cscope 15 $HOME/tikv               0002560760
	@benches/benches.rs

14 #![
ã©u»
(
¶ugš
)]

15 #![
ã©u»
(
‹¡
)]

16 #![
cfg_©Œ
(
ã©u»
 = "dev", 
¶ugš
(
şpy
))]

17 #![
cfg_©Œ
(
nÙ
(
ã©u»
 = "dev"), 
®low
(
unknown_lšts
))]

18 #![
®low
(
ÃedËss_·ss_by_v®ue
)]

19 #![
®low
(
uÄ—dabË_l™”®
)]

21 
ü©e
 
log
;

22 
ü©e
 
‹¡
;

23 
ü©e
 
mio
;

24 
ü©e
 
¿nd
;

25 
ü©e
 
tikv
;

26 
ü©e
 
time
;

27 
ü©e
 
‹mpdœ
;

28 
ü©e
 
rocksdb
;

29 
ü©e
 
´Ùobuf
;

30 
ü©e
 
kv´Ùo
;

32 
mod
 
	gchªÃl
;

33 
mod
 
	gwr™eb©ch
;

34 
mod
 
	g£rŸliz©iÚ
;

35 
mod
 
	gcİroûssÜ
;

37 #[
®low
(
d—d_code
)]

38 #[
·th
 = "../tests/util/mod.rs"]

39 
mod
 
	gut
;

41 
u£
 
	g‹¡
::
B’ch”
;

43 
u£
 
	gut
::
KvG’”©Ü
;

45 #[
b’ch
]

46 
â
 
	$_b’ch_check_»quœem’t
(
_
: &
mut
 
‹¡
::
B’ch”
) {

47 
Ët
 
	`E¼
(
e
èğ
tikv
::
ut
::
cÚfig
::
	`check_max_İ’_fds
(4096) {

48 
·nic
!(

51 
e


54 
	}
}

56 #[
b’ch
]

57 
â
 
	$b’ch_kv_™”
(
b
: &
mut
 
B’ch”
) {

58 
Ët
 
mut
 
g
 = 
KvG’”©Ü
::
	`Ãw
(100, 1000);

59 
b
.
	`™”
(|| 
g
.
	`Ãxt
());

60 
	}
}

	@benches/bin/bench-tikv.rs

14 #![
®low
(
¡abË_ã©u»s
)]

15 #![
ã©u»
(
mpsc_»cv_timeout
)]

16 #![
ã©u»
(
¶ugš
)]

17 #![
ã©u»
(
‹¡
)]

18 #![
ã©u»
(
âbox
)]

19 #![
ã©u»
(
box_syÁax
)]

20 #![
cfg_©Œ
(
ã©u»
 = "dev", 
¶ugš
(
şpy
))]

21 #![
cfg_©Œ
(
nÙ
(
ã©u»
 = "dev"), 
®low
(
unknown_lšts
))]

22 #![
ã©u»
(
bŒ“_¿nge
, 
cŞËùiÚs_bound
)]

23 #![
®low
(
Ãw_w™hout_deçuÉ
)]

24 #![
®low
(
ÃedËss_·ss_by_v®ue
)]

25 #![
®low
(
uÄ—dabË_l™”®
)]

27 #[
maüo_u£
]

28 
ü©e
 
log
;

29 
ü©e
 
´Ùobuf
;

30 #[
maüo_u£
]

31 
ü©e
 
tikv
;

32 
ü©e
 
¿nd
;

33 
ü©e
 
rocksdb
;

34 
ü©e
 
‹mpdœ
;

35 
ü©e
 
‹¡
;

36 
ü©e
 
kv´Ùo
;

37 
ü©e
 
futu»s
;

38 
ü©e
 
g½cio
 
as
 
g½c
;

40 #[
®low
(
d—d_code
)]

41 #[
·th
 = "../../tests/util/mod.rs"]

42 
mod
 
	g‹¡_ut
;

43 #[
®low
(
d—d_code
)]

44 #[
·th
 = "../../tests/raftstore/util.rs"]

45 
mod
 
	gut
;

46 #[
®low
(
d—d_code
)]

47 #[
·th
 = "../../tests/raftstore/cluster.rs"]

48 
mod
 
	gşu¡”
;

49 #[
·th
 = "../../tests/raftstore/node.rs"]

50 
mod
 
	gnode
;

51 #[
·th
 = "../../tests/raftstore/server.rs"]

52 
mod
 
	g£rv”
;

53 #[
®low
(
d—d_code
)]

54 #[
·th
 = "../../tests/raftstore/pd.rs"]

55 
mod
 
	gpd
;

56 #[
®low
(
d—d_code
)]

57 #[
·th
 = "../../tests/raftstore/transport_simulate.rs"]

58 
mod
 
	gŒª¥Üt_simuÏ‹
;

60 
u£
 
	g‹¡
::
B’chSam¶es
;

63 
	gmaüo_ruËs
! 
	gb’ch
 {

64 (
$
(
$¡mt
:
¡mt
);+) => ({

65 
u£
 
‹¡
::
b’ch
;

66 
	gb’ch
::
b’chm¬k
(|
b
| {

67 
b
.
™”
(|| {

68 
$
(
$¡mt
);+

75 
	gmaüo_ruËs
! 
	g´štf
 {

76 (
$
(
$¬g
:
‰
)*) => ({

77 
u£
 
¡d
::
io
::{
£lf
, 
Wr™e
};

78 
	g´št
!(
$
(
$¬g
)*);

79 
	gio
::
¡dout
().
æush
().
unw¿p
();

83 
mod
 
	g¿á¡Üe
;

84 
mod
 
	gmvcc
;

86 
â
 
	$´št_»suÉ
(
smp
: 
B’chSam¶es
) {

87 
´šn
!("{}", 
‹¡
::
	`fmt_b’ch_§m¶es
(&
smp
));

88 
	}
}

90 
â
 
	$maš
() {

91 
Ët
 
	`E¼
(
e
èğ
tikv
::
ut
::
cÚfig
::
	`check_max_İ’_fds
(4096) {

92 
·nic
!(

95 
e


99 
¿á¡Üe
::
	`b’ch_¿á¡Üe
();

100 
mvcc
::
	`b’ch_’gše
();

101 
	}
}

	@benches/bin/mvcc.rs

14 
u£
 
	g‹¡
::
B’chSam¶es
;

16 #[
®low
(
d—d_code
)]

17 #[
·th
 = "../../tests/storage/sync_storage.rs"]

18 
mod
 
	gsync_¡Üage
;

20 
u£
 
	g‹¡_ut
::*;

21 
u£
 
	gtikv
::
¡Üage
::{
Key
, 
	gMutiÚ
};

22 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

23 
u£
 
	g£lf
::
sync_¡Üage
::
SyncStÜage
;

25 
u£
 
	gsu³r
::
´št_»suÉ
;

29 
â
 
b’ch_tomb¡Úe_sÿn
(è-> 
	gB’chSam¶es
 {

30 
Ët
 
	g¡Üe
 = 
SyncStÜage
::
Ãw
(&
DeçuÉ
::());

31 
Ët
 
mut
 
	gts_g’”©Ü
 = 1..;

33 
Ët
 
mut
 
	gkvs
 = 
KvG’”©Ü
::
Ãw
(100, 1000);

35 
	gk
, 
	gv
è
š
 
	gkvs
.
ke
(100000) {

36 
Ët
 
mut
 
	gts
 = 
ts_g’”©Ü
.
Ãxt
().
unw¿p
();

37 
	g¡Üe


38 .
´ewr™e
(

39 
CÚ‹xt
::
Ãw
(),

40 
vec
![
MutiÚ
::
Put
((
Key
::
äom_¿w
(&
k
), 
v
))],

41 
k
.
şÚe
(),

42 
ts
,

44 .
ex³ù
("");

45 
	g¡Üe


46 .
comm™
(

47 
CÚ‹xt
::
Ãw
(),

48 
vec
![
Key
::
äom_¿w
(&
k
)],

49 
ts
,

50 
ts_g’”©Ü
.
Ãxt
().
unw¿p
(),

52 .
ex³ù
("");

54 
	gts
 = 
ts_g’”©Ü
.
Ãxt
().
unw¿p
();

55 
	g¡Üe


56 .
´ewr™e
(

57 
CÚ‹xt
::
Ãw
(),

58 
vec
![
MutiÚ
::
D–‘e
(
Key
::
äom_¿w
(&
k
))],

59 
k
.
şÚe
(),

60 
ts
,

62 .
ex³ù
("");

63 
	g¡Üe


64 .
comm™
(

65 
CÚ‹xt
::
Ãw
(),

66 
vec
![
Key
::
äom_¿w
(&
k
)],

67 
ts
,

68 
ts_g’”©Ü
.
Ãxt
().
unw¿p
(),

70 .
ex³ù
("");

73 
	gkvs
 = 
KvG’”©Ü
::
Ãw
(100, 1000);

74 
	gb’ch
!{

75 
Ët
 (
k
, 
_
èğ
kvs
.
Ãxt
().
unw¿p
();

76 
	gas£¹
!(
	g¡Üe
.
sÿn
(
CÚ‹xt
::
Ãw
(),

77 
Key
::
äom_¿w
(&
k
),

79 
çl£
,

80 
ts_g’”©Ü
.
Ãxt
().
unw¿p
())

81 .
unw¿p
()

82 .
is_em±y
())

86 
pub
 
â
 
	$b’ch_’gše
() {

87 
´štf
!("benchingombstone scan with„ocksdb\t...\t");

88 
	`´št_»suÉ
(
	`b’ch_tomb¡Úe_sÿn
());

89 
	}
}

	@benches/bin/raftstore.rs

14 
u£
 
	g‹¡
::
B’chSam¶es
;

15 
u£
 
	g‹¡_ut
::*;

16 
u£
 
	gşu¡”
::*;

17 
u£
 
	gnode
::
Ãw_node_şu¡”
;

18 
u£
 
	g£rv”
::
Ãw_£rv”_şu¡”
;

20 
u£
 
	grocksdb
::{
Wr™abË
, 
	gWr™eB©ch
, 
	gDB
};

21 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::*;

23 
u£
 
	gsu³r
::
´št_»suÉ
;

25 cÚ¡ 
	gDEFAULT_DATA_SIZE
: 
usize
 = 100
_000
;

27 
â
 
’c_wr™e_kvs
(
db
: &
DB
, 
kvs
: &[(
Vec
<
u8
>, Vec<u8>)]) {

28 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

29 &(
»f
 
	gk
,„eà
	gv
è
š
 
	gkvs
 {

30 
	gwb
.
put
(&
keys
::
d©a_key
(
k
), 
v
).
ex³ù
("");

32 
	gdb
.
wr™e
(
wb
).
ex³ù
("");

36 
â
 
	g´•¬e_şu¡”
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>, 
	gš™Ÿl_kvs
: &[(
Vec
<
u8
>, Vec<u8>)]) {

37 
	gşu¡”
.
run
();

38 
’gšes
 
š
 
	gşu¡”
.
	g’gšes
.
v®ues
() {

39 
’c_wr™e_kvs
(&
’gšes
.
kv_’gše
, 
š™Ÿl_kvs
);

41 
	gşu¡”
.
Ëad”_of_»giÚ
(1).
unw¿p
();

44 
â
 
	$´št_£t_´og»ss
(
g
: &
¡r
, 
nút
: 
usize
, 
vËn
: usize) {

45 
´štf
!(

47 
g
,

48 
nút
,

49 
vËn


51 
	}
}

53 
â
 
	$´št_Ùh”_´og»ss
(
g
: &
¡r
, 
aùiÚ
: &¡r, 
nút
: 
usize
) {

54 
´štf
!("b’chšg {} oÀ{},\Šodes: {}\t...", 
aùiÚ
, 
g
, 
nút
);

55 
	}
}

57 
â
 
	gb’ch_£t
<
	gT
: 
SimuÏtÜ
>(
mut
 
şu¡”
: 
Clu¡”
<
T
>, 
	gv®ue_size
: 
usize
è-> 
B’chSam¶es
 {

58 
´•¬e_şu¡”
(&
mut
 
şu¡”
, &[]);

60 
Ët
 
mut
 
	gkvs
 = 
KvG’”©Ü
::
Ãw
(100, 
v®ue_size
);

62 
	gb’ch
!{

63 
Ët
 (
k
, 
v
èğ
kvs
.
Ãxt
().
unw¿p
();

64 
	gşu¡”
.
mu¡_put
(&
k
, &
v
)

68 
â
 
	gb’ch_g‘
<
	gT
: 
SimuÏtÜ
>(
mut
 
şu¡”
: 
Clu¡”
<
T
>è-> 
B’chSam¶es
 {

69 
Ët
 
mut
 
kvs
 = 
g’”©e_¿ndom_kvs
(
DEFAULT_DATA_SIZE
, 100, 128);

70 
´•¬e_şu¡”
(&
mut
 
şu¡”
, &
kvs
);

72 
Ët
 
mut
 
	gkeys
 = 
kvs
.
d¿š
(..)

73 .
ke
(
DEFAULT_DATA_SIZE
 / 10)

74 .
m­
(|
i
| i.0)

75 .
chaš
(
KvG’”©Ü
::
Ãw
(100, 0).
m­
(|
i
| i.0));

77 
	gb’ch
!{

78 
Ët
 
	gk
 = 
keys
.
Ãxt
().
unw¿p
();

79 
	gşu¡”
.
g‘
(&
k
)

83 
â
 
	gb’ch_d–‘e
<
	gT
: 
SimuÏtÜ
>(
mut
 
şu¡”
: 
Clu¡”
<
T
>è-> 
B’chSam¶es
 {

84 
Ët
 
mut
 
kvs
 = 
g’”©e_¿ndom_kvs
(
DEFAULT_DATA_SIZE
, 100, 128);

85 
´•¬e_şu¡”
(&
mut
 
şu¡”
, &
kvs
);

87 
Ët
 
mut
 
	gkeys
 = 
kvs
.
d¿š
(..)

88 .
ke
(
DEFAULT_DATA_SIZE
 / 10)

89 .
m­
(|
i
| i.0)

90 .
chaš
(
KvG’”©Ü
::
Ãw
(100, 0).
m­
(|
i
| i.0));

92 
	gb’ch
!{

93 
Ët
 
	gk
 = 
keys
.
Ãxt
().
unw¿p
();

94 
	gşu¡”
.
mu¡_d–‘e
(&
k
)

98 
â
 
	gb’ch_¿á_şu¡”
<
	gT
, 
	gF
>(
	gçùÜy
: 
F
, 
	gg
: &'static str)

99 
wh”e


100 
T
: 
SimuÏtÜ
,

101 
	gF
: 
Fn
(
u64
, 
usize
è-> 
	gClu¡”
<
	gT
>,

103 
Ët
 
	gnode_úts
 = 
vec
![1, 3, 5];

104 
Ët
 
	gby‹s_Ëns
 = 
vec
![8, 128, 1024, 4096];

106 
nút
 
š
 
	gnode_úts
 {

107 &
vËn
 
	gš
 &
	gby‹s_Ëns
 {

108 
´št_£t_´og»ss
(
g
, 
nút
, 
vËn
);

109 
´št_»suÉ
(
b’ch_£t
(
çùÜy
(1, 
nút
), 
vËn
));

111 
´št_Ùh”_´og»ss
(
g
, "G‘", 
nút
);

112 
´št_»suÉ
(
b’ch_g‘
(
çùÜy
(1, 
nút
)));

113 
´št_Ùh”_´og»ss
(
g
, "D–‘e", 
nút
);

114 
´št_»suÉ
(
b’ch_d–‘e
(
çùÜy
(1, 
nút
)));

118 
pub
 
â
 
	$b’ch_¿á¡Üe
() {

119 
	`b’ch_¿á_şu¡”
(
Ãw_node_şu¡”
, "raft cluster (channel)");

120 
	`b’ch_¿á_şu¡”
(
Ãw_£rv”_şu¡”
, "raft cluster (tcp)");

121 
	}
}

	@benches/channel/bench_channel.rs

14 
u£
 
	g‹¡
::
B’ch”
;

15 
u£
 
	g¡d
::
th»ad
;

16 
u£
 
	g¡d
::
sync
::
mpsc
::
chªÃl
;

18 
u£
 
	gmio
::{
Ev’tLoİ
, 
	gHªdËr
, 
	gS’d”
};

20 
	sCouÁHªdËr
 {

21 
	mn
: 
usize
,

24 
im¶
 
HªdËr
 
	gCouÁHªdËr
 {

25 
ty³
 
	gTimeout
 = ();

26 
ty³
 
	gMes§ge
 = 
u32
;

28 
â
 
nÙify
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
CouÁHªdËr
>, 
msg
: 
u32
) {

29 
msg
 == 0 {

30 
ev’t_loİ
.
shutdown
();

34 
	g£lf
.
	gn
 += 1;

38 
â
 
mio_mu¡_£nd
(
£nd”
: &
S’d”
<
u32
>, 
n
: u32) {

39 
loİ
 {

41 
£nd”
.
£nd
(
n
).
is_ok
() {

47 #[
b’ch
]

48 
â
 
	$b’ch_mio_chªÃl
(
b
: &
mut
 
B’ch”
) {

49 
Ët
 
mut
 
ev’t_loİ
 = 
Ev’tLoİ
::
	`Ãw
().
	`unw¿p
();

50 
Ët
 
£nd”
 = 
ev’t_loİ
.
	`chªÃl
();

52 
Ët
 
t
 = 
th»ad
::
	`¥awn
(
move
 || {

53 
Ët
 
mut
 
h
 = 
CouÁHªdËr
 { 
n
: 0 };

54 
ev’t_loİ
.
	`run
(&
mut
 
h
).
	`unw¿p
();

55 
h
.
n


58 
Ët
 
mut
 
n1
 = 0;

59 
b
.
	`™”
(|| {

60 
n1
 += 1;

61 
	`mio_mu¡_£nd
(&
£nd”
, 1);

64 
	`mio_mu¡_£nd
(&
£nd”
, 0);

66 
Ët
 
n2
 = 
t
.
	`još
().
	`unw¿p
();

67 
as£¹_eq
!(
n1
, 
n2
);

68 
	}
}

70 #[
b’ch
]

71 
â
 
	$b’ch_th»ad_chªÃl
(
b
: &
mut
 
B’ch”
) {

72 
	`Ët
 (
tx
, 
rx
èğ
	`chªÃl
();

74 
Ët
 
t
 = 
th»ad
::
	`¥awn
(
move
 || {

75 
Ët
 
mut
 
n2
: 
usize
 = 0;

76 
loİ
 {

77 
Ët
 
n
 = 
rx
.
	`»cv
().
	`unw¿p
();

78 
n
 == 0 {

79  
n2
;

81 
n2
 += 1;

85 
Ët
 
mut
 
n1
 = 0;

86 
b
.
	`™”
(|| {

87 
n1
 += 1;

88 
tx
.
	`£nd
(1).
	`unw¿p
()

91 
tx
.
	`£nd
(0).
	`unw¿p
();

92 
Ët
 
n2
 = 
t
.
	`još
().
	`unw¿p
();

93 
as£¹_eq
!(
n1
, 
n2
);

94 
	}
}

	@benches/channel/mod.rs

14 
mod
 
	gb’ch_chªÃl
;

	@benches/coprocessor/codec/mod.rs

1 
mod
 
	gmysql
;

	@benches/coprocessor/codec/mysql/json/mod.rs

14 
ü©e
 
£rde_jsÚ
;

16 
u£
 
	g¡d
::
io
;

17 
u£
 
	g¡d
::
io
::
´–ude
::*;

18 
u£
 
	g¡d
::
´oûss
::{
Commªd
, 
	gStdio
};

19 
u£
 
	g¡d
::
th»ad
;

20 
u£
 
	g‹¡
::
B’ch”
;

22 
u£
 
	gtikv
::
cİroûssÜ
::
codec
::
mysql
::{
JsÚ
, 
	gJsÚDecod”
, 
	gJsÚEncod”
};

24 
â
 
dowÆßd_ªd_exŒaù_fe
(
u¾
: &
¡r
è-> 
io
::
ResuÉ
<
SŒšg
> {

25 
Ët
 
mut
 
dl_chd
 = 
Commªd
::
Ãw
("curl")

26 .
¬g
(
u¾
)

27 .
¡dout
(
Stdio
::
ped
())

28 .
¡d”r
(
Stdio
::
nuÎ
())

29 .
¥awn
()?;

30 
Ët
 
mut
 
	gr_chd
 = 
Commªd
::
Ãw
("tar")

31 .
¬gs
(&["xzf", "-", "--to-stdout"])

32 .
¡dš
(
Stdio
::
ped
())

33 .
¡dout
(
Stdio
::
ped
())

34 .
¡d”r
(
Stdio
::
nuÎ
())

35 .
¥awn
()?;

37 
Ët
 
mut
 
	gdl_ouut
 = 
dl_chd
.
¡dout
.
ke
().
unw¿p
();

38 
Ët
 
mut
 
	gr_šput
 = 
r_chd
.
¡dš
.
ke
().
unw¿p
();

39 
Ët
 
	gth
 = 
th»ad
::
¥awn
(
move
 || -> 
io
::
ResuÉ
<()> {

40 
Ët
 
mut
 
buf
 = 
vec
![0; 4096];

41 
loİ
 {

42 
Ët
 
nby‹s
 = 
dl_ouut
.
»ad
(&
mut
 
buf
)?;

43 
nby‹s
 > 0 {

44 
r_šput
.
wr™e_®l
(&
buf
[0..
nby‹s
])?;

47  
Ok
(());

51 
Ët
 
	gouut
 = 
r_chd
.
wa™_w™h_ouut
()?;

52 
	gdl_chd
.
wa™
()?;

53 
	gth
.
još
().
unw¿p
()?;

54 
	gas£¹_eq
!(
	gouut
.
	g¡©us
.
code
(), 
Some
(0));

55 
Ok
(
SŒšg
::
äom_utf8
(
ouut
.
¡dout
).
unw¿p
())

58 
pub
 
â
 
lßd_‹¡_jsÚs
(è-> 
io
::
ResuÉ
<
Vec
<
SŒšg
>> {

59 
Ët
 
u¾
 = "https://download.pingcap.org/resources/world_bank.json.tar.gz";

60 
dowÆßd_ªd_exŒaù_fe
(
u¾
).
m­
(|
¿w
: 
SŒšg
| {

61 
¿w
.
¥l™
('\n')

62 .
f‹r
(|
s
| !s.
is_em±y
())

63 .
m­
(|
s
| s.
to_owÃd
())

64 .
cŞËù
::<
Vec
<
_
>>()

68 #[
ignÜe
]

69 #[
b’ch
]

70 
â
 
	$b’ch_’code_bš¬y
(
b
: &
mut
 
B’ch”
) {

71 
Ët
 
jsÚs
: 
Vec
<
JsÚ
> = 
	`lßd_‹¡_jsÚs
()

72 .
	`unw¿p
()

73 .
	`što_™”
()

74 .
	`m­
(|
t
|.
	`·r£
().
	`unw¿p
())

75 .
	`cŞËù
();

76 
Ët
 
mut
 
buf
 = 
Vec
::
	`w™h_ÿ·c™y
(65536);

77 
b
.
	`™”
(|| 
j
 
š
 &
jsÚs
 {

78 
buf
.
	`ş—r
();

79 
buf
.
	`’code_jsÚ
(
j
).
	`unw¿p
();

81 
	}
}

83 #[
ignÜe
]

84 #[
b’ch
]

85 
â
 
	$b’ch_’code_‹xt
(
b
: &
mut
 
B’ch”
) {

86 
Ët
 
jsÚs
: 
Vec
<
JsÚ
> = 
	`lßd_‹¡_jsÚs
()

87 .
	`unw¿p
()

88 .
	`što_™”
()

89 .
	`m­
(|
t
|.
	`·r£
().
	`unw¿p
())

90 .
	`cŞËù
();

91 
Ët
 
mut
 
buf
 = 
Vec
::
	`w™h_ÿ·c™y
(65536);

92 
b
.
	`™”
(|| 
j
 
š
 &
jsÚs
 {

93 
buf
.
	`ş—r
();

94 
£rde_jsÚ
::
	`to_wr™”
(&
mut
 
buf
, 
j
).
	`unw¿p
();

96 
	}
}

98 #[
ignÜe
]

99 #[
b’ch
]

100 
â
 
	$b’ch_decode_‹xt
(
b
: &
mut
 
B’ch”
) {

101 
Ët
 
‹xts
 = 
	`lßd_‹¡_jsÚs
().
	`unw¿p
();

102 
b
.
	`™”
(|| 
‹xt
 
š
 &
‹xts
 {

103 
‹xt
.
·r£
::<
JsÚ
>().
	`unw¿p
();

105 
	}
}

107 #[
ignÜe
]

108 #[
b’ch
]

109 
â
 
	$b’ch_decode_bš¬y
(
b
: &
mut
 
B’ch”
) {

110 
Ët
 
bš¬›s
 = 
	`lßd_‹¡_jsÚs
()

111 .
	`unw¿p
()

112 .
	`što_™”
()

113 .
	`m­
(|
t
|.
·r£
::<
JsÚ
>().
	`unw¿p
())

114 .
	`m­
(|
j
| {

115 
Ët
 
mut
 
buf
 = 
Vec
::
	`Ãw
();

116 
buf
.
	`’code_jsÚ
(&
j
).
	`unw¿p
();

117 
buf


119 .
cŞËù
::<
Vec
<Vec<
u8
>>>();

120 
b
.
	`™”
(|| 
bš¬y
 
š
 &
bš¬›s
 {

121 
bš¬y
.
	`as_¦iû
().
	`decode_jsÚ
().
	`unw¿p
();

123 
	}
}

	@benches/coprocessor/codec/mysql/mod.rs

1 
mod
 
	gjsÚ
;

	@benches/coprocessor/mod.rs

1 
mod
 
	gcodec
;

	@benches/serialization/bench_serialization.rs

14 
ü©e
 
´Ùobuf
;

16 
u£
 
	g¡d
::
cŞËùiÚs
::
HashM­
;

17 
u£
 
	g‹¡
::
B’ch”
;

18 
u£
 
	g¿nd
::{
th»ad_ºg
, 
	gRng
};

19 
u£
 
	g´Ùobuf
::
Mes§ge
;

20 
u£
 
	gkv´Ùo
::
”aápb
::
EÁry
;

21 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
CmdTy³
, 
	gRaáCmdReque¡
, 
	gReque¡
};

23 #[
šlše
]

24 
â
 
g’_¿nd_¡r
(
Ën
: 
usize
è-> 
Vec
<
u8
> {

25 
Ët
 
mut
 
¿nd_¡r
 = 
vec
![0; 
Ën
];

26 
th»ad_ºg
().
fl_by‹s
(&
mut
 
¿nd_¡r
);

27 
	g¿nd_¡r


30 #[
šlše
]

31 
â
 
g’”©e_»que¡s
(
m­
: &
HashM­
<&[
u8
], &[u8]>è-> 
	gVec
<
	gReque¡
> {

32 
Ët
 
mut
 
	g»qs
 = 
vec
![];

33 
	gkey
, 
	gv®ue
è
š
 
	gm­
 {

34 
Ët
 
mut
 
	gr
 = 
Reque¡
::
Ãw
();

35 
	gr
.
£t_cmd_ty³
(
CmdTy³
::
Put
);

36 
	gr
.
mut_put
().
£t_cf
("tikv".
to_owÃd
());

37 
	gr
.
mut_put
().
£t_key
(
key
.
to_vec
());

38 
	gr
.
mut_put
().
£t_v®ue
(
v®ue
.
to_vec
());

39 
	g»qs
.
push
(
r
);

41 
	g»qs


44 
â
 
’code
(
m­
: &
HashM­
<&[
u8
], &[u8]>è-> 
	gVec
<
	gu8
> {

45 
Ët
 
mut
 
	ge
 = 
EÁry
::
Ãw
();

46 
Ët
 
mut
 
	gcmd
 = 
RaáCmdReque¡
::
Ãw
();

47 
Ët
 
	g»qs
 = 
g’”©e_»que¡s
(
m­
);

48 
	gcmd
.
£t_»que¡s
(
´Ùobuf
::
R•—‹dF›ld
::
äom_vec
(
»qs
));

49 
Ët
 
	gcmd_msg
 = 
cmd
.
wr™e_to_by‹s
().
unw¿p
();

50 
	ge
.
£t_d©a
(
cmd_msg
);

51 
	ge
.
wr™e_to_by‹s
().
unw¿p
()

54 
â
 
	$decode
(
d©a
: &[
u8
]) {

55 
Ët
 
mut
 
’Œy
 = 
EÁry
::
	`Ãw
();

56 
’Œy
.
	`m”ge_äom_by‹s
(
d©a
).
	`unw¿p
();

57 
Ët
 
mut
 
cmd
 = 
RaáCmdReque¡
::
	`Ãw
();

58 
cmd
.
	`m”ge_äom_by‹s
(
’Œy
.
	`g‘_d©a
()).
	`unw¿p
();

59 
	}
}

61 #[
b’ch
]

62 
â
 
	$b’ch_’code_Úe
(
b
: &
mut
 
B’ch”
) {

63 
Ët
 
key
 = 
	`g’_¿nd_¡r
(30);

64 
Ët
 
v®ue
 = 
	`g’_¿nd_¡r
(256);

65 
Ët
 
mut
 
m­
: 
HashM­
<&[
u8
], &[u8]> = HashM­::
	`Ãw
();

66 
m­
.
	`š£¹
(&
key
, &
v®ue
);

67 
b
.
	`™”
(|| { 
	`’code
(&
m­
); });

68 
	}
}

70 #[
b’ch
]

71 
â
 
	$b’ch_decode_Úe
(
b
: &
mut
 
B’ch”
) {

72 
Ët
 
key
 = 
	`g’_¿nd_¡r
(30);

73 
Ët
 
v®ue
 = 
	`g’_¿nd_¡r
(256);

74 
Ët
 
mut
 
m­
: 
HashM­
<&[
u8
], &[u8]> = HashM­::
	`Ãw
();

75 
m­
.
	`š£¹
(&
key
, &
v®ue
);

76 
Ët
 
d©a
 = 
	`’code
(&
m­
);

77 
b
.
	`™”
(|| { 
	`decode
(&
d©a
); });

78 
	}
}

80 #[
b’ch
]

81 
â
 
	$b’ch_’code_two
(
b
: &
mut
 
B’ch”
) {

82 
Ët
 
key_fÜ_lock
 = 
	`g’_¿nd_¡r
(30);

83 
Ët
 
v®ue_fÜ_lock
 = 
	`g’_¿nd_¡r
(10);

84 
Ët
 
key_fÜ_d©a
 = 
	`g’_¿nd_¡r
(30);

85 
Ët
 
v®ue_fÜ_d©a
 = 
	`g’_¿nd_¡r
(256);

86 
Ët
 
mut
 
m­
: 
HashM­
<&[
u8
], &[u8]> = HashM­::
	`Ãw
();

87 
m­
.
	`š£¹
(&
key_fÜ_lock
, &
v®ue_fÜ_lock
);

88 
m­
.
	`š£¹
(&
key_fÜ_d©a
, &
v®ue_fÜ_d©a
);

89 
b
.
	`™”
(|| { 
	`’code
(&
m­
); });

90 
	}
}

92 #[
b’ch
]

93 
â
 
	$b’ch_decode_two
(
b
: &
mut
 
B’ch”
) {

94 
Ët
 
key_fÜ_lock
 = 
	`g’_¿nd_¡r
(30);

95 
Ët
 
v®ue_fÜ_lock
 = 
	`g’_¿nd_¡r
(10);

96 
Ët
 
key_fÜ_d©a
 = 
	`g’_¿nd_¡r
(30);

97 
Ët
 
v®ue_fÜ_d©a
 = 
	`g’_¿nd_¡r
(256);

98 
Ët
 
mut
 
m­
: 
HashM­
<&[
u8
], &[u8]> = HashM­::
	`Ãw
();

99 
m­
.
	`š£¹
(&
key_fÜ_lock
, &
v®ue_fÜ_lock
);

100 
m­
.
	`š£¹
(&
key_fÜ_d©a
, &
v®ue_fÜ_d©a
);

101 
Ët
 
d©a
 = 
	`’code
(&
m­
);

102 
b
.
	`™”
(|| { 
	`decode
(&
d©a
); });

103 
	}
}

	@benches/serialization/mod.rs

14 
mod
 
	gb’ch_£rŸliz©iÚ
;

	@benches/writebatch/bench_writebatch.rs

14 
u£
 
	g‹¡
::
B’ch”
;

15 
u£
 
	g‹mpdœ
::
TempDœ
;

16 
u£
 
	grocksdb
::{
Wr™abË
, 
	gWr™eB©ch
, 
	gDB
};

18 
â
 
	$wr™eb©ch
(
db
: &
DB
, 
round
: 
usize
, 
b©ch_keys
: usize) {

19 
Ët
 
v
 = 
b
"operators‡re syntactic sugar for callso methods of built-inraits";

20 
r
 
š
 0..
round
 {

21 
Ët
 
b©ch
 = 
Wr™eB©ch
::
	`Ãw
();

22 
i
 
š
 0..ba
tch_keys
 {

23 
Ët
 
k
 = 
fÜm©
!("key_round{}_key{}", 
r
, 
i
);

24 
b©ch
.
	`put
(
k
.
	`as_by‹s
(), 
v
).
	`unw¿p
();

26 
db
.
	`wr™e
(
b©ch
).
	`unw¿p
()

28 
	}
}

30 
â
 
	$b’ch_wr™eb©ch_im¶
(
b
: &
mut
 
B’ch”
, 
b©ch_keys
: 
usize
) {

31 
Ët
 
·th
 = 
TempDœ
::
	`Ãw
("/tmp/rocksdb_wr™e_b©ch_b’ch").
	`unw¿p
();

32 
Ët
 
db
 = 
DB
::
	`İ’_deçuÉ
(
·th
.
	`·th
().
	`to_¡r
().
	`unw¿p
()).unwrap();

33 
Ët
 
key_couÁ
 = 1 << 13;

34 
Ët
 
round
 = 
key_couÁ
 / 
b©ch_keys
;

35 
b
.
	`™”
(|| { 
	`wr™eb©ch
(&
db
, 
round
, 
b©ch_keys
); });

36 
	}
}

38 #[
b’ch
]

39 
â
 
	$b’ch_wr™eb©ch_1
(
b
: &
mut
 
B’ch”
) {

40 
	`b’ch_wr™eb©ch_im¶
(
b
, 1);

41 
	}
}

43 #[
b’ch
]

44 
â
 
	$b’ch_wr™eb©ch_2
(
b
: &
mut
 
B’ch”
) {

45 
	`b’ch_wr™eb©ch_im¶
(
b
, 2);

46 
	}
}

48 #[
b’ch
]

49 
â
 
	$b’ch_wr™eb©ch_4
(
b
: &
mut
 
B’ch”
) {

50 
	`b’ch_wr™eb©ch_im¶
(
b
, 4);

51 
	}
}

53 #[
b’ch
]

54 
â
 
	$b’ch_wr™eb©ch_8
(
b
: &
mut
 
B’ch”
) {

55 
	`b’ch_wr™eb©ch_im¶
(
b
, 8);

56 
	}
}

58 #[
b’ch
]

59 
â
 
	$b’ch_wr™eb©ch_16
(
b
: &
mut
 
B’ch”
) {

60 
	`b’ch_wr™eb©ch_im¶
(
b
, 16);

61 
	}
}

63 #[
b’ch
]

64 
â
 
	$b’ch_wr™eb©ch_32
(
b
: &
mut
 
B’ch”
) {

65 
	`b’ch_wr™eb©ch_im¶
(
b
, 32);

66 
	}
}

68 #[
b’ch
]

69 
â
 
	$b’ch_wr™eb©ch_64
(
b
: &
mut
 
B’ch”
) {

70 
	`b’ch_wr™eb©ch_im¶
(
b
, 64);

71 
	}
}

73 #[
b’ch
]

74 
â
 
	$b’ch_wr™eb©ch_128
(
b
: &
mut
 
B’ch”
) {

75 
	`b’ch_wr™eb©ch_im¶
(
b
, 128);

76 
	}
}

78 #[
b’ch
]

79 
â
 
	$b’ch_wr™eb©ch_256
(
b
: &
mut
 
B’ch”
) {

80 
	`b’ch_wr™eb©ch_im¶
(
b
, 256);

81 
	}
}

83 #[
b’ch
]

84 
â
 
	$b’ch_wr™eb©ch_512
(
b
: &
mut
 
B’ch”
) {

85 
	`b’ch_wr™eb©ch_im¶
(
b
, 512);

86 
	}
}

88 #[
b’ch
]

89 
â
 
	$b’ch_wr™eb©ch_1024
(
b
: &
mut
 
B’ch”
) {

90 
	`b’ch_wr™eb©ch_im¶
(
b
, 1024);

91 
	}
}

93 
â
 
	$fl_wr™eb©ch
(
wb
: &
Wr™eB©ch
, 
rg‘_size
: 
usize
) {

94 
	`Ët
 (
k
, 
v
èğ(
b
"this ishe key", b"this ishe value");

95 
loİ
 {

96 
wb
.
	`put
(
k
, 
v
).
	`unw¿p
();

97 
wb
.
	`d©a_size
(è>ğ
rg‘_size
 {

101 
	}
}

103 #[
b’ch
]

104 
â
 
	$b’ch_wr™eb©ch_w™hout_ÿ·c™y
(
b
: &
mut
 
B’ch”
) {

105 
b
.
	`™”
(|| {

106 
Ët
 
wb
 = 
Wr™eB©ch
::
	`Ãw
();

107 
	`fl_wr™eb©ch
(&
wb
, 4096);

109 
	}
}

111 #[
b’ch
]

112 
â
 
	$b’ch_wr™eb©ch_w™h_ÿ·c™y
(
b
: &
mut
 
B’ch”
) {

113 
b
.
	`™”
(|| {

114 
Ët
 
wb
 = 
Wr™eB©ch
::
	`w™h_ÿ·c™y
(4096);

115 
	`fl_wr™eb©ch
(&
wb
, 4096);

117 
	}
}

	@benches/writebatch/mod.rs

14 
mod
 
	gb’ch_wr™eb©ch
;

	@build.rs

14 
ü©e
 
time
;

16 
u£
 
	g¡d
::
’v
;

17 
u£
 
	g¡d
::
fs
::
Fe
;

18 
u£
 
	g¡d
::
io
::
Wr™e
;

19 
u£
 
	g¡d
::
·th
::
P©hBuf
;

20 
u£
 
	g¡d
::
´oûss
::
Commªd
;

22 
â
 
	$maš
() {

23 
Ët
 
out_dœ
 = 
P©hBuf
::
	`äom
(
’v
::
	`v¬_os
("OUT_DIR").
	`unw¿p
());

25 
Fe
::
	`ü—‹
(
out_dœ
.
	`još
("build-info.txt"))

26 .
	`unw¿p
()

27 .
	`wr™e_®l
(
	`bud_šfo
().
	`as_by‹s
())

28 .
	`unw¿p
();

29 
	}
}

33 
â
 
bud_šfo
(è-> 
	gSŒšg
 {

35 
	gfÜm©
!(

37 
comm™_hash
().
Œim_right
(),

38 
b¿nch_šfo
().
Œim_right
(),

39 
utc_time
(),

40 
ru¡c_v”siÚ
()

44 
â
 
utc_time
(è-> 
	gSŒšg
 {

45 
Ët
 
	gutc
 = 
time
::
now_utc
();

46 
	gfÜm©
!("{}", 
	gutc
.
¡ráime
("%Y-%m-%d %I:%M:%S").
unw¿p
())

49 
â
 
comm™_hash
(è-> 
	gSŒšg
 {

50 
Ët
 
mut
 
	gcmd
 = 
Commªd
::
Ãw
("git");

51 
	gcmd
.
¬gs
(&["rev-parse", "HEAD"]);

52 
	gcmd
.
ouut
()

53 .
ok
()

54 .
ªd_th’
(|
o
| 
SŒšg
::
äom_utf8
(o.
¡dout
).
ok
())

55 .
unw¿p_Ü
("NÚe".
to_owÃd
())

58 
â
 
b¿nch_šfo
(è-> 
SŒšg
 {

59 
Ët
 
mut
 
cmd
 = 
Commªd
::
Ãw
("git");

60 
	gcmd
.
¬gs
(&["rev-parse", "--abbrev-ref", "HEAD"]);

61 
	gcmd
.
ouut
()

62 .
ok
()

63 .
ªd_th’
(|
o
| 
SŒšg
::
äom_utf8
(o.
¡dout
).
ok
())

64 .
unw¿p_Ü
("NÚe".
to_owÃd
())

67 
â
 
ru¡c_v”siÚ
(è-> 
SŒšg
 {

68 
Ët
 
mut
 
cmd
 = 
Commªd
::
Ãw
(
’v
::
v¬
("RUSTC").
unw¿p
());

69 
	gcmd
.
¬gs
(&["--version"]);

70 
	gcmd
.
ouut
()

71 .
ok
()

72 .
ªd_th’
(|
o
| 
SŒšg
::
äom_utf8
(o.
¡dout
).
ok
())

73 .
m­
(|
v
| v.
Œim_Ëá_m©ches
("ru¡c").
Œim
().
to_owÃd
())

74 .
unw¿p
()

	@src/bin/profiling.rs

14 #[
cfg
(
ã©u»
 = "mem-profiling")]

15 
mod
 
	gimp
 {

16 
u£
 
	g¡d
::
ffi
::
CSŒšg
;

17 
u£
 
	g¡d
::{
’v
, 
	g±r
};

19 
u£
 
	gjem®loÿtÜ
;

20 
u£
 
	glibc
::
c_ch¬
;

23 cÚ¡ 
	gPROFILE_ACTIVE
: &'static [u8] = b"prof.active\0";

24 cÚ¡ 
PROFILE_DUMP
: &'static [u8] = b"prof.dump\0";

26 
DumpP©hGu¬d
(
O±iÚ
<
Vec
<
u8
>>);

28 
im¶
 
	gDumpP©hGu¬d
 {

29 
â
 
äom_c¡ršg
(
s
: 
O±iÚ
<
CSŒšg
>è-> 
DumpP©hGu¬d
 {

30 
DumpP©hGu¬d
(
s
.
m­
(|s| s.
što_by‹s_w™h_nul
()))

35 #[
šlše
]

36 
un§ã
 
â
 
g‘_mut_±r
(&
mut
 
£lf
è-> *muˆ
c_ch¬
 {

37 
£lf
.0

38 .
as_mut
()

39 .
m­_Ü
(
±r
::
nuÎ_mut
(), |
v
| v.
as_mut_±r
(è
as
 *
mut
 
c_ch¬
)

46 
pub
 
â
 
dump_´of
(
·th
: 
O±iÚ
<&
¡r
>) {

47 
un§ã
 {

48 
Ët
 
E¼
(
e
èğ
jem®loÿtÜ
::
m®lùl_£t
(
PROFILE_ACTIVE
, 
Œue
) {

49 
	g”rÜ
!("çedØaùiv©´ofšg: {}", 
	ge
);

53 
Ët
 
mut
 
	gc_·th
 = 
DumpP©hGu¬d
::
äom_c¡ršg
(
·th
.
m­
(|
p
| 
CSŒšg
::
Ãw
Õ).
unw¿p
()));

54 
Ët
 
	g»s
 = 
un§ã
 { 
jem®loÿtÜ
::
m®lùl_£t
(
PROFILE_DUMP
, 
c_·th
.
g‘_mut_±r
()) };

55 
m©ch
 
	g»s
 {

56 
E¼
(
e
è=> 
”rÜ
!("çedØdum°th´oftØ{:?}: {}", 
	g·th
, 
	ge
),

57 
Ok
(
_
) => {

58 
Ët
 
Some
(
p
èğ
·th
 {

59 
šfo
!("dum°´oftØ{}", 
p
);

63 
	gšfo
!("dum°´oftØ{}", 
	g’v
::
cu¼’t_dœ
().
unw¿p
().
di¥Ïy
());

68 #[
cfg
(
‹¡
)]

69 
mod
 
	g‹¡
 {

70 
u£
 
	g¡d
::
fs
;

72 
u£
 
	g‹mpdœ
::
TempDœ
;

75 #[
‹¡
]

76 #[
ignÜe
]

77 
â
 
‹¡_´ofšg_memÜy
() {

78 
Ët
 
	gdœ
 = 
TempDœ
::
Ãw
("‹¡_´ofšg").
unw¿p
();

79 
Ët
 
	gos_·th
 = 
dœ
.
·th
().
to_·th_buf
().
još
("‹¡1.dump").
što_os_¡ršg
();

80 
Ët
 
	g·th
 = 
os_·th
.
što_¡ršg
().
unw¿p
();

81 
	gsu³r
::
dump_´of
(
Some
(&
·th
));

83 
Ët
 
	gos_·th
 = 
dœ
.
·th
().
to_·th_buf
().
još
("‹¡2.dump").
što_os_¡ršg
();

84 
Ët
 
	g·th
 = 
os_·th
.
što_¡ršg
().
unw¿p
();

85 
	gsu³r
::
dump_´of
(
Some
(&
·th
));

87 
Ët
 
	gfes
 = 
fs
::
»ad_dœ
(
dœ
.
·th
()).
unw¿p
().
couÁ
();

88 
	gas£¹_eq
!(
	gfes
, 2);

93 #[
cfg
(
nÙ
(
ã©u»
 = "mem-profiling"))]

94 
mod
 
	gimp
 {

95 
pub
 
â
 
dump_´of
(
_
: 
O±iÚ
<&
¡r
>) {}

98 
pub
 
u£
 
£lf
::
imp
::*;

	@src/bin/signal_handler.rs

15 #[
cfg
(
unix
)]

16 
mod
 
	gimp
 {

17 
u£
 
	g¡d
::{
±r
, 
	g¦iû
};

18 
u£
 
	g¡d
::
sync
::
Arc
;

19 
u£
 
	glibc
::{
£lf
, 
	gc_ch¬
, 
	gc_št
, 
	gc_void
};

21 
u£
 
	grocksdb
::
DB
;

22 
u£
 
	g´om‘heus
::{
£lf
, 
	gEncod”
, 
	gTextEncod”
};

23 
u£
 
	g´ofšg
;

25 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
Engšes
;

27 cÚ¡ 
	gROCKSDB_DB_STATS_KEY
: &'static str = "rocksdb.dbstats";

28 cÚ¡ 
ROCKSDB_CF_STATS_KEY
: &'static str = "rocksdb.cfstats";

31 #[
cfg_©Œ
(
rg‘_os
 = "macos", 
lšk_Çme
 = "je_malloc_stats_print")]

32 
â
 
m®loc_¡©s_´št
(

33 
wr™e_cb
: "C" 
â
(*
mut
 
c_void
, *cÚ¡ 
c_ch¬
),

34 
cbİaque
: *
mut
 
c_void
,

35 
İts
: *cÚ¡ 
c_ch¬
,

39 "C" 
â
 
wr™e_cb
(
´š‹r
: *
mut
 
c_void
, 
msg
: *cÚ¡ 
c_ch¬
) {

40 
un§ã
 {

41 
Ët
 
buf
 = &
mut
 *(
´š‹r
 
as
 *muˆ
Vec
<
u8
>);

42 
Ët
 
Ën
 = 
libc
::
¡¾’
(
msg
);

43 
Ët
 
by‹s
 = 
¦iû
::
äom_¿w_·¹s
(
msg
 
as
 *cÚ¡ 
u8
, 
Ën
);

44 
buf
.
ex‹nd_äom_¦iû
(
by‹s
);

48 
â
 
´št_m®loc_¡©s
() {

49 
Ët
 
mut
 
buf
 = 
Vec
::
Ãw
();

50 
un§ã
 {

51 
m®loc_¡©s_´št
(

52 
wr™e_cb
,

53 &
mut
 
buf
 
as
 *muˆ
Vec
<
u8
>‡ *muˆ
c_void
,

54 
±r
::
nuÎ
(),

57 
šfo
!("{}", 
SŒšg
::
äom_utf8_lossy
(&
buf
));

61 
pub
 
â
 
hªdË_sigÇl
(
’gšes
: 
Engšes
, 
_
: &
¡r
) {

62 
u£
 
sigÇl
::
Œ­
::
T¿p
;

63 
u£
 
nix
::
sys
::
sigÇl
::{
SIGUSR1
, 
SIGUSR2
, 
SIGHUP
, 
SIGINT
, 
SIGTERM
};

64 
Ët
 
Œ­
 = 
T¿p
::Œ­(&[
SIGTERM
, 
SIGINT
, 
SIGHUP
, 
SIGUSR1
, 
SIGUSR2
]);

65 
sig
 
š
 
Œ­
 {

66 
m©ch
 
sig
 {

67 
SIGTERM
 | 
SIGINT
 | 
SIGHUP
 => {

68 
šfo
!("»ûivsigÇÈ{}, stİpšg s”v”...", 
sig
 
as
 
c_št
);

71 
SIGUSR1
 => {

73 
Ët
 
mut
 
bufãr
 = 
vec
![];

74 
Ët
 
m‘ric_çmys
 = 
´om‘heus
::
g©h”
();

75 
Ët
 
’cod”
 = 
TextEncod”
::
Ãw
();

76 
’cod”
.
’code
(&
m‘ric_çmys
, &
mut
 
bufãr
).
unw¿p
();

77 
šfo
!("{}", 
SŒšg
::
äom_utf8
(
bufãr
).
unw¿p
());

79 
´št_rocksdb_¡©s
(&
’gšes
.
kv_’gše
);

80 
´št_rocksdb_¡©s
(&
’gšes
.
¿á_’gše
);

81 
´št_m®loc_¡©s
();

83 
SIGUSR2
 => 
´ofšg
::
dump_´of
(
NÚe
),

85 
_
 => 
uÄ—chabË
!(),

90 
â
 
´št_rocksdb_¡©s
(
’gše
: &
Arc
<
DB
>) {

92 
Çme
 
š
 
’gše
.
cf_Çmes
() {

93 
Ët
 
hªdËr
 = 
’gše
.
cf_hªdË
(
Çme
).
unw¿p
();

94 
Ët
 
Some
(
v
èğ
’gše
.
g‘_´İ”ty_v®ue_cf
(
hªdËr
, 
ROCKSDB_CF_STATS_KEY
) {

95 
šfo
!("{}", 
v
)

99 
Ët
 
Some
(
v
èğ
’gše
.
g‘_´İ”ty_v®ue
(
ROCKSDB_DB_STATS_KEY
) {

100 
šfo
!("{}", 
v
)

104 
Ët
 
Some
(
v
èğ
’gše
.
g‘_¡©i¡ics
() {

105 
šfo
!("{}", 
v
)

109 #[
cfg
(
‹¡
)]

110 
mod
 
‹¡s
 {

111 #[
‹¡
]

112 
â
 
‹¡_¡©s_´št
() {

114 
su³r
::
´št_m®loc_¡©s
()

119 #[
cfg
(
nÙ
(
unix
))]

120 
mod
 
imp
 {

121 
u£
 
¡d
::
sync
::
Arc
;

123 
u£
 
	grocksdb
::
DB
;

125 
pub
 
â
 
hªdË_sigÇl
(
_
: 
Arc
<
DB
>, _: &
¡r
) {}

128 
pub
 
u£
 
£lf
::
imp
::
hªdË_sigÇl
;

	@src/bin/tikv-ctl.rs

14 #![
ã©u»
(
¶ugš
)]

15 #![
cfg_©Œ
(
ã©u»
 = "dev", 
¶ugš
(
şpy
))]

16 #![
cfg_©Œ
(
nÙ
(
ã©u»
 = "dev"), 
®low
(
unknown_lšts
))]

17 #![
®low
(
ÃedËss_·ss_by_v®ue
)]

19 
ü©e
 
tikv
;

20 
ü©e
 
ş­
;

21 
ü©e
 
´Ùobuf
;

22 
ü©e
 
kv´Ùo
;

23 
ü©e
 
rocksdb
;

24 
ü©e
 
g½cio
;

25 
ü©e
 
futu»s
;

26 
ü©e
 
ru¡c_£rŸlize
;

28 
u£
 
	g¡d
::{
´oûss
, 
	g¡r
, 
	gu64
};

29 
u£
 
	g¡d
::
™”
::
FromI‹¿tÜ
;

30 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

31 
u£
 
	g¡d
::
”rÜ
::
E¼Ü
;

32 
u£
 
	g¡d
::
sync
::
Arc
;

33 
u£
 
	g¡d
::
·th
::
P©hBuf
;

34 
u£
 
	gru¡c_£rŸlize
::
hex
::{
FromHex
, 
	gToHex
};

36 
u£
 
	gş­
::{
Aµ
, 
	gArg
, 
	gArgM©ches
, 
	gSubCommªd
};

37 
u£
 
	g´Ùobuf
::
Mes§ge
;

38 
u£
 
	gfutu»s
::{
futu»
, 
	g¡»am
, 
	gFutu»
, 
	gSŒ—m
};

39 
u£
 
	gg½cio
::{
ChªÃlBud”
, 
	gEnvœÚm’t
};

40 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

42 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::
RaáCmdReque¡
;

43 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
P“rS‹
;

44 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

45 
u£
 
	gkv´Ùo
::
”aápb
::
EÁry
;

46 
u£
 
	gkv´Ùo
::
kv½ıb
::
MvccInfo
;

47 
u£
 
	gkv´Ùo
::
debugpb
::*;

48 
u£
 
	gkv´Ùo
::
debugpb
::
DB
 
as
 
DBTy³
;

49 
u£
 
	gkv´Ùo
::
debugpb_g½c
::
DebugCl›Á
;

50 
u£
 
	gtikv
::
ut
::{
£lf
, 
	gesÿ³
, 
	guÃsÿ³
};

51 
u£
 
	gtikv
::
ut
::
£cur™y
::{
Secur™yCÚfig
, 
	gSecur™yMªag”
};

52 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::{
keys
, 
	gEngšes
};

53 
u£
 
	gtikv
::
£rv”
::
debug
::{
Debugg”
, 
	gRegiÚInfo
};

54 
u£
 
	gtikv
::
¡Üage
::{
ALL_CFS
, 
	gCF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_WRITE
};

55 
u£
 
	gtikv
::
pd
::{
CÚfig
 
as
 
PdCÚfig
, 
	gPdCl›Á
, 
	gRpcCl›Á
};

57 
â
 
	g³¼Ü_ªd_ex™
<
	gE
: 
E¼Ü
>(
´efix
: &
¡r
, 
	ge
: 
E
) -> ! {

58 
•ršn
!("{}: {}", 
	g´efix
, 
	ge
);

59 
	g´oûss
::
ex™
(-1);

62 
â
 
Ãw_debug_executÜ
(

63 
db
: 
O±iÚ
<&
¡r
>,

64 
¿á_db
: 
O±iÚ
<&
¡r
>,

65 
ho¡
: 
O±iÚ
<&
¡r
>,

66 
mgr
: 
Arc
<
Secur™yMªag”
>,

67 è-> 
	gBox
<
	gDebugExecutÜ
> {

68 
m©ch
 (
ho¡
, 
db
) {

69 (
	gNÚe
, 
Some
(
kv_·th
)) => {

70 
Ët
 
db
 = 
ut
::
rocksdb
::
İ’
(
kv_·th
, 
ALL_CFS
).
unw¿p
();

71 
Ët
 
	g¿á_db
 = Ëˆ
Some
(
¿á_·th
èğ
¿á_db
 {

72 
ut
::
rocksdb
::
İ’
(
¿á_·th
, &[
CF_DEFAULT
]).
unw¿p
()

74 
Ët
 
¿á_·th
 = 
P©hBuf
::
äom
(
kv_·th
).
još
("../raft");

75 
	gut
::
rocksdb
::
İ’
(
¿á_·th
.
to_¡r
().
unw¿p
(), &[
CF_DEFAULT
]).unwrap()

77 
	gBox
::
Ãw
(
Debugg”
::Ãw(
Engšes
::Ãw(
Arc
::Ãw(
db
), Arc::Ãw(
¿á_db
)))è
as


78 
Box
<
DebugExecutÜ
>

80 (
Some
(
»mÙe
), 
	gNÚe
) => {

81 
Ët
 
’v
 = 
Arc
::
Ãw
(
EnvœÚm’t
::new(1));

82 
Ët
 
	gcb
 = 
ChªÃlBud”
::
Ãw
(
’v
);

83 
Ët
 
	gchªÃl
 = 
mgr
.
cÚÃù
(
cb
, 
»mÙe
);

84 
Ët
 
	gş›Á
 = 
DebugCl›Á
::
Ãw
(
chªÃl
);

85 
	gBox
::
Ãw
(
ş›Á
è
as
 
Box
<
DebugExecutÜ
>

87 
_
 => 
uÄ—chabË
!(),

91 
Œa™
 
	gDebugExecutÜ
 {

92 
â
 
dump_v®ue
(&
£lf
, 
cf
: &
¡r
, 
key
: 
Vec
<
u8
>) {

93 
Ët
 
v®ue
 = 
£lf
.
g‘_v®ue_by_key
(
cf
, 
key
);

94 
	g´šn
!("v®ue: {}", 
esÿ³
(&
v®ue
));

97 
â
 
dump_»giÚ_size
(&
£lf
, 
»giÚ
: 
u64
, 
cfs
: 
Vec
<&
¡r
>è-> 
usize
 {

98 
Ët
 
sizes
 = 
£lf
.
g‘_»giÚ_size
(
»giÚ
, 
cfs
);

99 
Ët
 
mut
 
	gtÙ®_size
 = 0;

100 
	g´šn
!("»giÚ id: {}", 
	g»giÚ
);

101 
	gcf
, 
	gsize
è
š
 
	gsizes
 {

102 
	g´šn
!("cà{}„egiÚ size: {}", 
	gcf
, 
cÚv”t_gbmb
(
size
 
as
 
u64
));

103 
	gtÙ®_size
 +ğ
size
;

105 
	gtÙ®_size


108 
â
 
dump_®l_»giÚ_size
(&
£lf
, 
cfs
: 
Vec
<&
¡r
>) {

109 
Ët
 
»giÚs
 = 
£lf
.
g‘_®l_m‘a_»giÚs
();

110 
Ët
 
	g»giÚs_numb”
 = 
»giÚs
.
Ën
();

111 
Ët
 
mut
 
	gtÙ®_size
 = 0;

112 
»giÚ
 
š
 
	g»giÚs
 {

113 
	gtÙ®_size
 +ğ
£lf
.
dump_»giÚ_size
(
»giÚ
, 
cfs
.
şÚe
());

115 
	g´šn
!("tÙ®„egiÚ‚umb”: {}", 
	g»giÚs_numb”
);

116 
	g´šn
!("tÙ®„egiÚ size: {}", 
cÚv”t_gbmb
(
tÙ®_size
 
as
 
u64
));

119 
â
 
dump_»giÚ_šfo
(&
£lf
, 
»giÚ
: 
u64
, 
sk_tomb¡Úe
: 
boŞ
) {

120 
Ët
 
r
 = 
£lf
.
g‘_»giÚ_šfo
(
»giÚ
);

121 
	gsk_tomb¡Úe
 {

122 
Ët
 
	g»giÚ_¡©e
 = 
r
.
»giÚ_loÿl_¡©e
.
as_»f
();

123 
	g»giÚ_¡©e
.
m­_Ü
(
çl£
, |
s
| s.
g‘_¡©e
(è=ğ
P“rS‹
::
Tomb¡Úe
) {

127 
Ët
 
	g»giÚ_¡©e_key
 = 
keys
::
»giÚ_¡©e_key
(
»giÚ
);

128 
Ët
 
	g¿á_¡©e_key
 = 
keys
::
¿á_¡©e_key
(
»giÚ
);

129 
Ët
 
	g­¶y_¡©e_key
 = 
keys
::
­¶y_¡©e_key
(
»giÚ
);

130 
	g´šn
!("»giÚ id: {}", 
	g»giÚ
);

131 
	g´šn
!("»giÚ s‹ key: {}", 
esÿ³
(&
»giÚ_¡©e_key
));

132 
	g´šn
!("»giÚ s‹: {:?}", 
	gr
.
	g»giÚ_loÿl_¡©e
);

133 
	g´šn
!("¿á s‹ key: {}", 
esÿ³
(&
¿á_¡©e_key
));

134 
	g´šn
!("¿á s‹: {:?}", 
	gr
.
	g¿á_loÿl_¡©e
);

135 
	g´šn
!("­¶y s‹ key: {}", 
esÿ³
(&
­¶y_¡©e_key
));

136 
	g´šn
!("­¶y s‹: {:?}", 
	gr
.
	g¿á_­¶y_¡©e
);

139 
â
 
dump_®l_»giÚ_šfo
(&
£lf
, 
sk_tomb¡Úe
: 
boŞ
) {

140 
»giÚ
 
š
 
£lf
.
g‘_®l_m‘a_»giÚs
() {

141 
£lf
.
dump_»giÚ_šfo
(
»giÚ
, 
sk_tomb¡Úe
);

145 
â
 
dump_¿á_log
(&
£lf
, 
»giÚ
: 
u64
, 
šdex
: u64) {

146 
Ët
 
idx_key
 = 
keys
::
¿á_log_key
(
»giÚ
, 
šdex
);

147 
	g´šn
!("idx_key: {}", 
esÿ³
(&
idx_key
));

148 
	g´šn
!("»giÚ: {}", 
	g»giÚ
);

149 
	g´šn
!("log index: {}", 
	gšdex
);

151 
Ët
 
mut
 
	g’Œy
 = 
£lf
.
g‘_¿á_log
(
»giÚ
, 
šdex
);

152 
Ët
 
	gd©a
 = 
’Œy
.
ke_d©a
();

153 
	g´šn
!("’Œy {:?}", 
	g’Œy
);

154 
	g´šn
!("msg†’: {}", 
	gd©a
.
Ën
());

156 
Ët
 
mut
 
	gmsg
 = 
RaáCmdReque¡
::
Ãw
();

157 
	gmsg
.
m”ge_äom_by‹s
(&
d©a
).
unw¿p
();

158 
	g´šn
!("{:?}", 
	gmsg
);

161 
â
 
dump_mvccs_šfos
(

162 &
£lf
,

163 
äom
: 
Vec
<
u8
>,

164 
to
: 
O±iÚ
<
Vec
<
u8
>>,

165 
lim™
: 
O±iÚ
<
u64
>,

166 
cfs
: 
Vec
<&
¡r
>,

167 
¡¬t_ts
: 
O±iÚ
<
u64
>,

168 
comm™_ts
: 
O±iÚ
<
u64
>,

170 
Ët
 
	gto
 = 
to
.
unw¿p_Ü_deçuÉ
();

171 
Ët
 
	glim™
 = 
lim™
.
unw¿p_Ü_deçuÉ
();

172 
	gto
.
is_em±y
(è&& 
	glim™
 == 0 {

173 
•ršn
!(
r
#"
¶—£
 
·ss
 "to" 
Ü
 "limit""#);

174 
´oûss
::
ex™
(-1);

176 !
	gto
.
is_em±y
(è&&Ø< 
	gäom
 {

177 
	g•ršn
!("The„egion's from…os must greaterhanheo…os.");

178 
	g´oûss
::
ex™
(-1);

180 
Ët
 
	gsÿn_futu»
 = 
£lf
.
g‘_mvcc_šfos
(
äom
, 
to
, 
lim™
).
fÜ_—ch
(

181 
move
 |(
key
, 
mvcc
)| {

182 
´šn
!("key: {}", 
esÿ³
(&
key
));

183 
cfs
.
cÚšs
(&
CF_LOCK
è&& 
mvcc
.
has_lock
() {

184 
Ët
 
lock_šfo
 = 
mvcc
.
g‘_lock
();

185 
¡¬t_ts
.
m­_Ü
(
Œue
, |
ts
| 
lock_šfo
.
g‘_lock_v”siÚ
() ==s) {

187 
´šn
!("\ock càv®ue: {:?}", 
lock_šfo
);

190 
cfs
.
cÚšs
(&
CF_DEFAULT
) {

191 
v®ue_šfo
 
š
 
mvcc
.
g‘_v®ues
() {

192 
comm™_ts
.
m­_Ü
(
Œue
, |
ts
| 
v®ue_šfo
.
g‘_ts
() ==s) {

193 
´šn
!("\tdeçuÉ càv®ue: {:?}", 
v®ue_šfo
);

197 
cfs
.
cÚšs
(&
CF_WRITE
) {

198 
wr™e_šfo
 
š
 
mvcc
.
g‘_wr™es
() {

199 
¡¬t_ts
.
m­_Ü
(
Œue
, |
ts
| 
wr™e_šfo
.
g‘_¡¬t_ts
() ==s) &&

200 
comm™_ts
.
m­_Ü
(
Œue
, |
ts
| 
wr™e_šfo
.
g‘_comm™_ts
() ==s)

203 
´šn
!("\ˆwr™càv®ue: {:?}", 
wr™e_šfo
);

207 
´šn
!("");

208 
futu»
::
ok
::<(), 
SŒšg
>(())

211 
Ët
 
E¼
(
e
èğ
sÿn_futu»
.
wa™
() {

212 
•ršn
!("{}", 
e
);

213 
	g´oûss
::
ex™
(-1);

217 
â
 
diff_»giÚ
(

218 &
£lf
,

219 
»giÚ
: 
u64
,

220 
db
: 
O±iÚ
<&
¡r
>,

221 
¿á_db
: 
O±iÚ
<&
¡r
>,

222 
ho¡
: 
O±iÚ
<&
¡r
>,

223 
mgr
: 
Arc
<
Secur™yMªag”
>,

225 
Ët
 
	grhs_debug_executÜ
 = 
Ãw_debug_executÜ
(
db
, 
¿á_db
, 
ho¡
, 
mgr
);

227 
Ët
 
	gr1
 = 
£lf
.
g‘_»giÚ_šfo
(
»giÚ
);

228 
Ët
 
	gr2
 = 
rhs_debug_executÜ
.
g‘_»giÚ_šfo
(
»giÚ
);

229 
	g´šn
!("»giÚ id: {}", 
	g»giÚ
);

230 
	g´šn
!("db1„egiÚ s‹: {:?}", 
	gr1
.
	g»giÚ_loÿl_¡©e
);

231 
	g´šn
!("db2„egiÚ s‹: {:?}", 
	gr2
.
	g»giÚ_loÿl_¡©e
);

232 
	g´šn
!("db1‡µly s‹: {:?}", 
	gr1
.
	g¿á_­¶y_¡©e
);

233 
	g´šn
!("db2‡µly s‹: {:?}", 
	gr2
.
	g¿á_­¶y_¡©e
);

235 
m©ch
 (
r1
.
»giÚ_loÿl_¡©e
, 
r2
.region_local_state) {

236 (
	gNÚe
, None) => ,

237 (
Some
(
_
), 
	gNÚe
) | (None, Some(_)) => {

238 
´šn
!("db1‡nd db2 don't have same„egion†ocal_state");

241 (
Some
(
»giÚ_loÿl_1
), Some(
»giÚ_loÿl_2
)) => {

242 
Ët
 
»giÚ1
 = 
»giÚ_loÿl_1
.
g‘_»giÚ
();

243 
Ët
 
	g»giÚ2
 = 
»giÚ_loÿl_2
.
g‘_»giÚ
();

244 
	g»giÚ1
 !ğ
»giÚ2
 {

245 
´šn
!("db1‡nd db2 have different„egion:");

246 
	g´šn
!("db1„egiÚ: {:?}", 
	g»giÚ1
);

247 
	g´šn
!("db2„egiÚ: {:?}", 
	g»giÚ2
);

250 
Ët
 
	g¡¬t_key
 = 
keys
::
d©a_key
(
»giÚ1
.
g‘_¡¬t_key
());

251 
Ët
 
	g’d_key
 = 
keys
::
d©a_key
(
»giÚ1
.
g‘_’d_key
());

252 
Ët
 
mut
 
	gmvcc_šfos_1
 = 
£lf
.
g‘_mvcc_šfos
(
¡¬t_key
.
şÚe
(), 
’d_key
.clone(), 0);

253 
Ët
 
mut
 
	gmvcc_šfos_2
 = 
rhs_debug_executÜ
.
g‘_mvcc_šfos
(
¡¬t_key
, 
’d_key
, 0);

255 
Ët
 
mut
 
	ghas_diff
 = 
çl£
;

256 
Ët
 
mut
 
	gkey_couÁs
 = [0; 2];

258 
Ët
 
mut
 
	gke_™em
 = |
i
: 
usize
| -> 
O±iÚ
<(
Vec
<
u8
>, 
	gMvccInfo
)> {

259 
Ët
 
	gwa™
 = 
m©ch
 
i
 {

260 1 => 
futu»
::
pŞl_â
(|| 
mvcc_šfos_1
.
pŞl
()).
wa™
(),

261 
	g_
 => 
futu»
::
pŞl_â
(|| 
mvcc_šfos_2
.
pŞl
()).
wa™
(),

263 
m©ch
 
	gwa™
 {

264 
Ok
(
™em1
) => item1,

265 
E¼
(
e
) => {

266 
´šn
!("db{} sÿÀd©¨š„egiÚ {} fa: {}", 
i
, 
»giÚ
, 
e
);

267 
	g´oûss
::
ex™
(-1);

272 
Ët
 
	gshow_Úly
 = |
i
: 
usize
, 
	gk
: &[
u8
]| {

273 
´šn
!("Úly db{} has: {}", 
	gi
, 
esÿ³
(
k
));

276 
Ët
 (
mut
 
™em1
, muˆ
™em2
èğ(
ke_™em
(1),ake_item(2));

277 
	g™em1
.
is_some
(è&& 
	g™em2
.is_some() {

278 
	gkey_couÁs
[0] += 1;

279 
	gkey_couÁs
[1] += 1;

280 
Ët
 
	gt1
 = 
™em1
.
ke
().
unw¿p
();

281 
Ët
 
	gt2
 = 
™em2
.
ke
().
unw¿p
();

282 
m©ch
 
	gt1
.0.c
mp
(&
t2
.0) {

283 
	gOrd”šg
::
Less
 => {

284 
show_Úly
(1, &
t1
.0);

285 
	ghas_diff
 = 
Œue
;

286 
	g™em1
 = 
ke_™em
(1);

287 
	g™em2
 = 
Some
(
t2
);

288 
	gkey_couÁs
[1] -= 1;

290 
	gOrd”šg
::
G»©”
 => {

291 
show_Úly
(2, &
t2
.0);

292 
	ghas_diff
 = 
Œue
;

293 
	g™em1
 = 
Some
(
t1
);

294 
	g™em2
 = 
ke_™em
(2);

295 
	gkey_couÁs
[0] -= 1;

297 
	g_
 => {

298 
t1
.1 !ğ
t2
.1 {

299 
´šn
!("difàmvcøÚ key: {}", 
esÿ³
(&
t1
.0));

300 
	ghas_diff
 = 
Œue
;

302 
	g™em1
 = 
ke_™em
(1);

303 
	g™em2
 = 
ke_™em
(2);

307 
Ët
 
mut
 
	g™em
 = 
™em1
.
m­
(|
t
| (1,)).
Ü_–£
(|| 
™em2
.map(|t| (2,)));

308 
Ët
 
Some
((
i
, (
key
, 
_
))èğ
™em
.
ke
() {

309 
key_couÁs
[
i
 - 1] += 1;

310 
show_Úly
(
i
, &
key
);

311 
	ghas_diff
 = 
Œue
;

312 
	g™em
 = 
ke_™em
(
i
).
m­
(|
t
| (i,));

314 !
	ghas_diff
 {

315 
	g´šn
!("db1‡nd db2 hav§md©¨š„egiÚ: {}", 
	g»giÚ
);

317 
	g´šn
!(

319 
	gkey_couÁs
[0],

320 
	gkey_couÁs
[1]

326 
â
 
com·ù
(&
£lf
, 
db
: 
DBTy³
, 
cf
: &
¡r
, 
äom
: 
O±iÚ
<
Vec
<
u8
>>, 
to
: Option<Vec<u8>>) {

327 
Ët
 
äom
 = from.
unw¿p_Ü_deçuÉ
();

328 
Ët
 
	gto
 = 
to
.
unw¿p_Ü_deçuÉ
();

329 
	g£lf
.
do_com·ù
(
db
, 
cf
, 
äom
, 
to
);

332 
â
 
£t_»giÚ_tomb¡Úe_aá”_»move_³”
(

333 &
£lf
,

334 
mgr
: 
Arc
<
Secur™yMªag”
>,

335 
cfg
: &
PdCÚfig
,

336 
»giÚ_id
: 
u64
,

338 
	g£lf
.
check_loÿl_mode
();

339 
m©ch
 
	gRpcCl›Á
::
Ãw
(
cfg
, 
mgr
)

340 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("RpcClient::new",ƒ))

341 .
g‘_»giÚ_by_id
(
»giÚ_id
)

342 .
wa™
()

343 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("Get„egion id from PD",ƒ))

345 
Some
(
»giÚ
è=> 
£lf
.
£t_»giÚ_tomb¡Úe
(
»giÚ_id
,„egion),

346 
	gNÚe
 => {

347 
•ršn
!("nØsuch„egiÚ iÀpd: {}", 
»giÚ_id
);

348 
	g´oûss
::
ex™
(-1);

353 
â
 
check_loÿl_mode
(&
£lf
);

355 
â
 
g‘_®l_m‘a_»giÚs
(&
£lf
è-> 
	gVec
<
	gu64
>;

357 
â
 
g‘_v®ue_by_key
(&
£lf
, 
cf
: &
¡r
, 
key
: 
Vec
<
u8
>) -> Vec<u8>;

359 
â
 
g‘_»giÚ_size
(&
£lf
, 
»giÚ
: 
u64
, 
cfs
: 
Vec
<&
¡r
>è-> Vec<(
SŒšg
, 
	gusize
)>;

361 
â
 
g‘_»giÚ_šfo
(&
£lf
, 
»giÚ
: 
u64
è-> 
RegiÚInfo
;

363 
â
 
g‘_¿á_log
(&
£lf
, 
»giÚ
: 
u64
, 
šdex
: u64è-> 
EÁry
;

365 
â
 
g‘_mvcc_šfos
(

366 &
£lf
,

367 
äom
: 
Vec
<
u8
>,

368 
to
: 
Vec
<
u8
>,

369 
lim™
: 
u64
,

370 è-> 
	gBox
<
	gSŒ—m
<
	gI‹m
 = (
Vec
<
u8
>, 
	gMvccInfo
), 
	gE¼Ü
 = 
SŒšg
>>;

372 
â
 
do_com·ù
(&
£lf
, 
db
: 
DBTy³
, 
cf
: &
¡r
, 
äom
: 
Vec
<
u8
>, 
to
: Vec<u8>);

374 
â
 
£t_»giÚ_tomb¡Úe
(&
£lf
, 
»giÚ_id
: 
u64
, 
»giÚ
: 
RegiÚ
);

378 
im¶
 
DebugExecutÜ
 
	gDebugCl›Á
 {

379 
â
 
check_loÿl_mode
(&
£lf
) {

380 
	g•ršn
!("This command is only for†ocal mode");

381 
	g´oûss
::
ex™
(-1);

384 
â
 
g‘_®l_m‘a_»giÚs
(&
£lf
è-> 
	gVec
<
	gu64
> {

385 
	gunim¶em’‹d
!();

388 
â
 
g‘_v®ue_by_key
(&
£lf
, 
cf
: &
¡r
, 
key
: 
Vec
<
u8
>) -> Vec<u8> {

389 
Ët
 
mut
 
»q
 = 
G‘Reque¡
::
Ãw
();

390 
	g»q
.
£t_db
(
DBTy³
::
KV
);

391 
	g»q
.
£t_cf
(
cf
.
to_owÃd
());

392 
	g»q
.
£t_key
(
key
);

393 
	g£lf
.
g‘
(
»q
)

394 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("DebugClient::get",ƒ))

395 .
ke_v®ue
()

398 
â
 
g‘_»giÚ_size
(&
£lf
, 
»giÚ
: 
u64
, 
cfs
: 
Vec
<&
¡r
>è-> Vec<(
SŒšg
, 
	gusize
)> {

399 
Ët
 
	gcfs
 = 
cfs
.
što_™”
().
m­
(|
s
| s.
to_owÃd
()).
cŞËù
();

400 
Ët
 
mut
 
	g»q
 = 
RegiÚSizeReque¡
::
Ãw
();

401 
	g»q
.
£t_cfs
(
R•—‹dF›ld
::
äom_vec
(
cfs
));

402 
	g»q
.
£t_»giÚ_id
(
»giÚ
);

403 
	g£lf
.
»giÚ_size
(
»q
)

404 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("DebugClient::region_size",ƒ))

405 .
ke_’Œ›s
()

406 .
što_™”
()

407 .
m­
(|
mut
 
’Œy
| (’Œy.
ke_cf
(),ƒÁry.
g‘_size
(è
as
 
usize
))

408 .
cŞËù
()

411 
â
 
g‘_»giÚ_šfo
(&
£lf
, 
»giÚ
: 
u64
è-> 
RegiÚInfo
 {

412 
Ët
 
mut
 
»q
 = 
RegiÚInfoReque¡
::
Ãw
();

413 
	g»q
.
£t_»giÚ_id
(
»giÚ
);

414 
Ët
 
mut
 
	g»¥
 = 
£lf
.
»giÚ_šfo
(
»q
)

415 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("DebugClient::region_info",ƒ));

417 
Ët
 
mut
 
	g»giÚ_šfo
 = 
RegiÚInfo
::();

418 
	g»¥
.
has_¿á_loÿl_¡©e
() {

419 
	g»giÚ_šfo
.
	g¿á_loÿl_¡©e
 = 
Some
(
»¥
.
ke_¿á_loÿl_¡©e
());

421 
	g»¥
.
has_¿á_­¶y_¡©e
() {

422 
	g»giÚ_šfo
.
	g¿á_­¶y_¡©e
 = 
Some
(
»¥
.
ke_¿á_­¶y_¡©e
());

424 
	g»¥
.
has_»giÚ_loÿl_¡©e
() {

425 
	g»giÚ_šfo
.
	g»giÚ_loÿl_¡©e
 = 
Some
(
»¥
.
ke_»giÚ_loÿl_¡©e
());

427 
	g»giÚ_šfo


430 
â
 
g‘_¿á_log
(&
£lf
, 
»giÚ
: 
u64
, 
šdex
: u64è-> 
EÁry
 {

431 
Ët
 
mut
 
»q
 = 
RaáLogReque¡
::
Ãw
();

432 
	g»q
.
£t_»giÚ_id
(
»giÚ
);

433 
	g»q
.
£t_log_šdex
(
šdex
);

434 
	g£lf
.
¿á_log
(
»q
)

435 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("DebugClient::raft_log",ƒ))

436 .
ke_’Œy
()

439 
â
 
g‘_mvcc_šfos
(

440 &
£lf
,

441 
äom
: 
Vec
<
u8
>,

442 
to
: 
Vec
<
u8
>,

443 
lim™
: 
u64
,

444 è-> 
	gBox
<
	gSŒ—m
<
	gI‹m
 = (
Vec
<
u8
>, 
	gMvccInfo
), 
	gE¼Ü
 = 
SŒšg
>> {

445 
Ët
 
mut
 
»q
 = 
SÿnMvccReque¡
::
Ãw
();

446 
	g»q
.
£t_äom_key
(
äom
);

447 
	g»q
.
£t_to_key
(
to
);

448 
	g»q
.
£t_lim™
(
lim™
);

449 
	gBox
::
Ãw
(

450 
£lf
.
sÿn_mvcc
(
»q
)

451 .
m­_”r
(|
e
|ƒ.
to_¡ršg
())

452 .
m­
(|
mut
 
»¥
| (»¥.
ke_key
(),„e¥.
ke_šfo
())),

453 è
as
 
	gBox
<
	gSŒ—m
<
	gI‹m
 = (
Vec
<
u8
>, 
	gMvccInfo
), 
	gE¼Ü
 = 
SŒšg
>>

456 
â
 
do_com·ù
(&
£lf
, 
db
: 
DBTy³
, 
cf
: &
¡r
, 
äom
: 
Vec
<
u8
>, 
to
: Vec<u8>) {

457 
Ët
 
mut
 
»q
 = 
Com·ùReque¡
::
Ãw
();

458 
	g»q
.
£t_db
(
db
);

459 
	g»q
.
£t_cf
(
cf
.
to_owÃd
());

460 
	g»q
.
£t_äom_key
(
äom
);

461 
	g»q
.
£t_to_key
(
to
);

462 
	g£lf
.
com·ù
(
»q
)

463 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("DebugClient::compact",ƒ));

464 
	g´šn
!("success!");

467 
â
 
£t_»giÚ_tomb¡Úe
(&
£lf
, 
_
: 
u64
, _: 
RegiÚ
) {

468 
unim¶em’‹d
!();

472 
im¶
 
DebugExecutÜ
 
	gDebugg”
 {

473 
â
 
check_loÿl_mode
(&
£lf
) {}

475 
â
 
g‘_®l_m‘a_»giÚs
(&
£lf
è-> 
	gVec
<
	gu64
> {

476 
	g£lf
.
g‘_®l_m‘a_»giÚs
()

477 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("Debugger::get_all_meta_regions",ƒ))

480 
â
 
g‘_v®ue_by_key
(&
£lf
, 
cf
: &
¡r
, 
key
: 
Vec
<
u8
>) -> Vec<u8> {

481 
£lf
.
g‘
(
DBTy³
::
KV
, 
cf
, &
key
)

482 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("Debugger::get",ƒ))

485 
â
 
g‘_»giÚ_size
(&
£lf
, 
»giÚ
: 
u64
, 
cfs
: 
Vec
<&
¡r
>è-> Vec<(
SŒšg
, 
	gusize
)> {

486 
	g£lf
.
»giÚ_size
(
»giÚ
, 
cfs
)

487 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("Debugger::region_size",ƒ))

488 .
što_™”
()

489 .
m­
(|(
cf
, 
size
)| (cf.
to_owÃd
(), siz
as
 
usize
))

490 .
cŞËù
()

493 
â
 
g‘_»giÚ_šfo
(&
£lf
, 
»giÚ
: 
u64
è-> 
RegiÚInfo
 {

494 
£lf
.
»giÚ_šfo
(
»giÚ
)

495 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("Debugger::region_info",ƒ))

498 
â
 
g‘_¿á_log
(&
£lf
, 
»giÚ
: 
u64
, 
šdex
: u64è-> 
EÁry
 {

499 
£lf
.
¿á_log
(
»giÚ
, 
šdex
)

500 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("Debugger::raft_log",ƒ))

503 
â
 
g‘_mvcc_šfos
(

504 &
£lf
,

505 
äom
: 
Vec
<
u8
>,

506 
to
: 
Vec
<
u8
>,

507 
lim™
: 
u64
,

508 è-> 
	gBox
<
	gSŒ—m
<
	gI‹m
 = (
Vec
<
u8
>, 
	gMvccInfo
), 
	gE¼Ü
 = 
SŒšg
>> {

509 
Ët
 
™”
 = 
£lf
.
sÿn_mvcc
(&
äom
, &
to
, 
lim™
)

510 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("Debugger::scan_mvcc",ƒ));

511 #[
®low
(
d•»ÿ‹d
)]

512 
Ët
 
	g¡»am
 = 
¡»am
::
™”
(™”).
m­_”r
(|
e
|ƒ.
to_¡ršg
());

513 
	gBox
::
Ãw
(
¡»am
è
as
 
Box
<
SŒ—m
<
I‹m
 = (
Vec
<
u8
>, 
	gMvccInfo
), 
	gE¼Ü
 = 
SŒšg
>>

516 
â
 
do_com·ù
(&
£lf
, 
db
: 
DBTy³
, 
cf
: &
¡r
, 
äom
: 
Vec
<
u8
>, 
to
: Vec<u8>) {

517 
£lf
.
com·ù
(
db
, 
cf
, &
äom
, &
to
)

518 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("Debugger::compact",ƒ));

519 
	g´šn
!("success!");

522 
â
 
£t_»giÚ_tomb¡Úe
(&
£lf
, 
»giÚ_id
: 
u64
, 
»giÚ
: 
RegiÚ
) {

523 
£lf
.
£t_»giÚ_tomb¡Úe
(
»giÚ_id
, 
»giÚ
)

524 .
unw¿p_Ü_–£
(|
e
| 
³¼Ü_ªd_ex™
("Debugger::set_region_tombstone",ƒ))

528 
â
 
	$maš
() {

529 
Ët
 
mut
 
­p
 = 
Aµ
::
	`Ãw
("TiKV Ctl")

530 .
	`authÜ
("PingCAP")

531 .
	`about
(

534 .
	`¬g
(

535 
Arg
::
	`w™h_Çme
("db")

536 .
	`»quœed
(
Œue
)

537 .
	`cÚæiùs_w™h_®l
(&["host", "hex-to-escaped", "escaped-to-hex"])

539 .
	`kes_v®ue
(
Œue
)

540 .
	`h–p
("set„ocksdb…ath"),

542 .
	`¬g
(

543 
Arg
::
	`w™h_Çme
("raftdb")

544 .
	`cÚæiùs_w™h_®l
(&["host", "hex-to-escaped", "escaped-to-hex"])

546 .
	`kes_v®ue
(
Œue
)

547 .
	`h–p
("set„aft„ocksdb…ath"),

549 .
	`¬g
(

550 
Arg
::
	`w™h_Çme
("host")

551 .
	`»quœed
(
Œue
)

552 .
	`cÚæiùs_w™h_®l
(&["db", "raftdb", "hex-to-escaped", "escaped-to-hex"])

554 .
	`kes_v®ue
(
Œue
)

555 .
	`h–p
("set„emote host"),

557 .
	`¬g
(

558 
Arg
::
	`w™h_Çme
("ca_path")

559 .
	`»quœed
(
çl£
)

561 .
	`kes_v®ue
(
Œue
)

562 .
	`h–p
("set CA certificate…ath"),

564 .
	`¬g
(

565 
Arg
::
	`w™h_Çme
("cert_path")

566 .
	`»quœed
(
çl£
)

568 .
	`kes_v®ue
(
Œue
)

569 .
	`h–p
("set certificate…ath"),

571 .
	`¬g
(

572 
Arg
::
	`w™h_Çme
("key_path")

573 .
	`»quœed
(
çl£
)

575 .
	`kes_v®ue
(
Œue
)

576 .
	`h–p
("set…rivate key…ath"),

578 .
	`¬g
(

579 
Arg
::
	`w™h_Çme
("hex-to-escaped")

580 .
	`cÚæiùs_w™h
("escaped-to-hex")

582 .
	`kes_v®ue
(
Œue
)

583 .
	`h–p
("convert hex keyoƒscaped key"),

585 .
	`¬g
(

586 
Arg
::
	`w™h_Çme
("escaped-to-hex")

587 .
	`cÚæiùs_w™h
("hex-to-escaped")

589 .
	`kes_v®ue
(
Œue
)

590 .
	`h–p
("convertƒscaped keyo hex key"),

592 .
	`subcommªd
(

593 
SubCommªd
::
	`w™h_Çme
("raft")

594 .
	`about
("print„aft†ogƒntry")

595 .
	`subcommªd
(

596 
SubCommªd
::
	`w™h_Çme
("log")

597 .
	`about
("printhe„aft†ogƒntry info")

598 .
	`¬g
(

599 
Arg
::
	`w™h_Çme
("region")

600 .
	`»quœed_uÆess
("key")

601 .
	`cÚæiùs_w™h
("key")

603 .
	`kes_v®ue
(
Œue
)

604 .
	`h–p
("sethe„egion id"),

606 .
	`¬g
(

607 
Arg
::
	`w™h_Çme
("index")

608 .
	`»quœed_uÆess
("key")

609 .
	`cÚæiùs_w™h
("key")

611 .
	`kes_v®ue
(
Œue
)

612 .
	`h–p
("sethe„aft†og index"),

614 .
	`¬g
(

615 
Arg
::
	`w™h_Çme
("key")

616 .
	`»quœed_uÆess_Úe
(&["region", "index"])

617 .
	`cÚæiùs_w™h_®l
(&["region", "index"])

619 .
	`kes_v®ue
(
Œue
)

620 .
	`h–p
("sethe„aw key, inƒscaped form"),

623 .
	`subcommªd
(

624 
SubCommªd
::
	`w™h_Çme
("region")

625 .
	`about
("print„egion info")

626 .
	`¬g
(

627 
Arg
::
	`w™h_Çme
("region")

629 .
	`kes_v®ue
(
Œue
)

630 .
	`h–p
("sethe„egion id, if‚ot specified,…rint‡ll„egions."),

632 .
	`¬g
(

633 
Arg
::
	`w™h_Çme
("skip-tombstone")

635 .
	`kes_v®ue
(
çl£
)

636 .
	`h–p
("skipombstone„egion."),

640 .
	`subcommªd
(

641 
SubCommªd
::
	`w™h_Çme
("size")

642 .
	`about
("print„egion size")

643 .
	`¬g
(

644 
Arg
::
	`w™h_Çme
("region")

646 .
	`kes_v®ue
(
Œue
)

647 .
	`h–p
("sethe„egion id, if‚ot specified,…rint‡ll„egions."),

649 .
	`¬g
(

650 
Arg
::
	`w™h_Çme
("cf")

652 .
	`kes_v®ue
(
Œue
)

653 .
	`muÉË
(
Œue
)

654 .
	`u£_d–im™”
(
Œue
)

655 .
	`»quœe_d–im™”
(
Œue
)

656 .
	`v®ue_d–im™”
(",")

657 .
	`deçuÉ_v®ue
("default,write,lock")

658 .
	`h–p
("sethe cf‚ame, if‚ot specified,…rint‡ll cf."),

661 .
	`subcommªd
(

662 
SubCommªd
::
	`w™h_Çme
("scan")

663 .
	`about
("printhe„ange db„ange")

664 .
	`¬g
(

665 
Arg
::
	`w™h_Çme
("from")

668 .
	`kes_v®ue
(
Œue
)

669 .
	`h–p
("sethe scan from„aw key, inƒscaped format"),

671 .
	`¬g
(

672 
Arg
::
	`w™h_Çme
("to")

675 .
	`kes_v®ue
(
Œue
)

676 .
	`h–p
("sethe scanƒnd„aw key, inƒscaped format"),

678 .
	`¬g
(

679 
Arg
::
	`w™h_Çme
("limit")

681 .
	`kes_v®ue
(
Œue
)

682 .
	`h–p
("sethe scan†imit"),

684 .
	`¬g
(

685 
Arg
::
	`w™h_Çme
("start_ts")

687 .
	`kes_v®ue
(
Œue
)

688 .
	`h–p
("sethe scan start_ts‡s filter"),

690 .
	`¬g
(

691 
Arg
::
	`w™h_Çme
("commit_ts")

693 .
	`kes_v®ue
(
Œue
)

694 .
	`h–p
("sethe scan commit_ts‡s filter"),

696 .
	`¬g
(

697 
Arg
::
	`w™h_Çme
("cf")

699 .
	`kes_v®ue
(
Œue
)

700 .
	`muÉË
(
Œue
)

701 .
	`u£_d–im™”
(
Œue
)

702 .
	`»quœe_d–im™”
(
Œue
)

703 .
	`v®ue_d–im™”
(",")

704 .
	`deçuÉ_v®ue
(
CF_DEFAULT
)

705 .
	`h–p
("column family‚ames, combined from default/lock/write"),

708 .
	`subcommªd
(

709 
SubCommªd
::
	`w™h_Çme
("print")

710 .
	`about
("printhe„aw value")

711 .
	`¬g
(

712 
Arg
::
	`w™h_Çme
("cf")

714 .
	`kes_v®ue
(
Œue
)

715 .
	`deçuÉ_v®ue
(
CF_DEFAULT
)

716 .
	`h–p
("column family‚ame"),

718 .
	`¬g
(

719 
Arg
::
	`w™h_Çme
("key")

720 .
	`»quœed
(
Œue
)

722 .
	`kes_v®ue
(
Œue
)

723 .
	`h–p
("sethe query„aw key, inƒscaped form"),

726 .
	`subcommªd
(

727 
SubCommªd
::
	`w™h_Çme
("mvcc")

728 .
	`about
("printhe mvcc value")

729 .
	`¬g
(

730 
Arg
::
	`w™h_Çme
("key")

732 .
	`kes_v®ue
(
Œue
)

733 .
	`h–p
("sethe query„aw key, inƒscaped form"),

735 .
	`¬g
(

736 
Arg
::
	`w™h_Çme
("cf")

738 .
	`kes_v®ue
(
Œue
)

739 .
	`muÉË
(
Œue
)

740 .
	`u£_d–im™”
(
Œue
)

741 .
	`»quœe_d–im™”
(
Œue
)

742 .
	`v®ue_d–im™”
(",")

743 .
	`deçuÉ_v®ue
(
CF_DEFAULT
)

744 .
	`h–p
("column family‚ames, combined from default/lock/write"),

746 .
	`¬g
(

747 
Arg
::
	`w™h_Çme
("start_ts")

749 .
	`kes_v®ue
(
Œue
)

750 .
	`h–p
("set start_ts‡s filter"),

752 .
	`¬g
(

753 
Arg
::
	`w™h_Çme
("commit_ts")

755 .
	`kes_v®ue
(
Œue
)

756 .
	`h–p
("set commit_ts‡s filter"),

759 .
	`subcommªd
(

760 
SubCommªd
::
	`w™h_Çme
("diff")

761 .
	`about
("diffwo„egion keys")

762 .
	`¬g
(

763 
Arg
::
	`w™h_Çme
("region")

765 .
	`kes_v®ue
(
Œue
)

766 .
	`h–p
("specify„egion id"),

768 .
	`¬g
(

769 
Arg
::
	`w™h_Çme
("to_db")

771 .
	`kes_v®ue
(
Œue
)

772 .
	`h–p
("to which db…ath"),

774 .
	`¬g
(

775 
Arg
::
	`w™h_Çme
("to_host")

777 .
	`kes_v®ue
(
Œue
)

778 .
	`cÚæiùs_w™h
("to_db")

779 .
	`h–p
("to which„emote host"),

782 .
	`subcommªd
(

783 
SubCommªd
::
	`w™h_Çme
("compact")

784 .
	`about
("compact‡ column family in‡ specified„ange")

785 .
	`¬g
(

786 
Arg
::
	`w™h_Çme
("db")

788 .
	`kes_v®ue
(
Œue
)

789 .
	`deçuÉ_v®ue
("kv")

790 .
	`h–p
("kv or„aft"),

792 .
	`¬g
(

793 
Arg
::
	`w™h_Çme
("cf")

795 .
	`kes_v®ue
(
Œue
)

796 .
	`deçuÉ_v®ue
(
CF_DEFAULT
)

797 .
	`h–p
("column family‚ame, only can be default/lock/write"),

799 .
	`¬g
(

800 
Arg
::
	`w™h_Çme
("from")

803 .
	`kes_v®ue
(
Œue
)

804 .
	`h–p
("sethe start„aw key, inƒscaped form"),

806 .
	`¬g
(

807 
Arg
::
	`w™h_Çme
("to")

810 .
	`kes_v®ue
(
Œue
)

811 .
	`h–p
("setheƒnd„aw key, inƒscaped form"),

814 .
	`subcommªd
(

815 
SubCommªd
::
	`w™h_Çme
("tombstone")

816 .
	`about
("set‡„egion onhe‚odeoombstone by manual")

817 .
	`¬g
(

818 
Arg
::
	`w™h_Çme
("region")

819 .
	`»quœed
(
Œue
)

821 .
	`kes_v®ue
(
Œue
)

822 .
	`h–p
("thearget„egion"),

824 .
	`¬g
(

825 
Arg
::
	`w™h_Çme
("pd")

826 .
	`»quœed
(
Œue
)

828 .
	`kes_v®ue
(
Œue
)

829 .
	`muÉË
(
Œue
)

830 .
	`u£_d–im™”
(
Œue
)

831 .
	`»quœe_d–im™”
(
Œue
)

832 .
	`v®ue_d–im™”
(",")

833 .
	`h–p
("PDƒndpoints"),

836 
Ët
 
m©ches
 = 
­p
.
	`şÚe
().
	`g‘_m©ches
();

838 
Ët
 
hex_key
 = 
m©ches
.
	`v®ue_of
("hex-to-escaped");

839 
Ët
 
esÿ³d_key
 = 
m©ches
.
	`v®ue_of
("escaped-to-hex");

840 
	`m©ch
 (
hex_key
, 
esÿ³d_key
) {

841 (
	`Some
(
hex
), 
NÚe
) => {

842 
´šn
!("{}", 
	`esÿ³
(&
	`äom_hex
(
hex
)));

845 (
NÚe
, 
	`Some
(
esÿ³d
)) => {

846 
´šn
!("{}", &
	`uÃsÿ³
(
esÿ³d
).
	`to_hex
().
	`to_uµ”ÿ£
());

849 (
NÚe
, None) => {}

850 
_
 => 
uÄ—chabË
!(),

853 
Ët
 
db
 = 
m©ches
.
	`v®ue_of
("db");

854 
Ët
 
¿á_db
 = 
m©ches
.
	`v®ue_of
("raftdb");

855 
Ët
 
ho¡
 = 
m©ches
.
	`v®ue_of
("host");

857 
Ët
 
mgr
 = 
	`Ãw_£cur™y_mgr
(&
m©ches
);

858 
Ët
 
debug_executÜ
 = 
	`Ãw_debug_executÜ
(
db
, 
¿á_db
, 
ho¡
, 
mgr
.
	`şÚe
());

860 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("print") {

861 
Ët
 
cf
 = 
m©ches
.
	`v®ue_of
("cf").
	`unw¿p
();

862 
Ët
 
key
 = 
	`uÃsÿ³
(
m©ches
.
	`v®ue_of
("key").
	`unw¿p
());

863 
debug_executÜ
.
	`dump_v®ue
(
cf
, 
key
);

864 } 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("raft") {

865 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("log") {

866 
	`Ët
 (
id
, 
šdex
èğ
Ët
 
	`Some
(
key
èğ
m©ches
.
	`v®ue_of
("key") {

867 
keys
::
	`decode_¿á_log_key
(&
	`uÃsÿ³
(
key
)).
	`unw¿p
()

869 
Ët
 
id
 = 
m©ches
.
	`v®ue_of
("»giÚ").
	`unw¿p
().
	`·r£
().unwrap();

870 
Ët
 
šdex
 = 
m©ches
.
	`v®ue_of
("šdex").
	`unw¿p
().
	`·r£
().unwrap();

871 (
id
, 
šdex
)

873 
debug_executÜ
.
	`dump_¿á_log
(
id
, 
šdex
);

874 } 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("region") {

875 
Ët
 
sk_tomb¡Úe
 = 
m©ches
.
	`is_´e£Á
("skip-tombstone");

876 
Ët
 
	`Some
(
id
èğ
m©ches
.
	`v®ue_of
("region") {

877 
debug_executÜ
.
	`dump_»giÚ_šfo
(
id
.
	`·r£
().
	`unw¿p
(), 
sk_tomb¡Úe
);

879 
debug_executÜ
.
	`dump_®l_»giÚ_šfo
(
sk_tomb¡Úe
);

882 
Ët
 
_
 = 
­p
.
	`´št_h–p
();

884 } 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("size") {

885 
Ët
 
cfs
 = 
Vec
::
	`äom_™”
(
m©ches
.
	`v®ues_of
("cf").
	`unw¿p
());

886 
Ët
 
	`Some
(
id
èğ
m©ches
.
	`v®ue_of
("region") {

887 
debug_executÜ
.
	`dump_»giÚ_size
(
id
.
	`·r£
().
	`unw¿p
(), 
cfs
);

889 
debug_executÜ
.
	`dump_®l_»giÚ_size
(
cfs
);

891 } 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("scan") {

892 
Ët
 
äom
 = 
	`uÃsÿ³
(
m©ches
.
	`v®ue_of
("äom").
	`unw¿p
());

893 
Ët
 
to
 = 
m©ches
.
	`v®ue_of
("to").
	`m­
(|to| 
	`uÃsÿ³
(to));

894 
Ët
 
lim™
 = 
m©ches
.
	`v®ue_of
("lim™").
	`m­
(|
s
| s.
	`·r£
().
	`unw¿p
());

895 
Ët
 
cfs
 = 
Vec
::
	`äom_™”
(
m©ches
.
	`v®ues_of
("cf").
	`unw¿p
());

896 
Ët
 
¡¬t_ts
 = 
m©ches
.
	`v®ue_of
("¡¬t_ts").
	`m­
(|
s
| s.
	`·r£
().
	`unw¿p
());

897 
Ët
 
comm™_ts
 = 
m©ches
.
	`v®ue_of
("comm™_ts").
	`m­
(|
s
| s.
	`·r£
().
	`unw¿p
());

898 
debug_executÜ
.
	`dump_mvccs_šfos
(
äom
, 
to
, 
lim™
, 
cfs
, 
¡¬t_ts
, 
comm™_ts
);

899 } 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("mvcc") {

900 
Ët
 
äom
 = 
	`uÃsÿ³
(
m©ches
.
	`v®ue_of
("key").
	`unw¿p
());

901 
Ët
 
cfs
 = 
Vec
::
	`äom_™”
(
m©ches
.
	`v®ues_of
("cf").
	`unw¿p
());

902 
Ët
 
¡¬t_ts
 = 
m©ches
.
	`v®ue_of
("¡¬t_ts").
	`m­
(|
s
| s.
	`·r£
().
	`unw¿p
());

903 
Ët
 
comm™_ts
 = 
m©ches
.
	`v®ue_of
("comm™_ts").
	`m­
(|
s
| s.
	`·r£
().
	`unw¿p
());

904 
debug_executÜ
.
	`dump_mvccs_šfos
(
äom
, 
NÚe
, 
	`Some
(1), 
cfs
, 
¡¬t_ts
, 
comm™_ts
);

905 } 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("diff") {

906 
Ët
 
»giÚ
 = 
m©ches
.
	`v®ue_of
("»giÚ").
	`unw¿p
().
	`·r£
().unwrap();

907 
Ët
 
to_db
 = 
m©ches
.
	`v®ue_of
("to_db");

908 
Ët
 
to_ho¡
 = 
m©ches
.
	`v®ue_of
("to_host");

909 
debug_executÜ
.
	`diff_»giÚ
(
»giÚ
, 
to_db
, 
NÚe
, 
to_ho¡
, 
mgr
);

910 } 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("compact") {

911 
Ët
 
db
 = 
m©ches
.
	`v®ue_of
("db").
	`unw¿p
();

912 
Ët
 
db_ty³
 = 
db
 =ğ"kv" { 
DBTy³
::
KV
 } { DBTy³::
RAFT
 };

913 
Ët
 
cf
 = 
m©ches
.
	`v®ue_of
("cf").
	`unw¿p
();

914 
Ët
 
äom_key
 = 
m©ches
.
	`v®ue_of
("äom").
	`m­
(|
k
| 
	`uÃsÿ³
(k));

915 
Ët
 
to_key
 = 
m©ches
.
	`v®ue_of
("to").
	`m­
(|
k
| 
	`uÃsÿ³
(k));

916 
debug_executÜ
.
	`com·ù
(
db_ty³
, 
cf
, 
äom_key
, 
to_key
);

917 } 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("tombstone") {

918 
Ët
 
»giÚ
 = 
m©ches
.
	`v®ue_of
("»giÚ").
	`unw¿p
().
	`·r£
().unwrap();

919 
Ët
 
pd_u¾s
 = 
Vec
::
	`äom_™”
(
m©ches
.
	`v®ues_of
("pd").
	`unw¿p
().
	`m­
(|
u
| u.
	`to_owÃd
()));

920 
Ët
 
mut
 
cfg
 = 
PdCÚfig
::();

921 
cfg
.
’dpošts
 = 
pd_u¾s
;

922 
Ët
 
	`E¼
(
e
èğ
cfg
.
	`v®id©e
() {

923 
·nic
!("šv®id…d cÚfigu¿tiÚ: {:?}", 
e
);

925 
debug_executÜ
.
	`£t_»giÚ_tomb¡Úe_aá”_»move_³”
(
mgr
, &
cfg
, 
»giÚ
);

927 
Ët
 
_
 = 
­p
.
	`´št_h–p
();

930 
	}
}

932 
â
 
äom_hex
(
key
: &
¡r
è-> 
Vec
<
u8
> {

933 cÚ¡ 
HEX_PREFIX
: &
¡r
 = "0x";

934 
Ët
 
mut
 
	gs
 = 
SŒšg
::
äom
(
key
);

935 
	gs
.
¡¬ts_w™h
(
HEX_PREFIX
) {

936 
Ët
 
	gËn
 = 
s
.
Ën
();

937 
Ët
 
	gÃw_Ën
 = 
Ën
.
§tu¿tšg_sub
(
HEX_PREFIX
.len());

938 
	gs
.
Œunÿ‹
(
Ãw_Ën
);

940 
	gs
.
as_¡r
().
äom_hex
().
unw¿p
()

943 
â
 
cÚv”t_gbmb
(
mut
 
by‹s
: 
u64
è-> 
SŒšg
 {

944 cÚ¡ 
GB
: 
u64
 = 1024 * 1024 * 1024;

945 cÚ¡ 
	gMB
: 
u64
 = 1024 * 1024;

946 
	gby‹s
 < 
	gMB
 {

947  
	gby‹s
.
to_¡ršg
();

949 
Ët
 
	gmb
 = 
by‹s
 % 
GB
 == 0 {

950 
SŒšg
::
äom
("")

952 
fÜm©
!("{:.3} MB ", (
by‹s
 % 
GB
è
as
 
f64
 / 
MB
‡s f64)

954 
	gby‹s
 /ğ
GB
;

955 
Ët
 
	ggb
 = 
by‹s
 == 0 {

956 
SŒšg
::
äom
("")

958 
fÜm©
!("{} GB ", 
by‹s
)

960 
	gfÜm©
!("{}{}", 
	ggb
, 
	gmb
)

963 
â
 
Ãw_£cur™y_mgr
(
m©ches
: &
ArgM©ches
è-> 
Arc
<
Secur™yMªag”
> {

964 
Ët
 
ÿ_·th
 = 
m©ches
.
v®ue_of
("ca_path");

965 
Ët
 
	gû¹_·th
 = 
m©ches
.
v®ue_of
("cert_path");

966 
Ët
 
	gkey_·th
 = 
m©ches
.
v®ue_of
("key_path");

968 
Ët
 
mut
 
	gcfg
 = 
Secur™yCÚfig
::();

969 
	gÿ_·th
.
is_nÚe
(è&& 
	gû¹_·th
.is_nÚe(è&& 
	gkey_·th
.is_none() {

970  
	gArc
::
Ãw
(
Secur™yMªag”
::Ãw(&
cfg
).
unw¿p
());

973 
	gÿ_·th
.
is_nÚe
(è|| 
	gû¹_·th
.is_nÚe(è|| 
	gkey_·th
.is_none() {

974 
	g·nic
!("CA certificate‡nd…rivate key should‡ll be set.");

976 
	gcfg
.
	gÿ_·th
 = 
ÿ_·th
.
unw¿p
().
to_owÃd
();

977 
	gcfg
.
	gû¹_·th
 = 
û¹_·th
.
unw¿p
().
to_owÃd
();

978 
	gcfg
.
	gkey_·th
 = 
key_·th
.
unw¿p
().
to_owÃd
();

979 
	gArc
::
Ãw
(

980 
Secur™yMªag”
::
Ãw
(&
cfg
).
ex³ù
("failedo initialize security manager"),

	@src/bin/tikv-fail.rs

14 #![
ã©u»
(
¶ugš
)]

15 #![
cfg_©Œ
(
ã©u»
 = "dev", 
¶ugš
(
şpy
))]

29 
ü©e
 
tikv
;

30 
ü©e
 
ş­
;

31 
ü©e
 
g½cio
 
as
 
g½c
;

32 
ü©e
 
´Ùobuf
;

33 
ü©e
 
kv´Ùo
;

35 
u£
 
	g¡d
::
fs
;

36 
u£
 
	g¡d
::
io
::{
BufR—d
, 
	gBufR—d”
};

37 
u£
 
	g¡d
::
¡r
;

38 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

39 
u£
 
	g¡d
::
sync
::
Arc
;

41 
u£
 
	gş­
::{
Aµ
, 
	gArg
, 
	gSubCommªd
};

42 
u£
 
	gg½c
::{
C®lO±iÚ
, 
	gChªÃlBud”
, 
	gEnvBud”
};

43 
u£
 
	gkv´Ùo
::
debugpb
;

44 
u£
 
	gkv´Ùo
::
debugpb_g½c
::
DebugCl›Á
;

46 
â
 
	$maš
() {

47 
Ët
 
­p
 = 
Aµ
::
	`Ãw
("TiKV fail…oint")

48 .
	`authÜ
("PingCAP")

49 .
	`about
("Aool for injecting failureso TiKV‡nd„ecovery")

50 .
	`¬g
(

51 
Arg
::
	`w™h_Çme
("addr")

53 .
	`kes_v®ue
(
Œue
)

54 .
	`h–p
("setikv ip:port"),

56 .
	`subcommªd
(

57 
SubCommªd
::
	`w™h_Çme
("inject")

58 .
	`about
("Inject failures")

59 .
	`¬g
(

60 
Arg
::
	`w™h_Çme
("args")

61 .
	`muÉË
(
Œue
)

62 .
	`kes_v®ue
(
Œue
)

63 .
	`h–p
(

68 .
	`¬g
(

69 
Arg
::
	`w™h_Çme
("file")

71 .
	`kes_v®ue
(
Œue
)

72 .
	`h–p
("Read‡ file of fail…oints‡nd‡ctionso inject"),

75 .
	`subcommªd
(

76 
SubCommªd
::
	`w™h_Çme
("recover")

77 .
	`about
("Recover failures")

78 .
	`¬g
(

79 
Arg
::
	`w™h_Çme
("args")

80 .
	`muÉË
(
Œue
)

81 .
	`kes_v®ue
(
Œue
)

82 .
	`h–p
("Recover fail…oints. Eg.ikv-fail„ecover fail::a fail::b"),

84 .
	`¬g
(

85 
Arg
::
	`w™h_Çme
("file")

87 .
	`kes_v®ue
(
Œue
)

88 .
	`h–p
("Recover from‡ file of fail…oints"),

91 .
	`subcommªd
(
SubCommªd
::
	`w™h_Çme
("li¡").
	`about
("List‡ll fail…oints"));

92 
Ët
 
m©ches
 = 
­p
.
	`şÚe
().
	`g‘_m©ches
();

93 
Ët
 
addr
 = 
m©ches
.
	`v®ue_of
("addr").
	`unw¿p
();

94 
Ët
 
addr
 =‡ddr.
	`Œim_Ëá_m©ches
("http://");

96 
Ët
 
’v
 = 
Arc
::
	`Ãw
(
EnvBud”
::Ãw().
	`Çme_´efix
("tikv-ç").
	`bud
());

97 
Ët
 
chªÃl
 = 
ChªÃlBud”
::
	`Ãw
(
’v
).
	`cÚÃù
(
addr
);

98 
Ët
 
ş›Á
 = 
DebugCl›Á
::
	`Ãw
(
chªÃl
);

100 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("inject") {

101 
Ët
 
mut
 
li¡
 = 
m©ches
.
	`v®ue_of
("fe").
	`m­_Ü_–£
(
Vec
::
Ãw
, 
»ad_fe
);

102 
Ët
 
	`Some
(
ps
èğ
m©ches
.
	`v®ues_of
("args") {

103 
·œ
 
š
 
ps
 {

104 
Ët
 
mut
 
·¹s
 = 
·œ
.
	`¥l™
('=');

105 
li¡
.
	`push
((

106 
·¹s
.
	`Ãxt
().
	`unw¿p
().
	`to_owÃd
(),

107 
·¹s
.
	`Ãxt
().
	`unw¿p_Ü
("").
	`to_owÃd
(),

112 
Çme
, 
aùiÚs
è
š
 
li¡
 {

113 
aùiÚs
.
	`is_em±y
() {

114 
´šn
!("NØaùiÚ fÜ fa…ošˆ{}", 
Çme
);

117 
Ët
 
mut
 
šjeù_»q
 = 
debugpb
::
InjeùFaPoštReque¡
::
	`Ãw
();

118 
šjeù_»q
.
	`£t_Çme
(
Çme
);

119 
šjeù_»q
.
	`£t_aùiÚs
(
aùiÚs
);

121 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
	`timeout
(
Du¿tiÚ
::
	`äom_£cs
(10));

122 
ş›Á
.
	`šjeù_ç_pošt_İt
(
šjeù_»q
, 
İtiÚ
).
	`unw¿p
();

124 } 
Ët
 
	`Some
(
m©ches
èğm©ches.
	`subcommªd_m©ches
("recover") {

125 
Ët
 
mut
 
li¡
 = 
m©ches
.
	`v®ue_of
("fe").
	`m­_Ü_–£
(
Vec
::
Ãw
, 
»ad_fe
);

126 
Ët
 
	`Some
(
ås
èğ
m©ches
.
	`v®ues_of
("args") {

127 
å
 
š
 
ås
 {

128 
li¡
.
	`push
((
å
.
	`to_owÃd
(), "".to_owned()))

132 
Çme
, 
_
è
š
 
li¡
 {

133 
Ët
 
mut
 
»cov”_»q
 = 
debugpb
::
Recov”FaPoštReque¡
::
	`Ãw
();

134 
»cov”_»q
.
	`£t_Çme
(
Çme
);

136 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
	`timeout
(
Du¿tiÚ
::
	`äom_£cs
(10));

137 
ş›Á
.
	`»cov”_ç_pošt_İt
(
»cov”_»q
, 
İtiÚ
).
	`unw¿p
();

139 } 
m©ches
.
	`is_´e£Á
("list") {

140 
Ët
 
li¡_»q
 = 
debugpb
::
Li¡FaPoštsReque¡
::
	`Ãw
();

141 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
	`timeout
(
Du¿tiÚ
::
	`äom_£cs
(10));

142 
Ët
 
»¥
 = 
ş›Á
.
	`li¡_ç_pošts_İt
(
li¡_»q
, 
İtiÚ
).
	`unw¿p
();

143 
´šn
!("{:?}", 
»¥
.
	`g‘_’Œ›s
());

145 
	}
}

147 
â
 
»ad_fe
(
·th
: &
¡r
è-> 
Vec
<(
SŒšg
, 
	gSŒšg
)> {

148 
Ët
 
	gf
 = 
fs
::
Fe
::
İ’
(
·th
).
unw¿p
();

149 
Ët
 
	gf
 = 
BufR—d”
::
Ãw
(
f
);

151 
Ët
 
mut
 
	gli¡
 = 
vec
![];

152 
lše
 
š
 
	gf
.
lšes
() {

153 
Ët
 
	glše
 = 
lše
.
unw¿p
();

154 
Ët
 
mut
 
	g·¹s
 = 
lše
.
¥l™
('=');

155 
	gli¡
.
push
((

156 
·¹s
.
Ãxt
().
unw¿p
().
to_owÃd
(),

157 
·¹s
.
Ãxt
().
unw¿p_Ü
("").
to_owÃd
(),

160 
	gli¡


	@src/bin/tikv-server.rs

14 #![
ã©u»
(
¶ugš
)]

15 #![
ã©u»
(
¦iû_·‰”ns
)]

16 #![
cfg_©Œ
(
ã©u»
 = "dev", 
¶ugš
(
şpy
))]

17 #![
cfg_©Œ
(
nÙ
(
ã©u»
 = "dev"), 
®low
(
unknown_lšts
))]

18 #![
®low
(
ÃedËss_·ss_by_v®ue
)]

19 #![
®low
(
uÄ—dabË_l™”®
)]

21 #![
®low
(
logic_bug
)]

23 #[
maüo_u£
]

24 
ü©e
 
ş­
;

25 #[
cfg
(
ã©u»
 = "mem-profiling")]

26 
ü©e
 
jem®loÿtÜ
;

27 
ü©e
 
tikv
;

28 #[
maüo_u£
]

29 
ü©e
 
log
;

30 
ü©e
 
rocksdb
;

31 
ü©e
 
toml
;

32 
ü©e
 
libc
;

33 
ü©e
 
fs2
;

34 #[
cfg
(
unix
)]

35 
ü©e
 
sigÇl
;

36 #[
cfg
(
unix
)]

37 
ü©e
 
nix
;

38 
ü©e
 
´om‘heus
;

39 
ü©e
 
£rde_jsÚ
;

41 
mod
 
	gsigÇl_hªdËr
;

42 #[
cfg
(
unix
)]

43 
mod
 
	g´ofšg
;

45 
u£
 
	g¡d
::
”rÜ
::
E¼Ü
;

46 
u£
 
	g¡d
::
´oûss
;

47 
u£
 
	g¡d
::
fs
::
Fe
;

48 
u£
 
	g¡d
::
usize
;

49 
u£
 
	g¡d
::
·th
::
P©h
;

50 
u£
 
	g¡d
::
sync
::{
mpsc
, 
	gArc
};

51 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicBoŞ
, 
	gOrd”šg
, 
	gATOMIC_BOOL_INIT
};

52 
u£
 
	g¡d
::
io
::
R—d
;

53 
u£
 
	g¡d
::
’v
;

54 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

56 
u£
 
	gş­
::{
Aµ
, 
	gArg
, 
	gArgM©ches
};

57 
u£
 
	gfs2
::
FeExt
;

59 
u£
 
	gtikv
::
cÚfig
::{
M‘ricCÚfig
, 
	gTiKvCÚfig
};

60 
u£
 
	gtikv
::
ut
::{
£lf
, 
	g·nic_hook
, 
rocksdb
 
as
 
	grocksdb_ut
};

61 
u£
 
	gtikv
::
ut
::
cŞËùiÚs
::
HashM­
;

62 
u£
 
	gtikv
::
ut
::
logg”
::{
£lf
, 
	gStd”rLogg”
};

63 
u£
 
	gtikv
::
ut
::
fe_log
::
RÙ©šgFeLogg”
;

64 
u£
 
	gtikv
::
ut
::
£cur™y
::
Secur™yMªag”
;

65 
u£
 
	gtikv
::
ut
::
Œª¥Üt
::
S’dCh
;

66 
u£
 
	gtikv
::
ut
::
wÜk”
::
Futu»WÜk”
;

67 
u£
 
	gtikv
::
ut
::
io_lim™”
::
IOLim™”
;

68 
u£
 
	gtikv
::
¡Üage
::
DEFAULT_ROCKSDB_SUB_DIR
;

69 
u£
 
	gtikv
::
£rv”
::{
ü—‹_¿á_¡Üage
, 
	gNode
, 
	gS”v”
, 
	gDEFAULT_CLUSTER_ID
};

70 
u£
 
	gtikv
::
£rv”
::
Œª¥Üt
::
S”v”RaáStÜeRou‹r
;

71 
u£
 
	gtikv
::
£rv”
::
»sŞve
;

72 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::{
£lf
, 
	gEngšes
, 
	gSÇpMªag”
};

73 
u£
 
	gtikv
::
¿á¡Üe
::
cİroûssÜ
::
CİroûssÜHo¡
;

74 
u£
 
	gtikv
::
pd
::{
PdCl›Á
, 
	gRpcCl›Á
};

75 
u£
 
	gtikv
::
ut
::
time
::
MÚ™Ü
;

76 
u£
 
	gtikv
::
ut
::
rocksdb
::
m‘rics_æush”
::{
M‘ricsFlush”
, 
	gDEFAULT_FLUSHER_INTERVAL
};

78 cÚ¡ 
	gRESERVED_OPEN_FDS
: 
u64
 = 1000;

81 
	gLOG_INITIALIZED
: 
AtomicBoŞ
 = 
ATOMIC_BOOL_INIT
;

83 
	gmaüo_ruËs
! 
	gçl
 {

84 (
	g$lvl
:
ex´
, 
$
(
$¬g
:
‰
)+) => ({

85 
LOG_INITIALIZED
.
lßd
(
Ord”šg
::
SeqC¡
) {

86 
”rÜ
!(
$lvl
, 
$
(
$¬g
)+);

88 
	g•ršn
!(
	g$lvl
, 
$
(
$¬g
)+);

90 
	g´oûss
::
ex™
(1)

94 
â
 
	$š™_log
(
cÚfig
: &
TiKvCÚfig
) {

95 
cÚfig
.
log_fe
.
	`is_em±y
() {

96 
logg”
::
	`š™_log
(
Std”rLogg”
, 
cÚfig
.
log_Ëv–
).
	`unw¿p_Ü_–£
(|
e
| {

97 
çl
!("çedØš™ŸÈlog: {:?}", 
e
);

100 
Ët
 
w
 = 
RÙ©šgFeLogg”
::
	`Ãw
(&
cÚfig
.
log_fe
).
	`unw¿p_Ü_–£
(|
e
| {

101 
çl
!(

103 
cÚfig
.
log_fe
,

104 
e


107 
logg”
::
	`š™_log
(
w
, 
cÚfig
.
log_Ëv–
).
	`unw¿p_Ü_–£
(|
e
| {

108 
çl
!("çedØš™ŸÈlog: {:?}", 
e
);

111 
LOG_INITIALIZED
.
	`¡Üe
(
Œue
, 
Ord”šg
::
SeqC¡
);

112 
	}
}

114 
â
 
š™Ÿl_m‘ric
(
cfg
: &
M‘ricCÚfig
, 
node_id
: 
O±iÚ
<
u64
>) {

115 
cfg
.
š‹rv®
.
as_£cs
(è=ğ0 || cfg.
add»ss
.
is_em±y
() {

119 
Ët
 
mut
 
	gpush_job
 = 
cfg
.
job
.
şÚe
();

120 
Ët
 
Some
(
id
èğ
node_id
 {

121 
push_job
.
push_¡r
(&
fÜm©
!("_{}", 
id
));

124 
	gšfo
!("start…rometheus client");

126 
	gut
::
mÚ™Ü_th»ads
("tikv")

127 .
unw¿p_Ü_–£
(|
e
| 
çl
!("failedo start monitorhread: {:?}",ƒ));

129 
	gut
::
run_´om‘heus
(
cfg
.
š‹rv®
.0, &cfg.
add»ss
, &
push_job
);

132 
â
 
	$check_sy¡em_cÚfig
(
cÚfig
: &
TiKvCÚfig
) {

133 
Ët
 
	`E¼
(
e
èğ
ut
::
cÚfig
::
	`check_max_İ’_fds
(

134 
RESERVED_OPEN_FDS
 + (
cÚfig
.
rocksdb
.
max_İ’_fes
 + cÚfig.
¿ádb
.max_İ’_fesè
as
 
u64
,

136 
çl
!("{:?}", 
e
);

139 
e
 
š
 
ut
::
cÚfig
::
	`check_k”Ãl
() {

140 
w¬n
!("{:?}", 
e
);

143 
cfg
!(
unix
è&& 
’v
::
	`v¬
("TZ").
	`is_”r
() {

144 
’v
::
	`£t_v¬
("TZ", ":/etc/localtime");

145 
w¬n
!("environment variable `TZ` is missing, use `/etc/localtime`");

147 
	}
}

149 
â
 
run_¿á_£rv”
(
pd_ş›Á
: 
RpcCl›Á
, 
cfg
: &
TiKvCÚfig
, 
£cur™y_mgr
: 
Arc
<
Secur™yMªag”
>) {

150 
Ët
 
¡Üe_·th
 = 
P©h
::
Ãw
(&
cfg
.
¡Üage
.
d©a_dœ
);

151 
Ët
 
	glock_·th
 = 
¡Üe_·th
.
još
(
P©h
::
Ãw
("LOCK"));

152 
Ët
 
	gdb_·th
 = 
¡Üe_·th
.
još
(
P©h
::
Ãw
(
DEFAULT_ROCKSDB_SUB_DIR
));

153 
Ët
 
	g¢­_·th
 = 
¡Üe_·th
.
još
(
P©h
::
Ãw
("snap"));

154 
Ët
 
	g¿á_db_·th
 = 
P©h
::
Ãw
(&
cfg
.
¿á_¡Üe
.
¿ádb_·th
);

156 
Ët
 
	gf
 = 
Fe
::
ü—‹
(
lock_·th
.
as_·th
()).
unw¿p_Ü_–£
(|
e
| {

157 
çl
!("çedØü—‹†ock‡ˆ{}: {:?}", 
lock_·th
.
di¥Ïy
(), 
e
)

159 
	gf
.
Œy_lock_exşusive
().
is_”r
() {

160 
	gçl
!(

162 
	g¡Üe_·th


167 
Ët
 
mut
 
	gev’t_loİ
 = 
¡Üe
::
ü—‹_ev’t_loİ
(&
cfg
.
¿á_¡Üe
)

168 .
unw¿p_Ü_–£
(|
e
| 
çl
!("failedo createƒvent†oop: {:?}",ƒ));

169 
Ët
 
	g¡Üe_£ndch
 = 
S’dCh
::
Ãw
(
ev’t_loİ
.
chªÃl
(), "raftstore");

170 
Ët
 (
signifiÿÁ_msg_£nd”
, 
signifiÿÁ_msg_»ûiv”
èğ
mpsc
::
chªÃl
();

171 
Ët
 
	g¿á_rou‹r
 = 
S”v”RaáStÜeRou‹r
::
Ãw
(
¡Üe_£ndch
.
şÚe
(), 
signifiÿÁ_msg_£nd”
);

174 
Ët
 
	gkv_db_İts
 = 
cfg
.
rocksdb
.
bud_İt
();

175 
Ët
 
	gkv_cfs_İts
 = 
cfg
.
rocksdb
.
bud_cf_İts
();

176 
Ët
 
	gkv_’gše
 = 
Arc
::
Ãw
(

177 
rocksdb_ut
::
Ãw_’gše_İt
(
db_·th
.
to_¡r
().
unw¿p
(), 
kv_db_İts
, 
kv_cfs_İts
)

178 .
unw¿p_Ü_–£
(|
s
| 
çl
!("failedo create kvƒngine: {:?}", s)),

180 
Ët
 
mut
 
	g¡Üage
 = 
ü—‹_¿á_¡Üage
(
¿á_rou‹r
.
şÚe
(), 
kv_’gše
.şÚe(), &
cfg
.
¡Üage
)

181 .
unw¿p_Ü_–£
(|
e
| 
çl
!("failedo create„aft stroage: {:?}",ƒ));

184 
Ët
 
	g¿á_db_İts
 = 
cfg
.
¿ádb
.
bud_İt
();

185 
Ët
 
	g¿á_db_cf_İts
 = 
cfg
.
¿ádb
.
bud_cf_İts
();

186 
Ët
 
	g¿á_’gše
 = 
Arc
::
Ãw
(

187 
rocksdb_ut
::
Ãw_’gše_İt
(

188 
¿á_db_·th
.
to_¡r
().
unw¿p
(),

189 
¿á_db_İts
,

190 
¿á_db_cf_İts
,

191 ).
unw¿p_Ü_–£
(|
s
| 
çl
!("failedo create„aftƒngine: {:?}", s)),

193 
Ët
 
	g’gšes
 = 
Engšes
::
Ãw
(
kv_’gše
.
şÚe
(), 
¿á_’gše
.clone());

196 
Ët
 
	gpd_ş›Á
 = 
Arc
::
Ãw
(
pd_ş›Á
);

197 
Ët
 
	gpd_wÜk”
 = 
Futu»WÜk”
::
Ãw
("pd worker");

198 
Ët
 (
mut
 
wÜk”
, 
»sŞv”
èğ
»sŞve
::
Ãw_»sŞv”
(
pd_ş›Á
.
şÚe
())

199 .
unw¿p_Ü_–£
(|
e
| 
çl
!("failedo start‡ddress„esolver: {:?}",ƒ));

200 
Ët
 
	glim™”
 = 
cfg
.
£rv”
.
¢­_max_wr™e_by‹s_³r_£c
.0 > 0 {

201 
Some
(
Arc
::
Ãw
(

202 
IOLim™”
::
Ãw
(
cfg
.
£rv”
.
¢­_max_wr™e_by‹s_³r_£c
.0),

205 
NÚe


207 
Ët
 
	g¢­_mgr
 = 
SÇpMªag”
::
Ãw
(

208 
¢­_·th
.
as_·th
().
to_¡r
().
unw¿p
().
to_owÃd
(),

209 
Some
(
¡Üe_£ndch
),

210 
lim™”
,

213 
Ët
 
	g£rv”_cfg
 = 
Arc
::
Ãw
(
cfg
.
£rv”
.
şÚe
());

215 
Ët
 
mut
 
	g£rv”
 = 
S”v”
::
Ãw
(

216 &
£rv”_cfg
,

217 &
£cur™y_mgr
,

218 
cfg
.
cİroûssÜ
.
»giÚ_¥l™_size
.0 
as
 
usize
,

219 
¡Üage
.
şÚe
(),

220 
¿á_rou‹r
,

221 
»sŞv”
,

222 
¢­_mgr
.
şÚe
(),

223 
pd_wÜk”
.
scheduËr
(),

224 
Some
(
’gšes
.
şÚe
()),

225 ).
unw¿p_Ü_–£
(|
e
| 
çl
!("failedo create server: {:?}",ƒ));

226 
Ët
 
	gŒªs
 = 
£rv”
.
Œª¥Üt
();

229 
Ët
 
mut
 
	gnode
 = 
Node
::
Ãw
(&muˆ
ev’t_loİ
, &
£rv”_cfg
, &
cfg
.
¿á_¡Üe
, 
pd_ş›Á
);

232 
Ët
 
	gcİroûssÜ_ho¡
 = 
CİroûssÜHo¡
::
Ãw
(
cfg
.
cİroûssÜ
.
şÚe
(), 
node
.
g‘_£ndch
());

234 
	gnode
.
¡¬t
(

235 
ev’t_loİ
,

236 
’gšes
.
şÚe
(),

237 
Œªs
,

238 
¢­_mgr
,

239 
signifiÿÁ_msg_»ûiv”
,

240 
pd_wÜk”
,

241 
cİroûssÜ_ho¡
,

242 ).
unw¿p_Ü_–£
(|
e
| 
çl
!("failedo start‚ode: {:?}",ƒ));

243 
š™Ÿl_m‘ric
(&
cfg
.
m‘ric
, 
Some
(
node
.
id
()));

246 
	gšfo
!("start storage");

247 
Ët
 
E¼
(
e
èğ
¡Üage
.
¡¬t
(&
cfg
.storage) {

248 
çl
!("çedØ¡¬ˆ¡Üage,ƒ¼Ü: {:?}", 
e
);

251 
Ët
 
mut
 
	gm‘rics_æush”
 = 
M‘ricsFlush”
::
Ãw
(

252 
’gšes
.
şÚe
(),

253 
Du¿tiÚ
::
äom_mlis
(
DEFAULT_FLUSHER_INTERVAL
),

257 
Ët
 
E¼
(
e
èğ
m‘rics_æush”
.
¡¬t
() {

258 
”rÜ
!("çedØ¡¬ˆm‘ric æush”,ƒ¼Ü: {:?}", 
e
);

262 
	g£rv”


263 .
¡¬t
(
£rv”_cfg
, 
£cur™y_mgr
)

264 .
unw¿p_Ü_–£
(|
e
| 
çl
!("failedo start server: {:?}",ƒ));

265 
	gsigÇl_hªdËr
::
hªdË_sigÇl
(
’gšes
, &
cfg
.
rocksdb
.
backup_dœ
);

268 
	g£rv”


269 .
¡İ
()

270 .
unw¿p_Ü_–£
(|
e
| 
çl
!("failedo stop server: {:?}",ƒ));

272 
	gm‘rics_æush”
.
¡İ
();

274 
	gnode
.
¡İ
()

275 .
unw¿p_Ü_–£
(|
e
| 
çl
!("failedo stop‚ode: {:?}",ƒ));

276 
Ët
 
Some
(
E¼
(
e
)èğ
wÜk”
.
¡İ
().
m­
(|
j
| j.
još
()) {

277 
šfo
!("ignÜçu» wh’ stİpšg„esŞv”: {:?}", 
e
);

281 
â
 
	$ov”wr™e_cÚfig_w™h_cmd_¬gs
(
cÚfig
: &
mut
 
TiKvCÚfig
, 
m©ches
: &
ArgM©ches
) {

282 
Ët
 
	`Some
(
Ëv–
èğ
m©ches
.
	`v®ue_of
("log-level") {

283 
cÚfig
.
log_Ëv–
 = 
logg”
::
	`g‘_Ëv–_by_¡ršg
(
Ëv–
);

286 
Ët
 
	`Some
(
fe
èğ
m©ches
.
	`v®ue_of
("log-file") {

287 
cÚfig
.
log_fe
 = 
fe
.
	`to_owÃd
();

290 
Ët
 
	`Some
(
addr
èğ
m©ches
.
	`v®ue_of
("addr") {

291 
cÚfig
.
£rv”
.
addr
 =‡ddr.
	`to_owÃd
();

294 
Ët
 
	`Some
(
adv”ti£_addr
èğ
m©ches
.
	`v®ue_of
("advertise-addr") {

295 
cÚfig
.
£rv”
.
adv”ti£_addr
 =‡dv”ti£_addr.
	`to_owÃd
();

298 
Ët
 
	`Some
(
d©a_dœ
èğ
m©ches
.
	`v®ue_of
("data-dir") {

299 
cÚfig
.
¡Üage
.
d©a_dœ
 = d©a_dœ.
	`to_owÃd
();

302 
Ët
 
	`Some
(
’dpošts
èğ
m©ches
.
	`v®ues_of
("pd-endpoints") {

303 
cÚfig
.
pd
.
’dpošts
 =ƒndpošts.
	`m­
(|
e
|ƒ.
	`to_owÃd
()).
	`cŞËù
();

306 
Ët
 
	`Some
(
Ïb–s_vec
èğ
m©ches
.
	`v®ues_of
("labels") {

307 
Ët
 
mut
 
Ïb–s
 = 
HashM­
::();

308 
Ïb–s_vec


309 .
	`m­
(|
s
| {

310 
Ët
 
mut
 
·¹s
 = 
s
.
	`¥l™
('=');

311 
Ët
 
key
 = 
·¹s
.
	`Ãxt
().
	`unw¿p
().
	`to_owÃd
();

312 
Ët
 
v®ue
 = 
m©ch
 
·¹s
.
	`Ãxt
() {

313 
NÚe
 => 
çl
!("šv®id†ab–: {:?}", 
s
),

314 
	`Some
(
v
è=> v.
	`to_owÃd
(),

316 
·¹s
.
	`Ãxt
().
	`is_some
() {

317 
çl
!("šv®id†ab–: {:?}", 
s
);

319 
Ïb–s
.
	`š£¹
(
key
, 
v®ue
);

321 .
	`couÁ
();

322 
cÚfig
.
£rv”
.
Ïb–s
 =†abels;

325 
Ët
 
	`Some
(
ÿ·c™y_¡r
èğ
m©ches
.
	`v®ue_of
("capacity") {

326 
Ët
 
ÿ·c™y
 = 
ÿ·c™y_¡r
.
	`·r£
().
	`unw¿p_Ü_–£
(|
e
| {

327 
çl
!("šv®id c­ac™y: {}", 
e
);

329 
cÚfig
.
¿á_¡Üe
.
ÿ·c™y
 = capacity;

331 
	}
}

333 
â
 
	$maš
() {

334 
Ët
 
lÚg_v”siÚ
: 
SŒšg
 = {

335 
	`Ët
 (
hash
, 
b¿nch
, 
time
, 
ru¡_v”
èğ
ut
::
	`bud_šfo
();

336 
fÜm©
!(

342 
ü©e_v”siÚ
!(),

343 
hash
,

344 
b¿nch
,

345 
time
,

346 
ru¡_v”


349 
Ët
 
m©ches
 = 
Aµ
::
	`Ãw
("TiKV")

350 .
	`lÚg_v”siÚ
(
lÚg_v”siÚ
.
	`as_»f
())

351 .
	`authÜ
("PingCAP Inc. <info@pingcap.com>")

352 .
	`about
(

355 .
	`¬g
(

356 
Arg
::
	`w™h_Çme
("config")

359 .
	`v®ue_Çme
("FILE")

360 .
	`h–p
("Sets config file")

361 .
	`kes_v®ue
(
Œue
),

363 .
	`¬g
(

364 
Arg
::
	`w™h_Çme
("addr")

367 .
	`kes_v®ue
(
Œue
)

368 .
	`v®ue_Çme
("IP:PORT")

369 .
	`h–p
("Sets†istening‡ddress"),

371 .
	`¬g
(

372 
Arg
::
	`w™h_Çme
("advertise-addr")

374 .
	`kes_v®ue
(
Œue
)

375 .
	`v®ue_Çme
("IP:PORT")

376 .
	`h–p
("Sets‡dvertise†istening‡ddress for client communication"),

378 .
	`¬g
(

379 
Arg
::
	`w™h_Çme
("log-level")

382 .
	`®Ÿs
("log")

383 .
	`kes_v®ue
(
Œue
)

384 .
	`v®ue_Çme
("LEVEL")

385 .
	`possibË_v®ues
(&["trace", "debug", "info", "warn", "error", "off"])

386 .
	`h–p
("Sets†og†evel"),

388 .
	`¬g
(

389 
Arg
::
	`w™h_Çme
("log-file")

392 .
	`kes_v®ue
(
Œue
)

393 .
	`v®ue_Çme
("FILE")

394 .
	`h–p
("Sets†og file")

395 .
	`lÚg_h–p
("Sets†og file. If‚ot set, output†ogo stderr"),

397 .
	`¬g
(

398 
Arg
::
	`w™h_Çme
("data-dir")

401 .
	`®Ÿs
("store")

402 .
	`kes_v®ue
(
Œue
)

403 .
	`v®ue_Çme
("PATH")

404 .
	`h–p
("Setshe…atho store directory"),

406 .
	`¬g
(

407 
Arg
::
	`w™h_Çme
("capacity")

409 .
	`kes_v®ue
(
Œue
)

410 .
	`v®ue_Çme
("CAPACITY")

411 .
	`h–p
("Setshe store capacity")

412 .
	`lÚg_h–p
("Setshe store capacity. If‚ot set, useƒntire…artition"),

414 .
	`¬g
(

415 
Arg
::
	`w™h_Çme
("pd-endpoints")

417 .
	`®Ÿ£s
(&["pd", "pd-endpoint"])

418 .
	`kes_v®ue
(
Œue
)

419 .
	`v®ue_Çme
("PD_URL")

420 .
	`muÉË
(
Œue
)

421 .
	`u£_d–im™”
(
Œue
)

422 .
	`»quœe_d–im™”
(
Œue
)

423 .
	`v®ue_d–im™”
(",")

424 .
	`h–p
("Sets PDƒndpoints")

425 .
	`lÚg_h–p
("Sets PDƒndpoints. Uses `,`o separate multiple PDs"),

427 .
	`¬g
(

428 
Arg
::
	`w™h_Çme
("labels")

430 .
	`®Ÿs
("label")

431 .
	`kes_v®ue
(
Œue
)

432 .
	`v®ue_Çme
("KEY=VALUE")

433 .
	`muÉË
(
Œue
)

434 .
	`u£_d–im™”
(
Œue
)

435 .
	`»quœe_d–im™”
(
Œue
)

436 .
	`v®ue_d–im™”
(",")

437 .
	`h–p
("Sets server†abels")

438 .
	`lÚg_h–p
(

443 .
	`¬g
(

444 
Arg
::
	`w™h_Çme
("print-sample-config")

446 .
	`h–p
("Print‡ sample configo stdout"),

448 .
	`g‘_m©ches
();

450 
m©ches
.
	`is_´e£Á
("print-sample-config") {

451 
Ët
 
cÚfig
 = 
TiKvCÚfig
::();

452 
´šn
!("{}", 
toml
::
	`to_¡ršg_´‘ty
(&
cÚfig
).
	`unw¿p
());

453 
´oûss
::
	`ex™
(0);

456 
Ët
 
mut
 
cÚfig
 = 
m©ches
.
	`v®ue_of
("cÚfig").
	`m­_Ü_–£
(

457 
TiKvCÚfig
::,

458 |
·th
| {

459 
Fe
::
	`İ’
(&
·th
)

460 .
m­_”r
::<
Box
<
E¼Ü
>, 
_
>(|
e
| Box::
	`Ãw
(e))

461 .
	`ªd_th’
(|
mut
 
f
| {

462 
Ët
 
mut
 
s
 = 
SŒšg
::
	`Ãw
();

463 
f
.
	`»ad_to_¡ršg
(&
mut
 
s
)?;

464 
Ët
 
c
 = 
toml
::
	`äom_¡r
(&
s
)?;

465 
	`Ok
(
c
)

467 .
	`unw¿p_Ü_–£
(|
e
| {

468 
çl
!("šv®id cÚfigu¿tiÚ f{:?}: {}", 
·th
, 
e
);

473 
	`ov”wr™e_cÚfig_w™h_cmd_¬gs
(&
mut
 
cÚfig
, &
m©ches
);

478 
	`š™_log
(&
cÚfig
);

481 
ut
::
	`´št_tikv_šfo
();

483 
·nic_hook
::
	`£t_ex™_hook
();

485 
cÚfig
.
	`com·tibË_adju¡
();

486 
Ët
 
	`E¼
(
e
èğ
cÚfig
.
	`v®id©e
() {

487 
çl
!("šv®id cÚfigu¿tiÚ: {:?}", 
e
);

489 
šfo
!(

491 
£rde_jsÚ
::
	`to_¡ršg_´‘ty
(&
cÚfig
).
	`unw¿p
()

495 
	`check_sy¡em_cÚfig
(&
cÚfig
);

497 
Ët
 
£cur™y_mgr
 = 
Arc
::
	`Ãw
(

498 
Secur™yMªag”
::
	`Ãw
(&
cÚfig
.
£cur™y
)

499 .
	`unw¿p_Ü_–£
(|
e
| 
çl
!("failedo create security manager: {:?}",ƒ)),

501 
Ët
 
pd_ş›Á
 = 
RpcCl›Á
::
	`Ãw
(&
cÚfig
.
pd
, 
£cur™y_mgr
.
	`şÚe
())

502 .
	`unw¿p_Ü_–£
(|
e
| 
çl
!("failedo create„pc client: {:?}",ƒ));

503 
Ët
 
şu¡”_id
 = 
pd_ş›Á


504 .
	`g‘_şu¡”_id
()

505 .
	`unw¿p_Ü_–£
(|
e
| 
çl
!("failedo get cluster id: {:?}",ƒ));

506 
şu¡”_id
 =ğ
DEFAULT_CLUSTER_ID
 {

507 
çl
!("şu¡” id cª'ˆb{}", 
DEFAULT_CLUSTER_ID
);

509 
cÚfig
.
£rv”
.
şu¡”_id
 = cluster_id;

510 
šfo
!("cÚÃùØPD clu¡” {}", 
şu¡”_id
);

512 
Ët
 
_m
 = 
MÚ™Ü
::();

513 
	`run_¿á_£rv”
(
pd_ş›Á
, &
cÚfig
, 
£cur™y_mgr
);

514 
	}
}

	@src/config.rs

14 
u£
 
	g¡d
::
”rÜ
::
E¼Ü
;

15 
u£
 
	g¡d
::
·th
::
P©h
;

16 
u£
 
	g¡d
::
usize
;

18 
u£
 
	glog
::
LogLev–F‹r
;

19 
u£
 
	grocksdb
::{
BlockBa£dO±iÚs
, 
	gCŞumnFamyO±iÚs
, 
	gCom·ùiÚPriÜ™y
, 
	gDBCom´essiÚTy³
,

20 
	gDBO±iÚs
, 
	gDBRecov”yMode
};

21 
u£
 
	gsys_šfo
;

23 
u£
 
	g£rv”
::
CÚfig
 
as
 
S”v”CÚfig
;

24 
u£
 
	gpd
::
CÚfig
 
as
 
PdCÚfig
;

25 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::
CÚfig
 
as
 
CİCÚfig
;

26 
u£
 
	g¿á¡Üe
::
¡Üe
::
CÚfig
 
as
 
Raá¡ÜeCÚfig
;

27 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
::
»giÚ_¿á_´efix_Ën
;

28 
u£
 
	g¡Üage
::{
CÚfig
 
as
 
StÜageCÚfig
, 
	gCF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_RAFT
, 
	gCF_WRITE
, 
	gDEFAULT_DATA_DIR
,

29 
	gDEFAULT_ROCKSDB_SUB_DIR
};

30 
u£
 
	gut
::
cÚfig
::{
£lf
, 
	gcom´essiÚ_ty³_Ëv–_£rde
, 
	gR—dabËDu¿tiÚ
, 
	gR—dabËSize
, 
	gGB
, 
	gKB
, 
	gMB
};

31 
u£
 
	gut
::
´İ”t›s
::{
MvccPrİ”t›sCŞËùÜFaùÜy
, 
	gSizePrİ”t›sCŞËùÜFaùÜy
};

32 
u£
 
	gut
::
rocksdb
::{
db_exi¡
, 
	gCFO±iÚs
, 
	gEv’tLi¡’”
, 
	gFixedP»fixSliûT¿nsfÜm
,

33 
	gFixedSuffixSliûT¿nsfÜm
, 
	gNoİSliûT¿nsfÜm
};

34 
u£
 
	gut
::
£cur™y
::
Secur™yCÚfig
;

36 cÚ¡ 
	gLOCKCF_MIN_MEM
: 
usize
 = 256 * 
MB
 
as
 usize;

37 cÚ¡ 
	gLOCKCF_MAX_MEM
: 
usize
 = 
GB
 
as
 usize;

38 cÚ¡ 
	gRAFT_MIN_MEM
: 
usize
 = 256 * 
MB
 
as
 usize;

39 cÚ¡ 
	gRAFT_MAX_MEM
: 
usize
 = 2 * 
GB
 
as
 usize;

41 
â
 
memÜy_mb_fÜ_cf
(
is_¿á_db
: 
boŞ
, 
cf
: &
¡r
è-> 
usize
 {

42 
Ët
 
tÙ®_mem
 = 
sys_šfo
::
mem_šfo
().
unw¿p
().
tÙ®
 * 
KB
;

43 
Ët
 (
¿tio
, 
mš
, 
max
èğ
m©ch
 (
is_¿á_db
, 
cf
) {

44 (
	gŒue
, 
	gCF_DEFAULT
è=> (0.02, 
	gRAFT_MIN_MEM
, 
	gRAFT_MAX_MEM
),

45 (
	gçl£
, 
	gCF_DEFAULT
è=> (0.25, 0, 
	gusize
::
MAX
),

46 (
	gçl£
, 
	gCF_LOCK
è=> (0.02, 
	gLOCKCF_MIN_MEM
, 
	gLOCKCF_MAX_MEM
),

47 (
	gçl£
, 
	gCF_WRITE
è=> (0.15, 0, 
	gusize
::
MAX
),

48 
	g_
 => 
uÄ—chabË
!(),

50 
Ët
 
mut
 
	gsize
 = (
tÙ®_mem
 
as
 
f64
 * 
¿tio
èa 
usize
;

51 
	gsize
 < 
	gmš
 {

52 
	gsize
 = 
mš
;

53 } 
	gsize
 > 
	gmax
 {

54 
	gsize
 = 
max
;

56 
	gsize
 / 
MB
 
as
 
	gusize


59 
	gmaüo_ruËs
! 
	gcf_cÚfig
 {

60 (
	g$Çme
:
id’t
) => {

61 #[
d”ive
(
ClÚe
, 
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
, 
Debug
)]

62 #[
£rde
()]

63 #[
£rde
(
»Çme_®l
 = "kebab-case")]

64 
pub
 
	s$Çme
 {

65 
pub
 
block_size
: 
R—dabËSize
,

66 
pub
 
block_ÿche_size
: 
R—dabËSize
,

67 
pub
 
ÿche_šdex_ªd_f‹r_blocks
: 
boŞ
,

68 
pub
 
pš_l0_f‹r_ªd_šdex_blocks
: 
boŞ
,

69 
pub
 
u£_bloom_f‹r
: 
boŞ
,

70 
pub
 
whŞe_key_f‹ršg
: 
boŞ
,

71 
pub
 
bloom_f‹r_b™s_³r_key
: 
i32
,

72 
pub
 
block_ba£d_bloom_f‹r
: 
boŞ
,

73 
pub
 
»ad_amp_by‹s_³r_b™
: 
u32
,

74 #[
£rde
(
w™h
 = "compression_type_level_serde")]

75 
pub
 
com´essiÚ_³r_Ëv–
: [
DBCom´essiÚTy³
; 7],

76 
pub
 
	gwr™e_bufãr_size
: 
R—dabËSize
,

77 
pub
 
	gmax_wr™e_bufãr_numb”
: 
i32
,

78 
pub
 
	gmš_wr™e_bufãr_numb”_to_m”ge
: 
i32
,

79 
pub
 
	gmax_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
,

80 
pub
 
	grg‘_fe_size_ba£
: 
R—dabËSize
,

81 
pub
 
	gËv–0_fe_num_com·ùiÚ_Œigg”
: 
i32
,

82 
pub
 
	gËv–0_¦owdown_wr™es_Œigg”
: 
i32
,

83 
pub
 
	gËv–0_¡İ_wr™es_Œigg”
: 
i32
,

84 
pub
 
	gmax_com·ùiÚ_by‹s
: 
R—dabËSize
,

85 #[
£rde
(
w™h
 = "config::compaction_pri_serde")]

86 
pub
 
	gcom·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
,

91 
	gmaüo_ruËs
! 
	gbud_cf_İt
 {

92 (
	g$İt
:
id’t
) => {{

93 
Ët
 
mut
 
block_ba£_İts
 = 
BlockBa£dO±iÚs
::
Ãw
();

94 
	gblock_ba£_İts
.
£t_block_size
(
$İt
.
block_size
.0 
as
 
usize
);

95 
	gblock_ba£_İts
.
£t_Ìu_ÿche
(
$İt
.
block_ÿche_size
.0 
as
 
usize
, -1, 0, 0.0);

96 
	gblock_ba£_İts
.
£t_ÿche_šdex_ªd_f‹r_blocks
(
$İt
.
ÿche_šdex_ªd_f‹r_blocks
);

97 
	gblock_ba£_İts
.
£t_pš_l0_f‹r_ªd_šdex_blocks_š_ÿche
(

98 
$İt
.
pš_l0_f‹r_ªd_šdex_blocks
);

99 
	g$İt
.
	gu£_bloom_f‹r
 {

100 
	gblock_ba£_İts
.
£t_bloom_f‹r
(
$İt
.
bloom_f‹r_b™s_³r_key
,

101 
$İt
.
block_ba£d_bloom_f‹r
);

102 
	gblock_ba£_İts
.
£t_whŞe_key_f‹ršg
(
$İt
.
whŞe_key_f‹ršg
);

104 
	gblock_ba£_İts
.
£t_»ad_amp_by‹s_³r_b™
(
$İt
.
»ad_amp_by‹s_³r_b™
);

105 
Ët
 
mut
 
	gcf_İts
 = 
CŞumnFamyO±iÚs
::
Ãw
();

106 
	gcf_İts
.
£t_block_ba£d_bË_çùÜy
(&
block_ba£_İts
);

107 
	gcf_İts
.
com´essiÚ_³r_Ëv–
(&
$İt
.compression_per_level);

108 
	gcf_İts
.
£t_wr™e_bufãr_size
(
$İt
.
wr™e_bufãr_size
.0);

109 
	gcf_İts
.
£t_max_wr™e_bufãr_numb”
(
$İt
.
max_wr™e_bufãr_numb”
);

110 
	gcf_İts
.
£t_mš_wr™e_bufãr_numb”_to_m”ge
(
$İt
.
mš_wr™e_bufãr_numb”_to_m”ge
);

111 
	gcf_İts
.
£t_max_by‹s_fÜ_Ëv–_ba£
(
$İt
.
max_by‹s_fÜ_Ëv–_ba£
.0);

112 
	gcf_İts
.
£t_rg‘_fe_size_ba£
(
$İt
.
rg‘_fe_size_ba£
.0);

113 
	gcf_İts
.
£t_Ëv–_z”o_fe_num_com·ùiÚ_Œigg”
(
$İt
.
Ëv–0_fe_num_com·ùiÚ_Œigg”
);

114 
	gcf_İts
.
£t_Ëv–_z”o_¦owdown_wr™es_Œigg”
(
$İt
.
Ëv–0_¦owdown_wr™es_Œigg”
);

115 
	gcf_İts
.
£t_Ëv–_z”o_¡İ_wr™es_Œigg”
(
$İt
.
Ëv–0_¡İ_wr™es_Œigg”
);

116 
	gcf_İts
.
£t_max_com·ùiÚ_by‹s
(
$İt
.
max_com·ùiÚ_by‹s
.0);

117 
	gcf_İts
.
com·ùiÚ_´iÜ™y
(
$İt
.
com·ùiÚ_´i
);

118 
	gcf_İts


122 
	gcf_cÚfig
!(
	gDeçuÉCfCÚfig
);

124 
im¶
 
DeçuÉ
 
	gDeçuÉCfCÚfig
 {

125 
â
 (è-> 
	gDeçuÉCfCÚfig
 {

126 
	gDeçuÉCfCÚfig
 {

127 
	gblock_size
: 
R—dabËSize
::
kb
(64),

128 
	gblock_ÿche_size
: 
R—dabËSize
::
mb
(
memÜy_mb_fÜ_cf
(
çl£
, 
CF_DEFAULT
è
as
 
u64
),

129 
	gÿche_šdex_ªd_f‹r_blocks
: 
Œue
,

130 
	gpš_l0_f‹r_ªd_šdex_blocks
: 
Œue
,

131 
	gu£_bloom_f‹r
: 
Œue
,

132 
	gwhŞe_key_f‹ršg
: 
Œue
,

133 
	gbloom_f‹r_b™s_³r_key
: 10,

134 
	gblock_ba£d_bloom_f‹r
: 
çl£
,

135 
	g»ad_amp_by‹s_³r_b™
: 0,

136 
	gcom´essiÚ_³r_Ëv–
: [

137 
DBCom´essiÚTy³
::
No
,

138 
DBCom´essiÚTy³
::
No
,

139 
DBCom´essiÚTy³
::
Lz4
,

140 
DBCom´essiÚTy³
::
Lz4
,

141 
DBCom´essiÚTy³
::
Lz4
,

142 
DBCom´essiÚTy³
::
Z¡d
,

143 
DBCom´essiÚTy³
::
Z¡d
,

145 
	gwr™e_bufãr_size
: 
R—dabËSize
::
mb
(128),

146 
	gmax_wr™e_bufãr_numb”
: 5,

147 
	gmš_wr™e_bufãr_numb”_to_m”ge
: 1,

148 
	gmax_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
::
mb
(512),

149 
	grg‘_fe_size_ba£
: 
R—dabËSize
::
mb
(8),

150 
	gËv–0_fe_num_com·ùiÚ_Œigg”
: 4,

151 
	gËv–0_¦owdown_wr™es_Œigg”
: 20,

152 
	gËv–0_¡İ_wr™es_Œigg”
: 36,

153 
	gmax_com·ùiÚ_by‹s
: 
R—dabËSize
::
gb
(2),

154 
	gcom·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
::
MšOv”ÏµšgR©io
,

159 
im¶
 
	gDeçuÉCfCÚfig
 {

160 
pub
 
â
 
bud_İt
(&
£lf
è-> 
	gCŞumnFamyO±iÚs
 {

161 
Ët
 
mut
 
	gcf_İts
 = 
bud_cf_İt
!(
£lf
);

162 
Ët
 
	gf
 = 
Box
::
Ãw
(
SizePrİ”t›sCŞËùÜFaùÜy
::());

163 
	gcf_İts
.
add_bË_´İ”t›s_cŞËùÜ_çùÜy
("tikv.size-´İ”t›s-cŞËùÜ", 
f
);

164 
	gcf_İts


168 
	gcf_cÚfig
!(
	gWr™eCfCÚfig
);

170 
im¶
 
DeçuÉ
 
	gWr™eCfCÚfig
 {

171 
â
 (è-> 
	gWr™eCfCÚfig
 {

172 
	gWr™eCfCÚfig
 {

173 
	gblock_size
: 
R—dabËSize
::
kb
(64),

174 
	gblock_ÿche_size
: 
R—dabËSize
::
mb
(
memÜy_mb_fÜ_cf
(
çl£
, 
CF_WRITE
è
as
 
u64
),

175 
	gÿche_šdex_ªd_f‹r_blocks
: 
Œue
,

176 
	gpš_l0_f‹r_ªd_šdex_blocks
: 
Œue
,

177 
	gu£_bloom_f‹r
: 
Œue
,

178 
	gwhŞe_key_f‹ršg
: 
çl£
,

179 
	gbloom_f‹r_b™s_³r_key
: 10,

180 
	gblock_ba£d_bloom_f‹r
: 
çl£
,

181 
	g»ad_amp_by‹s_³r_b™
: 0,

182 
	gcom´essiÚ_³r_Ëv–
: [

183 
DBCom´essiÚTy³
::
No
,

184 
DBCom´essiÚTy³
::
No
,

185 
DBCom´essiÚTy³
::
Lz4
,

186 
DBCom´essiÚTy³
::
Lz4
,

187 
DBCom´essiÚTy³
::
Lz4
,

188 
DBCom´essiÚTy³
::
Z¡d
,

189 
DBCom´essiÚTy³
::
Z¡d
,

191 
	gwr™e_bufãr_size
: 
R—dabËSize
::
mb
(128),

192 
	gmax_wr™e_bufãr_numb”
: 5,

193 
	gmš_wr™e_bufãr_numb”_to_m”ge
: 1,

194 
	gmax_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
::
mb
(512),

195 
	grg‘_fe_size_ba£
: 
R—dabËSize
::
mb
(8),

196 
	gËv–0_fe_num_com·ùiÚ_Œigg”
: 4,

197 
	gËv–0_¦owdown_wr™es_Œigg”
: 20,

198 
	gËv–0_¡İ_wr™es_Œigg”
: 36,

199 
	gmax_com·ùiÚ_by‹s
: 
R—dabËSize
::
gb
(2),

200 
	gcom·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
::
MšOv”ÏµšgR©io
,

205 
im¶
 
	gWr™eCfCÚfig
 {

206 
pub
 
â
 
bud_İt
(&
£lf
è-> 
	gCŞumnFamyO±iÚs
 {

207 
Ët
 
mut
 
	gcf_İts
 = 
bud_cf_İt
!(
£lf
);

209 
Ët
 
	ge
 = 
Box
::
Ãw
(
FixedSuffixSliûT¿nsfÜm
::new(8));

210 
	gcf_İts


211 .
£t_´efix_exŒaùÜ
("FixedSuffixSliûT¿nsfÜm", 
e
)

212 .
unw¿p
();

214 
	gcf_İts
.
£t_membË_´efix_bloom_size_¿tio
(0.1);

216 
Ët
 
	gf
 = 
Box
::
Ãw
(
MvccPrİ”t›sCŞËùÜFaùÜy
::());

217 
	gcf_İts
.
add_bË_´İ”t›s_cŞËùÜ_çùÜy
("tikv.mvcc-´İ”t›s-cŞËùÜ", 
f
);

218 
Ët
 
	gf
 = 
Box
::
Ãw
(
SizePrİ”t›sCŞËùÜFaùÜy
::());

219 
	gcf_İts
.
add_bË_´İ”t›s_cŞËùÜ_çùÜy
("tikv.size-´İ”t›s-cŞËùÜ", 
f
);

220 
	gcf_İts


224 
	gcf_cÚfig
!(
	gLockCfCÚfig
);

226 
im¶
 
DeçuÉ
 
	gLockCfCÚfig
 {

227 
â
 (è-> 
	gLockCfCÚfig
 {

228 
	gLockCfCÚfig
 {

229 
	gblock_size
: 
R—dabËSize
::
kb
(16),

230 
	gblock_ÿche_size
: 
R—dabËSize
::
mb
(
memÜy_mb_fÜ_cf
(
çl£
, 
CF_LOCK
è
as
 
u64
),

231 
	gÿche_šdex_ªd_f‹r_blocks
: 
Œue
,

232 
	gpš_l0_f‹r_ªd_šdex_blocks
: 
Œue
,

233 
	gu£_bloom_f‹r
: 
Œue
,

234 
	gwhŞe_key_f‹ršg
: 
Œue
,

235 
	gbloom_f‹r_b™s_³r_key
: 10,

236 
	gblock_ba£d_bloom_f‹r
: 
çl£
,

237 
	g»ad_amp_by‹s_³r_b™
: 0,

238 
	gcom´essiÚ_³r_Ëv–
: [
DBCom´essiÚTy³
::
No
; 7],

239 
	gwr™e_bufãr_size
: 
R—dabËSize
::
mb
(128),

240 
	gmax_wr™e_bufãr_numb”
: 5,

241 
	gmš_wr™e_bufãr_numb”_to_m”ge
: 1,

242 
	gmax_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
::
mb
(128),

243 
	grg‘_fe_size_ba£
: 
R—dabËSize
::
mb
(8),

244 
	gËv–0_fe_num_com·ùiÚ_Œigg”
: 1,

245 
	gËv–0_¦owdown_wr™es_Œigg”
: 20,

246 
	gËv–0_¡İ_wr™es_Œigg”
: 36,

247 
	gmax_com·ùiÚ_by‹s
: 
R—dabËSize
::
gb
(2),

248 
	gcom·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
::
ByCom³n§‹dSize
,

253 
im¶
 
	gLockCfCÚfig
 {

254 
pub
 
â
 
bud_İt
(&
£lf
è-> 
	gCŞumnFamyO±iÚs
 {

255 
Ët
 
mut
 
	gcf_İts
 = 
bud_cf_İt
!(
£lf
);

256 
Ët
 
	gf
 = 
Box
::
Ãw
(
NoİSliûT¿nsfÜm
);

257 
	gcf_İts


258 .
£t_´efix_exŒaùÜ
("NoİSliûT¿nsfÜm", 
f
)

259 .
unw¿p
();

260 
	gcf_İts
.
£t_membË_´efix_bloom_size_¿tio
(0.1);

261 
	gcf_İts


265 
	gcf_cÚfig
!(
	gRaáCfCÚfig
);

267 
im¶
 
DeçuÉ
 
	gRaáCfCÚfig
 {

268 
â
 (è-> 
	gRaáCfCÚfig
 {

269 
	gRaáCfCÚfig
 {

270 
	gblock_size
: 
R—dabËSize
::
kb
(16),

271 
	gblock_ÿche_size
: 
R—dabËSize
::
mb
(128),

272 
	gÿche_šdex_ªd_f‹r_blocks
: 
Œue
,

273 
	gpš_l0_f‹r_ªd_šdex_blocks
: 
Œue
,

274 
	gu£_bloom_f‹r
: 
Œue
,

275 
	gwhŞe_key_f‹ršg
: 
Œue
,

276 
	gbloom_f‹r_b™s_³r_key
: 10,

277 
	gblock_ba£d_bloom_f‹r
: 
çl£
,

278 
	g»ad_amp_by‹s_³r_b™
: 0,

279 
	gcom´essiÚ_³r_Ëv–
: [
DBCom´essiÚTy³
::
No
; 7],

280 
	gwr™e_bufãr_size
: 
R—dabËSize
::
mb
(128),

281 
	gmax_wr™e_bufãr_numb”
: 5,

282 
	gmš_wr™e_bufãr_numb”_to_m”ge
: 1,

283 
	gmax_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
::
mb
(128),

284 
	grg‘_fe_size_ba£
: 
R—dabËSize
::
mb
(8),

285 
	gËv–0_fe_num_com·ùiÚ_Œigg”
: 1,

286 
	gËv–0_¦owdown_wr™es_Œigg”
: 20,

287 
	gËv–0_¡İ_wr™es_Œigg”
: 36,

288 
	gmax_com·ùiÚ_by‹s
: 
R—dabËSize
::
gb
(2),

289 
	gcom·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
::
ByCom³n§‹dSize
,

294 
im¶
 
	gRaáCfCÚfig
 {

295 
pub
 
â
 
bud_İt
(&
£lf
è-> 
	gCŞumnFamyO±iÚs
 {

296 
Ët
 
mut
 
	gcf_İts
 = 
bud_cf_İt
!(
£lf
);

297 
Ët
 
	gf
 = 
Box
::
Ãw
(
NoİSliûT¿nsfÜm
);

298 
	gcf_İts


299 .
£t_´efix_exŒaùÜ
("NoİSliûT¿nsfÜm", 
f
)

300 .
unw¿p
();

301 
	gcf_İts
.
£t_membË_´efix_bloom_size_¿tio
(0.1);

302 
	gcf_İts


306 #[
d”ive
(
ClÚe
, 
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
, 
Debug
)]

307 #[
£rde
()]

308 #[
£rde
(
»Çme_®l
 = "kebab-case")]

309 
pub
 
	sDbCÚfig
 {

310 #[
£rde
(
w™h
 = "config::recovery_mode_serde")]

311 
pub
 
	mw®_»cov”y_mode
: 
DBRecov”yMode
,

312 
pub
 
	mw®_dœ
: 
SŒšg
,

313 
pub
 
	mw®_‰l_£cÚds
: 
u64
,

314 
pub
 
	mw®_size_lim™
: 
R—dabËSize
,

315 
pub
 
	mmax_tÙ®_w®_size
: 
R—dabËSize
,

316 
pub
 
	mmax_background_jobs
: 
i32
,

317 
pub
 
	mmax_mªiã¡_fe_size
: 
R—dabËSize
,

318 
pub
 
	mü—‹_if_missšg
: 
boŞ
,

319 
pub
 
	mmax_İ’_fes
: 
i32
,

320 
pub
 
	m’abË_¡©i¡ics
: 
boŞ
,

321 
pub
 
	m¡©s_dump_³riod
: 
R—dabËDu¿tiÚ
,

322 
pub
 
	mcom·ùiÚ_»adah—d_size
: 
R—dabËSize
,

323 
pub
 
	mšfo_log_max_size
: 
R—dabËSize
,

324 
pub
 
	mšfo_log_rŞl_time
: 
R—dabËDu¿tiÚ
,

325 
pub
 
	mšfo_log_dœ
: 
SŒšg
,

326 
pub
 
	m¿‹_by‹s_³r_£c
: 
R—dabËSize
,

327 
pub
 
	mw®_by‹s_³r_sync
: 
R—dabËSize
,

328 
pub
 
	mmax_sub_com·ùiÚs
: 
u32
,

329 
pub
 
	mwr™abË_fe_max_bufãr_size
: 
R—dabËSize
,

330 
pub
 
	mu£_dœeù_io_fÜ_æush_ªd_com·ùiÚ
: 
boŞ
,

331 
pub
 
	m’abË_p–šed_wr™e
: 
boŞ
,

332 
pub
 
	mbackup_dœ
: 
SŒšg
,

333 
pub
 
	mdeçuÉcf
: 
DeçuÉCfCÚfig
,

334 
pub
 
	mwr™ecf
: 
Wr™eCfCÚfig
,

335 
pub
 
	mlockcf
: 
LockCfCÚfig
,

336 
pub
 
	m¿ácf
: 
RaáCfCÚfig
,

339 
im¶
 
DeçuÉ
 
	gDbCÚfig
 {

340 
â
 (è-> 
	gDbCÚfig
 {

341 
	gDbCÚfig
 {

342 
	gw®_»cov”y_mode
: 
DBRecov”yMode
::
PoštInTime
,

343 
	gw®_dœ
: "".
to_owÃd
(),

344 
	gw®_‰l_£cÚds
: 0,

345 
	gw®_size_lim™
: 
R—dabËSize
::
kb
(0),

346 
	gmax_tÙ®_w®_size
: 
R—dabËSize
::
gb
(4),

347 
	gmax_background_jobs
: 6,

348 
	gmax_mªiã¡_fe_size
: 
R—dabËSize
::
mb
(20),

349 
	gü—‹_if_missšg
: 
Œue
,

350 
	gmax_İ’_fes
: 40960,

351 
	g’abË_¡©i¡ics
: 
Œue
,

352 
	g¡©s_dump_³riod
: 
R—dabËDu¿tiÚ
::
mšu‹s
(10),

353 
	gcom·ùiÚ_»adah—d_size
: 
R—dabËSize
::
kb
(0),

354 
	gšfo_log_max_size
: 
R—dabËSize
::
kb
(0),

355 
	gšfo_log_rŞl_time
: 
R—dabËDu¿tiÚ
::
£cs
(0),

356 
	gšfo_log_dœ
: "".
to_owÃd
(),

357 
	g¿‹_by‹s_³r_£c
: 
R—dabËSize
::
kb
(0),

358 
	gw®_by‹s_³r_sync
: 
R—dabËSize
::
kb
(0),

359 
	gmax_sub_com·ùiÚs
: 1,

360 
	gwr™abË_fe_max_bufãr_size
: 
R—dabËSize
::
mb
(1),

361 
	gu£_dœeù_io_fÜ_æush_ªd_com·ùiÚ
: 
çl£
,

362 
	g’abË_p–šed_wr™e
: 
Œue
,

363 
	gbackup_dœ
: "".
to_owÃd
(),

364 
	gdeçuÉcf
: 
DeçuÉCfCÚfig
::(),

365 
	gwr™ecf
: 
Wr™eCfCÚfig
::(),

366 
	glockcf
: 
LockCfCÚfig
::(),

367 
	g¿ácf
: 
RaáCfCÚfig
::(),

372 
im¶
 
	gDbCÚfig
 {

373 
pub
 
â
 
bud_İt
(&
£lf
è-> 
	gDBO±iÚs
 {

374 
Ët
 
mut
 
	gİts
 = 
DBO±iÚs
::
Ãw
();

375 
	gİts
.
£t_w®_»cov”y_mode
(
£lf
.
w®_»cov”y_mode
);

376 !
	g£lf
.
	gw®_dœ
.
is_em±y
() {

377 
	gİts
.
£t_w®_dœ
(&
£lf
.
w®_dœ
);

379 
	gİts
.
£t_w®_‰l_£cÚds
(
£lf
.
w®_‰l_£cÚds
);

380 
	gİts
.
£t_w®_size_lim™_mb
(
£lf
.
w®_size_lim™
.
as_mb
());

381 
	gİts
.
£t_max_tÙ®_w®_size
(
£lf
.
max_tÙ®_w®_size
.0);

382 
	gİts
.
£t_max_background_jobs
(
£lf
.
max_background_jobs
);

383 
	gİts
.
£t_max_mªiã¡_fe_size
(
£lf
.
max_mªiã¡_fe_size
.0);

384 
	gİts
.
ü—‹_if_missšg
(
£lf
.create_if_missing);

385 
	gİts
.
£t_max_İ’_fes
(
£lf
.
max_İ’_fes
);

386 
	g£lf
.
	g’abË_¡©i¡ics
 {

387 
	gİts
.
’abË_¡©i¡ics
();

388 
	gİts
.
£t_¡©s_dump_³riod_£c
(
£lf
.
¡©s_dump_³riod
.
as_£cs
(è
as
 
usize
);

390 
	gİts
.
£t_com·ùiÚ_»adah—d_size
(
£lf
.
com·ùiÚ_»adah—d_size
.0);

391 
	gİts
.
£t_max_log_fe_size
(
£lf
.
šfo_log_max_size
.0);

392 
	gİts
.
£t_log_fe_time_to_rŞl
(
£lf
.
šfo_log_rŞl_time
.
as_£cs
());

393 !
	g£lf
.
	gšfo_log_dœ
.
is_em±y
() {

394 
	gİts
.
ü—‹_šfo_log
(&
£lf
.
šfo_log_dœ
).
unw¿p_Ü_–£
(

395 |
e
| {

396 
·nic
!(

398 
£lf
.
šfo_log_dœ
,

399 
e


404 
	g£lf
.
	g¿‹_by‹s_³r_£c
.0 > 0 {

405 
	gİts
.
£t_¿‹lim™”
(
£lf
.
¿‹_by‹s_³r_£c
.0 
as
 
i64
);

407 
	gİts
.
£t_w®_by‹s_³r_sync
(
£lf
.
w®_by‹s_³r_sync
.0 
as
 
u64
);

408 
	gİts
.
£t_max_subcom·ùiÚs
(
£lf
.
max_sub_com·ùiÚs
);

409 
	gİts
.
£t_wr™abË_fe_max_bufãr_size
(
£lf
.
wr™abË_fe_max_bufãr_size
.0 
as
 
i32
);

410 
	gİts
.
£t_u£_dœeù_io_fÜ_æush_ªd_com·ùiÚ
(

411 
£lf
.
u£_dœeù_io_fÜ_æush_ªd_com·ùiÚ
,

413 
	gİts
.
’abË_p–šed_wr™e
(
£lf
.enable_pipelined_write);

414 
	gİts
.
add_ev’t_li¡’”
(
Ev’tLi¡’”
::
Ãw
("kv"));

415 
	gİts


418 
pub
 
â
 
bud_cf_İts
(&
£lf
è-> 
	gVec
<
	gCFO±iÚs
> {

419 
	gvec
![

420 
CFO±iÚs
::
Ãw
(
CF_DEFAULT
, 
£lf
.
deçuÉcf
.
bud_İt
()),

421 
CFO±iÚs
::
Ãw
(
CF_LOCK
, 
£lf
.
lockcf
.
bud_İt
()),

422 
CFO±iÚs
::
Ãw
(
CF_WRITE
, 
£lf
.
wr™ecf
.
bud_İt
()),

423 
CFO±iÚs
::
Ãw
(
CF_RAFT
, 
£lf
.
¿ácf
.
bud_İt
()),

427 
â
 
v®id©e
(&
mut
 
£lf
è-> 
	gResuÉ
<(), 
	gBox
<
	gE¼Ü
>> {

428 !
	g£lf
.
	gbackup_dœ
.
is_em±y
() {

429 
	g£lf
.
	gbackup_dœ
 = 
cÚfig
::
ÿnÚiÿlize_·th
(&
£lf
.
backup_dœ
)?;

431 
Ok
(())

435 
	gcf_cÚfig
!(
	gRaáDeçuÉCfCÚfig
);

437 
im¶
 
DeçuÉ
 
	gRaáDeçuÉCfCÚfig
 {

438 
â
 (è-> 
	gRaáDeçuÉCfCÚfig
 {

439 
	gRaáDeçuÉCfCÚfig
 {

440 
	gblock_size
: 
R—dabËSize
::
kb
(64),

441 
	gblock_ÿche_size
: 
R—dabËSize
::
mb
(
memÜy_mb_fÜ_cf
(
Œue
, 
CF_DEFAULT
è
as
 
u64
),

442 
	gÿche_šdex_ªd_f‹r_blocks
: 
Œue
,

443 
	gpš_l0_f‹r_ªd_šdex_blocks
: 
Œue
,

444 
	gu£_bloom_f‹r
: 
çl£
,

445 
	gwhŞe_key_f‹ršg
: 
Œue
,

446 
	gbloom_f‹r_b™s_³r_key
: 10,

447 
	gblock_ba£d_bloom_f‹r
: 
çl£
,

448 
	g»ad_amp_by‹s_³r_b™
: 0,

449 
	gcom´essiÚ_³r_Ëv–
: [

450 
DBCom´essiÚTy³
::
No
,

451 
DBCom´essiÚTy³
::
No
,

452 
DBCom´essiÚTy³
::
Lz4
,

453 
DBCom´essiÚTy³
::
Lz4
,

454 
DBCom´essiÚTy³
::
Lz4
,

455 
DBCom´essiÚTy³
::
Z¡d
,

456 
DBCom´essiÚTy³
::
Z¡d
,

458 
	gwr™e_bufãr_size
: 
R—dabËSize
::
mb
(128),

459 
	gmax_wr™e_bufãr_numb”
: 5,

460 
	gmš_wr™e_bufãr_numb”_to_m”ge
: 1,

461 
	gmax_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
::
mb
(512),

462 
	grg‘_fe_size_ba£
: 
R—dabËSize
::
mb
(8),

463 
	gËv–0_fe_num_com·ùiÚ_Œigg”
: 4,

464 
	gËv–0_¦owdown_wr™es_Œigg”
: 20,

465 
	gËv–0_¡İ_wr™es_Œigg”
: 36,

466 
	gmax_com·ùiÚ_by‹s
: 
R—dabËSize
::
gb
(2),

467 
	gcom·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
::
ByCom³n§‹dSize
,

472 
im¶
 
	gRaáDeçuÉCfCÚfig
 {

473 
pub
 
â
 
bud_İt
(&
£lf
è-> 
	gCŞumnFamyO±iÚs
 {

474 
Ët
 
mut
 
	gcf_İts
 = 
bud_cf_İt
!(
£lf
);

475 
Ët
 
	gf
 = 
Box
::
Ãw
(
FixedP»fixSliûT¿nsfÜm
::Ãw(
»giÚ_¿á_´efix_Ën
()));

476 
	gcf_İts


477 .
£t_membË_š£¹_hšt_´efix_exŒaùÜ
("RaáP»fixSliûT¿nsfÜm", 
f
)

478 .
unw¿p
();

479 
	gcf_İts


487 #[
d”ive
(
ClÚe
, 
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
, 
Debug
)]

488 #[
£rde
()]

489 #[
£rde
(
»Çme_®l
 = "kebab-case")]

490 
pub
 
	sRaáDbCÚfig
 {

491 #[
£rde
(
w™h
 = "config::recovery_mode_serde")]

492 
pub
 
	mw®_»cov”y_mode
: 
DBRecov”yMode
,

493 
pub
 
	mw®_dœ
: 
SŒšg
,

494 
pub
 
	mw®_‰l_£cÚds
: 
u64
,

495 
pub
 
	mw®_size_lim™
: 
R—dabËSize
,

496 
pub
 
	mmax_tÙ®_w®_size
: 
R—dabËSize
,

497 
pub
 
	mmax_mªiã¡_fe_size
: 
R—dabËSize
,

498 
pub
 
	mü—‹_if_missšg
: 
boŞ
,

499 
pub
 
	mmax_İ’_fes
: 
i32
,

500 
pub
 
	m’abË_¡©i¡ics
: 
boŞ
,

501 
pub
 
	m¡©s_dump_³riod
: 
R—dabËDu¿tiÚ
,

502 
pub
 
	mcom·ùiÚ_»adah—d_size
: 
R—dabËSize
,

503 
pub
 
	mšfo_log_max_size
: 
R—dabËSize
,

504 
pub
 
	mšfo_log_rŞl_time
: 
R—dabËDu¿tiÚ
,

505 
pub
 
	mšfo_log_dœ
: 
SŒšg
,

506 
pub
 
	mmax_sub_com·ùiÚs
: 
u32
,

507 
pub
 
	mwr™abË_fe_max_bufãr_size
: 
R—dabËSize
,

508 
pub
 
	mu£_dœeù_io_fÜ_æush_ªd_com·ùiÚ
: 
boŞ
,

509 
pub
 
	m’abË_p–šed_wr™e
: 
boŞ
,

510 
pub
 
	m®low_cÚcu¼’t_membË_wr™e
: 
boŞ
,

511 
pub
 
	mw®_by‹s_³r_sync
: 
R—dabËSize
,

512 
pub
 
	mdeçuÉcf
: 
RaáDeçuÉCfCÚfig
,

515 
im¶
 
DeçuÉ
 
	gRaáDbCÚfig
 {

516 
â
 (è-> 
	gRaáDbCÚfig
 {

517 
	gRaáDbCÚfig
 {

518 
	gw®_»cov”y_mode
: 
DBRecov”yMode
::
PoštInTime
,

519 
	gw®_dœ
: "".
to_owÃd
(),

520 
	gw®_‰l_£cÚds
: 0,

521 
	gw®_size_lim™
: 
R—dabËSize
::
kb
(0),

522 
	gmax_tÙ®_w®_size
: 
R—dabËSize
::
gb
(4),

523 
	gmax_mªiã¡_fe_size
: 
R—dabËSize
::
mb
(20),

524 
	gü—‹_if_missšg
: 
Œue
,

525 
	gmax_İ’_fes
: 40960,

526 
	g’abË_¡©i¡ics
: 
Œue
,

527 
	g¡©s_dump_³riod
: 
R—dabËDu¿tiÚ
::
mšu‹s
(10),

528 
	gcom·ùiÚ_»adah—d_size
: 
R—dabËSize
::
kb
(0),

529 
	gšfo_log_max_size
: 
R—dabËSize
::
kb
(0),

530 
	gšfo_log_rŞl_time
: 
R—dabËDu¿tiÚ
::
£cs
(0),

531 
	gšfo_log_dœ
: "".
to_owÃd
(),

532 
	gmax_sub_com·ùiÚs
: 1,

533 
	gwr™abË_fe_max_bufãr_size
: 
R—dabËSize
::
mb
(1),

534 
	gu£_dœeù_io_fÜ_æush_ªd_com·ùiÚ
: 
çl£
,

535 
	g’abË_p–šed_wr™e
: 
Œue
,

536 
	g®low_cÚcu¼’t_membË_wr™e
: 
çl£
,

537 
	gw®_by‹s_³r_sync
: 
R—dabËSize
::
kb
(0),

538 
	gdeçuÉcf
: 
RaáDeçuÉCfCÚfig
::(),

543 
im¶
 
	gRaáDbCÚfig
 {

544 
pub
 
â
 
bud_İt
(&
£lf
è-> 
	gDBO±iÚs
 {

545 
Ët
 
mut
 
	gİts
 = 
DBO±iÚs
::
Ãw
();

546 
	gİts
.
£t_w®_»cov”y_mode
(
£lf
.
w®_»cov”y_mode
);

547 !
	g£lf
.
	gw®_dœ
.
is_em±y
() {

548 
	gİts
.
£t_w®_dœ
(&
£lf
.
w®_dœ
);

550 
	gİts
.
£t_w®_‰l_£cÚds
(
£lf
.
w®_‰l_£cÚds
);

551 
	gİts
.
£t_w®_size_lim™_mb
(
£lf
.
w®_size_lim™
.
as_mb
());

552 
	gİts
.
£t_max_tÙ®_w®_size
(
£lf
.
max_tÙ®_w®_size
.0);

553 
	gİts
.
£t_max_mªiã¡_fe_size
(
£lf
.
max_mªiã¡_fe_size
.0);

554 
	gİts
.
ü—‹_if_missšg
(
£lf
.create_if_missing);

555 
	gİts
.
£t_max_İ’_fes
(
£lf
.
max_İ’_fes
);

556 
	g£lf
.
	g’abË_¡©i¡ics
 {

557 
	gİts
.
’abË_¡©i¡ics
();

558 
	gİts
.
£t_¡©s_dump_³riod_£c
(
£lf
.
¡©s_dump_³riod
.
as_£cs
(è
as
 
usize
);

560 
	gİts
.
£t_com·ùiÚ_»adah—d_size
(
£lf
.
com·ùiÚ_»adah—d_size
.0);

561 
	gİts
.
£t_max_log_fe_size
(
£lf
.
šfo_log_max_size
.0);

562 
	gİts
.
£t_log_fe_time_to_rŞl
(
£lf
.
šfo_log_rŞl_time
.
as_£cs
());

563 !
	g£lf
.
	gšfo_log_dœ
.
is_em±y
() {

564 
	gİts
.
ü—‹_šfo_log
(&
£lf
.
šfo_log_dœ
).
unw¿p_Ü_–£
(

565 |
e
| {

566 
·nic
!(

568 
£lf
.
šfo_log_dœ
,

569 
e


574 
	gİts
.
£t_max_subcom·ùiÚs
(
£lf
.
max_sub_com·ùiÚs
);

575 
	gİts
.
£t_wr™abË_fe_max_bufãr_size
(
£lf
.
wr™abË_fe_max_bufãr_size
.0 
as
 
i32
);

576 
	gİts
.
£t_u£_dœeù_io_fÜ_æush_ªd_com·ùiÚ
(

577 
£lf
.
u£_dœeù_io_fÜ_æush_ªd_com·ùiÚ
,

579 
	gİts
.
’abË_p–šed_wr™e
(
£lf
.enable_pipelined_write);

580 
	gİts
.
®low_cÚcu¼’t_membË_wr™e
(
£lf
.allow_concurrent_memtable_write);

581 
	gİts
.
add_ev’t_li¡’”
(
Ev’tLi¡’”
::
Ãw
("raft"));

582 
	gİts
.
£t_w®_by‹s_³r_sync
(
£lf
.
w®_by‹s_³r_sync
.0 
as
 
u64
);

584 
	gİts


587 
pub
 
â
 
bud_cf_İts
(&
£lf
è-> 
	gVec
<
	gCFO±iÚs
> {

588 
	gvec
![
CFO±iÚs
::
Ãw
(
CF_DEFAULT
, 
£lf
.
deçuÉcf
.
bud_İt
())]

592 #[
d”ive
(
ClÚe
, 
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
, 
Debug
)]

593 #[
£rde
()]

594 #[
£rde
(
»Çme_®l
 = "kebab-case")]

595 
pub
 
	sM‘ricCÚfig
 {

596 
pub
 
	mš‹rv®
: 
R—dabËDu¿tiÚ
,

597 
pub
 
	madd»ss
: 
SŒšg
,

598 
pub
 
	mjob
: 
SŒšg
,

601 
im¶
 
DeçuÉ
 
	gM‘ricCÚfig
 {

602 
â
 (è-> 
	gM‘ricCÚfig
 {

603 
	gM‘ricCÚfig
 {

604 
	gš‹rv®
: 
R—dabËDu¿tiÚ
::
£cs
(15),

605 
	gadd»ss
: "".
to_owÃd
(),

606 
	gjob
: "tikv".
to_owÃd
(),

611 #[
d”ive
(
S”Ÿlize
, 
De£rŸlize
)]

612 #[
£rde
(
»mÙe
 = "LogLevelFilter")]

613 #[
£rde
(
»Çme_®l
 = "kebab-case")]

614 
pub
 
	eLogLev–
 {

615 
	mInfo
,

616 
	mT¿û
,

617 
	mDebug
,

618 
	mW¬n
,

619 
	mE¼Ü
,

620 
	mOff
,

623 #[
d”ive
(
ClÚe
, 
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
, 
Debug
)]

624 #[
£rde
()]

625 #[
£rde
(
»Çme_®l
 = "kebab-case")]

626 
pub
 
	sTiKvCÚfig
 {

627 #[
£rde
(
w™h
 = "LogLevel")]

628 
pub
 
	mlog_Ëv–
: 
LogLev–F‹r
,

629 
pub
 
	mlog_fe
: 
SŒšg
,

630 
pub
 
	m£rv”
: 
S”v”CÚfig
,

631 
pub
 
	m¡Üage
: 
StÜageCÚfig
,

632 
pub
 
	mpd
: 
PdCÚfig
,

633 
pub
 
	mm‘ric
: 
M‘ricCÚfig
,

634 #[
£rde
(
»Çme
 = "raftstore")]

635 
pub
 
	m¿á_¡Üe
: 
Raá¡ÜeCÚfig
,

636 
pub
 
	mcİroûssÜ
: 
CİCÚfig
,

637 
pub
 
	mrocksdb
: 
DbCÚfig
,

638 
pub
 
	m¿ádb
: 
RaáDbCÚfig
,

639 
pub
 
	m£cur™y
: 
Secur™yCÚfig
,

642 
im¶
 
DeçuÉ
 
	gTiKvCÚfig
 {

643 
â
 (è-> 
	gTiKvCÚfig
 {

644 
	gTiKvCÚfig
 {

645 
	glog_Ëv–
: 
LogLev–F‹r
::
Info
,

646 
	glog_fe
: "".
to_owÃd
(),

647 
	g£rv”
: 
S”v”CÚfig
::(),

648 
	gm‘ric
: 
M‘ricCÚfig
::(),

649 
	g¿á_¡Üe
: 
Raá¡ÜeCÚfig
::(),

650 
	gcİroûssÜ
: 
CİCÚfig
::(),

651 
	gpd
: 
PdCÚfig
::(),

652 
	grocksdb
: 
DbCÚfig
::(),

653 
	g¿ádb
: 
RaáDbCÚfig
::(),

654 
	g¡Üage
: 
StÜageCÚfig
::(),

655 
	g£cur™y
: 
Secur™yCÚfig
::(),

660 
im¶
 
	gTiKvCÚfig
 {

661 
pub
 
â
 
v®id©e
(&
mut
 
£lf
è-> 
	gResuÉ
<(), 
	gBox
<
	gE¼Ü
>> {

662 
	g£lf
.
	g¡Üage
.
v®id©e
()?;

663 
	g£lf
.
	grocksdb
.
	gbackup_dœ
.
is_em±y
(è&& s–f.
	g¡Üage
.
	gd©a_dœ
 !ğ
DEFAULT_DATA_DIR
 {

664 
£lf
.
rocksdb
.
backup_dœ
 = 
fÜm©
!(

666 
	gP©h
::
Ãw
(&
£lf
.
¡Üage
.
d©a_dœ
).
još
("backup").
di¥Ïy
()

670 
	g£lf
.
	g¿á_¡Üe
.
	g»giÚ_¥l™_check_diff
 = 
£lf
.
cİroûssÜ
.
»giÚ_¥l™_size
 / 16;

671 
	g£lf
.
	g¿á_¡Üe
.
	g¿ádb_·th
 = 
£lf
.
¿á_¡Üe
.
¿ádb_·th
.
is_em±y
() {

672 
cÚfig
::
ÿnÚiÿlize_sub_·th
(&
£lf
.
¡Üage
.
d©a_dœ
, "raft")?

674 
cÚfig
::
ÿnÚiÿlize_·th
(&
£lf
.
¿á_¡Üe
.
¿ádb_·th
)?

677 
Ët
 
	gkv_db_·th
 =

678 
cÚfig
::
ÿnÚiÿlize_sub_·th
(&
£lf
.
¡Üage
.
d©a_dœ
, 
DEFAULT_ROCKSDB_SUB_DIR
)?;

680 
	gkv_db_·th
 =ğ
£lf
.
¿á_¡Üe
.
¿ádb_·th
 {

681  
E¼
(

682 "¿á_¡Üe.¿ádb_·th cª‚Ù samw™h stÜage.d©a_dœ/db".
što
(),

685 
db_exi¡
(&
kv_db_·th
è&& !db_exi¡(&
£lf
.
¿á_¡Üe
.
¿ádb_·th
) {

686  
E¼
("deçuÉ„ocksdbƒxi¡, buà¿ádb‚Ùƒxi¡".
što
());

688 !
db_exi¡
(&
kv_db_·th
è&& db_exi¡(&
£lf
.
¿á_¡Üe
.
¿ádb_·th
) {

689  
E¼
("deçuÉ„ocksdb‚Ùƒxi¡, buà¿ádbƒxi¡".
što
());

692 
	g£lf
.
	grocksdb
.
v®id©e
()?;

693 
	g£lf
.
	g£rv”
.
v®id©e
()?;

694 
	g£lf
.
	g¿á_¡Üe
.
v®id©e
()?;

695 
	g£lf
.
	gpd
.
v®id©e
()?;

696 
	g£lf
.
	gcİroûssÜ
.
v®id©e
()?;

697 
	g£lf
.
	g£cur™y
.
v®id©e
()?;

698 
Ok
(())

701 
pub
 
â
 
com·tibË_adju¡
(&
mut
 
£lf
) {

702 
Ët
 
	gdeçuÉ_¿á_¡Üe
 = 
Raá¡ÜeCÚfig
::();

703 
Ët
 
	gdeçuÉ_cİroûssÜ
 = 
CİCÚfig
::();

704 
	g£lf
.
	g¿á_¡Üe
.
	g»giÚ_max_size
 !ğ
deçuÉ_¿á_¡Üe
.
»giÚ_max_size
 {

705 
w¬n
!(

709 
	g£lf
.
	gcİroûssÜ
.
	g»giÚ_max_size
 =ğ
deçuÉ_cİroûssÜ
.
»giÚ_max_size
 {

710 
w¬n
!(

712 
£lf
.
¿á_¡Üe
.
»giÚ_max_size


714 
	g£lf
.
	gcİroûssÜ
.
	g»giÚ_max_size
 = 
£lf
.
¿á_¡Üe
.
»giÚ_max_size
;

716 
	g£lf
.
	g¿á_¡Üe
.
	g»giÚ_max_size
 = 
deçuÉ_¿á_¡Üe
.
»giÚ_max_size
;

718 
	g£lf
.
	g¿á_¡Üe
.
	g»giÚ_¥l™_size
 !ğ
deçuÉ_¿á_¡Üe
.
»giÚ_¥l™_size
 {

719 
w¬n
!(

723 
	g£lf
.
	gcİroûssÜ
.
	g»giÚ_¥l™_size
 =ğ
deçuÉ_cİroûssÜ
.
»giÚ_¥l™_size
 {

724 
w¬n
!(

726 
£lf
.
¿á_¡Üe
.
»giÚ_¥l™_size


728 
	g£lf
.
	gcİroûssÜ
.
	g»giÚ_¥l™_size
 = 
£lf
.
¿á_¡Üe
.
»giÚ_¥l™_size
;

730 
	g£lf
.
	g¿á_¡Üe
.
	g»giÚ_¥l™_size
 = 
deçuÉ_¿á_¡Üe
.
»giÚ_¥l™_size
;

	@src/coprocessor/codec/convert.rs

14 
u£
 
	g¡d
::{
£lf
, 
	g¡r
, 
	gi64
, 
	gu64
};

15 
u£
 
	g¡d
::
bÜrow
::
Cow
;

17 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

18 
u£
 
	gsu³r
::
mysql
::
Res
;

19 
u£
 
	gsu³r
::
ResuÉ
;

21 
pub
 cÚ¡ 
	gUNSPECIFIED_LENGTH
: 
i32
 = -1;

23 
pub
 
â
 
Œunÿ‹_bš¬y
(
s
: &
mut
 
Vec
<
u8
>, 
æ’
: 
isize
) {

24 
æ’
 !ğ
UNSPECIFIED_LENGTH
 
as
 
isize
 && 
s
.
Ën
(è> fËÀa 
usize
 {

25 
s
.
Œunÿ‹
(
æ’
 
as
 
usize
);

32 
pub
 
â
 
Œunÿ‹_f64
(
mut
 
f
: 
f64
, 
æ’
: 
u8
, 
decim®
: u8è-> 
Res
<f64> {

33 
f
.
is_Çn
() {

34  
Res
::
Ov”æow
(0f64);

36 
Ët
 
	gshiá
 = 10u64.
pow
(
decim®
 
as
 
u32
èa 
f64
;

37 
Ët
 
	gmaxf
 = 10u64.
pow
((
æ’
 - 
decim®
è
as
 
u32
èa 
f64
 - 1.0 / 
shiá
;

38 
	gf
.
is_fš™e
() {

39 
Ët
 
	gtmp
 = 
f
 * 
shiá
;

40 
	gtmp
.
is_fš™e
() {

41 
	gf
 = 
tmp
.
round
(è/ 
shiá


45 
	gf
 > 
	gmaxf
 {

46  
	gRes
::
Ov”æow
(
maxf
);

49 
	gf
 < -
	gmaxf
 {

50  
	gRes
::
Ov”æow
(-
maxf
);

52 
	gRes
::
Ok
(
f
)

56 #[
maüo_expÜt
]

57 
maüo_ruËs
! 
ov”æow
 {

58 (
$v®
:
id’t
, 
	g$bound
:ident) => ({

59 
E¼
(
box_”r
!("cÚ¡ªˆ{} ov”æow {}", 
$v®
, 
$bound
))

64 
pub
 
â
 
cÚv”t_ušt_to_št
(
v®
: 
u64
, 
uµ”_bound
: 
i64
, 

: 
u8
è-> 
ResuÉ
<i64> {

65 
v®
 > 
uµ”_bound
 
as
 
u64
 {

66  
ov”æow
!(
v®
, 
	g
);

68 
Ok
(
v®
 
as
 
i64
)

71 
pub
 
â
 
cÚv”t_æßt_to_št
(
fv®
: 
f64
, 
low”_bound
: 
i64
, 
uµ”_bound
: i64, 

: 
u8
è-> 
ResuÉ
<i64> {

73 
Ët
 
v®
 = 
fv®
.
round
();

74 
	gv®
 < 
low”_bound
 
as
 
	gf64
 {

75  
	gov”æow
!(
	gv®
, 
	g
);

78 
	gv®
 > 
uµ”_bound
 
as
 
	gf64
 {

79  
	gov”æow
!(
	gv®
, 
	g
);

81 
Ok
(
v®
 
as
 
i64
)

84 
pub
 
â
 
cÚv”t_æßt_to_ušt
(
fv®
: 
f64
, 
uµ”_bound
: 
u64
, 

: 
u8
è-> 
ResuÉ
<u64> {

86 
Ët
 
v®
 = 
fv®
.
round
();

87 
	gv®
 < 0f64 {

88  
	gov”æow
!(
	gv®
, 
	g
);

91 
	gv®
 > 
uµ”_bound
 
as
 
	gf64
 {

92  
	gov”æow
!(
	gv®
, 
	g
);

94 
Ok
(
v®
 
as
 
u64
)

100 
pub
 
â
 
by‹s_to_št_w™hout_cÚ‹xt
(
by‹s
: &[
u8
]è-> 
ResuÉ
<
i64
> {

102 
Ët
 
mut
 
Œimed
 = 
by‹s
.
™”
().
sk_whe
(|&&
b
| b == b' ' || b == b'\t');

103 
Ët
 
mut
 
	gÃg©ive
 = 
çl£
;

104 
Ët
 
mut
 
	gr
 = 0
i64
;

105 
Ët
 
Some
(&
c
èğ
Œimed
.
Ãxt
() {

106 
c
 =ğ
b
'-' {

107 
Ãg©ive
 = 
Œue
;

108 } 
	gc
 >ğ
b
'0' && 
c
 <= b'9' {

109 
r
 = 
c
 
as
 
i64
 - 
b
'0'‡s i64;

110 } 
	gc
 !ğ
b
'+' {

111  
Ok
(0);

114 
	gr
 = 
Œimed


115 .
ke_whe
(|&&
c
| c >ğ
b
'0' && c <= b'9')

116 .
fŞd
(
r
, |
l
, &r|† * 10 + (¸- 
b
'0'è
as
 
i64
);

117 
	gÃg©ive
 {

118 
	gr
 = -
r
;

121 
Ok
(
r
)

127 
pub
 
â
 
by‹s_to_ušt_w™hout_cÚ‹xt
(
by‹s
: &[
u8
]è-> 
ResuÉ
<
u64
> {

129 
Ët
 
mut
 
Œimed
 = 
by‹s
.
™”
().
sk_whe
(|&&
b
| b == b' ' || b == b'\t');

130 
Ët
 
mut
 
	gr
 = 0u64;

131 
Ët
 
Some
(&
c
èğ
Œimed
.
Ãxt
() {

132 
c
 >ğ
b
'0' && c <= b'9' {

133 
r
 = 
c
 
as
 
u64
 - 
b
'0'‡s u64;

134 } 
	gc
 !ğ
b
'+' {

135  
Ok
(0);

138 
	gr
 = 
Œimed


139 .
ke_whe
(|&&
c
| c >ğ
b
'0' && c <= b'9')

140 .
fŞd
(
r
, |
l
, &r|† * 10 + (¸- 
b
'0'è
as
 
u64
);

142 
Ok
(
r
)

147 
pub
 
â
 
by‹s_to_št
(
ùx
: &
Ev®CÚ‹xt
, 
by‹s
: &[
u8
]è-> 
ResuÉ
<
i64
> {

148 
Ët
 
s
 = 
¡r
::
äom_utf8
(
by‹s
)?.
Œim
();

149 
Ët
 
	gvs
 = 
g‘_v®id_št_´efix
(
ùx
, 
s
)?;

150 
by‹s_to_št_w™hout_cÚ‹xt
(
vs
.
as_by‹s
())

155 
pub
 
â
 
by‹s_to_ušt
(
ùx
: &
Ev®CÚ‹xt
, 
by‹s
: &[
u8
]è-> 
ResuÉ
<
u64
> {

156 
Ët
 
s
 = 
¡r
::
äom_utf8
(
by‹s
)?.
Œim
();

157 
Ët
 
	gvs
 = 
g‘_v®id_št_´efix
(
ùx
, 
s
)?;

158 
by‹s_to_ušt_w™hout_cÚ‹xt
(
vs
.
as_by‹s
())

161 
â
 
by‹s_to_f64_w™hout_cÚ‹xt
(
by‹s
: &[
u8
]è-> 
ResuÉ
<
f64
> {

162 
Ët
 
f
 = 
m©ch
 
¡d
::
¡r
::
äom_utf8
(
by‹s
) {

163 
Ok
(
s
è=> 
m©ch
 s.
Œim
().
·r£
::<
f64
>() {

164 
Ok
(
f
) => f,

165 
E¼
(
e
) => {

166 
”rÜ
!("çedØ·r£ flßˆäom {}: {}", 
s
, 
e
);

170 
E¼
(
e
) => {

171 
”rÜ
!("çedØcÚv”ˆby‹ tØ¡r: {:?}", 
e
);

175 
Ok
(
f
)

179 
pub
 
â
 
by‹s_to_f64
(
ùx
: &
Ev®CÚ‹xt
, 
by‹s
: &[
u8
]è-> 
ResuÉ
<
f64
> {

180 
Ët
 
s
 = 
¡r
::
äom_utf8
(
by‹s
)?.
Œim
();

181 
Ët
 
	gvs
 = 
g‘_v®id_æßt_´efix
(
ùx
, 
s
)?;

183 
by‹s_to_f64_w™hout_cÚ‹xt
(
vs
.
as_by‹s
())

186 #[
šlše
]

187 
pub
 
â
 
hªdË_Œunÿ‹_as_”rÜ
(
ùx
: &
Ev®CÚ‹xt
è-> 
boŞ
 {

188 !(
ùx
.
ignÜe_Œunÿ‹
 || ctx.
Œunÿ‹_as_w¬nšg
)

191 #[
šlše
]

192 
pub
 
â
 
hªdË_Œunÿ‹
(
ùx
: &
Ev®CÚ‹xt
, 
is_Œunÿ‹d
: 
boŞ
è-> 
ResuÉ
<()> {

193 
is_Œunÿ‹d
 && 
hªdË_Œunÿ‹_as_”rÜ
(
ùx
) {

194 
E¼
(
box_”r
!("[1265] Data Truncated"))

196 
Ok
(())

200 
â
 
g‘_v®id_št_´efix
<'a>(ùx: &Ev®CÚ‹xt, s: &'
a
 
¡r
è-> 
ResuÉ
<
Cow
<'a, str>> {

201 
Ët
 
vs
 = 
g‘_v®id_æßt_´efix
(
ùx
, 
s
)?;

202 
æßt_¡r_to_št_¡ršg
(
vs
)

205 
â
 
	gg‘_v®id_æßt_´efix
<'a>(ùx: &Ev®CÚ‹xt, s: &'
a
 
	g¡r
è-> 
	gResuÉ
<&'a str> {

206 
Ët
 
mut
 
	g§w_dÙ
 = 
çl£
;

207 
Ët
 
mut
 
	g§w_dig™
 = 
çl£
;

208 
Ët
 
mut
 
	gv®id_Ën
 = 0;

209 
Ët
 
mut
 
	ge_idx
 = 0;

210 
i
, 
c
è
š
 
s
.
	`ch¬s
().
	$’um”©e
() {

211 
c
 == '+' || c == '-' {

212 
i
 !ğ0 && i !ğ
e_idx
 + 1 {

216 } 
c
 == '.' {

217 
§w_dÙ
 || 
e_idx
 > 0 {

221 
§w_dÙ
 = 
Œue
;

222 
§w_dig™
 {

224 
v®id_Ën
 = 
i
 + 1;

226 } 
c
 == 'e' || c == 'E' {

227 !
§w_dig™
 {

231 
e_idx
 != 0 {

235 
e_idx
 = 
i


236 } 
c
 < '0' || c > '9' {

239 
§w_dig™
 = 
Œue
;

240 
v®id_Ën
 = 
i
 + 1;

242 
	}
}

244 
hªdË_Œunÿ‹
(
ùx
, 
v®id_Ën
 < 
s
.
Ën
())?;

245 
	gv®id_Ën
 == 0 {

246 
Ok
("0")

248 
Ok
(&
s
[..
v®id_Ën
])

255 
â
 
	gæßt_¡r_to_št_¡ršg
<'a, '
	gb
: 'a>(v®id_æßt: &'
b
 
¡r
è-> 
ResuÉ
<
Cow
<'a, str>> {

256 
Ët
 
mut
 
dÙ_idx
 = 
NÚe
;

257 
Ët
 
mut
 
	ge_idx
 = 
NÚe
;

258 
Ët
 
mut
 
	gšt_út
: 
i64
 = 0;

259 
Ët
 
mut
 
	gdig™s_út
: 
i64
 = 0;

261 
i
, 
c
è
š
 
v®id_æßt
.
	`ch¬s
().
	$’um”©e
() {

262 
m©ch
 
c
 {

263 '.' => 
dÙ_idx
 = 
	`Some
(
i
),

264 'e' | 'E' => 
e_idx
 = 
	`Some
(
i
),

265 '0'...'9' => 
e_idx
.
	`is_nÚe
() {

266 
dÙ_idx
.
	`is_nÚe
() {

267 
št_út
 += 1;

269 
dig™s_út
 += 1;

271 
_
 => (),

273 
	}
}

275 
	gdÙ_idx
.
is_nÚe
(è&& 
	ge_idx
.
	$is_nÚe
() {

276  
	`Ok
(
Cow
::
	`BÜrowed
(
v®id_æßt
));

277 
	}
}

279 
	ge_idx
.
	$is_nÚe
() {

280 
št_út
 == 0 {

281  
	`Ok
(
Cow
::
	`BÜrowed
("0"));

283  
	`Ok
(
Cow
::
	`BÜrowed
(&
v®id_æßt
[..
dÙ_idx
.
	`unw¿p
()]));

284 
	}
}

286 
Ët
 
	gexp
 = 
box_Œy
!((&
v®id_æßt
[
e_idx
.
unw¿p
(è+ 1..]).
·r£
::<
i64
>());

287 
	gexp
 > 0 && 
	gšt_út
 > (
	gi64
::
MAX
 - 
exp
) {

290  
E¼
(
box_”r
!("[1264] Data Out of Range"));

292 
	gšt_út
 + 
	gexp
 <= 0 {

293  
Ok
(
Cow
::
BÜrowed
("0"));

296 
Ët
 
mut
 
	gv®id_št
 = 
SŒšg
::
äom
(&
v®id_æßt
[..
e_idx
.
unw¿p
()]);

297 
	gdÙ_idx
.
	$is_some
() {

298 
v®id_št
.
	`»move
(
dÙ_idx
.
	`unw¿p
());

299 
	}
}

301 
Ët
 
	gexŒa_z”o_couÁ
 = 
exp
 + 
št_út
 - 
dig™s_út
;

302 
	gexŒa_z”o_couÁ
 > 
	gMAX_ZERO_COUNT
 {

305  
E¼
(
box_”r
!("[1264] Data Out of Range"));

308 
	gexŒa_z”o_couÁ
 >= 0 {

309 
v®id_št
.
ex‹nd
((0..ex
Œa_z”o_couÁ
).
m­
(|
_
| '0'));

311 
Ët
 
	gËn
 = 
v®id_št
.
Ën
();

312 
	gexŒa_z”o_couÁ
 >ğ
Ën
 
as
 
i64
 {

313  
Ok
(
Cow
::
BÜrowed
("0"));

315 
	gv®id_št
.
Œunÿ‹
((
Ën
 
as
 
i64
 + 
exŒa_z”o_couÁ
èa 
usize
);

318 
Ok
(
Cow
::
OwÃd
(
v®id_št
))

321 cÚ¡ 
MAX_ZERO_COUNT
: 
i64
 = 20;

323 #[
cfg
(
‹¡
)]

324 
mod
 
	g‹¡
 {

325 
u£
 
	g¡d
::
f64
::
EPSILON
;

326 
u£
 
	g¡d
::{
isize
, 
	gf64
, 
	gi64
, 
	gu64
};

328 
u£
 
	gchrÚo
::
FixedOff£t
;

330 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

331 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
ty³s
;

333 
u£
 
	gsu³r
::*;

335 #[
‹¡
]

336 
â
 
‹¡_by‹s_to_i64
() {

337 
Ët
 
	g‹¡s
: 
Vec
<(&'static [u8], i64)> = vec![

338 (
b
"0", 0),

339 (
	gb
" 23a", 23),

340 (
	gb
"\t 23a", 23),

341 (
	gb
"\r23a", 0),

342 (
	gb
"1", 1),

343 (
	gb
"2.1", 2),

344 (
	gb
"23e10", 23),

345 (
	gb
"ab", 0),

346 (
	gb
"4a", 4),

347 (
	gb
"+1024", 1024),

348 (
	gb
"-231", -231),

349 (
	gb
"", 0),

352 
	gbs
, 
	gn
è
š
 
	g‹¡s
 {

353 
Ët
 
	gt
 = 
su³r
::
by‹s_to_št_w™hout_cÚ‹xt
(
bs
).
unw¿p
();

354 
	gt
 !ğ
n
 {

355 
·nic
!("ex³ù cÚv”ˆ{:?}Ø{}, buˆgÙ {}", 
bs
, 
n
, 
t
);

360 #[
‹¡
]

361 
â
 
‹¡_by‹s_to_u64
() {

362 
Ët
 
	g‹¡s
: 
Vec
<(&'static [u8], u64)> = vec![

363 (
b
"0", 0),

364 (
	gb
" 23a", 23),

365 (
	gb
"\t 23a", 23),

366 (
	gb
"\r23a", 0),

367 (
	gb
"1", 1),

368 (
	gb
"2.1", 2),

369 (
	gb
"23e10", 23),

370 (
	gb
"ab", 0),

371 (
	gb
"4a", 4),

372 (
	gb
"+1024", 1024),

373 (
	gb
"231", 231),

374 (
	gb
"18446744073709551615", 
	gu64
::
MAX
),

377 
	gbs
, 
	gn
è
š
 
	g‹¡s
 {

378 
Ët
 
	gt
 = 
su³r
::
by‹s_to_ušt_w™hout_cÚ‹xt
(
bs
).
unw¿p
();

379 
	gt
 !ğ
n
 {

380 
·nic
!("ex³ù cÚv”ˆ{:?}Ø{}, buˆgÙ {}", 
bs
, 
n
, 
t
);

385 #[
‹¡
]

386 
â
 
‹¡_by‹s_to_f64
() {

387 
Ët
 
	g‹¡s
: 
Vec
<(&'static [u8], f64)> = vec![

388 (
b
"", 0.0),

389 (
	gb
" 23", 23.0),

390 (
	gb
"-1", -1.0),

391 (
	gb
"1.11", 1.11),

392 (
	gb
"1.11.00", 0.0),

393 (
	gb
"xx", 0.0),

394 (
	gb
"0x00", 0.0),

395 (
	gb
"11.xx", 0.0),

396 (
	gb
"xx.11", 0.0),

399 
	gv
, 
	gf
è
š
 
	g‹¡s
 {

400 
Ët
 
	gff
 = 
su³r
::
by‹s_to_f64_w™hout_cÚ‹xt
(
v
).
unw¿p
();

401 ià(
	gff
 - 
	gf
).
abs
(è> 
	gEPSILON
 {

402 
	g·nic
!("{:?} should bdecodtØ{}, buˆgÙ {}", 
	gv
, 
	gf
, 
	gff
);

407 #[
‹¡
]

408 
â
 
‹¡_hªdË_Œunÿ‹
() {

409 
Ët
 
	gùxs
 = 
vec
![

410 
Ev®CÚ‹xt
 {

411 
tz
: 
FixedOff£t
::
—¡
(0),

412 
ignÜe_Œunÿ‹
: 
Œue
,

413 
Œunÿ‹_as_w¬nšg
: 
Œue
,

415 
Ev®CÚ‹xt
 {

416 
tz
: 
FixedOff£t
::
—¡
(0),

417 
ignÜe_Œunÿ‹
: 
Œue
,

418 
Œunÿ‹_as_w¬nšg
: 
çl£
,

420 
Ev®CÚ‹xt
 {

421 
tz
: 
FixedOff£t
::
—¡
(0),

422 
ignÜe_Œunÿ‹
: 
çl£
,

423 
Œunÿ‹_as_w¬nšg
: 
Œue
,

425 
Ev®CÚ‹xt
 {

426 
tz
: 
FixedOff£t
::
—¡
(0),

427 
ignÜe_Œunÿ‹
: 
çl£
,

428 
Œunÿ‹_as_w¬nšg
: 
çl£
,

432 
ùx
 
	gš
 &
	gùxs
 {

433 
	gas£¹
!(
	gsu³r
::
hªdË_Œunÿ‹
(
ùx
, 
çl£
).
is_ok
());

436 
	gas£¹
!(
	gsu³r
::
hªdË_Œunÿ‹
(&
ùxs
[0], 
Œue
).
is_ok
());

437 
	gas£¹
!(
	gsu³r
::
hªdË_Œunÿ‹
(&
ùxs
[1], 
Œue
).
is_ok
());

438 
	gas£¹
!(
	gsu³r
::
hªdË_Œunÿ‹
(&
ùxs
[2], 
Œue
).
is_ok
());

439 
	gas£¹
!(
	gsu³r
::
hªdË_Œunÿ‹
(&
ùxs
[3], 
Œue
).
is_”r
());

442 #[
‹¡
]

443 
â
 
‹¡_g‘_v®id_æßt_´efix
() {

444 
Ët
 
	gÿ£s
 = 
vec
![

461 
Ët
 
	gùx
 = 
Ev®CÚ‹xt
 {

462 
tz
: 
FixedOff£t
::
—¡
(0),

463 
ignÜe_Œunÿ‹
: 
Œue
,

464 
Œunÿ‹_as_w¬nšg
: 
çl£
,

466 
	gi
, 
	go
è
š
 
	gÿ£s
 {

467 
	gas£¹_eq
!(
	gsu³r
::
g‘_v®id_æßt_´efix
(&
ùx
, 
i
).
unw¿p
(), 
	go
);

471 #[
‹¡
]

472 
â
 
‹¡_šv®id_g‘_v®id_št_´efix
() {

473 
Ët
 
	gÿ£s
 = 
vec
!["1e21", "1e9223372036854775807"];

475 
i
 
š
 
	gÿ£s
 {

476 
Ët
 
	go
 = 
su³r
::
æßt_¡r_to_št_¡ršg
(
i
);

477 
	gas£¹
!(
	go
.
is_”r
());

481 #[
‹¡
]

482 
â
 
‹¡_v®id_g‘_v®id_št_´efix
() {

483 
Ët
 
	gÿ£s
 = 
vec
![

496 
	gi
, 
	ge
è
š
 
	gÿ£s
 {

497 
Ët
 
	go
 = 
su³r
::
æßt_¡r_to_št_¡ršg
(
i
);

498 
	gas£¹_eq
!(
	go
.
unw¿p
(), *
	ge
);

502 #[
‹¡
]

503 
â
 
‹¡_cÚv”t_ušt_što_št
() {

504 
	gas£¹
!(
cÚv”t_ušt_to_št
(
u64
::
MAX
, 
i64
::MAX, 
ty³s
::
LONG_LONG
).
is_”r
());

505 
Ët
 
	gv
 = 
cÚv”t_ušt_to_št
(
u64
::
MIN
, 
i64
::
MAX
, 
ty³s
::
LONG_LONG
).
unw¿p
();

506 
	gas£¹_eq
!(
	gv
, 
	gu64
::
MIN
 
as
 
i64
);

510 #[
‹¡
]

511 
â
 
‹¡_cÚv”t_æßt_to_št
() {

512 
	gas£¹
!(
cÚv”t_æßt_to_št
(
f64
::
MIN
, 
i64
::MIN, i64::
MAX
, 
ty³s
::
DOUBLE
).
is_”r
());

513 
	gas£¹
!(
cÚv”t_æßt_to_št
(
f64
::
MAX
, 
i64
::
MIN
, i64::MAX, 
ty³s
::
DOUBLE
).
is_”r
());

514 
Ët
 
	gv
 = 
cÚv”t_æßt_to_št
(0.1, 
i64
::
MIN
, i64::
MAX
, 
ty³s
::
DOUBLE
).
unw¿p
();

515 
	gas£¹_eq
!(
	gv
, 0);

519 #[
‹¡
]

520 
â
 
‹¡_cÚv”t_æßt_to_ušt
() {

521 
	gas£¹
!(
cÚv”t_æßt_to_ušt
(
f64
::
MIN
, 
u64
::
MAX
, 
ty³s
::
DOUBLE
).
is_”r
());

522 
	gas£¹
!(
cÚv”t_æßt_to_ušt
(
f64
::
MAX
, 
u64
::MAX, 
ty³s
::
DOUBLE
).
is_”r
());

523 
Ët
 
	gv
 = 
cÚv”t_æßt_to_ušt
(0.1, 
u64
::
MAX
, 
ty³s
::
DOUBLE
).
unw¿p
();

524 
	gas£¹_eq
!(
	gv
, 0);

528 #[
‹¡
]

529 
â
 
‹¡_Œunÿ‹_bš¬y
() {

530 
Ët
 
	gs
 = 
b
"123456789".
to_vec
();

531 
Ët
 
mut
 
	gs1
 = 
s
.
şÚe
();

532 
Œunÿ‹_bš¬y
(&
mut
 
s1
, 
UNSPECIFIED_LENGTH
 
as
 
isize
);

533 
	gas£¹_eq
!(
	gs1
, 
	gs
);

534 
Ët
 
mut
 
	gs2
 = 
s
.
şÚe
();

535 
Œunÿ‹_bš¬y
(&
mut
 
s2
, 
isize
::
MAX
);

536 
	gas£¹_eq
!(
	gs2
, 
	gs
);

537 
Ët
 
mut
 
	gs3
 = 
s
;

538 
Œunÿ‹_bš¬y
(&
mut
 
s3
, 0);

539 
	gas£¹
!(
	gs3
.
is_em±y
());

543 #[
‹¡
]

544 
â
 
‹¡_Œunÿ‹_f64
() {

545 
Ët
 
	gÿ£s
 = 
vec
![

546 (100.114, 10, 2, 
Res
::
Ok
(100.11)),

547 (100.115, 10, 2, 
Res
::
Ok
(100.12)),

548 (100.1156, 10, 3, 
Res
::
Ok
(100.116)),

549 (100.1156, 3, 1, 
Res
::
Ov”æow
(99.9)),

550 (1.36, 10, 2, 
Res
::
Ok
(1.36)),

551 (
f64
::
NAN
, 10, 1, 
Res
::
Ov”æow
(0f64)),

553 
	gf
, 
	gæ’
, 
	gdecim®
, 
	gexp
è
š
 
	gÿ£s
 {

554 
Ët
 
	g»s
 = 
Œunÿ‹_f64
(
f
, 
æ’
, 
decim®
);

555 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

	@src/coprocessor/codec/datum.rs

15 
u£
 
	g¡d
::
bÜrow
::
Cow
;

16 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

17 
u£
 
	g¡d
::{
¡r
, 
	gi64
};

18 
u£
 
	g¡d
::
io
::
Wr™e
;

19 
u£
 
	g¡d
::
¡r
::
FromSŒ
;

20 
u£
 
	g¡d
::
mem
;

21 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDebug
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

22 
u£
 
	gby‹Üd”
::{
R—dBy‹sExt
, 
	gWr™eBy‹sExt
};

24 
u£
 
	gut
::
esÿ³
;

25 
u£
 
	gut
::
codec
::{
by‹s
, 
	gnumb”
};

26 
u£
 
	gut
::
codec
::
numb”
::
Numb”Decod”
;

27 
u£
 
	gut
::
codec
::
by‹s
::
By‹sEncod”
;

28 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

29 
u£
 
	gsu³r
::{
cÚv”t
, 
	gResuÉ
};

30 
u£
 
	gsu³r
::
mysql
::{
£lf
, 
	g·r£_jsÚ_·th_ex´
, 
	gDecim®
, 
	gDecim®Decod”
, 
	gDecim®Encod”
, 
	gDu¿tiÚ
,

31 
	gJsÚ
, 
	gJsÚDecod”
, 
	gJsÚEncod”
, 
	gP©hEx´essiÚ
, 
	gTime
, 
	gDEFAULT_FSP
, 
	gMAX_FSP
};

33 
pub
 cÚ¡ 
	gNIL_FLAG
: 
u8
 = 0;

34 cÚ¡ 
	gBYTES_FLAG
: 
u8
 = 1;

35 cÚ¡ 
	gCOMPACT_BYTES_FLAG
: 
u8
 = 2;

36 cÚ¡ 
	gINT_FLAG
: 
u8
 = 3;

37 cÚ¡ 
	gUINT_FLAG
: 
u8
 = 4;

38 cÚ¡ 
	gFLOAT_FLAG
: 
u8
 = 5;

39 cÚ¡ 
	gDECIMAL_FLAG
: 
u8
 = 6;

40 cÚ¡ 
	gDURATION_FLAG
: 
u8
 = 7;

41 cÚ¡ 
	gVAR_INT_FLAG
: 
u8
 = 8;

42 cÚ¡ 
	gVAR_UINT_FLAG
: 
u8
 = 9;

43 cÚ¡ 
	gJSON_FLAG
: 
u8
 = 10;

44 cÚ¡ 
	gMAX_FLAG
: 
u8
 = 250;

46 #[
d”ive
(
P¬tŸlEq
, 
ClÚe
)]

47 
pub
 
	eD©um
 {

48 
	mNuÎ
,

49 
I64
(
i64
),

50 
U64
(
u64
),

51 
F64
(
f64
),

52 
Dur
(
Du¿tiÚ
),

53 
By‹s
(
Vec
<
u8
>),

54 
Dec
(
Decim®
),

55 
Time
(Time),

56 
JsÚ
(Json),

57 
	mMš
,

58 
	mMax
,

61 
im¶
 
Di¥Ïy
 
	gD©um
 {

62 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

63 
m©ch
 *
£lf
 {

64 
D©um
::
NuÎ
 => 
wr™e
!(
f
, "NULL"),

65 
	gD©um
::
I64
(
i
è=> 
wr™e
!(
f
, "I64({})", 
	gi
),

66 
	gD©um
::
U64
(
u
è=> 
wr™e
!(
f
, "U64({})", 
	gu
),

67 
	gD©um
::
F64
(
v
è=> 
wr™e
!(
f
, "F64({})", 
	gv
),

68 
	gD©um
::
Dur
(
»f
 
d
è=> 
wr™e
!(
f
, "Dur({})", 
	gd
),

69 
	gD©um
::
By‹s
(
»f
 
bs
è=> 
wr™e
!(
f
, "By‹s(\"{}\")", 
esÿ³
(bs)),

70 
	gD©um
::
Dec
(
»f
 
d
è=> 
wr™e
!(
f
, "Dec({})", 
	gd
),

71 
	gD©um
::
Time
(
»f
 
t
è=> 
wr™e
!(
f
, "Time({})", 
	gt
),

72 
	gD©um
::
JsÚ
(
»f
 
j
è=> 
wr™e
!(
f
, "JsÚ({})", 
	gj
.
to_¡ršg
()),

73 
	gD©um
::
Mš
 => 
wr™e
!(
f
, "MIN"),

74 
	gD©um
::
Max
 => 
wr™e
!(
f
, "MAX"),

79 
im¶
 
Debug
 
	gD©um
 {

80 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

81 
wr™e
!(
f
, "{}", 
	g£lf
)

85 #[
šlše
]

86 
pub
 
â
 
cmp_f64
(
l
: 
f64
, 
r
: f64è-> 
ResuÉ
<
Ord”šg
> {

87 
l
.
·¹Ÿl_cmp
(&
r
)

88 .
ok_Ü_–£
(|| 
šv®id_ty³
!("{}‡nd {} cª'ˆbcom·»d", 
l
, 
r
))

91 #[
šlše
]

92 
â
 
checked_add_i64
(
l
: 
u64
, 
r
: 
i64
è-> 
O±iÚ
<u64> {

93 
r
 >= 0 {

94 
Some
(
l
 + 
r
 
as
 
u64
)

96 
l
.
checked_sub
(
r
.
ov”æowšg_Ãg
().0 
as
 
u64
)

100 
im¶
 
D©um
 {

101 
pub
 
â
 
cmp
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
d©um
: &
D©um
è-> 
ResuÉ
<
Ord”šg
> {

102 
Ët
 
D©um
::
JsÚ
(
_
èğ*
£lf
 {

103 
Ët
 
D©um
::
JsÚ
(
_
èğ*
d©um
 {

106 
Ët
 
Üd”
 = 
d©um
.
cmp
(
ùx
, 
£lf
)?;

107  
Ok
(
Üd”
.
»v”£
());

111 
m©ch
 *
	gd©um
 {

112 
	gD©um
::
NuÎ
 => 
m©ch
 *
£lf
 {

113 
D©um
::
NuÎ
 => 
Ok
(
Ord”šg
::
Equ®
),

114 
	g_
 => 
Ok
(
Ord”šg
::
G»©”
),

116 
	gD©um
::
Mš
 => 
m©ch
 *
£lf
 {

117 
D©um
::
NuÎ
 => 
Ok
(
Ord”šg
::
Less
),

118 
	gD©um
::
Mš
 => 
Ok
(
Ord”šg
::
Equ®
),

119 
	g_
 => 
Ok
(
Ord”šg
::
G»©”
),

121 
	gD©um
::
Max
 => 
m©ch
 *
£lf
 {

122 
D©um
::
Max
 => 
Ok
(
Ord”šg
::
Equ®
),

123 
	g_
 => 
Ok
(
Ord”šg
::
Less
),

125 
	gD©um
::
I64
(
i
è=> 
£lf
.
cmp_i64
(
ùx
, i),

126 
	gD©um
::
U64
(
u
è=> 
£lf
.
cmp_u64
(
ùx
, u),

127 
	gD©um
::
F64
(
f
è=> 
£lf
.
cmp_f64
(
ùx
, f),

128 
	gD©um
::
By‹s
(
»f
 
bs
è=> 
£lf
.
cmp_by‹s
(
ùx
, bs),

129 
	gD©um
::
Dur
(
»f
 
d
è=> 
£lf
.
cmp_dur
(
ùx
, d),

130 
	gD©um
::
Dec
(
»f
 
d
è=> 
£lf
.
cmp_dec
(
ùx
, d),

131 
	gD©um
::
Time
(
»f
 
t
è=> 
£lf
.
cmp_time
(
ùx
,),

132 
	gD©um
::
JsÚ
(
»f
 
j
è=> 
£lf
.
cmp_jsÚ
(j),

136 
â
 
cmp_i64
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
i
: 
i64
è-> 
ResuÉ
<
Ord”šg
> {

137 
m©ch
 *
£lf
 {

138 
D©um
::
I64
(
ii
è=> 
Ok
(ii.
cmp
(&
i
)),

139 
	gD©um
::
U64
(
u
è=> 
i
 < 0 || u > 
i64
::
MAX
 
as
 
u64
 {

140 
Ok
(
Ord”šg
::
G»©”
)

142 
Ok
(
u
.
cmp
(&(
i
 
as
 
u64
)))

144 
	g_
 => 
£lf
.
cmp_f64
(
ùx
, 
i
 
as
 
f64
),

148 
â
 
cmp_u64
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
u
: 
u64
è-> 
ResuÉ
<
Ord”šg
> {

149 
m©ch
 *
£lf
 {

150 
D©um
::
I64
(
i
è=> ˜< 0 || 
u
 > 
i64
::
MAX
 
as
 
u64
 {

151 
Ok
(
Ord”šg
::
Less
)

153 
Ok
(
i
.
cmp
(&(
u
 
as
 
i64
)))

155 
	gD©um
::
U64
(
uu
è=> 
Ok
(uu.
cmp
(&
u
)),

156 
	g_
 => 
£lf
.
cmp_f64
(
ùx
, 
u
 
as
 
f64
),

160 
â
 
cmp_f64
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
f
: 
f64
è-> 
ResuÉ
<
Ord”šg
> {

161 
m©ch
 *
£lf
 {

162 
D©um
::
NuÎ
 | D©um::
Mš
 => 
Ok
(
Ord”šg
::
Less
),

163 
	gD©um
::
Max
 => 
Ok
(
Ord”šg
::
G»©”
),

164 
	gD©um
::
I64
(
i
è=> 
cmp_f64
(˜
as
 
f64
, 
f
),

165 
	gD©um
::
U64
(
u
è=> 
cmp_f64
(u 
as
 
f64
, 
f
),

166 
	gD©um
::
F64
(
ff
è=> 
cmp_f64
(ff, 
f
),

167 
	gD©um
::
By‹s
(
»f
 
bs
) => {

168 
Ët
 
ff
 = 
cÚv”t
::
by‹s_to_f64
(
ùx
, 
bs
)?;

169 
cmp_f64
(
ff
, 
f
)

171 
	gD©um
::
Dec
(
»f
 
d
) => {

172 
Ët
 
ff
 = 
d
.
as_f64
()?;

173 
cmp_f64
(
ff
, 
f
)

175 
	gD©um
::
Dur
(
»f
 
d
) => {

176 
Ët
 
ff
 = 
d
.
to_£cs
();

177 
cmp_f64
(
ff
, 
f
)

179 
	gD©um
::
Time
(
»f
 
t
) => {

180 
Ët
 
ff
 = 
t
.
to_f64
()?;

181 
cmp_f64
(
ff
, 
f
)

183 
	gD©um
::
JsÚ
(
»f
 
jsÚ
è=> 
D©um
::
F64
(
f
).
cmp_jsÚ
(json),

187 
â
 
cmp_by‹s
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
bs
: &[
u8
]è-> 
ResuÉ
<
Ord”šg
> {

188 
m©ch
 *
£lf
 {

189 
D©um
::
NuÎ
 | D©um::
Mš
 => 
Ok
(
Ord”šg
::
Less
),

190 
	gD©um
::
Max
 => 
Ok
(
Ord”šg
::
G»©”
),

191 
	gD©um
::
By‹s
(
»f
 
bss
è=> 
Ok
((bs 
as
 &[
u8
]).
cmp
(
bs
)),

192 
	gD©um
::
Dec
(
»f
 
d
) => {

193 
Ët
 
s
 = 
¡r
::
äom_utf8
(
bs
)?;

194 
Ët
 
	gd2
 = 
s
.
·r£
()?;

195 
Ok
(
d
.
cmp
(&
d2
))

197 
	gD©um
::
Time
(
»f
 
t
) => {

198 
Ët
 
s
 = 
¡r
::
äom_utf8
(
bs
)?;

199 
Ët
 
	gt2
 = 
Time
::
·r£_d©‘ime
(
s
, 
DEFAULT_FSP
, &
ùx
.
tz
)?;

200 
Ok
(
t
.
cmp
(&
t2
))

202 
	gD©um
::
Dur
(
»f
 
d
) => {

203 
Ët
 
d2
 = 
Du¿tiÚ
::
·r£
(
bs
, 
MAX_FSP
)?;

204 
Ok
(
d
.
cmp
(&
d2
))

206 
	g_
 => {

207 
Ët
 
f
 = 
cÚv”t
::
by‹s_to_f64
(
ùx
, 
bs
)?;

208 
	g£lf
.
cmp_f64
(
ùx
, 
f
)

213 
â
 
cmp_dec
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
dec
: &
Decim®
è-> 
ResuÉ
<
Ord”šg
> {

214 
m©ch
 *
£lf
 {

215 
D©um
::
Dec
(
»f
 
d
è=> 
Ok
(d.
cmp
(
dec
)),

216 
	gD©um
::
By‹s
(
»f
 
bs
) => {

217 
Ët
 
s
 = 
¡r
::
äom_utf8
(
bs
)?;

218 
Ët
 
	gd
 = 
s
.
·r£
::<
Decim®
>()?;

219 
Ok
(
d
.
cmp
(
dec
))

221 
	g_
 => {

222 
Ët
 
f
 = 
dec
.
as_f64
()?;

223 
	g£lf
.
cmp_f64
(
ùx
, 
f
)

228 
â
 
cmp_dur
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
d
: &
Du¿tiÚ
è-> 
ResuÉ
<
Ord”šg
> {

229 
m©ch
 *
£lf
 {

230 
D©um
::
Dur
(
»f
 
d2
è=> 
Ok
(d2.
cmp
(
d
)),

231 
	gD©um
::
By‹s
(
»f
 
bs
) => {

232 
Ët
 
d2
 = 
Du¿tiÚ
::
·r£
(
bs
, 
MAX_FSP
)?;

233 
Ok
(
d2
.
cmp
(
d
))

235 
	g_
 => 
£lf
.
cmp_f64
(
ùx
, 
d
.
to_£cs
()),

239 
â
 
cmp_time
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
time
: &
Time
è-> 
ResuÉ
<
Ord”šg
> {

240 
m©ch
 *
£lf
 {

241 
D©um
::
By‹s
(
»f
 
bs
) => {

242 
Ët
 
s
 = 
¡r
::
äom_utf8
(
bs
)?;

243 
Ët
 
	gt
 = 
Time
::
·r£_d©‘ime
(
s
, 
DEFAULT_FSP
, &
ùx
.
tz
)?;

244 
Ok
(
t
.
cmp
(
time
))

246 
	gD©um
::
Time
(
»f
 
t
è=> 
Ok
Ñ.
cmp
(
time
)),

247 
	g_
 => {

248 
Ët
 
f
 = 
time
.
to_f64
()?;

249 
	g£lf
.
cmp_f64
(
ùx
, 
f
)

254 
â
 
cmp_jsÚ
(&
£lf
, 
jsÚ
: &
JsÚ
è-> 
ResuÉ
<
Ord”šg
> {

255 
Ët
 
Üd”
 = 
m©ch
 *
£lf
 {

256 
D©um
::
JsÚ
(
»f
 
j
è=> j.
cmp
(
jsÚ
),

257 
	gD©um
::
I64
(
d
è=> 
JsÚ
::I64(d).
cmp
(
jsÚ
),

258 
	gD©um
::
U64
(
d
è=> 
JsÚ
::U64(d).
cmp
(
jsÚ
),

259 
	gD©um
::
F64
(
d
è=> 
JsÚ
::
DoubË
(d).
cmp
(
jsÚ
),

260 
	gD©um
::
Dec
(
»f
 
d
) => {

261 
Ët
 
ff
 = 
d
.
as_f64
()?;

262 
	gJsÚ
::
DoubË
(
ff
).
cmp
(
jsÚ
)

264 
D©um
::
By‹s
(
»f
 
d
) => {

265 
Ët
 
d©a
 = 
¡r
::
äom_utf8
(
d
)?;

266 
	gJsÚ
::
SŒšg
(SŒšg::
äom
(
d©a
)).
cmp
(
jsÚ
)

268 
_
 => {

269 
Ët
 
d©a
 = 
£lf
.
to_¡ršg
().
unw¿p_Ü_deçuÉ
();

270 
	gJsÚ
::
SŒšg
(
d©a
).
cmp
(
jsÚ
)

273 
Ok
(
Üd”
)

278 
pub
 
â
 
što_boŞ
(
£lf
, 
ùx
: &
Ev®CÚ‹xt
è-> 
ResuÉ
<
O±iÚ
<
boŞ
>> {

279 
Ët
 
b
 = 
m©ch
 
£lf
 {

280 
D©um
::
I64
(
i
è=> 
Some
(i != 0),

281 
	gD©um
::
U64
(
u
è=> 
Some
(u != 0),

282 
	gD©um
::
F64
(
f
è=> 
Some
(f.
round
() != 0f64),

283 
	gD©um
::
By‹s
(
»f
 
bs
è=> 
Some
(!bs.
is_em±y
(è&& 
cÚv”t
::
by‹s_to_št
(
ùx
, bs)? != 0),

284 
	gD©um
::
Time
(
t
è=> 
Some
(!t.
is_z”o
()),

285 
	gD©um
::
Dur
(
d
è=> 
Some
(!d.
is_em±y
()),

286 
	gD©um
::
Dec
(
d
è=> 
Some
(d.
as_f64
()?.
round
() != 0f64),

287 
	gD©um
::
NuÎ
 => 
NÚe
,

288 
	g_
 =>  
E¼
(
šv®id_ty³
!("ÿn'ˆcÚv”ˆ{:?}ØboŞ", 
£lf
)),

290 
Ok
(
b
)

293 
pub
 
â
 
to_¡ršg
(&
£lf
è-> 
	gResuÉ
<
	gSŒšg
> {

294 
Ët
 
	gs
 = 
m©ch
 *
£lf
 {

295 
D©um
::
I64
(
i
è=> 
fÜm©
!("{}", 
	gi
),

296 
	gD©um
::
U64
(
u
è=> 
fÜm©
!("{}", 
	gu
),

297 
	gD©um
::
F64
(
f
è=> 
fÜm©
!("{}", 
	gf
),

298 
	gD©um
::
By‹s
(
»f
 
bs
è=> 
SŒšg
::
äom_utf8
(bs.
to_vec
())?,

299 
	gD©um
::
Time
(
»f
 
t
è=> 
fÜm©
!("{}", 
	gt
),

300 
	gD©um
::
Dur
(
»f
 
d
è=> 
fÜm©
!("{}", 
	gd
),

301 
	gD©um
::
Dec
(
»f
 
d
è=> 
fÜm©
!("{}", 
	gd
),

302 
	gD©um
::
JsÚ
(
»f
 
d
è=> d.
to_¡ršg
(),

303 
»f
 
	gd
 =>  
E¼
(
šv®id_ty³
!("ÿn'ˆcÚv”ˆ{:?}Ø¡ršg", 
d
)),

305 
Ok
(
s
)

310 
pub
 
â
 
što_¡ršg
(
£lf
è-> 
	gResuÉ
<
	gSŒšg
> {

311 
Ët
 
	gD©um
::
By‹s
(
bs
èğ
£lf
 {

312 
Ët
 
d©a
 = 
SŒšg
::
äom_utf8
(
bs
)?;

313 
Ok
(
d©a
)

315 
	g£lf
.
to_¡ršg
()

321 
pub
 
â
 
što_f64
(
£lf
, 
ùx
: &
Ev®CÚ‹xt
è-> 
ResuÉ
<
f64
> {

322 
m©ch
 
£lf
 {

323 
D©um
::
I64
(
i
è=> 
Ok
(˜
as
 
f64
),

324 
	gD©um
::
U64
(
u
è=> 
Ok
(u 
as
 
f64
),

325 
	gD©um
::
F64
(
f
è=> 
Ok
(f),

326 
	gD©um
::
By‹s
(
bs
è=> 
cÚv”t
::
by‹s_to_f64
(
ùx
, &bs),

327 
	gD©um
::
Time
(
t
) => {

328 
Ët
 
d
 = 
t
.
to_decim®
()?;

329 
	gd
.
as_f64
()

331 
	gD©um
::
Dur
(
d
) => {

332 
Ët
 
d
 = d.
to_decim®
()?;

333 
	gd
.
as_f64
()

335 
	gD©um
::
Dec
(
d
è=> d.
as_f64
(),

336 
	g_
 => 
E¼
(
box_”r
!("çedØcÚv”ˆ{}Øf64", 
£lf
)),

341 
pub
 
â
 
f64
(&
£lf
è-> 
	gf64
 {

342 
Ët
 
	gi
 = 
£lf
.
i64
();

343 
	gun§ã
 { 
	gmem
::
Œªsmu‹
(
i
) }

347 
pub
 
â
 
i64
(&
£lf
) -> i64 {

348 
m©ch
 *
£lf
 {

349 
D©um
::
I64
(
i
) => i,

350 
	gD©um
::
U64
(
u
è=> u 
as
 
i64
,

351 
	gD©um
::
F64
(
f
è=> 
un§ã
 { 
mem
::
Œªsmu‹
(f) },

352 
	gD©um
::
Dur
(
»f
 
d
è=> d.
to_Çnos
(),

353 
	gD©um
::
Time
(
_
) |

354 
D©um
::
By‹s
(
_
) |

355 
D©um
::
Dec
(
_
) |

356 
D©um
::
JsÚ
(
_
) |

357 
D©um
::
Max
 |

358 
D©um
::
Mš
 |

359 
D©um
::
NuÎ
 => 0,

364 
pub
 
â
 
u64
(&
£lf
è-> 
	gu64
 {

365 
	g£lf
.
i64
(è
as
 
	gu64


370 
pub
 
â
 
što_¬™h
(
£lf
, 
ùx
: &
Ev®CÚ‹xt
è-> 
ResuÉ
<
D©um
> {

371 
m©ch
 
£lf
 {

373 
D©um
::
By‹s
(
bs
è=> 
cÚv”t
::
by‹s_to_f64
(
ùx
, &bs).
m­
(
From
::
äom
),

374 
	gD©um
::
Time
(
t
) => {

376 
Ët
 
dec
 = 
t
.
to_decim®
()?;

377 
	gt
.
g‘_f¥
() == 0 {

378  
Ok
(
D©um
::
I64
(
dec
.
as_i64
().
unw¿p
()));

380 
Ok
(
D©um
::
Dec
(
dec
))

382 
D©um
::
Dur
(
d
) => {

383 
Ët
 
dec
 = 
d
.
to_decim®
()?;

384 
	gd
.
g‘_f¥
() == 0 {

385  
Ok
(
D©um
::
I64
(
dec
.
as_i64
().
unw¿p
()));

387 
Ok
(
D©um
::
Dec
(
dec
))

389 
a
 => 
Ok
(a),

394 
pub
 
â
 
što_dec
(
£lf
è-> 
	gResuÉ
<
	gDecim®
> {

395 
m©ch
 
	g£lf
 {

396 
	gD©um
::
Time
(
t
è=>.
to_decim®
().
m­_”r
(
From
::
äom
),

397 
	gD©um
::
Dur
(
d
è=> d.
to_decim®
().
m­_”r
(
From
::
äom
),

398 
	gd
 => 
m©ch
 
d
.
cÛrû_to_dec
()? {

399 
D©um
::
Dec
(
d
è=> 
Ok
(d),

400 
	gd
 => 
E¼
(
box_”r
!("çedØcÚv” {}Ødecim®", 
d
)),

414 
pub
 
â
 
ÿ¡_as_jsÚ
(
£lf
è-> 
	gResuÉ
<
	gJsÚ
> {

415 
m©ch
 
	g£lf
 {

416 
	gD©um
::
By‹s
(
»f
 
bs
) => {

417 
Ët
 
s
 = 
box_Œy
!(
¡r
::
äom_utf8
(
bs
));

418 
Ët
 
	gjsÚ
: 
JsÚ
 = 
s
.
·r£
()?;

419 
Ok
(
jsÚ
)

421 
	gD©um
::
I64
(
d
è=> 
Ok
(
JsÚ
::I64(d)),

422 
	gD©um
::
U64
(
d
è=> 
Ok
(
JsÚ
::U64(d)),

423 
	gD©um
::
F64
(
d
è=> 
Ok
(
JsÚ
::
DoubË
(d)),

424 
	gD©um
::
Dec
(
d
) => {

425 
Ët
 
ff
 = 
d
.
as_f64
()?;

426 
Ok
(
JsÚ
::
DoubË
(
ff
))

428 
D©um
::
JsÚ
(
d
è=> 
Ok
(d),

429 
	g_
 => {

430 
Ët
 
s
 = 
£lf
.
što_¡ršg
()?;

431 
Ok
(
JsÚ
::
SŒšg
(
s
))

439 
pub
 
â
 
što_jsÚ
(
£lf
è-> 
ResuÉ
<
JsÚ
> {

440 
m©ch
 
£lf
 {

441 
D©um
::
NuÎ
 => 
Ok
(
JsÚ
::
NÚe
),

442 
	gD©um
::
By‹s
(
bs
) => {

443 
Ët
 
s
 = 
SŒšg
::
äom_utf8
(
bs
)?;

444 
Ok
(
JsÚ
::
SŒšg
(
s
))

446 
_
 => 
£lf
.
ÿ¡_as_jsÚ
(),

450 
pub
 
â
 
to_jsÚ_·th_ex´
(&
£lf
è-> 
	gResuÉ
<
	gP©hEx´essiÚ
> {

451 
Ët
 
	gv
 = 
m©ch
 *
£lf
 {

452 
D©um
::
By‹s
(
»f
 
bs
è=> 
¡r
::
äom_utf8
(bs)?,

453 
	g_
 => "",

455 
·r£_jsÚ_·th_ex´
(
v
)

460 
â
 
cÛrû_to_dec
(
£lf
è-> 
	gResuÉ
<
	gD©um
> {

461 
Ët
 
	gdec
 = 
m©ch
 
£lf
 {

462 
D©um
::
I64
(
i
è=> i.
što
(),

463 
	gD©um
::
U64
(
u
è=> u.
što
(),

464 
	gD©um
::
F64
(
f
è=> 
Decim®
::
äom_f64
(f)?,

465 
	gD©um
::
By‹s
(
»f
 
bs
) => {

466 
Ët
 
s
 = 
box_Œy
!(
¡r
::
äom_utf8
(
bs
));

467 
	gDecim®
::
äom_¡r
(
s
)?

469 
d
 @ 
D©um
::
Dec
(
_
è=>  
Ok
(d),

470 
	g_
 =>  
E¼
(
box_”r
!("çedØcÚv”ˆ{}Ødecim®", 
£lf
)),

472 
Ok
(
D©um
::
Dec
(
dec
))

476 
â
 
cÛrû_to_f64
(
£lf
è-> 
ResuÉ
<
D©um
> {

477 
m©ch
 
£lf
 {

478 
D©um
::
I64
(
i
è=> 
Ok
(D©um::
F64
(˜
as
 
f64
)),

479 
	gD©um
::
U64
(
u
è=> 
Ok
(
D©um
::
F64
(u 
as
 
f64
)),

480 
	gD©um
::
Dec
(
d
) => {

481 
Ët
 
f
 = 
d
.
as_f64
()?;

482 
Ok
(
D©um
::
F64
(
f
))

484 
a
 => 
Ok
(a),

492 
pub
 
â
 
cÛrû
(
Ëá
: 
D©um
, 
right
: D©umè-> 
ResuÉ
<(D©um, 
	gD©um
)> {

493 
Ët
 
	g»s
 = 
m©ch
 (
Ëá
, 
right
) {

494 
	ga
 @ (
	gD©um
::
Dec
(
_
), D©um::Dec(_)è| 
a
 @ (
D©um
::
F64
(_), Datum::F64(_)) =>‡,

495 (
	gl
 @ 
	gD©um
::
F64
(
_
), 
	gr
è=> (
l
,„.
cÛrû_to_f64
()?),

496 (
	gl
, 
	gr
 @ 
	gD©um
::
F64
(
_
)è=> (
l
.
cÛrû_to_f64
()?,„),

497 (
	gl
 @ 
	gD©um
::
Dec
(
_
), 
	gr
è=> (
l
,„.
cÛrû_to_dec
()?),

498 (
	gl
, 
	gr
 @ 
	gD©um
::
Dec
(
_
)è=> (
l
.
cÛrû_to_dec
()?,„),

499 
	gp
 => 
p
,

501 
Ok
(
»s
)

504 
pub
 
â
 
checked_div
(
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
d
: 
D©um
è-> 
ResuÉ
<Datum> {

505 
m©ch
 (
£lf
, 
d
) {

506 (
	gD©um
::
F64
(
f
), 
	gd
) => {

507 
Ët
 
f2
 = 
d
.
što_f64
(
ùx
)?;

508 
	gf2
 == 0f64 {

509  
Ok
(
D©um
::
NuÎ
);

511 
Ok
(
D©um
::
F64
(
f
 / 
f2
))

513 (
a
, 
	gb
) => {

514 
Ët
 
a
 =‡.
što_dec
()?;

515 
Ët
 
	gb
 = 
b
.
što_dec
()?;

516 
m©ch
 
	ga
 / 
	gb
 {

517 
	gNÚe
 => 
Ok
(
D©um
::
NuÎ
),

518 
Some
(
»s
) => {

519 
Ët
 
d
 = 
»s
.
što_»suÉ
()?;

520 
Ok
(
D©um
::
Dec
(
d
))

528 
pub
 
â
 
checked_add
(
£lf
, 
_
: &
Ev®CÚ‹xt
, 
d
: 
D©um
è-> 
ResuÉ
<Datum> {

529 
Ët
 
»s
: 
D©um
 = 
m©ch
 (&
£lf
, &
d
) {

530 (&
	gD©um
::
I64
(
l
), &D©um::I64(
r
)è=>†.
checked_add
Ô).
što
(),

531 (&
	gD©um
::
I64
(
l
), &D©um::
U64
(
r
)è| (&
D©um
::U64(r), &Datum::I64(l)) => {

532 
checked_add_i64
(
r
, 
l
).
što
()

534 (&
D©um
::
U64
(
l
), &
	gD©um
::U64(
r
)è=>†.
checked_add
Ô).
što
(),

535 (&
	gD©um
::
F64
(
l
), &D©um::F64(
r
)) => {

536 
Ët
 
»s
 = 
l
 + 
r
;

537 !
	g»s
.
is_fš™e
() {

538 
	gD©um
::
NuÎ


540 
D©um
::
F64
(
»s
)

543 (&
D©um
::
Dec
(
»f
 
l
), &
	gD©um
::DecÔeà
r
)) => {

544 
Ët
 
dec
 = (
l
 + 
r
).
što_»suÉ
()?;

545  
Ok
(
D©um
::
Dec
(
dec
));

547 (
	gl
, 
	gr
è=>  
E¼
(
šv®id_ty³
!("{:?}‡nd {:?} cª'ˆbaddog‘h”.", 
l
, 
r
)),

549 
Ët
 
	gD©um
::
NuÎ
 = 
»s
 {

550  
E¼
(
box_”r
!("{:?} + {:?} ov”æow", 
£lf
, 
d
));

552 
Ok
(
»s
)

556 
pub
 
â
 
checked_mšus
(
£lf
, 
_
: &
Ev®CÚ‹xt
, 
d
: 
D©um
è-> 
ResuÉ
<Datum> {

557 
Ët
 
»s
 = 
m©ch
 (&
£lf
, &
d
) {

558 (&
	gD©um
::
I64
(
l
), &D©um::I64(
r
)è=>†.
checked_sub
Ô).
što
(),

559 (&
	gD©um
::
I64
(
l
), &D©um::
U64
(
r
)) => l < 0 {

560 
D©um
::
NuÎ


562 (
l
 
as
 
u64
).
checked_sub
(
r
).
što
()

564 (&
	gD©um
::
U64
(
l
), &D©um::
I64
(
r
)) => r < 0 {

565 
l
.
checked_add
(
r
.
ov”æowšg_Ãg
().0 
as
 
u64
).
što
()

567 
l
.
checked_sub
(
r
 
as
 
u64
).
što
()

569 (&
	gD©um
::
U64
(
l
), &D©um::U64(
r
)è=>†.
checked_sub
Ô).
što
(),

570 (&
	gD©um
::
F64
(
l
), &D©um::F64(
r
)è=>  
Ok
(
D©um
::F64(l -„)),

571 (&
	gD©um
::
Dec
(
»f
 
l
), &D©um::DecÔeà
r
)) => {

572 
Ët
 
dec
 = (
l
 - 
r
).
što_»suÉ
()?;

573  
Ok
(
D©um
::
Dec
(
dec
));

575 (
	gl
, 
	gr
è=>  
E¼
(
šv®id_ty³
!("{:?} cª'ˆmšu {:?}", 
l
, 
r
)),

577 
Ët
 
	gD©um
::
NuÎ
 = 
»s
 {

578  
E¼
(
box_”r
!("{:?} - {:?} ov”æow", 
£lf
, 
d
));

580 
Ok
(
»s
)

584 
pub
 
â
 
checked_mul
(
£lf
, 
_
: &
Ev®CÚ‹xt
, 
d
: 
D©um
è-> 
ResuÉ
<Datum> {

585 
Ët
 
»s
 = 
m©ch
 (&
£lf
, &
d
) {

586 (&
	gD©um
::
I64
(
l
), &D©um::I64(
r
)è=>†.
checked_mul
Ô).
što
(),

587 (&
	gD©um
::
I64
(
l
), &D©um::
U64
(
r
)è| (&
D©um
::U64(r), &Datum::I64(l)) => {

588 
l
 < 0 {

589  
E¼
(
box_”r
!("{} * {} ov”æow.", 
l
, 
r
));

591 
	gr
.
checked_mul
(
l
 
as
 
u64
).
što
()

593 (&
	gD©um
::
U64
(
l
), &D©um::U64(
r
)è=>†.
checked_mul
Ô).
što
(),

594 (&
	gD©um
::
F64
(
l
), &D©um::F64(
r
)è=>  
Ok
(
D©um
::F64(l *„)),

595 (&
	gD©um
::
Dec
(
»f
 
l
), &D©um::DecÔeà
r
)è=>  
Ok
(
D©um
::Dec(Ö *„).
unw¿p
())),

596 (
	gl
, 
	gr
è=>  
E¼
(
šv®id_ty³
!("{:?} cª'ˆmuÉly {:?}", 
l
, 
r
)),

599 
Ët
 
	gD©um
::
NuÎ
 = 
»s
 {

600  
E¼
(
box_”r
!("{} * {} ov”æow", 
£lf
, 
d
));

602 
Ok
(
»s
)

606 
pub
 
â
 
checked_»m
(
£lf
, 
_
: &
Ev®CÚ‹xt
, 
d
: 
D©um
è-> 
ResuÉ
<Datum> {

607 
m©ch
 
d
 {

608 
D©um
::
I64
(0è| D©um::
U64
(0è=>  
Ok
(D©um::
NuÎ
),

609 
	gD©um
::
F64
(
f
èà=ğ0f64 =>  
Ok
(
D©um
::
NuÎ
),

610 
	g_
 => {}

612 
m©ch
 (
£lf
, 
d
) {

613 (
	gD©um
::
I64
(
l
), D©um::I64(
r
)è=> 
Ok
(
D©um
::I64(l %„)),

614 (
	gD©um
::
I64
(
l
), D©um::
U64
(
r
)) => l < 0 {

615 
Ok
(
D©um
::
I64
(-((
l
.
ov”æowšg_Ãg
().0 
as
 
u64
 % 
r
èa 
i64
)))

617 
Ok
(
D©um
::
I64
((
l
 
as
 
u64
 % 
r
èa 
i64
))

619 (
	gD©um
::
U64
(
l
), D©um::
I64
(
r
)è=> 
Ok
(
D©um
::U64Ö %„.
ov”æowšg_abs
().0 
as
 
u64
)),

620 (
	gD©um
::
U64
(
l
), D©um::U64(
r
)è=> 
Ok
(
D©um
::U64(l %„)),

621 (
	gD©um
::
F64
(
l
), D©um::F64(
r
)è=> 
Ok
(
D©um
::F64(l %„)),

622 (
	gD©um
::
Dec
(
l
), D©um::Dec(
r
)è=> 
m©ch
† %„ {

623 
NÚe
 => 
Ok
(
D©um
::
NuÎ
),

624 
Some
(
»s
) => {

625 
Ët
 
d
 = 
»s
.
što_»suÉ
()?;

626 
Ok
(
D©um
::
Dec
(
d
))

629 (
	gl
, 
	gr
è=> 
E¼
(
šv®id_ty³
!("{:?} cª'ˆmod {:?}", 
l
, 
r
)),

634 
pub
 
â
 
checked_št_div
(
£lf
, 
_
: &
Ev®CÚ‹xt
, 
d
: 
D©um
è-> 
ResuÉ
<Datum> {

635 
m©ch
 
d
 {

636 
D©um
::
I64
(0è| D©um::
U64
(0è=>  
Ok
(D©um::
NuÎ
),

637 
	g_
 => {}

639 
m©ch
 (
£lf
, 
d
) {

640 (
	gD©um
::
I64
(
l
), D©um::I64(
r
)è=> 
m©ch
†.
checked_div
(r) {

641 
NÚe
 => 
E¼
(
box_”r
!("{} iÁdiv {} ov”æow", 
l
, 
r
)),

642 
Some
(
»s
è=> 
Ok
(
D©um
::
I64
(res)),

644 (
	gD©um
::
I64
(
l
), D©um::
U64
(
r
)) => l < 0 {

645 
l
.
ov”æowšg_Ãg
().0 
as
 
u64
 >ğ
r
 {

646 
E¼
(
box_”r
!("{} iÁdiv {} ov”æow", 
l
, 
r
))

648 
Ok
(
D©um
::
U64
(0))

651 
Ok
(
D©um
::
U64
(
l
 
as
 
u64
 / 
r
))

653 (
	gD©um
::
U64
(
l
), D©um::
I64
(
r
)) => r < 0 {

654 
l
 !ğ0 && 
r
.
ov”æowšg_Ãg
().0 
as
 
u64
 <=† {

655 
E¼
(
box_”r
!("{} iÁdiv {} ov”æow", 
l
, 
r
))

657 
Ok
(
D©um
::
U64
(0))

660 
Ok
(
D©um
::
U64
(
l
 / 
r
 
as
 
u64
))

662 (
	gD©um
::
U64
(
l
), D©um::U64(
r
)è=> 
Ok
(
D©um
::U64(l /„)),

663 (
	gl
, 
	gr
) => {

664 
Ët
 
a
 = 
l
.
što_dec
()?;

665 
Ët
 
	gb
 = 
r
.
što_dec
()?;

666 
m©ch
 
	ga
 / 
	gb
 {

667 
	gNÚe
 => 
Ok
(
D©um
::
NuÎ
),

668 
Some
(
»s
) => {

669 
Ët
 
i
 = 
»s
.
unw¿p
().
as_i64
().unwrap();

670 
Ok
(
D©um
::
I64
(
i
))

678 
im¶
 
From
<
boŞ
> 
D©um
 {

679 
â
 
äom
(
b
: 
boŞ
è-> 
D©um
 {

680 
b
 {

681 
D©um
::
I64
(1)

683 
D©um
::
I64
(0)

688 
im¶
<
T
: 
IÁo
<
D©um
>> 
From
<
O±iÚ
<T>> Datum {

689 
â
 
äom
(
İt
: 
O±iÚ
<
T
>è-> 
D©um
 {

690 
m©ch
 
İt
 {

691 
NÚe
 => 
D©um
::
NuÎ
,

692 
Some
(
t
è=>.
što
(),

697 
	gim¶
<'a, T: ClÚ+ IÁo<D©um>> From<Cow<'
	ga
, 
	gT
>> 
	gD©um
 {

698 
â
 
äom
(
c
: 
Cow
<'a, T>) -> Datum {

699 
c
.
što_owÃd
().
što
()

703 
im¶
 
From
<
Vec
<
u8
>> 
D©um
 {

704 
â
 
äom
(
d©a
: 
Vec
<
u8
>è-> 
D©um
 {

705 
D©um
::
By‹s
(
d©a
)

709 
im¶
<'a> From<&'
a
 [
u8
]> 
D©um
 {

710 
â
 
äom
(
d©a
: &'a [u8]) -> Datum {

711 
d©a
.
to_vec
().
što
()

715 
im¶
<'a> From<Cow<'
a
, [
u8
]>> 
D©um
 {

716 
â
 
äom
(
d©a
: 
Cow
<[
u8
]>è-> 
D©um
 {

717 
d©a
.
što_owÃd
().
što
()

721 
im¶
 
From
<
Du¿tiÚ
> 
D©um
 {

722 
â
 
äom
(
dur
: 
Du¿tiÚ
è-> 
D©um
 {

723 
D©um
::
Dur
(
dur
)

727 
im¶
 
From
<
i64
> 
D©um
 {

728 
â
 
äom
(
d©a
: 
i64
è-> 
D©um
 {

729 
D©um
::
I64
(
d©a
)

733 
im¶
 
From
<
u64
> 
D©um
 {

734 
â
 
äom
(
d©a
: 
u64
è-> 
D©um
 {

735 
D©um
::
U64
(
d©a
)

739 
im¶
 
From
<
Decim®
> 
D©um
 {

740 
â
 
äom
(
d©a
: 
Decim®
è-> 
D©um
 {

741 
D©um
::
Dec
(
d©a
)

745 
im¶
 
From
<
Time
> 
D©um
 {

746 
â
 
äom
(
t
: 
Time
è-> 
D©um
 {

747 
D©um
::
Time
(
t
)

751 
im¶
 
From
<
f64
> 
D©um
 {

752 
â
 
äom
(
d©a
: 
f64
è-> 
D©um
 {

753 
D©um
::
F64
(
d©a
)

757 
im¶
 
From
<
JsÚ
> 
D©um
 {

758 
â
 
äom
(
d©a
: 
JsÚ
è-> 
D©um
 {

759 
D©um
::
JsÚ
(
d©a
)

763 
pub
 
Œa™
 
D©umDecod”
: 
Decim®Decod”
 + 
JsÚDecod”
 {

765 
â
 
decode_d©um
(&
mut
 
£lf
è-> 
ResuÉ
<
D©um
> {

766 
Ët
 
æag
 = 
£lf
.
»ad_u8
()?;

767 
m©ch
 
æag
 {

768 
INT_FLAG
 => 
£lf
.
decode_i64
().
m­
(
D©um
::
I64
),

769 
UINT_FLAG
 => 
£lf
.
decode_u64
().
m­
(
D©um
::
U64
),

770 
BYTES_FLAG
 => 
£lf
.
decode_by‹s
(
çl£
).
m­
(
D©um
::
By‹s
),

771 
COMPACT_BYTES_FLAG
 => 
£lf
.
decode_com·ù_by‹s
().
m­
(
D©um
::
By‹s
),

772 
NIL_FLAG
 => 
Ok
(
D©um
::
NuÎ
),

773 
FLOAT_FLAG
 => 
£lf
.
decode_f64
().
m­
(
D©um
::
F64
),

774 
DURATION_FLAG
 => {

775 
Ët
 
Çnos
 = 
£lf
.
decode_i64
()?;

776 
Ët
 
dur
 = 
Du¿tiÚ
::
äom_Çnos
(
Çnos
, 
MAX_FSP
)?;

777 
Ok
(
D©um
::
Dur
(
dur
))

779 
DECIMAL_FLAG
 => 
£lf
.
decode_decim®
().
m­
(
D©um
::
Dec
),

780 
VAR_INT_FLAG
 => 
£lf
.
decode_v¬_i64
().
m­
(
D©um
::
I64
),

781 
VAR_UINT_FLAG
 => 
£lf
.
decode_v¬_u64
().
m­
(
D©um
::
U64
),

782 
JSON_FLAG
 => 
£lf
.
decode_jsÚ
().
m­
(
D©um
::
JsÚ
),

783 
f
 => 
E¼
(
šv®id_ty³
!("unsupported dataype `{}`", f)),

788 
â
 
decode
(&
mut
 
£lf
è-> 
ResuÉ
<
Vec
<
D©um
>> {

789 
Ët
 
mut
 
»s
 = 
vec
![];

791 
£lf
.
»maššg
() > 0 {

792 
Ët
 
v
 = 
£lf
.
decode_d©um
()?;

793 
»s
.
push
(
v
);

796 
Ok
(
»s
)

800 
im¶
<
T
: 
Decim®Decod”
> 
D©umDecod”
 T {}

802 
pub
 
Œa™
 
D©umEncod”
: 
By‹sEncod”
 + 
Decim®Encod”
 + 
JsÚEncod”
 {

804 
â
 
’code
(&
mut
 
£lf
, 
v®ues
: &[
D©um
], 
com·¿bË
: 
boŞ
è-> 
ResuÉ
<()> {

805 
Ët
 
mut
 
fšd_mš
 = 
çl£
;

806 
v
 
š
 
v®ues
 {

807 
fšd_mš
 {

808  
E¼
(
šv®id_ty³
!(

809 "MšV®ushould bthÏ¡ d©um.".
to_owÃd
()

812 
m©ch
 *
v
 {

813 
D©um
::
I64
(
i
è=> 
com·¿bË
 {

814 
£lf
.
wr™e_u8
(
INT_FLAG
)?;

815 
£lf
.
’code_i64
(
i
)?;

817 
£lf
.
wr™e_u8
(
VAR_INT_FLAG
)?;

818 
£lf
.
’code_v¬_i64
(
i
)?;

820 
D©um
::
U64
(
u
è=> 
com·¿bË
 {

821 
£lf
.
wr™e_u8
(
UINT_FLAG
)?;

822 
£lf
.
’code_u64
(
u
)?;

824 
£lf
.
wr™e_u8
(
VAR_UINT_FLAG
)?;

825 
£lf
.
’code_v¬_u64
(
u
)?;

827 
D©um
::
By‹s
(
»f
 
bs
è=> 
com·¿bË
 {

828 
£lf
.
wr™e_u8
(
BYTES_FLAG
)?;

829 
£lf
.
’code_by‹s
(
bs
, 
çl£
)?;

831 
£lf
.
wr™e_u8
(
COMPACT_BYTES_FLAG
)?;

832 
£lf
.
’code_com·ù_by‹s
(
bs
)?;

834 
D©um
::
F64
(
f
) => {

835 
£lf
.
wr™e_u8
(
FLOAT_FLAG
)?;

836 
£lf
.
’code_f64
(
f
)?;

838 
D©um
::
NuÎ
 => 
£lf
.
wr™e_u8
(
NIL_FLAG
)?,

839 
D©um
::
Mš
 => {

840 
£lf
.
wr™e_u8
(
BYTES_FLAG
)?;

841 
fšd_mš
 = 
Œue
;

843 
D©um
::
Max
 => 
£lf
.
wr™e_u8
(
MAX_FLAG
)?,

844 
D©um
::
Time
(
»f
 
t
) => {

845 
£lf
.
wr™e_u8
(
UINT_FLAG
)?;

846 
£lf
.
’code_u64
(
t
.
to_·cked_u64
())?;

848 
D©um
::
Dur
(
»f
 
d
) => {

849 
£lf
.
wr™e_u8
(
DURATION_FLAG
)?;

850 
£lf
.
’code_i64
(
d
.
to_Çnos
())?;

852 
D©um
::
Dec
(
»f
 
d
) => {

853 
£lf
.
wr™e_u8
(
DECIMAL_FLAG
)?;

854 
Ët
 (
´ec
, 
äac
èğ
d
.
´ec_ªd_äac
();

855 
£lf
.
’code_decim®
(
d
, 
´ec
, 
äac
)?;

857 
D©um
::
JsÚ
(
»f
 
j
) => {

858 
£lf
.
wr™e_u8
(
JSON_FLAG
)?;

859 
£lf
.
’code_jsÚ
(
j
)?;

863 
Ok
(())

867 
im¶
<
T
: 
Wr™e
> 
D©umEncod”
 T {}

872 #[
®low
(
m©ch_§me_¬ms
)]

873 
pub
 
â
 
­´oxim©e_size
(
v®ues
: &[
D©um
], 
com·¿bË
: 
boŞ
è-> 
usize
 {

874 
v®ues


875 .
™”
()

876 .
m­
(|
v
| {

877 1 + 
m©ch
 *
v
 {

878 
D©um
::
I64
(
_
è=> 
com·¿bË
 {

879 
numb”
::
I64_SIZE


881 
numb”
::
MAX_VAR_I64_LEN


883 
D©um
::
U64
(
_
è=> 
com·¿bË
 {

884 
numb”
::
U64_SIZE


886 
numb”
::
MAX_VAR_U64_LEN


888 
D©um
::
F64
(
_
è=> 
numb”
::
F64_SIZE
,

889 
D©um
::
Time
(
_
è=> 
numb”
::
U64_SIZE
,

890 
D©um
::
Dur
(
_
è=> 
numb”
::
I64_SIZE
,

891 
D©um
::
By‹s
(
»f
 
bs
è=> 
com·¿bË
 {

892 
by‹s
::
max_’coded_by‹s_size
(
bs
.
Ën
())

894 
bs
.
Ën
(è+ 
numb”
::
MAX_VAR_I64_LEN


896 
D©um
::
Dec
(
»f
 
d
è=> d.
­´oxim©e_’coded_size
(),

897 
D©um
::
JsÚ
(
»f
 
d
è=> d.
bš¬y_Ën
(),

898 
D©um
::
NuÎ
 | D©um::
Mš
 | D©um::
Max
 => 0,

901 .
sum
()

904 
pub
 
â
 
’code
(
v®ues
: &[
D©um
], 
com·¿bË
: 
boŞ
è-> 
ResuÉ
<
Vec
<
u8
>> {

905 
Ët
 
mut
 
buf
 = 
vec
![];

906 
’code_to
(&
mut
 
buf
, 
v®ues
, 
com·¿bË
)?;

907 
buf
.
shršk_to_f™
();

908 
Ok
(
buf
)

911 
pub
 
â
 
’code_key
(
v®ues
: &[
D©um
]è-> 
ResuÉ
<
Vec
<
u8
>> {

912 
’code
(
v®ues
, 
Œue
)

915 
pub
 
â
 
’code_v®ue
(
v®ues
: &[
D©um
]è-> 
ResuÉ
<
Vec
<
u8
>> {

916 
’code
(
v®ues
, 
çl£
)

919 
pub
 
â
 
’code_to
(
buf
: &
mut
 
Vec
<
u8
>, 
v®ues
: &[
D©um
], 
com·¿bË
: 
boŞ
è-> 
ResuÉ
<()> {

920 
buf
.
»£rve
(
­´oxim©e_size
(
v®ues
, 
com·¿bË
));

921 
buf
.
’code
(
v®ues
, 
com·¿bË
)?;

922 
Ok
(())

927 #[
®low
(
m©ch_§me_¬ms
)]

928 
pub
 
â
 
¥l™_d©um
(
buf
: &[
u8
], 
desc
: 
boŞ
è-> 
ResuÉ
<(&[u8], &[u8])> {

929 
buf
.
is_em±y
() {

930  
E¼
(
box_”r
!("{} i toØshÜt", 
esÿ³
(
buf
)));

932 
Ët
 
pos
 = 
m©ch
 
buf
[0] {

933 
INT_FLAG
 => 
numb”
::
I64_SIZE
,

934 
UINT_FLAG
 => 
numb”
::
U64_SIZE
,

935 
BYTES_FLAG
 => 
by‹s
::
’coded_by‹s_Ën
(&
buf
[1..], 
desc
),

936 
COMPACT_BYTES_FLAG
 => 
by‹s
::
’coded_com·ù_Ën
(&
buf
[1..]),

937 
NIL_FLAG
 => 0,

938 
FLOAT_FLAG
 => 
numb”
::
F64_SIZE
,

939 
DURATION_FLAG
 => 
numb”
::
I64_SIZE
,

940 
DECIMAL_FLAG
 => 
mysql
::
dec_’coded_Ën
(&
buf
[1..])?,

941 
VAR_INT_FLAG
 => {

942 
Ët
 
mut
 
v
 = &
buf
[1..];

943 
Ët
 
l
 = 
v
.
Ën
();

944 
v
.
decode_v¬_i64
()?;

945 
l
 - 
v
.
Ën
()

947 
VAR_UINT_FLAG
 => {

948 
Ët
 
mut
 
v
 = &
buf
[1..];

949 
Ët
 
l
 = 
v
.
Ën
();

950 
v
.
decode_v¬_u64
()?;

951 
l
 - 
v
.
Ën
()

953 
JSON_FLAG
 => {

954 
Ët
 
mut
 
v
 = &
buf
[1..];

955 
Ët
 
l
 = 
v
.
Ën
();

956 
v
.
decode_jsÚ
()?;

957 
l
 - 
v
.
Ën
()

959 
f
 =>  
E¼
(
šv®id_ty³
!("unsupported dataype `{}`", f)),

961 
buf
.
Ën
(è< 
pos
 + 1 {

962  
E¼
(
box_”r
!("{} i toØshÜt", 
esÿ³
(
buf
)));

964 
Ok
(
buf
.
¥l™_©
(1 + 
pos
))

967 #[
cfg
(
‹¡
)]

968 
mod
 
‹¡
 {

969 
u£
 
su³r
::*;

970 
u£
 
cİroûssÜ
::
codec
::
mysql
::{
Decim®
, 
Du¿tiÚ
, 
Time
, 
MAX_FSP
};

971 
u£
 
ut
::
as_¦iû
;

973 
u£
 
¡d
::
cmp
::
Ord”šg
;

974 
u£
 
¡d
::
time
::
Du¿tiÚ
 
as
 
StdDu¿tiÚ
;

975 
u£
 
¡d
::{
i16
, 
i32
, 
i64
, 
i8
, 
u16
, 
u32
, 
u64
, 
u8
};

977 
â
 
§me_ty³
(
l
: &
D©um
, 
r
: &D©umè-> 
boŞ
 {

978 
m©ch
 (
l
, 
r
) {

979 (&
D©um
::
I64
(
_
), &Datum::I64(_)) |

980 (&
D©um
::
U64
(
_
), &Datum::U64(_)) |

981 (&
D©um
::
F64
(
_
), &Datum::F64(_)) |

982 (&
D©um
::
Max
, &Datum::Max) |

983 (&
D©um
::
Mš
, &Datum::Min) |

984 (&
D©um
::
By‹s
(
_
), &Datum::Bytes(_)) |

985 (&
D©um
::
Dur
(
_
), &Datum::Dur(_)) |

986 (&
D©um
::
NuÎ
, &Datum::Null) |

987 (&
D©um
::
Time
(
_
), &Datum::Time(_)) |

988 (&
D©um
::
JsÚ
(
_
), &D©um::JsÚ(_)è=> 
Œue
,

989 (&
D©um
::
Dec
(
»f
 
d1
), &D©um::DecÔeà
d2
)è=> d1.
´ec_ªd_äac
() == d2.prec_and_frac(),

990 
_
 => 
çl£
,

994 #[
‹¡
]

995 
â
 
‹¡_d©um_codec
() {

996 
Ët
 
bË
 = 
vec
![

997 
vec
![
D©um
::
I64
(1)],

998 
vec
![
D©um
::
F64
(1.0), D©um::F64(3.15), 
b
"123".
as_»f
().
što
()],

999 
vec
![

1000 
D©um
::
U64
(1),

1001 
D©um
::
F64
(3.15),

1002 
b
"123".
as_»f
().
što
(),

1003 
D©um
::
I64
(-1),

1005 
vec
![
D©um
::
NuÎ
],

1006 
vec
![

1007 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(23), 
çl£
, 
MAX_FSP
)

1008 .
unw¿p
()

1009 .
što
(),

1010 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(23), 
Œue
, 
MAX_FSP
)

1011 .
unw¿p
()

1012 .
što
(),

1014 
vec
![

1015 
D©um
::
U64
(1),

1016 
D©um
::
Dec
(
Decim®
::
äom_f64
(2.3).
unw¿p
()),

1017 
D©um
::
Dec
("-34".
·r£
().
unw¿p
()),

1019 
vec
![

1020 
D©um
::
Dec
("1234.00".
·r£
().
unw¿p
()),

1021 
D©um
::
Dec
("1234".
·r£
().
unw¿p
()),

1022 
D©um
::
Dec
("12.34".
·r£
().
unw¿p
()),

1023 
D©um
::
Dec
("12.340".
·r£
().
unw¿p
()),

1024 
D©um
::
Dec
("0.1234".
·r£
().
unw¿p
()),

1025 
D©um
::
Dec
("0.0".
·r£
().
unw¿p
()),

1026 
D©um
::
Dec
("0".
·r£
().
unw¿p
()),

1027 
D©um
::
Dec
("-0.0".
·r£
().
unw¿p
()),

1028 
D©um
::
Dec
("-0.0000".
·r£
().
unw¿p
()),

1029 
D©um
::
Dec
("-1234.00".
·r£
().
unw¿p
()),

1030 
D©um
::
Dec
("-1234".
·r£
().
unw¿p
()),

1031 
D©um
::
Dec
("-12.34".
·r£
().
unw¿p
()),

1032 
D©um
::
Dec
("-12.340".
·r£
().
unw¿p
()),

1033 
D©um
::
Dec
("-0.1234".
·r£
().
unw¿p
()),

1035 
vec
![

1036 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"{"key":"value"}"#).unwrap()),

1037 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"["d1","d2"]"#).unwrap()),

1038 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"3"#).unwrap()),

1039 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"3.0"#).unwrap()),

1040 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"
nuÎ
"#).unwrap()),

1041 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"
Œue
"#).unwrap()),

1042 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"
çl£
"#).unwrap()),

1043 
D©um
::
JsÚ
(

1044 
JsÚ
::
äom_¡r
(

1045 
r
#"[

1048 "b": 
Œue


1053 
nuÎ
,

1054 
Œue
]"#,

1055 ).
unw¿p
(),

1059 
vs
 
š
 
bË
 {

1060 
Ët
 
mut
 
buf
 = 
’code_key
(&
vs
).
unw¿p
();

1061 
Ët
 
decoded
 = 
buf
.
as_¦iû
().
decode
().
unw¿p
();

1062 
as£¹_eq
!(
vs
, 
decoded
);

1064 
buf
 = 
’code_v®ue
(&
vs
).
unw¿p
();

1065 
Ët
 
decoded
 = 
buf
.
as_¦iû
().
decode
().
unw¿p
();

1066 
as£¹_eq
!(
vs
, 
decoded
);

1070 #[
‹¡
]

1071 
â
 
‹¡_d©um_cmp
() {

1072 
Ët
 
‹¡s
 = 
vec
![

1073 (
D©um
::
F64
(-1.0), D©um::
Mš
, 
Ord”šg
::
G»©”
),

1074 (
D©um
::
F64
(1.0), D©um::
Max
, 
Ord”šg
::
Less
),

1075 (
D©um
::
F64
(1.0), D©um::F64(1.0), 
Ord”šg
::
Equ®
),

1076 (
D©um
::
F64
(1.0), 
b
"1".
as_»f
().
što
(), 
Ord”šg
::
Equ®
),

1077 (
D©um
::
I64
(1), D©um::I64(1), 
Ord”šg
::
Equ®
),

1078 (
D©um
::
I64
(-1), D©um::I64(1), 
Ord”šg
::
Less
),

1079 (
D©um
::
I64
(-1), 
b
"-1".
as_»f
().
što
(), 
Ord”šg
::
Equ®
),

1080 (
D©um
::
U64
(1), D©um::U64(1), 
Ord”šg
::
Equ®
),

1081 (
D©um
::
U64
(1), D©um::
I64
(-1), 
Ord”šg
::
G»©”
),

1082 (
D©um
::
U64
(1), 
b
"1".
as_»f
().
što
(), 
Ord”šg
::
Equ®
),

1084 
D©um
::
Dec
(1
i64
.
što
()),

1085 
D©um
::
Dec
(1
i64
.
što
()),

1086 
Ord”šg
::
Equ®
,

1089 
D©um
::
Dec
(1
i64
.
što
()),

1090 
b
"2".
as_»f
().
što
(),

1091 
Ord”šg
::
Less
,

1094 
D©um
::
Dec
(1
i64
.
što
()),

1095 
b
"0.2".
as_»f
().
što
(),

1096 
Ord”šg
::
G»©”
,

1099 
D©um
::
Dec
(1
i64
.
što
()),

1100 
b
"1".
as_»f
().
što
(),

1101 
Ord”šg
::
Equ®
,

1103 (
b
"1".
as_»f
().
što
(), b"1".as_»f().što(), 
Ord”šg
::
Equ®
),

1104 (
b
"1".
as_»f
().
što
(), 
D©um
::
I64
(-1), 
Ord”šg
::
G»©”
),

1105 (
b
"1".
as_»f
().
što
(), 
D©um
::
U64
(1), 
Ord”šg
::
Equ®
),

1107 
b
"1".
as_»f
().
što
(),

1108 
D©um
::
Dec
(1
i64
.
što
()),

1109 
Ord”šg
::
Equ®
,

1111 (
D©um
::
NuÎ
, D©um::
I64
(2), 
Ord”šg
::
Less
),

1112 (
D©um
::
NuÎ
, D©um::NuÎ, 
Ord”šg
::
Equ®
),

1114 (
çl£
.
što
(), 
D©um
::
NuÎ
, 
Ord”šg
::
G»©”
),

1115 (
çl£
.
što
(), 
Œue
.što(), 
Ord”šg
::
Less
),

1116 (
Œue
.
što
(),rue.što(), 
Ord”šg
::
Equ®
),

1117 (
çl£
.
što
(), f®£.što(), 
Ord”šg
::
Equ®
),

1118 (
Œue
.
što
(), 
D©um
::
I64
(2), 
Ord”šg
::
Less
),

1120 (
D©um
::
F64
(1.23), D©um::
NuÎ
, 
Ord”šg
::
G»©”
),

1121 (
D©um
::
F64
(0.0), D©um::F64(3.45), 
Ord”šg
::
Less
),

1122 (
D©um
::
F64
(354.23), D©um::F64(3.45), 
Ord”šg
::
G»©”
),

1123 (
D©um
::
F64
(3.452), D©um::F64(3.452), 
Ord”šg
::
Equ®
),

1125 (
D©um
::
I64
(432), D©um::
NuÎ
, 
Ord”šg
::
G»©”
),

1126 (
D©um
::
I64
(-4), D©um::I64(32), 
Ord”šg
::
Less
),

1127 (
D©um
::
I64
(4), D©um::I64(-32), 
Ord”šg
::
G»©”
),

1128 (
D©um
::
I64
(432), D©um::I64(12), 
Ord”šg
::
G»©”
),

1129 (
D©um
::
I64
(23), D©um::I64(128), 
Ord”šg
::
Less
),

1130 (
D©um
::
I64
(123), D©um::I64(123), 
Ord”šg
::
Equ®
),

1131 (
D©um
::
I64
(23), D©um::I64(123), 
Ord”šg
::
Less
),

1132 (
D©um
::
I64
(133), D©um::I64(183), 
Ord”šg
::
Less
),

1134 (
D©um
::
U64
(123), D©um::U64(183), 
Ord”šg
::
Less
),

1135 (
D©um
::
U64
(2), D©um::
I64
(-2), 
Ord”šg
::
G»©”
),

1136 (
D©um
::
U64
(2), D©um::
I64
(1), 
Ord”šg
::
G»©”
),

1138 (
b
"".
as_»f
().
što
(), 
D©um
::
NuÎ
, 
Ord”šg
::
G»©”
),

1139 (
b
"".
as_»f
().
što
(), b"24".as_»f().što(), 
Ord”šg
::
Less
),

1141 
b
"¯sf".
as_»f
().
što
(),

1142 
b
"4".
as_»f
().
što
(),

1143 
Ord”šg
::
G»©”
,

1145 (
b
"".
as_»f
().
što
(), b"".as_»f().što(), 
Ord”šg
::
Equ®
),

1148 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(34), 
çl£
, 2)

1149 .
unw¿p
()

1150 .
što
(),

1151 
D©um
::
NuÎ
,

1152 
Ord”šg
::
G»©”
,

1155 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(3340), 
çl£
, 2)

1156 .
unw¿p
()

1157 .
što
(),

1158 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(29034), 
çl£
, 2)

1159 .
unw¿p
()

1160 .
što
(),

1161 
Ord”šg
::
Less
,

1164 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(3340), 
çl£
, 2)

1165 .
unw¿p
()

1166 .
što
(),

1167 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(34), 
çl£
, 2)

1168 .
unw¿p
()

1169 .
što
(),

1170 
Ord”šg
::
G»©”
,

1173 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(34), 
çl£
, 2)

1174 .
unw¿p
()

1175 .
što
(),

1176 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(34), 
çl£
, 2)

1177 .
unw¿p
()

1178 .
što
(),

1179 
Ord”šg
::
Equ®
,

1182 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(34), 
Œue
, 2)

1183 .
unw¿p
()

1184 .
što
(),

1185 
D©um
::
NuÎ
,

1186 
Ord”šg
::
G»©”
,

1189 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(0), 
Œue
, 2)

1190 .
unw¿p
()

1191 .
što
(),

1192 
D©um
::
I64
(0),

1193 
Ord”šg
::
Equ®
,

1196 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(3340), 
çl£
, 2)

1197 .
unw¿p
()

1198 .
što
(),

1199 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(29034), 
Œue
, 2)

1200 .
unw¿p
()

1201 .
što
(),

1202 
Ord”šg
::
G»©”
,

1205 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(3340), 
Œue
, 2)

1206 .
unw¿p
()

1207 .
što
(),

1208 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(34), 
çl£
, 2)

1209 .
unw¿p
()

1210 .
što
(),

1211 
Ord”šg
::
Less
,

1214 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(34), 
çl£
, 2)

1215 .
unw¿p
()

1216 .
što
(),

1217 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(34), 
Œue
, 2)

1218 .
unw¿p
()

1219 .
što
(),

1220 
Ord”šg
::
G»©”
,

1223 
Du¿tiÚ
::
Ãw
(
StdDu¿tiÚ
::
äom_mlis
(34), 
Œue
, 2)

1224 .
unw¿p
()

1225 .
što
(),

1226 
b
"-00.34".
as_»f
().
što
(),

1227 
Ord”šg
::
G»©”
,

1231 
Time
::
·r£_utc_d©‘ime
("2011-10-10 00:00:00", 0)

1232 .
unw¿p
()

1233 .
što
(),

1234 
Time
::
·r£_utc_d©‘ime
("2000-12-12 11:11:11", 0)

1235 .
unw¿p
()

1236 .
što
(),

1237 
Ord”šg
::
G»©”
,

1240 
Time
::
·r£_utc_d©‘ime
("2011-10-10 00:00:00", 0)

1241 .
unw¿p
()

1242 .
što
(),

1243 
b
"2000-12-12 11:11:11".
as_»f
().
što
(),

1244 
Ord”šg
::
G»©”
,

1247 
Time
::
·r£_utc_d©‘ime
("2000-10-10 00:00:00", 0)

1248 .
unw¿p
()

1249 .
što
(),

1250 
Time
::
·r£_utc_d©‘ime
("2001-10-10 00:00:00", 0)

1251 .
unw¿p
()

1252 .
što
(),

1253 
Ord”šg
::
Less
,

1256 
Time
::
·r£_utc_d©‘ime
("2000-10-10 00:00:00", 0)

1257 .
unw¿p
()

1258 .
što
(),

1259 
Time
::
·r£_utc_d©‘ime
("2000-10-10 00:00:00", 0)

1260 .
unw¿p
()

1261 .
što
(),

1262 
Ord”šg
::
Equ®
,

1265 
Time
::
·r£_utc_d©‘ime
("2000-10-10 00:00:00", 0)

1266 .
unw¿p
()

1267 .
što
(),

1268 
D©um
::
I64
(20001010000000),

1269 
Ord”šg
::
Equ®
,

1272 
Time
::
·r£_utc_d©‘ime
("2000-10-10 00:00:00", 0)

1273 .
unw¿p
()

1274 .
što
(),

1275 
D©um
::
I64
(0),

1276 
Ord”šg
::
G»©”
,

1279 
D©um
::
I64
(0),

1280 
Time
::
·r£_utc_d©‘ime
("2000-10-10 00:00:00", 0)

1281 .
unw¿p
()

1282 .
što
(),

1283 
Ord”šg
::
Less
,

1287 
D©um
::
Dec
("1234".
·r£
().
unw¿p
()),

1288 
D©um
::
Dec
("123400".
·r£
().
unw¿p
()),

1289 
Ord”šg
::
Less
,

1292 
D©um
::
Dec
("12340".
·r£
().
unw¿p
()),

1293 
D©um
::
Dec
("123400".
·r£
().
unw¿p
()),

1294 
Ord”šg
::
Less
,

1297 
D©um
::
Dec
("1234".
·r£
().
unw¿p
()),

1298 
D©um
::
Dec
("1234.5".
·r£
().
unw¿p
()),

1299 
Ord”šg
::
Less
,

1302 
D©um
::
Dec
("1234".
·r£
().
unw¿p
()),

1303 
D©um
::
Dec
("1234.0000".
·r£
().
unw¿p
()),

1304 
Ord”šg
::
Equ®
,

1307 
D©um
::
Dec
("1234".
·r£
().
unw¿p
()),

1308 
D©um
::
Dec
("12.34".
·r£
().
unw¿p
()),

1309 
Ord”šg
::
G»©”
,

1312 
D©um
::
Dec
("12.34".
·r£
().
unw¿p
()),

1313 
D©um
::
Dec
("12.35".
·r£
().
unw¿p
()),

1314 
Ord”šg
::
Less
,

1317 
D©um
::
Dec
("0.12".
·r£
().
unw¿p
()),

1318 
D©um
::
Dec
("0.1234".
·r£
().
unw¿p
()),

1319 
Ord”šg
::
Less
,

1322 
D©um
::
Dec
("0.1234".
·r£
().
unw¿p
()),

1323 
D©um
::
Dec
("12.3400".
·r£
().
unw¿p
()),

1324 
Ord”šg
::
Less
,

1327 
D©um
::
Dec
("0.1234".
·r£
().
unw¿p
()),

1328 
D©um
::
Dec
("0.1235".
·r£
().
unw¿p
()),

1329 
Ord”šg
::
Less
,

1332 
D©um
::
Dec
("0.123400".
·r£
().
unw¿p
()),

1333 
D©um
::
Dec
("12.34".
·r£
().
unw¿p
()),

1334 
Ord”šg
::
Less
,

1337 
D©um
::
Dec
("12.34000".
·r£
().
unw¿p
()),

1338 
D©um
::
Dec
("12.34".
·r£
().
unw¿p
()),

1339 
Ord”šg
::
Equ®
,

1342 
D©um
::
Dec
("0.01234".
·r£
().
unw¿p
()),

1343 
D©um
::
Dec
("0.01235".
·r£
().
unw¿p
()),

1344 
Ord”šg
::
Less
,

1347 
D©um
::
Dec
("0.1234".
·r£
().
unw¿p
()),

1348 
D©um
::
Dec
("0".
·r£
().
unw¿p
()),

1349 
Ord”šg
::
G»©”
,

1352 
D©um
::
Dec
("0.0000".
·r£
().
unw¿p
()),

1353 
D©um
::
Dec
("0".
·r£
().
unw¿p
()),

1354 
Ord”šg
::
Equ®
,

1357 
D©um
::
Dec
("0.0001".
·r£
().
unw¿p
()),

1358 
D©um
::
Dec
("0".
·r£
().
unw¿p
()),

1359 
Ord”šg
::
G»©”
,

1362 
D©um
::
Dec
("0.0001".
·r£
().
unw¿p
()),

1363 
D©um
::
Dec
("0.0000".
·r£
().
unw¿p
()),

1364 
Ord”šg
::
G»©”
,

1367 
D©um
::
Dec
("0".
·r£
().
unw¿p
()),

1368 
D©um
::
Dec
("-0.0000".
·r£
().
unw¿p
()),

1369 
Ord”šg
::
Equ®
,

1372 
D©um
::
Dec
("-0.0001".
·r£
().
unw¿p
()),

1373 
D©um
::
Dec
("0".
·r£
().
unw¿p
()),

1374 
Ord”šg
::
Less
,

1377 
D©um
::
Dec
("-0.1234".
·r£
().
unw¿p
()),

1378 
D©um
::
Dec
("0".
·r£
().
unw¿p
()),

1379 
Ord”šg
::
Less
,

1382 
D©um
::
Dec
("-0.1234".
·r£
().
unw¿p
()),

1383 
D©um
::
Dec
("-0.12".
·r£
().
unw¿p
()),

1384 
Ord”šg
::
Less
,

1387 
D©um
::
Dec
("-0.12".
·r£
().
unw¿p
()),

1388 
D©um
::
Dec
("-0.1234".
·r£
().
unw¿p
()),

1389 
Ord”šg
::
G»©”
,

1392 
D©um
::
Dec
("-0.12".
·r£
().
unw¿p
()),

1393 
D©um
::
Dec
("-0.1200".
·r£
().
unw¿p
()),

1394 
Ord”šg
::
Equ®
,

1397 
D©um
::
Dec
("-0.1234".
·r£
().
unw¿p
()),

1398 
D©um
::
Dec
("0.1234".
·r£
().
unw¿p
()),

1399 
Ord”šg
::
Less
,

1402 
D©um
::
Dec
("-1.234".
·r£
().
unw¿p
()),

1403 
D©um
::
Dec
("-12.34".
·r£
().
unw¿p
()),

1404 
Ord”šg
::
G»©”
,

1407 
D©um
::
Dec
("-0.1234".
·r£
().
unw¿p
()),

1408 
D©um
::
Dec
("-12.34".
·r£
().
unw¿p
()),

1409 
Ord”šg
::
G»©”
,

1412 
D©um
::
Dec
("-12.34".
·r£
().
unw¿p
()),

1413 
D©um
::
Dec
("1234".
·r£
().
unw¿p
()),

1414 
Ord”šg
::
Less
,

1417 
D©um
::
Dec
("-12.34".
·r£
().
unw¿p
()),

1418 
D©um
::
Dec
("-12.35".
·r£
().
unw¿p
()),

1419 
Ord”šg
::
G»©”
,

1422 
D©um
::
Dec
("-0.01234".
·r£
().
unw¿p
()),

1423 
D©um
::
Dec
("-0.01235".
·r£
().
unw¿p
()),

1424 
Ord”šg
::
G»©”
,

1427 
D©um
::
Dec
("-1234".
·r£
().
unw¿p
()),

1428 
D©um
::
Dec
("-123400".
·r£
().
unw¿p
()),

1429 
Ord”šg
::
G»©”
,

1432 
D©um
::
Dec
("-12340".
·r£
().
unw¿p
()),

1433 
D©um
::
Dec
("-123400".
·r£
().
unw¿p
()),

1434 
Ord”šg
::
G»©”
,

1436 (
D©um
::
Dec
(100.
što
()), D©um::
I64
(1), 
Ord”šg
::
G»©”
),

1437 (
D©um
::
Dec
((-100).
što
()), D©um::
I64
(-1), 
Ord”šg
::
Less
),

1438 (
D©um
::
Dec
((-100).
što
()), D©um::
I64
(-100), 
Ord”šg
::
Equ®
),

1439 (
D©um
::
Dec
(100.
što
()), D©um::
I64
(100), 
Ord”šg
::
Equ®
),

1443 
D©um
::
Dec
((-1
i64
).
što
()),

1444 
D©um
::
Dec
(1
i64
.
što
()),

1445 
Ord”šg
::
Less
,

1448 
D©um
::
Dec
(
i64
::
MAX
.
što
()),

1449 
D©um
::
Dec
(
i64
::
MIN
.
što
()),

1450 
Ord”šg
::
G»©”
,

1453 
D©um
::
Dec
(
i64
::
MAX
.
što
()),

1454 
D©um
::
Dec
(
i32
::
MAX
.
što
()),

1455 
Ord”šg
::
G»©”
,

1458 
D©um
::
Dec
(
i32
::
MIN
.
što
()),

1459 
D©um
::
Dec
(
i16
::
MAX
.
što
()),

1460 
Ord”šg
::
Less
,

1463 
D©um
::
Dec
(
i64
::
MIN
.
što
()),

1464 
D©um
::
Dec
(
i8
::
MAX
.
što
()),

1465 
Ord”šg
::
Less
,

1468 
D©um
::
Dec
(0
i64
.
što
()),

1469 
D©um
::
Dec
(
i8
::
MAX
.
što
()),

1470 
Ord”šg
::
Less
,

1473 
D©um
::
Dec
(
i8
::
MIN
.
što
()),

1474 
D©um
::
Dec
(0
i64
.
što
()),

1475 
Ord”šg
::
Less
,

1478 
D©um
::
Dec
(
i16
::
MIN
.
što
()),

1479 
D©um
::
Dec
(
i16
::
MAX
.
što
()),

1480 
Ord”šg
::
Less
,

1483 
D©um
::
Dec
(1
i64
.
što
()),

1484 
D©um
::
Dec
((-1
i64
).
što
()),

1485 
Ord”šg
::
G»©”
,

1488 
D©um
::
Dec
(1
i64
.
što
()),

1489 
D©um
::
Dec
(0
i64
.
što
()),

1490 
Ord”šg
::
G»©”
,

1493 
D©um
::
Dec
((-1
i64
).
što
()),

1494 
D©um
::
Dec
(0
i64
.
što
()),

1495 
Ord”šg
::
Less
,

1498 
D©um
::
Dec
(0
i64
.
što
()),

1499 
D©um
::
Dec
(0
i64
.
što
()),

1500 
Ord”šg
::
Equ®
,

1503 
D©um
::
Dec
(
i16
::
MAX
.
što
()),

1504 
D©um
::
Dec
(
i16
::
MAX
.
što
()),

1505 
Ord”šg
::
Equ®
,

1510 
D©um
::
Dec
(0u64.
što
()),

1511 
D©um
::
Dec
(0u64.
što
()),

1512 
Ord”šg
::
Equ®
,

1515 
D©um
::
Dec
(1u64.
što
()),

1516 
D©um
::
Dec
(0u64.
što
()),

1517 
Ord”šg
::
G»©”
,

1520 
D©um
::
Dec
(0u64.
što
()),

1521 
D©um
::
Dec
(1u64.
što
()),

1522 
Ord”šg
::
Less
,

1525 
D©um
::
Dec
(
i8
::
MAX
.
što
()),

1526 
D©um
::
Dec
(
i16
::
MAX
.
što
()),

1527 
Ord”šg
::
Less
,

1530 
D©um
::
Dec
(
u32
::
MAX
.
što
()),

1531 
D©um
::
Dec
(
i32
::
MAX
.
što
()),

1532 
Ord”šg
::
G»©”
,

1535 
D©um
::
Dec
(
u8
::
MAX
.
što
()),

1536 
D©um
::
Dec
(
i8
::
MAX
.
što
()),

1537 
Ord”šg
::
G»©”
,

1540 
D©um
::
Dec
(
u16
::
MAX
.
što
()),

1541 
D©um
::
Dec
(
i32
::
MAX
.
što
()),

1542 
Ord”šg
::
Less
,

1545 
D©um
::
Dec
(
u64
::
MAX
.
što
()),

1546 
D©um
::
Dec
(
i64
::
MAX
.
što
()),

1547 
Ord”šg
::
G»©”
,

1550 
D©um
::
Dec
(
i64
::
MAX
.
što
()),

1551 
D©um
::
Dec
(
u32
::
MAX
.
što
()),

1552 
Ord”šg
::
G»©”
,

1555 
D©um
::
Dec
(
u64
::
MAX
.
što
()),

1556 
D©um
::
Dec
(0u64.
što
()),

1557 
Ord”šg
::
G»©”
,

1560 
D©um
::
Dec
(0u64.
što
()),

1561 
D©um
::
Dec
(
u64
::
MAX
.
što
()),

1562 
Ord”šg
::
Less
,

1566 
b
"abc".
as_»f
().
što
(),

1567 
b
"ab".
as_»f
().
što
(),

1568 
Ord”šg
::
G»©”
,

1570 (
b
"123".
as_»f
().
što
(), 
D©um
::
I64
(1234), 
Ord”šg
::
Less
),

1571 (
b
"1".
as_»f
().
što
(), 
D©um
::
Max
, 
Ord”šg
::
Less
),

1572 (
b
"".
as_»f
().
što
(), 
D©um
::
NuÎ
, 
Ord”šg
::
G»©”
),

1574 (
D©um
::
Max
, D©um::Max, 
Ord”šg
::
Equ®
),

1575 (
D©um
::
Max
, D©um::
Mš
, 
Ord”šg
::
G»©”
),

1576 (
D©um
::
NuÎ
, D©um::
Mš
, 
Ord”šg
::
Less
),

1577 (
D©um
::
Mš
, D©um::Mš, 
Ord”šg
::
Equ®
),

1580 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"{"key":"value"}"#).unwrap()),

1581 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"{"key":"value"}"#).unwrap()),

1582 
Ord”šg
::
Equ®
,

1584 (
D©um
::
I64
(18), D©um::
JsÚ
(JsÚ::I64(18)), 
Ord”šg
::
Equ®
),

1585 (
D©um
::
U64
(18), D©um::
JsÚ
(JsÚ::
I64
(20)), 
Ord”šg
::
Less
),

1587 
D©um
::
F64
(1.2),

1588 
D©um
::
JsÚ
(JsÚ::
DoubË
(1.0)),

1589 
Ord”šg
::
G»©”
,

1592 
D©um
::
Dec
(
i32
::
MIN
.
što
()),

1593 
D©um
::
JsÚ
(JsÚ::
DoubË
(
i32
::
MIN
 
as
 
f64
)),

1594 
Ord”šg
::
Equ®
,

1597 
b
"hi".
as_»f
().
što
(),

1598 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#""hi""#).unwrap()),

1599 
Ord”šg
::
Equ®
,

1602 
D©um
::
Max
,

1603 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#""MAX""#).unwrap()),

1604 
Ord”šg
::
Less
,

1608 
lhs
, 
rhs
, 
»t
è
š
 
‹¡s
 {

1609 
»t
 !ğ
lhs
.
cmp
(&
DeçuÉ
::(), &
rhs
).
unw¿p
() {

1610 
·nic
!("{:?} should b{:?}Ø{:?}", 
lhs
, 
»t
, 
rhs
);

1613 
Ët
 
»v_»t
 = 
»t
.
»v”£
();

1615 
»v_»t
 !ğ
rhs
.
cmp
(&
DeçuÉ
::(), &
lhs
).
unw¿p
() {

1616 
·nic
!("{:?} should b{:?}Ø{:?}", 
rhs
, 
»v_»t
, 
lhs
);

1619 
§me_ty³
(&
lhs
, &
rhs
) {

1620 
Ët
 
lhs_bs
 = 
’code_key
(
as_¦iû
(&
lhs
)).
unw¿p
();

1621 
Ët
 
rhs_bs
 = 
’code_key
(
as_¦iû
(&
rhs
)).
unw¿p
();

1623 
»t
 !ğ
lhs_bs
.
cmp
(&
rhs_bs
) {

1624 
·nic
!("{:?} should b{:?}Ø{:?} wh’ƒncoded", 
lhs
, 
»t
, 
rhs
);

1627 
Ët
 
lhs_¡r
 = 
fÜm©
!("{:?}", 
lhs
);

1628 
Ët
 
rhs_¡r
 = 
fÜm©
!("{:?}", 
rhs
);

1629 
»t
 =ğ
Ord”šg
::
Equ®
 {

1630 
as£¹_eq
!(
lhs_¡r
, 
rhs_¡r
);

1636 #[
‹¡
]

1637 
â
 
‹¡_d©um_to_boŞ
() {

1638 
Ët
 
‹¡s
 = 
vec
![

1639 (
D©um
::
I64
(0), 
Some
(
çl£
)),

1640 (
D©um
::
I64
(-1), 
Some
(
Œue
)),

1641 (
D©um
::
U64
(0), 
Some
(
çl£
)),

1642 (
D©um
::
U64
(1), 
Some
(
Œue
)),

1643 (
D©um
::
F64
(0f64), 
Some
(
çl£
)),

1644 (
D©um
::
F64
(0.4), 
Some
(
çl£
)),

1645 (
D©um
::
F64
(0.5), 
Some
(
Œue
)),

1646 (
D©um
::
F64
(-0.5), 
Some
(
Œue
)),

1647 (
D©um
::
F64
(-0.4), 
Some
(
çl£
)),

1648 (
D©um
::
NuÎ
, 
NÚe
),

1649 (
b
"".
as_»f
().
što
(), 
Some
(
çl£
)),

1650 (
b
"0.5".
as_»f
().
što
(), 
Some
(
çl£
)),

1651 (
b
"0".
as_»f
().
što
(), 
Some
(
çl£
)),

1652 (
b
"2".
as_»f
().
što
(), 
Some
(
Œue
)),

1653 (
b
"abc".
as_»f
().
što
(), 
Some
(
çl£
)),

1655 
Time
::
·r£_utc_d©‘ime
("2011-11-10 11:11:11.999999", 6)

1656 .
unw¿p
()

1657 .
što
(),

1658 
Some
(
Œue
),

1661 
Du¿tiÚ
::
·r£
(
b
"11:11:11.999999", 
MAX_FSP
).
unw¿p
().
što
(),

1662 
Some
(
Œue
),

1665 
D©um
::
Dec
(
Decim®
::
äom_f64
(0.1415926).
unw¿p
()),

1666 
Some
(
çl£
),

1668 (
D©um
::
Dec
(0u64.
što
()), 
Some
(
çl£
)),

1670 
u£
 
chrÚo
::
FixedOff£t
;

1671 
u£
 
cİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

1673 
Ët
 
ùx
 = 
Ev®CÚ‹xt
 {

1674 
tz
: 
FixedOff£t
::
—¡
(0),

1675 
ignÜe_Œunÿ‹
: 
Œue
,

1676 
Œunÿ‹_as_w¬nšg
: 
Œue
,

1679 
d
, 
b
è
š
 
‹¡s
 {

1680 
d
.
şÚe
().
što_boŞ
(&
ùx
).
unw¿p
(è!ğ
b
 {

1681 
·nic
!("ex³ù {:?}Øb{:?}", 
d
, 
b
);

1686 #[
‹¡
]

1687 
â
 
‹¡_¥l™_d©um
() {

1688 
Ët
 
bË
 = 
vec
![

1689 
vec
![
D©um
::
I64
(1)],

1690 
vec
![

1691 
D©um
::
F64
(1f64),

1692 
D©um
::
F64
(3.15),

1693 
D©um
::
By‹s
(
b
"123".
to_vec
()),

1695 
vec
![

1696 
D©um
::
U64
(1),

1697 
D©um
::
F64
(3.15),

1698 
D©um
::
By‹s
(
b
"123".
to_vec
()),

1699 
D©um
::
I64
(-1),

1701 
vec
![
D©um
::
I64
(1), Datum::I64(0)],

1702 
vec
![
D©um
::
NuÎ
],

1703 
vec
![
D©um
::
I64
(100), D©um::
U64
(100)],

1704 
vec
![
D©um
::
U64
(1), Datum::U64(1)],

1705 
vec
![
D©um
::
Dec
(10.
što
())],

1706 
vec
![

1707 
D©um
::
F64
(1f64),

1708 
D©um
::
F64
(3.15),

1709 
D©um
::
By‹s
(
b
"123456789012345".
to_vec
()),

1711 
vec
![
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"{"key":"value"}"#).unwrap())],

1712 
vec
![

1713 
D©um
::
F64
(1f64),

1714 
D©um
::
JsÚ
(JsÚ::
äom_¡r
(
r
#"{"key":"value"}"#).unwrap()),

1715 
D©um
::
F64
(3.15),

1716 
D©um
::
By‹s
(
b
"123456789012345".
to_vec
()),

1720 
š
 
bË
 {

1721 
Ët
 
key_bs
 = 
’code_key
(&).
unw¿p
();

1722 
Ët
 
mut
 
buf
 = 
key_bs
.
as_¦iû
();

1723 
exp
 
š
 &{

1724 
Ët
 (
aù
, 
»m
èğ
¥l™_d©um
(
buf
, 
çl£
).
unw¿p
();

1725 
Ët
 
exp_bs
 = 
’code_key
(
as_¦iû
(
exp
)).
unw¿p
();

1726 
as£¹_eq
!(
exp_bs
, 
aù
);

1727 
buf
 = 
»m
;

1729 
as£¹
!(
buf
.
is_em±y
());

1731 
Ët
 
v®ue_bs
 = 
’code_v®ue
(&).
unw¿p
();

1732 
Ët
 
mut
 
buf
 = 
v®ue_bs
.
as_¦iû
();

1733 
exp
 
š
 &{

1734 
Ët
 (
aù
, 
»m
èğ
¥l™_d©um
(
buf
, 
çl£
).
unw¿p
();

1735 
Ët
 
exp_bs
 = 
’code_v®ue
(
as_¦iû
(
exp
)).
unw¿p
();

1736 
as£¹_eq
!(
exp_bs
, 
aù
);

1737 
buf
 = 
»m
;

1739 
as£¹
!(
buf
.
is_em±y
());

1743 #[
‹¡
]

1744 
â
 
‹¡_cÛrû_d©um
() {

1745 
Ët
 
ÿ£s
 = 
vec
![

1746 (
D©um
::
I64
(1), Datum::I64(1), Datum::I64(1), Datum::I64(1)),

1747 (
D©um
::
U64
(1), D©um::
I64
(1), Datum::U64(1), Datum::I64(1)),

1749 
D©um
::
U64
(1),

1750 
D©um
::
Dec
(1.
što
()),

1751 
D©um
::
Dec
(1.
što
()),

1752 
D©um
::
Dec
(1.
što
()),

1755 
D©um
::
F64
(1.0),

1756 
D©um
::
Dec
(1.
što
()),

1757 
D©um
::
F64
(1.0),

1758 
D©um
::
F64
(1.0),

1761 
D©um
::
F64
(1.0),

1762 
D©um
::
F64
(1.0),

1763 
D©um
::
F64
(1.0),

1764 
D©um
::
F64
(1.0),

1768 
x
, 
y
, 
exp_x
, 
exp_y
è
š
 
ÿ£s
 {

1769 
Ët
 (
»s_x
, 
»s_y
èğ
D©um
::
cÛrû
(
x
, 
y
).
unw¿p
();

1770 
as£¹_eq
!(
»s_x
, 
exp_x
);

1771 
as£¹_eq
!(
»s_y
, 
exp_y
);

1775 #[
‹¡
]

1776 
â
 
‹¡_ÿ¡_as_jsÚ
() {

1777 
Ët
 
‹¡s
 = 
vec
![

1778 (
D©um
::
I64
(1), "1.0"),

1779 (
D©um
::
F64
(3.3), "3.3"),

1781 
D©um
::
By‹s
(
br
#""Hello,world""#.to_vec()),

1782 
r
#""Hello,world""#,

1784 (
D©um
::
By‹s
(
b
"[1, 2, 3]".
to_vec
()), "[1, 2, 3]"),

1785 (
D©um
::
By‹s
(
b
"{}".
to_vec
()), "{}"),

1786 (
D©um
::
I64
(1), "true"),

1789 
d
, 
jsÚ
è
š
 
‹¡s
 {

1790 
as£¹_eq
!(
d
.
ÿ¡_as_jsÚ
().
unw¿p
(), 
jsÚ
.
·r£
().unwrap());

1793 
Ët
 
Ëg®_ÿ£s
 = 
vec
![

1794 
D©um
::
By‹s
(
b
"h–lo,wÜld".
to_vec
()),

1795 
D©um
::
NuÎ
,

1796 
D©um
::
Max
,

1797 
D©um
::
Mš
,

1800 
d
 
š
 
Ëg®_ÿ£s
 {

1801 
as£¹
!(
d
.
ÿ¡_as_jsÚ
().
is_”r
());

1805 #[
‹¡
]

1806 
â
 
‹¡_d©um_što_jsÚ
() {

1807 
Ët
 
‹¡s
 = 
vec
![

1808 (
D©um
::
I64
(1), "1.0"),

1809 (
D©um
::
F64
(3.3), "3.3"),

1810 (
D©um
::
By‹s
(
b
"H–lo,wÜld".
to_vec
()), 
r
#""Hello,world""#),

1811 (
D©um
::
By‹s
(
b
"[1, 2, 3]".
to_vec
()), 
r
#""[1, 2, 3]""#),

1812 (
D©um
::
NuÎ
, "null"),

1815 
d
, 
jsÚ
è
š
 
‹¡s
 {

1816 
as£¹_eq
!(
d
.
što_jsÚ
().
unw¿p
(), 
jsÚ
.
·r£
().unwrap());

1819 
Ët
 
Ëg®_ÿ£s
 = 
vec
![
D©um
::
Max
, D©um::
Mš
];

1821 
d
 
š
 
Ëg®_ÿ£s
 {

1822 
as£¹
!(
d
.
što_jsÚ
().
is_”r
());

	@src/coprocessor/codec/mod.rs

14 
pub
 
u£
 
	gut
::
codec
::{
E¼Ü
, 
	gResuÉ
};

16 cÚ¡ 
	gTEN_POW
: &'static [u32] = &[

20 1
	g_000
,

21 10
	g_000
,

22 100
	g_000
,

23 1
	g_000_000
,

24 10
	g_000_000
,

25 100
	g_000_000
,

26 1
	g_000_000_000
,

30 
	gmaüo_ruËs
! 
	gšv®id_ty³
 {

31 (
	g$e
:
ex´
) => ({

32 
u£
 
ut
::
codec
::
E¼Ü
;

33 
	gE¼Ü
::
Inv®idD©aTy³
((
$e
).
što
())

35 (
	g$f
:
‰
, 
$
(
$¬g
:
ex´
),+) => ({

36 
u£
 
ut
::
codec
::
E¼Ü
;

37 
	gE¼Ü
::
Inv®idD©aTy³
(
fÜm©
!(
$f
, 
$
(
$¬g
),+))

41 
pub
 
mod
 
	gd©um
;

42 
pub
 
mod
 
	gbË
;

43 
pub
 
mod
 
	gcÚv”t
;

44 
pub
 
mod
 
	gmysql
;

46 
pub
 
u£
 
	g£lf
::
d©um
::
D©um
;

	@src/coprocessor/codec/mysql/charset.rs

15 
pub
 cÚ¡ 
	gCHARSET_BIN
: &'static str = "binary";

17 
pub
 cÚ¡ 
COLLATION_BIN
: &'static str = "binary";

19 
pub
 cÚ¡ 
CHARSET_UTF8
: &'static str = "utf8";

21 
pub
 cÚ¡ 
COLLATION_UTF8
: &'static str = "utf8_bin";

23 
pub
 cÚ¡ 
CHARSET_UTF8MB4
: &'static str = "utf8mb4";

25 
pub
 cÚ¡ 
COLLATION_UTF8MB4
: &'static str = "utf8mb4_bin";

27 
pub
 cÚ¡ 
CHARSET_ASCII
: &'static str = "ascii";

29 
pub
 cÚ¡ 
COLLATION_ASCII
: &'static str = "ascii_bin";

31 
pub
 cÚ¡ 
CHARSET_LATIN1
: &'static str = "latin1";

33 
pub
 cÚ¡ 
COLLATION_LATIN1
: &'static str = "latin1_bin";

36 
pub
 cÚ¡ 
UTF8_CHARSETS
: &'¡©iø[&'
¡r
] = &[
CHARSET_UTF8
, 
CHARSET_UTF8MB4
, 
CHARSET_ASCII
];

	@src/coprocessor/codec/mysql/decimal.rs

14 
u£
 
	g¡d
::
ascii
::
AsciiExt
;

15 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

16 
u£
 
	g¡d
::
¡r
::{
£lf
, 
	gFromSŒ
};

17 
u£
 
	g¡d
::
io
::
Wr™e
;

18 
u£
 
	g¡d
::
İs
::{
Add
, 
	gD”ef
, 
	gD”efMut
, 
	gDiv
, 
	gMul
, 
	gNeg
, 
	gRem
, 
	gSub
};

19 
u£
 
	g¡d
::{
cmp
, 
	gmem
, 
	gi32
, 
	gi64
, 
	gu32
, 
	gu64
};

20 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

22 
u£
 
	gby‹Üd”
::
R—dBy‹sExt
;

24 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

25 
u£
 
	gut
::
codec
::
by‹s
::
By‹sDecod”
;

26 
u£
 
	gut
::
esÿ³
;

27 
u£
 
	gcİroûssÜ
::
codec
::{
cÚv”t
, 
	gE¼Ü
, 
	gResuÉ
, 
	gTEN_POW
};

30 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
E¼Ü
 
as
 
Ex´E¼Ü
;

32 #[
d”ive
(
Debug
, 
P¬tŸlEq
, 
ClÚe
)]

33 
pub
 
	gRes
<
	gT
> {

34 
Ok
(
T
),

35 
Trunÿ‹d
(
T
),

36 
Ov”æow
(
T
),

39 
	gim¶
<
	gT
> 
	gRes
<T> {

40 
pub
 
â
 
	gm­
<
	gU
, 
	gF
: 
FnOnû
(
T
è-> 
U
>(
£lf
, 
	gf
: 
F
è-> 
Res
<U> {

41 
m©ch
 
£lf
 {

42 
Res
::
Ok
(
t
è=> Res::Ok(
f
(t)),

43 
	gRes
::
Trunÿ‹d
(
t
è=> 
Res
::Trunÿ‹d(
f
(t)),

44 
	gRes
::
Ov”æow
(
t
è=> 
Res
::Ov”æow(
f
(t)),

48 
pub
 
â
 
unw¿p
(
£lf
è-> 
	gT
 {

49 
m©ch
 
	g£lf
 {

50 
	gRes
::
Ok
(
t
è| 
Res
::
Trunÿ‹d
Ñè| Res::
Ov”æow
(t) =>,

54 
pub
 
â
 
is_ok
(&
£lf
è-> 
	gboŞ
 {

55 
m©ch
 *
	g£lf
 {

56 
	gRes
::
Ok
(
_
è=> 
Œue
,

57 
	g_
 => 
çl£
,

61 
pub
 
â
 
is_ov”æow
(&
£lf
è-> 
	gboŞ
 {

62 
m©ch
 *
	g£lf
 {

63 
	gRes
::
Ov”æow
(
_
è=> 
Œue
,

64 
	g_
 => 
çl£
,

68 
pub
 
â
 
is_Œunÿ‹d
(&
£lf
è-> 
	gboŞ
 {

69 
m©ch
 *
	g£lf
 {

70 
	gRes
::
Trunÿ‹d
(
_
è=> 
Œue
,

71 
	g_
 => 
çl£
,

76 
	gim¶
<
	gT
: 
Di¥Ïy
> 
Res
<
T
> {

77 
pub
 
â
 
što_»suÉ
(
£lf
è-> 
ResuÉ
<
T
> {

78 
m©ch
 
£lf
 {

79 
Res
::
Ok
(
t
) => Ok(t),

80 
	gRes
::
Ov”æow
(
t
è=> 
E¼
(
box_”r
!("overflow: {}",)),

81 
	gRes
::
Trunÿ‹d
(
t
è=> 
E¼
(
box_”r
!("truncated: {}",)),

86 
	gim¶
<
	gT
> 
D”ef
 
	gRes
<T> {

87 
ty³
 
	gT¬g‘
 = 
T
;

89 
â
 
d”ef
(&
£lf
è-> &
	gT
 {

90 
m©ch
 *
	g£lf
 {

91 
	gRes
::
Ok
(
»f
 
t
è| 
Res
::
Ov”æow
Ôeàtè| Res::
Trunÿ‹d
(ref) =>,

96 
	gim¶
<
	gT
> 
D”efMut
 
	gRes
<T> {

97 
â
 
d”ef_mut
(&
mut
 
£lf
è-> &muˆ
	gT
 {

98 
m©ch
 *
	g£lf
 {

99 
	gRes
::
Ok
(
»f
 
mut
 
t
è| 
Res
::
Ov”æow
Ôeàmuˆtè| Res::
Trunÿ‹d
(ref mut) =>,

105 cÚ¡ 
	gWORD_BUF_LEN
: 
u8
 = 9;

107 cÚ¡ 
	gDIGITS_PER_WORD
: 
u8
 = 9;

109 cÚ¡ 
	gWORD_SIZE
: 
u8
 = 4;

110 cÚ¡ 
	gDIG_MASK
: 
u32
 = 
TEN_POW
[8];

111 cÚ¡ 
	gWORD_BASE
: 
u32
 = 
TEN_POW
[9];

112 cÚ¡ 
	gWORD_MAX
: 
u32
 = 
WORD_BASE
 - 1;

113 cÚ¡ 
	gMAX_FRACTION
: 
u8
 = 30;

114 cÚ¡ 
	gDEFAULT_DIV_FRAC_INCR
: 
u8
 = 4;

115 cÚ¡ 
	gDIG_2_BYTES
: &'static [u8] = &[0, 1, 1, 2, 2, 3, 3, 4, 4, 4];

116 cÚ¡ 
FRAC_MAX
: &'static [u32] = &[

126 cÚ¡ 
	gNOT_FIXED_DEC
: 
u8
 = 31;

128 
	gmaüo_ruËs
! 
	gwÜd_út
 {

129 (
	g$Ën
:
ex´
è=> (
wÜd_út
!(
$Ën
, 
	gu8
));

130 (
	g$Ën
:
ex´
, 
	g$t
:
ty
) => ({

131 ((
$Ën
è+ 
DIGITS_PER_WORD
 
as
 
$t
 - 1) / DIGITS_PER_WORD‡s $t

136 
pub
 
â
 
dec_’coded_Ën
(
’coded
: &[
u8
]è-> 
ResuÉ
<
usize
> {

137 
’coded
.
Ën
() < 2 {

138  
E¼
(
box_”r
!("decim®oØshÜt: {} < 2", 
’coded
.
Ën
()));

141 
Ët
 
	g´ecisiÚ
 = 
’coded
[0];

142 
Ët
 
	gäac_út
 = 
’coded
[1];

143 
	g´ecisiÚ
 < 
	gäac_út
 {

144  
E¼
(
box_”r
!(

146 
´ecisiÚ
,

147 
äac_út


150 
Ët
 
	gšt_út
 = 
´ecisiÚ
 - 
äac_út
;

151 
Ët
 
	gšt_wÜd_út
 = 
št_út
 / 
DIGITS_PER_WORD
;

152 
Ët
 
	gäac_wÜd_út
 = 
äac_út
 / 
DIGITS_PER_WORD
;

153 
Ët
 
	gšt_Ëá
 = (
št_út
 - 
št_wÜd_út
 * 
DIGITS_PER_WORD
è
as
 
usize
;

154 
Ët
 
	gäac_Ëá
 = (
äac_út
 - 
äac_wÜd_út
 * 
DIGITS_PER_WORD
è
as
 
usize
;

155 
Ët
 
	gšt_Ën
 = (
št_wÜd_út
 * 
WORD_SIZE
 + 
DIG_2_BYTES
[
št_Ëá
]è
as
 
usize
;

156 
Ët
 
	gäac_Ën
 = (
äac_wÜd_út
 * 
WORD_SIZE
 + 
DIG_2_BYTES
[
äac_Ëá
]è
as
 
usize
;

157 
Ok
(
št_Ën
 + 
äac_Ën
 + 2)

161 
â
 
couÁ_Ëadšg_z”Ûs
(
i
: 
u8
, 
wÜd
: 
u32
) -> u8 {

162 
Ët
 (
mut
 
c
, muˆ
i
èğ(0, i 
as
 
	gusize
);

163 
	gTEN_POW
[
i
] > 
	gwÜd
 {

164 
	gi
 -= 1;

165 
	gc
 += 1;

167 
	gc


171 
â
 
couÁ_Œašg_z”Ûs
(
i
: 
u8
, 
wÜd
: 
u32
) -> u8 {

172 
Ët
 (
mut
 
c
, muˆ
i
èğ(0, i 
as
 
	gusize
);

173 
	gwÜd
 % 
	gTEN_POW
[
i
] == 0 {

174 
i
 += 1;

175 
	gc
 += 1;

177 
	gc


181 
â
 
	$add
(
a
: 
u32
, 
b
: u32, 
ÿ¼y
: &
mut
 u32, 
»s
: &mut u32) {

182 
Ët
 
sum
 = 
a
 + 
b
 + *
ÿ¼y
;

183 
sum
 >ğ
WORD_BASE
 {

184 *
»s
 = 
sum
 - 
WORD_BASE
;

185 *
ÿ¼y
 = 1;

187 *
»s
 = 
sum
;

188 *
ÿ¼y
 = 0;

190 
	}
}

193 
â
 
fix_wÜd_út_”r
(
št_wÜd_út
: 
u8
, 
äac_wÜd_út
: u8, 
wÜd_buf_Ën
: u8è-> 
Res
<(u8, 
	gu8
)> {

194 
	gšt_wÜd_út
 + 
	gäac_wÜd_út
 > 
	gwÜd_buf_Ën
 {

195 
	gšt_wÜd_út
 > 
	gwÜd_buf_Ën
 {

196  
	gRes
::
Ov”æow
((
wÜd_buf_Ën
, 0));

198  
	gRes
::
Trunÿ‹d
((
št_wÜd_út
, 
wÜd_buf_Ën
 - int_word_cnt));

200 
	gRes
::
Ok
((
št_wÜd_út
, 
äac_wÜd_út
))

204 
â
 
	$sub
(
lhs
: 
u32
, 
rhs
: u32, 
ÿ¼y
: &
mut
 
i32
, 
»s
: &mut u32) {

205 
Ët
 
diff
 = 
lhs
 
as
 
i32
 - 
rhs
‡ i32 - *
ÿ¼y
;

206 
diff
 < 0 {

207 *
ÿ¼y
 = 1;

208 *
»s
 = (
diff
 + 
WORD_BASE
 
as
 
i32
èa 
u32
;

210 *
ÿ¼y
 = 0;

211 *
»s
 = 
diff
 
as
 
u32
;

213 
	}
}

217 
â
 
	$sub2
(
lhs
: 
u32
, 
rhs
: u32, 
ÿ¼y
: &
mut
 
i32
, 
»s
: &mut u32) {

218 
Ët
 
mut
 
diff
 = 
lhs
 
as
 
i32
 - 
rhs
‡ i32 - *
ÿ¼y
;

219 
diff
 < -(
WORD_BASE
 
as
 
i32
) {

220 *
ÿ¼y
 = 2;

221 
diff
 +ğ
WORD_BASE
 
as
 
i32
 + WORD_BASE‡s i32;

222 } 
diff
 < 0 {

223 *
ÿ¼y
 = 1;

224 
diff
 +ğ
WORD_BASE
 
as
 
i32
;

226 *
ÿ¼y
 = 0;

228 *
»s
 = 
diff
 
as
 
u32
;

229 
	}
}

231 
ty³
 
	gSubTmp
 = (
usize
, 
	gusize
, 
	gu8
);

237 #[
šlše
]

238 
â
 
ÿlc_sub_ÿ¼y
(
lhs
: &
Decim®
, 
rhs
: &Decim®è-> (
O±iÚ
<
i32
>, 
	gu8
, 
	gSubTmp
, SubTmp) {

239 
Ët
 (
l_št_wÜd_út
, 
mut
 
l_äac_wÜd_út
èğ(
wÜd_út
!(
lhs
.
št_út
), 
	gwÜd_út
!(
	glhs
.
	gäac_út
));

240 
Ët
 (
r_št_wÜd_út
, 
mut
 
r_äac_wÜd_út
èğ(
wÜd_út
!(
rhs
.
št_út
), 
	gwÜd_út
!(
	grhs
.
	gäac_út
));

241 
Ët
 
	gäac_wÜd_to
 = 
cmp
::
max
(
l_äac_wÜd_út
, 
r_äac_wÜd_út
);

243 
Ët
 (
l_¡İ
, 
mut
 
l_idx
èğ(
l_št_wÜd_út
 
as
 
usize
, 0u
	gsize
);

244 
	gl_idx
 < 
	gl_¡İ
 && 
	glhs
.
	gwÜd_buf
[
l_idx
] == 0 {

245 
l_idx
 += 1;

247 
Ët
 
	gl_¡¬t
 = 
l_idx
;

248 
Ët
 
	gl_št_wÜd_út
 = 
l_¡İ
 - 
l_idx
;

250 
Ët
 (
r_¡İ
, 
mut
 
r_idx
èğ(
r_št_wÜd_út
 
as
 
usize
, 0u
	gsize
);

251 
	gr_idx
 < 
	gr_¡İ
 && 
	grhs
.
	gwÜd_buf
[
r_idx
] == 0 {

252 
r_idx
 += 1;

254 
Ët
 
	gr_¡¬t
 = 
r_idx
;

255 
Ët
 
	gr_št_wÜd_út
 = 
r_¡İ
 - 
r_idx
;

257 
Ët
 
	gÿ¼y
 = 
r_št_wÜd_út
 > 
l_št_wÜd_út
 {

258 
Some
(1)

259 } 
r_št_wÜd_út
 =ğ
l_št_wÜd_út
 {

260 
Ët
 
mut
 
l_’d
 = (
l_¡İ
 + 
l_äac_wÜd_út
 
as
 
usize
 - 1èa 
isize
;

261 
Ët
 
mut
 
	gr_’d
 = (
r_¡İ
 + 
r_äac_wÜd_út
 
as
 
usize
 - 1èa 
isize
;

262 
l_idx
 
as
 
	gisize
 <ğ
l_’d
 && 
lhs
.
wÜd_buf
[l_’d‡ 
usize
] == 0 {

263 
l_’d
 -= 1;

265 
r_idx
 
as
 
	gisize
 <ğ
r_’d
 && 
rhs
.
wÜd_buf
[r_’d‡ 
usize
] == 0 {

266 
r_’d
 -= 1;

268 
	gl_äac_wÜd_út
 = (
l_’d
 + 1 - 
l_¡İ
 
as
 
isize
èa 
u8
;

269 
	gr_äac_wÜd_út
 = (
r_’d
 + 1 - 
r_¡İ
 
as
 
isize
èa 
u8
;

270 
l_idx
 
as
 
	gisize
 <ğ
l_’d
 && 
r_idx
‡ 
isize
 <ğ
r_’d
 &&

271 
lhs
.
wÜd_buf
[
l_idx
] =ğ
rhs
.wÜd_buf[
r_idx
]

273 
l_idx
 += 1;

274 
	gr_idx
 += 1;

276 
l_idx
 
as
 
	gisize
 <ğ
l_’d
 {

277 
r_idx
 
as
 
isize
 <ğ
r_’d
 && 
rhs
.
wÜd_buf
[r_idx] > 
lhs
.wÜd_buf[
l_idx
] {

278 
Some
(1)

280 
Some
(0)

282 } 
r_idx
 
as
 
	gisize
 <ğ
r_’d
 {

283 
Some
(1)

285 
NÚe


288 
Some
(0)

290 
Ët
 
	gl_»s
 = (
l_¡¬t
, 
	gl_št_wÜd_út
, 
	gl_äac_wÜd_út
);

291 
Ët
 
	gr_»s
 = (
r_¡¬t
, 
	gr_št_wÜd_út
, 
	gr_äac_wÜd_út
);

292 (
	gÿ¼y
, 
	gäac_wÜd_to
, 
	gl_»s
, 
	gr_»s
)

296 
â
 
	gdo_sub
<'a>(muˆlhs: &'
a
 
	gDecim®
, 
mut
 
	grhs
: &'a Decimal) -> Res<Decimal> {

297 
Ët
 (
ÿ¼y
, 
mut
 
äac_wÜd_to
, 
l_»s
, 
r_»s
èğ
ÿlc_sub_ÿ¼y
(
lhs
, 
rhs
);

298 
	gÿ¼y
.
	$is_nÚe
() {

299 
Ët
 
mut
 
»s
 = 
lhs
.
	`to_owÃd
();

300 
»s
.
	`»£t_to_z”o
();

301  
Res
::
	`Ok
(
»s
);

302 
	}
}

303 
Ët
 (
mut
 
l_¡¬t
, muˆ
l_št_wÜd_út
, muˆ
l_äac_wÜd_út
èğ
l_»s
;

304 
Ët
 (
mut
 
r_¡¬t
, muˆ
r_št_wÜd_út
, muˆ
r_äac_wÜd_út
èğ
r_»s
;

306 
Ët
 
	gÃg©ive
 = 
ÿ¼y
.
unw¿p
() > 0 {

307 
mem
::
sw­
(&
mut
 
lhs
, &muˆ
rhs
);

308 
	gmem
::
sw­
(&
mut
 
l_¡¬t
, &muˆ
r_¡¬t
);

309 
	gmem
::
sw­
(&
mut
 
l_št_wÜd_út
, &muˆ
r_št_wÜd_út
);

310 
	gmem
::
sw­
(&
mut
 
l_äac_wÜd_út
, &muˆ
r_äac_wÜd_út
);

311 !
	grhs
.
	gÃg©ive


313 
	glhs
.
	gÃg©ive


316 
Ët
 
	g»s
 = 
fix_wÜd_út_”r
(
l_št_wÜd_út
 
as
 
u8
, 
äac_wÜd_to
, 
WORD_BUF_LEN
);

317 
	gl_št_wÜd_út
 = 
»s
.0 
as
 
usize
;

318 
	gäac_wÜd_to
 = 
»s
.1;

319 
Ët
 
mut
 
	gidx_to
 = 
l_št_wÜd_út
 + 
äac_wÜd_to
 
as
 
usize
;

320 
Ët
 
mut
 
	gäac_út
 = 
cmp
::
max
(
lhs
.
äac_út
, 
rhs
.frac_cnt);

321 
Ët
 
	gšt_út
 = 
l_št_wÜd_út
 
as
 
u8
 * 
DIGITS_PER_WORD
;

322 !
	g»s
.
	$is_ok
() {

323 
äac_út
 = 
cmp
::
	`mš
(äac_út, 
äac_wÜd_to
 * 
DIGITS_PER_WORD
);

324 
l_äac_wÜd_út
 = 
cmp
::
	`mš
Ö_äac_wÜd_út, 
äac_wÜd_to
);

325 
r_äac_wÜd_út
 = 
cmp
::
	`mš
Ô_äac_wÜd_út, 
äac_wÜd_to
);

326 
r_št_wÜd_út
 = 
cmp
::
	`mš
Ô_št_wÜd_út, 
l_št_wÜd_út
);

327 
	}
}

328 
Ët
 
mut
 
	gÿ¼y
 = 0;

329 
Ët
 
mut
 
	g»s
 = 
»s
.
m­
(|
_
| 
Decim®
::
Ãw
(
št_út
, 
äac_út
, 
Ãg©ive
));

330 
Ët
 
mut
 
	gl_idx
 = 
l_¡¬t
 + 
l_št_wÜd_út
 
as
 
usize
 + 
l_äac_wÜd_út
‡s usize;

331 
Ët
 
mut
 
	gr_idx
 = 
r_¡¬t
 + 
r_št_wÜd_út
 
as
 
usize
 + 
r_äac_wÜd_út
‡s usize;

332 
	gl_äac_wÜd_út
 > 
	gr_äac_wÜd_út
 {

333 
Ët
 
	gl_¡İ
 = 
l_¡¬t
 + 
l_št_wÜd_út
 
as
 
usize
 + 
r_äac_wÜd_út
‡s usize;

334 
	gl_äac_wÜd_út
 < 
	gäac_wÜd_to
 {

335 
	gidx_to
 = (
äac_wÜd_to
 - 
l_äac_wÜd_út
è
as
 
usize
;

337 
	gl_idx
 > 
	gl_¡İ
 {

338 
	gidx_to
 -= 1;

339 
	gl_idx
 -= 1;

340 
	g»s
.
	gwÜd_buf
[
idx_to
] = 
lhs
.
wÜd_buf
[
l_idx
];

343 
Ët
 
	gr_¡İ
 = 
r_¡¬t
 + 
r_št_wÜd_út
 
as
 
usize
 + 
l_äac_wÜd_út
‡s usize;

344 
	gäac_wÜd_to
 > 
	gr_äac_wÜd_út
 {

345 
	gidx_to
 = (
äac_wÜd_to
 - 
r_äac_wÜd_út
è
as
 
usize
;

347 
	gr_idx
 > 
	gr_¡İ
 {

348 
	gidx_to
 -= 1;

349 
	gr_idx
 -= 1;

350 
sub
(

352 
rhs
.
wÜd_buf
[
r_idx
],

353 &
mut
 
ÿ¼y
,

354 &
mut
 
»s
.
wÜd_buf
[
idx_to
],

359 
	gr_idx
 > 
	gr_¡¬t
 {

360 
	gidx_to
 -= 1;

361 
	gl_idx
 -= 1;

362 
	gr_idx
 -= 1;

363 
sub
(

364 
lhs
.
wÜd_buf
[
l_idx
],

365 
rhs
.
wÜd_buf
[
r_idx
],

366 &
mut
 
ÿ¼y
,

367 &
mut
 
»s
.
wÜd_buf
[
idx_to
],

371 
	gÿ¼y
 > 0 && 
	gl_idx
 > 
	gl_¡¬t
 {

372 
	gidx_to
 -= 1;

373 
	gl_idx
 -= 1;

374 
sub
(

375 
lhs
.
wÜd_buf
[
l_idx
],

377 &
mut
 
ÿ¼y
,

378 &
mut
 
»s
.
wÜd_buf
[
idx_to
],

381 
	gl_idx
 > 
	gl_¡¬t
 {

382 
	gidx_to
 -= 1;

383 
	gl_idx
 -= 1;

384 
	g»s
.
	gwÜd_buf
[
idx_to
] = 
lhs
.
wÜd_buf
[
l_idx
];

386 
	g»s


390 
â
 
max_decim®
(
´ec
: 
u8
, 
äac_út
: u8è-> 
Decim®
 {

391 
Ët
 
št_út
 = 
´ec
 - 
äac_út
;

392 
Ët
 
mut
 
	g»s
 = 
Decim®
::
Ãw
(
št_út
, 
äac_út
, 
çl£
);

393 
Ët
 
mut
 
	gidx
 = 0;

394 
	gšt_út
 > 0 {

395 
Ët
 
	gfœ¡_wÜd_út
 = 
št_út
 % 
DIGITS_PER_WORD
;

396 
	gfœ¡_wÜd_út
 > 0 {

397 
	g»s
.
	gwÜd_buf
[
idx
] = 
TEN_POW
[
fœ¡_wÜd_út
 
as
 
usize
] - 1;

398 
	gidx
 += 1;

400 
_
 
	gš
 0..
	gšt_út
 / 
	gDIGITS_PER_WORD
 {

401 
	g»s
.
	gwÜd_buf
[
idx
] = 
WORD_MAX
;

402 
	gidx
 += 1;

405 
	gäac_út
 > 0 {

406 
Ët
 
	gÏ¡_dig™s
 = 
äac_út
 % 
DIGITS_PER_WORD
;

407 
_
 
	gš
 0..f
	g¿c_út
 / 
	gDIGITS_PER_WORD
 {

408 
	g»s
.
	gwÜd_buf
[
idx
] = 
WORD_MAX
;

409 
	gidx
 += 1;

411 
	gÏ¡_dig™s
 > 0 {

412 
	g»s
.
	gwÜd_buf
[
idx
] = 
FRAC_MAX
[
Ï¡_dig™s
 
as
 
usize
 - 1];

415 
	g»s


420 
pub
 
â
 
max_Ü_mš_dec
(
Ãg©ive
: 
boŞ
, 
´ec
: 
u8
, 
äac
: u8è-> 
Decim®
 {

421 
Ët
 
mut
 
»t
 = 
max_decim®
(
´ec
, 
äac
);

422 
	g»t
.
	gÃg©ive
 = 
Ãg©ive
;

423 
	g»t


427 
â
 
	gdo_add
<'a>(muˆlhs: &'
a
 
	gDecim®
, 
mut
 
	grhs
: &'a Decimal) -> Res<Decimal> {

428 
Ët
 (
mut
 
l_št_wÜd_út
, muˆ
l_äac_wÜd_út
) =

429 (
wÜd_út
!(
lhs
.
št_út
), 
	gwÜd_út
!(
	glhs
.
	gäac_út
));

430 
Ët
 (
mut
 
r_št_wÜd_út
, muˆ
r_äac_wÜd_út
) =

431 (
wÜd_út
!(
rhs
.
št_út
), 
	gwÜd_út
!(
	grhs
.
	gäac_út
));

432 
Ët
 (
mut
 
št_wÜd_to
, 
äac_wÜd_to
) = (

433 
cmp
::
max
(
l_št_wÜd_út
, 
r_št_wÜd_út
),

434 
	gcmp
::
max
(
l_äac_wÜd_út
, 
r_äac_wÜd_út
),

436 
Ët
 
	gx
 = 
l_št_wÜd_út
 > 
r_št_wÜd_út
 {

437 
lhs
.
wÜd_buf
[0]

438 } 
l_št_wÜd_út
 < 
r_št_wÜd_út
 {

439 
rhs
.
wÜd_buf
[0]

441 
lhs
.
wÜd_buf
[0] + 
rhs
.word_buf[0]

443 
	gx
 > 
	gWORD_MAX
 - 1 {

444 
	gšt_wÜd_to
 += 1;

446 
Ët
 
	g»s
 = 
fix_wÜd_út_”r
(
št_wÜd_to
, 
äac_wÜd_to
, 
WORD_BUF_LEN
);

447 
	g»s
.
	$is_ov”æow
() {

448  
Res
::
	`Ov”æow
(
	`max_decim®
(
WORD_BUF_LEN
 * 
DIGITS_PER_WORD
, 0));

449 
	}
}

450 
Ët
 (
št_wÜd_to
, 
äac_wÜd_to
èğ
»s
.
şÚe
().
unw¿p
();

451 
Ët
 
mut
 
	gidx_to
 = (
št_wÜd_to
 + 
äac_wÜd_to
è
as
 
usize
;

452 
Ët
 
mut
 
	g»s
 = 
»s
.
m­
(|
_
| {

453 
Decim®
::
Ãw
(

454 
št_wÜd_to
 * 
DIGITS_PER_WORD
,

455 
cmp
::
max
(
lhs
.
äac_út
, 
rhs
.frac_cnt),

456 
lhs
.
Ãg©ive
,

459 
	g»s
.
	gwÜd_buf
[0] = 0;

460 !
	g»s
.
	$is_ok
() {

461 
»s
.
äac_út
 = 
cmp
::
	`mš
(
äac_wÜd_to
 * 
DIGITS_PER_WORD
,„es.frac_cnt);

462 
l_äac_wÜd_út
 = 
cmp
::
	`mš
(
äac_wÜd_to
,†_frac_word_cnt);

463 
r_äac_wÜd_út
 = 
cmp
::
	`mš
Ô_äac_wÜd_út, 
äac_wÜd_to
);

464 
l_št_wÜd_út
 = 
cmp
::
	`mš
Ö_št_wÜd_út, 
št_wÜd_to
);

465 
r_št_wÜd_út
 = 
cmp
::
	`mš
Ô_št_wÜd_út, 
št_wÜd_to
);

466 
	}
}

467 
Ët
 (
mut
 
l_idx
, muˆ
r_idx
, 
l_¡İ
, 
r_¡İ
, 
exchªged
);

468 
	gl_äac_wÜd_út
 > 
	gr_äac_wÜd_út
 {

469 
	gl_idx
 = (
l_št_wÜd_út
 + 
l_äac_wÜd_út
è
as
 
usize
;

470 
	gl_¡İ
 = (
l_št_wÜd_út
 + 
r_äac_wÜd_út
è
as
 
usize
;

471 
	gr_idx
 = (
r_št_wÜd_út
 + 
r_äac_wÜd_út
è
as
 
usize
;

472 
	gr_¡İ
 = 
l_št_wÜd_út
.
§tu¿tšg_sub
(
r_št_wÜd_út
è
as
 
usize
;

473 
	gexchªged
 = 
çl£
;

475 
	gl_idx
 = (
r_št_wÜd_út
 + 
r_äac_wÜd_út
è
as
 
usize
;

476 
	gl_¡İ
 = (
r_št_wÜd_út
 + 
l_äac_wÜd_út
è
as
 
usize
;

477 
	gr_idx
 = (
l_št_wÜd_út
 + 
l_äac_wÜd_út
è
as
 
usize
;

478 
	gr_¡İ
 = 
r_št_wÜd_út
.
§tu¿tšg_sub
(
l_št_wÜd_út
è
as
 
usize
;

479 
	gmem
::
sw­
(&
mut
 
lhs
, &muˆ
rhs
);

480 
	gexchªged
 = 
Œue
;

482 
	gl_idx
 > 
	gl_¡İ
 {

483 
	gidx_to
 -= 1;

484 
	gl_idx
 -= 1;

485 
	g»s
.
	gwÜd_buf
[
idx_to
] = 
lhs
.
wÜd_buf
[
l_idx
];

487 
Ët
 
mut
 
	gÿ¼y
 = 0;

488 
	gl_idx
 > 
	gr_¡İ
 {

489 
	gl_idx
 -= 1;

490 
	gr_idx
 -= 1;

491 
	gidx_to
 -= 1;

492 
add
(

493 
lhs
.
wÜd_buf
[
l_idx
],

494 
rhs
.
wÜd_buf
[
r_idx
],

495 &
mut
 
ÿ¼y
,

496 &
mut
 
»s
.
wÜd_buf
[
idx_to
],

499 
Ët
 
	gl_¡İ
 = 0;

500 
	gl_št_wÜd_út
 > 
	gr_št_wÜd_út
 {

501 
	gl_idx
 = (
l_št_wÜd_út
 - 
r_št_wÜd_út
è
as
 
usize
;

502 
	gexchªged
 {

503 
	gmem
::
sw­
(&
mut
 
lhs
, &muˆ
rhs
);

506 
	gl_idx
 = (
r_št_wÜd_út
 - 
l_št_wÜd_út
è
as
 
usize
;

507 !
	gexchªged
 {

508 
	gmem
::
sw­
(&
mut
 
lhs
, &muˆ
rhs
);

511 
	gl_idx
 > 
	gl_¡İ
 {

512 
	gidx_to
 -= 1;

513 
	gl_idx
 -= 1;

514 
add
(

515 
lhs
.
wÜd_buf
[
l_idx
],

517 &
mut
 
ÿ¼y
,

518 &
mut
 
»s
.
wÜd_buf
[
idx_to
],

521 
	gÿ¼y
 > 0 {

522 
	gidx_to
 -= 1;

523 
	g»s
.
	gwÜd_buf
[
idx_to
] = 1;

525 
	g»s


529 #[
®low
(
cyşom©ic_com¶ex™y
)]

530 #[
®low
(
ÃedËss_¿nge_loİ
)]

531 
â
 
do_div_mod
(

532 
mut
 
lhs
: 
Decim®
,

533 
rhs
: 
Decim®
,

534 
mut
 
äac_šü
: 
u8
,

535 
do_mod
: 
boŞ
,

536 è-> 
	gO±iÚ
<
	gRes
<
	gDecim®
>> {

537 
Ët
 
	gr_äac_út
 = 
wÜd_út
!(
rhs
.
äac_út
è* 
DIGITS_PER_WORD
;

538 
Ët
 (
r_idx
, 
mut
 
r_´ec
èğ
rhs
.
»move_Ëadšg_z”Ûs
();

539 
	gr_´ec
 +ğ
r_äac_út
;

540 
	gr_´ec
 == 0 {

541  
NÚe
;

544 
Ët
 
	gl_äac_út
 = 
wÜd_út
!(
lhs
.
äac_út
è* 
DIGITS_PER_WORD
;

545 
Ët
 (
l_idx
, 
mut
 
l_´ec
èğ
lhs
.
»move_Ëadšg_z”Ûs
();

546 
	gl_´ec
 +ğ
l_äac_út
;

547 
	gl_´ec
 == 0 {

548 
lhs
.
»£t_to_z”o
();

549  
Some
(
Res
::
Ok
(
lhs
));

552 
	gäac_šü
 = 
äac_šü
.
§tu¿tšg_sub
(
l_äac_út
 - 
lhs
.
äac_út
 + 
r_äac_út
 - 
rhs
.frac_cnt);

553 
Ët
 
mut
 
	gšt_út_to
 = (
l_´ec
 - 
l_äac_út
è
as
 
i8
 - (
r_´ec
 - 
r_äac_út
)‡s i8;

554 
	glhs
.
	gwÜd_buf
[
l_idx
] >ğ
rhs
.
wÜd_buf
[
r_idx
] {

555 
št_út_to
 += 1;

557 
Ët
 
	gšt_wÜd_to
 = 
št_út_to
 < 0 {

558 
št_út_to
 /ğ
DIGITS_PER_WORD
 
as
 
i8
;

561 
	gwÜd_út
!(
št_út_to
 
as
 
	gu8
)

563 
Ët
 
mut
 
	gäac_wÜd_to
;

564 
Ët
 
mut
 
	g»s
 = 
do_mod
 {

565 
äac_wÜd_to
 = 0;

566 
Ët
 
	gäac_út
 = 
cmp
::
max
(
lhs
.
äac_út
, 
rhs
.frac_cnt);

567 
	gRes
::
Ok
(
Decim®
::
Ãw
(0, 
äac_út
, 
lhs
.
Ãg©ive
))

569 
	gäac_wÜd_to
 = 
wÜd_út
!(
l_äac_út
 + 
r_äac_út
 + 
äac_šü
);

570 
Ët
 
	g»s
 = 
fix_wÜd_út_”r
(
št_wÜd_to
, 
äac_wÜd_to
, 
WORD_BUF_LEN
);

571 
Ët
 
	gšt_wÜd_to
 = 
»s
.0;

572 
	gäac_wÜd_to
 = 
»s
.1;

573 
	g»s
.
m­
(|
_
| {

574 
Decim®
::
Ãw
(

575 
št_wÜd_to
 * 
DIGITS_PER_WORD
,

576 
äac_wÜd_to
 * 
DIGITS_PER_WORD
,

577 
lhs
.
Ãg©ive
 !ğ
rhs
.negative,

581 
Ët
 
mut
 
	gidx_to
 = !
do_mod
 && 
št_út_to
 < 0 {

582 
cmp
::
mš
((-
št_út_to
è
as
 
u8
, 
WORD_BUF_LEN
)

586 
Ët
 
	gi
 = 
wÜd_út
!(
l_´ec
 
as
 
usize
, 
	gusize
);

587 
Ët
 
	gl_Ën
 = 
cmp
::
max
(

589 
i
 + 
wÜd_út
!(2 * 
r_äac_út
 + 
äac_šü
 + 1è
as
 
usize
 + 1,

591 
Ët
 
mut
 
	gbuf
 = 
vec
![0; 
l_Ën
];

592 (&
mut
 
	gbuf
[0..
i
]).
cİy_äom_¦iû
(&
lhs
.
wÜd_buf
[
l_idx
..l_idx + i]);

593 
Ët
 
mut
 
	gl_idx
 = 0;

594 
Ët
 (
r_¡¬t
, 
mut
 
r_¡İ
èğ(
r_idx
, 
	gr_idx
 + 
	gwÜd_út
!(
r_´ec
 
as
 
	gusize
, usize) - 1);

595 
	grhs
.
	gwÜd_buf
[
r_¡İ
] =ğ0 &&„_¡İ >ğ
r_¡¬t
 {

596 
r_¡İ
 -= 1;

598 
Ët
 
	gr_Ën
 = 
r_¡İ
 - 
r_¡¬t
;

599 
	gr_¡İ
 += 1;

601 
Ët
 
	gnÜm_çùÜ
 = (
WORD_BASE
 / (
rhs
.
wÜd_buf
[
r_¡¬t
] + 1)è
as
 
i64
;

602 
Ët
 
mut
 
	gr_nÜm
 = 
nÜm_çùÜ
 * 
rhs
.
wÜd_buf
[
r_¡¬t
] 
as
 
i64
;

603 
	gr_Ën
 > 0 {

604 
	gr_nÜm
 +ğ
nÜm_çùÜ
 * 
rhs
.
wÜd_buf
[
r_¡¬t
 + 1] 
as
 
i64
 / 
WORD_BASE
‡s i64;

606 
Ët
 
mut
 
	gdÿ¼y
 = 0;

607 
	gbuf
[
l_idx
] < 
	grhs
.
	gwÜd_buf
[
r_¡¬t
] {

608 
	gdÿ¼y
 = 
buf
[
l_idx
] 
as
 
i32
;

609 
	gl_idx
 += 1;

611 
Ët
 
mut
 
	gguess
;

612 
idx_to
 
š
 
	gidx_to
..
	gšt_wÜd_to
 + 
	gäac_wÜd_to
 {

613 
	gdÿ¼y
 =ğ0 && 
buf
[
l_idx
] < 
rhs
.
wÜd_buf
[
r_¡¬t
] {

614 
guess
 = 0;

616 
Ët
 
	gx
 = 
buf
[
l_idx
] 
as
 
i64
 + 
dÿ¼y
‡ i64 * 
WORD_BASE
‡s i64;

617 
Ët
 
	gy
 = 
buf
[
l_idx
 + 1] 
as
 
i64
;

618 
	gguess
 = (
nÜm_çùÜ
 * 
x
 +‚Üm_çùÜ * 
y
 / 
WORD_BASE
 
as
 
i64
è/ 
r_nÜm
;

619 
	gguess
 >ğ
WORD_BASE
 
as
 
i64
 {

620 
guess
 = 
WORD_BASE
 
as
 
i64
 - 1;

622 
	gr_Ën
 > 0 {

623 
	grhs
.
	gwÜd_buf
[
r_¡¬t
 + 1] 
as
 
i64
 * 
	gguess
 >

624 (
	gx
 - 
guess
 * 
	grhs
.
	gwÜd_buf
[
r_¡¬t
] 
as
 
	gi64
è* 
WORD_BASE
‡ i64 + 
	gy


626 
	gguess
 -= 1;

628 
	grhs
.
	gwÜd_buf
[
r_¡¬t
 + 1] 
as
 
i64
 * 
	gguess
 >

629 (
	gx
 - 
guess
 * 
	grhs
.
	gwÜd_buf
[
r_¡¬t
] 
as
 
	gi64
è* 
WORD_BASE
‡ i64 + 
	gy


631 
	gguess
 -= 1;

634 
Ët
 
mut
 
	gÿ¼y
 = 0;

635 
	gr_idx
, 
	gl_idx
è
š
 (
r_¡¬t
..
r_¡İ
).
»v
().
z
((0..l
_idx
 + 
r_Ën
 + 1).rev()) {

636 
Ët
 
	gx
 = 
guess
 * 
rhs
.
wÜd_buf
[
r_idx
] 
as
 
i64
;

637 
Ët
 
	ghi
 = 
x
 / 
WORD_BASE
 
as
 
i64
;

638 
Ët
 
	glo
 = 
x
 - 
hi
 * 
WORD_BASE
 
as
 
i64
;

639 
sub2
(
buf
[
l_idx
], 
lo
 
as
 
u32
, &
mut
 
ÿ¼y
, &mut buf[l_idx]);

640 
	gÿ¼y
 +ğ
hi
 
as
 
i32
;

642 
	gdÿ¼y
 < 
	gÿ¼y
 {

643 
	gÿ¼y
 = 1;

645 
	gÿ¼y
 = 0;

647 
	gÿ¼y
 > 0 {

648 
	gguess
 -= 1;

649 
Ët
 
mut
 
	gÿ¼y
 = 0;

650 
	gr_idx
, 
	gl_idx
è
š
 (
r_¡¬t
..
r_¡İ
).
»v
().
z
((0..l
_idx
 + 
r_Ën
 + 1).rev()) {

651 
add
(
buf
[
l_idx
], 
rhs
.
wÜd_buf
[
r_idx
], &
mut
 
ÿ¼y
, &mut buf[l_idx]);

655 !
	gdo_mod
 {

656 
	g»s
.
	gwÜd_buf
[
idx_to
 
as
 
usize
] = 
guess
‡ 
u32
;

658 
	gdÿ¼y
 = 
buf
[
l_idx
] 
as
 
i32
;

659 
	gl_idx
 += 1;

661 
	gdo_mod
 {

662 
	gdÿ¼y
 != 0 {

663 
l_idx
 -= 1;

664 
	gbuf
[
l_idx
] = 
dÿ¼y
 
as
 
u32
;

666 
	gidx_to
 = 0;

667 
Ët
 
mut
 
	gšt_wÜd_to
 = 
wÜd_út
!(
l_´ec
 - 
l_äac_út
è
as
 
i8
 - 
l_idx
‡s i8;

668 
Ët
 
mut
 
	gäac_wÜd_to
 = 
wÜd_út
!(
»s
.
äac_út
);

669 
	gšt_wÜd_to
 =ğ0 && 
äac_wÜd_to
 == 0 {

670 
lhs
.
»£t_to_z”o
();

671  
Some
(
Res
::
Ok
(
lhs
));

673 
Ët
 
mut
 
	gl_¡İ
;

674 
	gšt_wÜd_to
 <= 0 {

675 ià(-
št_wÜd_to
è
as
 
u8
 >ğ
WORD_BUF_LEN
 {

676 
lhs
.
»£t_to_z”o
();

677  
Some
(
Res
::
Trunÿ‹d
(
lhs
));

679 
	gl_¡İ
 = (
l_idx
 
as
 
i8
 + 
št_wÜd_to
 + 
äac_wÜd_to
‡ i8èa 
u8
;

680 
	gäac_wÜd_to
 = (
äac_wÜd_to
 
as
 
i8
 + 
št_wÜd_to
èa 
u8
;

681 
	g»s
.
	gšt_út
 = 0;

682 
	gšt_wÜd_to
 < 0 {

683 
	g»s
.
	gwÜd_buf
[
idx_to
 
as
 
usize
] = 0;

684 
	gidx_to
 += 1;

685 
	gšt_wÜd_to
 += 1;

688 
št_wÜd_to
 
as
 
	gu8
 > 
	gWORD_BUF_LEN
 {

689 
	g»s
.
	gšt_út
 = 
DIGITS_PER_WORD
 * 
WORD_BUF_LEN
;

690 
	g»s
.
	gäac_út
 = 0;

691  
Some
(
Res
::
Ov”æow
(
»s
.
unw¿p
()));

693 
	gl_¡İ
 = 
l_idx
 
as
 
u8
 + 
št_wÜd_to
‡ u8 + 
äac_wÜd_to
;

694 
	g»s
.
	gšt_út
 = 
cmp
::
mš
(
št_wÜd_to
 
as
 
u8
 * 
DIGITS_PER_WORD
, 
rhs
.
št_út
);

696 
št_wÜd_to
 
as
 
	gu8
 + 
	gäac_wÜd_to
 > 
	gWORD_BUF_LEN
 {

697 
	gl_¡İ
 -ğ
št_wÜd_to
 
as
 
u8
 + 
äac_wÜd_to
 - 
WORD_BUF_LEN
;

698 
	gäac_wÜd_to
 = 
WORD_BUF_LEN
 - 
št_wÜd_to
 
as
 
u8
;

699 
	g»s
.
	gäac_út
 = 
äac_wÜd_to
 - 
št_wÜd_to
 
as
 
u8
;

700 
	g»s
 = 
Res
::
Trunÿ‹d
(
»s
.
unw¿p
());

702 
idx
 
š
 
	gl_idx
..
l_¡İ
 
as
 
	gusize
 {

703 
	g»s
.
	gwÜd_buf
[
idx_to
 
as
 
usize
] = 
buf
[
idx
];

704 
	gidx_to
 += 1;

707 
Some
(
»s
)

711 
â
 
do_mul
(
lhs
: &
Decim®
, 
rhs
: &Decim®è-> 
Res
<Decimal> {

712 
Ët
 (
l_št_wÜd_út
, 
mut
 
l_äac_wÜd_út
) = (

713 
wÜd_út
!(
lhs
.
št_út
è
as
 
usize
,

714 
	gwÜd_út
!(
	glhs
.
	gäac_út
è
as
 
	gusize
,

716 
Ët
 (
mut
 
r_št_wÜd_út
, muˆ
r_äac_wÜd_út
) = (

717 
wÜd_út
!(
rhs
.
št_út
è
as
 
usize
,

718 
	gwÜd_út
!(
	grhs
.
	gäac_út
è
as
 
	gusize
,

720 
Ët
 (
št_wÜd_to
, 
äac_wÜd_to
) = (

721 
wÜd_út
!(
lhs
.
št_út
 + 
rhs
.št_útè
as
 
usize
,

722 
	gl_äac_wÜd_út
 + 
	gr_äac_wÜd_út
,

724 
Ët
 (
mut
 
Şd_št_wÜd_to
, muˆ
Şd_äac_wÜd_to
èğ(
št_wÜd_to
, 
	gäac_wÜd_to
);

725 
Ët
 
	g»s
 = 
fix_wÜd_út_”r
(
št_wÜd_to
 
as
 
u8
, 
äac_wÜd_to
‡ u8, 
WORD_BUF_LEN
);

726 
Ët
 (
št_wÜd_to
, 
äac_wÜd_to
èğ(
»s
.0 
as
 
usize
, 
	g»s
.1‡ 
	gusize
);

727 
Ët
 
	gÃg©ive
 = 
lhs
.
Ãg©ive
 !ğ
rhs
.negative;

728 
Ët
 
	gäac_út
 = 
cmp
::
mš
(
lhs
.
äac_út
 + 
rhs
.äac_út, 
NOT_FIXED_DEC
);

729 
Ët
 
	gšt_út
 = 
št_wÜd_to
 
as
 
u8
 * 
DIGITS_PER_WORD
;

730 
Ët
 
mut
 
	gdec
 = 
Decim®
::
Ãw
(
št_út
, 
äac_út
, 
Ãg©ive
);

731 
	gdec
.
	g»suÉ_äac_út
 = 
cmp
::
mš
(
lhs
.
»suÉ_äac_út
 + 
rhs
.»suÉ_äac_út, 
MAX_FRACTION
);

732 
	g»s
.
is_ov”æow
() {

733  
	gRes
::
Ov”æow
(
dec
);

736 !
	g»s
.
is_ok
() {

737 
	gdec
.
	gäac_út
 = 
cmp
::
mš
(
dec
.
äac_út
, 
äac_wÜd_to
 
as
 
u8
 * 
DIGITS_PER_WORD
);

738 
	gŞd_št_wÜd_to
 > 
	gšt_wÜd_to
 {

739 
	gŞd_št_wÜd_to
 -ğ
št_wÜd_to
;

740 
	gŞd_äac_wÜd_to
 = 
Şd_št_wÜd_to
 / 2;

741 
	gr_št_wÜd_út
 = 
Şd_št_wÜd_to
 - 
Şd_äac_wÜd_to
;

742 
	gl_äac_wÜd_út
 = 0;

743 
	gr_äac_wÜd_út
 = 0;

745 
	gŞd_äac_wÜd_to
 -ğ
št_wÜd_to
;

746 
	gŞd_št_wÜd_to
 = 
Şd_äac_wÜd_to
 / 2;

747 
	gl_äac_wÜd_út
 <ğ
r_äac_wÜd_út
 {

748 
l_äac_wÜd_út
 -ğ
Şd_št_wÜd_to
;

749 
	gr_äac_wÜd_út
 -ğ
Şd_äac_wÜd_to
 - 
Şd_št_wÜd_to
;

751 
	gr_äac_wÜd_út
 -ğ
Şd_št_wÜd_to
;

752 
	gl_äac_wÜd_út
 -ğ
Şd_äac_wÜd_to
 - 
Şd_št_wÜd_to
;

757 
Ët
 
mut
 
	g¡¬t_to
 = 
št_wÜd_to
 + 
äac_wÜd_to
;

758 
Ët
 
	gr_¡¬t
 = 
r_št_wÜd_út
 + 
r_äac_wÜd_út
;

759 
l_idx
 
š
 (0..l
_št_wÜd_út
 + 
l_äac_wÜd_út
).
»v
() {

760 
	gas£¹
!(
	g¡¬t_to
 >ğ
r_¡¬t
);

761 
Ët
 (
mut
 
ÿ¼y
, muˆ
idx_to
èğ(0, 
	g¡¬t_to
);

762 
	g¡¬t_to
 -= 1;

763 
r_idx
 
š
 (0..
r_¡¬t
).
»v
() {

764 
	gidx_to
 -= 1;

765 
Ët
 
	gp
 = 
lhs
.
wÜd_buf
[
l_idx
] 
as
 
u64
 * 
rhs
.wÜd_buf[
r_idx
]‡s u64;

766 
Ët
 
	ghi
 = 
p
 / 
WORD_BASE
 
as
 
u64
;

767 
Ët
 
	glo
 = 
p
 - 
hi
 * 
WORD_BASE
 
as
 
u64
;

768 
add
(

769 
dec
.
wÜd_buf
[
idx_to
],

770 
lo
 
as
 
u32
,

771 &
mut
 
ÿ¼y
,

772 &
mut
 
dec
.
wÜd_buf
[
idx_to
],

774 
	gÿ¼y
 +ğ
hi
 
as
 
u32
;

776 
	gÿ¼y
 > 0 {

777 
	gidx_to
 == 0 {

778  
Res
::
Ov”æow
(
dec
);

780 
	gidx_to
 -= 1;

781 
add
(

782 
dec
.
wÜd_buf
[
idx_to
],

784 &
mut
 
ÿ¼y
,

785 &
mut
 
dec
.
wÜd_buf
[
idx_to
],

791 
	gdec
.
	gÃg©ive
 {

792 
Ët
 (
mut
 
idx
, 
’d
èğ(0, 
	gšt_wÜd_to
 + 
	gäac_wÜd_to
);

793 
	gdec
.
	gwÜd_buf
[
idx
] == 0 {

794 
idx
 += 1;

795 
	gidx
 =ğ
’d
 {

797 
dec
.
»£t_to_z”o
();

803 
Ët
 (
mut
 
idx_to
, muˆ
d_to_move
èğ(0, 
	gšt_wÜd_to
 + 
	gwÜd_út
!(
	gdec
.
	gäac_út
è
as
 
	gusize
);

804 
	gdec
.
	gwÜd_buf
[
idx_to
] =ğ0 && 
dec
.
št_út
 > 
DIGITS_PER_WORD
 {

805 
idx_to
 += 1;

806 
	gdec
.
	gšt_út
 -ğ
DIGITS_PER_WORD
;

807 
	gd_to_move
 -= 1;

809 
	gidx_to
 > 0 {

810 
cur_idx
 
	gš
 0..d
	g_to_move
 {

811 
	gdec
.
	gwÜd_buf
[
cur_idx
] = 
dec
.
wÜd_buf
[
idx_to
];

812 
	gidx_to
 += 1;

815 
	g»s
.
m­
(|
_
| 
dec
)

819 #[
d”ive
(
ClÚe
, 
Debug
)]

820 
pub
 
	sDecim®
 {

822 
	mšt_út
: 
u8
,

825 
	mäac_út
: 
u8
,

828 
	m´ecisiÚ
: 
u8
,

830 
	m»suÉ_äac_út
: 
u8
,

832 
	mÃg©ive
: 
boŞ
,

836 
	mwÜd_buf
: 
Box
<[
u32
]>,

839 #[
d”ive
(
Debug
)]

840 
pub
 
	eRoundMode
 {

842 
	mH®fEv’
,

844 
	mTrunÿ‹
,

846 
	mCešg
,

849 
im¶
 
	gDecim®
 {

851 #[
šlše
]

852 
pub
 
â
 
abs
(
mut
 
£lf
è-> 
	gRes
<
	gDecim®
> {

853 
	g£lf
.
	gÃg©ive
 = 
çl£
;

854 
	gRes
::
Ok
(
£lf
)

858 
pub
 
â
 
û
(&
£lf
è-> 
Res
<
Decim®
> {

859 !
£lf
.
Ãg©ive
 {

860 
£lf
.
şÚe
().
round
(0, 
RoundMode
::
Cešg
)

862 
£lf
.
şÚe
().
round
(0, 
RoundMode
::
Trunÿ‹
)

867 
pub
 
â
 
æoÜ
(&
£lf
è-> 
Res
<
Decim®
> {

868 !
£lf
.
Ãg©ive
 {

869 
£lf
.
şÚe
().
round
(0, 
RoundMode
::
Trunÿ‹
)

871 
£lf
.
şÚe
().
round
(0, 
RoundMode
::
Cešg
)

876 
â
 
Ãw
(
št_út
: 
u8
, 
äac_út
: u8, 
Ãg©ive
: 
boŞ
è-> 
Decim®
 {

877 
Decim®
 {

878 
št_út
: int_cnt,

879 
	gäac_út
: 
äac_út
,

880 
	g´ecisiÚ
: 0,

881 
	g»suÉ_äac_út
: 0,

882 
	gÃg©ive
: 
Ãg©ive
,

883 
	gwÜd_buf
: 
Box
::
Ãw
([0; 9]),

888 
â
 
»£t_to_z”o
(&
mut
 
£lf
) {

889 
	g£lf
.
	gšt_út
 = 1;

890 
	g£lf
.
	gäac_út
 = 0;

891 
	g£lf
.
	g»suÉ_äac_út
 = 0;

892 
	g£lf
.
	gÃg©ive
 = 
çl£
;

893 
	g£lf
.
	gwÜd_buf
[0] = 0;

897 
â
 
»move_Ëadšg_z”Ûs
(&
£lf
è-> (
	gusize
, 
	gu8
) {

898 
Ët
 
mut
 
	gšt_út
 = 
£lf
.
št_út
;

899 
Ët
 
mut
 
	gi
 = ((
št_út
 + 
DIGITS_PER_WORD
 - 1) % DIGITS_PER_WORD) + 1;

900 
Ët
 
mut
 
	gwÜd_idx
 = 0;

901 
	gšt_út
 > 0 && 
	g£lf
.
	gwÜd_buf
[
wÜd_idx
] == 0 {

902 
št_út
 -ğ
i
;

903 
	gi
 = 
DIGITS_PER_WORD
;

904 
	gwÜd_idx
 += 1;

906 
	gšt_út
 > 0 {

907 
	gšt_út
 -=

908 
couÁ_Ëadšg_z”Ûs
((
št_út
 - 1è% 
DIGITS_PER_WORD
, 
£lf
.
wÜd_buf
[
wÜd_idx
])

910 (
	gwÜd_idx
, 
	gšt_út
)

914 
â
 
´•¬e_buf
(&
£lf
è-> (
	gVec
<
	gu8
>, 
	gusize
, u8, u8, u8) {

915 
Ët
 
	gäac_út
 = 
£lf
.
äac_út
;

916 
Ët
 (
mut
 
wÜd_¡¬t_idx
, muˆ
št_út
èğ
£lf
.
»move_Ëadšg_z”Ûs
();

917 
	gšt_út
 + 
	gäac_út
 == 0 {

918 
št_út
 = 1;

919 
	gwÜd_¡¬t_idx
 = 0;

921 
Ët
 
	gšt_Ën
 = 
cmp
::
max
(1, 
št_út
);

922 
Ët
 
	gäac_Ën
 = 
äac_út
;

923 
Ët
 
mut
 
	gËn
 = 
št_Ën
 + 
äac_Ën
;

924 
	g£lf
.
	gÃg©ive
 {

925 
	gËn
 += 1;

927 
	gäac_út
 > 0 {

928 
	gËn
 += 1;

930 
Ët
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(
Ën
 
as
 
usize
);

931 (
	gbuf
, 
	gwÜd_¡¬t_idx
, 
	gšt_Ën
, 
	gšt_út
, 
	gäac_út
)

935 
â
 
to_¡ršg
(&
£lf
è-> 
	gSŒšg
 {

936 
Ët
 (
mut
 
buf
, 
wÜd_¡¬t_idx
, 
št_Ën
, 
št_út
, 
äac_út
èğ
£lf
.
´•¬e_buf
();

937 
	g£lf
.
	gÃg©ive
 {

938 
	gbuf
.
push
(
b
'-');

940 
_
 
	gš
 0..
	gšt_Ën
 - 
	gcmp
::
max
(
št_út
, 1) {

941 
	gbuf
.
push
(
b
'0');

943 
	gšt_út
 > 0 {

944 
Ët
 
	gba£_idx
 = 
buf
.
Ën
();

945 
Ët
 
mut
 
	gidx
 = 
ba£_idx
 + 
št_út
 
as
 
usize
;

946 
Ët
 
mut
 
	gwidx
 = 
wÜd_¡¬t_idx
 + 
wÜd_út
!(
št_út
è
as
 
usize
;

947 
	gbuf
.
»size
(
idx
, 0);

948 
	gidx
 > 
	gba£_idx
 {

949 
	gwidx
 -= 1;

950 
Ët
 
mut
 
	gx
 = 
£lf
.
wÜd_buf
[
widx
];

951 
_
 
	gš
 0..c
	gmp
::
mš
((
idx
 - 
ba£_idx
è
as
 
u8
, 
DIGITS_PER_WORD
) {

952 
	gidx
 -= 1;

953 
	gbuf
[
idx
] = 
b
'0' + (
x
 % 10è
as
 
u8
;

954 
	gx
 /= 10;

958 
	gbuf
.
push
(
b
'0');

960 
	gäac_út
 > 0 {

961 
	gbuf
.
push
(
b
'.');

962 
Ët
 
mut
 
	gwidx
 = 
wÜd_¡¬t_idx
 + 
wÜd_út
!(
št_út
è
as
 
usize
;

963 
Ët
 
	gexp_idx
 = 
buf
.
Ën
(è+ 
äac_út
 
as
 
usize
;

964 
	gbuf
.
Ën
(è< 
	gexp_idx
 {

965 
Ët
 
mut
 
	gx
 = 
£lf
.
wÜd_buf
[
widx
];

966 
_
 
	gš
 0..c
	gmp
::
mš
((
exp_idx
 - 
buf
.
Ën
()è
as
 
u8
, 
DIGITS_PER_WORD
) {

967 
	gbuf
.
push
((
x
 / 
DIG_MASK
è
as
 
u8
 + 
b
'0');

968 
	gx
 = (
x
 % 
DIG_MASK
) * 10;

970 
	gwidx
 += 1;

972 
	gbuf
.
ÿ·c™y
(è!ğ
buf
.
Ën
() {

973 
buf
.
push
(
b
'0');

976 
	gun§ã
 { 
	gSŒšg
::
äom_utf8_unchecked
(
buf
) }

980 
pub
 
â
 
´ec_ªd_äac
(&
£lf
è-> (
u8
, 
	gu8
) {

981 
	g£lf
.
	g´ecisiÚ
 == 0 {

982 
Ët
 (
_
, 
št_út
èğ
£lf
.
»move_Ëadšg_z”Ûs
();

983 
Ët
 
	g´ec
 = 
št_út
 + 
£lf
.
äac_út
;

984 
	g´ec
 == 0 {

985 (1, 
£lf
.
äac_út
)

987 (
´ec
, 
£lf
.
äac_út
)

990 (
	g£lf
.
	g´ecisiÚ
, s–f.
	g»suÉ_äac_út
)

995 
â
 
dig™_bounds
(&
£lf
è-> (
	gu8
, u8) {

996 
Ët
 
mut
 
	gbuf_beg
 = 0;

997 
Ët
 
	gbuf_Ën
 = (
wÜd_út
!(
£lf
.
št_út
è+ wÜd_út!(£lf.
äac_út
)è
as
 
usize
;

998 
Ët
 
mut
 
	gbuf_’d
 = 
buf_Ën
 - 1;

1000 
	gbuf_beg
 < 
	gbuf_Ën
 && 
	g£lf
.
	gwÜd_buf
[
buf_beg
] == 0 {

1001 
buf_beg
 += 1;

1003 
	gbuf_beg
 >ğ
buf_Ën
 {

1007 
Ët
 
mut
 
	gi
;

1008 
Ët
 
mut
 
	g¡¬t
 = 
buf_beg
 =ğ0 && 
£lf
.
št_út
 > 0 {

1009 
i
 = (
£lf
.
št_út
 - 1è% 
DIGITS_PER_WORD
;

1010 
	gDIGITS_PER_WORD
 - 
	gi
 - 1

1012 
	gi
 = 
DIGITS_PER_WORD
 - 1;

1013 
buf_beg
 
as
 
u8
 * 
	gDIGITS_PER_WORD


1015 
	gbuf_beg
 < 
	gbuf_Ën
 {

1016 
	g¡¬t
 +ğ
couÁ_Ëadšg_z”Ûs
(
i
, 
£lf
.
wÜd_buf
[
buf_beg
]);

1019 
	gbuf_’d
 > 
	gbuf_beg
 && 
	g£lf
.
	gwÜd_buf
[
buf_’d
] == 0 {

1020 
buf_’d
 -= 1;

1022 
Ët
 (
i
, 
mut
 
’d
èğ
buf_’d
 =ğ
buf_Ën
 - 1 && 
£lf
.
äac_út
 > 0 {

1023 
i
 = (
£lf
.
äac_út
 - 1è% 
DIGITS_PER_WORD
 + 1;

1024 (
	gDIGITS_PER_WORD
 - 
	gi
 + 1, 
buf_’d
 
as
 
u8
 * DIGITS_PER_WORD + i)

1026 (1, (
buf_’d
 
as
 
	gu8
 + 1è* 
	gDIGITS_PER_WORD
)

1028 
	g’d
 -ğ
couÁ_Œašg_z”Ûs
(
i
, 
£lf
.
wÜd_buf
[
buf_’d
]);

1029 (
	g¡¬t
, 
	g’d
)

1036 
â
 
do_mši_Ëá_shiá
(&
mut
 
£lf
, 
shiá
: 
u8
, 
beg
: u8, 
’d
: u8) {

1037 
Ët
 
shiá
 = shiá 
as
 
usize
;

1038 
Ët
 
mut
 
	gbuf_äom
 = (
beg
 / 
DIGITS_PER_WORD
è
as
 
usize
;

1039 
Ët
 
	gbuf_’d
 = ((
’d
 - 1è/ 
DIGITS_PER_WORD
è
as
 
usize
;

1040 
Ët
 
	gc_shiá
 = 
DIGITS_PER_WORD
 
as
 
usize
 - 
shiá
;

1041 
	gbeg
 % 
	gDIGITS_PER_WORD
 < 
shiá
 
as
 
	gu8
 {

1042 
	g£lf
.
	gwÜd_buf
[
buf_äom
 - 1] = 
£lf
.
wÜd_buf
[buf_äom] / 
TEN_POW
[
c_shiá
];

1044 
	gbuf_äom
 < 
	gbuf_’d
 {

1045 
	g£lf
.
	gwÜd_buf
[
buf_äom
] = (
£lf
.
wÜd_buf
[buf_äom] % 
TEN_POW
[
c_shiá
]) *

1046 
TEN_POW
[
shiá
] +

1047 
£lf
.
wÜd_buf
[
buf_äom
 + 1] / 
TEN_POW
[
c_shiá
];

1048 
	gbuf_äom
 += 1;

1050 
	g£lf
.
	gwÜd_buf
[
buf_äom
] = (
£lf
.
wÜd_buf
[buf_äom] % 
TEN_POW
[
c_shiá
]è* TEN_POW[
shiá
];

1057 
â
 
do_mši_right_shiá
(&
mut
 
£lf
, 
shiá
: 
u8
, 
beg
: u8, 
’d
: u8) {

1058 
Ët
 
shiá
 = shiá 
as
 
usize
;

1059 
Ët
 
mut
 
	gbuf_äom
 = ((
’d
 - 1è/ 
DIGITS_PER_WORD
è
as
 
usize
;

1060 
Ët
 
	gbuf_’d
 = (
beg
 / 
DIGITS_PER_WORD
è
as
 
usize
;

1061 
Ët
 
	gc_shiá
 = 
DIGITS_PER_WORD
 
as
 
usize
 - 
shiá
;

1062 
	gDIGITS_PER_WORD
 - ((
	g’d
 - 1è% DIGITS_PER_WORD + 1è< 
shiá
 
as
 
	gu8
 {

1063 
	g£lf
.
	gwÜd_buf
[
buf_äom
 + 1] =

1064 (
£lf
.
wÜd_buf
[
buf_äom
] % 
TEN_POW
[
shiá
]è* TEN_POW[
c_shiá
];

1066 
	gbuf_äom
 > 
	gbuf_’d
 {

1067 
	g£lf
.
	gwÜd_buf
[
buf_äom
] = 
£lf
.
wÜd_buf
[buf_äom] / 
TEN_POW
[
shiá
] +

1068 (
£lf
.
wÜd_buf
[
buf_äom
 - 1] % 
TEN_POW
[
shiá
]è* TEN_POW[
c_shiá
];

1069 
	gbuf_äom
 -= 1;

1071 
	g£lf
.
	gwÜd_buf
[
buf_äom
] /ğ
TEN_POW
[
shiá
];

1076 
pub
 
â
 
cÚv”t_to
(
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
æ’
: 
u8
, 
decim®
: u8è-> 
ResuÉ
<
Decim®
> {

1077 
Ët
 (
´ec
, 
äac
èğ
£lf
.
´ec_ªd_äac
();

1078 !
	g£lf
.
is_z”o
(è&& 
	g´ec
 - 
	gäac
 > 
	gæ’
 - 
	gdecim®
 {

1079  
Ok
(
max_Ü_mš_dec
(
£lf
.
Ãg©ive
, 
æ’
, 
decim®
));

1083 
	gäac
 =ğ
decim®
 {

1084  
Ok
(
£lf
);

1087 
Ët
 
	gtmp
 = 
£lf
.
şÚe
();

1088 
Ët
 
	g»t
 = 
£lf
.
round
(
decim®
 
as
 
i8
, 
RoundMode
::
H®fEv’
).
unw¿p
();

1090 !
	g»t
.
is_z”o
(è&& 
	gäac
 > 
	gdecim®
 &&„‘ !ğ
tmp
 {

1092 
cÚv”t
::
hªdË_Œunÿ‹
(
ùx
, 
Œue
)?;

1094 
Ok
(
»t
)

1102 
pub
 
â
 
round
(
£lf
, 
äac
: 
i8
, 
round_mode
: 
RoundMode
è-> 
Res
<
Decim®
> {

1103 
£lf
.
round_w™h_wÜd_buf_Ën
(
äac
, 
WORD_BUF_LEN
, 
round_mode
)

1106 
pub
 
â
 
round_w™h_wÜd_buf_Ën
(

1107 
mut
 
£lf
,

1108 
mut
 
äac
: 
i8
,

1109 
wÜd_buf_Ën
: 
u8
,

1110 
round_mode
: 
RoundMode
,

1111 è-> 
	gRes
<
	gDecim®
> {

1112 
	gäac
 > 
MAX_FRACTION
 
as
 
	gi8
 {

1113 
	gäac
 = 
MAX_FRACTION
 
as
 
i8
;

1115 
Ët
 
mut
 
	gäac_wÜds_to
 = 
äac
 > 0 {

1116 
wÜd_út
!(
äac
, 
i8
)

1118 (
äac
 + 1è/ 
DIGITS_PER_WORD
 
as
 
i8


1120 
Ët
 (
št_wÜd_út
, 
äac_wÜd_út
èğ(
wÜd_út
!(
£lf
.
št_út
), 
	gwÜd_út
!(
	g£lf
.
	gäac_út
));

1122 
Ët
 
mut
 
	g»s
 = 
št_wÜd_út
 
as
 
i8
 + 
äac_wÜds_to
 > 
wÜd_buf_Ën
‡s i8 {

1123 
äac_wÜds_to
 = 
wÜd_buf_Ën
 
as
 
i8
 - 
št_wÜd_út
‡s i8;

1124 
	gäac
 = 
äac_wÜds_to
 * 
DIGITS_PER_WORD
 
as
 
i8
;

1125 
	gRes
::
Trunÿ‹d
(
£lf
)

1126 } 
£lf
.
št_út
 
as
 
i8
 + 
äac
 < 0 {

1127 
£lf
.
»£t_to_z”o
();

1128  
	gRes
::
Ok
(
£lf
);

1130 
	gRes
::
Ok
(
£lf
)

1132 
	g»s
.
	gšt_út
 = 
cmp
::
mš
(
št_wÜd_út
, 
wÜd_buf_Ën
è* 
	gDIGITS_PER_WORD
;

1133 
	gäac_wÜds_to
 > 
äac_wÜd_út
 
as
 
	gi8
 {

1134 
idx
 
š
 
	gšt_wÜd_út
 + 
	gäac_wÜd_út
..št_wÜd_úˆ+ 
äac_wÜds_to
 
as
 
	gu8
 {

1135 
	g»s
.
	gwÜd_buf
[
idx
 
as
 
usize
] = 0;

1137 
	g»s
.
	gäac_út
 = 
äac
 
as
 
u8
;

1138  
	g»s
;

1140 
	gäac
 >ğ
»s
.
äac_út
 
as
 
i8
 {

1141 
»s
.
äac_út
 = 
äac
 
as
 
u8
;

1142  
	g»s
;

1145 
	gDecim®
::
hªdË_šü
(

1146 
»s
,

1147 
št_wÜd_út
,

1148 
äac_wÜds_to
,

1149 
äac
,

1150 
äac_wÜd_út
,

1151 
wÜd_buf_Ën
,

1152 
round_mode
,

1156 
â
 
hªdË_šü
(

1157 
mut
 
»s
: 
Res
<
Decim®
>,

1158 
št_wÜd_út
: 
u8
,

1159 
äac_wÜds_to
: 
i8
,

1160 
äac
: 
i8
,

1161 
äac_wÜd_út
: 
u8
,

1162 
wÜd_buf_Ën
: 
u8
,

1163 
round_mode
: 
RoundMode
,

1164 è-> 
	gRes
<
	gDecim®
> {

1166 
Ët
 
mut
 
	gto_idx
 = 
št_wÜd_út
 
as
 
i8
 + 
äac_wÜds_to
 - 1;

1167 
	gäac
 =ğ
äac_wÜds_to
 * 
DIGITS_PER_WORD
 
as
 
i8
 {

1168 
Ët
 
do_šc
 = 
m©ch
 
round_mode
 {

1170 
RoundMode
::
Cešg
 => {

1173 
Ët
 
idx
 = 
to_idx
 + 
äac_wÜd_út
 
as
 
i8
 - 
äac_wÜds_to
;

1174 
	gidx
 > 
	gto_idx
 {

1175 
	g»s
.
	gwÜd_buf
[(
to_idx
 + 1è
as
 
usize
..(
idx
‡s usize + 1)]

1176 .
™”
()

1177 .
ªy
(|
c
| *c != 0)

1179 
	gçl£


1182 
	gRoundMode
::
H®fEv’
 => {

1185 
»s
.
wÜd_buf
[(
to_idx
 + 1è
as
 
usize
] / 
DIG_MASK
 >= 5

1187 
RoundMode
::
Trunÿ‹
 => 
çl£
,

1189 
	gdo_šc
 {

1190 
	gto_idx
 >= 0 {

1191 
»s
.
wÜd_buf
[
to_idx
 
as
 
usize
] += 1;

1193 
	gto_idx
 += 1;

1194 
	g»s
.
	gwÜd_buf
[
to_idx
 
as
 
usize
] = 
WORD_BASE
;

1196 } 
št_wÜd_út
 
as
 
	gi8
 + 
	gäac_wÜds_to
 == 0 {

1197 
»s
.
»£t_to_z”o
();

1198  
	gRes
::
Ok
(
»s
.
unw¿p
());

1202 
Ët
 
	gpos
 = (
äac_wÜds_to
 * 
DIGITS_PER_WORD
 
as
 
i8
 - 
äac
 - 1èa 
usize
;

1203 
Ët
 
mut
 
	gshiáed_numb”
 = 
»s
.
wÜd_buf
[
to_idx
 
as
 
usize
] / 
TEN_POW
[
pos
];

1204 
Ët
 
	gdig_aá”_sÿË
 = 
shiáed_numb”
 % 10;

1205 
Ët
 
	ground_dig™
 = 
m©ch
 
round_mode
 {

1206 
RoundMode
::
Cešg
 => 0,

1207 
	gRoundMode
::
H®fEv’
 => 5,

1208 
	gRoundMode
::
Trunÿ‹
 => 10,

1210 
	gdig_aá”_sÿË
 > 
	ground_dig™
 || (round_dig™ =ğ5 && 
dig_aá”_sÿË
 == 5) {

1211 
shiáed_numb”
 += 10;

1213 
	g»s
.
	gwÜd_buf
[
to_idx
 
as
 
usize
] = 
TEN_POW
[
pos
] * (
shiáed_numb”
 - 
dig_aá”_sÿË
);

1216 
	gäac_wÜds_to
 < 
äac_wÜd_út
 
as
 
	gi8
 {

1217 
Ët
 
	gidx
 = 
äac
 =ğ0 && 
št_wÜd_út
 == 0 {

1220 (
št_wÜd_út
 
as
 
i8
 + 
äac_wÜds_to
èa 
usize


1222 
i
 
š
 
	gidx
..
wÜd_buf_Ën
 
as
 
	gusize
 {

1223 
	g»s
.
	gwÜd_buf
[
i
] = 0;

1227 
	gDecim®
::
hªdË_ÿ¼y
(

1228 
»s
,

1229 
to_idx
 
as
 
usize
,

1230 
äac
,

1231 
äac_wÜds_to
,

1232 
št_wÜd_út
,

1233 
wÜd_buf_Ën
,

1237 
â
 
hªdË_ÿ¼y
(

1238 
mut
 
dec
: 
Res
<
Decim®
>,

1239 
mut
 
to_idx
: 
usize
,

1240 
mut
 
äac
: 
i8
,

1241 
mut
 
äac_wÜd_to
: 
i8
,

1242 
št_wÜd_út
: 
u8
,

1243 
wÜd_buf_Ën
: 
u8
,

1244 è-> 
	gRes
<
	gDecim®
> {

1245 
	gdec
.
	gwÜd_buf
[
to_idx
] >ğ
WORD_BASE
 {

1246 
Ët
 
mut
 
ÿ¼y
 = 1;

1247 
	gdec
.
	gwÜd_buf
[
to_idx
] -ğ
WORD_BASE
;

1248 
	gÿ¼y
 =ğ1 && 
to_idx
 > 0 {

1249 
to_idx
 -= 1;

1250 
add
(

1251 
dec
.
wÜd_buf
[
to_idx
],

1253 &
mut
 
ÿ¼y
,

1254 &
mut
 
dec
.
wÜd_buf
[
to_idx
],

1257 
	gÿ¼y
 > 0 {

1258 
št_wÜd_út
 
as
 
	gi8
 + 
	gäac_wÜd_to
 >ğ
wÜd_buf_Ën
‡ 
i8
 {

1259 
äac_wÜd_to
 -= 1;

1260 
	gäac
 = 
äac_wÜd_to
 * 
DIGITS_PER_WORD
 
as
 
i8
;

1261 
	gdec
 = 
Res
::
Trunÿ‹d
(
dec
.
unw¿p
());

1263 
i
 
š
 (0..
št_wÜd_út
 
as
 
usize
 + 
cmp
::
max
(
äac_wÜd_to
, 0èa usize).
»v
() {

1264 
	gi
 + 1 < 
wÜd_buf_Ën
 
as
 
	gusize
 {

1265 
	gdec
.
	gwÜd_buf
[
i
 + 1] = 
dec
.
wÜd_buf
[i];

1266 } !
	gdec
.
is_ov”æow
() {

1267 
	gdec
 = 
Res
::
Ov”æow
(
dec
.
unw¿p
());

1270 
	gto_idx
 = 0;

1271 
	gdec
.
	gwÜd_buf
[0] = 1;

1272 
	gdec
.
	gšt_út
 < 
DIGITS_PER_WORD
 * 
	gwÜd_buf_Ën
 {

1273 
	gdec
.
	gšt_út
 += 1;

1275 
	gdec
 = 
Res
::
Ov”æow
(
dec
.
unw¿p
());

1279 
	gdec
.
	gwÜd_buf
[
to_idx
] == 0 {

1280 
to_idx
 == 0 {

1281 
Ët
 
idx
 = 
äac_wÜd_to
 + 1;

1282 
	gdec
.
	gšt_út
 = 1;

1283 
	gdec
.
	gÃg©ive
 = 
çl£
;

1284 
	gdec
.
	gäac_út
 = 
cmp
::
max
(0, 
äac
è
as
 
	gu8
;

1285 
i
 
	gš
 0..
	gidx
 {

1286 
	gdec
.
	gwÜd_buf
[
i
 
as
 
usize
] = 0;

1288  
	gRes
::
Ok
(
dec
.
unw¿p
());

1290 
	gto_idx
 -= 1;

1293 
Ët
 
	gfœ¡_dig
 = 
dec
.
št_út
 % 
DIGITS_PER_WORD
;

1294 
	gfœ¡_dig
 > 0 && 
	gdec
.
	gwÜd_buf
[
to_idx
] >ğ
TEN_POW
[
fœ¡_dig
 
as
 
usize
] {

1295 
dec
.
št_út
 += 1;

1297 
	gdec
.
	gäac_út
 = 
cmp
::
max
(0, 
äac
è
as
 
	gu8
;

1298 
	gdec


1305 
pub
 
â
 
shiá
(
£lf
, shiá: 
isize
è-> 
Res
<
Decim®
> {

1306 
£lf
.
shiá_w™h_wÜd_buf_Ën
(
shiá
, 
WORD_BUF_LEN
)

1309 
â
 
shiá_w™h_wÜd_buf_Ën
(
mut
 
£lf
, 
shiá
: 
isize
, 
wÜd_buf_Ën
: 
u8
è-> 
Res
<
Decim®
> {

1310 
shiá
 == 0 {

1311  
Res
::
Ok
(
£lf
);

1313 
Ët
 (
mut
 
beg
, muˆ
’d
èğ
£lf
.
dig™_bounds
();

1314 
	gbeg
 =ğ
’d
 {

1315 
£lf
.
»£t_to_z”o
();

1316  
	gRes
::
Ok
(
£lf
);

1319 
Ët
 
	gpošt
 = 
wÜd_út
!(
£lf
.
št_út
è* 
DIGITS_PER_WORD
;

1320 
Ët
 
mut
 
	gÃw_pošt
 = 
pošt
 
as
 
isize
 + 
shiá
;

1321 
Ët
 
	gšt_út
 = 
Ãw_pošt
 < 
beg
 
as
 
isize
 {

1324 
Ãw_pošt
 - 
beg
 
as
 
isize


1326 
Ët
 
mut
 
	gäac_út
 = 
Ãw_pošt
 > 
’d
 
as
 
isize
 {

1329 
’d
 
as
 
isize
 - 
Ãw_pošt


1331 
Ët
 
	gšt_wÜd_út
 = 
wÜd_út
!(
št_út
, 
	gisize
);

1332 
Ët
 
mut
 
	gäac_wÜd_út
 = 
wÜd_út
!(
äac_út
, 
	gisize
);

1333 
Ët
 
	gÃw_Ën
 = 
št_wÜd_út
 + 
äac_wÜd_út
;

1334 
Ët
 
mut
 
	g»s
 = 
Ãw_Ën
 > 
wÜd_buf_Ën
 
as
 
isize
 {

1335 
Ët
 
Ïck
 = 
Ãw_Ën
 - 
wÜd_buf_Ën
 
as
 
isize
;

1336 
	gäac_wÜd_út
 < 
	gÏck
 {

1337  
	gRes
::
Ov”æow
(
£lf
);

1339 
	gäac_wÜd_út
 -ğ
Ïck
;

1340 
Ët
 
	gdiff
 = 
äac_út
 - 
äac_wÜd_út
 * 
DIGITS_PER_WORD
 
as
 
isize
;

1341 
	gäac_út
 = 
äac_wÜd_út
 * 
DIGITS_PER_WORD
 
as
 
isize
;

1342 
’d
 
as
 
	gisize
 - 
	gdiff
 <ğ
beg
‡ 
isize
 {

1343 
£lf
.
»£t_to_z”o
();

1344  
	gRes
::
Trunÿ‹d
(
£lf
);

1346 
	g’d
 = (
’d
 
as
 
isize
 - 
diff
èa 
u8
;

1347 
	gRes
::
Trunÿ‹d
(

1348 
£lf
.
round_w™h_wÜd_buf_Ën
(

1349 
’d
 
as
 
i8
 - 
pošt
‡s i8,

1350 
wÜd_buf_Ën
,

1351 
RoundMode
::
H®fEv’
,

1352 ).
unw¿p
(),

1355 
	gRes
::
Ok
(
£lf
)

1358 
	gshiá
 % 
DIGITS_PER_WORD
 
as
 
	gisize
 != 0 {

1359 
Ët
 (
l_mši_shiá
, 
r_mši_shiá
, 
mši_shiá
, 
do_Ëá
);

1360 
	gshiá
 > 0 {

1361 
	gl_mši_shiá
 = (
shiá
 % 
DIGITS_PER_WORD
 
as
 
isize
èa 
u8
;

1362 
	gr_mši_shiá
 = 
DIGITS_PER_WORD
 - 
l_mši_shiá
;

1363 
	gdo_Ëá
 = 
l_mši_shiá
 <ğ
beg
;

1365 
	gr_mši_shiá
 = ((-
shiá
è% 
DIGITS_PER_WORD
 
as
 
isize
èa 
u8
;

1366 
	gl_mši_shiá
 = 
DIGITS_PER_WORD
 - 
r_mši_shiá
;

1367 
	gdo_Ëá
 = (
DIGITS_PER_WORD
 * 
wÜd_buf_Ën
 - 
’d
è< 
r_mši_shiá
;

1369 
	gdo_Ëá
 {

1370 
	g»s
.
do_mši_Ëá_shiá
(
l_mši_shiá
, 
beg
, 
’d
);

1371 
	gmši_shiá
 = -(
l_mši_shiá
 
as
 
i8
);

1373 
	g»s
.
do_mši_right_shiá
(
r_mši_shiá
, 
beg
, 
’d
);

1374 
	gmši_shiá
 = 
r_mši_shiá
 
as
 
i8
;

1376 
	gÃw_pošt
 +ğ
mši_shiá
 
as
 
isize
;

1377 
	gshiá
 + 
mši_shiá
 
as
 
	gisize
 == 0 &&

1378 (
Ãw_pošt
 - 
št_út
è< 
DIGITS_PER_WORD
 
as
 
isize


1380 
»s
.
št_út
 = iÁ_úˆ
as
 
u8
;

1381 
	g»s
.
	gäac_út
 = 
äac_út
 
as
 
u8
;

1382  
	g»s
;

1384 
	gbeg
 = (
beg
 
as
 
i8
 + 
mši_shiá
èa 
u8
;

1385 
	g’d
 = (
’d
 
as
 
i8
 + 
mši_shiá
èa 
u8
;

1388 
Ët
 
	gÃw_äÚt
 = 
Ãw_pošt
 - 
št_út
;

1389 
	gÃw_äÚt
 >ğ
DIGITS_PER_WORD
 
as
 
isize
 || 
Ãw_äÚt
 < 0 {

1390 
Ët
 
mut
 
wÜd_shiá
;

1391 
	gÃw_äÚt
 > 0 {

1392 
	gwÜd_shiá
 = 
Ãw_äÚt
 / 
DIGITS_PER_WORD
 
as
 
isize
;

1393 
Ët
 
	gto
 = ((
beg
 / 
DIGITS_PER_WORD
è
as
 
isize
 - 
wÜd_shiá
èa 
usize
;

1394 
Ët
 
	gb¬›r
 = (((
’d
 - 1è/ 
DIGITS_PER_WORD
è
as
 
isize
 - 
wÜd_shiá
èa 
usize
;

1395 
i
 
š
 
	gto
..
	gb¬›r
 + 1 {

1396 
	g»s
.
	gwÜd_buf
[
i
] = 
»s
.
wÜd_buf
[˜+ 
wÜd_shiá
 
as
 
usize
];

1398 
i
 
š
 
	gb¬›r
 + 1..ba
	gr›r
 + 
wÜd_shiá
 
as
 
	gusize
 + 1 {

1399 
	g»s
.
	gwÜd_buf
[
i
] = 0;

1401 
	gwÜd_shiá
 = -
wÜd_shiá
;

1403 
	gwÜd_shiá
 = (1 - 
Ãw_äÚt
è/ 
DIGITS_PER_WORD
 
as
 
isize
;

1404 
Ët
 
	gto
 = (((
’d
 - 1è/ 
DIGITS_PER_WORD
è
as
 
isize
 + 
wÜd_shiá
èa 
usize
;

1405 
Ët
 
	gb¬›r
 = ((
beg
 / 
DIGITS_PER_WORD
è
as
 
isize
 + 
wÜd_shiá
èa 
usize
;

1406 
i
 
š
 (
b¬›r
..
to
 + 1).
»v
() {

1407 
	g»s
.
	gwÜd_buf
[
i
] = 
»s
.
wÜd_buf
[˜- 
wÜd_shiá
 
as
 
usize
];

1409 
i
 
š
 
	gb¬›r
 - 
wÜd_shiá
 
as
 
	gusize
..barier {

1410 
	g»s
.
	gwÜd_buf
[
i
] = 0;

1413 
Ët
 
	gshiá_út
 = 
wÜd_shiá
 * 
DIGITS_PER_WORD
 
as
 
isize
;

1414 
	gbeg
 = (
beg
 
as
 
isize
 + 
shiá_út
èa 
u8
;

1415 
	g’d
 = (
’d
 
as
 
isize
 + 
shiá_út
èa 
u8
;

1416 
	gÃw_pošt
 +ğ
shiá_út
;

1418 
Ët
 
	gbeg_wÜd
 = (
beg
 / 
DIGITS_PER_WORD
è
as
 
isize
;

1419 
Ët
 
	g’d_wÜd
 = ((
’d
 - 1è/ 
DIGITS_PER_WORD
è
as
 
isize
;

1420 
Ët
 
	gÃw_pošt_wÜd
 = 
Ãw_pošt
 != 0 {

1421 (
Ãw_pošt
 - 1è/ 
DIGITS_PER_WORD
 
as
 
isize


1425 
	gÃw_pošt_wÜd
 > 
	g’d_wÜd
 {

1426 
i
 
š
 
	g’d_wÜd
 + 1..
	gÃw_pošt_wÜd
 + 1 {

1427 
	g»s
.
	gwÜd_buf
[
i
 
as
 
usize
] = 0;

1430 
i
 
š
 
	gÃw_pošt_wÜd
..
	gbeg_wÜd
 {

1431 
	g»s
.
	gwÜd_buf
[
i
 
as
 
usize
] = 0;

1434 
	g»s
.
	gšt_út
 = 
št_út
 
as
 
u8
;

1435 
	g»s
.
	gäac_út
 = 
äac_út
 
as
 
u8
;

1436 
	g»s


1440 
pub
 
â
 
as_i64
(&
£lf
è-> 
	gRes
<
	gi64
> {

1441 
Ët
 
mut
 
	gx
 = 0
i64
;

1442 
Ët
 
	gšt_wÜd_út
 = 
wÜd_út
!(
£lf
.
št_út
è
as
 
usize
;

1443 
wÜd_idx
 
	gš
 0..
	gšt_wÜd_út
 {

1444 
Ët
 
	gy
 = 
x
;

1445 
	gx
 = 
x
.
w¿µšg_mul
(
WORD_BASE
 
as
 
i64
)

1446 .
w¿µšg_sub
(
£lf
.
wÜd_buf
[
wÜd_idx
] 
as
 
i64
);

1447 
	gy
 < 
	gi64
::
MIN
 / 
WORD_BASE
 
as
 
i64
 || 
x
 > 
y
 {

1448 
£lf
.
Ãg©ive
 {

1449  
Res
::
Ov”æow
(
i64
::
MIN
);

1451  
	gRes
::
Ov”æow
(
i64
::
MAX
);

1454 !
	g£lf
.
	gÃg©ive
 && 
	gx
 =ğ
i64
::
MIN
 {

1455  
Res
::
Ov”æow
(
i64
::
MAX
);

1457 !
	g£lf
.
	gÃg©ive
 {

1458 
	gx
 = -
x
;

1460 
wÜd_idx
 
š
 
	gšt_wÜd_út
..št_wÜd_úˆ+ 
	gwÜd_út
!(
	g£lf
.
	gäac_út
è
as
 
	gusize
 {

1461 
	g£lf
.
	gwÜd_buf
[
wÜd_idx
] != 0 {

1462  
Res
::
Trunÿ‹d
(
x
);

1465 
	gRes
::
Ok
(
x
)

1469 
pub
 
â
 
as_i64_w™h_ùx
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
è-> ::
¡d
::
»suÉ
::
ResuÉ
<
i64
, 
	gEx´E¼Ü
> {

1470 
Ët
 
	g»s
 = 
£lf
.
as_i64
();

1471 
	gcÚv”t
::
hªdË_Œunÿ‹
(
ùx
, 
»s
.
is_Œunÿ‹d
())?;

1472 
	g»s
.
što
()

1476 
pub
 
â
 
as_u64
(&
£lf
è-> 
	gRes
<
	gu64
> {

1477 
	g£lf
.
	gÃg©ive
 {

1478  
	gRes
::
Ov”æow
(0);

1480 
Ët
 
mut
 
	gx
 = 0u64;

1481 
Ët
 
	gšt_út
 = 
wÜd_út
!(
£lf
.
št_út
è
as
 
usize
;

1482 
wÜd_idx
 
	gš
 0..
	gšt_út
 {

1483 
	gx
 = 
m©ch
 
x
.
ov”æowšg_mul
(
WORD_BASE
 
as
 
u64
) {

1484 (
_
, 
Œue
è=>  
Res
::
Ov”æow
(
u64
::
MAX
),

1485 (
	gx
, 
	g_
è=> 
m©ch
 
x
.
ov”æowšg_add
(
£lf
.
wÜd_buf
[
wÜd_idx
] 
as
 
u64
) {

1486 (
_
, 
Œue
è=>  
Res
::
Ov”æow
(
u64
::
MAX
),

1487 (
	gx
, 
	g_
è=> 
x
,

1491 
wÜd_idx
 
š
 
	gšt_út
..št_úˆ+ 
	gwÜd_út
!(
	g£lf
.
	gäac_út
è
as
 
	gusize
 {

1492 
	g£lf
.
	gwÜd_buf
[
wÜd_idx
] != 0 {

1493  
Res
::
Trunÿ‹d
(
x
);

1496 
	gRes
::
Ok
(
x
)

1503 
pub
 
â
 
äom_f64
(
f
: 
f64
è-> 
ResuÉ
<
Decim®
> {

1504 !
f
.
is_fš™e
() {

1505  
E¼
(
šv®id_ty³
!("{} cª'ˆbcÚv”ˆtØdecim®'", 
f
));

1508 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	gf
);

1509 
	gs
.
·r£
()

1515 
pub
 
â
 
as_f64
(&
£lf
è-> 
	gResuÉ
<
	gf64
> {

1516 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	g£lf
);

1518 
Ët
 
	gf
 = 
box_Œy
!(
s
.
·r£
::<
f64
>());

1519 
Ok
(
f
)

1522 
pub
 
â
 
äom_by‹s
(
s
: &[
u8
]è-> 
ResuÉ
<
Res
<
Decim®
>> {

1523 
Decim®
::
äom_by‹s_w™h_wÜd_buf
(
s
, 
WORD_BUF_LEN
)

1526 
â
 
äom_by‹s_w™h_wÜd_buf
(
s
: &[
u8
], 
wÜd_buf_Ën
: u8è-> 
ResuÉ
<
Res
<
Decim®
>> {

1527 
Ët
 
mut
 
bs
 = 
m©ch
 
s
.
™”
().
pos™iÚ
(|
c
| !c.
is_ascii_wh™e¥aû
()) {

1528 
NÚe
 =>  
E¼
(
box_”r
!("\"{}\" i em±y", 
esÿ³
(
s
))),

1529 
Some
(
pos
è=> &
s
[pos..],

1531 
Ët
 
mut
 
	gÃg©ive
 = 
çl£
;

1532 
m©ch
 
	gbs
[0] {

1533 
	gb
'-' => {

1534 
Ãg©ive
 = 
Œue
;

1535 
	gbs
 = &
bs
[1..];

1537 
	gb
'+' => 
bs
 = &bs[1..],

1538 
	g_
 => {}

1540 
Ët
 
	gšt_idx
 = 
fœ¡_nÚ_dig™
(
bs
, 0);

1541 
Ët
 
mut
 
	gšt_út
 = 
št_idx
 
as
 
u8
;

1542 
Ët
 
mut
 
	g’d_idx
 = 
št_idx
;

1543 
Ët
 
mut
 
	gäac_út
 = 
št_idx
 < 
bs
.
Ën
(è&& bs[št_idx] =ğ
b
'.' {

1544 
’d_idx
 = 
fœ¡_nÚ_dig™
(
bs
, 
št_idx
 + 1);

1545 (
	g’d_idx
 - 
	gšt_idx
 - 1è
as
 
	gu8


1549 
	gšt_út
 + 
	gäac_út
 == 0 {

1550  
E¼
(
box_”r
!("\"{}\" i šv®id‚umb”", 
esÿ³
(
s
)));

1552 
Ët
 
	gšt_wÜd_út
 = 
wÜd_út
!(
št_út
);

1553 
Ët
 
	gäac_wÜd_út
 = 
wÜd_út
!(
äac_út
);

1554 
Ët
 
	g»s
 = 
fix_wÜd_út_”r
(
št_wÜd_út
, 
äac_wÜd_út
, 
wÜd_buf_Ën
);

1555 
Ët
 (
št_wÜd_út
, 
äac_wÜd_út
èğ(
»s
.0, 
	g»s
.1);

1556 !
	g»s
.
is_ok
() {

1557 
	gäac_út
 = 
äac_wÜd_út
 * 
DIGITS_PER_WORD
;

1558 
	g»s
.
is_ov”æow
() {

1559 
	gšt_út
 = 
št_wÜd_út
 * 
DIGITS_PER_WORD
;

1562 
Ët
 
mut
 
	gd
 = 
»s
.
m­
(|
_
| 
Decim®
::
Ãw
(
št_út
, 
äac_út
, 
Ãg©ive
));

1563 
Ët
 
mut
 
	gšÃr_idx
 = 0;

1564 
Ët
 
mut
 
	gwÜd_idx
 = 
št_wÜd_út
 
as
 
usize
;

1565 
Ët
 
mut
 
	gwÜd
 = 0;

1566 
c
 
š
 
	gbs
[
št_idx
 - 
št_út
 
as
 
usize
..št_idx].
što_™”
().
»v
() {

1567 
	gwÜd
 +ğ(
c
 - 
b
'0'è
as
 
u32
 * 
TEN_POW
[
šÃr_idx
];

1568 
	gšÃr_idx
 += 1;

1569 
	gšÃr_idx
 =ğ
DIGITS_PER_WORD
 
as
 
usize
 {

1570 
wÜd_idx
 -= 1;

1571 
	gd
.
	gwÜd_buf
[
wÜd_idx
] = 
wÜd
;

1572 
	gwÜd
 = 0;

1573 
	gšÃr_idx
 = 0;

1576 
	gšÃr_idx
 != 0 {

1577 
wÜd_idx
 -= 1;

1578 
	gd
.
	gwÜd_buf
[
wÜd_idx
] = 
wÜd
;

1581 
	gwÜd_idx
 = 
št_wÜd_út
 
as
 
usize
;

1582 
	gwÜd
 = 0;

1583 
	gšÃr_idx
 = 0;

1584 &
c
 
š
 
	gbs
.
™”
().
sk
(
št_idx
 + 1).
ke
(
äac_út
 
as
 
usize
) {

1585 
	gwÜd
 = (
c
 - 
b
'0'è
as
 
u32
 + 
wÜd
 * 10;

1586 
	gšÃr_idx
 += 1;

1587 
	gšÃr_idx
 =ğ
DIGITS_PER_WORD
 
as
 
usize
 {

1588 
d
.
wÜd_buf
[
wÜd_idx
] = 
wÜd
;

1589 
	gwÜd_idx
 += 1;

1590 
	gwÜd
 = 0;

1591 
	gšÃr_idx
 = 0;

1594 
	gšÃr_idx
 != 0 {

1595 
d
.
wÜd_buf
[
wÜd_idx
] = 
wÜd
 * 
TEN_POW
[
DIGITS_PER_WORD
 
as
 
usize
 - 
šÃr_idx
];

1598 
	g’d_idx
 + 1 < 
	gbs
.
Ën
(è&& (bs[
’d_idx
] =ğ
b
'e' || 
bs
[end_idx] == b'E') {

1599 
Ët
 
exp
 = 
cÚv”t
::
by‹s_to_št_w™hout_cÚ‹xt
(&
bs
[
’d_idx
 + 1..])?;

1600 
	gexp
 > 
	gi32
::
MAX
 
as
 
i64
 / 2 {

1601 
d
.
»£t_to_z”o
();

1602  
Ok
(
Res
::
Ov”æow
(
d
.
unw¿p
()));

1604 
	gexp
 < 
	gi32
::
MIN
 
as
 
i64
 / 2 && !
d
.
is_ov”æow
() {

1605 
d
.
»£t_to_z”o
();

1606  
Ok
(
Res
::
Trunÿ‹d
(
d
.
unw¿p
()));

1608 !
	gd
.
is_ov”æow
() {

1609 
	gd
 = 
d
.
unw¿p
().
shiá
(
exp
 
as
 
isize
);

1612 
	gd
.
	gwÜd_buf
.
™”
().
®l
(|
c
| *c == 0) {

1613 
d
.
Ãg©ive
 = 
çl£
;

1615 
	gd
.
	g»suÉ_äac_út
 = 
d
.
äac_út
;

1616 
Ok
(
d
)

1622 
pub
 
â
 
­´oxim©e_’coded_size
(&
£lf
è-> 
	gusize
 {

1623 
Ët
 (
´ec
, 
äac
èğ
£lf
.
´ec_ªd_äac
();

1624 
dec_’coded_Ën
(&[
´ec
, 
äac
]).
unw¿p_Ü
(3)

1627 
pub
 
â
 
div
(
£lf
, 
rhs
: 
Decim®
, 
äac_šü
: 
u8
è-> 
O±iÚ
<
Res
<Decimal>> {

1628 
Ët
 
»suÉ_äac_út
 =

1629 
cmp
::
mš
(
£lf
.
»suÉ_äac_út
.
§tu¿tšg_add
(
äac_šü
), 
MAX_FRACTION
);

1630 
Ët
 
mut
 
	g»s
 = 
do_div_mod
(
£lf
, 
rhs
, 
äac_šü
, 
çl£
);

1631 
Ët
 
Some
(
»f
 
mut
 
dec
èğ
»s
 {

1632 
dec
.
»suÉ_äac_út
 =„esult_frac_cnt;

1634 
	g»s


1637 
pub
 
â
 
is_z”o
(&
£lf
è-> 
	gboŞ
 {

1638 
Ët
 
	gËn
 = 
wÜd_út
!(
£lf
.
št_út
è+ wÜd_út!(£lf.
äac_út
);

1639 
	g£lf
.
	gwÜd_buf
[0..Ë
n
 
as
 
usize
].
™”
().
®l
(|&
x
| x == 0)

1643 
	gmaüo_ruËs
! 
	g’abË_cÚv_fÜ_št
 {

1644 (
	g$s
:
ty
, 
	g$t
:ty) => {

1645 
im¶
 
From
<
$s
> 
Decim®
 {

1646 
â
 
äom
(
t
: 
$s
è-> 
Decim®
 {

1647 (
t
 
as
 
$t
).
što
()

1653 
	g’abË_cÚv_fÜ_št
!(
	gu32
, 
	gu64
);

1654 
	g’abË_cÚv_fÜ_št
!(
	gu16
, 
	gu64
);

1655 
	g’abË_cÚv_fÜ_št
!(
	gu8
, 
	gu64
);

1656 
	g’abË_cÚv_fÜ_št
!(
	gi32
, 
	gi64
);

1657 
	g’abË_cÚv_fÜ_št
!(
	gi16
, 
	gi64
);

1658 
	g’abË_cÚv_fÜ_št
!(
	gi8
, 
	gi64
);

1659 
	g’abË_cÚv_fÜ_št
!(
	gusize
, 
	gu64
);

1660 
	g’abË_cÚv_fÜ_št
!(
	gisize
, 
	gi64
);

1662 
im¶
 
	gFrom
<
	gi64
> 
	gDecim®
 {

1663 
â
 
äom
(
i
: 
i64
è-> 
Decim®
 {

1664 
Ët
 (
Ãg
, 
mut
 
d
èğ
i
 < 0 {

1665 (
Œue
, 
Decim®
::
äom
(
i
.
ov”æowšg_Ãg
().0 
as
 
u64
))

1667 (
çl£
, 
Decim®
::
äom
(
i
 
as
 
u64
))

1669 
	gd
.
	gÃg©ive
 = 
Ãg
;

1670 
	gd


1674 
im¶
 
	gFrom
<
	gu64
> 
	gDecim®
 {

1675 
â
 
äom
(
u
: 
u64
è-> 
Decim®
 {

1676 
Ët
 (
mut
 
x
, muˆ
wÜd_idx
èğ(
u
, 1);

1677 
	gx
 >ğ
WORD_BASE
 
as
 
u64
 {

1678 
wÜd_idx
 += 1;

1679 
	gx
 /ğ
WORD_BASE
 
as
 
u64
;

1681 
Ët
 
mut
 
	gd
 = 
Decim®
::
Ãw
(
wÜd_idx
 * 
DIGITS_PER_WORD
, 0, 
çl£
);

1682 
	gx
 = 
u
;

1683 
	gwÜd_idx
 > 0 {

1684 
	gwÜd_idx
 -= 1;

1685 
	gd
.
	gwÜd_buf
[
wÜd_idx
 
as
 
usize
] = (
x
 % 
WORD_BASE
‡ 
u64
èa 
u32
;

1686 
	gx
 /ğ
WORD_BASE
 
as
 
u64
;

1688 
	gd


1693 
â
 
fœ¡_nÚ_dig™
(
bs
: &[
u8
], 
¡¬t_idx
: 
usize
) -> usize {

1694 
bs
.
™”
()

1695 .
sk
(
¡¬t_idx
)

1696 .
pos™iÚ
(|&
c
| c < 
b
'0' || c > b'9')

1697 .
m­_Ü_–£
(|| 
bs
.
Ën
(), |
s
| s + 
¡¬t_idx
)

1700 
im¶
 
FromSŒ
 
	gDecim®
 {

1701 
ty³
 
	gE¼
 = 
E¼Ü
;

1703 
â
 
äom_¡r
(
s
: &
¡r
è-> 
ResuÉ
<
Decim®
> {

1704 
m©ch
 
Decim®
::
äom_by‹s
(
s
.
as_by‹s
())? {

1705 
Res
::
Ok
(
d
) => Ok(d),

1706 
	gRes
::
Ov”æow
(
_
è=> 
E¼
(
box_”r
!("·rsšg {} wÈov”æow", 
s
)),

1707 
	gRes
::
Trunÿ‹d
(
_
è=> 
E¼
(
box_”r
!("·rsšg {} wÈŒunÿ‹d", 
s
)),

1712 
im¶
 
Di¥Ïy
 
	gDecim®
 {

1713 
â
 
fmt
(&
£lf
, fmt: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

1714 
Ët
 
mut
 
dec
 = 
£lf
.
şÚe
();

1715 
	gdec
 = 
dec
.
round
(
£lf
.
»suÉ_äac_út
 
as
 
i8
, 
RoundMode
::
H®fEv’
)

1716 .
unw¿p
();

1717 
	gfmt
.
wr™e_¡r
(&
dec
.
to_¡ršg
())

1721 
	gmaüo_ruËs
! 
	gwr™e_u8
 {

1722 (
	g$wr™”
:
id’t
, 
	g$b
:
ex´
, 
	g$wr™‹n
:ident) => ({

1723 
Ët
 
mut
 
b
 = 
$b
;

1724 
	g$wr™‹n
 == 0 {

1725 
b
 ^= 0x80;

1727 
	gŒy
!(
	g$wr™”
.
wr™e_®l
(&[
b
]));

1728 
	g$wr™‹n
 += 1;

1732 
	gmaüo_ruËs
! 
	gwr™e_wÜd
 {

1733 (
	g$wr™”
:
ex´
, 
	g$wÜd
:ex´, 
	g$size
:ex´, 
	g$wr™‹n
:
id’t
) => ({

1734 
Ët
 
wÜd
 = 
$wÜd
;

1735 
Ët
 
	gsize
 = 
$size
;

1736 
Ët
 
mut
 
	gd©a
: [
u8
; 4] = 
m©ch
 
size
 {

1737 1 => [
wÜd
 
as
 
u8
, 0, 0, 0],

1738 2 => [(
wÜd
 >> 8è
as
 
u8
, word‡s u8, 0, 0],

1739 3 => [(
wÜd
 >> 16è
as
 
u8
, (word >> 8)‡s u8, word‡s u8, 0],

1740 4 => [(
wÜd
 >> 24è
as
 
u8
, (word >> 16)‡s u8, (word >> 8)‡s u8, word‡s u8],

1741 
	g_
 => 
uÄ—chabË
!()

1743 
	g$wr™‹n
 == 0 {

1744 
d©a
[0] ^= 0x80;

1746 
	gŒy
!((
	g$wr™”
).
wr™e_®l
(&
d©a
[..
size
 
as
 
usize
]));

1747 
	g$wr™‹n
 +ğ
size
;

1751 
	gmaüo_ruËs
! 
	g»ad_wÜd
 {

1752 (
	g$»ad”
:
id’t
, 
	g$size
:
ex´
, 
	g$»aded
:ident) => ({

1753 
Ët
 
buf
 = &
mut
 [0; 4];

1754 
Ët
 
	gsize
 = 
$size
;

1755 
	gŒy
!(
	g$»ad”
.
»ad_exaù
(&
mut
 
buf
[..
size
 
as
 
usize
]));

1756 
	g$»aded
 == 0 {

1757 
buf
[0] ^= 0x80;

1758 
	g$»aded
 +ğ
size
;

1760 
m©ch
 
	gsize
 {

1761 1 => 
buf
[0] 
as
 
i8
‡ 
i32
‡ 
u32
,

1762 2 => (((
buf
[0] 
as
 
i8
‡ 
i32
è<< 8è+ buf[1]‡ i32èa 
u32
,

1764 
buf
[0] & 128 > 0 {

1765 (255 << 24è| ((
buf
[0] 
as
 
u32
) << 16) | ((buf[1]‡s u32) << 8) | (buf[2]‡s u32)

1767 ((
buf
[0] 
as
 
u32
) << 16) | ((buf[1]‡s u32) << 8) | (buf[2]‡s u32)

1771 (((
buf
[0] 
as
 
i8
‡ 
i32
) << 24) + ((buf[1]‡s i32) << 16) +

1772 ((
buf
[2] 
as
 
i32
è<< 8è+ (buf[3]‡ i32)èa 
u32


1774 
_
 => 
uÄ—chabË
!(),

1779 
pub
 
Œa™
 
	gDecim®Encod”
: 
Wr™e
 {

1782 #[
®low
(
cyşom©ic_com¶ex™y
)]

1783 
â
 
’code_decim®
(&
mut
 
£lf
, 
d
: &
Decim®
, 
´ec
: 
u8
, 
äac
: u8è-> 
ResuÉ
<
Res
<()>> {

1784 
£lf
.
wr™e_®l
(&[
´ec
, 
äac
])?;

1785 
Ët
 
mut
 
	gmask
 = 
d
.
Ãg©ive
 { 
u32
::
MAX
 } { 0 };

1786 
Ët
 
mut
 
	gšt_út
 = 
´ec
 - 
äac
;

1787 
Ët
 
	gšt_wÜd_út
 = 
št_út
 / 
DIGITS_PER_WORD
;

1788 
Ët
 
	gËadšg_dig™s
 = (
št_út
 - 
št_wÜd_út
 * 
DIGITS_PER_WORD
è
as
 
usize
;

1790 
Ët
 
	gäac_wÜd_út
 = 
äac
 / 
DIGITS_PER_WORD
;

1791 
Ët
 
	gŒašg_dig™s
 = (
äac
 - 
äac_wÜd_út
 * 
DIGITS_PER_WORD
è
as
 
usize
;

1792 
Ët
 
mut
 
	g¤c_äac_wÜd_út
 = 
d
.
äac_út
 / 
DIGITS_PER_WORD
;

1793 
Ët
 
mut
 
	g¤c_Œašg_dig™s
 = (
d
.
äac_út
 - 
¤c_äac_wÜd_út
 * 
DIGITS_PER_WORD
è
as
 
usize
;

1795 
Ët
 
	gšt_size
 = 
št_wÜd_út
 * 
WORD_SIZE
 + 
DIG_2_BYTES
[
Ëadšg_dig™s
];

1796 
Ët
 
mut
 
	gäac_size
 = 
äac_wÜd_út
 * 
WORD_SIZE
 + 
DIG_2_BYTES
[
Œašg_dig™s
];

1797 
Ët
 
	g¤c_äac_size
 = 
¤c_äac_wÜd_út
 * 
WORD_SIZE
 + 
DIG_2_BYTES
[
¤c_Œašg_dig™s
];

1799 
Ët
 (
mut
 
¤c_wÜd_¡¬t_idx
, 
¤c_št_út
èğ
d
.
»move_Ëadšg_z”Ûs
();

1800 
	g¤c_št_út
 + 
	g¤c_äac_size
 == 0 {

1801 
mask
 = 0;

1802 
	gšt_út
 = 1;

1805 
Ët
 
mut
 
	g¤c_št_wÜd_út
 = 
¤c_št_út
 / 
DIGITS_PER_WORD
;

1806 
Ët
 
mut
 
	g¤c_Ëadšg_dig™s
 = (
¤c_št_út
 - 
¤c_št_wÜd_út
 * 
DIGITS_PER_WORD
è
as
 
usize
;

1807 
Ët
 
	g¤c_št_size
 = 
¤c_št_wÜd_út
 * 
WORD_SIZE
 + 
DIG_2_BYTES
[
¤c_Ëadšg_dig™s
];

1809 
Ët
 
mut
 
	gwr™‹n
: 
usize
 = 0;

1810 
Ët
 
mut
 
	g»s
 = 
Res
::
Ok
(());

1812 
	gšt_út
 < 
	g¤c_št_út
 {

1813 
	g¤c_wÜd_¡¬t_idx
 +ğ(
¤c_št_wÜd_út
 - 
št_wÜd_út
è
as
 
usize
;

1814 
	g¤c_Ëadšg_dig™s
 > 0 {

1815 
	g¤c_wÜd_¡¬t_idx
 += 1;

1817 
	gËadšg_dig™s
 > 0 {

1818 
	g¤c_wÜd_¡¬t_idx
 -= 1;

1820 
	g¤c_št_wÜd_út
 = 
št_wÜd_út
;

1821 
	g¤c_Ëadšg_dig™s
 = 
Ëadšg_dig™s
;

1822 
	g»s
 = 
Res
::
Ov”æow
(());

1823 
	g”rÜ
!(

1825 
	gd
.
to_¡ršg
(),

1826 
	g´ec
,

1827 
	gäac


1829 } 
	gšt_size
 > 
	g¤c_št_size
 {

1830 
_
 
š
 
	g¤c_št_size
..
	gšt_size
 {

1831 
	gwr™e_u8
!(
	g£lf
, 
mask
 
as
 
	gu8
, 
	gwr™‹n
);

1835 
	gäac_size
 < 
	g¤c_äac_size
 {

1836 
	g¤c_äac_wÜd_út
 = 
äac_wÜd_út
;

1837 
	g¤c_Œašg_dig™s
 = 
Œašg_dig™s
;

1838 
	g»s
 = 
Res
::
Trunÿ‹d
(());

1839 
	gw¬n
!(

1841 
	gd
.
to_¡ršg
(),

1842 
	g´ec
,

1843 
	gäac


1845 } 
	gäac_size
 > 
	g¤c_äac_size
 && 
	g¤c_Œašg_dig™s
 > 0 {

1846 
	gäac_wÜd_út
 =ğ
¤c_äac_wÜd_út
 {

1847 
¤c_Œašg_dig™s
 = 
Œašg_dig™s
;

1848 
	gäac_size
 = 
¤c_äac_size
;

1850 
	g¤c_äac_wÜd_út
 += 1;

1851 
	g¤c_Œašg_dig™s
 = 0;

1855 
	g¤c_Ëadšg_dig™s
 > 0 {

1856 
Ët
 
	gi
 = 
DIG_2_BYTES
[
¤c_Ëadšg_dig™s
] 
as
 
usize
;

1857 
Ët
 
	gx
 = (
d
.
wÜd_buf
[
¤c_wÜd_¡¬t_idx
] % 
TEN_POW
[
¤c_Ëadšg_dig™s
]è^ 
mask
;

1858 
	g¤c_wÜd_¡¬t_idx
 += 1;

1859 
	gwr™e_wÜd
!(
	g£lf
, 
	gx
, 
	gi
, 
	gwr™‹n
);

1862 
Ët
 
	g¡İ
 = 
¤c_wÜd_¡¬t_idx
 + 
¤c_št_wÜd_út
 
as
 
usize
 + 
¤c_äac_wÜd_út
‡s usize;

1863 
	g¤c_wÜd_¡¬t_idx
 < 
	g¡İ
 {

1864 
	gwr™e_wÜd
!(
	g£lf
, 
	gd
.
	gwÜd_buf
[
¤c_wÜd_¡¬t_idx
] ^ 
	gmask
, 4, 
	gwr™‹n
);

1865 
	g¤c_wÜd_¡¬t_idx
 += 1;

1868 
	g¤c_Œašg_dig™s
 > 0 {

1869 
Ët
 
	gi
 = 
DIG_2_BYTES
[
¤c_Œašg_dig™s
];

1870 
Ët
 
	glim
 = 
¤c_äac_wÜd_út
 < 
äac_wÜd_út
 {

1871 
DIGITS_PER_WORD
 
as
 
usize


1873 
Œašg_dig™s


1875 
	g¤c_Œašg_dig™s
 < 
	glim
 && 
	gDIG_2_BYTES
[
¤c_Œašg_dig™s
] =ğ
i
 {

1876 
¤c_Œašg_dig™s
 += 1;

1878 
Ët
 
	gx
 = (
d
.
wÜd_buf
[
¤c_wÜd_¡¬t_idx
] /

1879 
TEN_POW
[
DIGITS_PER_WORD
 
as
 
usize
 - 
¤c_Œašg_dig™s
]è^ 
mask
;

1880 
	gwr™e_wÜd
!(
	g£lf
, 
	gx
, 
i
 
as
 
	gusize
, 
	gwr™‹n
);

1883 
	gäac_size
 > 
	g¤c_äac_size
 {

1884 
_
 
š
 (
¤c_äac_size
..
äac_size
).
z
(
wr™‹n
..(
št_size
 + f¿c_sizeè
as
 
usize
) {

1885 
	gwr™e_u8
!(
	g£lf
, 
mask
 
as
 
	gu8
, 
	gwr™‹n
);

1888 
Ok
(
»s
)

1892 
	gim¶
<
	gT
: 
Wr™e
> 
Decim®Encod”
 
T
 {}

1894 
pub
 
Œa™
 
Decim®Decod”
: 
By‹sDecod”
 {

1895 
â
 
decode_decim®
(&
mut
 
£lf
è-> 
ResuÉ
<
Decim®
> {

1896 
£lf
.
»maššg
() < 3 {

1897  
E¼
(
box_”r
!("decim®oØshÜt: {} < 3", 
£lf
.
»maššg
()));

1900 
Ët
 
	g´ec
 = 
£lf
.
»ad_u8
()?;

1901 
Ët
 
	gäac_út
 = 
£lf
.
»ad_u8
()?;

1903 
	g´ec
 < 
	gäac_út
 {

1904  
E¼
(
box_”r
!(

1906 
´ec
,

1907 
äac_út


1911 
Ët
 
	gšt_út
 = 
´ec
 - 
äac_út
;

1912 
Ët
 
	gšt_wÜd_út
 = 
št_út
 / 
DIGITS_PER_WORD
;

1913 
Ët
 
	gËadšg_dig™s
 = (
št_út
 - 
št_wÜd_út
 * 
DIGITS_PER_WORD
è
as
 
usize
;

1914 
Ët
 
	gäac_wÜd_út
 = 
äac_út
 / 
DIGITS_PER_WORD
;

1915 
Ët
 
	gŒašg_dig™s
 = (
äac_út
 - 
äac_wÜd_út
 * 
DIGITS_PER_WORD
è
as
 
usize
;

1916 
Ët
 
mut
 
	gšt_wÜd_to
 = 
št_wÜd_út
;

1917 
	gËadšg_dig™s
 > 0 {

1918 
	gšt_wÜd_to
 += 1;

1920 
Ët
 
mut
 
	gäac_wÜd_to
 = 
äac_wÜd_út
;

1921 
	gŒašg_dig™s
 > 0 {

1922 
	gäac_wÜd_to
 += 1;

1924 
Ët
 
	gmask
 = 
£lf
.
³ak_u8
().
unw¿p
() & 0x80 > 0 {

1927 
u32
::
MAX


1929 
Ët
 
	g»s
 = 
fix_wÜd_út_”r
(
št_wÜd_to
, 
äac_wÜd_to
, 
WORD_BUF_LEN
);

1930 !
	g»s
.
is_ok
() {

1931  
E¼
(
box_”r
!("decodšg decim® faed: {:?}", 
»s
));

1933 
Ët
 
mut
 
	gd
 = 
Decim®
::
Ãw
(
št_út
, 
äac_út
, 
mask
 != 0);

1934 
	gd
.
	g´ecisiÚ
 = 
´ec
;

1935 
	gd
.
	g»suÉ_äac_út
 = 
äac_út
;

1936 
Ët
 
mut
 
	gwÜd_idx
 = 0;

1937 
Ët
 
mut
 
	g_»aded
 = 0;

1938 
	gËadšg_dig™s
 > 0 {

1939 
Ët
 
	gi
 = 
DIG_2_BYTES
[
Ëadšg_dig™s
];

1940 
	gd
.
	gwÜd_buf
[
wÜd_idx
] = 
»ad_wÜd
!(
£lf
, 
	gi
, 
	g_»aded
è^ 
	gmask
;

1941 
	gd
.
	gwÜd_buf
[
wÜd_idx
] >ğ
TEN_POW
[
Ëadšg_dig™s
 + 1] {

1942  
E¼
(
box_”r
!("invalid†eading digits for decimal‚umber"));

1944 
	gd
.
	gwÜd_buf
[
wÜd_idx
] != 0 {

1945 
wÜd_idx
 += 1;

1947 
	gd
.
	gšt_út
 -ğ
Ëadšg_dig™s
 
as
 
u8
;

1950 
_
 
	gš
 0..
	gšt_wÜd_út
 {

1951 
	gd
.
	gwÜd_buf
[
wÜd_idx
] = 
»ad_wÜd
!(
£lf
, 4, 
	g_»aded
è^ 
	gmask
;

1952 
	gd
.
	gwÜd_buf
[
wÜd_idx
] > 
	gWORD_MAX
 {

1953  
E¼
(
box_”r
!("invalid int…art for decimal‚umber"));

1955 
	gd
.
	gwÜd_buf
[
wÜd_idx
] != 0 {

1956 
wÜd_idx
 += 1;

1958 
	gd
.
	gšt_út
 -ğ
DIGITS_PER_WORD
;

1961 
_
 
	gš
 0..f
	g¿c_wÜd_út
 {

1962 
	gd
.
	gwÜd_buf
[
wÜd_idx
] = 
»ad_wÜd
!(
£lf
, 4, 
	g_»aded
è^ 
	gmask
;

1963 
	gd
.
	gwÜd_buf
[
wÜd_idx
] > 
	gWORD_MAX
 {

1964  
E¼
(
box_”r
!("invalid frac…art decimal‚umber"));

1966 
	gwÜd_idx
 += 1;

1968 
	gŒašg_dig™s
 > 0 {

1969 
Ët
 
	gx
 = 
»ad_wÜd
!(
£lf
, 
	gDIG_2_BYTES
[
Œašg_dig™s
], 
	g_»aded
è^ 
	gmask
;

1970 
	gd
.
	gwÜd_buf
[
wÜd_idx
] = 
x
 * 
TEN_POW
[
DIGITS_PER_WORD
 
as
 
usize
 - 
Œašg_dig™s
];

1971 
	gd
.
	gwÜd_buf
[
wÜd_idx
] > 
	gWORD_MAX
 {

1972  
E¼
(
box_”r
!("invalidrailing digits for decimal‚umber"));

1975 
	gd
.
	gšt_út
 =ğ0 && 
d
.
äac_út
 == 0 {

1976 
d
.
»£t_to_z”o
();

1978 
	gd
.
	g»suÉ_äac_út
 = 
äac_út
;

1979 
Ok
(
d
)

1983 
	gim¶
<
	gT
: 
By‹sDecod”
> 
Decim®Decod”
 
T
 {}

1985 
im¶
 
P¬tŸlEq
 
Decim®
 {

1986 
â
 
eq
(&
£lf
, 
right
: &
Decim®
è-> 
boŞ
 {

1987 
£lf
.
cmp
(
right
è=ğ
Ord”šg
::
Equ®


1991 
im¶
 
P¬tŸlOrd
 
Decim®
 {

1992 
â
 
·¹Ÿl_cmp
(&
£lf
, 
right
: &
Decim®
è-> 
O±iÚ
<
Ord”šg
> {

1993 
Some
(
£lf
.
cmp
(
right
))

1997 
im¶
 
Eq
 
Decim®
 {}

1999 
im¶
 
Ord
 
Decim®
 {

2000 
â
 
cmp
(&
£lf
, 
right
: &
Decim®
è-> 
Ord”šg
 {

2001 
£lf
.
Ãg©ive
 =ğ
right
.negative {

2002 
Ët
 (
ÿ¼y
, 
_
, _, _èğ
ÿlc_sub_ÿ¼y
(
£lf
, 
right
);

2003 
	gÿ¼y
.
m­_Ü
(
Ord”šg
::
Equ®
, |
ÿ¼y
| ià(ÿ¼y > 0è=ğ
£lf
.
Ãg©ive
 {

2004 
Ord”šg
::
G»©”


2006 
Ord”šg
::
Less


2008 } 
£lf
.
Ãg©ive
 {

2009 
Ord”šg
::
Less


2011 
Ord”šg
::
G»©”


2016 
im¶
<'a, '
b
> 
Add
<&'¨Decim®> fÜ &'b 
Decim®
 {

2017 
ty³
 
Ouut
 = 
Res
<
Decim®
>;

2019 
â
 
add
(
£lf
, 
rhs
: &'a Decimal) -> Res<Decimal> {

2020 
Ët
 
»suÉ_äac_út
 = 
cmp
::
max
(
£lf
.»suÉ_äac_út, 
rhs
.result_frac_cnt);

2021 
Ët
 
mut
 
»s
 = 
£lf
.
Ãg©ive
 =ğ
rhs
.negative {

2022 
do_add
(
£lf
, 
rhs
)

2024 
do_sub
(
£lf
, 
rhs
)

2026 
»s
.
»suÉ_äac_út
 =„esult_frac_cnt;

2027 
»s


2031 
im¶
<'a, '
b
> 
Sub
<&'¨Decim®> fÜ &'b 
Decim®
 {

2032 
ty³
 
Ouut
 = 
Res
<
Decim®
>;

2034 
â
 
sub
(
£lf
, 
rhs
: &'a Decimal) -> Res<Decimal> {

2035 
Ët
 
»suÉ_äac_út
 = 
cmp
::
max
(
£lf
.»suÉ_äac_út, 
rhs
.result_frac_cnt);

2036 
Ët
 
mut
 
»s
 = 
£lf
.
Ãg©ive
 =ğ
rhs
.negative {

2037 
do_sub
(
£lf
, 
rhs
)

2039 
do_add
(
£lf
, 
rhs
)

2041 
»s
.
»suÉ_äac_út
 =„esult_frac_cnt;

2042 
»s


2046 
im¶
<'a, '
b
> 
Mul
<&'¨Decim®> fÜ &'b 
Decim®
 {

2047 
ty³
 
Ouut
 = 
Res
<
Decim®
>;

2049 
â
 
mul
(
£lf
, 
rhs
: &'a Decimal) -> Res<Decimal> {

2050 
do_mul
(
£lf
, 
rhs
)

2054 
im¶
 
Div
 
Decim®
 {

2055 
ty³
 
Ouut
 = 
O±iÚ
<
Res
<
Decim®
>>;

2057 
â
 
div
(
£lf
, 
rhs
: 
Decim®
è-> 
O±iÚ
<
Res
<Decimal>> {

2058 
£lf
.
div
(
rhs
, 
DEFAULT_DIV_FRAC_INCR
)

2062 
im¶
 
Rem
 
Decim®
 {

2063 
ty³
 
Ouut
 = 
O±iÚ
<
Res
<
Decim®
>>;

2065 
â
 
»m
(
£lf
, 
rhs
: 
Decim®
è-> 
O±iÚ
<
Res
<Decimal>> {

2066 
Ët
 
»suÉ_äac_út
 = 
cmp
::
max
(
£lf
.»suÉ_äac_út, 
rhs
.result_frac_cnt);

2067 
Ët
 
mut
 
»s
 = 
do_div_mod
(
£lf
, 
rhs
, 0, 
Œue
);

2068 
Ët
 
Some
(
»f
 
mut
 
dec
èğ
»s
 {

2069 
dec
.
»suÉ_äac_út
 =„esult_frac_cnt;

2071 
»s


2075 
im¶
 
Neg
 
Decim®
 {

2076 
ty³
 
Ouut
 = 
Decim®
;

2078 
â
 
Ãg
(
mut
 
£lf
è-> 
Decim®
 {

2079 !
£lf
.
is_z”o
() {

2080 
£lf
.
Ãg©ive
 = !self.negative;

2082 
£lf


2086 #[
cfg
(
‹¡
)]

2087 
mod
 
‹¡
 {

2088 
u£
 
su³r
::*;

2089 
u£
 
su³r
::{
DEFAULT_DIV_FRAC_INCR
, 
WORD_BUF_LEN
};

2091 
u£
 
¡d
::
f64
;

2092 
u£
 
¡d
::
™”
::
»³©
;

2093 
u£
 
¡d
::
cmp
::
Ord”šg
;

2095 
maüo_ruËs
! 
as£¹_f64_eq
 {

2096 (
$l
:
ex´
, 
$r
:ex´è=> (
as£¹
!(($È- $r).
abs
(è< 
f64
::
EPSILON
));

2097 (
$g
:
ex´
, 
$l
:ex´, 
$r
:ex´è=> (
as£¹
!(($È- $r).
abs
(è< 
f64
::
EPSILON
, $tag));

2100 #[
‹¡
]

2101 
â
 
‹¡_äom_i64
() {

2102 
Ët
 
ÿ£s
 = 
vec
![

2103 (-12345
i64
, "-12345"),

2110 
num
, 
exp
è
š
 
ÿ£s
 {

2111 
Ët
 
dec
: 
Decim®
 = 
num
.
što
();

2112 
Ët
 
dec_¡r
 = 
fÜm©
!("{}", 
dec
);

2113 
as£¹_eq
!(
dec_¡r
, 
exp
);

2117 #[
‹¡
]

2118 
â
 
‹¡_äom_u64
() {

2119 
Ët
 
ÿ£s
 = 
vec
![

2125 
num
, 
exp
è
š
 
ÿ£s
 {

2126 
Ët
 
dec
: 
Decim®
 = 
num
.
što
();

2127 
Ët
 
dec_¡r
 = 
fÜm©
!("{}", 
dec
);

2128 
as£¹_eq
!(
dec_¡r
, 
exp
);

2132 #[
‹¡
]

2133 
â
 
‹¡_to_i64
() {

2134 
Ët
 
ÿ£s
 = 
vec
![

2137 
Res
::
Ov”æow
(9223372036854775807
i64
),

2139 ("-1", 
Res
::
Ok
(-1)),

2140 ("1", 
Res
::
Ok
(1)),

2141 ("-1.23", 
Res
::
Trunÿ‹d
(-1)),

2142 ("-9223372036854775807", 
Res
::
Ok
(-9223372036854775807)),

2143 ("-9223372036854775808", 
Res
::
Ok
(-9223372036854775808)),

2144 ("9223372036854775808", 
Res
::
Ov”æow
(9223372036854775807)),

2145 ("-9223372036854775809", 
Res
::
Ov”æow
(-9223372036854775808)),

2148 
dec_¡r
, 
exp
è
š
 
ÿ£s
 {

2149 
Ët
 
dec
: 
Decim®
 = 
dec_¡r
.
·r£
().
unw¿p
();

2150 
Ët
 
i
 = 
dec
.
as_i64
();

2151 
as£¹_eq
!(
i
, 
exp
);

2155 #[
‹¡
]

2156 
â
 
‹¡_to_u64
() {

2157 
Ët
 
ÿ£s
 = 
vec
![

2158 ("12345", 
Res
::
Ok
(12345u64)),

2159 ("0", 
Res
::
Ok
(0)),

2161 ("18446744073709551615", 
Res
::
Ok
(18446744073709551615)),

2162 ("18446744073709551616", 
Res
::
Ov”æow
(18446744073709551615)),

2163 ("-1", 
Res
::
Ov”æow
(0)),

2164 ("1.23", 
Res
::
Trunÿ‹d
(1)),

2167 
Res
::
Ov”æow
(18446744073709551615),

2171 
dec_¡r
, 
exp
è
š
 
ÿ£s
 {

2172 
Ët
 
dec
: 
Decim®
 = 
dec_¡r
.
·r£
().
unw¿p
();

2173 
Ët
 
i
 = 
dec
.
as_u64
();

2174 
as£¹_eq
!(
i
, 
exp
);

2178 #[
‹¡
]

2179 #[
®low
(
­´ox_cÚ¡ªt
)]

2180 
â
 
‹¡_f64
() {

2181 
Ët
 
ÿ£s
 = 
vec
![

2209 
dec_¡r
, 
exp
è
š
 
ÿ£s
 {

2210 
Ët
 
dec
 = 
dec_¡r
.
·r£
::<
Decim®
>().
unw¿p
();

2211 
Ët
 
»s
 = 
fÜm©
!("{}", 
dec
);

2212 
as£¹_eq
!(
»s
, 
dec_¡r
);

2214 
Ët
 
f
 = 
dec
.
as_f64
().
unw¿p
();

2215 
as£¹_f64_eq
!(
f
, 
exp
);

2219 #[
‹¡
]

2220 
â
 
‹¡_shiá
() {

2221 
Ët
 
ÿ£s
 = 
vec
![

2223 
WORD_BUF_LEN
,

2224 
b
"123.123" 
as
 &'static [u8],

2226 
Res
::
Ok
("1231.23"),

2229 
WORD_BUF_LEN
,

2230 
b
"123457189.123123456789000",

2232 
Res
::
Ok
("1234571891.23123456789"),

2235 
WORD_BUF_LEN
,

2236 
b
"123457189.123123456789000",

2238 
Res
::
Ok
("12345718912312345.6789"),

2241 
WORD_BUF_LEN
,

2242 
b
"123457189.123123456789000",

2244 
Res
::
Ok
("123457189123123456.789"),

2247 
WORD_BUF_LEN
,

2248 
b
"123457189.123123456789000",

2250 
Res
::
Ok
("1234571891231234567.89"),

2253 
WORD_BUF_LEN
,

2254 
b
"123457189.123123456789000",

2256 
Res
::
Ok
("12345718912312345678900000"),

2259 
WORD_BUF_LEN
,

2260 
b
"123457189.123123456789000",

2262 
Res
::
Ok
("123457189123123456789000000"),

2265 
WORD_BUF_LEN
,

2266 
b
"123457189.123123456789000",

2268 
Res
::
Ok
("1234571891231234567890000000"),

2271 
WORD_BUF_LEN
,

2272 
b
"123457189.123123456789000",

2274 
Res
::
Ok
("12345718912312345678900000000000000"),

2277 
WORD_BUF_LEN
,

2278 
b
"123457189.123123456789000",

2280 
Res
::
Ok
("123457189123123456789000000000000000"),

2283 
WORD_BUF_LEN
,

2284 
b
"123457189.123123456789000",

2286 
Res
::
Ok
("1234571891231234567890000000000000000"),

2289 
WORD_BUF_LEN
,

2290 
b
"000000000000000000000000123457189.123123456789000",

2292 
Res
::
Ok
("12345718912312345678900000000000000"),

2295 
WORD_BUF_LEN
,

2296 
b
"00000000123457189.123123456789000",

2298 
Res
::
Ok
("123457189123123456789000000000000000"),

2301 
WORD_BUF_LEN
,

2302 
b
"00000000000000000123457189.123123456789000",

2304 
Res
::
Ok
("1234571891231234567890000000000000000"),

2306 (
WORD_BUF_LEN
, 
b
"123", 1, 
Res
::
Ok
("1230")),

2307 (
WORD_BUF_LEN
, 
b
"123", 10, 
Res
::
Ok
("1230000000000")),

2308 (
WORD_BUF_LEN
, 
b
".123", 1, 
Res
::
Ok
("1.23")),

2309 (
WORD_BUF_LEN
, 
b
".123", 10, 
Res
::
Ok
("1230000000")),

2310 (
WORD_BUF_LEN
, 
b
".123", 14, 
Res
::
Ok
("12300000000000")),

2311 (
WORD_BUF_LEN
, 
b
"000.000", 1000, 
Res
::
Ok
("0")),

2312 (
WORD_BUF_LEN
, 
b
"000.", 1000, 
Res
::
Ok
("0")),

2313 (
WORD_BUF_LEN
, 
b
".000", 1000, 
Res
::
Ok
("0")),

2314 (
WORD_BUF_LEN
, 
b
"1", 1000, 
Res
::
Ov”æow
("1")),

2315 (
WORD_BUF_LEN
, 
b
"123.123", -1, 
Res
::
Ok
("12.3123")),

2317 
WORD_BUF_LEN
,

2318 
b
"123987654321.123456789000",

2320 
Res
::
Ok
("12398765432.1123456789"),

2323 
WORD_BUF_LEN
,

2324 
b
"123987654321.123456789000",

2326 
Res
::
Ok
("1239876543.21123456789"),

2329 
WORD_BUF_LEN
,

2330 
b
"123987654321.123456789000",

2332 
Res
::
Ok
("123987654.321123456789"),

2335 
WORD_BUF_LEN
,

2336 
b
"123987654321.123456789000",

2338 
Res
::
Ok
("1239.87654321123456789"),

2341 
WORD_BUF_LEN
,

2342 
b
"123987654321.123456789000",

2344 
Res
::
Ok
("123.987654321123456789"),

2347 
WORD_BUF_LEN
,

2348 
b
"123987654321.123456789000",

2350 
Res
::
Ok
("12.3987654321123456789"),

2353 
WORD_BUF_LEN
,

2354 
b
"123987654321.123456789000",

2356 
Res
::
Ok
("1.23987654321123456789"),

2359 
WORD_BUF_LEN
,

2360 
b
"123987654321.123456789000",

2362 
Res
::
Ok
("0.123987654321123456789"),

2365 
WORD_BUF_LEN
,

2366 
b
"123987654321.123456789000",

2368 
Res
::
Ok
("0.0123987654321123456789"),

2371 
WORD_BUF_LEN
,

2372 
b
"123987654321.123456789000",

2374 
Res
::
Ok
("0.00123987654321123456789"),

2377 
WORD_BUF_LEN
,

2378 
b
"00000087654321.123456789000",

2380 
Res
::
Ok
("0.00000087654321123456789"),

2382 (2, 
b
"123.123", -2, 
Res
::
Ok
("1.23123")),

2383 (2, 
b
"123.123", -3, 
Res
::
Ok
("0.123123")),

2384 (2, 
b
"123.123", -6, 
Res
::
Ok
("0.000123123")),

2385 (2, 
b
"123.123", -7, 
Res
::
Ok
("0.0000123123")),

2386 (2, 
b
"123.123", -15, 
Res
::
Ok
("0.000000000000123123")),

2387 (2, 
b
"123.123", -16, 
Res
::
Trunÿ‹d
("0.000000000000012312")),

2388 (2, 
b
"123.123", -17, 
Res
::
Trunÿ‹d
("0.000000000000001231")),

2389 (2, 
b
"123.123", -18, 
Res
::
Trunÿ‹d
("0.000000000000000123")),

2390 (2, 
b
"123.123", -19, 
Res
::
Trunÿ‹d
("0.000000000000000012")),

2391 (2, 
b
"123.123", -20, 
Res
::
Trunÿ‹d
("0.000000000000000001")),

2392 (2, 
b
"123.123", -21, 
Res
::
Trunÿ‹d
("0")),

2393 (2, 
b
".000000000123", -1, 
Res
::
Ok
("0.0000000000123")),

2394 (2, 
b
".000000000123", -6, 
Res
::
Ok
("0.000000000000000123")),

2397 
b
".000000000123",

2399 
Res
::
Trunÿ‹d
("0.000000000000000012"),

2403 
b
".000000000123",

2405 
Res
::
Trunÿ‹d
("0.000000000000000001"),

2407 (2, 
b
".000000000123", -9, 
Res
::
Trunÿ‹d
("0")),

2408 (2, 
b
".000000000123", 1, 
Res
::
Ok
("0.00000000123")),

2409 (2, 
b
".000000000123", 8, 
Res
::
Ok
("0.0123")),

2410 (2, 
b
".000000000123", 9, 
Res
::
Ok
("0.123")),

2411 (2, 
b
".000000000123", 10, 
Res
::
Ok
("1.23")),

2412 (2, 
b
".000000000123", 17, 
Res
::
Ok
("12300000")),

2413 (2, 
b
".000000000123", 18, 
Res
::
Ok
("123000000")),

2414 (2, 
b
".000000000123", 19, 
Res
::
Ok
("1230000000")),

2415 (2, 
b
".000000000123", 20, 
Res
::
Ok
("12300000000")),

2416 (2, 
b
".000000000123", 21, 
Res
::
Ok
("123000000000")),

2417 (2, 
b
".000000000123", 22, 
Res
::
Ok
("1230000000000")),

2418 (2, 
b
".000000000123", 23, 
Res
::
Ok
("12300000000000")),

2419 (2, 
b
".000000000123", 24, 
Res
::
Ok
("123000000000000")),

2420 (2, 
b
".000000000123", 25, 
Res
::
Ok
("1230000000000000")),

2421 (2, 
b
".000000000123", 26, 
Res
::
Ok
("12300000000000000")),

2422 (2, 
b
".000000000123", 27, 
Res
::
Ok
("123000000000000000")),

2423 (2, 
b
".000000000123", 28, 
Res
::
Ov”æow
("0.000000000123")),

2426 
b
"123456789.987654321",

2428 
Res
::
Trunÿ‹d
("12345678.998765432"),

2432 
b
"123456789.987654321",

2434 
Res
::
Trunÿ‹d
("1234567.899876543"),

2436 (2, 
b
"123456789.987654321", -8, 
Res
::
Trunÿ‹d
("1.234567900")),

2439 
b
"123456789.987654321",

2441 
Res
::
Ok
("0.123456789987654321"),

2445 
b
"123456789.987654321",

2447 
Res
::
Trunÿ‹d
("0.012345678998765432"),

2451 
b
"123456789.987654321",

2453 
Res
::
Trunÿ‹d
("0.000000001234567900"),

2457 
b
"123456789.987654321",

2459 
Res
::
Trunÿ‹d
("0.000000000123456790"),

2463 
b
"123456789.987654321",

2465 
Res
::
Trunÿ‹d
("0.000000000012345679"),

2469 
b
"123456789.987654321",

2471 
Res
::
Trunÿ‹d
("0.000000000000000001"),

2473 (2, 
b
"123456789.987654321", -27, 
Res
::
Trunÿ‹d
("0")),

2474 (2, 
b
"123456789.987654321", 1, 
Res
::
Trunÿ‹d
("1234567900")),

2475 (2, 
b
"123456789.987654321", 2, 
Res
::
Trunÿ‹d
("12345678999")),

2478 
b
"123456789.987654321",

2480 
Res
::
Trunÿ‹d
("1234567899877"),

2484 
b
"123456789.987654321",

2486 
Res
::
Trunÿ‹d
("12345678998765432"),

2488 (2, 
b
"123456789.987654321", 9, 
Res
::
Ok
("123456789987654321")),

2491 
b
"123456789.987654321",

2493 
Res
::
Ov”æow
("123456789.987654321"),

2495 (2, 
b
"123456789.987654321", 0, 
Res
::
Ok
("123456789.987654321")),

2498 
wÜd_buf_Ën
, 
dec
, 
shiá
, 
exp
è
š
 
ÿ£s
 {

2499 
Ët
 
dec
 = 
Decim®
::
äom_by‹s_w™h_wÜd_buf
(dec, 
wÜd_buf_Ën
)

2500 .
unw¿p
()

2501 .
unw¿p
();

2502 
Ët
 
shiáed
 = 
dec
.
shiá_w™h_wÜd_buf_Ën
(
shiá
, 
wÜd_buf_Ën
);

2503 
Ët
 
»s
 = 
shiáed
.
m­
(|
d
| d.
to_¡ršg
());

2504 
as£¹_eq
!(
»s
, 
exp
.
m­
(|
s
| s.
to_owÃd
()));

2508 #[
‹¡
]

2509 
â
 
‹¡_round
() {

2510 
Ët
 
ÿ£s
 = 
vec
![

2514 
Res
::
Ok
("123456790.0"),

2515 
Res
::
Ok
("123456789.9"),

2516 
Res
::
Ok
("123456790.0"),

2518 ("15.1", 0, 
Res
::
Ok
("15"), Res::Ok("15"), Res::Ok("16")),

2519 ("15.5", 0, 
Res
::
Ok
("16"), Res::Ok("15"), Res::Ok("16")),

2520 ("15.9", 0, 
Res
::
Ok
("16"), Res::Ok("15"), Res::Ok("16")),

2521 ("-15.1", 0, 
Res
::
Ok
("-15"), Res::Ok("-15"), Res::Ok("-16")),

2522 ("-15.5", 0, 
Res
::
Ok
("-16"), Res::Ok("-15"), Res::Ok("-16")),

2523 ("-15.9", 0, 
Res
::
Ok
("-16"), Res::Ok("-15"), Res::Ok("-16")),

2524 ("15.1", 1, 
Res
::
Ok
("15.1"), Res::Ok("15.1"), Res::Ok("15.1")),

2528 
Res
::
Ok
("-15.1"),

2529 
Res
::
Ok
("-15.1"),

2530 
Res
::
Ok
("-15.1"),

2535 
Res
::
Ok
("15.2"),

2536 
Res
::
Ok
("15.1"),

2537 
Res
::
Ok
("15.2"),

2539 ("15.4", -1, 
Res
::
Ok
("20"), Res::Ok("10"), Res::Ok("20")),

2540 ("-15.4", -1, 
Res
::
Ok
("-20"), Res::Ok("-10"), Res::Ok("-20")),

2541 ("5.4", -1, 
Res
::
Ok
("10"), Res::Ok("0"), Res::Ok("10")),

2542 (".999", 0, 
Res
::
Ok
("1"), Res::Ok("0"), Res::Ok("1")),

2546 
Res
::
Ok
("1000000000"),

2547 
Res
::
Ok
("0"),

2548 
Res
::
Ok
("1000000000"),

2552 
dec_¡r
, 
sÿË
, 
h®f_exp
, 
Œunc_exp
, 
û_exp
è
š
 
ÿ£s
 {

2553 
Ët
 
dec
 = 
dec_¡r
.
·r£
::<
Decim®
>().
unw¿p
();

2554 
Ët
 
»s
 = 
dec
.
şÚe
()

2555 .
round
(
sÿË
, 
RoundMode
::
H®fEv’
)

2556 .
m­
(|
d
| d.
to_¡ršg
());

2557 
as£¹_eq
!(
»s
, 
h®f_exp
.
m­
(|
s
| s.
to_owÃd
()));

2558 
Ët
 
»s
 = 
dec
.
şÚe
()

2559 .
round
(
sÿË
, 
RoundMode
::
Trunÿ‹
)

2560 .
m­
(|
d
| d.
to_¡ršg
());

2561 
as£¹_eq
!(
»s
, 
Œunc_exp
.
m­
(|
s
| s.
to_owÃd
()));

2562 
Ët
 
»s
 = 
dec
.
round
(
sÿË
, 
RoundMode
::
Cešg
).
m­
(|
d
| d.
to_¡ršg
());

2563 
as£¹_eq
!(
»s
, 
û_exp
.
m­
(|
s
| s.
to_owÃd
()));

2567 #[
‹¡
]

2568 
â
 
‹¡_¡ršg
() {

2569 
Ët
 
ÿ£s
 = 
vec
![

2570 (
WORD_BUF_LEN
, 
b
"12345" 
as
 &'static [u8], Res::Ok("12345")),

2571 (
WORD_BUF_LEN
, 
b
"12345.", 
Res
::
Ok
("12345")),

2572 (
WORD_BUF_LEN
, 
b
"123.45.", 
Res
::
Ok
("123.45")),

2573 (
WORD_BUF_LEN
, 
b
"-123.45.", 
Res
::
Ok
("-123.45")),

2575 
WORD_BUF_LEN
,

2576 
b
".00012345000098765",

2577 
Res
::
Ok
("0.00012345000098765"),

2580 
WORD_BUF_LEN
,

2581 
b
".12345000098765",

2582 
Res
::
Ok
("0.12345000098765"),

2585 
WORD_BUF_LEN
,

2586 
b
"-.000000012345000098765",

2587 
Res
::
Ok
("-0.000000012345000098765"),

2589 (
WORD_BUF_LEN
, 
b
"1234500009876.5", 
Res
::
Ok
("1234500009876.5")),

2590 (
WORD_BUF_LEN
, 
b
"123E5", 
Res
::
Ok
("12300000")),

2591 (
WORD_BUF_LEN
, 
b
"123E-2", 
Res
::
Ok
("1.23")),

2592 (1, 
b
"123450000098765", 
Res
::
Ov”æow
("98765")),

2593 (1, 
b
"123450.000098765", 
Res
::
Trunÿ‹d
("123450")),

2594 (
WORD_BUF_LEN
, 
b
"123.123", 
Res
::
Ok
("123.123")),

2595 (
WORD_BUF_LEN
, 
b
"123.1230", 
Res
::
Ok
("123.1230")),

2596 (
WORD_BUF_LEN
, 
b
"00123.123", 
Res
::
Ok
("123.123")),

2597 (
WORD_BUF_LEN
, 
b
"1.21", 
Res
::
Ok
("1.21")),

2598 (
WORD_BUF_LEN
, 
b
".21", 
Res
::
Ok
("0.21")),

2599 (
WORD_BUF_LEN
, 
b
"1.00", 
Res
::
Ok
("1.00")),

2600 (
WORD_BUF_LEN
, 
b
"100", 
Res
::
Ok
("100")),

2601 (
WORD_BUF_LEN
, 
b
"-100", 
Res
::
Ok
("-100")),

2602 (
WORD_BUF_LEN
, 
b
"100.00", 
Res
::
Ok
("100.00")),

2603 (
WORD_BUF_LEN
, 
b
"00100.00", 
Res
::
Ok
("100.00")),

2604 (
WORD_BUF_LEN
, 
b
"-100.00", 
Res
::
Ok
("-100.00")),

2605 (
WORD_BUF_LEN
, 
b
"-0.00", 
Res
::
Ok
("0.00")),

2606 (
WORD_BUF_LEN
, 
b
"00.00", 
Res
::
Ok
("0.00")),

2607 (
WORD_BUF_LEN
, 
b
"0.00", 
Res
::
Ok
("0.00")),

2608 (
WORD_BUF_LEN
, 
b
"-2.010", 
Res
::
Ok
("-2.010")),

2609 (
WORD_BUF_LEN
, 
b
"12345", 
Res
::
Ok
("12345")),

2610 (
WORD_BUF_LEN
, 
b
"-12345", 
Res
::
Ok
("-12345")),

2611 (
WORD_BUF_LEN
, 
b
"-3.", 
Res
::
Ok
("-3")),

2612 (
WORD_BUF_LEN
, 
b
"1.456e3", 
Res
::
Ok
("1456")),

2613 (
WORD_BUF_LEN
, 
b
"3.", 
Res
::
Ok
("3")),

2614 (
WORD_BUF_LEN
, 
b
"314e-2", 
Res
::
Ok
("3.14")),

2615 (
WORD_BUF_LEN
, 
b
"1e2", 
Res
::
Ok
("100")),

2616 (
WORD_BUF_LEN
, 
b
"2E-1", 
Res
::
Ok
("0.2")),

2617 (
WORD_BUF_LEN
, 
b
"2E0", 
Res
::
Ok
("2")),

2618 (
WORD_BUF_LEN
, 
b
"2.2E-1", 
Res
::
Ok
("0.22")),

2619 (
WORD_BUF_LEN
, 
b
"2.23E2", 
Res
::
Ok
("223")),

2620 (
WORD_BUF_LEN
, 
b
"2.23E2abc", 
Res
::
Ok
("223")),

2621 (
WORD_BUF_LEN
, 
b
"2.23a2", 
Res
::
Ok
("2.23")),

2622 (
WORD_BUF_LEN
, 
b
"223\xE0\x80\x80", 
Res
::
Ok
("223")),

2625 
wÜd_buf_Ën
, 
dec
, 
exp
è
š
 
ÿ£s
 {

2626 
Ët
 
d
 = 
Decim®
::
äom_by‹s_w™h_wÜd_buf
(
dec
, 
wÜd_buf_Ën
).
unw¿p
();

2627 
Ët
 
»s
 = 
d
.
m­
(|d| d.
to_¡ršg
());

2628 
as£¹_eq
!(
»s
, 
exp
.
m­
(|
s
| s.
to_owÃd
()));

2632 #[
‹¡
]

2633 
â
 
‹¡_codec
() {

2634 
Ët
 
ÿ£s
 = 
vec
![

2635 ("-10.55", 4, 2, 
Res
::
Ok
("-10.55")),

2640 
Res
::
Ok
("0.0123456789012345678912345"),

2642 ("12345", 5, 0, 
Res
::
Ok
("12345")),

2643 ("12345", 10, 3, 
Res
::
Ok
("12345.000")),

2644 ("123.45", 10, 3, 
Res
::
Ok
("123.450")),

2645 ("-123.45", 20, 10, 
Res
::
Ok
("-123.4500000000")),

2650 
Res
::
Trunÿ‹d
("0.00012345000098"),

2656 
Res
::
Ok
("0.00012345000098765000"),

2658 (".12345000098765", 30, 20, 
Res
::
Ok
("0.12345000098765000000")),

2663 
Res
::
Trunÿ‹d
("-0.00000001234500009876"),

2665 ("1234500009876.5", 30, 5, 
Res
::
Ok
("1234500009876.50000")),

2666 ("111111111.11", 10, 2, 
Res
::
Ov”æow
("11111111.11")),

2667 ("000000000.01", 7, 3, 
Res
::
Ok
("0.010")),

2668 ("123.4", 10, 2, 
Res
::
Ok
("123.40")),

2669 ("1000", 3, 0, 
Res
::
Ov”æow
("0")),

2672 
dec_¡r
, 
´ec
, 
äac
, 
exp
è
š
 
ÿ£s
 {

2673 
Ët
 
dec
 = 
dec_¡r
.
·r£
::<
Decim®
>().
unw¿p
();

2674 
Ët
 
mut
 
buf
 = 
vec
![];

2675 
Ët
 
»s
 = 
buf
.
’code_decim®
(&
dec
, 
´ec
, 
äac
).
unw¿p
();

2676 
Ët
 
decoded
 = 
buf
.
as_¦iû
().
decode_decim®
().
unw¿p
();

2677 
Ët
 
»s
 =„es.
m­
(|
_
| 
decoded
.
to_¡ršg
());

2678 
as£¹_eq
!(
»s
, 
exp
.
m­
(|
s
| s.
to_owÃd
()));

2682 #[
‹¡
]

2683 
â
 
‹¡_cmp
() {

2684 
Ët
 
ÿ£s
 = 
vec
![

2685 ("12", "13", 
Ord”šg
::
Less
),

2686 ("13", "12", 
Ord”šg
::
G»©”
),

2687 ("-10", "10", 
Ord”šg
::
Less
),

2688 ("10", "-10", 
Ord”šg
::
G»©”
),

2689 ("-12", "-13", 
Ord”šg
::
G»©”
),

2690 ("0", "12", 
Ord”šg
::
Less
),

2691 ("-10", "0", 
Ord”šg
::
Less
),

2692 ("4", "4", 
Ord”šg
::
Equ®
),

2693 ("4", "4.00", 
Ord”šg
::
Equ®
),

2694 ("-1.1", "-1.2", 
Ord”šg
::
G»©”
),

2695 ("1.2", "1.1", 
Ord”šg
::
G»©”
),

2696 ("1.1", "1.2", 
Ord”šg
::
Less
),

2699 
lhs_¡r
, 
rhs_¡r
, 
exp
è
š
 
ÿ£s
 {

2700 
Ët
 
lhs
 = 
lhs_¡r
.
·r£
::<
Decim®
>().
unw¿p
();

2701 
Ët
 
rhs
 = 
rhs_¡r
.
·r£
::<
Decim®
>().
unw¿p
();

2702 
as£¹_eq
!(
lhs
.
cmp
(&
rhs
), 
exp
);

2706 #[
‹¡
]

2707 
â
 
‹¡_max_decim®
() {

2708 
Ët
 
ÿ£s
 = 
vec
![

2726 
´ec
, 
äac
, 
exp
è
š
 
ÿ£s
 {

2727 
Ët
 
dec
 = 
su³r
::
max_decim®
(
´ec
, 
äac
);

2728 
Ët
 
»s
 = 
dec
.
to_¡ršg
();

2729 
as£¹_eq
!(&
»s
, 
exp
);

2733 #[
‹¡
]

2734 
â
 
‹¡_add
() {

2735 
Ët
 
a
 = "2".
to_owÃd
(è+ &
»³©
('1').
ke
(71).
cŞËù
::<
SŒšg
>();

2736 
Ët
 
b
: 
SŒšg
 = 
»³©
('8').
ke
(81).
cŞËù
();

2737 
Ët
 
c
 = "8888888890".
to_owÃd
(è+ &
»³©
('9').
ke
(71).
cŞËù
::<
SŒšg
>();

2738 
Ët
 
ÿ£s
 = 
vec
![

2742 
Res
::
Ok
("123.45012345000098765"),

2744 (".1", ".45", 
Res
::
Ok
("0.55")),

2748 
Res
::
Ok
("1234500009876.50012345000098765"),

2750 ("9999909999999.5", ".555", 
Res
::
Ok
("9999910000000.055")),

2751 ("99999999", "1", 
Res
::
Ok
("100000000")),

2752 ("989999999", "1", 
Res
::
Ok
("990000000")),

2753 ("999999999", "1", 
Res
::
Ok
("1000000000")),

2754 ("12345", "123.45", 
Res
::
Ok
("12468.45")),

2755 ("-12345", "-123.45", 
Res
::
Ok
("-12468.45")),

2756 ("-12345", "123.45", 
Res
::
Ok
("-12221.55")),

2757 ("12345", "-123.45", 
Res
::
Ok
("12221.55")),

2758 ("123.45", "-12345", 
Res
::
Ok
("-12221.55")),

2759 ("-123.45", "12345", 
Res
::
Ok
("12221.55")),

2760 ("5", "-6.0", 
Res
::
Ok
("-1.0")),

2761 ("2", "3", 
Res
::
Ok
("5")),

2762 ("2454495034", "3451204593", 
Res
::
Ok
("5905699627")),

2763 ("24544.95034", ".3451204593", 
Res
::
Ok
("24545.2954604593")),

2764 (".1", ".1", 
Res
::
Ok
("0.2")),

2765 (".1", "-.1", 
Res
::
Ok
("0")),

2766 ("0", "1.001", 
Res
::
Ok
("1.001")),

2767 (&
a
, &
b
, 
Res
::
Ok
(&
c
)),

2770 
lhs_¡r
, 
rhs_¡r
, 
exp
è
š
 
ÿ£s
 {

2771 
Ët
 
lhs
 = 
lhs_¡r
.
·r£
::<
Decim®
>().
unw¿p
();

2772 
Ët
 
rhs
 = 
rhs_¡r
.
·r£
::<
Decim®
>().
unw¿p
();

2774 
Ët
 
»s_dec
 = &
lhs
 + &
rhs
;

2775 
Ët
 
»s
 = 
»s_dec
.
m­
(|
s
| s.
to_¡ršg
());

2776 
Ët
 
exp_¡r
 = 
exp
.
m­
(|
s
| s.
to_owÃd
());

2777 
as£¹_eq
!(
»s
, 
exp_¡r
);

2779 
Ët
 
»s_dec
 = &
rhs
 + &
lhs
;

2780 
Ët
 
»s
 = 
»s_dec
.
m­
(|
s
| s.
to_¡ršg
());

2781 
as£¹_eq
!(
»s
, 
exp_¡r
);

2785 #[
‹¡
]

2786 
â
 
‹¡_sub
() {

2787 
Ët
 
ÿ£s
 = 
vec
![

2791 
Res
::
Ok
("-123.44987654999901235"),

2796 
Res
::
Ok
("1234500009876.49987654999901235"),

2798 ("9999900000000.5", ".555", 
Res
::
Ok
("9999899999999.945")),

2799 ("1111.5551", "1111.555", 
Res
::
Ok
("0.0001")),

2800 (".555", ".555", 
Res
::
Ok
("0")),

2801 ("10000000", "1", 
Res
::
Ok
("9999999")),

2802 ("1000001000", ".1", 
Res
::
Ok
("1000000999.9")),

2803 ("1000000000", ".1", 
Res
::
Ok
("999999999.9")),

2804 ("12345", "123.45", 
Res
::
Ok
("12221.55")),

2805 ("-12345", "-123.45", 
Res
::
Ok
("-12221.55")),

2806 ("123.45", "12345", 
Res
::
Ok
("-12221.55")),

2807 ("-123.45", "-12345", 
Res
::
Ok
("12221.55")),

2808 ("-12345", "123.45", 
Res
::
Ok
("-12468.45")),

2809 ("12345", "-123.45", 
Res
::
Ok
("12468.45")),

2812 
lhs_¡r
, 
rhs_¡r
, 
exp
è
š
 
ÿ£s
 {

2813 
Ët
 
lhs
 = 
lhs_¡r
.
·r£
::<
Decim®
>().
unw¿p
();

2814 
Ët
 
rhs
 = 
rhs_¡r
.
·r£
::<
Decim®
>().
unw¿p
();

2815 
Ët
 
»s_dec
 = &
lhs
 - &
rhs
;

2816 
Ët
 
»s
 = 
»s_dec
.
m­
(|
s
| s.
to_¡ršg
());

2817 
as£¹_eq
!(
»s
, 
exp
.
m­
(|
s
| s.
to_owÃd
()));

2821 #[
‹¡
]

2822 
â
 
‹¡_mul
() {

2823 
Ët
 
a
 = "1".
to_owÃd
(è+ &
»³©
('0').
ke
(60).
cŞËù
::<
SŒšg
>();

2824 
Ët
 
b
 = "1".
to_owÃd
(è+ &
»³©
("0").
ke
(60).
cŞËù
::<
SŒšg
>();

2825 
Ët
 
ÿ£s
 = 
vec
![

2826 ("12", "10", 
Res
::
Ok
("120")),

2827 ("0", "-1.1", 
Res
::
Ok
("0")),

2828 ("-123.456", "98765.4321", 
Res
::
Ok
("-12193185.1853376")),

2832 
Res
::
Ok
("-12193185185337600000000000"),

2834 ("123456", "987654321", 
Res
::
Ok
("121931851853376")),

2835 ("123456", "9876543210", 
Res
::
Ok
("1219318518533760")),

2836 ("123", "0.01", 
Res
::
Ok
("1.23")),

2837 ("123", "0", 
Res
::
Ok
("0")),

2838 (&
a
, &
b
, 
Res
::
Ov”æow
("0")),

2841 
lhs_¡r
, 
rhs_¡r
, 
exp_¡r
è
š
 
ÿ£s
 {

2842 
Ët
 
lhs
: 
Decim®
 = 
lhs_¡r
.
·r£
().
unw¿p
();

2843 
Ët
 
rhs
: 
Decim®
 = 
rhs_¡r
.
·r£
().
unw¿p
();

2844 
Ët
 
exp
 = 
exp_¡r
.
m­
(|
s
| s.
to_owÃd
());

2845 
Ët
 
»s
 = (&
lhs
 * &
rhs
).
m­
(|
d
| d.
to_¡ršg
());

2846 
as£¹_eq
!(
»s
, 
exp
);

2848 
Ët
 
»s
 = (&
rhs
 * &
lhs
).
m­
(|
d
| d.
to_¡ršg
());

2849 
as£¹_eq
!(
»s
, 
exp
);

2853 #[
‹¡
]

2854 
â
 
‹¡_div_mod
() {

2855 
Ët
 
ÿ£s
 = 
vec
![

2856 (5, "120", "10", 
Some
("12.000000000"), Some("0")),

2857 (5, "123", "0.01", 
Some
("12300.000000000"), Some("0.00")),

2862 
Some
("0.000000001200000000"),

2863 
Some
("120.00000"),

2865 (5, "123", "0", 
NÚe
, None),

2866 (5, "0", "0", 
NÚe
, None),

2871 
Some
("-123.456000000000000000"),

2872 
Some
("-45037.0370376"),

2878 
Some
("123456.000000000"),

2879 
Some
("0"),

2881 (5, "0", "987", 
Some
("0"), Some("0")),

2882 (5, "1", "3", 
Some
("0.333333333"), Some("1")),

2887 
Some
("0.333333333333333333"),

2888 
Some
("1.000000000000"),

2890 (5, "1", "1", 
Some
("1.000000000"), Some("0")),

2895 
Some
("0.000000000001234567890246913578148141"),

2896 
Some
("0.0123456789012345678912345"),

2902 
Some
("0.837019036046982584042122316"),

2903 
Some
("10.333000000"),

2909 
Some
("5.000000000030000000"),

2910 
Some
("0.000000000060"),

2912 (0, "234", "10", 
Some
("23"), Some("4")),

2917 
Some
("22.223306489815253434"),

2918 
Some
("2.357"),

2924 
Some
("-22.223306489815253434"),

2925 
Some
("-2.357"),

2931 
Some
("-22.223306489815253434"),

2932 
Some
("2.357"),

2938 
Some
("33333333333333333333333333333333333333"),

2939 
Some
("0"),

2942 
DEFAULT_DIV_FRAC_INCR
,

2945 
Some
("1.000000000"),

2946 
Some
("0"),

2949 
DEFAULT_DIV_FRAC_INCR
,

2952 
Some
("1.000000000"),

2953 
Some
("0.00"),

2956 
DEFAULT_DIV_FRAC_INCR
,

2959 
Some
("1.000000000"),

2960 
Some
("0.000"),

2963 
DEFAULT_DIV_FRAC_INCR
,

2966 
Some
("0.666666666"),

2967 
Some
("2"),

2969 (0, "1", "2.0", 
Some
("0.500000000"), Some("1.0")),

2970 (0, "1.0", "2", 
Some
("0.500000000"), Some("1.0")),

2971 (0, "2.23", "3", 
Some
("0.743333333"), Some("2.23")),

2973 
DEFAULT_DIV_FRAC_INCR
,

2976 
Some
("14868.804664723032069970"),

2977 
Some
("0.002760"),

2983 
Some
("14868.804664723032069970"),

2984 
Some
("0.002760"),

2990 
Some
("14868.804664723"),

2991 
Some
("0.002760"),

2995 
äac_šü
, 
lhs_¡r
, 
rhs_¡r
, 
div_exp
, 
»m_exp
è
š
 
ÿ£s
 {

2996 
Ët
 
lhs
: 
Decim®
 = 
lhs_¡r
.
·r£
().
unw¿p
();

2997 
Ët
 
rhs
: 
Decim®
 = 
rhs_¡r
.
·r£
().
unw¿p
();

2998 
Ët
 
»s
 = 
su³r
::
do_div_mod
(
lhs
.
şÚe
(), 
rhs
.şÚe(), 
äac_šü
, 
çl£
)

2999 .
m­
(|
d
| d.
unw¿p
().
to_¡ršg
());

3000 
as£¹_eq
!(
»s
, 
div_exp
.
m­
(|
s
| s.
to_owÃd
()));

3002 
Ët
 
»s
 = 
su³r
::
do_div_mod
(
lhs
, 
rhs
, 
äac_šü
, 
Œue
).
m­
(|
d
| d.
unw¿p
().
to_¡ršg
());

3003 
as£¹_eq
!(
»s
, 
»m_exp
.
m­
(|
s
| s.
to_owÃd
()));

3007 #[
‹¡
]

3008 
â
 
‹¡_Ãg
() {

3009 
Ët
 
ÿ£s
 = 
vec
![

3020 
pos
, 
Ãg
è
š
 
ÿ£s
 {

3021 
Ët
 
pos_dec
: 
Decim®
 = 
pos
.
·r£
().
unw¿p
();

3022 
Ët
 
»s
 = -
pos_dec
.
şÚe
();

3023 
as£¹_eq
!(
fÜm©
!("{}", 
»s
), 
Ãg
);

3024 
as£¹
!((&
pos_dec
 + &
»s
).
is_z”o
());

3026 
Ët
 
Ãg_dec
: 
Decim®
 = 
Ãg
.
·r£
().
unw¿p
();

3027 
Ët
 
»s
 = -
Ãg_dec
.
şÚe
();

3028 
as£¹_eq
!(
fÜm©
!("{}", 
»s
), 
pos
);

3029 
as£¹
!((&
Ãg_dec
 + &
»s
).
is_z”o
());

3032 
Ët
 
max_dec
 = 
su³r
::
max_Ü_mš_dec
(
çl£
, 40, 20);

3033 
Ët
 
mš_dec
 = 
su³r
::
max_Ü_mš_dec
(
Œue
, 40, 20);

3034 
as£¹_eq
!(
mš_dec
, -
max_dec
.
şÚe
());

3035 
as£¹_eq
!(
max_dec
, -
mš_dec
.
şÚe
());

3038 #[
‹¡
]

3039 
â
 
‹¡_max_Ü_mš_decim®
() {

3040 
Ët
 
ÿ£s
 = 
vec
![

3058 
´ec
, 
äac
, 
exp
è
š
 
ÿ£s
 {

3059 
Ët
 
pos™ive
 = 
su³r
::
max_Ü_mš_dec
(
çl£
, 
´ec
, 
äac
);

3060 
Ët
 
»s
 = 
pos™ive
.
to_¡ršg
();

3061 
as£¹_eq
!(&
»s
, 
exp
);

3062 
Ët
 
Ãg©ive
 = 
su³r
::
max_Ü_mš_dec
(
Œue
, 
´ec
, 
äac
);

3063 
Ët
 
mut
 
Ãg©ive_exp
 = 
SŒšg
::
äom
("-");

3064 
Ãg©ive_exp
.
push_¡r
(
exp
);

3065 
Ët
 
»s
 = 
Ãg©ive
.
to_¡ršg
();

3066 
as£¹_eq
!(
»s
, 
Ãg©ive_exp
);

3070 #[
‹¡
]

3071 
â
 
‹¡_»£t_to_z”o
() {

3072 
Ët
 
ÿ£s
 = 
vec
![

3082 
š
 
ÿ£s
 {

3083 
Ët
 
mut
 
dec
: 
Decim®
 = .
·r£
().
unw¿p
();

3084 
as£¹
!(!
dec
.
is_z”o
());

3085 
dec
.
»£t_to_z”o
();

3086 
as£¹
!(
dec
.
is_z”o
());

3090 #[
‹¡
]

3091 
â
 
‹¡_û
() {

3092 
Ët
 
ÿ£s
 = 
vec
![

3110 
šput
, 
exp
è
š
 
ÿ£s
 {

3111 
Ët
 
dec
: 
Decim®
 = 
šput
.
·r£
().
unw¿p
();

3112 
Ët
 
exp
: 
Decim®
 =ƒxp.
·r£
().
unw¿p
();

3113 
Ët
 
gÙ
 = 
dec
.
û
().
unw¿p
();

3114 
as£¹_eq
!(
gÙ
, 
exp
);

3118 #[
‹¡
]

3119 
â
 
‹¡_æoÜ
() {

3120 
Ët
 
ÿ£s
 = 
vec
![

3135 
šput
, 
exp
è
š
 
ÿ£s
 {

3136 
Ët
 
dec
: 
Decim®
 = 
šput
.
·r£
().
unw¿p
();

3137 
Ët
 
exp
: 
Decim®
 =ƒxp.
·r£
().
unw¿p
();

3138 
Ët
 
gÙ
 = 
dec
.
æoÜ
().
unw¿p
();

3139 
as£¹_eq
!(
gÙ
, 
exp
);

	@src/coprocessor/codec/mysql/duration.rs

14 
u£
 
	g¡d
::
time
::
Du¿tiÚ
 
as
 
StdDu¿tiÚ
;

15 
u£
 
	gtime
::{
£lf
, 
	gTm
};

16 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

17 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

18 
u£
 
	g¡d
::{
¡r
, 
	gi64
, 
	gu64
};

19 
u£
 
	g¡d
::
io
::
Wr™e
;

21 
u£
 
	gsu³r
::
su³r
::
ResuÉ
;

22 
u£
 
	gsu³r
::{
check_f¥
, 
	g·r£_äac
, 
	gDecim®
};

24 
pub
 cÚ¡ 
	gNANOS_PER_SEC
: 
i64
 = 1
_000_000_000
;

25 
pub
 cÚ¡ 
	gNANO_WIDTH
: 
u32
 = 9;

26 cÚ¡ 
	gSECS_PER_HOUR
: 
u64
 = 3600;

27 cÚ¡ 
	gSECS_PER_MINUTE
: 
u64
 = 60;

30 cÚ¡ 
	gMAX_TIME_IN_SECS
: 
u64
 = 838 * 
SECS_PER_HOUR
 + 59 * 
SECS_PER_MINUTE
 + 59;

32 
â
 
check_dur
(
dur
: &
StdDu¿tiÚ
è-> 
ResuÉ
<()> {

33 
Ët
 
£cs
 = 
dur
.
as_£cs
();

34 
	g£cs
 > 
	gMAX_TIME_IN_SECS
 || sec =ğ
MAX_TIME_IN_SECS
 && 
dur
.
sub£c_Çnos
() > 0 {

35  
E¼
(
šv®id_ty³
!(

37 
dur
,

38 
MAX_TIME_IN_SECS


41 
Ok
(())

44 
â
 
tm_to_£cs
(
t
: 
Tm
è-> 
u64
 {

45 
t
.
tm_hour
 
as
 
u64
 * 
SECS_PER_HOUR
 +.
tm_mš
‡ u64 * 
SECS_PER_MINUTE
 +.
tm_£c
‡s u64

49 #[
d”ive
(
Debug
, 
ClÚe
)]

50 
pub
 
	sDu¿tiÚ
 {

51 
pub
 
	mdur
: 
StdDu¿tiÚ
,

54 
pub
 
	mf¥
: 
u8
,

55 
	mÃg
: 
boŞ
,

58 
im¶
 
	gDu¿tiÚ
 {

59 
pub
 
â
 
z”o
(è-> 
	gDu¿tiÚ
 {

60 
	gDu¿tiÚ
 {

61 
	gdur
: 
StdDu¿tiÚ
::
äom_£cs
(0),

62 
	gÃg
: 
çl£
,

63 
	gf¥
: 0,

67 
pub
 
â
 
g‘_f¥
(&
£lf
è-> 
	gu8
 {

68 
	g£lf
.
	gf¥


71 
pub
 
â
 
hours
(&
£lf
è-> 
	gu64
 {

72 
	g£lf
.
	gdur
.
as_£cs
(è/ 
	gSECS_PER_HOUR


75 
pub
 
â
 
mšu‹s
(&
£lf
è-> 
	gu64
 {

76 
	g£lf
.
	gdur
.
as_£cs
(è% 
	gSECS_PER_HOUR
 / 
	gSECS_PER_MINUTE


79 
pub
 
â
 
£cs
(&
£lf
è-> 
	gu64
 {

80 
	g£lf
.
	gdur
.
as_£cs
(è% 
	gSECS_PER_MINUTE


83 
pub
 
â
 
miüo_£cs
(&
£lf
è-> 
	gu32
 {

84 
	g£lf
.
	gdur
.
sub£c_Çnos
()

87 
pub
 
â
 
to_£cs
(&
£lf
è-> 
	gf64
 {

88 
Ët
 
	g»s
 = 
£lf
.
dur
.
as_£cs
(è
as
 
f64
 + s–f.dur.
sub£c_Çnos
()‡s f64 * 10e-9;

89 
	g£lf
.
	gÃg
 {

90 -
	g»s


92 
	g»s


96 
pub
 
â
 
is_em±y
(&
£lf
è-> 
	gboŞ
 {

97 
	g£lf
.
to_Çnos
() == 0

100 
pub
 
â
 
to_Çnos
(&
£lf
è-> 
	gi64
 {

101 
Ët
 
	gÇnos
 = 
£lf
.
dur
.
as_£cs
(è
as
 
i64
 * 
NANOS_PER_SEC
 + s–f.dur.
sub£c_Çnos
()‡s i64;

102 
	g£lf
.
	gÃg
 {

103 -
	gÇnos


105 
	gÇnos


109 
pub
 
â
 
äom_Çnos
(
Çnos
: 
i64
, 
f¥
: 
i8
è-> 
ResuÉ
<
Du¿tiÚ
> {

110 
Ët
 
Ãg
 = 
Çnos
 < 0;

111 
Ët
 
	gÇnos
 = 
Çnos
.
abs
();

113 
Ët
 
	gdur
 = 
StdDu¿tiÚ
::
Ãw
(

114 (
Çnos
 / 
NANOS_PER_SEC
è
as
 
u64
,

115 (
Çnos
 % 
NANOS_PER_SEC
è
as
 
u32
,

117 
	gDu¿tiÚ
::
Ãw
(
dur
, 
Ãg
, 
f¥
)

120 
pub
 
â
 
Ãw
(
dur
: 
StdDu¿tiÚ
, 
Ãg
: 
boŞ
, 
f¥
: 
i8
è-> 
ResuÉ
<
Du¿tiÚ
> {

121 
check_dur
(&
dur
)?;

122 
Ok
(
Du¿tiÚ
 {

123 
dur
: dur,

124 
Ãg
:‚eg,

125 
f¥
: 
check_f¥
(fsp)?,

132 
pub
 
â
 
·r£
(
mut
 
s
: &[
u8
], 
f¥
: 
i8
è-> 
ResuÉ
<
Du¿tiÚ
> {

133 
Ët
 
f¥
 = 
check_f¥
(fsp)?;

135 
Ët
 (
mut
 
Ãg
, muˆ
day
, muˆ
äac
èğ(
çl£
, 
	gNÚe
, 0);

137 
	gs
.
is_em±y
() {

138  
Ok
(
Du¿tiÚ
::
z”o
());

139 } 
	gs
[0] =ğ
b
'-' {

140 
s
 = &s[1..];

141 
	gÃg
 = 
Œue
;

144 
Ët
 
mut
 
	g·¹s
 = 
s
.
¥l™n
(2, |
c
| *ø=ğ
b
' ');

145 
	gs
 = 
·¹s
.
Ãxt
().
unw¿p
();

146 
Ët
 
Some
(
»maš
èğ
·¹s
.
Ãxt
() {

147 
Ët
 
day_¡r
 = 
¡r
::
äom_utf8
(
s
)?;

148 
	gday
 = 
Some
(
box_Œy
!(
u64
::
äom_¡r_¿dix
(
day_¡r
, 10)));

149 
	gs
 = 
»maš
;

152 
Ët
 
mut
 
	g·¹s
 = 
s
.
¥l™n
(2, |
c
| *ø=ğ
b
'.');

153 
	gs
 = 
·¹s
.
Ãxt
().
unw¿p
();

154 
Ët
 
Some
(
äac_·¹
èğ
·¹s
.
Ãxt
() {

155 
äac
 = 
·r£_äac
(
äac_·¹
, 
f¥
)?;

156 
	gäac
 *ğ10u32.
pow
(
NANO_WIDTH
 - 
f¥
 
as
 
u32
);

159 
Ët
 
mut
 
	g·¹s
 = 
s
.
¥l™n
(2, |
c
| *ø=ğ
b
':');

160 
	gs
 = 
·¹s
.
Ãxt
().
unw¿p
();

161 
Ët
 
	gs_¡r
 = 
¡r
::
äom_utf8
(
s
)?;

162 
Ët
 
mut
 
	g£cs
;

163 
m©ch
 
	g·¹s
.
Ãxt
() {

164 
Some
(
»maš
) => {

165 
Ët
 
»maš_¡r
 = 
¡r
::
äom_utf8
(
»maš
)?;

166 
Ët
 
	gt
 = 
box_Œy
!(
m©ch
 
»maš
.
Ën
() {

167 5 => 
time
::
¡½time
(
»maš_¡r
, "%M:%S"),

168 2 => 
time
::
¡½time
(
»maš_¡r
, "%M"),

169 
	g_
 =>  
E¼
(
šv®id_ty³
!("{} i šv®idime.", 
»maš_¡r
)),

171 
	g£cs
 = 
tm_to_£cs
(
t
);

172 
	g£cs
 +ğ
box_Œy
!(
u64
::
äom_¡r_¿dix
(
s_¡r
, 10)è* 
	gSECS_PER_HOUR
;

174 
NÚe
 
	gday
.
is_some
() => {

175 
£cs
 = 
box_Œy
!(
u64
::
äom_¡r_¿dix
(
s_¡r
, 10)è* 
	gSECS_PER_HOUR
;

177 
	gNÚe
 => {

178 
Ët
 
t
 = 
box_Œy
!(
m©ch
 
s
.
Ën
() {

179 6 => 
time
::
¡½time
(
s_¡r
, "%H%M%S"),

180 4 => 
time
::
¡½time
(
s_¡r
, "%M%S"),

181 2 => 
time
::
¡½time
(
s_¡r
, "%S"),

182 
	g_
 =>  
E¼
(
šv®id_ty³
!("{} i šv®idime", 
s_¡r
)),

184 
	g£cs
 = 
tm_to_£cs
(
t
);

188 
Ët
 
Some
(
day
) = day {

189 
£cs
 +ğ
day
 * 
SECS_PER_HOUR
 * 24;

192 
Ët
 
	gdur
 = 
StdDu¿tiÚ
::
Ãw
(
£cs
, 
äac
);

193 
	gDu¿tiÚ
::
Ãw
(
dur
, 
Ãg
, 
f¥
 
as
 
i8
)

196 
pub
 
â
 
to_decim®
(&
£lf
è-> 
	gResuÉ
<
	gDecim®
> {

197 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(13);

198 
	g£lf
.
	gÃg
 {

199 
	gwr™e
!(
	gbuf
, "-")?;

201 
	gwr™e
!(

202 
	gbuf
,

204 
	g£lf
.
hours
(),

205 
	g£lf
.
mšu‹s
(),

206 
	g£lf
.
£cs
()

208 
	g£lf
.
	gf¥
 > 0 {

209 
	gwr™e
!(
	gbuf
, ".")?;

210 
Ët
 
	gÇnos
 = 
£lf
.
miüo_£cs
(è/ (10u32.
pow
(
NANO_WIDTH
 - s–f.
f¥
 
as
 
u32
));

211 
	gwr™e
!(
	gbuf
, "{:01$}", 
	gÇnos
, 
	g£lf
.
f¥
 
as
 
	gusize
)?;

213 
Ët
 
	gd
 = 
un§ã
 { 
¡r
::
äom_utf8_unchecked
(&
buf
).
·r£
()? };

214 
Ok
(
d
)

217 
pub
 
â
 
round_äac
(&
mut
 
£lf
, 
f¥
: 
i8
è-> 
ResuÉ
<()> {

218 
Ët
 
f¥
 = 
check_f¥
(fsp)?;

219 
	gf¥
 >ğ
£lf
.
f¥
 {

220 
£lf
.
f¥
 = fsp;

221  
Ok
(());

223 
	g£lf
.
	gf¥
 = 
f¥
;

224 
Ët
 
	gÇnos
 =

225 
£lf
.
dur
.
sub£c_Çnos
(è
as
 
f64
 / (10u32.
pow
(
NANO_WIDTH
 - s–f.
f¥
‡ 
u32
)‡s f64);

226 
Ët
 
	gÇnos
 = (
Çnos
.
round
(è
as
 
u32
è* (10u32.
pow
(
NANO_WIDTH
 - 
£lf
.
f¥
‡s u32));

227 
	g£lf
.
	gdur
 = 
StdDu¿tiÚ
::
Ãw
(
£lf
.
dur
.
as_£cs
(), 
Çnos
);

228 
Ok
(())

232 
im¶
 
Di¥Ïy
 
	gDu¿tiÚ
 {

233 
â
 
fmt
(&
£lf
, 
fÜm©‹r
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

234 
£lf
.
Ãg
 {

235 
wr™e
!(
fÜm©‹r
, "-")?;

237 
	gwr™e
!(

238 
	gfÜm©‹r
,

240 
	g£lf
.
hours
(),

241 
	g£lf
.
mšu‹s
(),

242 
	g£lf
.
£cs
()

244 
	g£lf
.
	gf¥
 > 0 {

245 
	gwr™e
!(
	gfÜm©‹r
, ".")?;

246 
Ët
 
	gÇnos
 = 
£lf
.
miüo_£cs
(è/ (10u32.
pow
(
NANO_WIDTH
 - s–f.
f¥
 
as
 
u32
));

247 
	gwr™e
!(
	gfÜm©‹r
, "{:01$}", 
	gÇnos
, 
	g£lf
.
f¥
 
as
 
	gusize
)?;

249 
Ok
(())

253 
im¶
 
P¬tŸlEq
 
	gDu¿tiÚ
 {

254 
â
 
eq
(&
£lf
, 
dur
: &
Du¿tiÚ
è-> 
boŞ
 {

255 
£lf
.
Ãg
 =ğ
dur
.Ãg && s–f.dur.
eq
(&dur.dur)

259 
im¶
 
P¬tŸlOrd
 
Du¿tiÚ
 {

260 
â
 
·¹Ÿl_cmp
(&
£lf
, 
dur
: &
Du¿tiÚ
è-> 
O±iÚ
<
Ord”šg
> {

261 
Some
(
m©ch
 (
£lf
.
Ãg
, 
dur
.neg) {

262 (
Œue
,rueè=> 
dur
.dur.
cmp
(&
£lf
.dur),

263 (
Œue
, 
çl£
è=> 
Ord”šg
::
Less
,

264 (
çl£
, 
Œue
è=> 
Ord”šg
::
G»©”
,

265 (
çl£
, f®£è=> 
£lf
.
dur
.
cmp
(&dur.dur),

270 
im¶
 
Eq
 
	gDu¿tiÚ
 {}

272 
im¶
 
Ord
 
	gDu¿tiÚ
 {

273 
â
 
cmp
(&
£lf
, 
dur
: &
Du¿tiÚ
è-> 
Ord”šg
 {

274 
£lf
.
·¹Ÿl_cmp
(
dur
).
unw¿p
()

278 #[
cfg
(
‹¡
)]

279 
mod
 
‹¡
 {

280 
u£
 
cİroûssÜ
::
codec
::
mysql
::
MAX_FSP
;

281 
u£
 
	gut
::
esÿ³
;

282 
u£
 
	gsu³r
::*;

284 #[
‹¡
]

285 
â
 
‹¡_·r£
() {

286 
Ët
 
	gÿ£s
: 
Vec
<(&'¡©iø[u8], i8, O±iÚ<&'
¡r
>)> = 
vec
![

287 (
b
"10:11:12", 0, 
Some
("10:11:12")),

288 (
b
"101112", 0, 
Some
("10:11:12")),

289 (
b
"10:11", 0, 
Some
("10:11:00")),

290 (
b
"101112.123456", 0, 
Some
("10:11:12")),

291 (
b
"1112", 0, 
Some
("00:11:12")),

292 (
b
"12", 0, 
Some
("00:00:12")),

293 (
b
"1 12", 0, 
Some
("36:00:00")),

294 (
b
"1 10:11:12", 0, 
Some
("34:11:12")),

295 (
b
"1 10:11:12.123456", 0, 
Some
("34:11:12")),

296 (
b
"1 10:11:12.123456", 4, 
Some
("34:11:12.1235")),

297 (
b
"1 10:11:12.12", 4, 
Some
("34:11:12.1200")),

298 (
b
"1 10:11:12.1234565", 6, 
Some
("34:11:12.123457")),

299 (
b
"1 10:11:12.9999995", 6, 
Some
("34:11:13.000000")),

300 (
b
"1 10:11:12.123456", 7, 
NÚe
),

301 (
b
"10:11:12.123456", 0, 
Some
("10:11:12")),

302 (
b
"1 10:11", 0, 
Some
("34:11:00")),

303 (
b
"1 10", 0, 
Some
("34:00:00")),

304 (
b
"24 10", 0, 
Some
("586:00:00")),

305 (
b
"-24 10", 0, 
Some
("-586:00:00")),

306 (
b
"0 10", 0, 
Some
("10:00:00")),

307 (
b
"-10:10:10", 0, 
Some
("-10:10:10")),

308 (
b
"-838:59:59", 0, 
Some
("-838:59:59")),

309 (
b
"838:59:59", 0, 
Some
("838:59:59")),

310 (
b
"23:60:59", 0, 
NÚe
),

311 (
b
"54:59:59", 0, 
Some
("54:59:59")),

312 (
b
"2011-11-11 00:00:01", 0, 
NÚe
),

313 (
b
"2011-11-11", 0, 
NÚe
),

314 (
b
"--23", 0, 
NÚe
),

315 (
b
"232 10", 0, 
NÚe
),

316 (
b
"-232 10", 0, 
NÚe
),

317 (
b
"00:00:00.1", 0, 
Some
("00:00:00")),

318 (
b
"00:00:00.1", 1, 
Some
("00:00:00.1")),

319 (
b
"00:00:00.777777", 2, 
Some
("00:00:00.78")),

320 (
b
"00:00:00.777777", 6, 
Some
("00:00:00.777777")),

321 (
b
"00:00:00.001", 3, 
Some
("00:00:00.001")),

324 
	gšput
, 
	gf¥
, 
	gex³ù
è
š
 
	gÿ£s
 {

325 
Ët
 
	gd
 = 
Du¿tiÚ
::
·r£
(
šput
, 
f¥
);

326 
m©ch
 
	gex³ù
 {

327 
Some
(
exp
) => {

328 
Ët
 
s
 = 
fÜm©
!("{}", 
	gd
.
ex³ù
(&
esÿ³
(
šput
)));

329 
	gs
 !ğ
ex³ù
.
unw¿p
() {

330 
·nic
!("ex³ù…¬£ {}Ø{}, gÙ {}", 
esÿ³
(
šput
), 
exp
, 
s
);

333 
	gNÚe
 => !
d
.
is_”r
() {

334 
·nic
!("{} should‚Ù b·s£d, gÙ {:?}", 
esÿ³
(
šput
), 
d
);

340 #[
‹¡
]

341 
â
 
‹¡_to_decim®
() {

342 
Ët
 
	gÿ£s
 = 
vec
![

359 
	gšput
, 
	gf¥
, 
	gexp
è
š
 
	gÿ£s
 {

360 
Ët
 
	gt
 = 
Du¿tiÚ
::
·r£
(
šput
.
as_by‹s
(), 
f¥
).
unw¿p
();

361 
Ët
 
	g»s
 = 
fÜm©
!("{}", 
	gt
.
to_decim®
().
unw¿p
());

362 
	gas£¹_eq
!(
	gexp
, 
	g»s
);

366 #[
‹¡
]

367 
â
 
‹¡_round_äac
() {

368 
Ët
 
	gÿ£s
 = 
vec
![

378 
	gšput
, 
	gf¥
, 
	gexp
è
š
 
	gÿ£s
 {

379 
Ët
 
mut
 
	gt
 = 
Du¿tiÚ
::
·r£
(
šput
.
as_by‹s
(), 
MAX_FSP
).
unw¿p
();

380 
	gt
.
round_äac
(
f¥
).
unw¿p
();

381 
Ët
 
	g»s
 = 
fÜm©
!("{}", 
	gt
);

382 
	gas£¹_eq
!(
	gexp
, 
	g»s
);

	@src/coprocessor/codec/mysql/json/binary.rs

14 
u£
 
	g¡d
::
cŞËùiÚs
::
BT»eM­
;

15 
u£
 
	g¡d
::
io
::{
R—d
, 
	gWr™e
};

16 
u£
 
	g¡d
::{
¡r
, 
	gf64
};

18 
u£
 
	gby‹Üd”
::{
R—dBy‹sExt
, 
	gWr™eBy‹sExt
};

19 
u£
 
	gut
::
codec
::
numb”
::{
Numb”Decod”
, 
	gNumb”Encod”
};

21 
u£
 
	gsu³r
::
su³r
::
ResuÉ
;

22 
u£
 
	gsu³r
::{
JsÚ
, 
	gERR_CONVERT_FAILED
};

24 cÚ¡ 
	gTYPE_CODE_OBJECT
: 
u8
 = 0x01;

25 cÚ¡ 
	gTYPE_CODE_ARRAY
: 
u8
 = 0x03;

26 cÚ¡ 
	gTYPE_CODE_LITERAL
: 
u8
 = 0x04;

27 cÚ¡ 
	gTYPE_CODE_I64
: 
u8
 = 0x09;

28 cÚ¡ 
	gTYPE_CODE_U64
: 
u8
 = 0x0a;

29 cÚ¡ 
	gTYPE_CODE_DOUBLE
: 
u8
 = 0x0b;

30 cÚ¡ 
	gTYPE_CODE_STRING
: 
u8
 = 0x0c;

32 cÚ¡ 
	gJSON_LITERAL_NIL
: 
u8
 = 0x00;

33 cÚ¡ 
	gJSON_LITERAL_TRUE
: 
u8
 = 0x01;

34 cÚ¡ 
	gJSON_LITERAL_FALSE
: 
u8
 = 0x02;

36 cÚ¡ 
	gTYPE_LEN
: 
usize
 = 1;

37 cÚ¡ 
	gLITERAL_LEN
: 
usize
 = 1;

38 cÚ¡ 
	gU16_LEN
: 
usize
 = 2;

39 cÚ¡ 
	gU32_LEN
: 
usize
 = 4;

40 cÚ¡ 
	gNUMBER_LEN
: 
usize
 = 8;

41 cÚ¡ 
	gKEY_ENTRY_LEN
: 
usize
 = 
U32_LEN
 + 
U16_LEN
;

42 cÚ¡ 
	gVALUE_ENTRY_LEN
: 
usize
 = 
TYPE_LEN
 + 
U32_LEN
;

43 cÚ¡ 
	gELEMENT_COUNT_LEN
: 
usize
 = 
U32_LEN
;

44 cÚ¡ 
	gSIZE_LEN
: 
usize
 = 
U32_LEN
;

51 
im¶
 
	gJsÚ
 {

52 
pub
 
â
 
as_l™”®
(&
£lf
è-> 
	gResuÉ
<
	gu8
> {

53 
m©ch
 *
	g£lf
 {

54 
	gJsÚ
::
BoŞ—n
(
d
) => d {

55 
Ok
(
JSON_LITERAL_TRUE
)

57 
Ok
(
JSON_LITERAL_FALSE
)

59 
	gJsÚ
::
NÚe
 => 
Ok
(
JSON_LITERAL_NIL
),

60 
	g_
 => 
E¼
(
šv®id_ty³
!(

62 
ERR_CONVERT_FAILED
,

63 
£lf
.
to_¡ršg
()

68 
pub
 
â
 
bš¬y_Ën
(&
£lf
è-> 
	gusize
 {

69 
	gTYPE_LEN
 + 
	g£lf
.
body_bš¬y_Ën
()

72 
â
 
body_bš¬y_Ën
(&
£lf
è-> 
	gusize
 {

73 
m©ch
 *
	g£lf
 {

74 
	gJsÚ
::
Objeù
(
»f
 
d
è=> 
g‘_obj_bš¬y_Ën
(d),

75 
	gJsÚ
::
A¼ay
(
»f
 
d
è=> 
g‘_¬¿y_bš¬y_Ën
(d),

76 
	gJsÚ
::
BoŞ—n
(
_
è| 
JsÚ
::
NÚe
 => 
LITERAL_LEN
,

77 
	gJsÚ
::
I64
(
_
è| 
JsÚ
::
U64
(_è| JsÚ::
DoubË
(_è=> 
NUMBER_LEN
,

78 
	gJsÚ
::
SŒšg
(
»f
 
d
è=> 
g‘_¡r_bš¬y_Ën
(d),

82 
â
 
g‘_ty³_code
(&
£lf
è-> 
	gu8
 {

83 
m©ch
 *
	g£lf
 {

84 
	gJsÚ
::
Objeù
(
_
è=> 
TYPE_CODE_OBJECT
,

85 
	gJsÚ
::
A¼ay
(
_
è=> 
TYPE_CODE_ARRAY
,

86 
	gJsÚ
::
BoŞ—n
(
_
è| 
JsÚ
::
NÚe
 => 
TYPE_CODE_LITERAL
,

87 
	gJsÚ
::
I64
(
_
è=> 
TYPE_CODE_I64
,

88 
	gJsÚ
::
U64
(
_
è=> 
TYPE_CODE_U64
,

89 
	gJsÚ
::
DoubË
(
_
è=> 
TYPE_CODE_DOUBLE
,

90 
	gJsÚ
::
SŒšg
(
_
è=> 
TYPE_CODE_STRING
,

95 
pub
 
Œa™
 
	gJsÚEncod”
: 
Numb”Encod”
 {

96 
â
 
’code_jsÚ
(&
mut
 
£lf
, 
d©a
: &
JsÚ
è-> 
ResuÉ
<()> {

97 
£lf
.
wr™e_u8
(
d©a
.
g‘_ty³_code
())?;

98 
	g£lf
.
’code_jsÚ_body
(
d©a
)

101 
â
 
’code_jsÚ_body
(&
mut
 
£lf
, 
d©a
: &
JsÚ
è-> 
ResuÉ
<()> {

102 
m©ch
 *
d©a
 {

103 
JsÚ
::
Objeù
(
»f
 
d
è=> 
£lf
.
’code_obj
(d),

104 
	gJsÚ
::
A¼ay
(
»f
 
d
è=> 
£lf
.
’code_¬¿y
(d),

105 
	gJsÚ
::
BoŞ—n
(
_
è| 
JsÚ
::
NÚe
 => {

106 
Ët
 
v
 = 
d©a
.
as_l™”®
()?;

107 
	g£lf
.
’code_l™”®
(
v
)

109 
	gJsÚ
::
I64
(
d
è=> 
£lf
.
’code_jsÚ_i64
(d),

110 
	gJsÚ
::
U64
(
d
è=> 
£lf
.
’code_jsÚ_u64
(d),

111 
	gJsÚ
::
DoubË
(
d
è=> 
£lf
.
’code_jsÚ_f64
(d),

112 
	gJsÚ
::
SŒšg
(
»f
 
d
è=> 
£lf
.
’code_¡r
(d),

116 
â
 
’code_obj
(&
mut
 
£lf
, 
d©a
: &
BT»eM­
<
SŒšg
, 
JsÚ
>è-> 
	gResuÉ
<()> {

118 
Ët
 
	g–em’t_couÁ
 = 
d©a
.
Ën
();

120 
Ët
 
	gkey_’Œ›s_Ën
 = 
KEY_ENTRY_LEN
 * 
–em’t_couÁ
;

122 
Ët
 
	gv®ue_’Œ›s_Ën
 = 
VALUE_ENTRY_LEN
 * 
–em’t_couÁ
;

123 
Ët
 
mut
 
	gkey_’Œ›s
 = 
Vec
::
w™h_ÿ·c™y
(
key_’Œ›s_Ën
);

124 
Ët
 
mut
 
	g’code_keys
 = 
Vec
::
Ãw
();

125 
Ët
 
mut
 
	gkey_off£t
 = 
ELEMENT_COUNT_LEN
 + 
SIZE_LEN
 + 
key_’Œ›s_Ën
 + 
v®ue_’Œ›s_Ën
;

126 
key
 
š
 
	gd©a
.
keys
() {

127 
Ët
 
	g’code_key
 = 
key
.
as_by‹s
();

128 
Ët
 
	gkey_Ën
 = 
’code_keys
.
wr™e
(
’code_key
)?;

129 
	gkey_’Œ›s
.
’code_u32_Ë
(
key_off£t
 
as
 
u32
)?;

130 
	gkey_’Œ›s
.
’code_u16_Ë
(
key_Ën
 
as
 
u16
)?;

131 
	gkey_off£t
 +ğ
key_Ën
;

134 
Ët
 
mut
 
	gv®ue_off£t
 = 
key_off£t
 
as
 
u32
;

135 
Ët
 
mut
 
	gv®ue_’Œ›s
 = 
Vec
::
w™h_ÿ·c™y
(
v®ue_’Œ›s_Ën
);

136 
Ët
 
mut
 
	g’code_v®ues
 = 
vec
![];

137 
v®ue
 
š
 
	gd©a
.
v®ues
() {

138 
	gv®ue_’Œ›s


139 .
’code_jsÚ_™em
(
v®ue
, &
mut
 
v®ue_off£t
, &muˆ
’code_v®ues
)?;

141 
Ët
 
	gsize
 = 
ELEMENT_COUNT_LEN
 + 
SIZE_LEN
 + 
key_’Œ›s_Ën
 + 
v®ue_’Œ›s_Ën
 +

142 
’code_keys
.
Ën
(è+ 
’code_v®ues
.len();

143 
	g£lf
.
’code_u32_Ë
(
–em’t_couÁ
 
as
 
u32
)?;

144 
	g£lf
.
’code_u32_Ë
(
size
 
as
 
u32
)?;

145 
	g£lf
.
wr™e_®l
(
key_’Œ›s
.
as_mut
())?;

146 
	g£lf
.
wr™e_®l
(
v®ue_’Œ›s
.
as_mut
())?;

147 
	g£lf
.
wr™e_®l
(
’code_keys
.
as_mut
())?;

148 
	g£lf
.
wr™e_®l
(
’code_v®ues
.
as_mut
())?;

149 
Ok
(())

152 
â
 
’code_¬¿y
(&
mut
 
£lf
, 
d©a
: &[
JsÚ
]è-> 
ResuÉ
<()> {

154 
Ët
 
–em’t_couÁ
 = 
d©a
.
Ën
();

155 
Ët
 
	gv®ue_’Œ›s_Ën
 = 
VALUE_ENTRY_LEN
 * 
–em’t_couÁ
;

156 
Ët
 
mut
 
	gv®ue_off£t
 = (
ELEMENT_COUNT_LEN
 + 
SIZE_LEN
 + 
v®ue_’Œ›s_Ën
è
as
 
u32
;

157 
Ët
 
mut
 
	gv®ue_’Œ›s
 = 
Vec
::
w™h_ÿ·c™y
(
v®ue_’Œ›s_Ën
);

158 
Ët
 
mut
 
	g’code_v®ues
 = 
vec
![];

159 
v®ue
 
š
 
	gd©a
 {

160 
	gv®ue_’Œ›s


161 .
’code_jsÚ_™em
(
v®ue
, &
mut
 
v®ue_off£t
, &muˆ
’code_v®ues
)?;

163 
Ët
 
	gtÙ®_size
 = 
ELEMENT_COUNT_LEN
 + 
SIZE_LEN
 + 
v®ue_’Œ›s_Ën
 + 
’code_v®ues
.
Ën
();

164 
	g£lf
.
’code_u32_Ë
(
–em’t_couÁ
 
as
 
u32
)?;

165 
	g£lf
.
’code_u32_Ë
(
tÙ®_size
 
as
 
u32
)?;

166 
	g£lf
.
wr™e_®l
(
v®ue_’Œ›s
.
as_mut
())?;

167 
	g£lf
.
wr™e_®l
(
’code_v®ues
.
as_mut
())?;

168 
Ok
(())

171 
â
 
’code_l™”®
(&
mut
 
£lf
, 
d©a
: 
u8
è-> 
ResuÉ
<()> {

172 
£lf
.
wr™e_u8
(
d©a
)?;

173 
Ok
(())

176 
â
 
’code_jsÚ_i64
(&
mut
 
£lf
, 
d©a
: 
i64
è-> 
ResuÉ
<()> {

177 
£lf
.
’code_i64_Ë
(
d©a
)

180 
â
 
’code_jsÚ_u64
(&
mut
 
£lf
, 
d©a
: 
u64
è-> 
ResuÉ
<()> {

181 
£lf
.
’code_u64_Ë
(
d©a
)

184 
â
 
’code_jsÚ_f64
(&
mut
 
£lf
, 
d©a
: 
f64
è-> 
ResuÉ
<()> {

185 
£lf
.
’code_f64_Ë
(
d©a
)

188 
â
 
’code_¡r
(&
mut
 
£lf
, 
d©a
: &
¡r
è-> 
ResuÉ
<()> {

189 
Ët
 
by‹s
 = 
d©a
.
as_by‹s
();

190 
Ët
 
	gby‹s_Ën
 = 
by‹s
.
Ën
(è
as
 
u64
;

191 
	g£lf
.
’code_v¬_u64
(
by‹s_Ën
)?;

192 
	g£lf
.
wr™e_®l
(
by‹s
)?;

193 
Ok
(())

196 
â
 
’code_jsÚ_™em
(

197 &
mut
 
£lf
,

198 
d©a
: &
JsÚ
,

199 
off£t
: &
mut
 
u32
,

200 
d©a_buf
: &
mut
 
Vec
<
u8
>,

201 è-> 
	gResuÉ
<()> {

202 
Ët
 
	gcode
 = 
d©a
.
g‘_ty³_code
();

203 
	g£lf
.
wr™e_u8
(
code
)?;

204 
m©ch
 *
	gd©a
 {

207 
	gJsÚ
::
BoŞ—n
(
_
è| 
JsÚ
::
NÚe
 => {

208 
Ët
 
v
 = 
d©a
.
as_l™”®
()?;

209 
	g£lf
.
wr™e_u8
(
v
)?;

210 
Ët
 
	gËá
 = 
U32_LEN
 - 
LITERAL_LEN
;

211 
_
 
	gš
 0..Ëf
	gt
 {

212 
	g£lf
.
wr™e_u8
(
JSON_LITERAL_NIL
)?;

215 
	g_
 => {

216 
£lf
.
’code_u32_Ë
(*
off£t
)?;

217 
Ët
 
	g¡¬t_Ën
 = 
d©a_buf
.
Ën
();

218 
	gd©a_buf
.
’code_jsÚ_body
(
d©a
)?;

219 *
	goff£t
 +ğ(
d©a_buf
.
Ën
(è- 
¡¬t_Ën
è
as
 
u32
;

222 
Ok
(())

226 
	gim¶
<
	gT
: 
Wr™e
> 
JsÚEncod”
 
T
 {}

228 
pub
 
Œa™
 
JsÚDecod”
: 
Numb”Decod”
 {

229 
â
 
decode_jsÚ
(&
mut
 
£lf
è-> 
ResuÉ
<
JsÚ
> {

230 
Ët
 
code
 = 
£lf
.
»ad_u8
()?;

231 
	g£lf
.
decode_jsÚ_body
(
code
)

234 
â
 
decode_jsÚ_body
(&
mut
 
£lf
, 
code_ty³
: 
u8
è-> 
ResuÉ
<
JsÚ
> {

235 
m©ch
 
code_ty³
 {

236 
TYPE_CODE_OBJECT
 => 
£lf
.
decode_jsÚ_obj
(),

237 
	gTYPE_CODE_ARRAY
 => 
£lf
.
decode_jsÚ_¬¿y
(),

238 
	gTYPE_CODE_LITERAL
 => 
£lf
.
decode_jsÚ_l™”®
(),

239 
	gTYPE_CODE_I64
 => 
£lf
.
decode_jsÚ_i64
(),

240 
	gTYPE_CODE_U64
 => 
£lf
.
decode_jsÚ_u64
(),

241 
	gTYPE_CODE_DOUBLE
 => 
£lf
.
decode_jsÚ_doubË
(),

242 
	gTYPE_CODE_STRING
 => 
£lf
.
decode_jsÚ_¡r
(),

243 
	g_
 => 
E¼
(
šv®id_ty³
!("unsuµÜ‹dy³ {:?}", 
code_ty³
)),

247 
â
 
decode_jsÚ_obj
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gJsÚ
> {

249 
Ët
 
	g–em’t_couÁ
 = 
£lf
.
decode_u32_Ë
()? 
as
 
usize
;

250 
Ët
 
	gtÙ®_size
 = 
£lf
.
decode_u32_Ë
()? 
as
 
usize
;

251 
Ët
 
	gËá_size
 = 
tÙ®_size
 - 
ELEMENT_COUNT_LEN
 - 
SIZE_LEN
;

252 
Ët
 
mut
 
	gd©a
 = 
vec
![0; 
Ëá_size
];

253 
	g£lf
.
»ad_exaù
(&
mut
 
d©a
)?;

254 
Ët
 
mut
 
	gobj
 = 
BT»eM­
::
Ãw
();

255 
	g–em’t_couÁ
 == 0 {

256  
Ok
(
JsÚ
::
Objeù
(
obj
));

259 
Ët
 
	gkey_’Œ›s_Ën
 = 
KEY_ENTRY_LEN
 * 
–em’t_couÁ
;

260 
Ët
 
mut
 
	gkey_’Œ›s_d©a
 = &
d©a
[0..
key_’Œ›s_Ën
];

263 
Ët
 
	gv®ue_’Œ›s_Ën
 = 
VALUE_ENTRY_LEN
 * 
–em’t_couÁ
;

264 
Ët
 
mut
 
	gv®ue_’Œ›s_d©a
 = &
d©a
[
key_’Œ›s_Ën
..(key_’Œ›s_ËÀ+ 
v®ue_’Œ›s_Ën
)];

265 
Ët
 
mut
 
	gkey_off£t
 = 
key_’Œ›s_Ën
 + 
v®ue_’Œ›s_Ën
;

266 
_
 
	gš
 0..–e
	gm’t_couÁ
 {

267 
Ët
 
	gkey_»®_off£t
 = 
key_’Œ›s_d©a
.
decode_u32_Ë
()?;

268 
Ët
 
	gkey_Ën
 = 
key_’Œ›s_d©a
.
decode_u16_Ë
()?;

269 
Ët
 
	gkey_d©a
 = &
d©a
[
key_off£t
..(key_off£ˆ+ 
key_Ën
 
as
 
usize
)];

270 
Ët
 
	gkey
 = 
SŒšg
::
äom
(
¡r
::
äom_utf8
(
key_d©a
).
unw¿p
());

271 
Ët
 
	gv®ue
 = 
v®ue_’Œ›s_d©a


272 .
decode_jsÚ_™em
(&
d©a
[
key_off£t
..], 
key_»®_off£t
)?;

273 
	gobj
.
š£¹
(
key
, 
v®ue
);

274 
	gkey_off£t
 +ğ
key_Ën
 
as
 
usize
;

276 
Ok
(
JsÚ
::
Objeù
(
obj
))

279 
â
 
decode_jsÚ_¬¿y
(&
mut
 
£lf
è-> 
ResuÉ
<
JsÚ
> {

281 
Ët
 
–em’t_couÁ
 = 
£lf
.
decode_u32_Ë
()? 
as
 
usize
;

282 
Ët
 
	gtÙ®_size
 = 
£lf
.
decode_u32_Ë
()?;

284 
Ët
 
	gËá_size
 = 
tÙ®_size
 
as
 
usize
 - 
ELEMENT_COUNT_LEN
 - 
SIZE_LEN
;

285 
Ët
 
mut
 
	gd©a
 = 
vec
![0; 
Ëá_size
];

286 
	g£lf
.
»ad_exaù
(&
mut
 
d©a
)?;

287 
Ët
 
	gv®ue_’Œ›s_Ën
 = 
VALUE_ENTRY_LEN
 * 
–em’t_couÁ
;

288 
Ët
 
mut
 
	gv®ue_’Œ›s_d©a
 = &
d©a
[0..
v®ue_’Œ›s_Ën
];

289 
Ët
 
	gv®ues_d©a
 = &
d©a
[
v®ue_’Œ›s_Ën
..];

290 
Ët
 
mut
 
	g¬¿y_d©a
 = 
Vec
::
w™h_ÿ·c™y
(
–em’t_couÁ
);

291 
Ët
 
	gd©a_¡¬t_off£t
 = (
U32_LEN
 + U32_LEN + 
v®ue_’Œ›s_Ën
è
as
 
u32
;

292 
_
 
	gš
 0..–e
	gm’t_couÁ
 {

293 
Ët
 
	gv®ue
 = 
v®ue_’Œ›s_d©a


294 .
decode_jsÚ_™em
(
v®ues_d©a
, 
d©a_¡¬t_off£t
)?;

295 
	g¬¿y_d©a
.
push
(
v®ue
);

297 
Ok
(
JsÚ
::
A¼ay
(
¬¿y_d©a
))

300 
â
 
decode_jsÚ_¡r
(&
mut
 
£lf
è-> 
ResuÉ
<
JsÚ
> {

301 
Ët
 
Ëngth
 = 
£lf
.
decode_v¬_u64
()?;

302 
Ët
 
mut
 
	g’code_v®ue
 = 
vec
![0; 
Ëngth
 
as
 
usize
];

303 
	g£lf
.
»ad_exaù
(&
mut
 
’code_v®ue
)?;

304 
Ët
 
	gv®ue
 = 
SŒšg
::
äom_utf8
(
’code_v®ue
)?;

305 
Ok
(
JsÚ
::
SŒšg
(
v®ue
))

308 
â
 
decode_jsÚ_l™”®
(&
mut
 
£lf
è-> 
ResuÉ
<
JsÚ
> {

309 
m©ch
 
£lf
.
»ad_u8
()? {

310 
JSON_LITERAL_TRUE
 => 
Ok
(
JsÚ
::
BoŞ—n
(
Œue
)),

311 
	gJSON_LITERAL_FALSE
 => 
Ok
(
JsÚ
::
BoŞ—n
(
çl£
)),

312 
	g_
 => 
Ok
(
JsÚ
::
NÚe
),

316 
â
 
decode_jsÚ_doubË
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gJsÚ
> {

317 
Ët
 
	gv®ue
 = 
£lf
.
decode_f64_Ë
()?;

318 
Ok
(
JsÚ
::
DoubË
(
v®ue
))

321 
â
 
decode_jsÚ_i64
(&
mut
 
£lf
è-> 
ResuÉ
<
JsÚ
> {

322 
Ët
 
v®ue
 = 
£lf
.
decode_i64_Ë
()?;

323 
Ok
(
JsÚ
::
I64
(
v®ue
))

326 
â
 
decode_jsÚ_u64
(&
mut
 
£lf
è-> 
ResuÉ
<
JsÚ
> {

327 
Ët
 
v®ue
 = 
£lf
.
decode_u64_Ë
()?;

328 
Ok
(
JsÚ
::
U64
(
v®ue
))

331 
â
 
decode_jsÚ_™em
(&
mut
 
£lf
, 
v®ues_d©a
: &[
u8
], 
d©a_¡¬t_pos™iÚ
: 
u32
è-> 
ResuÉ
<
JsÚ
> {

332 
Ët
 
mut
 
’Œy
 = 
vec
![0; 
VALUE_ENTRY_LEN
];

333 
	g£lf
.
»ad_exaù
(&
mut
 
’Œy
)?;

334 
Ët
 
mut
 
	g’Œy
 = 
’Œy
.
as_¦iû
();

335 
Ët
 
	gcode
 = 
’Œy
.
»ad_u8
()?;

336 
m©ch
 
	gcode
 {

337 
	gTYPE_CODE_LITERAL
 => 
’Œy
.
decode_jsÚ_body
(
code
),

338 
	g_
 => {

339 
Ët
 
»®_off£t
 = 
’Œy
.
decode_u32_Ë
().
unw¿p
();

340 
Ët
 
	goff£t_š_v®ues
 = 
»®_off£t
 - 
d©a_¡¬t_pos™iÚ
;

341 
Ët
 
mut
 
	gv®ue
 = &
v®ues_d©a
[
off£t_š_v®ues
 
as
 
usize
..];

342 
	gv®ue
.
decode_jsÚ_body
(
code
)

348 
	gim¶
<
	gT
: 
R—d
> 
JsÚDecod”
 
T
 {}

350 
â
 
g‘_obj_bš¬y_Ën
(
d©a
: &
BT»eM­
<
SŒšg
, 
JsÚ
>è-> 
	gusize
 {

351 
Ët
 
	g–em’t_couÁ
 = 
d©a
.
Ën
();

352 
Ët
 
	gkey_’Œ›s_Ën
 = 
–em’t_couÁ
 * 
KEY_ENTRY_LEN
;

353 
Ët
 
	gv®ue_’Œ›s_Ën
 = 
–em’t_couÁ
 * 
VALUE_ENTRY_LEN
;

354 
Ët
 
mut
 
	gkeys_Ën
 = 0;

355 
Ët
 
mut
 
	gv®ues_Ën
 = 0;

356 
	gk
, 
	gv
è
š
 
	gd©a
 {

357 
	gkeys_Ën
 +ğ
k
.
Ën
();

358 
	gv
.
g‘_ty³_code
(è!ğ
TYPE_CODE_LITERAL
 {

359 
v®ues_Ën
 +ğ
v
.
body_bš¬y_Ën
();

363 
	gELEMENT_COUNT_LEN
 + 
	gSIZE_LEN
 + 
	gkey_’Œ›s_Ën
 + 
	gv®ue_’Œ›s_Ën
 + 
	gkeys_Ën
 + 
	gv®ues_Ën


366 
â
 
g‘_¬¿y_bš¬y_Ën
(
d©a
: &[
JsÚ
]è-> 
usize
 {

367 
Ët
 
–em’t_couÁ
 = 
d©a
.
Ën
();

368 
Ët
 
	gv®ue_’Œ›s_Ën
 = 
–em’t_couÁ
 * 
VALUE_ENTRY_LEN
;

369 
Ët
 
mut
 
	gv®ues_Ën
 = 0;

370 
v
 
š
 
	gd©a
 {

371 
	gv
.
g‘_ty³_code
(è!ğ
TYPE_CODE_LITERAL
 {

372 
v®ues_Ën
 +ğ
v
.
body_bš¬y_Ën
();

376 
	gELEMENT_COUNT_LEN
 + 
	gSIZE_LEN
 + 
	gv®ue_’Œ›s_Ën
 + 
	gv®ues_Ën


379 
â
 
g‘_¡r_bš¬y_Ën
(
d©a
: &
¡r
è-> 
usize
 {

380 
Ët
 
Ën
 = 
d©a
.
as_by‹s
().len();

381 
g‘_v¬_u64_bš¬y_Ën
(
Ën
 
as
 
u64
è+ 
	gËn


384 
â
 
g‘_v¬_u64_bš¬y_Ën
(
mut
 
v
: 
u64
è-> 
usize
 {

385 
Ët
 
mut
 
Ën
 = 1;

386 
	gv
 >= 0x80 {

387 
v
 >>= 7;

388 
	gËn
 += 1;

390 
	gËn


393 #[
cfg
(
‹¡
)]

394 
mod
 
	g‹¡
 {

395 
u£
 
	gsu³r
::*;

397 #[
‹¡
]

398 
â
 
‹¡_jsÚ_bš¬y
() {

399 
Ët
 
	gj¡r1
 =

400 
r
#"{"¯¯¯¯¯a": [1, "2", {"¯": "bb"}, 4.0], "bbbbbbbbbb": 
Œue
, "ccccccccc": "d"}"#;

401 
Ët
 
j1
: 
JsÚ
 = 
j¡r1
.
·r£
().
unw¿p
();

402 
Ët
 
	gj¡r2
 = 
r
#"[{"a": 1, "b": 
Œue
}, 3, 3.5, "h–lo, wÜld", 
nuÎ
,rue]"#;

403 
Ët
 
	gj2
: 
JsÚ
 = 
j¡r2
.
·r£
().
unw¿p
();

405 
Ët
 
	gjsÚ_n
 = 
JsÚ
::
NÚe
;

406 
Ët
 
	gjsÚ_boŞ
 = 
JsÚ
::
BoŞ—n
(
Œue
);

407 
Ët
 
	gjsÚ_št
 = 
JsÚ
::
I64
(30);

408 
Ët
 
	gjsÚ_ušt
 = 
JsÚ
::
U64
(30);

409 
Ët
 
	gjsÚ_doubË
 = 
JsÚ
::
DoubË
(3.24);

410 
Ët
 
	gjsÚ_¡r
 = 
JsÚ
::
SŒšg
(SŒšg::
äom
("hello, ä¸–ç•Œ"));

411 
Ët
 
	g‹¡_ÿ£s
 = 
vec
![

412 
jsÚ_n
,

413 
jsÚ_boŞ
,

414 
jsÚ_št
,

415 
jsÚ_ušt
,

416 
jsÚ_doubË
,

417 
jsÚ_¡r
,

418 
j1
,

419 
j2
,

421 
jsÚ
 
š
 
	g‹¡_ÿ£s
 {

422 
Ët
 
mut
 
	gd©a
 = 
vec
![];

423 
	gd©a
.
’code_jsÚ
(&
jsÚ
).
unw¿p
();

424 
Ët
 
	gouut
 = 
d©a
.
as_¦iû
().
decode_jsÚ
().
unw¿p
();

425 
Ët
 
	gšput_¡r
 = 
jsÚ
.
to_¡ršg
();

426 
Ët
 
	gouut_¡r
 = 
ouut
.
to_¡ršg
();

427 
	gas£¹_eq
!(
	gšput_¡r
, 
	gouut_¡r
);

431 #[
‹¡
]

432 
â
 
‹¡_ty³_code
() {

433 
Ët
 
	gËg®_ÿ£s
 = 
vec
![

434 (
r
#"{"key":"value"}"#, TYPE_CODE_OBJECT),

435 (
r
#"["d1","d2"]"#, TYPE_CODE_ARRAY),

436 (
	gr
#"-3"#, TYPE_CODE_I64),

437 (
	gr
#"3"#, TYPE_CODE_U64),

438 (
	gr
#"18446744073709551615"#, TYPE_CODE_U64),

439 (
	gr
#"3.0"#, TYPE_CODE_DOUBLE),

440 (
	gr
#"
	gnuÎ
"#, TYPE_CODE_LITERAL),

441 (
	gr
#"
	gŒue
"#, TYPE_CODE_LITERAL),

442 (
	gr
#"
	gçl£
"#, TYPE_CODE_LITERAL),

445 
	gjsÚ_¡r
, 
	gcode
è
š
 
	gËg®_ÿ£s
 {

446 
Ët
 
	gjsÚ
: 
JsÚ
 = 
jsÚ_¡r
.
·r£
().
unw¿p
();

447 
	gas£¹_eq
!(
	gjsÚ
.
g‘_ty³_code
(), 
	gcode
);

	@src/coprocessor/codec/mysql/json/comparison.rs

14 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

15 
u£
 
	g¡d
::
f64
;

17 
u£
 
	gsu³r
::
su³r
::
ResuÉ
;

18 
u£
 
	gsu³r
::{
JsÚ
, 
	gJsÚEncod”
, 
	gERR_CONVERT_FAILED
};

20 cÚ¡ 
	gPRECEDENCE_BLOB
: 
i32
 = -1;

21 cÚ¡ 
	gPRECEDENCE_BIT
: 
i32
 = -2;

22 cÚ¡ 
	gPRECEDENCE_OPAQUE
: 
i32
 = -3;

23 cÚ¡ 
	gPRECEDENCE_DATETIME
: 
i32
 = -4;

24 cÚ¡ 
	gPRECEDENCE_TIME
: 
i32
 = -5;

25 cÚ¡ 
	gPRECEDENCE_DATE
: 
i32
 = -6;

26 cÚ¡ 
	gPRECEDENCE_BOOLEAN
: 
i32
 = -7;

27 cÚ¡ 
	gPRECEDENCE_ARRAY
: 
i32
 = -8;

28 cÚ¡ 
	gPRECEDENCE_OBJECT
: 
i32
 = -9;

29 cÚ¡ 
	gPRECEDENCE_STRING
: 
i32
 = -10;

30 cÚ¡ 
	gPRECEDENCE_NUMBER
: 
i32
 = -11;

31 cÚ¡ 
	gPRECEDENCE_NULL
: 
i32
 = -12;

33 
im¶
 
	gJsÚ
 {

34 
â
 
g‘_´eûd’û
(&
£lf
è-> 
	gi32
 {

35 
m©ch
 *
	g£lf
 {

36 
	gJsÚ
::
Objeù
(
_
è=> 
PRECEDENCE_OBJECT
,

37 
	gJsÚ
::
A¼ay
(
_
è=> 
PRECEDENCE_ARRAY
,

38 
	gJsÚ
::
BoŞ—n
(
_
è=> 
PRECEDENCE_BOOLEAN
,

39 
	gJsÚ
::
NÚe
 => 
PRECEDENCE_NULL
,

40 
	gJsÚ
::
I64
(
_
è| 
JsÚ
::
U64
(_è| JsÚ::
DoubË
(_è=> 
PRECEDENCE_NUMBER
,

41 
	gJsÚ
::
SŒšg
(
_
è=> 
PRECEDENCE_STRING
,

45 
â
 
as_f64
(&
£lf
è-> 
	gResuÉ
<
	gf64
> {

46 
m©ch
 *
	g£lf
 {

47 
	gJsÚ
::
DoubË
(
d
è=> 
Ok
(d),

48 
	gJsÚ
::
I64
(
d
è=> 
Ok
(d 
as
 
f64
),

49 
	gJsÚ
::
U64
(
d
è=> 
Ok
(d 
as
 
f64
),

50 
	gJsÚ
::
BoŞ—n
(
_
) => {

51 
Ët
 
v
 = 
£lf
.
as_l™”®
()?;

52 
Ok
(
v
 
as
 
f64
)

54 
	g_
 => 
E¼
(
šv®id_ty³
!(

56 
ERR_CONVERT_FAILED
,

57 
£lf
.
to_¡ršg
()

63 
im¶
 
Eq
 
	gJsÚ
 {}

64 
im¶
 
Ord
 
	gJsÚ
 {

65 
â
 
cmp
(&
£lf
, 
right
: &
JsÚ
è-> 
Ord”šg
 {

66 
£lf
.
·¹Ÿl_cmp
(
right
).
unw¿p
()

70 
im¶
 
P¬tŸlEq
 
JsÚ
 {

71 
â
 
eq
(&
£lf
, 
right
: &
JsÚ
è-> 
boŞ
 {

72 
£lf
.
·¹Ÿl_cmp
(
right
).
unw¿p
(è=ğ
Ord”šg
::
Equ®


76 
im¶
 
P¬tŸlOrd
 
JsÚ
 {

77 
â
 
·¹Ÿl_cmp
(&
£lf
, 
right
: &
JsÚ
è-> 
O±iÚ
<
Ord”šg
> {

78 
Ët
 
´eûd’û_diff
 = 
£lf
.
g‘_´eûd’û
(è- 
right
.get_precedence();

79 
	g´eûd’û_diff
 == 0 {

80 
£lf
.
g‘_´eûd’û
(è=ğ
PRECEDENCE_NUMBER
 {

81 
Ët
 
Ëá_d©a
 = 
£lf
.
as_f64
().
unw¿p
();

82 
Ët
 
	gright_d©a
 = 
right
.
as_f64
().
unw¿p
();

83 ià(
	gËá_d©a
 - 
	gright_d©a
).
abs
(è< 
	gf64
::
EPSILON
 {

84  
Some
(
Ord”šg
::
Equ®
);

86  
	gËá_d©a
.
·¹Ÿl_cmp
(&
right_d©a
);

90  
m©ch
 (
£lf
, 
right
) {

91 (&
	gJsÚ
::
BoŞ—n
(
Ëá_d©a
), &JsÚ::BoŞ—n(
right_d©a
)) => {

92 
Ëá_d©a
.
·¹Ÿl_cmp
(&
right_d©a
)

94 (&
JsÚ
::
SŒšg
(
»f
 
Ëá_d©a
), &
	gJsÚ
::SŒšgÔeà
right_d©a
)) => {

95 
Ëá_d©a
.
·¹Ÿl_cmp
(
right_d©a
)

97 (&
JsÚ
::
A¼ay
(
»f
 
Ëá_d©a
), &
	gJsÚ
::A¼ayÔeà
right_d©a
)) => {

98 
Ëá_d©a
.
·¹Ÿl_cmp
(
right_d©a
)

100 (&
JsÚ
::
Objeù
(
_
), &
	gJsÚ
::Object(_)) => {

101 
Ët
 
mut
 
Ëá_d©a
 = 
vec
![];

102 
Ët
 
mut
 
	gright_d©a
 = 
vec
![];

103 
	gËá_d©a
.
’code_jsÚ
(
£lf
).
unw¿p
();

104 
	gright_d©a
.
’code_jsÚ
(
right
).
unw¿p
();

105 
	gËá_d©a
.
·¹Ÿl_cmp
(&
right_d©a
)

107 
	g_
 => 
Some
(
Ord”šg
::
Equ®
),

111 
Ët
 
	gËá_d©a
 = 
£lf
.
as_f64
();

112 
Ët
 
	gright_d©a
 = 
right
.
as_f64
();

115 
	gËá_d©a
.
is_ok
(è&& 
	gright_d©a
.is_ok() {

116 
Ët
 
	gËá
 = 
Ëá_d©a
.
unw¿p
();

117 
Ët
 
	gright
 = 
right_d©a
.
unw¿p
();

118  
	gËá
.
·¹Ÿl_cmp
(&
right
);

121 
	g´eûd’û_diff
 > 0 {

122 
Some
(
Ord”šg
::
G»©”
)

124 
Some
(
Ord”šg
::
Less
)

129 #[
cfg
(
‹¡
)]

130 
mod
 
‹¡
 {

131 
u£
 
su³r
::*;

133 #[
‹¡
]

134 
â
 
‹¡_cmp_jsÚ_b‘w“n_§me_ty³
() {

135 
Ët
 
	g‹¡_ÿ£s
 = 
vec
![

140 (
r
#""hello""#,„#""hello, world""#),

141 (
r
#"["a", "b"]"#,„#"["a", "c"]"#),

142 (
	gr
#"{"a": "b"}"#,„#"{"a": "c"}"#),

144 
	gËá_¡r
, 
	gright_¡r
è
š
 
	g‹¡_ÿ£s
 {

145 
Ët
 
	gËá
: 
JsÚ
 = 
Ëá_¡r
.
·r£
().
unw¿p
();

146 
Ët
 
	gright
: 
JsÚ
 = 
right_¡r
.
·r£
().
unw¿p
();

147 
	gas£¹
!(
	gËá
 < 
	gright
);

148 
	gas£¹_eq
!(
	gËá
,†eft);

150 
	gas£¹_eq
!(
	gJsÚ
::
NÚe
, Json::None);

153 #[
‹¡
]

154 
â
 
‹¡_cmp_jsÚ_b‘w“n_diff_ty³
() {

155 
Ët
 
	g‹¡_ÿ£s
 = 
vec
![

160 ("nuÎ", 
r
#"{"a": "b"}"#),

161 ("2", 
r
#""hello, world""#),

162 (
r
#""hello, world""#,„#"{"a": "b"}"#),

163 (
r
#"{"a": "b"}"#,„#"["a", "b"]"#),

164 (
	gr
#"["a", "b"]"#, "
	gçl£
"),

167 
	gËá_¡r
, 
	gright_¡r
è
š
 
	g‹¡_ÿ£s
 {

168 
Ët
 
	gËá
: 
JsÚ
 = 
Ëá_¡r
.
·r£
().
unw¿p
();

169 
Ët
 
	gright
: 
JsÚ
 = 
right_¡r
.
·r£
().
unw¿p
();

170 
	gas£¹
!(
	gËá
 < 
	gright
);

173 
	gas£¹_eq
!(
	gJsÚ
::
I64
(2), JsÚ::
BoŞ—n
(
çl£
));

	@src/coprocessor/codec/mysql/json/json_cast.rs

14 
u£
 
	gsu³r
::
JsÚ
;

16 
im¶
 
	gJsÚ
 {

17 
pub
 
â
 
ÿ¡_to_št
(&
£lf
è-> 
	gi64
 {

18 
m©ch
 *
	g£lf
 {

19 
	gJsÚ
::
Objeù
(
_
è| 
JsÚ
::
A¼ay
(_è| JsÚ::
NÚe
 | JsÚ::
BoŞ—n
(
çl£
) => 0,

20 
	gJsÚ
::
BoŞ—n
(
Œue
) => 1,

21 
	gJsÚ
::
I64
(
d
) => d,

22 
	gJsÚ
::
U64
(
d
è=> d 
as
 
i64
,

23 
	gJsÚ
::
DoubË
(
d
è=> d 
as
 
i64
,

24 
	gJsÚ
::
SŒšg
(
»f
 
s
è=> s.
·r£
::<
i64
>().
unw¿p_Ü
(0),

28 
pub
 
â
 
ÿ¡_to_»®
(&
£lf
è-> 
	gf64
 {

29 
m©ch
 *
	g£lf
 {

30 
	gJsÚ
::
Objeù
(
_
è| 
JsÚ
::
A¼ay
(_è| JsÚ::
NÚe
 | JsÚ::
BoŞ—n
(
çl£
) => 0f64,

31 
	gJsÚ
::
BoŞ—n
(
Œue
) => 1f64,

32 
	gJsÚ
::
I64
(
d
è=> d 
as
 
f64
,

33 
	gJsÚ
::
U64
(
d
è=> d 
as
 
f64
,

34 
	gJsÚ
::
DoubË
(
d
) => d,

35 
	gJsÚ
::
SŒšg
(
»f
 
s
è=> s.
·r£
::<
f64
>().
unw¿p_Ü
(0f64),

40 #[
cfg
(
‹¡
)]

41 
mod
 
	g‹¡
 {

42 
u£
 
	g¡d
::
f64
;

44 
u£
 
	gsu³r
::*;

46 #[
‹¡
]

47 
â
 
‹¡_ÿ¡_to_št
() {

48 
Ët
 
	g‹¡_ÿ£s
 = 
vec
![

57 (
r
#""hello""#, 0),

58 (
r
#""1234""#, 1234),

61 
	gj¡r
, 
	gexp
è
š
 
	g‹¡_ÿ£s
 {

62 
Ët
 
	gjsÚ
: 
JsÚ
 = 
j¡r
.
·r£
().
unw¿p
();

63 
Ët
 
	gg‘
 = 
jsÚ
.
ÿ¡_to_št
();

64 
	gas£¹_eq
!(
	gg‘
, 
	gexp
, "cast_to_int get: {},ƒxp: {}", get,ƒxp);

68 #[
‹¡
]

69 
â
 
‹¡_ÿ¡_to_f64
() {

70 
Ët
 
	g‹¡_ÿ£s
 = 
vec
![

79 (
r
#""hello""#, 0f64),

80 (
r
#""1234""#, 1234f64),

83 
	gj¡r
, 
	gexp
è
š
 
	g‹¡_ÿ£s
 {

84 
Ët
 
	gjsÚ
: 
JsÚ
 = 
j¡r
.
·r£
().
unw¿p
();

85 
Ët
 
	gg‘
 = 
jsÚ
.
ÿ¡_to_»®
();

86 
	gas£¹
!(

87 (
	gg‘
 - 
	gexp
).
abs
(è< 
	gf64
::
EPSILON
,

89 
	gg‘
,

90 
	gexp


	@src/coprocessor/codec/mysql/json/json_extract.rs

15 #![
®low
(
d—d_code
)]

17 
u£
 
	gsu³r
::
JsÚ
;

18 
u£
 
	gsu³r
::
·th_ex´
::{
P©hEx´essiÚ
, 
	gP©hLeg
, 
	gPATH_EXPR_ARRAY_INDEX_ASTERISK
, 
	gPATH_EXPR_ASTERISK
};

20 
im¶
 
	gJsÚ
 {

24 
pub
 
â
 
exŒaù
(&
£lf
, 
·th_ex´_li¡
: &[
P©hEx´essiÚ
]è-> 
O±iÚ
<
JsÚ
> {

25 
Ët
 
mut
 
–em_li¡
 = 
Vec
::
w™h_ÿ·c™y
(
·th_ex´_li¡
.
Ën
());

26 
·th_ex´
 
š
 
	g·th_ex´_li¡
 {

27 
	g–em_li¡
.
­³nd
(&
mut
 
exŒaù_jsÚ
(
£lf
, &
·th_ex´
.
Ëgs
))

29 
	g–em_li¡
.
is_em±y
() {

30  
	gNÚe
;

32 
	g·th_ex´_li¡
.
Ën
(è=ğ1 && 
–em_li¡
.len() == 1 {

35  
Some
(
–em_li¡
.
»move
(0));

37 
Some
(
JsÚ
::
A¼ay
(
–em_li¡
))

42 
pub
 
â
 
exŒaù_jsÚ
(
j
: &
JsÚ
, 
·th_Ëgs
: &[
P©hLeg
]è-> 
Vec
<Json> {

43 
·th_Ëgs
.
is_em±y
() {

44  
vec
![
j
.
şÚe
()];

46 
Ët
 (
cu¼’t_Ëg
, 
sub_·th_Ëgs
èğ(&
·th_Ëgs
[0], &
	g·th_Ëgs
[1..]);

47 
Ët
 
mut
 
	g»t
 = 
vec
![];

48 
m©ch
 *
	gcu¼’t_Ëg
 {

49 
	gP©hLeg
::
Index
(
i
è=> 
m©ch
 *
j
 {

50 
JsÚ
::
A¼ay
(
»f
 
¬¿y
è=> 
i
 =ğ
PATH_EXPR_ARRAY_INDEX_ASTERISK
 {

51 
chd
 
š
 
¬¿y
 {

52 
»t
.
­³nd
(&
mut
 
exŒaù_jsÚ
(
chd
, 
sub_·th_Ëgs
))

54 } ià(
i
 
as
 
usize
è< 
¬¿y
.
Ën
() {

55 
»t
.
­³nd
(&
mut
 
exŒaù_jsÚ
(&
¬¿y
[
i
 
as
 
usize
], 
sub_·th_Ëgs
))

57 
	g_
 => ià(
i
 =ğ
PATH_EXPR_ARRAY_INDEX_ASTERISK
è|| (˜
as
 
usize
 == 0) {

58 
»t
.
­³nd
(&
mut
 
exŒaù_jsÚ
(
j
, 
sub_·th_Ëgs
))

61 
	gP©hLeg
::
Key
(
»f
 
key
è=> 
Ët
 
JsÚ
::
Objeù
Ôeà
m­
èğ*
j
 {

62 
key
 =ğ
PATH_EXPR_ASTERISK
 {

63 
key
 
š
 
m­
.
keys
() {

64 
»t
.
­³nd
(&
mut
 
exŒaù_jsÚ
(&
m­
[
key
], 
sub_·th_Ëgs
))

66 } 
m­
.
cÚšs_key
(
key
) {

67 
»t
.
­³nd
(&
mut
 
exŒaù_jsÚ
(&
m­
[
key
], 
sub_·th_Ëgs
))

70 
	gP©hLeg
::
DoubËA¡”isk
 => {

71 
»t
.
­³nd
(&
mut
 
exŒaù_jsÚ
(
j
, 
sub_·th_Ëgs
));

72 
m©ch
 *
	gj
 {

73 
	gJsÚ
::
A¼ay
(
»f
 
¬¿y
è=> 
chd
 
š
‡rray {

74 
»t
.
­³nd
(&
mut
 
exŒaù_jsÚ
(
chd
, 
·th_Ëgs
))

76 
	gJsÚ
::
Objeù
(
»f
 
m­
è=> 
key
 
š
 m­.
keys
() {

77 
»t
.
­³nd
(&
mut
 
exŒaù_jsÚ
(&
m­
[
key
], 
·th_Ëgs
))

79 
	g_
 => {}

83 
	g»t


86 #[
cfg
(
‹¡
)]

87 
mod
 
	g‹¡
 {

88 
u£
 
	g¡d
::
¡r
::
FromSŒ
;

89 
u£
 
	gsu³r
::*;

90 
u£
 
	gsu³r
::
su³r
::
·th_ex´
::{
P©hEx´essiÚFÏg
, 
	gPATH_EXPRESSION_CONTAINS_ASTERISK
,

91 
	gPATH_EXPRESSION_CONTAINS_DOUBLE_ASTERISK
,

92 
	gPATH_EXPR_ARRAY_INDEX_ASTERISK
};

94 #[
‹¡
]

95 
â
 
‹¡_jsÚ_exŒaù
() {

96 
Ët
 
mut
 
	g‹¡_ÿ£s
 = 
vec
![

98 ("nuÎ", 
vec
![], 
	gNÚe
),

102 
	gvec
![

103 
P©hEx´essiÚ
 {

104 
Ëgs
: 
vec
![
P©hLeg
::
Index
(0)],

105 
	gæags
: 
P©hEx´essiÚFÏg
::(),

108 
Some
("true"),

112 
	gvec
![

113 
P©hEx´essiÚ
 {

114 
Ëgs
: 
vec
![
P©hLeg
::
Index
(
PATH_EXPR_ARRAY_INDEX_ASTERISK
)],

115 
	gæags
: 
PATH_EXPRESSION_CONTAINS_ASTERISK
,

118 
Some
("[true, 2017]"),

122 
	gvec
![

123 
P©hEx´essiÚ
 {

124 
Ëgs
: 
vec
![
P©hLeg
::
Index
(2)],

125 
	gæags
: 
P©hEx´essiÚFÏg
::(),

128 
	gNÚe
,

132 
	gvec
![

133 
P©hEx´essiÚ
 {

134 
Ëgs
: 
vec
![
P©hLeg
::
Index
(0)],

135 
	gæags
: 
P©hEx´essiÚFÏg
::(),

138 
Some
("6.18"),

142 
	gr
#"{"a": "a1", "b": 20.08, "c": 
çl£
}"#,

143 
vec
![

144 
P©hEx´essiÚ
 {

145 
Ëgs
: 
vec
![
P©hLeg
::
Key
(
SŒšg
::
äom
("c"))],

146 
	gæags
: 
P©hEx´essiÚFÏg
::(),

149 
Some
("false"),

152 
	gr
#"{"a": "a1", "b": 20.08, "c": 
çl£
}"#,

153 
vec
![

154 
P©hEx´essiÚ
 {

155 
Ëgs
: 
vec
![
P©hLeg
::
Key
(
SŒšg
::
äom
(
PATH_EXPR_ASTERISK
))],

156 
	gæags
: 
PATH_EXPRESSION_CONTAINS_ASTERISK
,

159 
Some
(
r
#"["a1", 20.08, 
çl£
]"#),

162 
	gr
#"{"a": "a1", "b": 20.08, "c": 
çl£
}"#,

163 
vec
![

164 
P©hEx´essiÚ
 {

165 
Ëgs
: 
vec
![
P©hLeg
::
Key
(
SŒšg
::
äom
("d"))],

166 
	gæags
: 
P©hEx´essiÚFÏg
::(),

169 
	gNÚe
,

174 
	gvec
![

175 
P©hEx´essiÚ
 {

176 
Ëgs
: 
vec
![
P©hLeg
::
DoubËA¡”isk
, P©hLeg::
Key
(
SŒšg
::
äom
("c"))],

177 
	gæags
: 
PATH_EXPRESSION_CONTAINS_DOUBLE_ASTERISK
,

180 
	gNÚe
,

183 
	gr
#"{"g": {"a": "a1", "b": 20.08, "c": 
çl£
}}"#,

184 
vec
![

185 
P©hEx´essiÚ
 {

186 
Ëgs
: 
vec
![
P©hLeg
::
DoubËA¡”isk
, P©hLeg::
Key
(
SŒšg
::
äom
("c"))],

187 
	gæags
: 
PATH_EXPRESSION_CONTAINS_DOUBLE_ASTERISK
,

190 
Some
("false"),

193 
	gr
#"[{"a": "a1", "b": 20.08, "c": 
çl£
}, 
Œue
]"#,

194 
	gvec
![

195 
P©hEx´essiÚ
 {

196 
Ëgs
: 
vec
![
P©hLeg
::
DoubËA¡”isk
, P©hLeg::
Key
(
SŒšg
::
äom
("c"))],

197 
	gæags
: 
PATH_EXPRESSION_CONTAINS_DOUBLE_ASTERISK
,

200 
Some
("false"),

203 
	gi
, (
	gjs
, 
	gex´s
, 
	gex³ùed
)è
š
 
	g‹¡_ÿ£s
.
d¿š
(..).
’um”©e
() {

204 
Ët
 
	gj
 = 
js
.
·r£
();

205 
	gas£¹
!(
	gj
.
is_ok
(), "#{}ƒx³ù…¬£ ok buˆgÙ {:?}", 
	gi
, j);

206 
Ët
 
	gj
: 
JsÚ
 = 
j
.
unw¿p
();

207 
Ët
 
	gex³ùed
 = 
m©ch
 
ex³ùed
 {

208 
Some
(
es
) => {

209 
Ët
 
e
 = 
JsÚ
::
äom_¡r
(
es
);

210 
	gas£¹
!(
	ge
.
is_ok
(), "#{}ƒx³ù…¬£ jsÚ ok buˆgÙ {:?}", 
	gi
,ƒ);

211 
Some
(
e
.
unw¿p
())

213 
	gNÚe
 => 
NÚe
,

215 
Ët
 
	ggÙ
 = 
j
.
exŒaù
(&
ex´s
[..]);

216 
	gas£¹_eq
!(

217 
	ggÙ
,

218 
	gex³ùed
,

220 
	gi
,

221 
	gex³ùed
,

222 
	ggÙ


	@src/coprocessor/codec/mysql/json/json_merge.rs

14 
u£
 
	gsu³r
::
JsÚ
;

16 
im¶
 
	gJsÚ
 {

25 
pub
 
â
 
m”ge
(
£lf
, 
to_m”ge
: 
JsÚ
) -> Json {

26 
m©ch
 (
£lf
, 
to_m”ge
) {

28 (
	gJsÚ
::
A¼ay
(
mut
 
¬¿y
), JsÚ::A¼ay(muˆ
sub_¬¿y
)) => {

29 
¬¿y
.
­³nd
(&
mut
 
sub_¬¿y
);

30 
	gJsÚ
::
A¼ay
(
¬¿y
)

33 (
JsÚ
::
A¼ay
(
mut
 
¬¿y
), 
	gsuffix
) => {

34 
¬¿y
.
push
(
suffix
);

35 
	gJsÚ
::
A¼ay
(
¬¿y
)

38 (
JsÚ
::
Objeù
(
mut
 
obj
), 
	gJsÚ
::Objeù(
sub_obj
)) => {

39 
sub_key
, 
sub_v®ue
è
š
 
sub_obj
 {

40 
Ët
 
v
 = Ëˆ
Some
(
v®ue
èğ
obj
.
»move
(&
sub_key
) {

41 
v®ue
.
m”ge
(
sub_v®ue
)

43 
sub_v®ue


45 
	gobj
.
š£¹
(
sub_key
, 
v
);

47 
	gJsÚ
::
Objeù
(
obj
)

50 (
obj
, 
	gJsÚ
::
A¼ay
(
mut
 
sub_¬¿y
)) => {

51 
Ët
 
mut
 
¬¿y
 = 
Vec
::
w™h_ÿ·c™y
(
sub_¬¿y
.
Ën
() + 1);

52 
	g¬¿y
.
push
(
obj
);

53 
	g¬¿y
.
­³nd
(&
mut
 
sub_¬¿y
);

54 
	gJsÚ
::
A¼ay
(
¬¿y
)

57 (
obj
, 
	gsuffix
è=> 
JsÚ
::
A¼ay
(
vec
![obj, 
suffix
]),

62 #[
cfg
(
‹¡
)]

63 
mod
 
	g‹¡
 {

64 
u£
 
	gsu³r
::*;

66 #[
‹¡
]

67 
â
 
‹¡_m”ge
() {

68 
Ët
 
	g‹¡_ÿ£s
 = 
vec
![

69 
vec
![
r
#"{"a": 1}"#,„#"{"b": 2}"#,„#"{"a": 1, "b": 2}"#],

70 
vec
![
r
#"{"a": 1}"#,„#"{"a": 2}"#,„#"{"a": [1, 2]}"#],

71 
vec
![
r
#"{"a": 1}"#,„#"{"a": [2, 3]}"#,„#"{"a": [1, 2, 3]}"#],

72 
vec
![

73 
r
#"{"a": 1}"#,

74 
r
#"{"a": {"b": [2, 3]}}"#,

75 
r
#"{"a": [1, {"b": [2, 3]}]}"#,

77 
	gvec
![

78 
r
#"{"a": {"b": [2, 3]}}"#,

79 
	gr
#"{"a": 1}"#,

80 
r
#"{"a": [{"b": [2, 3]}, 1]}"#,

82 
	gvec
![

83 
r
#"{"a": [1, 2]}"#,

84 
	gr
#"{"a": {"b": [3, 4]}}"#,

85 
	gr
#"{"a": [1, 2, {"b": [3, 4]}]}"#,

87 
	gvec
![

88 
r
#"{"b": {"c": 2}}"#,

89 
r
#"{"a": 1, "b": {"d": 1}}"#,

90 
r
#"{"a": 1, "b": {"c": 2, "d": 1}}"#,

92 
	gvec
![
r
#"[1]"#,„#"[2]"#,„#"[1, 2]"#],

93 
	gvec
![
r
#"{"a": 1}"#,„#"[1]"#,„#"[{"a": 1}, 1]"#],

94 
	gvec
![
r
#"[1]"#,„#"{"a": 1}"#,„#"[1, {"a": 1}]"#],

95 
vec
![
r
#"{"a": 1}"#,„#"4"#,„#"[{"a": 1}, 4]"#],

96 
	gvec
![
r
#"[1]"#,„#"4"#,„#"[1, 4]"#],

97 
	gvec
![
r
#"4"#,„#"{"a": 1}"#,„#"[4, {"a": 1}]"#],

98 
vec
![
r
#"1"#,„#"[4]"#,„#"[1, 4]"#],

99 
	gvec
![
r
#"4"#,„#"1"#,„#"[4, 1]"#],

100 
	gvec
!["1", "2", "3", "[1, 2, 3]"],

101 
	gvec
!["[1, 2]", "3", "[4, 5, 6]", "[1, 2, 3, 4, 5, 6]"],

102 
	gvec
![

103 
r
#"{"a": 1, "b": {"c": 3, "d": 4}, "e": [5, 6]}"#,

104 
	gr
#"{"c": 7, "b": {"a": 8, "c": 9}, "f": [1, 2]}"#,

105 
	gr
#"{"d": 9, "b": {"b": 10, "c": 11}, "e": 8}"#,

106 
r
#"{

116 
š
 
	g‹¡_ÿ£s
 {

117 
Ët
 
	gba£
: 
JsÚ
 = [0].
·r£
().
unw¿p
();

118 
Ët
 
	g»s
 = [1..ÿ
£
.
Ën
() - 1]

119 .
™”
()

120 .
m­
(|
s
| s.
·r£
().
unw¿p
())

121 .
fŞd
(
ba£
, 
JsÚ
::
m”ge
);

122 
Ët
 
	gex³ù
: 
JsÚ
 = [.
Ën
(è- 1].
·r£
().
unw¿p
();

123 
	gas£¹_eq
!(
	g»s
, 
	gex³ù
);

	@src/coprocessor/codec/mysql/json/json_modify.rs

14 
u£
 
	g¡d
::
mem
;

16 
u£
 
	gsu³r
::
JsÚ
;

17 
u£
 
	gsu³r
::
·th_ex´
::{
P©hEx´essiÚ
, 
	gP©hLeg
};

18 
u£
 
	gsu³r
::
su³r
::
ResuÉ
;

21 #[
d”ive
(
ClÚe
, 
Cİy
, 
Debug
, 
P¬tŸlEq
)]

22 
pub
 
	eModifyTy³
 {

24 
	mIn£¹
,

26 
	mR•Ïû
,

28 
	mS‘
,

31 
im¶
 
	gJsÚ
 {

35 
pub
 
â
 
modify
(

36 &
mut
 
£lf
,

37 
·th_ex´_li¡
: &[
P©hEx´essiÚ
],

38 
mut
 
v®ues
: 
Vec
<
JsÚ
>,

39 
mt
: 
ModifyTy³
,

40 è-> 
	gResuÉ
<()> {

41 
	g·th_ex´_li¡
.
Ën
(è!ğ
v®ues
.len() {

42  
E¼
(
box_”r
!("Incorrect…arameter count"));

44 
ex´
 
š
 
	g·th_ex´_li¡
 {

45 
	gex´
.
cÚšs_ªy_a¡”isk
() {

46  
E¼
(
box_”r
!("Invalid…athƒxpression"));

49 
	gex´
, 
	gv®ue
è
š
 
	g·th_ex´_li¡
.
™”
().
z
(
v®ues
.
d¿š
(..)) {

50 
	g£lf
.
£t_jsÚ
(&
ex´
.
Ëgs
, 
v®ue
, 
mt
);

52 
Ok
(())

56 
â
 
£t_jsÚ
(&
mut
 
£lf
, 
·th_Ëgs
: &[
P©hLeg
], 
v®ue
: 
JsÚ
, 
mt
: 
ModifyTy³
) {

57 
·th_Ëgs
.
is_em±y
() {

58 
m©ch
 
mt
 {

59 
ModifyTy³
::
R•Ïû
 | ModifyTy³::
S‘
 => {

60 *
£lf
 = 
v®ue
;

62 
	g_
 => {}

67 
Ët
 (
cu¼’t_Ëg
, 
sub_·th_Ëgs
èğ(&
·th_Ëgs
[0], &
	g·th_Ëgs
[1..]);

69 
Ët
 
	gP©hLeg
::
Index
(
i
èğ*
cu¼’t_Ëg
 {

70 
Ët
 
ba£_d©a
 = 
mem
::
»¶aû
(
£lf
, 
JsÚ
::
NÚe
);

71 
Ët
 
	gšdex
 = 
i
 
as
 
usize
;

74 
Ët
 (
mut
 
¬¿y
, 
w¿µed
èğ
m©ch
 
ba£_d©a
 {

75 
JsÚ
::
A¼ay
(
¬¿y
è=> (¬¿y, 
	gçl£
),

76 
	g_
 => (
vec
![
ba£_d©a
], 
	gŒue
),

78 
	g¬¿y
.
Ën
(è> 
	gšdex
 {

79 
	g¬¿y
[
šdex
].
£t_jsÚ
(
sub_·th_Ëgs
, 
v®ue
, 
mt
);

80 } 
	gsub_·th_Ëgs
.
is_em±y
(è&& 
	gmt
 !ğ
ModifyTy³
::
R•Ïû
 {

82 
¬¿y
.
push
(
v®ue
);

84 ià(
	g¬¿y
.
Ën
(è=ğ1è&& 
w¿µed
 {

85 *
£lf
 = 
¬¿y
.
pİ
().
unw¿p
();

87 *
	g£lf
 = 
JsÚ
::
A¼ay
(
¬¿y
);

92 
Ët
 
	gP©hLeg
::
Key
(
»f
 
key
èğ*
cu¼’t_Ëg
 {

93 
Ët
 
JsÚ
::
Objeù
(
»f
 
mut
 
m­
èğ*
£lf
 {

94 
m­
.
cÚšs_key
(
key
) {

96 
Ët
 
v
 = 
m­
.
g‘_mut
(
key
).
unw¿p
();

97 
	gv
.
£t_jsÚ
(
sub_·th_Ëgs
, 
v®ue
, 
mt
);

98 } 
	gsub_·th_Ëgs
.
is_em±y
(è&& 
	gmt
 !ğ
ModifyTy³
::
R•Ïû
 {

100 
m­
.
š£¹
(
key
.
şÚe
(), 
v®ue
);

107 #[
cfg
(
‹¡
)]

108 
mod
 
	g‹¡
 {

109 
u£
 
	gsu³r
::*;

110 
u£
 
	gsu³r
::
su³r
::
·th_ex´
::
·r£_jsÚ_·th_ex´
;

112 #[
‹¡
]

113 
â
 
‹¡_jsÚ_modify
() {

114 
Ët
 
mut
 
	g‹¡_ÿ£s
 = 
vec
![

115 (
r
#"
nuÎ
"#, "
$
",„#"{}"#, ModifyType::Set,„#"{}"#,rue),

116 (
r
#"{}"#, "
$
.
a
",„#"3"#, ModifyType::Set,„#"{"a": 3}"#,rue),

118 
r
#"{"a": 3}"#,

120 
r
#"[]"#,

121 
	gModifyTy³
::
R•Ïû
,

122 
	gr
#"{"a": []}"#,

123 
Œue
,

126 
	gr
#"{"a": []}"#,

128 
	gr
#"3"#,

129 
	gModifyTy³
::
S‘
,

130 
	gr
#"{"a": [3]}"#,

131 
Œue
,

134 
	gr
#"{"a": [3]}"#,

136 
	gr
#"4"#,

137 
	gModifyTy³
::
In£¹
,

138 
	gr
#"{"a": [3, 4]}"#,

139 
	gŒue
,

143 
	gr
#"{"a": [3]}"#,

145 
	gr
#"4"#,

146 
	gModifyTy³
::
S‘
,

147 
	gr
#"4"#,

148 
	gŒue
,

152 
	gr
#"{"a": [3]}"#,

154 
	gr
#"4"#,

155 
	gModifyTy³
::
S‘
,

156 
	gr
#"[{"a": [3]}, 4]"#,

157 
	gŒue
,

161 (
	gr
#"{}"#, "
	g$
",„#"1"#, ModifyType::Insert,„#"{}"#,rue),

164 
	gr
#"{"a": [3, 4]}"#,

166 
	gr
#"3"#,

167 
	gModifyTy³
::
S‘
,

168 
	gr
#"{"a": [3, 4]}"#,

169 
	gŒue
,

173 
	gr
#"{"a": [3, 4]}"#,

175 
	gr
#"3"#,

176 
	gModifyTy³
::
S‘
,

177 
	gr
#"{"a": [3, 4]}"#,

178 
	gŒue
,

182 
	gr
#"{"a": [3, 4]}"#,

184 
	gr
#"30"#,

185 
	gModifyTy³
::
In£¹
,

186 
	gr
#"{"a": [3, 4]}"#,

187 
	gŒue
,

191 
	gr
#"{"a": [3, 4]}"#,

193 
	gr
#"30"#,

194 
	gModifyTy³
::
R•Ïû
,

195 
	gr
#"{"a": [3, 4]}"#,

196 
	gŒue
,

200 (
	gr
#"
	gnuÎ
"#, "
	g$
.*",„#"{}"#, ModifyType::Set,„#"null"#, false),

202 
	gr
#"
	gnuÎ
"#,

204 
	gr
#"{}"#,

205 
	gModifyTy³
::
S‘
,

206 
	gr
#"
	gnuÎ
"#,

207 
	gçl£
,

210 
	gr
#"
	gnuÎ
"#,

212 
	gr
#"{}"#,

213 
	gModifyTy³
::
S‘
,

214 
	gr
#"
	gnuÎ
"#,

215 
	gçl£
,

218 
	gr
#"
	gnuÎ
"#,

220 
	gr
#"{}"#,

221 
	gModifyTy³
::
S‘
,

222 
	gr
#"
	gnuÎ
"#,

223 
	gçl£
,

226 
	gi
, (
	gjsÚ
, 
	g·th
, 
	gv®ue
, 
	gmt
, 
	gex³ùed
, 
	gsucûss
)è
š
 
	g‹¡_ÿ£s
.
d¿š
(..).
’um”©e
() {

227 
Ët
 
	gj
: 
ResuÉ
<
JsÚ
> = 
jsÚ
.
·r£
();

228 
	gas£¹
!(
	gj
.
is_ok
(), "#{}ƒx³ù jsÚ…¬£ ok buˆgÙ {:?}", 
	gi
, j);

229 
Ët
 
	gp
 = 
·r£_jsÚ_·th_ex´
(
·th
);

230 
	gas£¹
!(
	gp
.
is_ok
(), "#{}ƒx³ù…©h…¬£ ok buˆgÙ {:?}", 
	gi
,…);

231 
Ët
 
	gv
 = 
v®ue
.
·r£
();

232 
	gas£¹
!(
	gv
.
is_ok
(), "#{}ƒx³ù v®u·r£ ok buˆgÙ {:?}", 
	gi
, v);

233 
Ët
 
	ge
: 
ResuÉ
<
JsÚ
> = 
ex³ùed
.
·r£
();

234 
	gas£¹
!(

235 
	ge
.
is_ok
(),

237 
	gi
,

238 
	ge


240 
Ët
 (
mut
 
j
, 
p
, 
v
, 
e
èğ(j.
unw¿p
(), 
	gp
.unw¿p(), 
	gv
.unw¿p(), 
	ge
.unwrap());

241 
Ët
 
	gr
 = 
j
.
modify
(
vec
![
p
].
as_¦iû
(), vec![
v
], 
mt
);

242 
	gsucûss
 {

243 
	gas£¹
!(
	gr
.
is_ok
(), "#{}ƒx³ù modify ok buˆgÙ {:?}", 
	gi
,„);

245 
	gas£¹
!(
	gr
.
is_”r
(), "#{}ƒx³ù modifyƒ¼Ü buˆgÙ {:?}", 
	gi
,„);

247 
	gas£¹_eq
!(
	ge
, 
	gj
, "#{}ƒx³ù modif›d jsÚ {:?} =ğ{:?}", 
	gi
, j,ƒ);

	@src/coprocessor/codec/mysql/json/json_remove.rs

14 
u£
 
	gsu³r
::
JsÚ
;

15 
u£
 
	gsu³r
::
·th_ex´
::{
P©hEx´essiÚ
, 
	gP©hLeg
};

16 
u£
 
	gsu³r
::
su³r
::
ResuÉ
;

18 
im¶
 
	gJsÚ
 {

22 
pub
 
â
 
»move
(&
mut
 
£lf
, 
·th_ex´_li¡
: &[
P©hEx´essiÚ
]è-> 
ResuÉ
<()> {

23 
·th_ex´_li¡


24 .
™”
()

25 .
ªy
(|
ex´
|ƒx´.
Ëgs
.
is_em±y
(è||ƒx´.
cÚšs_ªy_a¡”isk
())

27  
E¼
(
box_”r
!("Invalid…athƒxpression"));

30 
ex´
 
š
 
	g·th_ex´_li¡
 {

31 
	g£lf
.
»move_·th
(&
ex´
.
Ëgs
);

33 
Ok
(())

36 
â
 
»move_·th
(&
mut
 
£lf
, 
·th_Ëgs
: &[
P©hLeg
]) {

37 
Ët
 (
cu¼’t_Ëg
, 
sub_·th_Ëgs
èğ
·th_Ëgs
.
¥l™_fœ¡
().
unw¿p
();

39 
Ët
 
	gP©hLeg
::
Index
(
šdex
èğ*
cu¼’t_Ëg
 {

40 
Ët
 
JsÚ
::
A¼ay
(
»f
 
mut
 
¬¿y
èğ*
£lf
 {

41 
Ët
 
šdex
 = index 
as
 
usize
;

42 
	g¬¿y
.
Ën
(è<ğ
šdex
 {

45 
	gsub_·th_Ëgs
.
is_em±y
() {

46 
	g¬¿y
.
»move
(
šdex
);

49 
	g¬¿y
[
šdex
].
»move_·th
(
sub_·th_Ëgs
);

54 
Ët
 
	gP©hLeg
::
Key
(
»f
 
key
èğ*
cu¼’t_Ëg
 {

55 
Ët
 
JsÚ
::
Objeù
(
»f
 
mut
 
obj
èğ*
£lf
 {

56 
sub_·th_Ëgs
.
is_em±y
() {

57 
obj
.
»move
(
key
);

60 
Ët
 
Some
(
sub_obj
èğ
obj
.
g‘_mut
(
key
) {

61 
sub_obj
.
»move_·th
(
sub_·th_Ëgs
);

68 #[
cfg
(
‹¡
)]

69 
mod
 
	g‹¡
 {

70 
u£
 
	gsu³r
::*;

71 
u£
 
	gsu³r
::
su³r
::
·th_ex´
::
·r£_jsÚ_·th_ex´
;

73 #[
‹¡
]

74 
â
 
‹¡_jsÚ_»move
() {

75 
Ët
 
	g‹¡_ÿ£s
 = 
vec
![

76 (
r
#"{"a": [3, 4]}"#, "
$
.
a
[0]",„#"{"a": [4]}"#,rue),

77 (
r
#"{"a": [3, 4]}"#, "
$
.
a
",„#"{}"#,rue),

79 
r
#"{"a": [3, 4], "b":1, "c":{"a":1}}"#,

81 
	gr
#"{"a": [3, 4],"b":1, "c":{}}"#,

82 
Œue
,

85 (
	gr
#"{"a": [3, 4]}"#, "
	g$
.
	gb
[1]",„#"{"a": [3, 4]}"#,rue),

87 (
	gr
#"{"a": [3, 4]}"#, "
	g$
.
	ga
[0].
	gb
",„#"{"a": [3, 4]}"#,rue),

90 (
	gr
#"
	gnuÎ
"#, "
	g$
.*",„#"null"#, false),

91 (
	gr
#"
	gnuÎ
"#, "
	g$
[*]",„#"null"#, false),

92 (
	gr
#"
	gnuÎ
"#, "
	g$
**.
	ga
",„#"null"#, false),

93 (
	gr
#"
	gnuÎ
"#, "
	g$
**[3]",„#"null"#, false),

96 
	gi
, (
	gjsÚ
, 
	g·th
, 
	gex³ùed
, 
	gsucûss
)è
š
 
	g‹¡_ÿ£s
.
što_™”
().
’um”©e
() {

97 
Ët
 
	gj
: 
ResuÉ
<
JsÚ
> = 
jsÚ
.
·r£
();

98 
	gas£¹
!(
	gj
.
is_ok
(), "#{}ƒx³ù jsÚ…¬£ ok buˆgÙ {:?}", 
	gi
, j);

99 
Ët
 
	gp
 = 
·r£_jsÚ_·th_ex´
(
·th
);

100 
	gas£¹
!(
	gp
.
is_ok
(), "#{}ƒx³ù…©h…¬£ ok buˆgÙ {:?}", 
	gi
,…);

101 
Ët
 
	ge
: 
ResuÉ
<
JsÚ
> = 
ex³ùed
.
·r£
();

102 
	gas£¹
!(

103 
	ge
.
is_ok
(),

105 
	gi
,

106 
	ge


108 
Ët
 (
mut
 
j
, 
p
, 
e
èğ(j.
unw¿p
(), 
	gp
.unw¿p(), 
	ge
.unwrap());

109 
Ët
 
	gr
 = 
j
.
»move
(
vec
![
p
].
as_¦iû
());

110 
	gsucûss
 {

111 
	gas£¹
!(
	gr
.
is_ok
(), "#{}ƒx³ù„emovok buˆgÙ {:?}", 
	gi
,„);

113 
	gas£¹
!(
	gr
.
is_”r
(), "#{}ƒx³ù„emov”rÜ buˆgÙ {:?}", 
	gi
,„);

115 
	gas£¹_eq
!(
	ge
, 
	gj
, "#{}ƒx³ù„emovjsÚ {:?} =ğ{:?}", 
	gi
, j,ƒ);

	@src/coprocessor/codec/mysql/json/json_type.rs

14 
u£
 
	gsu³r
::
JsÚ
;

16 cÚ¡ 
	gJSON_TYPE_BOOLEAN
: &'static [u8] = b"BOOLEAN";

17 cÚ¡ 
JSON_TYPE_NONE
: &'static [u8] = b"NULL";

18 cÚ¡ 
JSON_TYPE_INTEGER
: &'static [u8] = b"INTEGER";

19 cÚ¡ 
JSON_TYPE_UNSIGNED_INTEGER
: &'static [u8] = b"UNSIGNED INTEGER";

20 cÚ¡ 
JSON_TYPE_DOUBLE
: &'static [u8] = b"DOUBLE";

21 cÚ¡ 
JSON_TYPE_STRING
: &'static [u8] = b"STRING";

22 cÚ¡ 
JSON_TYPE_OBJECT
: &'static [u8] = b"OBJECT";

23 cÚ¡ 
JSON_TYPE_ARRAY
: &'static [u8] = b"ARRAY";

25 
im¶
 
JsÚ
 {

28 
pub
 
â
 
jsÚ_ty³
(&
£lf
) -> &'static [u8] {

29 
m©ch
 *
£lf
 {

30 
JsÚ
::
Objeù
(
_
è=> 
JSON_TYPE_OBJECT
,

31 
	gJsÚ
::
A¼ay
(
_
è=> 
JSON_TYPE_ARRAY
,

32 
	gJsÚ
::
I64
(
_
è=> 
JSON_TYPE_INTEGER
,

33 
	gJsÚ
::
U64
(
_
è=> 
JSON_TYPE_UNSIGNED_INTEGER
,

34 
	gJsÚ
::
DoubË
(
_
è=> 
JSON_TYPE_DOUBLE
,

35 
	gJsÚ
::
SŒšg
(
_
è=> 
JSON_TYPE_STRING
,

36 
	gJsÚ
::
BoŞ—n
(
_
è=> 
JSON_TYPE_BOOLEAN
,

37 
	gJsÚ
::
NÚe
 => 
JSON_TYPE_NONE
,

42 #[
cfg
(
‹¡
)]

43 
mod
 
	g‹¡
 {

44 
u£
 
	gsu³r
::*;

46 #[
‹¡
]

47 
â
 
‹¡_ty³
() {

48 
Ët
 
	g‹¡_ÿ£s
 = 
vec
![

49 (
r
#"{"a": "b"}"#, JSON_TYPE_OBJECT),

50 (
r
#"["a", "b"]"#, JSON_TYPE_ARRAY),

51 ("-5", 
	gJSON_TYPE_INTEGER
),

52 ("5", 
	gJSON_TYPE_UNSIGNED_INTEGER
),

53 ("18446744073709551615", 
	gJSON_TYPE_UNSIGNED_INTEGER
),

54 ("5.6", 
	gJSON_TYPE_DOUBLE
),

55 (
	gr
#""hello, world""#, JSON_TYPE_STRING),

56 ("Œue", 
	gJSON_TYPE_BOOLEAN
),

57 ("nuÎ", 
	gJSON_TYPE_NONE
),

60 
	gj¡r
, 
	gty³_Çme
è
š
 
	g‹¡_ÿ£s
 {

61 
Ët
 
	gjsÚ
: 
JsÚ
 = 
j¡r
.
·r£
().
unw¿p
();

62 
	gas£¹_eq
!(
	gjsÚ
.
jsÚ_ty³
(), 
	gty³_Çme
);

	@src/coprocessor/codec/mysql/json/json_unquote.rs

15 #![
®low
(
d—d_code
)]

17 
u£
 
	g¡d
::{, 
	g¡r
, 
	gu32
};

19 
u£
 
	gsu³r
::
su³r
::
ResuÉ
;

20 
u£
 
	gsu³r
::
JsÚ
;

22 cÚ¡ 
	gESCAPED_UNICODE_BYTES_SIZE
: 
usize
 = 4;

24 cÚ¡ 
	gCHAR_BACKSPACE
: = '\x08';

25 cÚ¡ 
	gCHAR_HORIZONTAL_TAB
: = '\x09';

26 cÚ¡ 
	gCHAR_LINEFEED
: = '\x0A';

27 cÚ¡ 
	gCHAR_FORMFEED
: = '\x0C';

28 cÚ¡ 
	gCHAR_CARRIAGE_RETURN
: = '\x0D';

30 
im¶
 
	gJsÚ
 {

31 
pub
 
â
 
unquÙe
(&
£lf
è-> 
	gResuÉ
<
	gSŒšg
> {

32 
m©ch
 *
	g£lf
 {

33 
	gJsÚ
::
SŒšg
(
»f
 
s
è=> 
unquÙe_¡ršg
(s),

34 
	g_
 => 
Ok
(
£lf
.
to_¡ršg
()),

42 
pub
 
â
 
unquÙe_¡ršg
(
s
: &
¡r
è-> 
ResuÉ
<
SŒšg
> {

43 
Ët
 
mut
 
»t
 = 
SŒšg
::
w™h_ÿ·c™y
(
s
.
Ën
());

44 
Ët
 
mut
 
	gch¬s
 = 
s
.
ch¬s
();

45 
Ët
 
Some
(
ch
èğ
ch¬s
.
Ãxt
() {

46 
ch
 == '\\' {

47 
Ët
 
c
 = 
m©ch
 
ch¬s
.
Ãxt
() {

48 
Some
(
c
) => c,

49 
	gNÚe
 =>  
E¼
(
box_”r
!("Incompleteƒscaped sequence")),

51 
m©ch
 
	gc
 {

52 '"' => 
»t
.
push
('"'),

53 'b' => 
»t
.
push
(
CHAR_BACKSPACE
),

54 'f' => 
»t
.
push
(
CHAR_FORMFEED
),

55 'n' => 
»t
.
push
(
CHAR_LINEFEED
),

56 'r' => 
»t
.
push
(
CHAR_CARRIAGE_RETURN
),

57 't' => 
»t
.
push
(
CHAR_HORIZONTAL_TAB
),

58 '\\' => 
»t
.
push
('\\'),

60 
Ët
 
b
 = 
ch¬s
.
as_¡r
().
as_by‹s
();

61 
	gb
.
Ën
(è< 
	gESCAPED_UNICODE_BYTES_SIZE
 {

62  
E¼
(
box_”r
!("Inv®id unicode, by‹†’oØshÜt: {:?}", 
b
));

64 
Ët
 
	gunicode
 = 
¡r
::
äom_utf8
(&
b
[0..E
SCAPED_UNICODE_BYTES_SIZE
])?;

65 
	gunicode
.
Ën
(è!ğ
ESCAPED_UNICODE_BYTES_SIZE
 {

66  
E¼
(
box_”r
!("Inv®id unicode, ch¬†’oØshÜt: {}", 
unicode
));

68 
Ët
 
	gutf8
 = 
decode_esÿ³d_unicode
(
unicode
)?;

69 
	g»t
.
push
(
utf8
);

70 
_
 
	gš
 0..E
	gSCAPED_UNICODE_BYTES_SIZE
 {

71 
	gch¬s
.
Ãxt
();

74 
	g_
 => {

76 
»t
.
push
(
c
);

80 
	g»t
.
push
(
ch
);

83 
Ok
(
»t
)

86 
â
 
decode_esÿ³d_unicode
(
s
: &
¡r
è-> 
ResuÉ
<> {

87 
Ët
 
u
 = 
box_Œy
!(
u32
::
äom_¡r_¿dix
(
s
, 16));

88 ::
äom_u32
(
u
).
ok_Ü
(
box_”r
!("šv®id ch¬ from: {}", 
s
))

91 #[
cfg
(
‹¡
)]

92 
mod
 
	g‹¡
 {

93 
u£
 
	g¡d
::
cŞËùiÚs
::
BT»eM­
;

94 
u£
 
	gsu³r
::*;

96 #[
‹¡
]

97 
â
 
‹¡_decode_esÿ³d_unicode
() {

98 
Ët
 
mut
 
	g‹¡_ÿ£s
 = 
vec
![

105 
	gi
, (
	gesÿ³d
, 
	gex³ùed
)è
š
 
	g‹¡_ÿ£s
.
d¿š
(..).
’um”©e
() {

106 
Ët
 
	gd
 = 
decode_esÿ³d_unicode
(
esÿ³d
);

107 
	gas£¹
!(
	gd
.
is_ok
(), "#{}ƒx³ù ok buˆgÙƒ¼ {:?}", 
	gi
, d);

108 
Ët
 
	ggÙ
 = 
d
.
unw¿p
();

109 
	gas£¹_eq
!(

110 
	ggÙ
,

111 
	gex³ùed
,

113 
	gi
,

114 
	gex³ùed
,

115 
	ggÙ


120 #[
‹¡
]

121 
â
 
‹¡_jsÚ_unquÙe
() {

123 
Ët
 
mut
 
	g‹¡_ÿ£s
 = 
vec
![

124 ("\\b", 
Œue
, 
Some
("\x08")),

125 ("\\f", 
Œue
, 
Some
("\x0C")),

126 ("\\n", 
Œue
, 
Some
("\x0A")),

127 ("\\r", 
Œue
, 
Some
("\x0D")),

128 ("\\t", 
Œue
, 
Some
("\x09")),

129 ("\\\\", 
Œue
, 
Some
("\x5c")),

130 ("\\u597d", 
Œue
, 
Some
("å¥½")),

131 ("0\\u597d0", 
Œue
, 
Some
("0å¥½0")),

132 ("\\a", 
Œue
, 
Some
("a")),

133 ("[", 
Œue
, 
Some
("[")),

135 ("\\", 
çl£
, 
NÚe
),

136 ("\\u59", 
çl£
, 
NÚe
),

138 
	gi
, (
	gšput
, 
	gno_”rÜ
, 
	gex³ùed
)è
š
 
	g‹¡_ÿ£s
.
d¿š
(..).
’um”©e
() {

139 
Ët
 
	gj
 = 
JsÚ
::
SŒšg
(SŒšg::
äom
(
šput
));

140 
Ët
 
	gr
 = 
j
.
unquÙe
();

141 
	gno_”rÜ
 {

142 
	gas£¹
!(
	gr
.
is_ok
(), "#{}ƒx³ù unquÙok buˆgÙƒ¼ {:?}", 
	gi
,„);

143 
Ët
 
	ggÙ
 = 
r
.
unw¿p
();

144 
Ët
 
	gex³ùed
 = 
SŒšg
::
äom
(
ex³ùed
.
unw¿p
());

145 
	gas£¹_eq
!(

146 
	ggÙ
,

147 
	gex³ùed
,

149 
	gi
,

150 
	gex³ùed
,

151 
	ggÙ


154 
	gas£¹
!(
	gr
.
is_”r
(), "#{}ƒx³ùedƒ¼Ü buˆgÙ {:?}", 
	gi
,„);

159 
Ët
 
mut
 
	g‹¡_ÿ£s
 = 
vec
![

160 
JsÚ
::
Objeù
(
BT»eM­
::
Ãw
()),

161 
JsÚ
::
A¼ay
(
vec
![]),

162 
	gJsÚ
::
I64
(2017),

163 
	gJsÚ
::
DoubË
(19.28),

164 
	gJsÚ
::
BoŞ—n
(
Œue
),

165 
	gJsÚ
::
NÚe
,

167 
	gi
, 
	gj
è
š
 
	g‹¡_ÿ£s
.
d¿š
(..).
’um”©e
() {

168 
Ët
 
	gex³ùed
 = 
j
.
to_¡ršg
();

169 
Ët
 
	gr
 = 
j
.
unquÙe
();

170 
	gas£¹
!(
	gr
.
is_ok
(), "#{}ƒx³ù unquÙok buˆgÙƒ¼ {:?}", 
	gi
,„);

171 
Ët
 
	ggÙ
 = 
r
.
unw¿p
();

172 
	gas£¹_eq
!(

173 
	ggÙ
,

174 
	gex³ùed
,

176 
	gi
,

177 
	gex³ùed
,

178 
	ggÙ


	@src/coprocessor/codec/mysql/json/mod.rs

15 #![
®low
(
d—d_code
)]

17 
mod
 
	gbš¬y
;

18 
mod
 
	gcom·risÚ
;

19 
mod
 
	g£rde
;

20 
mod
 
	g·th_ex´
;

22 
mod
 
	gjsÚ_ÿ¡
;

23 
mod
 
	gjsÚ_exŒaù
;

24 
mod
 
	gjsÚ_m”ge
;

25 
mod
 
	gjsÚ_modify
;

26 
mod
 
	gjsÚ_ty³
;

27 
mod
 
	gjsÚ_unquÙe
;

28 
mod
 
	gjsÚ_»move
;

30 
u£
 
	g¡d
::
cŞËùiÚs
::
BT»eM­
;

31 
pub
 
u£
 
	g£lf
::
bš¬y
::{
JsÚDecod”
, 
	gJsÚEncod”
};

32 
pub
 
u£
 
	g£lf
::
·th_ex´
::{
·r£_jsÚ_·th_ex´
, 
	gP©hEx´essiÚ
};

33 
pub
 
u£
 
	g£lf
::
jsÚ_modify
::
ModifyTy³
;

35 
u£
 
	gut
::
is_ev’
;

36 
u£
 
	gsu³r
::
su³r
::
d©um
::
D©um
;

37 
u£
 
	gsu³r
::
su³r
::{
E¼Ü
, 
	gResuÉ
};

39 cÚ¡ 
	gERR_CONVERT_FAILED
: &
¡r
 = "Can‚ot covert from ";

48 #[
d”ive
(
ClÚe
, 
Debug
)]

49 
pub
 
	eJsÚ
 {

50 
Objeù
(
BT»eM­
<
SŒšg
, 
JsÚ
>),

51 
A¼ay
(
Vec
<
JsÚ
>),

52 
I64
(
i64
),

53 
U64
(
u64
),

54 
DoubË
(
f64
),

55 
SŒšg
(String),

56 
BoŞ—n
(
boŞ
),

57 
	mNÚe
,

61 
pub
 
â
 
jsÚ_¬¿y
(
–ems
: 
Vec
<
D©um
>è-> 
ResuÉ
<
JsÚ
> {

62 
Ët
 
mut
 
a
 = 
Vec
::
w™h_ÿ·c™y
(
–ems
.
Ën
());

63 
–em
 
š
 
	g–ems
 {

64 
	ga
.
push
(
–em
.
što_jsÚ
()?);

66 
Ok
(
JsÚ
::
A¼ay
(
a
))

70 
pub
 
â
 
jsÚ_objeù
(
kvs
: 
Vec
<
D©um
>è-> 
ResuÉ
<
JsÚ
> {

71 
Ët
 
Ën
 = 
kvs
.len();

72 !
is_ev’
(
Ën
) {

73  
E¼
(
E¼Ü
::
Oth”
(
box_”r
!(

78 
Ët
 
mut
 
	gm­
 = 
BT»eM­
::
Ãw
();

79 
Ët
 
mut
 
	gkey
 = 
NÚe
;

80 
–em
 
š
 
	gkvs
 {

81 
	gkey
.
is_nÚe
() {

83 
	g–em
 =ğ
D©um
::
NuÎ
 {

84  
E¼
(
šv®id_ty³
!(

88 
	gkey
 = 
Some
(
–em
.
što_¡ršg
()?);

91 
Ët
 
	gv®
 = 
–em
.
što_jsÚ
()?;

92 
	gm­
.
š£¹
(
key
.
ke
().
unw¿p
(), 
v®
);

95 
Ok
(
JsÚ
::
Objeù
(
m­
))

98 #[
cfg
(
‹¡
)]

99 
mod
 
‹¡
 {

100 
u£
 
su³r
::*;

102 #[
‹¡
]

103 
â
 
‹¡_jsÚ_¬¿y
() {

104 
Ët
 
	gÿ£s
 = 
vec
![

106 
vec
![

107 
D©um
::
I64
(1),

108 
D©um
::
By‹s
(
b
"sdf".
to_vec
()),

109 
D©um
::
U64
(2),

110 
D©um
::
JsÚ
(
r
#"[3,4]"#.parse().unwrap()),

112 
r
#"[1,"sdf",2,[3,4]]"#.parse().unwrap(),

114 (
	gvec
![], "[]".
·r£
().
unw¿p
()),

116 
	gd
, 
	g•_jsÚ
è
š
 
	gÿ£s
 {

117 
	gas£¹_eq
!(
jsÚ_¬¿y
(
d
).
unw¿p
(), 
	g•_jsÚ
);

121 #[
‹¡
]

122 
â
 
‹¡_jsÚ_objeù
() {

123 
Ët
 
	gÿ£s
 = 
vec
![

124 
vec
![
D©um
::
I64
(1)],

125 
	gvec
![

126 
D©um
::
I64
(1),

127 
D©um
::
By‹s
(
b
"sdf".
to_vec
()),

128 
D©um
::
NuÎ
,

129 
D©um
::
U64
(2),

132 
d
 
š
 
	gÿ£s
 {

133 
	gas£¹
!(
jsÚ_objeù
(
d
).
is_”r
());

136 
Ët
 
	gÿ£s
 = 
vec
![

138 
vec
![

139 
D©um
::
I64
(1),

140 
D©um
::
By‹s
(
b
"sdf".
to_vec
()),

141 
D©um
::
By‹s
(
b
"asd".
to_vec
()),

142 
D©um
::
By‹s
(
b
"qwe".
to_vec
()),

143 
D©um
::
I64
(2),

144 
D©um
::
JsÚ
(
r
#"{"3":4}"#.parse().unwrap()),

146 
r
#"{"1":"sdf","2":{"3":4},"asd":"qwe"}"#.parse().unwrap(),

148 (
	gvec
![], "{}".
·r£
().
unw¿p
()),

150 
	gd
, 
	g•_jsÚ
è
š
 
	gÿ£s
 {

151 
	gas£¹_eq
!(
jsÚ_objeù
(
d
).
unw¿p
(), 
	g•_jsÚ
);

	@src/coprocessor/codec/mysql/json/path_expr.rs

38 #![
®low
(
d—d_code
)]

40 
u£
 
	g¡d
::
İs
::
Index
;

41 
u£
 
	g¡d
::
ascii
::
AsciiExt
;

42 
u£
 
	g»gex
::
Regex
;

43 
u£
 
	gcİroûssÜ
::
codec
::
ResuÉ
;

44 
u£
 
	gsu³r
::
jsÚ_unquÙe
::
unquÙe_¡ršg
;

46 
pub
 cÚ¡ 
	gPATH_EXPR_ASTERISK
: &'static str = "*";

50 cÚ¡ 
PATH_EXPR_LEG_RE_STR
: &'static str =

51 
r
#"(\.\
s
*([
a
-
zA
-
Z_
][a-zA-
Z0
-9
_
]*|\*|"[^"\\]*(\\.[^"\\]*)*")|(\[\s*([0-9]+|\*)\s*\])|\*\*)"#;

53 #[
d”ive
(
ClÚe
, 
Debug
, 
P¬tŸlEq
)]

54 
pub
 
	eP©hLeg
 {

56 
Key
(
SŒšg
),

58 
Index
(
i32
),

60 
	mDoubËA¡”isk
,

65 
pub
 cÚ¡ 
	gPATH_EXPR_ARRAY_INDEX_ASTERISK
: 
i32
 = -1;

67 
pub
 
ty³
 
	gP©hEx´essiÚFÏg
 = 
u8
;

69 
pub
 cÚ¡ 
	gPATH_EXPRESSION_CONTAINS_ASTERISK
: 
P©hEx´essiÚFÏg
 = 0x01;

70 
pub
 cÚ¡ 
	gPATH_EXPRESSION_CONTAINS_DOUBLE_ASTERISK
: 
P©hEx´essiÚFÏg
 = 0x02;

73 #[
d”ive
(
ClÚe
, 
DeçuÉ
, 
Debug
, 
P¬tŸlEq
)]

74 
pub
 
	sP©hEx´essiÚ
 {

75 
pub
 
	mËgs
: 
Vec
<
P©hLeg
>,

76 
pub
 
	mæags
: 
P©hEx´essiÚFÏg
,

79 
im¶
 
	gP©hEx´essiÚ
 {

80 
pub
 
â
 
cÚšs_ªy_a¡”isk
(&
£lf
è-> 
	gboŞ
 {

81 (
	g£lf
.
	gæags
 &

82 (
	gPATH_EXPRESSION_CONTAINS_ASTERISK
 | 
	gPATH_EXPRESSION_CONTAINS_DOUBLE_ASTERISK
)) !=

89 
pub
 
â
 
·r£_jsÚ_·th_ex´
(
·th_ex´
: &
¡r
è-> 
ResuÉ
<
P©hEx´essiÚ
> {

92 
Ët
 
dŞÏr_šdex
 = 
m©ch
 
·th_ex´
.
fšd
('$') {

93 
Some
(
i
) => i,

94 
	gNÚe
 =>  
E¼
(
box_”r
!("Inv®id JSON…©h: {}", 
·th_ex´
)),

96 
	g·th_ex´


97 .
šdex
(0..d
ŞÏr_šdex
)

98 .
ch¬_šdiûs
()

99 .
ªy
(|(
_
, 
c
)| !c.
is_ascii_wh™e¥aû
())

101  
E¼
(
box_”r
!("Inv®id JSON…©h: {}", 
·th_ex´
));

104 
Ët
 
	gex´
 = 
·th_ex´
.
šdex
(
dŞÏr_šdex
 + 1..).
Œim_Ëá
();

106 
	gÏzy_¡©ic
! {

107 
»f
 
	gRE
: 
Regex
 = Regex::
Ãw
(
PATH_EXPR_LEG_RE_STR
).
unw¿p
();

109 
Ët
 
mut
 
	gËgs
 = 
vec
![];

110 
Ët
 
mut
 
	gæags
 = 
P©hEx´essiÚFÏg
::();

111 
Ët
 
mut
 
	gÏ¡_’d
 = 0;

112 
	g¡¬t
, 
	g’d
è
š
 
	gRE
.
fšd_™”
(
ex´
) {

114 
	gex´
.
šdex
(
Ï¡_’d
..
¡¬t
)

115 .
ch¬_šdiûs
()

116 .
ªy
(|(
_
, 
c
)| !c.
is_ascii_wh™e¥aû
())

118  
E¼
(
box_”r
!("Inv®id JSON…©h: {}", 
·th_ex´
));

120 
	gÏ¡_’d
 = 
’d
;

122 
Ët
 
	gÃxt_ch¬
 = 
ex´
.
šdex
(
¡¬t
..).
ch¬s
().
Ãxt
().
unw¿p
();

123 
	gÃxt_ch¬
 == '[' {

125 
Ët
 
Ëg
 = 
ex´
[
¡¬t
 + 1..e
nd
].
Œim
();

126 
Ët
 
	gšdex_¡r
 = 
Ëg
[0..Ë
g
.
Ën
(è- 1].
Œim
();

127 
Ët
 
	gšdex
 = 
šdex_¡r
 =ğ
PATH_EXPR_ASTERISK
 {

128 
æags
 |ğ
PATH_EXPRESSION_CONTAINS_ASTERISK
;

129 
	gPATH_EXPR_ARRAY_INDEX_ASTERISK


131 
	gbox_Œy
!(
	gšdex_¡r
.
	g·r£
::<
i32
>())

133 
	gËgs
.
push
(
P©hLeg
::
Index
(
šdex
))

134 } 
Ãxt_ch¬
 == '.' {

136 
Ët
 
mut
 
key
 = 
ex´
[
¡¬t
 + 1..e
nd
].
Œim
().
to_owÃd
();

137 
	gkey
 =ğ
PATH_EXPR_ASTERISK
 {

138 
æags
 |ğ
PATH_EXPRESSION_CONTAINS_ASTERISK
;

139 } 
	gkey
.
ch¬s
().
Ãxt
().
unw¿p
() == '"' {

141 
key
 = 
unquÙe_¡ršg
(&key[1..key.
Ën
() - 1])?;

143 
	gËgs
.
push
(
P©hLeg
::
Key
(
key
))

146 
æags
 |ğ
PATH_EXPRESSION_CONTAINS_DOUBLE_ASTERISK
;

147 
	gËgs
.
push
(
P©hLeg
::
DoubËA¡”isk
);

151 ià(
	gÏ¡_’d
 =ğ0è&& (!
ex´
.
is_em±y
()) {

152  
E¼
(
box_”r
!("Inv®id JSON…©h: {}", 
·th_ex´
));

154 !
	gËgs
.
is_em±y
() {

155 
Ët
 
	gP©hLeg
::
DoubËA¡”isk
 = *
Ëgs
.
Ï¡
().
unw¿p
() {

157  
E¼
(
box_”r
!("Inv®id JSON…©h: {}", 
·th_ex´
));

160 
Ok
(
P©hEx´essiÚ
 {

161 
Ëgs
:†egs,

162 
æags
: flags,

166 #[
cfg
(
‹¡
)]

167 
mod
 
	g‹¡
 {

168 
u£
 
	gsu³r
::*;

170 #[
‹¡
]

171 
â
 
‹¡_·th_ex´essiÚ_æag
() {

172 
Ët
 
mut
 
	ge
 = 
P©hEx´essiÚ
 {

173 
Ëgs
: 
vec
![],

174 
æags
: 
P©hEx´essiÚFÏg
::(),

176 
	gas£¹
!(!
	ge
.
cÚšs_ªy_a¡”isk
());

177 
	ge
.
	gæags
 |ğ
PATH_EXPRESSION_CONTAINS_ASTERISK
;

178 
	gas£¹
!(
	ge
.
cÚšs_ªy_a¡”isk
());

179 
	ge
.
	gæags
 = 
P©hEx´essiÚFÏg
::();

180 
	ge
.
	gæags
 |ğ
PATH_EXPRESSION_CONTAINS_DOUBLE_ASTERISK
;

181 
	gas£¹
!(
	ge
.
cÚšs_ªy_a¡”isk
());

184 #[
‹¡
]

185 
â
 
‹¡_·r£_jsÚ_·th_ex´
() {

186 
Ët
 
mut
 
	g‹¡_ÿ£s
 = 
vec
![

189 
Œue
,

190 
Some
(
P©hEx´essiÚ
 {

191 
Ëgs
: 
vec
![],

192 
æags
: 
P©hEx´essiÚFÏg
::(),

197 
	gŒue
,

198 
Some
(
P©hEx´essiÚ
 {

199 
Ëgs
: 
vec
![
P©hLeg
::
Key
(
SŒšg
::
äom
("a"))],

200 
æags
: 
P©hEx´essiÚFÏg
::(),

205 
	gŒue
,

206 
Some
(
P©hEx´essiÚ
 {

207 
Ëgs
: 
vec
![
P©hLeg
::
Key
(
SŒšg
::
äom
("hello world"))],

208 
æags
: 
P©hEx´essiÚFÏg
::(),

213 
	gŒue
,

214 
Some
(
P©hEx´essiÚ
 {

215 
Ëgs
: 
vec
![
P©hLeg
::
Index
(0)],

216 
æags
: 
P©hEx´essiÚFÏg
::(),

221 
	gŒue
,

222 
Some
(
P©hEx´essiÚ
 {

223 
Ëgs
: 
vec
![
P©hLeg
::
DoubËA¡”isk
, P©hLeg::
Key
(
SŒšg
::
äom
("a"))],

224 
æags
: 
PATH_EXPRESSION_CONTAINS_DOUBLE_ASTERISK
,

228 (".a", 
	gçl£
, 
	gNÚe
),

229 ("xx$[1]", 
	gçl£
, 
	gNÚe
),

230 ("$.¨xx .b", 
	gçl£
, 
	gNÚe
),

231 ("$[a]", 
	gçl£
, 
	gNÚe
),

232 ("$.\"\\u33\"", 
	gçl£
, 
	gNÚe
),

233 ("$**", 
	gçl£
, 
	gNÚe
),

235 
	gi
, (
	g·th_ex´
, 
	gno_”rÜ
, 
	gex³ùed
)è
š
 
	g‹¡_ÿ£s
.
d¿š
(..).
’um”©e
() {

236 
Ët
 
	gr
 = 
·r£_jsÚ_·th_ex´
(
·th_ex´
);

237 
	gno_”rÜ
 {

238 
	gas£¹
!(
	gr
.
is_ok
(), "#{}ƒx³ù…¬£ ok buˆgÙƒ¼ {:?}", 
	gi
,„);

239 
Ët
 
	ggÙ
 = 
r
.
unw¿p
();

240 
Ët
 
	gex³ùed
 = 
ex³ùed
.
unw¿p
();

241 
	gas£¹_eq
!(

242 
	ggÙ
,

243 
	gex³ùed
,

245 
	gi
,

246 
	gex³ùed
,

247 
	ggÙ


250 
	gas£¹
!(
	gr
.
is_”r
(), "#{}ƒx³ùƒ¼Ü buˆgÙ {:?}", 
	gi
,„);

255 #[
‹¡
]

256 
â
 
‹¡_·r£_jsÚ_·th_ex´_cÚšs_ªy_a¡”isk
() {

257 
Ët
 
mut
 
	g‹¡_ÿ£s
 = 
vec
![

258 ("$.a[b]", 
çl£
),

259 ("$.a[*]", 
Œue
),

260 ("$.*[b]", 
Œue
),

261 ("$**.a[b]", 
Œue
),

263 
	gi
, (
	g·th_ex´
, 
	gex³ùed
)è
š
 
	g‹¡_ÿ£s
.
d¿š
(..).
’um”©e
() {

264 
Ët
 
	gr
 = 
·r£_jsÚ_·th_ex´
(
·th_ex´
);

265 
	gas£¹
!(
	gr
.
is_ok
(), "#{}ƒx³ù…¬£ ok buˆgÙƒ¼ {:?}", 
	gi
,„);

266 
Ët
 
	ge
 = 
r
.
unw¿p
();

267 
Ët
 
	gb
 = 
e
.
cÚšs_ªy_a¡”isk
();

268 
	gas£¹_eq
!(
	gb
, 
	gex³ùed
, "#{}ƒx³ù {:?} buˆgÙ {:?}", 
	gi
,ƒxpected, b);

	@src/coprocessor/codec/mysql/json/serde.rs

14 
u£
 
	g£rde
::
£r
::{
S”Ÿlize
, 
	gS”ŸlizeM­
, 
	gS”ŸlizeTu¶e
, 
	gS”Ÿliz”
};

15 
u£
 
	g£rde
::
de
::{
£lf
, 
	gDe£rŸlize
, 
	gDe£rŸliz”
, 
	gM­Acûss
, 
	gSeqAcûss
, 
	gVis™Ü
};

16 
u£
 
	g£rde_jsÚ
;

17 
u£
 
	g¡d
::
cŞËùiÚs
::
BT»eM­
;

18 
u£
 
	g¡d
::
fmt
;

19 
u£
 
	g¡d
::{
¡r
, 
	gf64
};

20 
u£
 
	g¡d
::
¡r
::
FromSŒ
;

22 
u£
 
	gcİroûssÜ
::
codec
::
E¼Ü
;

23 
u£
 
	gsu³r
::
JsÚ
;

25 
im¶
 
	gJsÚ
 {

26 
pub
 
â
 
to_¡ršg
(&
£lf
è-> 
	gSŒšg
 {

27 
	g£rde_jsÚ
::
to_¡ršg
(
£lf
).
unw¿p
()

31 
im¶
 
FromSŒ
 
JsÚ
 {

32 
ty³
 
E¼
 = 
E¼Ü
;

33 
â
 
äom_¡r
(
s
: &
¡r
è-> 
ResuÉ
<
S–f
, 
	gS–f
::
E¼
> {

34 
m©ch
 
£rde_jsÚ
::
äom_¡r
(
s
) {

35 
Ok
(
v®ue
) => Ok(value),

36 
E¼
(
e
è=> E¼(
šv®id_ty³
!("Illegal Jsonext: {:?}",ƒ)),

41 
im¶
 
S”Ÿlize
 
	gJsÚ
 {

42 
â
 
	g£rŸlize
<
	gS
>(&
	g£lf
, 
	g£rŸliz”
: 
S
è-> 
ResuÉ
<S::
Ok
, S::
E¼Ü
>

43 
wh”e


44 
S
: 
S”Ÿliz”
,

46 
m©ch
 *
	g£lf
 {

47 
	gJsÚ
::
NÚe
 => 
£rŸliz”
.
£rŸlize_nÚe
(),

48 
	gJsÚ
::
BoŞ—n
(
d
è=> 
£rŸliz”
.
£rŸlize_boŞ
(d),

49 
	gJsÚ
::
SŒšg
(
»f
 
s
è=> 
£rŸliz”
.
£rŸlize_¡r
(s),

50 
	gJsÚ
::
Objeù
(
»f
 
obj
) => {

51 
Ët
 
mut
 
m­
 = 
£rŸliz”
.
£rŸlize_m­
(
Some
(
obj
.
Ën
()))?;

52 
	gk
, 
	gv
è
š
 
	gobj
 {

53 
	gm­
.
£rŸlize_’Œy
(
k
, 
v
)?;

55 
	gm­
.
’d
()

57 
	gJsÚ
::
A¼ay
(
»f
 
¬¿y
) => {

58 
Ët
 
mut
 
tup
 = 
£rŸliz”
.
£rŸlize_tu¶e
(
¬¿y
.
Ën
())?;

59 
™em
 
š
 
	g¬¿y
 {

60 
	gtup
.
£rŸlize_–em’t
(
™em
)?;

62 
	gtup
.
’d
()

64 
	gJsÚ
::
DoubË
(
d
è=> 
£rŸliz”
.
£rŸlize_f64
(d),

65 
	gJsÚ
::
I64
(
d
è=> 
£rŸliz”
.
£rŸlize_i64
(d),

66 
	gJsÚ
::
U64
(
d
è=> 
£rŸliz”
.
£rŸlize_u64
(d),

71 
	gJsÚVis™Ü
;

72 
	gim¶
<'de> Vis™Ü<'
	gde
> 
	gJsÚVis™Ü
 {

73 
ty³
 
	gV®ue
 = 
JsÚ
;

74 
â
 
ex³ùšg
(&
£lf
, 
fÜm©‹r
: &
mut
 
fmt
::
FÜm©‹r
è-> fmt::
ResuÉ
 {

75 
wr™e
!(
fÜm©‹r
, "a json value")

78 
â
 
	gvis™_un™
<
	gE
>(
	g£lf
è-> 
	gResuÉ
<
	gS–f
::
V®ue
, E>

79 
wh”e


80 
	gE
: 
de
::
E¼Ü
,

82 
Ok
(
JsÚ
::
NÚe
)

85 
â
 
vis™_boŞ
<
E
>(
£lf
, 
	gv
: 
boŞ
è-> 
ResuÉ
<
S–f
::
V®ue
, 
	gE
>

86 
wh”e


87 
	gE
: 
de
::
E¼Ü
,

89 
Ok
(
JsÚ
::
BoŞ—n
(
v
))

92 
â
 
vis™_i64
<
E
>(
£lf
, 
	gv
: 
i64
è-> 
ResuÉ
<
S–f
::
V®ue
, 
	gE
>

93 
wh”e


94 
	gE
: 
de
::
E¼Ü
,

96 
Ok
(
JsÚ
::
I64
(
v
))

99 
â
 
vis™_u64
<
E
>(
£lf
, 
	gv
: 
u64
è-> 
ResuÉ
<
S–f
::
V®ue
, 
	gE
>

100 
wh”e


101 
	gE
: 
de
::
E¼Ü
,

103 
Ok
(
JsÚ
::
U64
(
v
))

106 
â
 
vis™_f64
<
E
>(
£lf
, 
	gv
: 
f64
è-> 
ResuÉ
<
S–f
::
V®ue
, 
	gE
>

107 
wh”e


108 
	gE
: 
de
::
E¼Ü
,

110 
Ok
(
JsÚ
::
DoubË
(
v
))

113 
â
 
vis™_¡r
<
E
>(
£lf
, 
	gv
: &
¡r
è-> 
ResuÉ
<
S–f
::
V®ue
, 
	gE
>

114 
wh”e


115 
	gE
: 
de
::
E¼Ü
,

117 
Ok
(
JsÚ
::
SŒšg
(SŒšg::
äom
(
v
)))

120 
â
 
vis™_£q
<
M
>(
£lf
, 
mut
 
	g£q
: Mè-> 
ResuÉ
<
S–f
::
V®ue
, 
	gM
::
E¼Ü
>

121 
wh”e


122 
M
: 
SeqAcûss
<'de>,

124 
Ët
 
mut
 
£qs
 = 
Vec
::
w™h_ÿ·c™y
(
£q
.
size_hšt
().
unw¿p_Ü
(0));

125 
Ët
 
Some
(
v®ue
èğ
£q
.
Ãxt_–em’t
()? {

126 
£qs
.
push
(
v®ue
);

128 
Ok
(
JsÚ
::
A¼ay
(
£qs
))

131 
â
 
vis™_m­
<
M
>(
£lf
, 
mut
 
	gacûss
: Mè-> 
ResuÉ
<
S–f
::
V®ue
, 
	gM
::
E¼Ü
>

132 
wh”e


133 
M
: 
M­Acûss
<'de>,

135 
Ët
 
mut
 
m­
 = 
BT»eM­
::
Ãw
();

136 
Ët
 
Some
((
key
, 
v®ue
)èğ
acûss
.
Ãxt_’Œy
()? {

137 
m­
.
š£¹
(
key
, 
v®ue
);

139 
Ok
(
JsÚ
::
Objeù
(
m­
))

143 
im¶
<'de> De£rŸlize<'
de
> 
JsÚ
 {

144 
â
 
de£rŸlize
<
D
>(
de£rŸliz”
: Dè-> 
ResuÉ
<
S–f
, 
	gD
::
E¼Ü
>

145 
wh”e


146 
D
: 
De£rŸliz”
<'de>,

148 
de£rŸliz”
.
de£rŸlize_ªy
(
JsÚVis™Ü
)

152 #[
cfg
(
‹¡
)]

153 
mod
 
‹¡
 {

154 
u£
 
su³r
::*;

156 #[
‹¡
]

157 
â
 
‹¡_äom_¡r_fÜ_objeù
() {

158 
Ët
 
	gj¡r1
 = 
r
#"{"a": [1, "2", {"¯": "bb"}, 4.0, 
nuÎ
], "c":‚uÎ,"b": 
Œue
}"#;

159 
Ët
 
j1
: 
JsÚ
 = 
j¡r1
.
·r£
().
unw¿p
();

160 
Ët
 
	gj¡r2
 = 
j1
.
to_¡ršg
();

161 
Ët
 
	gex³ù_¡r
 = 
r
#"{"a":[1,"2",{"¯":"bb"},4.0,
nuÎ
],"b":
Œue
,"c":null}"#;

162 
as£¹_eq
!(
j¡r2
, 
	gex³ù_¡r
);

165 #[
‹¡
]

166 
â
 
‹¡_äom_¡r
() {

167 
Ët
 
	gËg®_ÿ£s
 = 
vec
![

168 (
r
#"{"key":"value"}"#),

169 (
r
#"["d1","d2"]"#),

170 (
	gr
#"-3"#),

171 (
	gr
#"3"#),

172 (
	gr
#"3.0"#),

173 (
	gr
#"
	gnuÎ
"#),

174 (
	gr
#"
	gŒue
"#),

175 (
	gr
#"
	gçl£
"#),

178 
jsÚ_¡r
 
š
 
	gËg®_ÿ£s
 {

179 
Ët
 
	g»¥
 = 
JsÚ
::
äom_¡r
(
jsÚ_¡r
);

180 
	gas£¹
!(
	g»¥
.
is_ok
());

183 
Ët
 
	gËg®_ÿ£s
 = 
vec
!["[pxx,apaa]", "hpeheh", ""];

184 
jsÚ_¡r
 
š
 
	gËg®_ÿ£s
 {

185 
Ët
 
	g»¥
 = 
JsÚ
::
äom_¡r
(
jsÚ_¡r
);

186 
	gas£¹
!(
	g»¥
.
is_”r
());

	@src/coprocessor/codec/mysql/mod.rs

14 
u£
 
	gsu³r
::
ResuÉ
;

15 
u£
 
	gut
::
esÿ³
;

18 
pub
 cÚ¡ 
	gUN_SPECIFIED_FSP
: 
i8
 = -1;

20 
pub
 cÚ¡ 
	gMAX_FSP
: 
i8
 = 6;

22 
pub
 cÚ¡ 
	gMIN_FSP
: 
i8
 = 0;

25 
pub
 cÚ¡ 
	gDEFAULT_FSP
: 
i8
 = 0;

27 
â
 
check_f¥
(
f¥
: 
i8
è-> 
ResuÉ
<
u8
> {

28 
f¥
 =ğ
UN_SPECIFIED_FSP
 {

29  
Ok
(
DEFAULT_FSP
 
as
 
u8
);

31 
	gf¥
 > 
	gMAX_FSP
 || f¥ < 
	gMIN_FSP
 {

32  
E¼
(
šv®id_ty³
!("Inv®id f¥ {}", 
f¥
));

34 
Ok
(
f¥
 
as
 
u8
)

39 
â
 
·r£_äac
(
s
: &[
u8
], 
f¥
: u8è-> 
ResuÉ
<
u32
> {

40 
s
.
is_em±y
() {

41  
Ok
(0);

44 
	gs
.
™”
().
ªy
(|&
c
| c < 
b
'0' || c > b'9') {

45  
E¼
(
šv®id_ty³
!("{} cÚš šv®id ch¬", 
esÿ³
(
s
)));

47 
Ët
 
	g»s
 = 
s
.
™”
()

48 .
ke
(
f¥
 
as
 
usize
 + 1)

49 .
fŞd
(0, |
l
, 
r
|† * 10 + (¸- 
b
'0'è
as
 
u32
);

50 
	gs
.
Ën
(è> 
f¥
 
as
 
	gusize
 {

51 
	g»s
 % 10 >= 5 {

52 
Ok
(
»s
 / 10 + 1)

54 
Ok
(
»s
 / 10)

57 
Ok
(
»s
 * 10u32.
pow
((
f¥
 
as
 
usize
 - 
s
.
Ën
()èa 
u32
))

61 
mod
 
	gdu¿tiÚ
;

62 
pub
 
mod
 
	gdecim®
;

63 
pub
 
mod
 
	gch¬£t
;

64 
pub
 
mod
 
	gty³s
;

65 
mod
 
	gtime
;

66 
pub
 
mod
 
	gjsÚ
;

68 
pub
 
u£
 
	g£lf
::
du¿tiÚ
::
Du¿tiÚ
;

69 
pub
 
u£
 
	g£lf
::
decim®
::{
dec_’coded_Ën
, 
	gDecim®
, 
	gDecim®Decod”
, 
	gDecim®Encod”
, 
	gRes
};

70 
pub
 
u£
 
	g£lf
::
ty³s
::{
has_is_boŞ—n_æag
, 
	ghas_nÙ_nuÎ_æag
, 
	ghas_·r£_to_jsÚ_æag
,

71 
	ghas_unsigÃd_æag
};

72 
pub
 
u£
 
	g£lf
::
time
::
Time
;

73 
pub
 
u£
 
	g£lf
::
jsÚ
::{
·r£_jsÚ_·th_ex´
, 
	gJsÚ
, 
	gJsÚDecod”
, 
	gJsÚEncod”
, 
	gModifyTy³
,

74 
	gP©hEx´essiÚ
};

76 #[
cfg
(
‹¡
)]

77 
mod
 
	g‹¡
 {

78 #[
‹¡
]

79 
â
 
‹¡_·r£_äaû
() {

80 
Ët
 
	gÿ£s
 = 
vec
![

89 
	gs
, 
	gf¥
, 
	gexp
è
š
 
	gÿ£s
 {

90 
Ët
 
	g»s
 = 
su³r
::
·r£_äac
(
s
.
as_by‹s
(), 
f¥
).
unw¿p
();

91 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

	@src/coprocessor/codec/mysql/time.rs

15 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

16 
u£
 
	g¡d
::
¡r
;

17 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

19 
u£
 
	gchrÚo
::{
D©eTime
, 
	gD©–ike
, 
	gDu¿tiÚ
, 
	gFixedOff£t
, 
	gTimeZÚe
, 
	gTim–ike
, 
	gUtc
};

21 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
£lf
, 
	gcheck_f¥
, 
	g·r£_äac
, 
	gty³s
};

22 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
Decim®
;

23 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
du¿tiÚ
::{
Du¿tiÚ
 
as
 
MyDu¿tiÚ
, 
	gNANOS_PER_SEC
, 
	gNANO_WIDTH
};

24 
u£
 
	gsu³r
::
su³r
::{
ResuÉ
, 
	gTEN_POW
};

27 cÚ¡ 
	gZERO_DATETIME_STR
: &'static str = "0000-00-00 00:00:00";

28 cÚ¡ 
ZERO_DATE_STR
: &'static str = "0000-00-00";

31 cÚ¡ 
ZERO_TIMESTAMP
: 
i64
 = -62169984000;

33 #[
šlše
]

34 
â
 
z”o_time
(
tz
: &
FixedOff£t
è-> 
D©eTime
<FixedOffset> {

35 
tz
.
time¡amp
(
ZERO_TIMESTAMP
, 0)

38 #[
šlše
]

39 
â
 
z”o_d©‘ime
(
tz
: &
FixedOff£t
è-> 
Time
 {

40 
Time
::
Ãw
(
z”o_time
(
tz
), 
ty³s
::
DATETIME
, 
mysql
::
DEFAULT_FSP
).
unw¿p
()

43 #[
®low
(
too_mªy_¬gum’ts
)]

44 #[
šlše
]

45 
â
 
ymd_hms_Çnos
<
T
: 
TimeZÚe
>(

46 
tz
: &
T
,

47 
	gy—r
: 
i32
,

48 
	gmÚth
: 
u32
,

49 
	gday
: 
u32
,

50 
	ghour
: 
u32
,

51 
	gmš
: 
u32
,

52 
	g£cs
: 
u32
,

53 
	gÇnos
: 
u32
,

54 è-> 
	gResuÉ
<
	gD©eTime
<
	gT
>> {

55 
	gtz
.
ymd_İt
(
y—r
, 
mÚth
, 
day
)

56 .
ªd_hms_İt
(
hour
, 
mš
, 
£cs
)

57 .
sšgË
()

58 .
ªd_th’
(|
t
| {

59 
t
.
checked_add_sigÃd
(
Du¿tiÚ
::
Çno£cÚds
(
Çnos
 
as
 
i64
))

61 .
ok_Ü_–£
(|| {

62 
box_”r
!(

64 
y—r
,

65 
mÚth
,

66 
day
,

67 
hour
,

68 
mš
,

69 
£cs
,

70 
Çnos


75 #[
šlše
]

76 
â
 
äom_by‹s
(
bs
: &[
u8
]è-> &
¡r
 {

77 
un§ã
 { 
¡r
::
äom_utf8_unchecked
(
bs
) }

80 
â
 
¥l™_ymd_hms
(
mut
 
s
: &[
u8
]è-> 
ResuÉ
<(
i32
, 
	gu32
, u32, u32, u32, u32)> {

81 
Ët
 
	gy—r
: 
i32
;

82 
	gs
.
Ën
(è=ğ14 || 
s
.len() == 8 {

83 
y—r
 = 
box_Œy
!(
äom_by‹s
(&
s
[..4]).
·r£
());

84 
	gs
 = &
s
[4..];

86 
	gy—r
 = 
box_Œy
!(
äom_by‹s
(&
s
[..2]).
·r£
());

87 
	gs
 = &
s
[2..];

89 
Ët
 
	gmÚth
: 
u32
 = 
box_Œy
!(
äom_by‹s
(&
s
[..2]).
·r£
());

90 
Ët
 
	gday
: 
u32
 = 
box_Œy
!(
äom_by‹s
(&
s
[2..4]).
·r£
());

91 
Ët
 
	ghour
: 
u32
 = 
s
.
Ën
() > 4 {

92 
box_Œy
!(
äom_by‹s
(&
s
[4..6]).
·r£
())

96 
Ët
 
	gmšu‹
: 
u32
 = 
s
.
Ën
() > 6 {

97 
box_Œy
!(
äom_by‹s
(&
s
[6..8]).
·r£
())

101 
Ët
 
	g£cs
: 
u32
 = 
s
.
Ën
() > 8 {

102 
box_Œy
!(
äom_by‹s
(&
s
[8..10]).
·r£
())

106 
Ok
((
y—r
, 
mÚth
, 
day
, 
hour
, 
mšu‹
, 
£cs
))

110 #[
d”ive
(
ClÚe
, 
Debug
)]

111 
pub
 
	sTime
 {

113 
	mtime
: 
D©eTime
<
FixedOff£t
>,

114 
	m
: 
u8
,

115 
	mf¥
: 
u8
,

118 
im¶
 
	gTime
 {

119 
pub
 
â
 
Ãw
(
time
: 
D©eTime
<
FixedOff£t
>, 

: 
u8
, 
f¥
: 
i8
è-> 
ResuÉ
<
Time
> {

120 
Ok
(
Time
 {

121 
time
:ime,

122 

:p,

123 
f¥
: 
check_f¥
(fsp)?,

127 
pub
 
â
 
g‘_
(&
£lf
è-> 
	gu8
 {

128 
	g£lf
.
	g


131 
pub
 
â
 
£t_
(&
mut
 
£lf
, 

: 
u8
è-> 
ResuÉ
<()> {

132 
£lf
.

 !ğ &&°=ğ
ty³s
::
DATE
 {

134 
£lf
.
time
 = s–f.time.
d©e
().
ªd_hms
(0, 0, 0);

136 
	g£lf
.
	g
 !ğ

 &&°=ğ
ty³s
::
TIMESTAMP
 {

137  
E¼
(
box_”r
!("can‚ot convert datetime/dateoimestamp"));

139 
	g£lf
.
	g
 = 

;

140 
Ok
(())

143 
pub
 
â
 
is_z”o
(&
£lf
è-> 
	gboŞ
 {

144 
	g£lf
.
	gtime
.
time¡amp
(è=ğ
ZERO_TIMESTAMP


147 
pub
 
â
 
g‘_f¥
(&
£lf
è-> 
	gu8
 {

148 
	g£lf
.
	gf¥


151 
pub
 
â
 
£t_f¥
(&
mut
 
£lf
, 
f¥
: 
u8
) {

152 
£lf
.
f¥
 = fsp;

155 
â
 
to_num”ic_¡r
(&
£lf
è-> 
	gSŒšg
 {

156 
	g£lf
.
	g
 =ğ
ty³s
::
DATE
 {

158 
fÜm©
!("{}", 
£lf
.
time
.format("%Y%m%d"))

160 
Ët
 
s
 = 
£lf
.
time
.
fÜm©
("%Y%m%d%H%M%S");

161 
	g£lf
.
	gf¥
 > 0 {

163 
Ët
 
	gÇnos
 = 
£lf
.
time
.
Çno£cÚd
(è/ 
TEN_POW
[9 - s–f.
f¥
 
as
 
usize
];

164 
	gfÜm©
!("{}.{1:02$}", 
	gs
, 
	gÇnos
, 
	g£lf
.
f¥
 
as
 
	gusize
)

166 
	gfÜm©
!("{}", 
	gs
)

171 
pub
 
â
 
to_decim®
(&
£lf
è-> 
	gResuÉ
<
	gDecim®
> {

172 
	g£lf
.
is_z”o
() {

173  
Ok
(0.
što
());

175 
Ët
 
	gdec
: 
Decim®
 = 
box_Œy
!(
£lf
.
to_num”ic_¡r
().
·r£
());

176 
Ok
(
dec
)

179 
pub
 
â
 
to_f64
(&
£lf
è-> 
	gResuÉ
<
	gf64
> {

180 
	g£lf
.
is_z”o
() {

181  
Ok
(0f64);

183 
Ët
 
	gf
: 
f64
 = 
box_Œy
!(
£lf
.
to_num”ic_¡r
().
·r£
());

184 
Ok
(
f
)

187 
â
 
·r£_d©‘ime_fÜm©
(
s
: &
¡r
è-> 
Vec
<&str> {

188 
Ët
 
Œimmed
 = 
s
.
Œim
();

189 
	gŒimmed
.
is_em±y
() {

190  
	gvec
![];

192 
Ët
 
	g¥es
: 
Vec
<&
¡r
> = 
Œimmed
.
¥l™
(|
c
| c < '0' || c > '9').
cŞËù
();

193 
	g¥es
.
™”
().
ªy
(|
s
| s.
is_em±y
()) {

194 
	gvec
![]

196 
	g¥es


200 
pub
 
â
 
·r£_utc_d©‘ime
(
s
: &
¡r
, 
f¥
: 
i8
è-> 
ResuÉ
<
Time
> {

201 
Time
::
·r£_d©‘ime
(
s
, 
f¥
, &
FixedOff£t
::
—¡
(0))

204 
pub
 
â
 
·r£_d©‘ime
(
s
: &
¡r
, 
f¥
: 
i8
, 
tz
: &
FixedOff£t
è-> 
ResuÉ
<
Time
> {

205 
Ët
 
f¥
 = 
check_f¥
(fsp)?;

206 
Ët
 
mut
 
	gäac_¡r
 = "";

207 
Ët
 
mut
 
	gÃed_adju¡
 = 
çl£
;

208 
Ët
 
	g·¹s
 = 
Time
::
·r£_d©‘ime_fÜm©
(
s
);

209 
Ët
 (
mut
 
y
, 
m
, 
d
, 
h
, 
mšu‹
, 
£c
): (
i32
, 
	gu32
, u32, u32, u32, u32) =

210 
m©ch
 *
·¹s
.
as_¦iû
() {

211 [
s1
] => {

212 
Ãed_adju¡
 = 
s1
.
Ën
() == 12 || s1.len() == 6;

213 
m©ch
 
	gs1
.
Ën
() {

214 14 | 12 | 8 | 6 => 
¥l™_ymd_hms
(
s1
.
as_by‹s
())?,

215 
	g_
 =>  
E¼
(
box_”r
!("šv®id d©‘ime: {}", 
s
)),

218 [
s1
, 
äac
] => {

219 
äac_¡r
 = 
äac
;

220 
	gÃed_adju¡
 = 
s1
.
Ën
() == 12;

221 
m©ch
 
	gs1
.
Ën
() {

222 14 | 12 => 
¥l™_ymd_hms
(
s1
.
as_by‹s
())?,

223 
	g_
 =>  
E¼
(
box_”r
!("šv®id d©‘ime: {}", 
s
)),

226 [
y—r
, 
mÚth
, 
day
] => (

227 
box_Œy
!(
y—r
.
·r£
()),

228 
	gbox_Œy
!(
	gmÚth
.
·r£
()),

229 
	gbox_Œy
!(
	gday
.
·r£
()),

234 [
y—r
, 
mÚth
, 
day
, 
hour
, 
mš
, 
£c
] => (

235 
box_Œy
!(
y—r
.
·r£
()),

236 
	gbox_Œy
!(
	gmÚth
.
·r£
()),

237 
	gbox_Œy
!(
	gday
.
·r£
()),

238 
	gbox_Œy
!(
	ghour
.
·r£
()),

239 
	gbox_Œy
!(
	gmš
.
·r£
()),

240 
	gbox_Œy
!(
	g£c
.
·r£
()),

242 [
y—r
, 
mÚth
, 
day
, 
hour
, 
mš
, 
£c
, 
äac
] => {

243 
äac_¡r
 = 
äac
;

245 
	gbox_Œy
!(
	gy—r
.
·r£
()),

246 
	gbox_Œy
!(
	gmÚth
.
·r£
()),

247 
	gbox_Œy
!(
	gday
.
·r£
()),

248 
	gbox_Œy
!(
	ghour
.
·r£
()),

249 
	gbox_Œy
!(
	gmš
.
·r£
()),

250 
	gbox_Œy
!(
	g£c
.
·r£
()),

253 
	g_
 =>  
E¼
(
box_”r
!("šv®id d©‘ime: {}", 
s
)),

256 
	gÃed_adju¡
 || 
	g·¹s
[0].
Ën
() == 2 {

257 
y
 >= 0 && y <= 69 {

258 
y
 += 2000;

259 } 
	gy
 >ğ70 && 
y
 <= 99 {

260 
y
 += 1900;

264 
Ët
 
	gäac
 = 
·r£_äac
(
äac_¡r
.
as_by‹s
(), 
f¥
)?;

265 
	gy
 =ğ0 && 
m
 =ğ0 && 
d
 =ğ0 && 
h
 =ğ0 && 
mšu‹
 =ğ0 && 
£c
 == 0 {

266  
Ok
(
z”o_d©‘ime
(
tz
));

269 
	gy
 < 0 || y > 9999 {

270  
E¼
(
box_”r
!("unsuµÜˆy—r: {}", 
y
));

272 
Ët
 
	gt
 = 
ymd_hms_Çnos
(

273 
tz
,

274 
y
,

275 
m
,

276 
d
,

277 
h
,

278 
mšu‹
,

279 
£c
,

280 
äac
 * 
TEN_POW
[9 - 
f¥
 
as
 
usize
],

282 
	gTime
::
Ãw
(
t
, 
ty³s
::
DATETIME
 
as
 
u8
, 
f¥
‡ 
i8
)

288 
pub
 
â
 
äom_·cked_u64
(
u
: 
u64
, 

: 
u8
, 
f¥
: 
i8
, 
tz
: &
FixedOff£t
è-> 
ResuÉ
<
Time
> {

289 
u
 == 0 {

290  
Time
::
Ãw
(
z”o_time
(
tz
), 

, 
f¥
);

292 
Ët
 
	gf¥
 = 
mysql
::
check_f¥
(
f¥
)?;

293 
Ët
 
	gymdhms
 = 
u
 >> 24;

294 
Ët
 
	gymd
 = 
ymdhms
 >> 17;

295 
Ët
 
	gday
 = (
ymd
 & ((1 << 5è- 1)è
as
 
u32
;

296 
Ët
 
	gym
 = 
ymd
 >> 5;

297 
Ët
 
	gmÚth
 = (
ym
 % 13è
as
 
u32
;

298 
Ët
 
	gy—r
 = (
ym
 / 13è
as
 
i32
;

299 
Ët
 
	ghms
 = 
ymdhms
 & ((1 << 17) - 1);

300 
Ët
 
	g£cÚd
 = (
hms
 & ((1 << 6è- 1)è
as
 
u32
;

301 
Ët
 
	gmšu‹
 = ((
hms
 >> 6è& ((1 << 6è- 1)è
as
 
u32
;

302 
Ët
 
	ghour
 = (
hms
 >> 12è
as
 
u32
;

303 
Ët
 
	gÇno£c
 = ((
u
 & ((1 << 24è- 1)è* 1000è
as
 
u32
;

304 
Ët
 
	gt
 = 

 =ğ
ty³s
::
TIMESTAMP
 {

305 
Ët
 
t
 = 
ymd_hms_Çnos
(&
Utc
, 
y—r
, 
mÚth
, 
day
, 
hour
, 
mšu‹
, 
£cÚd
, 
Çno£c
)?;

306 
	gtz
.
äom_utc_d©‘ime
(&
t
.
Çive_utc
())

308 
ymd_hms_Çnos
(
tz
, 
y—r
, 
mÚth
, 
day
, 
hour
, 
mšu‹
, 
£cÚd
, 
Çno£c
)?

310 
	gTime
::
Ãw
(
t
, 

, 
f¥
 
as
 
i8
)

313 
pub
 
â
 
äom_du¿tiÚ
(
tz
: &
FixedOff£t
, 

: 
u8
, 
d
: &
MyDu¿tiÚ
è-> 
ResuÉ
<
Time
> {

314 
Ët
 
dur
 = 
Du¿tiÚ
::
Çno£cÚds
(
d
.
to_Çnos
());

315 
Ët
 
	gt
 = 
Utc
::
now
()

316 .
w™h_timezÚe
(
tz
)

317 .
d©e
()

318 .
ªd_hms
(0, 0, 0)

319 .
checked_add_sigÃd
(
dur
);

320 
	gt
.
is_nÚe
() {

321  
E¼
(
box_”r
!("·r£ from du¿tiÚ {} ov”æows", 
d
));

324 
Ët
 
	gt
 = 
t
.
unw¿p
();

325 
	gt
.
y—r
() < 1000 ||.year() > 9999 {

326  
E¼
(
box_”r
!(

328 
t


331 
	g
 =ğ
ty³s
::
DATE
 {

332 
Ët
 
t
 =.
d©e
().
ªd_hms
(0, 0, 0);

333 
	gTime
::
Ãw
(
t
, 

, 
d
.
f¥
 
as
 
i8
)

335 
	gTime
::
Ãw
(
t
, 

, 
d
.
f¥
 
as
 
i8
)

339 
pub
 
â
 
to_du¿tiÚ
(&
£lf
è-> 
	gResuÉ
<
	gMyDu¿tiÚ
> {

340 
	g£lf
.
is_z”o
() {

341  
Ok
(
MyDu¿tiÚ
::
z”o
());

343 
Ët
 
	gÇnos
 = 
£lf
.
time
.
num_£cÚds_äom_midnight
(è
as
 
i64
 * 
NANOS_PER_SEC
 +

344 
£lf
.
time
.
Çno£cÚd
(è
as
 
i64
;

345 
	gMyDu¿tiÚ
::
äom_Çnos
(
Çnos
, 
£lf
.
f¥
 
as
 
i8
)

351 
pub
 
â
 
to_·cked_u64
(&
£lf
è-> 
	gu64
 {

352 
	g£lf
.
is_z”o
() {

355 
Ët
 
	gt
 = 
£lf
.

 =ğ
ty³s
::
TIMESTAMP
 {

356 
£lf
.
time
.
Çive_utc
()

358 
£lf
.
time
.
Çive_loÿl
()

360 
Ët
 
	gymd
 = ((
t
.
y—r
(è
as
 
u64
 * 13 +.
mÚth
(èa u64è<< 5è|.
day
()‡s u64;

361 
Ët
 
	ghms
 = ((
t
.
hour
(è
as
 
u64
è<< 12è| (Ñ.
mšu‹
(èa u64è<< 6è|.
£cÚd
()‡s u64;

362 
Ët
 
	gmiüo
 = 
t
.
Çno£cÚd
(è
as
 
u64
 / 1000;

363 (((
	gymd
 << 17è| 
	ghms
è<< 24è| 
	gmiüo


366 
pub
 
â
 
round_äac
(&
mut
 
£lf
, 
f¥
: 
i8
è-> 
ResuÉ
<()> {

367 
£lf
.

 =ğ
ty³s
::
DATE
 || s–f.
is_z”o
() {

369  
Ok
(());

371 
Ët
 
	gf¥
 = 
check_f¥
(
f¥
)?;

372 
	gf¥
 =ğ
£lf
.
f¥
 {

373  
Ok
(());

376 
Ët
 
	gÇnos
 = 
£lf
.
time
.
Çno£cÚd
();

377 
Ët
 
	gba£
 = 10u32.
pow
(
NANO_WIDTH
 - 
f¥
 
as
 
u32
);

378 
Ët
 
	gex³ù_Çnos
 = ((
Çnos
 
as
 
f64
 / 
ba£
‡ f64).
round
(èa 
u32
) * base;

379 
Ët
 
	gdiff
 = 
Çnos
 
as
 
i64
 - 
ex³ù_Çnos
‡s i64;

380 
Ët
 
	gÃw_time
 = 
£lf
.
time
.
checked_add_sigÃd
(
Du¿tiÚ
::
Çno£cÚds
(
diff
));

382 
	gÃw_time
.
is_nÚe
() {

383 
E¼
(
box_”r
!("round_äaø{} ov”æows", 
£lf
.
time
))

385 
	g£lf
.
	gtime
 = 
Ãw_time
.
unw¿p
();

386 
	g£lf
.
	gf¥
 = 
f¥
;

387 
Ok
(())

392 
im¶
 
P¬tŸlOrd
 
	gTime
 {

393 
â
 
·¹Ÿl_cmp
(&
£lf
, 
right
: &
Time
è-> 
O±iÚ
<
Ord”šg
> {

394 
Some
(
£lf
.
cmp
(
right
))

398 
im¶
 
P¬tŸlEq
 
Time
 {

399 
â
 
eq
(&
£lf
, 
right
: &
Time
è-> 
boŞ
 {

400 
£lf
.
time
.
eq
(&
right
.time)

404 
im¶
 
Eq
 
Time
 {}

406 
im¶
 
Ord
 
Time
 {

407 
â
 
cmp
(&
£lf
, 
right
: &
Time
è-> 
Ord”šg
 {

408 
£lf
.
time
.
cmp
(&
right
.time)

412 
im¶
 
Di¥Ïy
 
Time
 {

413 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

414 
£lf
.
is_z”o
() {

415 
£lf
.

 =ğ
ty³s
::
DATE
 {

416  
f
.
wr™e_¡r
(
ZERO_DATE_STR
);

419  
	gf
.
wr™e_¡r
(
ZERO_DATETIME_STR
);

422 
	g£lf
.
	g
 =ğ
ty³s
::
DATE
 {

423 
£lf
.
is_z”o
() {

424  
f
.
wr™e_¡r
(
ZERO_DATE_STR
);

426  
	gwr™e
!(
	gf
, "{}", 
	g£lf
.
	gtime
.
fÜm©
("%Y-%m-%d"));

430 
	g£lf
.
is_z”o
() {

431 
	gf
.
wr™e_¡r
(
ZERO_DATETIME_STR
)?;

433 
	gwr™e
!(
	gf
, "{}", 
	g£lf
.
	gtime
.
fÜm©
("%Y-%m-%d %H:%M:%S"))?;

435 
	g£lf
.
	gf¥
 > 0 {

437 
Ët
 
	gÇnos
 = 
£lf
.
time
.
Çno£cÚd
(è/ 
TEN_POW
[9 - s–f.
f¥
 
as
 
usize
];

438 
	gwr™e
!(
	gf
, ".{0:01$}", 
	gÇnos
, 
	g£lf
.
f¥
 
as
 
	gusize
)?;

440 
Ok
(())

444 #[
cfg
(
‹¡
)]

445 
mod
 
	g‹¡
 {

446 
u£
 
	gsu³r
::*;

448 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

450 
u£
 
	gchrÚo
::{
Du¿tiÚ
, 
	gFixedOff£t
};

452 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
ty³s
, 
Du¿tiÚ
 
as
 
	gMyDu¿tiÚ
, 
	gMAX_FSP
, 
	gUN_SPECIFIED_FSP
};

454 cÚ¡ 
	gMIN_OFFSET
: 
i32
 = -60 * 24 + 1;

455 cÚ¡ 
	gMAX_OFFSET
: 
i32
 = 60 * 24;

457 #[
‹¡
]

458 
â
 
‹¡_·r£_d©‘ime
() {

459 
Ët
 
	gok_bËs
 = 
vec
![

462 
UN_SPECIFIED_FSP
,

467 
UN_SPECIFIED_FSP
,

472 
UN_SPECIFIED_FSP
,

475 ("00-12-31 11:30:45", 
UN_SPECIFIED_FSP
, "2000-12-31 11:30:45"),

476 ("12-12-31 11:30:45", 
UN_SPECIFIED_FSP
, "2012-12-31 11:30:45"),

477 ("2012-12-31", 
UN_SPECIFIED_FSP
, "2012-12-31 00:00:00"),

478 ("20121231", 
UN_SPECIFIED_FSP
, "2012-12-31 00:00:00"),

479 ("121231", 
UN_SPECIFIED_FSP
, "2012-12-31 00:00:00"),

482 
UN_SPECIFIED_FSP
,

487 
UN_SPECIFIED_FSP
,

490 ("2012-2-1 11:30:45", 
UN_SPECIFIED_FSP
, "2012-02-01 11:30:45"),

491 ("12-2-1 11:30:45", 
UN_SPECIFIED_FSP
, "2012-02-01 11:30:45"),

492 ("20121231113045", 
UN_SPECIFIED_FSP
, "2012-12-31 11:30:45"),

493 ("121231113045", 
UN_SPECIFIED_FSP
, "2012-12-31 11:30:45"),

494 ("2012-02-29", 
UN_SPECIFIED_FSP
, "2012-02-29 00:00:00"),

502 
	gšput
, 
	gf¥
, 
	gexp
è
š
 
	gok_bËs
 {

503 
Ët
 
	gutc_t
 = 
Time
::
·r£_utc_d©‘ime
(
šput
, 
f¥
).
unw¿p
();

504 
	gas£¹_eq
!(
	gfÜm©
!("{}", 
	gutc_t
), 
	gexp
);

506 
mut
 
off£t
 
š
 
	gMIN_OFFSET
..
	gMAX_OFFSET
 {

507 
	goff£t
 *= 60;

508 
Ët
 
	gtz
 = 
FixedOff£t
::
—¡
(
off£t
);

509 
Ët
 
	gt
 = 
Time
::
·r£_d©‘ime
(
šput
, 
f¥
, &
tz
).
unw¿p
();

510 
	gutc_t
.
is_z”o
() {

511 
	gas£¹_eq
!(
	gt
, 
	gutc_t
);

513 
Ët
 
	gexp_t
 = 
Time
::
Ãw
(

514 
utc_t
.
time
 - 
Du¿tiÚ
::
£cÚds
(
off£t
 
as
 
i64
),

515 
utc_t
.

,

516 
utc_t
.
f¥
 
as
 
i8
,

517 ).
unw¿p
();

518 
	gas£¹_eq
!(
	gexp_t
, 
	gt
);

523 
Ët
 
	gç_tbl
 = 
vec
![

532 
t
 
š
 
	gç_tbl
 {

533 
Ët
 
	gtz
 = 
FixedOff£t
::
—¡
(0);

534 
	gas£¹
!(
	gTime
::
·r£_d©‘ime
(
t
, 0, &
tz
).
is_”r
(), 
	gt
);

538 #[
‹¡
]

539 
â
 
‹¡_codec
() {

540 
Ët
 
	gÿ£s
 = 
vec
![

543 ("0001-01-01 00:00:00", 
UN_SPECIFIED_FSP
),

544 ("2000-01-01 00:00:00.000000", 
MAX_FSP
),

545 ("2000-01-01 00:00:00.123456", 
MAX_FSP
),

546 ("0001-01-01 00:00:00.123456", 
MAX_FSP
),

547 ("2000-06-01 00:00:00.999999", 
MAX_FSP
),

549 
	gs
, 
	gf¥
è
š
 
	gÿ£s
 {

550 
mut
 
off£t
 
š
 
	gMIN_OFFSET
..
	gMAX_OFFSET
 {

551 
	goff£t
 *= 60;

552 
Ët
 
	gtz
 = 
FixedOff£t
::
—¡
(
off£t
);

553 
Ët
 
	gt
 = 
Time
::
·r£_d©‘ime
(
s
, 
f¥
, &
tz
).
unw¿p
();

554 
Ët
 
	g·cked
 = 
t
.
to_·cked_u64
();

555 
Ët
 
	g»v”‹d_d©‘ime
 =

556 
Time
::
äom_·cked_u64
(
·cked
, 
ty³s
::
DATETIME
, 
f¥
, &
tz
).
unw¿p
();

557 
	gas£¹_eq
!(
	g»v”‹d_d©‘ime
, 
	gt
);

558 
	gas£¹_eq
!(
	g»v”‹d_d©‘ime
.
to_·cked_u64
(), 
	g·cked
);

560 
Ët
 
	g»v”‹d_time¡amp
 =

561 
Time
::
äom_·cked_u64
(
·cked
, 
ty³s
::
TIMESTAMP
, 
f¥
, &
tz
).
unw¿p
();

562 
	gas£¹_eq
!(

563 
	g»v”‹d_time¡amp
.
	gtime
,

564 
	g»v”‹d_d©‘ime
.
	gtime
 + 
	gDu¿tiÚ
::
£cÚds
(
off£t
 
as
 
i64
)

566 
	gas£¹_eq
!(
	g»v”‹d_time¡amp
.
to_·cked_u64
(), 
	g·cked
);

571 #[
‹¡
]

572 
â
 
‹¡_to_dec
() {

573 
Ët
 
	gÿ£s
 = 
vec
![

610 
	gt_¡r
, 
	gf¥
, 
	gd©‘ime_dec
, 
	gd©e_dec
è
š
 
	gÿ£s
 {

611 
mut
 
off£t
 
š
 
	gMIN_OFFSET
..
	gMAX_OFFSET
 {

612 
	goff£t
 *= 60;

613 
Ët
 
	gtz
 = 
FixedOff£t
::
—¡
(
off£t
);

614 
Ët
 
mut
 
	gt
 = 
Time
::
·r£_d©‘ime
(
t_¡r
, 
f¥
, &
tz
).
unw¿p
();

615 
Ët
 
mut
 
	g»s
 = 
fÜm©
!("{}", 
	gt
.
to_decim®
().
unw¿p
());

616 
	gas£¹_eq
!(
	g»s
, 
	gd©‘ime_dec
);

618 
	gt
 = 
Time
::
·r£_d©‘ime
(
t_¡r
, 0, &
tz
).
unw¿p
();

619 
	gt
.
	g
 = 
ty³s
::
DATE
;

620 
	g»s
 = 
fÜm©
!("{}", 
	gt
.
to_decim®
().
unw¿p
());

621 
	gas£¹_eq
!(
	g»s
, 
	gd©e_dec
);

626 #[
‹¡
]

627 
â
 
‹¡_com·»
() {

628 
Ët
 
	gÿ£s
 = 
vec
![

632 
Ord”šg
::
Equ®
,

637 
Ord”šg
::
G»©”
,

642 
Ord”šg
::
Less
,

644 ("0000-00-00 00:00:00", "2011-10-10 11:11:11", 
Ord”šg
::
Less
),

648 
Ord”šg
::
Equ®
,

652 
	gl
, 
	gr
, 
	gexp
è
š
 
	gÿ£s
 {

653 
mut
 
off£t
 
š
 
	gMIN_OFFSET
..
	gMAX_OFFSET
 {

654 
	goff£t
 *= 60;

655 
Ët
 
	gtz
 = 
FixedOff£t
::
—¡
(
off£t
);

656 
Ët
 
	gl_t
 = 
Time
::
·r£_d©‘ime
(
l
, 
MAX_FSP
, &
tz
).
unw¿p
();

657 
Ët
 
	gr_t
 = 
Time
::
·r£_d©‘ime
(
r
, 
MAX_FSP
, &
tz
).
unw¿p
();

658 
	gas£¹_eq
!(
	gexp
, 
	gl_t
.
cmp
(&
r_t
));

663 #[
‹¡
]

664 
â
 
‹¡_·r£_d©‘ime_fÜm©
() {

665 
Ët
 
	gÿ£s
 = 
vec
![

668 
vec
!["2011", "11", "11", "10", "10", "10", "123456"],

672 
	gvec
!["2011", "11", "11", "10", "10", "10", "123456"],

674 ("2011-11-11 10", 
	gvec
!["2011", "11", "11", "10"]),

677 
	gvec
!["2011", "11", "11", "10", "10", "10", "123456"],

681 
	gvec
!["2011", "11", "11", "10", "10", "10", "123456"],

683 ("xx2011-11-11 10:10:10", 
	gvec
![]),

684 ("T10:10:10", 
	gvec
![]),

685 ("2011-11-11x", 
	gvec
![]),

686 ("2011-11-11 10:10:10", 
	gvec
![]),

687 ("xxx 10:10:10", 
	gvec
![]),

690 
	gs
, 
	gexp
è
š
 
	gÿ£s
 {

691 
Ët
 
	g»s
 = 
Time
::
·r£_d©‘ime_fÜm©
(
s
);

692 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

696 #[
‹¡
]

697 
â
 
‹¡_round_äac
() {

698 
Ët
 
	gok_bËs
 = 
vec
![

701 
UN_SPECIFIED_FSP
,

706 
UN_SPECIFIED_FSP
,

711 
UN_SPECIFIED_FSP
,

714 ("00-12-31 11:30:45", 
UN_SPECIFIED_FSP
, "2000-12-31 11:30:45"),

715 ("12-12-31 11:30:45", 
UN_SPECIFIED_FSP
, "2012-12-31 11:30:45"),

716 ("2012-12-31", 
UN_SPECIFIED_FSP
, "2012-12-31 00:00:00"),

717 ("20121231", 
UN_SPECIFIED_FSP
, "2012-12-31 00:00:00"),

718 ("121231", 
UN_SPECIFIED_FSP
, "2012-12-31 00:00:00"),

721 
UN_SPECIFIED_FSP
,

726 
UN_SPECIFIED_FSP
,

729 ("2012-2-1 11:30:45", 
UN_SPECIFIED_FSP
, "2012-02-01 11:30:45"),

730 ("12-2-1 11:30:45", 
UN_SPECIFIED_FSP
, "2012-02-01 11:30:45"),

731 ("20121231113045", 
UN_SPECIFIED_FSP
, "2012-12-31 11:30:45"),

732 ("121231113045", 
UN_SPECIFIED_FSP
, "2012-12-31 11:30:45"),

733 ("2012-02-29", 
UN_SPECIFIED_FSP
, "2012-02-29 00:00:00"),

757 
	gšput
, 
	gf¥
, 
	gexp
è
š
 
	gok_bËs
 {

758 
Ët
 
mut
 
	gutc_t
 = 
Time
::
·r£_utc_d©‘ime
(
šput
, 
UN_SPECIFIED_FSP
).
unw¿p
();

759 
	gutc_t
.
round_äac
(
f¥
).
unw¿p
();

760 
Ët
 
	gex³ù
 = 
Time
::
·r£_utc_d©‘ime
(
exp
, 
UN_SPECIFIED_FSP
).
unw¿p
();

761 
	gas£¹_eq
!(

762 
	gutc_t
,

763 
	gex³ù
,

765 
	gšput
,

766 
	gexp
,

767 
	gutc_t
,

768 
	gex³ù


771 
mut
 
off£t
 
š
 
	gMIN_OFFSET
..
	gMAX_OFFSET
 {

772 
	goff£t
 *= 60;

773 
Ët
 
	gtz
 = 
FixedOff£t
::
—¡
(
off£t
);

774 
Ët
 
mut
 
	gt
 = 
Time
::
·r£_d©‘ime
(
šput
, 
UN_SPECIFIED_FSP
, &
tz
).
unw¿p
();

775 
	gt
.
round_äac
(
f¥
).
unw¿p
();

776 
Ët
 
	gex³ù
 = 
Time
::
·r£_d©‘ime
(
exp
, 
UN_SPECIFIED_FSP
, &
tz
).
unw¿p
();

777 
	gas£¹_eq
!(

778 
	gt
,

779 
	gex³ù
,

781 
	goff£t
,

782 
	gšput
,

783 
	gexp
,

784 
	gt
,

785 
	gex³ù


791 #[
‹¡
]

792 
â
 
‹¡_£t_
() {

793 
Ët
 
	gÿ£s
 = 
vec
![

798 
	gs
, 
	gexp
è
š
 
	gÿ£s
 {

799 
Ët
 
mut
 
	g»s
 = 
Time
::
·r£_utc_d©‘ime
(
s
, 
UN_SPECIFIED_FSP
).
unw¿p
();

800 
	g»s
.
£t_
(
ty³s
::
DATE
).
unw¿p
();

801 
	g»s
.
£t_
(
ty³s
::
DATETIME
).
unw¿p
();

802 
Ët
 
	g•
 = 
Time
::
·r£_utc_d©‘ime
(
exp
, 
UN_SPECIFIED_FSP
).
unw¿p
();

803 
	gas£¹_eq
!(
	g»s
, 
	g•
);

804 
Ët
 
	g»s
 = 
»s
.
£t_
(
ty³s
::
TIMESTAMP
);

805 
	gas£¹
!(
	g»s
.
is_”r
());

809 #[
‹¡
]

810 
â
 
‹¡_äom_du¿tiÚ
() {

811 
Ët
 
	gÿ£s
 = 
vec
![("11:30:45.123456"), ("-35:30:46")];

812 
Ët
 
	gtz
 = 
FixedOff£t
::
—¡
(0);

813 
s
 
š
 
	gÿ£s
 {

814 
Ët
 
	gd
 = 
MyDu¿tiÚ
::
·r£
(
s
.
as_by‹s
(), 
MAX_FSP
).
unw¿p
();

815 
Ët
 
	gg‘
 = 
Time
::
äom_du¿tiÚ
(&
tz
, 
ty³s
::
DATETIME
, &
d
).
unw¿p
();

816 
Ët
 
	gg‘_today
 = 
g‘
.
time


817 .
checked_sub_sigÃd
(
Du¿tiÚ
::
Çno£cÚds
(
d
.
to_Çnos
()))

818 .
unw¿p
();

819 
Ët
 
	gnow
 = 
Utc
::
now
();

820 
	gas£¹_eq
!(
	gg‘_today
.
y—r
(), 
	gnow
.year());

821 
	gas£¹_eq
!(
	gg‘_today
.
mÚth
(), 
	gnow
.month());

822 
	gas£¹_eq
!(
	gg‘_today
.
day
(), 
	gnow
.day());

823 
	gas£¹_eq
!(
	gg‘_today
.
hour
(), 0);

824 
	gas£¹_eq
!(
	gg‘_today
.
mšu‹
(), 0);

825 
	gas£¹_eq
!(
	gg‘_today
.
£cÚd
(), 0);

829 #[
‹¡
]

830 
â
 
‹¡_cÚv”t_to_du¿tiÚ
() {

831 
Ët
 
	gÿ£s
 = 
vec
![

840 
	gs
, 
	gf¥
, 
	gex³ù
è
š
 
	gÿ£s
 {

841 
Ët
 
	gt
 = 
Time
::
·r£_utc_d©‘ime
(
s
, 
f¥
).
unw¿p
();

842 
Ët
 
	gdu
 = 
t
.
to_du¿tiÚ
().
unw¿p
();

843 
Ët
 
	gg‘
 = 
du
.
to_¡ršg
();

844 
	gas£¹_eq
!(
	gg‘
, 
	gex³ù
);

	@src/coprocessor/codec/mysql/types.rs

15 cÚ¡ 
	gNOT_NULL_FLAG
: 
u64
 = 1;

17 
pub
 cÚ¡ 
	gUNSIGNED_FLAG
: 
u64
 = 32;

19 
pub
 cÚ¡ 
	gPARSE_TO_JSON_FLAG
: 
u64
 = 262144;

21 
pub
 cÚ¡ 
	gIS_BOOLEAN_FLAG
: 
u64
 = 524288;

24 #[
šlše
]

25 
pub
 
â
 
	ghas_unsigÃd_æag
<
	gT
: 
IÁo
<
u64
>>(
æag
: 
T
è-> 
boŞ
 {

26 
Ët
 
æag
: 
u64
 = fÏg.
što
();

27 
	gæag
 & 
	gUNSIGNED_FLAG
 > 0

31 #[
šlše
]

32 
pub
 
â
 
has_nÙ_nuÎ_æag
(
æag
: 
u64
è-> 
boŞ
 {

33 
æag
 & 
NOT_NULL_FLAG
 > 0

36 #[
šlše
]

37 
pub
 
â
 
has_·r£_to_jsÚ_æag
<
T
: 
IÁo
<
u64
>>(
æag
: Tè-> 
boŞ
 {

38 
Ët
 
æag
: 
u64
 = fÏg.
što
();

39 
	gæag
 & 
	gPARSE_TO_JSON_FLAG
 > 0

42 #[
šlše
]

43 
pub
 
â
 
	ghas_is_boŞ—n_æag
<
	gT
: 
IÁo
<
u64
>>(
æag
: 
T
è-> 
boŞ
 {

44 
Ët
 
æag
: 
u64
 = fÏg.
što
();

45 
	gæag
 & 
	gIS_BOOLEAN_FLAG
 > 0

49 
pub
 cÚ¡ 
	gUNSPECIFIED
: 
u8
 = 0;

50 
pub
 cÚ¡ 
	gTINY
: 
u8
 = 1;

51 
pub
 cÚ¡ 
	gSHORT
: 
u8
 = 2;

52 
pub
 cÚ¡ 
	gLONG
: 
u8
 = 3;

53 
pub
 cÚ¡ 
	gFLOAT
: 
u8
 = 4;

54 
pub
 cÚ¡ 
	gDOUBLE
: 
u8
 = 5;

55 
pub
 cÚ¡ 
	gNULL
: 
u8
 = 6;

56 
pub
 cÚ¡ 
	gTIMESTAMP
: 
u8
 = 7;

57 
pub
 cÚ¡ 
	gLONG_LONG
: 
u8
 = 8;

58 
pub
 cÚ¡ 
	gINT24
: 
u8
 = 9;

59 
pub
 cÚ¡ 
	gDATE
: 
u8
 = 10;

60 
pub
 cÚ¡ 
	gDURATION
: 
u8
 = 11;

61 
pub
 cÚ¡ 
	gDATETIME
: 
u8
 = 12;

62 
pub
 cÚ¡ 
	gYEAR
: 
u8
 = 13;

63 
pub
 cÚ¡ 
	gNEWDATE
: 
u8
 = 14;

64 
pub
 cÚ¡ 
	gVARCHAR
: 
u8
 = 15;

65 
pub
 cÚ¡ 
	gBIT
: 
u8
 = 16;

67 
pub
 cÚ¡ 
	gJSON
: 
u8
 = 0xf5;

68 
pub
 cÚ¡ 
	gNEW_DECIMAL
: 
u8
 = 246;

69 
pub
 cÚ¡ 
	gENUM
: 
u8
 = 247;

70 
pub
 cÚ¡ 
	gSET
: 
u8
 = 248;

71 
pub
 cÚ¡ 
	gTINY_BLOB
: 
u8
 = 249;

72 
pub
 cÚ¡ 
	gMEDIUM_BLOB
: 
u8
 = 250;

73 
pub
 cÚ¡ 
	gLONG_BLOB
: 
u8
 = 251;

74 
pub
 cÚ¡ 
	gBLOB
: 
u8
 = 252;

75 
pub
 cÚ¡ 
	gVAR_STRING
: 
u8
 = 253;

76 
pub
 cÚ¡ 
	gSTRING
: 
u8
 = 254;

77 
pub
 cÚ¡ 
	gGEOMETRY
: 
u8
 = 255;

	@src/coprocessor/codec/table.rs

15 
u£
 
	g¡d
::
io
::
Wr™e
;

16 
u£
 
	g¡d
::{
cmp
, 
	gu8
};

17 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

19 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

20 
u£
 
	gut
::
esÿ³
;

21 
u£
 
	gut
::
cŞËùiÚs
::{
HashM­
, 
	gHashS‘
};

23 
u£
 
	gut
::
codec
::
numb”
::{
Numb”Decod”
, 
	gNumb”Encod”
};

24 
u£
 
	gut
::
codec
::
by‹s
::
By‹sDecod”
;

25 
u£
 
	gsu³r
::
d©um
::
D©umDecod”
;

26 
u£
 
	gsu³r
::{
d©um
, 
	gD©um
, 
	gResuÉ
};

27 
u£
 
	gsu³r
::
mysql
::{
ty³s
, 
	gDu¿tiÚ
, 
	gTime
};

30 
pub
 cÚ¡ 
	gID_LEN
: 
usize
 = 8;

31 
pub
 cÚ¡ 
	gPREFIX_LEN
: 
usize
 = 
TABLE_PREFIX_LEN
 + 
ID_LEN
 + 
SEP_LEN
;

32 
pub
 cÚ¡ 
	gRECORD_ROW_KEY_LEN
: 
usize
 = 
PREFIX_LEN
 + 
ID_LEN
;

33 
pub
 cÚ¡ 
	gTABLE_PREFIX
: &'static [u8] = b"t";

34 
pub
 cÚ¡ 
RECORD_PREFIX_SEP
: &'static [u8] = b"_r";

35 
pub
 cÚ¡ 
INDEX_PREFIX_SEP
: &'static [u8] = b"_i";

36 
pub
 cÚ¡ 
SEP_LEN
: 
usize
 = 2;

37 
pub
 cÚ¡ 
	gTABLE_PREFIX_LEN
: 
usize
 = 1;

38 
pub
 cÚ¡ 
	gTABLE_PREFIX_KEY_LEN
: 
usize
 = 
TABLE_PREFIX_LEN
 + 
ID_LEN
;

41 
Œa™
 
	gTabËEncod”
: 
Numb”Encod”
 {

42 
â
 
­³nd_bË_»cÜd_´efix
(&
mut
 
£lf
, 
bË_id
: 
i64
è-> 
ResuÉ
<()> {

43 
£lf
.
wr™e_®l
(
TABLE_PREFIX
)?;

44 
	g£lf
.
’code_i64
(
bË_id
)?;

45 
	g£lf
.
wr™e_®l
(
RECORD_PREFIX_SEP
).
m­_”r
(
From
::
äom
)

48 
â
 
­³nd_bË_šdex_´efix
(&
mut
 
£lf
, 
bË_id
: 
i64
è-> 
ResuÉ
<()> {

49 
£lf
.
wr™e_®l
(
TABLE_PREFIX
)?;

50 
	g£lf
.
’code_i64
(
bË_id
)?;

51 
	g£lf
.
wr™e_®l
(
INDEX_PREFIX_SEP
).
m­_”r
(
From
::
äom
)

55 
im¶
<
T
: 
Wr™e
> 
TabËEncod”
 T {}

59 
pub
 
â
 
exŒaù_bË_´efix
(
key
: &[
u8
]è-> 
ResuÉ
<&[u8]> {

60 !
key
.
¡¬ts_w™h
(
TABLE_PREFIX
è|| key.
Ën
(è< 
TABLE_PREFIX_KEY_LEN
 {

61 
E¼
(
šv®id_ty³
!(

63 
key


66 
Ok
(&
key
[..
TABLE_PREFIX_KEY_LEN
])

70 
pub
 
â
 
æ©‹n
(
d©a
: 
D©um
è-> 
ResuÉ
<Datum> {

71 
m©ch
 
d©a
 {

72 
D©um
::
Dur
(
d
è=> 
Ok
(D©um::
I64
(d.
to_Çnos
())),

73 
	gD©um
::
Time
(
t
è=> 
Ok
(
D©um
::
U64
Ñ.
to_·cked_u64
())),

74 
	g_
 => 
Ok
(
d©a
),

80 
pub
 
â
 
’code_row
(
row
: 
Vec
<
D©um
>, 
cŞ_ids
: &[
i64
]è-> 
ResuÉ
<Vec<
u8
>> {

81 
row
.
Ën
(è!ğ
cŞ_ids
.len() {

82  
E¼
(
box_”r
!(

84 
row
.
Ën
(),

85 
cŞ_ids
.
Ën
()

88 
Ët
 
mut
 
	gv®ues
 = 
Vec
::
w™h_ÿ·c™y
(
cmp
::
max
(
row
.
Ën
() * 2, 1));

89 &
	gid
, 
	gcŞ
è
š
 
	gcŞ_ids
.
što_™”
().
z
(
row
) {

90 
	gv®ues
.
push
(
D©um
::
I64
(
id
));

91 
Ët
 
	gfc
 = 
æ©‹n
(
cŞ
)?;

92 
	gv®ues
.
push
(
fc
);

94 
	gv®ues
.
is_em±y
() {

95 
	gv®ues
.
push
(
D©um
::
NuÎ
);

97 
	gd©um
::
’code_v®ue
(&
v®ues
)

101 
pub
 
â
 
’code_row_key
(
bË_id
: 
i64
, 
’coded_hªdË
: &[
u8
]è-> 
Vec
<u8> {

102 
Ët
 
mut
 
key
 = 
Vec
::
w™h_ÿ·c™y
(
RECORD_ROW_KEY_LEN
);

104 
	gkey
.
­³nd_bË_»cÜd_´efix
(
bË_id
).
unw¿p
();

105 
	gkey
.
wr™e_®l
(
’coded_hªdË
).
unw¿p
();

106 
	gkey


110 
pub
 
â
 
’code_cŞumn_key
(
bË_id
: 
i64
, 
hªdË
: i64, 
cŞumn_id
: i64è-> 
Vec
<
u8
> {

111 
Ët
 
mut
 
key
 = 
Vec
::
w™h_ÿ·c™y
(
RECORD_ROW_KEY_LEN
 + 
ID_LEN
);

112 
	gkey
.
­³nd_bË_»cÜd_´efix
(
bË_id
).
unw¿p
();

113 
	gkey
.
’code_i64
(
hªdË
).
unw¿p
();

114 
	gkey
.
’code_i64
(
cŞumn_id
).
unw¿p
();

115 
	gkey


119 
pub
 
â
 
decode_hªdË
(
’coded
: &[
u8
]è-> 
ResuÉ
<
i64
> {

120 !
’coded
.
¡¬ts_w™h
(
TABLE_PREFIX
) {

121  
E¼
(
šv®id_ty³
!(

123 
esÿ³
(
’coded
)

127 
Ët
 
mut
 
	g»maššg
 = &
’coded
[
TABLE_PREFIX
.
Ën
()..];

128 
	g»maššg
.
decode_i64
()?;

130 !
	g»maššg
.
¡¬ts_w™h
(
RECORD_PREFIX_SEP
) {

131  
E¼
(
šv®id_ty³
!(

133 
esÿ³
(
’coded
)

137 
	g»maššg
 = &
»maššg
[
RECORD_PREFIX_SEP
.
Ën
()..];

138 
	g»maššg
.
decode_i64
()

142 
pub
 
â
 
Œunÿ‹_as_row_key
(
key
: &[
u8
]è-> 
ResuÉ
<&[u8]> {

143 
decode_hªdË
(
key
)?;

144 
Ok
(&
key
[..
RECORD_ROW_KEY_LEN
])

148 
pub
 
â
 
’code_šdex_£ek_key
(
bË_id
: 
i64
, 
idx_id
: i64, 
’coded
: &[
u8
]è-> 
Vec
<u8> {

149 
Ët
 
mut
 
key
 = 
Vec
::
w™h_ÿ·c™y
(
PREFIX_LEN
 + 
ID_LEN
 + 
’coded
.
Ën
());

150 
	gkey
.
­³nd_bË_šdex_´efix
(
bË_id
).
unw¿p
();

151 
	gkey
.
’code_i64
(
idx_id
).
unw¿p
();

152 
	gkey
.
wr™e_®l
(
’coded
).
unw¿p
();

153 
	gkey


157 
pub
 
â
 
decode_šdex_key
(

158 
ùx
: &
Ev®CÚ‹xt
,

159 
mut
 
’coded
: &[
u8
],

160 
šfos
: &[
CŞumnInfo
],

161 è-> 
	gResuÉ
<
	gVec
<
	gD©um
>> {

162 
	g’coded
 = &
’coded
[
PREFIX_LEN
 + 
ID_LEN
..];

163 
Ët
 
mut
 
	g»s
 = 
vec
![];

165 
šfo
 
š
 
	gšfos
 {

166 
	g’coded
.
is_em±y
() {

167  
E¼
(
box_”r
!("{} i toØshÜt.", 
esÿ³
(
’coded
)));

169 
Ët
 
mut
 
	gv
 = 
’coded
.
decode_d©um
()?;

170 
	gv
 = 
unæ©‹n
(
ùx
, 
v
, 
šfo
)?;

171 
	g»s
.
push
(
v
);

174 
Ok
(
»s
)

178 
â
 
unæ©‹n
(
ùx
: &
Ev®CÚ‹xt
, 
d©um
: 
D©um
, 
cŞ
: &
CŞumnInfo
è-> 
ResuÉ
<Datum> {

179 
Ët
 
D©um
::
NuÎ
 = 
d©um
 {

180  
Ok
(
d©um
);

182 
	gcŞ
.
g‘_
(è> 
	gu8
::
MAX
 
as
 
i32
 || 
cŞ
.get_tp() < 0 {

183 
”rÜ
!("unknowÀty³ {} {:?}", 
	gcŞ
.
g‘_
(), 
	gd©um
);

185 
m©ch
 
	gcŞ
.
g‘_
(è
as
 
	gu8
 {

186 
	gty³s
::
FLOAT
 => 
Ok
(
D©um
::
F64
(
d©um
.
f64
(è
as
 
f32
‡s f64)),

187 
	gty³s
::
DATE
 | 
ty³s
::
DATETIME
 |y³s::
TIMESTAMP
 => {

188 
Ët
 
f¥
 = 
cŞ
.
g‘_decim®
(è
as
 
i8
;

189 
Ët
 
	gt
 = 
Time
::
äom_·cked_u64
(
d©um
.
u64
(), 
cŞ
.
g‘_
(è
as
 
u8
, 
f¥
, &
ùx
.
tz
)?;

190 
Ok
(
D©um
::
Time
(
t
))

192 
ty³s
::
DURATION
 => 
Du¿tiÚ
::
äom_Çnos
(
d©um
.
i64
(), 0).
m­
(
D©um
::
Dur
),

193 
	gty³s
::
ENUM
 | 
ty³s
::
SET
 |y³s::
BIT
 => {

194 
E¼
(
box_”r
!("unæ©‹ÀcŞumÀ{:?} i nÙ suµÜ‹d y‘.", 
cŞ
))

196 
t
 => {

197 
debug_as£¹
!(

199 
ty³s
::
TINY
,

200 
ty³s
::
SHORT
,

201 
ty³s
::
YEAR
,

202 
ty³s
::
INT24
,

203 
ty³s
::
LONG
,

204 
ty³s
::
LONG_LONG
,

205 
ty³s
::
DOUBLE
,

206 
ty³s
::
TINY_BLOB
,

207 
ty³s
::
MEDIUM_BLOB
,

208 
ty³s
::
BLOB
,

209 
ty³s
::
LONG_BLOB
,

210 
ty³s
::
VARCHAR
,

211 
ty³s
::
STRING
,

212 
ty³s
::
NEW_DECIMAL
,

213 
ty³s
::
JSON


214 ].
cÚšs
(&
t
),

216 
t
,

217 
d©um


219 
Ok
(
d©um
)

224 
pub
 
Œa™
 
	gTabËDecod”
: 
D©umDecod”
 {

226 
â
 
decode_cŞ_v®ue
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
cŞ
: &
CŞumnInfo
è-> 
ResuÉ
<
D©um
> {

227 
Ët
 
d
 = 
£lf
.
decode_d©um
()?;

228 
unæ©‹n
(
ùx
, 
d
, 
cŞ
)

234 
â
 
decode_row
(

235 &
mut
 
£lf
,

236 
ùx
: &
Ev®CÚ‹xt
,

237 
cŞs
: &
HashM­
<
i64
, 
CŞumnInfo
>,

238 è-> 
	gResuÉ
<
	gHashM­
<
	gi64
, 
	gD©um
>> {

239 
Ët
 
mut
 
	gv®ues
 = 
£lf
.
decode
()?;

240 
	gv®ues
.
g‘
(0).
m­_Ü
(
Œue
, |
d
| *d =ğ
D©um
::
NuÎ
) {

241  
Ok
(
HashM­
::());

243 
	gv®ues
.
Ën
() & 1 == 1 {

244  
E¼
(
box_”r
!("decoded„ow values'†ength should beƒven!"));

246 
Ët
 
mut
 
	grow
 = 
HashM­
::
w™h_ÿ·c™y_ªd_hash”
(
cŞs
.
Ën
(), 
DeçuÉ
::());

247 
Ët
 
mut
 
	gd¿š
 = 
v®ues
.
d¿š
(..);

248 
	gloİ
 {

249 
Ët
 
	gid
 = 
m©ch
 
d¿š
.
Ãxt
() {

250 
NÚe
 =>  
Ok
(
row
),

251 
Some
(
id
è=> id.
i64
(),

253 
Ët
 
	gv
 = 
d¿š
.
Ãxt
().
unw¿p
();

254 
Ët
 
Some
(
ci
èğ
cŞs
.
g‘
(&
id
) {

255 
Ët
 
v
 = 
unæ©‹n
(
ùx
, v, 
ci
)?;

256 
	grow
.
š£¹
(
id
, 
v
);

262 
	gim¶
<
	gT
: 
By‹sDecod”
> 
TabËDecod”
 
T
 {}

264 #[
d”ive
(
Debug
)]

265 
pub
 
	sRowCŞM‘a
 {

266 
off£t
: 
usize
,

267 
	mËngth
: 
usize
,

270 #[
d”ive
(
Debug
)]

271 
pub
 
	sRowCŞsDiù
 {

273 
pub
 
	mv®ue
: 
Vec
<
u8
>,

276 
pub
 
	mcŞs
: 
HashM­
<
i64
, 
	mRowCŞM‘a
>,

279 
im¶
 
	gRowCŞM‘a
 {

280 
pub
 
â
 
Ãw
(
off£t
: 
usize
, 
Ëngth
: usizeè-> 
RowCŞM‘a
 {

281 
RowCŞM‘a
 {

282 
off£t
: offset,

283 
	gËngth
: 
Ëngth
,

288 
im¶
 
	gRowCŞsDiù
 {

289 
pub
 
â
 
Ãw
(
cŞs
: 
HashM­
<
i64
, 
RowCŞM‘a
>, 
v®
: 
Vec
<
u8
>è-> 
RowCŞsDiù
 {

290 
RowCŞsDiù
 {

291 
v®ue
: 
v®
,

292 
	gcŞs
: 
cŞs
,

296 
pub
 
â
 
Ën
(&
£lf
è-> 
	gusize
 {

297 
	g£lf
.
	gcŞs
.
Ën
()

300 
pub
 
â
 
is_em±y
(&
£lf
è-> 
	gboŞ
 {

301 
	g£lf
.
	gcŞs
.
is_em±y
()

304 
pub
 
â
 
g‘
(&
£lf
, 
key
: 
i64
è-> 
O±iÚ
<&[
u8
]> {

305 
Ët
 
Some
(
m‘a
èğ
£lf
.
cŞs
.
g‘
(&
key
) {

306  
Some
(&
£lf
.
v®ue
[
m‘a
.
off£t
..(m‘a.off£ˆ+ m‘a.
Ëngth
)]);

308 
	gNÚe


311 
pub
 
â
 
­³nd
(&
mut
 
£lf
, 
cid
: 
i64
, 
v®ue
: &muˆ
Vec
<
u8
>) {

312 
Ët
 
off£t
 = 
£lf
.
v®ue
.
Ën
();

313 
Ët
 
	gËngth
 = 
v®ue
.
Ën
();

314 
	g£lf
.
	gv®ue
.
­³nd
(
v®ue
);

315 
	g£lf
.
	gcŞs
.
š£¹
(
cid
, 
RowCŞM‘a
::
Ãw
(
off£t
, 
Ëngth
));

319 
pub
 
â
 
g‘_cŞumn_v®ues
(&
£lf
è-> &[
u8
] {

320 
Ët
 
mut
 
	g¡¬t
 = 
£lf
.
v®ue
.
Ën
();

321 
Ët
 
mut
 
	gËngth
 = 0;

322 
m‘a
 
š
 
	g£lf
.
	gcŞs
.
v®ues
() {

323 
	gm‘a
.
	goff£t
 < 
	g¡¬t
 {

324 
	g¡¬t
 = 
m‘a
.
off£t
;

326 
	gËngth
 +ğ
m‘a
.
Ëngth
;

328 &
	g£lf
.
	gv®ue
[
¡¬t
..¡¬ˆ+ 
Ëngth
]

334 
pub
 
â
 
cut_row
(
d©a
: 
Vec
<
u8
>, 
cŞs
: &
HashS‘
<
i64
>è-> 
ResuÉ
<
RowCŞsDiù
> {

335 
cŞs
.
is_em±y
(è|| 
d©a
.is_em±y(è|| (d©a.
Ën
(è=ğ1 && d©a[0] =ğ
d©um
::
NIL_FLAG
) {

336  
Ok
(
RowCŞsDiù
::
Ãw
(
HashM­
::(), 
d©a
));

339 
Ët
 
	gm‘a_m­
 = {

340 
Ët
 
mut
 
m‘a_m­
 = 
HashM­
::
w™h_ÿ·c™y_ªd_hash”
(
cŞs
.
Ën
(), 
DeçuÉ
::());

341 
Ët
 
	gËngth
 = 
d©a
.
Ën
();

342 
Ët
 
mut
 
	gtmp_d©a
: &[
u8
] = 
d©a
.
as_»f
();

343 !
	gtmp_d©a
.
is_em±y
(è&& 
	gm‘a_m­
.
Ën
(è< 
	gcŞs
.len() {

344 
Ët
 
	gid
 = 
tmp_d©a
.
decode_d©um
()?.
i64
();

345 
Ët
 
	goff£t
 = 
Ëngth
 - 
tmp_d©a
.
Ën
();

346 
Ët
 (
v®
, 
»m
èğ
d©um
::
¥l™_d©um
(
tmp_d©a
, 
çl£
)?;

347 
	gcŞs
.
cÚšs
(&
id
) {

348 
	gm‘a_m­
.
š£¹
(
id
, 
RowCŞM‘a
::
Ãw
(
off£t
, 
v®
.
Ën
()));

350 
	gtmp_d©a
 = 
»m
;

352 
	gm‘a_m­


354 
Ok
(
RowCŞsDiù
::
Ãw
(
m‘a_m­
, 
d©a
))

358 
pub
 
â
 
cut_idx_key
(
key
: 
Vec
<
u8
>, 
cŞ_ids
: &[
i64
]è-> 
ResuÉ
<(
RowCŞsDiù
, 
	gO±iÚ
<
	gi64
>)> {

359 
Ët
 
mut
 
	gm‘a_m­
: 
HashM­
<
i64
, 
	gRowCŞM‘a
> =

360 
HashM­
::
w™h_ÿ·c™y_ªd_hash”
(
cŞ_ids
.
Ën
(), 
DeçuÉ
::());

361 
Ët
 
	ghªdË
 = {

362 
Ët
 
mut
 
tmp_d©a
: &[
u8
] = &
key
[
PREFIX_LEN
 + 
ID_LEN
..];

363 
Ët
 
	gËngth
 = 
key
.
Ën
();

365 &
id
 
š
 
	gcŞ_ids
 {

366 
Ët
 
	goff£t
 = 
Ëngth
 - 
tmp_d©a
.
Ën
();

367 
Ët
 (
v®
, 
»m
èğ
d©um
::
¥l™_d©um
(
tmp_d©a
, 
çl£
)?;

368 
	gm‘a_m­
.
š£¹
(
id
, 
RowCŞM‘a
::
Ãw
(
off£t
, 
v®
.
Ën
()));

369 
	gtmp_d©a
 = 
»m
;

372 
	gtmp_d©a
.
is_em±y
() {

373 
	gNÚe


375 
Some
(
box_Œy
!(
tmp_d©a
.
decode_d©um
()).
i64
())

378 
Ok
((
RowCŞsDiù
::
Ãw
(
m‘a_m­
, 
key
), 
hªdË
))

381 #[
cfg
(
‹¡
)]

382 
mod
 
	g‹¡
 {

383 
u£
 
	g¡d
::
i64
;

385 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

387 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
ty³s
;

388 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::{
£lf
, 
	gD©um
, 
	gD©umDecod”
};

389 
u£
 
	gut
::
codec
::
numb”
::
Numb”Encod”
;

390 
u£
 
	gut
::
cŞËùiÚs
::{
HashM­
, 
	gHashS‘
};

392 
u£
 
	gsu³r
::*;

394 #[
‹¡
]

395 
â
 
‹¡_row_key_codec
() {

396 
Ët
 
	g‹¡s
 = 
vec
![
i64
::
MIN
, i64::
MAX
, -1, 0, 2, 3, 1024];

397 &
t
 
	gš
 &
	g‹¡s
 {

398 
Ët
 
mut
 
	gbuf
 = 
vec
![];

399 
	gbuf
.
’code_i64
(
t
).
unw¿p
();

400 
Ët
 
	gk
 = 
’code_row_key
(1, &
buf
);

401 
	gas£¹_eq
!(
	gt
, 
decode_hªdË
(&
k
).
unw¿p
());

405 #[
‹¡
]

406 
â
 
‹¡_šdex_key_codec
() {

407 
Ët
 
	g‹¡s
 = 
vec
![
D©um
::
U64
(1), D©um::
By‹s
(
b
"123".
to_vec
()), D©um::
I64
(-1)];

408 
Ët
 
	gty³s
 = 
vec
![

409 
Ãw_cŞ_šfo
(
ty³s
::
LONG_LONG
),

410 
Ãw_cŞ_šfo
(
ty³s
::
VARCHAR
),

411 
Ãw_cŞ_šfo
(
ty³s
::
LONG_LONG
),

413 
Ët
 
	gbuf
 = 
d©um
::
’code_key
(&
‹¡s
).
unw¿p
();

414 
Ët
 
	g’coded
 = 
’code_šdex_£ek_key
(1, 2, &
buf
);

415 
	gas£¹_eq
!(

416 
	g‹¡s
,

417 
decode_šdex_key
(&
DeçuÉ
::(), &
’coded
, &
ty³s
).
unw¿p
()

421 
â
 
Ãw_cŞ_šfo
(

: 
u8
è-> 
CŞumnInfo
 {

422 
Ët
 
mut
 
cŞ_šfo
 = 
CŞumnInfo
::
Ãw
();

423 
	gcŞ_šfo
.
£t_
(

 
as
 
i32
);

424 
	gcŞ_šfo


427 
â
 
to_hash_m­
(
row
: &
RowCŞsDiù
è-> 
HashM­
<
i64
, 
	gVec
<
	gu8
>> {

428 
Ët
 
mut
 
	gd©a
 = 
HashM­
::
w™h_ÿ·c™y_ªd_hash”
(
row
.
cŞs
.
Ën
(), 
DeçuÉ
::());

429 
	grow
.
is_em±y
() {

430  
	gd©a
;

432 
	gkey
, 
	gm‘a
è
	gš
 &
	grow
.
	gcŞs
 {

433 
	gd©a
.
š£¹
(

434 *
key
,

435 
row
.
v®ue
[
m‘a
.
off£t
..(m‘a.off£ˆ+ m‘a.
Ëngth
)].
to_vec
(),

438 
	gd©a


441 
â
 
cut_row_as_owÃd
(
bs
: &[
u8
], 
cŞ_id_£t
: &
HashS‘
<
i64
>è-> 
HashM­
<i64, 
	gVec
<
	gu8
>> {

442 
Ët
 
	g»s
 = 
cut_row
(
bs
.
to_vec
(), 
cŞ_id_£t
).
unw¿p
();

443 
to_hash_m­
(&
»s
)

446 
â
 
cut_idx_key_as_owÃd
(
bs
: &[
u8
], 
ids
: &[
i64
]è-> (
HashM­
<i64, 
	gVec
<
	gu8
>>, 
	gO±iÚ
<
	gi64
>) {

447 
Ët
 (
»s
, 
Ëá
èğ
cut_idx_key
(
bs
.
to_vec
(), 
ids
).
unw¿p
();

448 (
to_hash_m­
(&
»s
), 
	gËá
)

451 #[
‹¡
]

452 
â
 
‹¡_row_codec
() {

453 
Ët
 
mut
 
	gcŞs
 = 
m­
![

454 1 => 
Ãw_cŞ_šfo
(
ty³s
::
LONG_LONG
),

455 2 => 
Ãw_cŞ_šfo
(
ty³s
::
VARCHAR
),

456 3 => 
Ãw_cŞ_šfo
(
ty³s
::
NEW_DECIMAL
),

457 5 => 
Ãw_cŞ_šfo
(
ty³s
::
JSON
)

460 
Ët
 
mut
 
	grow
 = 
m­
![

461 1 => 
D©um
::
I64
(100),

462 2 => 
D©um
::
By‹s
(
b
"abc".
to_vec
()),

463 3 => 
D©um
::
Dec
(10.
što
()),

464 5 => 
D©um
::
JsÚ
(
r
#"{"name": "John"}"#.parse().unwrap())

467 
Ët
 
cŞ_ids
: 
Vec
<
_
> = 
row
.
™”
().
m­
(|(&
id
, _)| id).
cŞËù
();

468 
Ët
 
cŞ_v®ues
: 
Vec
<
_
> = 
row
.
™”
().
m­
(|(_, 
v
)| v.
şÚe
()).
cŞËù
();

469 
Ët
 
mut
 
cŞ_’coded
: 
HashM­
<
_
, _> = 
row
.
™”
()

470 .
m­
(|(
k
, 
v
)| {

471 
Ët
 
f
 = 
su³r
::
æ©‹n
(
v
.
şÚe
()).
unw¿p
();

472 (*
k
, 
d©um
::
’code_v®ue
(&[
f
]).
unw¿p
())

474 .
cŞËù
();

475 
Ët
 
mut
 
cŞ_id_£t
: 
HashS‘
<
_
> = 
cŞ_ids
.
™”
().
şÚed
().
cŞËù
();

477 
Ët
 
bs
 = 
’code_row
(
cŞ_v®ues
, &
cŞ_ids
).
unw¿p
();

478 
as£¹
!(!
bs
.
is_em±y
());

480 
Ët
 
r
 = 
bs
.
as_¦iû
()

481 .
decode_row
(&
DeçuÉ
::(), &
cŞs
)

482 .
unw¿p
();

483 
as£¹_eq
!(
row
, 
r
);

485 
Ët
 
mut
 
d©ums
: 
HashM­
<
_
, _>;

486 
d©ums
 = 
cut_row_as_owÃd
(&
bs
, &
cŞ_id_£t
);

487 
as£¹_eq
!(
cŞ_’coded
, 
d©ums
);

489 
cŞs
.
š£¹
(4, 
Ãw_cŞ_šfo
(
ty³s
::
FLOAT
));

490 
Ët
 
r
 = 
bs
.
as_¦iû
()

491 .
decode_row
(&
DeçuÉ
::(), &
cŞs
)

492 .
unw¿p
();

493 
as£¹_eq
!(
row
, 
r
);

495 
cŞ_id_£t
.
š£¹
(4);

496 
d©ums
 = 
cut_row_as_owÃd
(&
bs
, &
cŞ_id_£t
);

497 
as£¹_eq
!(
cŞ_’coded
, 
d©ums
);

499 
cŞs
.
»move
(&4);

500 
cŞs
.
»move
(&3);

501 
Ët
 
r
 = 
bs
.
as_¦iû
()

502 .
decode_row
(&
DeçuÉ
::(), &
cŞs
)

503 .
unw¿p
();

504 
row
.
»move
(&3);

505 
as£¹_eq
!(
row
, 
r
);

507 
cŞ_id_£t
.
»move
(&3);

508 
cŞ_id_£t
.
»move
(&4);

509 
d©ums
 = 
cut_row_as_owÃd
(&
bs
, &
cŞ_id_£t
);

510 
cŞ_’coded
.
»move
(&3);

511 
as£¹_eq
!(
cŞ_’coded
, 
d©ums
);

513 
Ët
 
bs
 = 
’code_row
(
vec
![], &[]).
unw¿p
();

514 
as£¹
!(!
bs
.
is_em±y
());

515 
as£¹
!(

516 
bs
.
as_¦iû
()

517 .
decode_row
(&
DeçuÉ
::(), &
cŞs
)

518 .
unw¿p
()

519 .
is_em±y
()

521 
d©ums
 = 
cut_row_as_owÃd
(&
bs
, &
cŞ_id_£t
);

522 
as£¹
!(
d©ums
.
is_em±y
());

525 #[
‹¡
]

526 
â
 
‹¡_idx_codec
() {

527 
Ët
 
mut
 
cŞ_ids
 = 
vec
![1, 2, 3];

528 
Ët
 
cŞ_ty³s
 = 
vec
![

529 
Ãw_cŞ_šfo
(
ty³s
::
LONG_LONG
),

530 
Ãw_cŞ_šfo
(
ty³s
::
VARCHAR
),

531 
Ãw_cŞ_šfo
(
ty³s
::
NEW_DECIMAL
),

533 
Ët
 
cŞ_v®ues
 = 
vec
![

534 
D©um
::
I64
(100),

535 
D©um
::
By‹s
(
b
"abc".
to_vec
()),

536 
D©um
::
Dec
(10.
što
()),

538 
Ët
 
mut
 
cŞ_’coded
: 
HashM­
<
_
, _> = 
cŞ_ids


539 .
™”
()

540 .
z
(&
cŞ_ty³s
)

541 .
z
(&
cŞ_v®ues
)

542 .
m­
(|((
id
, 
t
), 
v
)| {

543 
Ët
 
unæ©‹Ãd
 = 
su³r
::
unæ©‹n
(&
DeçuÉ
::(), 
v
.
şÚe
(), 
t
).
unw¿p
();

544 
Ët
 
’coded
 = 
d©um
::
’code_key
(&[
unæ©‹Ãd
]).
unw¿p
();

545 (*
id
, 
’coded
)

547 .
cŞËù
();

549 
Ët
 
key
 = 
d©um
::
’code_key
(&
cŞ_v®ues
).
unw¿p
();

550 
Ët
 
bs
 = 
’code_šdex_£ek_key
(1, 1, &
key
);

551 
as£¹
!(!
bs
.
is_em±y
());

553 
Ët
 
r
 = 
decode_šdex_key
(&
DeçuÉ
::(), &
bs
, &
cŞ_ty³s
).
unw¿p
();

554 
as£¹_eq
!(
cŞ_v®ues
, 
r
);

556 
Ët
 
mut
 
»s
: (
HashM­
<
_
, _>, _èğ
cut_idx_key_as_owÃd
(&
bs
, &
cŞ_ids
);

557 
as£¹_eq
!(
cŞ_’coded
, 
»s
.0);

558 
as£¹
!(
»s
.1.
is_nÚe
());

560 
Ët
 
hªdË_d©a
 = 
cŞ_’coded
.
»move
(&3).
unw¿p
();

561 
Ët
 
hªdË
 = 
hªdË_d©a
.
is_em±y
() {

562 
NÚe


564 
Some
(

565 (
hªdË_d©a
.
as_»f
(è
as
 &[
u8
])

566 .
decode_d©um
()

567 .
unw¿p
()

568 .
i64
(),

571 
cŞ_ids
.
»move
(2);

572 
»s
 = 
cut_idx_key_as_owÃd
(&
bs
, &
cŞ_ids
);

573 
as£¹_eq
!(
cŞ_’coded
, 
»s
.0);

574 
as£¹_eq
!(
»s
.1, 
hªdË
);

576 
Ët
 
bs
 = 
’code_šdex_£ek_key
(1, 1, &[]);

577 
as£¹
!(!
bs
.
is_em±y
());

578 
as£¹
!(

579 
decode_šdex_key
(&
DeçuÉ
::(), &
bs
, &[])

580 .
unw¿p
()

581 .
is_em±y
()

583 
»s
 = 
cut_idx_key_as_owÃd
(&
bs
, &[]);

584 
as£¹
!(
»s
.0.
is_em±y
());

585 
as£¹
!(
»s
.1.
is_nÚe
());

588 #[
‹¡
]

589 
â
 
‹¡_exŒaù_bË_´efix
() {

590 
Ët
 
ÿ£s
 = 
vec
![

591 (
vec
![], 
NÚe
),

592 (
b
"a\x80\x00\x00\x00\x00\x00\x00\x01".
to_vec
(), 
NÚe
),

593 (
b
"t\x80\x00\x00\x00\x00\x00\x01".
to_vec
(), 
NÚe
),

595 
b
"t\x80\x00\x00\x00\x00\x00\x00\x01".
to_vec
(),

596 
Some
(
b
"t\x80\x00\x00\x00\x00\x00\x00\x01".
to_vec
()),

599 
b
"t\x80\x00\x00\x00\x00\x00\x00\x01_r\xff\xff".
to_vec
(),

600 
Some
(
b
"t\x80\x00\x00\x00\x00\x00\x00\x01".
to_vec
()),

603 
šput
, 
ouut
è
š
 
ÿ£s
 {

604 
as£¹_eq
!(
exŒaù_bË_´efix
(&
šput
).
ok
().
m­
(
From
::
äom
), 
ouut
);

	@src/coprocessor/dag/dag.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

17 
u£
 
	gtb
::
£Ëù
::{
Chunk
, 
	gDAGReque¡
, 
	gS–eùRe¥Ú£
};

18 
u£
 
	gkv´Ùo
::
cİroûssÜ
::{
KeyRªge
, 
	gRe¥Ú£
};

19 
u£
 
	g´Ùobuf
::{
Mes§ge
 
as
 
PbMsg
, 
	gR•—‹dF›ld
};

21 
u£
 
	gcİroûssÜ
::
codec
::
mysql
;

22 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::{
D©um
, 
	gD©umEncod”
};

23 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

24 
u£
 
	gcİroûssÜ
::{
E¼Ü
, 
	gResuÉ
};

25 
u£
 
	gcİroûssÜ
::
’dpošt
::{
g‘_pk
, 
	gto_pb_”rÜ
, 
	gReqCÚ‹xt
};

26 
u£
 
	g¡Üage
::{
SÇpshÙ
, 
	gSÇpshÙStÜe
, 
	gSti¡ics
};

28 
u£
 
	gsu³r
::
executÜ
::{
bud_exec
, 
	gExecutÜ
, 
	gRow
};

30 
pub
 
	sDAGCÚ‹xt
 {

31 
	mcŞumns
: 
Arc
<
Vec
<
CŞumnInfo
>>,

32 
	mhas_aggr
: 
boŞ
,

33 
	m»q_ùx
: 
Arc
<
ReqCÚ‹xt
>,

34 
	mexec
: 
Box
<
ExecutÜ
>,

35 
	mouut_off£ts
: 
Vec
<
u32
>,

36 
	mb©ch_row_lim™
: 
usize
,

39 
im¶
 
	gDAGCÚ‹xt
 {

40 
pub
 
â
 
Ãw
(

41 
mut
 
»q
: 
DAGReque¡
,

42 
¿nges
: 
Vec
<
KeyRªge
>,

43 
¢­
: 
Box
<
SÇpshÙ
>,

44 
»q_ùx
: 
Arc
<
ReqCÚ‹xt
>,

45 
b©ch_row_lim™
: 
usize
,

46 è-> 
	gResuÉ
<
	gDAGCÚ‹xt
> {

47 
Ët
 
	gev®_ùx
 = 
Arc
::
Ãw
(
box_Œy
!(
Ev®CÚ‹xt
::new(

48 
»q
.
g‘_time_zÚe_off£t
(),

49 
»q
.
g‘_æags
()

51 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(

52 
¢­
,

53 
»q
.
g‘_¡¬t_ts
(),

54 
»q_ùx
.
isŞ©iÚ_Ëv–
,

55 
»q_ùx
.
fl_ÿche
,

58 
Ët
 
	gdag_executÜ
 = 
bud_exec
(
»q
.
ke_executÜs
().
što_vec
(), 
¡Üe
, 
¿nges
, 
ev®_ùx
)?;

59 
Ok
(
DAGCÚ‹xt
 {

60 
cŞumns
: 
dag_executÜ
.columns,

61 
has_aggr
: 
dag_executÜ
.has_aggr,

62 
»q_ùx
:„eq_ctx,

63 
exec
: 
dag_executÜ
.exec,

64 
ouut_off£ts
: 
»q
.
ke_ouut_off£ts
(),

65 
b©ch_row_lim™
: batch_row_limit,

69 
pub
 
â
 
hªdË_»que¡
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gRe¥Ú£
> {

70 
Ët
 
mut
 
	g»cÜd_út
 = 0;

71 
Ët
 
mut
 
	gchunks
 = 
Vec
::
Ãw
();

72 
	gloİ
 {

73 
m©ch
 
	g£lf
.
	gexec
.
Ãxt
() {

74 
Ok
(
Some
(
row
)) => {

75 
£lf
.
»q_ùx
.
check_if_outd©ed
()?;

76 
	gchunks
.
is_em±y
(è|| 
	g»cÜd_út
 >ğ
£lf
.
b©ch_row_lim™
 {

77 
Ët
 
chunk
 = 
Chunk
::
Ãw
();

78 
	gchunks
.
push
(
chunk
);

79 
	g»cÜd_út
 = 0;

81 
Ët
 
	gchunk
 = 
chunks
.
Ï¡_mut
().
unw¿p
();

82 
	g»cÜd_út
 += 1;

83 
	g£lf
.
	ghas_aggr
 {

84 
	gchunk
.
mut_rows_d©a
().
ex‹nd_äom_¦iû
(&
row
.
d©a
.
v®ue
);

86 
Ët
 
	gv®ue
 = 
šæ©e_cŞs
(&
row
, &
£lf
.
cŞumns
, &£lf.
ouut_off£ts
)?;

87 
	gchunk
.
mut_rows_d©a
().
ex‹nd_äom_¦iû
(&
v®ue
);

90 
Ok
(
NÚe
) => {

91 
Ët
 
mut
 
»¥
 = 
Re¥Ú£
::
Ãw
();

92 
Ët
 
mut
 
	g£l_»¥
 = 
S–eùRe¥Ú£
::
Ãw
();

93 
	g£l_»¥
.
£t_chunks
(
R•—‹dF›ld
::
äom_vec
(
chunks
));

94 
Ët
 
	gd©a
 = 
box_Œy
!(
£l_»¥
.
wr™e_to_by‹s
());

95 
	g»¥
.
£t_d©a
(
d©a
);

96  
Ok
(
»¥
);

98 
E¼
(
e
è=> 
Ët
 
E¼Ü
::
Oth”
(
_
) =ƒ {

99 
Ët
 
mut
 
»¥
 = 
Re¥Ú£
::
Ãw
();

100 
Ët
 
mut
 
	g£l_»¥
 = 
S–eùRe¥Ú£
::
Ãw
();

101 
	g£l_»¥
.
£t_”rÜ
(
to_pb_”rÜ
(&
e
));

102 
	g»¥
.
£t_d©a
(
box_Œy
!(
£l_»¥
.
wr™e_to_by‹s
()));

103 
	g»¥
.
£t_Ùh”_”rÜ
(
fÜm©
!("{}", 
e
));

104  
Ok
(
»¥
);

106  
E¼
(
e
);

112 
pub
 
â
 
cŞËù_¡©i¡ics_što
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
Sti¡ics
) {

113 
£lf
.
exec
.
cŞËù_¡©i¡ics_što
(
¡©i¡ics
);

117 #[
šlše
]

118 
â
 
šæ©e_cŞs
(
row
: &
Row
, 
cŞs
: &[
CŞumnInfo
], 
ouut_off£ts
: &[
u32
]è-> 
ResuÉ
<
Vec
<
u8
>> {

119 
Ët
 
d©a
 = &
row
.data;

121 
Ët
 
mut
 
	gv®ues
 = 
Vec
::
w™h_ÿ·c™y
(
d©a
.
v®ue
.
Ën
());

122 
off£t
 
š
 
	gouut_off£ts
 {

123 
Ët
 
	gcŞ
 = &
cŞs
[*
off£t
 
as
 
usize
];

124 
Ët
 
	gcŞ_id
 = 
cŞ
.
g‘_cŞumn_id
();

125 
m©ch
 
	gd©a
.
g‘
(
cŞ_id
) {

126 
Some
(
v®ue
è=> 
v®ues
.
ex‹nd_äom_¦iû
(value),

127 
NÚe
 
	gcŞ
.
g‘_pk_hªdË
() => {

128 
Ët
 
pk
 = 
g‘_pk
(
cŞ
, 
row
.
hªdË
);

129 
	gbox_Œy
!(
	gv®ues
.
’code
(&[
pk
], 
çl£
));

131 
NÚe
 
	gcŞ
.
has_deçuÉ_v®
() => {

132 
v®ues
.
ex‹nd_äom_¦iû
(
cŞ
.
g‘_deçuÉ_v®
());

134 
NÚe
 
	gmysql
::
has_nÙ_nuÎ_æag
(
cŞ
.
g‘_æag
(è
as
 
u64
) => {

135  
E¼
(
box_”r
!("cŞumÀ{} oà{} i missšg", 
cŞ_id
, 
row
.
hªdË
));

137 
	gNÚe
 => {

138 
box_Œy
!(
v®ues
.
’code
(&[
D©um
::
NuÎ
], 
çl£
));

142 
Ok
(
v®ues
)

	@src/coprocessor/dag/executor/aggregation.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

17 
u£
 
	gtb
::
executÜ
::
Agg»g©iÚ
;

18 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gEx´Ty³
};

20 
u£
 
	gut
::
cŞËùiÚs
::{
Ord”M­
, 
	gOrd”M­EÁry
};

21 
u£
 
	gcİroûssÜ
::
codec
::
bË
::
RowCŞsDiù
;

22 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::{
£lf
, 
	g­´oxim©e_size
, 
	gD©um
, 
	gD©umEncod”
};

23 
u£
 
	gcİroûssÜ
::
’dpošt
::
SINGLE_GROUP
;

24 
u£
 
	gcİroûssÜ
::
£Ëù
::
agg»g©e
::{
£lf
, 
	gAggrFunc
};

25 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

26 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
Ex´essiÚ
;

27 
u£
 
	gcİroûssÜ
::
m‘rics
::*;

28 
u£
 
	gcİroûssÜ
::
ResuÉ
;

29 
u£
 
	g¡Üage
::
Sti¡ics
;

31 
u£
 
	gsu³r
::{
šæ©e_w™h_cŞ_fÜ_dag
, 
	gExecutÜ
, 
	gEx´CŞumnRefVis™Ü
, 
	gRow
};

33 
	sAggrFuncEx´
 {

34 
	m¬gs
: 
Vec
<
Ex´essiÚ
>,

35 
	m
: 
Ex´Ty³
,

38 
im¶
 
	gAggrFuncEx´
 {

39 
â
 
b©ch_bud
(
ùx
: &
Ev®CÚ‹xt
, 
ex´
: 
Vec
<
Ex´
>è-> 
ResuÉ
<Vec<
AggrFuncEx´
>> {

40 
ex´
.
što_™”
()

41 .
m­
(|
v
| 
AggrFuncEx´
::
bud
(
ùx
, v))

42 .
cŞËù
()

45 
â
 
bud
(
ùx
: &
Ev®CÚ‹xt
, 
mut
 
ex´
: 
Ex´
è-> 
ResuÉ
<
AggrFuncEx´
> {

46 
Ët
 
¬gs
 = 
box_Œy
!(
Ex´essiÚ
::
b©ch_bud
(

47 
ùx
,

48 
ex´
.
ke_chd»n
().
što_vec
()

50 
Ët
 
	g
 = 
ex´
.
g‘_
();

51 
Ok
(
AggrFuncEx´
 { 
¬gs
:‡rgs, 

:p })

54 
â
 
ev®_¬gs
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
Vec
<Datum>> {

55 
Ët
 
»s
: 
Vec
<
D©um
> = 
box_Œy
!(
£lf
.
¬gs
.
™”
().
m­
(|
v
| v.
ev®
(
ùx
, 
row
)).
cŞËù
());

56 
Ok
(
»s
)

60 
im¶
 
	gAggrFunc
 {

61 
â
 
upd©e_w™h_ex´
(

62 &
mut
 
£lf
,

63 
ùx
: &
Ev®CÚ‹xt
,

64 
ex´
: &
AggrFuncEx´
,

65 
row
: &[
D©um
],

66 è-> 
	gResuÉ
<()> {

67 
Ët
 
	gv®s
 = 
ex´
.
ev®_¬gs
(
ùx
, 
row
)?;

68 
	g£lf
.
upd©e
(
ùx
, 
v®s
)?;

69 
Ok
(())

73 
pub
 
	sAgg»g©iÚExecutÜ
 {

74 
	mgroup_by
: 
Vec
<
Ex´essiÚ
>,

75 
	maggr_func
: 
Vec
<
AggrFuncEx´
>,

76 
	mgroup_key_aggrs
: 
Ord”M­
<
Vec
<
u8
>, 
	mVec
<
	mBox
<
	mAggrFunc
>>>,

77 
	mcursÜ
: 
usize
,

78 
	mexecu‹d
: 
boŞ
,

79 
	mùx
: 
Arc
<
Ev®CÚ‹xt
>,

80 
	mcŞs
: 
Arc
<
Vec
<
CŞumnInfo
>>,

81 
	m»Ï‹d_cŞs_off£t
: 
Vec
<
usize
>,

82 
	m¤c
: 
Box
<
ExecutÜ
>,

85 
im¶
 
	gAgg»g©iÚExecutÜ
 {

86 
pub
 
â
 
Ãw
(

87 
mut
 
m‘a
: 
Agg»g©iÚ
,

88 
ùx
: 
Arc
<
Ev®CÚ‹xt
>,

89 
cŞumns
: 
Arc
<
Vec
<
CŞumnInfo
>>,

90 
¤c
: 
Box
<
ExecutÜ
>,

91 è-> 
	gResuÉ
<
	gAgg»g©iÚExecutÜ
> {

93 
Ët
 
mut
 
	gvis™Ü
 = 
Ex´CŞumnRefVis™Ü
::
Ãw
(
cŞumns
.
Ën
());

94 
Ët
 
	ggroup_by
 = 
m‘a
.
ke_group_by
().
što_vec
();

95 
	gvis™Ü
.
b©ch_vis™
(&
group_by
)?;

96 
Ët
 
	gaggr_func
 = 
m‘a
.
ke_agg_func
().
što_vec
();

97 
	gvis™Ü
.
b©ch_vis™
(&
aggr_func
)?;

98 
	gCOPR_EXECUTOR_COUNT


99 .
w™h_Ïb–_v®ues
(&["aggregation"])

100 .
šc
();

101 
Ok
(
Agg»g©iÚExecutÜ
 {

102 
group_by
: 
box_Œy
!(
Ex´essiÚ
::
b©ch_bud
(&
ùx
, group_by)),

103 
aggr_func
: 
AggrFuncEx´
::
b©ch_bud
(&
ùx
,‡ggr_func)?,

104 
group_key_aggrs
: 
Ord”M­
::
Ãw
(),

105 
cursÜ
: 0,

106 
execu‹d
: 
çl£
,

107 
ùx
: ctx,

108 
cŞs
: 
cŞumns
,

109 
»Ï‹d_cŞs_off£t
: 
vis™Ü
.
cŞumn_off£ts
(),

110 
¤c
: src,

114 
â
 
g‘_group_key
(&
£lf
, 
row
: &[
D©um
]è-> 
ResuÉ
<
Vec
<
u8
>> {

115 
£lf
.
group_by
.
is_em±y
() {

116 
Ët
 
sšgË_group
 = 
D©um
::
By‹s
(
SINGLE_GROUP
.
to_vec
());

117  
Ok
(
box_Œy
!(
d©um
::
’code_v®ue
(&[
sšgË_group
])));

119 
Ët
 
mut
 
	gv®s
 = 
Vec
::
w™h_ÿ·c™y
(
£lf
.
group_by
.
Ën
());

120 
ex´
 
	gš
 &
	g£lf
.
	ggroup_by
 {

121 
Ët
 
	gv
 = 
box_Œy
!(
ex´
.
ev®
(&
£lf
.
ùx
, 
row
));

122 
	gv®s
.
push
(
v
);

124 
Ët
 
	g»s
 = 
box_Œy
!(
d©um
::
’code_v®ue
(&
v®s
));

125 
Ok
(
»s
)

128 
â
 
agg»g©e
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

129 
Ët
 
Some
(
row
èğ
£lf
.
¤c
.
Ãxt
()? {

130 
Ët
 
cŞs
 = 
šæ©e_w™h_cŞ_fÜ_dag
(

131 &
£lf
.
ùx
,

132 &
row
.
d©a
,

133 &
£lf
.
cŞs
,

134 &
£lf
.
»Ï‹d_cŞs_off£t
,

135 
row
.
hªdË
,

137 
Ët
 
	ggroup_key
 = 
£lf
.
g‘_group_key
(&
cŞs
)?;

138 
m©ch
 
	g£lf
.
	ggroup_key_aggrs
.
’Œy
(
group_key
) {

139 
	gOrd”M­EÁry
::
VaÿÁ
(
e
) => {

140 
Ët
 
mut
 
aggrs
 = 
Vec
::
w™h_ÿ·c™y
(
£lf
.
aggr_func
.
Ën
());

141 
ex´
 
	gš
 &
	g£lf
.
	gaggr_func
 {

142 
Ët
 
mut
 
	gaggr
 = 
agg»g©e
::
bud_aggr_func
(
ex´
.

)?;

143 
	gaggr
.
upd©e_w™h_ex´
(&
£lf
.
ùx
, 
ex´
, &
cŞs
)?;

144 
	gaggrs
.
push
(
aggr
);

146 
	ge
.
š£¹
(
aggrs
);

148 
	gOrd”M­EÁry
::
Occup›d
(
e
) => {

149 
Ët
 
aggrs
 = 
e
.
što_mut
();

150 
	gex´
, 
	gaggr
è
š
 
	g£lf
.
	gaggr_func
.
™”
().
z
(
aggrs
) {

151 
	gaggr
.
upd©e_w™h_ex´
(&
£lf
.
ùx
, 
ex´
, &
cŞs
)?;

156 
Ok
(())

160 
im¶
 
ExecutÜ
 
	gAgg»g©iÚExecutÜ
 {

161 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gRow
>> {

162 !
	g£lf
.
	gexecu‹d
 {

163 
	g£lf
.
agg»g©e
()?;

164 
	g£lf
.
	gexecu‹d
 = 
Œue
;

167 
m©ch
 
	g£lf
.
	ggroup_key_aggrs
.
g‘_šdex_mut
(
£lf
.
cursÜ
) {

168 
Some
((
group_key
, 
aggrs
)) => {

169 
£lf
.
cursÜ
 += 1;

170 
Ët
 
mut
 
	gaggr_cŞs
 = 
Vec
::
w™h_ÿ·c™y
(2 * 
£lf
.
aggr_func
.
Ën
());

173 
aggr
 
š
 
	gaggrs
 {

174 
	gaggr
.
ÿlc
(&
mut
 
aggr_cŞs
)?;

178 
Ët
 
	gv®ue_size
 = 
group_key
.
Ën
(è+ 
­´oxim©e_size
(&
aggr_cŞs
, 
çl£
);

179 
Ët
 
mut
 
	gv®ue
 = 
Vec
::
w™h_ÿ·c™y
(
v®ue_size
);

180 
	gbox_Œy
!(
	gv®ue
.
’code
(
aggr_cŞs
.
as_¦iû
(), 
çl£
));

181 !
	g£lf
.
	ggroup_by
.
is_em±y
() {

182 
	gv®ue
.
ex‹nd_äom_¦iû
(
group_key
);

184 
Ok
(
Some
(
Row
 {

185 
hªdË
: 0,

186 
d©a
: 
RowCŞsDiù
::
Ãw
(
m­
![], 
v®ue
),

189 
	gNÚe
 => 
Ok
(
NÚe
),

193 
â
 
cŞËù_¡©i¡ics_što
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
Sti¡ics
) {

194 
£lf
.
¤c
.
cŞËù_¡©i¡ics_što
(
¡©i¡ics
);

198 #[
cfg
(
‹¡
)]

199 
mod
 
	g‹¡
 {

200 
u£
 
	g¡d
::
i64
;

202 
u£
 
	gkv´Ùo
::
kv½ıb
::
IsŞ©iÚLev–
;

203 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

204 
u£
 
	gtb
::
executÜ
::
TabËSÿn
;

205 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gEx´Ty³
};

207 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::{
D©um
, 
	gD©umDecod”
};

208 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
decim®
::
Decim®
;

209 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
ty³s
;

210 
u£
 
	g¡Üage
::
SÇpshÙStÜe
;

211 
u£
 
	gut
::
codec
::
numb”
::
Numb”Encod”
;

213 
u£
 
	gsu³r
::*;

214 
u£
 
	gsu³r
::
su³r
::
bË_sÿn
::
TabËSÿnExecutÜ
;

215 
u£
 
	gsu³r
::
su³r
::
sÿÂ”
::
‹¡
::{
g‘_¿nge
, 
	gÃw_cŞ_šfo
, 
	gTe¡StÜe
};

216 
u£
 
	gsu³r
::
su³r
::
tİn
::
‹¡
::
g’_bË_d©a
;

218 #[
šlše
]

219 
â
 
bud_ex´
(

: 
Ex´Ty³
, 
id
: 
O±iÚ
<
i64
>, 
chd
: O±iÚ<
Ex´
>) -> Expr {

220 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

221 
	gex´
.
£t_
(

);

222 
	g
 =ğ
Ex´Ty³
::
CŞumnRef
 {

223 
ex´
.
mut_v®
().
’code_i64
(
id
.
unw¿p
()).unwrap();

225 
	gex´
.
mut_chd»n
().
push
(
chd
.
unw¿p
());

227 
	gex´


230 
â
 
bud_group_by
(
cŞ_ids
: &[
i64
]è-> 
Vec
<
Ex´
> {

231 
Ët
 
mut
 
group_by
 = 
Vec
::
w™h_ÿ·c™y
(
cŞ_ids
.
Ën
());

232 
id
 
š
 
	gcŞ_ids
 {

233 
	ggroup_by
.
push
(
bud_ex´
(
Ex´Ty³
::
CŞumnRef
, 
Some
(*
id
), 
NÚe
));

235 
	ggroup_by


238 
â
 
bud_aggr_func
(
aggrs
: &[(
Ex´Ty³
, 
i64
)]è-> 
	gVec
<
	gEx´
> {

239 
Ët
 
mut
 
	gaggr_func
 = 
Vec
::
w™h_ÿ·c™y
(
aggrs
.
Ën
());

240 
aggr
 
š
 
	gaggrs
 {

241 
	gËt
 &(
	g
, 
	gid
èğ
aggr
;

242 
Ët
 
	gcŞ_»f
 = 
bud_ex´
(
Ex´Ty³
::
CŞumnRef
, 
Some
(
id
), 
NÚe
);

243 
	gaggr_func
.
push
(
bud_ex´
(

, 
NÚe
, 
Some
(
cŞ_»f
)));

245 
	gaggr_func


248 #[
‹¡
]

249 
â
 
‹¡_agg»g©iÚ
() {

251 
Ët
 
	gtid
 = 1;

252 
Ët
 
	gcis
 = 
vec
![

253 
Ãw_cŞ_šfo
(1, 
ty³s
::
LONG_LONG
),

254 
Ãw_cŞ_šfo
(2, 
ty³s
::
VARCHAR
),

255 
Ãw_cŞ_šfo
(3, 
ty³s
::
NEW_DECIMAL
),

257 
Ët
 
	g¿w_d©a
 = 
vec
![

258 
vec
![

259 
D©um
::
I64
(1),

260 
D©um
::
By‹s
(
b
"a".
to_vec
()),

261 
D©um
::
Dec
(7.
što
()),

263 
	gvec
![

264 
D©um
::
I64
(2),

265 
D©um
::
By‹s
(
b
"a".
to_vec
()),

266 
D©um
::
Dec
(7.
što
()),

268 
	gvec
![

269 
D©um
::
I64
(3),

270 
D©um
::
By‹s
(
b
"b".
to_vec
()),

271 
D©um
::
Dec
(8.
što
()),

273 
	gvec
![

274 
D©um
::
I64
(4),

275 
D©um
::
By‹s
(
b
"a".
to_vec
()),

276 
D©um
::
Dec
(7.
što
()),

278 
	gvec
![

279 
D©um
::
I64
(5),

280 
D©um
::
By‹s
(
b
"f".
to_vec
()),

281 
D©um
::
Dec
(5.
što
()),

283 
	gvec
![

284 
D©um
::
I64
(6),

285 
D©um
::
By‹s
(
b
"b".
to_vec
()),

286 
D©um
::
Dec
(8.
što
()),

288 
	gvec
![

289 
D©um
::
I64
(7),

290 
D©um
::
By‹s
(
b
"f".
to_vec
()),

291 
D©um
::
Dec
(6.
što
()),

294 
Ët
 
	gbË_d©a
 = 
g’_bË_d©a
(
tid
, &
cis
, &
¿w_d©a
);

295 
Ët
 
mut
 
	g‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
bË_d©a
);

297 
Ët
 
mut
 
	gbË_sÿn
 = 
TabËSÿn
::
Ãw
();

298 
	gbË_sÿn
.
£t_bË_id
(
tid
);

299 
	gbË_sÿn
.
£t_cŞumns
(
R•—‹dF›ld
::
äom_vec
(
cis
.
şÚe
()));

301 
Ët
 
	gkey_¿nges
 = 
vec
![
g‘_¿nge
(
tid
, 
i64
::
MIN
, i64::
MAX
)];

302 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
‹¡_¡Üe
.
g‘_¢­shÙ
();

303 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

304 
Ët
 
	gts_eù
 = 
TabËSÿnExecutÜ
::
Ãw
(&
bË_sÿn
, 
key_¿nges
, 
¡Üe
);

307 
Ët
 
mut
 
	gagg»g©iÚ
 = 
Agg»g©iÚ
::();

308 
Ët
 
	ggroup_by_cŞs
 = 
vec
![1, 2];

309 
Ët
 
	ggroup_by
 = 
bud_group_by
(&
group_by_cŞs
);

310 
	gagg»g©iÚ
.
£t_group_by
(
R•—‹dF›ld
::
äom_vec
(
group_by
));

311 
Ët
 
	gaggr_funcs
 = 
vec
![(
Ex´Ty³
::
Avg
, 0), (Ex´Ty³::
CouÁ
, 2)];

312 
Ët
 
	gaggr_funcs
 = 
bud_aggr_func
(&
aggr_funcs
);

313 
	gagg»g©iÚ
.
£t_agg_func
(
R•—‹dF›ld
::
äom_vec
(
aggr_funcs
));

315 
Ët
 
mut
 
	gaggr_eù
 = 
Agg»g©iÚExecutÜ
::
Ãw
(

316 
agg»g©iÚ
,

317 
Arc
::
Ãw
(
Ev®CÚ‹xt
::()),

318 
Arc
::
Ãw
(
cis
),

319 
Box
::
Ãw
(
ts_eù
),

320 ).
unw¿p
();

321 
Ët
 
	gex³ù_row_út
 = 4;

322 
Ët
 
mut
 
	grow_d©a
 = 
Vec
::
w™h_ÿ·c™y
(
ex³ù_row_út
);

323 
Ët
 
Some
(
row
èğ
aggr_eù
.
Ãxt
().
unw¿p
() {

324 
row_d©a
.
push
(
row
.
d©a
);

326 
	gas£¹_eq
!(
	grow_d©a
.
Ën
(), 
	gex³ù_row_út
);

327 
Ët
 
	gex³ù_row_d©a
 = 
vec
![

329 3 
as
 
u64
,

330 
Decim®
::
äom
(7),

331 3 
as
 
u64
,

332 
b
"a".
as_»f
(),

333 
Decim®
::
äom
(7),

336 2 
as
 
u64
,

337 
Decim®
::
äom
(9),

338 2 
as
 
u64
,

339 
b
"b".
as_»f
(),

340 
Decim®
::
äom
(8),

343 1 
as
 
u64
,

344 
Decim®
::
äom
(5),

345 1 
as
 
u64
,

346 
b
"f".
as_»f
(),

347 
Decim®
::
äom
(5),

350 1 
as
 
u64
,

351 
Decim®
::
äom
(7),

352 1 
as
 
u64
,

353 
b
"f".
as_»f
(),

354 
Decim®
::
äom
(6),

357 
Ët
 
	gex³ù_cŞ_út
 = 5;

358 
	grow
, 
	gex³ù_cŞs
è
š
 
	grow_d©a
.
što_™”
().
z
(
ex³ù_row_d©a
) {

359 
Ët
 
	gds
 = 
row
.
v®ue
.
as_¦iû
().
decode
().
unw¿p
();

360 
	gas£¹_eq
!(
	gds
.
Ën
(), 
	gex³ù_cŞ_út
);

361 
	gas£¹_eq
!(
	gds
[0], 
	gD©um
::
äom
(
ex³ù_cŞs
.0));

362 
	gas£¹_eq
!(
	gds
[1], 
	gD©um
::
äom
(
ex³ù_cŞs
.1));

363 
	gas£¹_eq
!(
	gds
[2], 
	gD©um
::
äom
(
ex³ù_cŞs
.2));

364 
	gas£¹_eq
!(
	gds
[3], 
	gD©um
::
äom
(
ex³ù_cŞs
.3));

365 
	gas£¹_eq
!(
	gds
[4], 
	gD©um
::
äom
(
ex³ù_cŞs
.4));

	@src/coprocessor/dag/executor/index_scan.rs

14 
u£
 
	g¡d
::
vec
::
IÁoI‹r
;

15 
u£
 
	gby‹Üd”
::{
BigEndŸn
, 
	gR—dBy‹sExt
};

17 
u£
 
	gkv´Ùo
::
cİroûssÜ
::
KeyRªge
;

18 
u£
 
	gtb
::
executÜ
::
IndexSÿn
;

19 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

21 
u£
 
	gcİroûssÜ
::
codec
::{
d©um
, 
	gmysql
, 
	gbË
};

22 
u£
 
	gcİroûssÜ
::
m‘rics
::*;

23 
u£
 
	gcİroûssÜ
::{
E¼Ü
, 
	gResuÉ
};

24 
u£
 
	g¡Üage
::{
SÇpshÙStÜe
, 
	gSti¡ics
};

26 
u£
 
	gsu³r
::{
ExecutÜ
, 
	gRow
};

27 
u£
 
	gsu³r
::
sÿÂ”
::{
SÿnOn
, 
	gSÿÂ”
};

30 
pub
 
	sIndexSÿnExecutÜ
 {

31 
	m¡Üe
: 
SÇpshÙStÜe
,

32 
	mdesc
: 
boŞ
,

33 
	mcŞ_ids
: 
Vec
<
i64
>,

34 
	mpk_cŞ
: 
O±iÚ
<
CŞumnInfo
>,

35 
	mkey_¿nges
: 
IÁoI‹r
<
KeyRªge
>,

36 
	msÿÂ”
: 
O±iÚ
<
SÿÂ”
>,

39 
im¶
 
	gIndexSÿnExecutÜ
 {

40 
pub
 
â
 
Ãw
(

41 
mut
 
m‘a
: 
IndexSÿn
,

42 
mut
 
key_¿nges
: 
Vec
<
KeyRªge
>,

43 
¡Üe
: 
SÇpshÙStÜe
,

44 è-> 
	gIndexSÿnExecutÜ
 {

45 
Ët
 
mut
 
	gpk_cŞ
 = 
NÚe
;

46 
Ët
 
	gdesc
 = 
m‘a
.
g‘_desc
();

47 
	gdesc
 {

48 
	gkey_¿nges
.
»v”£
();

50 
Ët
 
	gcŞs
 = 
m‘a
.
mut_cŞumns
();

51 
	gcŞs
.
Ï¡
().
m­_Ü
(
çl£
, |
c
| c.
g‘_pk_hªdË
()) {

52 
	gpk_cŞ
 = 
Some
(
cŞs
.
pİ
().
unw¿p
());

54 
Ët
 
	gcŞ_ids
 = 
cŞs
.
™”
().
m­
(|
c
| c.
g‘_cŞumn_id
()).
cŞËù
();

56 
	gCOPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["idxsÿn"]).
šc
();

57 
	gIndexSÿnExecutÜ
 {

58 
	g¡Üe
: 
¡Üe
,

59 
	gdesc
: 
desc
,

60 
	gcŞ_ids
: 
cŞ_ids
,

61 
	gpk_cŞ
: 
pk_cŞ
,

62 
	gkey_¿nges
: 
key_¿nges
.
što_™”
(),

63 
	gsÿÂ”
: 
NÚe
,

67 
pub
 
â
 
Ãw_w™h_cŞs_Ën
(

68 
cŞs
: 
i64
,

69 
key_¿nges
: 
Vec
<
KeyRªge
>,

70 
¡Üe
: 
SÇpshÙStÜe
,

71 è-> 
	gIndexSÿnExecutÜ
 {

72 
Ët
 
	gcŞ_ids
: 
Vec
<
i64
> = (0..c
Şs
).
cŞËù
();

73 
	gCOPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["idxsÿn"]).
šc
();

74 
	gIndexSÿnExecutÜ
 {

75 
	g¡Üe
: 
¡Üe
,

76 
	gdesc
: 
çl£
,

77 
	gcŞ_ids
: 
cŞ_ids
,

78 
	gpk_cŞ
: 
NÚe
,

79 
	gkey_¿nges
: 
key_¿nges
.
što_™”
(),

80 
	gsÿÂ”
: 
NÚe
,

84 
â
 
g‘_row_äom_¿nge_sÿÂ”
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gRow
>> {

85 
	g£lf
.
	gsÿÂ”
.
is_nÚe
() {

86  
Ok
(
NÚe
);

88 
	gCOPR_GET_OR_SCAN_COUNT
.
w™h_Ïb–_v®ues
(&["¿nge"]).
šc
();

90 
Ët
 
	gsÿÂ”
 = 
£lf
.
sÿÂ”
.
as_mut
().
unw¿p
();

91 
Ët
 (
key
, 
v®ue
èğ
m©ch
 
sÿÂ”
.
Ãxt_row
()? {

92 
Some
((
key
, 
v®ue
)è=> (key, 
	gv®ue
),

93 
	gNÚe
 =>  
Ok
(
NÚe
),

96 
Ët
 (
mut
 
v®ues
, 
hªdË
èğ
box_Œy
!(
bË
::
cut_idx_key
(
key
, &
£lf
.
cŞ_ids
));

97 
Ët
 
	ghªdË
 = 
m©ch
 
hªdË
 {

98 
NÚe
 => 
box_Œy
!(
v®ue
.
as_¦iû
().
»ad_i64
::<
BigEndŸn
>()),

99 
Some
(
h
) => h,

102 
Ët
 
Some
(
»f
 
pk_cŞ
èğ
£lf
.pk_col {

103 
Ët
 
hªdË_d©um
 = 
mysql
::
has_unsigÃd_æag
(
pk_cŞ
.
g‘_æag
(è
as
 
u64
) {

105 
d©um
::
D©um
::
U64
(
hªdË
 
as
 
u64
)

107 
d©um
::
D©um
::
I64
(
hªdË
)

109 
Ët
 
mut
 
	gby‹s
 = 
box_Œy
!(
d©um
::
’code_key
(&[
hªdË_d©um
]));

110 
	gv®ues
.
­³nd
(
pk_cŞ
.
g‘_cŞumn_id
(), &
mut
 
by‹s
);

112 
Ok
(
Some
(
Row
::
Ãw
(
hªdË
, 
v®ues
)))

115 
â
 
Ãw_sÿÂ”
(&
£lf
, 
¿nge
: 
KeyRªge
è-> 
ResuÉ
<
SÿÂ”
> {

116 
SÿÂ”
::
Ãw
(&
£lf
.
¡Üe
, 
SÿnOn
::
Index
, s–f.
desc
, 
çl£
, 
¿nge
).
m­_”r
(
E¼Ü
::
äom
)

120 
im¶
 
ExecutÜ
 
IndexSÿnExecutÜ
 {

121 
â
 
Ãxt
(&
mut
 
£lf
è-> 
ResuÉ
<
O±iÚ
<
Row
>> {

122 
loİ
 {

123 
Ët
 
Some
(
row
èğ
£lf
.
g‘_row_äom_¿nge_sÿÂ”
()? {

124  
Ok
(
Some
(
row
));

126 
Ët
 
Some
(
¿nge
èğ
£lf
.
key_¿nges
.
Ãxt
() {

127 
£lf
.
sÿÂ”
 = 
m©ch
 s–f.sÿÂ”.
ke
() {

128 
Some
(
mut
 
sÿÂ”
) => {

129 
box_Œy
!(
sÿÂ”
.
»£t_¿nge
(
¿nge
, &
£lf
.
¡Üe
));

130 
Some
(
sÿÂ”
)

132 
	gNÚe
 => 
Some
(
£lf
.
Ãw_sÿÂ”
(
¿nge
)?),

136  
Ok
(
NÚe
);

140 
â
 
cŞËù_¡©i¡ics_što
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
Sti¡ics
) {

141 
Ët
 
Some
(
sÿÂ”
èğ
£lf
.sÿÂ”.
ke
() {

142 
sÿÂ”
.
cŞËù_¡©i¡ics_što
(
¡©i¡ics
);

147 #[
cfg
(
‹¡
)]

148 
mod
 
	g‹¡
 {

149 
u£
 
	g¡d
::
i64
;

150 
u£
 
	gby‹Üd”
::{
BigEndŸn
, 
	gWr™eBy‹sExt
};

152 
u£
 
	gkv´Ùo
::
kv½ıb
::
IsŞ©iÚLev–
;

153 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

154 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

156 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
ty³s
;

157 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::{
£lf
, 
	gD©um
};

158 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

159 
u£
 
	g¡Üage
::
SÇpshÙStÜe
;

161 
u£
 
	gsu³r
::*;

162 
u£
 
	gsu³r
::
su³r
::
sÿÂ”
::
‹¡
::{
Ãw_cŞ_šfo
, 
	gD©a
, 
	gTe¡StÜe
};

164 cÚ¡ 
	gTABLE_ID
: 
i64
 = 1;

165 cÚ¡ 
	gINDEX_ID
: 
i64
 = 1;

166 cÚ¡ 
	gKEY_NUMBER
: 
usize
 = 10;

169 
pub
 
â
 
g‘_idx_¿nge
(
bË_id
: 
i64
, 
idx_id
: i64, 
¡¬t
: i64, 
’d
: i64è-> 
KeyRªge
 {

170 
Ët
 (
_
, 
¡¬t_key
èğ
g’”©e_šdex_d©a
(
bË_id
, 
idx_id
, 
¡¬t
);

171 
Ët
 (
_
, 
’d_key
èğ
g’”©e_šdex_d©a
(
bË_id
, 
idx_id
, 
’d
);

172 
Ët
 
mut
 
	gkey_¿nge
 = 
KeyRªge
::
Ãw
();

173 
	gkey_¿nge
.
£t_¡¬t
(
¡¬t_key
);

174 
	gkey_¿nge
.
£t_’d
(
’d_key
);

175 
	gkey_¿nge


178 
pub
 
â
 
g’”©e_šdex_d©a
(

179 
bË_id
: 
i64
,

180 
šdex_id
: 
i64
,

181 
hªdË
: 
i64
,

182 è-> (
	gHashM­
<
	gi64
, 
	gVec
<
	gu8
>>, Vec<u8>) {

183 
Ët
 
	gšdiû
 = 
vec
![

184 (2, 
D©um
::
By‹s
(
b
"abc".
to_vec
())),

185 (3, 
D©um
::
Dec
(
hªdË
.
što
())),

187 
Ët
 
mut
 
	gex³ù_row
 = 
HashM­
::();

188 
Ët
 
	gv
: 
Vec
<
_
> = 
šdiû


189 .
™”
()

190 .
m­
(|&(
»f
 
cid
,„eà
v®ue
)| {

191 
ex³ù_row
.
š£¹
(*
cid
, 
d©um
::
’code_key
(&[
v®ue
.
şÚe
()]).
unw¿p
());

192 
v®ue
.
şÚe
()

194 .
cŞËù
();

195 
Ët
 
	g’coded
 = 
d©um
::
’code_key
(&
v
).
unw¿p
();

196 
Ët
 
	gidx_key
 = 
bË
::
’code_šdex_£ek_key
(
bË_id
, 
šdex_id
, &
’coded
);

197 (
	gex³ù_row
, 
	gidx_key
)

200 
pub
 
â
 
´•¬e_šdex_d©a
(
key_numb”
: 
usize
, 
bË_id
: 
i64
, 
šdex_id
: i64è-> 
D©a
 {

201 
Ët
 
cŞs
 = 
vec
![

202 
Ãw_cŞ_šfo
(1, 
ty³s
::
LONG_LONG
),

203 
Ãw_cŞ_šfo
(2, 
ty³s
::
VARCHAR
),

204 
Ãw_cŞ_šfo
(3, 
ty³s
::
NEW_DECIMAL
),

207 
Ët
 
mut
 
	gkv_d©a
 = 
Vec
::
Ãw
();

208 
Ët
 
mut
 
	gex³ù_rows
 = 
Vec
::
Ãw
();

210 
hªdË
 
	gš
 0..
	gkey_numb”
 {

211 
Ët
 (
ex³ù_row
, 
idx_key
èğ
g’”©e_šdex_d©a
(
bË_id
, 
šdex_id
, 
hªdË
 
as
 
i64
);

212 
	gex³ù_rows
.
push
(
ex³ù_row
);

213 
Ët
 
mut
 
	gv®ue
 = 
Vec
::
w™h_ÿ·c™y
(8);

214 
	gv®ue
.
	gwr™e_i64
::<
BigEndŸn
>(
hªdË
 
as
 
i64
).
unw¿p
();

215 
	gkv_d©a
.
push
((
idx_key
, 
v®ue
));

217 
	gD©a
 {

218 
	gkv_d©a
: 
kv_d©a
,

219 
	gex³ù_rows
: 
ex³ù_rows
,

220 
	gcŞs
: 
cŞs
,

224 
	sIndexTe¡W¿µ”
 {

225 
	gd©a
: 
D©a
,

226 
	g¡Üe
: 
Te¡StÜe
,

227 
	gsÿn
: 
IndexSÿn
,

228 
	g¿nges
: 
Vec
<
KeyRªge
>,

229 
	gcŞs
: 
Vec
<
CŞumnInfo
>,

232 
im¶
 
	gIndexTe¡W¿µ”
 {

233 
â
 
šşude_pk_cŞs
(è-> 
	gIndexTe¡W¿µ”
 {

234 
Ët
 
mut
 
	gw¿µ”
 = 
IndexTe¡W¿µ”
::();

235 
Ët
 
mut
 
	gcŞs
 = 
w¿µ”
.
d©a
.
g‘_šdex_cŞs
();

236 
	gcŞs
.
push
(
w¿µ”
.
d©a
.
g‘_cŞ_pk
());

237 
	gw¿µ”


238 .
	gsÿn


239 .
£t_cŞumns
(
R•—‹dF›ld
::
äom_vec
(
cŞs
.
şÚe
()));

240 
	gw¿µ”
.
	gcŞs
 = 
cŞs
;

241 
	gw¿µ”


245 
im¶
 
DeçuÉ
 
	gIndexTe¡W¿µ”
 {

246 
â
 (è-> 
	gIndexTe¡W¿µ”
 {

247 
Ët
 
	g‹¡_d©a
 = 
´•¬e_šdex_d©a
(
KEY_NUMBER
, 
TABLE_ID
, 
INDEX_ID
);

248 
Ët
 
	g‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
‹¡_d©a
.
kv_d©a
);

249 
Ët
 
mut
 
	gsÿn
 = 
IndexSÿn
::
Ãw
();

251 
Ët
 
	gcŞs
 = 
‹¡_d©a
.
g‘_šdex_cŞs
();

252 
Ët
 
	gcŞ_»q
 = 
R•—‹dF›ld
::
äom_vec
(
cŞs
.
şÚe
());

253 
	gsÿn
.
£t_cŞumns
(
cŞ_»q
);

255 
Ët
 
	g¿nge
 = 
g‘_idx_¿nge
(
TABLE_ID
, 
INDEX_ID
, 0, 
i64
::
MAX
);

256 
Ët
 
	gkey_¿nges
 = 
vec
![
¿nge
];

257 
	gIndexTe¡W¿µ”
 {

258 
	gd©a
: 
‹¡_d©a
,

259 
	g¡Üe
: 
‹¡_¡Üe
,

260 
	gsÿn
: 
sÿn
,

261 
	g¿nges
: 
key_¿nges
,

262 
	gcŞs
: 
cŞs
,

267 #[
‹¡
]

268 
â
 
‹¡_muÉË_¿nges
() {

269 
Ët
 
mut
 
	gw¿µ”
 = 
IndexTe¡W¿µ”
::();

270 
Ët
 
	gr1
 = 
g‘_idx_¿nge
(
TABLE_ID
, 
INDEX_ID
, 0, (
KEY_NUMBER
 / 3è
as
 
i64
);

271 
Ët
 
	gr2
 = 
g‘_idx_¿nge
(

272 
TABLE_ID
,

273 
INDEX_ID
,

274 (
KEY_NUMBER
 / 3è
as
 
i64
,

275 (
KEY_NUMBER
 / 2è
as
 
i64
,

277 
	gw¿µ”
.
	g¿nges
 = 
vec
![
r1
, 
r2
];

278 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
w¿µ”
.
¡Üe
.
g‘_¢­shÙ
();

279 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

281 
Ët
 
mut
 
	gsÿÂ”
 = 
IndexSÿnExecutÜ
::
Ãw
(
w¿µ”
.
sÿn
, w¿µ”.
¿nges
, 
¡Üe
);

283 
hªdË
 
	gš
 0..
	gKEY_NUMBER
 / 2 {

284 
Ët
 
	grow
 = 
sÿÂ”
.
Ãxt
().
unw¿p
().unwrap();

285 
	gas£¹_eq
!(
	grow
.
	ghªdË
, 
hªdË
 
as
 
	gi64
);

286 
	gas£¹_eq
!(
	grow
.
	gd©a
.
Ën
(), 
	gw¿µ”
.
	gcŞs
.len());

287 
Ët
 
	gex³ù_row
 = &
w¿µ”
.
d©a
.
ex³ù_rows
[
hªdË
];

288 
cŞ
 
	gš
 &
	gw¿µ”
.
	gcŞs
 {

289 
Ët
 
	gcid
 = 
cŞ
.
g‘_cŞumn_id
();

290 
Ët
 
	gv
 = 
row
.
d©a
.
g‘
(
cid
).
unw¿p
();

291 
	gas£¹_eq
!(
	gex³ù_row
[&
cid
], 
	gv
.
to_vec
());

294 
	gas£¹
!(
	gsÿÂ”
.
Ãxt
().
unw¿p
().
is_nÚe
());

297 #[
‹¡
]

298 
â
 
‹¡_»v”£_sÿn
() {

299 
Ët
 
mut
 
	gw¿µ”
 = 
IndexTe¡W¿µ”
::();

300 
	gw¿µ”
.
	gsÿn
.
£t_desc
(
Œue
);

302 
Ët
 
	gr1
 = 
g‘_idx_¿nge
(
TABLE_ID
, 
INDEX_ID
, 
i64
::
MIN
, 0);

303 
Ët
 
	gr2
 = 
g‘_idx_¿nge
(
TABLE_ID
, 
INDEX_ID
, 0, (
KEY_NUMBER
 / 2è
as
 
i64
);

304 
Ët
 
	gr3
 = 
g‘_idx_¿nge
(
TABLE_ID
, 
INDEX_ID
, (
KEY_NUMBER
 / 2è
as
 
i64
, i64::
MAX
);

305 
	gw¿µ”
.
	g¿nges
 = 
vec
![
r1
, 
r2
, 
r3
];

307 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
w¿µ”
.
¡Üe
.
g‘_¢­shÙ
();

308 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

310 
Ët
 
mut
 
	gsÿÂ”
 = 
IndexSÿnExecutÜ
::
Ãw
(
w¿µ”
.
sÿn
, w¿µ”.
¿nges
, 
¡Üe
);

312 
tid
 
	gš
 0..
	gKEY_NUMBER
 {

313 
Ët
 
	ghªdË
 = 
KEY_NUMBER
 - 
tid
 - 1;

314 
Ët
 
	grow
 = 
sÿÂ”
.
Ãxt
().
unw¿p
().unwrap();

315 
	gas£¹_eq
!(
	grow
.
	ghªdË
, 
hªdË
 
as
 
	gi64
);

316 
	gas£¹_eq
!(
	grow
.
	gd©a
.
Ën
(), 2);

317 
Ët
 
	gex³ù_row
 = &
w¿µ”
.
d©a
.
ex³ù_rows
[
hªdË
];

318 
cŞ
 
	gš
 &
	gw¿µ”
.
	gcŞs
 {

319 
Ët
 
	gcid
 = 
cŞ
.
g‘_cŞumn_id
();

320 
Ët
 
	gv
 = 
row
.
d©a
.
g‘
(
cid
).
unw¿p
();

321 
	gas£¹_eq
!(
	gex³ù_row
[&
cid
], 
	gv
.
to_vec
());

324 
	gas£¹
!(
	gsÿÂ”
.
Ãxt
().
unw¿p
().
is_nÚe
());

327 #[
‹¡
]

328 
â
 
‹¡_šşude_pk
() {

329 
Ët
 
mut
 
	gw¿µ”
 = 
IndexTe¡W¿µ”
::
šşude_pk_cŞs
();

330 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
w¿µ”
.
¡Üe
.
g‘_¢­shÙ
();

331 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

333 
Ët
 
mut
 
	gsÿÂ”
 = 
IndexSÿnExecutÜ
::
Ãw
(
w¿µ”
.
sÿn
, w¿µ”.
¿nges
, 
¡Üe
);

335 
hªdË
 
	gš
 0..
	gKEY_NUMBER
 {

336 
Ët
 
	grow
 = 
sÿÂ”
.
Ãxt
().
unw¿p
().unwrap();

337 
	gas£¹_eq
!(
	grow
.
	ghªdË
, 
hªdË
 
as
 
	gi64
);

338 
	gas£¹_eq
!(
	grow
.
	gd©a
.
Ën
(), 
	gw¿µ”
.
	gcŞs
.len());

339 
Ët
 
	gex³ù_row
 = &
w¿µ”
.
d©a
.
ex³ù_rows
[
hªdË
];

340 
Ët
 
	ghªdË_d©um
 = 
d©um
::
D©um
::
I64
(
hªdË
 
as
 
i64
);

341 
Ët
 
	gpk
 = 
d©um
::
’code_key
(&[
hªdË_d©um
]).
unw¿p
();

342 
cŞ
 
	gš
 &
	gw¿µ”
.
	gcŞs
 {

343 
Ët
 
	gcid
 = 
cŞ
.
g‘_cŞumn_id
();

344 
Ët
 
	gv
 = 
row
.
d©a
.
g‘
(
cid
).
unw¿p
();

345 
	gcŞ
.
g‘_pk_hªdË
() {

346 
	gas£¹_eq
!(
	gpk
, 
	gv
.
to_vec
());

349 
	gas£¹_eq
!(
	gex³ù_row
[&
cid
], 
	gv
.
to_vec
());

352 
	gas£¹
!(
	gsÿÂ”
.
Ãxt
().
unw¿p
().
is_nÚe
());

	@src/coprocessor/dag/executor/limit.rs

15 #![
®low
(
d—d_code
)]

17 
u£
 
	gtb
::
executÜ
::
Lim™
;

19 
u£
 
	gcİroûssÜ
::
ResuÉ
;

20 
u£
 
	gcİroûssÜ
::
m‘rics
::*;

21 
u£
 
	gcİroûssÜ
::
dag
::
executÜ
::{
ExecutÜ
, 
	gRow
};

22 
u£
 
	g¡Üage
::
Sti¡ics
;

24 
pub
 
	gLim™ExecutÜ
<'a> {

25 
	glim™
: 
u64
,

26 
	gcursÜ
: 
u64
,

27 
	g¤c
: 
Box
<
ExecutÜ
 + 'a>,

30 
im¶
<'a> Lim™ExecutÜ<'
a
> {

31 
pub
 
â
 
Ãw
(
lim™
: 
Lim™
, 
¤c
: 
Box
<
ExecutÜ
 + 'a>) -> LimitExecutor {

32 
COPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["lim™"]).
šc
();

33 
Lim™ExecutÜ
 {

34 
lim™
:†im™.
g‘_lim™
(),

35 
cursÜ
: 0,

36 
¤c
: src,

41 
im¶
<'a> ExecutÜ fÜ Lim™ExecutÜ<'
a
> {

42 
â
 
Ãxt
(&
mut
 
£lf
è-> 
ResuÉ
<
O±iÚ
<
Row
>> {

43 
£lf
.
cursÜ
 >ğ£lf.
lim™
 {

44  
Ok
(
NÚe
);

46 
Ët
 
Some
(
row
èğ
£lf
.
¤c
.
Ãxt
()? {

47 
£lf
.
cursÜ
 += 1;

48 
Ok
(
Some
(
row
))

50 
Ok
(
NÚe
)

54 
â
 
cŞËù_¡©i¡ics_što
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
Sti¡ics
) {

55 
£lf
.
¤c
.
cŞËù_¡©i¡ics_što
(
¡©i¡ics
);

59 #[
cfg
(
‹¡
)]

60 
mod
 
‹¡
 {

61 
u£
 
kv´Ùo
::
kv½ıb
::
IsŞ©iÚLev–
;

62 
u£
 
´Ùobuf
::
R•—‹dF›ld
;

63 
u£
 
tb
::
executÜ
::
TabËSÿn
;

65 
u£
 
cİroûssÜ
::
codec
::
mysql
::
ty³s
;

66 
u£
 
cİroûssÜ
::
codec
::
d©um
::
D©um
;

67 
u£
 
¡Üage
::
SÇpshÙStÜe
;

69 
u£
 
su³r
::*;

70 
u£
 
su³r
::su³r::
bË_sÿn
::
TabËSÿnExecutÜ
;

71 
u£
 
su³r
::su³r::
sÿÂ”
::
‹¡
::{
g‘_¿nge
, 
Ãw_cŞ_šfo
, 
Te¡StÜe
};

72 
u£
 
su³r
::su³r::
tİn
::
‹¡
::
g’_bË_d©a
;

74 #[
‹¡
]

75 
â
 
‹¡_lim™_executÜ
() {

77 
Ët
 
tid
 = 1;

78 
Ët
 
cis
 = 
vec
![

79 
Ãw_cŞ_šfo
(1, 
ty³s
::
LONG_LONG
),

80 
Ãw_cŞ_šfo
(2, 
ty³s
::
VARCHAR
),

82 
Ët
 
¿w_d©a
 = 
vec
![

83 
vec
![
D©um
::
I64
(1), D©um::
By‹s
(
b
"a".
to_vec
())],

84 
vec
![
D©um
::
I64
(2), D©um::
By‹s
(
b
"b".
to_vec
())],

85 
vec
![
D©um
::
I64
(3), D©um::
By‹s
(
b
"c".
to_vec
())],

86 
vec
![
D©um
::
I64
(4), D©um::
By‹s
(
b
"d".
to_vec
())],

87 
vec
![
D©um
::
I64
(5), D©um::
By‹s
(
b
"e".
to_vec
())],

88 
vec
![
D©um
::
I64
(6), D©um::
By‹s
(
b
"f".
to_vec
())],

89 
vec
![
D©um
::
I64
(7), D©um::
By‹s
(
b
"g".
to_vec
())],

91 
Ët
 
bË_d©a
 = 
g’_bË_d©a
(
tid
, &
cis
, &
¿w_d©a
);

92 
Ët
 
mut
 
‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
bË_d©a
);

94 
Ët
 
mut
 
bË_sÿn
 = 
TabËSÿn
::
Ãw
();

95 
bË_sÿn
.
£t_bË_id
(
tid
);

96 
bË_sÿn
.
£t_cŞumns
(
R•—‹dF›ld
::
äom_vec
(
cis
.
şÚe
()));

98 
Ët
 
¿nge1
 = 
g‘_¿nge
(
tid
, 0, 4);

99 
Ët
 
¿nge2
 = 
g‘_¿nge
(
tid
, 5, 10);

100 
Ët
 
key_¿nges
 = 
vec
![
¿nge1
, 
¿nge2
];

102 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
‹¡_¡Üe
.
g‘_¢­shÙ
();

103 
Ët
 
¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

104 
Ët
 
ts_eù
 = 
TabËSÿnExecutÜ
::
Ãw
(&
bË_sÿn
, 
key_¿nges
, 
¡Üe
);

107 
Ët
 
mut
 
lim™_m‘a
 = 
Lim™
::();

108 
Ët
 
lim™
 = 5;

109 
lim™_m‘a
.
£t_lim™
(
lim™
);

111 
Ët
 
mut
 
lim™_eù
 = 
Lim™ExecutÜ
::
Ãw
(
lim™_m‘a
, 
Box
::Ãw(
ts_eù
));

112 
Ët
 
mut
 
lim™_rows
 = 
Vec
::
w™h_ÿ·c™y
(
lim™
 
as
 
usize
);

113 
Ët
 
Some
(
row
èğ
lim™_eù
.
Ãxt
().
unw¿p
() {

114 
lim™_rows
.
push
(
row
);

116 
as£¹_eq
!(
lim™_rows
.
Ën
(), 
lim™
 
as
 
usize
);

117 
Ët
 
ex³ù_row_hªdËs
 = 
vec
![1, 2, 3, 5, 6];

118 
row
, 
hªdË
è
š
 
lim™_rows
.
™”
().
z
(
ex³ù_row_hªdËs
) {

119 
as£¹_eq
!(
row
.
hªdË
, handle);

	@src/coprocessor/dag/executor/mod.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	gtb
::
executÜ
::{
£lf
, 
	gExecTy³
};

17 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gEx´Ty³
};

18 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

19 
u£
 
	gkv´Ùo
::
cİroûssÜ
::
KeyRªge
;

21 
u£
 
	gcİroûssÜ
::
codec
::
mysql
;

22 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::{
£lf
, 
	gD©um
};

23 
u£
 
	gcİroûssÜ
::
codec
::
bË
::{
RowCŞsDiù
, 
	gTabËDecod”
};

24 
u£
 
	gcİroûssÜ
::
’dpošt
::
g‘_pk
;

25 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

26 
u£
 
	gcİroûssÜ
::{
E¼Ü
, 
	gResuÉ
};

27 
u£
 
	g¡Üage
::{
SÇpshÙStÜe
, 
	gSti¡ics
};

28 
u£
 
	gut
::
codec
::
numb”
::
Numb”Decod”
;

29 
u£
 
	gut
::
cŞËùiÚs
::
HashS‘
;

31 
mod
 
	gsÿÂ”
;

32 
mod
 
	gbË_sÿn
;

33 
mod
 
	gšdex_sÿn
;

34 
mod
 
	g£ËùiÚ
;

35 
mod
 
	gtİn
;

36 
mod
 
	glim™
;

37 
mod
 
	gagg»g©iÚ
;

39 
pub
 
u£
 
	g£lf
::
bË_sÿn
::
TabËSÿnExecutÜ
;

40 
pub
 
u£
 
	g£lf
::
šdex_sÿn
::
IndexSÿnExecutÜ
;

41 
pub
 
u£
 
	g£lf
::
£ËùiÚ
::
S–eùiÚExecutÜ
;

42 
pub
 
u£
 
	g£lf
::
tİn
::
TİNExecutÜ
;

43 
pub
 
u£
 
	g£lf
::
lim™
::
Lim™ExecutÜ
;

44 
pub
 
u£
 
	g£lf
::
agg»g©iÚ
::
Agg»g©iÚExecutÜ
;

45 
pub
 
u£
 
	g£lf
::
sÿÂ”
::{
SÿnOn
, 
	gSÿÂ”
};

47 
pub
 
	sEx´CŞumnRefVis™Ü
 {

48 
	mcŞs_off£t
: 
HashS‘
<
usize
>,

49 
	mcŞs_Ën
: 
usize
,

52 
im¶
 
	gEx´CŞumnRefVis™Ü
 {

53 
pub
 
â
 
Ãw
(
cŞs_Ën
: 
usize
è-> 
Ex´CŞumnRefVis™Ü
 {

54 
Ex´CŞumnRefVis™Ü
 {

55 
cŞs_off£t
: 
HashS‘
::(),

56 
	gcŞs_Ën
: 
cŞs_Ën
,

60 
pub
 
â
 
vis™
(&
mut
 
£lf
, 
ex´
: &
Ex´
è-> 
ResuÉ
<()> {

61 
ex´
.
g‘_
(è=ğ
Ex´Ty³
::
CŞumnRef
 {

62 
Ët
 
off£t
 = 
box_Œy
!(
ex´
.
g‘_v®
().
decode_i64
()è
as
 
usize
;

63 
	goff£t
 >ğ
£lf
.
cŞs_Ën
 {

64  
E¼
(
E¼Ü
::
Oth”
(
box_”r
!(

66 
off£t
,

67 
£lf
.
cŞs_Ën


70 
	g£lf
.
	gcŞs_off£t
.
š£¹
(
off£t
);

72 
sub_ex´
 
š
 
	gex´
.
g‘_chd»n
() {

73 
	g£lf
.
vis™
(
sub_ex´
)?;

76 
Ok
(())

79 
pub
 
â
 
b©ch_vis™
(&
mut
 
£lf
, 
ex´s
: &[
Ex´
]è-> 
ResuÉ
<()> {

80 
ex´
 
š
 
ex´s
 {

81 
£lf
.
vis™
(
ex´
)?;

83 
Ok
(())

86 
pub
 
â
 
cŞumn_off£ts
(
£lf
è-> 
	gVec
<
	gusize
> {

87 
	g£lf
.
	gcŞs_off£t
.
što_™”
().
cŞËù
()

91 #[
d”ive
(
Debug
)]

92 
pub
 
	sRow
 {

93 
pub
 
	mhªdË
: 
i64
,

94 
pub
 
	md©a
: 
RowCŞsDiù
,

97 
im¶
 
	gRow
 {

98 
pub
 
â
 
Ãw
(
hªdË
: 
i64
, 
d©a
: 
RowCŞsDiù
è-> 
Row
 {

99 
Row
 {

100 
hªdË
: handle,

101 
	gd©a
: 
d©a
,

106 
pub
 
â
 
g‘_bš¬y_cŞs
(&
£lf
, 
cŞumns
: &[
CŞumnInfo
]è-> 
ResuÉ
<
Vec
<Vec<
u8
>>> {

107 
Ët
 
mut
 
»s
 = 
Vec
::
w™h_ÿ·c™y
(
cŞumns
.
Ën
());

108 
cŞ
 
š
 
	gcŞumns
 {

109 
	gcŞ
.
g‘_pk_hªdË
() {

110 
Ët
 
	gv
 = 
g‘_pk
(
cŞ
, 
£lf
.
hªdË
);

111 
Ët
 
	gbt
 = 
box_Œy
!(
d©um
::
’code_v®ue
(&[
v
]));

112 
	g»s
.
push
(
bt
);

115 
Ët
 
	gcŞ_id
 = 
cŞ
.
g‘_cŞumn_id
();

116 
Ët
 
	gv®ue
 = 
m©ch
 
£lf
.
d©a
.
g‘
(
cŞ_id
) {

117 
NÚe
 
cŞ
.
has_deçuÉ_v®
(è=> cŞ.
g‘_deçuÉ_v®
().
to_vec
(),

118 
NÚe
 
	gmysql
::
has_nÙ_nuÎ_æag
(
cŞ
.
g‘_æag
(è
as
 
u64
) => {

119  
E¼
(
box_”r
!("cŞumÀ{} oà{} i missšg", 
cŞ_id
, 
£lf
.
hªdË
));

121 
	gNÚe
 => 
box_Œy
!(
d©um
::
’code_v®ue
(&[
D©um
::
NuÎ
])),

122 
Some
(
bs
è=> bs.
to_vec
(),

124 
	g»s
.
push
(
v®ue
);

126 
Ok
(
»s
)

130 
pub
 
Œa™
 
	gExecutÜ
 {

131 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gRow
>>;

132 
â
 
cŞËù_¡©i¡ics_što
(&
mut
 
£lf
, 
¡©s
: &muˆ
Sti¡ics
);

135 
pub
 
	sDAGExecutÜ
 {

136 
pub
 
	mexec
: 
Box
<
ExecutÜ
>,

137 
pub
 
	mcŞumns
: 
Arc
<
Vec
<
CŞumnInfo
>>,

138 
pub
 
	mhas_aggr
: 
boŞ
,

141 
pub
 
â
 
bud_exec
(

142 
execs
: 
Vec
<
executÜ
::
ExecutÜ
>,

143 
¡Üe
: 
SÇpshÙStÜe
,

144 
¿nges
: 
Vec
<
KeyRªge
>,

145 
ùx
: 
Arc
<
Ev®CÚ‹xt
>,

146 è-> 
	gResuÉ
<
	gDAGExecutÜ
> {

147 
Ët
 
mut
 
	gexecs
 = 
execs
.
što_™”
();

148 
Ët
 
	gfœ¡
 = 
execs


149 .
Ãxt
()

150 .
ok_Ü_–£
(|| 
E¼Ü
::
Oth”
(
box_”r
!("has‚oƒxecutor")))?;

151 
Ët
 (
mut
 
¤c
, 
cŞumns
èğ
bud_fœ¡_executÜ
(
fœ¡
, 
¡Üe
, 
¿nges
)?;

152 
Ët
 
mut
 
	ghas_aggr
 = 
çl£
;

153 
mut
 
exec
 
š
 
	gexecs
 {

154 
Ët
 
	gcu¼
: 
Box
<
ExecutÜ
> = 
m©ch
 
exec
.
g‘_
() {

155 
ExecTy³
::
Ty³TabËSÿn
 | ExecTy³::
Ty³IndexSÿn
 => {

156  
E¼
(
box_”r
!("gotoo much *scanƒxec, should be only one"))

158 
ExecTy³
::
Ty³S–eùiÚ
 => 
Box
::
Ãw
(
S–eùiÚExecutÜ
::new(

159 
exec
.
ke_£ËùiÚ
(),

160 
ùx
.
şÚe
(),

161 
cŞumns
.
şÚe
(),

162 
¤c
,

164 
	gExecTy³
::
Ty³Agg»g©iÚ
 => {

165 
has_aggr
 = 
Œue
;

166 
	gBox
::
Ãw
(
Agg»g©iÚExecutÜ
::new(

167 
exec
.
ke_agg»g©iÚ
(),

168 
ùx
.
şÚe
(),

169 
cŞumns
.
şÚe
(),

170 
¤c
,

173 
	gExecTy³
::
Ty³TİN
 => 
Box
::
Ãw
(
TİNExecutÜ
::new(

174 
exec
.
ke_tİN
(),

175 
ùx
.
şÚe
(),

176 
cŞumns
.
şÚe
(),

177 
¤c
,

179 
	gExecTy³
::
Ty³Lim™
 => 
Box
::
Ãw
(
Lim™ExecutÜ
::Ãw(
exec
.
ke_lim™
(), 
¤c
)),

181 
	g¤c
 = 
cu¼
;

183 
Ok
(
DAGExecutÜ
 {

184 
exec
: 
¤c
,

185 
cŞumns
: columns,

186 
has_aggr
: has_aggr,

190 
ty³
 
	gFœ¡ExecutÜ
 = (
Box
<
ExecutÜ
>, 
	gArc
<
	gVec
<
	gCŞumnInfo
>>);

192 
â
 
bud_fœ¡_executÜ
(

193 
mut
 
fœ¡
: 
executÜ
::
ExecutÜ
,

194 
¡Üe
: 
SÇpshÙStÜe
,

195 
¿nges
: 
Vec
<
KeyRªge
>,

196 è-> 
	gResuÉ
<
	gFœ¡ExecutÜ
> {

197 
m©ch
 
	gfœ¡
.
g‘_
() {

198 
	gExecTy³
::
Ty³TabËSÿn
 => {

199 
Ët
 
cŞs
 = 
Arc
::
Ãw
(
fœ¡
.
g‘_tbl_sÿn
().
g‘_cŞumns
().
to_vec
());

200 
Ët
 
	gex
 = 
Box
::
Ãw
(
TabËSÿnExecutÜ
::Ãw(
fœ¡
.
g‘_tbl_sÿn
(), 
¿nges
, 
¡Üe
));

201 
Ok
((
ex
, 
cŞs
))

203 
	gExecTy³
::
Ty³IndexSÿn
 => {

204 
Ët
 
cŞs
 = 
Arc
::
Ãw
(
fœ¡
.
g‘_idx_sÿn
().
g‘_cŞumns
().
to_vec
());

205 
Ët
 
	gex
 = 
Box
::
Ãw
(
IndexSÿnExecutÜ
::Ãw(
fœ¡
.
ke_idx_sÿn
(), 
¿nges
, 
¡Üe
));

206 
Ok
((
ex
, 
cŞs
))

208 
	g_
 => 
E¼
(
box_”r
!(

210 
fœ¡
.
g‘_
()

215 
pub
 
â
 
šæ©e_w™h_cŞ_fÜ_dag
(

216 
ùx
: &
Ev®CÚ‹xt
,

217 
v®ues
: &
RowCŞsDiù
,

218 
cŞumns
: &[
CŞumnInfo
],

219 
off£ts
: &[
usize
],

220 
h
: 
i64
,

221 è-> 
	gResuÉ
<
	gVec
<
	gD©um
>> {

222 
Ët
 
mut
 
	g»s
 = 
vec
![
D©um
::
NuÎ
; 
cŞumns
.
Ën
()];

223 
off£t
 
š
 
	goff£ts
 {

224 
Ët
 
	gcŞ
 = &
cŞumns
[*
off£t
];

225 
	gcŞ
.
g‘_pk_hªdË
() {

226 
Ët
 
	gv
 = 
g‘_pk
(
cŞ
, 
h
);

227 
	g»s
[*
off£t
] = 
v
;

229 
Ët
 
	gcŞ_id
 = 
cŞ
.
g‘_cŞumn_id
();

230 
Ët
 
	gv®ue
 = 
m©ch
 
v®ues
.
g‘
(
cŞ_id
) {

231 
NÚe
 
cŞ
.
has_deçuÉ_v®
() => {

233 
box_Œy
!(
cŞ
.
g‘_deçuÉ_v®
().
decode_cŞ_v®ue
(
ùx
, col))

235 
NÚe
 
mysql
::
has_nÙ_nuÎ_æag
(
cŞ
.
g‘_æag
(è
as
 
u64
) => {

236  
E¼
(
box_”r
!("cŞumÀ{} oà{} i missšg", 
cŞ_id
, 
h
));

238 
	gNÚe
 => 
D©um
::
NuÎ
,

239 
Some
(
mut
 
bs
è=> 
box_Œy
!(bs.
decode_cŞ_v®ue
(
ùx
, 
cŞ
)),

241 
	g»s
[*
off£t
] = 
v®ue
;

244 
Ok
(
»s
)

	@src/coprocessor/dag/executor/scanner.rs

14 
u£
 
	gkv´Ùo
::
cİroûssÜ
::
KeyRªge
;

16 
u£
 
	gcİroûssÜ
::
’dpošt
::
´efix_Ãxt
;

17 
u£
 
	gcİroûssÜ
::
codec
::
bË
::
Œunÿ‹_as_row_key
;

18 
u£
 
	g¡Üage
::{
Key
, 
	gSÿnMode
, 
	gSÇpshÙStÜe
, 
	gSti¡ics
, 
	gStÜeSÿÂ”
, 
	gV®ue
};

19 
u£
 
	g¡Üage
::
txn
::
ResuÉ
;

20 
u£
 
	gut
::
esÿ³
;

22 #[
d”ive
(
Cİy
, 
ClÚe
)]

23 
pub
 
	eSÿnOn
 {

24 
	mTabË
,

25 
	mIndex
,

30 
pub
 
	sSÿÂ”
 {

31 
	msÿn_mode
: 
SÿnMode
,

32 
	msÿn_Ú
: 
SÿnOn
,

33 
	mkey_Úly
: 
boŞ
,

34 
	m£ek_key
: 
Vec
<
u8
>,

35 
	msÿÂ”
: 
StÜeSÿÂ”
,

36 
	m¿nge
: 
KeyRªge
,

37 
	mno_mÜe
: 
boŞ
,

40 
	m¡©i¡ics_ÿche
: 
Sti¡ics
,

43 
im¶
 
	gSÿÂ”
 {

44 
pub
 
â
 
Ãw
(

45 
¡Üe
: &
SÇpshÙStÜe
,

46 
sÿn_Ú
: 
SÿnOn
,

47 
desc
: 
boŞ
,

48 
key_Úly
: 
boŞ
,

49 
¿nge
: 
KeyRªge
,

50 è-> 
	gResuÉ
<
	gSÿÂ”
> {

51 
Ët
 (
sÿn_mode
, 
£ek_key
, 
uµ”_bound
èğ
desc
 {

52 (
SÿnMode
::
Backw¬d
, 
¿nge
.
g‘_’d
().
to_vec
(), 
NÚe
)

55 
SÿnMode
::
FÜw¬d
,

56 
¿nge
.
g‘_¡¬t
().
to_vec
(),

57 
Some
(
Key
::
äom_¿w
(
¿nge
.
g‘_’d
()).
’coded
().
to_vec
()),

61 
Ok
(
SÿÂ”
 {

62 
sÿn_mode
: scan_mode,

63 
sÿn_Ú
: scan_on,

64 
key_Úly
: key_only,

65 
£ek_key
: seek_key,

66 
sÿÂ”
: 
¡Üe
.sÿÂ”(
sÿn_mode
, 
key_Úly
, 
uµ”_bound
)?,

67 
¿nge
:„ange,

68 
no_mÜe
: 
çl£
,

69 
¡©i¡ics_ÿche
: 
Sti¡ics
::(),

73 
pub
 
â
 
»£t_¿nge
(&
mut
 
£lf
, 
¿nge
: 
KeyRªge
, 
¡Üe
: &
SÇpshÙStÜe
è-> 
ResuÉ
<()> {

74 
£lf
.
¿nge
 =„ange;

75 
	g£lf
.
	gno_mÜe
 = 
çl£
;

76 
m©ch
 
	g£lf
.
	gsÿn_mode
 {

77 
	gSÿnMode
::
Backw¬d
 => 
£lf
.
£ek_key
 = s–f.
¿nge
.
g‘_’d
().
to_vec
(),

78 
	gSÿnMode
::
FÜw¬d
 => {

80 
£lf
.
£ek_key
 = s–f.
¿nge
.
g‘_¡¬t
().
to_vec
();

81 
	g£lf
.
	g¡©i¡ics_ÿche
.
add
(
£lf
.
sÿÂ”
.
g‘_¡©i¡ics
());

82 
Ët
 
	guµ”_bound
 = 
Some
(
Key
::
äom_¿w
(&
£lf
.
¿nge
.
’d
).
’coded
().
to_vec
());

83 
	g£lf
.
	gsÿÂ”
 = 
¡Üe
.
sÿÂ”
(
£lf
.
sÿn_mode
, s–f.
key_Úly
, 
uµ”_bound
)?;

85 
	g_
 => 
uÄ—chabË
!(),

87 
Ok
(())

90 
pub
 
â
 
Ãxt_row
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<(
	gVec
<
	gu8
>, 
	gV®ue
)>> {

91 
	g£lf
.
	gno_mÜe
 {

92  
Ok
(
NÚe
);

95 
Ët
 
	gkv
 = 
m©ch
 
£lf
.
sÿn_mode
 {

96 
SÿnMode
::
Backw¬d
 => 
£lf
.
sÿÂ”
.
»v”£_£ek
(
Key
::
äom_¿w
(&£lf.
£ek_key
))?,

97 
	gSÿnMode
::
FÜw¬d
 => 
£lf
.
sÿÂ”
.
£ek
(
Key
::
äom_¿w
(&£lf.
£ek_key
))?,

98 
	g_
 => 
uÄ—chabË
!(),

101 
Ët
 (
key
, 
v®ue
èğ
m©ch
 
kv
 {

102 
Some
((
key
, 
v®ue
)è=> (
box_Œy
!(key.
¿w
()), 
	gv®ue
),

103 
	gNÚe
 => {

104 
£lf
.
no_mÜe
 = 
Œue
;

105  
Ok
(
NÚe
);

109 
	g£lf
.
	g¿nge
.
	g¡¬t
 > 
	gkey
 || s–f.¿nge.
	g’d
 <ğ
key
 {

110 
debug
!(

112 
esÿ³
(&
key
),

113 
esÿ³
(
£lf
.
¿nge
.
g‘_¡¬t
()),

114 
esÿ³
(
£lf
.
¿nge
.
g‘_’d
())

116 
	g£lf
.
	gno_mÜe
 = 
Œue
;

117  
Ok
(
NÚe
);

120 
	g£lf
.
	g£ek_key
 = 
m©ch
 (
£lf
.
sÿn_mode
, s–f.
sÿn_Ú
) {

121 (
	gSÿnMode
::
FÜw¬d
, 
	g_
è=> 
´efix_Ãxt
(&
key
),

122 (
	gSÿnMode
::
Backw¬d
, 
	gSÿnOn
::
TabË
è=> 
box_Œy
!(
Œunÿ‹_as_row_key
(&
key
)).
to_vec
(),

123 (
	gSÿnMode
::
Backw¬d
, 
	gSÿnOn
::
Index
è=> 
key
.
şÚe
(),

124 
	g_
 => 
uÄ—chabË
!(),

126 
Ok
(
Some
((
key
, 
v®ue
)))

129 
pub
 
â
 
cŞËù_¡©i¡ics_što
(
£lf
, 
¡©s
: &
mut
 
Sti¡ics
) {

130 
¡©s
.
add
(&
£lf
.
¡©i¡ics_ÿche
);

131 
	g¡©s
.
add
(
£lf
.
sÿÂ”
.
g‘_¡©i¡ics
());

135 #[
cfg
(
‹¡
)]

136 
pub
 
mod
 
	g‹¡
 {

137 
u£
 
	g¡d
::
i64
;

139 
u£
 
	gkv´Ùo
::
kv½ıb
::{
CÚ‹xt
, 
	gIsŞ©iÚLev–
};

140 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

142 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
ty³s
;

143 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::{
£lf
, 
	gD©um
};

144 
u£
 
	gcİroûssÜ
::
codec
::
bË
;

145 
u£
 
	gcİroûssÜ
::
’dpošt
::
´efix_Ãxt
;

146 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

147 
u£
 
	gut
::
codec
::
numb”
::
Numb”Encod”
;

148 
u£
 
	g¡Üage
::
mvcc
::
MvccTxn
;

149 
u£
 
	g¡Üage
::{
make_key
, 
	gMutiÚ
, 
	gO±iÚs
, 
	gSÇpshÙ
, 
	gSÇpshÙStÜe
, 
	gALL_CFS
};

150 
u£
 
	g¡Üage
::
’gše
::{
£lf
, 
	gEngše
, 
	gModify
, 
	gTEMP_DIR
};

152 
u£
 
	gsu³r
::*;

154 
pub
 
â
 
Ãw_cŞ_šfo
(
cid
: 
i64
, 

: 
u8
è-> 
CŞumnInfo
 {

155 
Ët
 
mut
 
cŞ_šfo
 = 
CŞumnInfo
::
Ãw
();

156 
	gcŞ_šfo
.
£t_
(

 
as
 
i32
);

157 
	gcŞ_šfo
.
£t_cŞumn_id
(
cid
);

158 
	gcŞ_šfo


161 
pub
 
	sD©a
 {

162 
pub
 
	gkv_d©a
: 
Vec
<(Vec<
u8
>, 
	gVec
<
	gu8
>)>,

164 
pub
 
	gex³ù_rows
: 
Vec
<
HashM­
<
i64
, 
	gVec
<
	gu8
>>>,

165 
pub
 
	gcŞs
: 
Vec
<
CŞumnInfo
>,

168 
im¶
 
	gD©a
 {

169 
pub
 
â
 
g‘_´ev_2_cŞs
(&
£lf
è-> 
	gVec
<
	gCŞumnInfo
> {

170 
Ët
 
	gcŞ1
 = 
£lf
.
cŞs
[0].
şÚe
();

171 
Ët
 
	gcŞ2
 = 
£lf
.
cŞs
[1].
şÚe
();

172 
	gvec
![
cŞ1
, 
cŞ2
]

175 
pub
 
â
 
g‘_šdex_cŞs
(&
£lf
è-> 
	gVec
<
	gCŞumnInfo
> {

176 
	gvec
![
£lf
.
cŞs
[1].
şÚe
(), 
	g£lf
.
	gcŞs
[2].clone()]

179 
pub
 
â
 
g‘_cŞ_pk
(&
£lf
è-> 
	gCŞumnInfo
 {

180 
Ët
 
mut
 
	gpk_cŞ
 = 
Ãw_cŞ_šfo
(0, 
ty³s
::
LONG
);

181 
	gpk_cŞ
.
£t_pk_hªdË
(
Œue
);

182 
	gpk_cŞ


186 
pub
 
â
 
´•¬e_bË_d©a
(
key_numb”
: 
usize
, 
bË_id
: 
i64
è-> 
D©a
 {

187 
Ët
 
cŞs
 = 
vec
![

188 
Ãw_cŞ_šfo
(1, 
ty³s
::
LONG_LONG
),

189 
Ãw_cŞ_šfo
(2, 
ty³s
::
VARCHAR
),

190 
Ãw_cŞ_šfo
(3, 
ty³s
::
NEW_DECIMAL
),

193 
Ët
 
mut
 
	gkv_d©a
 = 
Vec
::
Ãw
();

194 
Ët
 
mut
 
	gex³ù_rows
 = 
Vec
::
Ãw
();

196 
hªdË
 
	gš
 0..
	gkey_numb”
 {

197 
Ët
 
	grow
 = 
m­
![

198 1 => 
D©um
::
I64
(
hªdË
 
as
 
i64
),

199 2 => 
D©um
::
By‹s
(
b
"abc".
to_vec
()),

200 3 => 
D©um
::
Dec
(10.
što
())

202 
Ët
 
mut
 
	gex³ù_row
 = 
HashM­
::();

203 
Ët
 
	gcŞ_ids
: 
Vec
<
_
> = 
row
.
™”
().
m­
(|(&
id
, _)| id).
cŞËù
();

204 
Ët
 
	gcŞ_v®ues
: 
Vec
<
_
> = 
row
.
™”
()

205 .
m­
(|(
cid
, 
v
)| {

206 
Ët
 
f
 = 
bË
::
æ©‹n
(
v
.
şÚe
()).
unw¿p
();

207 
Ët
 
v®ue
 = 
d©um
::
’code_v®ue
(&[
f
]).
unw¿p
();

208 
ex³ù_row
.
š£¹
(*
cid
, 
v®ue
);

209 
v
.
şÚe
()

211 .
cŞËù
();

213 
Ët
 
	gv®ue
 = 
bË
::
’code_row
(
cŞ_v®ues
, &
cŞ_ids
).
unw¿p
();

214 
Ët
 
mut
 
	gbuf
 = 
vec
![];

215 
	gbuf
.
’code_i64
(
hªdË
 
as
 
i64
).
unw¿p
();

216 
Ët
 
	gkey
 = 
bË
::
’code_row_key
(
bË_id
, &
buf
);

217 
	gex³ù_rows
.
push
(
ex³ù_row
);

218 
	gkv_d©a
.
push
((
key
, 
v®ue
));

220 
	gD©a
 {

221 
	gkv_d©a
: 
kv_d©a
,

222 
	gex³ù_rows
: 
ex³ù_rows
,

223 
	gcŞs
: 
cŞs
,

227 cÚ¡ 
	gSTART_TS
: 
u64
 = 10;

228 cÚ¡ 
	gCOMMIT_TS
: 
u64
 = 20;

230 
pub
 
	sTe¡StÜe
 {

231 
	g¢­shÙ
: 
Box
<
SÇpshÙ
>,

232 
	gùx
: 
CÚ‹xt
,

233 
	g’gše
: 
Box
<
Engše
>,

236 
im¶
 
	gTe¡StÜe
 {

237 
pub
 
â
 
Ãw
(
kv_d©a
: &[(
Vec
<
u8
>, Vec<u8>)]è-> 
	gTe¡StÜe
 {

238 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

239 
Ët
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

240 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

241 
Ët
 
mut
 
	g¡Üe
 = 
Te¡StÜe
 {

242 
¢­shÙ
: snapshot,

243 
ùx
: ctx,

244 
’gše
:ƒngine,

246 
	g¡Üe
.
š™_d©a
(
kv_d©a
);

247 
	g¡Üe


250 
â
 
š™_d©a
(&
mut
 
£lf
, 
kv_d©a
: &[(
Vec
<
u8
>, Vec<u8>)]) {

252 
Ët
 
	gtxn_mÙif›s
 = {

253 
Ët
 
mut
 
txn
 = 
MvccTxn
::
Ãw
(

254 
£lf
.
¢­shÙ
.
şÚe
(),

255 
START_TS
,

256 
NÚe
,

257 
IsŞ©iÚLev–
::
SI
,

258 
Œue
,

260 
Ët
 
mut
 
	gpk
 = 
vec
![];

261 &(
»f
 
	gkey
,„eà
	gv®ue
è
š
 
	gkv_d©a
 {

262 
	gpk
.
is_em±y
() {

263 
	gpk
 = 
key
.
şÚe
();

265 
	gtxn
.
´ewr™e
(

266 
MutiÚ
::
Put
((
make_key
(
key
), 
v®ue
.
to_vec
())),

267 &
pk
,

268 &
O±iÚs
::(),

269 ).
unw¿p
();

271 
	gtxn
.
što_modif›s
()

273 
	g£lf
.
wr™e_modif›s
(
txn_mÙif›s
);

276 
Ët
 
	gtxn_modif›s
 = {

277 
Ët
 
mut
 
txn
 = 
MvccTxn
::
Ãw
(

278 
£lf
.
¢­shÙ
.
şÚe
(),

279 
START_TS
,

280 
NÚe
,

281 
IsŞ©iÚLev–
::
SI
,

282 
Œue
,

284 &(
»f
 
	gkey
, 
	g_
è
š
 
	gkv_d©a
 {

285 
	gtxn
.
comm™
(&
make_key
(
key
), 
COMMIT_TS
).
unw¿p
();

287 
	gtxn
.
što_modif›s
()

289 
	g£lf
.
wr™e_modif›s
(
txn_modif›s
);

292 #[
šlše
]

293 
â
 
wr™e_modif›s
(&
mut
 
£lf
, 
txn
: 
Vec
<
Modify
>) {

294 
£lf
.
’gše
.
wr™e
(&£lf.
ùx
, 
txn
).
unw¿p
();

295 
	g£lf
.
	g¢­shÙ
 = 
£lf
.
’gše
.
¢­shÙ
(&£lf.
ùx
).
unw¿p
()

298 
pub
 
â
 
g‘_¢­shÙ
(&
mut
 
£lf
è-> (
	gBox
<
	gSÇpshÙ
>, 
	gu64
) {

299 (
	g£lf
.
	g¢­shÙ
.
şÚe
(), 
	gCOMMIT_TS
 + 1)

303 #[
šlše
]

304 
pub
 
â
 
g‘_¿nge
(
bË_id
: 
i64
, 
¡¬t
: i64, 
’d
: i64è-> 
KeyRªge
 {

305 
Ët
 
mut
 
¡¬t_buf
 = 
Vec
::
w™h_ÿ·c™y
(8);

306 
	g¡¬t_buf
.
’code_i64
(
¡¬t
).
unw¿p
();

307 
Ët
 
mut
 
	g’d_buf
 = 
Vec
::
w™h_ÿ·c™y
(8);

308 
	g’d_buf
.
’code_i64
(
’d
).
unw¿p
();

309 
Ët
 
mut
 
	gkey_¿nge
 = 
KeyRªge
::
Ãw
();

310 
	gkey_¿nge
.
£t_¡¬t
(
bË
::
’code_row_key
(
bË_id
, &
¡¬t_buf
));

311 
	gkey_¿nge
.
£t_’d
(
bË
::
’code_row_key
(
bË_id
, &
’d_buf
));

312 
	gkey_¿nge


315 
pub
 
â
 
g‘_pošt_¿nge
(
bË_id
: 
i64
, 
hªdË
: i64è-> 
KeyRªge
 {

316 
Ët
 
mut
 
¡¬t_buf
 = 
Vec
::
w™h_ÿ·c™y
(8);

317 
	g¡¬t_buf
.
’code_i64
(
hªdË
).
unw¿p
();

318 
Ët
 
	g¡¬t_key
 = 
bË
::
’code_row_key
(
bË_id
, &
¡¬t_buf
);

319 
Ët
 
	g’d
 = 
´efix_Ãxt
(&
¡¬t_key
);

320 
Ët
 
mut
 
	gkey_¿nge
 = 
KeyRªge
::
Ãw
();

321 
	gkey_¿nge
.
£t_¡¬t
(
¡¬t_key
);

322 
	gkey_¿nge
.
£t_’d
(
’d
);

323 
	gkey_¿nge


326 #[
‹¡
]

327 
â
 
‹¡_sÿn
() {

328 
Ët
 
	gbË_id
 = 1;

329 
Ët
 
	gpk
 = 
bË
::
’code_row_key
(
bË_id
, 
b
"key1");

330 
Ët
 
	gpv
 = 
b
"value1";

331 
Ët
 
	g‹¡_d©a
 = 
vec
![

332 (
pk
.
şÚe
(), 
pv
.
to_vec
()),

333 (
bË
::
’code_row_key
(
bË_id
, 
b
"key2"), b"v®ue2".
to_vec
()),

335 
Ët
 
mut
 
	g‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
‹¡_d©a
);

336 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
‹¡_¡Üe
.
g‘_¢­shÙ
();

337 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

338 
Ët
 
	g¿nge
 = 
g‘_¿nge
(
bË_id
, 
i64
::
MIN
, i64::
MAX
);

339 
Ët
 
mut
 
	gsÿÂ”
 = 
SÿÂ”
::
Ãw
(&
¡Üe
, 
SÿnOn
::
TabË
, 
çl£
, f®£, 
¿nge
).
unw¿p
();

340 &(
»f
 
	gk
,„eà
	gv
è
	gš
 &
	g‹¡_d©a
 {

341 
Ët
 (
key
, 
v®ue
èğ
sÿÂ”
.
Ãxt_row
().
unw¿p
().unwrap();

342 
	gas£¹_eq
!(
	gk
, &
	gkey
);

343 
	gas£¹_eq
!(*
	gv
, 
	gv®ue
);

345 
	gas£¹
!(
	gsÿÂ”
.
Ãxt_row
().
unw¿p
().
is_nÚe
());

348 #[
‹¡
]

349 
â
 
‹¡_»v”£_sÿn
() {

350 
Ët
 
	gbË_id
 = 1;

351 
Ët
 
	gkey_numb”
 = 10;

352 
Ët
 
mut
 
	gd©a
 = 
´•¬e_bË_d©a
(
key_numb”
, 
bË_id
);

353 
Ët
 
mut
 
	g‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
d©a
.
kv_d©a
);

354 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
‹¡_¡Üe
.
g‘_¢­shÙ
();

355 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

356 
Ët
 
	g¿nge
 = 
g‘_¿nge
(
bË_id
, 
i64
::
MIN
, i64::
MAX
);

357 
Ët
 
mut
 
	gsÿÂ”
 = 
SÿÂ”
::
Ãw
(&
¡Üe
, 
SÿnOn
::
TabË
, 
Œue
, 
çl£
, 
¿nge
).
unw¿p
();

358 
	gd©a
.
	gkv_d©a
.
»v”£
();

359 &(
»f
 
	gk
,„eà
	gv
è
	gš
 &
	gd©a
.
	gkv_d©a
 {

360 
Ët
 (
key
, 
v®ue
èğ
sÿÂ”
.
Ãxt_row
().
unw¿p
().unwrap();

361 
	gas£¹_eq
!(*
	gk
, 
	gkey
);

362 
	gas£¹_eq
!(*
	gv
, 
	gv®ue
);

364 
	gas£¹
!(
	gsÿÂ”
.
Ãxt_row
().
unw¿p
().
is_nÚe
());

367 #[
‹¡
]

368 
â
 
‹¡_sÿn_key_Úly
() {

369 
Ët
 
	gbË_id
 = 1;

370 
Ët
 
	gpk
 = 
bË
::
’code_row_key
(
bË_id
, 
b
"key1");

371 
Ët
 
	gpv
 = 
b
"value1";

372 
Ët
 
	g‹¡_d©a
 = 
vec
![

373 (
pk
.
şÚe
(), 
pv
.
to_vec
()),

374 (
bË
::
’code_row_key
(
bË_id
, 
b
"key2"), b"v®ue2".
to_vec
()),

376 
Ët
 
mut
 
	g‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
‹¡_d©a
);

377 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
‹¡_¡Üe
.
g‘_¢­shÙ
();

378 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

379 
Ët
 
	g¿nge
 = 
g‘_¿nge
(
bË_id
, 
i64
::
MIN
, i64::
MAX
);

380 
Ët
 
mut
 
	gsÿÂ”
 = 
SÿÂ”
::
Ãw
(&
¡Üe
, 
SÿnOn
::
TabË
, 
çl£
, 
Œue
, 
¿nge
).
unw¿p
();

381 
Ët
 (
_
, 
v®ue
èğ
sÿÂ”
.
Ãxt_row
().
unw¿p
().unwrap();

382 
	gas£¹
!(
	gv®ue
.
is_em±y
());

385 #[
‹¡
]

386 
â
 
‹¡_£ek_key
() {

387 
Ët
 
	gbË_id
 = 1;

388 
Ët
 
	gpk
 = 
bË
::
’code_row_key
(
bË_id
, 
b
"key1");

389 
Ët
 
	gpv
 = 
b
"value1";

390 
Ët
 
	g‹¡_d©a
 = 
vec
![(
pk
.
şÚe
(), 
pv
.
to_vec
())];

391 
Ët
 
mut
 
	g‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
‹¡_d©a
);

392 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
‹¡_¡Üe
.
g‘_¢­shÙ
();

393 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

394 
Ët
 
	g¿nge
 = 
g‘_¿nge
(
bË_id
, 
i64
::
MIN
, i64::
MAX
);

397 
Ët
 
	gsÿÂ”
 = 
SÿÂ”
::
Ãw
(&
¡Üe
, 
SÿnOn
::
TabË
, 
Œue
, 
çl£
, 
¿nge
.
şÚe
()).
unw¿p
();

398 
	gas£¹_eq
!(
	gsÿÂ”
.
	g£ek_key
, 
	g¿nge
.
g‘_’d
());

401 
Ët
 
	gsÿÂ”
 = 
SÿÂ”
::
Ãw
(&
¡Üe
, 
SÿnOn
::
TabË
, 
çl£
, f®£, 
¿nge
.
şÚe
()).
unw¿p
();

402 
	gas£¹_eq
!(
	gsÿÂ”
.
	g£ek_key
, 
	g¿nge
.
g‘_¡¬t
());

	@src/coprocessor/dag/executor/selection.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	gtb
::
executÜ
::
S–eùiÚ
;

17 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

19 
u£
 
	gcİroûssÜ
::
m‘rics
::*;

20 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

21 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
Ex´essiÚ
;

22 
u£
 
	gcİroûssÜ
::
ResuÉ
;

23 
u£
 
	g¡Üage
::
Sti¡ics
;

25 
u£
 
	gsu³r
::{
šæ©e_w™h_cŞ_fÜ_dag
, 
	gExecutÜ
, 
	gEx´CŞumnRefVis™Ü
, 
	gRow
};

27 
pub
 
	sS–eùiÚExecutÜ
 {

28 
	mcÚd™iÚs
: 
Vec
<
Ex´essiÚ
>,

29 
	mcŞs
: 
Arc
<
Vec
<
CŞumnInfo
>>,

30 
	m»Ï‹d_cŞs_off£t
: 
Vec
<
usize
>,

31 
	mùx
: 
Arc
<
Ev®CÚ‹xt
>,

32 
	m¤c
: 
Box
<
ExecutÜ
>,

35 
im¶
 
	gS–eùiÚExecutÜ
 {

36 
pub
 
â
 
Ãw
(

37 
mut
 
m‘a
: 
S–eùiÚ
,

38 
ùx
: 
Arc
<
Ev®CÚ‹xt
>,

39 
cŞumns_šfo
: 
Arc
<
Vec
<
CŞumnInfo
>>,

40 
¤c
: 
Box
<
ExecutÜ
>,

41 è-> 
	gResuÉ
<
	gS–eùiÚExecutÜ
> {

42 
Ët
 
	gcÚd™iÚs
 = 
m‘a
.
ke_cÚd™iÚs
().
što_vec
();

43 
Ët
 
mut
 
	gvis™Ü
 = 
Ex´CŞumnRefVis™Ü
::
Ãw
(
cŞumns_šfo
.
Ën
());

44 
	gvis™Ü
.
b©ch_vis™
(&
cÚd™iÚs
)?;

45 
	gCOPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["£ËùiÚ"]).
šc
();

46 
Ok
(
S–eùiÚExecutÜ
 {

47 
cÚd™iÚs
: 
box_Œy
!(
Ex´essiÚ
::
b©ch_bud
(
ùx
.
as_»f
(), conditions)),

48 
cŞs
: 
cŞumns_šfo
,

49 
»Ï‹d_cŞs_off£t
: 
vis™Ü
.
cŞumn_off£ts
(),

50 
ùx
: ctx,

51 
¤c
: src,

56 #[
®low
(
Ãv”_loİ
)]

57 
im¶
 
ExecutÜ
 
	gS–eùiÚExecutÜ
 {

58 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gRow
>> {

60 
Ët
 
	gcŞs
 = 
šæ©e_w™h_cŞ_fÜ_dag
(

61 &
£lf
.
ùx
,

62 &
row
.
d©a
,

63 
£lf
.
cŞs
.
as_»f
(),

64 &
£lf
.
»Ï‹d_cŞs_off£t
,

65 
row
.
hªdË
,

67 
f‹r
 
	gš
 &
	g£lf
.
	gcÚd™iÚs
 {

68 
Ët
 
	gv®
 = 
box_Œy
!(
f‹r
.
ev®
(&
£lf
.
ùx
, &
cŞs
));

69 !
	gbox_Œy
!(
	gv®
.
što_boŞ
(&
£lf
.
ùx
)).
unw¿p_Ü
(
çl£
) {

73  
Ok
(
Some
(
row
));

75 
Ok
(
NÚe
)

78 
â
 
	$cŞËù_¡©i¡ics_što
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
Sti¡ics
) {

79 
£lf
.
¤c
.
	`cŞËù_¡©i¡ics_što
(
¡©i¡ics
);

80 
	}
}

83 #[
cfg
(
‹¡
)]

84 
mod
 
	g‹¡s
 {

85 
u£
 
	g¡d
::
i64
;

86 
u£
 
	g¡d
::
sync
::
Arc
;

88 
u£
 
	gkv´Ùo
::
kv½ıb
::
IsŞ©iÚLev–
;

89 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

90 
u£
 
	gtb
::
executÜ
::
TabËSÿn
;

91 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gEx´Ty³
, 
	gSÿÏrFuncSig
};

93 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
ty³s
;

94 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::
D©um
;

95 
u£
 
	g¡Üage
::
SÇpshÙStÜe
;

96 
u£
 
	gut
::
codec
::
numb”
::
Numb”Encod”
;

98 
u£
 
	gsu³r
::*;

99 
u£
 
	gsu³r
::
su³r
::
tİn
::
‹¡
::
g’_bË_d©a
;

100 
u£
 
	gsu³r
::
su³r
::
sÿÂ”
::
‹¡
::{
g‘_¿nge
, 
	gÃw_cŞ_šfo
, 
	gTe¡StÜe
};

101 
u£
 
	gsu³r
::
su³r
::
bË_sÿn
::
TabËSÿnExecutÜ
;

103 
â
 
Ãw_cÚ¡_ex´
(è-> 
	gEx´
 {

104 
Ët
 
mut
 
	gex´
 = 
Ex´
::
Ãw
();

105 
	gex´
.
£t_
(
Ex´Ty³
::
SÿÏrFunc
);

106 
	gex´
.
£t_sig
(
SÿÏrFuncSig
::
NuÎEQIÁ
);

107 
	gex´
.
mut_chd»n
().
push
({

108 
Ët
 
mut
 
lhs
 = 
Ex´
::
Ãw
();

109 
lhs
.
£t_
(
Ex´Ty³
::
NuÎ
);

110 
lhs


112 
	gex´
.
mut_chd»n
().
push
({

113 
Ët
 
mut
 
rhs
 = 
Ex´
::
Ãw
();

114 
rhs
.
£t_
(
Ex´Ty³
::
NuÎ
);

115 
rhs


117 
	gex´


120 
â
 
Ãw_cŞ_gt_u64_ex´
(
off£t
: 
i64
, 
v®
: 
u64
è-> 
Ex´
 {

121 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

122 
	gex´
.
£t_
(
Ex´Ty³
::
SÿÏrFunc
);

123 
	gex´
.
£t_sig
(
SÿÏrFuncSig
::
GTIÁ
);

124 
	gex´
.
mut_chd»n
().
push
({

125 
Ët
 
mut
 
lhs
 = 
Ex´
::
Ãw
();

126 
lhs
.
£t_
(
Ex´Ty³
::
CŞumnRef
);

127 
lhs
.
mut_v®
().
’code_i64
(
off£t
).
unw¿p
();

128 
lhs


130 
	gex´
.
mut_chd»n
().
push
({

131 
Ët
 
mut
 
rhs
 = 
Ex´
::
Ãw
();

132 
rhs
.
£t_
(
Ex´Ty³
::
Ušt64
);

133 
rhs
.
mut_v®
().
’code_u64
(
v®
).
unw¿p
();

134 
rhs


136 
	gex´


139 #[
‹¡
]

140 
â
 
‹¡_£ËùiÚ_executÜ_sim¶e
() {

141 
Ët
 
	gtid
 = 1;

142 
Ët
 
	gcis
 = 
vec
![

143 
Ãw_cŞ_šfo
(1, 
ty³s
::
LONG_LONG
),

144 
Ãw_cŞ_šfo
(2, 
ty³s
::
VARCHAR
),

145 
Ãw_cŞ_šfo
(3, 
ty³s
::
NEW_DECIMAL
),

147 
Ët
 
	g¿w_d©a
 = 
vec
![

148 
vec
![

149 
D©um
::
I64
(1),

150 
D©um
::
By‹s
(
b
"a".
to_vec
()),

151 
D©um
::
Dec
(7.
što
()),

153 
	gvec
![

154 
D©um
::
I64
(2),

155 
D©um
::
By‹s
(
b
"b".
to_vec
()),

156 
D©um
::
Dec
(7.
što
()),

158 
	gvec
![

159 
D©um
::
I64
(3),

160 
D©um
::
By‹s
(
b
"b".
to_vec
()),

161 
D©um
::
Dec
(8.
što
()),

163 
	gvec
![

164 
D©um
::
I64
(4),

165 
D©um
::
By‹s
(
b
"d".
to_vec
()),

166 
D©um
::
Dec
(3.
što
()),

168 
	gvec
![

169 
D©um
::
I64
(5),

170 
D©um
::
By‹s
(
b
"f".
to_vec
()),

171 
D©um
::
Dec
(5.
što
()),

173 
	gvec
![

174 
D©um
::
I64
(6),

175 
D©um
::
By‹s
(
b
"e".
to_vec
()),

176 
D©um
::
Dec
(9.
što
()),

178 
	gvec
![

179 
D©um
::
I64
(7),

180 
D©um
::
By‹s
(
b
"f".
to_vec
()),

181 
D©um
::
Dec
(6.
što
()),

185 
Ët
 
	gbË_d©a
 = 
g’_bË_d©a
(
tid
, &
cis
, &
¿w_d©a
);

186 
Ët
 
mut
 
	g‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
bË_d©a
);

188 
Ët
 
mut
 
	gbË_sÿn
 = 
TabËSÿn
::
Ãw
();

189 
	gbË_sÿn
.
£t_bË_id
(
tid
);

190 
	gbË_sÿn
.
£t_cŞumns
(
R•—‹dF›ld
::
äom_vec
(
cis
.
şÚe
()));

192 
Ët
 
	gkey_¿nges
 = 
vec
![
g‘_¿nge
(
tid
, 0, 
i64
::
MAX
)];

194 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
‹¡_¡Üe
.
g‘_¢­shÙ
();

195 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

197 
Ët
 
	gšÃr_bË_sÿn
 = 
TabËSÿnExecutÜ
::
Ãw
(&
bË_sÿn
, 
key_¿nges
, 
¡Üe
);

200 
Ët
 
mut
 
	g£ËùiÚ
 = 
S–eùiÚ
::
Ãw
();

201 
Ët
 
	gex´
 = 
Ãw_cÚ¡_ex´
();

202 
	g£ËùiÚ
.
mut_cÚd™iÚs
().
push
(
ex´
);

204 
Ët
 
mut
 
	g£ËùiÚ_executÜ
 = 
S–eùiÚExecutÜ
::
Ãw
(

205 
£ËùiÚ
,

206 
Arc
::
Ãw
(
Ev®CÚ‹xt
::()),

207 
Arc
::
Ãw
(
cis
),

208 
Box
::
Ãw
(
šÃr_bË_sÿn
),

209 ).
unw¿p
();

211 
Ët
 
mut
 
	g£ËùiÚ_rows
 = 
Vec
::
w™h_ÿ·c™y
(
¿w_d©a
.
Ën
());

212 
Ët
 
Some
(
row
èğ
£ËùiÚ_executÜ
.
Ãxt
().
unw¿p
() {

213 
£ËùiÚ_rows
.
push
(
row
);

216 
	gas£¹_eq
!(
	g£ËùiÚ_rows
.
Ën
(), 
	g¿w_d©a
.len());

217 
Ët
 
	gex³ù_row_hªdËs
 = 
¿w_d©a
.
™”
().
m­
(|
r
|„[0].
i64
()).
cŞËù
::<
Vec
<
_
>>();

218 
Ët
 
	g»suÉ_row
 = 
£ËùiÚ_rows
.
™”
().
m­
(|
r
|„.
hªdË
).
cŞËù
::<
Vec
<
_
>>();

219 
	gas£¹_eq
!(
	g»suÉ_row
, 
	gex³ù_row_hªdËs
);

222 #[
‹¡
]

223 
â
 
‹¡_£ËùiÚ_executÜ_cÚd™iÚ
() {

224 
Ët
 
	gtid
 = 1;

225 
Ët
 
	gcis
 = 
vec
![

226 
Ãw_cŞ_šfo
(1, 
ty³s
::
LONG_LONG
),

227 
Ãw_cŞ_šfo
(2, 
ty³s
::
VARCHAR
),

228 
Ãw_cŞ_šfo
(3, 
ty³s
::
LONG_LONG
),

230 
Ët
 
	g¿w_d©a
 = 
vec
![

231 
vec
![
D©um
::
I64
(1), D©um::
By‹s
(
b
"a".
to_vec
()), Datum::I64(7)],

232 
	gvec
![
D©um
::
I64
(2), D©um::
By‹s
(
b
"b".
to_vec
()), Datum::I64(7)],

233 
	gvec
![
D©um
::
I64
(3), D©um::
By‹s
(
b
"b".
to_vec
()), Datum::I64(8)],

234 
	gvec
![
D©um
::
I64
(4), D©um::
By‹s
(
b
"d".
to_vec
()), Datum::I64(3)],

235 
	gvec
![
D©um
::
I64
(5), D©um::
By‹s
(
b
"f".
to_vec
()), Datum::I64(5)],

236 
	gvec
![
D©um
::
I64
(6), D©um::
By‹s
(
b
"e".
to_vec
()), Datum::I64(9)],

237 
	gvec
![
D©um
::
I64
(7), D©um::
By‹s
(
b
"f".
to_vec
()), Datum::I64(6)],

240 
Ët
 
	gbË_d©a
 = 
g’_bË_d©a
(
tid
, &
cis
, &
¿w_d©a
);

241 
Ët
 
mut
 
	g‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
bË_d©a
);

243 
Ët
 
mut
 
	gbË_sÿn
 = 
TabËSÿn
::
Ãw
();

244 
	gbË_sÿn
.
£t_bË_id
(
tid
);

245 
	gbË_sÿn
.
£t_cŞumns
(
R•—‹dF›ld
::
äom_vec
(
cis
.
şÚe
()));

247 
Ët
 
	gkey_¿nges
 = 
vec
![
g‘_¿nge
(
tid
, 0, 
i64
::
MAX
)];

249 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
‹¡_¡Üe
.
g‘_¢­shÙ
();

250 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

251 
Ët
 
	gšÃr_bË_sÿn
 = 
TabËSÿnExecutÜ
::
Ãw
(&
bË_sÿn
, 
key_¿nges
, 
¡Üe
);

254 
Ët
 
mut
 
	g£ËùiÚ
 = 
S–eùiÚ
::
Ãw
();

255 
Ët
 
	gex´
 = 
Ãw_cŞ_gt_u64_ex´
(2, 5);

256 
	g£ËùiÚ
.
mut_cÚd™iÚs
().
push
(
ex´
);

258 
Ët
 
mut
 
	g£ËùiÚ_executÜ
 = 
S–eùiÚExecutÜ
::
Ãw
(

259 
£ËùiÚ
,

260 
Arc
::
Ãw
(
Ev®CÚ‹xt
::()),

261 
Arc
::
Ãw
(
cis
),

262 
Box
::
Ãw
(
šÃr_bË_sÿn
),

263 ).
unw¿p
();

265 
Ët
 
mut
 
	g£ËùiÚ_rows
 = 
Vec
::
w™h_ÿ·c™y
(
¿w_d©a
.
Ën
());

266 
Ët
 
Some
(
row
èğ
£ËùiÚ_executÜ
.
Ãxt
().
unw¿p
() {

267 
£ËùiÚ_rows
.
push
(
row
);

270 
Ët
 
	gex³ù_row_hªdËs
 = 
¿w_d©a


271 .
™”
()

272 .
f‹r
(|
r
|„[2].
i64
() > 5)

273 .
m­
(|
r
|„[0].
i64
())

274 .
cŞËù
::<
Vec
<
_
>>();

275 
	gas£¹
!(
	gex³ù_row_hªdËs
.
Ën
(è< 
	g¿w_d©a
.len());

276 
	gas£¹_eq
!(
	g£ËùiÚ_rows
.
Ën
(), 
	gex³ù_row_hªdËs
.len());

277 
Ët
 
	g»suÉ_row
 = 
£ËùiÚ_rows
.
™”
().
m­
(|
r
|„.
hªdË
).
cŞËù
::<
Vec
<
_
>>();

278 
	gas£¹_eq
!(
	g»suÉ_row
, 
	gex³ù_row_hªdËs
);

	@src/coprocessor/dag/executor/table_scan.rs

14 
u£
 
	g¡d
::
vec
::
IÁoI‹r
;

16 
u£
 
	gkv´Ùo
::
cİroûssÜ
::
KeyRªge
;

17 
u£
 
	gtb
::
executÜ
::
TabËSÿn
;

19 
u£
 
	gcİroûssÜ
::
codec
::
bË
;

20 
u£
 
	gcİroûssÜ
::
’dpošt
::
is_pošt
;

21 
u£
 
	gcİroûssÜ
::{
E¼Ü
, 
	gResuÉ
};

22 
u£
 
	gcİroûssÜ
::
m‘rics
::*;

23 
u£
 
	g¡Üage
::{
Key
, 
	gSÇpshÙStÜe
, 
	gSti¡ics
};

24 
u£
 
	gut
::
cŞËùiÚs
::
HashS‘
;

26 
u£
 
	gsu³r
::{
ExecutÜ
, 
	gRow
};

27 
u£
 
	gsu³r
::
sÿÂ”
::{
SÿnOn
, 
	gSÿÂ”
};

30 
pub
 
	sTabËSÿnExecutÜ
 {

31 
	m¡Üe
: 
SÇpshÙStÜe
,

32 
	m¡©i¡ics
: 
Sti¡ics
,

33 
	mdesc
: 
boŞ
,

34 
	mcŞ_ids
: 
HashS‘
<
i64
>,

35 
	mkey_¿nges
: 
IÁoI‹r
<
KeyRªge
>,

36 
	msÿÂ”
: 
O±iÚ
<
SÿÂ”
>,

39 
im¶
 
	gTabËSÿnExecutÜ
 {

40 
pub
 
â
 
Ãw
(

41 
m‘a
: &
TabËSÿn
,

42 
mut
 
key_¿nges
: 
Vec
<
KeyRªge
>,

43 
¡Üe
: 
SÇpshÙStÜe
,

44 è-> 
	gTabËSÿnExecutÜ
 {

45 
	gCOPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["tblsÿn"]).
šc
();

47 
Ët
 
	gcŞ_ids
 = 
m‘a
.
g‘_cŞumns
()

48 .
™”
()

49 .
f‹r
(|
c
| !c.
g‘_pk_hªdË
())

50 .
m­
(|
c
| c.
g‘_cŞumn_id
())

51 .
cŞËù
();

53 
Ët
 
	gdesc
 = 
m‘a
.
g‘_desc
();

54 
	gdesc
 {

55 
	gkey_¿nges
.
»v”£
();

58 
	gTabËSÿnExecutÜ
 {

59 
	g¡Üe
: 
¡Üe
,

60 
	g¡©i¡ics
: 
Sti¡ics
::(),

61 
	gdesc
: 
desc
,

62 
	gcŞ_ids
: 
cŞ_ids
,

63 
	gkey_¿nges
: 
key_¿nges
.
što_™”
(),

64 
	gsÿÂ”
: 
NÚe
,

68 
â
 
g‘_row_äom_¿nge_sÿÂ”
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gRow
>> {

69 
Ët
 
Some
(
sÿÂ”
èğ
£lf
.sÿÂ”.
as_mut
() {

70 
COPR_GET_OR_SCAN_COUNT
.
w™h_Ïb–_v®ues
(&["¿nge"]).
šc
();

71 
Ët
 (
key
, 
v®ue
èğ
m©ch
 
sÿÂ”
.
Ãxt_row
()? {

72 
Some
((
key
, 
v®ue
)è=> (key, 
	gv®ue
),

73 
	gNÚe
 =>  
Ok
(
NÚe
),

75 
Ët
 
	grow_d©a
 = 
box_Œy
!(
bË
::
cut_row
(
v®ue
, &
£lf
.
cŞ_ids
));

76 
Ët
 
	gh
 = 
box_Œy
!(
bË
::
decode_hªdË
(&
key
));

77  
Ok
(
Some
(
Row
::
Ãw
(
h
, 
row_d©a
)));

79 
Ok
(
NÚe
)

82 
â
 
g‘_row_äom_pošt
(&
mut
 
£lf
, 
¿nge
: 
KeyRªge
è-> 
ResuÉ
<
O±iÚ
<
Row
>> {

83 
Ët
 
key
 = 
¿nge
.
g‘_¡¬t
();

84 
Ët
 
	gv®ue
 = 
£lf
.
¡Üe
.
g‘
(&
Key
::
äom_¿w
(
key
), &
mut
 s–f.
¡©i¡ics
)?;

85 
Ët
 
Some
(
v®ue
) = value {

86 
Ët
 
v®ues
 = 
box_Œy
!(
bË
::
cut_row
(
v®ue
, &
£lf
.
cŞ_ids
));

87 
Ët
 
	gh
 = 
box_Œy
!(
bË
::
decode_hªdË
(
key
));

88  
Ok
(
Some
(
Row
::
Ãw
(
h
, 
v®ues
)));

90 
Ok
(
NÚe
)

93 
â
 
Ãw_sÿÂ”
(&
£lf
, 
¿nge
: 
KeyRªge
è-> 
ResuÉ
<
SÿÂ”
> {

94 
SÿÂ”
::
Ãw
(&
£lf
.
¡Üe
, 
SÿnOn
::
TabË
, s–f.
desc
, 
çl£
, 
¿nge
).
m­_”r
(
E¼Ü
::
äom
)

98 
im¶
 
ExecutÜ
 
TabËSÿnExecutÜ
 {

99 
â
 
Ãxt
(&
mut
 
£lf
è-> 
ResuÉ
<
O±iÚ
<
Row
>> {

100 
loİ
 {

101 
Ët
 
Some
(
row
èğ
£lf
.
g‘_row_äom_¿nge_sÿÂ”
()? {

102  
Ok
(
Some
(
row
));

105 
Ët
 
Some
(
¿nge
èğ
£lf
.
key_¿nges
.
Ãxt
() {

106 
is_pošt
(&
¿nge
) {

107 
COPR_GET_OR_SCAN_COUNT
.
w™h_Ïb–_v®ues
(&["pošt"]).
šc
();

108 
Ët
 
Some
(
row
èğ
£lf
.
g‘_row_äom_pošt
(
¿nge
)? {

109  
Ok
(
Some
(
row
));

113 
	g£lf
.
	gsÿÂ”
 = 
m©ch
 
£lf
.
sÿÂ”
.
ke
() {

114 
Some
(
mut
 
sÿÂ”
) => {

115 
box_Œy
!(
sÿÂ”
.
»£t_¿nge
(
¿nge
, &
£lf
.
¡Üe
));

116 
Some
(
sÿÂ”
)

118 
	gNÚe
 => 
Some
(
£lf
.
Ãw_sÿÂ”
(
¿nge
)?),

122  
Ok
(
NÚe
);

126 
â
 
cŞËù_¡©i¡ics_što
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
Sti¡ics
) {

127 
¡©i¡ics
.
add
(&
£lf
.statistics);

128 
	g£lf
.
	g¡©i¡ics
 = 
Sti¡ics
::();

129 
Ët
 
Some
(
sÿÂ”
èğ
£lf
.sÿÂ”.
ke
() {

130 
sÿÂ”
.
cŞËù_¡©i¡ics_što
(
¡©i¡ics
);

135 #[
cfg
(
‹¡
)]

136 
mod
 
	g‹¡
 {

137 
u£
 
	g¡d
::
i64
;

139 
u£
 
	gkv´Ùo
::
kv½ıb
::
IsŞ©iÚLev–
;

140 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

141 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

143 
u£
 
	g¡Üage
::
SÇpshÙStÜe
;

145 
u£
 
	gsu³r
::*;

146 
u£
 
	gsu³r
::
su³r
::
sÿÂ”
::
‹¡
::{
g‘_pošt_¿nge
, 
	gg‘_¿nge
, 
	g´•¬e_bË_d©a
, 
	gD©a
,

147 
	gTe¡StÜe
};

149 cÚ¡ 
	gTABLE_ID
: 
i64
 = 1;

150 cÚ¡ 
	gKEY_NUMBER
: 
usize
 = 10;

152 
	sTabËSÿnTe¡W¿µ”
 {

153 
	gd©a
: 
D©a
,

154 
	g¡Üe
: 
Te¡StÜe
,

155 
	gbË_sÿn
: 
TabËSÿn
,

156 
	g¿nges
: 
Vec
<
KeyRªge
>,

157 
	gcŞs
: 
Vec
<
CŞumnInfo
>,

160 
im¶
 
	gTabËSÿnTe¡W¿µ”
 {

161 
â
 
g‘_pošt_¿nge
(&
£lf
, 
hªdË
: 
i64
è-> 
KeyRªge
 {

162 
g‘_pošt_¿nge
(
TABLE_ID
, 
hªdË
)

166 
im¶
 
DeçuÉ
 
	gTabËSÿnTe¡W¿µ”
 {

167 
â
 (è-> 
	gTabËSÿnTe¡W¿µ”
 {

168 
Ët
 
	g‹¡_d©a
 = 
´•¬e_bË_d©a
(
KEY_NUMBER
, 
TABLE_ID
);

169 
Ët
 
	g‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
‹¡_d©a
.
kv_d©a
);

170 
Ët
 
mut
 
	gbË_sÿn
 = 
TabËSÿn
::
Ãw
();

172 
Ët
 
	gcŞs
 = 
‹¡_d©a
.
g‘_´ev_2_cŞs
();

173 
Ët
 
	gcŞ_»q
 = 
R•—‹dF›ld
::
äom_vec
(
cŞs
.
şÚe
());

174 
	gbË_sÿn
.
£t_cŞumns
(
cŞ_»q
);

176 
Ët
 
	g¿nge
 = 
g‘_¿nge
(
TABLE_ID
, 
i64
::
MIN
, i64::
MAX
);

177 
Ët
 
	gkey_¿nges
 = 
vec
![
¿nge
];

178 
	gTabËSÿnTe¡W¿µ”
 {

179 
	gd©a
: 
‹¡_d©a
,

180 
	g¡Üe
: 
‹¡_¡Üe
,

181 
	gbË_sÿn
: 
bË_sÿn
,

182 
	g¿nges
: 
key_¿nges
,

183 
	gcŞs
: 
cŞs
,

188 #[
‹¡
]

189 
â
 
‹¡_pošt_g‘
() {

190 
Ët
 
mut
 
	gw¿µ”
 = 
TabËSÿnTe¡W¿µ”
::();

192 
Ët
 
	gr1
 = 
w¿µ”
.
g‘_pošt_¿nge
(
i64
::
MIN
);

194 
Ët
 
	ghªdË
 = 0;

195 
Ët
 
	gr2
 = 
w¿µ”
.
g‘_pošt_¿nge
(
hªdË
);

196 
	gw¿µ”
.
	g¿nges
 = 
vec
![
r1
, 
r2
];

198 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
w¿µ”
.
¡Üe
.
g‘_¢­shÙ
();

199 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

200 
Ët
 
mut
 
	gbË_sÿÂ”
 = 
TabËSÿnExecutÜ
::
Ãw
(&
w¿µ”
.
bË_sÿn
, w¿µ”.
¿nges
, 
¡Üe
);

202 
Ët
 
	grow
 = 
bË_sÿÂ”
.
Ãxt
().
unw¿p
().unwrap();

203 
	gas£¹_eq
!(
	grow
.
	ghªdË
, 
hªdË
 
as
 
	gi64
);

204 
	gas£¹_eq
!(
	grow
.
	gd©a
.
Ën
(), 
	gw¿µ”
.
	gcŞs
.len());

206 
Ët
 
	gex³ù_row
 = &
w¿µ”
.
d©a
.
ex³ù_rows
[
hªdË
 
as
 
usize
];

207 
cŞ
 
	gš
 &
	gw¿µ”
.
	gcŞs
 {

208 
Ët
 
	gcid
 = 
cŞ
.
g‘_cŞumn_id
();

209 
Ët
 
	gv
 = 
row
.
d©a
.
g‘
(
cid
).
unw¿p
();

210 
	gas£¹_eq
!(
	gex³ù_row
[&
cid
], 
	gv
.
to_vec
());

212 
	gas£¹
!(
	gbË_sÿÂ”
.
Ãxt
().
unw¿p
().
is_nÚe
());

215 #[
‹¡
]

216 
â
 
‹¡_muÉË_¿nges
() {

217 
Ët
 
mut
 
	gw¿µ”
 = 
TabËSÿnTe¡W¿µ”
::();

219 
Ët
 
	gr1
 = 
g‘_¿nge
(
TABLE_ID
, 
i64
::
MIN
, 0);

220 
Ët
 
	gr2
 = 
g‘_¿nge
(
TABLE_ID
, 0, (
KEY_NUMBER
 / 2è
as
 
i64
);

223 
Ët
 
	ghªdË
 = 
KEY_NUMBER
 / 2;

224 
Ët
 
	gr3
 = 
w¿µ”
.
g‘_pošt_¿nge
(
hªdË
 
as
 
i64
);

226 
Ët
 
	gr4
 = 
g‘_¿nge
(
TABLE_ID
, (
hªdË
 + 1è
as
 
i64
, i64::
MAX
);

227 
	gw¿µ”
.
	g¿nges
 = 
vec
![
r1
, 
r2
, 
r3
, 
r4
];

229 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
w¿µ”
.
¡Üe
.
g‘_¢­shÙ
();

230 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

231 
Ët
 
mut
 
	gbË_sÿÂ”
 = 
TabËSÿnExecutÜ
::
Ãw
(&
w¿µ”
.
bË_sÿn
, w¿µ”.
¿nges
, 
¡Üe
);

233 
hªdË
 
	gš
 0..
	gKEY_NUMBER
 {

234 
Ët
 
	grow
 = 
bË_sÿÂ”
.
Ãxt
().
unw¿p
().unwrap();

235 
	gas£¹_eq
!(
	grow
.
	ghªdË
, 
hªdË
 
as
 
	gi64
);

236 
	gas£¹_eq
!(
	grow
.
	gd©a
.
Ën
(), 
	gw¿µ”
.
	gcŞs
.len());

237 
Ët
 
	gex³ù_row
 = &
w¿µ”
.
d©a
.
ex³ù_rows
[
hªdË
];

238 
cŞ
 
	gš
 &
	gw¿µ”
.
	gcŞs
 {

239 
Ët
 
	gcid
 = 
cŞ
.
g‘_cŞumn_id
();

240 
Ët
 
	gv
 = 
row
.
d©a
.
g‘
(
cid
).
unw¿p
();

241 
	gas£¹_eq
!(
	gex³ù_row
[&
cid
], 
	gv
.
to_vec
());

244 
	gas£¹
!(
	gbË_sÿÂ”
.
Ãxt
().
unw¿p
().
is_nÚe
());

247 #[
‹¡
]

248 
â
 
‹¡_»v”£_sÿn
() {

249 
Ët
 
mut
 
	gw¿µ”
 = 
TabËSÿnTe¡W¿µ”
::();

250 
	gw¿µ”
.
	gbË_sÿn
.
£t_desc
(
Œue
);

253 
Ët
 
	gr1
 = 
g‘_¿nge
(
TABLE_ID
, 
i64
::
MIN
, 0);

254 
Ët
 
	gr2
 = 
g‘_¿nge
(
TABLE_ID
, 0, (
KEY_NUMBER
 / 2è
as
 
i64
);

257 
Ët
 
	ghªdË
 = 
KEY_NUMBER
 / 2;

258 
Ët
 
	gr3
 = 
w¿µ”
.
g‘_pošt_¿nge
(
hªdË
 
as
 
i64
);

260 
Ët
 
	gr4
 = 
g‘_¿nge
(
TABLE_ID
, (
hªdË
 + 1è
as
 
i64
, i64::
MAX
);

261 
	gw¿µ”
.
	g¿nges
 = 
vec
![
r1
, 
r2
, 
r3
, 
r4
];

263 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
w¿µ”
.
¡Üe
.
g‘_¢­shÙ
();

264 
Ët
 
	g¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

265 
Ët
 
mut
 
	gbË_sÿÂ”
 = 
TabËSÿnExecutÜ
::
Ãw
(&
w¿µ”
.
bË_sÿn
, w¿µ”.
¿nges
, 
¡Üe
);

267 
tid
 
	gš
 0..
	gKEY_NUMBER
 {

268 
Ët
 
	ghªdË
 = 
KEY_NUMBER
 - 
tid
 - 1;

269 
Ët
 
	grow
 = 
bË_sÿÂ”
.
Ãxt
().
unw¿p
().unwrap();

270 
	gas£¹_eq
!(
	grow
.
	ghªdË
, 
hªdË
 
as
 
	gi64
);

271 
	gas£¹_eq
!(
	grow
.
	gd©a
.
Ën
(), 
	gw¿µ”
.
	gcŞs
.len());

272 
Ët
 
	gex³ù_row
 = &
w¿µ”
.
d©a
.
ex³ù_rows
[
hªdË
];

273 
cŞ
 
	gš
 &
	gw¿µ”
.
	gcŞs
 {

274 
Ët
 
	gcid
 = 
cŞ
.
g‘_cŞumn_id
();

275 
Ët
 
	gv
 = 
row
.
d©a
.
g‘
(
cid
).
unw¿p
();

276 
	gas£¹_eq
!(
	gex³ù_row
[&
cid
], 
	gv
.
to_vec
());

279 
	gas£¹
!(
	gbË_sÿÂ”
.
Ãxt
().
unw¿p
().
is_nÚe
());

	@src/coprocessor/dag/executor/topn.rs

14 
u£
 
	g¡d
::
usize
;

15 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	g¡d
::
vec
::
IÁoI‹r
;

18 
u£
 
	gtb
::
executÜ
::
TİN
;

19 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

20 
u£
 
	gtb
::
ex´essiÚ
::
ByI‹m
;

22 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::
D©um
;

23 
u£
 
	gcİroûssÜ
::
ResuÉ
;

24 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

25 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
Ex´essiÚ
;

26 
u£
 
	gcİroûssÜ
::
£Ëù
::
tİn_h—p
::{
SÜtRow
, 
	gTİNH—p
};

27 
u£
 
	gcİroûssÜ
::
m‘rics
::*;

28 
u£
 
	g¡Üage
::
Sti¡ics
;

30 
u£
 
	gsu³r
::{
šæ©e_w™h_cŞ_fÜ_dag
, 
	gExecutÜ
, 
	gEx´CŞumnRefVis™Ü
, 
	gRow
};

32 
	sOrd”By
 {

33 
	m™ems
: 
Arc
<
Vec
<
ByI‹m
>>,

34 
	mex´s
: 
Vec
<
Ex´essiÚ
>,

37 
im¶
 
	gOrd”By
 {

38 
â
 
Ãw
(
ùx
: &
Ev®CÚ‹xt
, 
mut
 
Üd”_by
: 
Vec
<
ByI‹m
>è-> 
ResuÉ
<
Ord”By
> {

39 
Ët
 
ex´s
: 
Vec
<
Ex´essiÚ
> = 
box_Œy
!(

40 
Üd”_by


41 .
™”_mut
()

42 .
m­
(|
v
| 
Ex´essiÚ
::
bud
(
ùx
, v.
ke_ex´
()))

43 .
cŞËù
()

45 
Ok
(
Ord”By
 {

46 
™ems
: 
Arc
::
Ãw
(
Üd”_by
),

47 
ex´s
:ƒxprs,

51 
â
 
ev®
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
Vec
<Datum>> {

52 
Ët
 
»s
: 
Vec
<
D©um
> = 
box_Œy
!(
£lf
.
ex´s
.
™”
().
m­
(|
v
| v.
ev®
(
ùx
, 
row
)).
cŞËù
());

53 
Ok
(
»s
)

57 
pub
 
	sTİNExecutÜ
 {

58 
	mÜd”_by
: 
Ord”By
,

59 
	mcŞs
: 
Arc
<
Vec
<
CŞumnInfo
>>,

60 
	m»Ï‹d_cŞs_off£t
: 
Vec
<
usize
>,

61 
	mh—p
: 
O±iÚ
<
TİNH—p
>,

62 
	m™”
: 
O±iÚ
<
IÁoI‹r
<
SÜtRow
>>,

63 
	mùx
: 
Arc
<
Ev®CÚ‹xt
>,

64 
	m¤c
: 
Box
<
ExecutÜ
>,

67 
im¶
 
	gTİNExecutÜ
 {

68 
pub
 
â
 
Ãw
(

69 
mut
 
m‘a
: 
TİN
,

70 
ùx
: 
Arc
<
Ev®CÚ‹xt
>,

71 
cŞumns_šfo
: 
Arc
<
Vec
<
CŞumnInfo
>>,

72 
¤c
: 
Box
<
ExecutÜ
>,

73 è-> 
	gResuÉ
<
	gTİNExecutÜ
> {

74 
Ët
 
	gÜd”_by
 = 
m‘a
.
ke_Üd”_by
().
što_vec
();

76 
Ët
 
mut
 
	gvis™Ü
 = 
Ex´CŞumnRefVis™Ü
::
Ãw
(
cŞumns_šfo
.
Ën
());

77 
by_™em
 
	gš
 &
	gÜd”_by
 {

78 
	gvis™Ü
.
vis™
(
by_™em
.
g‘_ex´
())?;

81 
	gCOPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["tİn"]).
šc
();

82 
Ok
(
TİNExecutÜ
 {

83 
Üd”_by
: 
Ord”By
::
Ãw
(&
ùx
, order_by)?,

84 
h—p
: 
Some
(
TİNH—p
::
Ãw
(
m‘a
.
g‘_lim™
(è
as
 
usize
)?),

85 
cŞs
: 
cŞumns_šfo
,

86 
»Ï‹d_cŞs_off£t
: 
vis™Ü
.
cŞumn_off£ts
(),

87 
™”
: 
NÚe
,

88 
ùx
: ctx,

89 
¤c
: src,

93 
â
 
ãtch_®l
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

94 
Ët
 
Some
(
row
èğ
£lf
.
¤c
.
Ãxt
()? {

95 
Ët
 
cŞs
 = 
šæ©e_w™h_cŞ_fÜ_dag
(

96 &
£lf
.
ùx
,

97 &
row
.
d©a
,

98 
£lf
.
cŞs
.
as_»f
(),

99 &
£lf
.
»Ï‹d_cŞs_off£t
,

100 
row
.
hªdË
,

102 
Ët
 
	gob_v®ues
 = 
£lf
.
Üd”_by
.
ev®
(&£lf.
ùx
, &
cŞs
)?;

103 
	g£lf
.
	gh—p
.
as_mut
().
unw¿p
().
Œy_add_row
(

104 
row
.
hªdË
,

105 
row
.
d©a
,

106 
ob_v®ues
,

107 
£lf
.
Üd”_by
.
™ems
.
şÚe
(),

108 
£lf
.
ùx
.
şÚe
(),

111 
Ok
(())

115 
im¶
 
ExecutÜ
 
	gTİNExecutÜ
 {

116 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gRow
>> {

117 
	g£lf
.
	g™”
.
is_nÚe
() {

118 
	g£lf
.
ãtch_®l
()?;

119 
	g£lf
.
	g™”
 = 
Some
(
£lf
.
h—p
.
ke
().
unw¿p
().
što_sÜ‹d_vec
()?.
što_™”
());

121 
Ët
 
	g™”
 = 
£lf
.
™”
.
as_mut
().
unw¿p
();

122 
m©ch
 
	g™”
.
Ãxt
() {

123 
Some
(
sÜt_row
è=> 
Ok
(Some(
Row
 {

124 
hªdË
: 
sÜt_row
.handle,

125 
d©a
: 
sÜt_row
.data,

127 
	gNÚe
 => 
Ok
(
NÚe
),

131 
â
 
cŞËù_¡©i¡ics_što
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
Sti¡ics
) {

132 
£lf
.
¤c
.
cŞËù_¡©i¡ics_što
(
¡©i¡ics
);

137 #[
cfg
(
‹¡
)]

138 
pub
 
mod
 
	g‹¡
 {

139 
u£
 
	g¡d
::
sync
::
Arc
;

141 
u£
 
	gkv´Ùo
::
kv½ıb
::
IsŞ©iÚLev–
;

142 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

143 
u£
 
	gtb
::
executÜ
::
TabËSÿn
;

144 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gEx´Ty³
};

146 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

147 
u£
 
	gcİroûssÜ
::
codec
::
bË
::{
£lf
, 
	gRowCŞsDiù
};

148 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
ty³s
;

149 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

150 
u£
 
	gut
::
codec
::
numb”
::
Numb”Encod”
;

152 
u£
 
	g¡Üage
::
SÇpshÙStÜe
;

154 
u£
 
	gsu³r
::*;

155 
u£
 
	gsu³r
::
su³r
::
bË_sÿn
::
TabËSÿnExecutÜ
;

156 
u£
 
	gsu³r
::
su³r
::
sÿÂ”
::
‹¡
::{
g‘_¿nge
, 
	gÃw_cŞ_šfo
, 
	gTe¡StÜe
};

158 
â
 
Ãw_Üd”_by
(
off£t
: 
i64
, 
desc
: 
boŞ
è-> 
ByI‹m
 {

159 
Ët
 
mut
 
™em
 = 
ByI‹m
::
Ãw
();

160 
Ët
 
mut
 
	gex´
 = 
Ex´
::
Ãw
();

161 
	gex´
.
£t_
(
Ex´Ty³
::
CŞumnRef
);

162 
	gex´
.
mut_v®
().
’code_i64
(
off£t
).
unw¿p
();

163 
	g™em
.
£t_ex´
(
ex´
);

164 
	g™em
.
£t_desc
(
desc
);

165 
	g™em


168 #[
‹¡
]

169 
pub
 
â
 
‹¡_tİn_h—p
() {

170 
Ët
 
mut
 
	gÜd”_cŞs
 = 
Vec
::
Ãw
();

171 
	gÜd”_cŞs
.
push
(
Ãw_Üd”_by
(0, 
Œue
));

172 
	gÜd”_cŞs
.
push
(
Ãw_Üd”_by
(1, 
çl£
));

173 
Ët
 
	gÜd”_cŞs
 = 
Arc
::
Ãw
(
Üd”_cŞs
);

174 
Ët
 
	gùx
 = 
Arc
::
Ãw
(
Ev®CÚ‹xt
::());

176 
Ët
 
mut
 
	gtİn_h—p
 = 
TİNH—p
::
Ãw
(5).
unw¿p
();

178 
Ët
 
	g‹¡_d©a
 = 
vec
![

179 (1, 
SŒšg
::
äom
("d©a1"), 
D©um
::
NuÎ
, D©um::
I64
(1)),

182 
SŒšg
::
äom
("data2"),

183 
D©um
::
By‹s
(
b
"Çme:0".
to_vec
()),

184 
D©um
::
I64
(2),

188 
SŒšg
::
äom
("data3"),

189 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

190 
D©um
::
I64
(1),

194 
SŒšg
::
äom
("data4"),

195 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

196 
D©um
::
I64
(2),

200 
SŒšg
::
äom
("data5"),

201 
D©um
::
By‹s
(
b
"Çme:0".
to_vec
()),

202 
D©um
::
I64
(6),

206 
SŒšg
::
äom
("data6"),

207 
D©um
::
By‹s
(
b
"Çme:0".
to_vec
()),

208 
D©um
::
I64
(4),

212 
SŒšg
::
äom
("data7"),

213 
D©um
::
By‹s
(
b
"Çme:7".
to_vec
()),

214 
D©um
::
I64
(2),

218 
SŒšg
::
äom
("data8"),

219 
D©um
::
By‹s
(
b
"Çme:8".
to_vec
()),

220 
D©um
::
I64
(2),

224 
SŒšg
::
äom
("data9"),

225 
D©um
::
By‹s
(
b
"Çme:9".
to_vec
()),

226 
D©um
::
I64
(2),

230 
Ët
 
	gexp
 = 
vec
![

233 
SŒšg
::
äom
("data9"),

234 
D©um
::
By‹s
(
b
"Çme:9".
to_vec
()),

235 
D©um
::
I64
(2),

239 
SŒšg
::
äom
("data8"),

240 
D©um
::
By‹s
(
b
"Çme:8".
to_vec
()),

241 
D©um
::
I64
(2),

245 
SŒšg
::
äom
("data7"),

246 
D©um
::
By‹s
(
b
"Çme:7".
to_vec
()),

247 
D©um
::
I64
(2),

251 
SŒšg
::
äom
("data3"),

252 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

253 
D©um
::
I64
(1),

257 
SŒšg
::
äom
("data4"),

258 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

259 
D©um
::
I64
(2),

263 
	ghªdË
, 
	gd©a
, 
	gÇme
, 
	gcouÁ
è
š
 
	g‹¡_d©a
 {

264 
Ët
 
	gob_v®ues
: 
Vec
<
D©um
> = 
vec
![
Çme
, 
couÁ
];

265 
Ët
 
	grow_d©a
 = 
RowCŞsDiù
::
Ãw
(
HashM­
::(), 
d©a
.
što_by‹s
());

266 
	gtİn_h—p


267 .
Œy_add_row
(

268 
hªdË
 
as
 
i64
,

269 
row_d©a
,

270 
ob_v®ues
,

271 
Üd”_cŞs
.
şÚe
(),

272 
ùx
.
şÚe
(),

274 .
unw¿p
();

276 
Ët
 
	g»suÉ
 = 
tİn_h—p
.
što_sÜ‹d_vec
().
unw¿p
();

277 
	gas£¹_eq
!(
	g»suÉ
.
Ën
(), 
	gexp
.len());

278 
	grow
, (
	ghªdË
, 
	g_
, 
	gÇme
, 
	gcouÁ
)è
š
 
	g»suÉ
.
™”
().
z
(
exp
) {

279 
Ët
 
	gexp_key
: 
Vec
<
D©um
> = 
vec
![
Çme
, 
couÁ
];

280 
	gas£¹_eq
!(
	grow
.
	ghªdË
, handle);

281 
	gas£¹_eq
!(
	grow
.
	gkey
, 
	gexp_key
);

285 #[
‹¡
]

286 
â
 
‹¡_tİn_h—p_w™h_cmp_”rÜ
() {

287 
Ët
 
mut
 
	gÜd”_cŞs
 = 
Vec
::
Ãw
();

288 
	gÜd”_cŞs
.
push
(
Ãw_Üd”_by
(0, 
çl£
));

289 
	gÜd”_cŞs
.
push
(
Ãw_Üd”_by
(1, 
Œue
));

290 
Ët
 
	gÜd”_cŞs
 = 
Arc
::
Ãw
(
Üd”_cŞs
);

291 
Ët
 
	gùx
 = 
Arc
::
Ãw
(
Ev®CÚ‹xt
::());

292 
Ët
 
mut
 
	gtİn_h—p
 = 
TİNH—p
::
Ãw
(5).
unw¿p
();

294 
Ët
 
	gob_v®ues1
: 
Vec
<
D©um
> = 
vec
![D©um::
By‹s
(
b
"¯a".
to_vec
()), D©um::
I64
(2)];

295 
Ët
 
	grow_d©a
 = 
RowCŞsDiù
::
Ãw
(
HashM­
::(), 
b
"Çme:1".
to_vec
());

296 
	gtİn_h—p


297 .
Œy_add_row
(

298 0 
as
 
i64
,

299 
row_d©a
,

300 
ob_v®ues1
,

301 
Üd”_cŞs
.
şÚe
(),

302 
ùx
.
şÚe
(),

304 .
unw¿p
();

306 
Ët
 
	gob_v®ues2
: 
Vec
<
D©um
> = 
vec
![D©um::
By‹s
(
b
"¯a".
to_vec
()), D©um::
I64
(3)];

307 
Ët
 
	grow_d©a2
 = 
RowCŞsDiù
::
Ãw
(
HashM­
::(), 
b
"Çme:2".
to_vec
());

308 
	gtİn_h—p


309 .
Œy_add_row
(

310 0 
as
 
i64
,

311 
row_d©a2
,

312 
ob_v®ues2
,

313 
Üd”_cŞs
.
şÚe
(),

314 
ùx
.
şÚe
(),

316 .
unw¿p
();

318 
Ët
 
	gbad_key1
: 
Vec
<
D©um
> = 
vec
![D©um::
I64
(2), D©um::
By‹s
(
b
"¯a".
to_vec
())];

319 
Ët
 
	grow_d©a3
 = 
RowCŞsDiù
::
Ãw
(
HashM­
::(), 
b
"Çme:3".
to_vec
());

321 
	gas£¹
!(

322 
	gtİn_h—p


323 .
Œy_add_row
(

324 0 
as
 
i64
,

325 
row_d©a3
,

326 
bad_key1
,

327 
Üd”_cŞs
.
şÚe
(),

328 
ùx
.
şÚe
()

330 .
is_”r
()

332 
	gas£¹
!(
	gtİn_h—p
.
što_sÜ‹d_vec
().
is_”r
());

336 
pub
 
â
 
g’_bË_d©a
(

337 
tid
: 
i64
,

338 
cis
: &[
CŞumnInfo
],

339 
rows
: &[
Vec
<
D©um
>],

340 è-> 
	gVec
<(Vec<
	gu8
>, Vec<u8>)> {

341 
Ët
 
mut
 
	gkv_d©a
 = 
Vec
::
Ãw
();

342 
Ët
 
	gcŞ_ids
: 
Vec
<
i64
> = 
cis
.
™”
().
m­
(|
c
| c.
g‘_cŞumn_id
()).
cŞËù
();

343 
cŞs
 
š
 
	grows
.
™”
() {

344 
Ët
 
	gcŞ_v®ues
: 
Vec
<
_
> = 
cŞs
.
to_vec
();

345 
Ët
 
	gv®ue
 = 
bË
::
’code_row
(
cŞ_v®ues
, &
cŞ_ids
).
unw¿p
();

346 
Ët
 
mut
 
	gbuf
 = 
vec
![];

347 
	gbuf
.
’code_i64
(
cŞs
[0].
i64
()).
unw¿p
();

348 
Ët
 
	gkey
 = 
bË
::
’code_row_key
(
tid
, &
buf
);

349 
	gkv_d©a
.
push
((
key
, 
v®ue
));

351 
	gkv_d©a


354 #[
‹¡
]

355 
â
 
‹¡_tİn_executÜ
() {

357 
Ët
 
	gtid
 = 1;

358 
Ët
 
	gcis
 = 
vec
![

359 
Ãw_cŞ_šfo
(1, 
ty³s
::
LONG_LONG
),

360 
Ãw_cŞ_šfo
(2, 
ty³s
::
VARCHAR
),

361 
Ãw_cŞ_šfo
(3, 
ty³s
::
NEW_DECIMAL
),

363 
Ët
 
	g¿w_d©a
 = 
vec
![

364 
vec
![

365 
D©um
::
I64
(1),

366 
D©um
::
By‹s
(
b
"a".
to_vec
()),

367 
D©um
::
Dec
(7.
što
()),

369 
	gvec
![

370 
D©um
::
I64
(2),

371 
D©um
::
By‹s
(
b
"b".
to_vec
()),

372 
D©um
::
Dec
(7.
što
()),

374 
	gvec
![

375 
D©um
::
I64
(3),

376 
D©um
::
By‹s
(
b
"b".
to_vec
()),

377 
D©um
::
Dec
(8.
što
()),

379 
	gvec
![

380 
D©um
::
I64
(4),

381 
D©um
::
By‹s
(
b
"d".
to_vec
()),

382 
D©um
::
Dec
(3.
što
()),

384 
	gvec
![

385 
D©um
::
I64
(5),

386 
D©um
::
By‹s
(
b
"f".
to_vec
()),

387 
D©um
::
Dec
(5.
što
()),

389 
	gvec
![

390 
D©um
::
I64
(6),

391 
D©um
::
By‹s
(
b
"e".
to_vec
()),

392 
D©um
::
Dec
(9.
što
()),

394 
	gvec
![

395 
D©um
::
I64
(7),

396 
D©um
::
By‹s
(
b
"f".
to_vec
()),

397 
D©um
::
Dec
(6.
što
()),

400 
Ët
 
	gbË_d©a
 = 
g’_bË_d©a
(
tid
, &
cis
, &
¿w_d©a
);

401 
Ët
 
mut
 
	g‹¡_¡Üe
 = 
Te¡StÜe
::
Ãw
(&
bË_d©a
);

403 
Ët
 
mut
 
	gbË_sÿn
 = 
TabËSÿn
::
Ãw
();

404 
	gbË_sÿn
.
£t_bË_id
(
tid
);

405 
	gbË_sÿn
.
£t_cŞumns
(
R•—‹dF›ld
::
äom_vec
(
cis
.
şÚe
()));

407 
Ët
 
	g¿nge1
 = 
g‘_¿nge
(
tid
, 0, 4);

408 
Ët
 
	g¿nge2
 = 
g‘_¿nge
(
tid
, 5, 10);

409 
Ët
 
	gkey_¿nges
 = 
vec
![
¿nge1
, 
¿nge2
];

411 
Ët
 (
¢­shÙ
, 
¡¬t_ts
èğ
‹¡_¡Üe
.
g‘_¢­shÙ
();

412 
Ët
 
	g¢­
 = 
SÇpshÙStÜe
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

413 
Ët
 
	gts_eù
 = 
TabËSÿnExecutÜ
::
Ãw
(&
bË_sÿn
, 
key_¿nges
, 
¢­
);

416 
Ët
 
mut
 
	gob_vec
 = 
Vec
::
w™h_ÿ·c™y
(2);

417 
	gob_vec
.
push
(
Ãw_Üd”_by
(1, 
çl£
));

418 
	gob_vec
.
push
(
Ãw_Üd”_by
(2, 
Œue
));

419 
Ët
 
mut
 
	gtİn
 = 
TİN
::();

420 
	gtİn
.
£t_Üd”_by
(
R•—‹dF›ld
::
äom_vec
(
ob_vec
));

421 
Ët
 
	glim™
 = 4;

422 
	gtİn
.
£t_lim™
(
lim™
);

424 
Ët
 
mut
 
	gtİn_eù
 = 
TİNExecutÜ
::
Ãw
(

425 
tİn
,

426 
Arc
::
Ãw
(
Ev®CÚ‹xt
::()),

427 
Arc
::
Ãw
(
cis
),

428 
Box
::
Ãw
(
ts_eù
),

429 ).
unw¿p
();

430 
Ët
 
mut
 
	gtİn_rows
 = 
Vec
::
w™h_ÿ·c™y
(
lim™
 
as
 
usize
);

431 
Ët
 
Some
(
row
èğ
tİn_eù
.
Ãxt
().
unw¿p
() {

432 
tİn_rows
.
push
(
row
);

434 
	gas£¹_eq
!(
	gtİn_rows
.
Ën
(), 
lim™
 
as
 
	gusize
);

435 
Ët
 
	gex³ù_row_hªdËs
 = 
vec
![1, 3, 2, 6];

436 
	grow
, 
	ghªdË
è
š
 
	gtİn_rows
.
™”
().
z
(
ex³ù_row_hªdËs
) {

437 
	gas£¹_eq
!(
	grow
.
	ghªdË
, handle);

	@src/coprocessor/dag/expr/arithmetic.rs

14 
u£
 
	g¡d
::{
f64
, 
	gi64
, 
	gu64
};

15 
u£
 
	g¡d
::
bÜrow
::
Cow
;

16 
u£
 
	g¡d
::
İs
::{
Add
, 
	gMul
, 
	gSub
};

17 
u£
 
	gcİroûssÜ
::
codec
::{
mysql
, 
	gD©um
};

18 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
Decim®
, 
	gRes
};

19 
u£
 
	gsu³r
::{
E¼Ü
, 
	gFnC®l
, 
	gResuÉ
, 
	gS‹m’tCÚ‹xt
};

21 
im¶
 
	gFnC®l
 {

22 
pub
 
â
 
¶us_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

23 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

24 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_»®
(
ùx
, 
row
));

25 
Ët
 
	g»s
 = 
lhs
 + 
rhs
;

26 !
	g»s
.
is_fš™e
() {

27  
E¼
(
E¼Ü
::
Ov”æow
);

29 
Ok
(
Some
(
»s
))

32 
pub
 
â
 
	g¶us_decim®
<'a, '
	gb
: 'a>(

34 
ùx
: &
S‹m’tCÚ‹xt
,

35 
	grow
: &'a [Datum],

36 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

37 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

38 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_decim®
(
ùx
, 
row
));

39 
Ët
 
	g»suÉ
: 
ResuÉ
<
Decim®
> = 
lhs
.
add
(&
rhs
).
što
();

40 
	g»suÉ
.
m­
(|
t
| 
Some
(
Cow
::
OwÃd
(t)))

43 
pub
 
â
 
¶us_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

44 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

45 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_št
(
ùx
, 
row
));

46 
Ët
 
	glus
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[0].
g‘_
().
g‘_æag
());

47 
Ët
 
	grus
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[1].
g‘_
().
g‘_æag
());

48 
Ët
 
	g»s
 = 
m©ch
 (
lus
, 
rus
) {

49 (
	gŒue
,rueè=> (
lhs
 
as
 
u64
).
checked_add
(
rhs
‡ u64).
m­
(|
t
|‡ 
i64
),

50 (
	gŒue
, 
	gçl£
è=> 
rhs
 >= 0 {

51 (
lhs
 
as
 
u64
).
checked_add
(
rhs
‡ u64).
m­
(|
t
|‡ 
i64
)

53 (
lhs
 
as
 
u64
)

54 .
checked_sub
(
rhs
.
ov”æowšg_Ãg
().0 
as
 
u64
)

55 .
m­
(|
t
| 
as
 
i64
)

57 (
	gçl£
, 
	gŒue
è=> 
lhs
 >= 0 {

58 (
lhs
 
as
 
u64
).
checked_add
(
rhs
‡ u64).
m­
(|
t
|‡ 
i64
)

60 (
rhs
 
as
 
u64
)

61 .
checked_sub
(
lhs
.
ov”æowšg_Ãg
().0 
as
 
u64
)

62 .
m­
(|
t
| 
as
 
i64
)

64 (
	gçl£
, f®£è=> 
lhs
.
checked_add
(
rhs
),

66 
	g»s
.
ok_Ü
(
E¼Ü
::
Ov”æow
).
m­
(
Some
)

69 
pub
 
â
 
mšus_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

70 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

71 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_»®
(
ùx
, 
row
));

72 
Ët
 
	g»s
 = 
lhs
 - 
rhs
;

73 !
	g»s
.
is_fš™e
() {

74  
E¼
(
E¼Ü
::
Ov”æow
);

76 
Ok
(
Some
(
»s
))

79 
pub
 
â
 
	gmšus_decim®
<'a, '
	gb
: 'a>(

81 
ùx
: &
S‹m’tCÚ‹xt
,

82 
	grow
: &'a [Datum],

83 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

84 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

85 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_decim®
(
ùx
, 
row
));

86 
Ët
 
	g»suÉ
: 
ResuÉ
<
Decim®
> = 
lhs
.
sub
(&
rhs
).
što
();

87 
	g»suÉ
.
m­
(
Cow
::
OwÃd
).m­(
Some
)

90 
pub
 
â
 
mšus_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

91 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

92 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_št
(
ùx
, 
row
));

93 
Ët
 
	glus
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[0].
g‘_
().
g‘_æag
());

94 
Ët
 
	grus
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[1].
g‘_
().
g‘_æag
());

95 
Ët
 
	g»s
 = 
m©ch
 (
lus
, 
rus
) {

96 (
	gŒue
,rueè=> (
lhs
 
as
 
u64
).
checked_sub
(
rhs
‡ u64).
m­
(|
t
|‡ 
i64
),

97 (
	gŒue
, 
	gçl£
è=> 
rhs
 >= 0 {

98 (
lhs
 
as
 
u64
).
checked_sub
(
rhs
‡ u64).
m­
(|
t
|‡ 
i64
)

100 (
lhs
 
as
 
u64
)

101 .
checked_add
(
rhs
.
ov”æowšg_Ãg
().0 
as
 
u64
)

102 .
m­
(|
t
| 
as
 
i64
)

104 (
	gçl£
, 
	gŒue
è=> 
lhs
 >= 0 {

105 (
lhs
 
as
 
u64
).
checked_sub
(
rhs
‡ u64).
m­
(|
t
|‡ 
i64
)

107  
E¼
(
E¼Ü
::
Ov”æow
);

109 (
	gçl£
, f®£è=> 
lhs
.
checked_sub
(
rhs
),

111 
	g»s
.
ok_Ü
(
E¼Ü
::
Ov”æow
).
m­
(
Some
)

114 
pub
 
â
 
muÉly_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

115 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

116 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_»®
(
ùx
, 
row
));

117 
Ët
 
	g»s
 = 
lhs
 * 
rhs
;

118 !
	g»s
.
is_fš™e
() {

119  
E¼
(
E¼Ü
::
Ov”æow
);

121 
Ok
(
Some
(
»s
))

124 
pub
 
â
 
	gmuÉly_decim®
<'a, '
	gb
: 'a>(

126 
ùx
: &
S‹m’tCÚ‹xt
,

127 
	grow
: &'a [Datum],

128 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

129 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

130 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_decim®
(
ùx
, 
row
));

131 
Ët
 
	g»suÉ
: 
ResuÉ
<
Decim®
> = 
lhs
.
mul
(&
rhs
).
što
();

132 
	g»suÉ
.
m­
(
Cow
::
OwÃd
).m­(
Some
)

135 
pub
 
â
 
muÉly_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

136 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

137 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_št
(
ùx
, 
row
));

138 
Ët
 
	glus
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[0].
g‘_
().
g‘_æag
());

139 
Ët
 
	grus
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[1].
g‘_
().
g‘_æag
());

140 
Ët
 
	gu64_mul_i64
 = |
u
, 
	gs
| s >= 0 {

141 (
u
 
as
 
u64
).
checked_mul
(
s
‡ u64).
m­
(|
t
|‡ 
i64
)

143 
NÚe


145 
Ët
 
	g»s
 = 
m©ch
 (
lus
, 
rus
) {

146 (
	gŒue
,rueè=> (
lhs
 
as
 
u64
).
checked_mul
(
rhs
‡ u64).
m­
(|
t
|‡ 
i64
),

147 (
	gçl£
, f®£è=> 
lhs
.
checked_mul
(
rhs
),

148 (
	gŒue
, 
	gçl£
è=> 
u64_mul_i64
(
lhs
, 
rhs
),

149 (
	gçl£
, 
	gŒue
è=> 
u64_mul_i64
(
rhs
, 
lhs
),

151 
	g»s
.
ok_Ü
(
E¼Ü
::
Ov”æow
).
m­
(
Some
)

154 
pub
 
â
 
divide_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

155 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

156 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_»®
(
ùx
, 
row
));

157 
	grhs
 == 0f64 {

158  
Ok
(
NÚe
);

160 
Ët
 
	g»s
 = 
lhs
 / 
rhs
;

161 
	g»s
.
is_šfš™e
() {

162 
E¼
(
E¼Ü
::
Ov”æow
)

164 
Ok
(
Some
(
»s
))

168 
pub
 
â
 
divide_decim®
<'a, '
b
: 'a>(

170 
ùx
: &
S‹m’tCÚ‹xt
,

171 
	grow
: &'a [Datum],

172 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

173 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

174 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_decim®
(
ùx
, 
row
));

175 
m©ch
 
	glhs
.
što_owÃd
(è/ 
	grhs
.
	$što_owÃd
() {

176 
	`Some
(
v
è=> 
m©ch
 v {

177 
Res
::
	`Ok
(
v
è=> Ok(
	`Some
(
Cow
::
	`OwÃd
(v))),

178 
Res
::
	`Trunÿ‹d
(
_
è| Res::
	`Ov”æow
(_è=> 
	`E¼
(
E¼Ü
::
Ov”æow
),

180 
NÚe
 => 
	`Ok
(None),

181 
	}
}

185 #[
cfg
(
‹¡
)]

186 
mod
 
	g‹¡
 {

187 
u£
 
	g¡d
::{
f64
, 
	gi64
, 
	gu64
};

188 
u£
 
	gtb
::
ex´essiÚ
::
SÿÏrFuncSig
;

189 
u£
 
	gcİroûssÜ
::
codec
::{
mysql
, 
	gD©um
};

190 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
ty³s
;

191 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::{
Ex´essiÚ
, 
	gS‹m’tCÚ‹xt
};

192 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
‹¡
::{
check_ov”æow
, 
	gâÿÎ_ex´
, 
	g¡r2dec
};

193 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::
d©um_ex´
;

195 #[
‹¡
]

196 
â
 
‹¡_¬™hm‘ic_št
() {

197 
Ët
 
	g‹¡s
 = 
vec
![

199 
SÿÏrFuncSig
::
PlusIÁ
,

200 
D©um
::
NuÎ
,

201 
D©um
::
I64
(1),

202 
D©um
::
NuÎ
,

205 
SÿÏrFuncSig
::
PlusIÁ
,

206 
D©um
::
I64
(1),

207 
D©um
::
NuÎ
,

208 
D©um
::
NuÎ
,

211 
SÿÏrFuncSig
::
PlusIÁ
,

212 
D©um
::
I64
(12),

213 
D©um
::
I64
(1),

214 
D©um
::
I64
(13),

217 
SÿÏrFuncSig
::
PlusIÁ
,

218 
D©um
::
I64
(
i64
::
MIN
),

219 
D©um
::
U64
(
i64
::
MAX
 
as
 
u64
 + 1),

220 
D©um
::
U64
(0),

223 
SÿÏrFuncSig
::
MšusIÁ
,

224 
D©um
::
I64
(12),

225 
D©um
::
I64
(1),

226 
D©um
::
I64
(11),

229 
SÿÏrFuncSig
::
MšusIÁ
,

230 
D©um
::
U64
(0),

231 
D©um
::
I64
(
i64
::
MIN
),

232 
D©um
::
U64
(
i64
::
MAX
 
as
 
u64
 + 1),

235 
SÿÏrFuncSig
::
MuÉlyIÁ
,

236 
D©um
::
I64
(12),

237 
D©um
::
I64
(1),

238 
D©um
::
I64
(12),

241 
SÿÏrFuncSig
::
MuÉlyIÁ
,

242 
D©um
::
I64
(
i64
::
MIN
),

243 
D©um
::
I64
(1),

244 
D©um
::
I64
(
i64
::
MIN
),

247 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

248 
‰
 
š
 
	g‹¡s
 {

249 
Ët
 
	glhs
 = 
d©um_ex´
(
‰
.1);

250 
Ët
 
	grhs
 = 
d©um_ex´
(
‰
.2);

252 
Ët
 
	glus
 = 
mysql
::
has_unsigÃd_æag
(
lhs
.
g‘_f›ld_ty³
().
g‘_æag
());

253 
Ët
 
	grus
 = 
mysql
::
has_unsigÃd_æag
(
rhs
.
g‘_f›ld_ty³
().
g‘_æag
());

254 
Ët
 ğ
lus
 | 
rus
;

256 
Ët
 
mut
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
‰
.0, &[
lhs
, 
rhs
])).
unw¿p
();

259 
	gİ
.
mut_
().
£t_æag
(
ty³s
::
UNSIGNED_FLAG
 
as
 
u32
);

262 
Ët
 
	ggÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

263 
	gas£¹_eq
!(
	ggÙ
, 
	g‰
.3);

267 #[
‹¡
]

268 
â
 
‹¡_¬™hm‘ic_»®
() {

269 
Ët
 
	g‹¡s
 = 
vec
![

271 
SÿÏrFuncSig
::
PlusR—l
,

272 
D©um
::
F64
(1.01001),

273 
D©um
::
F64
(-0.01),

274 
D©um
::
F64
(1.00001),

277 
SÿÏrFuncSig
::
MšusR—l
,

278 
D©um
::
F64
(1.01001),

279 
D©um
::
F64
(-0.01),

280 
D©um
::
F64
(1.02001),

283 
SÿÏrFuncSig
::
MuÉlyR—l
,

284 
D©um
::
F64
(1.01001),

285 
D©um
::
F64
(-0.01),

286 
D©um
::
F64
(-0.0101001),

289 
SÿÏrFuncSig
::
DivideR—l
,

290 
D©um
::
F64
(2.0),

291 
D©um
::
F64
(0.3),

292 
D©um
::
F64
(6.666666666666667),

295 
SÿÏrFuncSig
::
DivideR—l
,

296 
D©um
::
F64
(44.3),

297 
D©um
::
F64
(0.000),

298 
D©um
::
NuÎ
,

301 
SÿÏrFuncSig
::
DivideR—l
,

302 
D©um
::
NuÎ
,

303 
D©um
::
F64
(1.0),

304 
D©um
::
NuÎ
,

307 
SÿÏrFuncSig
::
DivideR—l
,

308 
D©um
::
F64
(1.0),

309 
D©um
::
NuÎ
,

310 
D©um
::
NuÎ
,

325 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

326 
‰
 
š
 
	g‹¡s
 {

327 
Ët
 
	glhs
 = 
d©um_ex´
(
‰
.1);

328 
Ët
 
	grhs
 = 
d©um_ex´
(
‰
.2);

330 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
‰
.0, &[
lhs
, 
rhs
])).
unw¿p
();

331 
Ët
 
	ggÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

332 
	gas£¹_eq
!(
	ggÙ
, 
	g‰
.3);

336 #[
‹¡
]

337 
â
 
‹¡_¬™hm‘ic_decim®
() {

338 
Ët
 
	g‹¡s
 = 
vec
![

340 
SÿÏrFuncSig
::
PlusDecim®
,

341 
¡r2dec
("1.1"),

342 
¡r2dec
("2.2"),

343 
¡r2dec
("3.3"),

346 
SÿÏrFuncSig
::
MšusDecim®
,

347 
¡r2dec
("1.1"),

348 
¡r2dec
("2.2"),

349 
¡r2dec
("-1.1"),

352 
SÿÏrFuncSig
::
MuÉlyDecim®
,

353 
¡r2dec
("1.1"),

354 
¡r2dec
("2.2"),

355 
¡r2dec
("2.42"),

358 
SÿÏrFuncSig
::
DivideDecim®
,

359 
¡r2dec
("12.3"),

360 
¡r2dec
("-0.3"),

361 
¡r2dec
("-41"),

364 
SÿÏrFuncSig
::
DivideDecim®
,

365 
¡r2dec
("12.3"),

366 
¡r2dec
("0.3"),

367 
¡r2dec
("41"),

370 
SÿÏrFuncSig
::
DivideDecim®
,

371 
¡r2dec
("12.3"),

372 
¡r2dec
("0"),

373 
D©um
::
NuÎ
,

376 
SÿÏrFuncSig
::
DivideDecim®
,

377 
D©um
::
NuÎ
,

378 
¡r2dec
("123"),

379 
D©um
::
NuÎ
,

382 
SÿÏrFuncSig
::
DivideDecim®
,

383 
¡r2dec
("123"),

384 
D©um
::
NuÎ
,

385 
D©um
::
NuÎ
,

388 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

389 
‰
 
š
 
	g‹¡s
 {

390 
Ët
 
	glhs
 = 
d©um_ex´
(
‰
.1);

391 
Ët
 
	grhs
 = 
d©um_ex´
(
‰
.2);

393 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
‰
.0, &[
lhs
, 
rhs
])).
unw¿p
();

394 
Ët
 
	ggÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

395 
	gas£¹_eq
!(
	ggÙ
, 
	g‰
.3);

399 #[
‹¡
]

400 
â
 
‹¡_¬™hm‘ic_ov”æow_št
() {

401 
Ët
 
	g‹¡s
 = 
vec
![

403 
SÿÏrFuncSig
::
PlusIÁ
,

404 
D©um
::
I64
(
i64
::
MAX
),

405 
D©um
::
I64
(
i64
::
MAX
),

408 
SÿÏrFuncSig
::
PlusIÁ
,

409 
D©um
::
I64
(
i64
::
MIN
),

410 
D©um
::
I64
(
i64
::
MIN
),

412 (
SÿÏrFuncSig
::
PlusIÁ
, 
D©um
::
I64
(-2), D©um::
U64
(1)),

413 (
SÿÏrFuncSig
::
PlusIÁ
, 
D©um
::
U64
(1), D©um::
I64
(-2)),

415 
SÿÏrFuncSig
::
MšusIÁ
,

416 
D©um
::
I64
(
i64
::
MIN
),

417 
D©um
::
I64
(
i64
::
MAX
),

420 
SÿÏrFuncSig
::
MšusIÁ
,

421 
D©um
::
I64
(
i64
::
MAX
),

422 
D©um
::
I64
(
i64
::
MIN
),

424 (
SÿÏrFuncSig
::
MšusIÁ
, 
D©um
::
I64
(-1), D©um::
U64
(2)),

425 (
SÿÏrFuncSig
::
MšusIÁ
, 
D©um
::
U64
(1), D©um::
I64
(2)),

427 
SÿÏrFuncSig
::
MuÉlyIÁ
,

428 
D©um
::
I64
(
i64
::
MIN
),

429 
D©um
::
I64
(
i64
::
MAX
),

432 
SÿÏrFuncSig
::
MuÉlyIÁ
,

433 
D©um
::
U64
(
u64
::
MAX
),

434 
D©um
::
I64
(
i64
::
MAX
),

437 
SÿÏrFuncSig
::
MuÉlyIÁ
,

438 
D©um
::
I64
(
i64
::
MIN
),

439 
D©um
::
U64
(1),

442 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

443 
‰
 
š
 
	g‹¡s
 {

444 
Ët
 
	glhs
 = 
d©um_ex´
(
‰
.1);

445 
Ët
 
	grhs
 = 
d©um_ex´
(
‰
.2);

447 
Ët
 
	glus
 = 
mysql
::
has_unsigÃd_æag
(
lhs
.
g‘_f›ld_ty³
().
g‘_æag
());

448 
Ët
 
	grus
 = 
mysql
::
has_unsigÃd_æag
(
rhs
.
g‘_f›ld_ty³
().
g‘_æag
());

449 
Ët
 ğ
lus
 | 
rus
;

451 
Ët
 
mut
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
‰
.0, &[
lhs
, 
rhs
])).
unw¿p
();

454 
	gİ
.
mut_
().
£t_æag
(
ty³s
::
UNSIGNED_FLAG
 
as
 
u32
);

457 
Ët
 
	ggÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p_”r
();

458 
	gas£¹
!(
check_ov”æow
(
gÙ
).
is_ok
());

462 #[
‹¡
]

463 
â
 
‹¡_¬™hm‘ic_ov”æow_»®
() {

464 
Ët
 
	g‹¡s
 = 
vec
![

466 
SÿÏrFuncSig
::
PlusR—l
,

467 
D©um
::
F64
(
f64
::
MAX
),

468 
D©um
::
F64
(
f64
::
MAX
),

471 
SÿÏrFuncSig
::
MšusR—l
,

472 
D©um
::
F64
(
f64
::
MIN
),

473 
D©um
::
F64
(
f64
::
MAX
),

476 
SÿÏrFuncSig
::
MuÉlyR—l
,

477 
D©um
::
F64
(
f64
::
MIN
),

478 
D©um
::
F64
(
f64
::
MAX
),

481 
SÿÏrFuncSig
::
DivideR—l
,

482 
D©um
::
F64
(
f64
::
MAX
),

483 
D©um
::
F64
(0.00001),

486 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

487 
‰
 
š
 
	g‹¡s
 {

488 
Ët
 
	glhs
 = 
d©um_ex´
(
‰
.1);

489 
Ët
 
	grhs
 = 
d©um_ex´
(
‰
.2);

491 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
‰
.0, &[
lhs
, 
rhs
])).
unw¿p
();

492 
Ët
 
	ggÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p_”r
();

493 
	gas£¹
!(
check_ov”æow
(
gÙ
).
is_ok
());

	@src/coprocessor/dag/expr/builtin_cast.rs

14 
u£
 
	g¡d
::{
¡r
, 
	gi64
, 
	gu64
};

15 
u£
 
	g¡d
::
ascii
::
AsciiExt
;

16 
u£
 
	g¡d
::
bÜrow
::
Cow
;

18 
u£
 
	gcİroûssÜ
::
codec
::{
mysql
, 
	gD©um
};

19 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
ch¬£t
, 
	gty³s
, 
	gDecim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gRes
, 
	gTime
};

20 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
decim®
::
RoundMode
;

21 
u£
 
	gcİroûssÜ
::
codec
::
cÚv”t
::{
£lf
, 
	gcÚv”t_æßt_to_št
, 
	gcÚv”t_æßt_to_ušt
};

23 
u£
 
	gsu³r
::{
FnC®l
, 
	gResuÉ
, 
	gS‹m’tCÚ‹xt
};

25 
im¶
 
	gFnC®l
 {

26 
pub
 
â
 
ÿ¡_št_as_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

27 
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
)

30 
pub
 
â
 
ÿ¡_»®_as_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

31 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

32 
	gmysql
::
has_unsigÃd_æag
(
£lf
.

.
g‘_æag
(è
as
 
u64
) {

33 
Ët
 
uv®
 = 
cÚv”t_æßt_to_ušt
(
v®
, 
u64
::
MAX
, 
ty³s
::
DOUBLE
)?;

34 
Ok
(
Some
(
uv®
 
as
 
i64
))

36 
Ët
 
	g»s
 = 
cÚv”t_æßt_to_št
(
v®
, 
i64
::
MIN
, i64::
MAX
, 
ty³s
::
DOUBLE
)?;

37 
Ok
(
Some
(
»s
))

41 
pub
 
â
 
ÿ¡_decim®_as_št
(

42 &
£lf
,

43 
ùx
: &
S‹m’tCÚ‹xt
,

44 
row
: &[
D©um
],

45 è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

46 
Ët
 
	gv®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

47 
Ët
 
	gv®
 = 
v®
.
što_owÃd
().
round
(0, 
RoundMode
::
H®fEv’
).
unw¿p
();

48 
	gmysql
::
has_unsigÃd_æag
(
£lf
.

.
g‘_æag
(è
as
 
u64
) {

49 
Ët
 
ušt
 = 
v®
.
as_u64
().
unw¿p
();

51 
Ok
(
Some
(
ušt
 
as
 
i64
))

53 
Ët
 
	gv®
 = 
v®
.
as_i64
().
unw¿p
();

55 
Ok
(
Some
(
v®
))

59 
pub
 
â
 
ÿ¡_¡r_as_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

60 
£lf
.
chd»n
[0].
is_hybrid_ty³
() {

61  
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
);

63 
Ët
 
	gv®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_¡ršg
(
ùx
, 
row
));

64 
Ët
 
	gis_Ãg©ive
 = 
m©ch
 
v®
.
™”
().
sk_whe
(|
x
| x.
is_ascii_wh™e¥aû
()).
Ãxt
() {

65 
Some
(&
b
'-'è=> 
Œue
,

66 
	g_
 => 
çl£
,

68 
	gis_Ãg©ive
 {

70 
Ët
 
	gv
 = 
cÚv”t
::
by‹s_to_št
(
ùx
, &
v®
)?;

72 
Ok
(
Some
(
v
))

74 
Ët
 
	gurs
 = 
cÚv”t
::
by‹s_to_ušt
(
ùx
, &
v®
)?;

76 
Ok
(
Some
(
urs
 
as
 
i64
))

80 
pub
 
â
 
ÿ¡_time_as_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

81 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_time
(
ùx
, 
row
));

82 
Ët
 
	gdec
 = 
v®
.
to_decim®
()?;

83 
Ët
 
	gdec
 = 
dec
.
round
(
mysql
::
DEFAULT_FSP
 
as
 
i8
, 
RoundMode
::
H®fEv’
)

84 .
unw¿p
();

85 
Ët
 
	g»s
 = 
dec
.
as_i64
().
unw¿p
();

86 
Ok
(
Some
(
»s
))

89 
pub
 
â
 
ÿ¡_du¿tiÚ_as_št
(

90 &
£lf
,

91 
ùx
: &
S‹m’tCÚ‹xt
,

92 
row
: &[
D©um
],

93 è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

94 
Ët
 
	gv®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_du¿tiÚ
(
ùx
, 
row
));

95 
Ët
 
	gdec
 = 
v®
.
to_decim®
()?;

96 
Ët
 
	gdec
 = 
dec
.
round
(
mysql
::
DEFAULT_FSP
 
as
 
i8
, 
RoundMode
::
H®fEv’
)

97 .
unw¿p
();

98 
Ët
 
	g»s
 = 
dec
.
as_i64
().
unw¿p
();

99 
Ok
(
Some
(
»s
))

102 
pub
 
â
 
ÿ¡_jsÚ_as_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

103 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
));

104 
Ët
 
	g»s
 = 
v®
.
ÿ¡_to_št
();

105 
Ok
(
Some
(
»s
))

108 
pub
 
â
 
ÿ¡_št_as_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

109 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

110 !
	gmysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[0].
g‘_
().
g‘_æag
(è
as
 
u64
) {

111 
Ok
(
Some
(
£lf
.
´oduû_æßt_w™h_¥ecif›d_
(
ùx
, 
v®
 
as
 
f64
)?))

113 
Ët
 
	guv®
 = 
v®
 
as
 
u64
;

114 
Ok
(
Some
(

115 
£lf
.
´oduû_æßt_w™h_¥ecif›d_
(
ùx
, 
uv®
 
as
 
f64
)?,

120 
pub
 
â
 
ÿ¡_»®_as_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

121 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

122 
Ok
(
Some
(
£lf
.
´oduû_æßt_w™h_¥ecif›d_
(
ùx
, 
v®
)?))

125 
pub
 
â
 
ÿ¡_decim®_as_»®
(

126 &
£lf
,

127 
ùx
: &
S‹m’tCÚ‹xt
,

128 
row
: &[
D©um
],

129 è-> 
	gResuÉ
<
	gO±iÚ
<
	gf64
>> {

130 
Ët
 
	gv®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

131 
Ët
 
	g»s
 = 
v®
.
as_f64
()?;

132 
Ok
(
Some
(
£lf
.
´oduû_æßt_w™h_¥ecif›d_
(
ùx
, 
»s
)?))

135 
pub
 
â
 
ÿ¡_¡r_as_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

136 
£lf
.
chd»n
[0].
is_hybrid_ty³
() {

137  
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
);

139 
Ët
 
	gv®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_¡ršg
(
ùx
, 
row
));

140 
Ët
 
	g»s
 = 
cÚv”t
::
by‹s_to_f64
(
ùx
, &
v®
)?;

141 
Ok
(
Some
(
£lf
.
´oduû_æßt_w™h_¥ecif›d_
(
ùx
, 
»s
)?))

144 
pub
 
â
 
ÿ¡_time_as_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

145 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_time
(
ùx
, 
row
));

146 
Ët
 
	gv®
 = 
v®
.
to_decim®
()?;

147 
Ët
 
	g»s
 = 
v®
.
as_f64
()?;

148 
Ok
(
Some
(
£lf
.
´oduû_æßt_w™h_¥ecif›d_
(
ùx
, 
»s
)?))

151 
pub
 
â
 
ÿ¡_du¿tiÚ_as_»®
(

152 &
£lf
,

153 
ùx
: &
S‹m’tCÚ‹xt
,

154 
row
: &[
D©um
],

155 è-> 
	gResuÉ
<
	gO±iÚ
<
	gf64
>> {

156 
Ët
 
	gv®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_du¿tiÚ
(
ùx
, 
row
));

157 
Ët
 
	gv®
 = 
v®
.
to_decim®
()?;

158 
Ët
 
	g»s
 = 
v®
.
as_f64
()?;

159 
Ok
(
Some
(
£lf
.
´oduû_æßt_w™h_¥ecif›d_
(
ùx
, 
»s
)?))

162 
pub
 
â
 
ÿ¡_jsÚ_as_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

163 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
));

164 
Ët
 
	gv®
 = 
v®
.
ÿ¡_to_»®
();

165 
Ok
(
Some
(
£lf
.
´oduû_æßt_w™h_¥ecif›d_
(
ùx
, 
v®
)?))

168 
pub
 
â
 
	gÿ¡_št_as_decim®
<'a, '
	gb
: 'a>(

170 
ùx
: &
S‹m’tCÚ‹xt
,

171 
	grow
: &[
D©um
],

172 è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<'a, Decimal>>> {

173 
Ët
 
	gv®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

174 
Ët
 
	gf›ld_ty³
 = &
£lf
.
chd»n
[0].
g‘_
();

175 
Ët
 
	g»s
 = !
mysql
::
has_unsigÃd_æag
(
f›ld_ty³
.
g‘_æag
(è
as
 
u64
) {

176 
Cow
::
OwÃd
(
Decim®
::
äom
(
v®
))

178 
Ët
 
uv®
 = 
v®
 
as
 
u64
;

179 
	gCow
::
OwÃd
(
Decim®
::
äom
(
uv®
))

181 
	g£lf
.
´oduû_dec_w™h_¥ecif›d_
(
ùx
, 
»s
).
m­
(
Some
)

184 
pub
 
â
 
	gÿ¡_»®_as_decim®
<'a, '
	gb
: 'a>(

186 
ùx
: &
S‹m’tCÚ‹xt
,

187 
	grow
: &'a [Datum],

188 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

189 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

190 
Ët
 
	g»s
 = 
Decim®
::
äom_f64
(
v®
)?;

191 
	g£lf
.
´oduû_dec_w™h_¥ecif›d_
(
ùx
, 
Cow
::
OwÃd
(
»s
))

192 .
m­
(
Some
)

195 
pub
 
â
 
ÿ¡_decim®_as_decim®
<'a, '
b
: 'a>(

197 
ùx
: &
S‹m’tCÚ‹xt
,

198 
	grow
: &'a [Datum],

199 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

200 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

201 
	g£lf
.
´oduû_dec_w™h_¥ecif›d_
(
ùx
, 
v®
).
m­
(
Some
)

205 
pub
 
â
 
	gÿ¡_¡r_as_decim®
<'a, '
	gb
: 'a>(

207 
ùx
: &
S‹m’tCÚ‹xt
,

208 
	grow
: &'a [Datum],

209 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

210 
Ët
 
dec
 = 
£lf
.
chd»n
[0].
	$is_hybrid_ty³
() {

211 
Œy_İt
!(
£lf
.
chd»n
[0].
	`ev®_decim®
(
ùx
, 
row
))

212 
	}
} {

213 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_¡ršg
(
ùx
, 
row
));

214 
m©ch
 
	gDecim®
::
äom_by‹s
(&
v®
)? {

215 
Res
::
Ok
(
d
è=> 
Cow
::
OwÃd
(d),

216 
	gRes
::
Trunÿ‹d
(
d
è| 
Res
::
Ov”æow
(d) => {

217 
cÚv”t
::
hªdË_Œunÿ‹
(
ùx
, 
Œue
)?;

218 
	gCow
::
OwÃd
(
d
)

222 
	g£lf
.
´oduû_dec_w™h_¥ecif›d_
(
ùx
, 
dec
).
m­
(
Some
)

225 
pub
 
â
 
	gÿ¡_time_as_decim®
<'a, '
	gb
: 'a>(

227 
ùx
: &
S‹m’tCÚ‹xt
,

228 
	grow
: &'a [Datum],

229 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

230 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_time
(
ùx
, 
row
));

231 
Ët
 
	gdec
 = 
v®
.
to_decim®
()?;

232 
	g£lf
.
´oduû_dec_w™h_¥ecif›d_
(
ùx
, 
Cow
::
OwÃd
(
dec
))

233 .
m­
(
Some
)

236 
pub
 
â
 
ÿ¡_du¿tiÚ_as_decim®
<'a, '
b
: 'a>(

238 
ùx
: &
S‹m’tCÚ‹xt
,

239 
	grow
: &'a [Datum],

240 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

241 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_du¿tiÚ
(
ùx
, 
row
));

242 
Ët
 
	gdec
 = 
v®
.
to_decim®
()?;

243 
	g£lf
.
´oduû_dec_w™h_¥ecif›d_
(
ùx
, 
Cow
::
OwÃd
(
dec
))

244 .
m­
(
Some
)

248 
pub
 
â
 
ÿ¡_jsÚ_as_decim®
<'a, '
b
: 'a>(

250 
ùx
: &
S‹m’tCÚ‹xt
,

251 
	grow
: &'a [Datum],

252 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

253 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
));

254 
Ët
 
	gv®
 = 
v®
.
ÿ¡_to_»®
();

255 
Ët
 
	gdec
 = 
Decim®
::
äom_f64
(
v®
)?;

256 
	g£lf
.
´oduû_dec_w™h_¥ecif›d_
(
ùx
, 
Cow
::
OwÃd
(
dec
))

257 .
m­
(
Some
)

260 
pub
 
â
 
ÿ¡_št_as_¡r
<'a, '
b
: 'a>(

262 
ùx
: &
S‹m’tCÚ‹xt
,

263 
	grow
: &'a [Datum],

264 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

265 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

266 
Ët
 
	gs
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[0].
g‘_
().
	$g‘_æag
(è
as
 
u64
) {

267 
Ët
 
uv®
 = 
v®
 
as
 
u64
;

268 
fÜm©
!("{}", 
uv®
)

269 
	}
} {

270 
	gfÜm©
!("{}", 
	gv®
)

272 
	g£lf
.
´oduû_¡r_w™h_¥ecif›d_
(
ùx
, 
Cow
::
OwÃd
(
s
.
što_by‹s
()))

273 .
m­
(
Some
)

276 
pub
 
â
 
ÿ¡_»®_as_¡r
<'a, '
b
: 'a>(

278 
ùx
: &
S‹m’tCÚ‹xt
,

279 
	grow
: &'a [Datum],

280 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

281 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

282 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	gv®
);

283 
	g£lf
.
´oduû_¡r_w™h_¥ecif›d_
(
ùx
, 
Cow
::
OwÃd
(
s
.
što_by‹s
()))

284 .
m­
(
Some
)

287 
pub
 
â
 
ÿ¡_decim®_as_¡r
<'a, '
b
: 'a>(

289 
ùx
: &
S‹m’tCÚ‹xt
,

290 
	grow
: &'a [Datum],

291 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

292 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

293 
Ët
 
	gs
 = 
v®
.
to_¡ršg
();

294 
	g£lf
.
´oduû_¡r_w™h_¥ecif›d_
(
ùx
, 
Cow
::
OwÃd
(
s
.
što_by‹s
()))

295 .
m­
(
Some
)

298 
pub
 
â
 
ÿ¡_¡r_as_¡r
<'a, '
b
: 'a>(

300 
ùx
: &
S‹m’tCÚ‹xt
,

301 
	grow
: &'a [Datum],

302 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

303 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_¡ršg
(
ùx
, 
row
));

304 
	g£lf
.
´oduû_¡r_w™h_¥ecif›d_
(
ùx
, 
v®
).
m­
(
Some
)

307 
pub
 
â
 
	gÿ¡_time_as_¡r
<'a, '
	gb
: 'a>(

309 
ùx
: &
S‹m’tCÚ‹xt
,

310 
	grow
: &'a [Datum],

311 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

312 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_time
(
ùx
, 
row
));

313 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	gv®
);

314 
	g£lf
.
´oduû_¡r_w™h_¥ecif›d_
(
ùx
, 
Cow
::
OwÃd
(
s
.
što_by‹s
()))

315 .
m­
(
Some
)

319 
pub
 
â
 
ÿ¡_du¿tiÚ_as_¡r
<'a, '
b
: 'a>(

321 
ùx
: &
S‹m’tCÚ‹xt
,

322 
	grow
: &'a [Datum],

323 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

324 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_du¿tiÚ
(
ùx
, 
row
));

325 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	gv®
);

326 
	g£lf
.
´oduû_¡r_w™h_¥ecif›d_
(
ùx
, 
Cow
::
OwÃd
(
s
.
što_by‹s
()))

327 .
m­
(
Some
)

330 
pub
 
â
 
ÿ¡_jsÚ_as_¡r
<'a, '
b
: 'a>(

332 
ùx
: &
S‹m’tCÚ‹xt
,

333 
	grow
: &'a [Datum],

334 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

335 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
));

336 
Ët
 
	gs
 = 
v®
.
to_¡ršg
();

337 
	g£lf
.
´oduû_¡r_w™h_¥ecif›d_
(
ùx
, 
Cow
::
OwÃd
(
s
.
što_by‹s
()))

338 .
m­
(
Some
)

341 
pub
 
â
 
ÿ¡_št_as_time
<'a, '
b
: 'a>(

343 
ùx
: &
S‹m’tCÚ‹xt
,

344 
	grow
: &'a [Datum],

345 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

346 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

347 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	gv®
);

348 
Ok
(
Some
(
£lf
.
´oduû_time_w™h_¡r
(
ùx
, 
s
)?))

351 
pub
 
â
 
	gÿ¡_»®_as_time
<'a, '
	gb
: 'a>(

353 
ùx
: &
S‹m’tCÚ‹xt
,

354 
	grow
: &'a [Datum],

355 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

356 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

357 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	gv®
);

358 
Ok
(
Some
(
£lf
.
´oduû_time_w™h_¡r
(
ùx
, 
s
)?))

361 
pub
 
â
 
	gÿ¡_decim®_as_time
<'a, '
	gb
: 'a>(

363 
ùx
: &
S‹m’tCÚ‹xt
,

364 
	grow
: &'a [Datum],

365 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

366 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

367 
Ët
 
	gs
 = 
v®
.
to_¡ršg
();

368 
Ok
(
Some
(
£lf
.
´oduû_time_w™h_¡r
(
ùx
, 
s
)?))

371 
pub
 
â
 
	gÿ¡_¡r_as_time
<'a, '
	gb
: 'a>(

373 
ùx
: &
S‹m’tCÚ‹xt
,

374 
	grow
: &'a [Datum],

375 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

376 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_¡ršg
(
ùx
, 
row
));

377 
Ët
 
	gs
 = 
SŒšg
::
äom_utf8
(
v®
.
što_owÃd
())?;

378 
Ok
(
Some
(
£lf
.
´oduû_time_w™h_¡r
(
ùx
, 
s
)?))

381 
pub
 
â
 
	gÿ¡_time_as_time
<'a, '
	gb
: 'a>(

383 
ùx
: &
S‹m’tCÚ‹xt
,

384 
	grow
: &'a [Datum],

385 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

386 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_time
(
ùx
, 
row
));

387 
Ët
 
mut
 
	gv®
 = 
v®
.
što_owÃd
();

388 
	gv®
.
round_äac
(
£lf
.

.
	$g‘_decim®
(è
as
 
i8
)?;

390 
v®
.
	`£t_
(
£lf
.

.
	$g‘_
(è
as
 
u8
)?;

391 
	`Ok
(
	`Some
(
Cow
::
	`OwÃd
(
v®
)))

392 
	}
}

394 
pub
 
â
 
ÿ¡_du¿tiÚ_as_time
<'a, '
b
: 'a>(

396 
ùx
: &
S‹m’tCÚ‹xt
,

397 
	grow
: &'a [Datum],

398 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

399 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_du¿tiÚ
(
ùx
, 
row
));

400 
Ët
 
mut
 
	gv®
 = 
Time
::
äom_du¿tiÚ
(&
ùx
.
tz
, 
£lf
.

.
	$g‘_
(è
as
 
u8
, 
v®
.
	`as_»f
())?;

401 
v®
.
	`round_äac
(
£lf
.

.
	$g‘_decim®
(è
as
 
i8
)?;

402 
	`Ok
(
	`Some
(
Cow
::
	`OwÃd
(
v®
)))

403 
	}
}

405 
pub
 
â
 
ÿ¡_jsÚ_as_time
<'a, '
b
: 'a>(

407 
ùx
: &
S‹m’tCÚ‹xt
,

408 
	grow
: &'a [Datum],

409 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

410 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
));

411 
Ët
 
	gs
 = 
v®
.
unquÙe
()?;

412 
Ok
(
Some
(
£lf
.
´oduû_time_w™h_¡r
(
ùx
, 
s
)?))

415 
pub
 
â
 
	gÿ¡_št_as_du¿tiÚ
<'a, '
	gb
: 'a>(

417 
ùx
: &
S‹m’tCÚ‹xt
,

418 
	grow
: &'a [Datum],

419 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

420 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

421 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	gv®
);

422 
Ët
 
	gdur
 = 
Du¿tiÚ
::
·r£
(
s
.
as_by‹s
(), 
£lf
.

.
	$g‘_decim®
(è
as
 
i8
)?;

423 
	`Ok
(
	`Some
(
Cow
::
	`OwÃd
(
dur
)))

424 
	}
}

426 
pub
 
â
 
ÿ¡_»®_as_du¿tiÚ
<'a, '
b
: 'a>(

428 
ùx
: &
S‹m’tCÚ‹xt
,

429 
	grow
: &'a [Datum],

430 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

431 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

432 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	gv®
);

433 
Ët
 
	gdur
 = 
Du¿tiÚ
::
·r£
(
s
.
as_by‹s
(), 
£lf
.

.
	$g‘_decim®
(è
as
 
i8
)?;

434 
	`Ok
(
	`Some
(
Cow
::
	`OwÃd
(
dur
)))

435 
	}
}

437 
pub
 
â
 
ÿ¡_decim®_as_du¿tiÚ
<'a, '
b
: 'a>(

439 
ùx
: &
S‹m’tCÚ‹xt
,

440 
	grow
: &'a [Datum],

441 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

442 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

443 
Ët
 
	gs
 = 
v®
.
to_¡ršg
();

444 
Ët
 
	gdur
 = 
Du¿tiÚ
::
·r£
(
s
.
as_by‹s
(), 
£lf
.

.
	$g‘_decim®
(è
as
 
i8
)?;

445 
	`Ok
(
	`Some
(
Cow
::
	`OwÃd
(
dur
)))

446 
	}
}

448 
pub
 
â
 
ÿ¡_¡r_as_du¿tiÚ
<'a, '
b
: 'a>(

450 
ùx
: &
S‹m’tCÚ‹xt
,

451 
	grow
: &'a [Datum],

452 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

453 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_¡ršg
(
ùx
, 
row
));

454 
Ët
 
	gdur
 = 
Du¿tiÚ
::
·r£
(
v®
.
as_»f
(), 
£lf
.

.
	$g‘_decim®
(è
as
 
i8
)?;

455 
	`Ok
(
	`Some
(
Cow
::
	`OwÃd
(
dur
)))

456 
	}
}

458 
pub
 
â
 
ÿ¡_time_as_du¿tiÚ
<'a, '
b
: 'a>(

460 
ùx
: &
S‹m’tCÚ‹xt
,

461 
	grow
: &'a [Datum],

462 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

463 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_time
(
ùx
, 
row
));

464 
Ët
 
mut
 
	g»s
 = 
v®
.
to_du¿tiÚ
()?;

465 
	g»s
.
round_äac
(
£lf
.

.
	$g‘_decim®
(è
as
 
i8
)?;

466 
	`Ok
(
	`Some
(
Cow
::
	`OwÃd
(
»s
)))

467 
	}
}

469 
pub
 
â
 
ÿ¡_du¿tiÚ_as_du¿tiÚ
<'a, '
b
: 'a>(

471 
ùx
: &
S‹m’tCÚ‹xt
,

472 
	grow
: &'a [Datum],

473 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

474 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_du¿tiÚ
(
ùx
, 
row
));

475 
Ët
 
mut
 
	g»s
 = 
v®
.
što_owÃd
();

476 
	g»s
.
round_äac
(
£lf
.

.
	$g‘_decim®
(è
as
 
i8
)?;

477 
	`Ok
(
	`Some
(
Cow
::
	`OwÃd
(
»s
)))

478 
	}
}

480 
pub
 
â
 
ÿ¡_jsÚ_as_du¿tiÚ
<'a, '
b
: 'a>(

482 
ùx
: &
S‹m’tCÚ‹xt
,

483 
	grow
: &'a [Datum],

484 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

485 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
));

486 
Ët
 
	gs
 = 
v®
.
unquÙe
()?;

488 
Ët
 
	gd
 = 
Du¿tiÚ
::
·r£
(
s
.
as_by‹s
(), 
£lf
.

.
	$g‘_decim®
(è
as
 
i8
)?;

489 
	`Ok
(
	`Some
(
Cow
::
	`OwÃd
(
d
)))

490 
	}
}

492 
pub
 
â
 
ÿ¡_št_as_jsÚ
<'a, '
b
: 'a>(

494 
ùx
: &
S‹m’tCÚ‹xt
,

495 
	grow
: &'a [Datum],

496 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

497 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

498 
Ët
 
	gæag
 = 
£lf
.
chd»n
[0].
g‘_
().
g‘_æag
();

499 
Ët
 
	gj
 = 
mysql
::
	$has_is_boŞ—n_æag
(
æag
) {

500 
JsÚ
::
	`BoŞ—n
(
v®
 != 0)

501 
	}
} 
mysql
::
	$has_unsigÃd_æag
(
æag
) {

502 
JsÚ
::
	`U64
(
v®
 
as
 
u64
)

503 
	}
} {

504 
JsÚ
::
I64
(
v®
)

506 
Ok
(
Some
(
Cow
::
OwÃd
(
j
)))

509 
pub
 
â
 
ÿ¡_»®_as_jsÚ
<'a, '
b
: 'a>(

511 
ùx
: &
S‹m’tCÚ‹xt
,

512 
	grow
: &'a [Datum],

513 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

514 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

515 
Ët
 
	gj
 = 
JsÚ
::
DoubË
(
v®
);

516 
Ok
(
Some
(
Cow
::
OwÃd
(
j
)))

519 
pub
 
â
 
ÿ¡_decim®_as_jsÚ
<'a, '
b
: 'a>(

521 
ùx
: &
S‹m’tCÚ‹xt
,

522 
	grow
: &'a [Datum],

523 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

524 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

525 
Ët
 
	gv®
 = 
v®
.
as_f64
()?;

526 
Ët
 
	gj
 = 
JsÚ
::
DoubË
(
v®
);

527 
Ok
(
Some
(
Cow
::
OwÃd
(
j
)))

530 
pub
 
â
 
ÿ¡_¡r_as_jsÚ
<'a, '
b
: 'a>(

532 
ùx
: &
S‹m’tCÚ‹xt
,

533 
	grow
: &'a [Datum],

534 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

535 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_¡ršg
(
ùx
, 
row
));

536 
Ët
 
	gs
 = 
SŒšg
::
äom_utf8
(
v®
.
što_owÃd
())?;

537 
	gmysql
::
has_·r£_to_jsÚ_æag
(
£lf
.

.
	$g‘_æag
()) {

538 
Ët
 
j
: 
JsÚ
 = 
s
.
	`·r£
()?;

539 
	`Ok
(
	`Some
(
Cow
::
	`OwÃd
(
j
)))

540 
	}
} {

541 
Ok
(
Some
(
Cow
::
OwÃd
(
JsÚ
::
SŒšg
(
s
))))

545 
pub
 
â
 
ÿ¡_time_as_jsÚ
<'a, '
b
: 'a>(

547 
ùx
: &
S‹m’tCÚ‹xt
,

548 
	grow
: &'a [Datum],

549 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

550 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_time
(
ùx
, 
row
));

551 
Ët
 
mut
 
	gv®
 = 
v®
.
što_owÃd
();

552 
	gv®
.
g‘_
(è=ğ
ty³s
::
DATETIME
 || 
v®
.g‘_(è=ğty³s::
TIMESTAMP
 {

553 
v®
.
£t_f¥
(
mysql
::
MAX_FSP
 
as
 
u8
);

555 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	gv®
);

556 
Ok
(
Some
(
Cow
::
OwÃd
(
JsÚ
::
SŒšg
(
s
))))

559 
pub
 
â
 
ÿ¡_du¿tiÚ_as_jsÚ
<'a, '
b
: 'a>(

561 
ùx
: &
S‹m’tCÚ‹xt
,

562 
	grow
: &'a [Datum],

563 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

564 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_du¿tiÚ
(
ùx
, 
row
));

565 
Ët
 
mut
 
	gv®
 = 
v®
.
što_owÃd
();

566 
	gv®
.
	gf¥
 = 
mysql
::
MAX_FSP
 
as
 
u8
;

567 
Ët
 
	gs
 = 
fÜm©
!("{}", 
	gv®
);

568 
Ok
(
Some
(
Cow
::
OwÃd
(
JsÚ
::
SŒšg
(
s
))))

571 
pub
 
â
 
ÿ¡_jsÚ_as_jsÚ
<'a, '
b
: 'a>(

573 
ùx
: &
S‹m’tCÚ‹xt
,

574 
	grow
: &'a [Datum],

575 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

576 
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
)

579 
â
 
	g´oduû_dec_w™h_¥ecif›d_
<'a, '
	gb
: 'a>(

581 
ùx
: &
S‹m’tCÚ‹xt
,

582 
	gv®
: 
Cow
<'a, Decimal>,

583 è-> 
ResuÉ
<
Cow
<'a, Decimal>> {

584 
Ët
 
æ’
 = 
£lf
.

.
g‘_æ’
();

585 
Ët
 
	gdecim®
 = 
£lf
.

.
g‘_decim®
();

586 
	gæ’
 =ğ
cÚv”t
::
UNSPECIFIED_LENGTH
 || 
decim®
 == convert::UNSPECIFIED_LENGTH {

587  
Ok
(
v®
);

589 
Ët
 
	g»s
 = 
v®
.
što_owÃd
().
cÚv”t_to
(
ùx
, 
æ’
 
as
 
u8
, 
decim®
‡s u8)?;

590 
Ok
(
Cow
::
OwÃd
(
»s
))

595 
â
 
´oduû_¡r_w™h_¥ecif›d_
<'a, '
b
: 'a>(

597 
ùx
: &
S‹m’tCÚ‹xt
,

598 
	gs
: 
Cow
<'a, [u8]>,

599 è-> 
ResuÉ
<
Cow
<'a, [u8]>> {

600 
Ët
 
æ’
 = 
£lf
.

.
g‘_æ’
();

601 
Ët
 
	gchs
 = 
£lf
.

.
g‘_ch¬£t
();

602 
	gæ’
 < 0 {

603  
Ok
(
s
);

605 
Ët
 
	gæ’
 = 
æ’
 
as
 
usize
;

608 
	gchs
 =ğ
ch¬£t
::
CHARSET_UTF8
 || 
chs
 =ğch¬£t::
CHARSET_UTF8MB4
 {

609 
Ët
 
Œunÿ‹_šfo
 = {

610 
Ët
 
s
 = 
¡r
::
äom_utf8
(s.
as_»f
())?;

611 
Ët
 
mut
 
	gšdiûs
 = 
s
.
ch¬_šdiûs
().
sk
(
æ’
);

612 
Ët
 
Some
((
Œunÿ‹_pos
, 
_
)èğ
šdiûs
.
Ãxt
() {

613 
Ët
 
ch¬_couÁ
 = 
æ’
 + 1 + 
šdiûs
.
couÁ
();

614 
Some
((
ch¬_couÁ
, 
Œunÿ‹_pos
))

616 
	gNÚe


619 
	gŒunÿ‹_šfo
.
is_nÚe
() {

620  
Ok
(
s
);

622 
Ët
 (
ch¬_couÁ
, 
Œunÿ‹_pos
èğ
Œunÿ‹_šfo
.
unw¿p
();

623 
	gcÚv”t
::
hªdË_Œunÿ‹_as_”rÜ
(
ùx
) {

624  
E¼
(
box_”r
!(

626 
æ’
,

627 
ch¬_couÁ


631 
Ët
 
mut
 
	g»s
 = 
s
.
što_owÃd
();

632 
	gcÚv”t
::
Œunÿ‹_bš¬y
(&
mut
 
»s
, 
Œunÿ‹_pos
 
as
 
isize
);

633  
Ok
(
Cow
::
OwÃd
(
»s
));

636 
	gs
.
Ën
(è> 
	gæ’
 {

637 
	gcÚv”t
::
hªdË_Œunÿ‹_as_”rÜ
(
ùx
) {

638  
E¼
(
box_”r
!(

640 
æ’
,

641 
s
.
Ën
()

644 
Ët
 
mut
 
	g»s
 = 
s
.
što_owÃd
();

645 
	gcÚv”t
::
Œunÿ‹_bš¬y
(&
mut
 
»s
, 
æ’
 
as
 
isize
);

646  
Ok
(
Cow
::
OwÃd
(
»s
));

649 
	g£lf
.
	g
.
g‘_
(è=ğ
ty³s
::
STRING
 
as
 
i32
 && 
s
.
Ën
(è< 
æ’
 {

650 
Ët
 
mut
 
s
 = s.
što_owÃd
();

651 
	gs
.
»size
(
æ’
, 0);

652  
Ok
(
Cow
::
OwÃd
(
s
));

654 
Ok
(
s
)

657 
â
 
´oduû_time_w™h_¡r
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
s
: 
SŒšg
è-> 
ResuÉ
<
Cow
<
Time
>> {

658 
Ët
 
mut
 
t
 = 
Time
::
·r£_d©‘ime
(
s
.
as_»f
(), 
£lf
.

.
g‘_decim®
(è
as
 
i8
, &
ùx
.
tz
)?;

659 
	gt
.
£t_
(
£lf
.

.
g‘_
(è
as
 
u8
)?;

660 
Ok
(
Cow
::
OwÃd
(
t
))

666 
â
 
´oduû_æßt_w™h_¥ecif›d_
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
f
: 
f64
è-> 
ResuÉ
<f64> {

667 
Ët
 
æ’
 = 
£lf
.

.
g‘_æ’
();

668 
Ët
 
	gdecim®
 = 
£lf
.

.
g‘_decim®
();

669 
	gæ’
 =ğ
cÚv”t
::
UNSPECIFIED_LENGTH
 || 
decim®
 == convert::UNSPECIFIED_LENGTH {

670  
Ok
(
f
);

672 
m©ch
 
	gcÚv”t
::
Œunÿ‹_f64
(
f
, 
æ’
 
as
 
u8
, 
decim®
‡s u8) {

673 
	gRes
::
Ok
(
d
) => Ok(d),

674 
	gRes
::
Ov”æow
(
d
è| 
Res
::
Trunÿ‹d
(d) => {

676 
cÚv”t
::
hªdË_Œunÿ‹
(
ùx
, 
Œue
)?;

677 
Ok
(
d
)

683 #[
cfg
(
‹¡
)]

684 
mod
 
	g‹¡
 {

685 
u£
 
	g¡d
::
u64
;

687 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gF›ldTy³
, 
	gSÿÏrFuncSig
};

689 
u£
 
	gchrÚo
::{
FixedOff£t
, 
	gUtc
};

691 
u£
 
	gcİroûssÜ
::
codec
::{
cÚv”t
, 
	gD©um
};

692 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
£lf
, 
	gch¬£t
, 
	gty³s
, 
	gDecim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gTime
};

693 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::{
Ex´essiÚ
, 
	gS‹m’tCÚ‹xt
};

694 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
‹¡
::
âÿÎ_ex´
;

695 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::
cŞ_ex´
 
as
 
ba£_cŞ_ex´
;

697 
pub
 
â
 
cŞ_ex´
(
cŞ_id
: 
i64
, 

: 
i32
è-> 
Ex´
 {

698 
Ët
 
mut
 
ex´
 = 
ba£_cŞ_ex´
(
cŞ_id
);

699 
Ët
 
mut
 
	gå
 = 
F›ldTy³
::
Ãw
();

700 
	gå
.
£t_
(

);

701 
	gex´
.
£t_f›ld_ty³
(
å
);

702 
	gex´


705 #[
‹¡
]

706 
â
 
‹¡_ÿ¡_as_št
() {

707 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

708 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

709 
Ët
 
	gt
 = 
Time
::
·r£_utc_d©‘ime
("2012-12-12 12:00:23", 0).
unw¿p
();

710 #[
®low
(
šcÚsi¡’t_dig™_groupšg
)]

711 
Ët
 
	gtime_št
 = 2012
_12_12_12_00_23i64
;

712 
Ët
 
	gdu¿tiÚ_t
 = 
Du¿tiÚ
::
·r£
(
b
"12:00:23", 0).
unw¿p
();

713 
Ët
 
	gÿ£s
 = 
vec
![

715 
SÿÏrFuncSig
::
Ca¡IÁAsIÁ
,

716 
ty³s
::
LONG_LONG
,

717 
Some
(
ty³s
::
UNSIGNED_FLAG
),

718 
vec
![
D©um
::
U64
(1)],

722 
	gSÿÏrFuncSig
::
Ca¡IÁAsIÁ
,

723 
	gty³s
::
LONG_LONG
,

724 
	gNÚe
,

725 
	gvec
![
D©um
::
I64
(-1)],

729 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsIÁ
,

730 
	gty³s
::
STRING
,

731 
	gNÚe
,

732 
	gvec
![
D©um
::
By‹s
(
b
"1".
to_vec
())],

736 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsIÁ
,

737 
	gty³s
::
STRING
,

738 
	gNÚe
,

739 
	gvec
![
D©um
::
By‹s
(
b
"-123".
to_vec
())],

743 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsIÁ
,

744 
	gty³s
::
STRING
,

745 
	gNÚe
,

746 
	gvec
![
D©um
::
By‹s
(
b
"18446744073709551615".
to_vec
())],

747 
	gu64
::
MAX
 
as
 
i64
,

750 
	gSÿÏrFuncSig
::
Ca¡R—lAsIÁ
,

751 
	gty³s
::
DOUBLE
,

752 
	gNÚe
,

753 
	gvec
![
D©um
::
F64
(1f64)],

757 
	gSÿÏrFuncSig
::
Ca¡R—lAsIÁ
,

758 
	gty³s
::
DOUBLE
,

759 
	gNÚe
,

760 
	gvec
![
D©um
::
F64
(1234.000)],

764 
	gSÿÏrFuncSig
::
Ca¡TimeAsIÁ
,

765 
	gty³s
::
DATETIME
,

766 
	gNÚe
,

767 
	gvec
![
D©um
::
Time
(
t
)],

768 
	gtime_št
,

771 
	gSÿÏrFuncSig
::
Ca¡Du¿tiÚAsIÁ
,

772 
	gty³s
::
DURATION
,

773 
	gNÚe
,

774 
	gvec
![
D©um
::
Dur
(
du¿tiÚ_t
)],

778 
	gSÿÏrFuncSig
::
Ca¡JsÚAsIÁ
,

779 
	gty³s
::
JSON
,

780 
	gNÚe
,

781 
	gvec
![
D©um
::
JsÚ
(JsÚ::
I64
(-1))],

785 
	gSÿÏrFuncSig
::
Ca¡JsÚAsIÁ
,

786 
	gty³s
::
JSON
,

787 
	gNÚe
,

788 
	gvec
![
D©um
::
JsÚ
(JsÚ::
U64
(1))],

792 
	gSÿÏrFuncSig
::
Ca¡Decim®AsIÁ
,

793 
	gty³s
::
NEW_DECIMAL
,

794 
	gNÚe
,

795 
	gvec
![
D©um
::
Dec
(
Decim®
::
äom
(1))],

800 
Ët
 
	gnuÎ_cŞs
 = 
vec
![
D©um
::
NuÎ
];

801 
	gsig
, 
	g
, 
	gæag
, 
	gcŞ
, 
	gex³ù
è
š
 
	gÿ£s
 {

802 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 

 
as
 
i32
);

803 
Ët
 
mut
 
	gexp
 = 
âÿÎ_ex´
(
sig
, &[
cŞ_ex´
]);

804 
	gæag
.
is_some
() {

805 
	gexp
.
mut_f›ld_ty³
().
£t_æag
(
æag
.
unw¿p
(è
as
 
u32
);

807 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
exp
).
unw¿p
();

808 
Ët
 
	g»s
 = 
e
.
ev®_št
(&
ùx
, &
cŞ
).
unw¿p
();

809 
	gas£¹_eq
!(
	g»s
.
unw¿p
(), 
	gex³ù
);

811 
Ët
 
	g»s
 = 
e
.
ev®_št
(&
ùx
, &
nuÎ_cŞs
).
unw¿p
();

812 
	gas£¹
!(
	g»s
.
is_nÚe
());

816 #[
‹¡
]

817 
â
 
‹¡_ÿ¡_as_»®
() {

818 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

819 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

820 
Ët
 
	gt
 = 
Time
::
·r£_utc_d©‘ime
("2012-12-12 12:00:23", 0).
unw¿p
();

821 #[
®low
(
šcÚsi¡’t_dig™_groupšg
)]

822 
Ët
 
	gšt_t
 = 2012
_12_12_12_00_23u64
;

823 
Ët
 
	gdu¿tiÚ_t
 = 
Du¿tiÚ
::
·r£
(
b
"12:00:23", 0).
unw¿p
();

824 
Ët
 
	gÿ£s
 = 
vec
![

826 
SÿÏrFuncSig
::
Ca¡IÁAsR—l
,

827 
ty³s
::
LONG_LONG
,

828 
vec
![
D©um
::
I64
(1)],

829 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

830 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

834 
	gSÿÏrFuncSig
::
Ca¡IÁAsR—l
,

835 
	gty³s
::
LONG_LONG
,

836 
	gvec
![
D©um
::
I64
(1234)],

842 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsR—l
,

843 
	gty³s
::
STRING
,

844 
	gvec
![
D©um
::
By‹s
(
b
"1".
to_vec
())],

845 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

846 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

850 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsR—l
,

851 
	gty³s
::
STRING
,

852 
	gvec
![
D©um
::
By‹s
(
b
"1234".
to_vec
())],

858 
	gSÿÏrFuncSig
::
Ca¡R—lAsR—l
,

859 
	gty³s
::
DOUBLE
,

860 
	gvec
![
D©um
::
F64
(1f64)],

861 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

862 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

866 
	gSÿÏrFuncSig
::
Ca¡R—lAsR—l
,

867 
	gty³s
::
DOUBLE
,

868 
	gvec
![
D©um
::
F64
(1234.123)],

874 
	gSÿÏrFuncSig
::
Ca¡TimeAsR—l
,

875 
	gty³s
::
DATETIME
,

876 
	gvec
![
D©um
::
Time
(
t
.
şÚe
())],

877 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

878 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

879 
št_t
 
as
 
	gf64
,

882 
	gSÿÏrFuncSig
::
Ca¡TimeAsR—l
,

883 
	gty³s
::
DATETIME
,

884 
	gvec
![
D©um
::
Time
(
t
)],

887 
	gfÜm©
!("{}.0", 
	gšt_t
).
	g·r£
::<
f64
>().
unw¿p
(),

890 
	gSÿÏrFuncSig
::
Ca¡Du¿tiÚAsR—l
,

891 
	gty³s
::
DURATION
,

892 
	gvec
![
D©um
::
Dur
(
du¿tiÚ_t
.
şÚe
())],

893 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

894 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

898 
	gSÿÏrFuncSig
::
Ca¡Du¿tiÚAsR—l
,

899 
	gty³s
::
DURATION
,

900 
	gvec
![
D©um
::
Dur
(
du¿tiÚ_t
)],

906 
	gSÿÏrFuncSig
::
Ca¡JsÚAsR—l
,

907 
	gty³s
::
JSON
,

908 
	gvec
![
D©um
::
JsÚ
(JsÚ::
I64
(1))],

909 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

910 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

914 
	gSÿÏrFuncSig
::
Ca¡JsÚAsR—l
,

915 
	gty³s
::
JSON
,

916 
	gvec
![
D©um
::
JsÚ
(JsÚ::
I64
(1))],

922 
	gSÿÏrFuncSig
::
Ca¡Decim®AsR—l
,

923 
	gty³s
::
NEW_DECIMAL
,

924 
	gvec
![
D©um
::
Dec
(
Decim®
::
äom
(1))],

925 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

926 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

930 
	gSÿÏrFuncSig
::
Ca¡Decim®AsR—l
,

931 
	gty³s
::
NEW_DECIMAL
,

932 
	gvec
![
D©um
::
Dec
(
Decim®
::
äom
(1))],

939 
Ët
 
	gnuÎ_cŞs
 = 
vec
![
D©um
::
NuÎ
];

940 
	gsig
, 
	g
, 
	gcŞ
, 
	gæ’
, 
	gdecim®
, 
	gex³ù
è
š
 
	gÿ£s
 {

941 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 

 
as
 
i32
);

942 
Ët
 
mut
 
	gexp
 = 
âÿÎ_ex´
(
sig
, &[
cŞ_ex´
]);

943 
	gexp
.
mut_f›ld_ty³
().
£t_æ’
(
æ’
 
as
 
i32
);

944 
	gexp
.
mut_f›ld_ty³
().
£t_decim®
(
decim®
 
as
 
i32
);

945 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
exp
).
unw¿p
();

946 
Ët
 
	g»s
 = 
e
.
ev®_»®
(&
ùx
, &
cŞ
).
unw¿p
();

947 
	gas£¹_eq
!(
	gfÜm©
!("{}", 
	g»s
.
unw¿p
()), fÜm©!("{}", 
	gex³ù
));

949 
Ët
 
	g»s
 = 
e
.
ev®_»®
(&
ùx
, &
nuÎ_cŞs
).
unw¿p
();

950 
	gas£¹
!(
	g»s
.
is_nÚe
());

954 #[
‹¡
]

955 
â
 
‹¡_ÿ¡_as_decim®
() {

956 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

957 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

958 
Ët
 
	gt
 = 
Time
::
·r£_utc_d©‘ime
("2012-12-12 12:00:23", 0).
unw¿p
();

959 
Ët
 
	gšt_t
 = 20121212120023u64;

960 
Ët
 
	gdu¿tiÚ_t
 = 
Du¿tiÚ
::
·r£
(
b
"12:00:23", 0).
unw¿p
();

961 
Ët
 
	gÿ£s
 = 
vec
![

963 
SÿÏrFuncSig
::
Ca¡IÁAsDecim®
,

964 
ty³s
::
LONG_LONG
,

965 
vec
![
D©um
::
I64
(1)],

966 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

967 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

968 
	gDecim®
::
äom
(1),

971 
	gSÿÏrFuncSig
::
Ca¡IÁAsDecim®
,

972 
	gty³s
::
LONG_LONG
,

973 
	gvec
![
D©um
::
I64
(1234)],

976 
	gDecim®
::
äom_f64
(1234.000).
unw¿p
(),

979 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsDecim®
,

980 
	gty³s
::
STRING
,

981 
	gvec
![
D©um
::
By‹s
(
b
"1".
to_vec
())],

982 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

983 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

984 
	gDecim®
::
äom
(1),

987 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsDecim®
,

988 
	gty³s
::
STRING
,

989 
	gvec
![
D©um
::
By‹s
(
b
"1234".
to_vec
())],

992 
	gDecim®
::
äom_f64
(1234.000).
unw¿p
(),

995 
	gSÿÏrFuncSig
::
Ca¡R—lAsDecim®
,

996 
	gty³s
::
DOUBLE
,

997 
	gvec
![
D©um
::
F64
(1f64)],

998 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

999 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1000 
	gDecim®
::
äom
(1),

1003 
	gSÿÏrFuncSig
::
Ca¡R—lAsDecim®
,

1004 
	gty³s
::
DOUBLE
,

1005 
	gvec
![
D©um
::
F64
(1234.123)],

1008 
	gDecim®
::
äom_f64
(1234.1230).
unw¿p
(),

1011 
	gSÿÏrFuncSig
::
Ca¡TimeAsDecim®
,

1012 
	gty³s
::
DATETIME
,

1013 
	gvec
![
D©um
::
Time
(
t
.
şÚe
())],

1014 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1015 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1016 
	gDecim®
::
äom
(
št_t
),

1019 
	gSÿÏrFuncSig
::
Ca¡TimeAsDecim®
,

1020 
	gty³s
::
DATETIME
,

1021 
	gvec
![
D©um
::
Time
(
t
)],

1024 
	gfÜm©
!("{}.0", 
	gšt_t
).
	g·r£
::<
Decim®
>().
unw¿p
(),

1027 
	gSÿÏrFuncSig
::
Ca¡Du¿tiÚAsDecim®
,

1028 
	gty³s
::
DURATION
,

1029 
	gvec
![
D©um
::
Dur
(
du¿tiÚ_t
.
şÚe
())],

1030 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1031 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1032 
	gDecim®
::
äom
(120023),

1035 
	gSÿÏrFuncSig
::
Ca¡Du¿tiÚAsDecim®
,

1036 
	gty³s
::
DURATION
,

1037 
	gvec
![
D©um
::
Dur
(
du¿tiÚ_t
)],

1040 
	gDecim®
::
äom_f64
(120023.0).
unw¿p
(),

1043 
	gSÿÏrFuncSig
::
Ca¡JsÚAsDecim®
,

1044 
	gty³s
::
JSON
,

1045 
	gvec
![
D©um
::
JsÚ
(JsÚ::
I64
(1))],

1046 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1047 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1048 
	gDecim®
::
äom
(1),

1051 
	gSÿÏrFuncSig
::
Ca¡JsÚAsDecim®
,

1052 
	gty³s
::
JSON
,

1053 
	gvec
![
D©um
::
JsÚ
(JsÚ::
I64
(1))],

1056 
	gDecim®
::
äom_f64
(1.0).
unw¿p
(),

1059 
	gSÿÏrFuncSig
::
Ca¡Decim®AsDecim®
,

1060 
	gty³s
::
NEW_DECIMAL
,

1061 
	gvec
![
D©um
::
Dec
(
Decim®
::
äom
(1))],

1062 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1063 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1064 
	gDecim®
::
äom
(1),

1067 
	gSÿÏrFuncSig
::
Ca¡Decim®AsDecim®
,

1068 
	gty³s
::
NEW_DECIMAL
,

1069 
	gvec
![
D©um
::
Dec
(
Decim®
::
äom
(1))],

1072 
	gDecim®
::
äom_f64
(1.0).
unw¿p
(),

1076 
Ët
 
	gnuÎ_cŞs
 = 
vec
![
D©um
::
NuÎ
];

1077 
	gsig
, 
	g
, 
	gcŞ
, 
	gæ’
, 
	gdecim®
, 
	gex³ù
è
š
 
	gÿ£s
 {

1078 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 

 
as
 
i32
);

1079 
Ët
 
mut
 
	gexp
 = 
âÿÎ_ex´
(
sig
, &[
cŞ_ex´
]);

1080 
	gexp
.
mut_f›ld_ty³
().
£t_æ’
(
æ’
 
as
 
i32
);

1081 
	gexp
.
mut_f›ld_ty³
().
£t_decim®
(
decim®
 
as
 
i32
);

1082 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
exp
).
unw¿p
();

1083 
Ët
 
	g»s
 = 
e
.
ev®_decim®
(&
ùx
, &
cŞ
).
unw¿p
();

1084 
	gas£¹_eq
!(
	g»s
.
unw¿p
().
što_owÃd
(), 
	gex³ù
);

1086 
Ët
 
	g»s
 = 
e
.
ev®_decim®
(&
ùx
, &
nuÎ_cŞs
).
unw¿p
();

1087 
	gas£¹
!(
	g»s
.
is_nÚe
());

1091 #[
‹¡
]

1092 
â
 
‹¡_ÿ¡_as_¡r
() {

1093 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

1094 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

1095 
Ët
 
	gt_¡r
 = "2012-12-12 12:00:23";

1096 
Ët
 
	gt
 = 
Time
::
·r£_utc_d©‘ime
(
t_¡r
, 0).
unw¿p
();

1097 
Ët
 
	gdur_¡r
 = 
b
"12:00:23";

1098 
Ët
 
	gdu¿tiÚ_t
 = 
Du¿tiÚ
::
·r£
(
dur_¡r
, 0).
unw¿p
();

1099 
Ët
 
	gs
 = "æ‚¨å¥½world";

1100 
Ët
 
	gexp_s
 = "æ‚¨å¥½w";

1101 
Ët
 
	gÿ£s
 = 
vec
![

1103 
SÿÏrFuncSig
::
Ca¡IÁAsSŒšg
,

1104 
ty³s
::
LONG_LONG
,

1105 
ch¬£t
::
CHARSET_UTF8
,

1106 
NÚe
,

1107 
vec
![
D©um
::
I64
(1)],

1108 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1109 
	gb
"1".
to_vec
(),

1112 
	gSÿÏrFuncSig
::
Ca¡IÁAsSŒšg
,

1113 
	gty³s
::
LONG_LONG
,

1114 
	gch¬£t
::
CHARSET_UTF8
,

1115 
	gNÚe
,

1116 
	gvec
![
D©um
::
I64
(1234)],

1118 
	gb
"123".
to_vec
(),

1121 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsSŒšg
,

1122 
	gty³s
::
STRING
,

1123 
	gch¬£t
::
CHARSET_ASCII
,

1124 
Some
(
ty³s
::
STRING
 
as
 
i32
),

1125 
	gvec
![
D©um
::
By‹s
(
b
"1234".
to_vec
())],

1127 
	gb
"1234\0\0".
to_vec
(),

1130 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsSŒšg
,

1131 
	gty³s
::
STRING
,

1132 
	gch¬£t
::
CHARSET_UTF8
,

1133 
	gNÚe
,

1134 
	gvec
![
D©um
::
By‹s
(
s
.
as_by‹s
().
to_vec
())],

1136 
	gexp_s
.
as_by‹s
().
to_vec
(),

1139 
	gSÿÏrFuncSig
::
Ca¡R—lAsSŒšg
,

1140 
	gty³s
::
DOUBLE
,

1141 
	gch¬£t
::
CHARSET_UTF8
,

1142 
	gNÚe
,

1143 
	gvec
![
D©um
::
F64
(1f64)],

1144 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1145 
	gb
"1".
to_vec
(),

1148 
	gSÿÏrFuncSig
::
Ca¡R—lAsSŒšg
,

1149 
	gty³s
::
DOUBLE
,

1150 
	gch¬£t
::
CHARSET_UTF8
,

1151 
	gNÚe
,

1152 
	gvec
![
D©um
::
F64
(1234.123)],

1154 
	gb
"123".
to_vec
(),

1157 
	gSÿÏrFuncSig
::
Ca¡TimeAsSŒšg
,

1158 
	gty³s
::
DATETIME
,

1159 
	gch¬£t
::
CHARSET_UTF8
,

1160 
	gNÚe
,

1161 
	gvec
![
D©um
::
Time
(
t
.
şÚe
())],

1162 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1163 
	gt_¡r
.
as_by‹s
().
to_vec
(),

1166 
	gSÿÏrFuncSig
::
Ca¡TimeAsSŒšg
,

1167 
	gty³s
::
DATETIME
,

1168 
	gch¬£t
::
CHARSET_UTF8
,

1169 
	gNÚe
,

1170 
	gvec
![
D©um
::
Time
(
t
)],

1172 
	gt_¡r
[0..3].
as_by‹s
().
to_vec
(),

1175 
	gSÿÏrFuncSig
::
Ca¡Du¿tiÚAsSŒšg
,

1176 
	gty³s
::
DURATION
,

1177 
	gch¬£t
::
CHARSET_UTF8
,

1178 
	gNÚe
,

1179 
	gvec
![
D©um
::
Dur
(
du¿tiÚ_t
.
şÚe
())],

1180 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1181 
	gdur_¡r
.
to_vec
(),

1184 
	gSÿÏrFuncSig
::
Ca¡Du¿tiÚAsSŒšg
,

1185 
	gty³s
::
DURATION
,

1186 
	gch¬£t
::
CHARSET_UTF8
,

1187 
	gNÚe
,

1188 
	gvec
![
D©um
::
Dur
(
du¿tiÚ_t
)],

1190 
	gdur_¡r
[0..3].
to_vec
(),

1193 
	gSÿÏrFuncSig
::
Ca¡JsÚAsSŒšg
,

1194 
	gty³s
::
JSON
,

1195 
	gch¬£t
::
CHARSET_UTF8
,

1196 
	gNÚe
,

1197 
	gvec
![
D©um
::
JsÚ
(JsÚ::
I64
(1))],

1198 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1199 
	gb
"1".
to_vec
(),

1202 
	gSÿÏrFuncSig
::
Ca¡JsÚAsSŒšg
,

1203 
	gty³s
::
JSON
,

1204 
	gch¬£t
::
CHARSET_UTF8
,

1205 
	gNÚe
,

1206 
	gvec
![
D©um
::
JsÚ
(JsÚ::
I64
(1234))],

1208 
	gb
"12".
to_vec
(),

1211 
	gSÿÏrFuncSig
::
Ca¡Decim®AsSŒšg
,

1212 
	gty³s
::
NEW_DECIMAL
,

1213 
	gch¬£t
::
CHARSET_UTF8
,

1214 
	gNÚe
,

1215 
	gvec
![
D©um
::
Dec
(
Decim®
::
äom
(1))],

1216 
	gcÚv”t
::
UNSPECIFIED_LENGTH
,

1217 
	gb
"1".
to_vec
(),

1220 
	gSÿÏrFuncSig
::
Ca¡Decim®AsSŒšg
,

1221 
	gty³s
::
NEW_DECIMAL
,

1222 
	gch¬£t
::
CHARSET_UTF8
,

1223 
	gNÚe
,

1224 
	gvec
![
D©um
::
Dec
(
Decim®
::
äom
(1234))],

1226 
	gb
"12".
to_vec
(),

1230 
Ët
 
	gnuÎ_cŞs
 = 
vec
![
D©um
::
NuÎ
];

1231 
	gsig
, 
	g
, 
	gch¬£t
, 
	gto_
, 
	gcŞ
, 
	gæ’
, 
	gexp
è
š
 
	gÿ£s
 {

1232 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 

 
as
 
i32
);

1233 
Ët
 
mut
 
	gex
 = 
âÿÎ_ex´
(
sig
, &[
cŞ_ex´
]);

1234 
	gex
.
mut_f›ld_ty³
().
£t_æ’
(
æ’
 
as
 
i32
);

1235 
	gex
.
mut_f›ld_ty³
().
£t_decim®
(
cÚv”t
::
UNSPECIFIED_LENGTH
);

1236 
	gto_
.
is_some
() {

1237 
	gex
.
mut_f›ld_ty³
().
£t_
(
to_
.
unw¿p
());

1239 
	gex
.
mut_f›ld_ty³
().
£t_ch¬£t
(
SŒšg
::
äom
(
ch¬£t
));

1240 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

1241 
Ët
 
	g»s
 = 
e
.
ev®_¡ršg
(&
ùx
, &
cŞ
).
unw¿p
();

1242 
	gas£¹_eq
!(

1243 
	g»s
.
unw¿p
().
što_owÃd
(),

1244 
	gexp
,

1246 
	gsig
,

1247 
	gæ’


1250 
Ët
 
	g»s
 = 
e
.
ev®_¡ršg
(&
ùx
, &
nuÎ_cŞs
).
unw¿p
();

1251 
	gas£¹
!(
	g»s
.
is_nÚe
());

1255 #[
‹¡
]

1256 
â
 
‹¡_ÿ¡_as_time
() {

1257 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

1258 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

1259 
Ët
 
	gtoday
 = 
Utc
::
now
();

1260 
Ët
 
	gt_d©e_¡r
 = 
fÜm©
!("{}", 
	gtoday
.format("%Y-%m-%d"));

1261 
Ët
 
	gt_time_¡r
 = 
fÜm©
!("{}", 
	gtoday
.format("%Y-%m-%d %H:%M:%S"));

1262 
Ët
 
	gt_time
 = 
Time
::
·r£_utc_d©‘ime
(
t_time_¡r
.
as_»f
(), 0).
unw¿p
();

1263 
Ët
 
	gt_d©e
 = {

1264 
Ët
 
mut
 
d©e
 = 
t_time
.
şÚe
();

1265 
	gd©e
.
£t_
(
ty³s
::
DATE
).
unw¿p
();

1266 
	gd©e


1268 
Ët
 
	gt_št
 = 
fÜm©
!("{}", 
	gtoday
.format("%Y%m%d%H%M%S"))

1269 .
	g·r£
::<
u64
>()

1270 .
unw¿p
();

1272 
Ët
 
	gdur_¡r
 = "12:00:23";

1273 
Ët
 
	gdu¿tiÚ_t
 = 
Du¿tiÚ
::
·r£
(
dur_¡r
.
as_by‹s
(), 0).
unw¿p
();

1274 
Ët
 
	gdur_to_time_¡r
 = 
fÜm©
!("{} 12:00:23", 
	gt_d©e_¡r
);

1275 
Ët
 
	gdur_to_time
 = 
Time
::
·r£_utc_d©‘ime
(&
dur_to_time_¡r
, 0).
unw¿p
();

1276 
Ët
 
mut
 
	gdur_to_d©e
 = 
dur_to_time
.
şÚe
();

1277 
	gdur_to_d©e
.
£t_
(
ty³s
::
DATE
).
unw¿p
();

1279 
Ët
 
	gjsÚ_cŞs
 = 
vec
![
D©um
::
JsÚ
(JsÚ::
SŒšg
(
t_time_¡r
.
şÚe
()))];

1280 
Ët
 
	gšt_cŞs
 = 
vec
![
D©um
::
U64
(
t_št
)];

1281 
Ët
 
	g¡r_cŞs
 = 
vec
![
D©um
::
By‹s
(
t_time_¡r
.
as_by‹s
().
to_vec
())];

1282 
Ët
 
	gf64_cŞs
 = 
vec
![
D©um
::
F64
(
t_št
 
as
 
f64
)];

1283 
Ët
 
	gtime_cŞs
 = 
vec
![
D©um
::
Time
(
t_time
.
şÚe
())];

1284 
Ët
 
	gdu¿tiÚ_cŞs
 = 
vec
![
D©um
::
Dur
(
du¿tiÚ_t
)];

1285 
Ët
 
	gdec_cŞs
 = 
vec
![
D©um
::
Dec
(
Decim®
::
äom
(
t_št
))];

1287 
Ët
 
	gÿ£s
 = 
vec
![

1290 
SÿÏrFuncSig
::
Ca¡IÁAsTime
,

1291 
ty³s
::
LONG_LONG
,

1292 &
št_cŞs
,

1293 
mysql
::
UN_SPECIFIED_FSP
,

1294 
ty³s
::
DATETIME
,

1295 &
t_time
,

1299 
SÿÏrFuncSig
::
Ca¡IÁAsTime
,

1300 
ty³s
::
LONG_LONG
,

1301 &
št_cŞs
,

1302 
mysql
::
MAX_FSP
,

1303 
ty³s
::
DATETIME
,

1304 &
t_time
,

1307 
SÿÏrFuncSig
::
Ca¡SŒšgAsTime
,

1308 
ty³s
::
STRING
,

1309 &
¡r_cŞs
,

1310 
mysql
::
UN_SPECIFIED_FSP
,

1311 
ty³s
::
DATETIME
,

1312 &
t_time
,

1316 
SÿÏrFuncSig
::
Ca¡SŒšgAsTime
,

1317 
ty³s
::
STRING
,

1318 &
¡r_cŞs
,

1319 
mysql
::
MAX_FSP
,

1320 
ty³s
::
DATETIME
,

1321 &
t_time
,

1324 
SÿÏrFuncSig
::
Ca¡R—lAsTime
,

1325 
ty³s
::
DOUBLE
,

1326 &
f64_cŞs
,

1327 
mysql
::
UN_SPECIFIED_FSP
,

1328 
ty³s
::
DATETIME
,

1329 &
t_time
,

1333 
SÿÏrFuncSig
::
Ca¡R—lAsTime
,

1334 
ty³s
::
DOUBLE
,

1335 &
f64_cŞs
,

1336 
mysql
::
DEFAULT_FSP
,

1337 
ty³s
::
DATE
,

1338 &
t_d©e
,

1341 
SÿÏrFuncSig
::
Ca¡TimeAsTime
,

1342 
ty³s
::
DATETIME
,

1343 &
time_cŞs
,

1344 
mysql
::
UN_SPECIFIED_FSP
,

1345 
ty³s
::
DATETIME
,

1346 &
t_time
,

1350 
SÿÏrFuncSig
::
Ca¡TimeAsTime
,

1351 
ty³s
::
DATETIME
,

1352 &
time_cŞs
,

1353 
mysql
::
DEFAULT_FSP
,

1354 
ty³s
::
DATE
,

1355 &
t_d©e
,

1358 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsTime
,

1359 
ty³s
::
DURATION
,

1360 &
du¿tiÚ_cŞs
,

1361 
mysql
::
UN_SPECIFIED_FSP
,

1362 
ty³s
::
DATETIME
,

1363 &
dur_to_time
,

1367 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsTime
,

1368 
ty³s
::
DURATION
,

1369 &
du¿tiÚ_cŞs
,

1370 
mysql
::
MAX_FSP
,

1371 
ty³s
::
DATE
,

1372 &
dur_to_d©e
,

1375 
SÿÏrFuncSig
::
Ca¡JsÚAsTime
,

1376 
ty³s
::
JSON
,

1377 &
jsÚ_cŞs
,

1378 
mysql
::
UN_SPECIFIED_FSP
,

1379 
ty³s
::
DATETIME
,

1380 &
t_time
,

1383 
SÿÏrFuncSig
::
Ca¡JsÚAsTime
,

1384 
ty³s
::
JSON
,

1385 &
jsÚ_cŞs
,

1386 
mysql
::
DEFAULT_FSP
,

1387 
ty³s
::
DATE
,

1388 &
t_d©e
,

1391 
SÿÏrFuncSig
::
Ca¡Decim®AsTime
,

1392 
ty³s
::
NEW_DECIMAL
,

1393 &
dec_cŞs
,

1394 
mysql
::
UN_SPECIFIED_FSP
,

1395 
ty³s
::
DATETIME
,

1396 &
t_time
,

1400 
SÿÏrFuncSig
::
Ca¡Decim®AsTime
,

1401 
ty³s
::
NEW_DECIMAL
,

1402 &
dec_cŞs
,

1403 
mysql
::
DEFAULT_FSP
,

1404 
ty³s
::
DATE
,

1405 &
t_d©e
,

1409 
Ët
 
	gnuÎ_cŞs
 = 
vec
![
D©um
::
NuÎ
];

1410 
	gsig
, 
	g
, 
	gcŞ
, 
	gto_f¥
, 
	gto_
, 
	gexp
è
š
 
	gÿ£s
 {

1411 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 

 
as
 
i32
);

1412 
Ët
 
mut
 
	gex
 = 
âÿÎ_ex´
(
sig
, &[
cŞ_ex´
]);

1413 
	gex
.
mut_f›ld_ty³
().
£t_decim®
(
to_f¥
 
as
 
i32
);

1414 
	gex
.
mut_f›ld_ty³
().
£t_
(
to_
 
as
 
i32
);

1415 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

1417 
Ët
 
	g»s
 = 
e
.
ev®_time
(&
ùx
, 
cŞ
).
unw¿p
();

1418 
Ët
 
	gd©a
 = 
»s
.
unw¿p
().
što_owÃd
();

1419 
Ët
 
mut
 
	gex±
 = 
exp
.
şÚe
();

1420 
	gto_f¥
 !ğ
mysql
::
UN_SPECIFIED_FSP
 {

1421 
ex±
.
£t_f¥
(
to_f¥
 
as
 
u8
);

1423 
	gas£¹_eq
!(

1424 
	gd©a
.
to_¡ršg
(),

1425 
	gex±
.
to_¡ršg
(),

1427 
	gsig
,

1428 
	gto_
,

1429 
	gto_f¥
,

1432 
Ët
 
	g»s
 = 
e
.
ev®_time
(&
ùx
, &
nuÎ_cŞs
).
unw¿p
();

1433 
	gas£¹
!(
	g»s
.
is_nÚe
());

1437 #[
‹¡
]

1438 
â
 
‹¡_ÿ¡_as_du¿tiÚ
() {

1439 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

1440 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

1441 
Ët
 
	gtoday
 = 
Utc
::
now
();

1442 
Ët
 
	gt_d©e_¡r
 = 
fÜm©
!("{}", 
	gtoday
.format("%Y-%m-%d"));

1444 
Ët
 
	gdur_¡r
 = "12:00:23";

1445 
Ët
 
	gdur_št
 = 120023u64;

1446 
Ët
 
	gdu¿tiÚ
 = 
Du¿tiÚ
::
·r£
(
dur_¡r
.
as_by‹s
(), 0).
unw¿p
();

1447 
Ët
 
	gdur_to_time_¡r
 = 
fÜm©
!("{} 12:00:23", 
	gt_d©e_¡r
);

1448 
Ët
 
	gdur_to_time
 = 
Time
::
·r£_utc_d©‘ime
(&
dur_to_time_¡r
, 0).
unw¿p
();

1449 
Ët
 
mut
 
	gdur_to_d©e
 = 
dur_to_time
.
şÚe
();

1450 
	gdur_to_d©e
.
£t_
(
ty³s
::
DATE
).
unw¿p
();

1452 
Ët
 
	gjsÚ_cŞs
 = 
vec
![
D©um
::
JsÚ
(JsÚ::
SŒšg
(SŒšg::
äom
(
dur_¡r
)))];

1453 
Ët
 
	gšt_cŞs
 = 
vec
![
D©um
::
U64
(
dur_št
)];

1454 
Ët
 
	g¡r_cŞs
 = 
vec
![
D©um
::
By‹s
(
dur_¡r
.
as_by‹s
().
to_vec
())];

1455 
Ët
 
	gf64_cŞs
 = 
vec
![
D©um
::
F64
(
dur_št
 
as
 
f64
)];

1456 
Ët
 
	gtime_cŞs
 = 
vec
![
D©um
::
Time
(
dur_to_time
)];

1457 
Ët
 
	gdu¿tiÚ_cŞs
 = 
vec
![
D©um
::
Dur
(
du¿tiÚ
.
şÚe
())];

1458 
Ët
 
	gdec_cŞs
 = 
vec
![
D©um
::
Dec
(
Decim®
::
äom
(
dur_št
))];

1460 
Ët
 
	gÿ£s
 = 
vec
![

1463 
SÿÏrFuncSig
::
Ca¡IÁAsDu¿tiÚ
,

1464 
ty³s
::
LONG_LONG
,

1465 &
št_cŞs
,

1466 
mysql
::
UN_SPECIFIED_FSP
,

1467 &
du¿tiÚ
,

1471 
SÿÏrFuncSig
::
Ca¡IÁAsDu¿tiÚ
,

1472 
ty³s
::
LONG_LONG
,

1473 &
št_cŞs
,

1474 
mysql
::
MAX_FSP
,

1475 &
du¿tiÚ
,

1479 
SÿÏrFuncSig
::
Ca¡SŒšgAsDu¿tiÚ
,

1480 
ty³s
::
STRING
,

1481 &
¡r_cŞs
,

1482 
mysql
::
UN_SPECIFIED_FSP
,

1483 &
du¿tiÚ
,

1487 
SÿÏrFuncSig
::
Ca¡SŒšgAsDu¿tiÚ
,

1488 
ty³s
::
STRING
,

1489 &
¡r_cŞs
,

1491 &
du¿tiÚ
,

1495 
SÿÏrFuncSig
::
Ca¡R—lAsDu¿tiÚ
,

1496 
ty³s
::
DOUBLE
,

1497 &
f64_cŞs
,

1498 
mysql
::
UN_SPECIFIED_FSP
,

1499 &
du¿tiÚ
,

1503 
SÿÏrFuncSig
::
Ca¡R—lAsDu¿tiÚ
,

1504 
ty³s
::
DOUBLE
,

1505 &
f64_cŞs
,

1507 &
du¿tiÚ
,

1511 
SÿÏrFuncSig
::
Ca¡TimeAsDu¿tiÚ
,

1512 
ty³s
::
DATETIME
,

1513 &
time_cŞs
,

1514 
mysql
::
UN_SPECIFIED_FSP
,

1515 &
du¿tiÚ
,

1519 
SÿÏrFuncSig
::
Ca¡TimeAsDu¿tiÚ
,

1520 
ty³s
::
DATETIME
,

1521 &
time_cŞs
,

1523 &
du¿tiÚ
,

1526 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsDu¿tiÚ
,

1527 
ty³s
::
DURATION
,

1528 &
du¿tiÚ_cŞs
,

1529 
mysql
::
UN_SPECIFIED_FSP
,

1530 &
du¿tiÚ
,

1534 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsDu¿tiÚ
,

1535 
ty³s
::
DURATION
,

1536 &
du¿tiÚ_cŞs
,

1537 
mysql
::
MAX_FSP
,

1538 &
du¿tiÚ
,

1542 
SÿÏrFuncSig
::
Ca¡JsÚAsDu¿tiÚ
,

1543 
ty³s
::
JSON
,

1544 &
jsÚ_cŞs
,

1545 
mysql
::
UN_SPECIFIED_FSP
,

1546 &
du¿tiÚ
,

1549 
SÿÏrFuncSig
::
Ca¡JsÚAsDu¿tiÚ
,

1550 
ty³s
::
JSON
,

1551 &
jsÚ_cŞs
,

1553 &
du¿tiÚ
,

1557 
SÿÏrFuncSig
::
Ca¡Decim®AsDu¿tiÚ
,

1558 
ty³s
::
NEW_DECIMAL
,

1559 &
dec_cŞs
,

1560 
mysql
::
UN_SPECIFIED_FSP
,

1561 &
du¿tiÚ
,

1565 
SÿÏrFuncSig
::
Ca¡Decim®AsDu¿tiÚ
,

1566 
ty³s
::
NEW_DECIMAL
,

1567 &
dec_cŞs
,

1569 &
du¿tiÚ
,

1573 
Ët
 
	gnuÎ_cŞs
 = 
vec
![
D©um
::
NuÎ
];

1574 
	gsig
, 
	g
, 
	gcŞ
, 
	gto_f¥
, 
	gexp
è
š
 
	gÿ£s
 {

1575 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 

 
as
 
i32
);

1576 
Ët
 
mut
 
	gex
 = 
âÿÎ_ex´
(
sig
, &[
cŞ_ex´
]);

1577 
	gex
.
mut_f›ld_ty³
().
£t_decim®
(
to_f¥
 
as
 
i32
);

1578 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

1579 
Ët
 
	g»s
 = 
e
.
ev®_du¿tiÚ
(&
ùx
, 
cŞ
).
unw¿p
();

1580 
Ët
 
	gd©a
 = 
»s
.
unw¿p
().
što_owÃd
();

1581 
Ët
 
mut
 
	gex±
 = 
exp
.
şÚe
();

1582 
	gto_f¥
 !ğ
mysql
::
UN_SPECIFIED_FSP
 {

1583 
ex±
.
f¥
 = 
to_f¥
 
as
 
u8
;

1585 
	gas£¹_eq
!(

1586 
	gd©a
.
to_¡ršg
(),

1587 
	gex±
.
to_¡ršg
(),

1589 
	gsig
,

1590 
	gto_f¥
,

1593 
Ët
 
	g»s
 = 
e
.
ev®_du¿tiÚ
(&
ùx
, &
nuÎ_cŞs
).
unw¿p
();

1594 
	gas£¹
!(
	g»s
.
is_nÚe
());

1598 #[
‹¡
]

1599 
â
 
‹¡_ÿ¡_št_as_jsÚ
() {

1600 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

1601 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

1602 
Ët
 
	gÿ£s
 = 
vec
![

1604 
Some
(
ty³s
::
UNSIGNED_FLAG
),

1605 
vec
![
D©um
::
U64
(32)],

1606 
Some
(
JsÚ
::
U64
(32)),

1609 
Some
(
ty³s
::
UNSIGNED_FLAG
 |y³s::
IS_BOOLEAN_FLAG
),

1610 
	gvec
![
D©um
::
U64
(1)],

1611 
Some
(
JsÚ
::
BoŞ—n
(
Œue
)),

1614 
Some
(
ty³s
::
UNSIGNED_FLAG
 |y³s::
IS_BOOLEAN_FLAG
),

1615 
	gvec
![
D©um
::
I64
(0)],

1616 
Some
(
JsÚ
::
BoŞ—n
(
çl£
)),

1618 (
	gNÚe
, 
	gvec
![
D©um
::
I64
(-1)], 
Some
(
JsÚ
::I64(-1))),

1619 (
	gNÚe
, 
	gvec
![
D©um
::
NuÎ
], None),

1621 
	gæag
, 
	gcŞs
, 
	gexp
è
š
 
	gÿ£s
 {

1622 
Ët
 
mut
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 
ty³s
::
LONG_LONG
 
as
 
i32
);

1623 
	gæag
.
is_some
() {

1624 
	gcŞ_ex´
.
mut_f›ld_ty³
().
£t_æag
(
æag
.
unw¿p
(è
as
 
u32
);

1626 
Ët
 
	gex
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
Ca¡IÁAsJsÚ
, &[
cŞ_ex´
]);

1627 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

1628 
Ët
 
	g»s
 = 
e
.
ev®_jsÚ
(&
ùx
, &
cŞs
).
unw¿p
();

1629 
	gexp
.
is_nÚe
() {

1630 
	gas£¹
!(
	g»s
.
is_nÚe
());

1633 
	gas£¹_eq
!(
	g»s
.
unw¿p
().
što_owÃd
(), 
	gexp
.unwrap());

1637 #[
‹¡
]

1638 
â
 
‹¡_ÿ¡_»®_as_jsÚ
() {

1639 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

1640 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

1641 
Ët
 
	gÿ£s
 = 
vec
![

1642 (
vec
![
D©um
::
F64
(32.0001)], 
Some
(
JsÚ
::
DoubË
(32.0001))),

1643 (
	gvec
![
D©um
::
NuÎ
], 
	gNÚe
),

1645 
	gcŞs
, 
	gexp
è
š
 
	gÿ£s
 {

1646 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 
ty³s
::
DOUBLE
 
as
 
i32
);

1647 
Ët
 
	gex
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
Ca¡R—lAsJsÚ
, &[
cŞ_ex´
]);

1648 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

1649 
Ët
 
	g»s
 = 
e
.
ev®_jsÚ
(&
ùx
, &
cŞs
).
unw¿p
();

1650 
	gexp
.
is_nÚe
() {

1651 
	gas£¹
!(
	g»s
.
is_nÚe
());

1654 
	gas£¹_eq
!(
	g»s
.
unw¿p
().
što_owÃd
(), 
	gexp
.unwrap());

1658 #[
‹¡
]

1659 
â
 
‹¡_ÿ¡_decim®_as_jsÚ
() {

1660 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

1661 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

1662 
Ët
 
	gÿ£s
 = 
vec
![

1664 
vec
![
D©um
::
Dec
(
Decim®
::
äom_f64
(32.0001).
unw¿p
())],

1665 
Some
(
JsÚ
::
DoubË
(32.0001)),

1667 (
	gvec
![
D©um
::
NuÎ
], 
	gNÚe
),

1669 
	gcŞs
, 
	gexp
è
š
 
	gÿ£s
 {

1670 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 
ty³s
::
NEW_DECIMAL
 
as
 
i32
);

1671 
Ët
 
	gex
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
Ca¡Decim®AsJsÚ
, &[
cŞ_ex´
]);

1673 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

1674 
Ët
 
	g»s
 = 
e
.
ev®_jsÚ
(&
ùx
, &
cŞs
).
unw¿p
();

1675 
	gexp
.
is_nÚe
() {

1676 
	gas£¹
!(
	g»s
.
is_nÚe
());

1679 
	gas£¹_eq
!(
	g»s
.
unw¿p
().
što_owÃd
(), 
	gexp
.unwrap());

1683 #[
‹¡
]

1684 
â
 
‹¡_ÿ¡_¡r_as_jsÚ
() {

1685 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

1686 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

1687 
Ët
 
	gÿ£s
 = 
vec
![

1689 
çl£
,

1690 
vec
![
D©um
::
By‹s
(
b
"[1,2,3]".
to_vec
())],

1691 
Some
(
JsÚ
::
SŒšg
(SŒšg::
äom
("[1,2,3]"))),

1694 
	gŒue
,

1695 
	gvec
![
D©um
::
By‹s
(
b
"[1,2,3]".
to_vec
())],

1696 
Some
(
JsÚ
::
A¼ay
(
vec
![JsÚ::
I64
(1), Json::I64(2), Json::I64(3)])),

1698 (
	gçl£
, 
	gvec
![
D©um
::
NuÎ
], 
	gNÚe
),

1699 (
	gŒue
, 
	gvec
![
D©um
::
NuÎ
], 
	gNÚe
),

1701 
	gby_·r£
, 
	gcŞs
, 
	gexp
è
š
 
	gÿ£s
 {

1702 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 
ty³s
::
STRING
 
as
 
i32
);

1703 
Ët
 
mut
 
	gex
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
Ca¡SŒšgAsJsÚ
, &[
cŞ_ex´
]);

1704 
	gby_·r£
 {

1705 
Ët
 
mut
 
	gæag
 = 
ex
.
g‘_f›ld_ty³
().
g‘_æag
();

1706 
	gæag
 |ğ
ty³s
::
PARSE_TO_JSON_FLAG
 
as
 
u32
;

1707 
	gex
.
mut_f›ld_ty³
().
£t_æag
(
æag
);

1709 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

1710 
Ët
 
	g»s
 = 
e
.
ev®_jsÚ
(&
ùx
, &
cŞs
).
unw¿p
();

1711 
	gexp
.
is_nÚe
() {

1712 
	gas£¹
!(
	g»s
.
is_nÚe
());

1715 
	gas£¹_eq
!(
	g»s
.
unw¿p
().
što_owÃd
(), 
	gexp
.unwrap());

1719 #[
‹¡
]

1720 
â
 
‹¡_ÿ¡_time_as_jsÚ
() {

1721 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

1722 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

1723 
Ët
 
	gtime_¡r
 = "2012-12-12 11:11:11";

1724 
Ët
 
	gd©e_¡r
 = "2012-12-12";

1725 
Ët
 
	gtz
 = 
FixedOff£t
::
—¡
(0);

1726 
Ët
 
	gtime
 = 
Time
::
·r£_utc_d©‘ime
(
time_¡r
, 
mysql
::
DEFAULT_FSP
).
unw¿p
();

1727 
Ët
 
	gtime_¡amp
 = {

1728 
Ët
 
t
 = 
time
.
to_·cked_u64
();

1729 
	gTime
::
äom_·cked_u64
(
t
, 
ty³s
::
TIMESTAMP
, 
mysql
::
DEFAULT_FSP
, &
tz
).
unw¿p
()

1731 
Ët
 
	gd©e
 = {

1732 
Ët
 
mut
 
t
 = 
time
.
şÚe
();

1733 
	gt
.
£t_
(
ty³s
::
DATE
).
unw¿p
();

1734 
	gt


1738 
Ët
 
	gÿ£s
 = 
vec
![

1740 
ty³s
::
DATETIME
,

1741 
vec
![
D©um
::
Time
(
time
)],

1742 
Some
(
JsÚ
::
SŒšg
(
fÜm©
!("{}.000000", 
time_¡r
))),

1745 
	gty³s
::
TIMESTAMP
,

1746 
	gvec
![
D©um
::
Time
(
time_¡amp
)],

1747 
Some
(
JsÚ
::
SŒšg
(
fÜm©
!("{}.000000", 
time_¡r
))),

1750 
	gty³s
::
DATE
,

1751 
	gvec
![
D©um
::
Time
(
d©e
)],

1752 
Some
(
JsÚ
::
SŒšg
(SŒšg::
äom
(
d©e_¡r
))),

1754 (0, 
	gvec
![
D©um
::
NuÎ
], 
	gNÚe
),

1756 
	g
, 
	gcŞs
, 
	gexp
è
š
 
	gÿ£s
 {

1757 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 

 
as
 
i32
);

1758 
Ët
 
	gex
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
Ca¡TimeAsJsÚ
, &[
cŞ_ex´
]);

1759 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

1760 
Ët
 
	g»s
 = 
e
.
ev®_jsÚ
(&
ùx
, &
cŞs
).
unw¿p
();

1761 
	gexp
.
is_nÚe
() {

1762 
	gas£¹
!(
	g»s
.
is_nÚe
());

1765 
	gas£¹_eq
!(
	g»s
.
unw¿p
().
što_owÃd
(), 
	gexp
.unwrap());

1769 #[
‹¡
]

1770 
â
 
‹¡_ÿ¡_du¿tiÚ_as_jsÚ
() {

1771 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

1772 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

1773 
Ët
 
	gdur_¡r
 = "11:12:08";

1774 
Ët
 
	gdur_¡r_ex³ù
 = "11:12:08.000000";

1776 
Ët
 
	gÿ£s
 = 
vec
![

1778 
vec
![
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
dur_¡r
.
as_by‹s
(), 0).
unw¿p
())],

1779 
Some
(
JsÚ
::
SŒšg
(SŒšg::
äom
(
dur_¡r_ex³ù
))),

1781 (
	gvec
![
D©um
::
NuÎ
], 
	gNÚe
),

1783 
	gcŞs
, 
	gexp
è
š
 
	gÿ£s
 {

1784 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 
ty³s
::
STRING
 
as
 
i32
);

1785 
Ët
 
	gex
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsJsÚ
, &[
cŞ_ex´
]);

1786 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

1787 
Ët
 
	g»s
 = 
e
.
ev®_jsÚ
(&
ùx
, &
cŞs
).
unw¿p
();

1788 
	gexp
.
is_nÚe
() {

1789 
	gas£¹
!(
	g»s
.
is_nÚe
());

1792 
	gas£¹_eq
!(
	g»s
.
unw¿p
().
što_owÃd
(), 
	gexp
.unwrap());

1796 #[
‹¡
]

1797 
â
 
‹¡_ÿ¡_jsÚ_as_jsÚ
() {

1798 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

1799 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

1800 
Ët
 
	gÿ£s
 = 
vec
![

1802 
vec
![
D©um
::
JsÚ
(JsÚ::
BoŞ—n
(
Œue
))],

1803 
Some
(
JsÚ
::
BoŞ—n
(
Œue
)),

1805 (
	gvec
![
D©um
::
NuÎ
], 
	gNÚe
),

1807 
	gcŞs
, 
	gexp
è
š
 
	gÿ£s
 {

1808 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0, 
ty³s
::
STRING
 
as
 
i32
);

1809 
Ët
 
	gex
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
Ca¡JsÚAsJsÚ
, &[
cŞ_ex´
]);

1810 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

1811 
Ët
 
	g»s
 = 
e
.
ev®_jsÚ
(&
ùx
, &
cŞs
).
unw¿p
();

1812 
	gexp
.
is_nÚe
() {

1813 
	gas£¹
!(
	g»s
.
is_nÚe
());

1816 
	gas£¹_eq
!(
	g»s
.
unw¿p
().
što_owÃd
(), 
	gexp
.unwrap());

	@src/coprocessor/dag/expr/builtin_control.rs

14 
u£
 
	g¡d
::
bÜrow
::
Cow
;

15 
u£
 
	gsu³r
::{
FnC®l
, 
	gResuÉ
, 
	gS‹m’tCÚ‹xt
};

16 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

17 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
Decim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gTime
};

18 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
Ex´essiÚ
;

20 
â
 
	gif_nuÎ
<
	gF
, 
	gT
>(
	gf
: 
F
è-> 
ResuÉ
<
O±iÚ
<
T
>>

21 
wh”e


22 
F
: 
Fn
(
usize
è-> 
ResuÉ
<
O±iÚ
<
T
>>,

24 
Ët
 
	g¬g0
 = 
f
(0)?;

25 !
	g¬g0
.
is_nÚe
() {

26  
Ok
(
¬g0
);

28 
f
(1)

31 
â
 
	gif_cÚd™iÚ
<
	gF
, 
	gT
>(

32 
	gex´
: &
FnC®l
,

33 
	gùx
: &
S‹m’tCÚ‹xt
,

34 
	grow
: &[
D©um
],

35 
	gf
: 
F
,

36 è-> 
	gResuÉ
<
	gO±iÚ
<
	gT
>>

37 
wh”e


38 
	gF
: 
Fn
(
usize
è-> 
ResuÉ
<
O±iÚ
<
T
>>,

40 
Ët
 
	g¬g0
 = 
ex´
.
chd»n
[0].
ev®_št
(
ùx
, 
row
)?;

41 
	g¬g0
.
m­_Ü
(
çl£
, |
¬g
|‡rg != 0) {

42 
f
(1)

44 
f
(2)

49 
â
 
	gÿ£_wh’
<'a, F, T>(

50 
	gex´
: &'a FnCall,

51 
ùx
: &
S‹m’tCÚ‹xt
,

52 
	grow
: &'a [Datum],

53 
f
: 
F
,

54 è-> 
	gResuÉ
<
	gO±iÚ
<
	gT
>>

55 
wh”e


56 
	gF
: 
Fn
(&'a Expression) -> Result<Option<T>>,

58 
chunk
 
š
 
ex´
.
chd»n
.
chunks
(2) {

59 
chunk
.
Ën
() == 1 {

61  
f
(&
chunk
[0]);

63 
Ët
 
cÚd
 = 
chunk
[0].
ev®_št
(
ùx
, 
row
)?;

64 
cÚd
.
unw¿p_Ü
(0) == 0 {

67  
f
(&
chunk
[1]);

69 
Ok
(
NÚe
)

72 
im¶
 
FnC®l
 {

73 
pub
 
â
 
if_nuÎ_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

74 
if_nuÎ
(|
i
| 
£lf
.
chd»n
[i].
ev®_št
(
ùx
, 
row
))

77 
pub
 
â
 
if_nuÎ_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

78 
if_nuÎ
(|
i
| 
£lf
.
chd»n
[i].
ev®_»®
(
ùx
, 
row
))

81 
pub
 
â
 
if_nuÎ_decim®
<'a, '
b
: 'a>(

83 
ùx
: &
S‹m’tCÚ‹xt
,

84 
row
: &'a [Datum],

85 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

86 
if_nuÎ
(|
i
| 
£lf
.
chd»n
[i].
ev®_decim®
(
ùx
, 
row
))

89 
pub
 
â
 
	gif_nuÎ_¡ršg
<'a, '
	gb
: 'a>(

91 
ùx
: &
S‹m’tCÚ‹xt
,

92 
	grow
: &'a [Datum],

93 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

94 
if_nuÎ
(|
i
| 
£lf
.
chd»n
[i].
ev®_¡ršg
(
ùx
, 
row
))

97 
pub
 
â
 
	gif_nuÎ_time
<'a, '
	gb
: 'a>(

99 
ùx
: &
S‹m’tCÚ‹xt
,

100 
	grow
: &'a [Datum],

101 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

102 
if_nuÎ
(|
i
| 
£lf
.
chd»n
[i].
ev®_time
(
ùx
, 
row
))

105 
pub
 
â
 
	gif_nuÎ_du¿tiÚ
<'a, '
	gb
: 'a>(

107 
ùx
: &
S‹m’tCÚ‹xt
,

108 
	grow
: &'a [Datum],

109 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

110 
if_nuÎ
(|
i
| 
£lf
.
chd»n
[i].
ev®_du¿tiÚ
(
ùx
, 
row
))

113 
pub
 
â
 
	gif_nuÎ_jsÚ
<'a, '
	gb
: 'a>(

115 
ùx
: &
S‹m’tCÚ‹xt
,

116 
	grow
: &'a [Datum],

117 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

118 
if_nuÎ
(|
i
| 
£lf
.
chd»n
[i].
ev®_jsÚ
(
ùx
, 
row
))

121 
pub
 
â
 
if_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

122 
if_cÚd™iÚ
(
£lf
, 
ùx
, 
row
, |
i
| s–f.
chd»n
[i].
ev®_št
(ctx,„ow))

125 
pub
 
â
 
if_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

126 
if_cÚd™iÚ
(
£lf
, 
ùx
, 
row
, |
i
| s–f.
chd»n
[i].
ev®_»®
(ctx,„ow))

129 
pub
 
â
 
	gif_decim®
<'a, '
	gb
: 'a>(

131 
ùx
: &
S‹m’tCÚ‹xt
,

132 
	grow
: &'a [Datum],

133 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

134 
if_cÚd™iÚ
(
£lf
, 
ùx
, 
row
, |
i
| s–f.
chd»n
[i].
ev®_decim®
(ctx,„ow))

137 
pub
 
â
 
	gif_¡ršg
<'a, '
	gb
: 'a>(

139 
ùx
: &
S‹m’tCÚ‹xt
,

140 
	grow
: &'a [Datum],

141 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

142 
if_cÚd™iÚ
(
£lf
, 
ùx
, 
row
, |
i
| s–f.
chd»n
[i].
ev®_¡ršg
(ctx,„ow))

145 
pub
 
â
 
	gif_time
<'a, '
	gb
: 'a>(

147 
ùx
: &
S‹m’tCÚ‹xt
,

148 
	grow
: &'a [Datum],

149 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

150 
if_cÚd™iÚ
(
£lf
, 
ùx
, 
row
, |
i
| s–f.
chd»n
[i].
ev®_time
(ctx,„ow))

153 
pub
 
â
 
	gif_du¿tiÚ
<'a, '
	gb
: 'a>(

155 
ùx
: &
S‹m’tCÚ‹xt
,

156 
	grow
: &'a [Datum],

157 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

158 
if_cÚd™iÚ
(
£lf
, 
ùx
, 
row
, |
i
| s–f.
chd»n
[i].
ev®_du¿tiÚ
(ctx,„ow))

161 
pub
 
â
 
	gif_jsÚ
<'a, '
	gb
: 'a>(

163 
ùx
: &
S‹m’tCÚ‹xt
,

164 
	grow
: &'a [Datum],

165 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

166 
if_cÚd™iÚ
(
£lf
, 
ùx
, 
row
, |
i
| s–f.
chd»n
[i].
ev®_jsÚ
(ctx,„ow))

169 
pub
 
â
 
ÿ£_wh’_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

170 
ÿ£_wh’
(
£lf
, 
ùx
, 
row
, |
v
| v.
ev®_št
(ctx,„ow))

173 
pub
 
â
 
ÿ£_wh’_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

174 
ÿ£_wh’
(
£lf
, 
ùx
, 
row
, |
v
| v.
ev®_»®
(ctx,„ow))

177 
pub
 
â
 
	gÿ£_wh’_decim®
<'a, '
	gb
: 'a>(

179 
ùx
: &
S‹m’tCÚ‹xt
,

180 
	grow
: &'a [Datum],

181 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

182 
ÿ£_wh’
(
£lf
, 
ùx
, 
row
, |
v
| v.
ev®_decim®
(ctx,„ow))

185 
pub
 
â
 
	gÿ£_wh’_¡ršg
<'a, '
	gb
: 'a>(

187 
ùx
: &
S‹m’tCÚ‹xt
,

188 
	grow
: &'a [Datum],

189 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

190 
ÿ£_wh’
(
£lf
, 
ùx
, 
row
, |
v
| v.
ev®_¡ršg
(ctx,„ow))

193 
pub
 
â
 
	gÿ£_wh’_time
<'a, '
	gb
: 'a>(

195 
ùx
: &
S‹m’tCÚ‹xt
,

196 
	grow
: &'a [Datum],

197 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

198 
ÿ£_wh’
(
£lf
, 
ùx
, 
row
, |
v
| v.
ev®_time
(ctx,„ow))

201 
pub
 
â
 
	gÿ£_wh’_du¿tiÚ
<'a, '
	gb
: 'a>(

203 
ùx
: &
S‹m’tCÚ‹xt
,

204 
	grow
: &'a [Datum],

205 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

206 
ÿ£_wh’
(
£lf
, 
ùx
, 
row
, |
v
| v.
ev®_du¿tiÚ
(ctx,„ow))

209 
pub
 
â
 
	gÿ£_wh’_jsÚ
<'a, '
	gb
: 'a>(

211 
ùx
: &
S‹m’tCÚ‹xt
,

212 
	grow
: &'a [Datum],

213 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

214 
ÿ£_wh’
(
£lf
, 
ùx
, 
row
, |
v
| v.
ev®_jsÚ
(ctx,„ow))

218 #[
cfg
(
‹¡
)]

219 
mod
 
	g‹¡
 {

220 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

221 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gEx´Ty³
, 
	gSÿÏrFuncSig
};

223 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

224 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
Du¿tiÚ
, 
	gJsÚ
, 
	gTime
};

225 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::{
Ex´essiÚ
, 
	gS‹m’tCÚ‹xt
};

226 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
‹¡
::{
âÿÎ_ex´
, 
	g¡r2dec
};

227 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::
d©um_ex´
;

228 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::
cŞ_ex´
;

231 #[
‹¡
]

232 
â
 
‹¡_if_nuÎ
() {

233 
Ët
 
	g‹¡s
 = 
vec
![

235 
SÿÏrFuncSig
::
IfNuÎIÁ
,

236 
D©um
::
I64
(0),

237 
D©um
::
I64
(2),

238 
D©um
::
I64
(0),

241 
SÿÏrFuncSig
::
IfNuÎIÁ
,

242 
D©um
::
I64
(1),

243 
D©um
::
I64
(2),

244 
D©um
::
I64
(1),

247 
SÿÏrFuncSig
::
IfNuÎIÁ
,

248 
D©um
::
NuÎ
,

249 
D©um
::
I64
(2),

250 
D©um
::
I64
(2),

253 
SÿÏrFuncSig
::
IfNuÎR—l
,

254 
D©um
::
F64
(0.0),

255 
D©um
::
F64
(2.2),

256 
D©um
::
F64
(0.0),

259 
SÿÏrFuncSig
::
IfNuÎR—l
,

260 
D©um
::
F64
(1.1),

261 
D©um
::
F64
(2.2),

262 
D©um
::
F64
(1.1),

265 
SÿÏrFuncSig
::
IfNuÎR—l
,

266 
D©um
::
NuÎ
,

267 
D©um
::
F64
(2.2),

268 
D©um
::
F64
(2.2),

271 
SÿÏrFuncSig
::
IfNuÎSŒšg
,

272 
D©um
::
By‹s
(
b
"abc".
to_vec
()),

273 
D©um
::
By‹s
(
b
"abd".
to_vec
()),

274 
D©um
::
By‹s
(
b
"abc".
to_vec
()),

277 
SÿÏrFuncSig
::
IfNuÎSŒšg
,

278 
D©um
::
NuÎ
,

279 
D©um
::
By‹s
(
b
"abd".
to_vec
()),

280 
D©um
::
By‹s
(
b
"abd".
to_vec
()),

283 
SÿÏrFuncSig
::
IfNuÎDecim®
,

284 
¡r2dec
("1.123"),

285 
¡r2dec
("2.345"),

286 
¡r2dec
("1.123"),

289 
SÿÏrFuncSig
::
IfNuÎDecim®
,

290 
D©um
::
NuÎ
,

291 
¡r2dec
("2.345"),

292 
¡r2dec
("2.345"),

295 
SÿÏrFuncSig
::
IfNuÎDu¿tiÚ
,

296 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(123, 1).
unw¿p
()),

297 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(345, 2).
unw¿p
()),

298 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(123, 1).
unw¿p
()),

301 
SÿÏrFuncSig
::
IfNuÎDu¿tiÚ
,

302 
D©um
::
NuÎ
,

303 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(345, 2).
unw¿p
()),

304 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(345, 2).
unw¿p
()),

307 
SÿÏrFuncSig
::
IfNuÎTime
,

308 
D©um
::
NuÎ
,

309 
D©um
::
Time
(Time::
·r£_utc_d©‘ime
("1970-01-01 12:00:00", 6).
unw¿p
()),

310 
D©um
::
Time
(Time::
·r£_utc_d©‘ime
("1970-01-01 12:00:00", 6).
unw¿p
()),

313 
SÿÏrFuncSig
::
IfNuÎJsÚ
,

314 
D©um
::
NuÎ
,

315 
D©um
::
JsÚ
(JsÚ::
SŒšg
("h–lo".
to_owÃd
())),

316 
D©um
::
JsÚ
(JsÚ::
SŒšg
("h–lo".
to_owÃd
())),

319 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

320 
	gİ”©Ü
, 
	gb¿nch1
, 
	gb¿nch2
, 
	gexp
è
š
 
	g‹¡s
 {

321 
Ët
 
	g¬g1
 = 
d©um_ex´
(
b¿nch1
);

322 
Ët
 
	g¬g2
 = 
d©um_ex´
(
b¿nch2
);

323 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
İ”©Ü
, &[
¬g1
, 
¬g2
])).
unw¿p
();

324 
Ët
 
	g»s
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

325 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

329 #[
‹¡
]

330 
â
 
‹¡_if
() {

331 
Ët
 
	g‹¡s
 = 
vec
![

333 
SÿÏrFuncSig
::
IfIÁ
,

334 
D©um
::
I64
(1),

335 
D©um
::
I64
(1),

336 
D©um
::
I64
(2),

337 
D©um
::
I64
(1),

340 
SÿÏrFuncSig
::
IfIÁ
,

341 
D©um
::
NuÎ
,

342 
D©um
::
I64
(1),

343 
D©um
::
I64
(2),

344 
D©um
::
I64
(2),

347 
SÿÏrFuncSig
::
IfIÁ
,

348 
D©um
::
I64
(0),

349 
D©um
::
I64
(1),

350 
D©um
::
I64
(2),

351 
D©um
::
I64
(2),

354 
SÿÏrFuncSig
::
IfR—l
,

355 
D©um
::
I64
(1),

356 
D©um
::
F64
(1.1),

357 
D©um
::
F64
(2.2),

358 
D©um
::
F64
(1.1),

361 
SÿÏrFuncSig
::
IfR—l
,

362 
D©um
::
NuÎ
,

363 
D©um
::
F64
(1.1),

364 
D©um
::
F64
(2.2),

365 
D©um
::
F64
(2.2),

368 
SÿÏrFuncSig
::
IfR—l
,

369 
D©um
::
I64
(0),

370 
D©um
::
F64
(1.1),

371 
D©um
::
F64
(2.2),

372 
D©um
::
F64
(2.2),

375 
SÿÏrFuncSig
::
IfSŒšg
,

376 
D©um
::
I64
(1),

377 
D©um
::
By‹s
(
b
"abc".
to_vec
()),

378 
D©um
::
By‹s
(
b
"abd".
to_vec
()),

379 
D©um
::
By‹s
(
b
"abc".
to_vec
()),

382 
SÿÏrFuncSig
::
IfSŒšg
,

383 
D©um
::
NuÎ
,

384 
D©um
::
By‹s
(
b
"abc".
to_vec
()),

385 
D©um
::
By‹s
(
b
"abd".
to_vec
()),

386 
D©um
::
By‹s
(
b
"abd".
to_vec
()),

389 
SÿÏrFuncSig
::
IfSŒšg
,

390 
D©um
::
I64
(0),

391 
D©um
::
By‹s
(
b
"abc".
to_vec
()),

392 
D©um
::
By‹s
(
b
"abd".
to_vec
()),

393 
D©um
::
By‹s
(
b
"abd".
to_vec
()),

396 
SÿÏrFuncSig
::
IfDecim®
,

397 
D©um
::
I64
(1),

398 
¡r2dec
("1.123"),

399 
¡r2dec
("2.345"),

400 
¡r2dec
("1.123"),

403 
SÿÏrFuncSig
::
IfDecim®
,

404 
D©um
::
NuÎ
,

405 
¡r2dec
("1.123"),

406 
¡r2dec
("2.345"),

407 
¡r2dec
("2.345"),

410 
SÿÏrFuncSig
::
IfDecim®
,

411 
D©um
::
I64
(0),

412 
¡r2dec
("1.123"),

413 
¡r2dec
("2.345"),

414 
¡r2dec
("2.345"),

417 
SÿÏrFuncSig
::
IfDu¿tiÚ
,

418 
D©um
::
I64
(1),

419 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(123, 1).
unw¿p
()),

420 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(345, 2).
unw¿p
()),

421 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(123, 1).
unw¿p
()),

424 
SÿÏrFuncSig
::
IfDu¿tiÚ
,

425 
D©um
::
NuÎ
,

426 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(123, 1).
unw¿p
()),

427 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(345, 2).
unw¿p
()),

428 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(345, 2).
unw¿p
()),

431 
SÿÏrFuncSig
::
IfDu¿tiÚ
,

432 
D©um
::
I64
(0),

433 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(123, 1).
unw¿p
()),

434 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(345, 2).
unw¿p
()),

435 
D©um
::
Dur
(
Du¿tiÚ
::
äom_Çnos
(345, 2).
unw¿p
()),

438 
SÿÏrFuncSig
::
IfTime
,

439 
D©um
::
I64
(0),

440 
D©um
::
Time
(Time::
·r£_utc_d©‘ime
("1970-01-01 12:00:00", 6).
unw¿p
()),

441 
D©um
::
Time
(Time::
·r£_utc_d©‘ime
("1971-01-01 12:00:00", 6).
unw¿p
()),

442 
D©um
::
Time
(Time::
·r£_utc_d©‘ime
("1971-01-01 12:00:00", 6).
unw¿p
()),

445 
SÿÏrFuncSig
::
IfJsÚ
,

446 
D©um
::
I64
(0),

447 
D©um
::
JsÚ
(JsÚ::
I64
(300)),

448 
D©um
::
JsÚ
(JsÚ::
SŒšg
("h–lo".
to_owÃd
())),

449 
D©um
::
JsÚ
(JsÚ::
SŒšg
("h–lo".
to_owÃd
())),

452 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

453 
	gİ”©Ü
, 
	gcÚd
, 
	gb¿nch1
, 
	gb¿nch2
, 
	gexp
è
š
 
	g‹¡s
 {

454 
Ët
 
	g¬g1
 = 
d©um_ex´
(
cÚd
);

455 
Ët
 
	g¬g2
 = 
d©um_ex´
(
b¿nch1
);

456 
Ët
 
	g¬g3
 = 
d©um_ex´
(
b¿nch2
);

457 
Ët
 
	gex³ùed
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
d©um_ex´
(
exp
)).
unw¿p
();

458 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
İ”©Ü
, &[
¬g1
, 
¬g2
, 
¬g3
])).
unw¿p
();

459 
Ët
 
	glhs
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

460 
Ët
 
	grhs
 = 
ex³ùed
.
ev®
(&
ùx
, &[]).
unw¿p
();

461 
	gas£¹_eq
!(
	glhs
, 
	grhs
);

465 
â
 
cÚd
(
ok
: 
boŞ
è-> 
D©um
 {

466 
ok
 {

467 
D©um
::
I64
(1)

469 
D©um
::
I64
(0)

473 #[
‹¡
]

474 
â
 
‹¡_ÿ£_wh’
() {

475 
Ët
 
dec1
 = 
D©um
::
Dec
("1.1".
·r£
().
unw¿p
());

476 
Ët
 
	gdec2
 = 
D©um
::
Dec
("2.2".
·r£
().
unw¿p
());

477 
Ët
 
	gdur1
 = 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"01:00:00", 0).
unw¿p
());

478 
Ët
 
	gdur2
 = 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"12:00:12", 0).
unw¿p
());

479 
Ët
 
	gtime1
 = 
D©um
::
Time
(Time::
·r£_utc_d©‘ime
("2012-12-12 12:00:23", 0).
unw¿p
());

480 
Ët
 
	gs
 = "ä½ å¥½".
as_by‹s
().
to_owÃd
();

482 
Ët
 
	gÿ£s
 = 
vec
![

484 
SÿÏrFuncSig
::
Ca£Wh’IÁ
,

485 
vec
![
cÚd
(
Œue
), 
D©um
::
I64
(3), cond(true), Datum::I64(5)],

486 
	gD©um
::
I64
(3),

489 
	gSÿÏrFuncSig
::
Ca£Wh’Decim®
,

490 
	gvec
![
cÚd
(
çl£
), 
dec1
, cÚd(
Œue
), 
dec2
.
şÚe
()],

491 
	gdec2
,

494 
	gSÿÏrFuncSig
::
Ca£Wh’Du¿tiÚ
,

495 
	gvec
![
D©um
::
NuÎ
, 
dur1
, 
cÚd
(
Œue
), 
dur2
.
şÚe
()],

496 
	gdur2
,

498 (
	gSÿÏrFuncSig
::
Ca£Wh’Time
, 
	gvec
![
time1
.
şÚe
()], 
	gtime1
),

500 
	gSÿÏrFuncSig
::
Ca£Wh’R—l
,

501 
	gvec
![
cÚd
(
çl£
), 
D©um
::
NuÎ
],

502 
	gD©um
::
NuÎ
,

505 
	gSÿÏrFuncSig
::
Ca£Wh’SŒšg
,

506 
	gvec
![
cÚd
(
Œue
), 
D©um
::
By‹s
(
s
.
şÚe
())],

507 
	gD©um
::
By‹s
(
s
),

510 
	gSÿÏrFuncSig
::
Ca£Wh’JsÚ
,

511 
	gvec
![

512 
cÚd
(
çl£
),

513 
D©um
::
NuÎ
,

514 
D©um
::
NuÎ
,

515 
D©um
::
NuÎ
,

516 
D©um
::
JsÚ
(JsÚ::
I64
(23)),

518 
	gD©um
::
JsÚ
(JsÚ::
I64
(23)),

522 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

524 
	gsig
, 
	grow
, 
	gexp
è
š
 
	gÿ£s
 {

525 
Ët
 
	gchd»n
: 
Vec
<
Ex´
> = (0..
row
.
Ën
()).
m­
(|
id
| 
cŞ_ex´
(id 
as
 
i64
)).
cŞËù
();

526 
Ët
 
mut
 
	gex´
 = 
Ex´
::
Ãw
();

527 
	gex´
.
£t_
(
Ex´Ty³
::
SÿÏrFunc
);

528 
	gex´
.
£t_sig
(
sig
);

530 
	gex´
.
£t_chd»n
(
R•—‹dF›ld
::
äom_vec
(
chd»n
));

531 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex´
).
unw¿p
();

532 
Ët
 
	g»s
 = 
e
.
ev®
(&
ùx
, &
row
).
unw¿p
();

533 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

	@src/coprocessor/dag/expr/builtin_op.rs

14 
u£
 
	g¡d
::
i64
;

15 
u£
 
	g¡d
::
bÜrow
::
Cow
;

16 
u£
 
	gsu³r
::{
E¼Ü
, 
	gFnC®l
, 
	gResuÉ
, 
	gS‹m’tCÚ‹xt
};

17 
u£
 
	gcİroûssÜ
::
codec
::{
mysql
, 
	gD©um
};

18 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
Decim®
;

20 
im¶
 
	gFnC®l
 {

21 
pub
 
â
 
logiÿl_ªd
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

22 
Ët
 
¬g0
 = 
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
)?;

23 
	g¬g0
.
m­_Ü
(
çl£
, |
v
| v == 0) {

24  
Ok
(
Some
(0));

26 
Ët
 
	g¬g1
 = 
£lf
.
chd»n
[1].
ev®_št
(
ùx
, 
row
)?;

27 
	g¬g1
.
m­_Ü
(
çl£
, |
v
| v == 0) {

28  
Ok
(
Some
(0));

30 
	g¬g0
.
is_nÚe
(è|| 
	g¬g1
.is_none() {

31  
Ok
(
NÚe
);

33 
Ok
(
Some
(1))

36 
pub
 
â
 
logiÿl_Ü
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

37 
Ët
 
¬g0
 = 
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
)?;

38 
	g¬g0
.
m­_Ü
(
çl£
, |
v
| v != 0) {

39  
Ok
(
Some
(1));

41 
Ët
 
	g¬g1
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_št
(
ùx
, 
row
));

42 
	g¬g1
 != 0 {

43 
Ok
(
Some
(1))

45 
Ok
(
¬g0
)

49 
pub
 
â
 
logiÿl_xÜ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

50 
Ët
 
¬g0
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

51 
Ët
 
	g¬g1
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_št
(
ùx
, 
row
));

52 
Ok
(
Some
(((
¬g0
 =ğ0è^ (
¬g1
 =ğ0)è
as
 
i64
))

55 
pub
 
â
 
št_is_Œue
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

56 
Ët
 
v
 = 
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
)?;

57 
Ët
 
	g»t
 = 
v
.
m­_Ü
(0, |v| (v !ğ0è
as
 
i64
);

58 
Ok
(
Some
(
»t
))

61 
pub
 
â
 
»®_is_Œue
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

62 
Ët
 
šput
 = 
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
)?;

63 
Ok
(
Some
(
šput
.
m­_Ü
(0, |
i
| (˜!ğ0f64è
as
 
i64
)))

66 
pub
 
â
 
decim®_is_Œue
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

67 
Ët
 
šput
 = 
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
)?;

68 
Ok
(
Some
(
šput
.
m­_Ü
(0, |
dec
| !dec.
is_z”o
(è
as
 
i64
)))

71 
pub
 
â
 
št_is_çl£
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

72 
Ët
 
šput
 = 
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
)?;

73 
Ok
(
Some
(
šput
.
m­_Ü
(0, |
i
| (˜=ğ0è
as
 
i64
)))

76 
pub
 
â
 
»®_is_çl£
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

77 
Ët
 
v
 = 
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
)?;

78 
Ët
 
	g»t
 = 
v
.
m­_Ü
(0, |v| (v =ğ0f64è
as
 
i64
);

79 
Ok
(
Some
(
»t
))

82 
pub
 
â
 
decim®_is_çl£
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

83 
Ët
 
v
 = 
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
)?;

84 
Ët
 
	g»t
 = 
v
.
m­_Ü
(0, |v| v.
is_z”o
(è
as
 
i64
);

85 
Ok
(
Some
(
»t
))

88 
pub
 
â
 
uÇry_nÙ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

89 
Ët
 
¬g
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

90 
Ok
(
Some
((
¬g
 =ğ0è
as
 
i64
))

93 
pub
 
â
 
uÇry_mšus_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

94 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

95 
	gmysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[0].
g‘_
().
g‘_æag
(è
as
 
u64
) {

96 
Ët
 
uv®
 = 
v®
 
as
 
u64
;

97 
	guv®
 > 
	gi64
::
MAX
 
as
 
u64
 + 1 {

98  
E¼
(
E¼Ü
::
Ov”æow
);

99 } 
	guv®
 =ğ
i64
::
MAX
 
as
 
u64
 + 1 {

100  
Ok
(
Some
(
i64
::
MIN
));

102 } 
	gv®
 =ğ
i64
::
MIN
 {

103  
E¼
(
E¼Ü
::
Ov”æow
);

105 
Ok
(
Some
(-
v®
))

108 
pub
 
â
 
	guÇry_mšus_decim®
<'a, '
	gb
: 'a>(

110 
ùx
: &
S‹m’tCÚ‹xt
,

111 
	grow
: &'a [Datum],

112 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

113 
Ët
 
dec
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
)).
što_owÃd
();

114 
Ok
(
Some
(
Cow
::
OwÃd
(-
dec
)))

117 
pub
 
â
 
uÇry_mšus_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

118 
Ët
 
v®
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

119 
Ok
(
Some
(-
v®
))

122 
pub
 
â
 
decim®_is_nuÎ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

123 
Ët
 
¬g
 = 
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
)?;

124 
Ok
(
Some
(
¬g
.
is_nÚe
(è
as
 
i64
))

127 
pub
 
â
 
št_is_nuÎ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

128 
Ët
 
¬g
 = 
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
)?;

129 
Ok
(
Some
(
¬g
.
is_nÚe
(è
as
 
i64
))

132 
pub
 
â
 
»®_is_nuÎ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

133 
Ët
 
¬g
 = 
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
)?;

134 
Ok
(
Some
(
¬g
.
is_nÚe
(è
as
 
i64
))

137 
pub
 
â
 
¡ršg_is_nuÎ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

138 
Ët
 
¬g
 = 
£lf
.
chd»n
[0].
ev®_¡ršg
(
ùx
, 
row
)?;

139 
Ok
(
Some
(
¬g
.
is_nÚe
(è
as
 
i64
))

142 
pub
 
â
 
time_is_nuÎ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

143 
Ët
 
¬g
 = 
£lf
.
chd»n
[0].
ev®_time
(
ùx
, 
row
)?;

144 
Ok
(
Some
(
¬g
.
is_nÚe
(è
as
 
i64
))

147 
pub
 
â
 
du¿tiÚ_is_nuÎ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

148 
Ët
 
¬g
 = 
£lf
.
chd»n
[0].
ev®_du¿tiÚ
(
ùx
, 
row
)?;

149 
Ok
(
Some
(
¬g
.
is_nÚe
(è
as
 
i64
))

152 
pub
 
â
 
jsÚ_is_nuÎ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

153 
Ët
 
¬g
 = 
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
)?;

154 
Ok
(
Some
(
¬g
.
is_nÚe
(è
as
 
i64
))

157 
pub
 
â
 
b™_ªd
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

158 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

159 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_št
(
ùx
, 
row
));

160 
Ok
(
Some
(
lhs
 & 
rhs
))

163 
pub
 
â
 
b™_Ü
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

164 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

165 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_št
(
ùx
, 
row
));

166 
Ok
(
Some
(
lhs
 | 
rhs
))

169 
pub
 
â
 
b™_xÜ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

170 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

171 
Ët
 
	grhs
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_št
(
ùx
, 
row
));

172 
Ok
(
Some
(
lhs
 ^ 
rhs
))

175 
pub
 
â
 
b™_Ãg
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

176 
Ët
 
lhs
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

177 
Ok
(
Some
(!
lhs
))

181 #[
cfg
(
‹¡
)]

182 
mod
 
	g‹¡
 {

183 
u£
 
	g¡d
::
i64
;

184 
u£
 
	gtb
::
ex´essiÚ
::
SÿÏrFuncSig
;

185 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

186 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
Du¿tiÚ
;

187 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::{
E¼Ü
, 
	gEx´essiÚ
, 
	gS‹m’tCÚ‹xt
};

188 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
‹¡
::{
âÿÎ_ex´
, 
	g¡r2dec
};

189 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::
d©um_ex´
;

191 #[
‹¡
]

192 
â
 
‹¡_logic_İ
() {

193 
Ët
 
	g‹¡s
 = 
vec
![

195 
SÿÏrFuncSig
::
LogiÿlAnd
,

196 
D©um
::
I64
(1),

197 
D©um
::
I64
(1),

198 
Some
(1),

201 
SÿÏrFuncSig
::
LogiÿlAnd
,

202 
D©um
::
I64
(1),

203 
D©um
::
I64
(0),

204 
Some
(0),

207 
SÿÏrFuncSig
::
LogiÿlAnd
,

208 
D©um
::
I64
(0),

209 
D©um
::
I64
(0),

210 
Some
(0),

213 
SÿÏrFuncSig
::
LogiÿlAnd
,

214 
D©um
::
I64
(2),

215 
D©um
::
I64
(-1),

216 
Some
(1),

219 
SÿÏrFuncSig
::
LogiÿlAnd
,

220 
D©um
::
I64
(0),

221 
D©um
::
NuÎ
,

222 
Some
(0),

224 (
SÿÏrFuncSig
::
LogiÿlAnd
, 
D©um
::
NuÎ
, D©um::
I64
(1), 
NÚe
),

226 
SÿÏrFuncSig
::
LogiÿlOr
,

227 
D©um
::
I64
(1),

228 
D©um
::
I64
(1),

229 
Some
(1),

232 
SÿÏrFuncSig
::
LogiÿlOr
,

233 
D©um
::
I64
(1),

234 
D©um
::
I64
(0),

235 
Some
(1),

238 
SÿÏrFuncSig
::
LogiÿlOr
,

239 
D©um
::
I64
(0),

240 
D©um
::
I64
(0),

241 
Some
(0),

244 
SÿÏrFuncSig
::
LogiÿlOr
,

245 
D©um
::
I64
(2),

246 
D©um
::
I64
(-1),

247 
Some
(1),

250 
SÿÏrFuncSig
::
LogiÿlOr
,

251 
D©um
::
I64
(1),

252 
D©um
::
NuÎ
,

253 
Some
(1),

255 (
SÿÏrFuncSig
::
LogiÿlOr
, 
D©um
::
NuÎ
, D©um::
I64
(0), 
NÚe
),

257 
SÿÏrFuncSig
::
LogiÿlXÜ
,

258 
D©um
::
I64
(1),

259 
D©um
::
I64
(1),

260 
Some
(0),

263 
SÿÏrFuncSig
::
LogiÿlXÜ
,

264 
D©um
::
I64
(1),

265 
D©um
::
I64
(0),

266 
Some
(1),

269 
SÿÏrFuncSig
::
LogiÿlXÜ
,

270 
D©um
::
I64
(0),

271 
D©um
::
I64
(0),

272 
Some
(0),

275 
SÿÏrFuncSig
::
LogiÿlXÜ
,

276 
D©um
::
I64
(2),

277 
D©um
::
I64
(-1),

278 
Some
(0),

280 (
SÿÏrFuncSig
::
LogiÿlXÜ
, 
D©um
::
I64
(0), D©um::
NuÎ
, 
NÚe
),

281 (
SÿÏrFuncSig
::
LogiÿlXÜ
, 
D©um
::
NuÎ
, D©um::
I64
(1), 
NÚe
),

283 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

284 
	gİ
, 
	glhs
, 
	grhs
, 
	gexp
è
š
 
	g‹¡s
 {

285 
Ët
 
	g¬g1
 = 
d©um_ex´
(
lhs
);

286 
Ët
 
	g¬g2
 = 
d©um_ex´
(
rhs
);

288 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
İ
, &[
¬g1
.
şÚe
(), 
¬g2
.clone()]))

289 .
unw¿p
();

290 
Ët
 
	g»s
 = 
İ
.
ev®_št
(&
ùx
, &[]).
unw¿p
();

291 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

294 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
İ
, &[
¬g2
, 
¬g1
])).
unw¿p
();

295 
Ët
 
	g»s
 = 
İ
.
ev®_št
(&
ùx
, &[]).
unw¿p
();

296 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

301 #[
‹¡
]

302 
â
 
‹¡_uÇry_mšus_İ
() {

303 
Ët
 
	g‹¡s
 = 
vec
![

305 
SÿÏrFuncSig
::
UÇryMšusIÁ
,

306 
D©um
::
I64
(
i64
::
MAX
),

307 
D©um
::
I64
(-
i64
::
MAX
),

310 
SÿÏrFuncSig
::
UÇryMšusIÁ
,

311 
D©um
::
I64
(-
i64
::
MAX
),

312 
D©um
::
I64
(
i64
::
MAX
),

314 (
SÿÏrFuncSig
::
UÇryMšusIÁ
, 
D©um
::
I64
(0), Datum::I64(0)),

316 
SÿÏrFuncSig
::
UÇryMšusIÁ
,

317 
D©um
::
U64
(
i64
::
MAX
 
as
 
u64
 + 1),

318 
D©um
::
I64
(
i64
::
MIN
),

320 (
SÿÏrFuncSig
::
UÇryMšusIÁ
, 
D©um
::
NuÎ
, Datum::Null),

322 
SÿÏrFuncSig
::
UÇryMšusR—l
,

323 
D©um
::
F64
(0.123),

324 
D©um
::
F64
(-0.123),

327 
SÿÏrFuncSig
::
UÇryMšusR—l
,

328 
D©um
::
F64
(-0.123),

329 
D©um
::
F64
(0.123),

332 
SÿÏrFuncSig
::
UÇryMšusR—l
,

333 
D©um
::
F64
(0.0),

334 
D©um
::
F64
(0.0),

336 (
SÿÏrFuncSig
::
UÇryMšusR—l
, 
D©um
::
NuÎ
, Datum::Null),

337 (
SÿÏrFuncSig
::
UÇryMšusDecim®
, 
¡r2dec
("0"), str2dec("0")),

339 
SÿÏrFuncSig
::
UÇryMšusDecim®
,

340 
¡r2dec
("0.123"),

341 
¡r2dec
("-0.123"),

343 (
SÿÏrFuncSig
::
UÇryMšusDecim®
, 
D©um
::
NuÎ
, Datum::Null),

345 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

346 
	gİ”©Ü
, 
	g¬g
, 
	gexp
è
š
 
	g‹¡s
 {

347 
Ët
 
	g¬g1
 = 
d©um_ex´
(
¬g
);

348 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
İ”©Ü
, &[
¬g1
])).
unw¿p
();

349 
Ët
 
	g»s
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

350 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

354 #[
‹¡
]

355 
â
 
‹¡_uÇry_İ
() {

356 
Ët
 
	g‹¡s
 = 
vec
![

357 (
SÿÏrFuncSig
::
UÇryNÙ
, 
D©um
::
I64
(1), 
Some
(0)),

358 (
SÿÏrFuncSig
::
UÇryNÙ
, 
D©um
::
I64
(0), 
Some
(1)),

359 (
SÿÏrFuncSig
::
UÇryNÙ
, 
D©um
::
I64
(123), 
Some
(0)),

360 (
SÿÏrFuncSig
::
UÇryNÙ
, 
D©um
::
I64
(-123), 
Some
(0)),

361 (
SÿÏrFuncSig
::
UÇryNÙ
, 
D©um
::
NuÎ
, 
NÚe
),

362 (
SÿÏrFuncSig
::
R—lIsTrue
, 
D©um
::
F64
(0.25), 
Some
(1)),

363 (
SÿÏrFuncSig
::
R—lIsTrue
, 
D©um
::
F64
(0.0), 
Some
(0)),

364 (
SÿÏrFuncSig
::
R—lIsTrue
, 
D©um
::
NuÎ
, 
Some
(0)),

365 (
SÿÏrFuncSig
::
R—lIsF®£
, 
D©um
::
F64
(0.25), 
Some
(0)),

366 (
SÿÏrFuncSig
::
R—lIsF®£
, 
D©um
::
F64
(0.000), 
Some
(1)),

367 (
SÿÏrFuncSig
::
R—lIsF®£
, 
D©um
::
F64
(-0.00), 
Some
(1)),

368 (
SÿÏrFuncSig
::
R—lIsF®£
, 
D©um
::
F64
(-0.011), 
Some
(0)),

369 (
SÿÏrFuncSig
::
R—lIsF®£
, 
D©um
::
NuÎ
, 
Some
(0)),

370 (
SÿÏrFuncSig
::
R—lIsNuÎ
, 
D©um
::
F64
(1.25), 
Some
(0)),

371 (
SÿÏrFuncSig
::
R—lIsNuÎ
, 
D©um
::
NuÎ
, 
Some
(1)),

372 (
SÿÏrFuncSig
::
Decim®IsTrue
, 
¡r2dec
("1.1"), 
Some
(1)),

373 (
SÿÏrFuncSig
::
Decim®IsTrue
, 
¡r2dec
("0"), 
Some
(0)),

374 (
SÿÏrFuncSig
::
Decim®IsTrue
, 
D©um
::
NuÎ
, 
Some
(0)),

375 (
SÿÏrFuncSig
::
Decim®IsF®£
, 
¡r2dec
("1.1"), 
Some
(0)),

376 (
SÿÏrFuncSig
::
Decim®IsF®£
, 
¡r2dec
("0"), 
Some
(1)),

377 (
SÿÏrFuncSig
::
Decim®IsF®£
, 
D©um
::
NuÎ
, 
Some
(0)),

378 (
SÿÏrFuncSig
::
Decim®IsNuÎ
, 
¡r2dec
("1.1"), 
Some
(0)),

379 (
SÿÏrFuncSig
::
Decim®IsNuÎ
, 
D©um
::
NuÎ
, 
Some
(1)),

380 (
SÿÏrFuncSig
::
IÁIsTrue
, 
D©um
::
I64
(0), 
Some
(0)),

381 (
SÿÏrFuncSig
::
IÁIsTrue
, 
D©um
::
I64
(12), 
Some
(1)),

382 (
SÿÏrFuncSig
::
IÁIsTrue
, 
D©um
::
NuÎ
, 
Some
(0)),

383 (
SÿÏrFuncSig
::
IÁIsF®£
, 
D©um
::
I64
(0), 
Some
(1)),

384 (
SÿÏrFuncSig
::
IÁIsF®£
, 
D©um
::
I64
(1), 
Some
(0)),

385 (
SÿÏrFuncSig
::
IÁIsF®£
, 
D©um
::
NuÎ
, 
Some
(0)),

386 (
SÿÏrFuncSig
::
IÁIsNuÎ
, 
D©um
::
I64
(1), 
Some
(0)),

387 (
SÿÏrFuncSig
::
IÁIsNuÎ
, 
D©um
::
NuÎ
, 
Some
(1)),

388 (
SÿÏrFuncSig
::
SŒšgIsNuÎ
, 
D©um
::
NuÎ
, 
Some
(1)),

390 
SÿÏrFuncSig
::
SŒšgIsNuÎ
,

391 
D©um
::
By‹s
(
b
"abc".
to_vec
()),

392 
Some
(0),

394 (
SÿÏrFuncSig
::
TimeIsNuÎ
, 
D©um
::
NuÎ
, 
Some
(1)),

397 
SÿÏrFuncSig
::
Du¿tiÚIsNuÎ
,

398 
D©um
::
Dur
(
Du¿tiÚ
::
z”o
()),

399 
Some
(0),

401 (
SÿÏrFuncSig
::
Du¿tiÚIsNuÎ
, 
D©um
::
NuÎ
, 
Some
(1)),

403 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

404 
	gİ
, 
	g¬g
, 
	gexp
è
š
 
	g‹¡s
 {

405 
Ët
 
	g¬g1
 = 
d©um_ex´
(
¬g
);

406 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
İ
, &[
¬g1
])).
unw¿p
();

407 
Ët
 
	g»s
 = 
İ
.
ev®_št
(&
ùx
, &[]).
unw¿p
();

408 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

412 
â
 
check_ov”æow
(
e
: 
E¼Ü
è-> 
ResuÉ
<(), ()> {

413 
m©ch
 
	ge
 {

414 
	gE¼Ü
::
Ov”æow
 => 
Ok
(()),

415 
	g_
 => 
E¼
(()),

419 #[
‹¡
]

420 
â
 
‹¡_uÇry_İ_ov”æow
() {

421 
Ët
 
	g‹¡s
 = 
vec
![

422 (
SÿÏrFuncSig
::
UÇryMšusIÁ
, 
D©um
::
I64
(
i64
::
MIN
)),

424 
SÿÏrFuncSig
::
UÇryMšusIÁ
,

425 
D©um
::
U64
(
i64
::
MAX
 
as
 
u64
 + 2),

428 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

429 
	gİ
, 
	g¬gum’t
è
š
 
	g‹¡s
 {

430 
Ët
 
	g¬g
 = 
d©um_ex´
(
¬gum’t
);

431 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
İ
, &[
¬g
])).
unw¿p
();

432 
Ët
 
	ggÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p_”r
();

433 
	gas£¹
!(
check_ov”æow
(
gÙ
).
is_ok
());

437 #[
‹¡
]

438 
â
 
‹¡_b™_ªd
() {

439 
Ët
 
	gÿ£s
 = 
vec
![

440 (
D©um
::
I64
(123), Datum::I64(321), Datum::I64(65)),

441 (
D©um
::
I64
(-123), Datum::I64(321), Datum::I64(257)),

442 (
D©um
::
NuÎ
, D©um::
I64
(1), Datum::Null),

444 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

445 
	glhs
, 
	grhs
, 
	gexp
è
š
 
	gÿ£s
 {

446 
Ët
 
	g¬gs
 = &[
d©um_ex´
(
lhs
), d©um_ex´(
rhs
)];

447 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
SÿÏrFuncSig
::
B™AndSig
, 
¬gs
)).
unw¿p
();

448 
Ët
 
	g»s
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

449 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

453 #[
‹¡
]

454 
â
 
‹¡_b™_Ü
() {

455 
Ët
 
	gÿ£s
 = 
vec
![

456 (
D©um
::
I64
(123), Datum::I64(321), Datum::I64(379)),

457 (
D©um
::
I64
(-123), Datum::I64(321), Datum::I64(-59)),

458 (
D©um
::
NuÎ
, D©um::
I64
(1), Datum::Null),

460 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

461 
	glhs
, 
	grhs
, 
	gexp
è
š
 
	gÿ£s
 {

462 
Ët
 
	g¬gs
 = &[
d©um_ex´
(
lhs
), d©um_ex´(
rhs
)];

463 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
SÿÏrFuncSig
::
B™OrSig
, 
¬gs
)).
unw¿p
();

464 
Ët
 
	g»s
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

465 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

469 #[
‹¡
]

470 
â
 
‹¡_b™_xÜ
() {

471 
Ët
 
	gÿ£s
 = 
vec
![

472 (
D©um
::
I64
(123), Datum::I64(321), Datum::I64(314)),

473 (
D©um
::
I64
(-123), Datum::I64(321), Datum::I64(-316)),

474 (
D©um
::
NuÎ
, D©um::
I64
(1), Datum::Null),

476 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

477 
	glhs
, 
	grhs
, 
	gexp
è
š
 
	gÿ£s
 {

478 
Ët
 
	g¬gs
 = &[
d©um_ex´
(
lhs
), d©um_ex´(
rhs
)];

479 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
SÿÏrFuncSig
::
B™XÜSig
, 
¬gs
)).
unw¿p
();

480 
Ët
 
	g»s
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

481 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

485 #[
‹¡
]

486 
â
 
‹¡_b™_Ãg
() {

487 
Ët
 
	gÿ£s
 = 
vec
![

488 (
D©um
::
I64
(123), Datum::I64(-124)),

489 (
D©um
::
I64
(-123), Datum::I64(122)),

490 (
D©um
::
NuÎ
, Datum::Null),

492 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

493 
	g¬g
, 
	gexp
è
š
 
	gÿ£s
 {

494 
Ët
 
	g¬gs
 = &[
d©um_ex´
(
¬g
)];

495 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
SÿÏrFuncSig
::
B™NegSig
, 
¬gs
)).
unw¿p
();

496 
Ët
 
	g»s
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

497 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

	@src/coprocessor/dag/expr/column.rs

14 
u£
 
	g¡d
::
bÜrow
::
Cow
;

16 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

17 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
Decim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gTime
};

18 
u£
 
	gsu³r
::{
CŞumn
, 
	gResuÉ
};

20 
im¶
 
	gCŞumn
 {

21 
pub
 
â
 
ev®
(&
£lf
, 
row
: &[
D©um
]) -> Datum {

22 
row
[
£lf
.
off£t
].
şÚe
()

25 #[
šlše
]

26 
pub
 
â
 
ev®_št
(&
£lf
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

27 
row
[
£lf
.
off£t
].
as_št
()

30 #[
šlše
]

31 
pub
 
â
 
ev®_»®
(&
£lf
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

32 
row
[
£lf
.
off£t
].
as_»®
()

35 #[
šlše
]

36 
pub
 
â
 
ev®_decim®
<'a>(&£lf,„ow: &'
a
 [
D©um
]è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

37 
row
[
£lf
.
off£t
].
as_decim®
()

40 #[
šlše
]

41 
pub
 
â
 
ev®_¡ršg
<'a>(&£lf,„ow: &'
a
 [
D©um
]è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

42 
row
[
£lf
.
off£t
].
as_¡ršg
()

45 #[
šlše
]

46 
pub
 
â
 
ev®_time
<'a>(&£lf,„ow: &'
a
 [
D©um
]è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

47 
row
[
£lf
.
off£t
].
as_time
()

50 #[
šlše
]

51 
pub
 
â
 
ev®_du¿tiÚ
<'a>(&£lf,„ow: &'
a
 [
D©um
]è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

52 
row
[
£lf
.
off£t
].
as_du¿tiÚ
()

55 #[
šlše
]

56 
pub
 
â
 
ev®_jsÚ
<'a>(&£lf,„ow: &'
a
 [
D©um
]è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

57 
row
[
£lf
.
off£t
].
as_jsÚ
()

61 #[
cfg
(
‹¡
)]

62 
mod
 
‹¡
 {

63 
u£
 
¡d
::
u64
;

64 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

65 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
Decim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gTime
};

66 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::{
Ex´essiÚ
, 
	gS‹m’tCÚ‹xt
};

67 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::
cŞ_ex´
;

69 #[
d”ive
(
P¬tŸlEq
, 
Debug
)]

70 
Ev®ResuÉs
(

71 
O±iÚ
<
i64
>,

72 
O±iÚ
<
f64
>,

73 
O±iÚ
<
Decim®
>,

74 
O±iÚ
<
Vec
<
u8
>>,

75 
O±iÚ
<
Time
>,

76 
O±iÚ
<
Du¿tiÚ
>,

77 
O±iÚ
<
JsÚ
>,

80 #[
‹¡
]

81 
â
 
‹¡_cŞumn_ev®
() {

82 
Ët
 
	gdec
 = "1.1".
·r£
::<
Decim®
>().
unw¿p
();

83 
Ët
 
	gs
 = "ä½ å¥½".
as_by‹s
().
to_owÃd
();

84 
Ët
 
	gdur
 = 
Du¿tiÚ
::
·r£
(
b
"01:00:00", 0).
unw¿p
();

86 
Ët
 
	grow
 = 
vec
![

87 
D©um
::
NuÎ
,

88 
D©um
::
I64
(-30),

89 
D©um
::
U64
(
u64
::
MAX
),

90 
D©um
::
F64
(124.32),

91 
D©um
::
Dec
(
dec
.
şÚe
()),

92 
D©um
::
By‹s
(
s
.
şÚe
()),

93 
D©um
::
Dur
(
dur
.
şÚe
()),

96 
Ët
 
	gex³ùeds
 = 
vec
![

97 
Ev®ResuÉs
(
NÚe
, None, None, None, None, None, None),

98 
Ev®ResuÉs
(
Some
(-30), 
NÚe
, None, None, None, None, None),

99 
Ev®ResuÉs
(
Some
(-1), 
NÚe
, None, None, None, None, None),

100 
Ev®ResuÉs
(
NÚe
, 
Some
(124.32), None, None, None, None, None),

101 
Ev®ResuÉs
(
NÚe
, NÚe, 
Some
(
dec
.
şÚe
()), None, None, None, None),

102 
Ev®ResuÉs
(
NÚe
, NÚe, NÚe, 
Some
(
s
.
şÚe
()), None, None, None),

103 
Ev®ResuÉs
(
NÚe
, NÚe, NÚe, NÚe, NÚe, 
Some
(
dur
.
şÚe
()), None),

106 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

107 
	gii
, 
	gexp
è
š
 
	gex³ùeds
.
™”
().
’um”©e
().
ke
(
row
.
Ën
()) {

108 
Ët
 
	gc
 = 
cŞ_ex´
(
ii
 
as
 
i64
);

109 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
c
).
unw¿p
();

111 
Ët
 
	gi
 = 
e
.
ev®_št
(&
ùx
, &
row
).
unw¿p_Ü
(
NÚe
);

112 
Ët
 
	gr
 = 
e
.
ev®_»®
(&
ùx
, &
row
).
unw¿p_Ü
(
NÚe
);

113 
Ët
 
	gdec
 = 
e
.
ev®_decim®
(&
ùx
, &
row
)

114 .
unw¿p_Ü
(
NÚe
)

115 .
m­
(|
t
|.
što_owÃd
());

116 
Ët
 
	gs
 = 
e
.
ev®_¡ršg
(&
ùx
, &
row
)

117 .
unw¿p_Ü
(
NÚe
)

118 .
m­
(|
t
|.
što_owÃd
());

119 
Ët
 
	gt
 = 
e
.
ev®_time
(&
ùx
, &
row
)

120 .
unw¿p_Ü
(
NÚe
)

121 .
m­
(|
t
|.
što_owÃd
());

122 
Ët
 
	gdur
 = 
e
.
ev®_du¿tiÚ
(&
ùx
, &
row
)

123 .
unw¿p_Ü
(
NÚe
)

124 .
m­
(|
t
|.
što_owÃd
());

125 
Ët
 
	gj
 = 
e
.
ev®_jsÚ
(&
ùx
, &
row
)

126 .
unw¿p_Ü
(
NÚe
)

127 .
m­
(|
t
|.
što_owÃd
());

129 
Ët
 
	g»suÉ
 = 
Ev®ResuÉs
(
i
, 
r
, 
dec
, 
s
, 
t
, 
dur
, 
j
);

130 
	gas£¹_eq
!(*
	gexp
, 
	g»suÉ
);

	@src/coprocessor/dag/expr/compare.rs

14 
u£
 
	g¡d
::{
¡r
, 
	gi64
};

15 
u£
 
	g¡d
::
¦iû
::
I‹r
;

16 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

17 
u£
 
	g¡d
::
bÜrow
::
Cow
;

19 
u£
 
	gcİroûssÜ
::
codec
::{
d©um
, 
	gmysql
, 
	gD©um
};

20 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
Decim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gTime
};

21 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
Ex´essiÚ
;

22 
u£
 
	gsu³r
::{
E¼Ü
, 
	gFnC®l
, 
	gResuÉ
, 
	gS‹m’tCÚ‹xt
};

24 cÚ¡ 
	gMAX_RECURSE_LEVEL
: 
usize
 = 1024;

26 #[
d”ive
(
ClÚe
, 
Cİy
, 
P¬tŸlEq
)]

27 
pub
 
	eCmpOp
 {

28 
	mLT
,

29 
	mLE
,

30 
	mGT
,

31 
	mGE
,

32 
	mNE
,

33 
	mEQ
,

34 
	mNuÎEQ
,

37 
im¶
 
	gFnC®l
 {

38 
pub
 
â
 
com·»_št
(

39 &
£lf
,

40 
ùx
: &
S‹m’tCÚ‹xt
,

41 
row
: &[
D©um
],

42 
İ
: 
CmpOp
,

43 è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

44 
Ët
 
	ge
 = |
i
: 
usize
| 
£lf
.
chd»n
[i].
ev®_št
(
ùx
, 
row
);

45 
do_com·»
(
e
, 
İ
, |
l
, 
r
| {

46 
Ët
 
lhs_unsigÃd
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[0].
g‘_
().
g‘_æag
());

47 
Ët
 
rhs_unsigÃd
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[1].
g‘_
().
g‘_æag
());

48 
Ok
(
cmp_i64_w™h_unsigÃd_æag
(
l
, 
lhs_unsigÃd
, 
r
, 
rhs_unsigÃd
))

52 
pub
 
â
 
com·»_»®
(

53 &
£lf
,

54 
ùx
: &
S‹m’tCÚ‹xt
,

55 
row
: &[
D©um
],

56 
İ
: 
CmpOp
,

57 è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

58 
do_com·»
(

59 |
i
| 
£lf
.
chd»n
[i].
ev®_»®
(
ùx
, 
row
),

60 
İ
,

61 |
l
, 
r
| 
d©um
::
cmp_f64
Ö,„).
m­_”r
(
E¼Ü
::
äom
),

65 
pub
 
â
 
com·»_decim®
(

66 &
£lf
,

67 
ùx
: &
S‹m’tCÚ‹xt
,

68 
row
: &[
D©um
],

69 
İ
: 
CmpOp
,

70 è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

71 
Ët
 
	ge
 = |
i
: 
usize
| 
£lf
.
chd»n
[i].
ev®_decim®
(
ùx
, 
row
);

72 
do_com·»
(
e
, 
İ
, |
l
, 
r
| 
Ok
Ö.
cmp
(&r)))

75 
pub
 
â
 
com·»_¡ršg
(

76 &
£lf
,

77 
ùx
: &
S‹m’tCÚ‹xt
,

78 
row
: &[
D©um
],

79 
İ
: 
CmpOp
,

80 è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

81 
Ët
 
	ge
 = |
i
: 
usize
| 
£lf
.
chd»n
[i].
ev®_¡ršg
(
ùx
, 
row
);

82 
do_com·»
(
e
, 
İ
, |
l
, 
r
| 
Ok
Ö.
cmp
(&r)))

85 
pub
 
â
 
com·»_time
(

86 &
£lf
,

87 
ùx
: &
S‹m’tCÚ‹xt
,

88 
row
: &[
D©um
],

89 
İ
: 
CmpOp
,

90 è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

91 
Ët
 
	ge
 = |
i
: 
usize
| 
£lf
.
chd»n
[i].
ev®_time
(
ùx
, 
row
);

92 
do_com·»
(
e
, 
İ
, |
l
, 
r
| 
Ok
Ö.
cmp
(&r)))

95 
pub
 
â
 
com·»_du¿tiÚ
(

96 &
£lf
,

97 
ùx
: &
S‹m’tCÚ‹xt
,

98 
row
: &[
D©um
],

99 
İ
: 
CmpOp
,

100 è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

101 
Ët
 
	ge
 = |
i
: 
usize
| 
£lf
.
chd»n
[i].
ev®_du¿tiÚ
(
ùx
, 
row
);

102 
do_com·»
(
e
, 
İ
, |
l
, 
r
| 
Ok
Ö.
cmp
(&r)))

105 
pub
 
â
 
com·»_jsÚ
(

106 &
£lf
,

107 
ùx
: &
S‹m’tCÚ‹xt
,

108 
row
: &[
D©um
],

109 
İ
: 
CmpOp
,

110 è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

111 
Ët
 
	ge
 = |
i
: 
usize
| 
£lf
.
chd»n
[i].
ev®_jsÚ
(
ùx
, 
row
);

112 
do_com·»
(
e
, 
İ
, |
l
, 
r
| 
Ok
Ö.
cmp
(&r)))

116 
pub
 
â
 
cßËsû_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

117 
do_cßËsû
(
£lf
, |
v
| v.
ev®_št
(
ùx
, 
row
))

120 
pub
 
â
 
cßËsû_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

121 
do_cßËsû
(
£lf
, |
v
| v.
ev®_»®
(
ùx
, 
row
))

124 
pub
 
â
 
	gcßËsû_decim®
<'a, '
	gb
: 'a>(

126 
ùx
: &
S‹m’tCÚ‹xt
,

127 
	grow
: &'a [Datum],

128 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

129 
do_cßËsû
(
£lf
, |
v
| v.
ev®_decim®
(
ùx
, 
row
))

132 
pub
 
â
 
	gcßËsû_time
<'a, '
	gb
: 'a>(

134 
ùx
: &
S‹m’tCÚ‹xt
,

135 
	grow
: &'a [Datum],

136 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

137 
do_cßËsû
(
£lf
, |
v
| v.
ev®_time
(
ùx
, 
row
))

140 
pub
 
â
 
	gcßËsû_du¿tiÚ
<'a, '
	gb
: 'a>(

142 
ùx
: &
S‹m’tCÚ‹xt
,

143 
	grow
: &'a [Datum],

144 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

145 
do_cßËsû
(
£lf
, |
v
| v.
ev®_du¿tiÚ
(
ùx
, 
row
))

148 
pub
 
â
 
	gcßËsû_¡ršg
<'a, '
	gb
: 'a>(

150 
ùx
: &
S‹m’tCÚ‹xt
,

151 
	grow
: &'a [Datum],

152 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

153 
do_cßËsû
(
£lf
, |
v
| v.
ev®_¡ršg
(
ùx
, 
row
))

156 
pub
 
â
 
	gcßËsû_jsÚ
<'a, '
	gb
: 'a>(

158 
ùx
: &
S‹m’tCÚ‹xt
,

159 
	grow
: &'a [Datum],

160 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

161 
do_cßËsû
(
£lf
, |
v
| v.
ev®_jsÚ
(
ùx
, 
row
))

164 
pub
 
â
 
š_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

165 
do_š
(

166 
£lf
,

167 |
v
| v.
ev®_št
(
ùx
, 
row
),

168 |
l
, 
r
| {

169 
Ët
 
lhs_unsigÃd
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[0].
g‘_
().
g‘_æag
());

170 
Ët
 
rhs_unsigÃd
 = 
mysql
::
has_unsigÃd_æag
(
£lf
.
chd»n
[1].
g‘_
().
g‘_æag
());

171 
Ok
(
cmp_i64_w™h_unsigÃd_æag
(

172 *
l
,

173 
lhs_unsigÃd
,

174 *
r
,

175 
rhs_unsigÃd
,

181 
pub
 
â
 
š_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

182 
do_š
(

183 
£lf
,

184 |
v
| v.
ev®_»®
(
ùx
, 
row
),

185 |
l
, 
r
| 
d©um
::
cmp_f64
(*l, *r).
m­_”r
(
E¼Ü
::
äom
),

189 
pub
 
â
 
š_decim®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

190 
do_š
(
£lf
, |
v
| v.
ev®_decim®
(
ùx
, 
row
), |
l
, 
r
| 
Ok
Ö.
cmp
(r)))

193 
pub
 
â
 
š_time
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

194 
do_š
(
£lf
, |
v
| v.
ev®_time
(
ùx
, 
row
), |
l
, 
r
| 
Ok
Ö.
cmp
(r)))

197 
pub
 
â
 
š_du¿tiÚ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

198 
do_š
(
£lf
, |
v
| v.
ev®_du¿tiÚ
(
ùx
, 
row
), |
l
, 
r
| 
Ok
Ö.
cmp
(r)))

201 
pub
 
â
 
š_¡ršg
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

202 
do_š
(
£lf
, |
v
| v.
ev®_¡ršg
(
ùx
, 
row
), |
l
, 
r
| 
Ok
Ö.
cmp
(r)))

205 
pub
 
â
 
š_jsÚ
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

206 
do_š
(
£lf
, |
v
| v.
ev®_jsÚ
(
ùx
, 
row
), |
l
, 
r
| 
Ok
Ö.
cmp
(r)))

213 
pub
 
â
 
like
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

214 
Ët
 
rg‘
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_¡ršg
(
ùx
, 
row
));

215 
Ët
 
	g·‰”n
 = 
Œy_İt
!(
£lf
.
chd»n
[1].
ev®_¡ršg
(
ùx
, 
row
));

216 
Ët
 
	gesÿ³
 = 
Œy_İt
!(
£lf
.
chd»n
[2].
ev®_št
(
ùx
, 
row
)è
as
 
	gu32
;

217 
Ok
(
Some
(
like
(&
rg‘
, &
·‰”n
, 
esÿ³
, 0)? 
as
 
i64
))

221 
â
 
	gdo_com·»
<
	gT
, 
	gE
, 
	gF
>(
	ge
: 
E
, 
	gİ
: 
CmpOp
, 
	gg‘_Üd”
: 
F
è-> 
ResuÉ
<
O±iÚ
<
i64
>>

222 
wh”e


223 
E
: 
Fn
(
usize
è-> 
ResuÉ
<
O±iÚ
<
T
>>,

224 
	gF
: 
Fn
(
T
, Tè-> 
	gResuÉ
<
	gOrd”šg
>,

226 
Ët
 
	glhs
 = 
e
(0)?;

227 
	glhs
.
is_nÚe
(è&& 
	gİ
 !ğ
CmpOp
::
NuÎEQ
 {

228  
Ok
(
NÚe
);

230 
Ët
 
	grhs
 = 
e
(1)?;

231 
m©ch
 (
lhs
, 
rhs
) {

232 (
	gNÚe
, NÚeè=> 
Ok
(
Some
(1)),

233 (
Some
(
lhs
), Some(
rhs
)) => {

234 
Ët
 
Üd”šg
 = 
g‘_Üd”
(
lhs
, 
rhs
)?;

235 
Ët
 
	gr
 = 
m©ch
 
İ
 {

236 
CmpOp
::
LT
 => 
Üd”šg
 =ğ
Ord”šg
::
Less
,

237 
	gCmpOp
::
LE
 => 
Üd”šg
 !ğ
Ord”šg
::
G»©”
,

238 
	gCmpOp
::
GT
 => 
Üd”šg
 =ğ
Ord”šg
::
G»©”
,

239 
	gCmpOp
::
GE
 => 
Üd”šg
 !ğ
Ord”šg
::
Less
,

240 
	gCmpOp
::
NE
 => 
Üd”šg
 !ğ
Ord”šg
::
Equ®
,

241 
	gCmpOp
::
EQ
 | 
CmpOp
::
NuÎEQ
 => 
Üd”šg
 =ğ
Ord”šg
::
Equ®
,

243 
Ok
(
Some
(
r
 
as
 
i64
))

245 
	g_
 => 
m©ch
 
İ
 {

246 
CmpOp
::
NuÎEQ
 => 
Ok
(
Some
(0)),

247 
	g_
 => 
Ok
(
NÚe
),

252 #[
šlše
]

253 
â
 
cmp_i64_w™h_unsigÃd_æag
(

254 
lhs
: 
i64
,

255 
lhs_unsigÃd
: 
boŞ
,

256 
rhs
: 
i64
,

257 
rhs_unsigÃd
: 
boŞ
,

258 è-> 
	gOrd”šg
 {

259 
m©ch
 (
lhs_unsigÃd
, 
rhs_unsigÃd
) {

260 (
	gçl£
, f®£è=> 
lhs
.
cmp
(&
rhs
),

261 (
	gŒue
,rue) => {

262 
Ët
 
lhs
 =†h 
as
 
u64
;

263 
Ët
 
	grhs
 = 
rhs
 
as
 
u64
;

264 
	glhs
.
cmp
(&
rhs
)

266 (
	gŒue
, 
	gçl£
è=> 
rhs
 < 0 || 
lhs
 
as
 
u64
 > 
i64
::
MAX
‡s u64 {

267 
Ord”šg
::
G»©”


269 
lhs
.
cmp
(&
rhs
)

271 (
	gçl£
, 
	gŒue
è=> 
lhs
 < 0 || 
rhs
 
as
 
u64
 > 
i64
::
MAX
‡s u64 {

272 
Ord”šg
::
Less


274 
lhs
.
cmp
(&
rhs
)

279 
â
 
	gdo_cßËsû
<'a, F, T>Óx´: &'
a
 
	gFnC®l
, 
	gf
: 
F
è-> 
ResuÉ
<
O±iÚ
<
T
>>

280 
wh”e


281 
F
: 
Fn
(&'a Expression) -> Result<Option<T>>,

283 
exp
 
š
 &
ex´
.
chd»n
 {

284 
Ët
 
v
 = 
f
(
exp
)?;

285 
v
.
is_some
() {

286  
Ok
(
v
);

289 
Ok
(
NÚe
)

292 
â
 
do_š
<'a, T, E, F>Óx´: &'
a
 
FnC®l
, 
f
: 
F
, 
g‘_Üd”
: 
E
è-> 
ResuÉ
<
O±iÚ
<
i64
>>

293 
wh”e


294 
F
: 
Fn
(&'a Expression) -> Result<Option<T>>,

295 
E
: 
Fn
(&
T
, &Tè-> 
ResuÉ
<
Ord”šg
>,

297 
Ët
 (
fœ¡
, 
Ùh”s
èğ
ex´
.
chd»n
.
¥l™_fœ¡
().
unw¿p
();

298 
Ët
 
¬g
 = 
Œy_İt
!(
f
(
fœ¡
));

299 
Ët
 
mut
 
»t_wh’_nÙ_m©ched
 = 
Ok
(
Some
(0));

300 
exp
 
š
 
Ùh”s
 {

301 
Ët
 
¬g1
 = 
f
(
exp
)?;

302 
¬g1
.
is_nÚe
() {

303 
»t_wh’_nÙ_m©ched
 = 
Ok
(
NÚe
);

306 
Ët
 
cmp_»suÉ
 = 
g‘_Üd”
(&
¬g
, &
¬g1
.
unw¿p
())?;

307 
cmp_»suÉ
 =ğ
Ord”šg
::
Equ®
 {

308  
Ok
(
Some
(1));

311 
»t_wh’_nÙ_m©ched


315 #[
šlše
]

316 
â
 
·¹Ÿl_like
(
tcs
: &
mut
 
I‹r
<
u8
>, 
pcs
: &muˆI‹r<u8>, 
esÿ³
: 
u32
è-> 
O±iÚ
<
boŞ
> {

317 
loİ
 {

318 
m©ch
 
pcs
.
Ãxt
().
şÚed
() {

319 
NÚe
 =>  
Some
(
tcs
.
Ãxt
().
is_nÚe
()),

320 
Some
(
b
'%'è=>  
NÚe
,

321 
Some
(
c
) => {

322 
Ët
 (
Åc
, 
esÿ³
èğ
c
 
as
 
u32
 ==ƒscape {

323 
pcs
.
Ãxt
().
m­_Ü
((
c
, 
çl£
), |&c| (c, 
Œue
))

325 (
c
, 
çl£
)

327 
Ët
 
nsc
 = 
m©ch
 
tcs
.
Ãxt
() {

328 
NÚe
 =>  
Some
(
çl£
),

329 
Some
(&
c
) => c,

331 
nsc
 !ğ
Åc
 && (Åø!ğ
b
'_' || 
esÿ³
) {

332  
Some
(
çl£
);

339 
â
 
like
(
rg‘
: &[
u8
], 
·‰”n
: &[u8], 
esÿ³
: 
u32
, 
»cur£_Ëv–
: 
usize
è-> 
ResuÉ
<
boŞ
> {

340 
Ët
 
mut
 
tcs
 = 
rg‘
.
™”
();

341 
Ët
 
mut
 
pcs
 = 
·‰”n
.
™”
();

342 
loİ
 {

343 
Ët
 
Some
(
»s
èğ
·¹Ÿl_like
(&
mut
 
tcs
, &muˆ
pcs
, 
esÿ³
) {

344  
Ok
(
»s
);

346 
Ët
 
Ãxt_ch¬
 = 
loİ
 {

347 
m©ch
 
pcs
.
Ãxt
().
şÚed
() {

348 
Some
(
b
'%') => {}

349 
Some
(
b
'_'è=> 
tcs
.
Ãxt
().
is_nÚe
() {

350  
Ok
(
çl£
);

353 
NÚe
 =>  
Ok
(
Œue
),

354 
Some
(
c
) => {

355  
c
 
as
 
u32
 =ğ
esÿ³
 {

356 
pcs
.
Ãxt
().
m­_Ü
(
esÿ³
, |&
c
| c 
as
 
u32
)

358 
c
 
as
 
u32


363 
»cur£_Ëv–
 >ğ
MAX_RECURSE_LEVEL
 {

365  
E¼
(
box_”r
!(

367 
MAX_RECURSE_LEVEL


371 
loİ
 {

372 
Ët
 
s
 = 
m©ch
 
tcs
.
Ãxt
() {

373 
NÚe
 =>  
Ok
(
çl£
),

374 
Some
(&
s
è=> s 
as
 
u32
,

376 
s
 =ğ
Ãxt_ch¬
 && 
like
(
tcs
.
as_¦iû
(), 
pcs
.as_¦iû(), 
esÿ³
, 
»cur£_Ëv–
 + 1)? {

377  
Ok
(
Œue
);

383 #[
cfg
(
‹¡
)]

384 
mod
 
‹¡
 {

385 
u£
 
¡d
::{
i64
, 
u64
};

386 
u£
 
tb
::
ex´essiÚ
::{
Ex´
, 
Ex´Ty³
, 
SÿÏrFuncSig
};

387 
u£
 
´Ùobuf
::
R•—‹dF›ld
;

388 
u£
 
cİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::{
cŞ_ex´
, 
d©um_ex´
};

389 
u£
 
cİroûssÜ
::
codec
::
mysql
::{
Decim®
, 
Du¿tiÚ
, 
JsÚ
, 
Time
};

390 
u£
 
cİroûssÜ
::
codec
::
D©um
;

391 
u£
 
cİroûssÜ
::
dag
::
ex´
::{
Ex´essiÚ
, 
S‹m’tCÚ‹xt
};

392 
u£
 
cİroûssÜ
::
dag
::
ex´
::
‹¡
::
âÿÎ_ex´
;

393 
u£
 
su³r
::*;

395 #[
‹¡
]

396 
â
 
‹¡_cmp_i64_w™h_unsigÃd_æag
() {

397 
Ët
 
ÿ£s
 = 
vec
![

398 (5, 
çl£
, 3, f®£, 
Ord”šg
::
G»©”
),

399 (
u64
::
MAX
 
as
 
i64
, 
çl£
, 5‡ i64, f®£, 
Ord”šg
::
Less
),

401 
u64
::
MAX
 
as
 
i64
,

402 
Œue
,

403 (
u64
::
MAX
 - 1è
as
 
i64
,

404 
Œue
,

405 
Ord”šg
::
G»©”
,

407 (
u64
::
MAX
 
as
 
i64
, 
Œue
, 5‡ i64,rue, 
Ord”šg
::
G»©”
),

408 (5, 
Œue
, 
i64
::
MIN
, 
çl£
, 
Ord”šg
::
G»©”
),

409 (
u64
::
MAX
 
as
 
i64
, 
Œue
, i64::
MIN
, 
çl£
, 
Ord”šg
::
G»©”
),

410 (5, 
Œue
, 3, 
çl£
, 
Ord”šg
::
G»©”
),

411 (
i64
::
MIN
, 
çl£
, 3, 
Œue
, 
Ord”šg
::
Less
),

412 (5, 
çl£
, 
u64
::
MAX
 
as
 
i64
, 
Œue
, 
Ord”šg
::
Less
),

413 (5, 
çl£
, 3, 
Œue
, 
Ord”šg
::
G»©”
),

415 
a
, 
b
, 
c
, 
d
, 
e
è
š
 
ÿ£s
 {

416 
Ët
 
o
 = 
cmp_i64_w™h_unsigÃd_æag
(
a
, 
b
, 
c
, 
d
);

417 
as£¹_eq
!(
o
, 
e
);

421 #[
‹¡
]

422 
â
 
‹¡_cßËsû
() {

423 
Ët
 
dec
 = "1.1".
·r£
::<
Decim®
>().
unw¿p
();

424 
Ët
 
s
 = "ä½ å¥½".
as_by‹s
().
to_owÃd
();

425 
Ët
 
dur
 = 
Du¿tiÚ
::
·r£
(
b
"01:00:00", 0).
unw¿p
();

426 
Ët
 
jsÚ
 = 
JsÚ
::
I64
(12);

427 
Ët
 
t
 = 
Time
::
·r£_utc_d©‘ime
("2012-12-12 12:00:39", 0).
unw¿p
();

428 
Ët
 
ÿ£s
 = 
vec
![

429 (
SÿÏrFuncSig
::
CßËsûIÁ
, 
vec
![
D©um
::
NuÎ
], Datum::Null),

431 
SÿÏrFuncSig
::
CßËsûIÁ
,

432 
vec
![
D©um
::
NuÎ
, Datum::Null],

433 
D©um
::
NuÎ
,

436 
SÿÏrFuncSig
::
CßËsûIÁ
,

437 
vec
![
D©um
::
NuÎ
, Datum::Null, Datum::Null],

438 
D©um
::
NuÎ
,

441 
SÿÏrFuncSig
::
CßËsûIÁ
,

442 
vec
![
D©um
::
NuÎ
, D©um::
I64
(0), Datum::Null],

443 
D©um
::
I64
(0),

446 
SÿÏrFuncSig
::
CßËsûR—l
,

447 
vec
![
D©um
::
NuÎ
, D©um::
F64
(3.2), Datum::Null],

448 
D©um
::
F64
(3.2),

451 
SÿÏrFuncSig
::
CßËsûIÁ
,

452 
vec
![
D©um
::
I64
(32), D©um::
F64
(1.0)],

453 
D©um
::
I64
(32),

456 
SÿÏrFuncSig
::
CßËsûDecim®
,

457 
vec
![
D©um
::
NuÎ
, D©um::
Dec
(
dec
.
şÚe
())],

458 
D©um
::
Dec
(
dec
),

461 
SÿÏrFuncSig
::
CßËsûDu¿tiÚ
,

462 
vec
![
D©um
::
NuÎ
, D©um::
Dur
(
dur
.
şÚe
())],

463 
D©um
::
Dur
(
dur
),

466 
SÿÏrFuncSig
::
CßËsûJsÚ
,

467 
vec
![
D©um
::
JsÚ
(
jsÚ
.
şÚe
())],

468 
D©um
::
JsÚ
(
jsÚ
),

471 
SÿÏrFuncSig
::
CßËsûSŒšg
,

472 
vec
![
D©um
::
By‹s
(
s
.
şÚe
())],

473 
D©um
::
By‹s
(
s
),

476 
SÿÏrFuncSig
::
CßËsûTime
,

477 
vec
![
D©um
::
Time
(
t
.
şÚe
())],

478 
D©um
::
Time
(
t
),

482 
Ët
 
ùx
 = 
S‹m’tCÚ‹xt
::();

484 
sig
, 
row
, 
exp
è
š
 
ÿ£s
 {

485 
Ët
 
chd»n
: 
Vec
<
Ex´
> = (0..
row
.
Ën
()).
m­
(|
id
| 
cŞ_ex´
(id 
as
 
i64
)).
cŞËù
();

486 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

487 
ex´
.
£t_
(
Ex´Ty³
::
SÿÏrFunc
);

488 
ex´
.
£t_sig
(
sig
);

490 
ex´
.
£t_chd»n
(
R•—‹dF›ld
::
äom_vec
(
chd»n
));

491 
Ët
 
e
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex´
).
unw¿p
();

492 
Ët
 
»s
 = 
e
.
ev®
(&
ùx
, &
row
).
unw¿p
();

493 
as£¹_eq
!(
»s
, 
exp
);

497 #[
‹¡
]

498 
â
 
‹¡_š
() {

499 
Ët
 
dec1
 = "1.1".
·r£
::<
Decim®
>().
unw¿p
();

500 
Ët
 
dec2
 = "1.11".
·r£
::<
Decim®
>().
unw¿p
();

501 
Ët
 
dur1
 = 
Du¿tiÚ
::
·r£
(
b
"01:00:00", 0).
unw¿p
();

502 
Ët
 
dur2
 = 
Du¿tiÚ
::
·r£
(
b
"02:00:00", 0).
unw¿p
();

503 
Ët
 
jsÚ1
 = 
JsÚ
::
I64
(11);

504 
Ët
 
jsÚ2
 = 
JsÚ
::
I64
(12);

505 
Ët
 
s1
 = "ä½ å¥½".
as_by‹s
().
to_owÃd
();

506 
Ët
 
s2
 = "ä½ å¥½å•Š".
as_by‹s
().
to_owÃd
();

507 
Ët
 
t1
 = 
Time
::
·r£_utc_d©‘ime
("2012-12-12 12:00:39", 0).
unw¿p
();

508 
Ët
 
t2
 = 
Time
::
·r£_utc_d©‘ime
("2012-12-12 13:00:39", 0).
unw¿p
();

509 
Ët
 
ÿ£s
 = 
vec
![

511 
SÿÏrFuncSig
::
InIÁ
,

512 
vec
![
D©um
::
I64
(1), Datum::I64(2)],

513 
D©um
::
I64
(0),

516 
SÿÏrFuncSig
::
InIÁ
,

517 
vec
![
D©um
::
I64
(1), Datum::I64(2), Datum::I64(1)],

518 
D©um
::
I64
(1),

521 
SÿÏrFuncSig
::
InIÁ
,

522 
vec
![
D©um
::
I64
(1), D©um::I64(2), D©um::
NuÎ
],

523 
D©um
::
NuÎ
,

526 
SÿÏrFuncSig
::
InIÁ
,

527 
vec
![
D©um
::
I64
(1), D©um::I64(2), D©um::
NuÎ
, Datum::I64(1)],

528 
D©um
::
I64
(1),

531 
SÿÏrFuncSig
::
InIÁ
,

532 
vec
![
D©um
::
NuÎ
, D©um::
I64
(2), Datum::I64(1)],

533 
D©um
::
NuÎ
,

536 
SÿÏrFuncSig
::
InR—l
,

537 
vec
![
D©um
::
F64
(3.1), Datum::F64(3.2), Datum::F64(3.3)],

538 
D©um
::
I64
(0),

541 
SÿÏrFuncSig
::
InR—l
,

542 
vec
![
D©um
::
F64
(3.1), Datum::F64(3.2), Datum::F64(3.1)],

543 
D©um
::
I64
(1),

546 
SÿÏrFuncSig
::
InDecim®
,

547 
vec
![
D©um
::
Dec
(
dec1
.
şÚe
()), D©um::Dec(
dec2
.clone())],

548 
D©um
::
I64
(0),

551 
SÿÏrFuncSig
::
InDecim®
,

552 
vec
![

553 
D©um
::
Dec
(
dec1
.
şÚe
()),

554 
D©um
::
Dec
(
dec2
.
şÚe
()),

555 
D©um
::
Dec
(
dec1
.
şÚe
()),

557 
D©um
::
I64
(1),

560 
SÿÏrFuncSig
::
InDu¿tiÚ
,

561 
vec
![
D©um
::
Dur
(
dur1
.
şÚe
()), D©um::Dur(
dur2
.clone())],

562 
D©um
::
I64
(0),

565 
SÿÏrFuncSig
::
InDu¿tiÚ
,

566 
vec
![

567 
D©um
::
Dur
(
dur1
.
şÚe
()),

568 
D©um
::
Dur
(
dur2
.
şÚe
()),

569 
D©um
::
Dur
(
dur1
.
şÚe
()),

571 
D©um
::
I64
(1),

574 
SÿÏrFuncSig
::
InJsÚ
,

575 
vec
![
D©um
::
JsÚ
(
jsÚ1
.
şÚe
()), D©um::JsÚ(
jsÚ2
.clone())],

576 
D©um
::
I64
(0),

579 
SÿÏrFuncSig
::
InJsÚ
,

580 
vec
![

581 
D©um
::
JsÚ
(
jsÚ1
.
şÚe
()),

582 
D©um
::
JsÚ
(
jsÚ2
.
şÚe
()),

583 
D©um
::
JsÚ
(
jsÚ1
.
şÚe
()),

585 
D©um
::
I64
(1),

588 
SÿÏrFuncSig
::
InSŒšg
,

589 
vec
![
D©um
::
By‹s
(
s1
.
şÚe
()), D©um::By‹s(
s2
.clone())],

590 
D©um
::
I64
(0),

593 
SÿÏrFuncSig
::
InSŒšg
,

594 
vec
![

595 
D©um
::
By‹s
(
s1
.
şÚe
()),

596 
D©um
::
By‹s
(
s2
.
şÚe
()),

597 
D©um
::
By‹s
(
s1
.
şÚe
()),

599 
D©um
::
I64
(1),

602 
SÿÏrFuncSig
::
InTime
,

603 
vec
![
D©um
::
Time
(
t1
.
şÚe
()), D©um::Time(
t2
.clone())],

604 
D©um
::
I64
(0),

607 
SÿÏrFuncSig
::
InTime
,

608 
vec
![

609 
D©um
::
Time
(
t1
.
şÚe
()),

610 
D©um
::
Time
(
t2
.
şÚe
()),

611 
D©um
::
Time
(
t1
.
şÚe
()),

613 
D©um
::
I64
(1),

617 
Ët
 
ùx
 = 
S‹m’tCÚ‹xt
::();

619 
sig
, 
row
, 
exp
è
š
 
ÿ£s
 {

620 
Ët
 
chd»n
: 
Vec
<
Ex´
> = (0..
row
.
Ën
()).
m­
(|
id
| 
cŞ_ex´
(id 
as
 
i64
)).
cŞËù
();

621 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

622 
ex´
.
£t_
(
Ex´Ty³
::
SÿÏrFunc
);

623 
ex´
.
£t_sig
(
sig
);

625 
ex´
.
£t_chd»n
(
R•—‹dF›ld
::
äom_vec
(
chd»n
));

626 
Ët
 
e
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex´
).
unw¿p
();

627 
Ët
 
»s
 = 
e
.
ev®
(&
ùx
, &
row
).
unw¿p
();

628 
as£¹_eq
!(
»s
, 
exp
);

632 #[
‹¡
]

633 
â
 
‹¡_like
() {

634 
Ët
 
ÿ£s
 = 
vec
![

635 (
r
#"
h–lo
"#,„#"%
HELLO
%"#, '\\', false),

636 (
r
#"
H–lo
, 
WÜld
"#,„#"Hello, World"#, '\\',rue),

637 (
r
#"
H–lo
, 
WÜld
"#,„#"Hello, %"#, '\\',rue),

638 (
r
#"
H–lo
, 
WÜld
"#,„#"%, World"#, '\\',rue),

639 (
r
#"
‹¡
"#,„#"
‹
%
¡
"#, '\\',rue),

640 (
r
#"
‹¡
"#,„#"
‹
%%
¡
"#, '\\',rue),

641 (
r
#"
‹¡
"#,„#"test%"#, '\\',rue),

642 (
r
#"
‹¡
"#,„#"%test%"#, '\\',rue),

643 (
r
#"
‹¡
"#,„#"
t
%
e
%
s
%t"#, '\\',rue),

644 (
r
#"
‹¡
"#,„#"
_
%_%_%_"#, '\\',rue),

645 (
r
#"
‹¡
"#,„#"
_
%_%
¡
"#, '\\',rue),

646 (
r
#"
C
:"#,„#"%\"#, '\\', false),

647 (
r
#"
C
:\"#,„#"%\"#, '\\',rue),

648 (
r
#"
C
:\
Prog¿ms
"#,„#"%\"#, '\\', false),

649 (
r
#"
C
:\
Prog¿ms
\"#,„#"%\"#, '\\',rue),

650 (
r
#"
C
:"#,„#"%\\"#, '\\', false),

651 (
r
#"
C
:\"#,„#"%\\"#, '\\',rue),

652 (
r
#"
C
:\
Prog¿ms
"#,„#"%\\"#, '\\', false),

653 (
r
#"
C
:\
Prog¿ms
\"#,„#"%\\"#, '\\',rue),

654 (
r
#"
C
:\
Prog¿ms
\"#,„#"%
Prog
%"#, '\\',rue),

655 (
r
#"
C
:\
Prog¿ms
\"#,„#"%
Pr_g
%"#, '\\',rue),

656 (
r
#"
C
:\
Prog¿ms
\"#,„#"%%\"#, '%',rue),

657 (
r
#"
C
:\
Prog¿ms
%"#,„#"%%%"#, '%',rue),

658 (
r
#"
C
:\
Prog¿ms
%"#,„#"%%%%"#, '%',rue),

659 (
r
#"
h–lo
"#,„#"\%"#, '\\', false),

660 (
r
#"%"#,„#"\%"#, '\\',rue),

661 (
r
#"3
h–lo
"#,„#"%%hello"#, '%',rue),

662 (
r
#"3
h–lo
"#,„#"3%hello"#, '3', false),

663 (
r
#"3
h–lo
"#,„#"
__h–lo
"#, '_', false),

664 (
r
#"3
h–lo
"#,„#"%
_h–lo
"#, '%',rue),

666 
Ët
 
ùx
 = 
S‹m’tCÚ‹xt
::();

667 
rg‘_¡r
, 
·‰”n_¡r
, 
esÿ³
, 
exp
è
š
 
ÿ£s
 {

668 
Ët
 
rg‘
 = 
d©um_ex´
(
D©um
::
By‹s
(
rg‘_¡r
.
as_by‹s
().
to_vec
()));

669 
Ët
 
·‰”n
 = 
d©um_ex´
(
D©um
::
By‹s
(
·‰”n_¡r
.
as_by‹s
().
to_vec
()));

670 
Ët
 
esÿ³
 = 
d©um_ex´
(
D©um
::
I64
Ósÿ³ 
as
 
i64
));

671 
Ët
 
İ
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
LikeSig
, &[
rg‘
, 
·‰”n
, 
esÿ³
]);

672 
Ët
 
İ
 = 
Ex´essiÚ
::
bud
(&
ùx
, op).
unw¿p
();

673 
Ët
 
gÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

674 
Ët
 
exp
 = 
D©um
::
äom
(exp);

675 
as£¹_eq
!(
gÙ
, 
exp
, "{:?}†ik{:?}", 
rg‘_¡r
, 
·‰”n_¡r
);

	@src/coprocessor/dag/expr/constant.rs

14 
u£
 
	g¡d
::
bÜrow
::
Cow
;

16 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

17 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
Decim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gTime
};

18 
u£
 
	gsu³r
::{
CÚ¡ªt
, 
	gResuÉ
};

20 
im¶
 
	gD©um
 {

21 #[
šlše
]

22 
pub
 
â
 
as_št
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

23 
m©ch
 *
	g£lf
 {

24 
	gD©um
::
NuÎ
 => 
Ok
(
NÚe
),

25 
	gD©um
::
I64
(
i
è=> 
Ok
(
Some
(i)),

26 
	gD©um
::
U64
(
u
è=> 
Ok
(
Some
(u 
as
 
i64
)),

27 
	g_
 => 
E¼
(
box_”r
!("Can'tƒval_int from Datum")),

31 #[
šlše
]

32 
pub
 
â
 
as_»®
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gf64
>> {

33 
m©ch
 *
	g£lf
 {

34 
	gD©um
::
NuÎ
 => 
Ok
(
NÚe
),

35 
	gD©um
::
F64
(
f
è=> 
Ok
(
Some
(f)),

36 
	g_
 => 
E¼
(
box_”r
!("Can'tƒval_real from Datum")),

40 #[
šlše
]

41 
pub
 
â
 
as_decim®
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<
	gDecim®
>>> {

42 
m©ch
 *
	g£lf
 {

43 
	gD©um
::
NuÎ
 => 
Ok
(
NÚe
),

44 
	gD©um
::
Dec
(
»f
 
d
è=> 
Ok
(
Some
(
Cow
::
BÜrowed
(d))),

45 
	g_
 => 
E¼
(
box_”r
!("Can'tƒval_decimal from Datum")),

49 #[
šlše
]

50 
pub
 
â
 
as_¡ršg
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<[
u8
]>>> {

51 
m©ch
 *
	g£lf
 {

52 
	gD©um
::
NuÎ
 => 
Ok
(
NÚe
),

53 
	gD©um
::
By‹s
(
»f
 
b
è=> 
Ok
(
Some
(
Cow
::
BÜrowed
(b))),

54 
	g_
 => 
E¼
(
box_”r
!("Can'tƒval_string from Datum")),

58 #[
šlše
]

59 
pub
 
â
 
as_time
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<
	gTime
>>> {

60 
m©ch
 *
	g£lf
 {

61 
	gD©um
::
NuÎ
 => 
Ok
(
NÚe
),

62 
	gD©um
::
Time
(
»f
 
t
è=> 
Ok
(
Some
(
Cow
::
BÜrowed
(t))),

63 
	g_
 => 
E¼
(
box_”r
!("Can'tƒval_time from Datum")),

67 #[
šlše
]

68 
pub
 
â
 
as_du¿tiÚ
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<
	gDu¿tiÚ
>>> {

69 
m©ch
 *
	g£lf
 {

70 
	gD©um
::
NuÎ
 => 
Ok
(
NÚe
),

71 
	gD©um
::
Dur
(
»f
 
d
è=> 
Ok
(
Some
(
Cow
::
BÜrowed
(d))),

72 
	g_
 => 
E¼
(
box_”r
!("Can'tƒval_duration from Datum")),

76 #[
šlše
]

77 
pub
 
â
 
as_jsÚ
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<
	gJsÚ
>>> {

78 
m©ch
 *
	g£lf
 {

79 
	gD©um
::
NuÎ
 => 
Ok
(
NÚe
),

80 
	gD©um
::
JsÚ
(
»f
 
j
è=> 
Ok
(
Some
(
Cow
::
BÜrowed
(j))),

81 
	g_
 => 
E¼
(
box_”r
!("Can'tƒval_json from Datum")),

86 
im¶
 
	gCÚ¡ªt
 {

87 
pub
 
â
 
ev®
(&
£lf
è-> 
	gD©um
 {

88 
	g£lf
.
	gv®
.
şÚe
()

91 #[
šlše
]

92 
pub
 
â
 
ev®_št
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gi64
>> {

93 
	g£lf
.
	gv®
.
as_št
()

96 #[
šlše
]

97 
pub
 
â
 
ev®_»®
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gf64
>> {

98 
	g£lf
.
	gv®
.
as_»®
()

101 #[
šlše
]

102 
pub
 
â
 
ev®_decim®
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<
	gDecim®
>>> {

103 
	g£lf
.
	gv®
.
as_decim®
()

106 #[
šlše
]

107 
pub
 
â
 
ev®_¡ršg
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<[
u8
]>>> {

108 
	g£lf
.
	gv®
.
as_¡ršg
()

111 #[
šlše
]

112 
pub
 
â
 
ev®_time
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<
	gTime
>>> {

113 
	g£lf
.
	gv®
.
as_time
()

116 #[
šlše
]

117 
pub
 
â
 
ev®_du¿tiÚ
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<
	gDu¿tiÚ
>>> {

118 
	g£lf
.
	gv®
.
as_du¿tiÚ
()

121 #[
šlše
]

122 
pub
 
â
 
ev®_jsÚ
(&
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<
	gJsÚ
>>> {

123 
	g£lf
.
	gv®
.
as_jsÚ
()

127 #[
cfg
(
‹¡
)]

128 
mod
 
	g‹¡
 {

129 
u£
 
	g¡d
::
u64
;

130 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

131 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
Decim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gTime
};

132 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::{
Ex´essiÚ
, 
	gS‹m’tCÚ‹xt
};

133 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::
d©um_ex´
;

135 #[
d”ive
(
P¬tŸlEq
, 
Debug
)]

136 
Ev®ResuÉs
(

137 
O±iÚ
<
i64
>,

138 
O±iÚ
<
f64
>,

139 
O±iÚ
<
Decim®
>,

140 
O±iÚ
<
Vec
<
u8
>>,

141 
O±iÚ
<
Time
>,

142 
O±iÚ
<
Du¿tiÚ
>,

143 
O±iÚ
<
JsÚ
>,

146 #[
‹¡
]

147 
â
 
‹¡_cÚ¡ªt_ev®
() {

148 
Ët
 
	gdec
 = "1.1".
·r£
::<
Decim®
>().
unw¿p
();

149 
Ët
 
	gs
 = "ä½ å¥½".
as_by‹s
().
to_owÃd
();

150 
Ët
 
	gdur
 = 
Du¿tiÚ
::
·r£
(
b
"01:00:00", 0).
unw¿p
();

152 
Ët
 
	g‹¡s
 = 
vec
![

153 
d©um_ex´
(
D©um
::
NuÎ
),

154 
d©um_ex´
(
D©um
::
I64
(-30)),

155 
d©um_ex´
(
D©um
::
U64
(
u64
::
MAX
)),

156 
d©um_ex´
(
D©um
::
F64
(124.32)),

157 
d©um_ex´
(
D©um
::
Dec
(
dec
.
şÚe
())),

158 
d©um_ex´
(
D©um
::
By‹s
(
s
.
şÚe
())),

159 
d©um_ex´
(
D©um
::
Dur
(
dur
.
şÚe
())),

162 
Ët
 
	gex³ùeds
 = 
vec
![

163 
Ev®ResuÉs
(
NÚe
, None, None, None, None, None, None),

164 
Ev®ResuÉs
(
Some
(-30), 
NÚe
, None, None, None, None, None),

165 
Ev®ResuÉs
(
Some
(-1), 
NÚe
, None, None, None, None, None),

166 
Ev®ResuÉs
(
NÚe
, 
Some
(124.32), None, None, None, None, None),

167 
Ev®ResuÉs
(
NÚe
, NÚe, 
Some
(
dec
.
şÚe
()), None, None, None, None),

168 
Ev®ResuÉs
(
NÚe
, NÚe, NÚe, 
Some
(
s
.
şÚe
()), None, None, None),

169 
Ev®ResuÉs
(
NÚe
, NÚe, NÚe, NÚe, NÚe, 
Some
(
dur
.
şÚe
()), None),

172 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

173 , 
	gex³ùed
è
š
 
	g‹¡s
.
što_™”
().
z
(
ex³ùeds
.into_iter()) {

174 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, ).
unw¿p
();

176 
Ët
 
	gi
 = 
e
.
ev®_št
(&
ùx
, &[]).
unw¿p_Ü
(
NÚe
);

177 
Ët
 
	gr
 = 
e
.
ev®_»®
(&
ùx
, &[]).
unw¿p_Ü
(
NÚe
);

178 
Ët
 
	gdec
 = 
e
.
ev®_decim®
(&
ùx
, &[])

179 .
unw¿p_Ü
(
NÚe
)

180 .
m­
(|
t
|.
što_owÃd
());

181 
Ët
 
	gs
 = 
e
.
ev®_¡ršg
(&
ùx
, &[])

182 .
unw¿p_Ü
(
NÚe
)

183 .
m­
(|
t
|.
što_owÃd
());

184 
Ët
 
	gt
 = 
e
.
ev®_time
(&
ùx
, &[])

185 .
unw¿p_Ü
(
NÚe
)

186 .
m­
(|
t
|.
što_owÃd
());

187 
Ët
 
	gdur
 = 
e
.
ev®_du¿tiÚ
(&
ùx
, &[])

188 .
unw¿p_Ü
(
NÚe
)

189 .
m­
(|
t
|.
što_owÃd
());

190 
Ët
 
	gj
 = 
e
.
ev®_jsÚ
(&
ùx
, &[])

191 .
unw¿p_Ü
(
NÚe
)

192 .
m­
(|
t
|.
što_owÃd
());

194 
Ët
 
	g»suÉ
 = 
Ev®ResuÉs
(
i
, 
r
, 
dec
, 
s
, 
t
, 
dur
, 
j
);

195 
	gas£¹_eq
!(
	gex³ùed
, 
	g»suÉ
);

	@src/coprocessor/dag/expr/fncall.rs

14 
u£
 
	g¡d
::
bÜrow
::
Cow
;

15 
u£
 
	g¡d
::
usize
;

17 
u£
 
	gtb
::
ex´essiÚ
::
SÿÏrFuncSig
;

19 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

20 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
£lf
, 
	gDecim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gTime
};

21 
u£
 
	gsu³r
::{
E¼Ü
, 
	gFnC®l
, 
	gResuÉ
, 
	gS‹m’tCÚ‹xt
};

22 
u£
 
	gsu³r
::
com·»
::
CmpOp
;

24 
im¶
 
	gFnC®l
 {

25 
pub
 
â
 
check_¬gs
(
sig
: 
SÿÏrFuncSig
, 
¬gs
: 
usize
è-> 
ResuÉ
<()> {

26 
Ët
 (
mš_¬gs
, 
max_¬gs
èğ
m©ch
 
sig
 {

27 
SÿÏrFuncSig
::
LTIÁ
 |

28 
SÿÏrFuncSig
::
LEIÁ
 |

29 
SÿÏrFuncSig
::
GTIÁ
 |

30 
SÿÏrFuncSig
::
GEIÁ
 |

31 
SÿÏrFuncSig
::
EQIÁ
 |

32 
SÿÏrFuncSig
::
NEIÁ
 |

33 
SÿÏrFuncSig
::
NuÎEQIÁ
 |

34 
SÿÏrFuncSig
::
LTR—l
 |

35 
SÿÏrFuncSig
::
LER—l
 |

36 
SÿÏrFuncSig
::
GTR—l
 |

37 
SÿÏrFuncSig
::
GER—l
 |

38 
SÿÏrFuncSig
::
EQR—l
 |

39 
SÿÏrFuncSig
::
NER—l
 |

40 
SÿÏrFuncSig
::
NuÎEQR—l
 |

41 
SÿÏrFuncSig
::
LTDecim®
 |

42 
SÿÏrFuncSig
::
LEDecim®
 |

43 
SÿÏrFuncSig
::
GTDecim®
 |

44 
SÿÏrFuncSig
::
GEDecim®
 |

45 
SÿÏrFuncSig
::
EQDecim®
 |

46 
SÿÏrFuncSig
::
NEDecim®
 |

47 
SÿÏrFuncSig
::
NuÎEQDecim®
 |

48 
SÿÏrFuncSig
::
LTSŒšg
 |

49 
SÿÏrFuncSig
::
LESŒšg
 |

50 
SÿÏrFuncSig
::
GTSŒšg
 |

51 
SÿÏrFuncSig
::
GESŒšg
 |

52 
SÿÏrFuncSig
::
EQSŒšg
 |

53 
SÿÏrFuncSig
::
NESŒšg
 |

54 
SÿÏrFuncSig
::
NuÎEQSŒšg
 |

55 
SÿÏrFuncSig
::
LTTime
 |

56 
SÿÏrFuncSig
::
LETime
 |

57 
SÿÏrFuncSig
::
GTTime
 |

58 
SÿÏrFuncSig
::
GETime
 |

59 
SÿÏrFuncSig
::
EQTime
 |

60 
SÿÏrFuncSig
::
NETime
 |

61 
SÿÏrFuncSig
::
NuÎEQTime
 |

62 
SÿÏrFuncSig
::
LTDu¿tiÚ
 |

63 
SÿÏrFuncSig
::
LEDu¿tiÚ
 |

64 
SÿÏrFuncSig
::
GTDu¿tiÚ
 |

65 
SÿÏrFuncSig
::
GEDu¿tiÚ
 |

66 
SÿÏrFuncSig
::
EQDu¿tiÚ
 |

67 
SÿÏrFuncSig
::
NEDu¿tiÚ
 |

68 
SÿÏrFuncSig
::
NuÎEQDu¿tiÚ
 |

69 
SÿÏrFuncSig
::
LTJsÚ
 |

70 
SÿÏrFuncSig
::
LEJsÚ
 |

71 
SÿÏrFuncSig
::
GTJsÚ
 |

72 
SÿÏrFuncSig
::
GEJsÚ
 |

73 
SÿÏrFuncSig
::
EQJsÚ
 |

74 
SÿÏrFuncSig
::
NEJsÚ
 |

75 
SÿÏrFuncSig
::
NuÎEQJsÚ
 |

76 
SÿÏrFuncSig
::
PlusR—l
 |

77 
SÿÏrFuncSig
::
PlusDecim®
 |

78 
SÿÏrFuncSig
::
PlusIÁ
 |

79 
SÿÏrFuncSig
::
MšusR—l
 |

80 
SÿÏrFuncSig
::
MšusDecim®
 |

81 
SÿÏrFuncSig
::
MšusIÁ
 |

82 
SÿÏrFuncSig
::
MuÉlyR—l
 |

83 
SÿÏrFuncSig
::
MuÉlyDecim®
 |

84 
SÿÏrFuncSig
::
MuÉlyIÁ
 |

85 
SÿÏrFuncSig
::
IfNuÎIÁ
 |

86 
SÿÏrFuncSig
::
IfNuÎR—l
 |

87 
SÿÏrFuncSig
::
IfNuÎSŒšg
 |

88 
SÿÏrFuncSig
::
IfNuÎDecim®
 |

89 
SÿÏrFuncSig
::
IfNuÎTime
 |

90 
SÿÏrFuncSig
::
IfNuÎDu¿tiÚ
 |

91 
SÿÏrFuncSig
::
IfNuÎJsÚ
 |

92 
SÿÏrFuncSig
::
LogiÿlAnd
 |

93 
SÿÏrFuncSig
::
LogiÿlOr
 |

94 
SÿÏrFuncSig
::
LogiÿlXÜ
 |

95 
SÿÏrFuncSig
::
DivideDecim®
 |

96 
SÿÏrFuncSig
::
DivideR—l
 |

97 
SÿÏrFuncSig
::
B™AndSig
 |

98 
SÿÏrFuncSig
::
B™OrSig
 |

99 
SÿÏrFuncSig
::
B™XÜSig
 => (2, 2),

101 
	gSÿÏrFuncSig
::
Ca¡IÁAsIÁ
 |

102 
SÿÏrFuncSig
::
Ca¡IÁAsR—l
 |

103 
SÿÏrFuncSig
::
Ca¡IÁAsSŒšg
 |

104 
SÿÏrFuncSig
::
Ca¡IÁAsDecim®
 |

105 
SÿÏrFuncSig
::
Ca¡IÁAsTime
 |

106 
SÿÏrFuncSig
::
Ca¡IÁAsDu¿tiÚ
 |

107 
SÿÏrFuncSig
::
Ca¡IÁAsJsÚ
 |

108 
SÿÏrFuncSig
::
Ca¡R—lAsIÁ
 |

109 
SÿÏrFuncSig
::
Ca¡R—lAsR—l
 |

110 
SÿÏrFuncSig
::
Ca¡R—lAsSŒšg
 |

111 
SÿÏrFuncSig
::
Ca¡R—lAsDecim®
 |

112 
SÿÏrFuncSig
::
Ca¡R—lAsTime
 |

113 
SÿÏrFuncSig
::
Ca¡R—lAsDu¿tiÚ
 |

114 
SÿÏrFuncSig
::
Ca¡R—lAsJsÚ
 |

115 
SÿÏrFuncSig
::
Ca¡Decim®AsIÁ
 |

116 
SÿÏrFuncSig
::
Ca¡Decim®AsR—l
 |

117 
SÿÏrFuncSig
::
Ca¡Decim®AsSŒšg
 |

118 
SÿÏrFuncSig
::
Ca¡Decim®AsDecim®
 |

119 
SÿÏrFuncSig
::
Ca¡Decim®AsTime
 |

120 
SÿÏrFuncSig
::
Ca¡Decim®AsDu¿tiÚ
 |

121 
SÿÏrFuncSig
::
Ca¡Decim®AsJsÚ
 |

122 
SÿÏrFuncSig
::
Ca¡SŒšgAsIÁ
 |

123 
SÿÏrFuncSig
::
Ca¡SŒšgAsR—l
 |

124 
SÿÏrFuncSig
::
Ca¡SŒšgAsSŒšg
 |

125 
SÿÏrFuncSig
::
Ca¡SŒšgAsDecim®
 |

126 
SÿÏrFuncSig
::
Ca¡SŒšgAsTime
 |

127 
SÿÏrFuncSig
::
Ca¡SŒšgAsDu¿tiÚ
 |

128 
SÿÏrFuncSig
::
Ca¡SŒšgAsJsÚ
 |

129 
SÿÏrFuncSig
::
Ca¡TimeAsIÁ
 |

130 
SÿÏrFuncSig
::
Ca¡TimeAsR—l
 |

131 
SÿÏrFuncSig
::
Ca¡TimeAsSŒšg
 |

132 
SÿÏrFuncSig
::
Ca¡TimeAsDecim®
 |

133 
SÿÏrFuncSig
::
Ca¡TimeAsTime
 |

134 
SÿÏrFuncSig
::
Ca¡TimeAsDu¿tiÚ
 |

135 
SÿÏrFuncSig
::
Ca¡TimeAsJsÚ
 |

136 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsIÁ
 |

137 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsR—l
 |

138 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsSŒšg
 |

139 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsDecim®
 |

140 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsTime
 |

141 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsDu¿tiÚ
 |

142 
SÿÏrFuncSig
::
Ca¡Du¿tiÚAsJsÚ
 |

143 
SÿÏrFuncSig
::
Ca¡JsÚAsIÁ
 |

144 
SÿÏrFuncSig
::
Ca¡JsÚAsR—l
 |

145 
SÿÏrFuncSig
::
Ca¡JsÚAsSŒšg
 |

146 
SÿÏrFuncSig
::
Ca¡JsÚAsDecim®
 |

147 
SÿÏrFuncSig
::
Ca¡JsÚAsTime
 |

148 
SÿÏrFuncSig
::
Ca¡JsÚAsDu¿tiÚ
 |

149 
SÿÏrFuncSig
::
Ca¡JsÚAsJsÚ
 |

150 
SÿÏrFuncSig
::
UÇryNÙ
 |

151 
SÿÏrFuncSig
::
UÇryMšusIÁ
 |

152 
SÿÏrFuncSig
::
UÇryMšusR—l
 |

153 
SÿÏrFuncSig
::
UÇryMšusDecim®
 |

154 
SÿÏrFuncSig
::
IÁIsTrue
 |

155 
SÿÏrFuncSig
::
IÁIsF®£
 |

156 
SÿÏrFuncSig
::
IÁIsNuÎ
 |

157 
SÿÏrFuncSig
::
R—lIsTrue
 |

158 
SÿÏrFuncSig
::
R—lIsF®£
 |

159 
SÿÏrFuncSig
::
R—lIsNuÎ
 |

160 
SÿÏrFuncSig
::
Decim®IsTrue
 |

161 
SÿÏrFuncSig
::
Decim®IsF®£
 |

162 
SÿÏrFuncSig
::
Decim®IsNuÎ
 |

163 
SÿÏrFuncSig
::
SŒšgIsNuÎ
 |

164 
SÿÏrFuncSig
::
TimeIsNuÎ
 |

165 
SÿÏrFuncSig
::
Du¿tiÚIsNuÎ
 |

166 
SÿÏrFuncSig
::
JsÚIsNuÎ
 |

167 
SÿÏrFuncSig
::
AbsIÁ
 |

168 
SÿÏrFuncSig
::
AbsUIÁ
 |

169 
SÿÏrFuncSig
::
AbsR—l
 |

170 
SÿÏrFuncSig
::
AbsDecim®
 |

171 
SÿÏrFuncSig
::
CeR—l
 |

172 
SÿÏrFuncSig
::
CeIÁToIÁ
 |

173 
SÿÏrFuncSig
::
CeIÁToDec
 |

174 
SÿÏrFuncSig
::
CeDecToDec
 |

175 
SÿÏrFuncSig
::
CeDecToIÁ
 |

176 
SÿÏrFuncSig
::
FloÜR—l
 |

177 
SÿÏrFuncSig
::
FloÜIÁToIÁ
 |

178 
SÿÏrFuncSig
::
FloÜIÁToDec
 |

179 
SÿÏrFuncSig
::
FloÜDecToDec
 |

180 
SÿÏrFuncSig
::
FloÜDecToIÁ
 |

181 
SÿÏrFuncSig
::
JsÚTy³Sig
 |

182 
SÿÏrFuncSig
::
JsÚUnquÙeSig
 |

183 
SÿÏrFuncSig
::
B™NegSig
 => (1, 1),

185 
	gSÿÏrFuncSig
::
IfIÁ
 |

186 
SÿÏrFuncSig
::
IfR—l
 |

187 
SÿÏrFuncSig
::
IfSŒšg
 |

188 
SÿÏrFuncSig
::
IfDecim®
 |

189 
SÿÏrFuncSig
::
IfTime
 |

190 
SÿÏrFuncSig
::
IfDu¿tiÚ
 |

191 
SÿÏrFuncSig
::
IfJsÚ
 |

192 
SÿÏrFuncSig
::
LikeSig
 => (3, 3),

194 
	gSÿÏrFuncSig
::
JsÚA¼aySig
 | 
SÿÏrFuncSig
::
JsÚObjeùSig
 => (0, 
	gusize
::
MAX
),

196 
	gSÿÏrFuncSig
::
CßËsûDecim®
 |

197 
SÿÏrFuncSig
::
CßËsûDu¿tiÚ
 |

198 
SÿÏrFuncSig
::
CßËsûIÁ
 |

199 
SÿÏrFuncSig
::
CßËsûJsÚ
 |

200 
SÿÏrFuncSig
::
CßËsûR—l
 |

201 
SÿÏrFuncSig
::
CßËsûSŒšg
 |

202 
SÿÏrFuncSig
::
CßËsûTime
 |

203 
SÿÏrFuncSig
::
Ca£Wh’Decim®
 |

204 
SÿÏrFuncSig
::
Ca£Wh’Du¿tiÚ
 |

205 
SÿÏrFuncSig
::
Ca£Wh’IÁ
 |

206 
SÿÏrFuncSig
::
Ca£Wh’JsÚ
 |

207 
SÿÏrFuncSig
::
Ca£Wh’R—l
 |

208 
SÿÏrFuncSig
::
Ca£Wh’SŒšg
 |

209 
SÿÏrFuncSig
::
Ca£Wh’Time
 => (1, 
	gusize
::
MAX
),

211 
	gSÿÏrFuncSig
::
JsÚExŒaùSig
 |

212 
SÿÏrFuncSig
::
JsÚRemoveSig
 |

213 
SÿÏrFuncSig
::
JsÚM”geSig
 |

214 
SÿÏrFuncSig
::
InIÁ
 |

215 
SÿÏrFuncSig
::
InR—l
 |

216 
SÿÏrFuncSig
::
InSŒšg
 |

217 
SÿÏrFuncSig
::
InDecim®
 |

218 
SÿÏrFuncSig
::
InTime
 |

219 
SÿÏrFuncSig
::
InDu¿tiÚ
 |

220 
SÿÏrFuncSig
::
InJsÚ
 => (2, 
	gusize
::
MAX
),

222 
	gSÿÏrFuncSig
::
JsÚS‘Sig
 |

223 
SÿÏrFuncSig
::
JsÚIn£¹Sig
 |

224 
SÿÏrFuncSig
::
JsÚR•ÏûSig
 => (3, 
	gusize
::
MAX
),

226 
	g¬gs
 < 
	gmš_¬gs
 ||‡rg > 
	gmax_¬gs
 {

227  
E¼
(
box_”r
!("unexpected‡rguments"));

229 
Ët
 
	gÙh”_checks
 = 
m©ch
 
sig
 {

230 
SÿÏrFuncSig
::
JsÚObjeùSig
 => 
¬gs
 & 1 == 0,

231 
	gSÿÏrFuncSig
::
JsÚS‘Sig
 |

232 
SÿÏrFuncSig
::
JsÚIn£¹Sig
 |

233 
SÿÏrFuncSig
::
JsÚR•ÏûSig
 => 
¬gs
 & 1 == 1,

234 
	g_
 => 
Œue
,

236 !
	gÙh”_checks
 {

237  
E¼
(
box_”r
!("unexpected‡rguments"));

239 
Ok
(())

243 
	gmaüo_ruËs
! 
	gdi¥©ch_ÿÎ
 {

245 
	gINT_CALLS
 {
$
(
$i_sig
:
id’t
 => 
$i_func
:id’ˆ$(
$i_¬g
:
ex´
)*,)*}

246 
	gREAL_CALLS
 {
$
(
$r_sig
:
id’t
 => 
$r_func
:id’ˆ$(
$r_¬g
:
ex´
)*,)*}

247 
	gDEC_CALLS
 {
$
(
$d_sig
:
id’t
 => 
$d_func
:id’ˆ$(
$d_¬g
:
ex´
)*,)*}

248 
	gBYTES_CALLS
 {
$
(
$b_sig
:
id’t
 => 
$b_func
:id’ˆ$(
$b_¬g
:
ex´
)*,)*}

249 
	gTIME_CALLS
 {
$
(
$t_sig
:
id’t
 => 
$t_func
:id’ˆ$(
$t_¬g
:
ex´
)*,)*}

250 
	gDUR_CALLS
 {
$
(
$u_sig
:
id’t
 => 
$u_func
:id’ˆ$(
$u_¬g
:
ex´
)*,)*}

251 
	gJSON_CALLS
 {
$
(
$j_sig
:
id’t
 => 
$j_func
:id’ˆ$(
$j_¬g
:
ex´
)*,)*}

253 
im¶
 
FnC®l
 {

254 
pub
 
â
 
ev®_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

255 
m©ch
 
£lf
.
sig
 {

256 
$
(
SÿÏrFuncSig
::
$i_sig
 => 
£lf
.
$i_func
(
ùx
, 
row
, $(
$i_¬g
),*)),*,

257 
	g_
 => 
E¼
(
E¼Ü
::
UnknownSigÇtu»
(
£lf
.
sig
))

261 
pub
 
â
 
ev®_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

262 
m©ch
 
£lf
.
sig
 {

263 
$
(
SÿÏrFuncSig
::
$r_sig
 => 
£lf
.
$r_func
(
ùx
, 
row
, $(
$r_¬g
),*),)*

264 
	g_
 => 
E¼
(
E¼Ü
::
UnknownSigÇtu»
(
£lf
.
sig
))

268 
pub
 
â
 
ev®_decim®
<'a, '
b
: 'a>(

270 
row
: &'a [Datum]

271 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

272 
m©ch
 
£lf
.
sig
 {

273 
$
(
SÿÏrFuncSig
::
$d_sig
 => 
£lf
.
$d_func
(
ùx
, 
row
, $(
$d_¬g
),*),)*

274 
	g_
 => 
E¼
(
E¼Ü
::
UnknownSigÇtu»
(
£lf
.
sig
))

278 
pub
 
â
 
ev®_by‹s
<'a, '
b
: 'a>(

280 
ùx
: &
S‹m’tCÚ‹xt
,

281 
	grow
: &'a [Datum]

282 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

283 
m©ch
 
£lf
.
sig
 {

284 
$
(
SÿÏrFuncSig
::
$b_sig
 => 
£lf
.
$b_func
(
ùx
, 
row
, $(
$b_¬g
),*),)*

285 
	g_
 => 
E¼
(
E¼Ü
::
UnknownSigÇtu»
(
£lf
.
sig
))

289 
pub
 
â
 
ev®_time
<'a, '
b
: 'a>(

291 
ùx
: &
S‹m’tCÚ‹xt
,

292 
	grow
: &'a [Datum]

293 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

294 
m©ch
 
£lf
.
sig
 {

295 
$
(
SÿÏrFuncSig
::
$t_sig
 => 
£lf
.
$t_func
(
ùx
, 
row
, $(
$t_¬g
),*),)*

296 
	g_
 => 
E¼
(
E¼Ü
::
UnknownSigÇtu»
(
£lf
.
sig
))

300 
pub
 
â
 
ev®_du¿tiÚ
<'a, '
b
: 'a>(

302 
ùx
: &
S‹m’tCÚ‹xt
,

303 
	grow
: &'a [Datum]

304 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

305 
m©ch
 
£lf
.
sig
 {

306 
$
(
SÿÏrFuncSig
::
$u_sig
 => 
£lf
.
$u_func
(
ùx
, 
row
, $(
$u_¬g
),*),)*

307 
	g_
 => 
E¼
(
E¼Ü
::
UnknownSigÇtu»
(
£lf
.
sig
))

311 
pub
 
â
 
ev®_jsÚ
<'a, '
b
: 'a>(

313 
ùx
: &
S‹m’tCÚ‹xt
,

314 
	grow
: &'a [Datum]

315 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

316 
m©ch
 
£lf
.
sig
 {

317 
$
(
SÿÏrFuncSig
::
$j_sig
 => 
£lf
.
$j_func
(
ùx
, 
row
, $(
$j_¬g
),*),)*

318 
	g_
 => 
E¼
(
E¼Ü
::
UnknownSigÇtu»
(
£lf
.
sig
))

322 
pub
 
â
 
ev®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<Datum> {

323 
m©ch
 
£lf
.
sig
 {

324 
$
(
SÿÏrFuncSig
::
$i_sig
 => {

325 
m©ch
 
£lf
.
$i_func
(
ùx
, 
row
, 
$
(
$i_¬g
)*) {

326 
Ok
(
Some
(
i
)) => {

327 
mysql
::
has_unsigÃd_æag
(
£lf
.

.
g‘_æag
(è
as
 
u64
) {

328 
Ok
(
D©um
::
U64
(
i
 
as
 
u64
))

330 
Ok
(
D©um
::
I64
(
i
))

333 
Ok
(
NÚe
è=> Ok(
D©um
::
NuÎ
),

334 
E¼
(
e
) => Err(e),

337 
$
(
SÿÏrFuncSig
::
$r_sig
 => {

338 
£lf
.
$r_func
(
ùx
, 
row
, 
$
(
$r_¬g
)*).
m­
(
D©um
::
äom
)

340 
$
(
SÿÏrFuncSig
::
$d_sig
 => {

341 
£lf
.
$d_func
(
ùx
, 
row
, 
$
(
$d_¬g
)*).
m­
(
D©um
::
äom
)

343 
$
(
SÿÏrFuncSig
::
$b_sig
 => {

344 
£lf
.
$b_func
(
ùx
, 
row
, 
$
(
$b_¬g
)*).
m­
(
D©um
::
äom
)

346 
$
(
SÿÏrFuncSig
::
$t_sig
 => {

347 
£lf
.
$t_func
(
ùx
, 
row
, 
$
(
$t_¬g
)*).
m­
(
D©um
::
äom
)

349 
$
(
SÿÏrFuncSig
::
$u_sig
 => {

350 
£lf
.
$u_func
(
ùx
, 
row
, 
$
(
$u_¬g
)*).
m­
(
D©um
::
äom
)

352 
$
(
SÿÏrFuncSig
::
$j_sig
 => {

353 
£lf
.
$j_func
(
ùx
, 
row
, 
$
(
$j_¬g
)*).
m­
(
D©um
::
äom
)

361 
	gdi¥©ch_ÿÎ
! {

362 
	gINT_CALLS
 {

363 
	gLTIÁ
 => 
com·»_št
 
CmpOp
::
LT
,

364 
	gLEIÁ
 => 
com·»_št
 
CmpOp
::
LE
,

365 
	gGTIÁ
 => 
com·»_št
 
CmpOp
::
GT
,

366 
	gGEIÁ
 => 
com·»_št
 
CmpOp
::
GE
,

367 
	gEQIÁ
 => 
com·»_št
 
CmpOp
::
EQ
,

368 
	gNEIÁ
 => 
com·»_št
 
CmpOp
::
NE
,

369 
	gNuÎEQIÁ
 => 
com·»_št
 
CmpOp
::
NuÎEQ
,

371 
	gLTR—l
 => 
com·»_»®
 
CmpOp
::
LT
,

372 
	gLER—l
 => 
com·»_»®
 
CmpOp
::
LE
,

373 
	gGTR—l
 => 
com·»_»®
 
CmpOp
::
GT
,

374 
	gGER—l
 => 
com·»_»®
 
CmpOp
::
GE
,

375 
	gEQR—l
 => 
com·»_»®
 
CmpOp
::
EQ
,

376 
	gNER—l
 => 
com·»_»®
 
CmpOp
::
NE
,

377 
	gNuÎEQR—l
 => 
com·»_»®
 
CmpOp
::
NuÎEQ
,

379 
	gLTDecim®
 => 
com·»_decim®
 
CmpOp
::
LT
,

380 
	gLEDecim®
 => 
com·»_decim®
 
CmpOp
::
LE
,

381 
	gGTDecim®
 => 
com·»_decim®
 
CmpOp
::
GT
,

382 
	gGEDecim®
 => 
com·»_decim®
 
CmpOp
::
GE
,

383 
	gEQDecim®
 => 
com·»_decim®
 
CmpOp
::
EQ
,

384 
	gNEDecim®
 => 
com·»_decim®
 
CmpOp
::
NE
,

385 
	gNuÎEQDecim®
 => 
com·»_decim®
 
CmpOp
::
NuÎEQ
,

387 
	gLTSŒšg
 => 
com·»_¡ršg
 
CmpOp
::
LT
,

388 
	gLESŒšg
 => 
com·»_¡ršg
 
CmpOp
::
LE
,

389 
	gGTSŒšg
 => 
com·»_¡ršg
 
CmpOp
::
GT
,

390 
	gGESŒšg
 => 
com·»_¡ršg
 
CmpOp
::
GE
,

391 
	gEQSŒšg
 => 
com·»_¡ršg
 
CmpOp
::
EQ
,

392 
	gNESŒšg
 => 
com·»_¡ršg
 
CmpOp
::
NE
,

393 
	gNuÎEQSŒšg
 => 
com·»_¡ršg
 
CmpOp
::
NuÎEQ
,

395 
	gLTTime
 => 
com·»_time
 
CmpOp
::
LT
,

396 
	gLETime
 => 
com·»_time
 
CmpOp
::
LE
,

397 
	gGTTime
 => 
com·»_time
 
CmpOp
::
GT
,

398 
	gGETime
 => 
com·»_time
 
CmpOp
::
GE
,

399 
	gEQTime
 => 
com·»_time
 
CmpOp
::
EQ
,

400 
	gNETime
 => 
com·»_time
 
CmpOp
::
NE
,

401 
	gNuÎEQTime
 => 
com·»_time
 
CmpOp
::
NuÎEQ
,

403 
	gLTDu¿tiÚ
 => 
com·»_du¿tiÚ
 
CmpOp
::
LT
,

404 
	gLEDu¿tiÚ
 => 
com·»_du¿tiÚ
 
CmpOp
::
LE
,

405 
	gGTDu¿tiÚ
 => 
com·»_du¿tiÚ
 
CmpOp
::
GT
,

406 
	gGEDu¿tiÚ
 => 
com·»_du¿tiÚ
 
CmpOp
::
GE
,

407 
	gEQDu¿tiÚ
 => 
com·»_du¿tiÚ
 
CmpOp
::
EQ
,

408 
	gNEDu¿tiÚ
 => 
com·»_du¿tiÚ
 
CmpOp
::
NE
,

409 
	gNuÎEQDu¿tiÚ
 => 
com·»_du¿tiÚ
 
CmpOp
::
NuÎEQ
,

411 
	gLTJsÚ
 => 
com·»_jsÚ
 
CmpOp
::
LT
,

412 
	gLEJsÚ
 => 
com·»_jsÚ
 
CmpOp
::
LE
,

413 
	gGTJsÚ
 => 
com·»_jsÚ
 
CmpOp
::
GT
,

414 
	gGEJsÚ
 => 
com·»_jsÚ
 
CmpOp
::
GE
,

415 
	gEQJsÚ
 => 
com·»_jsÚ
 
CmpOp
::
EQ
,

416 
	gNEJsÚ
 => 
com·»_jsÚ
 
CmpOp
::
NE
,

417 
	gNuÎEQJsÚ
 => 
com·»_jsÚ
 
CmpOp
::
NuÎEQ
,

419 
	gCa¡IÁAsIÁ
 => 
ÿ¡_št_as_št
,

420 
	gCa¡R—lAsIÁ
 => 
ÿ¡_»®_as_št
,

421 
	gCa¡Decim®AsIÁ
 => 
ÿ¡_decim®_as_št
,

422 
	gCa¡SŒšgAsIÁ
 => 
ÿ¡_¡r_as_št
,

423 
	gCa¡TimeAsIÁ
 => 
ÿ¡_time_as_št
,

424 
	gCa¡Du¿tiÚAsIÁ
 => 
ÿ¡_du¿tiÚ_as_št
,

425 
	gCa¡JsÚAsIÁ
 => 
ÿ¡_jsÚ_as_št
,

427 
	gInIÁ
 => 
š_št
,

428 
	gInR—l
 => 
š_»®
,

429 
	gInDecim®
 => 
š_decim®
,

430 
	gInSŒšg
 => 
š_¡ršg
,

431 
	gInTime
 => 
š_time
,

432 
	gInDu¿tiÚ
 => 
š_du¿tiÚ
,

433 
	gInJsÚ
 => 
š_jsÚ
,

435 
	gPlusIÁ
 => 
¶us_št
,

436 
	gMšusIÁ
 => 
mšus_št
,

437 
	gMuÉlyIÁ
 => 
muÉly_št
,

439 
	gLogiÿlAnd
 => 
logiÿl_ªd
,

440 
	gLogiÿlOr
 => 
logiÿl_Ü
,

441 
	gLogiÿlXÜ
 => 
logiÿl_xÜ
,

443 
	gUÇryNÙ
 => 
uÇry_nÙ
,

444 
	gUÇryMšusIÁ
 => 
uÇry_mšus_št
,

445 
	gIÁIsNuÎ
 => 
št_is_nuÎ
,

446 
	gIÁIsF®£
 => 
št_is_çl£
,

447 
	gIÁIsTrue
 => 
št_is_Œue
,

448 
	gR—lIsTrue
 => 
»®_is_Œue
,

449 
	gR—lIsF®£
 => 
»®_is_çl£
,

450 
	gR—lIsNuÎ
 => 
»®_is_nuÎ
,

451 
	gDecim®IsNuÎ
 => 
decim®_is_nuÎ
,

452 
	gDecim®IsTrue
 => 
decim®_is_Œue
,

453 
	gDecim®IsF®£
 => 
decim®_is_çl£
,

454 
	gSŒšgIsNuÎ
 => 
¡ršg_is_nuÎ
,

455 
	gTimeIsNuÎ
 => 
time_is_nuÎ
,

456 
	gDu¿tiÚIsNuÎ
 => 
du¿tiÚ_is_nuÎ
,

457 
	gJsÚIsNuÎ
 => 
jsÚ_is_nuÎ
,

459 
	gAbsIÁ
 => 
abs_št
,

460 
	gAbsUIÁ
 => 
abs_ušt
,

461 
	gCeIÁToIÁ
 => 
û_št_to_št
,

462 
	gCeDecToIÁ
 => 
û_dec_to_št
,

463 
	gFloÜIÁToIÁ
 => 
æoÜ_št_to_št
,

464 
	gFloÜDecToIÁ
 => 
æoÜ_dec_to_št
,

466 
	gIfNuÎIÁ
 => 
if_nuÎ_št
,

467 
	gIfIÁ
 => 
if_št
,

469 
	gCßËsûIÁ
 => 
cßËsû_št
,

470 
	gCa£Wh’IÁ
 => 
ÿ£_wh’_št
,

472 
	gLikeSig
 => 
like
,

474 
	gB™AndSig
 => 
b™_ªd
,

475 
	gB™NegSig
 => 
b™_Ãg
,

476 
	gB™OrSig
 => 
b™_Ü
,

477 
	gB™XÜSig
 => 
b™_xÜ
,

479 
	gREAL_CALLS
 {

480 
	gCa¡IÁAsR—l
 => 
ÿ¡_št_as_»®
,

481 
	gCa¡R—lAsR—l
 => 
ÿ¡_»®_as_»®
,

482 
	gCa¡Decim®AsR—l
 => 
ÿ¡_decim®_as_»®
,

483 
	gCa¡SŒšgAsR—l
 => 
ÿ¡_¡r_as_»®
,

484 
	gCa¡TimeAsR—l
 => 
ÿ¡_time_as_»®
,

485 
	gCa¡Du¿tiÚAsR—l
 => 
ÿ¡_du¿tiÚ_as_»®
,

486 
	gCa¡JsÚAsR—l
 => 
ÿ¡_jsÚ_as_»®
,

487 
	gUÇryMšusR—l
 => 
uÇry_mšus_»®
,

489 
	gPlusR—l
 => 
¶us_»®
,

490 
	gMšusR—l
 => 
mšus_»®
,

491 
	gMuÉlyR—l
 => 
muÉly_»®
,

493 
	gAbsR—l
 => 
abs_»®
,

494 
	gCeR—l
 => 
û_»®
,

495 
	gFloÜR—l
 => 
æoÜ_»®
,

497 
	gIfNuÎR—l
 => 
if_nuÎ_»®
,

498 
	gIfR—l
 => 
if_»®
,

500 
	gCßËsûR—l
 => 
cßËsû_»®
,

501 
	gCa£Wh’R—l
 => 
ÿ£_wh’_»®
,

502 
	gDivideR—l
 => 
divide_»®
,

504 
	gDEC_CALLS
 {

505 
	gCa¡IÁAsDecim®
 => 
ÿ¡_št_as_decim®
,

506 
	gCa¡R—lAsDecim®
 => 
ÿ¡_»®_as_decim®
,

507 
	gCa¡Decim®AsDecim®
 => 
ÿ¡_decim®_as_decim®
,

508 
	gCa¡SŒšgAsDecim®
 => 
ÿ¡_¡r_as_decim®
,

509 
	gCa¡TimeAsDecim®
 => 
ÿ¡_time_as_decim®
,

510 
	gCa¡Du¿tiÚAsDecim®
 => 
ÿ¡_du¿tiÚ_as_decim®
,

511 
	gCa¡JsÚAsDecim®
 => 
ÿ¡_jsÚ_as_decim®
,

512 
	gUÇryMšusDecim®
 => 
uÇry_mšus_decim®
,

514 
	gPlusDecim®
 => 
¶us_decim®
,

515 
	gMšusDecim®
 => 
mšus_decim®
,

516 
	gMuÉlyDecim®
 => 
muÉly_decim®
,

518 
	gAbsDecim®
 => 
abs_decim®
,

519 
	gCeDecToDec
 => 
û_dec_to_dec
,

520 
	gCeIÁToDec
 => 
ÿ¡_št_as_decim®
,

521 
	gFloÜDecToDec
 => 
æoÜ_dec_to_dec
,

522 
	gFloÜIÁToDec
 => 
ÿ¡_št_as_decim®
,

524 
	gIfNuÎDecim®
 => 
if_nuÎ_decim®
,

525 
	gIfDecim®
 => 
if_decim®
,

527 
	gCßËsûDecim®
 => 
cßËsû_decim®
,

528 
	gCa£Wh’Decim®
 => 
ÿ£_wh’_decim®
,

529 
	gDivideDecim®
 => 
divide_decim®
,

531 
	gBYTES_CALLS
 {

532 
	gCa¡IÁAsSŒšg
 => 
ÿ¡_št_as_¡r
,

533 
	gCa¡R—lAsSŒšg
 => 
ÿ¡_»®_as_¡r
,

534 
	gCa¡Decim®AsSŒšg
 => 
ÿ¡_decim®_as_¡r
,

535 
	gCa¡SŒšgAsSŒšg
 => 
ÿ¡_¡r_as_¡r
,

536 
	gCa¡TimeAsSŒšg
 => 
ÿ¡_time_as_¡r
,

537 
	gCa¡Du¿tiÚAsSŒšg
 => 
ÿ¡_du¿tiÚ_as_¡r
,

538 
	gCa¡JsÚAsSŒšg
 => 
ÿ¡_jsÚ_as_¡r
,

540 
	gIfNuÎSŒšg
 => 
if_nuÎ_¡ršg
,

541 
	gIfSŒšg
 => 
if_¡ršg
,

543 
	gCßËsûSŒšg
 => 
cßËsû_¡ršg
,

544 
	gCa£Wh’SŒšg
 => 
ÿ£_wh’_¡ršg
,

545 
	gJsÚTy³Sig
 => 
jsÚ_ty³
,

546 
	gJsÚUnquÙeSig
 => 
jsÚ_unquÙe
,

548 
	gTIME_CALLS
 {

549 
	gCa¡IÁAsTime
 => 
ÿ¡_št_as_time
,

550 
	gCa¡R—lAsTime
 => 
ÿ¡_»®_as_time
,

551 
	gCa¡Decim®AsTime
 => 
ÿ¡_decim®_as_time
,

552 
	gCa¡SŒšgAsTime
 => 
ÿ¡_¡r_as_time
,

553 
	gCa¡TimeAsTime
 => 
ÿ¡_time_as_time
,

554 
	gCa¡Du¿tiÚAsTime
 => 
ÿ¡_du¿tiÚ_as_time
,

555 
	gCa¡JsÚAsTime
 => 
ÿ¡_jsÚ_as_time
,

557 
	gIfNuÎTime
 => 
if_nuÎ_time
,

558 
	gIfTime
 => 
if_time
,

560 
	gCßËsûTime
 => 
cßËsû_time
,

561 
	gCa£Wh’Time
 => 
ÿ£_wh’_time
,

563 
	gDUR_CALLS
 {

564 
	gCa¡IÁAsDu¿tiÚ
 => 
ÿ¡_št_as_du¿tiÚ
,

565 
	gCa¡R—lAsDu¿tiÚ
 => 
ÿ¡_»®_as_du¿tiÚ
,

566 
	gCa¡Decim®AsDu¿tiÚ
 => 
ÿ¡_decim®_as_du¿tiÚ
,

567 
	gCa¡SŒšgAsDu¿tiÚ
 => 
ÿ¡_¡r_as_du¿tiÚ
,

568 
	gCa¡TimeAsDu¿tiÚ
 => 
ÿ¡_time_as_du¿tiÚ
,

569 
	gCa¡Du¿tiÚAsDu¿tiÚ
 => 
ÿ¡_du¿tiÚ_as_du¿tiÚ
,

570 
	gCa¡JsÚAsDu¿tiÚ
 => 
ÿ¡_jsÚ_as_du¿tiÚ
,

572 
	gIfNuÎDu¿tiÚ
 => 
if_nuÎ_du¿tiÚ
,

573 
	gIfDu¿tiÚ
 => 
if_du¿tiÚ
,

575 
	gCßËsûDu¿tiÚ
 => 
cßËsû_du¿tiÚ
,

576 
	gCa£Wh’Du¿tiÚ
 => 
ÿ£_wh’_du¿tiÚ
,

578 
	gJSON_CALLS
 {

579 
	gCa¡IÁAsJsÚ
 => 
ÿ¡_št_as_jsÚ
,

580 
	gCa¡R—lAsJsÚ
 => 
ÿ¡_»®_as_jsÚ
,

581 
	gCa¡Decim®AsJsÚ
 => 
ÿ¡_decim®_as_jsÚ
,

582 
	gCa¡SŒšgAsJsÚ
 => 
ÿ¡_¡r_as_jsÚ
,

583 
	gCa¡TimeAsJsÚ
 => 
ÿ¡_time_as_jsÚ
,

584 
	gCa¡Du¿tiÚAsJsÚ
 => 
ÿ¡_du¿tiÚ_as_jsÚ
,

585 
	gCa¡JsÚAsJsÚ
 => 
ÿ¡_jsÚ_as_jsÚ
,

587 
	gCßËsûJsÚ
 => 
cßËsû_jsÚ
,

588 
	gCa£Wh’JsÚ
 => 
ÿ£_wh’_jsÚ
,

590 
	gIfJsÚ
 => 
if_jsÚ
,

591 
	gIfNuÎJsÚ
 => 
if_nuÎ_jsÚ
,

593 
	gJsÚExŒaùSig
 => 
jsÚ_exŒaù
,

594 
	gJsÚS‘Sig
 => 
jsÚ_£t
,

595 
	gJsÚIn£¹Sig
 => 
jsÚ_š£¹
,

596 
	gJsÚR•ÏûSig
 => 
jsÚ_»¶aû
,

597 
	gJsÚRemoveSig
 => 
jsÚ_»move
,

598 
	gJsÚM”geSig
 => 
jsÚ_m”ge
,

599 
	gJsÚA¼aySig
 => 
jsÚ_¬¿y
,

600 
	gJsÚObjeùSig
 => 
jsÚ_objeù
,

	@src/coprocessor/dag/expr/json.rs

14 
u£
 
	g¡d
::
bÜrow
::
Cow
;

15 
u£
 
	g¡d
::
cŞËùiÚs
::
BT»eM­
;

16 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

17 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
JsÚ
;

18 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
jsÚ
::{
·r£_jsÚ_·th_ex´
, 
	gModifyTy³
, 
	gP©hEx´essiÚ
};

19 
u£
 
	gsu³r
::{
E¼Ü
, 
	gEx´essiÚ
, 
	gFnC®l
, 
	gResuÉ
, 
	gS‹m’tCÚ‹xt
};

21 
im¶
 
	gFnC®l
 {

22 #[
šlše
]

23 
pub
 
â
 
	gjsÚ_ty³
<'a, '
	gb
: 'a>(

25 
ùx
: &
S‹m’tCÚ‹xt
,

26 
	grow
: &'a [Datum],

27 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

28 
Ët
 
j
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
));

29 
Ok
(
Some
(
Cow
::
BÜrowed
(
j
.
jsÚ_ty³
())))

32 #[
šlše
]

33 
pub
 
â
 
jsÚ_unquÙe
<'a, '
b
: 'a>(

35 
ùx
: &
S‹m’tCÚ‹xt
,

36 
	grow
: &'a [Datum],

37 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

38 
Ët
 
j
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
));

39 
	gj
.
unquÙe
()

40 .
m­_”r
(
E¼Ü
::
äom
)

41 .
m­
(|
s
| 
Some
(
Cow
::
OwÃd
(s.
što_by‹s
())))

44 
pub
 
â
 
jsÚ_¬¿y
<'a, '
b
: 'a>(

46 
ùx
: &
S‹m’tCÚ‹xt
,

47 
	grow
: &'a [Datum],

48 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

49 
Ët
 
·r£r
 = 
JsÚFuncArgsP¬£r
::
Ãw
(
ùx
, 
row
);

50 
Ët
 
	g–ems
 = 
Œy_İt
!(
£lf
.
chd»n
.
™”
().
m­
(|
e
| 
·r£r
.
g‘_jsÚ
Ó)).
cŞËù
());

51 
Ok
(
Some
(
Cow
::
OwÃd
(
JsÚ
::
A¼ay
(
–ems
))))

54 
pub
 
â
 
jsÚ_objeù
<'a, '
b
: 'a>(

56 
ùx
: &
S‹m’tCÚ‹xt
,

57 
	grow
: &'a [Datum],

58 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

59 
Ët
 
mut
 
·œs
 = 
BT»eM­
::
Ãw
();

60 
Ët
 
	g·r£r
 = 
JsÚFuncArgsP¬£r
::
Ãw
(
ùx
, 
row
);

61 
chunk
 
š
 
	g£lf
.
	gchd»n
.
	$chunks
(2) {

62 
Ët
 
key
 = 
Œy_İt
!(
chunk
[0].
	`ev®_¡ršg_ªd_decode
(
ùx
, 
row
)).
	`što_owÃd
();

63 
Ët
 
v®
 = 
Œy_İt
!(
·r£r
.
	`g‘_jsÚ
(&
chunk
[1]));

64 
·œs
.
	`š£¹
(
key
, 
v®
);

65 
	}
}

66 
Ok
(
Some
(
Cow
::
OwÃd
(
JsÚ
::
Objeù
(
·œs
))))

69 
pub
 
â
 
jsÚ_exŒaù
<'a, '
b
: 'a>(

71 
ùx
: &
S‹m’tCÚ‹xt
,

72 
	grow
: &'a [Datum],

73 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

75 
Ët
 
j
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
));

76 
Ët
 
	g·r£r
 = 
JsÚFuncArgsP¬£r
::
Ãw
(
ùx
, 
row
);

77 
Ët
 
	g·th_ex´s
: 
Vec
<
_
> = 
Œy_İt
!(
·r£r
.
g‘_·th_ex´s
(&
£lf
.
chd»n
[1..]));

78 
Ok
(
j
.
exŒaù
(&
·th_ex´s
).
m­
(
Cow
::
OwÃd
))

81 #[
šlše
]

82 
pub
 
â
 
jsÚ_£t
<'a, '
b
: 'a>(

84 
ùx
: &
S‹m’tCÚ‹xt
,

85 
	grow
: &'a [Datum],

86 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

87 
£lf
.
jsÚ_modify
(
ùx
, 
row
, 
ModifyTy³
::
S‘
)

90 #[
šlše
]

91 
pub
 
â
 
jsÚ_š£¹
<'a, '
b
: 'a>(

93 
ùx
: &
S‹m’tCÚ‹xt
,

94 
	grow
: &'a [Datum],

95 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

96 
£lf
.
jsÚ_modify
(
ùx
, 
row
, 
ModifyTy³
::
In£¹
)

99 #[
šlše
]

100 
pub
 
â
 
jsÚ_»¶aû
<'a, '
b
: 'a>(

102 
ùx
: &
S‹m’tCÚ‹xt
,

103 
	grow
: &'a [Datum],

104 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

105 
£lf
.
jsÚ_modify
(
ùx
, 
row
, 
ModifyTy³
::
R•Ïû
)

108 
pub
 
â
 
jsÚ_»move
<'a, '
b
: 'a>(

110 
ùx
: &
S‹m’tCÚ‹xt
,

111 
	grow
: &'a [Datum],

112 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

113 
Ët
 
mut
 
j
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
)).
što_owÃd
();

114 
Ët
 
	g·r£r
 = 
JsÚFuncArgsP¬£r
::
Ãw
(
ùx
, 
row
);

115 
Ët
 
	g·th_ex´s
: 
Vec
<
_
> = 
Œy_İt
!(
·r£r
.
g‘_·th_ex´s
(&
£lf
.
chd»n
[1..]));

116 
	gj
.
»move
(&
·th_ex´s
)

117 .
m­
(|
_
| 
Some
(
Cow
::
OwÃd
(
j
)))

118 .
m­_”r
(
E¼Ü
::
äom
)

121 
pub
 
â
 
jsÚ_m”ge
<'a, '
b
: 'a>(

123 
ùx
: &
S‹m’tCÚ‹xt
,

124 
	grow
: &'a [Datum],

125 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

126 
Ët
 
·r£r
 = 
JsÚFuncArgsP¬£r
::
Ãw
(
ùx
, 
row
);

127 
Ët
 
mut
 
	gh—d
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
)).
što_owÃd
();

128 
e
 
	gš
 &
	g£lf
.
	gchd»n
[1..] {

129 
Ët
 
	gsuffix
 = 
Œy_İt
!(
·r£r
.
g‘_jsÚ_nÙ_nÚe
(
e
));

130 
	gh—d
 = 
h—d
.
m”ge
(
suffix
);

132 
Ok
(
Some
(
Cow
::
OwÃd
(
h—d
)))

135 
â
 
jsÚ_modify
<'a, '
b
: 'a>(

137 
ùx
: &
S‹m’tCÚ‹xt
,

138 
	grow
: &'a [Datum],

139 
mt
: 
ModifyTy³
,

140 è-> 
	gResuÉ
<
	gO±iÚ
<
	gCow
<'a, Json>>> {

141 
Ët
 
mut
 
	gj
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_jsÚ
(
ùx
, 
row
)).
što_owÃd
();

142 
Ët
 
	g·r£r
 = 
JsÚFuncArgsP¬£r
::
Ãw
(
ùx
, 
row
);

143 
Ët
 
mut
 
	g·th_ex´s
 = 
Vec
::
w™h_ÿ·c™y
(
£lf
.
chd»n
.
Ën
() / 2);

144 
Ët
 
mut
 
	gv®ues
 = 
Vec
::
w™h_ÿ·c™y
(
£lf
.
chd»n
.
Ën
() / 2);

145 
chunk
 
š
 
	g£lf
.
	gchd»n
[1..].
	$chunks
(2) {

146 
·th_ex´s
.
	`push
(
Œy_İt
!(
·r£r
.
	`g‘_·th_ex´
(&
chunk
[0])));

147 
v®ues
.
	`push
(
Œy_İt
!(
·r£r
.
	`g‘_jsÚ
(&
chunk
[1])));

148 
	}
}

149 
	gj
.
modify
(&
·th_ex´s
, 
v®ues
, 
mt
)

150 .
m­
(|
_
| 
Some
(
Cow
::
OwÃd
(
j
)))

151 .
m­_”r
(
E¼Ü
::
äom
)

155 
JsÚFuncArgsP¬£r
<'a> {

156 
ùx
: &'a StatementContext,

157 
row
: &'a [Datum],

160 
im¶
<'a> JsÚFuncArgsP¬£r<'
a
> {

161 #[
šlše
]

162 
â
 
Ãw
(
ùx
: &'¨S‹m’tCÚ‹xt,„ow: &'
a
 [
D©um
]è-> 
S–f
 {

163 
JsÚFuncArgsP¬£r
 { 
ùx
: ctx, 
	grow
: 
row
 }

166 
â
 
g‘_·th_ex´
(&
£lf
, 
e
: &
Ex´essiÚ
è-> 
ResuÉ
<
O±iÚ
<
P©hEx´essiÚ
>> {

167 
Ët
 
s
 = 
Œy_İt
!(
e
.
ev®_¡ršg_ªd_decode
(
£lf
.
ùx
, s–f.
row
));

168 
Ët
 
	gex´
 = 
·r£_jsÚ_·th_ex´
(&
s
)?;

169 
Ok
(
Some
(
ex´
))

172 
â
 
g‘_·th_ex´s
(&
£lf
, 
es
: &[
Ex´essiÚ
]è-> 
ResuÉ
<
O±iÚ
<
Vec
<
P©hEx´essiÚ
>>> {

173 
es
.
™”
().
m­
(|
e
| 
£lf
.
g‘_·th_ex´
Ó)).
cŞËù
()

176 
â
 
g‘_jsÚ
(&
£lf
, 
e
: &
Ex´essiÚ
è-> 
ResuÉ
<
O±iÚ
<
JsÚ
>> {

177 
Ët
 
j
 = 
e
.
ev®_jsÚ
(
£lf
.
ùx
, s–f.
row
)?

178 .
m­_Ü
(
JsÚ
::
NÚe
, 
Cow
::
što_owÃd
);

179 
Ok
(
Some
(
j
))

182 
â
 
g‘_jsÚ_nÙ_nÚe
(&
£lf
, 
e
: &
Ex´essiÚ
è-> 
ResuÉ
<
O±iÚ
<
JsÚ
>> {

183 
Ët
 
j
 = 
Œy_İt
!(
e
.
ev®_jsÚ
(
£lf
.
ùx
, s–f.
row
)).
što_owÃd
();

184 
Ok
(
Some
(
j
))

188 #[
cfg
(
‹¡
)]

189 
mod
 
	g‹¡
 {

190 
u£
 
	gtb
::
ex´essiÚ
::
SÿÏrFuncSig
;

191 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

192 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
JsÚ
;

193 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::{
Ex´essiÚ
, 
	gS‹m’tCÚ‹xt
};

194 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
‹¡
::{
âÿÎ_ex´
, 
	gmake_nuÎ_d©ums
};

195 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::
d©um_ex´
;

197 #[
‹¡
]

198 
â
 
‹¡_jsÚ_ty³
() {

199 
Ët
 
	gÿ£s
 = 
vec
![

200 (
NÚe
, None),

201 (
Some
(
r
#"
Œue
"#), Some("
BOOLEAN
")),

202 (
Some
(
r
#"
nuÎ
"#), Some("
NULL
")),

203 (
Some
(
r
#"-3"#), Some("
INTEGER
")),

204 (
Some
(
r
#"3"#), Some("
UNSIGNED
 
INTEGER
")),

205 (
Some
(
r
#"3.14"#), Some("
DOUBLE
")),

206 (
Some
(
r
#"[1, 2, 3]"#), Some("
ARRAY
")),

207 (
Some
(
r
#"{"Çme": 123}"#), Some("
OBJECT
")),

209 
Ët
 
ùx
 = 
S‹m’tCÚ‹xt
::();

210 
šput
, 
exp
è
š
 
ÿ£s
 {

211 
Ët
 
šput
 = 
m©ch
 input {

212 
NÚe
 => 
D©um
::
NuÎ
,

213 
Some
(
s
è=> 
D©um
::
JsÚ
(s.
·r£
().
unw¿p
()),

215 
Ët
 
exp
 = 
m©ch
ƒxp {

216 
NÚe
 => 
D©um
::
NuÎ
,

217 
Some
(
s
è=> 
D©um
::
By‹s
(s.
to_owÃd
().
što_by‹s
()),

220 
Ët
 
¬g
 = 
d©um_ex´
(
šput
);

221 
Ët
 
İ
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
JsÚTy³Sig
, &[
¬g
]);

222 
Ët
 
İ
 = 
Ex´essiÚ
::
bud
(&
ùx
, op).
unw¿p
();

223 
Ët
 
gÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

224 
as£¹_eq
!(
gÙ
, 
exp
);

228 #[
‹¡
]

229 
â
 
‹¡_jsÚ_unquÙe
() {

230 
Ët
 
ÿ£s
 = 
vec
![

231 (
NÚe
, 
çl£
, None),

232 (
Some
(
r
"a"), 
çl£
, Some("a")),

233 (
Some
(
r
#""3""#), false, Some(r#""3""#)),

234 (
Some
(
r
#""3""#),rue, Some(r#"3"#)),

235 (
Some
(
r
#"{"a": "b"}"#), false, Some(r#"{"a": "b"}"#)),

236 (
Some
(
r
#"{"a": "b"}"#),rue, Some(r#"{"a":"b"}"#)),

238 
Some
(
r
#"
h–lo
,\"quoted string\",world"#),

239 
çl£
,

240 
Some
(
r
#"
h–lo
,"quÙed sŒšg",
wÜld
"#),

243 
Ët
 
ùx
 = 
S‹m’tCÚ‹xt
::();

244 
šput
, 
·r£
, 
exp
è
š
 
ÿ£s
 {

245 
Ët
 
šput
 = 
m©ch
 input {

246 
NÚe
 => 
D©um
::
NuÎ
,

247 
Some
(
s
è=> 
·r£
 {

248 
D©um
::
JsÚ
(
s
.
·r£
().
unw¿p
())

250 
D©um
::
JsÚ
(JsÚ::
SŒšg
(
s
.
to_owÃd
()))

253 
Ët
 
exp
 = 
m©ch
ƒxp {

254 
NÚe
 => 
D©um
::
NuÎ
,

255 
Some
(
s
è=> 
D©um
::
By‹s
(s.
to_owÃd
().
što_by‹s
()),

258 
Ët
 
¬g
 = 
d©um_ex´
(
šput
);

259 
Ët
 
İ
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
JsÚUnquÙeSig
, &[
¬g
]);

260 
Ët
 
İ
 = 
Ex´essiÚ
::
bud
(&
ùx
, op).
unw¿p
();

261 
Ët
 
gÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

262 
as£¹_eq
!(
gÙ
, 
exp
);

266 #[
‹¡
]

267 
â
 
‹¡_jsÚ_objeù
() {

268 
Ët
 
ÿ£s
 = 
vec
![

269 (
vec
![], 
D©um
::
JsÚ
(
r
#"{}"#.parse().unwrap())),

271 
vec
![
D©um
::
By‹s
(
b
"1".
to_vec
()), D©um::
NuÎ
],

272 
D©um
::
JsÚ
(
r
#"{"1":
nuÎ
}"#.parse().unwrap()),

275 
vec
![

276 
D©um
::
By‹s
(
b
"1".
to_vec
()),

277 
D©um
::
NuÎ
,

278 
D©um
::
By‹s
(
b
"2".
to_vec
()),

279 
D©um
::
JsÚ
(JsÚ::
SŒšg
("sdf".
to_owÃd
())),

280 
D©um
::
By‹s
(
b
"k1".
to_vec
()),

281 
D©um
::
JsÚ
(JsÚ::
SŒšg
("v1".
to_owÃd
())),

283 
D©um
::
JsÚ
(
r
#"{"1":
nuÎ
,"2":"sdf","k1":"v1"}"#.parse().unwrap()),

286 
Ët
 
ùx
 = 
S‹m’tCÚ‹xt
::();

287 
šputs
, 
exp
è
š
 
ÿ£s
 {

288 
Ët
 
¬gs
 = 
šputs
.
što_™”
().
m­
(
d©um_ex´
).
cŞËù
::<
Vec
<
_
>>();

289 
Ët
 
İ
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
JsÚObjeùSig
, &
¬gs
);

290 
Ët
 
İ
 = 
Ex´essiÚ
::
bud
(&
ùx
, op).
unw¿p
();

291 
Ët
 
gÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

292 
as£¹_eq
!(
gÙ
, 
exp
);

296 #[
‹¡
]

297 
â
 
‹¡_jsÚ_¬¿y
() {

298 
Ët
 
ÿ£s
 = 
vec
![

299 (
vec
![], 
D©um
::
JsÚ
(
r
#"[]"#.parse().unwrap())),

301 
vec
![
D©um
::
JsÚ
("1".
·r£
().
unw¿p
()), D©um::
NuÎ
],

302 
D©um
::
JsÚ
(
r
#"[1, 
nuÎ
]"#.parse().unwrap()),

305 
vec
![

306 
D©um
::
JsÚ
("1".
·r£
().
unw¿p
()),

307 
D©um
::
NuÎ
,

308 
D©um
::
JsÚ
("2".
·r£
().
unw¿p
()),

309 
D©um
::
JsÚ
(JsÚ::
SŒšg
("sdf".
to_owÃd
())),

310 
D©um
::
JsÚ
(JsÚ::
SŒšg
("k1".
to_owÃd
())),

311 
D©um
::
JsÚ
(JsÚ::
SŒšg
("v1".
to_owÃd
())),

313 
D©um
::
JsÚ
(
r
#"[1, 
nuÎ
, 2, "sdf", "k1", "v1"]"#.parse().unwrap()),

316 
Ët
 
ùx
 = 
S‹m’tCÚ‹xt
::();

317 
šputs
, 
exp
è
š
 
ÿ£s
 {

318 
Ët
 
¬gs
 = 
šputs
.
što_™”
().
m­
(
d©um_ex´
).
cŞËù
::<
Vec
<
_
>>();

319 
Ët
 
İ
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
JsÚA¼aySig
, &
¬gs
);

320 
Ët
 
İ
 = 
Ex´essiÚ
::
bud
(&
ùx
, op).
unw¿p
();

321 
Ët
 
gÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

322 
as£¹_eq
!(
gÙ
, 
exp
);

326 #[
‹¡
]

327 
â
 
‹¡_jsÚ_modify
() {

328 
Ët
 
ÿ£s
 = 
vec
![

330 
SÿÏrFuncSig
::
JsÚS‘Sig
,

331 
vec
![
D©um
::
NuÎ
, Datum::Null, Datum::Null],

332 
D©um
::
NuÎ
,

335 
SÿÏrFuncSig
::
JsÚS‘Sig
,

336 
vec
![

337 
D©um
::
JsÚ
(JsÚ::
I64
(9)),

338 
D©um
::
By‹s
(
b
"$[1]".
to_vec
()),

339 
D©um
::
JsÚ
(JsÚ::
U64
(3)),

341 
D©um
::
JsÚ
(
r
#"[9,3]"#.parse().unwrap()),

344 
SÿÏrFuncSig
::
JsÚIn£¹Sig
,

345 
vec
![

346 
D©um
::
JsÚ
(JsÚ::
I64
(9)),

347 
D©um
::
By‹s
(
b
"$[1]".
to_vec
()),

348 
D©um
::
JsÚ
(JsÚ::
U64
(3)),

350 
D©um
::
JsÚ
(
r
#"[9,3]"#.parse().unwrap()),

353 
SÿÏrFuncSig
::
JsÚR•ÏûSig
,

354 
vec
![

355 
D©um
::
JsÚ
(JsÚ::
I64
(9)),

356 
D©um
::
By‹s
(
b
"$[1]".
to_vec
()),

357 
D©um
::
JsÚ
(JsÚ::
U64
(3)),

359 
D©um
::
JsÚ
(
r
#"9"#.parse().unwrap()),

362 
SÿÏrFuncSig
::
JsÚS‘Sig
,

363 
vec
![

364 
D©um
::
JsÚ
(
r
#"{"a":"x"}"#.parse().unwrap()),

365 
D©um
::
By‹s
(
b
"$.a".
to_vec
()),

366 
D©um
::
NuÎ
,

368 
D©um
::
JsÚ
(
r
#"{"a":
nuÎ
}"#.parse().unwrap()),

371 
Ët
 
ùx
 = 
S‹m’tCÚ‹xt
::();

372 
sig
, 
šputs
, 
exp
è
š
 
ÿ£s
 {

373 
Ët
 
¬gs
: 
Vec
<
_
> = 
šputs
.
što_™”
().
m­
(
d©um_ex´
).
cŞËù
();

374 
Ët
 
İ
 = 
âÿÎ_ex´
(
sig
, &
¬gs
);

375 
Ët
 
İ
 = 
Ex´essiÚ
::
bud
(&
ùx
, op).
unw¿p
();

376 
Ët
 
gÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

377 
as£¹_eq
!(
gÙ
, 
exp
);

381 #[
‹¡
]

382 
â
 
‹¡_jsÚ_m”ge
() {

383 
Ët
 
ÿ£s
 = 
vec
![

384 (
vec
![
D©um
::
NuÎ
, Datum::Null], Datum::Null),

386 
vec
![

387 
D©um
::
JsÚ
("{}".
·r£
().
unw¿p
()),

388 
D©um
::
JsÚ
("[]".
·r£
().
unw¿p
()),

390 
D©um
::
JsÚ
("[{}]".
·r£
().
unw¿p
()),

393 
vec
![

394 
D©um
::
JsÚ
("{}".
·r£
().
unw¿p
()),

395 
D©um
::
JsÚ
("[]".
·r£
().
unw¿p
()),

396 
D©um
::
JsÚ
("3".
·r£
().
unw¿p
()),

397 
D©um
::
JsÚ
(
r
#""4""#.parse().unwrap()),

399 
D©um
::
JsÚ
(
r
#"[{}, 3, "4"]"#.parse().unwrap()),

402 
Ët
 
ùx
 = 
S‹m’tCÚ‹xt
::();

403 
šputs
, 
exp
è
š
 
ÿ£s
 {

404 
Ët
 
¬gs
: 
Vec
<
_
> = 
šputs
.
što_™”
().
m­
(
d©um_ex´
).
cŞËù
();

405 
Ët
 
İ
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
JsÚM”geSig
, &
¬gs
);

406 
Ët
 
İ
 = 
Ex´essiÚ
::
bud
(&
ùx
, op).
unw¿p
();

407 
Ët
 
gÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

408 
as£¹_eq
!(
gÙ
, 
exp
);

412 #[
‹¡
]

413 
â
 
‹¡_jsÚ_šv®id_¬gum’ts
() {

414 
Ët
 
ÿ£s
 = 
vec
![

415 (
SÿÏrFuncSig
::
JsÚObjeùSig
, 
make_nuÎ_d©ums
(3)),

416 (
SÿÏrFuncSig
::
JsÚS‘Sig
, 
make_nuÎ_d©ums
(4)),

417 (
SÿÏrFuncSig
::
JsÚIn£¹Sig
, 
make_nuÎ_d©ums
(6)),

418 (
SÿÏrFuncSig
::
JsÚR•ÏûSig
, 
make_nuÎ_d©ums
(8)),

420 
Ët
 
ùx
 = 
S‹m’tCÚ‹xt
::();

421 
sig
, 
¬gs
è
š
 
ÿ£s
 {

422 
Ët
 
¬gs
: 
Vec
<
_
> =‡rgs.
što_™”
().
m­
(
d©um_ex´
).
cŞËù
();

423 
Ët
 
İ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
sig
, &
¬gs
));

424 
as£¹
!(
İ
.
is_”r
());

	@src/coprocessor/dag/expr/math.rs

14 
u£
 
	g¡d
::
i64
;

15 
u£
 
	g¡d
::
bÜrow
::
Cow
;

16 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

17 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
Decim®
;

18 
u£
 
	gsu³r
::{
E¼Ü
, 
	gFnC®l
, 
	gResuÉ
, 
	gS‹m’tCÚ‹xt
};

20 
im¶
 
	gFnC®l
 {

21 #[
šlše
]

22 
pub
 
â
 
abs_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

23 
Ët
 
n
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

24 
Ok
(
Some
(
n
.
abs
()))

27 #[
šlše
]

28 
pub
 
â
 
	gabs_decim®
<'a, '
	gb
: 'a>(

30 
ùx
: &
S‹m’tCÚ‹xt
,

31 
	grow
: &'a [Datum],

32 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

33 
Ët
 
d
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

34 
Ët
 
	g»suÉ
: 
ResuÉ
<
Decim®
> = 
d
.
što_owÃd
().
abs
().
što
();

35 
	g»suÉ
.
m­
(|
t
| 
Some
(
Cow
::
OwÃd
(t)))

38 #[
šlše
]

39 
pub
 
â
 
abs_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

40 
Ët
 
n
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
));

41 
	gn
 =ğ
i64
::
MIN
 {

42  
E¼
(
E¼Ü
::
Ov”æow
);

44 
Ok
(
Some
(
n
.
abs
()))

47 #[
šlše
]

48 
pub
 
â
 
abs_ušt
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

49 
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
)

52 #[
šlše
]

53 
pub
 
â
 
û_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

54 
Ët
 
n
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

55 
Ok
(
Some
(
n
.
û
()))

58 #[
šlše
]

59 
pub
 
â
 
û_dec_to_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

60 
Ët
 
d
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

61 
Ët
 
	gd
: 
ResuÉ
<
Decim®
> = 
d
.
û
().
što
();

62 
	gd
.
ªd_th’
(|
dec
| dec.
as_i64_w™h_ùx
(
ùx
)).
m­
(
Some
)

65 #[
šlše
]

66 
pub
 
â
 
	gû_dec_to_dec
<'a, '
	gb
: 'a>(

68 
ùx
: &
S‹m’tCÚ‹xt
,

69 
	grow
: &'a [Datum],

70 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

71 
Ët
 
d
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

72 
Ët
 
	g»suÉ
: 
ResuÉ
<
Decim®
> = 
d
.
û
().
što
();

73 
	g»suÉ
.
m­
(|
t
| 
Some
(
Cow
::
OwÃd
(t)))

76 #[
šlše
]

77 
pub
 
â
 
û_št_to_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

78 
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
)

81 #[
šlše
]

82 
pub
 
â
 
æoÜ_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

83 
Ët
 
n
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_»®
(
ùx
, 
row
));

84 
Ok
(
Some
(
n
.
æoÜ
()))

87 #[
šlše
]

88 
pub
 
â
 
æoÜ_dec_to_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

89 
Ët
 
d
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

90 
Ët
 
	gd
: 
ResuÉ
<
Decim®
> = 
d
.
æoÜ
().
što
();

91 
	gd
.
ªd_th’
(|
dec
| dec.
as_i64_w™h_ùx
(
ùx
)).
m­
(
Some
)

94 #[
šlše
]

95 
pub
 
â
 
	gæoÜ_dec_to_dec
<'a, '
	gb
: 'a>(

97 
ùx
: &
S‹m’tCÚ‹xt
,

98 
	grow
: &'a [Datum],

99 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

100 
Ët
 
d
 = 
Œy_İt
!(
£lf
.
chd»n
[0].
ev®_decim®
(
ùx
, 
row
));

101 
Ët
 
	g»suÉ
: 
ResuÉ
<
Decim®
> = 
d
.
æoÜ
().
što
();

102 
	g»suÉ
.
m­
(|
t
| 
Some
(
Cow
::
OwÃd
(t)))

105 #[
šlše
]

106 
pub
 
â
 
æoÜ_št_to_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

107 
£lf
.
chd»n
[0].
ev®_št
(
ùx
, 
row
)

111 #[
cfg
(
‹¡
)]

112 
mod
 
	g‹¡
 {

113 
u£
 
	g¡d
::{
f64
, 
	gi64
, 
	gu64
};

114 
u£
 
	gtb
::
ex´essiÚ
::
SÿÏrFuncSig
;

115 
u£
 
	gcİroûssÜ
::
codec
::{
cÚv”t
, 
	gmysql
, 
	gD©um
};

116 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
ty³s
;

117 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::
‹¡
::{
check_ov”æow
, 
	gâÿÎ_ex´
, 
	g¡r2dec
};

118 
u£
 
	gcİroûssÜ
::
dag
::
ex´
::{
Ex´essiÚ
, 
	gS‹m’tCÚ‹xt
};

119 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::
d©um_ex´
;

121 #[
‹¡
]

122 
â
 
‹¡_abs
() {

123 
Ët
 
	g‹¡s
 = 
vec
![

124 (
SÿÏrFuncSig
::
AbsIÁ
, 
D©um
::
I64
(-3), Datum::I64(3)),

126 
SÿÏrFuncSig
::
AbsIÁ
,

127 
D©um
::
I64
(
i64
::
MAX
),

128 
D©um
::
I64
(
i64
::
MAX
),

131 
SÿÏrFuncSig
::
AbsUIÁ
,

132 
D©um
::
U64
(
u64
::
MAX
),

133 
D©um
::
U64
(
u64
::
MAX
),

135 (
SÿÏrFuncSig
::
AbsR—l
, 
D©um
::
F64
(3.5), Datum::F64(3.5)),

136 (
SÿÏrFuncSig
::
AbsR—l
, 
D©um
::
F64
(-3.5), Datum::F64(3.5)),

137 (
SÿÏrFuncSig
::
AbsDecim®
, 
¡r2dec
("1.1"), str2dec("1.1")),

138 (
SÿÏrFuncSig
::
AbsDecim®
, 
¡r2dec
("-1.1"), str2dec("1.1")),

140 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

141 
	gsig
, 
	g¬g
, 
	gexp
è
š
 
	g‹¡s
 {

142 
Ët
 
	g¬g
 = 
d©um_ex´
(
¬g
);

143 
Ët
 
mut
 
	gf
 = 
âÿÎ_ex´
(
sig
, &[
¬g
]);

144 
	gsig
 =ğ
SÿÏrFuncSig
::
AbsUIÁ
 {

145 
f
.
mut_f›ld_ty³
().
£t_æag
(
ty³s
::
UNSIGNED_FLAG
 
as
 
u32
);

147 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
f
).
unw¿p
();

148 
Ët
 
	ggÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

149 
	gas£¹_eq
!(
	ggÙ
, 
	gexp
);

153 #[
‹¡
]

154 
â
 
‹¡_ov”æow_abs
() {

155 
Ët
 
	g‹¡s
 = 
vec
![(
SÿÏrFuncSig
::
AbsIÁ
, 
D©um
::
I64
(
i64
::
MIN
))];

156 
Ët
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

157 
‰
 
š
 
	g‹¡s
 {

158 
Ët
 
	g¬g
 = 
d©um_ex´
(
‰
.1);

159 
Ët
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
‰
.0, &[
¬g
])).
unw¿p
();

160 
Ët
 
	ggÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p_”r
();

161 
	gas£¹
!(
check_ov”æow
(
gÙ
).
is_ok
());

165 #[
‹¡
]

166 
â
 
‹¡_û
() {

167 
Ët
 
	g‹¡s
 = 
vec
![

168 (
SÿÏrFuncSig
::
CeR—l
, 
D©um
::
F64
(3.45), Datum::F64(4f64)),

170 
SÿÏrFuncSig
::
CeR—l
,

171 
D©um
::
F64
(-3.45),

172 
D©um
::
F64
(-3f64),

175 
SÿÏrFuncSig
::
CeR—l
,

176 
D©um
::
F64
(
f64
::
MAX
),

177 
D©um
::
F64
(
f64
::
MAX
),

180 
SÿÏrFuncSig
::
CeR—l
,

181 
D©um
::
F64
(
f64
::
MIN
),

182 
D©um
::
F64
(
f64
::
MIN
),

185 
SÿÏrFuncSig
::
CeIÁToIÁ
,

186 
D©um
::
I64
(
i64
::
MIN
),

187 
D©um
::
I64
(
i64
::
MIN
),

190 
SÿÏrFuncSig
::
CeIÁToIÁ
,

191 
D©um
::
U64
(
u64
::
MAX
),

192 
D©um
::
U64
(
u64
::
MAX
),

195 
SÿÏrFuncSig
::
CeIÁToDec
,

196 
D©um
::
I64
(
i64
::
MIN
),

197 
¡r2dec
("-9223372036854775808"),

200 
SÿÏrFuncSig
::
CeDecToIÁ
,

201 
¡r2dec
("123.456"),

202 
D©um
::
I64
(124),

205 
SÿÏrFuncSig
::
CeDecToIÁ
,

206 
¡r2dec
("-123.456"),

207 
D©um
::
I64
(-123),

210 
SÿÏrFuncSig
::
CeDecToDec
,

211 
¡r2dec
("9223372036854775808"),

212 
¡r2dec
("9223372036854775808"),

215 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

216 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

217 
	gsig
, 
	g¬g
, 
	gexp
è
š
 
	g‹¡s
 {

218 
Ët
 
	g¬g
 = 
d©um_ex´
(
¬g
);

219 
Ët
 
mut
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
sig
, &[
¬g
.
şÚe
()])).
unw¿p
();

220 
	gmysql
::
has_unsigÃd_æag
(
¬g
.
g‘_f›ld_ty³
().
g‘_æag
()) {

221 
İ
.
mut_
().
£t_æag
(
ty³s
::
UNSIGNED_FLAG
 
as
 
u32
);

223 
	gsig
 =ğ
SÿÏrFuncSig
::
CeIÁToDec
 || 
sig
 =ğSÿÏrFuncSig::
CeDecToDec
 {

224 
İ
.
mut_
().
£t_æ’
(
cÚv”t
::
UNSPECIFIED_LENGTH
);

225 
	gİ
.
mut_
().
£t_decim®
(
cÚv”t
::
UNSPECIFIED_LENGTH
);

227 
Ët
 
	ggÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

228 
	gas£¹_eq
!(
	ggÙ
, 
	gexp
);

232 #[
‹¡
]

233 
â
 
‹¡_æoÜ
() {

234 
Ët
 
	g‹¡s
 = 
vec
![

235 (
SÿÏrFuncSig
::
FloÜR—l
, 
D©um
::
F64
(3.45), Datum::F64(3f64)),

237 
SÿÏrFuncSig
::
FloÜR—l
,

238 
D©um
::
F64
(-3.45),

239 
D©um
::
F64
(-4f64),

242 
SÿÏrFuncSig
::
FloÜR—l
,

243 
D©um
::
F64
(
f64
::
MAX
),

244 
D©um
::
F64
(
f64
::
MAX
),

247 
SÿÏrFuncSig
::
FloÜR—l
,

248 
D©um
::
F64
(
f64
::
MIN
),

249 
D©um
::
F64
(
f64
::
MIN
),

252 
SÿÏrFuncSig
::
FloÜIÁToIÁ
,

253 
D©um
::
I64
(
i64
::
MIN
),

254 
D©um
::
I64
(
i64
::
MIN
),

257 
SÿÏrFuncSig
::
FloÜIÁToIÁ
,

258 
D©um
::
U64
(
u64
::
MAX
),

259 
D©um
::
U64
(
u64
::
MAX
),

262 
SÿÏrFuncSig
::
FloÜIÁToDec
,

263 
D©um
::
I64
(
i64
::
MIN
),

264 
¡r2dec
("-9223372036854775808"),

267 
SÿÏrFuncSig
::
FloÜDecToIÁ
,

268 
¡r2dec
("123.456"),

269 
D©um
::
I64
(123),

272 
SÿÏrFuncSig
::
FloÜDecToIÁ
,

273 
¡r2dec
("-123.456"),

274 
D©um
::
I64
(-124),

277 
SÿÏrFuncSig
::
FloÜDecToDec
,

278 
¡r2dec
("9223372036854775808"),

279 
¡r2dec
("9223372036854775808"),

282 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

283 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

284 
	gsig
, 
	g¬g
, 
	gexp
è
š
 
	g‹¡s
 {

285 
Ët
 
	g¬g
 = 
d©um_ex´
(
¬g
);

286 
Ët
 
mut
 
	gİ
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
âÿÎ_ex´
(
sig
, &[
¬g
.
şÚe
()])).
unw¿p
();

287 
	gmysql
::
has_unsigÃd_æag
(
¬g
.
g‘_f›ld_ty³
().
g‘_æag
()) {

288 
İ
.
mut_
().
£t_æag
(
ty³s
::
UNSIGNED_FLAG
 
as
 
u32
);

290 
	gsig
 =ğ
SÿÏrFuncSig
::
FloÜIÁToDec
 || 
sig
 =ğSÿÏrFuncSig::
FloÜDecToDec
 {

291 
İ
.
mut_
().
£t_æ’
(
cÚv”t
::
UNSPECIFIED_LENGTH
);

292 
	gİ
.
mut_
().
£t_decim®
(
cÚv”t
::
UNSPECIFIED_LENGTH
);

294 
Ët
 
	ggÙ
 = 
İ
.
ev®
(&
ùx
, &[]).
unw¿p
();

295 
	gas£¹_eq
!(
	ggÙ
, 
	gexp
);

	@src/coprocessor/dag/expr/mod.rs

14 
mod
 
	gcŞumn
;

15 
mod
 
	gcÚ¡ªt
;

16 
mod
 
	gâÿÎ
;

17 
mod
 
	gbutš_ÿ¡
;

18 
mod
 
	gbutš_cÚŒŞ
;

19 
mod
 
	gbutš_İ
;

20 
mod
 
	gcom·»
;

21 
mod
 
	g¬™hm‘ic
;

22 
mod
 
	gm©h
;

23 
mod
 
	gjsÚ
;

25 
u£
 
	g¡d
::{
”rÜ
, 
	gio
, 
	g¡r
};

26 
u£
 
	g¡d
::
bÜrow
::
Cow
;

27 
u£
 
	g¡d
::
¡ršg
::
FromUtf8E¼Ü
;

28 
u£
 
	g¡d
::
¡r
::
Utf8E¼Ü
;

30 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gEx´Ty³
, 
	gF›ldTy³
, 
	gSÿÏrFuncSig
};

32 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
Decim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gRes
, 
	gTime
, 
	gMAX_FSP
};

33 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
decim®
::
Decim®Decod”
;

34 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
jsÚ
::
JsÚDecod”
;

35 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
ch¬£t
, 
	gty³s
};

36 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

37 
u£
 
	gut
;

38 
u£
 
	gut
::
codec
::
numb”
::
Numb”Decod”
;

39 
u£
 
	gut
::
codec
::
E¼Ü
 
as
 
CE¼Ü
;

41 
pub
 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
 
as
 
S‹m’tCÚ‹xt
;

43 
	gquick_”rÜ
! {

44 #[
d”ive
(
Debug
)]

45 
pub
 
	eE¼Ü
 {

46 
Io
(
”r
: 
io
::
E¼Ü
) {

47 
äom
()

48 
desütiÚ
("ioƒrror")

49 
di¥Ïy
("I/Oƒ¼Ü: {}", 
”r
)

50 
ÿu£
(
”r
)

52 
	gTy³
 { 
	ghas
: &'¡©iø¡r,ƒx³ùed: &'
¡r
 } {

53 
desütiÚ
("typeƒrror")

54 
di¥Ïy
("ty³ƒ¼Ü: cªnÙ g‘ {:?}„esuÉ from {:?}ƒx´essiÚ", 
ex³ùed
, 
has
)

56 
Codec
(
”r
: 
ut
::
codec
::
E¼Ü
) {

57 
äom
()

58 
desütiÚ
("codecƒrror")

59 
di¥Ïy
("codeø”rÜ: {}", 
”r
)

60 
ÿu£
(
”r
)

62 
CŞumnOff£t
(
off£t
: 
usize
) {

63 
desütiÚ
("column offset‚ot found")

64 
di¥Ïy
("Ëg® cŞumÀoff£t: {}", 
off£t
)

66 
UnknownSigÇtu»
(
sig
: 
SÿÏrFuncSig
) {

67 
desütiÚ
("Unknown signature")

68 
di¥Ïy
("UnknowÀsigÇtu»: {:?}", 
sig
)

70 
	gTrunÿ‹d
 {

71 
desütiÚ
("Truncated")

72 
di¥Ïy
("error Truncated")

74 
	gOv”æow
 {

75 
desütiÚ
("Overflow")

76 
di¥Ïy
("error Overflow")

78 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
S’d
 + 
Sync
>) {

79 
äom
()

80 
ÿu£
(
”r
.
as_»f
())

81 
desütiÚ
(
”r
.description())

82 
di¥Ïy
("unknowÀ”rÜ {:?}", 
”r
)

87 
im¶
 
	gFrom
<
	gFromUtf8E¼Ü
> 
	gE¼Ü
 {

88 
â
 
äom
(
”r
: 
FromUtf8E¼Ü
è-> 
E¼Ü
 {

89 
E¼Ü
::
Codec
(
CE¼Ü
::
Encodšg
(
”r
.
utf8_”rÜ
().
što
()))

92 
im¶
 
From
<
Utf8E¼Ü
> 
E¼Ü
 {

93 
â
 
äom
(
”r
: 
Utf8E¼Ü
è-> 
E¼Ü
 {

94 
E¼Ü
::
Codec
(
CE¼Ü
::
Encodšg
(
”r
.
što
()))

98 
pub
 
ty³
 
ResuÉ
<
T
> = ::
¡d
::
»suÉ
::ResuÉ<T, 
	gE¼Ü
>;

100 
	gim¶
<
	gT
> 
	gIÁo
<
	gResuÉ
<T>> 
	gRes
<T> {

101 
â
 
što
(
£lf
è-> 
	gResuÉ
<
	gT
> {

102 
m©ch
 
	g£lf
 {

103 
	gRes
::
Ok
(
t
) => Ok(t),

104 
	gRes
::
Trunÿ‹d
(
_
è=> 
E¼
(
E¼Ü
::Truncated),

105 
	gRes
::
Ov”æow
(
_
è=> 
E¼
(
E¼Ü
::Overflow),

110 #[
d”ive
(
Debug
, 
ClÚe
, 
P¬tŸlEq
)]

111 
pub
 
	eEx´essiÚ
 {

112 
CÚ¡ªt
(Constant),

113 
CŞumnRef
(
CŞumn
),

114 
SÿÏrFn
(
FnC®l
),

117 #[
d”ive
(
Debug
, 
ClÚe
, 
P¬tŸlEq
)]

118 
pub
 
	sCŞumn
 {

119 
	moff£t
: 
usize
,

120 
	m
: 
F›ldTy³
,

123 #[
d”ive
(
Debug
, 
ClÚe
, 
P¬tŸlEq
)]

124 
pub
 
	sCÚ¡ªt
 {

125 
	mv®
: 
D©um
,

126 
	m
: 
F›ldTy³
,

130 #[
d”ive
(
Debug
, 
ClÚe
, 
P¬tŸlEq
)]

131 
pub
 
	sFnC®l
 {

132 
	msig
: 
SÿÏrFuncSig
,

133 
	mchd»n
: 
Vec
<
Ex´essiÚ
>,

134 
	m
: 
F›ldTy³
,

137 
im¶
 
	gEx´essiÚ
 {

138 
â
 
Ãw_cÚ¡
(
v
: 
D©um
, 
f›ld_ty³
: 
F›ldTy³
è-> 
Ex´essiÚ
 {

139 
Ex´essiÚ
::
CÚ¡ªt
(Constant {

140 
v®
: 
v
,

141 

: 
f›ld_ty³
,

145 #[
šlše
]

146 
â
 
g‘_
(&
£lf
è-> &
	gF›ldTy³
 {

147 
m©ch
 *
	g£lf
 {

148 
	gEx´essiÚ
::
CÚ¡ªt
(
»f
 
c
è=> &c.

,

149 
	gEx´essiÚ
::
CŞumnRef
(
»f
 
c
è=> &c.

,

150 
	gEx´essiÚ
::
SÿÏrFn
(
»f
 
c
è=> &c.

,

154 #[
cfg
(
‹¡
)]

155 #[
šlše
]

156 
â
 
mut_
(&
mut
 
£lf
è-> &muˆ
	gF›ldTy³
 {

157 
m©ch
 *
	g£lf
 {

158 
	gEx´essiÚ
::
CÚ¡ªt
(
»f
 
mut
 
c
è=> &muˆc.

,

159 
	gEx´essiÚ
::
CŞumnRef
(
»f
 
mut
 
c
è=> &muˆc.

,

160 
	gEx´essiÚ
::
SÿÏrFn
(
»f
 
mut
 
c
è=> &muˆc.

,

164 #[
®low
(
m©ch_§me_¬ms
)]

165 
â
 
ev®_št
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

166 
m©ch
 *
£lf
 {

167 
Ex´essiÚ
::
CÚ¡ªt
(
»f
 
cÚ¡ªt
è=> cÚ¡ªt.
ev®_št
(),

168 
	gEx´essiÚ
::
CŞumnRef
(
»f
 
cŞumn
è=> cŞumn.
ev®_št
(
row
),

169 
	gEx´essiÚ
::
SÿÏrFn
(
»f
 
f
è=> f.
ev®_št
(
ùx
, 
row
),

173 
â
 
ev®_»®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<
O±iÚ
<
f64
>> {

174 
m©ch
 *
£lf
 {

175 
Ex´essiÚ
::
CÚ¡ªt
(
»f
 
cÚ¡ªt
è=> cÚ¡ªt.
ev®_»®
(),

176 
	gEx´essiÚ
::
CŞumnRef
(
»f
 
cŞumn
è=> cŞumn.
ev®_»®
(
row
),

177 
	gEx´essiÚ
::
SÿÏrFn
(
»f
 
f
è=> f.
ev®_»®
(
ùx
, 
row
),

181 #[
®low
(
m©ch_§me_¬ms
)]

182 
â
 
	gev®_decim®
<'a, '
	gb
: 'a>(

184 
ùx
: &
S‹m’tCÚ‹xt
,

185 
	grow
: &'a [Datum],

186 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Decimal>>> {

187 
m©ch
 *
£lf
 {

188 
Ex´essiÚ
::
CÚ¡ªt
(
»f
 
cÚ¡ªt
è=> cÚ¡ªt.
ev®_decim®
(),

189 
	gEx´essiÚ
::
CŞumnRef
(
»f
 
cŞumn
è=> cŞumn.
ev®_decim®
(
row
),

190 
	gEx´essiÚ
::
SÿÏrFn
(
»f
 
f
è=> f.
ev®_decim®
(
ùx
, 
row
),

194 
â
 
	gev®_¡ršg
<'a, '
	gb
: 'a>(

196 
ùx
: &
S‹m’tCÚ‹xt
,

197 
	grow
: &'a [Datum],

198 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, [u8]>>> {

199 
m©ch
 *
£lf
 {

200 
Ex´essiÚ
::
CÚ¡ªt
(
»f
 
cÚ¡ªt
è=> cÚ¡ªt.
ev®_¡ršg
(),

201 
	gEx´essiÚ
::
CŞumnRef
(
»f
 
cŞumn
è=> cŞumn.
ev®_¡ršg
(
row
),

202 
	gEx´essiÚ
::
SÿÏrFn
(
»f
 
f
è=> f.
ev®_by‹s
(
ùx
, 
row
),

206 
â
 
	gev®_¡ršg_ªd_decode
<'a, '
	gb
: 'a>(

208 
ùx
: &
S‹m’tCÚ‹xt
,

209 
	grow
: &'a [Datum],

210 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, str>>> {

211 
Ët
 
by‹s
 = 
Œy_İt
!(
£lf
.
ev®_¡ršg
(
ùx
, 
row
));

212 
Ët
 
	gchr¡
 = 
£lf
.
g‘_
().
g‘_ch¬£t
();

213 
	gch¬£t
::
UTF8_CHARSETS
.
	$cÚšs
(&
chr¡
) {

214 
Ët
 
s
 = 
m©ch
 
by‹s
 {

215 
Cow
::
	`BÜrowed
(
bs
è=> 
¡r
::
	`äom_utf8
(bs).
	`m­_”r
(
E¼Ü
::
äom
).
	`m­
(Cow::
BÜrowed
),

216 
Cow
::
	`OwÃd
(
bs
è=> 
SŒšg
::
	`äom_utf8
(bs).
	`m­_”r
(
E¼Ü
::
äom
).
	`m­
(Cow::
OwÃd
),

218  
s
.
	`m­
(
Some
);

219 
	}
}

220 
E¼
(
box_”r
!("unsuµÜ‹d ch¬£t: {}", 
chr¡
))

223 
â
 
	gev®_time
<'a, '
	gb
: 'a>(

225 
ùx
: &
S‹m’tCÚ‹xt
,

226 
	grow
: &'a [Datum],

227 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Time>>> {

228 
m©ch
 *
£lf
 {

229 
Ex´essiÚ
::
CÚ¡ªt
(
»f
 
cÚ¡ªt
è=> cÚ¡ªt.
ev®_time
(),

230 
	gEx´essiÚ
::
CŞumnRef
(
»f
 
cŞumn
è=> cŞumn.
ev®_time
(
row
),

231 
	gEx´essiÚ
::
SÿÏrFn
(
»f
 
f
è=> f.
ev®_time
(
ùx
, 
row
),

235 
â
 
	gev®_du¿tiÚ
<'a, '
	gb
: 'a>(

237 
ùx
: &
S‹m’tCÚ‹xt
,

238 
	grow
: &'a [Datum],

239 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Duration>>> {

240 
m©ch
 *
£lf
 {

241 
Ex´essiÚ
::
CÚ¡ªt
(
»f
 
cÚ¡ªt
è=> cÚ¡ªt.
ev®_du¿tiÚ
(),

242 
	gEx´essiÚ
::
CŞumnRef
(
»f
 
cŞumn
è=> cŞumn.
ev®_du¿tiÚ
(
row
),

243 
	gEx´essiÚ
::
SÿÏrFn
(
»f
 
f
è=> f.
ev®_du¿tiÚ
(
ùx
, 
row
),

247 
â
 
	gev®_jsÚ
<'a, '
	gb
: 'a>(

249 
ùx
: &
S‹m’tCÚ‹xt
,

250 
	grow
: &'a [Datum],

251 è-> 
ResuÉ
<
O±iÚ
<
Cow
<'a, Json>>> {

252 
m©ch
 *
£lf
 {

253 
Ex´essiÚ
::
CÚ¡ªt
(
»f
 
cÚ¡ªt
è=> cÚ¡ªt.
ev®_jsÚ
(),

254 
	gEx´essiÚ
::
CŞumnRef
(
»f
 
cŞumn
è=> cŞumn.
ev®_jsÚ
(
row
),

255 
	gEx´essiÚ
::
SÿÏrFn
(
»f
 
f
è=> f.
ev®_jsÚ
(
ùx
, 
row
),

266 
â
 
is_hybrid_ty³
(&
£lf
è-> 
	gboŞ
 {

267 
m©ch
 
	g£lf
.
g‘_
().g‘_(è
as
 
	gu8
 {

268 
	gty³s
::
ENUM
 | 
ty³s
::
BIT
 |y³s::
SET
 => {

269  
Œue
;

271 
	g_
 => {}

275 
	gçl£


279 
im¶
 
	gEx´essiÚ
 {

280 
pub
 
â
 
ev®
(&
£lf
, 
ùx
: &
S‹m’tCÚ‹xt
, 
row
: &[
D©um
]è-> 
ResuÉ
<Datum> {

281 
m©ch
 *
£lf
 {

282 
Ex´essiÚ
::
CÚ¡ªt
(
»f
 
cÚ¡ªt
è=> 
Ok
(cÚ¡ªt.
ev®
()),

283 
	gEx´essiÚ
::
CŞumnRef
(
»f
 
cŞumn
è=> 
Ok
(cŞumn.
ev®
(
row
)),

284 
	gEx´essiÚ
::
SÿÏrFn
(
»f
 
f
è=> f.
ev®
(
ùx
, 
row
),

288 
pub
 
â
 
b©ch_bud
(
ùx
: &
S‹m’tCÚ‹xt
, 
ex´s
: 
Vec
<
Ex´
>è-> 
ResuÉ
<Vec<
S–f
>> {

289 
Ët
 
mut
 
d©a
 = 
Vec
::
w™h_ÿ·c™y
(
ex´s
.
Ën
());

290 
ex´
 
š
 
	gex´s
 {

291 
Ët
 
	gex
 = 
Ex´essiÚ
::
bud
(
ùx
, 
ex´
)?;

292 
	gd©a
.
push
(
ex
);

294 
Ok
(
d©a
)

297 
pub
 
â
 
bud
(
ùx
: &
S‹m’tCÚ‹xt
, 
mut
 
ex´
: 
Ex´
è-> 
ResuÉ
<
S–f
> {

298 
Ët
 

 = 
ex´
.
ke_f›ld_ty³
();

299 
m©ch
 
	gex´
.
g‘_
() {

300 
	gEx´Ty³
::
NuÎ
 => 
Ok
(
Ex´essiÚ
::
Ãw_cÚ¡
(
D©um
::NuÎ, 

)),

301 
	gEx´Ty³
::
IÁ64
 => 
ex´
.
g‘_v®
()

302 .
decode_i64
()

303 .
m­
(
D©um
::
I64
)

304 .
m­
(|
e
| 
Ex´essiÚ
::
Ãw_cÚ¡
Ó, 

))

305 .
m­_”r
(
E¼Ü
::
äom
),

306 
	gEx´Ty³
::
Ušt64
 => 
ex´
.
g‘_v®
()

307 .
decode_u64
()

308 .
m­
(
D©um
::
U64
)

309 .
m­
(|
e
| 
Ex´essiÚ
::
Ãw_cÚ¡
Ó, 

))

310 .
m­_”r
(
E¼Ü
::
äom
),

311 
	gEx´Ty³
::
SŒšg
 | 
Ex´Ty³
::
By‹s
 => {

312 
Ok
(
Ex´essiÚ
::
Ãw_cÚ¡
(
D©um
::
By‹s
(
ex´
.
ke_v®
()), 

))

314 
Ex´Ty³
::
Flßt32
 | Ex´Ty³::
Flßt64
 => 
ex´
.
g‘_v®
()

315 .
decode_f64
()

316 .
m­
(
D©um
::
F64
)

317 .
m­
(|
e
| 
Ex´essiÚ
::
Ãw_cÚ¡
Ó, 

))

318 .
m­_”r
(
E¼Ü
::
äom
),

319 
	gEx´Ty³
::
MysqlTime
 => 
ex´
.
g‘_v®
()

320 .
decode_u64
()

321 .
ªd_th’
(|
i
| {

322 
Ët
 
f¥
 = 

.
g‘_decim®
(è
as
 
i8
;

323 
Ët
 
t
 = 

.
g‘_
(è
as
 
u8
;

324 
Time
::
äom_·cked_u64
(
i
, 
t
, 
f¥
, &
ùx
.
tz
)

326 .
m­
(|
t
| 
Ex´essiÚ
::
Ãw_cÚ¡
(
D©um
::
Time
Ñ), 

))

327 .
m­_”r
(
E¼Ü
::
äom
),

328 
	gEx´Ty³
::
MysqlDu¿tiÚ
 => 
ex´
.
g‘_v®
()

329 .
decode_i64
()

330 .
ªd_th’
(|
n
| 
Du¿tiÚ
::
äom_Çnos
Ò, 
MAX_FSP
))

331 .
m­
(
D©um
::
Dur
)

332 .
m­
(|
e
| 
Ex´essiÚ
::
Ãw_cÚ¡
Ó, 

))

333 .
m­_”r
(
E¼Ü
::
äom
),

334 
	gEx´Ty³
::
MysqlDecim®
 => 
ex´
.
g‘_v®
()

335 .
decode_decim®
()

336 .
m­
(
D©um
::
Dec
)

337 .
m­
(|
e
| 
Ex´essiÚ
::
Ãw_cÚ¡
Ó, 

))

338 .
m­_”r
(
E¼Ü
::
äom
),

339 
	gEx´Ty³
::
MysqlJsÚ
 => 
ex´
.
g‘_v®
()

340 .
decode_jsÚ
()

341 .
m­
(
D©um
::
JsÚ
)

342 .
m­
(|
e
| 
Ex´essiÚ
::
Ãw_cÚ¡
Ó, 

))

343 .
m­_”r
(
E¼Ü
::
äom
),

344 
	gEx´Ty³
::
SÿÏrFunc
 => {

345 
FnC®l
::
check_¬gs
(
ex´
.
g‘_sig
(),ƒx´.
g‘_chd»n
().
Ën
())?;

346 
	gex´
.
ke_chd»n
()

347 .
što_™”
()

348 .
m­
(|
chd
| 
Ex´essiÚ
::
bud
(
ùx
, child))

349 .
	gcŞËù
::<
ResuÉ
<
Vec
<
_
>>>()

350 .
m­
(|
chd»n
| {

351 
Ex´essiÚ
::
SÿÏrFn
(
FnC®l
 {

352 
sig
: 
ex´
.
g‘_sig
(),

353 
chd»n
: children,

354 

:p,

358 
	gEx´Ty³
::
CŞumnRef
 => {

359 
Ët
 
off£t
 = 
ex´
.
g‘_v®
().
decode_i64
().
m­_”r
(
E¼Ü
::
äom
)? 
as
 
usize
;

360 
Ët
 
	gcŞumn
 = 
CŞumn
 {

361 
off£t
: offset,

362 

:p,

364 
Ok
(
Ex´essiÚ
::
CŞumnRef
(
cŞumn
))

366 
unhªdËd
 => 
E¼
(
box_”r
!("can't handle {:?}ƒxpr in DAG mode", unhandled)),

371 #[
cfg
(
‹¡
)]

372 
mod
 
	g‹¡
 {

373 
u£
 
	g¡d
::{
i64
, 
	gu64
};

374 
u£
 
	gcİroûssÜ
::
codec
::{
cÚv”t
, 
	gD©um
};

375 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
ty³s
, 
	gDecim®
, 
	gDu¿tiÚ
, 
	gJsÚ
, 
	gTime
};

376 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
‹¡
::
cŞ_ex´
;

377 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gEx´Ty³
, 
	gF›ldTy³
, 
	gSÿÏrFuncSig
};

378 
u£
 
	gsu³r
::{
E¼Ü
, 
	gEx´essiÚ
, 
	gS‹m’tCÚ‹xt
};

380 #[
šlše
]

381 
pub
 
â
 
¡r2dec
(
s
: &
¡r
è-> 
D©um
 {

382 
D©um
::
Dec
(
s
.
·r£
().
unw¿p
())

385 #[
šlše
]

386 
pub
 
â
 
make_nuÎ_d©ums
(
size
: 
usize
è-> 
Vec
<
D©um
> {

387 (0..
size
).
m­
(|
_
| 
D©um
::
NuÎ
).
cŞËù
()

390 #[
šlše
]

391 
pub
 
â
 
check_ov”æow
(
e
: 
E¼Ü
è-> 
ResuÉ
<(), ()> {

392 
m©ch
 
	ge
 {

393 
	gE¼Ü
::
Ov”æow
 => 
Ok
(()),

394 
	g_
 => 
E¼
(()),

398 
pub
 
â
 
âÿÎ_ex´
(
sig
: 
SÿÏrFuncSig
, 
chd»n
: &[
Ex´
]) -> Expr {

399 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

400 
	gex´
.
£t_
(
Ex´Ty³
::
SÿÏrFunc
);

401 
	gex´
.
£t_sig
(
sig
);

402 
	gex´
.
£t_f›ld_ty³
(
F›ldTy³
::
Ãw
());

403 
chd
 
š
 
	gchd»n
 {

404 
	gex´
.
mut_chd»n
().
push
(
chd
.
şÚe
());

406 
	gex´


409 #[
‹¡
]

410 
â
 
‹¡_ex´essiÚ_ev®
() {

411 
Ët
 
mut
 
	gùx
 = 
S‹m’tCÚ‹xt
::();

412 
	gùx
.
	gignÜe_Œunÿ‹
 = 
Œue
;

413 
Ët
 
	gÿ£s
 = 
vec
![

415 
SÿÏrFuncSig
::
Ca¡SŒšgAsR—l
,

416 
vec
![
D©um
::
By‹s
(
b
"123".
to_vec
())],

417 
	gD©um
::
F64
(123f64),

420 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsDecim®
,

421 
	gvec
![
D©um
::
By‹s
(
b
"123".
to_vec
())],

422 
	gD©um
::
Dec
(
Decim®
::
äom
(123)),

425 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsDu¿tiÚ
,

426 
	gvec
![
D©um
::
By‹s
(
b
"12:02:03".
to_vec
())],

427 
	gD©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"12:02:03", 0).
unw¿p
()),

430 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsTime
,

431 
	gvec
![
D©um
::
By‹s
(
b
"2012-12-12 14:00:05".
to_vec
())],

432 
	gD©um
::
Time
(Time::
·r£_utc_d©‘ime
("2012-12-12 14:00:05", 0).
unw¿p
()),

435 
	gSÿÏrFuncSig
::
Ca¡SŒšgAsSŒšg
,

436 
	gvec
![
D©um
::
By‹s
(
b
"134".
to_vec
())],

437 
	gD©um
::
By‹s
(
b
"134".
to_vec
()),

440 
	gSÿÏrFuncSig
::
Ca¡IÁAsJsÚ
,

441 
	gvec
![
D©um
::
I64
(12)],

442 
	gD©um
::
JsÚ
(JsÚ::
I64
(12)),

445 
	gsig
, 
	gcŞs
, 
	gexp
è
š
 
	gÿ£s
 {

446 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0);

447 
Ët
 
mut
 
	gex
 = 
âÿÎ_ex´
(
sig
, &[
cŞ_ex´
]);

448 
	gex
.
mut_f›ld_ty³
()

449 .
£t_decim®
(
cÚv”t
::
UNSPECIFIED_LENGTH
 
as
 
i32
);

450 
	gex
.
mut_f›ld_ty³
()

451 .
£t_æ’
(
cÚv”t
::
UNSPECIFIED_LENGTH
 
as
 
i32
);

452 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

453 
Ët
 
	g»s
 = 
e
.
ev®
(&
ùx
, &
cŞs
).
unw¿p
();

454 
Ët
 
	gD©um
::
F64
(
_
èğ
exp
 {

455 
as£¹_eq
!(
fÜm©
!("{}", 
»s
), fÜm©!("{}", 
exp
));

457 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

461 
Ët
 
	gÿ£s
 = 
vec
![

463 
Some
(
ty³s
::
UNSIGNED_FLAG
),

464 
vec
![
D©um
::
U64
(
u64
::
MAX
)],

465 
	gD©um
::
U64
(
u64
::
MAX
),

467 (
	gNÚe
, 
	gvec
![
D©um
::
I64
(
i64
::
MIN
)], 
	gD©um
::I64(i64::MIN)),

468 (
	gNÚe
, 
	gvec
![
D©um
::
NuÎ
], 
	gD©um
::Null),

470 
	gæag
, 
	gcŞs
, 
	gexp
è
š
 
	gÿ£s
 {

471 
Ët
 
	gcŞ_ex´
 = 
cŞ_ex´
(0);

472 
Ët
 
mut
 
	gex
 = 
âÿÎ_ex´
(
SÿÏrFuncSig
::
Ca¡IÁAsIÁ
, &[
cŞ_ex´
]);

473 
	gæag
.
is_some
() {

474 
	gex
.
mut_f›ld_ty³
().
£t_æag
(
æag
.
unw¿p
(è
as
 
u32
);

476 
Ët
 
	ge
 = 
Ex´essiÚ
::
bud
(&
ùx
, 
ex
).
unw¿p
();

477 
Ët
 
	g»s
 = 
e
.
ev®
(&
ùx
, &
cŞs
).
unw¿p
();

478 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

	@src/coprocessor/dag/mod.rs

13 
pub
 
mod
 
	gexecutÜ
;

14 
pub
 
mod
 
	gdag
;

15 
pub
 
mod
 
	gex´
;

16 
pub
 
u£
 
	g£lf
::
dag
::
DAGCÚ‹xt
;

	@src/coprocessor/endpoint.rs

14 
u£
 
	g¡d
::
usize
;

15 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

16 
u£
 
	g¡d
::
sync
::
Arc
;

17 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDebug
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

18 
u£
 
	g¡d
::
mem
;

20 
u£
 
	gtb
::
£Ëù
::{
£lf
, 
	gDAGReque¡
, 
	gS–eùReque¡
};

21 
u£
 
	gtb
::
ª®yze
::{
AÇlyzeReq
, 
	gAÇlyzeTy³
};

22 
u£
 
	gtb
::
executÜ
::
ExecTy³
;

23 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

24 
u£
 
	g´Ùobuf
::{
CodedIÅutSŒ—m
, 
Mes§ge
 
as
 
	gPbMsg
};

25 
u£
 
	gkv´Ùo
::
cİroûssÜ
::{
KeyRªge
, 
	gReque¡
, 
	gRe¥Ú£
};

26 
u£
 
	gkv´Ùo
::
”rÜpb
::{
£lf
, 
	gS”v”IsBusy
};

27 
u£
 
	gkv´Ùo
::
kv½ıb
::{
CommªdPri
, 
	gIsŞ©iÚLev–
};

29 
u£
 
	gut
::
time
::{
du¿tiÚ_to_£c
, 
	gIn¡ªt
};

30 
u£
 
	gut
::
wÜk”
::{
B©chRuÂabË
, 
	gFutu»ScheduËr
, 
	gScheduËr
};

31 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

32 
u£
 
	gut
::
th»adpoŞ
::{
CÚ‹xt
, 
	gCÚ‹xtFaùÜy
, 
	gTh»adPoŞ
, 
	gTh»adPoŞBud”
};

33 
u£
 
	g£rv”
::{
CÚfig
, 
	gOnRe¥Ú£
};

34 
u£
 
	g¡Üage
::{
£lf
, 
	g’gše
, 
	gEngše
, 
	gFlowSti¡ics
, 
	gSÇpshÙ
, 
	gSti¡ics
, 
	gSti¡icsSumm¬y
};

35 
u£
 
	g¡Üage
::
’gše
::
E¼Ü
 
as
 
EngšeE¼Ü
;

36 
u£
 
	gpd
::
PdTask
;

38 
u£
 
	gsu³r
::
codec
::
mysql
;

39 
u£
 
	gsu³r
::
codec
::
d©um
::
D©um
;

40 
u£
 
	gsu³r
::
£Ëù
::£Ëù::
S–eùCÚ‹xt
;

41 
u£
 
	gsu³r
::
dag
::
DAGCÚ‹xt
;

42 
u£
 
	gsu³r
::
¡©i¡ics
::
ª®yze
::
AÇlyzeCÚ‹xt
;

43 
u£
 
	gsu³r
::
m‘rics
::*;

44 
u£
 
	gsu³r
::{
E¼Ü
, 
	gResuÉ
};

46 
pub
 cÚ¡ 
	gREQ_TYPE_SELECT
: 
i64
 = 101;

47 
pub
 cÚ¡ 
	gREQ_TYPE_INDEX
: 
i64
 = 102;

48 
pub
 cÚ¡ 
	gREQ_TYPE_DAG
: 
i64
 = 103;

49 
pub
 cÚ¡ 
	gREQ_TYPE_ANALYZE
: 
i64
 = 104;

53 cÚ¡ 
	gREQUEST_MAX_HANDLE_SECS
: 
u64
 = 60;

55 cÚ¡ 
	gSLOW_QUERY_LOWER_BOUND
: 
f64
 = 1.0;

57 cÚ¡ 
	gDEFAULT_ERROR_CODE
: 
i32
 = 1;

59 
pub
 cÚ¡ 
	gSINGLE_GROUP
: &'static [u8] = b"SingleGroup";

61 cÚ¡ 
OUTDATED_ERROR_MSG
: &'static str = "request outdated.";

63 cÚ¡ 
ENDPOINT_IS_BUSY
: &'static str = "endpoint is busy";

65 
pub
 
	sHo¡
 {

66 
’gše
: 
Box
<
Engše
>,

67 
	msched
: 
ScheduËr
<
Task
>,

68 
	m»qs
: 
HashM­
<
u64
, 
	mVec
<
	mReque¡Task
>>,

69 
	mÏ¡_»q_id
: 
u64
,

70 
	mpoŞ
: 
Th»adPoŞ
<
CİCÚ‹xt
>,

71 
	mlow_´iÜ™y_poŞ
: 
Th»adPoŞ
<
CİCÚ‹xt
>,

72 
	mhigh_´iÜ™y_poŞ
: 
Th»adPoŞ
<
CİCÚ‹xt
>,

73 
	mmax_ruÂšg_sk_couÁ
: 
usize
,

74 
	mb©ch_row_lim™
: 
usize
,

77 
pub
 
ty³
 
	gCİReque¡Sti¡ics
 = 
HashM­
<
u64
, 
	gFlowSti¡ics
>;

79 
pub
 
Œa™
 
	gCİS’d”
: 
S’d
 + 
ClÚe
 {

80 
â
 
£nd
(&
£lf
, 
CİReque¡Sti¡ics
è-> 
	gResuÉ
<()>;

83 
	sCİCÚ‹xtFaùÜy
 {

84 
	m£nd”
: 
Futu»ScheduËr
<
PdTask
>,

87 
im¶
 
	gCÚ‹xtFaùÜy
<
	gCİCÚ‹xt
> 
	gCİCÚ‹xtFaùÜy
 {

88 
â
 
ü—‹
(&
£lf
è-> 
	gCİCÚ‹xt
 {

89 
	gCİCÚ‹xt
 {

90 
	g£nd”
: 
£lf
.
£nd”
.
şÚe
(),

91 
	g£Ëù_¡©s
: 
DeçuÉ
::(),

92 
	gšdex_¡©s
: 
DeçuÉ
::(),

93 
	g»que¡_¡©s
: 
HashM­
::(),

98 
	sCİCÚ‹xt
 {

99 
	m£Ëù_¡©s
: 
Sti¡icsSumm¬y
,

100 
	mšdex_¡©s
: 
Sti¡icsSumm¬y
,

101 
	m»que¡_¡©s
: 
CİReque¡Sti¡ics
,

102 
	m£nd”
: 
Futu»ScheduËr
<
PdTask
>,

105 
im¶
 
	gCİCÚ‹xt
 {

106 
â
 
add_¡©i¡ics
(&
mut
 
£lf
, 
ty³_¡r
: &
¡r
, 
¡©s
: &
Sti¡ics
) {

107 
£lf
.
g‘_¡©i¡ics
(
ty³_¡r
).
add_¡©i¡ics
(
¡©s
);

110 
â
 
g‘_¡©i¡ics
(&
mut
 
£lf
, 
ty³_¡r
: &
¡r
è-> &muˆ
Sti¡icsSumm¬y
 {

111 
m©ch
 
ty³_¡r
 {

112 
STR_REQ_TYPE_SELECT
 => &
mut
 
£lf
.
£Ëù_¡©s
,

113 
	gSTR_REQ_TYPE_INDEX
 => &
mut
 
£lf
.
šdex_¡©s
,

114 
	g_
 => {

115 
w¬n
!("unknowÀSTR_REQ_TYPE: {}", 
ty³_¡r
);

116 &
mut
 
	g£lf
.
	g£Ëù_¡©s


121 
â
 
add_¡©i¡ics_by_»giÚ
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
¡©s
: &
Sti¡ics
) {

122 
Ët
 
æow_¡©s
 = 
£lf
.
»que¡_¡©s


123 .
’Œy
(
»giÚ_id
)

124 .
Ü_š£¹_w™h
(
FlowSti¡ics
::);

125 
	gæow_¡©s
.
add
(&
¡©s
.
wr™e
.
æow_¡©s
);

126 
	gæow_¡©s
.
add
(&
¡©s
.
d©a
.
æow_¡©s
);

130 
im¶
 
CÚ‹xt
 
	gCİCÚ‹xt
 {

131 
â
 
Ú_tick
(&
mut
 
£lf
) {

132 
ty³_¡r
 
	gš
 &[
STR_REQ_TYPE_SELECT
, 
STR_REQ_TYPE_INDEX
] {

133 
Ët
 
	gthis_¡©i¡ics
 = 
£lf
.
g‘_¡©i¡ics
(
ty³_¡r
);

134 
	gthis_¡©i¡ics
.
	gcouÁ
 == 0 {

137 
	gcf
, 
	gd‘as
è
š
 
	gthis_¡©i¡ics
.
	g¡©
.
d‘as
() {

138 
	gg
, 
	gcouÁ
è
š
 
	gd‘as
 {

139 
	gCOPR_SCAN_DETAILS


140 .
w™h_Ïb–_v®ues
(&[
ty³_¡r
, 
cf
, 
g
])

141 .
šc_by
(
couÁ
 
as
 
f64
)

142 .
unw¿p
();

145 *
	gthis_¡©i¡ics
 = 
DeçuÉ
::();

147 !
	g£lf
.
	g»que¡_¡©s
.
is_em±y
() {

148 
Ët
 
mut
 
	gto_£nd_¡©s
 = 
HashM­
::();

149 
	gmem
::
sw­
(&
mut
 
to_£nd_¡©s
, &muˆ
£lf
.
»que¡_¡©s
);

150 
Ët
 
E¼
(
e
èğ
£lf
.
£nd”
.
scheduË
(
PdTask
::
R—dSts
 {

151 
»ad_¡©s
: 
to_£nd_¡©s
,

153 
”rÜ
!("£nd cİroûssÜ sti¡ics: {:?}", 
e
);

159 
im¶
 
	gHo¡
 {

160 
pub
 
â
 
Ãw
(

161 
’gše
: 
Box
<
Engše
>,

162 
scheduËr
: 
ScheduËr
<
Task
>,

163 
cfg
: &
CÚfig
,

164 
r
: 
Futu»ScheduËr
<
PdTask
>,

165 è-> 
	gHo¡
 {

166 
	gHo¡
 {

167 
	g’gše
: 
’gše
,

168 
	gsched
: 
scheduËr
,

169 
	g»qs
: 
HashM­
::(),

170 
	gÏ¡_»q_id
: 0,

171 
	gmax_ruÂšg_sk_couÁ
: 
cfg
.
’d_pošt_max_sks
,

172 
	gb©ch_row_lim™
: 
cfg
.
’d_pošt_b©ch_row_lim™
,

173 
	gpoŞ
: 
Th»adPoŞBud”
::
Ãw
(

174 
thd_Çme
!("endpoint-normal-pool"),

175 
CİCÚ‹xtFaùÜy
 { 
£nd”
: 
r
.
şÚe
() },

176 ).
th»ad_couÁ
(
cfg
.
’d_pošt_cÚcu¼’cy
)

177 .
¡ack_size
(
cfg
.
’d_pošt_¡ack_size
.0 
as
 
usize
)

178 .
bud
(),

179 
	glow_´iÜ™y_poŞ
: 
Th»adPoŞBud”
::
Ãw
(

180 
thd_Çme
!("endpoint-low-pool"),

181 
CİCÚ‹xtFaùÜy
 { 
£nd”
: 
r
.
şÚe
() },

182 ).
th»ad_couÁ
(
cfg
.
’d_pošt_cÚcu¼’cy
)

183 .
¡ack_size
(
cfg
.
’d_pošt_¡ack_size
.0 
as
 
usize
)

184 .
bud
(),

185 
	ghigh_´iÜ™y_poŞ
: 
Th»adPoŞBud”
::
Ãw
(

186 
thd_Çme
!("endpoint-high-pool"),

187 
CİCÚ‹xtFaùÜy
 { 
£nd”
: 
r
.
şÚe
() },

188 ).
th»ad_couÁ
(
cfg
.
’d_pošt_cÚcu¼’cy
)

189 .
¡ack_size
(
cfg
.
’d_pošt_¡ack_size
.0 
as
 
usize
)

190 .
bud
(),

194 
â
 
ruÂšg_sk_couÁ
(&
£lf
è-> 
	gusize
 {

195 
	g£lf
.
	gpoŞ
.
g‘_sk_couÁ
(è+ s–f.
	glow_´iÜ™y_poŞ
.get_task_count() +

196 
	g£lf
.
	ghigh_´iÜ™y_poŞ
.
g‘_sk_couÁ
()

199 
â
 
hªdË_¢­shÙ_»suÉ
(&
mut
 
£lf
, 
id
: 
u64
, 
¢­shÙ
: 
’gše
::
ResuÉ
<
Box
<
SÇpshÙ
>>) {

200 
Ët
 
»qs
 = 
£lf
.»qs.
»move
(&
id
).
unw¿p
();

201 
Ët
 
	g¢­
 = 
m©ch
 
¢­shÙ
 {

202 
Ok
(
s
) => s,

203 
E¼
(
e
) => {

204 
nÙify_b©ch_çed
(
e
, 
»qs
);

209 
	g£lf
.
ruÂšg_sk_couÁ
(è>ğ
£lf
.
max_ruÂšg_sk_couÁ
 {

210 
nÙify_b©ch_çed
(
E¼Ü
::
FuÎ
(
£lf
.
max_ruÂšg_sk_couÁ
), 
»qs
);

214 
Ët
 
	gb©ch_row_lim™
 = 
£lf
.
b©ch_row_lim™
;

215 
»q
 
š
 
	g»qs
 {

216 
Ët
 
	g´i
 = 
»q
.
´iÜ™y
();

217 
Ët
 
	g´i_¡r
 = 
g‘_»q_´i_¡r
(
´i
);

218 
Ët
 
	gty³_¡r
 = 
»q
.
ùx
.
g‘_sÿn_g
();

219 
	gCOPR_PENDING_REQS


220 .
w™h_Ïb–_v®ues
(&[
ty³_¡r
, 
´i_¡r
])

221 .
add
(1.0);

222 
Ët
 
	g’d_pošt
 = 
TiDbEndPošt
::
Ãw
(
¢­
.
şÚe
());

224 
Ët
 
	gpoŞ
 = 
m©ch
 
´i
 {

225 
CommªdPri
::
Low
 => &
mut
 
£lf
.
low_´iÜ™y_poŞ
,

226 
	gCommªdPri
::
High
 => &
mut
 
£lf
.
high_´iÜ™y_poŞ
,

227 
	gCommªdPri
::
NÜm®
 => &
mut
 
£lf
.
poŞ
,

229 
	gpoŞ
.
execu‹
(
move
 |
ùx
: &
mut
 
CİCÚ‹xt
| {

230 
Ët
 
»giÚ_id
 = 
»q
.»q.
g‘_cÚ‹xt
().
g‘_»giÚ_id
();

231 
Ët
 
¡©s
 = 
’d_pošt
.
hªdË_»que¡
(
»q
, 
b©ch_row_lim™
);

232 
ùx
.
add_¡©i¡ics
(
ty³_¡r
, &
¡©s
);

233 
ùx
.
add_¡©i¡ics_by_»giÚ
(
»giÚ_id
, &
¡©s
);

234 
COPR_PENDING_REQS


235 .
w™h_Ïb–_v®ues
(&[
ty³_¡r
, 
´i_¡r
])

236 .
dec
();

242 
pub
 
	eTask
 {

243 
Reque¡
(
Reque¡Task
),

244 
SÇpRes
(
u64
, 
’gše
::
ResuÉ
<
Box
<
SÇpshÙ
>>),

245 
B©chSÇpRes
(
Vec
<(
u64
, 
’gše
::
ResuÉ
<
Box
<
SÇpshÙ
>>)>),

246 
R‘ryReque¡s
(
Vec
<
u64
>),

249 
im¶
 
Di¥Ïy
 
	gTask
 {

250 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

251 
m©ch
 *
£lf
 {

252 
Task
::
Reque¡
(
»f
 
»q
è=> 
wr™e
!(
f
, "{}", 
	g»q
),

253 
	gTask
::
SÇpRes
(
»q_id
, 
_
è=> 
wr™e
!(
f
, "¢­» [{}]", 
	g»q_id
),

254 
	gTask
::
B©chSÇpRes
(
_
è=> 
wr™e
!(
f
, "batch snapres"),

255 
	gTask
::
R‘ryReque¡s
(
»f
 
»Œy
è=> 
wr™e
!(
f
, "»Œy oÀsk ids: {:?}", 
	g»Œy
),

260 
	eCİReque¡
 {

261 
S–eù
(
S–eùReque¡
),

262 
DAG
(
DAGReque¡
),

263 
AÇlyze
(
AÇlyzeReq
),

266 
pub
 
	sReqCÚ‹xt
 {

268 
pub
 
	md—dlše
: 
In¡ªt
,

269 
pub
 
	misŞ©iÚ_Ëv–
: 
IsŞ©iÚLev–
,

270 
pub
 
	mfl_ÿche
: 
boŞ
,

272 
pub
 
	mbË_sÿn
: 
boŞ
,

275 
im¶
 
	gReqCÚ‹xt
 {

276 #[
šlše
]

277 
â
 
g‘_sÿn_g
(&
£lf
) -> &'static str {

278 
	g£lf
.
	gbË_sÿn
 {

279 
	gSTR_REQ_TYPE_SELECT


281 
	gSTR_REQ_TYPE_INDEX


285 
pub
 
â
 
check_if_outd©ed
(&
£lf
è-> 
	gResuÉ
<()> {

286 
Ët
 
	gnow
 = 
In¡ªt
::
now_cßr£
();

287 
	g£lf
.
	gd—dlše
 <ğ
now
 {

288  
E¼
(
E¼Ü
::
Outd©ed
(
£lf
.
d—dlše
, 
now
, s–f.
g‘_sÿn_g
()));

290 
Ok
(())

294 
pub
 
	sReque¡Task
 {

295 
	m»q
: 
Reque¡
,

296 
	m¡¬t_ts
: 
O±iÚ
<
u64
>,

297 
	mwa™_time
: 
O±iÚ
<
f64
>,

298 
	mtim”
: 
In¡ªt
,

299 
	m¡©i¡ics
: 
Sti¡ics
,

300 
	mÚ_»¥
: 
OnRe¥Ú£
,

301 
	mcİ_»q
: 
O±iÚ
<
ResuÉ
<
CİReque¡
>>,

302 
	mùx
: 
Arc
<
ReqCÚ‹xt
>,

305 
im¶
 
	gReque¡Task
 {

306 
pub
 
â
 
Ãw
(
»q
: 
Reque¡
, 
Ú_»¥
: 
OnRe¥Ú£
, 
»cursiÚ_lim™
: 
u32
è-> 
Reque¡Task
 {

307 
Ët
 
tim”
 = 
In¡ªt
::
now_cßr£
();

308 
Ët
 
	gd—dlše
 = 
tim”
 + 
Du¿tiÚ
::
äom_£cs
(
REQUEST_MAX_HANDLE_SECS
);

309 
Ët
 
mut
 
	g¡¬t_ts
 = 
NÚe
;

310 
Ët
 
	g
 = 
»q
.
g‘_
();

311 
Ët
 
mut
 
	gbË_sÿn
 = 
çl£
;

312 
Ët
 
	gcİ_»q
 = 
m©ch
 

 {

313 
REQ_TYPE_SELECT
 | 
REQ_TYPE_INDEX
 => {

314 

 =ğ
REQ_TYPE_SELECT
 {

315 
bË_sÿn
 = 
Œue
;

317 
Ët
 
mut
 
	gis
 = 
CodedIÅutSŒ—m
::
äom_by‹s
(
»q
.
g‘_d©a
());

318 
	gis
.
£t_»cursiÚ_lim™
(
»cursiÚ_lim™
);

319 
Ët
 
mut
 
	g£l
 = 
S–eùReque¡
::
Ãw
();

320 
Ët
 
E¼
(
e
èğ
£l
.
m”ge_äom
(&
mut
 
is
) {

321 
E¼
(
box_”r
!(
e
))

323 
¡¬t_ts
 = 
Some
(
£l
.
g‘_¡¬t_ts
());

324 
Ok
(
CİReque¡
::
S–eù
(
£l
))

327 
REQ_TYPE_DAG
 => {

328 
Ët
 
mut
 
is
 = 
CodedIÅutSŒ—m
::
äom_by‹s
(
»q
.
g‘_d©a
());

329 
	gis
.
£t_»cursiÚ_lim™
(
»cursiÚ_lim™
);

330 
Ët
 
mut
 
	gdag
 = 
DAGReque¡
::
Ãw
();

331 
Ët
 
E¼
(
e
èğ
dag
.
m”ge_äom
(&
mut
 
is
) {

332 
E¼
(
box_”r
!(
e
))

334 
¡¬t_ts
 = 
Some
(
dag
.
g‘_¡¬t_ts
());

335 
Ët
 
Some
(
sÿn
èğ
dag
.
g‘_executÜs
().
™”
().
Ãxt
() {

336 
sÿn
.
g‘_
(è=ğ
ExecTy³
::
Ty³TabËSÿn
 {

337 
bË_sÿn
 = 
Œue
;

340 
Ok
(
CİReque¡
::
DAG
(
dag
))

343 
REQ_TYPE_ANALYZE
 => {

344 
Ët
 
mut
 
is
 = 
CodedIÅutSŒ—m
::
äom_by‹s
(
»q
.
g‘_d©a
());

345 
	gis
.
£t_»cursiÚ_lim™
(
»cursiÚ_lim™
);

346 
Ët
 
mut
 
	gª®yze
 = 
AÇlyzeReq
::
Ãw
();

347 
Ët
 
E¼
(
e
èğ
ª®yze
.
m”ge_äom
(&
mut
 
is
) {

348 
E¼
(
box_”r
!(
e
))

350 
¡¬t_ts
 = 
Some
(
ª®yze
.
g‘_¡¬t_ts
());

351 
	gª®yze
.
g‘_
(è=ğ
AÇlyzeTy³
::
Ty³CŞumn
 {

352 
bË_sÿn
 = 
Œue
;

354 
Ok
(
CİReque¡
::
AÇlyze
(
ª®yze
))

358 
_
 => 
E¼
(
box_”r
!("unsuµÜ‹d°{}", 

)),

360 
Ët
 
	g»q_ùx
 = 
ReqCÚ‹xt
 {

361 
d—dlše
: deadline,

362 
isŞ©iÚ_Ëv–
: 
»q
.
g‘_cÚ‹xt
().
g‘_isŞ©iÚ_Ëv–
(),

363 
fl_ÿche
: !
»q
.
g‘_cÚ‹xt
().
g‘_nÙ_fl_ÿche
(),

364 
bË_sÿn
:able_scan,

366 
	gReque¡Task
 {

367 
	g»q
: 
»q
,

368 
	g¡¬t_ts
: 
¡¬t_ts
,

369 
	gwa™_time
: 
NÚe
,

370 
	gtim”
: 
tim”
,

371 
	g¡©i¡ics
: 
DeçuÉ
::(),

372 
	gÚ_»¥
: 
Ú_»¥
,

373 
	gcİ_»q
: 
Some
(
cİ_»q
),

374 
	gùx
: 
Arc
::
Ãw
(
»q_ùx
),

378 #[
šlše
]

379 
â
 
check_outd©ed
(&
£lf
è-> 
	gResuÉ
<()> {

380 
	g£lf
.
	gùx
.
check_if_outd©ed
()

383 
â
 
¡İ_»cÜd_wa™šg
(&
mut
 
£lf
) {

384 
	g£lf
.
	gwa™_time
.
is_some
() {

387 
Ët
 
	gwa™_time
 = 
du¿tiÚ_to_£c
(
£lf
.
tim”
.
–­£d
());

388 
	gCOPR_REQ_WAIT_TIME


389 .
w™h_Ïb–_v®ues
(&[
£lf
.
ùx
.
g‘_sÿn_g
()])

390 .
ob£rve
(
wa™_time
);

391 
	g£lf
.
	gwa™_time
 = 
Some
(
wa™_time
);

394 
â
 
¡İ_»cÜd_hªdlšg
(&
mut
 
£lf
) {

395 
	g£lf
.
¡İ_»cÜd_wa™šg
();

397 
Ët
 
	gqu”y_time
 = 
du¿tiÚ_to_£c
(
£lf
.
tim”
.
–­£d
());

398 
Ët
 
	gty³_¡r
 = 
£lf
.
ùx
.
g‘_sÿn_g
();

399 
	gCOPR_REQ_HISTOGRAM_VEC


400 .
w™h_Ïb–_v®ues
(&[
ty³_¡r
])

401 .
ob£rve
(
qu”y_time
);

402 
Ët
 
	gwa™_time
 = 
£lf
.
wa™_time
.
unw¿p
();

403 
Ët
 
	ghªdË_time
 = 
qu”y_time
 - 
wa™_time
;

404 
	gCOPR_REQ_HANDLE_TIME


405 .
w™h_Ïb–_v®ues
(&[
ty³_¡r
])

406 .
ob£rve
(
hªdË_time
);

408 
	gCOPR_SCAN_KEYS


409 .
w™h_Ïb–_v®ues
(&[
ty³_¡r
])

410 .
ob£rve
(
£lf
.
¡©i¡ics
.
tÙ®_İ_couÁ
(è
as
 
f64
);

413 
	ghªdË_time
 > 
	gSLOW_QUERY_LOWER_BOUND
 {

414 
	gšfo
!(

417 
	g£lf
.
	g»q
.
g‘_cÚ‹xt
().
g‘_»giÚ_id
(),

418 
	g£lf
.
	g¡¬t_ts
,

419 
	gty³_¡r
,

420 
	ghªdË_time
,

421 
	g£lf
.
	g¡©i¡ics
.
tÙ®_İ_couÁ
(),

422 
	g£lf
.
	g¡©i¡ics
.
tÙ®_´oûs£d
(),

423 
	g£lf
.
	g»q
.
g‘_¿nges
().
Ën
(),

424 
	g£lf
.
	g»q
.
g‘_¿nges
().
g‘
(0)

429 
pub
 
â
 
´iÜ™y
(&
£lf
è-> 
	gCommªdPri
 {

430 
	g£lf
.
	g»q
.
g‘_cÚ‹xt
().
g‘_´iÜ™y
()

434 
im¶
 
Di¥Ïy
 
	gReque¡Task
 {

435 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

436 
wr™e
!(

437 
f
,

439 
	g£lf
.
	g»q
.
g‘_cÚ‹xt
(),

440 
	g£lf
.
	g»q
.
g‘_
(),

441 
	g£lf
.
	g»q
.
g‘_¿nges
().
Ën
(),

442 
	g£lf
.
	g»q
.
g‘_¿nges
().
g‘
(0)

447 
im¶
 
	gB©chRuÂabË
<
	gTask
> 
	gHo¡
 {

449 #[
®low
(
fÜ_kv_m­
)]

450 
â
 
run_b©ch
(&
mut
 
£lf
, 
sks
: &muˆ
Vec
<
Task
>) {

451 
Ët
 
mut
 
grou³d_»qs
 = 
m­
![];

452 
sk
 
š
 
	gsks
.
d¿š
(..) {

453 
m©ch
 
	gsk
 {

454 
	gTask
::
Reque¡
(
»q
) => {

455 
Ët
 
E¼
(
e
èğ
»q
.
check_outd©ed
() {

456 
Ú_”rÜ
(
e
, 
»q
);

459 
Ët
 
	gkey
 = {

460 
Ët
 
ùx
 = 
»q
.»q.
g‘_cÚ‹xt
();

462 
	gùx
.
g‘_»giÚ_id
(),

463 
	gùx
.
g‘_»giÚ_•och
().
g‘_v”siÚ
(),

464 
	gùx
.
g‘_³”
().
g‘_id
(),

467 
Ët
 
	ggroup
 = 
grou³d_»qs
.
’Œy
(
key
).
Ü_š£¹_w™h
(
Vec
::
Ãw
);

468 
	ggroup
.
push
(
»q
);

470 
	gTask
::
SÇpRes
(
q_id
, 
¢­_»s
) => {

471 
£lf
.
hªdË_¢­shÙ_»suÉ
(
q_id
, 
¢­_»s
);

473 
	gTask
::
B©chSÇpRes
(
b©ch
è=> 
q_id
, 
	g¢­_»s
è
š
 
	gb©ch
 {

474 
	g£lf
.
hªdË_¢­shÙ_»suÉ
(
q_id
, 
¢­_»s
);

476 
	gTask
::
R‘ryReque¡s
(
»Œy
è=> 
id
 
š
„etry {

477 
Ët
 
»qs
 = 
£lf
.»qs.
»move
(&
id
).
unw¿p
();

478 
Ët
 
	gsched
 = 
£lf
.
sched
.
şÚe
();

479 
Ët
 
E¼
(
e
èğ
£lf
.
’gše
.
async_¢­shÙ
(

480 
»qs
[0].
»q
.
g‘_cÚ‹xt
(),

481 
box
 
move
 |(
_
, 
»s
)| 
sched
.
scheduË
(
Task
::
SÇpRes
(
id
,„es)).
unw¿p
(),

483 
nÙify_b©ch_çed
(
e
, 
»qs
);

485 
	g£lf
.
	g»qs
.
š£¹
(
id
, 
»qs
);

491 
	ggrou³d_»qs
.
is_em±y
() {

495 
Ët
 
mut
 
	gb©ch
 = 
Vec
::
w™h_ÿ·c™y
(
grou³d_»qs
.
Ën
());

496 
Ët
 
	g¡¬t_id
 = 
£lf
.
Ï¡_»q_id
 + 1;

497 
	g_
, 
	g»qs
è
š
 
	ggrou³d_»qs
 {

498 
	g£lf
.
	gÏ¡_»q_id
 += 1;

499 
Ët
 
	gid
 = 
£lf
.
Ï¡_»q_id
;

500 
Ët
 
	gùx
 = 
»qs
[0].
»q
.
g‘_cÚ‹xt
().
şÚe
();

501 
	gb©ch
.
push
(
ùx
);

502 
	g£lf
.
	g»qs
.
š£¹
(
id
, 
»qs
);

504 
Ët
 
	g’d_id
 = 
£lf
.
Ï¡_»q_id
;

506 
Ët
 
	gsched
 = 
£lf
.
sched
.
şÚe
();

507 
Ët
 
	gÚ_fšished
: 
’gše
::
B©chC®lback
<
Box
<
SÇpshÙ
>> = 
box
 
move
 |
»suÉs
: 
Vec
<
_
>| {

508 
Ët
 
mut
 
»ady
 = 
Vec
::
w™h_ÿ·c™y
(
»suÉs
.
Ën
());

509 
Ët
 
mut
 
	g»Œy
 = 
Vec
::
Ãw
();

510 
	gid
, 
	g»s
è
š
 (
¡¬t_id
..
’d_id
 + 1).
z
(
»suÉs
) {

511 
m©ch
 
	g»s
 {

512 
Some
((
_
, 
»s
)) => {

513 
»ady
.
push
((
id
, 
»s
));

515 
	gNÚe
 => {

516 
»Œy
.
push
(
id
);

521 !
	g»ady
.
is_em±y
() {

522 
	gsched
.
scheduË
(
Task
::
B©chSÇpRes
(
»ady
)).
unw¿p
();

524 !
	g»Œy
.
is_em±y
() {

525 
	gBATCH_REQUEST_TASKS


526 .
w™h_Ïb–_v®ues
(&["retry"])

527 .
ob£rve
(
»Œy
.
Ën
(è
as
 
f64
);

528 
	gsched
.
scheduË
(
Task
::
R‘ryReque¡s
(
»Œy
)).
unw¿p
();

532 
	gBATCH_REQUEST_TASKS


533 .
w™h_Ïb–_v®ues
(&["all"])

534 .
ob£rve
(
b©ch
.
Ën
(è
as
 
f64
);

535 
Ët
 
E¼
(
e
èğ
£lf
.
’gše
.
async_b©ch_¢­shÙ
(
b©ch
, 
Ú_fšished
) {

536 
id
 
š
 
	g¡¬t_id
..
	g’d_id
 + 1 {

537 
Ët
 
	g»qs
 = 
£lf
.
»qs
.
»move
(&
id
).
unw¿p
();

538 
Ët
 
	g”r
 = 
e
.
maybe_şÚe
().
unw¿p_Ü_–£
(|| {

539 
”rÜ
!("asynø¢­shÙ b©ch faedƒ¼Ü {:?}", 
e
);

540 
EngšeE¼Ü
::
Oth”
(
box_”r
!("{:?}", 
e
))

542 
nÙify_b©ch_çed
(
”r
, 
»qs
);

547 
â
 
shutdown
(&
mut
 
£lf
) {

548 
Ët
 
E¼
(
e
èğ
£lf
.
poŞ
.
¡İ
() {

549 
w¬n
!("Stİh»adpoŞ faed w™h {:?}", 
e
);

551 
Ët
 
E¼
(
e
èğ
£lf
.
low_´iÜ™y_poŞ
.
¡İ
() {

552 
w¬n
!("Stİh»adpoŞ faed w™h {:?}", 
e
);

554 
Ët
 
E¼
(
e
èğ
£lf
.
high_´iÜ™y_poŞ
.
¡İ
() {

555 
w¬n
!("Stİh»adpoŞ faed w™h {:?}", 
e
);

560 
â
 
”r_»¥
(
e
: 
E¼Ü
è-> 
Re¥Ú£
 {

561 
Ët
 
mut
 
»¥
 = 
Re¥Ú£
::
Ãw
();

562 
m©ch
 
	ge
 {

563 
	gE¼Ü
::
RegiÚ
(
e
) => {

564 
Ët
 
g
 = 
¡Üage
::
g‘_g_äom_h—d”
(&
e
);

565 
	gCOPR_REQ_ERROR
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

566 
	g»¥
.
£t_»giÚ_”rÜ
(
e
);

568 
	gE¼Ü
::
Locked
(
šfo
) => {

569 
»¥
.
£t_locked
(
šfo
);

570 
	gCOPR_REQ_ERROR
.
w™h_Ïb–_v®ues
(&["lock"]).
šc
();

572 
	gE¼Ü
::
Outd©ed
(
d—dlše
, 
now
, 
sÿn_g
) => {

573 
Ët
 
–­£d
 =

574 
now
.
du¿tiÚ_sšû
(
d—dlše
è+ 
Du¿tiÚ
::
äom_£cs
(
REQUEST_MAX_HANDLE_SECS
);

575 
	gCOPR_REQ_ERROR
.
w™h_Ïb–_v®ues
(&["outd©ed"]).
šc
();

576 
	gOUTDATED_REQ_WAIT_TIME


577 .
w™h_Ïb–_v®ues
(&[
sÿn_g
])

578 .
ob£rve
(
–­£d
.
as_£cs
(è
as
 
f64
);

580 
	g»¥
.
£t_Ùh”_”rÜ
(
OUTDATED_ERROR_MSG
.
to_owÃd
());

582 
	gE¼Ü
::
FuÎ
(
®low
) => {

583 
COPR_REQ_ERROR
.
w™h_Ïb–_v®ues
(&["fuÎ"]).
šc
();

584 
Ët
 
mut
 
	g”rÜpb
 = 
”rÜpb
::
E¼Ü
::
Ãw
();

585 
	g”rÜpb
.
£t_mes§ge
(
fÜm©
!("ruÂšg b©che »ach†im™ {}", 
®low
));

586 
Ët
 
mut
 
	g£rv”_is_busy_”r
 = 
S”v”IsBusy
::
Ãw
();

587 
	g£rv”_is_busy_”r
.
£t_»asÚ
(
ENDPOINT_IS_BUSY
.
to_owÃd
());

588 
	g”rÜpb
.
£t_£rv”_is_busy
(
£rv”_is_busy_”r
);

589 
	g»¥
.
£t_»giÚ_”rÜ
(
”rÜpb
);

591 
	gE¼Ü
::
Oth”
(
_
) => {

592 
»¥
.
£t_Ùh”_”rÜ
(
fÜm©
!("{}", 
e
));

593 
	gCOPR_REQ_ERROR
.
w™h_Ïb–_v®ues
(&["Ùh”"]).
šc
();

596 
	g»¥


599 
â
 
Ú_”rÜ
(
e
: 
E¼Ü
, 
»q
: 
Reque¡Task
è-> 
Sti¡ics
 {

600 
Ët
 
»¥
 = 
”r_»¥
(
e
);

601 
»¥Úd
(
»¥
, 
»q
)

604 
â
 
	gnÙify_b©ch_çed
<
	gE
: 
IÁo
<
E¼Ü
> + 
Debug
>(
e
: 
E
, 
	g»qs
: 
Vec
<
Reque¡Task
>) {

605 
debug
!("çedØhªdË b©ch„eque¡: {:?}", 
	ge
);

606 
Ët
 
	g»¥
 = 
”r_»¥
(
e
.
što
());

607 
t
 
š
 
	g»qs
 {

608 
»¥Úd
(
»¥
.
şÚe
(), 
t
);

612 
â
 
»¥Úd
(
»¥
: 
Re¥Ú£
, 
mut
 
t
: 
Reque¡Task
è-> 
Sti¡ics
 {

613 
t
.
¡İ_»cÜd_hªdlšg
();

614 (
	gt
.
	gÚ_»¥
)(
	g»¥
);

615 
	gt
.
	g¡©i¡ics


618 
pub
 
	sTiDbEndPošt
 {

619 
	m¢­
: 
Box
<
SÇpshÙ
>,

622 
im¶
 
	gTiDbEndPošt
 {

623 
pub
 
â
 
Ãw
(
¢­
: 
Box
<
SÇpshÙ
>è-> 
TiDbEndPošt
 {

624 
TiDbEndPošt
 { 
¢­
: snap }

628 
im¶
 
TiDbEndPošt
 {

629 
â
 
hªdË_»que¡
(
£lf
, 
mut
 
t
: 
Reque¡Task
, 
b©ch_row_lim™
: 
usize
è-> 
Sti¡ics
 {

630 
t
.
¡İ_»cÜd_wa™šg
();

632 
Ët
 
E¼
(
e
èğ
t
.
check_outd©ed
() {

633  
Ú_”rÜ
(
e
, 
t
);

635 
Ët
 
	g»¥
 = 
m©ch
 
t
.
cİ_»q
.
ke
().
unw¿p
() {

636 
Ok
(
CİReque¡
::
S–eù
(
£l
)è=> 
£lf
.
hªdË_£Ëù
(£l, &
mut
 
t
, 
b©ch_row_lim™
),

637 
Ok
(
CİReque¡
::
DAG
(
dag
)è=> 
£lf
.
hªdË_dag
(dag, &
mut
 
t
, 
b©ch_row_lim™
),

638 
Ok
(
CİReque¡
::
AÇlyze
(
ª®yze
)è=> 
£lf
.
hªdË_ª®yze
×Çlyze, &
mut
 
t
),

639 
E¼
(
”r
) => Err(err),

641 
m©ch
 
	g»¥
 {

642 
Ok
(
r
è=> 
»¥Úd
Ô, 
t
),

643 
E¼
(
e
è=> 
Ú_”rÜ
Ó, 
t
),

647 
â
 
hªdË_£Ëù
(

648 
£lf
,

649 
£l
: 
S–eùReque¡
,

650 
t
: &
mut
 
Reque¡Task
,

651 
b©ch_row_lim™
: 
usize
,

652 è-> 
	gResuÉ
<
	gRe¥Ú£
> {

653 
Ët
 
mut
 
	gùx
 = 
S–eùCÚ‹xt
::
Ãw
(
£l
, 
£lf
.
¢­
, 
t
.
ùx
.
şÚe
(), 
b©ch_row_lim™
)?;

654 
Ët
 
	g¿nges
 = 
t
.
»q
.
ke_¿nges
().
što_vec
();

655 
Ët
 
	g»s
 = 
ùx
.
hªdË_»que¡
(
¿nges
);

656 
	gùx
.
cŞËù_¡©i¡ics_što
(&
mut
 
t
.
¡©i¡ics
);

657 
	g»s


660 
pub
 
â
 
hªdË_dag
(

661 
£lf
,

662 
dag
: 
DAGReque¡
,

663 
t
: &
mut
 
Reque¡Task
,

664 
b©ch_row_lim™
: 
usize
,

665 è-> 
	gResuÉ
<
	gRe¥Ú£
> {

666 
Ët
 
	g¿nges
 = 
t
.
»q
.
ke_¿nges
().
što_vec
();

667 
Ët
 
mut
 
	gùx
 = 
DAGCÚ‹xt
::
Ãw
(
dag
, 
¿nges
, 
£lf
.
¢­
, 
t
.
ùx
.
şÚe
(), 
b©ch_row_lim™
)?;

668 
Ët
 
	g»s
 = 
ùx
.
hªdË_»que¡
();

669 
	gùx
.
cŞËù_¡©i¡ics_što
(&
mut
 
t
.
¡©i¡ics
);

670 
	g»s


673 
pub
 
â
 
hªdË_ª®yze
(
£lf
, 
ª®yze
: 
AÇlyzeReq
, 
t
: &
mut
 
Reque¡Task
è-> 
ResuÉ
<
Re¥Ú£
> {

674 
Ët
 
¿nges
 = 
t
.
»q
.
ke_¿nges
().
što_vec
();

675 
Ët
 
	gùx
 = 
AÇlyzeCÚ‹xt
::
Ãw
(
ª®yze
, 
¿nges
, 
£lf
.
¢­
, 
t
.
ùx
.
as_»f
());

676 
	gùx
.
hªdË_»que¡
(&
mut
 
t
.
¡©i¡ics
)

680 
pub
 
â
 
to_pb_”rÜ
(
”r
: &
E¼Ü
è-> 
£Ëù
::Error {

681 
Ët
 
mut
 
e
 = 
£Ëù
::
E¼Ü
::
Ãw
();

682 
	ge
.
£t_code
(
DEFAULT_ERROR_CODE
);

683 
	ge
.
£t_msg
(
fÜm©
!("{}", 
”r
));

684 
	ge


687 
pub
 
â
 
´efix_Ãxt
(
key
: &[
u8
]è-> 
Vec
<u8> {

688 
Ët
 
mut
 
nk
 = 
key
.
to_vec
();

689 
	gnk
.
is_em±y
() {

690 
	gnk
.
push
(0);

691  
	gnk
;

693 
Ët
 
mut
 
	gi
 = 
nk
.
Ën
() - 1;

694 
	gloİ
 {

695 
	gnk
[
i
] == 255 {

696 
nk
[
i
] = 0;

698 
	gnk
[
i
] += 1;

699  
	gnk
;

701 
	gi
 == 0 {

702 
nk
 = 
key
.
to_vec
();

703 
	gnk
.
push
(0);

704  
	gnk
;

706 
	gi
 -= 1;

711 
pub
 
â
 
is_pošt
(
¿nge
: &
KeyRªge
è-> 
boŞ
 {

712 
¿nge
.
g‘_’d
(è=ğ&*
´efix_Ãxt
Ôªge.
g‘_¡¬t
())

715 #[
šlše
]

716 
pub
 
â
 
g‘_pk
(
cŞ
: &
CŞumnInfo
, 
h
: 
i64
è-> 
D©um
 {

717 
mysql
::
has_unsigÃd_æag
(
cŞ
.
g‘_æag
(è
as
 
u64
) {

719 
D©um
::
U64
(
h
 
as
 
u64
)

721 
D©um
::
I64
(
h
)

725 
pub
 cÚ¡ 
STR_REQ_TYPE_SELECT
: &'static str = "select";

726 
pub
 cÚ¡ 
STR_REQ_TYPE_INDEX
: &'static str = "index";

727 
pub
 cÚ¡ 
STR_REQ_PRI_LOW
: &'static str = "low";

728 
pub
 cÚ¡ 
STR_REQ_PRI_NORMAL
: &'static str = "normal";

729 
pub
 cÚ¡ 
STR_REQ_PRI_HIGH
: &'static str = "high";

731 #[
šlše
]

732 
pub
 
â
 
g‘_»q_´i_¡r
(
´i
: 
CommªdPri
) -> &'static str {

733 
m©ch
 
´i
 {

734 
CommªdPri
::
Low
 => 
STR_REQ_PRI_LOW
,

735 
	gCommªdPri
::
NÜm®
 => 
STR_REQ_PRI_NORMAL
,

736 
	gCommªdPri
::
High
 => 
STR_REQ_PRI_HIGH
,

740 #[
cfg
(
‹¡
)]

741 
mod
 
	g‹¡s
 {

742 
u£
 
	gsu³r
::*;

743 
u£
 
	g¡Üage
::
’gše
::{
£lf
, 
	gTEMP_DIR
};

744 
u£
 
	g¡d
::
sync
::*;

745 
u£
 
	g¡d
::
th»ad
;

746 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

748 
u£
 
	gkv´Ùo
::
cİroûssÜ
::
Reque¡
;

749 
u£
 
	gtb
::
£Ëù
::
DAGReque¡
;

750 
u£
 
	gtb
::
ex´essiÚ
::
Ex´
;

751 
u£
 
	gtb
::
executÜ
::
ExecutÜ
;

753 
u£
 
	gut
::
wÜk”
::{
Futu»WÜk”
, 
	gWÜk”
};

754 
u£
 
	gut
::
time
::
In¡ªt
;

756 #[
‹¡
]

757 
â
 
‹¡_g‘_»g_sÿn_g
() {

758 
Ët
 
mut
 
	gùx
 = 
ReqCÚ‹xt
 {

759 
d—dlše
: 
In¡ªt
::
now_cßr£
(),

760 
isŞ©iÚ_Ëv–
: 
IsŞ©iÚLev–
::
RC
,

761 
fl_ÿche
: 
Œue
,

762 
bË_sÿn
: 
Œue
,

764 
	gas£¹_eq
!(
	gùx
.
g‘_sÿn_g
(), 
	gSTR_REQ_TYPE_SELECT
);

765 
	gùx
.
	gbË_sÿn
 = 
çl£
;

766 
	gas£¹_eq
!(
	gùx
.
g‘_sÿn_g
(), 
	gSTR_REQ_TYPE_INDEX
);

769 #[
‹¡
]

770 
â
 
‹¡_»q_outd©ed
() {

771 
Ët
 
mut
 
	gwÜk”
 = 
WÜk”
::
Ãw
("test-endpoint");

772 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
TEMP_DIR
, &[]).
unw¿p
();

773 
Ët
 
mut
 
	gcfg
 = 
CÚfig
::();

774 
	gcfg
.
	g’d_pošt_cÚcu¼’cy
 = 1;

775 
Ët
 
	gpd_wÜk”
 = 
Futu»WÜk”
::
Ãw
("test-pd-worker");

776 
Ët
 
	g’d_pošt
 = 
Ho¡
::
Ãw
(
’gše
, 
wÜk”
.
scheduËr
(), &
cfg
, 
pd_wÜk”
.scheduler());

777 
	gwÜk”
.
¡¬t_b©ch
(
’d_pošt
, 30).
unw¿p
();

778 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

779 
Ët
 
mut
 
	gsk
 = 
Reque¡Task
::
Ãw
(

780 
Reque¡
::
Ãw
(),

781 
box
 
move
 |
msg
| { 
tx
.
£nd
(msg).
unw¿p
(); },

784 
Ët
 
	gùx
 = 
ReqCÚ‹xt
 {

785 
d—dlše
: 
sk
.
ùx
.d—dlš- 
Du¿tiÚ
::
äom_£cs
(
su³r
::
REQUEST_MAX_HANDLE_SECS
),

786 
isŞ©iÚ_Ëv–
: 
sk
.
ùx
.isolation_level,

787 
fl_ÿche
: 
sk
.
ùx
.fill_cache,

788 
bË_sÿn
: 
sk
.
ùx
.table_scan,

790 
	gsk
.
	gùx
 = 
Arc
::
Ãw
(
ùx
);

791 
	gwÜk”
.
scheduË
(
Task
::
Reque¡
(
sk
)).
unw¿p
();

792 
Ët
 
	g»¥
 = 
rx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

793 
	gas£¹
!(!
	g»¥
.
g‘_Ùh”_”rÜ
().
is_em±y
());

794 
	gas£¹_eq
!(
	g»¥
.
g‘_Ùh”_”rÜ
(), 
	gsu³r
::
OUTDATED_ERROR_MSG
);

796 #[
‹¡
]

797 
â
 
‹¡_too_mªy_»qs
() {

798 
Ët
 
mut
 
	gwÜk”
 = 
WÜk”
::
Ãw
("test-endpoint");

799 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
TEMP_DIR
, &[]).
unw¿p
();

800 
Ët
 
mut
 
	gcfg
 = 
CÚfig
::();

801 
	gcfg
.
	g’d_pošt_cÚcu¼’cy
 = 1;

802 
Ët
 
	gpd_wÜk”
 = 
Futu»WÜk”
::
Ãw
("test-pd-worker");

803 
Ët
 
mut
 
	g’d_pošt
 = 
Ho¡
::
Ãw
(
’gše
, 
wÜk”
.
scheduËr
(), &
cfg
, 
pd_wÜk”
.scheduler());

804 
	g’d_pošt
.
	gmax_ruÂšg_sk_couÁ
 = 3;

805 
	gwÜk”
.
¡¬t_b©ch
(
’d_pošt
, 30).
unw¿p
();

806 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

807 
pos
 
	gš
 0..30 * 4 {

808 
Ët
 
	gtx
 = 
tx
.
şÚe
();

809 
Ët
 
mut
 
	g»q
 = 
Reque¡
::
Ãw
();

810 
	gpos
 % 3 == 0 {

811 
»q
.
mut_cÚ‹xt
().
£t_´iÜ™y
(
CommªdPri
::
Low
);

812 } 
	gpos
 % 3 == 1 {

813 
»q
.
mut_cÚ‹xt
().
£t_´iÜ™y
(
CommªdPri
::
NÜm®
);

815 
	g»q
.
mut_cÚ‹xt
().
£t_´iÜ™y
(
CommªdPri
::
High
);

817 
Ët
 
	gsk
 = 
Reque¡Task
::
Ãw
(

818 
»q
,

819 
box
 
move
 |
msg
| {

820 
th»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(100));

821 
Ët
 
_
 = 
tx
.
£nd
(
msg
);

825 
	gwÜk”
.
scheduË
(
Task
::
Reque¡
(
sk
)).
unw¿p
();

827 
_
 
	gš
 0..120 {

828 
Ët
 
	g»¥
 = 
rx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

829 !
	g»¥
.
has_»giÚ_”rÜ
() {

832 
	gas£¹
!(
	g»¥
.
g‘_»giÚ_”rÜ
().
has_£rv”_is_busy
());

835 
	g·nic
!("supposeo get ServerIsBusyƒrror.");

838 #[
‹¡
]

839 
â
 
‹¡_¡ack_gu¬d
() {

840 
Ët
 
mut
 
	gex´
 = 
Ex´
::
Ãw
();

841 
_
 
	gš
 0..10 {

842 
Ët
 
mut
 
	ge
 = 
Ex´
::
Ãw
();

843 
	ge
.
mut_chd»n
().
push
(
ex´
);

844 
	gex´
 = 
e
;

846 
Ët
 
mut
 
	ge
 = 
ExecutÜ
::
Ãw
();

847 
	ge
.
mut_£ËùiÚ
().
mut_cÚd™iÚs
().
push
(
ex´
);

848 
Ët
 
mut
 
	gdag
 = 
DAGReque¡
::
Ãw
();

849 
	gdag
.
mut_executÜs
().
push
(
e
);

850 
Ët
 
mut
 
	g»q
 = 
Reque¡
::
Ãw
();

851 
	g»q
.
£t_
(
REQ_TYPE_DAG
);

852 
	g»q
.
£t_d©a
(
dag
.
wr™e_to_by‹s
().
unw¿p
());

853 
	gReque¡Task
::
Ãw
(
»q
.
şÚe
(), 
box
 
move
 |
_
| 
uÄ—chabË
!(), 100);

854 
	gReque¡Task
::
Ãw
(

855 
»q
,

856 
box
 
move
 |
»s
| {

857 
Ët
 
s
 = 
fÜm©
!("{:?}", 
»s
);

858 
as£¹
!(

859 
s
.
cÚšs
("Recursion"),

861 
s


	@src/coprocessor/metrics.rs

14 
u£
 
	g´om‘heus
::*;

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gCOPR_REQ_HISTOGRAM_VEC
: 
Hi¡og¿mVec
 =

18 
»gi¡”_hi¡og¿m_vec
!(

22 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

23 ).
unw¿p
();

25 
pub
 
»f
 
	gOUTDATED_REQ_WAIT_TIME
: 
Hi¡og¿mVec
 =

26 
»gi¡”_hi¡og¿m_vec
!(

30 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

31 ).
unw¿p
();

33 
pub
 
»f
 
	gCOPR_REQ_HANDLE_TIME
: 
Hi¡og¿mVec
 =

34 
»gi¡”_hi¡og¿m_vec
!(

38 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

39 ).
unw¿p
();

41 
pub
 
»f
 
	gCOPR_REQ_WAIT_TIME
: 
Hi¡og¿mVec
 =

42 
»gi¡”_hi¡og¿m_vec
!(

46 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

47 ).
unw¿p
();

49 
pub
 
»f
 
	gCOPR_REQ_ERROR
: 
CouÁ”Vec
 =

50 
»gi¡”_couÁ”_vec
!(

54 ).
unw¿p
();

56 
pub
 
»f
 
	gCOPR_PENDING_REQS
: 
GaugeVec
 =

57 
»gi¡”_gauge_vec
!(

61 ).
unw¿p
();

63 
pub
 
»f
 
	gCOPR_SCAN_KEYS
: 
Hi¡og¿mVec
 =

64 
»gi¡”_hi¡og¿m_vec
!(

68 
expÚ’tŸl_buck‘s
(1.0, 2.0, 20).
unw¿p
()

69 ).
unw¿p
();

71 
pub
 
»f
 
	gCOPR_SCAN_DETAILS
: 
CouÁ”Vec
 =

72 
»gi¡”_couÁ”_vec
!(

76 ).
unw¿p
();

78 
pub
 
»f
 
	gCOPR_EXECUTOR_COUNT
: 
CouÁ”Vec
 =

79 
»gi¡”_couÁ”_vec
!(

83 ).
unw¿p
();

85 
pub
 
»f
 
	gCOPR_GET_OR_SCAN_COUNT
: 
CouÁ”Vec
 =

86 
»gi¡”_couÁ”_vec
!(

90 ).
unw¿p
();

92 
pub
 
»f
 
	gBATCH_REQUEST_TASKS
: 
Hi¡og¿mVec
 =

93 
»gi¡”_hi¡og¿m_vec
!(

97 
	gvec
![1.0, 2.0, 4.0, 6.0, 8.0, 10.0, 12.0, 14.0, 16.0, 18.0,

99 ).
unw¿p
();

	@src/coprocessor/mod.rs

14 
mod
 
	g’dpošt
;

15 
mod
 
	gm‘rics
;

16 
mod
 
	gdag
;

17 
mod
 
	g¡©i¡ics
;

18 
pub
 
mod
 
	g£Ëù
;

19 
pub
 
mod
 
	gcodec
;

21 
u£
 
	g¡d
::
»suÉ
;

22 
u£
 
	g¡d
::
”rÜ
;

24 
u£
 
	gkv´Ùo
::
kv½ıb
::
LockInfo
;

25 
u£
 
	gkv´Ùo
::
”rÜpb
;

27 
u£
 
	g¡Üage
::{
’gše
, 
	gmvcc
, 
	gtxn
};

28 
u£
 
	gut
::
time
::
In¡ªt
;

30 
	gquick_”rÜ
! {

31 #[
d”ive
(
Debug
)]

32 
pub
 
	eE¼Ü
 {

33 
RegiÚ
(
”r
: 
”rÜpb
::
E¼Ü
) {

34 
desütiÚ
("region„elated failure")

35 
di¥Ïy
("»giÚ {:?}", 
”r
)

37 
Locked
(
l
: 
LockInfo
) {

38 
desütiÚ
("key is†ocked")

39 
di¥Ïy
("locked {:?}", 
l
)

41 
Outd©ed
(
d—dlše
: 
In¡ªt
, 
now
: In¡ªt, 
g
: &'static str) {

42 
desütiÚ
("request is outdated")

44 
FuÎ
(
®low
: 
usize
) {

45 
desütiÚ
("running queue is full")

47 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
S’d
 + 
Sync
>) {

48 
äom
()

49 
ÿu£
(
”r
.
as_»f
())

50 
desütiÚ
(
”r
.description())

51 
di¥Ïy
("unknowÀ”rÜ {:?}", 
”r
)

56 
pub
 
ty³
 
ResuÉ
<
T
> = 
»suÉ
::ResuÉ<T, 
E¼Ü
>;

58 
im¶
 
From
<
’gše
::
E¼Ü
> Error {

59 
â
 
äom
(
e
: 
’gše
::
E¼Ü
) -> Error {

60 
m©ch
 
e
 {

61 
’gše
::
E¼Ü
::
Reque¡
(
e
è=> E¼Ü::
RegiÚ
(e),

62 
_
 => 
E¼Ü
::
Oth”
(
box
 
e
),

67 
im¶
 
From
<
txn
::
E¼Ü
> Error {

68 
â
 
äom
(
e
: 
txn
::
E¼Ü
) -> Error {

69 
m©ch
 
e
 {

70 
txn
::
E¼Ü
::
Mvcc
(
mvcc
::E¼Ü::
KeyIsLocked
 {

71 
´im¬y
,

72 
ts
,

73 
key
,

74 
‰l
,

76 
Ët
 
mut
 
šfo
 = 
LockInfo
::
Ãw
();

77 
šfo
.
£t_´im¬y_lock
(
´im¬y
);

78 
šfo
.
£t_lock_v”siÚ
(
ts
);

79 
šfo
.
£t_key
(
key
);

80 
šfo
.
£t_lock_‰l
(
‰l
);

81 
E¼Ü
::
Locked
(
šfo
)

83 
_
 => 
E¼Ü
::
Oth”
(
box
 
e
),

88 
pub
 
u£
 
£lf
::
’dpošt
::{
CİReque¡Sti¡ics
, 
CİS’d”
, 
Ho¡
 
as
 
EndPoštHo¡
, 
Reque¡Task
,

89 
Task
 
as
 
EndPoštTask
, 
REQ_TYPE_DAG
, 
REQ_TYPE_INDEX
, 
REQ_TYPE_SELECT
,

90 
SINGLE_GROUP
};

	@src/coprocessor/select/aggregate.rs

14 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

15 
u£
 
	gtb
::
ex´essiÚ
::
Ex´Ty³
;

17 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

18 
u£
 
	gcİroûssÜ
::
ResuÉ
;

20 
u£
 
	gsu³r
::
xev®
::{
ev®u©Ü
, 
	gEv®CÚ‹xt
};

22 
pub
 
â
 
bud_aggr_func
(

: 
Ex´Ty³
è-> 
ResuÉ
<
Box
<
AggrFunc
>> {

23 
m©ch
 

 {

24 
Ex´Ty³
::
CouÁ
 => 
Ok
(
box
 CouÁ { 
c
: 0 }),

25 
	gEx´Ty³
::
Fœ¡
 => 
Ok
(
box
 Fœ¡ { 
e
: 
NÚe
 }),

26 
	gEx´Ty³
::
Sum
 => 
Ok
(
box
 Sum { 
»s
: 
NÚe
 }),

27 
	gEx´Ty³
::
Avg
 => 
Ok
(
box
 Avg {

28 
sum
: 
Sum
 { 
»s
: 
NÚe
 },

29 
út
: 0,

31 
	gEx´Ty³
::
Max
 => 
Ok
(
box
 
ExŒemum
::
Ãw
(
Ord”šg
::
Less
)),

32 
	gEx´Ty³
::
Mš
 => 
Ok
(
box
 
ExŒemum
::
Ãw
(
Ord”šg
::
G»©”
)),

33 
	g‘
 => 
E¼
(
box_”r
!("unsuµÜˆAggrEx´Ty³: {:?}", 
‘
)),

38 
pub
 
Œa™
 
	gAggrFunc
 {

40 
â
 
upd©e
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
¬gs
: 
Vec
<
D©um
>è-> 
ResuÉ
<()>;

42 
â
 
ÿlc
(&
mut
 
£lf
, 
cŞËùÜ
: &muˆ
Vec
<
D©um
>è-> 
ResuÉ
<()>;

45 
	sCouÁ
 {

46 
	mc
: 
u64
,

49 
im¶
 
AggrFunc
 
	gCouÁ
 {

50 
â
 
upd©e
(&
mut
 
£lf
, 
_
: &
Ev®CÚ‹xt
, 
¬gs
: 
Vec
<
D©um
>è-> 
ResuÉ
<()> {

51 
¬g
 
š
 
¬gs
 {

52 
¬g
 =ğ
D©um
::
NuÎ
 {

53  
Ok
(());

56 
	g£lf
.
	gc
 += 1;

57 
Ok
(())

60 
â
 
ÿlc
(&
mut
 
£lf
, 
cŞËùÜ
: &muˆ
Vec
<
D©um
>è-> 
ResuÉ
<()> {

61 
cŞËùÜ
.
push
(
D©um
::
U64
(
£lf
.
c
));

62 
Ok
(())

66 
	sFœ¡
 {

67 
	me
: 
O±iÚ
<
D©um
>,

70 
im¶
 
AggrFunc
 
	gFœ¡
 {

71 
â
 
upd©e
(&
mut
 
£lf
, 
_
: &
Ev®CÚ‹xt
, muˆ
¬gs
: 
Vec
<
D©um
>è-> 
ResuÉ
<()> {

72 
£lf
.
e
.
is_some
() {

73  
Ok
(());

75 
	g¬gs
.
Ën
() != 1 {

76  
E¼
(
box_”r
!(

78 
¬gs
.
Ën
()

81 
	g£lf
.
	ge
 = 
¬gs
.
pİ
();

82 
Ok
(())

85 
â
 
ÿlc
(&
mut
 
£lf
, 
cŞËùÜ
: &muˆ
Vec
<
D©um
>è-> 
ResuÉ
<()> {

86 
cŞËùÜ
.
push
(
£lf
.
e
.
ke
().
unw¿p_Ü
(
D©um
::
NuÎ
));

87 
Ok
(())

91 
	sSum
 {

92 
	m»s
: 
O±iÚ
<
D©um
>,

95 
im¶
 
	gSum
 {

99 
â
 
add_asssign
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, muˆ
¬gs
: 
Vec
<
D©um
>è-> 
ResuÉ
<
boŞ
> {

100 
¬gs
.
Ën
() != 1 {

101  
E¼
(
box_”r
!(

103 
¬gs
.
Ën
()

106 
Ët
 
	ga
 = 
¬gs
.
pİ
().
unw¿p
();

107 
	ga
 =ğ
D©um
::
NuÎ
 {

108  
Ok
(
çl£
);

110 
Ët
 
	g»s
 = 
m©ch
 
£lf
.
»s
.
ke
() {

111 
Some
(
b
è=> 
box_Œy
!(
ev®u©Ü
::
ev®_¬™h
(
ùx
, 
a
, b, 
D©um
::
checked_add
)),

112 
	gNÚe
 => 
a
,

114 
	g£lf
.
	g»s
 = 
Some
(
»s
);

115 
Ok
(
Œue
)

119 
im¶
 
AggrFunc
 
	gSum
 {

120 
â
 
upd©e
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
¬gs
: 
Vec
<
D©um
>è-> 
ResuÉ
<()> {

121 
£lf
.
add_asssign
(
ùx
, 
¬gs
)?;

122 
Ok
(())

125 
â
 
ÿlc
(&
mut
 
£lf
, 
cŞËùÜ
: &muˆ
Vec
<
D©um
>è-> 
ResuÉ
<()> {

126 
Ët
 
»s
 = 
£lf
.»s.
ke
().
unw¿p_Ü
(
D©um
::
NuÎ
);

127 
	g»s
 =ğ
D©um
::
NuÎ
 {

128 
cŞËùÜ
.
push
(
»s
);

129  
Ok
(());

131 
Ët
 
	gd
 = 
box_Œy
!(
»s
.
što_dec
());

132 
	gcŞËùÜ
.
push
(
D©um
::
Dec
(
d
));

133 
Ok
(())

137 
	sAvg
 {

138 
	msum
: 
Sum
,

139 
	mút
: 
u64
,

142 
im¶
 
AggrFunc
 
	gAvg
 {

143 
â
 
upd©e
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
¬gs
: 
Vec
<
D©um
>è-> 
ResuÉ
<()> {

144 
£lf
.
sum
.
add_asssign
(
ùx
, 
¬gs
)? {

145 
	g£lf
.
	gút
 += 1;

147 
Ok
(())

150 
â
 
ÿlc
(&
mut
 
£lf
, 
cŞËùÜ
: &muˆ
Vec
<
D©um
>è-> 
ResuÉ
<()> {

151 
cŞËùÜ
.
push
(
D©um
::
U64
(
£lf
.
út
));

152 
	g£lf
.
	gsum
.
ÿlc
(
cŞËùÜ
)

156 
	sExŒemum
 {

157 
	md©um
: 
O±iÚ
<
D©um
>,

158 
	mÜd
: 
Ord”šg
,

161 
im¶
 
	gExŒemum
 {

162 
â
 
Ãw
(
Üd
: 
Ord”šg
è-> 
ExŒemum
 {

163 
ExŒemum
 {

164 
d©um
: 
NÚe
,

165 
	gÜd
: 
Üd
,

170 
im¶
 
AggrFunc
 
	gExŒemum
 {

171 
â
 
upd©e
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, muˆ
¬gs
: 
Vec
<
D©um
>è-> 
ResuÉ
<()> {

172 
¬gs
.
Ën
() != 1 {

173  
E¼
(
box_”r
!(

175 
¬gs
.
Ën
()

178 
	g¬gs
[0] =ğ
D©um
::
NuÎ
 {

179  
Ok
(());

181 
Ët
 
Some
(
»f
 
d
èğ
£lf
.
d©um
 {

182 
box_Œy
!(
d
.
cmp
(
ùx
, &
¬gs
[0])è!ğ
£lf
.
Üd
 {

183  
Ok
(());

186 
	g£lf
.
	gd©um
 = 
¬gs
.
pİ
();

187 
Ok
(())

190 
â
 
ÿlc
(&
mut
 
£lf
, 
cŞËùÜ
: &muˆ
Vec
<
D©um
>è-> 
ResuÉ
<()> {

191 
cŞËùÜ
.
push
(
£lf
.
d©um
.
ke
().
unw¿p_Ü
(
D©um
::
NuÎ
));

192 
Ok
(())

	@src/coprocessor/select/mod.rs

14 
pub
 
mod
 
	gagg»g©e
;

15 
pub
 
mod
 
	gxev®
;

16 
pub
 
mod
 
	g£Ëù
;

17 
pub
 
mod
 
	gtİn_h—p
;

	@src/coprocessor/select/select.rs

14 
u£
 
	g¡d
::{
mem
, 
	gusize
};

15 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	gtb
::
£Ëù
::{
Chunk
, 
	gRowM‘a
, 
	gS–eùReque¡
, 
	gS–eùRe¥Ú£
};

17 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

18 
u£
 
	gtb
::
ex´essiÚ
::{
ByI‹m
, 
	gEx´
, 
	gEx´Ty³
};

19 
u£
 
	g´Ùobuf
::{
Mes§ge
 
as
 
PbMsg
, 
	gR•—‹dF›ld
};

20 
u£
 
	gby‹Üd”
::{
BigEndŸn
, 
	gR—dBy‹sExt
};

21 
u£
 
	gkv´Ùo
::
cİroûssÜ
::{
KeyRªge
, 
	gRe¥Ú£
};

23 
u£
 
	gcİroûssÜ
::
dag
::
executÜ
::{
SÿnOn
, 
	gSÿÂ”
};

24 
u£
 
	gcİroûssÜ
::
codec
::{
d©um
, 
	gmysql
, 
	gbË
};

25 
u£
 
	gcİroûssÜ
::
codec
::
bË
::{
RowCŞsDiù
, 
	gTabËDecod”
};

26 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::
D©um
;

27 
u£
 
	gcİroûssÜ
::
m‘rics
::*;

28 
u£
 
	gcİroûssÜ
::{
E¼Ü
, 
	gResuÉ
};

29 
u£
 
	gcİroûssÜ
::
’dpošt
::{
g‘_pk
, 
	gis_pošt
, 
	gto_pb_”rÜ
, 
	gReqCÚ‹xt
, 
	gSINGLE_GROUP
};

30 
u£
 
	gut
::
E™h”
;

31 
u£
 
	gut
::
cŞËùiÚs
::{
HashM­
, 
HashM­EÁry
 
as
 
	gEÁry
, 
	gHashS‘
};

32 
u£
 
	gut
::
codec
::
numb”
::
Numb”Decod”
;

33 
u£
 
	g¡Üage
::{
Key
, 
	gSÇpshÙ
, 
	gSÇpshÙStÜe
, 
	gSti¡ics
};

35 
u£
 
	gsu³r
::
xev®
::{
Ev®CÚ‹xt
, 
	gEv®u©Ü
};

36 
u£
 
	gsu³r
::
agg»g©e
::{
£lf
, 
	gAggrFunc
};

37 
u£
 
	gsu³r
::
tİn_h—p
::
TİNH—p
;

39 cÚ¡ 
	gREQUEST_CHECKPOINT
: 
usize
 = 255;

41 
pub
 
	sS–eùCÚ‹xt
 {

42 
	m¢­
: 
SÇpshÙStÜe
,

43 
	m¡©i¡ics
: 
Sti¡ics
,

44 
	mcÜe
: 
S–eùCÚ‹xtCÜe
,

45 
	m»q_ùx
: 
Arc
<
ReqCÚ‹xt
>,

46 
	msÿÂ”
: 
O±iÚ
<
SÿÂ”
>,

49 
im¶
 
	gS–eùCÚ‹xt
 {

50 
pub
 
â
 
Ãw
(

51 
£l
: 
S–eùReque¡
,

52 
¢­
: 
Box
<
SÇpshÙ
>,

53 
»q_ùx
: 
Arc
<
ReqCÚ‹xt
>,

54 
b©ch_row_lim™
: 
usize
,

55 è-> 
	gResuÉ
<
	gS–eùCÚ‹xt
> {

56 
Ët
 
	g¢­
 = 
SÇpshÙStÜe
::
Ãw
(

57 
¢­
,

58 
£l
.
g‘_¡¬t_ts
(),

59 
»q_ùx
.
isŞ©iÚ_Ëv–
,

60 
»q_ùx
.
fl_ÿche
,

62 
Ok
(
S–eùCÚ‹xt
 {

63 
cÜe
: 
S–eùCÚ‹xtCÜe
::
Ãw
(
£l
, 
b©ch_row_lim™
)?,

64 
¢­
: snap,

65 
¡©i¡ics
: 
Sti¡ics
::(),

66 
»q_ùx
:„eq_ctx,

67 
sÿÂ”
: 
NÚe
,

71 
pub
 
â
 
hªdË_»que¡
(&
mut
 
£lf
, muˆ
¿nges
: 
Vec
<
KeyRªge
>è-> 
ResuÉ
<
Re¥Ú£
> {

72 
£lf
.
cÜe
.
desc_sÿn
 {

73 
¿nges
.
»v”£
();

76 
Ët
 
	g»s
 = 
£lf
.
»q_ùx
.
bË_sÿn
 {

77 
£lf
.
g‘_rows_äom_£l
(
¿nges
)

79 
£lf
.
g‘_rows_äom_idx
(
¿nges
)

82 
Ët
 
mut
 
	g»¥
 = 
Re¥Ú£
::
Ãw
();

83 
Ët
 
mut
 
	g£l_»¥
 = 
S–eùRe¥Ú£
::
Ãw
();

84 
m©ch
 
	g»s
 {

85 
Ok
(()) => {

86 
Ët
 
chunks
 = 
mem
::
»¶aû
(&
mut
 
£lf
.
cÜe
.chunks, 
Vec
::
Ãw
());

87 
	g£l_»¥
.
£t_chunks
(
R•—‹dF›ld
::
äom_vec
(
chunks
));

88 
Ët
 
	gd©a
 = 
box_Œy
!(
£l_»¥
.
wr™e_to_by‹s
());

89 
	g»¥
.
£t_d©a
(
d©a
);

91 
E¼
(
e
è=> 
Ët
 
E¼Ü
::
Oth”
(
_
) =ƒ {

92 
£l_»¥
.
£t_”rÜ
(
to_pb_”rÜ
(&
e
));

93 
	g»¥
.
£t_d©a
(
box_Œy
!(
£l_»¥
.
wr™e_to_by‹s
()));

94 
	g»¥
.
£t_Ùh”_”rÜ
(
fÜm©
!("{}", 
e
));

95 
	gCOPR_REQ_ERROR
.
w™h_Ïb–_v®ues
(&["Ùh”"]).
šc
();

97  
E¼
(
e
);

100 
Ok
(
»¥
)

103 
â
 
»£t_sÿn_¿nge
(&
mut
 
£lf
, 
¿nge
: 
KeyRªge
è-> 
ResuÉ
<()> {

104 
£lf
.
sÿÂ”
.
is_nÚe
() {

105 
Ët
 
sÿn_Ú
 = 
£lf
.
»q_ùx
.
bË_sÿn
 {

106 
SÿnOn
::
TabË


108 
SÿnOn
::
Index


110 
Ët
 
	gdesc
 = 
£lf
.
cÜe
.
desc_sÿn
;

111 
Ët
 
	gkey_Úly
 = 
£lf
.
key_Úly
();

112 
Ët
 
	gs
 = 
SÿÂ”
::
Ãw
(&
£lf
.
¢­
, 
sÿn_Ú
, 
desc
, 
key_Úly
, 
¿nge
)?;

113 
	g£lf
.
	gsÿÂ”
 = 
Some
(
s
);

114  
Ok
(());

116 
Ët
 
	gs
 = 
£lf
.
sÿÂ”
.
as_mut
().
unw¿p
();

117 
	gs
.
»£t_¿nge
(
¿nge
, &
£lf
.
¢­
)?;

118 
Ok
(())

121 
â
 
g‘_rows_äom_£l
(&
mut
 
£lf
, 
¿nges
: 
Vec
<
KeyRªge
>è-> 
ResuÉ
<()> {

122 
Ët
 
mut
 
cŞËùed
 = 0;

123 
¿n
 
š
 
	g¿nges
 {

124 
	gcŞËùed
 >ğ
£lf
.
cÜe
.
lim™
 {

127 
	gcŞËùed
 +ğ
£lf
.
g‘_rows_äom_¿nge
(
¿n
)?;

128 
	g£lf
.
	g»q_ùx
.
check_if_outd©ed
()?;

130 
	g£lf
.
	gcÜe
.
	gtİn
 {

131 
	g£lf
.
	gcÜe
.
cŞËù_tİn_rows
()

132 } 
	g£lf
.
	gcÜe
.
	gaggr
 {

133 
	g£lf
.
	gcÜe
.
aggr_rows
()

135 
Ok
(())

139 
â
 
key_Úly
(&
£lf
è-> 
	gboŞ
 {

140 
m©ch
 
	g£lf
.
	gcÜe
.
	gcŞs
 {

141 
	gE™h”
::
Leá
(
»f
 
cŞs
è=> cŞs.
is_em±y
(),

142 
	gE™h”
::
Right
(
_
è=> 
çl£
,

146 
â
 
g‘_rows_äom_¿nge
(&
mut
 
£lf
, 
¿nge
: 
KeyRªge
è-> 
ResuÉ
<
usize
> {

147 
Ët
 
mut
 
row_couÁ
 = 0;

148 
is_pošt
(&
¿nge
) {

149 
	gCOPR_GET_OR_SCAN_COUNT
.
w™h_Ïb–_v®ues
(&["pošt"]).
šc
();

150 
Ët
 
	gv®ue
 = 
m©ch
 
£lf
.
¢­


151 .
g‘
(&
Key
::
äom_¿w
(
¿nge
.
g‘_¡¬t
()), &
mut
 
£lf
.
¡©i¡ics
)?

153 
	gNÚe
 =>  
Ok
(0),

154 
Some
(
v
) => v,

156 
Ët
 
	gv®ues
 = {

157 
Ët
 
ids
 = 
£lf
.
cÜe
.
cŞs
.
as_»f
().
Ëá
().
unw¿p
();

158 
	gbox_Œy
!(
	gbË
::
cut_row
(
v®ue
, 
ids
))

160 
Ët
 
	gh
 = 
box_Œy
!(
bË
::
decode_hªdË
(
¿nge
.
g‘_¡¬t
()));

161 
	grow_couÁ
 +ğ
£lf
.
cÜe
.
hªdË_row
(
h
, 
v®ues
)?;

163 
	g£lf
.
»£t_sÿn_¿nge
(
¿nge
)?;

164 
Ët
 
	gsÿÂ”
 = 
£lf
.
sÿÂ”
.
as_mut
().
unw¿p
();

165 
	g£lf
.
	gcÜe
.
	glim™
 > 
	grow_couÁ
 {

166 
	grow_couÁ
 & 
	gREQUEST_CHECKPOINT
 == 0 {

167 
£lf
.
»q_ùx
.
check_if_outd©ed
()?;

169 
	gCOPR_GET_OR_SCAN_COUNT
.
w™h_Ïb–_v®ues
(&["¿nge"]).
šc
();

170 
Ët
 
Some
((
key
, 
v®ue
)èğ
sÿÂ”
.
Ãxt_row
()? {

171 
Ët
 
h
 = 
box_Œy
!(
bË
::
decode_hªdË
(&
key
));

172 
Ët
 
	grow_d©a
 = {

173 
Ët
 
ids
 = 
£lf
.
cÜe
.
cŞs
.
as_»f
().
Ëá
().
unw¿p
();

174 
	gbox_Œy
!(
	gbË
::
cut_row
(
v®ue
, 
ids
))

176 
	grow_couÁ
 +ğ
£lf
.
cÜe
.
hªdË_row
(
h
, 
row_d©a
)?;

182 
Ok
(
row_couÁ
)

185 
â
 
g‘_rows_äom_idx
(&
mut
 
£lf
, 
¿nges
: 
Vec
<
KeyRªge
>è-> 
ResuÉ
<()> {

186 
Ët
 
mut
 
cŞËùed
 = 0;

187 
r
 
š
 
	g¿nges
 {

188 
	gcŞËùed
 >ğ
£lf
.
cÜe
.
lim™
 {

191 
	gcŞËùed
 +ğ
£lf
.
g‘_idx_row_äom_¿nge
(
r
)?;

192 
	g£lf
.
	g»q_ùx
.
check_if_outd©ed
()?;

194 
	g£lf
.
	gcÜe
.
	gtİn
 {

195 
	g£lf
.
	gcÜe
.
cŞËù_tİn_rows
()

196 } 
	g£lf
.
	gcÜe
.
	gaggr
 {

197 
	g£lf
.
	gcÜe
.
aggr_rows
()

199 
Ok
(())

203 
â
 
g‘_idx_row_äom_¿nge
(&
mut
 
£lf
, 
r
: 
KeyRªge
è-> 
ResuÉ
<
usize
> {

204 
Ët
 
mut
 
row_út
 = 0;

205 
	g£lf
.
»£t_sÿn_¿nge
(
r
)?;

206 
Ët
 
	gsÿÂ”
 = 
£lf
.
sÿÂ”
.
as_mut
().
unw¿p
();

207 
	grow_út
 < 
	g£lf
.
	gcÜe
.
	glim™
 {

208 
	grow_út
 & 
	gREQUEST_CHECKPOINT
 == 0 {

209 
£lf
.
»q_ùx
.
check_if_outd©ed
()?;

211 
Ët
 
Some
((
key
, 
v®
)èğ
sÿÂ”
.
Ãxt_row
()? {

212 
Ët
 (
mut
 
v®ues
, 
hªdË
) = {

213 
Ët
 
mut
 
ids
 = 
£lf
.
cÜe
.
cŞs
.
as_»f
().
right
().
unw¿p
().
şÚe
();

214 
	g£lf
.
	gcÜe
.
	gpk_cŞ
.
is_some
() {

215 
	gids
.
pİ
();

217 
	gbox_Œy
!(
	gbË
::
cut_idx_key
(
key
, &
ids
))

219 
Ët
 
	ghªdË
 = 
hªdË
.
is_nÚe
() {

220 
box_Œy
!(
v®
.
as_¦iû
().
»ad_i64
::<
BigEndŸn
>())

222 
hªdË
.
unw¿p
()

224 
Ët
 
Some
(
»f
 
pk_cŞ
èğ
£lf
.
cÜe
.pk_col {

225 
Ët
 
hªdË_d©um
 = 
mysql
::
has_unsigÃd_æag
(
pk_cŞ
.
g‘_æag
(è
as
 
u64
) {

227 
d©um
::
D©um
::
U64
(
hªdË
 
as
 
u64
)

229 
d©um
::
D©um
::
I64
(
hªdË
)

231 
Ët
 
mut
 
	gby‹s
 = 
box_Œy
!(
d©um
::
’code_key
(&[
hªdË_d©um
]));

232 
	gv®ues
.
­³nd
(
pk_cŞ
.
g‘_cŞumn_id
(), &
mut
 
by‹s
);

234 
	grow_út
 +ğ
£lf
.
cÜe
.
hªdË_row
(
hªdË
, 
v®ues
)?;

239 
Ok
(
row_út
)

242 
pub
 
â
 
cŞËù_¡©i¡ics_što
(
£lf
, 
¡©s
: &
mut
 
Sti¡ics
) {

243 
¡©s
.
add
(&
£lf
.
¡©i¡ics
);

244 
Ët
 
Some
(
sÿÂ”
èğ
£lf
.scanner {

245 
sÿÂ”
.
cŞËù_¡©i¡ics_što
(
¡©s
);

251 
	sS–eùCÚ‹xtCÜe
 {

252 
	mùx
: 
Arc
<
Ev®CÚ‹xt
>,

253 
	m£l
: 
S–eùReque¡
,

254 
	mev®
: 
Ev®u©Ü
,

255 
	mcŞs
: 
E™h”
<
HashS‘
<
i64
>, 
	mVec
<
	mi64
>>,

256 
	mpk_cŞ
: 
O±iÚ
<
CŞumnInfo
>,

257 
	mcÚd_cŞs
: 
Vec
<
CŞumnInfo
>,

258 
	mtİn_cŞs
: 
Vec
<
CŞumnInfo
>,

259 
	maggr
: 
boŞ
,

260 
	maggr_cŞs
: 
Vec
<
CŞumnInfo
>,

261 
	mtİn
: 
boŞ
,

262 
	mtİn_h—p
: 
O±iÚ
<
TİNH—p
>,

263 
	mÜd”_cŞs
: 
Arc
<
Vec
<
ByI‹m
>>,

264 
	mlim™
: 
usize
,

265 
	mdesc_sÿn
: 
boŞ
,

266 
	mgks
: 
Vec
<
Arc
<Vec<
u8
>>>,

267 
	mgk_aggrs
: 
HashM­
<
Arc
<
Vec
<
u8
>>, 
	mVec
<
	mBox
<
	mAggrFunc
>>>,

268 
	mchunks
: 
Vec
<
Chunk
>,

269 
	mb©ch_row_lim™
: 
usize
,

272 
im¶
 
	gS–eùCÚ‹xtCÜe
 {

273 
â
 
Ãw
(
£l
: 
S–eùReque¡
, 
b©ch_row_lim™
: 
usize
è-> 
ResuÉ
<
S–eùCÚ‹xtCÜe
> {

274 
Ët
 
cÚd_cŞs
;

275 
Ët
 
	gtİn_cŞs
;

276 
Ët
 
mut
 
	gÜd”_by_cŞs
: 
Vec
<
ByI‹m
> = Vec::
Ãw
();

277 
Ët
 
mut
 
	gaggr_cŞs
 = 
vec
![];

279 
Ët
 
	g£Ëù_cŞs
 = 
£l
.
has_bË_šfo
() {

280 
COPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["tblsÿn"]).
šc
();

281 
	g£l
.
g‘_bË_šfo
().
g‘_cŞumns
()

283 
	gCOPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["idxsÿn"]).
šc
();

284 
	g£l
.
g‘_šdex_šfo
().
g‘_cŞumns
()

286 
Ët
 
mut
 
	gcÚd_cŞ_m­
 = 
HashM­
::();

287 
	g£l
.
has_f›ld_wh”e
() {

288 
	gCOPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["£ËùiÚ"]).
šc
();

289 
cŞËù_cŞ_š_ex´
(&
mut
 
cÚd_cŞ_m­
, 
£Ëù_cŞs
, 
£l
.
g‘_f›ld_wh”e
())?;

291 
Ët
 
mut
 
	gaggr_cŞs_m­
 = 
HashM­
::();

292 
aggr
 
š
 
	g£l
.
g‘_agg»g©es
() {

293 
cŞËù_cŞ_š_ex´
(&
mut
 
aggr_cŞs_m­
, 
£Ëù_cŞs
, 
aggr
)?;

295 
™em
 
š
 
	g£l
.
g‘_group_by
() {

296 
cŞËù_cŞ_š_ex´
(&
mut
 
aggr_cŞs_m­
, 
£Ëù_cŞs
, 
™em
.
g‘_ex´
())?;

298 !
	gaggr_cŞs_m­
.
is_em±y
() {

299 
cÚd_cŞ
 
š
 
	gcÚd_cŞ_m­
.
keys
() {

300 
	gaggr_cŞs_m­
.
»move
(
cÚd_cŞ
);

302 
	gaggr_cŞs
 = 
aggr_cŞs_m­
.
što_™”
().
m­
(|(
_
, 
v
)| v).
cŞËù
();

304 
	gcÚd_cŞs
 = 
cÚd_cŞ_m­
.
što_™”
().
m­
(|(
_
, 
v
)| v).
cŞËù
();

307 
Ët
 
mut
 
	gtİn_cŞ_m­
 = 
HashM­
::();

308 
™em
 
š
 
	g£l
.
g‘_Üd”_by
() {

309 
cŞËù_cŞ_š_ex´
(&
mut
 
tİn_cŞ_m­
, 
£Ëù_cŞs
, 
™em
.
g‘_ex´
())?

311 
	gtİn_cŞs
 = 
tİn_cŞ_m­
.
što_™”
().
m­
(|(
_
, 
v
)| v).
cŞËù
();

312 
	gÜd”_by_cŞs
.
ex‹nd_äom_¦iû
(
£l
.
g‘_Üd”_by
())

315 
Ët
 
	glim™
 = 
£l
.
has_lim™
() {

316 
COPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["lim™"]).
šc
();

317 
	g£l
.
g‘_lim™
(è
as
 
	gusize


319 
	gusize
::
MAX


323 
Ët
 
mut
 
	gtİn
 = 
çl£
;

324 
Ët
 
mut
 
	gdesc_ÿn
 = 
çl£
;

325 !
	g£l
.
g‘_Üd”_by
().
is_em±y
() {

327 !
	g£l
.
g‘_Üd”_by
()[0].
has_ex´
() {

328 
	gdesc_ÿn
 = 
£l
.
g‘_Üd”_by
().
fœ¡
().
m­_Ü
(
çl£
, |
o
| o.
g‘_desc
());

330 
	gCOPR_EXECUTOR_COUNT
.
w™h_Ïb–_v®ues
(&["tİn"]).
šc
();

331 
	gtİn
 = 
Œue
;

335 
Ët
 
mut
 
	gpk_cŞ
 = 
NÚe
;

336 
Ët
 
	gcŞs
 = 
£l
.
has_bË_šfo
() {

337 
E™h”
::
Leá
(

338 
£l
.
g‘_bË_šfo
()

339 .
g‘_cŞumns
()

340 .
™”
()

341 .
f‹r
(|
c
| !c.
g‘_pk_hªdË
())

342 .
m­
(|
c
| c.
g‘_cŞumn_id
())

343 .
cŞËù
(),

346 
Ët
 
cŞs
 = 
£l
.
g‘_šdex_šfo
().
g‘_cŞumns
();

347 
	gcŞs
.
Ï¡
().
m­_Ü
(
çl£
, |
c
| c.
g‘_pk_hªdË
()) {

348 
	gpk_cŞ
 = 
Some
(
cŞs
.
Ï¡
().
unw¿p
().
şÚe
());

350 
	gE™h”
::
Right
(
cŞs
.
™”
().
m­
(|
c
| c.
g‘_cŞumn_id
()).
cŞËù
())

353 
Ët
 
	gaggr
 = !
£l
.
g‘_agg»g©es
().
is_em±y
(è|| !£l.
g‘_group_by
().is_empty() {

354 
COPR_EXECUTOR_COUNT


355 .
w™h_Ïb–_v®ues
(&["aggregation"])

356 .
šc
();

357 
	gŒue


359 
	gçl£


362 
Ok
(
S–eùCÚ‹xtCÜe
 {

363 
ùx
: 
Arc
::
Ãw
(
box_Œy
!(
Ev®CÚ‹xt
::new(

364 
£l
.
g‘_time_zÚe_off£t
(),

365 
£l
.
g‘_æags
()

367 
aggr
:‡ggr,

368 
aggr_cŞs
:‡ggr_cols,

369 
tİn_cŞs
:opn_cols,

370 
£l
: sel,

371 
ev®
: 
DeçuÉ
::(),

372 
cŞs
: cols,

373 
pk_cŞ
:…k_col,

374 
cÚd_cŞs
: cond_cols,

375 
gks
: 
vec
![],

376 
gk_aggrs
: 
m­
![],

377 
chunks
: 
vec
![],

378 
tİn
:opn,

379 
tİn_h—p
: {

380 
tİn
 {

381 
Some
(
TİNH—p
::
Ãw
(
lim™
)?)

383 
NÚe


386 
Üd”_cŞs
: 
Arc
::
Ãw
(
Üd”_by_cŞs
),

387 
lim™
:†imit,

388 
desc_sÿn
: 
desc_ÿn
,

389 
b©ch_row_lim™
: batch_row_limit,

393 
â
 
hªdË_row
(&
mut
 
£lf
, 
h
: 
i64
, 
row_d©a
: 
RowCŞsDiù
è-> 
ResuÉ
<
usize
> {

395 
£lf
.
ev®
.
row
.
ş—r
();

396 
	g£lf
.
should_sk
(
h
, &
row_d©a
)? {

397  
Ok
(0);

401 
	g£lf
.
	gtİn
 {

402 
	g£lf
.
cŞËù_tİn_row
(
h
, 
row_d©a
)?;

403 
Ok
(0)

404 } 
	g£lf
.
	gaggr
 {

405 
	g£lf
.
agg»g©e
(
h
, &
row_d©a
)?;

406 
Ok
(0)

408 
	g£lf
.
g‘_row
(
h
, 
row_d©a
)?;

409 
Ok
(1)

413 
â
 
should_sk
(&
mut
 
£lf
, 
h
: 
i64
, 
v®ues
: &
RowCŞsDiù
è-> 
ResuÉ
<
boŞ
> {

414 !
£lf
.
£l
.
has_f›ld_wh”e
() {

415  
Ok
(
çl£
);

417 
šæ©e_w™h_cŞ
(&
mut
 
£lf
.
ev®
, &£lf.
ùx
, 
v®ues
, &£lf.
cÚd_cŞs
, 
h
)?;

418 
Ët
 
	g»s
 = 
box_Œy
!(
£lf
.
ev®
.ev®(&£lf.
ùx
, s–f.
£l
.
g‘_f›ld_wh”e
()));

419 
Ët
 
	gb
 = 
box_Œy
!(
»s
.
što_boŞ
(&
£lf
.
ùx
));

420 
Ok
(
b
.
m­_Ü
(
Œue
, |
v
| !v))

423 
â
 
cŞËù_tİn_row
(&
mut
 
£lf
, 
h
: 
i64
, 
v®ues
: 
RowCŞsDiù
è-> 
ResuÉ
<()> {

424 
šæ©e_w™h_cŞ
(&
mut
 
£lf
.
ev®
, &£lf.
ùx
, &
v®ues
, &£lf.
tİn_cŞs
, 
h
)?;

425 
Ët
 
mut
 
	gsÜt_keys
 = 
Vec
::
w™h_ÿ·c™y
(
£lf
.
£l
.
g‘_Üd”_by
().
Ën
());

427 
cŞ
 
š
 
	g£lf
.
	g£l
.
g‘_Üd”_by
() {

428 
Ët
 
	gv
 = 
box_Œy
!(
£lf
.
ev®
.ev®(&£lf.
ùx
, 
cŞ
.
g‘_ex´
()));

429 
	gsÜt_keys
.
push
(
v
);

432 
	g£lf
.
	gtİn_h—p
.
as_mut
().
unw¿p
().
Œy_add_row
(

433 
h
,

434 
v®ues
,

435 
sÜt_keys
,

436 
£lf
.
Üd”_cŞs
.
şÚe
(),

437 
£lf
.
ùx
.
şÚe
(),

441 
â
 
g‘_row
(&
mut
 
£lf
, 
h
: 
i64
, 
v®ues
: 
RowCŞsDiù
è-> 
ResuÉ
<()> {

442 
Ët
 
chunk
 = 
g‘_chunk
(&
mut
 
£lf
.
chunks
, s–f.
b©ch_row_lim™
);

443 
Ët
 
	gÏ¡_Ën
 = 
chunk
.
g‘_rows_d©a
().
Ën
();

444 
Ët
 
	gcŞs
 = 
£lf
.
£l
.
has_bË_šfo
() {

445 
£lf
.
£l
.
g‘_bË_šfo
().
g‘_cŞumns
()

447 
£lf
.
£l
.
g‘_šdex_šfo
().
g‘_cŞumns
()

449 
cŞ
 
š
 
	gcŞs
 {

450 
Ët
 
	gcŞ_id
 = 
cŞ
.
g‘_cŞumn_id
();

451 
Ët
 
Some
(
v
èğ
v®ues
.
g‘
(
cŞ_id
) {

452 
chunk
.
mut_rows_d©a
().
ex‹nd_äom_¦iû
(
v
);

455 
	gcŞ
.
g‘_pk_hªdË
() {

456 
	gbox_Œy
!(
	gd©um
::
’code_to
(

457 
chunk
.
mut_rows_d©a
(),

458 &[
g‘_pk
(
cŞ
, 
h
)],

459 
çl£


461 } 
	gcŞ
.
has_deçuÉ_v®
() {

462 
	gchunk


463 .
mut_rows_d©a
()

464 .
ex‹nd_äom_¦iû
(
cŞ
.
g‘_deçuÉ_v®
());

465 } 
	gmysql
::
has_nÙ_nuÎ_æag
(
cŞ
.
g‘_æag
(è
as
 
u64
) {

466  
E¼
(
box_”r
!("cŞumÀ{} oà{} i missšg", 
cŞ_id
, 
h
));

468 
	gbox_Œy
!(
	gd©um
::
’code_to
(

469 
chunk
.
mut_rows_d©a
(),

470 &[
D©um
::
NuÎ
],

471 
çl£


475 
Ët
 
mut
 
	gm‘a
 = 
RowM‘a
::
Ãw
();

476 
	gm‘a
.
£t_hªdË
(
h
);

477 
	gm‘a
.
£t_Ëngth
((
chunk
.
g‘_rows_d©a
().
Ën
(è- 
Ï¡_Ën
è
as
 
i64
);

478 
	gchunk
.
mut_rows_m‘a
().
push
(
m‘a
);

479 
Ok
(())

482 
â
 
g‘_group_key
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gVec
<
	gu8
>> {

483 
Ët
 
	g™ems
 = 
£lf
.
£l
.
g‘_group_by
();

484 
	g™ems
.
is_em±y
() {

485  
Ok
(
SINGLE_GROUP
.
to_vec
());

487 
Ët
 
mut
 
	gv®s
 = 
Vec
::
w™h_ÿ·c™y
(
™ems
.
Ën
());

488 
™em
 
š
 
	g™ems
 {

489 
Ët
 
	gv
 = 
box_Œy
!(
£lf
.
ev®
.ev®(&£lf.
ùx
, 
™em
.
g‘_ex´
()));

490 
	gv®s
.
push
(
v
);

492 
Ët
 
	g»s
 = 
box_Œy
!(
d©um
::
’code_v®ue
(&
v®s
));

493 
Ok
(
»s
)

496 
â
 
agg»g©e
(&
mut
 
£lf
, 
h
: 
i64
, 
v®ues
: &
RowCŞsDiù
è-> 
ResuÉ
<()> {

497 
šæ©e_w™h_cŞ
(&
mut
 
£lf
.
ev®
, &£lf.
ùx
, 
v®ues
, &£lf.
aggr_cŞs
, 
h
)?;

498 
Ët
 
	ggk
 = 
Arc
::
Ãw
(
£lf
.
g‘_group_key
()?);

499 
Ët
 
	gaggr_ex´s
 = 
£lf
.
£l
.
g‘_agg»g©es
();

500 
m©ch
 
	g£lf
.
	ggk_aggrs
.
’Œy
(
gk
.
şÚe
()) {

501 
	gEÁry
::
Occup›d
(
e
) => {

502 
Ët
 
funcs
 = 
e
.
što_mut
();

503 
	gex´
, 
	gfunc
è
š
 
	gaggr_ex´s
.
™”
().
z
(
funcs
) {

505 
Ët
 
	g¬gs
 = 
box_Œy
!(
£lf
.
ev®
.
b©ch_ev®
(&£lf.
ùx
, 
ex´
.
g‘_chd»n
()));

506 
	gfunc
.
upd©e
(&
£lf
.
ùx
, 
¬gs
)?;

509 
	gEÁry
::
VaÿÁ
(
e
) => {

510 
Ët
 
mut
 
aggrs
 = 
Vec
::
w™h_ÿ·c™y
(
aggr_ex´s
.
Ën
());

511 
ex´
 
š
 
	gaggr_ex´s
 {

512 
Ët
 
mut
 
	gaggr
 = 
agg»g©e
::
bud_aggr_func
(
ex´
.
g‘_
())?;

513 
Ët
 
	g¬gs
 = 
box_Œy
!(
£lf
.
ev®
.
b©ch_ev®
(&£lf.
ùx
, 
ex´
.
g‘_chd»n
()));

514 
	gaggr
.
upd©e
(&
£lf
.
ùx
, 
¬gs
)?;

515 
	gaggrs
.
push
(
aggr
);

517 
	g£lf
.
	ggks
.
push
(
gk
);

518 
	ge
.
š£¹
(
aggrs
);

521 
Ok
(())

524 
â
 
cŞËù_tİn_rows
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

525 
Ët
 
	gsÜ‹d_d©a
 = 
£lf
.
tİn_h—p
.
ke
().
unw¿p
().
što_sÜ‹d_vec
()?;

526 
row
 
š
 
	gsÜ‹d_d©a
 {

527 
	g£lf
.
g‘_row
(
row
.
hªdË
,„ow.
d©a
)?;

529 
Ok
(())

538 
â
 
aggr_rows
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

539 
	g£lf
.
	gchunks
 = 
Vec
::
w™h_ÿ·c™y
(

540 (
£lf
.
gk_aggrs
.
Ën
(è+ s–f.
b©ch_row_lim™
 - 1) / self.batch_row_limit,

543 
Ët
 
mut
 
	grow_d©a
 = 
Vec
::
w™h_ÿ·c™y
(1 + 2 * 
£lf
.
£l
.
g‘_agg»g©es
().
Ën
());

544 
gk
 
š
 
	g£lf
.
	ggks
.
d¿š
(..) {

545 
Ët
 
	gaggrs
 = 
£lf
.
gk_aggrs
.
»move
(&
gk
).
unw¿p
();

546 
Ët
 
	gchunk
 = 
g‘_chunk
(&
mut
 
£lf
.
chunks
, s–f.
b©ch_row_lim™
);

548 
	grow_d©a
.
push
(
D©um
::
By‹s
(
Arc
::
Œy_unw¿p
(
gk
).
unw¿p
()));

549 
mut
 
aggr
 
š
 
	gaggrs
 {

550 
	gaggr
.
ÿlc
(&
mut
 
row_d©a
)?;

552 
Ët
 
	gÏ¡_Ën
 = 
chunk
.
g‘_rows_d©a
().
Ën
();

553 
	gbox_Œy
!(
	gd©um
::
’code_to
(
chunk
.
mut_rows_d©a
(), &
row_d©a
, 
çl£
));

554 
Ët
 
mut
 
	gm‘a
 = 
RowM‘a
::
Ãw
();

555 
	gm‘a
.
£t_Ëngth
((
chunk
.
g‘_rows_d©a
().
Ën
(è- 
Ï¡_Ën
è
as
 
i64
);

556 
	gchunk
.
mut_rows_m‘a
().
push
(
m‘a
);

557 
	grow_d©a
.
ş—r
();

559 
Ok
(())

563 
â
 
cŞËù_cŞ_š_ex´
(

564 
cŞs
: &
mut
 
HashM­
<
i64
, 
CŞumnInfo
>,

565 
cŞ_m‘a
: &[
CŞumnInfo
],

566 
ex´
: &
Ex´
,

567 è-> 
	gResuÉ
<()> {

568 
	gex´
.
g‘_
(è=ğ
Ex´Ty³
::
CŞumnRef
 {

569 
Ët
 
i
 = 
box_Œy
!(
ex´
.
g‘_v®
().
decode_i64
());

570 
Ët
 
	gEÁry
::
VaÿÁ
(
e
èğ
cŞs
.
’Œy
(
i
) {

571 
c
 
š
 
cŞ_m‘a
 {

572 
c
.
g‘_cŞumn_id
(è=ğ
i
 {

573 
e
.
š£¹
(
c
.
şÚe
());

574  
Ok
(());

577  
E¼
(
box_”r
!("cŞumÀm‘¨oà{} i missšg", 
i
));

580 
c
 
š
 
	gex´
.
g‘_chd»n
() {

581 
cŞËù_cŞ_š_ex´
(
cŞs
, 
cŞ_m‘a
, 
c
)?;

583 
Ok
(())

586 #[
šlše
]

587 
â
 
	gšæ©e_w™h_cŞ
<'a, T>(

588 
	gev®
: &
mut
 
Ev®u©Ü
,

589 
	gùx
: &
Ev®CÚ‹xt
,

590 
	gv®ues
: &
RowCŞsDiù
,

591 
	gcŞs
: 
T
,

592 
	gh
: 
i64
,

593 è-> 
	gResuÉ
<()>

594 
wh”e


595 
	gT
: 
IÁoI‹¿tÜ
<
I‹m
 = &'a ColumnInfo>,

597 
cŞ
 
š
 
cŞs
 {

598 
Ët
 
cŞ_id
 = 
cŞ
.
g‘_cŞumn_id
();

599 
Ët
 
	gEÁry
::
VaÿÁ
(
e
èğ
ev®
.
row
.
’Œy
(
cŞ_id
) {

600 
cŞ
.
g‘_pk_hªdË
() {

601 
Ët
 
v
 = 
g‘_pk
(
cŞ
, 
h
);

602 
	ge
.
š£¹
(
v
);

604 
Ët
 
	gv®ue
 = 
m©ch
 
v®ues
.
g‘
(
cŞ_id
) {

605 
NÚe
 
cŞ
.
has_deçuÉ_v®
() => {

607 
box_Œy
!(
cŞ
.
g‘_deçuÉ_v®
().
decode_cŞ_v®ue
(
ùx
, col))

609 
NÚe
 
mysql
::
has_nÙ_nuÎ_æag
(
cŞ
.
g‘_æag
(è
as
 
u64
) => {

610  
E¼
(
box_”r
!("cŞumÀ{} oà{} i missšg", 
cŞ_id
, 
h
));

612 
	gNÚe
 => 
D©um
::
NuÎ
,

613 
Some
(
mut
 
bs
è=> 
box_Œy
!(bs.
decode_cŞ_v®ue
(
ùx
, 
cŞ
)),

615 
	ge
.
š£¹
(
v®ue
);

619 
Ok
(())

622 #[
šlše
]

623 
â
 
g‘_chunk
(
chunks
: &
mut
 
Vec
<
Chunk
>, 
b©ch_row_lim™
: 
usize
) -> &mut Chunk {

624 
chunks


625 .
Ï¡
()

626 .
m­_Ü
(
Œue
, |
chunk
| chunk.
g‘_rows_m‘a
().
Ën
(è>ğ
b©ch_row_lim™
)

628 
Ët
 
chunk
 = 
Chunk
::
Ãw
();

629 
	gchunks
.
push
(
chunk
);

631 
	gchunks
.
Ï¡_mut
().
unw¿p
()

	@src/coprocessor/select/topn_heap.rs

14 
u£
 
	g¡d
::
usize
;

15 
u£
 
	g¡d
::
cŞËùiÚs
::
Bš¬yH—p
;

16 
u£
 
	g¡d
::
sync
::
Arc
;

17 
u£
 
	g¡d
::
cmp
::{
£lf
, 
	gOrd”šg
};

18 
u£
 
	g¡d
::
ûÎ
::
RefC–l
;

19 
u£
 
	gtb
::
ex´essiÚ
::
ByI‹m
;

21 
u£
 
	gcİroûssÜ
::
codec
::
bË
::
RowCŞsDiù
;

22 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::
D©um
;

23 
u£
 
	gcİroûssÜ
::
ResuÉ
;

25 
u£
 
	gsu³r
::
xev®
::
Ev®CÚ‹xt
;

27 cÚ¡ 
	gHEAP_MAX_CAPACITY
: 
usize
 = 1024;

29 
pub
 
	sSÜtRow
 {

30 
pub
 
	mhªdË
: 
i64
,

31 
pub
 
	md©a
: 
RowCŞsDiù
,

32 
pub
 
	mkey
: 
Vec
<
D©um
>,

33 
	mÜd”_cŞs
: 
Arc
<
Vec
<
ByI‹m
>>,

34 
	mùx
: 
Arc
<
Ev®CÚ‹xt
>,

35 
	m”r
: 
Arc
<
RefC–l
<
O±iÚ
<
SŒšg
>>>,

38 
im¶
 
	gSÜtRow
 {

39 
â
 
Ãw
(

40 
hªdË
: 
i64
,

41 
d©a
: 
RowCŞsDiù
,

42 
key
: 
Vec
<
D©um
>,

43 
Üd”_cŞs
: 
Arc
<
Vec
<
ByI‹m
>>,

44 
ùx
: 
Arc
<
Ev®CÚ‹xt
>,

45 
”r
: 
Arc
<
RefC–l
<
O±iÚ
<
SŒšg
>>>,

46 è-> 
	gSÜtRow
 {

47 
	gSÜtRow
 {

48 
	ghªdË
: 
hªdË
,

49 
	gd©a
: 
d©a
,

50 
	gkey
: 
key
,

51 
	gÜd”_cŞs
: 
Üd”_cŞs
,

52 
	gùx
: 
ùx
,

53 
	g”r
: 
”r
,

57 
â
 
cmp_ªd_check
(&
£lf
, 
right
: &
SÜtRow
è-> 
ResuÉ
<
Ord”šg
> {

59 
£lf
.
check_”r
()?;

60 
Ët
 
	gv®ues
 = 
£lf
.
key
.
™”
().
z
(
right
.key.iter());

61 
	gcŞ
, (
	gv1
, 
	gv2
)è
š
 
	g£lf
.
	gÜd”_cŞs
.
as_»f
().
™”
().
z
(
v®ues
) {

62 
m©ch
 
	gv1
.
cmp
(
£lf
.
ùx
.
as_»f
(), 
v2
) {

63 
Ok
(
Ord”šg
::
Equ®
) => {

66 
Ok
(
Üd”
) => {

67 
cŞ
.
g‘_desc
() {

68  
Ok
(
Üd”
.
»v”£
());

70  
Ok
(
Üd”
);

72 
E¼
(
”r
) => {

73 
£lf
.
£t_”r
(
fÜm©
!("cm°çed w™h:{:?}", 
”r
));

74 
	g£lf
.
check_”r
()?;

78 
Ok
(
Ord”šg
::
Equ®
)

81 #[
šlše
]

82 
â
 
check_”r
(&
£lf
è-> 
ResuÉ
<()> {

83 
Ët
 
Some
(
»f
 
”r_msg
èğ*
£lf
.
”r
.
as_»f
().
bÜrow
() {

84  
E¼
(
box_”r
!(
”r_msg
.
to_owÃd
()));

86 
Ok
(())

89 
â
 
£t_”r
(&
£lf
, 
”r_msg
: 
SŒšg
) {

90 *
£lf
.
”r
.
bÜrow_mut
(èğ
Some
(
”r_msg
);

94 
pub
 
	sTİNH—p
 {

95 
pub
 
	mrows
: 
Bš¬yH—p
<
SÜtRow
>,

96 
	mlim™
: 
usize
,

97 
	m”r
: 
Arc
<
RefC–l
<
O±iÚ
<
SŒšg
>>>,

100 
im¶
 
	gTİNH—p
 {

101 
pub
 
â
 
Ãw
(
lim™
: 
usize
è-> 
ResuÉ
<
TİNH—p
> {

102 
lim™
 =ğ
usize
::
MAX
 {

103  
E¼
(
box_”r
!("invalid†imit"));

105 
Ët
 
	gÿp
 = 
cmp
::
mš
(
lim™
, 
HEAP_MAX_CAPACITY
);

106 
Ok
(
TİNH—p
 {

107 
rows
: 
Bš¬yH—p
::
w™h_ÿ·c™y
(
ÿp
),

108 
lim™
:†imit,

109 
”r
: 
Arc
::
Ãw
(
RefC–l
::Ãw(
NÚe
)),

113 #[
šlše
]

114 
pub
 
â
 
check_”r
(&
£lf
è-> 
	gResuÉ
<()> {

115 
Ët
 
Some
(
»f
 
”r_msg
èğ*
£lf
.
”r
.
as_»f
().
bÜrow
() {

116  
E¼
(
box_”r
!(
”r_msg
.
to_owÃd
()));

118 
Ok
(())

121 
pub
 
â
 
Œy_add_row
(

122 &
mut
 
£lf
,

123 
hªdË
: 
i64
,

124 
d©a
: 
RowCŞsDiù
,

125 
v®ues
: 
Vec
<
D©um
>,

126 
Üd”_cŞs
: 
Arc
<
Vec
<
ByI‹m
>>,

127 
ùx
: 
Arc
<
Ev®CÚ‹xt
>,

128 è-> 
	gResuÉ
<()> {

129 
Ët
 
	grow
 = 
SÜtRow
::
Ãw
(
hªdË
, 
d©a
, 
v®ues
, 
Üd”_cŞs
, 
ùx
, 
£lf
.
”r
.
şÚe
());

131 
	g£lf
.
	grows
.
Ën
(è< s–f.
	glim™
 {

132 
	g£lf
.
	grows
.
push
(
row
);

135 
Ët
 
mut
 
	gtİ_d©a
 = 
£lf
.
rows
.
³ek_mut
().
unw¿p
();

136 
Ët
 
	gÜd”
 = 
row
.
cmp_ªd_check
(&
tİ_d©a
)?;

137 
	gOrd”šg
::
Less
 =ğ
Üd”
 {

138 *
tİ_d©a
 = 
row
;

141 
	g£lf
.
check_”r
()

144 
pub
 
â
 
što_sÜ‹d_vec
(
£lf
è-> 
	gResuÉ
<
	gVec
<
	gSÜtRow
>> {

145 
Ët
 
	gsÜ‹d_d©a
 = 
£lf
.
rows
.
što_sÜ‹d_vec
();

147 
Ët
 
Some
(
»f
 
”r_msg
èğ*
£lf
.
”r
.
as_»f
().
bÜrow
() {

148  
E¼
(
box_”r
!(
”r_msg
.
to_owÃd
()));

150 
Ok
(
sÜ‹d_d©a
)

154 
im¶
 
Ord
 
	gSÜtRow
 {

155 
â
 
cmp
(&
£lf
, 
right
: &
SÜtRow
è-> 
Ord”šg
 {

156 
Ët
 
Ok
(
Üd”
èğ
£lf
.
cmp_ªd_check
(
right
) {

157  
Üd”
;

159 
	gOrd”šg
::
Equ®


163 
im¶
 
P¬tŸlEq
 
SÜtRow
 {

164 
â
 
eq
(&
£lf
, 
right
: &
SÜtRow
è-> 
boŞ
 {

165 
£lf
.
cmp
(
right
è=ğ
Ord”šg
::
Equ®


169 
im¶
 
Eq
 
SÜtRow
 {}

171 
im¶
 
P¬tŸlOrd
 
SÜtRow
 {

172 
â
 
·¹Ÿl_cmp
(&
£lf
, 
rhs
: &
SÜtRow
è-> 
O±iÚ
<
Ord”šg
> {

173 
Some
(
£lf
.
cmp
(
rhs
))

178 #[
cfg
(
‹¡
)]

179 
mod
 
‹¡s
 {

180 
u£
 
¡d
::
sync
::
Arc
;

182 
u£
 
	gtb
::
ex´essiÚ
::{
ByI‹m
, 
	gEx´
, 
	gEx´Ty³
};

184 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

185 
u£
 
	gut
::
codec
::
numb”
::*;

186 
u£
 
	gcİroûssÜ
::
codec
::
D©um
;

187 
u£
 
	gcİroûssÜ
::
codec
::
bË
::
RowCŞsDiù
;

188 
u£
 
	gcİroûssÜ
::
£Ëù
::
xev®
::
Ev®CÚ‹xt
;

190 
u£
 
	gsu³r
::*;

192 
â
 
Ãw_Üd”_by
(
cŞ_id
: 
i64
, 
desc
: 
boŞ
è-> 
ByI‹m
 {

193 
Ët
 
mut
 
™em
 = 
ByI‹m
::
Ãw
();

194 
Ët
 
mut
 
	gex´
 = 
Ex´
::
Ãw
();

195 
	gex´
.
£t_
(
Ex´Ty³
::
CŞumnRef
);

196 
	gex´
.
mut_v®
().
’code_i64
(
cŞ_id
).
unw¿p
();

197 
	g™em
.
£t_ex´
(
ex´
);

198 
	g™em
.
£t_desc
(
desc
);

199 
	g™em


202 #[
‹¡
]

203 
â
 
‹¡_tİn_h—p
() {

204 
Ët
 
mut
 
	gÜd”_cŞs
 = 
Vec
::
Ãw
();

205 
	gÜd”_cŞs
.
push
(
Ãw_Üd”_by
(0, 
Œue
));

206 
	gÜd”_cŞs
.
push
(
Ãw_Üd”_by
(1, 
çl£
));

207 
Ët
 
	gÜd”_cŞs
 = 
Arc
::
Ãw
(
Üd”_cŞs
);

208 
Ët
 
	gùx
 = 
Arc
::
Ãw
(
Ev®CÚ‹xt
::());

209 
Ët
 
mut
 
	gtİn_h—p
 = 
TİNH—p
::
Ãw
(5).
unw¿p
();

210 
Ët
 
	g‹¡_d©a
 = 
vec
![

211 (1, 
SŒšg
::
äom
("d©a1"), 
D©um
::
NuÎ
, D©um::
I64
(1)),

214 
SŒšg
::
äom
("data2"),

215 
D©um
::
By‹s
(
b
"Çme:0".
to_vec
()),

216 
D©um
::
I64
(2),

220 
SŒšg
::
äom
("data3"),

221 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

222 
D©um
::
I64
(1),

226 
SŒšg
::
äom
("data4"),

227 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

228 
D©um
::
I64
(2),

232 
SŒšg
::
äom
("data5"),

233 
D©um
::
By‹s
(
b
"Çme:0".
to_vec
()),

234 
D©um
::
I64
(6),

238 
SŒšg
::
äom
("data6"),

239 
D©um
::
By‹s
(
b
"Çme:0".
to_vec
()),

240 
D©um
::
I64
(4),

244 
SŒšg
::
äom
("data7"),

245 
D©um
::
By‹s
(
b
"Çme:7".
to_vec
()),

246 
D©um
::
I64
(2),

250 
SŒšg
::
äom
("data8"),

251 
D©um
::
By‹s
(
b
"Çme:8".
to_vec
()),

252 
D©um
::
I64
(2),

256 
SŒšg
::
äom
("data9"),

257 
D©um
::
By‹s
(
b
"Çme:9".
to_vec
()),

258 
D©um
::
I64
(2),

262 
Ët
 
	gexp
 = 
vec
![

265 
SŒšg
::
äom
("data9"),

266 
D©um
::
By‹s
(
b
"Çme:9".
to_vec
()),

267 
D©um
::
I64
(2),

271 
SŒšg
::
äom
("data8"),

272 
D©um
::
By‹s
(
b
"Çme:8".
to_vec
()),

273 
D©um
::
I64
(2),

277 
SŒšg
::
äom
("data7"),

278 
D©um
::
By‹s
(
b
"Çme:7".
to_vec
()),

279 
D©um
::
I64
(2),

283 
SŒšg
::
äom
("data3"),

284 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

285 
D©um
::
I64
(1),

289 
SŒšg
::
äom
("data4"),

290 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

291 
D©um
::
I64
(2),

295 
	ghªdË
, 
	gd©a
, 
	gÇme
, 
	gcouÁ
è
š
 
	g‹¡_d©a
 {

296 
Ët
 
	gcur_key
: 
Vec
<
D©um
> = 
vec
![
Çme
, 
couÁ
];

297 
Ët
 
	grow_d©a
 = 
RowCŞsDiù
::
Ãw
(
HashM­
::(), 
d©a
.
što_by‹s
());

298 
	gtİn_h—p


299 .
Œy_add_row
(

300 
hªdË
 
as
 
i64
,

301 
row_d©a
,

302 
cur_key
,

303 
Üd”_cŞs
.
şÚe
(),

304 
ùx
.
şÚe
(),

306 .
unw¿p
();

308 
Ët
 
	g»suÉ
 = 
tİn_h—p
.
što_sÜ‹d_vec
().
unw¿p
();

309 
	gas£¹_eq
!(
	g»suÉ
.
Ën
(), 
	gexp
.len());

310 
	grow
, (
	ghªdË
, 
	g_
, 
	gÇme
, 
	gcouÁ
)è
š
 
	g»suÉ
.
™”
().
z
(
exp
) {

311 
Ët
 
	gexp_keys
: 
Vec
<
D©um
> = 
vec
![
Çme
, 
couÁ
];

312 
	gas£¹_eq
!(
	grow
.
	ghªdË
, handle);

313 
	gas£¹_eq
!(
	grow
.
	gkey
, 
	gexp_keys
);

317 #[
‹¡
]

318 
â
 
‹¡_tİn_h—p_w™h_cmp_”rÜ
() {

319 
Ët
 
mut
 
	gÜd”_cŞs
 = 
Vec
::
Ãw
();

320 
	gÜd”_cŞs
.
push
(
Ãw_Üd”_by
(0, 
Œue
));

321 
	gÜd”_cŞs
.
push
(
Ãw_Üd”_by
(1, 
çl£
));

322 
Ët
 
	gÜd”_cŞs
 = 
Arc
::
Ãw
(
Üd”_cŞs
);

323 
Ët
 
	gùx
 = 
Arc
::
Ãw
(
Ev®CÚ‹xt
::());

324 
Ët
 
mut
 
	gtİn_h—p
 = 
TİNH—p
::
Ãw
(5).
unw¿p
();

326 
Ët
 
	g¡d_key
: 
Vec
<
D©um
> = 
vec
![D©um::
By‹s
(
b
"¯a".
to_vec
()), D©um::
I64
(2)];

327 
Ët
 
	grow_d©a
 = 
RowCŞsDiù
::
Ãw
(
HashM­
::(), 
b
"Çme:1".
to_vec
());

328 
	gtİn_h—p


329 .
Œy_add_row
(0 
as
 
i64
, 
row_d©a
, 
¡d_key
, 
Üd”_cŞs
.
şÚe
(), 
ùx
.clone())

330 .
unw¿p
();

332 
Ët
 
	g¡d_key2
: 
Vec
<
D©um
> = 
vec
![D©um::
By‹s
(
b
"¯a".
to_vec
()), D©um::
I64
(3)];

333 
Ët
 
	grow_d©a2
 = 
RowCŞsDiù
::
Ãw
(
HashM­
::(), 
b
"Çme:2".
to_vec
());

334 
	gtİn_h—p


335 .
Œy_add_row
(

336 0 
as
 
i64
,

337 
row_d©a2
,

338 
¡d_key2
,

339 
Üd”_cŞs
.
şÚe
(),

340 
ùx
.
şÚe
(),

342 .
unw¿p
();

344 
Ët
 
	gbad_key1
: 
Vec
<
D©um
> = 
vec
![D©um::
I64
(2), D©um::
By‹s
(
b
"¯a".
to_vec
())];

345 
Ët
 
	grow_d©a3
 = 
RowCŞsDiù
::
Ãw
(
HashM­
::(), 
b
"Çme:3".
to_vec
());

347 
	gas£¹
!(

348 
	gtİn_h—p


349 .
Œy_add_row
(

350 0 
as
 
i64
,

351 
row_d©a3
,

352 
bad_key1
,

353 
Üd”_cŞs
.
şÚe
(),

354 
ùx
.
şÚe
()

356 .
is_”r
()

359 
	gas£¹
!(
	gtİn_h—p
.
što_sÜ‹d_vec
().
is_”r
());

362 #[
‹¡
]

363 
â
 
‹¡_tİn_h—p_w™h_ãw_d©a
() {

364 
Ët
 
mut
 
	gÜd”_cŞs
 = 
Vec
::
Ãw
();

365 
	gÜd”_cŞs
.
push
(
Ãw_Üd”_by
(0, 
Œue
));

366 
	gÜd”_cŞs
.
push
(
Ãw_Üd”_by
(1, 
çl£
));

367 
Ët
 
	gÜd”_cŞs
 = 
Arc
::
Ãw
(
Üd”_cŞs
);

368 
Ët
 
	gùx
 = 
Arc
::
Ãw
(
Ev®CÚ‹xt
::());

369 
Ët
 
mut
 
	gtİn_h—p
 = 
TİNH—p
::
Ãw
(10).
unw¿p
();

370 
Ët
 
	g‹¡_d©a
 = 
vec
![

373 
SŒšg
::
äom
("data3"),

374 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

375 
D©um
::
I64
(1),

379 
SŒšg
::
äom
("data4"),

380 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

381 
D©um
::
I64
(2),

385 
SŒšg
::
äom
("data7"),

386 
D©um
::
By‹s
(
b
"Çme:7".
to_vec
()),

387 
D©um
::
I64
(2),

391 
SŒšg
::
äom
("data8"),

392 
D©um
::
By‹s
(
b
"Çme:8".
to_vec
()),

393 
D©um
::
I64
(2),

397 
SŒšg
::
äom
("data9"),

398 
D©um
::
By‹s
(
b
"Çme:9".
to_vec
()),

399 
D©um
::
I64
(2),

403 
Ët
 
	gexp
 = 
vec
![

406 
SŒšg
::
äom
("data9"),

407 
D©um
::
By‹s
(
b
"Çme:9".
to_vec
()),

408 
D©um
::
I64
(2),

412 
SŒšg
::
äom
("data8"),

413 
D©um
::
By‹s
(
b
"Çme:8".
to_vec
()),

414 
D©um
::
I64
(2),

418 
SŒšg
::
äom
("data7"),

419 
D©um
::
By‹s
(
b
"Çme:7".
to_vec
()),

420 
D©um
::
I64
(2),

424 
SŒšg
::
äom
("data3"),

425 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

426 
D©um
::
I64
(1),

430 
SŒšg
::
äom
("data4"),

431 
D©um
::
By‹s
(
b
"Çme:3".
to_vec
()),

432 
D©um
::
I64
(2),

436 
	ghªdË
, 
	gd©a
, 
	gÇme
, 
	gcouÁ
è
š
 
	g‹¡_d©a
 {

437 
Ët
 
	gcur_key
: 
Vec
<
D©um
> = 
vec
![
Çme
, 
couÁ
];

438 
Ët
 
	grow_d©a
 = 
RowCŞsDiù
::
Ãw
(
HashM­
::(), 
d©a
.
što_by‹s
());

439 
	gtİn_h—p


440 .
Œy_add_row
(

441 
hªdË
 
as
 
i64
,

442 
row_d©a
,

443 
cur_key
,

444 
Üd”_cŞs
.
şÚe
(),

445 
ùx
.
şÚe
(),

447 .
unw¿p
();

450 
Ët
 
	g»suÉ
 = 
tİn_h—p
.
što_sÜ‹d_vec
().
unw¿p
();

451 
	gas£¹_eq
!(
	g»suÉ
.
Ën
(), 
	gexp
.len());

452 
	grow
, (
	ghªdË
, 
	g_
, 
	gÇme
, 
	gcouÁ
)è
š
 
	g»suÉ
.
™”
().
z
(
exp
) {

453 
Ët
 
	gexp_keys
: 
Vec
<
D©um
> = 
vec
![
Çme
, 
couÁ
];

454 
	gas£¹_eq
!(
	grow
.
	ghªdË
, handle);

455 
	gas£¹_eq
!(
	grow
.
	gkey
, 
	gexp_keys
);

459 #[
‹¡
]

460 
â
 
‹¡_tİn_lim™_oom
() {

461 
Ët
 
	gtİn_h—p
 = 
TİNH—p
::
Ãw
(
usize
::
MAX
 - 1);

462 
	gas£¹
!(
	gtİn_h—p
.
is_ok
());

463 
Ët
 
	gtİn_h—p
 = 
TİNH—p
::
Ãw
(
usize
::
MAX
);

464 
	gas£¹
!(
	gtİn_h—p
.
is_”r
());

	@src/coprocessor/select/xeval/builtin_math.rs

14 
u£
 
	gtb
::
ex´essiÚ
::
Ex´
;

15 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::
D©um
;

16 
u£
 
	gsu³r
::{
E¼Ü
, 
	gEv®CÚ‹xt
, 
	gEv®u©Ü
, 
	gResuÉ
};

18 
pub
 cÚ¡ 
	gTYPE_INT
: &'static str = "int";

19 
pub
 cÚ¡ 
TYPE_FLOAT
: &'static str = "float";

21 
pub
 
â
 
šv®id_ty³_”rÜ
(
d©um
: &
D©um
, 
ex³ùed_ty³
: &
¡r
è-> 
ResuÉ
<Datum> {

22 
E¼
(
E¼Ü
::
Ev®
(
fÜm©
!(

24 
d©um
,

25 
ex³ùed_ty³


29 
im¶
 
	gEv®u©Ü
 {

30 
pub
 
â
 
abs_št
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

31 
Ët
 
chd
 = 
£lf
.
g‘_Úe_chd
(
ex´
)?;

32 
Ët
 
	gd
 = 
£lf
.
ev®
(
ùx
, 
chd
)?;

33 
m©ch
 
	gd
 {

34 
	gD©um
::
I64
(
i
) => i >= 0 {

35 
Ok
(
D©um
::
I64
(
i
))

37 
Ok
(
D©um
::
I64
(-
i
))

39 
	gD©um
::
U64
(
_
è| 
D©um
::
NuÎ
 => 
Ok
(
d
),

40 
	g_
 => 
šv®id_ty³_”rÜ
(&
d
, 
TYPE_INT
),

44 
pub
 
â
 
abs_»®
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

45 
Ët
 
chd
 = 
£lf
.
g‘_Úe_chd
(
ex´
)?;

46 
Ët
 
	gd
 = 
£lf
.
ev®
(
ùx
, 
chd
)?;

47 
m©ch
 
	gd
 {

48 
	gD©um
::
F64
(
f
è=> 
Ok
(
D©um
::F64(f.
abs
())),

49 
	gD©um
::
NuÎ
 => 
Ok
(
D©um
::Null),

50 
	g_
 => 
šv®id_ty³_”rÜ
(&
d
, 
TYPE_FLOAT
),

54 
pub
 
â
 
û_št
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

55 
Ët
 
chd
 = 
£lf
.
g‘_Úe_chd
(
ex´
)?;

56 
Ët
 
	gd
 = 
£lf
.
ev®
(
ùx
, 
chd
)?;

57 
m©ch
 
	gd
 {

58 
	gD©um
::
F64
(
i
) => {

59 
Ët
 
»suÉ
 = 
i
.
û
(è
as
 
i64
;

60 
Ok
(
D©um
::
I64
(
»suÉ
))

62 
D©um
::
NuÎ
 => 
Ok
(Datum::Null),

63 
	g_
 => 
šv®id_ty³_”rÜ
(&
d
, 
TYPE_FLOAT
),

67 
pub
 
â
 
û_»®
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

68 
Ët
 
chd
 = 
£lf
.
g‘_Úe_chd
(
ex´
)?;

69 
Ët
 
	gd
 = 
£lf
.
ev®
(
ùx
, 
chd
)?;

70 
m©ch
 
	gd
 {

71 
	gD©um
::
F64
(
f
è=> 
Ok
(
D©um
::F64(f.
û
())),

72 
	gD©um
::
NuÎ
 => 
Ok
(
D©um
::Null),

73 
	g_
 => 
šv®id_ty³_”rÜ
(&
d
, 
TYPE_FLOAT
),

78 #[
cfg
(
‹¡
)]

79 
mod
 
	g‹¡
 {

80 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´Ty³
, 
	gSÿÏrFuncSig
};

81 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::
D©um
;

82 
u£
 
	gsu³r
::
su³r
::
Ev®u©Ü
;

83 
u£
 
	gsu³r
::
su³r
::
ev®u©Ü
::
‹¡
::
bud_ex´_w™h_sig
;

85 
	gmaüo_ruËs
! 
	g‹¡_ev®
 {

86 (
	g$g
:
id’t
, 
	g$ÿ£s
:
ex´
) => {

87 #[
‹¡
]

88 
â
 
$g
() {

89 
Ët
 
mut
 
‹¡_ÿ£s
 = 
$ÿ£s
;

90 
Ët
 
mut
 
	gev®u©Ü
 = 
Ev®u©Ü
::();

91 
	gi
, (
	gex´
, 
	gex³ùed
)è
š
 
	g‹¡_ÿ£s
.
d¿š
(..).
’um”©e
() {

92 
Ët
 
	g»s
 = 
ev®u©Ü
.
ev®
(&
DeçuÉ
::(), &
ex´
);

93 
	gas£¹
!(
	g»s
.
is_ok
(),

95 
	gi
,

96 
	gex´
,

97 
	g»s
);

98 
Ët
 
	g»s
 = 
»s
.
unw¿p
();

99 
	gas£¹_eq
!(
	g»s
,

100 
	gex³ùed
,

102 
	gi
,

103 
	gex³ùed
,

104 
	g»s
);

110 
	g‹¡_ev®
!(

111 
	g‹¡_abs_št
,

112 
	gvec
![

114 
bud_ex´_w™h_sig
(

115 
vec
![
D©um
::
I64
(-1)],

116 
Ex´Ty³
::
SÿÏrFunc
,

117 
SÿÏrFuncSig
::
AbsIÁ
,

119 
	gD©um
::
I64
(1),

122 
bud_ex´_w™h_sig
(

123 
vec
![
D©um
::
I64
(1)],

124 
Ex´Ty³
::
SÿÏrFunc
,

125 
SÿÏrFuncSig
::
AbsIÁ
,

127 
	gD©um
::
I64
(1),

130 
bud_ex´_w™h_sig
(

131 
vec
![
D©um
::
U64
(1)],

132 
Ex´Ty³
::
SÿÏrFunc
,

133 
SÿÏrFuncSig
::
AbsIÁ
,

135 
	gD©um
::
U64
(1),

138 
bud_ex´_w™h_sig
(

139 
vec
![
D©um
::
NuÎ
],

140 
Ex´Ty³
::
SÿÏrFunc
,

141 
SÿÏrFuncSig
::
AbsIÁ
,

143 
	gD©um
::
NuÎ
,

148 
	g‹¡_ev®
!(

149 
	g‹¡_abs_»®
,

150 
	gvec
![

152 
bud_ex´_w™h_sig
(

153 
vec
![
D©um
::
F64
(-1.0
_f64
)],

154 
Ex´Ty³
::
SÿÏrFunc
,

155 
SÿÏrFuncSig
::
AbsR—l
,

157 
	gD©um
::
F64
(1.0
_f64
),

160 
bud_ex´_w™h_sig
(

161 
vec
![
D©um
::
F64
(1.0
_f64
)],

162 
Ex´Ty³
::
SÿÏrFunc
,

163 
SÿÏrFuncSig
::
AbsR—l
,

165 
	gD©um
::
F64
(1.0
_f64
),

168 
bud_ex´_w™h_sig
(

169 
vec
![
D©um
::
NuÎ
],

170 
Ex´Ty³
::
SÿÏrFunc
,

171 
SÿÏrFuncSig
::
AbsR—l
,

173 
	gD©um
::
NuÎ
,

176 
bud_ex´_w™h_sig
(

177 
vec
![
D©um
::
F64
(0.0
_f64
)],

178 
Ex´Ty³
::
SÿÏrFunc
,

179 
SÿÏrFuncSig
::
AbsR—l
,

181 
	gD©um
::
F64
(0.0
_f64
),

186 
	g‹¡_ev®
!(

187 
	g‹¡_û_»®
,

188 
	gvec
![

190 
bud_ex´_w™h_sig
(

191 
vec
![
D©um
::
F64
(-1.5)],

192 
Ex´Ty³
::
SÿÏrFunc
,

193 
SÿÏrFuncSig
::
CeR—l
,

195 
	gD©um
::
F64
(-1.0),

198 
bud_ex´_w™h_sig
(

199 
vec
![
D©um
::
F64
(1.1)],

200 
Ex´Ty³
::
SÿÏrFunc
,

201 
SÿÏrFuncSig
::
CeR—l
,

203 
	gD©um
::
F64
(2.0),

206 
bud_ex´_w™h_sig
(

207 
vec
![
D©um
::
F64
(2.0)],

208 
Ex´Ty³
::
SÿÏrFunc
,

209 
SÿÏrFuncSig
::
CeR—l
,

211 
	gD©um
::
F64
(2.0),

214 
bud_ex´_w™h_sig
(

215 
vec
![
D©um
::
NuÎ
],

216 
Ex´Ty³
::
SÿÏrFunc
,

217 
SÿÏrFuncSig
::
CeR—l
,

219 
	gD©um
::
NuÎ
,

	@src/coprocessor/select/xeval/evaluator.rs

14 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

15 
u£
 
	g¡d
::
ascii
::
AsciiExt
;

16 
u£
 
	g¡d
::
»suÉ
;

18 
u£
 
	gchrÚo
::
FixedOff£t
;

19 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gEx´Ty³
, 
	gSÿÏrFuncSig
};

21 
u£
 
	gut
::
is_ev’
;

22 
u£
 
	gut
::
codec
::
numb”
::
Numb”Decod”
;

23 
u£
 
	gut
::
cŞËùiÚs
::{
HashM­
, 
	gHashM­EÁry
};

25 
u£
 
	gcİroûssÜ
::
codec
;

26 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::{
D©um
, 
	gD©umDecod”
};

27 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
Decim®Decod”
, 
	gDu¿tiÚ
, 
	gModifyTy³
, 
	gTime
, 
	gMAX_FSP
};

28 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
jsÚ
::{
jsÚ_¬¿y
, 
	gjsÚ_objeù
};

29 
u£
 
	gsu³r
::{
E¼Ü
, 
	gResuÉ
};

36 
pub
 cÚ¡ 
	gFLAG_IGNORE_TRUNCATE
: 
u64
 = 1;

40 
pub
 cÚ¡ 
	gFLAG_TRUNCATE_AS_WARNING
: 
u64
 = 1 << 1;

42 #[
d”ive
(
Debug
)]

44 
pub
 
	sEv®CÚ‹xt
 {

46 
pub
 
	mtz
: 
FixedOff£t
,

47 
pub
 
	mignÜe_Œunÿ‹
: 
boŞ
,

48 
pub
 
	mŒunÿ‹_as_w¬nšg
: 
boŞ
,

51 
im¶
 
DeçuÉ
 
	gEv®CÚ‹xt
 {

52 
â
 (è-> 
	gEv®CÚ‹xt
 {

53 
	gEv®CÚ‹xt
 {

54 
	gtz
: 
FixedOff£t
::
—¡
(0),

55 
	gignÜe_Œunÿ‹
: 
çl£
,

56 
	gŒunÿ‹_as_w¬nšg
: 
çl£
,

61 cÚ¡ 
	gONE_DAY
: 
i64
 = 3600 * 24;

63 
im¶
 
	gEv®CÚ‹xt
 {

64 
pub
 
â
 
Ãw
(
tz_off£t
: 
i64
, 
æags
: 
u64
è-> 
ResuÉ
<
Ev®CÚ‹xt
> {

65 
tz_off£t
 <ğ-
ONE_DAY
 ||z_offset >= ONE_DAY {

66  
E¼
(
E¼Ü
::
Ev®
(
fÜm©
!("šv®idz off£ˆ{}", 
tz_off£t
)));

68 
Ët
 
	gtz
 = 
m©ch
 
FixedOff£t
::
—¡_İt
(
tz_off£t
 
as
 
i32
) {

69 
NÚe
 =>  
E¼
(
E¼Ü
::
Ev®
(
fÜm©
!("šv®idz off£ˆ{}", 
tz_off£t
))),

70 
Some
(
tz
) =>z,

73 
Ët
 
	ge
 = 
Ev®CÚ‹xt
 {

74 
tz
:z,

75 
ignÜe_Œunÿ‹
: (
æags
 & 
FLAG_IGNORE_TRUNCATE
) > 0,

76 
Œunÿ‹_as_w¬nšg
: (
æags
 & 
FLAG_TRUNCATE_AS_WARNING
) > 0,

79 
Ok
(
e
)

86 #[
d”ive
(
DeçuÉ
)]

87 
pub
 
	sEv®u©Ü
 {

89 
pub
 
	mrow
: 
HashM­
<
i64
, 
	mD©um
>,

91 
	mÿched_v®ue_li¡
: 
HashM­
<
isize
, 
	mVec
<
	mD©um
>>,

94 
im¶
 
	gEv®u©Ü
 {

95 
pub
 
â
 
b©ch_ev®
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´s
: &[
Ex´
]è-> 
ResuÉ
<
Vec
<
D©um
>> {

96 
Ët
 
mut
 
»s
 = 
Vec
::
w™h_ÿ·c™y
(
ex´s
.
Ën
());

97 
ex´
 
š
 
	gex´s
 {

98 
Ët
 
	gr
 = 
£lf
.
ev®
(
ùx
, 
ex´
)?;

99 
	g»s
.
push
(
r
);

101 
Ok
(
»s
)

105 
pub
 
â
 
ev®
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

106 
m©ch
 
ex´
.
g‘_
() {

107 
Ex´Ty³
::
IÁ64
 => 
£lf
.
ev®_št
(
ex´
),

108 
	gEx´Ty³
::
Ušt64
 => 
£lf
.
ev®_ušt
(
ex´
),

110 
	gEx´Ty³
::
SŒšg
 | 
Ex´Ty³
::
By‹s
 => 
Ok
(
D©um
::By‹s(
ex´
.
g‘_v®
().
to_vec
())),

111 
	gEx´Ty³
::
CŞumnRef
 => 
£lf
.
ev®_cŞumn_»f
(
ex´
),

112 
	gEx´Ty³
::
LT
 => 
£lf
.
ev®_É
(
ùx
, 
ex´
),

113 
	gEx´Ty³
::
LE
 => 
£lf
.
ev®_Ë
(
ùx
, 
ex´
),

114 
	gEx´Ty³
::
EQ
 => 
£lf
.
ev®_eq
(
ùx
, 
ex´
),

115 
	gEx´Ty³
::
NE
 => 
£lf
.
ev®_Ã
(
ùx
, 
ex´
),

116 
	gEx´Ty³
::
GE
 => 
£lf
.
ev®_ge
(
ùx
, 
ex´
),

117 
	gEx´Ty³
::
GT
 => 
£lf
.
ev®_gt
(
ùx
, 
ex´
),

118 
	gEx´Ty³
::
NuÎEQ
 => 
£lf
.
ev®_nuÎ_eq
(
ùx
, 
ex´
),

119 
	gEx´Ty³
::
And
 => 
£lf
.
ev®_logic
(
ùx
, 
ex´
, 
Some
(
çl£
), 
ev®_ªd
),

120 
	gEx´Ty³
::
Or
 => 
£lf
.
ev®_logic
(
ùx
, 
ex´
, 
Some
(
Œue
), 
ev®_Ü
),

121 
	gEx´Ty³
::
NÙ
 => 
£lf
.
ev®_nÙ
(
ùx
, 
ex´
),

122 
	gEx´Ty³
::
Like
 => 
£lf
.
ev®_like
(
ùx
, 
ex´
),

123 
	gEx´Ty³
::
Flßt32
 | 
Ex´Ty³
::
Flßt64
 => 
£lf
.
ev®_æßt
(
ex´
),

124 
	gEx´Ty³
::
MysqlDu¿tiÚ
 => 
£lf
.
ev®_du¿tiÚ
(
ex´
),

125 
	gEx´Ty³
::
MysqlDecim®
 => 
£lf
.
ev®_decim®
(
ex´
),

126 
	gEx´Ty³
::
MysqlTime
 => 
£lf
.
ev®_time
(
ùx
, 
ex´
),

127 
	gEx´Ty³
::
In
 => 
£lf
.
ev®_š
(
ùx
, 
ex´
),

128 
	gEx´Ty³
::
Plus
 => 
£lf
.
ev®_¬™h
(
ùx
, 
ex´
, 
D©um
::
checked_add
),

129 
	gEx´Ty³
::
Div
 => 
£lf
.
ev®_¬™h
(
ùx
, 
ex´
, 
D©um
::
checked_div
),

130 
	gEx´Ty³
::
Mšus
 => 
£lf
.
ev®_¬™h
(
ùx
, 
ex´
, 
D©um
::
checked_mšus
),

131 
	gEx´Ty³
::
Mul
 => 
£lf
.
ev®_¬™h
(
ùx
, 
ex´
, 
D©um
::
checked_mul
),

132 
	gEx´Ty³
::
IÁDiv
 => 
£lf
.
ev®_¬™h
(
ùx
, 
ex´
, 
D©um
::
checked_št_div
),

133 
	gEx´Ty³
::
Mod
 => 
£lf
.
ev®_¬™h
(
ùx
, 
ex´
, 
D©um
::
checked_»m
),

134 
	gEx´Ty³
::
Ca£
 => 
£lf
.
ev®_ÿ£_wh’
(
ùx
, 
ex´
),

135 
	gEx´Ty³
::
If
 => 
£lf
.
ev®_if
(
ùx
, 
ex´
),

136 
	gEx´Ty³
::
CßËsû
 => 
£lf
.
ev®_cßËsû
(
ùx
, 
ex´
),

137 
	gEx´Ty³
::
IfNuÎ
 => 
£lf
.
ev®_if_nuÎ
(
ùx
, 
ex´
),

138 
	gEx´Ty³
::
IsNuÎ
 => 
£lf
.
ev®_is_nuÎ
(
ùx
, 
ex´
),

139 
	gEx´Ty³
::
NuÎIf
 => 
£lf
.
ev®_nuÎ_if
(
ùx
, 
ex´
),

140 
	gEx´Ty³
::
JsÚS‘
 => 
£lf
.
ev®_jsÚ_modify
(
ùx
, 
ex´
, 
ModifyTy³
::
S‘
),

141 
	gEx´Ty³
::
JsÚIn£¹
 => 
£lf
.
ev®_jsÚ_modify
(
ùx
, 
ex´
, 
ModifyTy³
::
In£¹
),

142 
	gEx´Ty³
::
JsÚR•Ïû
 => 
£lf
.
ev®_jsÚ_modify
(
ùx
, 
ex´
, 
ModifyTy³
::
R•Ïû
),

143 
	gEx´Ty³
::
JsÚUnquÙe
 => 
£lf
.
ev®_jsÚ_unquÙe
(
ùx
, 
ex´
),

144 
	gEx´Ty³
::
JsÚExŒaù
 => 
£lf
.
ev®_jsÚ_exŒaù
(
ùx
, 
ex´
),

145 
	gEx´Ty³
::
JsÚTy³
 => 
£lf
.
ev®_jsÚ_ty³
(
ùx
, 
ex´
),

146 
	gEx´Ty³
::
JsÚM”ge
 => 
£lf
.
ev®_jsÚ_m”ge
(
ùx
, 
ex´
),

147 
	gEx´Ty³
::
JsÚObjeù
 => 
£lf
.
ev®_jsÚ_objeù
(
ùx
, 
ex´
),

148 
	gEx´Ty³
::
JsÚA¼ay
 => 
£lf
.
ev®_jsÚ_¬¿y
(
ùx
, 
ex´
),

149 
	gEx´Ty³
::
JsÚRemove
 => 
£lf
.
ev®_jsÚ_»move
(
ùx
, 
ex´
),

150 
	gEx´Ty³
::
SÿÏrFunc
 => 
£lf
.
ev®_sÿÏr_funùiÚ
(
ùx
, 
ex´
),

151 
	g_
 => 
Ok
(
D©um
::
NuÎ
),

155 
â
 
ev®_št
(&
£lf
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

156 
Ët
 
i
 = 
ex´
.
g‘_v®
().
decode_i64
()?;

157 
Ok
(
D©um
::
I64
(
i
))

160 
â
 
ev®_ušt
(&
£lf
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

161 
Ët
 
u
 = 
ex´
.
g‘_v®
().
decode_u64
()?;

162 
Ok
(
D©um
::
U64
(
u
))

165 
â
 
ev®_æßt
(&
£lf
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

166 
Ët
 
f
 = 
ex´
.
g‘_v®
().
decode_f64
()?;

167 
Ok
(
D©um
::
F64
(
f
))

170 
â
 
ev®_du¿tiÚ
(&
£lf
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

171 
Ët
 
n
 = 
ex´
.
g‘_v®
().
decode_i64
()?;

172 
Ët
 
	gdur
 = 
Du¿tiÚ
::
äom_Çnos
(
n
, 
MAX_FSP
)?;

173 
Ok
(
D©um
::
Dur
(
dur
))

176 
â
 
ev®_decim®
(&
£lf
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

177 
Ët
 
d
 = 
ex´
.
g‘_v®
().
decode_decim®
()?;

178 
Ok
(
D©um
::
Dec
(
d
))

181 
â
 
ev®_time
(&
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

182 
Ët
 
d
 = 
ex´
.
g‘_v®
().
decode_u64
()?;

183 
Ët
 
	gt
 = 
Time
::
äom_·cked_u64
(

184 
d
,

185 
ex´
.
g‘_f›ld_ty³
().
g‘_
(è
as
 
u8
,

186 
ex´
.
g‘_f›ld_ty³
().
g‘_decim®
(è
as
 
i8
,

187 &
ùx
.
tz
,

189 
Ok
(
D©um
::
Time
(
t
))

192 
â
 
ev®_cŞumn_»f
(&
£lf
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

193 
Ët
 
i
 = 
ex´
.
g‘_v®
().
decode_i64
()?;

194 
	g£lf
.
	grow


195 .
g‘
(&
i
)

196 .
şÚed
()

197 .
ok_Ü_–£
(|| 
E¼Ü
::
Ev®
(
fÜm©
!("cŞumÀ{}‚Ù found", 
i
)))

200 
â
 
ev®_É
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

201 
Ët
 
cmp
 = 
£lf
.
cmp_chd»n
(
ùx
, 
ex´
)?;

202 
Ok
(
cmp
.
m­
(|
c
| c < 
Ord”šg
::
Equ®
).
što
())

205 
â
 
ev®_Ë
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

206 
Ët
 
cmp
 = 
£lf
.
cmp_chd»n
(
ùx
, 
ex´
)?;

207 
Ok
(
cmp
.
m­
(|
c
| c <ğ
Ord”šg
::
Equ®
).
što
())

210 
â
 
ev®_eq
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

211 
Ët
 
cmp
 = 
£lf
.
cmp_chd»n
(
ùx
, 
ex´
)?;

212 
Ok
(
cmp
.
m­
(|
c
| c =ğ
Ord”šg
::
Equ®
).
što
())

215 
â
 
ev®_Ã
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

216 
Ët
 
cmp
 = 
£lf
.
cmp_chd»n
(
ùx
, 
ex´
)?;

217 
Ok
(
cmp
.
m­
(|
c
| c !ğ
Ord”šg
::
Equ®
).
što
())

220 
â
 
ev®_ge
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

221 
Ët
 
cmp
 = 
£lf
.
cmp_chd»n
(
ùx
, 
ex´
)?;

222 
Ok
(
cmp
.
m­
(|
c
| c >ğ
Ord”šg
::
Equ®
).
što
())

225 
â
 
ev®_gt
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

226 
Ët
 
cmp
 = 
£lf
.
cmp_chd»n
(
ùx
, 
ex´
)?;

227 
Ok
(
cmp
.
m­
(|
c
| c > 
Ord”šg
::
Equ®
).
što
())

230 
â
 
ev®_nuÎ_eq
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

231 
Ët
 (
Ëá
, 
right
èğ
£lf
.
ev®_two_chd»n
(
ùx
, 
ex´
)?;

232 
Ët
 
	gcmp
 = 
Ëá
.
cmp
(
ùx
, &
right
)?;

233 
Ok
((
cmp
 =ğ
Ord”šg
::
Equ®
).
što
())

236 
â
 
cmp_chd»n
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
O±iÚ
<
Ord”šg
>> {

237 
Ët
 (
Ëá
, 
right
èğ
£lf
.
ev®_two_chd»n
(
ùx
, 
ex´
)?;

238 
	gËá
 =ğ
D©um
::
NuÎ
 || 
right
 == Datum::Null {

239  
Ok
(
NÚe
);

241 
	gËá
.
cmp
(
ùx
, &
right
).
m­
(
Some
).
m­_”r
(
From
::
äom
)

244 
pub
 
â
 
g‘_Úe_chd
<'a>(&muˆ£lf,ƒx´: &'
a
 
Ex´
è-> 
ResuÉ
<&'a Expr> {

245 
Ët
 
l
 = 
ex´
.
g‘_chd»n
().
Ën
();

246 
	gl
 != 1 {

247  
E¼
(
E¼Ü
::
Ex´
(

248 
fÜm©
!("{:?}‚“d 1 o³¿nd buˆgÙ {}", 
ex´
.
g‘_
(), 
l
),

251 
Ët
 
	gchd»n
 = 
ex´
.
g‘_chd»n
();

252 
Ok
(&
chd»n
[0])

255 
â
 
	gg‘_two_chd»n
<'a>(&muˆ£lf,ƒx´: &'
a
 
	gEx´
è-> 
	gResuÉ
<(&'a Expr, &'a Expr)> {

256 
Ët
 
	gl
 = 
ex´
.
g‘_chd»n
().
Ën
();

257 
	gl
 != 2 {

258  
E¼
(
E¼Ü
::
Ex´
(

259 
fÜm©
!("{:?}‚“d 2 o³¿nd buˆgÙ {}", 
ex´
.
g‘_
(), 
l
),

262 
Ët
 
	gchd»n
 = 
ex´
.
g‘_chd»n
();

263 
Ok
((&
chd»n
[0], &children[1]))

266 
â
 
ev®_Úe_chd
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

267 
Ët
 
chd_ex´
 = 
£lf
.
g‘_Úe_chd
(
ex´
)?;

268 
	g£lf
.
ev®
(
ùx
, 
chd_ex´
)

271 
â
 
ev®_two_chd»n
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<(
D©um
, 
	gD©um
)> {

272 
Ët
 (
Ëá_ex´
, 
right_ex´
èğ
£lf
.
g‘_two_chd»n
(
ex´
)?;

273 
Ët
 
	gËá
 = 
£lf
.
ev®
(
ùx
, 
Ëá_ex´
)?;

274 
Ët
 
	gright
 = 
£lf
.
ev®
(
ùx
, 
right_ex´
)?;

275 
Ok
((
Ëá
, 
right
))

278 
â
 
ev®_mÜe_chd»n
(

279 &
mut
 
£lf
,

280 
ùx
: &
Ev®CÚ‹xt
,

281 
ex´
: &
Ex´
,

282 
num
: 
usize
,

283 è-> 
	gResuÉ
<
	gVec
<
	gD©um
>> {

284 
Ët
 
	gchd»n
 = 
ex´
.
g‘_chd»n
();

285 
	gchd»n
.
Ën
(è< 
	gnum
 {

286  
E¼
(
E¼Ü
::
Ex´
(
fÜm©
!(

288 
num
,

289 
chd»n
.
Ën
()

292 
	gchd»n
.
™”
().
m­
(|
chd
| 
£lf
.
ev®
(
ùx
, chd)).
cŞËù
()

295 
â
 
ev®_nÙ
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

296 
Ët
 
chd»n_út
 = 
ex´
.
g‘_chd»n
().
Ën
();

297 
	gchd»n_út
 != 1 {

298  
E¼
(
E¼Ü
::
Ex´
(

299 
fÜm©
!("ex³ù 1 o³¿nd, gÙ {}", 
chd»n_út
),

302 
Ët
 
	gd
 = 
£lf
.
ev®
(
ùx
, &
ex´
.
g‘_chd»n
()[0])?;

303 
	gd
 =ğ
D©um
::
NuÎ
 {

304  
Ok
(
D©um
::
NuÎ
);

306 
Ët
 
	gb
 = 
d
.
što_boŞ
(
ùx
)?;

307 
Ok
((
b
.
m­
(|
v
| !v)).
što
())

310 
â
 
ev®_like
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

311 
Ët
 (
rg‘
, 
·‰”n
èğ
£lf
.
ev®_two_chd»n
(
ùx
, 
ex´
)?;

312 
	gD©um
::
NuÎ
 =ğ
rg‘
 || 
D©um
::NuÎ =ğ
·‰”n
 {

313  
Ok
(
D©um
::
NuÎ
);

315 
Ët
 
mut
 
	grg‘_¡r
 = 
rg‘
.
što_¡ršg
()?;

316 
Ët
 
mut
 
	g·‰”n_¡r
 = 
·‰”n
.
što_¡ršg
()?;

317 
	g·‰”n_¡r


318 .
ch¬s
()

319 .
ªy
(|
x
| x.
is_ascii
(è&& x.
is_®phab‘ic
())

321 
	grg‘_¡r
 = 
rg‘_¡r
.
to_ascii_low”ÿ£
();

322 
	g·‰”n_¡r
 = 
·‰”n_¡r
.
to_ascii_low”ÿ£
();

325 
Ët
 
	gËn
 = 
·‰”n_¡r
.
Ën
();

326 
	g·‰”n_¡r
.
¡¬ts_w™h
('%') {

327 
	g·‰”n_¡r
[1..].
’ds_w™h
('%') {

328 
Ok
(
rg‘_¡r
.
cÚšs
(&
·‰”n_¡r
[1..Ë
n
 - 1]).
što
())

330 
Ok
(
rg‘_¡r
.
’ds_w™h
(&
·‰”n_¡r
[1..]).
što
())

332 } 
	g·‰”n_¡r
.
’ds_w™h
('%') {

333 
Ok
(
rg‘_¡r
.
¡¬ts_w™h
(&
·‰”n_¡r
[..
Ën
 - 1]).
što
())

335 
Ok
(
rg‘_¡r
.
eq
(&
·‰”n_¡r
).
što
())

339 
â
 
ev®_š
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

340 
ex´
.
g‘_chd»n
().
Ën
() != 2 {

341  
E¼
(
E¼Ü
::
Ex´
(
fÜm©
!(

343 
ex´
.
g‘_chd»n
().
Ën
()

346 
Ët
 
	gchd»n
 = 
ex´
.
g‘_chd»n
();

347 
Ët
 
	grg‘
 = 
£lf
.
ev®
(
ùx
, &
chd»n
[0])?;

348 
Ët
 
	gD©um
::
NuÎ
 = 
rg‘
 {

349  
Ok
(
rg‘
);

351 
Ët
 
	gv®ue_li¡_ex´
 = &
chd»n
[1];

352 
	gv®ue_li¡_ex´
.
g‘_
(è!ğ
Ex´Ty³
::
V®ueLi¡
 {

353  
E¼
(
E¼Ü
::
Ex´
(

354 "th£cÚd chd should boàthv®uli¡y³".
to_owÃd
(),

357 
Ët
 
	gdecoded
 = 
£lf
.
decode_v®ue_li¡
(
v®ue_li¡_ex´
)?;

358 
check_š
(
ùx
, 
rg‘
, 
decoded
)? {

359  
Ok
(
Œue
.
što
());

361 
	gdecoded
.
fœ¡
().
m­_Ü
(
çl£
, |
d
| *d =ğ
D©um
::
NuÎ
) {

362  
Ok
(
D©um
::
NuÎ
);

364 
Ok
(
çl£
.
što
())

367 
â
 
decode_v®ue_li¡
(&
mut
 
£lf
, 
v®ue_li¡_ex´
: &
Ex´
è-> 
ResuÉ
<&
Vec
<
D©um
>> {

368 
Ët
 
p
 = 
v®ue_li¡_ex´
 
as
 *cÚ¡ 
Ex´
‡ 
isize
;

369 
Ët
 
	gdecoded
 = 
m©ch
 
£lf
.
ÿched_v®ue_li¡
.
’Œy
(
p
) {

370 
HashM­EÁry
::
Occup›d
(
’Œy
è=>ƒÁry.
što_mut
(),

371 
	gHashM­EÁry
::
VaÿÁ
(
’Œy
) => {

372 
Ët
  = 
v®ue_li¡_ex´
.
g‘_v®
().
decode
()?;

373 
	g’Œy
.
š£¹
()

376 
Ok
(
decoded
)

379 
â
 
	gev®_¬™h
<
	gF
>(&
mut
 
	g£lf
, 
	gùx
: &
Ev®CÚ‹xt
, 
	gex´
: &
Ex´
, 
	gf
: 
F
è-> 
ResuÉ
<
D©um
>

380 
wh”e


381 
F
: 
FnOnû
(
D©um
, &
Ev®CÚ‹xt
, D©umè-> 
	gcodec
::
ResuÉ
<Datum>,

383 
Ët
 (
Ëá
, 
right
èğ
£lf
.
ev®_two_chd»n
(
ùx
, 
ex´
)?;

384 
ev®_¬™h
(
ùx
, 
Ëá
, 
right
, 
f
)

387 
â
 
ev®_ÿ£_wh’
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

388 
chunk
 
š
 
ex´
.
g‘_chd»n
().
chunks
(2) {

389 
Ët
 
»s
 = 
£lf
.
ev®
(
ùx
, &
chunk
[0])?;

390 
	gchunk
.
Ën
() == 1 {

392  
Ok
(
»s
);

394 !
	g»s
.
što_boŞ
(
ùx
)?.
unw¿p_Ü
(
çl£
) {

397  
	g£lf
.
ev®
(
ùx
, &
chunk
[1]).
m­_”r
(
From
::
äom
);

399 
Ok
(
D©um
::
NuÎ
)

402 
â
 
ev®_if
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

403 
Ët
 
chd»n
 = 
ex´
.
g‘_chd»n
();

404 
	gchd»n
.
Ën
() != 3 {

405  
E¼
(
E¼Ü
::
Ex´
(

406 
fÜm©
!("ex³ù 3 o³¿nds, gÙ {}", 
chd»n
.
Ën
()),

409 
Ët
 
	gcÚd
 = 
£lf
.
ev®
(
ùx
, &
chd»n
[0])?;

410 
Ët
 
	gd
 = 
m©ch
 
cÚd
.
što_boŞ
(
ùx
)? {

411 
Some
(
Œue
è=> 
£lf
.
ev®
(
ùx
, &
chd»n
[1])?,

412 
	g_
 => 
£lf
.
ev®
(
ùx
, &
chd»n
[2])?,

414 
Ok
(
d
)

417 
â
 
ev®_cßËsû
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

418 
chd
 
š
 
ex´
.
g‘_chd»n
() {

419 
m©ch
 
£lf
.
ev®
(
ùx
, 
chd
)? {

420 
	gD©um
::
NuÎ
 => {}

421 
»s
 =>  
Ok
(res),

424 
Ok
(
D©um
::
NuÎ
)

427 
â
 
ev®_if_nuÎ
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

428 
Ët
 
chd»n
 = 
ex´
.
g‘_chd»n
();

429 
	gchd»n
.
Ën
() != 2 {

430  
E¼
(
E¼Ü
::
Ex´
(

431 
fÜm©
!("ex³ù 2 o³¿nds, gÙ {}", 
chd»n
.
Ën
()),

434 
Ët
 
	gËá
 = 
£lf
.
ev®
(
ùx
, &
chd»n
[0])?;

435 
	gËá
 =ğ
D©um
::
NuÎ
 {

436 
Ok
(
£lf
.
ev®
(
ùx
, &
chd»n
[1])?)

438 
Ok
(
Ëá
)

442 
â
 
ev®_is_nuÎ
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

443 
Ët
 
chd»n
 = 
ex´
.
g‘_chd»n
();

444 
	gchd»n
.
Ën
() != 1 {

445  
E¼
(
E¼Ü
::
Ex´
(

446 
fÜm©
!("ex³ù 1 o³¿nd, gÙ {}", 
chd»n
.
Ën
()),

449 
Ët
 
	gd
 = 
£lf
.
ev®
(
ùx
, &
chd»n
[0])?;

450 
Ok
((
d
 =ğ
D©um
::
NuÎ
).
što
())

453 
â
 
ev®_nuÎ_if
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

454 
Ët
 (
Ëá
, 
right
èğ
£lf
.
ev®_two_chd»n
(
ùx
, 
ex´
)?;

455 
	gËá
 =ğ
D©um
::
NuÎ
 || 
right
 == Datum::Null {

456  
Ok
(
Ëá
);

458 
Ët
 
	gOrd”šg
::
Equ®
 = 
Ëá
.
cmp
(
ùx
, &
right
)? {

459 
Ok
(
D©um
::
NuÎ
)

461 
Ok
(
Ëá
)

465 
â
 
ev®_jsÚ_modify
(

466 &
mut
 
£lf
,

467 
ùx
: &
Ev®CÚ‹xt
,

468 
ex´
: &
Ex´
,

469 
mt
: 
ModifyTy³
,

470 è-> 
	gResuÉ
<
	gD©um
> {

471 
Ët
 
	gchd»n
 = 
£lf
.
ev®_mÜe_chd»n
(
ùx
, 
ex´
, 2)?;

472 
is_ev’
(
chd»n
.
Ën
()) {

473  
E¼
(
E¼Ü
::
Ex´
(
fÜm©
!(

475 
chd»n
.
Ën
()

479 
Ët
 
mut
 
	gšdex
 = 0 
as
 
i64
;

480 
Ët
 
	gshould_be_nuÎ
 = 
chd»n
.
™”
().
ªy
(|
™em
| {

481 
šdex
 += 1;

482 *
™em
 !ğ
D©um
::
NuÎ
 {

483 
çl£


485 
šdex
 =ğ1 || 
is_ev’
(šdex 
as
 
usize
)

488 
	gshould_be_nuÎ
 {

489  
Ok
(
D©um
::
NuÎ
);

492 
Ët
 
	gkv_Ën
 = 
chd»n
.
Ën
() / 2;

493 
Ët
 
mut
 
	gchd»n
 = 
chd»n
.
što_™”
();

494 
Ët
 
mut
 
	gjsÚ
 = 
chd»n
.
Ãxt
().
unw¿p
().
ÿ¡_as_jsÚ
()?;

495 
Ët
 
mut
 
	gkeys
 = 
Vec
::
w™h_ÿ·c™y
(
kv_Ën
);

496 
Ët
 
mut
 
	gv®ues
 = 
Vec
::
w™h_ÿ·c™y
(
kv_Ën
);

497 
Ët
 
Some
(
™em
èğ
chd»n
.
Ãxt
() {

498 
Ët
 
key
 = 
™em
.
to_jsÚ_·th_ex´
()?;

499 
Ët
 
	gv®ue
 = 
chd»n
.
Ãxt
().
unw¿p
().
što_jsÚ
()?;

500 
	gkeys
.
push
(
key
);

501 
	gv®ues
.
push
(
v®ue
);

504 
	gjsÚ
.
modify
(&
keys
, 
v®ues
, 
mt
)?;

505 
Ok
(
D©um
::
JsÚ
(
jsÚ
))

508 
â
 
ev®_jsÚ_»move
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

509 
Ët
 
chd»n
 = 
£lf
.
ev®_mÜe_chd»n
(
ùx
, 
ex´
, 2)?;

510 
	gchd»n
.
™”
().
ªy
(|
™em
| *™em =ğ
D©um
::
NuÎ
) {

511  
Ok
(
D©um
::
NuÎ
);

513 
Ët
 
mut
 
	gchd»n
 = 
chd»n
.
što_™”
();

514 
Ët
 
mut
 
	gjsÚ
 = 
chd»n
.
Ãxt
().
unw¿p
().
ÿ¡_as_jsÚ
()?;

515 
Ët
 
	g·th_exŒs
 = 
chd»n


516 .
m­
(|
™em
| i‹m.
to_jsÚ_·th_ex´
())

517 .
cŞËù
::<
»suÉ
::
ResuÉ
<
Vec
<
_
>, 
	g_
>>()?;

518 
	gjsÚ
.
»move
(&
·th_exŒs
)?;

519 
Ok
(
D©um
::
JsÚ
(
jsÚ
))

522 
â
 
ev®_jsÚ_unquÙe
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

523 
Ët
 
chd
 = 
£lf
.
ev®_Úe_chd
(
ùx
, 
ex´
)?;

524 
	gchd
 =ğ
D©um
::
NuÎ
 {

525  
Ok
(
D©um
::
NuÎ
);

534 
Ët
 
	gjsÚ
 = 
chd
.
što_jsÚ
()?;

535 
Ët
 
	gunquÙe_d©a
 = 
jsÚ
.
unquÙe
()?;

536 
Ok
(
D©um
::
By‹s
(
unquÙe_d©a
.
što_by‹s
()))

539 
â
 
ev®_jsÚ_exŒaù
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

540 
Ët
 
chd»n
 = 
£lf
.
ev®_mÜe_chd»n
(
ùx
, 
ex´
, 2)?;

541 
	gchd»n
.
™”
().
ªy
(|
™em
| *™em =ğ
D©um
::
NuÎ
) {

542  
Ok
(
D©um
::
NuÎ
);

544 
Ët
 
mut
 
	gchd»n
 = 
chd»n
.
što_™”
();

545 
Ët
 
	gjsÚ
 = 
chd»n
.
Ãxt
().
unw¿p
().
ÿ¡_as_jsÚ
()?;

546 
Ët
 
	g·th_exŒs
 = 
chd»n


547 .
m­
(|
™em
| i‹m.
to_jsÚ_·th_ex´
())

548 .
cŞËù
::<
»suÉ
::
ResuÉ
<
Vec
<
_
>, 
	g_
>>()?;

549 
Ët
 
Some
(
d©a
èğ
jsÚ
.
exŒaù
(&
·th_exŒs
) {

550 
Ok
(
D©um
::
JsÚ
(
d©a
))

552 
Ok
(
D©um
::
NuÎ
)

556 
â
 
ev®_jsÚ_ty³
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

557 
Ët
 
chd
 = 
£lf
.
ev®_Úe_chd
(
ùx
, 
ex´
)?;

558 
	gD©um
::
NuÎ
 =ğ
chd
 {

559  
Ok
(
D©um
::
NuÎ
);

561 
Ët
 
	gjsÚ
 = 
chd
.
ÿ¡_as_jsÚ
()?;

562 
Ët
 
	gjsÚ_ty³
 = 
jsÚ
.
jsÚ_ty³
().
to_vec
();

563 
Ok
(
D©um
::
By‹s
(
jsÚ_ty³
))

566 
â
 
ev®_jsÚ_m”ge
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

567 
Ët
 
chd»n
 = 
£lf
.
ev®_mÜe_chd»n
(
ùx
, 
ex´
, 2)?;

568 
	gchd»n
.
™”
().
ªy
(|
™em
| *™em =ğ
D©um
::
NuÎ
) {

569  
Ok
(
D©um
::
NuÎ
);

571 
Ët
 
mut
 
	gchd»n
 = 
chd»n
.
što_™”
();

572 
Ët
 
mut
 
	g»s
 = 
chd»n
.
Ãxt
().
unw¿p
().
ÿ¡_as_jsÚ
()?;

573 
™em
 
š
 
	gchd»n
 {

574 
Ët
 
	gj
 = 
™em
.
ÿ¡_as_jsÚ
()?;

575 
	g»s
 = 
»s
.
m”ge
(
j
);

577 
Ok
(
D©um
::
JsÚ
(
»s
))

580 
â
 
ev®_jsÚ_objeù
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

581 
Ët
 
chd»n
 = 
£lf
.
ev®_mÜe_chd»n
(
ùx
, 
ex´
, 0)?;

582 
Ët
 
	gobj
 = 
jsÚ_objeù
(
chd»n
)?;

583 
Ok
(
D©um
::
JsÚ
(
obj
))

586 
â
 
ev®_jsÚ_¬¿y
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

587 
Ët
 
chd»n
 = 
£lf
.
ev®_mÜe_chd»n
(
ùx
, 
ex´
, 0)?;

588 
Ët
 
	g¬r
 = 
jsÚ_¬¿y
(
chd»n
)?;

589 
Ok
(
D©um
::
JsÚ
(
¬r
))

592 
â
 
ev®_sÿÏr_funùiÚ
(&
mut
 
£lf
, 
ùx
: &
Ev®CÚ‹xt
, 
ex´
: &
Ex´
è-> 
ResuÉ
<
D©um
> {

593 
m©ch
 
ex´
.
g‘_sig
() {

594 
SÿÏrFuncSig
::
AbsIÁ
 => 
£lf
.
abs_št
(
ùx
, 
ex´
),

595 
	gSÿÏrFuncSig
::
AbsR—l
 => 
£lf
.
abs_»®
(
ùx
, 
ex´
),

596 
	gSÿÏrFuncSig
::
CeR—l
 => 
£lf
.
û_»®
(
ùx
, 
ex´
),

597 
	g_
 => 
E¼
(
E¼Ü
::
Ex´
(

598 
fÜm©
!("unsuµÜ‹d sÿÏ¸funùiÚ: {:?}", 
ex´
.
g‘_sig
()),

603 
â
 
	gev®_logic
<
	gF
>(

604 &
mut
 
	g£lf
,

605 
	gùx
: &
Ev®CÚ‹xt
,

606 
	gex´
: &
Ex´
,

607 
	gb»ak_»s
: 
O±iÚ
<
boŞ
>,

608 
	glogic_func
: 
F
,

609 è-> 
	gResuÉ
<
	gD©um
>

610 
wh”e


611 
	gF
: 
FnOnû
(
O±iÚ
<
boŞ
>, O±iÚ<boŞ>è-> 
	gD©um
,

613 
Ët
 (
Ëá_ex´
, 
right_ex´
èğ
£lf
.
g‘_two_chd»n
(
ex´
)?;

614 
Ët
 
	gËá_d©um
 = 
£lf
.
ev®
(
ùx
, 
Ëá_ex´
)?;

615 
Ët
 
	gËá
 = 
Ëá_d©um
.
što_boŞ
(
ùx
)?;

616 
	gËá
 =ğ
b»ak_»s
 {

617  
Ok
(
Ëá
.
što
());

619 
Ët
 
	gright_d©um
 = 
£lf
.
ev®
(
ùx
, 
right_ex´
)?;

620 
Ët
 
	gright
 = 
right_d©um
.
što_boŞ
(
ùx
)?;

621 
	gright
 =ğ
b»ak_»s
 {

622  
Ok
(
right
.
što
());

624 
Ok
(
logic_func
(
Ëá
, 
right
))

629 #[
šlše
]

630 
â
 
ev®_ªd
(
lhs
: 
O±iÚ
<
boŞ
>, 
rhs
: O±iÚ<boŞ>è-> 
D©um
 {

631 
m©ch
 (
lhs
, 
rhs
) {

632 (
Some
(
Œue
), SomeÑrue)è=>rue.
što
(),

633 
	g_
 => 
D©um
::
NuÎ
,

638 #[
šlše
]

639 
â
 
ev®_Ü
(
lhs
: 
O±iÚ
<
boŞ
>, 
rhs
: O±iÚ<boŞ>è-> 
D©um
 {

640 
m©ch
 (
lhs
, 
rhs
) {

641 (
Some
(
çl£
), Some(çl£)è=> f®£.
što
(),

642 
	g_
 => 
D©um
::
NuÎ
,

646 #[
šlše
]

647 
pub
 
â
 
	gev®_¬™h
<
	gF
>(
	gùx
: &
Ev®CÚ‹xt
, 
	gËá
: 
D©um
, 
	gright
: D©um, 
	gf
: 
F
è-> 
ResuÉ
<Datum>

648 
wh”e


649 
F
: 
FnOnû
(
D©um
, &
Ev®CÚ‹xt
, D©umè-> 
	gcodec
::
ResuÉ
<Datum>,

651 
Ët
 
	gËá
 = 
Ëá
.
što_¬™h
(
ùx
)?;

652 
Ët
 
	gright
 = 
right
.
što_¬™h
(
ùx
)?;

654 
Ët
 (
Ëá
, 
right
èğ
D©um
::
cÛrû
(left,„ight)?;

655 
	gËá
 =ğ
D©um
::
NuÎ
 || 
right
 == Datum::Null {

656  
Ok
(
D©um
::
NuÎ
);

659 
f
(
Ëá
, 
ùx
, 
right
).
m­_”r
(
From
::
äom
)

663 
â
 
check_š
(
ùx
: &
Ev®CÚ‹xt
, 
rg‘
: 
D©um
, 
v®ue_li¡
: &[D©um]è-> 
ResuÉ
<
boŞ
> {

664 
Ët
 
mut
 
”r
 = 
NÚe
;

665 
Ët
 
	gpos
 = 
v®ue_li¡
.
bš¬y_£¬ch_by
(|
d
| 
m©ch
 d.
cmp
(
ùx
, &
rg‘
) {

666 
Ok
(
Üd
) => ord,

667 
E¼
(
e
) => {

668 
”r
 = 
Some
(
e
);

669 
Ord”šg
::
Less


672 
Ët
 
Some
(
e
èğ
”r
 {

673  
E¼
(
e
.
što
());

675 
Ok
(
pos
.
is_ok
())

678 #[
cfg
(
‹¡
)]

679 
pub
 
mod
 
	g‹¡
 {

680 
u£
 
	gsu³r
::*;

681 
u£
 
	gut
::
codec
::
numb”
::{
£lf
, 
	gNumb”Encod”
};

682 
u£
 
	gcİroûssÜ
::
codec
::{
d©um
, 
	gmysql
, 
	gD©um
};

683 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::{
ch¬£t
, 
	gty³s
, 
	gDecim®
, 
	gDecim®Encod”
, 
	gDu¿tiÚ
, 
	gMAX_FSP
};

684 
u£
 
	gcİroûssÜ
::
codec
::
mysql
::
jsÚ
::
JsÚEncod”
;

685 
u£
 
	gtb
::
ex´essiÚ
::
F›ldTy³
;

687 
u£
 
	g¡d
::
i32
;

689 
u£
 
	gtb
::
ex´essiÚ
::{
Ex´
, 
	gEx´Ty³
};

690 
u£
 
	gtb
::
£Ëù
::
S–eùReque¡
;

691 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

693 
pub
 
â
 
d©um_ex´
(
d©um
: 
D©um
è-> 
Ex´
 {

694 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

695 
m©ch
 
	gd©um
 {

696 
	gD©um
::
I64
(
i
) => {

697 
ex´
.
£t_
(
Ex´Ty³
::
IÁ64
);

698 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(
numb”
::
I64_SIZE
);

699 
	gbuf
.
’code_i64
(
i
).
unw¿p
();

700 
	gex´
.
£t_v®
(
buf
);

702 
	gD©um
::
U64
(
u
) => {

703 
ex´
.
£t_
(
Ex´Ty³
::
Ušt64
);

704 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(
numb”
::
U64_SIZE
);

705 
	gbuf
.
’code_u64
(
u
).
unw¿p
();

706 
	gex´
.
£t_v®
(
buf
);

707 
	gex´
.
mut_f›ld_ty³
().
£t_æag
(
ty³s
::
UNSIGNED_FLAG
 
as
 
u32
);

709 
	gD©um
::
By‹s
(
bs
) => {

710 
ex´
.
£t_
(
Ex´Ty³
::
By‹s
);

711 
	gex´
.
£t_v®
(
bs
);

712 
	gex´
.
mut_f›ld_ty³
()

713 .
£t_ch¬£t
(
ch¬£t
::
CHARSET_UTF8
.
to_owÃd
());

715 
	gD©um
::
F64
(
f
) => {

716 
ex´
.
£t_
(
Ex´Ty³
::
Flßt64
);

717 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(
numb”
::
F64_SIZE
);

718 
	gbuf
.
’code_f64
(
f
).
unw¿p
();

719 
	gex´
.
£t_v®
(
buf
);

721 
	gD©um
::
Dur
(
d
) => {

722 
ex´
.
£t_
(
Ex´Ty³
::
MysqlDu¿tiÚ
);

723 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(
numb”
::
I64_SIZE
);

724 
	gbuf
.
’code_i64
(
d
.
to_Çnos
()).
unw¿p
();

725 
	gex´
.
£t_v®
(
buf
);

727 
	gD©um
::
Dec
(
d
) => {

728 
ex´
.
£t_
(
Ex´Ty³
::
MysqlDecim®
);

729 
Ët
 (
´ec
, 
äac
èğ
d
.
´ec_ªd_äac
();

730 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(
mysql
::
dec_’coded_Ën
(&[
´ec
, 
äac
]).
unw¿p
());

731 
	gbuf
.
’code_decim®
(&
d
, 
´ec
, 
äac
).
unw¿p
();

732 
	gex´
.
£t_v®
(
buf
);

734 
	gD©um
::
Time
(
t
) => {

735 
ex´
.
£t_
(
Ex´Ty³
::
MysqlTime
);

736 
Ët
 
mut
 
	gá
 = 
F›ldTy³
::
Ãw
();

737 
	gá
.
£t_
(
t
.
g‘_
(è
as
 
i32
);

738 
	gá
.
£t_decim®
(
t
.
g‘_f¥
(è
as
 
i32
);

739 
	gex´
.
£t_f›ld_ty³
(
á
);

740 
Ët
 
	gu
 = 
t
.
to_·cked_u64
();

741 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(
numb”
::
U64_SIZE
);

742 
	gbuf
.
’code_u64
(
u
).
unw¿p
();

743 
	gex´
.
£t_v®
(
buf
);

745 
	gD©um
::
JsÚ
(
j
) => {

746 
ex´
.
£t_
(
Ex´Ty³
::
MysqlJsÚ
);

747 
Ët
 
mut
 
	gbuf
 = 
Vec
::
Ãw
();

748 
	gbuf
.
’code_jsÚ
(&
j
).
unw¿p
();

749 
	gex´
.
£t_v®
(
buf
);

751 
	gD©um
::
NuÎ
 => 
ex´
.
£t_
(
Ex´Ty³
::Null),

752 
	gd
 => 
·nic
!("unsupport datum: {:?}", d),

754 
	gex´


757 
pub
 
â
 
cŞ_ex´
(
cŞ_id
: 
i64
è-> 
Ex´
 {

758 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

759 
	gex´
.
£t_
(
Ex´Ty³
::
CŞumnRef
);

760 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(8);

761 
	gbuf
.
’code_i64
(
cŞ_id
).
unw¿p
();

762 
	gex´
.
£t_v®
(
buf
);

763 
	gex´


766 
â
 
bš_ex´
(
Ëá
: 
D©um
, 
right
: D©um, 

: 
Ex´Ty³
è-> 
Ex´
 {

767 
bud_ex´
(
vec
![
Ëá
, 
right
], 

)

770 
pub
 
â
 
bud_ex´_w™h_sig
(
chd»n
: 
Vec
<
D©um
>, 

: 
Ex´Ty³
, 
sig
: 
SÿÏrFuncSig
è-> 
Ex´
 {

771 
Ët
 
mut
 
ex´
 = 
bud_ex´
(
chd»n
, 

);

772 
	gex´
.
£t_sig
(
sig
);

773 
	gex´


776 
â
 
bud_ex´
(
chd»n
: 
Vec
<
D©um
>, 

: 
Ex´Ty³
è-> 
Ex´
 {

777 
Ët
 
chd»n_ex´
 = 
chd»n
.
što_™”
().
m­
(
d©um_ex´
).
cŞËù
();

778 
bud_ex´_r
(
chd»n_ex´
, 

)

781 
â
 
bud_ex´_r
(
chd»n_ex´
: 
Vec
<
Ex´
>, 

: 
Ex´Ty³
) -> Expr {

782 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

783 
	gex´
.
£t_
(

);

784 
	gex´
.
£t_chd»n
(
R•—‹dF›ld
::
äom_vec
(
chd»n_ex´
));

785 
	gex´


788 
â
 
ÿ£_wh’
(
d©ums
: 
Vec
<
D©um
>è-> 
Ex´
 {

789 
bud_ex´
(
d©ums
, 
Ex´Ty³
::
Ca£
)

792 
â
 
cßËsû
(
d©ums
: 
Vec
<
D©um
>è-> 
Ex´
 {

793 
bud_ex´
(
d©ums
, 
Ex´Ty³
::
CßËsû
)

796 
â
 
nÙ_ex´
(
v®ue
: 
D©um
è-> 
Ex´
 {

797 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

798 
	gex´
.
£t_
(
Ex´Ty³
::
NÙ
);

799 
	gex´
.
mut_chd»n
().
push
(
d©um_ex´
(
v®ue
));

800 
	gex´


803 
â
 
like_ex´
(
rg‘
: &'¡©iø¡r,…©‹º: &'
¡r
è-> 
Ex´
 {

804 
Ët
 
rg‘_ex´
 = 
d©um_ex´
(
D©um
::
By‹s
(
rg‘
.
as_by‹s
().
to_vec
()));

805 
Ët
 
	g·‰”n_ex´
 = 
d©um_ex´
(
D©um
::
By‹s
(
·‰”n
.
as_by‹s
().
to_vec
()));

806 
Ët
 
mut
 
	gex´
 = 
Ex´
::
Ãw
();

807 
	gex´
.
£t_
(
Ex´Ty³
::
Like
);

808 
	gex´
.
mut_chd»n
().
push
(
rg‘_ex´
);

809 
	gex´
.
mut_chd»n
().
push
(
·‰”n_ex´
);

810 
	gex´


813 
	gmaüo_ruËs
! 
	g‹¡_ev®
 {

814 (
	g$g
:
id’t
, 
	g$ÿ£s
:
ex´
) => {

815 #[
‹¡
]

816 
â
 
$g
() {

817 
Ët
 
ÿ£s
 = 
$ÿ£s
;

819 
Ët
 
mut
 
	gxev®u©Ü
 = 
Ev®u©Ü
::();

820 
	gxev®u©Ü
.
	grow
.
š£¹
(1, 
D©um
::
I64
(100));

821 
	gex´
, 
	gexp
è
š
 
	gÿ£s
 {

822 
Ët
 
	g»s
 = 
xev®u©Ü
.
ev®
(&
DeçuÉ
::(), &
ex´
);

823 
	g»s
.
is_”r
() {

824 
	g·nic
!("çedØev® {:?}: {:?}", 
	gex´
, 
	g»s
);

826 
Ët
 
	g»s
 = 
»s
.
unw¿p
();

827 
	g»s
 !ğ
exp
 {

828 
·nic
!("çedØev® {:?}ƒx³ù {:?}, gÙ {:?}", 
ex´
, 
exp
, 
»s
);

835 
	gmaüo_ruËs
! 
	g‹¡_ev®_”r
 {

836 (
	g$g
:
id’t
, 
	g$ÿ£s
:
ex´
) => {

837 #[
‹¡
]

838 
â
 
$g
() {

839 
Ët
 
ÿ£s
 = 
$ÿ£s
;

841 
Ët
 
mut
 
	gxev®u©Ü
 = 
Ev®u©Ü
::();

842 
	gxev®u©Ü
.
	grow
.
š£¹
(1, 
D©um
::
I64
(100));

843 
ex´
 
š
 
	gÿ£s
 {

844 
Ët
 
	g»s
 = 
xev®u©Ü
.
ev®
(&
DeçuÉ
::(), &
ex´
);

845 
	gas£¹
!(
	g»s
.
is_”r
());

852 
	g‹¡_ev®
!(

853 
	g‹¡_ev®_d©um_cŞ
,

854 
	gvec
![

855 (
d©um_ex´
(
D©um
::
F64
(1.1)), Datum::F64(1.1)),

856 (
d©um_ex´
(
D©um
::
I64
(1)), Datum::I64(1)),

857 (
d©um_ex´
(
D©um
::
U64
(1)), Datum::U64(1)),

859 
d©um_ex´
(

860 
Time
::
·r£_utc_d©‘ime
("19910905111111", 0)

861 .
unw¿p
()

862 .
što
(),

864 
Time
::
·r£_utc_d©‘ime
("1991-09-05 11:11:11.001", 0)

865 .
unw¿p
()

866 .
što
(),

868 (
d©um_ex´
(
b
"abc".
as_»f
().
što
()), b"abc".as_ref().into()),

869 (
d©um_ex´
(
D©um
::
NuÎ
), Datum::Null),

871 
d©um_ex´
(
Du¿tiÚ
::
·r£
(
b
"01:00:00", 0).
unw¿p
().
što
()),

872 
Du¿tiÚ
::
äom_Çnos
(3600 * 1
_000_000_000
, 
MAX_FSP
)

873 .
unw¿p
()

874 .
što
(),

877 
d©um_ex´
(
D©um
::
Dec
("1.1".
·r£
().
unw¿p
())),

878 
D©um
::
Dec
(
Decim®
::
äom_f64
(1.1).
unw¿p
()),

880 (
cŞ_ex´
(1), 
D©um
::
I64
(100)),

884 
	g‹¡_ev®
!(

885 
	g‹¡_ev®_cmp
,

886 
	gvec
![

888 
bš_ex´
(

889 
Du¿tiÚ
::
·r£
(
b
"11:00:00", 0).
unw¿p
().
što
(),

890 
Du¿tiÚ
::
·r£
(
b
"00:00:00", 0).
unw¿p
().
što
(),

891 
Ex´Ty³
::
LT
,

893 
D©um
::
I64
(0),

896 
bš_ex´
(

897 
Du¿tiÚ
::
·r£
(
b
"11:00:00.233", 2).
unw¿p
().
što
(),

898 
Du¿tiÚ
::
·r£
(
b
"11:00:00.233", 0).
unw¿p
().
što
(),

899 
Ex´Ty³
::
EQ
,

901 
D©um
::
I64
(0),

904 
bš_ex´
(

905 
Du¿tiÚ
::
·r£
(
b
"11:00:00.233", 3).
unw¿p
().
što
(),

906 
Du¿tiÚ
::
·r£
(
b
"11:00:00.233", 4).
unw¿p
().
što
(),

907 
Ex´Ty³
::
EQ
,

909 
D©um
::
I64
(1),

912 
bš_ex´
(

913 
D©um
::
Dec
(
Decim®
::
äom_f64
(2.0).
unw¿p
()),

914 
D©um
::
Dec
(2u64.
što
()),

915 
Ex´Ty³
::
EQ
,

917 
D©um
::
I64
(1),

920 
bš_ex´
(
D©um
::
I64
(100), D©um::I64(1), 
Ex´Ty³
::
LT
),

921 
D©um
::
I64
(0),

924 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(100), 
Ex´Ty³
::
LT
),

925 
D©um
::
I64
(1),

928 
bš_ex´
(
D©um
::
I64
(100), D©um::
NuÎ
, 
Ex´Ty³
::
LT
),

929 
D©um
::
NuÎ
,

932 
bš_ex´
(
D©um
::
I64
(100), D©um::I64(1), 
Ex´Ty³
::
LE
),

933 
D©um
::
I64
(0),

936 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(1), 
Ex´Ty³
::
LE
),

937 
D©um
::
I64
(1),

940 
bš_ex´
(
D©um
::
I64
(100), D©um::
NuÎ
, 
Ex´Ty³
::
LE
),

941 
D©um
::
NuÎ
,

944 
bš_ex´
(
D©um
::
I64
(100), D©um::I64(1), 
Ex´Ty³
::
EQ
),

945 
D©um
::
I64
(0),

948 
bš_ex´
(
D©um
::
I64
(100), D©um::I64(100), 
Ex´Ty³
::
EQ
),

949 
D©um
::
I64
(1),

952 
bš_ex´
(
D©um
::
I64
(100), D©um::
NuÎ
, 
Ex´Ty³
::
EQ
),

953 
D©um
::
NuÎ
,

956 
bš_ex´
(
D©um
::
I64
(100), D©um::I64(100), 
Ex´Ty³
::
NE
),

957 
D©um
::
I64
(0),

960 
bš_ex´
(
D©um
::
I64
(100), D©um::I64(1), 
Ex´Ty³
::
NE
),

961 
D©um
::
I64
(1),

964 
bš_ex´
(
D©um
::
I64
(100), D©um::
NuÎ
, 
Ex´Ty³
::
NE
),

965 
D©um
::
NuÎ
,

968 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(100), 
Ex´Ty³
::
GE
),

969 
D©um
::
I64
(0),

972 
bš_ex´
(
D©um
::
I64
(100), D©um::I64(100), 
Ex´Ty³
::
GE
),

973 
D©um
::
I64
(1),

976 
bš_ex´
(
D©um
::
I64
(100), D©um::
NuÎ
, 
Ex´Ty³
::
GE
),

977 
D©um
::
NuÎ
,

980 
bš_ex´
(
D©um
::
I64
(100), D©um::I64(100), 
Ex´Ty³
::
GT
),

981 
D©um
::
I64
(0),

984 
bš_ex´
(
D©um
::
I64
(100), D©um::I64(1), 
Ex´Ty³
::
GT
),

985 
D©um
::
I64
(1),

988 
bš_ex´
(
D©um
::
I64
(100), D©um::
NuÎ
, 
Ex´Ty³
::
GT
),

989 
D©um
::
NuÎ
,

992 
bš_ex´
(
D©um
::
I64
(1), D©um::
NuÎ
, 
Ex´Ty³
::
NuÎEQ
),

993 
D©um
::
I64
(0),

996 
bš_ex´
(
D©um
::
NuÎ
, D©um::NuÎ, 
Ex´Ty³
::
NuÎEQ
),

997 
D©um
::
I64
(1),

1002 
	g‹¡_ev®
!(

1003 
	g‹¡_ev®_logic
,

1004 
	gvec
![

1006 
bš_ex´
(
D©um
::
I64
(0), D©um::I64(1), 
Ex´Ty³
::
And
),

1007 
D©um
::
I64
(0),

1010 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(1), 
Ex´Ty³
::
And
),

1011 
D©um
::
I64
(1),

1014 
bš_ex´
(
D©um
::
I64
(1), D©um::
NuÎ
, 
Ex´Ty³
::
And
),

1015 
D©um
::
NuÎ
,

1018 
bš_ex´
(
D©um
::
NuÎ
, D©um::
I64
(1), 
Ex´Ty³
::
And
),

1019 
D©um
::
NuÎ
,

1022 
bš_ex´
(
D©um
::
I64
(0), D©um::
NuÎ
, 
Ex´Ty³
::
And
),

1023 
D©um
::
I64
(0),

1026 
bš_ex´
(
D©um
::
NuÎ
, D©um::
I64
(0), 
Ex´Ty³
::
And
),

1027 
D©um
::
I64
(0),

1030 
bš_ex´
(

1031 
D©um
::
Dec
(
Decim®
::
äom_f64
(2.0).
unw¿p
()),

1032 
D©um
::
Dec
(0u64.
što
()),

1033 
Ex´Ty³
::
And
,

1035 
D©um
::
I64
(0),

1038 
bš_ex´
(
D©um
::
NuÎ
, D©um::NuÎ, 
Ex´Ty³
::
And
),

1039 
D©um
::
NuÎ
,

1042 
bš_ex´
(
D©um
::
I64
(0), D©um::I64(0), 
Ex´Ty³
::
Or
),

1043 
D©um
::
I64
(0),

1046 
bš_ex´
(
D©um
::
I64
(0), D©um::I64(1), 
Ex´Ty³
::
Or
),

1047 
D©um
::
I64
(1),

1050 
bš_ex´
(

1051 
D©um
::
Dec
(
Decim®
::
äom_f64
(2.0).
unw¿p
()),

1052 
D©um
::
Dec
(0u64.
što
()),

1053 
Ex´Ty³
::
Or
,

1055 
D©um
::
I64
(1),

1058 
bš_ex´
(
D©um
::
I64
(1), D©um::
NuÎ
, 
Ex´Ty³
::
Or
),

1059 
D©um
::
I64
(1),

1062 
bš_ex´
(
D©um
::
NuÎ
, D©um::
I64
(1), 
Ex´Ty³
::
Or
),

1063 
D©um
::
I64
(1),

1066 
bš_ex´
(
D©um
::
NuÎ
, D©um::NuÎ, 
Ex´Ty³
::
Or
),

1067 
D©um
::
NuÎ
,

1070 
bš_ex´
(
D©um
::
NuÎ
, D©um::
I64
(0), 
Ex´Ty³
::
Or
),

1071 
D©um
::
NuÎ
,

1074 
bš_ex´
(
D©um
::
I64
(0), D©um::
NuÎ
, 
Ex´Ty³
::
Or
),

1075 
D©um
::
NuÎ
,

1078 
bud_ex´_r
(

1079 
vec
![

1080 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(1), 
Ex´Ty³
::
EQ
),

1081 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(1), 
Ex´Ty³
::
EQ
),

1083 
Ex´Ty³
::
And
,

1085 
	gD©um
::
I64
(1),

1087 (
nÙ_ex´
(
D©um
::
I64
(1)), 
	gD©um
::I64(0)),

1088 (
nÙ_ex´
(
D©um
::
I64
(0)), 
	gD©um
::I64(1)),

1089 (
nÙ_ex´
(
D©um
::
NuÎ
), 
	gD©um
::Null),

1093 
	g‹¡_ev®
!(

1094 
	g‹¡_ev®_like
,

1095 
	gvec
![

1096 (
like_ex´
("a", ""), 
D©um
::
I64
(0)),

1097 (
like_ex´
("a", "a"), 
D©um
::
I64
(1)),

1098 (
like_ex´
("a", "b"), 
D©um
::
I64
(0)),

1099 (
like_ex´
("aAb", "AaB"), 
D©um
::
I64
(1)),

1100 (
like_ex´
("a", "%"), 
D©um
::
I64
(1)),

1101 (
like_ex´
("aAD", "%d"), 
D©um
::
I64
(1)),

1102 (
like_ex´
("aAeD", "%e"), 
D©um
::
I64
(0)),

1103 (
like_ex´
("aAb", "Aa%"), 
D©um
::
I64
(1)),

1104 (
like_ex´
("abAb", "Aa%"), 
D©um
::
I64
(0)),

1105 (
like_ex´
("aAcb", "%C%"), 
D©um
::
I64
(1)),

1106 (
like_ex´
("aAb", "%C%"), 
D©um
::
I64
(0)),

1108 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(1), 
Ex´Ty³
::
Like
),

1109 
D©um
::
I64
(1),

1112 
bš_ex´
(
D©um
::
U64
(1), D©um::U64(1), 
Ex´Ty³
::
Like
),

1113 
D©um
::
I64
(1),

1116 
bš_ex´
(
D©um
::
F64
(1.0), D©um::F64(1.0), 
Ex´Ty³
::
Like
),

1117 
D©um
::
I64
(1),

1120 
bš_ex´
(

1121 
Du¿tiÚ
::
·r£
(
b
"11:00:00", 0).
unw¿p
().
što
(),

1122 
Du¿tiÚ
::
·r£
(
b
"11:00:00", 0).
unw¿p
().
što
(),

1123 
Ex´Ty³
::
Like
,

1125 
D©um
::
I64
(1),

1131 
	g‹¡_ev®
!(

1132 
	g‹¡_ev®_¶us
,

1133 
	gvec
![

1135 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(1), 
Ex´Ty³
::
Plus
),

1136 
D©um
::
I64
(2),

1139 
bš_ex´
(
D©um
::
I64
(1), D©um::
U64
(1), 
Ex´Ty³
::
Plus
),

1140 
D©um
::
U64
(2),

1143 
bš_ex´
(
D©um
::
I64
(1), D©um::
By‹s
(
b
"1".
to_vec
()), 
Ex´Ty³
::
Plus
),

1144 
D©um
::
F64
(2.0),

1147 
bš_ex´
(
D©um
::
I64
(1), D©um::
By‹s
(
b
"-1".
to_vec
()), 
Ex´Ty³
::
Plus
),

1148 
D©um
::
F64
(0.0),

1151 
bš_ex´
(
D©um
::
NuÎ
, D©um::NuÎ, 
Ex´Ty³
::
Plus
),

1152 
D©um
::
NuÎ
,

1155 
bš_ex´
(
D©um
::
I64
(-1), D©um::
NuÎ
, 
Ex´Ty³
::
Plus
),

1156 
D©um
::
NuÎ
,

1159 
bš_ex´
(
D©um
::
NuÎ
, D©um::
I64
(-1), 
Ex´Ty³
::
Plus
),

1160 
D©um
::
NuÎ
,

1163 
bš_ex´
(
D©um
::
I64
(-1), D©um::
U64
(1), 
Ex´Ty³
::
Plus
),

1164 
D©um
::
U64
(0),

1167 
bš_ex´
(

1168 
D©um
::
I64
(
i64
::
mš_v®ue
()),

1169 
D©um
::
U64
(
i64
::
max_v®ue
(è
as
 
u64
 + 1),

1170 
Ex´Ty³
::
Plus
,

1172 
D©um
::
U64
(0),

1175 
bš_ex´
(
D©um
::
F64
(2.0), D©um::
I64
(-1), 
Ex´Ty³
::
Plus
),

1176 
D©um
::
F64
(1.0),

1179 
bš_ex´
(
D©um
::
F64
(2.0), D©um::
U64
(1), 
Ex´Ty³
::
Plus
),

1180 
D©um
::
F64
(3.0),

1183 
bš_ex´
(

1184 
D©um
::
Dec
("3.3".
·r£
().
unw¿p
()),

1185 
D©um
::
I64
(-1),

1186 
Ex´Ty³
::
Plus
,

1188 
D©um
::
Dec
("2.3".
·r£
().
unw¿p
()),

1191 
bš_ex´
(

1192 
D©um
::
F64
(2.0),

1193 
D©um
::
Dec
("3.3".
·r£
().
unw¿p
()),

1194 
Ex´Ty³
::
Plus
,

1196 
D©um
::
F64
(5.3),

1199 
bš_ex´
(

1200 
D©um
::
Dec
("3.3".
·r£
().
unw¿p
()),

1201 
b
"2.0".
as_»f
().
što
(),

1202 
Ex´Ty³
::
Plus
,

1204 
D©um
::
F64
(5.3),

1207 
bš_ex´
(

1208 
D©um
::
I64
(2),

1209 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"21 00:02", 0).
unw¿p
()),

1210 
Ex´Ty³
::
Plus
,

1212 
D©um
::
Dec
(
Decim®
::
äom_f64
(5040202.000000).
unw¿p
()),

1215 
bš_ex´
(

1216 
D©um
::
I64
(2),

1217 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"21 00:02:00.321", 2).
unw¿p
()),

1218 
Ex´Ty³
::
Plus
,

1220 
D©um
::
Dec
(
Decim®
::
äom_f64
(5040202.32).
unw¿p
()),

1225 
	g‹¡_ev®
!(

1226 
	g‹¡_ev®_div
,

1227 
	gvec
![

1229 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(1), 
Ex´Ty³
::
Div
),

1230 
D©um
::
Dec
(1.
što
()),

1233 
bš_ex´
(
D©um
::
I64
(1), D©um::
U64
(1), 
Ex´Ty³
::
Div
),

1234 
D©um
::
Dec
(1.
što
()),

1237 
bš_ex´
(
D©um
::
I64
(1), D©um::
By‹s
(
b
"1".
to_vec
()), 
Ex´Ty³
::
Div
),

1238 
D©um
::
F64
(1f64),

1241 
bš_ex´
(
D©um
::
I64
(1), D©um::
By‹s
(
b
"-1".
to_vec
()), 
Ex´Ty³
::
Div
),

1242 
D©um
::
F64
(-1f64),

1245 
bš_ex´
(
D©um
::
NuÎ
, D©um::NuÎ, 
Ex´Ty³
::
Div
),

1246 
D©um
::
NuÎ
,

1249 
bš_ex´
(
D©um
::
I64
(-1), D©um::
NuÎ
, 
Ex´Ty³
::
Div
),

1250 
D©um
::
NuÎ
,

1253 
bš_ex´
(
D©um
::
NuÎ
, D©um::
I64
(-1), 
Ex´Ty³
::
Div
),

1254 
D©um
::
NuÎ
,

1257 
bš_ex´
(
D©um
::
I64
(-1), D©um::
U64
(1), 
Ex´Ty³
::
Div
),

1258 
D©um
::
Dec
((-1).
što
()),

1261 
bš_ex´
(

1262 
D©um
::
I64
(
i64
::
mš_v®ue
()),

1263 
D©um
::
U64
(
i64
::
max_v®ue
(è
as
 
u64
 + 1),

1264 
Ex´Ty³
::
Div
,

1266 
D©um
::
Dec
((-1).
što
()),

1269 
bš_ex´
(
D©um
::
F64
(2.0), D©um::
I64
(-1), 
Ex´Ty³
::
Div
),

1270 
D©um
::
F64
(-2.0),

1273 
bš_ex´
(
D©um
::
F64
(2.0), D©um::
U64
(1), 
Ex´Ty³
::
Div
),

1274 
D©um
::
F64
(2.0),

1277 
bš_ex´
(

1278 
D©um
::
F64
(2.0),

1279 
D©um
::
Dec
("0.3".
·r£
().
unw¿p
()),

1280 
Ex´Ty³
::
Div
,

1282 
D©um
::
F64
(6.666666666666667),

1285 
bš_ex´
(

1286 
D©um
::
F64
(2.0),

1287 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"1 00:02", 0).
unw¿p
()),

1288 
Ex´Ty³
::
Div
,

1290 
D©um
::
F64
(0.00000832639467110741),

1293 
bš_ex´
(

1294 
D©um
::
Dec
("3.3".
·r£
().
unw¿p
()),

1295 
D©um
::
I64
(-1),

1296 
Ex´Ty³
::
Div
,

1298 
D©um
::
Dec
("-3.3".
·r£
().
unw¿p
()),

1301 
bš_ex´
(

1302 
D©um
::
I64
(2000),

1303 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"1 00:02", 0).
unw¿p
()),

1304 
Ex´Ty³
::
Div
,

1306 
D©um
::
Dec
("0.008326394671107410".
·r£
().
unw¿p
()),

1309 
bš_ex´
(

1310 
D©um
::
I64
(2000),

1311 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"00:02:00.321", 2).
unw¿p
()),

1312 
Ex´Ty³
::
Div
,

1314 
D©um
::
Dec
("9.984025559105431309".
·r£
().
unw¿p
()),

1319 
	g‹¡_ev®
!(

1320 
	g‹¡_ev®_mšus
,

1321 
	gvec
![

1323 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(1), 
Ex´Ty³
::
Mšus
),

1324 
D©um
::
I64
(0),

1327 
bš_ex´
(
D©um
::
I64
(1), D©um::
U64
(1), 
Ex´Ty³
::
Mšus
),

1328 
D©um
::
U64
(0),

1331 
bš_ex´
(
D©um
::
U64
(1), D©um::
I64
(-1), 
Ex´Ty³
::
Mšus
),

1332 
D©um
::
U64
(2),

1335 
bš_ex´
(
D©um
::
U64
(1), D©um::U64(1), 
Ex´Ty³
::
Mšus
),

1336 
D©um
::
U64
(0),

1339 
bš_ex´
(
D©um
::
I64
(1), D©um::
By‹s
(
b
"1".
to_vec
()), 
Ex´Ty³
::
Mšus
),

1340 
D©um
::
F64
(0.0),

1343 
bš_ex´
(
D©um
::
I64
(1), D©um::
By‹s
(
b
"-1".
to_vec
()), 
Ex´Ty³
::
Mšus
),

1344 
D©um
::
F64
(2.0),

1347 
bš_ex´
(
D©um
::
NuÎ
, D©um::NuÎ, 
Ex´Ty³
::
Mšus
),

1348 
D©um
::
NuÎ
,

1351 
bš_ex´
(
D©um
::
I64
(-1), D©um::
NuÎ
, 
Ex´Ty³
::
Mšus
),

1352 
D©um
::
NuÎ
,

1355 
bš_ex´
(
D©um
::
U64
(1), D©um::
I64
(
i64
::
mš_v®ue
()), 
Ex´Ty³
::
Mšus
),

1356 
D©um
::
U64
(
i64
::
max_v®ue
(è
as
 
u64
 + 2),

1359 
bš_ex´
(
D©um
::
NuÎ
, D©um::
I64
(-1), 
Ex´Ty³
::
Mšus
),

1360 
D©um
::
NuÎ
,

1363 
bš_ex´
(
D©um
::
F64
(2.0), D©um::
I64
(-1), 
Ex´Ty³
::
Mšus
),

1364 
D©um
::
F64
(3.0),

1367 
bš_ex´
(
D©um
::
F64
(2.0), D©um::
U64
(1), 
Ex´Ty³
::
Mšus
),

1368 
D©um
::
F64
(1.0),

1371 
bš_ex´
(

1372 
D©um
::
F64
(2.0),

1373 
D©um
::
Dec
("0.3".
·r£
().
unw¿p
()),

1374 
Ex´Ty³
::
Mšus
,

1376 
D©um
::
F64
(1.7),

1379 
bš_ex´
(

1380 
D©um
::
F64
(2.0),

1381 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"1 00:02", 0).
unw¿p
()),

1382 
Ex´Ty³
::
Mšus
,

1384 
D©um
::
F64
(-240198.0),

1387 
bš_ex´
(

1388 
D©um
::
Dec
("3.3".
·r£
().
unw¿p
()),

1389 
D©um
::
I64
(-1),

1390 
Ex´Ty³
::
Mšus
,

1392 
D©um
::
Dec
("4.3".
·r£
().
unw¿p
()),

1395 
bš_ex´
(

1396 
D©um
::
I64
(2000),

1397 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"1 00:02", 0).
unw¿p
()),

1398 
Ex´Ty³
::
Mšus
,

1400 
D©um
::
Dec
("-238200".
·r£
().
unw¿p
()),

1403 
bš_ex´
(

1404 
D©um
::
I64
(2000),

1405 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"00:02:00.321", 2).
unw¿p
()),

1406 
Ex´Ty³
::
Mšus
,

1408 
D©um
::
Dec
("1799.680000".
·r£
().
unw¿p
()),

1413 
	g‹¡_ev®
!(

1414 
	g‹¡_ev®_mul
,

1415 
	gvec
![

1417 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(1), 
Ex´Ty³
::
Mul
),

1418 
D©um
::
I64
(1),

1421 
bš_ex´
(
D©um
::
I64
(1), D©um::
U64
(1), 
Ex´Ty³
::
Mul
),

1422 
D©um
::
U64
(1),

1425 
bš_ex´
(
D©um
::
I64
(1), D©um::
By‹s
(
b
"1".
to_vec
()), 
Ex´Ty³
::
Mul
),

1426 
D©um
::
F64
(1f64),

1429 
bš_ex´
(
D©um
::
I64
(1), D©um::
By‹s
(
b
"-1".
to_vec
()), 
Ex´Ty³
::
Mul
),

1430 
D©um
::
F64
(-1f64),

1433 
bš_ex´
(
D©um
::
NuÎ
, D©um::NuÎ, 
Ex´Ty³
::
Mul
),

1434 
D©um
::
NuÎ
,

1437 
bš_ex´
(
D©um
::
I64
(-1), D©um::
NuÎ
, 
Ex´Ty³
::
Mul
),

1438 
D©um
::
NuÎ
,

1441 
bš_ex´
(
D©um
::
NuÎ
, D©um::
I64
(-1), 
Ex´Ty³
::
Mul
),

1442 
D©um
::
NuÎ
,

1445 
bš_ex´
(
D©um
::
I64
(-1), D©um::I64(1), 
Ex´Ty³
::
Mul
),

1446 
D©um
::
I64
((-1).
što
()),

1449 
bš_ex´
(
D©um
::
F64
(2.0), D©um::
I64
(-1), 
Ex´Ty³
::
Mul
),

1450 
D©um
::
F64
(-2.0),

1453 
bš_ex´
(
D©um
::
F64
(2.0), D©um::
U64
(1), 
Ex´Ty³
::
Mul
),

1454 
D©um
::
F64
(2.0),

1457 
bš_ex´
(

1458 
D©um
::
F64
(2.0),

1459 
D©um
::
Dec
("0.3".
·r£
().
unw¿p
()),

1460 
Ex´Ty³
::
Mul
,

1462 
D©um
::
F64
(0.6),

1465 
bš_ex´
(

1466 
D©um
::
F64
(2.0),

1467 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"1 00:02", 0).
unw¿p
()),

1468 
Ex´Ty³
::
Mul
,

1470 
D©um
::
F64
(480400.0),

1473 
bš_ex´
(

1474 
D©um
::
Dec
("3.3".
·r£
().
unw¿p
()),

1475 
D©um
::
I64
(-1),

1476 
Ex´Ty³
::
Mul
,

1478 
D©um
::
Dec
("-3.3".
·r£
().
unw¿p
()),

1481 
bš_ex´
(

1482 
D©um
::
I64
(2000),

1483 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"1 00:02", 0).
unw¿p
()),

1484 
Ex´Ty³
::
Mul
,

1486 
D©um
::
Dec
("480400000".
·r£
().
unw¿p
()),

1489 
bš_ex´
(

1490 
D©um
::
I64
(2000),

1491 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"00:02:00.321", 2).
unw¿p
()),

1492 
Ex´Ty³
::
Mul
,

1494 
D©um
::
Dec
("400640".
·r£
().
unw¿p
()),

1499 
	g‹¡_ev®
!(

1500 
	g‹¡_ev®_št_div
,

1501 
	gvec
![

1503 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(1), 
Ex´Ty³
::
IÁDiv
),

1504 
D©um
::
I64
(1),

1507 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(0), 
Ex´Ty³
::
IÁDiv
),

1508 
D©um
::
NuÎ
,

1511 
bš_ex´
(
D©um
::
I64
(1), D©um::
U64
(1), 
Ex´Ty³
::
IÁDiv
),

1512 
D©um
::
U64
(1),

1515 
bš_ex´
(
D©um
::
I64
(1), D©um::
U64
(0), 
Ex´Ty³
::
IÁDiv
),

1516 
D©um
::
NuÎ
,

1519 
bš_ex´
(
D©um
::
I64
(1), D©um::
By‹s
(
b
"1".
to_vec
()), 
Ex´Ty³
::
IÁDiv
),

1520 
D©um
::
I64
(1),

1523 
bš_ex´
(

1524 
D©um
::
I64
(1),

1525 
D©um
::
By‹s
(
b
"-1".
to_vec
()),

1526 
Ex´Ty³
::
IÁDiv
,

1528 
D©um
::
I64
(-1),

1531 
bš_ex´
(
D©um
::
I64
(1), D©um::
By‹s
(
b
"0".
to_vec
()), 
Ex´Ty³
::
IÁDiv
),

1532 
D©um
::
NuÎ
,

1535 
bš_ex´
(
D©um
::
NuÎ
, D©um::NuÎ, 
Ex´Ty³
::
IÁDiv
),

1536 
D©um
::
NuÎ
,

1539 
bš_ex´
(
D©um
::
I64
(-1), D©um::
NuÎ
, 
Ex´Ty³
::
IÁDiv
),

1540 
D©um
::
NuÎ
,

1543 
bš_ex´
(
D©um
::
NuÎ
, D©um::
I64
(-1), 
Ex´Ty³
::
IÁDiv
),

1544 
D©um
::
NuÎ
,

1547 
bš_ex´
(

1548 
D©um
::
I64
(
i64
::
mš_v®ue
()),

1549 
D©um
::
U64
(
i64
::
max_v®ue
(è
as
 
u64
 + 2),

1550 
Ex´Ty³
::
IÁDiv
,

1552 
D©um
::
U64
(0),

1555 
bš_ex´
(
D©um
::
F64
(2.0), D©um::
I64
(-1), 
Ex´Ty³
::
IÁDiv
),

1556 
D©um
::
I64
(-2),

1559 
bš_ex´
(
D©um
::
F64
(2.0), D©um::
U64
(1), 
Ex´Ty³
::
IÁDiv
),

1560 
D©um
::
I64
(2),

1563 
bš_ex´
(

1564 
D©um
::
I64
(2),

1565 
D©um
::
Dec
("0.3".
·r£
().
unw¿p
()),

1566 
Ex´Ty³
::
IÁDiv
,

1568 
D©um
::
I64
(6),

1571 
bš_ex´
(

1572 
D©um
::
F64
(2.0),

1573 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"1 00:02", 0).
unw¿p
()),

1574 
Ex´Ty³
::
IÁDiv
,

1576 
D©um
::
I64
(0),

1579 
bš_ex´
(

1580 
D©um
::
Dec
("3.3".
·r£
().
unw¿p
()),

1581 
D©um
::
I64
(-1),

1582 
Ex´Ty³
::
IÁDiv
,

1584 
D©um
::
I64
(-3),

1587 
bš_ex´
(

1588 
D©um
::
I64
(2000),

1589 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"1 00:02", 0).
unw¿p
()),

1590 
Ex´Ty³
::
IÁDiv
,

1592 
D©um
::
I64
(0),

1595 
bš_ex´
(

1596 
D©um
::
I64
(2000),

1597 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"00:02:00.321", 2).
unw¿p
()),

1598 
Ex´Ty³
::
IÁDiv
,

1600 
D©um
::
I64
(9),

1605 
	g‹¡_ev®
!(

1606 
	g‹¡_ev®_»m
,

1607 
	gvec
![

1609 
bš_ex´
(
D©um
::
I64
(3), D©um::I64(1), 
Ex´Ty³
::
Mod
),

1610 
D©um
::
I64
(0),

1613 
bš_ex´
(
D©um
::
I64
(3), D©um::I64(2), 
Ex´Ty³
::
Mod
),

1614 
D©um
::
I64
(1),

1617 
bš_ex´
(
D©um
::
I64
(1), D©um::I64(0), 
Ex´Ty³
::
Mod
),

1618 
D©um
::
NuÎ
,

1621 
bš_ex´
(
D©um
::
I64
(3), D©um::
U64
(2), 
Ex´Ty³
::
Mod
),

1622 
D©um
::
I64
(1),

1625 
bš_ex´
(
D©um
::
I64
(1), D©um::
U64
(0), 
Ex´Ty³
::
Mod
),

1626 
D©um
::
NuÎ
,

1629 
bš_ex´
(
D©um
::
I64
(3), D©um::
By‹s
(
b
"2".
to_vec
()), 
Ex´Ty³
::
Mod
),

1630 
D©um
::
F64
(1.0),

1633 
bš_ex´
(
D©um
::
I64
(3), D©um::
By‹s
(
b
"-2".
to_vec
()), 
Ex´Ty³
::
Mod
),

1634 
D©um
::
F64
(1.0),

1637 
bš_ex´
(
D©um
::
NuÎ
, D©um::NuÎ, 
Ex´Ty³
::
Mod
),

1638 
D©um
::
NuÎ
,

1641 
bš_ex´
(
D©um
::
I64
(-1), D©um::
NuÎ
, 
Ex´Ty³
::
Mod
),

1642 
D©um
::
NuÎ
,

1645 
bš_ex´
(
D©um
::
NuÎ
, D©um::
I64
(-1), 
Ex´Ty³
::
Mod
),

1646 
D©um
::
NuÎ
,

1649 
bš_ex´
(
D©um
::
I64
(-1), D©um::
U64
(2), 
Ex´Ty³
::
Mod
),

1650 
D©um
::
I64
((-1).
što
()),

1653 
bš_ex´
(

1654 
D©um
::
I64
(
i64
::
mš_v®ue
()),

1655 
D©um
::
U64
(
i64
::
max_v®ue
(è
as
 
u64
),

1656 
Ex´Ty³
::
Mod
,

1658 
D©um
::
I64
(-1),

1661 
bš_ex´
(

1662 
D©um
::
U64
(
i64
::
max_v®ue
(è
as
 
u64
),

1663 
D©um
::
I64
(
i64
::
mš_v®ue
()),

1664 
Ex´Ty³
::
Mod
,

1666 
D©um
::
U64
(
i64
::
max_v®ue
(è
as
 
u64
),

1669 
bš_ex´
(
D©um
::
F64
(3.2), D©um::
I64
(2), 
Ex´Ty³
::
Mod
),

1670 
D©um
::
F64
(1.2000000000000002),

1673 
bš_ex´
(
D©um
::
F64
(-3.2), D©um::
I64
(2), 
Ex´Ty³
::
Mod
),

1674 
D©um
::
F64
(-1.2000000000000002),

1677 
bš_ex´
(

1678 
D©um
::
F64
(2.0),

1679 
D©um
::
Dec
("0.3".
·r£
().
unw¿p
()),

1680 
Ex´Ty³
::
Mod
,

1682 
D©um
::
F64
(0.20000000000000007),

1685 
bš_ex´
(

1686 
D©um
::
F64
(2.0),

1687 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"1 00:02", 0).
unw¿p
()),

1688 
Ex´Ty³
::
Mod
,

1690 
D©um
::
F64
(2.0),

1693 
bš_ex´
(

1694 
D©um
::
Dec
("3.3".
·r£
().
unw¿p
()),

1695 
D©um
::
I64
(-1),

1696 
Ex´Ty³
::
Mod
,

1698 
D©um
::
Dec
("0.3".
·r£
().
unw¿p
()),

1701 
bš_ex´
(

1702 
D©um
::
I64
(2000),

1703 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"1 00:02", 0).
unw¿p
()),

1704 
Ex´Ty³
::
Mod
,

1706 
D©um
::
Dec
("2000".
·r£
().
unw¿p
()),

1709 
bš_ex´
(

1710 
D©um
::
I64
(2000),

1711 
D©um
::
Dur
(
Du¿tiÚ
::
·r£
(
b
"00:02:00.321", 2).
unw¿p
()),

1712 
Ex´Ty³
::
Mod
,

1714 
D©um
::
Dec
("197.12".
·r£
().
unw¿p
()),

1719 
	g‹¡_ev®
!(

1720 
	g‹¡_ev®_ÿ£_wh’
,

1721 
	gvec
![

1723 
ÿ£_wh’
(
vec
![

1724 
D©um
::
I64
(0),

1725 
b
"ÿ£1".
as_»f
().
što
(),

1726 
D©um
::
I64
(1),

1727 
b
"ÿ£2".
as_»f
().
što
(),

1728 
D©um
::
I64
(1),

1729 
b
"ÿ£3".
as_»f
().
što
(),

1731 
	gb
"ÿ£2".
as_»f
().
što
(),

1734 
ÿ£_wh’
(
vec
![

1735 
D©um
::
I64
(0),

1736 
b
"ÿ£1".
as_»f
().
što
(),

1737 
D©um
::
I64
(0),

1738 
b
"ÿ£2".
as_»f
().
što
(),

1739 
D©um
::
I64
(0),

1740 
b
"ÿ£3".
as_»f
().
što
(),

1741 
b
"–£".
as_»f
().
što
(),

1743 
	gb
"–£".
as_»f
().
što
(),

1746 
ÿ£_wh’
(
vec
![

1747 
D©um
::
I64
(0),

1748 
b
"ÿ£1".
as_»f
().
što
(),

1749 
D©um
::
I64
(0),

1750 
b
"ÿ£2".
as_»f
().
što
(),

1751 
D©um
::
I64
(0),

1752 
b
"ÿ£3".
as_»f
().
što
(),

1754 
	gD©um
::
NuÎ
,

1757 
bud_ex´_r
(

1758 
vec
![

1759 
ÿ£_wh’
(
vec
![

1760 
D©um
::
I64
(0),

1761 
D©um
::
I64
(0),

1762 
D©um
::
I64
(1),

1763 
D©um
::
I64
(1),

1765 
d©um_ex´
(
b
"Ã¡ed ca£ wh’".
as_»f
().
što
()),

1766 
d©um_ex´
(
D©um
::
I64
(0)),

1767 
d©um_ex´
(
b
"ÿ£1".
as_»f
().
što
()),

1768 
d©um_ex´
(
D©um
::
I64
(1)),

1769 
d©um_ex´
(
b
"ÿ£2".
as_»f
().
što
()),

1770 
d©um_ex´
(
D©um
::
I64
(1)),

1771 
d©um_ex´
(
b
"ÿ£3".
as_»f
().
što
()),

1773 
Ex´Ty³
::
Ca£
,

1775 
	gb
"Ã¡ed ca£ wh’".
as_»f
().
što
(),

1778 
ÿ£_wh’
(
vec
![

1779 
D©um
::
NuÎ
,

1780 
b
"ÿ£1".
as_»f
().
što
(),

1781 
D©um
::
I64
(0),

1782 
b
"ÿ£2".
as_»f
().
što
(),

1783 
D©um
::
I64
(1),

1784 
b
"ÿ£3".
as_»f
().
što
(),

1786 
	gb
"ÿ£3".
as_»f
().
što
(),

1791 
	g‹¡_ev®
!(

1792 
	g‹¡_ev®_if
,

1793 
	gvec
![

1795 
bud_ex´
(

1796 
vec
![

1797 
Œue
.
što
(),

1798 
b
"ex´1".
as_»f
().
što
(),

1799 
b
"ex´2".
as_»f
().
što
(),

1801 
Ex´Ty³
::
If
,

1803 
	gb
"ex´1".
as_»f
().
što
(),

1806 
bud_ex´
(

1807 
vec
![

1808 
çl£
.
što
(),

1809 
b
"ex´1".
as_»f
().
što
(),

1810 
b
"ex´2".
as_»f
().
što
(),

1812 
Ex´Ty³
::
If
,

1814 
	gb
"ex´2".
as_»f
().
što
(),

1817 
bud_ex´
(

1818 
vec
![

1819 
D©um
::
NuÎ
,

1820 
b
"ex´1".
as_»f
().
što
(),

1821 
b
"ex´2".
as_»f
().
što
(),

1823 
Ex´Ty³
::
If
,

1825 
	gb
"ex´2".
as_»f
().
što
(),

1828 
bud_ex´
(

1829 
vec
![
Œue
.
što
(), 
D©um
::
NuÎ
, 
b
"ex´2".
as_»f
().into()],

1830 
Ex´Ty³
::
If
,

1832 
	gD©um
::
NuÎ
,

1835 
bud_ex´
(

1836 
vec
![
çl£
.
što
(), 
b
"ex´1".
as_»f
().što(), 
D©um
::
NuÎ
],

1837 
Ex´Ty³
::
If
,

1839 
	gD©um
::
NuÎ
,

1842 
bud_ex´_r
(

1843 
vec
![

1844 
bud_ex´
(
vec
![
Œue
.
što
(), 
D©um
::
NuÎ
,rue.što()], 
Ex´Ty³
::
If
),

1845 
bud_ex´
(

1846 
vec
![

1847 
Œue
.
što
(),

1848 
b
"ex´1".
as_»f
().
što
(),

1849 
b
"ex´2".
as_»f
().
što
(),

1851 
Ex´Ty³
::
If
,

1853 
bud_ex´
(

1854 
vec
![

1855 
çl£
.
što
(),

1856 
b
"ex´1".
as_»f
().
što
(),

1857 
b
"ex´2".
as_»f
().
što
(),

1859 
Ex´Ty³
::
If
,

1862 
Ex´Ty³
::
If
,

1864 
	gb
"ex´2".
as_»f
().
što
(),

1869 
	g‹¡_ev®
!(

1870 
	g‹¡_ev®_cßËsû
,

1871 
	gvec
![

1873 
cßËsû
(
vec
![
D©um
::
NuÎ
, Datum::Null, Datum::Null]),

1874 
	gD©um
::
NuÎ
,

1877 
cßËsû
(
vec
![
D©um
::
NuÎ
, 
b
"nÙ-nuÎ".
as_»f
().
što
(), Datum::Null]),

1878 
	gb
"nÙ-nuÎ".
as_»f
().
što
(),

1881 
cßËsû
(
vec
![

1882 
D©um
::
NuÎ
,

1883 
b
"nÙ-nuÎ".
as_»f
().
što
(),

1884 
b
"nÙ-nuÎ-2".
as_»f
().
što
(),

1885 
D©um
::
NuÎ
,

1887 
	gb
"nÙ-nuÎ".
as_»f
().
što
(),

1892 
	g‹¡_ev®
!(

1893 
	g‹¡_ev®_if_nuÎ
,

1894 
	gvec
![

1896 
bud_ex´
(

1897 
vec
![
D©um
::
NuÎ
, 
b
"right".
as_»f
().
što
()],

1898 
Ex´Ty³
::
IfNuÎ
,

1900 
	gb
"right".
as_»f
().
što
(),

1903 
bud_ex´
(

1904 
vec
![
b
"Ëá".
as_»f
().
što
(), b"right".as_ref().into()],

1905 
Ex´Ty³
::
IfNuÎ
,

1907 
	gb
"Ëá".
as_»f
().
što
(),

1910 
bud_ex´
(
vec
![
b
"Ëá".
as_»f
().
što
(), 
D©um
::
NuÎ
], 
Ex´Ty³
::
IfNuÎ
),

1911 
	gb
"Ëá".
as_»f
().
što
(),

1914 
bud_ex´
(
vec
![
D©um
::
NuÎ
, D©um::NuÎ], 
Ex´Ty³
::
IfNuÎ
),

1915 
	gD©um
::
NuÎ
,

1920 
	g‹¡_ev®
!(

1921 
	g‹¡_ev®_is_nuÎ
,

1922 
	gvec
![

1924 
bud_ex´
(
vec
![
b
"abc".
as_»f
().
što
()], 
Ex´Ty³
::
IsNuÎ
),

1925 
	gçl£
.
što
(),

1927 (
bud_ex´
(
vec
![
D©um
::
NuÎ
], 
Ex´Ty³
::
IsNuÎ
), 
	gŒue
.
što
()),

1929 
bud_ex´
(
vec
![
D©um
::
I64
(0)], 
Ex´Ty³
::
IsNuÎ
),

1930 
	gçl£
.
što
(),

1935 
	g‹¡_ev®
!(

1936 
	g‹¡_ev®_nuÎ_if
,

1937 
	gvec
![

1939 
bud_ex´
(

1940 
vec
![
b
"abc".
as_»f
().
što
(), b"abc".as_ref().into()],

1941 
Ex´Ty³
::
NuÎIf
,

1943 
	gD©um
::
NuÎ
,

1946 
bud_ex´
(
vec
![
D©um
::
NuÎ
, D©um::NuÎ], 
Ex´Ty³
::
NuÎIf
),

1947 
	gD©um
::
NuÎ
,

1950 
bud_ex´
(
vec
![123
i64
.
što
(), 111i64.što()], 
Ex´Ty³
::
NuÎIf
),

1951 123
	gi64
.
što
(),

1954 
bud_ex´
(
vec
![123
i64
.
što
(), 
D©um
::
NuÎ
], 
Ex´Ty³
::
NuÎIf
),

1955 123
	gi64
.
što
(),

1960 
â
 
š_ex´
(
rg‘
: 
D©um
, 
mut
 
li¡
: 
Vec
<D©um>è-> 
Ex´
 {

1961 
Ët
 
rg‘_ex´
 = 
d©um_ex´
(
rg‘
);

1962 
	gli¡
.
sÜt_by
(|
l
, 
r
|†.
cmp
(&
DeçuÉ
::(),„).
unw¿p
());

1963 
Ët
 
	gv®
 = 
d©um
::
’code_v®ue
(&
li¡
).
unw¿p
();

1964 
Ët
 
mut
 
	gli¡_ex´
 = 
Ex´
::
Ãw
();

1965 
	gli¡_ex´
.
£t_
(
Ex´Ty³
::
V®ueLi¡
);

1966 
	gli¡_ex´
.
£t_v®
(
v®
);

1967 
Ët
 
mut
 
	gex´
 = 
Ex´
::
Ãw
();

1968 
	gex´
.
£t_
(
Ex´Ty³
::
In
);

1969 
	gex´
.
mut_chd»n
().
push
(
rg‘_ex´
);

1970 
	gex´
.
mut_chd»n
().
push
(
li¡_ex´
);

1971 
	gex´


1974 #[
‹¡
]

1975 
â
 
‹¡_cÚ‹xt
() {

1976 
Ët
 
mut
 
	g»q
 = 
S–eùReque¡
::
Ãw
();

1977 
	g»q
.
£t_time_zÚe_off£t
(
i32
::
MAX
 
as
 
i64
 + 1);

1978 
Ët
 
	gùx
 = 
Ev®CÚ‹xt
::
Ãw
(
»q
.
g‘_time_zÚe_off£t
(),„eq.
g‘_æags
());

1979 
	gas£¹
!(
	gùx
.
is_”r
());

1980 
	g»q
.
£t_time_zÚe_off£t
(3600);

1981 
	gEv®CÚ‹xt
::
Ãw
(
»q
.
g‘_time_zÚe_off£t
(),„eq.
g‘_æags
()).
unw¿p
();

1984 #[
‹¡
]

1985 
â
 
‹¡_wh”e_š
() {

1986 
Ët
 
	gÿ£s
 = 
vec
![

1988 
š_ex´
(
D©um
::
I64
(1), 
vec
![Datum::I64(1), Datum::I64(2)]),

1989 
	gD©um
::
I64
(1),

1992 
š_ex´
(
D©um
::
I64
(1), 
vec
![D©um::I64(2), D©um::
NuÎ
]),

1993 
	gD©um
::
NuÎ
,

1996 
š_ex´
(
D©um
::
NuÎ
, 
vec
![D©um::
I64
(1), Datum::Null]),

1997 
	gD©um
::
NuÎ
,

2000 
š_ex´
(
D©um
::
I64
(2), 
vec
![D©um::I64(1), D©um::
NuÎ
]),

2001 
	gD©um
::
NuÎ
,

2003 (
š_ex´
(
D©um
::
I64
(2), 
vec
![]), 
	gD©um
::I64(0)),

2005 
š_ex´
(

2006 
b
"abc".
as_»f
().
što
(),

2007 
vec
![
b
"abc".
as_»f
().
što
(), b"ab".as_ref().into()],

2009 
	gD©um
::
I64
(1),

2012 
š_ex´
(

2013 
b
"abc".
as_»f
().
što
(),

2014 
vec
![
b
"aba".
as_»f
().
što
(), b"bab".as_ref().into()],

2016 
	gD©um
::
I64
(0),

2020 
Ët
 
mut
 
	gev®
 = 
Ev®u©Ü
::();

2021 
	gex´
, 
	gex³ù_»s
è
š
 
	gÿ£s
 {

2022 
Ët
 
	g»s
 = 
ev®
.ev®(&
DeçuÉ
::(), &
ex´
);

2023 
	g»s
.
is_”r
() {

2024 
	g·nic
!("çedØexecu‹ {:?}: {:?}", 
	gex´
, 
	g»s
);

2026 
Ët
 
	g»s
 = 
»s
.
unw¿p
();

2027 
	g»s
 !ğ
ex³ù_»s
 {

2028 
·nic
!(

2030 
»s
,

2031 
ex³ù_»s
,

2032 
ex´


2038 
â
 
bud_by‹_d©ums_ex´
(
d©a
: &[&[
u8
]], 

: 
Ex´Ty³
è-> 
Ex´
 {

2039 
Ët
 
d©ums
 = 
d©a
.
što_™”
()

2040 .
m­
(|
™em
| 
D©um
::
By‹s
(™em.
to_vec
()))

2041 .
cŞËù
();

2042 
bud_ex´
(
d©ums
, 

)

2045 
	g‹¡_ev®
!(

2046 
	g‹¡_ev®_jsÚ_modify
,

2047 
	gvec
![

2049 
bud_ex´
(

2050 
vec
![
D©um
::
NuÎ
, Datum::Null, Datum::Null],

2051 
Ex´Ty³
::
JsÚS‘
,

2053 
	gD©um
::
NuÎ
,

2056 
bud_ex´
(

2057 
vec
![
D©um
::
I64
(9), D©um::
By‹s
(
b
"$[1]".
to_vec
()), Datum::I64(3)],

2058 
Ex´Ty³
::
JsÚS‘
,

2060 
	gD©um
::
JsÚ
(
r
#"[9,3]"#.parse().unwrap()),

2063 
bud_ex´
(

2064 
vec
![
D©um
::
I64
(9), D©um::
By‹s
(
b
"$[1]".
to_vec
()), Datum::I64(3)],

2065 
Ex´Ty³
::
JsÚIn£¹
,

2067 
	gD©um
::
JsÚ
(
r
#"[9,3]"#.parse().unwrap()),

2070 
bud_ex´
(

2071 
vec
![
D©um
::
I64
(9), D©um::
By‹s
(
b
"$[1]".
to_vec
()), Datum::I64(3)],

2072 
Ex´Ty³
::
JsÚR•Ïû
,

2074 
	gD©um
::
JsÚ
(
r
#"9"#.parse().unwrap()),

2077 
bud_ex´
(

2078 
vec
![

2079 
D©um
::
By‹s
(
br
#"{"a":"x"}"#.to_vec()),

2080 
D©um
::
By‹s
(
b
"$.a".
to_vec
()),

2081 
D©um
::
NuÎ
,

2083 
Ex´Ty³
::
JsÚS‘
,

2085 
D©um
::
JsÚ
(
r
#"{"a":
nuÎ
}"#.parse().unwrap()),

2090 
	g‹¡_ev®
!(

2091 
	g‹¡_ev®_jsÚ_unquÙe
,

2092 
	gvec
![

2094 
bud_ex´
(
vec
![
D©um
::
NuÎ
], 
Ex´Ty³
::
JsÚUnquÙe
),

2095 
	gD©um
::
NuÎ
,

2098 
bud_by‹_d©ums_ex´
(&[
b
"a"], 
Ex´Ty³
::
JsÚUnquÙe
),

2099 
	gD©um
::
By‹s
(
b
"a".
to_vec
()),

2102 
bud_by‹_d©ums_ex´
(&[
br
#"\"3\""#], 
Ex´Ty³
::
JsÚUnquÙe
),

2103 
D©um
::
By‹s
(
br
#""3""#.to_vec()),

2106 
bud_by‹_d©ums_ex´
(&[
br
#"{"a": "b"}"#], ExprType::JsonUnquote),

2107 
D©um
::
By‹s
(
br
#"{"a": "b"}"#.to_vec()),

2110 
bud_by‹_d©ums_ex´
(

2111 &[
br
#"
h–lo
,\"quoted string\",world"#],

2112 
Ex´Ty³
::
JsÚUnquÙe
,

2114 
D©um
::
By‹s
(
br
#"
h–lo
,"quÙed sŒšg",
wÜld
"#.to_vec()),

2119 
‹¡_ev®
!(

2120 
‹¡_ev®_jsÚ_exŒaù
,

2121 
vec
![

2123 
bud_ex´
(
vec
![
D©um
::
NuÎ
, D©um::NuÎ], 
Ex´Ty³
::
JsÚExŒaù
),

2124 
D©um
::
NuÎ
,

2127 
bud_by‹_d©ums_ex´
(

2129 
br
#"{"a": [{"aa": [{"aaa": 1}]}], "aaa": 2}"#,

2130 
b
"$.a[0].aa[0].aaa",

2131 
b
"$.aaa",

2133 
Ex´Ty³
::
JsÚExŒaù
,

2135 
D©um
::
JsÚ
("[1,2]".
·r£
().
unw¿p
()),

2140 
‹¡_ev®
!(

2141 
‹¡_ev®_jsÚ_ty³
,

2142 
vec
![

2144 
bud_ex´
(
vec
![
D©um
::
NuÎ
], 
Ex´Ty³
::
JsÚTy³
),

2145 
D©um
::
NuÎ
,

2148 
bud_by‹_d©ums_ex´
(&[
br
#"
Œue
"#], ExprType::JsonType),

2149 
D©um
::
By‹s
(
b
"BOOLEAN".
to_vec
()),

2152 
bud_by‹_d©ums_ex´
(&[
br
#"
nuÎ
"#], ExprType::JsonType),

2153 
D©um
::
By‹s
(
b
"NULL".
to_vec
()),

2156 
bud_by‹_d©ums_ex´
(&[
br
#"-3"#], ExprType::JsonType),

2157 
D©um
::
By‹s
(
b
"INTEGER".
to_vec
()),

2160 
bud_by‹_d©ums_ex´
(&[
br
#"3"#], ExprType::JsonType),

2161 
D©um
::
By‹s
(
b
"UNSIGNED INTEGER".
to_vec
()),

2164 
bud_by‹_d©ums_ex´
(&[
br
#"3.14"#], ExprType::JsonType),

2165 
D©um
::
By‹s
(
b
"DOUBLE".
to_vec
()),

2168 
bud_by‹_d©ums_ex´
(&[
br
#"{"name":"shirly","age":18}"#], ExprType::JsonType),

2169 
D©um
::
By‹s
(
b
"OBJECT".
to_vec
()),

2172 
bud_by‹_d©ums_ex´
(&[
br
#"[1,2,3]"#], ExprType::JsonType),

2173 
D©um
::
By‹s
(
b
"ARRAY".
to_vec
()),

2178 
‹¡_ev®
!(

2179 
‹¡_ev®_jsÚ_m”ge
,

2180 
vec
![

2182 
bud_ex´
(
vec
![
D©um
::
NuÎ
, D©um::NuÎ], 
Ex´Ty³
::
JsÚM”ge
),

2183 
D©um
::
NuÎ
,

2186 
bud_by‹_d©ums_ex´
(&[
b
"{}", b"[]"], 
Ex´Ty³
::
JsÚM”ge
),

2187 
D©um
::
JsÚ
("[{}]".
·r£
().
unw¿p
()),

2190 
bud_by‹_d©ums_ex´
(&[
b
"{}", b"[]", b"3", 
br
#""4""#], ExprType::JsonMerge),

2191 
D©um
::
JsÚ
(
r
#"[{}, 3, "4"]"#.parse().unwrap()),

2196 
‹¡_ev®_”r
!(

2197 
‹¡_ev®_jsÚ_”r
,

2198 
vec
![

2199 
bud_by‹_d©ums_ex´
(&[
b
"{}", b"$šv®idP©h", b"3"], 
Ex´Ty³
::
JsÚR•Ïû
),

2200 
bud_by‹_d©ums_ex´
(&[
b
"{}", b"$.a", b"3", b"$.c"], 
Ex´Ty³
::
JsÚR•Ïû
),

2201 
bud_ex´
(
vec
![], 
Ex´Ty³
::
JsÚUnquÙe
),

2202 
bud_by‹_d©ums_ex´
(&[
br
#"
Œue
"#, br#"444"#], ExprType::JsonUnquote),

2203 
bud_ex´
(
vec
![], 
Ex´Ty³
::
JsÚExŒaù
),

2204 
bud_by‹_d©ums_ex´
(

2205 &[
br
#"{"a": [{"aa": [{"aaa": 1}]}], "aaa": 2}"#],

2206 
Ex´Ty³
::
JsÚExŒaù
,

2208 
bud_by‹_d©ums_ex´
(

2209 &[
br
#"{"a": [{"¯": [{"¯a": 1}]}], "¯a": 2}"#, b"
¯a
"],

2210 
Ex´Ty³
::
JsÚExŒaù
,

2212 
bud_ex´
(
vec
![], 
Ex´Ty³
::
JsÚTy³
),

2213 
bud_by‹_d©ums_ex´
(&[
br
#"
Œue
"#, br#"444"#], ExprType::JsonType),

2214 
bud_ex´
(
vec
![], 
Ex´Ty³
::
JsÚM”ge
),

2215 
bud_ex´
(
vec
![
D©um
::
NuÎ
], 
Ex´Ty³
::
JsÚM”ge
),

2216 
bud_ex´
(
vec
![
D©um
::
NuÎ
], 
Ex´Ty³
::
JsÚRemove
),

2217 
bud_by‹_d©ums_ex´
(

2218 &[
br
#"{"a": [1, 2, {"¯": "xx"}]}"#, b"
$
"],

2219 
Ex´Ty³
::
JsÚRemove
,

2221 
bud_by‹_d©ums_ex´
(

2222 &[
br
#"{"a": [1, 2, {"¯": "xx"}]}"#, b"
$
.*"],

2223 
Ex´Ty³
::
JsÚRemove
,

2225 
bud_by‹_d©ums_ex´
(

2226 &[
br
#"{"a": [1, 2, {"¯": "xx"}]}"#, b"
$
[*]"],

2227 
Ex´Ty³
::
JsÚRemove
,

2229 
bud_by‹_d©ums_ex´
(

2230 &[
br
#"{"a": [1, 2, {"¯": "xx"}]}"#, b"
$
**.
a
"],

2231 
Ex´Ty³
::
JsÚRemove
,

2236 
‹¡_ev®
!(

2237 
‹¡_ev®_jsÚ_objeù
,

2238 
vec
![

2240 
bud_ex´
(
vec
![], 
Ex´Ty³
::
JsÚObjeù
),

2241 
D©um
::
JsÚ
("{}".
·r£
().
unw¿p
()),

2244 
bud_ex´
(
vec
![
D©um
::
U64
(1), D©um::
NuÎ
], 
Ex´Ty³
::
JsÚObjeù
),

2245 
D©um
::
JsÚ
(
r
#"{"1":
nuÎ
}"#.parse().unwrap()),

2248 
bud_ex´
(

2249 
vec
![

2250 
D©um
::
U64
(1),

2251 
D©um
::
NuÎ
,

2252 
D©um
::
U64
(2),

2253 
D©um
::
By‹s
(
b
"sdf".
to_vec
()),

2254 
D©um
::
By‹s
(
b
"k1".
to_vec
()),

2255 
D©um
::
By‹s
(
b
"v1".
to_vec
()),

2257 
Ex´Ty³
::
JsÚObjeù
,

2259 
D©um
::
JsÚ
(
r
#"{"1":
nuÎ
,"2":"sdf","k1":"v1"}"#.parse().unwrap()),

2264 
‹¡_ev®
!(

2265 
‹¡_ev®_jsÚ_¬¿y
,

2266 
vec
![

2268 
bud_ex´
(
vec
![], 
Ex´Ty³
::
JsÚA¼ay
),

2269 
D©um
::
JsÚ
("[]".
·r£
().
unw¿p
()),

2272 
bud_ex´
(
vec
![
D©um
::
NuÎ
], 
Ex´Ty³
::
JsÚA¼ay
),

2273 
D©um
::
JsÚ
("[nuÎ]".
·r£
().
unw¿p
()),

2276 
bud_ex´
(

2277 
vec
![
D©um
::
U64
(1), D©um::
NuÎ
, D©um::
By‹s
(
b
"sdf".
to_vec
())],

2278 
Ex´Ty³
::
JsÚA¼ay
,

2280 
D©um
::
JsÚ
(
r
#"[1,
nuÎ
,"sdf"]"#.parse().unwrap()),

2285 
‹¡_ev®
!(

2286 
‹¡_ev®_jsÚ_»move
,

2287 
vec
![

2289 
bud_ex´
(
vec
![
D©um
::
NuÎ
, D©um::NuÎ], 
Ex´Ty³
::
JsÚRemove
),

2290 
D©um
::
NuÎ
,

2293 
bud_by‹_d©ums_ex´
(

2294 &[
br
#"{"a": [1, 2, {"¯": "xx"}]}"#, b"
$
.
a
[2].
¯
"],

2295 
Ex´Ty³
::
JsÚRemove
,

2297 
D©um
::
JsÚ
(
r
#"{"a": [1, 2, {}]}"#.parse().unwrap()),

2300 
bud_by‹_d©ums_ex´
(

2301 &[
br
#"{"a": [1, 2, {"¯": "xx"}]}"#, b"
$
.
a
[1]"],

2302 
Ex´Ty³
::
JsÚRemove
,

2304 
D©um
::
JsÚ
(
r
#"{"a": [1, {"aa": "xx"}]}"#.parse().unwrap()),

2307 
bud_by‹_d©ums_ex´
(

2308 &[
br
#"{"a": [1, 2, {"¯": "xx"}]}"#, b"
$
.
a
[2].
¯
", b"$.a[1]"],

2309 
Ex´Ty³
::
JsÚRemove
,

2311 
D©um
::
JsÚ
(
r
#"{"a": [1, {}]}"#.parse().unwrap()),

2314 
bud_by‹_d©ums_ex´
(

2315 &[
br
#"{"a": [1, 2, {"¯": "xx"}]}"#, b"
$
.
a
[1]", b"$.a[1].
¯
"],

2316 
Ex´Ty³
::
JsÚRemove
,

2318 
D©um
::
JsÚ
(
r
#"{"a": [1, {}]}"#.parse().unwrap()),

2321 
bud_by‹_d©ums_ex´
(

2322 &[
br
#"{"a": [1, 2, {"¯": "xx"}]}"#, b"
$
.
a
[3]", b"$.
b
"],

2323 
Ex´Ty³
::
JsÚRemove
,

2325 
D©um
::
JsÚ
(
r
#"{"a": [1, 2, {"aa": "xx"}]}"#.parse().unwrap()),

	@src/coprocessor/select/xeval/mod.rs

15 
pub
 
mod
 
	gev®u©Ü
;

16 
mod
 
	gbutš_m©h
;

18 
u£
 
	gut
::
codec
;

20 
	gquick_”rÜ
! {

21 #[
d”ive
(
Debug
)]

22 
pub
 
	eE¼Ü
 {

23 
Codec
(
e
: 
codec
::
E¼Ü
) {

24 
äom
()

25 
desütiÚ
("codec failed")

27 
Ex´
(
s
: 
SŒšg
) {

28 
desütiÚ
("invalidƒxpression")

29 
di¥Ïy
("{}", 
s
)

31 
Ev®
(
s
: 
SŒšg
) {

32 
desütiÚ
("evaluation failed")

33 
di¥Ïy
("{}", 
s
)

38 
u£
 
	g¡d
::
»suÉ
;

39 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

41 
pub
 
u£
 
	g£lf
::
ev®u©Ü
::{
Ev®CÚ‹xt
, 
	gEv®u©Ü
};

	@src/coprocessor/statistics/analyze.rs

14 
u£
 
	g¡d
::
mem
;

16 
u£
 
	g¿nd
::{
th»ad_ºg
, 
	gRng
, 
	gTh»adRng
};

17 
u£
 
	g´Ùobuf
::{
Mes§ge
, 
	gR•—‹dF›ld
};

18 
u£
 
	gkv´Ùo
::
cİroûssÜ
::{
KeyRªge
, 
	gRe¥Ú£
};

19 
u£
 
	gtb
::
ª®yze
::{
£lf
, 
	gAÇlyzeCŞumnsReq
, 
	gAÇlyzeIndexReq
, 
	gAÇlyzeReq
, 
	gAÇlyzeTy³
};

20 
u£
 
	gtb
::
schema
::
CŞumnInfo
;

21 
u£
 
	gtb
::
executÜ
::
TabËSÿn
;

23 
u£
 
	gcİroûssÜ
::
dag
::
executÜ
::{
ExecutÜ
, 
	gIndexSÿnExecutÜ
, 
	gTabËSÿnExecutÜ
};

24 
u£
 
	gcİroûssÜ
::
’dpošt
::
ReqCÚ‹xt
;

25 
u£
 
	gcİroûssÜ
::
codec
::
d©um
;

26 
u£
 
	gcİroûssÜ
::{
E¼Ü
, 
	gResuÉ
};

27 
u£
 
	g¡Üage
::{
SÇpshÙ
, 
	gSÇpshÙStÜe
, 
	gSti¡ics
};

28 
u£
 
	gsu³r
::
fmsk‘ch
::
FMSk‘ch
;

29 
u£
 
	gsu³r
::
cmsk‘ch
::
CMSk‘ch
;

30 
u£
 
	gsu³r
::
hi¡og¿m
::
Hi¡og¿m
;

33 
pub
 
	sAÇlyzeCÚ‹xt
 {

34 
	m»q
: 
AÇlyzeReq
,

35 
	m¢­
: 
O±iÚ
<
SÇpshÙStÜe
>,

36 
	m¿nges
: 
Vec
<
KeyRªge
>,

39 
im¶
 
	gAÇlyzeCÚ‹xt
 {

40 
pub
 
â
 
Ãw
(

41 
»q
: 
AÇlyzeReq
,

42 
¿nges
: 
Vec
<
KeyRªge
>,

43 
¢­
: 
Box
<
SÇpshÙ
>,

44 
»q_ùx
: &
ReqCÚ‹xt
,

45 è-> 
	gAÇlyzeCÚ‹xt
 {

46 
Ët
 
	g¢­
 = 
SÇpshÙStÜe
::
Ãw
(

47 
¢­
,

48 
»q
.
g‘_¡¬t_ts
(),

49 
»q_ùx
.
isŞ©iÚ_Ëv–
,

50 
»q_ùx
.
fl_ÿche
,

52 
	gAÇlyzeCÚ‹xt
 {

53 
	g»q
: 
»q
,

54 
	g¢­
: 
Some
(
¢­
),

55 
	g¿nges
: 
¿nges
,

59 
pub
 
â
 
hªdË_»que¡
(
mut
 
£lf
, 
¡©s
: &muˆ
Sti¡ics
è-> 
ResuÉ
<
Re¥Ú£
> {

60 
Ët
 
»t
 = 
m©ch
 
£lf
.
»q
.
g‘_
() {

61 
AÇlyzeTy³
::
Ty³Index
 => {

62 
Ët
 
»q
 = 
£lf
.»q.
ke_idx_»q
();

63 
Ët
 
mut
 
	gsÿÂ”
 = 
IndexSÿnExecutÜ
::
Ãw_w™h_cŞs_Ën
(

64 
»q
.
g‘_num_cŞumns
(è
as
 
i64
,

65 
mem
::
»¶aû
(&
mut
 
£lf
.
¿nges
, 
Vec
::
Ãw
()),

66 
£lf
.
¢­
.
ke
().
unw¿p
(),

68 
Ët
 
	g»s
 = 
AÇlyzeCÚ‹xt
::
hªdË_šdex
(
»q
, &
mut
 
sÿÂ”
);

69 
	gsÿÂ”
.
cŞËù_¡©i¡ics_što
(
¡©s
);

70 
	g»s


73 
	gAÇlyzeTy³
::
Ty³CŞumn
 => {

74 
Ët
 
cŞ_»q
 = 
£lf
.
»q
.
ke_cŞ_»q
();

75 
Ët
 
	g¢­
 = 
£lf
.
¢­
.
ke
().
unw¿p
();

76 
Ët
 
	g¿nges
 = 
mem
::
»¶aû
(&
mut
 
£lf
.
¿nges
, 
Vec
::
Ãw
());

77 
Ët
 
mut
 
	gbud”
 = 
Sam¶eBud”
::
Ãw
(
cŞ_»q
, 
¢­
, 
¿nges
)?;

78 
Ët
 
	g»s
 = 
AÇlyzeCÚ‹xt
::
hªdË_cŞumn
(&
mut
 
bud”
);

79 
	gbud”
.
	gd©a
.
cŞËù_¡©i¡ics_što
(
¡©s
);

80 
	g»s


83 
m©ch
 
	g»t
 {

84 
Ok
(
d©a
) => {

85 
Ët
 
mut
 
»¥
 = 
Re¥Ú£
::
Ãw
();

86 
	g»¥
.
£t_d©a
(
d©a
);

87 
Ok
(
»¥
)

89 
E¼
(
E¼Ü
::
Oth”
(
e
)) => {

90 
Ët
 
mut
 
»¥
 = 
Re¥Ú£
::
Ãw
();

91 
	g»¥
.
£t_Ùh”_”rÜ
(
fÜm©
!("{}", 
e
));

92 
Ok
(
»¥
)

94 
E¼
(
e
) => Err(e),

101 
â
 
hªdË_cŞumn
(
bud”
: &
mut
 
Sam¶eBud”
è-> 
ResuÉ
<
Vec
<
u8
>> {

102 
Ët
 (
cŞËùÜs
, 
pk_bud”
èğ
bud”
.
cŞËù_cŞumns_¡©s
()?;

104 
Ët
 
	gpk_hi¡
 = 
pk_bud”
.
što_´Ùo
();

105 
Ët
 
	gcŞs
: 
Vec
<
ª®yze
::
Sam¶eCŞËùÜ
> =

106 
cŞËùÜs
.
što_™”
().
m­
(|
cŞ
| cŞ.
što_´Ùo
()).
cŞËù
();

108 
Ët
 
	g»s_d©a
 = {

109 
Ët
 
mut
 
»s
 = 
ª®yze
::
AÇlyzeCŞumnsRe¥
::
Ãw
();

110 
	g»s
.
£t_cŞËùÜs
(
R•—‹dF›ld
::
äom_vec
(
cŞs
));

111 
	g»s
.
£t_pk_hi¡
(
pk_hi¡
);

112 
	gbox_Œy
!(
	g»s
.
wr™e_to_by‹s
())

114 
Ok
(
»s_d©a
)

119 
â
 
hªdË_šdex
(
»q
: 
AÇlyzeIndexReq
, 
sÿÂ”
: &
mut
 
IndexSÿnExecutÜ
è-> 
ResuÉ
<
Vec
<
u8
>> {

120 
Ët
 
mut
 
hi¡
 = 
Hi¡og¿m
::
Ãw
(
»q
.
g‘_buck‘_size
(è
as
 
usize
);

121 
Ët
 
mut
 
	gcms
 = 
CMSk‘ch
::
Ãw
(

122 
»q
.
g‘_cmsk‘ch_d•th
(è
as
 
usize
,

123 
»q
.
g‘_cmsk‘ch_width
(è
as
 
usize
,

125 
Ët
 
Some
(
row
èğ
sÿÂ”
.
Ãxt
()? {

126 
Ët
 
by‹s
 = 
row
.
d©a
.
g‘_cŞumn_v®ues
();

127 
	ghi¡
.
­³nd
(
by‹s
);

128 
Ët
 
Some
(
c
èğ
cms
.
as_mut
() {

129 
c
.
š£¹
(
by‹s
)

132 
Ët
 
mut
 
	g»s
 = 
ª®yze
::
AÇlyzeIndexRe¥
::
Ãw
();

133 
	g»s
.
£t_hi¡
(
hi¡
.
što_´Ùo
());

134 
Ët
 
Some
(
c
èğ
cms
 {

135 
»s
.
£t_cms
(
c
.
što_´Ùo
());

137 
Ët
 
	gdt
 = 
box_Œy
!(
»s
.
wr™e_to_by‹s
());

138 
Ok
(
dt
)

143 
	sSam¶eBud”
 {

144 
	md©a
: 
TabËSÿnExecutÜ
,

145 
	mcŞs
: 
Vec
<
CŞumnInfo
>,

148 
	mcŞ_Ën
: 
usize
,

149 
	mmax_buck‘_size
: 
usize
,

150 
	mmax_§m¶e_size
: 
usize
,

151 
	mmax_fm_sk‘ch_size
: 
usize
,

152 
	mcm_sk‘ch_d•th
: 
usize
,

153 
	mcm_sk‘ch_width
: 
usize
,

159 
im¶
 
	gSam¶eBud”
 {

160 
â
 
Ãw
(

161 
mut
 
»q
: 
AÇlyzeCŞumnsReq
,

162 
¢­
: 
SÇpshÙStÜe
,

163 
¿nges
: 
Vec
<
KeyRªge
>,

164 è-> 
	gResuÉ
<
	gSam¶eBud”
> {

165 
Ët
 
	gcŞs_šfo
 = 
»q
.
ke_cŞumns_šfo
();

166 
	gcŞs_šfo
.
is_em±y
() {

167  
E¼
(
box_”r
!("empty columns_info"));

170 
Ët
 
mut
 
	gcŞ_Ën
 = 
cŞs_šfo
.
Ën
();

171 
	gcŞs_šfo
[0].
g‘_pk_hªdË
() {

172 
	gcŞ_Ën
 -= 1;

175 
Ët
 
mut
 
	gm‘a
 = 
TabËSÿn
::
Ãw
();

176 
	gm‘a
.
£t_cŞumns
(
cŞs_šfo
);

177 
Ët
 
	gbË_sÿÂ”
 = 
TabËSÿnExecutÜ
::
Ãw
(&
m‘a
, 
¿nges
, 
¢­
);

178 
Ok
(
Sam¶eBud”
 {

179 
d©a
: 
bË_sÿÂ”
,

180 
cŞs
: 
m‘a
.
ke_cŞumns
().
to_vec
(),

181 
cŞ_Ën
: col_len,

182 
max_buck‘_size
: 
»q
.
g‘_buck‘_size
(è
as
 
usize
,

183 
max_fm_sk‘ch_size
: 
»q
.
g‘_sk‘ch_size
(è
as
 
usize
,

184 
max_§m¶e_size
: 
»q
.
g‘_§m¶e_size
(è
as
 
usize
,

185 
cm_sk‘ch_d•th
: 
»q
.
g‘_cmsk‘ch_d•th
(è
as
 
usize
,

186 
cm_sk‘ch_width
: 
»q
.
g‘_cmsk‘ch_width
(è
as
 
usize
,

194 
â
 
cŞËù_cŞumns_¡©s
(&
mut
 
£lf
è-> 
	gResuÉ
<(
	gVec
<
	gSam¶eCŞËùÜ
>, 
	gHi¡og¿m
)> {

195 
Ët
 
mut
 
	gpk_bud”
 = 
Hi¡og¿m
::
Ãw
(
£lf
.
max_buck‘_size
);

196 
Ët
 
mut
 
	gcŞËùÜs
 = 
vec
![

197 
Sam¶eCŞËùÜ
::
Ãw
(

198 
£lf
.
max_§m¶e_size
,

199 
£lf
.
max_fm_sk‘ch_size
,

200 
£lf
.
cm_sk‘ch_d•th
,

201 
£lf
.
cm_sk‘ch_width


203 
£lf
.
cŞ_Ën


205 
Ët
 
Some
(
row
èğ
£lf
.
d©a
.
Ãxt
()? {

206 
Ët
 
cŞs
 = 
row
.
g‘_bš¬y_cŞs
(&
£lf
.cols)?;

207 
Ët
 
	g»Œ›ve_Ën
 = 
cŞs
.
Ën
();

208 
Ët
 
mut
 
	gcŞs_™”
 = 
cŞs
.
što_™”
();

209 
	g£lf
.
	gcŞ_Ën
 !ğ
»Œ›ve_Ën
 {

210 
Ët
 
Some
(
v
èğ
cŞs_™”
.
Ãxt
() {

211 
pk_bud”
.
­³nd
(&
v
);

214 
	gcŞËùÜ
, 
	gv®
è
š
 
	gcŞËùÜs
.
™”_mut
().
z
(
cŞs_™”
) {

215 
	gcŞËùÜ
.
cŞËù
(
v®
);

218 
Ok
((
cŞËùÜs
, 
pk_bud”
))

223 #[
d”ive
(
ClÚe
)]

224 
	sSam¶eCŞËùÜ
 {

225 
	m§m¶es
: 
Vec
<Vec<
u8
>>,

226 
	mnuÎ_couÁ
: 
u64
,

227 
	mcouÁ
: 
u64
,

228 
	mmax_§m¶e_size
: 
usize
,

229 
	mfm_sk‘ch
: 
FMSk‘ch
,

230 
	mcm_sk‘ch
: 
O±iÚ
<
CMSk‘ch
>,

231 
	mºg
: 
Th»adRng
,

234 
im¶
 
	gSam¶eCŞËùÜ
 {

235 
â
 
Ãw
(

236 
max_§m¶e_size
: 
usize
,

237 
max_fm_sk‘ch_size
: 
usize
,

238 
cm_sk‘ch_d•th
: 
usize
,

239 
cm_sk‘ch_width
: 
usize
,

240 è-> 
	gSam¶eCŞËùÜ
 {

241 
	gSam¶eCŞËùÜ
 {

242 
	g§m¶es
: 
DeçuÉ
::(),

243 
	gnuÎ_couÁ
: 0,

244 
	gcouÁ
: 0,

245 
	gmax_§m¶e_size
,

246 
	gfm_sk‘ch
: 
FMSk‘ch
::
Ãw
(
max_fm_sk‘ch_size
),

247 
	gcm_sk‘ch
: 
CMSk‘ch
::
Ãw
(
cm_sk‘ch_d•th
, 
cm_sk‘ch_width
),

248 
	gºg
: 
th»ad_ºg
(),

252 
â
 
što_´Ùo
(
£lf
è-> 
	gª®yze
::
Sam¶eCŞËùÜ
 {

253 
Ët
 
mut
 
s
 = 
ª®yze
::
Sam¶eCŞËùÜ
::
Ãw
();

254 
	gs
.
£t_nuÎ_couÁ
(
£lf
.
nuÎ_couÁ
 
as
 
i64
);

255 
	gs
.
£t_couÁ
(
£lf
.
couÁ
 
as
 
i64
);

256 
	gs
.
£t_fm_sk‘ch
(
£lf
.
fm_sk‘ch
.
što_´Ùo
());

257 
	gs
.
£t_§m¶es
(
R•—‹dF›ld
::
äom_vec
(
£lf
.
§m¶es
));

258 
Ët
 
Some
(
c
èğ
£lf
.
cm_sk‘ch
 {

259 
s
.
£t_cm_sk‘ch
(
c
.
što_´Ùo
())

261 
s


264 
pub
 
â
 
cŞËù
(&
mut
 
£lf
, 
d©a
: 
Vec
<
u8
>) {

265 
d©a
[0] =ğ
d©um
::
NIL_FLAG
 {

266 
£lf
.
nuÎ_couÁ
 += 1;

269 
	g£lf
.
	gcouÁ
 += 1;

270 
	g£lf
.
	gfm_sk‘ch
.
š£¹
(&
d©a
);

271 
Ët
 
Some
(
c
èğ
£lf
.
cm_sk‘ch
.
as_mut
() {

272 
c
.
š£¹
(&
d©a
)

274 
£lf
.
§m¶es
.
Ën
(è< s–f.
max_§m¶e_size
 {

275 
£lf
.
§m¶es
.
push
(
d©a
);

278 
	g£lf
.
	gºg
.
g’_¿nge
(0, 
£lf
.
couÁ
è< s–f.
max_§m¶e_size
 
as
 
	gu64
 {

279 
Ët
 
	gidx
 = 
£lf
.
ºg
.
g’_¿nge
(0, s–f.
max_§m¶e_size
);

280 
	g£lf
.
	g§m¶es
[
idx
] = 
d©a
;

285 #[
cfg
(
‹¡
)]

286 
mod
 
	g‹¡
 {

287 
u£
 
	gcİroûssÜ
::
codec
::
d©um
;

288 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::
D©um
;

289 
u£
 
	gsu³r
::*;

291 #[
‹¡
]

292 
â
 
‹¡_§m¶e_cŞËùÜ
() {

293 
Ët
 
	gmax_§m¶e_size
 = 3;

294 
Ët
 
	gmax_fm_sk‘ch_size
 = 10;

295 
Ët
 
	gcm_sk‘ch_d•th
 = 2;

296 
Ët
 
	gcm_sk‘ch_width
 = 16;

297 
Ët
 
mut
 
	g§m¶e
 = 
Sam¶eCŞËùÜ
::
Ãw
(

298 
max_§m¶e_size
,

299 
max_fm_sk‘ch_size
,

300 
cm_sk‘ch_d•th
,

301 
cm_sk‘ch_width
,

303 
Ët
 
	gÿ£s
 = 
vec
![
D©um
::
I64
(1), D©um::
NuÎ
, Datum::I64(2), Datum::I64(5)];

305 
d©a
 
š
 
	gÿ£s
 {

306 
	g§m¶e
.
cŞËù
(
d©um
::
’code_v®ue
(&[
d©a
]).
unw¿p
());

308 
	gas£¹_eq
!(
	g§m¶e
.
	g§m¶es
.
Ën
(), 
	gmax_§m¶e_size
);

309 
	gas£¹_eq
!(
	g§m¶e
.
	gnuÎ_couÁ
, 1);

310 
	gas£¹_eq
!(
	g§m¶e
.
	gcouÁ
, 3);

311 
	gas£¹_eq
!(
	g§m¶e
.
	gcm_sk‘ch
.
unw¿p
().
couÁ
(), 3)

	@src/coprocessor/statistics/cmsketch.rs

14 
u£
 
	gby‹Üd”
::{
By‹Ord”
, 
	gL™eEndŸn
};

15 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

16 
u£
 
	gmurmur3
::
murmur3_x64_128
;

17 
u£
 
	gtb
::
ª®yze
;

21 #[
d”ive
(
ClÚe
)]

22 
pub
 
	sCMSk‘ch
 {

23 
	md•th
: 
usize
,

24 
	mwidth
: 
usize
,

25 
	mcouÁ
: 
u32
,

26 
	mbË
: 
Vec
<Vec<
u32
>>,

29 
im¶
 
	gCMSk‘ch
 {

30 
pub
 
â
 
Ãw
(
d
: 
usize
, 
w
: usizeè-> 
O±iÚ
<
CMSk‘ch
> {

31 
d
 =ğ0 || 
w
 == 0 {

32 
NÚe


34 
Some
(
CMSk‘ch
 {

35 
d•th
: 
d
,

36 
width
: 
w
,

37 
couÁ
: 0,

38 
bË
: 
vec
![vec![0; 
w
]; 
d
],

44 
â
 
hash
(
mut
 
by‹s
: &[
u8
]è-> (
u64
, 
	gu64
) {

45 
Ët
 
mut
 
	gout
: [
u8
; 16] = [0; 16];

46 
murmur3_x64_128
(&
mut
 
by‹s
, 0, &muˆ
out
);

48 
	gL™eEndŸn
::
»ad_u64
(&
out
[0..8]),

49 
	gL™eEndŸn
::
»ad_u64
(&
out
[8..16]),

56 
pub
 
â
 
š£¹
(&
mut
 
£lf
, 
by‹s
: &[
u8
]) {

57 
£lf
.
couÁ
 = s–f.couÁ.
w¿µšg_add
(1);

58 
Ët
 (
h1
, 
h2
èğ
CMSk‘ch
::
hash
(
by‹s
);

59 
	gi
, 
	grow
è
š
 
	g£lf
.
	gbË
.
™”_mut
().
’um”©e
() {

60 
Ët
 
	gj
 = (
h1
.
w¿µšg_add
(
h2
.
w¿µšg_mul
(
i
 
as
 
u64
)è% 
£lf
.
width
‡ u64èa 
usize
;

61 
	grow
[
j
] = 
row
[j].
§tu¿tšg_add
(1);

65 
pub
 
â
 
što_´Ùo
(
£lf
è-> 
	gª®yze
::
CMSk‘ch
 {

66 
Ët
 
mut
 
´Ùo
 = 
ª®yze
::
CMSk‘ch
::
Ãw
();

67 
Ët
 
mut
 
	grows
 = 
vec
![
ª®yze
::
CMSk‘chRow
::(); 
£lf
.
d•th
];

68 
	gi
, 
	grow
è
š
 
	g£lf
.
	gbË
.
™”
().
’um”©e
() {

69 
	grows
[
i
].
£t_couÁ”s
(
row
.
to_vec
());

71 
	g´Ùo
.
£t_rows
(
R•—‹dF›ld
::
äom_vec
(
rows
));

72 
	g´Ùo


76 #[
cfg
(
‹¡
)]

77 
mod
 
	g‹¡
 {

78 
u£
 
	g¡d
::
cŞËùiÚs
::
HashM­
;

79 
u£
 
	g¡d
::
cmp
::
mš
;

80 
u£
 
	g¿nd
::{
Rng
, 
	gS“dabËRng
, 
	gStdRng
};

81 
u£
 
	gzf
::
ZfDi¡ributiÚ
;

82 
u£
 
	gcİroûssÜ
::
codec
::
d©um
;

83 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::
D©um
;

84 
u£
 
	gut
::
as_¦iû
;

85 
u£
 
	gsu³r
::*;

87 
im¶
 
	gCMSk‘ch
 {

88 
â
 
qu”y
(&
£lf
, 
by‹s
: &[
u8
]è-> 
u32
 {

89 
Ët
 (
h1
, 
h2
èğ
CMSk‘ch
::
hash
(
by‹s
);

90 
Ët
 
mut
 
	gv®s
 = 
vec
![0u32; 
£lf
.
d•th
];

91 
Ët
 
mut
 
	gmš_couÁ”
 = 
u32
::
max_v®ue
();

92 
	gi
, 
	grow
è
š
 
	g£lf
.
	gbË
.
™”
().
’um”©e
() {

93 
Ët
 
	gj
 = (
h1
.
w¿µšg_add
(
h2
.
w¿µšg_mul
(
i
 
as
 
u64
)è% 
£lf
.
width
‡ u64èa 
usize
;

94 
Ët
 
	gnoi£
 = (
£lf
.
couÁ
 - 
row
[
j
]è/ (£lf.
width
 
as
 
u32
 - 1);

95 
	gv®s
[
i
] = 
row
[
j
].
§tu¿tšg_sub
(
noi£
);

96 
	gmš_couÁ”
 = 
mš
(
mš_couÁ”
, 
row
[
j
])

98 
	gv®s
.
sÜt
();

99 
mš
(

100 
mš_couÁ”
,

101 
v®s
[(
£lf
.
d•th
 - 1) / 2] +

102 (
v®s
[
£lf
.
d•th
 / 2] - vals[(self.depth - 1) / 2]) / 2,

106 
pub
 
â
 
couÁ
(&
£lf
è-> 
	gu32
 {

107 
	g£lf
.
	gcouÁ


111 
â
 
av”age_”rÜ
(
d•th
: 
usize
, 
width
: usize, 
tÙ®
: 
u32
, 
max_v®ue
: usize, 
s
: 
f64
è-> 
u64
 {

112 
Ët
 
mut
 
c
 = 
CMSk‘ch
::
Ãw
(
d•th
, 
width
).
unw¿p
();

113 
Ët
 
mut
 
	gm­
: 
HashM­
<
u64
, 
	gu32
> = HashM­::
Ãw
();

114 
Ët
 
	g£ed
: &[
_
] = &[1, 2, 3, 4];

115 
Ët
 
mut
 
	gg’
: 
ZfDi¡ributiÚ
<
StdRng
> =

116 
ZfDi¡ributiÚ
::
Ãw
(
S“dabËRng
::
äom_£ed
(
£ed
), 
max_v®ue
, 
s
).
unw¿p
();

117 
_
 
	gš
 0..
	gtÙ®
 {

118 
Ët
 
	gv®
 = 
g’
.
Ãxt_u64
();

119 
Ët
 
	gby‹s
 = 
d©um
::
’code_v®ue
(
as_¦iû
(&
D©um
::
U64
(
v®
))).
unw¿p
();

120 
	gc
.
š£¹
(&
by‹s
);

121 
Ët
 
	gcouÁ”
 = 
m­
.
’Œy
(
v®
).
Ü_š£¹
(0);

122 *
	gcouÁ”
 += 1;

124 
Ët
 
mut
 
	gtÙ®
 = 0u64;

125 
	gv®
, 
	gnum
è
	gš
 &
	gm­
 {

126 
Ët
 
	gby‹s
 = 
d©um
::
’code_v®ue
(
as_¦iû
(&
D©um
::
U64
(*
v®
))).
unw¿p
();

127 
Ët
 
	ge¡im©e
 = 
c
.
qu”y
(&
by‹s
);

128 
Ët
 
	g”r
 = *
num
 > 
e¡im©e
 {

129 *
num
 - 
e¡im©e


131 
e¡im©e
 - *
num


133 
	gtÙ®
 +ğ
”r
 
as
 
u64


135 
	gtÙ®
 / 
	gm­
.
Ën
(è
as
 
	gu64


138 #[
‹¡
]

139 
â
 
‹¡_cm_sk‘ch
() {

140 
Ët
 (
d•th
, 
width
) = (8, 2048);

141 
Ët
 (
tÙ®
, 
max_v®ue
) = (1000000, 10000000);

142 
	gas£¹_eq
!(
av”age_”rÜ
(
d•th
, 
width
, 
tÙ®
, 
max_v®ue
, 1.1), 3);

143 
	gas£¹_eq
!(
av”age_”rÜ
(
d•th
, 
width
, 
tÙ®
, 
max_v®ue
, 2.0), 24);

144 
	gas£¹_eq
!(
av”age_”rÜ
(
d•th
, 
width
, 
tÙ®
, 
max_v®ue
, 3.0), 64);

	@src/coprocessor/statistics/fmsketch.rs

14 
u£
 
	g¡d
::
cŞËùiÚs
::
HashS‘
;

15 
u£
 
	gby‹Üd”
::{
By‹Ord”
, 
	gL™eEndŸn
};

16 
u£
 
	gmurmur3
::
murmur3_x64_128
;

17 
u£
 
	gtb
::
ª®yze
;

22 #[
d”ive
(
ClÚe
)]

23 
pub
 
	sFMSk‘ch
 {

24 
	mmask
: 
u64
,

25 
	mmax_size
: 
usize
,

26 
	mhash_£t
: 
HashS‘
<
u64
>,

29 
im¶
 
	gFMSk‘ch
 {

30 
pub
 
â
 
Ãw
(
max_size
: 
usize
è-> 
FMSk‘ch
 {

31 
FMSk‘ch
 {

32 
mask
: 0,

33 
	gmax_size
: 
max_size
,

34 
	ghash_£t
: 
HashS‘
::
w™h_ÿ·c™y
(
max_size
 + 1),

38 
pub
 
â
 
š£¹
(&
mut
 
£lf
, muˆ
by‹s
: &[
u8
]) {

39 
Ët
 
hash
 = {

40 
Ët
 
mut
 
out
: [
u8
; 16] = [0; 16];

41 
murmur3_x64_128
(&
mut
 
by‹s
, 0, &muˆ
out
);

42 
	gL™eEndŸn
::
»ad_u64
(&
out
[0..8])

44 
	g£lf
.
š£¹_hash_v®ue
(
hash
);

47 
pub
 
â
 
što_´Ùo
(
£lf
è-> 
	gª®yze
::
FMSk‘ch
 {

48 
Ët
 
mut
 
´Ùo
 = 
ª®yze
::
FMSk‘ch
::
Ãw
();

49 
	g´Ùo
.
£t_mask
(
£lf
.
mask
);

50 
Ët
 
	ghash
 = 
£lf
.
hash_£t
.
što_™”
().
cŞËù
();

51 
	g´Ùo
.
£t_hash£t
(
hash
);

52 
	g´Ùo


55 
â
 
š£¹_hash_v®ue
(&
mut
 
£lf
, 
hash_v®
: 
u64
) {

56 ià(
hash_v®
 & 
£lf
.
mask
) != 0 {

59 
	g£lf
.
	ghash_£t
.
š£¹
(
hash_v®
);

60 
	g£lf
.
	ghash_£t
.
Ën
(è> s–f.
	gmax_size
 {

61 
Ët
 
	gmask
 = (
£lf
.
mask
 << 1) | 1;

62 
	g£lf
.
	ghash_£t
.
»š
(|&
x
| x & 
mask
 == 0);

63 
	g£lf
.
	gmask
 = 
mask
;

68 #[
cfg
(
‹¡
)]

69 
mod
 
	g‹¡
 {

70 
u£
 
	g¡d
::
™”
::
»³©
;

71 
u£
 
	gcİroûssÜ
::
codec
::
d©um
;

72 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::
D©um
;

73 
u£
 
	gcİroûssÜ
::
codec
::
ResuÉ
;

74 
u£
 
	gut
::
as_¦iû
;

75 
u£
 
	gsu³r
::*;

77 
	sTe¡D©a
 {

78 
	g§m¶es
: 
Vec
<
D©um
>,

79 
	grc
: 
Vec
<
D©um
>,

80 
	gpk
: 
Vec
<
D©um
>,

83 
â
 
g’”©e_§m¶es
(
couÁ
: 
usize
è-> 
Vec
<
D©um
> {

84 
Ët
 
¡¬t
 = 1000;

85 
Ët
 
mut
 
	g§m¶es
: 
Vec
<
usize
> = (0..1)

86 .
chaš
(
»³©
(2).
ke
(
¡¬t
 - 1))

87 .
chaš
(1000..c
ouÁ
)

88 .
cŞËù
();

89 
Ët
 
mut
 
	gid
 = 
¡¬t
;

90 
	gid
 < 
	gcouÁ
 {

91 
	g§m¶es
[
id
] += 1;

92 
	gid
 += 3;

95 
	gid
 = 
¡¬t
;

96 
	gid
 < 
	gcouÁ
 {

97 
	g§m¶es
[
id
] += 2;

98 
	gid
 += 5;

100 
	g§m¶es
.
što_™”
().
m­
(|
v
| 
D©um
::
I64
(v 
as
 
i64
)).
cŞËù
()

103 
im¶
 
DeçuÉ
 
Te¡D©a
 {

104 
â
 (è-> 
Te¡D©a
 {

105 
Ët
 
§m¶es
 = 
g’”©e_§m¶es
(10000);

106 
Ët
 
	gcouÁ
 = 100000;

107 
Ët
 
	grc
 = 
g’”©e_§m¶es
(
couÁ
);

108 
	gTe¡D©a
 {

109 
	g§m¶es
: 
§m¶es
,

110 
	grc
: 
rc
,

111 
	gpk
: (0..c
ouÁ
 
as
 
i64
).
m­
(
D©um
::
I64
).
cŞËù
(),

116 
pub
 
â
 
bud_fmsk‘ch
(
v®ues
: &[
D©um
], 
max_size
: 
usize
è-> 
ResuÉ
<
FMSk‘ch
> {

117 
Ët
 
mut
 
s
 = 
FMSk‘ch
::
Ãw
(
max_size
);

118 
v®ue
 
š
 
	gv®ues
 {

119 
Ët
 
	gby‹s
 = 
d©um
::
’code_v®ue
(
as_¦iû
(
v®ue
))?;

120 
	gs
.
š£¹
(&
by‹s
);

122 
Ok
(
s
)

125 
im¶
 
	gFMSk‘ch
 {

127 
pub
 
â
 
ndv
(&
£lf
è-> 
	gu64
 {

128 (
	g£lf
.
	gmask
 + 1è* (£lf.
	ghash_£t
.
Ën
(è
as
 
	gu64
)

133 #[
‹¡
]

134 
â
 
‹¡_sk‘ch
() {

135 
Ët
 
	gmax_size
 = 1000;

136 
Ët
 
	gd©a
 = 
Te¡D©a
::();

137 
Ët
 
	g§m¶e
 = 
bud_fmsk‘ch
(&
d©a
.
§m¶es
, 
max_size
).
unw¿p
();

138 
	gas£¹_eq
!(
	g§m¶e
.
ndv
(), 6232);

139 
Ët
 
	grc
 = 
bud_fmsk‘ch
(&
d©a
.
rc
, 
max_size
).
unw¿p
();

140 
	gas£¹_eq
!(
	grc
.
ndv
(), 73344);

141 
Ët
 
	gpk
 = 
bud_fmsk‘ch
(&
d©a
.
pk
, 
max_size
).
unw¿p
();

142 
	gas£¹_eq
!(
	gpk
.
ndv
(), 100480);

144 
Ët
 
	gmax_size
 = 2;

145 
Ët
 
mut
 
	gsk‘ch
 = 
FMSk‘ch
::
Ãw
(
max_size
);

146 
	gsk‘ch
.
š£¹_hash_v®ue
(1);

147 
	gsk‘ch
.
š£¹_hash_v®ue
(2);

148 
	gas£¹_eq
!(
	gsk‘ch
.
	ghash_£t
.
Ën
(), 
	gmax_size
);

149 
	gsk‘ch
.
š£¹_hash_v®ue
(4);

150 
	gas£¹_eq
!(
	gsk‘ch
.
	ghash_£t
.
Ën
(), 
	gmax_size
);

	@src/coprocessor/statistics/histogram.rs

14 
u£
 
	g¡d
::
mem
;

15 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

16 
u£
 
	gtb
::
ª®yze
;

19 
	sBuck‘
 {

21 
	mcouÁ
: 
u64
,

23 
	muµ”_bound
: 
Vec
<
u8
>,

25 
	mlow”_bound
: 
Vec
<
u8
>,

27 
	m»³©s
: 
u64
,

30 
im¶
 
	gBuck‘
 {

31 
â
 
Ãw
(
couÁ
: 
u64
, 
uµ”_bound
: 
Vec
<
u8
>, 
low”_bound
: Vec<u8>, 
»³©s
: u64è-> 
Buck‘
 {

32 
Buck‘
 {

33 
couÁ
: count,

34 
	guµ”_bound
: 
uµ”_bound
,

35 
	glow”_bound
: 
low”_bound
,

36 
	g»³©s
: 
»³©s
,

40 
â
 
couÁ_»³©ed
(&
mut
 
£lf
) {

41 
	g£lf
.
	gcouÁ
 += 1;

42 
	g£lf
.
	g»³©s
 += 1;

48 
â
 
­³nd
(&
mut
 
£lf
, 
d©a
: 
Vec
<
u8
>) {

49 
£lf
.
uµ”_bound
 = 
d©a
;

50 
	g£lf
.
	gcouÁ
 += 1;

51 
	g£lf
.
	g»³©s
 = 1;

54 
â
 
što_´Ùo
(
£lf
è-> 
	gª®yze
::
Buck‘
 {

55 
Ët
 
mut
 
buck‘
 = 
ª®yze
::
Buck‘
::
Ãw
();

56 
	gbuck‘
.
£t_»³©s
(
£lf
.
»³©s
 
as
 
i64
);

57 
	gbuck‘
.
£t_couÁ
(
£lf
.
couÁ
 
as
 
i64
);

58 
	gbuck‘
.
£t_low”_bound
(
£lf
.
low”_bound
);

59 
	gbuck‘
.
£t_uµ”_bound
(
£lf
.
uµ”_bound
);

60 
	gbuck‘


65 #[
d”ive
(
DeçuÉ
)]

66 
pub
 
	sHi¡og¿m
 {

68 
	mndv
: 
u64
,

69 
	mbuck‘s
: 
Vec
<
Buck‘
>,

72 
	m³r_buck‘_lim™
: 
u64
,

74 
	mbuck‘s_num
: 
usize
,

77 
im¶
 
	gHi¡og¿m
 {

78 
pub
 
â
 
Ãw
(
buck‘s_num
: 
usize
è-> 
Hi¡og¿m
 {

79 
Hi¡og¿m
 {

80 
³r_buck‘_lim™
: 1,

81 
	gbuck‘s_num
: 
buck‘s_num
,

82 ..
	gDeçuÉ
::()

86 
pub
 
â
 
što_´Ùo
(
£lf
è-> 
ª®yze
::
Hi¡og¿m
 {

87 
Ët
 
mut
 
hi¡
 = 
ª®yze
::
Hi¡og¿m
::
Ãw
();

88 
	ghi¡
.
£t_ndv
(
£lf
.
ndv
 
as
 
i64
);

89 
Ët
 
	gbuck‘s
: 
Vec
<
ª®yze
::
Buck‘
> = 
£lf
.
buck‘s


90 .
što_™”
()

91 .
m­
(|
buck‘
| buck‘.
što_´Ùo
())

92 .
cŞËù
();

93 
	ghi¡
.
£t_buck‘s
(
R•—‹dF›ld
::
äom_vec
(
buck‘s
));

94 
	ghi¡


98 
pub
 
â
 
­³nd
(&
mut
 
£lf
, 
d©a
: &[
u8
]) {

99 
Ët
 
Some
(
buck‘
èğ
£lf
.
buck‘s
.
Ï¡_mut
() {

103 
buck‘
.
uµ”_bound
 =ğ
d©a
 {

104 
buck‘
.
couÁ_»³©ed
();

108 
	g£lf
.
	gndv
 += 1;

109 
	g£lf
.
	gbuck‘s
.
Ën
(è>ğ
£lf
.
buck‘s_num
 && s–f.
is_Ï¡_buck‘_fuÎ
() {

110 
£lf
.
m”ge_buck‘s
();

113 !
	g£lf
.
is_Ï¡_buck‘_fuÎ
() {

114 
	g£lf
.
	gbuck‘s
.
Ï¡_mut
().
unw¿p
().
­³nd
(
d©a
.
to_vec
());

119 
Ët
 
mut
 
	gcouÁ
 = 1;

120 
Ët
 
Some
(
buck‘
èğ
£lf
.
buck‘s
.
Ï¡
() {

121 
couÁ
 +ğ
buck‘
.count

123 
	g£lf
.
	gbuck‘s


124 .
push
(
Buck‘
::
Ãw
(
couÁ
, 
d©a
.
to_vec
(), data.to_vec(), 1));

128 
â
 
is_Ï¡_buck‘_fuÎ
(&
£lf
è-> 
	gboŞ
 {

129 
	g£lf
.
	gbuck‘s
.
is_em±y
() {

130  
	gŒue
;

132 
Ët
 
	gcouÁ
 = 
£lf
.
buck‘s
.
Ën
() == 1 {

133 
£lf
.
buck‘s
[0].
couÁ


135 
Ët
 
Ën
 = 
£lf
.
buck‘s
.len();

136 
	g£lf
.
	gbuck‘s
[
Ën
 - 1].
	gcouÁ
 - self.buckets[len - 2].count

138 
	gcouÁ
 >ğ
£lf
.
³r_buck‘_lim™


142 
â
 
m”ge_buck‘s
(&
mut
 
£lf
) {

143 
Ët
 
	gbuck‘_num
 = (
£lf
.
buck‘s_num
 + 1) / 2;

144 
	g£lf
.
	gbuck‘s_num
 > 1 {

145 
Ët
 (
Ëá
, 
right
èğ
£lf
.
buck‘s
.
¥l™_©_mut
(1);

146 
	gmem
::
sw­
(&
mut
 
Ëá
[0].
uµ”_bound
, &muˆ
right
[0].upper_bound);

147 
	gËá
[0].
	gcouÁ
 = 
right
[0].
couÁ
;

148 
	gËá
[0].
	g»³©s
 = 
right
[0].
»³©s
;

150 
id
 
	gš
 1..buc
	gk‘_num
 {

151 
Ët
 (
Ëá
, 
right
èğ
£lf
.
buck‘s
.
¥l™_©_mut
(
id
 * 2);

152 
	gright
.
Ën
() == 1 {

153 
mem
::
sw­
(&
mut
 
Ëá
[
id
], &muˆ
right
[0]);

156 
	gmem
::
sw­
(&
mut
 
Ëá
[
id
].
low”_bound
, &muˆ
right
[0].lower_bound);

157 
	gmem
::
sw­
(&
mut
 
Ëá
[
id
].
uµ”_bound
, &muˆ
right
[1].upper_bound);

158 
	gËá
[
id
].
	gcouÁ
 = 
right
[1].
couÁ
;

159 
	gËá
[
id
].
	g»³©s
 = 
right
[1].
»³©s
;

161 
	g£lf
.
	gbuck‘s
.
d¿š
(
buck‘_num
..);

162 
	g£lf
.
	g³r_buck‘_lim™
 *= 2;

167 #[
cfg
(
‹¡
)]

168 
mod
 
	g‹¡
 {

169 
u£
 
	g¡d
::
™”
::
»³©
;

170 
u£
 
	gcİroûssÜ
::
codec
::
d©um
;

171 
u£
 
	gcİroûssÜ
::
codec
::
d©um
::
D©um
;

172 
u£
 
	gsu³r
::*;

174 #[
‹¡
]

175 
â
 
‹¡_hi¡og¿m
() {

176 
Ët
 
	gbuck‘s_num
 = 3;

177 
Ët
 
mut
 
	ghi¡
 = 
Hi¡og¿m
::
Ãw
(
buck‘s_num
);

178 
	gas£¹_eq
!(
	ghi¡
.
	gbuck‘s
.
Ën
(), 0);

180 
™em
 
š
 (0..3).
m­
(
D©um
::
I64
) {

181 
Ët
 
by‹s
 = 
d©um
::
’code_v®ue
(&[
™em
]).
unw¿p
();

182 
	ghi¡
.
­³nd
(&
by‹s
);

187 
	gas£¹_eq
!(
	ghi¡
.
	gbuck‘s
.
Ën
(), 
	gbuck‘s_num
);

188 
	gas£¹_eq
!(
	ghi¡
.
	g³r_buck‘_lim™
, 1);

189 
	gas£¹_eq
!(
	ghi¡
.
	gndv
, 3);

192 
Ët
 
	gby‹s
 = 
d©um
::
’code_v®ue
(&[
D©um
::
I64
(3)]).
unw¿p
();

193 
	ghi¡
.
­³nd
(&
by‹s
);

196 
	gas£¹_eq
!(
	ghi¡
.
	g³r_buck‘_lim™
, 2);

197 
	gas£¹_eq
!(
	ghi¡
.
	gbuck‘s
.
Ën
(), 2);

198 
	gas£¹_eq
!(
	ghi¡
.
	gndv
, 4);

201 
™em
 
š
 
»³©
(3).
ke
(3).
m­
(
D©um
::
I64
) {

202 
Ët
 
by‹s
 = 
d©um
::
’code_v®ue
(&[
™em
]).
unw¿p
();

203 
	ghi¡
.
­³nd
(&
by‹s
);

208 
	gas£¹_eq
!(
	ghi¡
.
	g³r_buck‘_lim™
, 2);

209 
	gas£¹_eq
!(
	ghi¡
.
	gbuck‘s
.
Ën
(), 2);

210 
	gas£¹_eq
!(
	ghi¡
.
	gndv
, 4);

212 
™em
 
š
 
»³©
(4).
ke
(4).
m­
(
D©um
::
I64
) {

213 
Ët
 
by‹s
 = 
d©um
::
’code_v®ue
(&[
™em
]).
unw¿p
();

214 
	ghi¡
.
­³nd
(&
by‹s
);

219 
	gas£¹_eq
!(
	ghi¡
.
	g³r_buck‘_lim™
, 2);

220 
	gas£¹_eq
!(
	ghi¡
.
	gbuck‘s
.
Ën
(), 3);

221 
	gas£¹_eq
!(
	ghi¡
.
	gndv
, 5);

224 
Ët
 
	gby‹s
 = 
d©um
::
’code_v®ue
(&[
D©um
::
I64
(5)]).
unw¿p
();

225 
	ghi¡
.
­³nd
(&
by‹s
);

229 
	gas£¹_eq
!(
	ghi¡
.
	g³r_buck‘_lim™
, 4);

230 
	gas£¹_eq
!(
	ghi¡
.
	gbuck‘s
.
Ën
(), 3);

231 
	gas£¹_eq
!(
	ghi¡
.
	gndv
, 6);

234 #[
‹¡
]

235 
â
 
‹¡_buck‘s_lim™
() {

236 
Ët
 
	gbuck‘s_num
 = 1;

237 
Ët
 
mut
 
	ghi¡
 = 
Hi¡og¿m
::
Ãw
(
buck‘s_num
);

238 
	gas£¹_eq
!(
	ghi¡
.
	gbuck‘s
.
Ën
(), 0);

239 
	ghi¡
.
­³nd
(&
d©um
::
’code_v®ue
(&[
D©um
::
I64
(1)]).
unw¿p
());

240 
	gas£¹_eq
!(
	ghi¡
.
	gbuck‘s
.
Ën
(), 1);

241 
	gas£¹_eq
!(
	ghi¡
.
	g³r_buck‘_lim™
, 1);

242 
	ghi¡
.
­³nd
(&
d©um
::
’code_v®ue
(&[
D©um
::
I64
(2)]).
unw¿p
());

243 
	gas£¹_eq
!(
	ghi¡
.
	gbuck‘s
.
Ën
(), 1);

244 
	gas£¹_eq
!(
	ghi¡
.
	g³r_buck‘_lim™
, 2);

245 
	ghi¡
.
­³nd
(&
d©um
::
’code_v®ue
(&[
D©um
::
I64
(3)]).
unw¿p
());

246 
	gas£¹_eq
!(
	ghi¡
.
	g³r_buck‘_lim™
, 4);

	@src/coprocessor/statistics/mod.rs

14 
pub
 
mod
 
	gfmsk‘ch
;

15 
pub
 
mod
 
	ghi¡og¿m
;

16 
pub
 
mod
 
	gª®yze
;

17 
pub
 
mod
 
	gcmsk‘ch
;

	@src/lib.rs

14 #![
ü©e_ty³
 = "lib"]

15 #![
cfg_©Œ
(
‹¡
, 
ã©u»
(test))]

16 #![
ã©u»
(
âbox
)]

17 #![
ã©u»
(
®loc
)]

18 #![
ã©u»
(
¦iû_·‰”ns
)]

19 #![
ã©u»
(
box_syÁax
)]

20 #![
cfg_©Œ
(
ã©u»
 = "dev", f—tu»(
¶ugš
))]

21 #![
cfg_©Œ
(
ã©u»
 = "dev", 
¶ugš
(
şpy
))]

22 #![
cfg_©Œ
(
nÙ
(
ã©u»
 = "dev"), 
®low
(
unknown_lšts
))]

23 #![
»cursiÚ_lim™
 = "100"]

24 #![
ã©u»
(
ascii_ùy³
)]

25 #![
®low
(
moduË_šû±iÚ
)]

26 #![
®low
(
should_im¶em’t_Œa™
)]

27 #![
®low
(
Ïrge_’um_v¬ŸÁ
)]

28 #![
®low
(
ÃedËss_·ss_by_v®ue
)]

29 #![
®low
(
uÄ—dabË_l™”®
)]

30 #![
®low
(
Ãw_w™hout_deçuÉ_d”ive
)]

31 #![
®low
(
v”bo£_b™_mask
)]

33 #[
maüo_u£
]

34 
ü©e
 
log
;

35 #[
maüo_u£
]

36 
ü©e
 
quick_”rÜ
;

37 #[
cfg
(
‹¡
)]

38 
ü©e
 
‹¡
;

39 
ü©e
 
´Ùobuf
;

40 
ü©e
 
by‹Üd”
;

41 
ü©e
 
¿nd
;

42 
ü©e
 
mio
;

43 
ü©e
 
‹mpdœ
;

44 
ü©e
 
rocksdb
;

45 
ü©e
 
kv´Ùo
;

46 
ü©e
 
time
;

47 
ü©e
 
tb
;

48 
ü©e
 
libc
;

49 
ü©e
 
üc
;

50 
ü©e
 
®loc
;

51 
ü©e
 
chrÚo
;

52 
ü©e
 
zf
;

53 #[
maüo_u£
]

54 
ü©e
 
´om‘heus
;

55 #[
maüo_u£
]

56 
ü©e
 
Ïzy_¡©ic
;

57 
ü©e
 
backŒaû
;

58 
ü©e
 
u¾
;

59 
ü©e
 
fs2
;

60 
ü©e
 
»gex
;

61 
ü©e
 
g½cio
 
as
 
g½c
;

62 
ü©e
 
âv
;

63 
ü©e
 
æ©_m­
;

64 
ü©e
 
Üd”m­
;

65 
ü©e
 
futu»s
;

66 
ü©e
 
futu»s_ıupoŞ
;

67 
ü©e
 
tokio_cÜe
;

68 
ü©e
 
tokio_tim”
;

69 
ü©e
 
£rde_jsÚ
;

70 
ü©e
 
£rde
;

71 
ü©e
 
murmur3
;

72 #[
maüo_u£
]

73 
ü©e
 
£rde_d”ive
;

74 #[
cfg
(
‹¡
)]

75 
ü©e
 
toml
;

76 
ü©e
 
sys_šfo
;

77 #[
cfg
(
‹¡
)]

78 
ü©e
 
utime
;

79 #[
maüo_u£
]

80 
ü©e
 
ç
;

82 #[
maüo_u£
]

83 
pub
 
mod
 
	gut
;

84 
pub
 
mod
 
	gcÚfig
;

85 
pub
 
mod
 
	g¿á
;

86 
pub
 
mod
 
	g¡Üage
;

87 
pub
 
mod
 
	g¿á¡Üe
;

88 
pub
 
mod
 
	gpd
;

89 
pub
 
mod
 
	g£rv”
;

90 
pub
 
mod
 
	gcİroûssÜ
;

92 
pub
 
u£
 
	g¡Üage
::
StÜage
;

	@src/pd/client.rs

14 
u£
 
	g¡d
::
fmt
;

15 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gRwLock
};

16 
u£
 
	g¡d
::
time
::{
Du¿tiÚ
, 
	gIn¡ªt
};

18 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

19 
u£
 
	gfutu»s
::{
futu»
, 
	gFutu»
, 
	gSšk
, 
	gSŒ—m
};

20 
u£
 
	gfutu»s
::
sync
::
mpsc
;

21 
u£
 
	gg½c
::{
C®lO±iÚ
, 
	gEnvBud”
, 
	gWr™eFÏgs
};

22 
u£
 
	gkv´Ùo
::
m‘­b
;

23 
u£
 
	gkv´Ùo
::
pdpb
::{
£lf
, 
	gMemb”
};

25 
u£
 
	gut
::{
E™h”
, 
	gHªdyRwLock
};

26 
u£
 
	gut
::
£cur™y
::
Secur™yMªag”
;

27 
u£
 
	gut
::
time
::
du¿tiÚ_to_£c
;

28 
u£
 
	gpd
::{
CÚfig
, 
	gPdFutu»
};

29 
u£
 
	gsu³r
::{
E¼Ü
, 
	gPdCl›Á
, 
	gRegiÚSt
, 
	gResuÉ
, 
	gREQUEST_TIMEOUT
};

30 
u£
 
	gsu³r
::
ut
::{
check_»¥_h—d”
, 
	gsync_»que¡
, 
	gv®id©e_’dpošts
, 
	gIÂ”
, 
	gL—d”Cl›Á
};

31 
u£
 
	gsu³r
::
m‘rics
::*;

33 cÚ¡ 
	gCQ_COUNT
: 
usize
 = 1;

34 cÚ¡ 
	gCLIENT_PREFIX
: &'static str = "pd";

36 
pub
 
	sRpcCl›Á
 {

37 
şu¡”_id
: 
u64
,

38 
	mËad”_ş›Á
: 
L—d”Cl›Á
,

41 
im¶
 
	gRpcCl›Á
 {

42 
pub
 
â
 
Ãw
(
cfg
: &
CÚfig
, 
£cur™y_mgr
: 
Arc
<
Secur™yMªag”
>è-> 
ResuÉ
<
RpcCl›Á
> {

43 
Ët
 
’v
 = 
Arc
::
Ãw
(

44 
EnvBud”
::
Ãw
()

45 .
cq_couÁ
(
CQ_COUNT
)

46 .
Çme_´efix
(
thd_Çme
!(
CLIENT_PREFIX
))

47 .
bud
(),

49 
Ët
 (
ş›Á
, 
memb”s
èğ
v®id©e_’dpošts
(
’v
.
şÚe
(), 
cfg
, &
£cur™y_mgr
)?;

51 
Ok
(
RpcCl›Á
 {

52 
şu¡”_id
: 
memb”s
.
g‘_h—d”
().
g‘_şu¡”_id
(),

53 
Ëad”_ş›Á
: 
L—d”Cl›Á
::
Ãw
(
’v
, 
£cur™y_mgr
, 
ş›Á
, 
memb”s
),

57 
â
 
h—d”
(&
£lf
è-> 
	gpdpb
::
Reque¡H—d”
 {

58 
Ët
 
mut
 
h—d”
 = 
pdpb
::
Reque¡H—d”
::
Ãw
();

59 
	gh—d”
.
£t_şu¡”_id
(
£lf
.
şu¡”_id
);

60 
	gh—d”


63 
pub
 
â
 
g‘_Ëad”
(&
£lf
è-> 
	gMemb”
 {

64 
	g£lf
.
	gËad”_ş›Á
.
g‘_Ëad”
()

68 
im¶
 
	gfmt
::
Debug
 
RpcCl›Á
 {

69 
â
 
fmt
(&
£lf
, fmt: &
mut
 fmt::
FÜm©‹r
è-> fmt::
ResuÉ
 {

70 
fmt
.
debug_¡ruù
("RpcClient")

71 .
f›ld
("şu¡”_id", &
£lf
.
şu¡”_id
)

72 .
f›ld
("Ëad”", &
£lf
.
g‘_Ëad”
())

73 .
fšish
()

77 cÚ¡ 
	gLEADER_CHANGE_RETRY
: 
usize
 = 10;

79 
im¶
 
PdCl›Á
 
	gRpcCl›Á
 {

80 
â
 
g‘_şu¡”_id
(&
£lf
è-> 
	gResuÉ
<
	gu64
> {

81 
Ok
(
£lf
.
şu¡”_id
)

84 
â
 
boÙ¡¿p_şu¡”
(&
£lf
, 
¡Ües
: 
m‘­b
::
StÜe
, 
»giÚ
: m‘­b::
RegiÚ
è-> 
ResuÉ
<()> {

85 
Ët
 
_tim”
 = 
PD_REQUEST_HISTOGRAM_VEC


86 .
w™h_Ïb–_v®ues
(&["bootstrap_cluster"])

87 .
¡¬t_cßr£_tim”
();

89 
Ët
 
mut
 
	g»q
 = 
pdpb
::
BoÙ¡¿pReque¡
::
Ãw
();

90 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

91 
	g»q
.
£t_¡Üe
(
¡Ües
);

92 
	g»q
.
£t_»giÚ
(
»giÚ
);

94 
Ët
 
	g»¥
 = 
sync_»que¡
(&
£lf
.
Ëad”_ş›Á
, 
LEADER_CHANGE_RETRY
, |
ş›Á
| {

95 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

96 
ş›Á
.
boÙ¡¿p_İt
(
»q
.
şÚe
(), 
İtiÚ
)

98 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

99 
Ok
(())

102 
â
 
is_şu¡”_boÙ¡¿µed
(&
£lf
è-> 
	gResuÉ
<
	gboŞ
> {

103 
Ët
 
	g_tim”
 = 
PD_REQUEST_HISTOGRAM_VEC


104 .
w™h_Ïb–_v®ues
(&["is_cluster_bootstrapped"])

105 .
¡¬t_cßr£_tim”
();

107 
Ët
 
mut
 
	g»q
 = 
pdpb
::
IsBoÙ¡¿µedReque¡
::
Ãw
();

108 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

110 
Ët
 
	g»¥
 = 
sync_»que¡
(&
£lf
.
Ëad”_ş›Á
, 
LEADER_CHANGE_RETRY
, |
ş›Á
| {

111 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

112 
ş›Á
.
is_boÙ¡¿µed_İt
(
»q
.
şÚe
(), 
İtiÚ
)

114 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

116 
Ok
(
»¥
.
g‘_boÙ¡¿µed
())

119 
â
 
®loc_id
(&
£lf
è-> 
	gResuÉ
<
	gu64
> {

120 
Ët
 
	g_tim”
 = 
PD_REQUEST_HISTOGRAM_VEC


121 .
w™h_Ïb–_v®ues
(&["alloc_id"])

122 .
¡¬t_cßr£_tim”
();

124 
Ët
 
mut
 
	g»q
 = 
pdpb
::
AÎocIDReque¡
::
Ãw
();

125 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

127 
Ët
 
	g»¥
 = 
sync_»que¡
(&
£lf
.
Ëad”_ş›Á
, 
LEADER_CHANGE_RETRY
, |
ş›Á
| {

128 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

129 
ş›Á
.
®loc_id_İt
(
»q
.
şÚe
(), 
İtiÚ
)

131 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

133 
Ok
(
»¥
.
g‘_id
())

136 
â
 
put_¡Üe
(&
£lf
, 
¡Üe
: 
m‘­b
::
StÜe
è-> 
ResuÉ
<()> {

137 
Ët
 
_tim”
 = 
PD_REQUEST_HISTOGRAM_VEC


138 .
w™h_Ïb–_v®ues
(&["put_store"])

139 .
¡¬t_cßr£_tim”
();

141 
Ët
 
mut
 
	g»q
 = 
pdpb
::
PutStÜeReque¡
::
Ãw
();

142 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

143 
	g»q
.
£t_¡Üe
(
¡Üe
);

145 
Ët
 
	g»¥
 = 
sync_»que¡
(&
£lf
.
Ëad”_ş›Á
, 
LEADER_CHANGE_RETRY
, |
ş›Á
| {

146 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

147 
ş›Á
.
put_¡Üe_İt
(
»q
.
şÚe
(), 
İtiÚ
)

149 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

151 
Ok
(())

154 
â
 
g‘_¡Üe
(&
£lf
, 
¡Üe_id
: 
u64
è-> 
ResuÉ
<
m‘­b
::
StÜe
> {

155 
Ët
 
_tim”
 = 
PD_REQUEST_HISTOGRAM_VEC


156 .
w™h_Ïb–_v®ues
(&["get_store"])

157 .
¡¬t_cßr£_tim”
();

159 
Ët
 
mut
 
	g»q
 = 
pdpb
::
G‘StÜeReque¡
::
Ãw
();

160 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

161 
	g»q
.
£t_¡Üe_id
(
¡Üe_id
);

163 
Ët
 
mut
 
	g»¥
 = 
sync_»que¡
(&
£lf
.
Ëad”_ş›Á
, 
LEADER_CHANGE_RETRY
, |
ş›Á
| {

164 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

165 
ş›Á
.
g‘_¡Üe_İt
(
»q
.
şÚe
(), 
İtiÚ
)

167 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

169 
Ok
(
»¥
.
ke_¡Üe
())

172 
â
 
g‘_şu¡”_cÚfig
(&
£lf
è-> 
	gResuÉ
<
	gm‘­b
::
Clu¡”
> {

173 
Ët
 
_tim”
 = 
PD_REQUEST_HISTOGRAM_VEC


174 .
w™h_Ïb–_v®ues
(&["get_cluster_config"])

175 .
¡¬t_cßr£_tim”
();

177 
Ët
 
mut
 
	g»q
 = 
pdpb
::
G‘Clu¡”CÚfigReque¡
::
Ãw
();

178 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

180 
Ët
 
mut
 
	g»¥
 = 
sync_»que¡
(&
£lf
.
Ëad”_ş›Á
, 
LEADER_CHANGE_RETRY
, |
ş›Á
| {

181 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

182 
ş›Á
.
g‘_şu¡”_cÚfig_İt
(
»q
.
şÚe
(), 
İtiÚ
)

184 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

186 
Ok
(
»¥
.
ke_şu¡”
())

189 
â
 
g‘_»giÚ
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
m‘­b
::
RegiÚ
> {

190 
Ët
 
_tim”
 = 
PD_REQUEST_HISTOGRAM_VEC


191 .
w™h_Ïb–_v®ues
(&["get_region"])

192 .
¡¬t_cßr£_tim”
();

194 
Ët
 
mut
 
	g»q
 = 
pdpb
::
G‘RegiÚReque¡
::
Ãw
();

195 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

196 
	g»q
.
£t_»giÚ_key
(
key
.
to_vec
());

198 
Ët
 
mut
 
	g»¥
 = 
sync_»que¡
(&
£lf
.
Ëad”_ş›Á
, 
LEADER_CHANGE_RETRY
, |
ş›Á
| {

199 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

200 
ş›Á
.
g‘_»giÚ_İt
(
»q
.
şÚe
(), 
İtiÚ
)

202 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

204 
Ok
(
»¥
.
ke_»giÚ
())

207 
â
 
g‘_»giÚ_by_id
(&
£lf
, 
»giÚ_id
: 
u64
è-> 
PdFutu»
<
O±iÚ
<
m‘­b
::
RegiÚ
>> {

208 
Ët
 
tim”
 = 
In¡ªt
::
now
();

210 
Ët
 
mut
 
	g»q
 = 
pdpb
::
G‘RegiÚByIDReque¡
::
Ãw
();

211 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

212 
	g»q
.
£t_»giÚ_id
(
»giÚ_id
);

214 
Ët
 
	gexecutÜ
 = 
move
 |
ş›Á
: &
RwLock
<
IÂ”
>, 
	g»q
: 
pdpb
::
G‘RegiÚByIDReque¡
| {

215 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

216 
Ët
 
	ghªdËr
 = 
ş›Á
.
¾
().ş›Á.
g‘_»giÚ_by_id_async_İt
(
»q
, 
İtiÚ
);

217 
	gBox
::
Ãw
(
hªdËr
.
m­_”r
(
E¼Ü
::
G½c
).
ªd_th’
(
move
 |
mut
 
»¥
| {

218 
PD_REQUEST_HISTOGRAM_VEC


219 .
w™h_Ïb–_v®ues
(&["get_region_by_id"])

220 .
ob£rve
(
du¿tiÚ_to_£c
(
tim”
.
–­£d
()));

221 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

222 
»¥
.
has_»giÚ
() {

223 
Ok
(
Some
(
»¥
.
ke_»giÚ
()))

225 
Ok
(
NÚe
)

227 })è
as
 
	gPdFutu»
<
	g_
>

230 
	g£lf
.
	gËad”_ş›Á


231 .
»que¡
(
»q
, 
executÜ
, 
LEADER_CHANGE_RETRY
)

232 .
execu‹
()

235 
â
 
»giÚ_h—¹b—t
(

236 &
£lf
,

237 
»giÚ
: 
m‘­b
::
RegiÚ
,

238 
Ëad”
: 
m‘­b
::
P“r
,

239 
»giÚ_¡©
: 
RegiÚSt
,

240 è-> 
	gPdFutu»
<()> {

241 
	gPD_HEARTBEAT_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["£nd"]).
šc
();

243 
Ët
 
mut
 
	g»q
 = 
pdpb
::
RegiÚH—¹b—tReque¡
::
Ãw
();

244 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

245 
	g»q
.
£t_»giÚ
(
»giÚ
);

246 
	g»q
.
£t_Ëad”
(
Ëad”
);

247 
	g»q
.
£t_down_³”s
(
R•—‹dF›ld
::
äom_vec
(
»giÚ_¡©
.
down_³”s
));

248 
	g»q
.
£t_³ndšg_³”s
(
R•—‹dF›ld
::
äom_vec
(
»giÚ_¡©
.
³ndšg_³”s
));

249 
	g»q
.
£t_by‹s_wr™‹n
(
»giÚ_¡©
.
wr™‹n_by‹s
);

250 
	g»q
.
£t_keys_wr™‹n
(
»giÚ_¡©
.
wr™‹n_keys
);

251 
	g»q
.
£t_by‹s_»ad
(
»giÚ_¡©
.
»ad_by‹s
);

252 
	g»q
.
£t_keys_»ad
(
»giÚ_¡©
.
»ad_by‹s
);

253 
	g»q
.
£t_­´oxim©e_size
(
»giÚ_¡©
.
­´oxim©e_size
);

255 
Ët
 
	gexecutÜ
 = |
ş›Á
: &
RwLock
<
IÂ”
>, 
	g»q
: 
pdpb
::
RegiÚH—¹b—tReque¡
| {

256 
Ët
 
mut
 
šÃr
 = 
ş›Á
.
wl
();

257 
Ët
 
	g£nd”
 = 
m©ch
 
šÃr
.
hb_£nd”
 {

258 
E™h”
::
Leá
(
»f
 
mut
 
£nd”
è=> s’d”.
ke
(),

259 
	gE™h”
::
Right
(
»f
 
£nd”
) => {

260  
Box
::
Ãw
(
futu»
::
»suÉ
(

261 
£nd”


262 .
unbounded_£nd
(
»q
)

263 .
m­_”r
(|
e
| 
E¼Ü
::
Oth”
(
Box
::
Ãw
(e))),

264 )è
as
 
PdFutu»
<
_
>

268 
m©ch
 
	g£nd”
 {

269 
Some
(
£nd”
) => {

270 
Ët
 (
tx
, 
rx
èğ
mpsc
::
unbounded
();

271 
	gtx
.
unbounded_£nd
(
»q
).
unw¿p
();

272 
	gšÃr
.
	ghb_£nd”
 = 
E™h”
::
Right
(
tx
);

273 
	gBox
::
Ãw
(

274 
£nd”


275 .
sšk_m­_”r
(
E¼Ü
::
G½c
)

276 .
£nd_®l
(

277 
rx
.
m­_”r
(|
e
| {

278 
E¼Ü
::
Oth”
(
box_”r
!("çedØ»cv h—¹b—t: {:?}", 
e
))

279 }).
m­
(|
r
| (r, 
Wr™eFÏgs
::())),

281 .
m­
(|
_
| ()),

282 è
as
 
	gPdFutu»
<
	g_
>

284 
	gNÚe
 => 
uÄ—chabË
!(),

288 
	g£lf
.
	gËad”_ş›Á


289 .
»que¡
(
»q
, 
executÜ
, 
LEADER_CHANGE_RETRY
)

290 .
execu‹
()

293 
â
 
	ghªdË_»giÚ_h—¹b—t_»¥Ú£
<
	gF
>(&
	g£lf
, 
	g_
: 
u64
, 
	gf
: 
F
è-> 
PdFutu»
<()>

294 
wh”e


295 
F
: 
Fn
(
pdpb
::
RegiÚH—¹b—tRe¥Ú£
è+ 
S’d
 + 'static,

297 
£lf
.
Ëad”_ş›Á
.
hªdË_»giÚ_h—¹b—t_»¥Ú£
(
f
)

300 
â
 
ask_¥l™
(&
£lf
, 
»giÚ
: 
m‘­b
::
RegiÚ
è-> 
PdFutu»
<
pdpb
::
AskS¶™Re¥Ú£
> {

301 
Ët
 
tim”
 = 
In¡ªt
::
now
();

303 
Ët
 
mut
 
	g»q
 = 
pdpb
::
AskS¶™Reque¡
::
Ãw
();

304 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

305 
	g»q
.
£t_»giÚ
(
»giÚ
);

307 
Ët
 
	gexecutÜ
 = 
move
 |
ş›Á
: &
RwLock
<
IÂ”
>, 
	g»q
: 
pdpb
::
AskS¶™Reque¡
| {

308 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

309 
Ët
 
	ghªdËr
 = 
ş›Á
.
¾
().ş›Á.
ask_¥l™_async_İt
(
»q
, 
İtiÚ
);

310 
	gBox
::
Ãw
(
hªdËr
.
m­_”r
(
E¼Ü
::
G½c
).
ªd_th’
(
move
 |
»¥
| {

311 
PD_REQUEST_HISTOGRAM_VEC


312 .
w™h_Ïb–_v®ues
(&["ask_split"])

313 .
ob£rve
(
du¿tiÚ_to_£c
(
tim”
.
–­£d
()));

314 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

315 
Ok
(
»¥
)

316 })è
as
 
	gPdFutu»
<
	g_
>

319 
	g£lf
.
	gËad”_ş›Á


320 .
»que¡
(
»q
, 
executÜ
, 
LEADER_CHANGE_RETRY
)

321 .
execu‹
()

324 
â
 
¡Üe_h—¹b—t
(&
£lf
, 
¡©s
: 
pdpb
::
StÜeSts
è-> 
PdFutu»
<()> {

325 
Ët
 
tim”
 = 
In¡ªt
::
now
();

327 
Ët
 
mut
 
	g»q
 = 
pdpb
::
StÜeH—¹b—tReque¡
::
Ãw
();

328 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

329 
	g»q
.
£t_¡©s
(
¡©s
);

331 
Ët
 
	gexecutÜ
 = 
move
 |
ş›Á
: &
RwLock
<
IÂ”
>, 
	g»q
: 
pdpb
::
StÜeH—¹b—tReque¡
| {

332 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

333 
Ët
 
	ghªdËr
 = 
ş›Á
.
¾
().ş›Á.
¡Üe_h—¹b—t_async_İt
(
»q
, 
İtiÚ
);

334 
	gBox
::
Ãw
(
hªdËr
.
m­_”r
(
E¼Ü
::
G½c
).
ªd_th’
(
move
 |
»¥
| {

335 
PD_REQUEST_HISTOGRAM_VEC


336 .
w™h_Ïb–_v®ues
(&["store_heartbeat"])

337 .
ob£rve
(
du¿tiÚ_to_£c
(
tim”
.
–­£d
()));

338 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

339 
Ok
(())

340 })è
as
 
	gPdFutu»
<
	g_
>

343 
	g£lf
.
	gËad”_ş›Á


344 .
»que¡
(
»q
, 
executÜ
, 
LEADER_CHANGE_RETRY
)

345 .
execu‹
()

348 
â
 
»pÜt_¥l™
(&
£lf
, 
Ëá
: 
m‘­b
::
RegiÚ
, 
right
: m‘­b::RegiÚè-> 
PdFutu»
<()> {

349 
Ët
 
tim”
 = 
In¡ªt
::
now
();

351 
Ët
 
mut
 
	g»q
 = 
pdpb
::
R•ÜtS¶™Reque¡
::
Ãw
();

352 
	g»q
.
£t_h—d”
(
£lf
.
h—d”
());

353 
	g»q
.
£t_Ëá
(
Ëá
);

354 
	g»q
.
£t_right
(
right
);

356 
Ët
 
	gexecutÜ
 = 
move
 |
ş›Á
: &
RwLock
<
IÂ”
>, 
	g»q
: 
pdpb
::
R•ÜtS¶™Reque¡
| {

357 
Ët
 
İtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

358 
Ët
 
	ghªdËr
 = 
ş›Á
.
¾
().ş›Á.
»pÜt_¥l™_async_İt
(
»q
, 
İtiÚ
);

359 
	gBox
::
Ãw
(
hªdËr
.
m­_”r
(
E¼Ü
::
G½c
).
ªd_th’
(
move
 |
»¥
| {

360 
PD_REQUEST_HISTOGRAM_VEC


361 .
w™h_Ïb–_v®ues
(&["report_split"])

362 .
ob£rve
(
du¿tiÚ_to_£c
(
tim”
.
–­£d
()));

363 
check_»¥_h—d”
(
»¥
.
g‘_h—d”
())?;

364 
Ok
(())

365 })è
as
 
	gPdFutu»
<
	g_
>

368 
	g£lf
.
	gËad”_ş›Á


369 .
»que¡
(
»q
, 
executÜ
, 
LEADER_CHANGE_RETRY
)

370 .
execu‹
()

	@src/pd/config.rs

14 
u£
 
	g¡d
::
”rÜ
::
E¼Ü
;

16 #[
d”ive
(
ClÚe
, 
S”Ÿlize
, 
De£rŸlize
, 
DeçuÉ
, 
P¬tŸlEq
, 
Debug
)]

17 #[
£rde
()]

18 #[
£rde
(
»Çme_®l
 = "kebab-case")]

19 
pub
 
	sCÚfig
 {

20 
pub
 
	m’dpošts
: 
Vec
<
SŒšg
>,

23 
im¶
 
	gCÚfig
 {

24 
pub
 
â
 
v®id©e
(&
mut
 
£lf
è-> 
	gResuÉ
<(), 
	gBox
<
	gE¼Ü
>> {

25 
	g£lf
.
	g’dpošts
.
is_em±y
() {

26  
E¼
("¶—£ s³cify…d.’dpošts.".
što
());

29 
Ok
(())

33 #[
cfg
(
‹¡
)]

34 
mod
 
	g‹¡s
 {

35 
u£
 
	gsu³r
::*;

37 #[
‹¡
]

38 
â
 
‹¡_pd_cfg
() {

39 
Ët
 
mut
 
	gcfg
 = 
CÚfig
::();

41 
	gcfg
.
v®id©e
().
unw¿p_”r
();

42 
	gcfg
.
	g’dpošts
 = 
vec
!["127.0.0.1:2333".
to_owÃd
()];

43 
	gcfg
.
v®id©e
().
unw¿p
();

	@src/pd/errors.rs

14 
u£
 
	g¡d
::
”rÜ
;

15 
u£
 
	g¡d
::
»suÉ
;

17 
	gquick_”rÜ
!{

18 #[
d”ive
(
Debug
)]

19 
pub
 
	eE¼Ü
 {

20 
Io
(
”r
: ::
¡d
::
io
::
E¼Ü
) {

21 
äom
()

22 
ÿu£
(
”r
)

23 
desütiÚ
(
”r
.description())

25 
Clu¡”BoÙ¡¿µed
(
şu¡”_id
: 
u64
) {

26 
desütiÚ
("cluster bootstrapƒrror")

27 
di¥Ïy
("şu¡” {} i ®»ady boÙ¡¿µed", 
şu¡”_id
)

29 
Clu¡”NÙBoÙ¡¿µed
(
şu¡”_id
: 
u64
) {

30 
desütiÚ
("cluster‚ot bootstrapƒrror")

31 
di¥Ïy
("şu¡” {} i nÙ boÙ¡¿µed", 
şu¡”_id
)

33 
G½c
(
”r
: ::
g½c
::
E¼Ü
) {

34 
äom
()

35 
ÿu£
(
”r
)

36 
desütiÚ
(
”r
.description())

38 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

39 
äom
()

40 
ÿu£
(
”r
.
as_»f
())

41 
desütiÚ
(
”r
.description())

42 
di¥Ïy
("unknowÀ”rÜ {:?}", 
”r
)

48 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

	@src/pd/metrics.rs

14 
u£
 
	g´om‘heus
::*;

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gPD_REQUEST_HISTOGRAM_VEC
: 
Hi¡og¿mVec
 =

18 
»gi¡”_hi¡og¿m_vec
!(

22 ).
unw¿p
();

24 
pub
 
»f
 
	gPD_HEARTBEAT_COUNTER_VEC
: 
CouÁ”Vec
 =

25 
»gi¡”_couÁ”_vec
!(

29 ).
unw¿p
();

31 
pub
 
»f
 
	gPD_VALIDATE_PEER_COUNTER_VEC
: 
CouÁ”Vec
 =

32 
»gi¡”_couÁ”_vec
!(

36 ).
unw¿p
();

38 
pub
 
»f
 
	gSTORE_SIZE_GAUGE_VEC
: 
GaugeVec
 =

39 
»gi¡”_gauge_vec
!(

43 ).
unw¿p
();

45 
pub
 
»f
 
	gREGION_READ_KEYS_HISTOGRAM
: 
Hi¡og¿m
 =

46 
»gi¡”_hi¡og¿m
!(

49 
expÚ’tŸl_buck‘s
(1.0, 2.0, 20).
unw¿p
()

50 ).
unw¿p
();

52 
pub
 
»f
 
	gREGION_READ_BYTES_HISTOGRAM
: 
Hi¡og¿m
 =

53 
»gi¡”_hi¡og¿m
!(

56 
expÚ’tŸl_buck‘s
(256.0, 2.0, 20).
unw¿p
()

57 ).
unw¿p
();

59 
pub
 
»f
 
	gREGION_WRITTEN_BYTES_HISTOGRAM
: 
Hi¡og¿m
 =

60 
»gi¡”_hi¡og¿m
!(

63 
expÚ’tŸl_buck‘s
(256.0, 2.0, 20).
unw¿p
()

64 ).
unw¿p
();

66 
pub
 
»f
 
	gREGION_WRITTEN_KEYS_HISTOGRAM
: 
Hi¡og¿m
 =

67 
»gi¡”_hi¡og¿m
!(

70 
expÚ’tŸl_buck‘s
(1.0, 2.0, 20).
unw¿p
()

71 ).
unw¿p
();

	@src/pd/mod.rs

15 
mod
 
	gm‘rics
;

16 
mod
 
	gş›Á
;

17 
mod
 
	gut
;

19 
pub
 
mod
 
	g”rÜs
;

20 
pub
 
mod
 
	gpd
;

21 
mod
 
	gcÚfig
;

22 
pub
 
u£
 
	g£lf
::
”rÜs
::{
E¼Ü
, 
	gResuÉ
};

23 
pub
 
u£
 
	g£lf
::
ş›Á
::
RpcCl›Á
;

24 
pub
 
u£
 
	g£lf
::
ut
::
v®id©e_’dpošts
;

25 
pub
 
u£
 
	g£lf
::
pd
::{
RuÂ”
 
as
 
PdRuÂ”
, 
Task
‡ 
	gPdTask
};

26 
pub
 
u£
 
	g£lf
::
ut
::
RECONNECT_INTERVAL_SEC
;

27 
pub
 
u£
 
	g£lf
::
cÚfig
::
CÚfig
;

29 
u£
 
	gkv´Ùo
::
m‘­b
;

30 
u£
 
	gkv´Ùo
::
pdpb
;

31 
u£
 
	gfutu»s
::
Futu»
;

33 
pub
 
ty³
 
	gKey
 = 
Vec
<
u8
>;

34 
pub
 
ty³
 
	gPdFutu»
<
	gT
> = 
Box
<
Futu»
<
I‹m
 = 
T
, 
	gE¼Ü
 = 
E¼Ü
> + 
S’d
>;

36 #[
d”ive
(
DeçuÉ
)]

37 
pub
 
	sRegiÚSt
 {

38 
pub
 
	mdown_³”s
: 
Vec
<
pdpb
::
P“rSts
>,

39 
pub
 
	m³ndšg_³”s
: 
Vec
<
m‘­b
::
P“r
>,

40 
pub
 
	mwr™‹n_by‹s
: 
u64
,

41 
pub
 
	mwr™‹n_keys
: 
u64
,

42 
pub
 
	m»ad_by‹s
: 
u64
,

43 
pub
 
	m»ad_keys
: 
u64
,

44 
pub
 
	m­´oxim©e_size
: 
u64
,

47 
im¶
 
	gRegiÚSt
 {

48 
pub
 
â
 
Ãw
(

49 
down_³”s
: 
Vec
<
pdpb
::
P“rSts
>,

50 
³ndšg_³”s
: 
Vec
<
m‘­b
::
P“r
>,

51 
wr™‹n_by‹s
: 
u64
,

52 
wr™‹n_keys
: 
u64
,

53 
»ad_by‹s
: 
u64
,

54 
»ad_keys
: 
u64
,

55 
­´oxim©e_size
: 
u64
,

56 è-> 
	gRegiÚSt
 {

57 
	gRegiÚSt
 {

58 
	gdown_³”s
: 
down_³”s
,

59 
	g³ndšg_³”s
: 
³ndšg_³”s
,

60 
	gwr™‹n_by‹s
: 
wr™‹n_by‹s
,

61 
	gwr™‹n_keys
: 
wr™‹n_keys
,

62 
	g»ad_by‹s
: 
»ad_by‹s
,

63 
	g»ad_keys
: 
»ad_keys
,

64 
	g­´oxim©e_size
: 
­´oxim©e_size
,

69 
pub
 cÚ¡ 
	gINVALID_ID
: 
u64
 = 0;

76 
pub
 
Œa™
 
	gPdCl›Á
: 
S’d
 + 
Sync
 {

78 
â
 
g‘_şu¡”_id
(&
£lf
è-> 
ResuÉ
<
u64
>;

88 
â
 
boÙ¡¿p_şu¡”
(&
£lf
, 
¡Ües
: 
m‘­b
::
StÜe
, 
»giÚ
: m‘­b::
RegiÚ
è-> 
ResuÉ
<()>;

94 
â
 
is_şu¡”_boÙ¡¿µed
(&
£lf
è-> 
	gResuÉ
<
	gboŞ
>;

97 
â
 
®loc_id
(&
£lf
è-> 
	gResuÉ
<
	gu64
>;

101 
â
 
put_¡Üe
(&
£lf
, 
¡Üe
: 
m‘­b
::
StÜe
è-> 
ResuÉ
<()>;

115 
â
 
g‘_¡Üe
(&
£lf
, 
¡Üe_id
: 
u64
è-> 
ResuÉ
<
m‘­b
::
StÜe
>;

118 
â
 
g‘_şu¡”_cÚfig
(&
£lf
è-> 
	gResuÉ
<
	gm‘­b
::
Clu¡”
>;

122 
â
 
g‘_»giÚ
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
m‘­b
::
RegiÚ
>;

125 
â
 
g‘_»giÚ_by_id
(&
£lf
, 
»giÚ_id
: 
u64
è-> 
PdFutu»
<
O±iÚ
<
m‘­b
::
RegiÚ
>>;

128 
â
 
»giÚ_h—¹b—t
(

129 &
£lf
,

130 
»giÚ
: 
m‘­b
::
RegiÚ
,

131 
Ëad”
: 
m‘­b
::
P“r
,

132 
»giÚ_¡©
: 
RegiÚSt
,

133 è-> 
	gPdFutu»
<()>;

138 
â
 
	ghªdË_»giÚ_h—¹b—t_»¥Ú£
<
	gF
>(&
	g£lf
, 
	g¡Üe_id
: 
u64
, 
	gf
: 
F
è-> 
PdFutu»
<()>

139 
wh”e


140 
F
: 
Fn
(
pdpb
::
RegiÚH—¹b—tRe¥Ú£
è+ 
S’d
 + 'static;

143 
â
 
ask_¥l™
(&
£lf
, 
»giÚ
: 
m‘­b
::
RegiÚ
è-> 
PdFutu»
<
pdpb
::
AskS¶™Re¥Ú£
>;

146 
â
 
¡Üe_h—¹b—t
(&
£lf
, 
¡©s
: 
pdpb
::
StÜeSts
è-> 
PdFutu»
<()>;

149 
â
 
»pÜt_¥l™
(&
£lf
, 
Ëá
: 
m‘­b
::
RegiÚ
, 
right
: m‘­b::RegiÚè-> 
PdFutu»
<()>;

152 cÚ¡ 
	gREQUEST_TIMEOUT
: 
u64
 = 2;

	@src/pd/pd.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

15 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

17 
u£
 
	gfutu»s
::
Futu»
;

18 
u£
 
	gtokio_cÜe
::
»aùÜ
::
HªdË
;

20 
u£
 
	gkv´Ùo
::
m‘­b
;

21 
u£
 
	gkv´Ùo
::
”aápb
::
CÚfChªgeTy³
;

22 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
AdmšCmdTy³
, 
	gAdmšReque¡
, 
	gRaáCmdReque¡
};

23 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

24 
u£
 
	gkv´Ùo
::
pdpb
;

25 
u£
 
	grocksdb
::
DB
;

26 
u£
 
	gfs2
;

28 
u£
 
	gut
::
wÜk”
::
Futu»RuÂabË
 
as
 
RuÂabË
;

29 
u£
 
	gut
::
esÿ³
;

30 
u£
 
	gut
::
Œª¥Üt
::
S’dCh
;

31 
u£
 
	gut
::
rocksdb
::*;

32 
u£
 
	gpd
::{
PdCl›Á
, 
	gRegiÚSt
};

33 
u£
 
	g¿á¡Üe
::
¡Üe
::
Msg
;

34 
u£
 
	g¿á¡Üe
::
¡Üe
::
ut
::{
g‘_»giÚ_­´oxim©e_size
, 
	gis_•och_¡®e
};

35 
u£
 
	g¿á¡Üe
::
¡Üe
::¡Üe::
StÜeInfo
;

36 
u£
 
	g¿á¡Üe
::
¡Üe
::
C®lback
;

37 
u£
 
	g¡Üage
::
FlowSti¡ics
;

38 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

39 
u£
 
	g´om‘heus
::
loÿl
::
LoÿlHi¡og¿m
;

40 
u£
 
	gsu³r
::
m‘rics
::*;

43 
pub
 
	eTask
 {

44 
	mAskS¶™
 {

45 
	m»giÚ
: 
m‘­b
::
RegiÚ
,

46 
	m¥l™_key
: 
Vec
<
u8
>,

47 
	m³”
: 
m‘­b
::
P“r
,

49 
	mright_d”ive
: 
boŞ
,

50 
	mÿÎback
: 
O±iÚ
<
C®lback
>,

52 
	mH—¹b—t
 {

53 
	m»giÚ
: 
m‘­b
::
RegiÚ
,

54 
	m³”
: 
m‘­b
::
P“r
,

55 
	mdown_³”s
: 
Vec
<
pdpb
::
P“rSts
>,

56 
	m³ndšg_³”s
: 
Vec
<
m‘­b
::
P“r
>,

57 
	mwr™‹n_by‹s
: 
u64
,

58 
	mwr™‹n_keys
: 
u64
,

59 
	m»giÚ_size
: 
O±iÚ
<
u64
>,

61 
	mStÜeH—¹b—t
 {

62 
	m¡©s
: 
pdpb
::
StÜeSts
,

63 
	m¡Üe_šfo
: 
StÜeInfo
,

65 
	mR•ÜtS¶™
 {

66 
	mËá
: 
m‘­b
::
RegiÚ
,

67 
	mright
: 
m‘­b
::
RegiÚ
,

69 
	mV®id©eP“r
 {

70 
	m»giÚ
: 
m‘­b
::
RegiÚ
,

71 
	m³”
: 
m‘­b
::
P“r
,

73 
	mR—dSts
 { 
	m»ad_¡©s
: 
HashM­
<
u64
, 
	mFlowSti¡ics
>, },

74 
	mDe¡royP“r
 { 
	m»giÚ_id
: 
u64
 },

77 
pub
 
	sStÜeSt
 {

78 
pub
 
	m’gše_tÙ®_by‹s_»ad
: 
u64
,

79 
pub
 
	m’gše_tÙ®_keys_»ad
: 
u64
,

80 
pub
 
	m’gše_Ï¡_tÙ®_by‹s_»ad
: 
u64
,

81 
pub
 
	m’gše_Ï¡_tÙ®_keys_»ad
: 
u64
,

83 
pub
 
	m»giÚ_by‹s_»ad
: 
LoÿlHi¡og¿m
,

84 
pub
 
	m»giÚ_keys_»ad
: 
LoÿlHi¡og¿m
,

85 
pub
 
	m»giÚ_by‹s_wr™‹n
: 
LoÿlHi¡og¿m
,

86 
pub
 
	m»giÚ_keys_wr™‹n
: 
LoÿlHi¡og¿m
,

89 
im¶
 
DeçuÉ
 
	gStÜeSt
 {

90 
â
 (è-> 
	gStÜeSt
 {

91 
	gStÜeSt
 {

92 
	g»giÚ_by‹s_»ad
: 
REGION_READ_BYTES_HISTOGRAM
.
loÿl
(),

93 
	g»giÚ_keys_»ad
: 
REGION_READ_KEYS_HISTOGRAM
.
loÿl
(),

94 
	g»giÚ_by‹s_wr™‹n
: 
REGION_WRITTEN_BYTES_HISTOGRAM
.
loÿl
(),

95 
	g»giÚ_keys_wr™‹n
: 
REGION_WRITTEN_KEYS_HISTOGRAM
.
loÿl
(),

97 
	g’gše_tÙ®_by‹s_»ad
: 0,

98 
	g’gše_tÙ®_keys_»ad
: 0,

99 
	g’gše_Ï¡_tÙ®_by‹s_»ad
: 0,

100 
	g’gše_Ï¡_tÙ®_keys_»ad
: 0,

105 #[
d”ive
(
DeçuÉ
)]

106 
pub
 
	sP“rSt
 {

107 
pub
 
	m»ad_by‹s
: 
u64
,

108 
pub
 
	m»ad_keys
: 
u64
,

109 
pub
 
	mÏ¡_»ad_by‹s
: 
u64
,

110 
pub
 
	mÏ¡_»ad_keys
: 
u64
,

111 
pub
 
	mÏ¡_wr™‹n_by‹s
: 
u64
,

112 
pub
 
	mÏ¡_wr™‹n_keys
: 
u64
,

115 
im¶
 
Di¥Ïy
 
	gTask
 {

116 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

117 
m©ch
 *
£lf
 {

118 
Task
::
AskS¶™
 {

119 
»f
 
»giÚ
,

120 
»f
 
	g¥l™_key
,

122 } => 
wr™e
!(

123 
f
,

125 
	g»giÚ
.
g‘_id
(),

126 
esÿ³
(
¥l™_key
)

128 
	gTask
::
H—¹b—t
 {

129 
»f
 
»giÚ
,

130 
»f
 
	g³”
,

132 } => 
wr™e
!(

133 
f
,

135 
	g»giÚ
,

136 
	g³”
.
g‘_id
()

138 
	gTask
::
StÜeH—¹b—t
 { 
»f
 
¡©s
, .. } => {

139 
wr™e
!(
f
, "¡Üh—¹b—ˆ¡©s: {:?}", 
¡©s
)

141 
Task
::
R•ÜtS¶™
 {

142 
»f
 
Ëá
,

143 
»f
 
right
,

144 } => 
wr™e
!(
f
, "»pÜˆ¥l™†eá {:?},„ighˆ{:?}", 
	gËá
, 
	gright
),

145 
	gTask
::
V®id©eP“r
 {

146 
»f
 
»giÚ
,

147 
»f
 
	g³”
,

148 } => 
wr™e
!(
f
, "v®id©³” {:?} w™h„egiÚ {:?}", 
	g³”
, 
	g»giÚ
),

149 
	gTask
::
R—dSts
 { 
»f
 
»ad_¡©s
 } => {

150 
wr™e
!(
f
, "g‘h»ad sti¡ic {:?}", 
»ad_¡©s
)

152 
Task
::
De¡royP“r
 { 
»f
 
»giÚ_id
 } => 
wr™e
!(
f
, "de¡roy…“¸{}", 
	g»giÚ_id
),

157 
pub
 
	gRuÂ”
<
	gT
: 
PdCl›Á
> {

158 
¡Üe_id
: 
u64
,

159 
	gpd_ş›Á
: 
Arc
<
T
>,

160 
	gch
: 
S’dCh
<
Msg
>,

161 
	gdb
: 
Arc
<
DB
>,

162 
	g»giÚ_³”s
: 
HashM­
<
u64
, 
	gP“rSt
>,

163 
	g¡Üe_¡©
: 
StÜeSt
,

164 
	gis_hb_»ûiv”_scheduËd
: 
boŞ
,

167 
	gim¶
<
	gT
: 
PdCl›Á
> 
RuÂ”
<
T
> {

168 
pub
 
â
 
Ãw
(
¡Üe_id
: 
u64
, 
pd_ş›Á
: 
Arc
<
T
>, 
ch
: 
S’dCh
<
Msg
>, 
db
: Arc<
DB
>è-> 
RuÂ”
<T> {

169 
RuÂ”
 {

170 
¡Üe_id
: store_id,

171 
	gpd_ş›Á
: 
pd_ş›Á
,

172 
	gch
: 
ch
,

173 
	gdb
: 
db
,

174 
	gis_hb_»ûiv”_scheduËd
: 
çl£
,

175 
	g»giÚ_³”s
: 
HashM­
::(),

176 
	g¡Üe_¡©
: 
StÜeSt
::(),

180 
â
 
hªdË_ask_¥l™
(

181 &
£lf
,

182 
hªdË
: &
HªdË
,

183 
mut
 
»giÚ
: 
m‘­b
::
RegiÚ
,

184 
¥l™_key
: 
Vec
<
u8
>,

185 
³”
: 
m‘­b
::
P“r
,

186 
right_d”ive
: 
boŞ
,

187 
ÿÎback
: 
O±iÚ
<
C®lback
>,

189 
Ët
 
	gch
 = 
£lf
.
ch
.
şÚe
();

190 
Ët
 
	gf
 = 
£lf
.
pd_ş›Á
.
ask_¥l™
(
»giÚ
.
şÚe
()).
th’
(
move
 |
»¥
| {

191 
m©ch
 
»¥
 {

192 
Ok
(
mut
 
»¥
) => {

193 
šfo
!(

195 
»giÚ
.
g‘_id
(),

196 
»¥
.
g‘_Ãw_»giÚ_id
(),

197 
»giÚ


200 
Ët
 
»q
 = 
Ãw_¥l™_»giÚ_»que¡
(

201 
¥l™_key
,

202 
»¥
.
g‘_Ãw_»giÚ_id
(),

203 
»¥
.
ke_Ãw_³”_ids
(),

204 
right_d”ive
,

206 
Ët
 
»giÚ_id
 = 
»giÚ
.
g‘_id
();

207 
Ët
 
•och
 = 
»giÚ
.
ke_»giÚ_•och
();

208 
£nd_admš_»que¡
(&
ch
, 
»giÚ_id
, 
•och
, 
³”
, 
»q
, 
ÿÎback
)

210 
E¼
(
e
) => {

211 
debug
!("[»giÚ {}] faedØask s¶™: {:?}", 
»giÚ
.
g‘_id
(), 
e
);

214 
Ok
(())

216 
	ghªdË
.
¥awn
(
f
)

219 
â
 
hªdË_h—¹b—t
(

220 &
£lf
,

221 
hªdË
: &
HªdË
,

222 
»giÚ
: 
m‘­b
::
RegiÚ
,

223 
³”
: 
m‘­b
::
P“r
,

224 
»giÚ_¡©
: 
RegiÚSt
,

226 
	g£lf
.
	g¡Üe_¡©


227 .
	g»giÚ_by‹s_wr™‹n


228 .
ob£rve
(
»giÚ_¡©
.
wr™‹n_by‹s
 
as
 
f64
);

229 
	g£lf
.
	g¡Üe_¡©


230 .
	g»giÚ_keys_wr™‹n


231 .
ob£rve
(
»giÚ_¡©
.
wr™‹n_keys
 
as
 
f64
);

232 
	g£lf
.
	g¡Üe_¡©


233 .
	g»giÚ_by‹s_»ad


234 .
ob£rve
(
»giÚ_¡©
.
»ad_by‹s
 
as
 
f64
);

235 
	g£lf
.
	g¡Üe_¡©


236 .
	g»giÚ_keys_»ad


237 .
ob£rve
(
»giÚ_¡©
.
»ad_keys
 
as
 
f64
);

240 
Ët
 
	gf
 = 
£lf
.
pd_ş›Á


241 .
»giÚ_h—¹b—t
(
»giÚ
.
şÚe
(), 
³”
.şÚe(), 
»giÚ_¡©
)

242 .
m­_”r
(
move
 |
e
| {

243 
debug
!(

245 
»giÚ
.
g‘_id
(),

246 
e


249 
	ghªdË
.
¥awn
(
f
);

252 
â
 
hªdË_¡Üe_h—¹b—t
(

253 &
mut
 
£lf
,

254 
hªdË
: &
HªdË
,

255 
mut
 
¡©s
: 
pdpb
::
StÜeSts
,

256 
¡Üe_šfo
: 
StÜeInfo
,

258 
Ët
 
	gdisk_¡©s
 = 
m©ch
 
fs2
::
¡©vfs
(
¡Üe_šfo
.
’gše
.
·th
()) {

259 
E¼
(
e
) => {

260 
”rÜ
!(

262 
¡Üe_šfo
.
’gše
.
·th
(),

263 
e


267 
Ok
(
¡©s
) => stats,

270 
Ët
 
	gdisk_ÿp
 = 
disk_¡©s
.
tÙ®_¥aû
();

271 
Ët
 
	gÿ·c™y
 = 
¡Üe_šfo
.
ÿ·c™y
 =ğ0 || 
disk_ÿp
 < store_info.capacity {

272 
disk_ÿp


274 
¡Üe_šfo
.
ÿ·c™y


276 
	g¡©s
.
£t_ÿ·c™y
(
ÿ·c™y
);

278 
Ët
 
	gu£d_size
 = 
¡©s
.
g‘_u£d_size
(è+ 
g‘_’gše_u£d_size
(
¡Üe_šfo
.
’gše
.
şÚe
());

279 
	g¡©s
.
£t_u£d_size
(
u£d_size
);

282 
Ët
 
mut
 
	gavaabË
 = 
ÿ·c™y
 > 
u£d_size
 {

283 
ÿ·c™y
 - 
u£d_size


285 
w¬n
!("no‡vailable space");

291 
	gavaabË
 > 
	gdisk_¡©s
.
ä“_¥aû
() {

292 
	gavaabË
 = 
disk_¡©s
.
ä“_¥aû
();

295 
	g¡©s
.
£t_avaabË
(
avaabË
);

296 
	g¡©s
.
£t_by‹s_»ad
(

297 
£lf
.
¡Üe_¡©
.
’gše_tÙ®_by‹s_»ad
 - s–f.¡Üe_¡©.
’gše_Ï¡_tÙ®_by‹s_»ad
,

299 
	g¡©s
.
£t_keys_»ad
(

300 
£lf
.
¡Üe_¡©
.
’gše_tÙ®_keys_»ad
 - s–f.¡Üe_¡©.
’gše_Ï¡_tÙ®_keys_»ad
,

302 
	g£lf
.
	g¡Üe_¡©
.
	g’gše_Ï¡_tÙ®_by‹s_»ad
 = 
£lf
.
¡Üe_¡©
.
’gše_tÙ®_by‹s_»ad
;

303 
	g£lf
.
	g¡Üe_¡©
.
	g’gše_Ï¡_tÙ®_keys_»ad
 = 
£lf
.
¡Üe_¡©
.
’gše_tÙ®_keys_»ad
;

305 
	g£lf
.
	g¡Üe_¡©
.
	g»giÚ_by‹s_wr™‹n
.
æush
();

306 
	g£lf
.
	g¡Üe_¡©
.
	g»giÚ_keys_wr™‹n
.
æush
();

307 
	g£lf
.
	g¡Üe_¡©
.
	g»giÚ_by‹s_»ad
.
æush
();

308 
	g£lf
.
	g¡Üe_¡©
.
	g»giÚ_keys_»ad
.
æush
();

310 
	gSTORE_SIZE_GAUGE_VEC


311 .
w™h_Ïb–_v®ues
(&["capacity"])

312 .
£t
(
ÿ·c™y
 
as
 
f64
);

313 
	gSTORE_SIZE_GAUGE_VEC


314 .
w™h_Ïb–_v®ues
(&["available"])

315 .
£t
(
avaabË
 
as
 
f64
);

317 
Ët
 
	gf
 = 
£lf
.
pd_ş›Á
.
¡Üe_h—¹b—t
(
¡©s
).
m­_”r
(|
e
| {

318 
”rÜ
!("¡Üh—¹b—ˆçed {:?}", 
e
);

320 
	ghªdË
.
¥awn
(
f
);

323 
â
 
hªdË_»pÜt_¥l™
(&
£lf
, 
hªdË
: &
HªdË
, 
Ëá
: 
m‘­b
::
RegiÚ
, 
right
: metapb::Region) {

324 
Ët
 
f
 = 
£lf
.
pd_ş›Á
.
»pÜt_¥l™
(
Ëá
, 
right
).
m­_”r
(|
e
| {

325 
debug
!("»pÜˆ¥l™ faed {:?}", 
e
);

327 
	ghªdË
.
¥awn
(
f
);

330 
â
 
hªdË_v®id©e_³”
(

331 &
£lf
,

332 
hªdË
: &
HªdË
,

333 
loÿl_»giÚ
: 
m‘­b
::
RegiÚ
,

334 
³”
: 
m‘­b
::
P“r
,

336 
Ët
 
	gch
 = 
£lf
.
ch
.
şÚe
();

337 
Ët
 
	gf
 = 
£lf
.
pd_ş›Á
.
g‘_»giÚ_by_id
(
loÿl_»giÚ
.
g‘_id
()).
th’
(
move
 |
»¥
| {

338 
m©ch
 
»¥
 {

339 
Ok
(
Some
(
pd_»giÚ
)) => {

340 
is_•och_¡®e
(
pd_»giÚ
.
g‘_»giÚ_•och
(),

341 
loÿl_»giÚ
.
g‘_»giÚ_•och
()) {

346 
”rÜ
!("[region {}] {}he†ocal„egionƒpoch: {:?} is greaterhe \
ƒpoch in PD: {:?}. Something is wrong!",

348 
loÿl_»giÚ
.
g‘_id
(),

349 
³”
.
g‘_id
(),

350 
loÿl_»giÚ
.
g‘_»giÚ_•och
(),

351 
pd_»giÚ
.
g‘_»giÚ_•och
());

352 
PD_VALIDATE_PEER_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["regionƒpochƒrror"])

353 .
šc
();

354  
Ok
(());

357 
pd_»giÚ
.
g‘_³”s
().
što_™”
().
®l
(|
p
|… !ğ&
³”
) {

360 
šfo
!("[region {}] {} is‚ot‡ valid member of„egion {:?}. To be \
 soon.",

362 
loÿl_»giÚ
.
g‘_id
(),

363 
³”
.
g‘_id
(),

364 
pd_»giÚ
);

365 
PD_VALIDATE_PEER_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["³” sË"]).
šc
();

366 
£nd_de¡roy_³”_mes§ge
(
ch
, 
loÿl_»giÚ
, 
³”
, 
pd_»giÚ
);

367  
Ok
(());

369 
šfo
!("[region {}] {} is still valid in„egion {:?}",

370 
loÿl_»giÚ
.
g‘_id
(),

371 
³”
.
g‘_id
(),

372 
pd_»giÚ
);

373 
PD_VALIDATE_PEER_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["³” v®id"]).
šc
();

375 
Ok
(
NÚe
) => {

379 
E¼
(
e
) => {

380 
”rÜ
!("g‘„egiÚ faed {:?}", 
e
);

383 
Ok
(())

385 
	ghªdË
.
¥awn
(
f
);

388 
â
 
scheduË_h—¹b—t_»ûiv”
(&
mut
 
£lf
, 
hªdË
: &
HªdË
) {

389 
Ët
 
ch
 = 
£lf
.ch.
şÚe
();

390 
Ët
 
	g¡Üe_id
 = 
£lf
.
¡Üe_id
;

391 
Ët
 
	gf
 = 
£lf
.
pd_ş›Á


392 .
hªdË_»giÚ_h—¹b—t_»¥Ú£
(
£lf
.
¡Üe_id
, 
move
 |
mut
 
»¥
| {

393 
Ët
 
»giÚ_id
 = 
»¥
.
g‘_»giÚ_id
();

394 
Ët
 
•och
 = 
»¥
.
ke_»giÚ_•och
();

395 
Ët
 
³”
 = 
»¥
.
ke_rg‘_³”
();

397 
»¥
.
has_chªge_³”
() {

398 
PD_HEARTBEAT_COUNTER_VEC


399 .
w™h_Ïb–_v®ues
(&["change…eer"])

400 .
šc
();

402 
Ët
 
mut
 
chªge_³”
 = 
»¥
.
ke_chªge_³”
();

403 
šfo
!(

405 
»giÚ_id
,

406 
chªge_³”
.
g‘_chªge_ty³
(),

407 
chªge_³”
.
g‘_³”
()

409 
Ët
 
»q
 = 
Ãw_chªge_³”_»que¡
(

410 
chªge_³”
.
g‘_chªge_ty³
().
što
(),

411 
chªge_³”
.
ke_³”
(),

413 
£nd_admš_»que¡
(&
ch
, 
»giÚ_id
, 
•och
, 
³”
, 
»q
, 
NÚe
);

414 } 
»¥
.
has_Œªsãr_Ëad”
() {

415 
PD_HEARTBEAT_COUNTER_VEC


416 .
w™h_Ïb–_v®ues
(&["transfer†eader"])

417 .
šc
();

419 
Ët
 
mut
 
Œªsãr_Ëad”
 = 
»¥
.
ke_Œªsãr_Ëad”
();

420 
šfo
!(

422 
»giÚ_id
,

423 
³”
,

424 
Œªsãr_Ëad”
.
g‘_³”
()

426 
Ët
 
»q
 = 
Ãw_Œªsãr_Ëad”_»que¡
(
Œªsãr_Ëad”
.
ke_³”
());

427 
£nd_admš_»que¡
(&
ch
, 
»giÚ_id
, 
•och
, 
³”
, 
»q
, 
NÚe
)

429 
PD_HEARTBEAT_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["noİ"]).
šc
();

432 .
m­_”r
(|
e
| 
·nic
!("unexpectedƒrror: {:?}",ƒ))

433 .
m­
(
move
 |
_
| {

434 
šfo
!(

436 
¡Üe_id


439 
	ghªdË
.
¥awn
(
f
);

440 
	g£lf
.
	gis_hb_»ûiv”_scheduËd
 = 
Œue
;

443 
â
 
hªdË_»ad_¡©s
(&
mut
 
£lf
, 
»ad_¡©s
: 
HashM­
<
u64
, 
FlowSti¡ics
>) {

444 
	g»giÚ_id
, 
	g¡©s
è
š
 
	g»ad_¡©s
 {

445 
Ët
 
	g³”_¡©
 = 
£lf
.
»giÚ_³”s


446 .
’Œy
(
»giÚ_id
)

447 .
Ü_š£¹_w™h
(
P“rSt
::);

448 
	g³”_¡©
.
	g»ad_by‹s
 +ğ
¡©s
.
»ad_by‹s
 
as
 
u64
;

449 
	g³”_¡©
.
	g»ad_keys
 +ğ
¡©s
.
»ad_keys
 
as
 
u64
;

450 
	g£lf
.
	g¡Üe_¡©
.
	g’gše_tÙ®_by‹s_»ad
 +ğ
¡©s
.
»ad_by‹s
 
as
 
u64
;

451 
	g£lf
.
	g¡Üe_¡©
.
	g’gše_tÙ®_keys_»ad
 +ğ
¡©s
.
»ad_keys
 
as
 
u64
;

455 
â
 
hªdË_de¡roy_³”
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
) {

456 
m©ch
 
£lf
.
»giÚ_³”s
.
»move
(&
»giÚ_id
) {

457 
NÚe
 => ,

458 
Some
(
_
è=> 
šfo
!("[»giÚ {}]„emov³” sti¡iø»cÜd iÀpd", 
	g»giÚ_id
),

463 
	gim¶
<
	gT
: 
PdCl›Á
> 
RuÂabË
<
Task
> 
RuÂ”
<
T
> {

464 
â
 
run
(&
mut
 
£lf
, 
sk
: 
Task
, 
hªdË
: &
HªdË
) {

465 
debug
!("executšgask {}", 
	gsk
);

467 !
	g£lf
.
	gis_hb_»ûiv”_scheduËd
 {

468 
	g£lf
.
scheduË_h—¹b—t_»ûiv”
(
hªdË
);

471 
m©ch
 
	gsk
 {

472 
	gTask
::
AskS¶™
 {

473 
»giÚ
,

474 
	g¥l™_key
,

475 
	g³”
,

476 
	gright_d”ive
,

477 
	gÿÎback
,

478 } => 
£lf
.
hªdË_ask_¥l™
(
hªdË
, 
»giÚ
, 
¥l™_key
, 
³”
, 
right_d”ive
, 
ÿÎback
),

479 
	gTask
::
H—¹b—t
 {

480 
»giÚ
,

481 
	g³”
,

482 
	gdown_³”s
,

483 
	g³ndšg_³”s
,

484 
	gwr™‹n_by‹s
,

485 
	gwr™‹n_keys
,

486 
	g»giÚ_size
,

488 
Ët
 
­´oxim©e_size
 = 
m©ch
 
»giÚ_size
 {

489 
Some
(
size
) => size,

490 
	gNÚe
 => 
g‘_»giÚ_­´oxim©e_size
(&
£lf
.
db
, &
»giÚ
).
unw¿p_Ü
(0),

492 
Ët
 (
»ad_by‹s_d–
, 
»ad_keys_d–
, 
wr™‹n_by‹s_d–
, 
wr™‹n_keys_d–
) = {

493 
Ët
 
³”_¡©
 = 
£lf
.
»giÚ_³”s


494 .
’Œy
(
»giÚ
.
g‘_id
())

495 .
Ü_š£¹_w™h
(
P“rSt
::);

496 
Ët
 
	g»ad_by‹s_d–
 = 
³”_¡©
.
»ad_by‹s
 -…“r_¡©.
Ï¡_»ad_by‹s
;

497 
Ët
 
	g»ad_keys_d–
 = 
³”_¡©
.
»ad_keys
 -…“r_¡©.
Ï¡_»ad_keys
;

498 
Ët
 
	gwr™‹n_by‹s_d–
 = 
wr™‹n_by‹s
 - 
³”_¡©
.
Ï¡_wr™‹n_by‹s
;

499 
Ët
 
	gwr™‹n_keys_d–
 = 
wr™‹n_keys
 - 
³”_¡©
.
Ï¡_wr™‹n_keys
;

500 
	g³”_¡©
.
	gÏ¡_wr™‹n_by‹s
 = 
wr™‹n_by‹s
;

501 
	g³”_¡©
.
	gÏ¡_wr™‹n_keys
 = 
wr™‹n_keys
;

502 
	g³”_¡©
.
	gÏ¡_»ad_by‹s
 = 
³”_¡©
.
»ad_by‹s
;

503 
	g³”_¡©
.
	gÏ¡_»ad_keys
 = 
³”_¡©
.
»ad_keys
;

505 
	g»ad_by‹s_d–
,

506 
	g»ad_keys_d–
,

507 
	gwr™‹n_by‹s_d–
,

508 
	gwr™‹n_keys_d–
,

511 
	g£lf
.
hªdË_h—¹b—t
(

512 
hªdË
,

513 
»giÚ
,

514 
³”
,

515 
RegiÚSt
::
Ãw
(

516 
down_³”s
,

517 
³ndšg_³”s
,

518 
wr™‹n_by‹s_d–
,

519 
wr™‹n_keys_d–
,

520 
»ad_by‹s_d–
,

521 
»ad_keys_d–
,

522 
­´oxim©e_size
,

526 
	gTask
::
StÜeH—¹b—t
 { 
¡©s
, 
	g¡Üe_šfo
 } => {

527 
£lf
.
hªdË_¡Üe_h—¹b—t
(
hªdË
, 
¡©s
, 
¡Üe_šfo
)

529 
Task
::
R•ÜtS¶™
 { 
Ëá
, 
right
 } => 
£lf
.
hªdË_»pÜt_¥l™
(
hªdË
,†eft,„ight),

530 
	gTask
::
V®id©eP“r
 { 
»giÚ
, 
	g³”
 } => 
£lf
.
hªdË_v®id©e_³”
(
hªdË
,„egiÚ, 
³”
),

531 
	gTask
::
R—dSts
 { 
»ad_¡©s
 } => 
£lf
.
hªdË_»ad_¡©s
(read_stats),

532 
	gTask
::
De¡royP“r
 { 
»giÚ_id
 } => 
£lf
.
hªdË_de¡roy_³”
(region_id),

537 
â
 
Ãw_chªge_³”_»que¡
(
chªge_ty³
: 
CÚfChªgeTy³
, 
³”
: 
m‘­b
::
P“r
è-> 
AdmšReque¡
 {

538 
Ët
 
mut
 
»q
 = 
AdmšReque¡
::
Ãw
();

539 
	g»q
.
£t_cmd_ty³
(
AdmšCmdTy³
::
ChªgeP“r
);

540 
	g»q
.
mut_chªge_³”
().
£t_chªge_ty³
(
chªge_ty³
.
što
());

541 
	g»q
.
mut_chªge_³”
().
£t_³”
(
³”
);

542 
	g»q


545 
â
 
Ãw_¥l™_»giÚ_»que¡
(

546 
¥l™_key
: 
Vec
<
u8
>,

547 
Ãw_»giÚ_id
: 
u64
,

548 
³”_ids
: 
Vec
<
u64
>,

549 
right_d”ive
: 
boŞ
,

550 è-> 
	gAdmšReque¡
 {

551 
Ët
 
mut
 
	g»q
 = 
AdmšReque¡
::
Ãw
();

552 
	g»q
.
£t_cmd_ty³
(
AdmšCmdTy³
::
S¶™
);

553 
	g»q
.
mut_¥l™
().
£t_¥l™_key
(
¥l™_key
);

554 
	g»q
.
mut_¥l™
().
£t_Ãw_»giÚ_id
(
Ãw_»giÚ_id
);

555 
	g»q
.
mut_¥l™
().
£t_Ãw_³”_ids
(
³”_ids
);

556 
	g»q
.
mut_¥l™
().
£t_right_d”ive
(
right_d”ive
);

557 
	g»q


560 
â
 
Ãw_Œªsãr_Ëad”_»que¡
(
³”
: 
m‘­b
::
P“r
è-> 
AdmšReque¡
 {

561 
Ët
 
mut
 
»q
 = 
AdmšReque¡
::
Ãw
();

562 
	g»q
.
£t_cmd_ty³
(
AdmšCmdTy³
::
T¿nsãrL—d”
);

563 
	g»q
.
mut_Œªsãr_Ëad”
().
£t_³”
(
³”
);

564 
	g»q


567 
â
 
£nd_admš_»que¡
(

568 
ch
: &
S’dCh
<
Msg
>,

569 
»giÚ_id
: 
u64
,

570 
•och
: 
m‘­b
::
RegiÚEpoch
,

571 
³”
: 
m‘­b
::
P“r
,

572 
»que¡
: 
AdmšReque¡
,

573 
ÿÎback
: 
O±iÚ
<
C®lback
>,

575 
Ët
 
	gcmd_ty³
 = 
»que¡
.
g‘_cmd_ty³
();

577 
Ët
 
mut
 
	g»q
 = 
RaáCmdReque¡
::
Ãw
();

578 
	g»q
.
mut_h—d”
().
£t_»giÚ_id
(
»giÚ_id
);

579 
	g»q
.
mut_h—d”
().
£t_»giÚ_•och
(
•och
);

580 
	g»q
.
mut_h—d”
().
£t_³”
(
³”
);

582 
	g»q
.
£t_admš_»que¡
(
»que¡
);

584 
Ët
 
E¼
(
e
èğ
ch
.
Œy_£nd
(
Msg
::
Ãw_¿á_cmd
(

585 
»q
,

586 
ÿÎback
.
unw¿p_Ü_–£
(|| 
Box
::
Ãw
(|
_
| {})),

588 
	g”rÜ
!(

590 
	g»giÚ_id
,

591 
	gcmd_ty³
,

592 
	ge


598 
â
 
£nd_de¡roy_³”_mes§ge
(

599 
ch
: 
S’dCh
<
Msg
>,

600 
loÿl_»giÚ
: 
m‘­b
::
RegiÚ
,

601 
³”
: 
m‘­b
::
P“r
,

602 
pd_»giÚ
: 
m‘­b
::
RegiÚ
,

604 
Ët
 
mut
 
	gmes§ge
 = 
RaáMes§ge
::
Ãw
();

605 
	gmes§ge
.
£t_»giÚ_id
(
loÿl_»giÚ
.
g‘_id
());

606 
	gmes§ge
.
£t_äom_³”
(
³”
.
şÚe
());

607 
	gmes§ge
.
£t_to_³”
(
³”
.
şÚe
());

608 
	gmes§ge
.
£t_»giÚ_•och
(
pd_»giÚ
.
g‘_»giÚ_•och
().
şÚe
());

609 
	gmes§ge
.
£t_is_tomb¡Úe
(
Œue
);

610 
Ët
 
E¼
(
e
èğ
ch
.
Œy_£nd
(
Msg
::
RaáMes§ge
(
mes§ge
)) {

611 
”rÜ
!(

613 
loÿl_»giÚ
.
g‘_id
(),

614 
e


	@src/pd/util.rs

14 
u£
 
	g¡d
::
»suÉ
;

15 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	g¡d
::
sync
::
RwLock
;

17 
u£
 
	g¡d
::
time
::
In¡ªt
;

18 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

19 
u£
 
	g¡d
::
cŞËùiÚs
::
HashS‘
;

21 
u£
 
	gfutu»s
::{
sk
, 
	gAsync
, 
	gFutu»
, 
	gPŞl
, 
	gSŒ—m
};

22 
u£
 
	gfutu»s
::
sk
::
Task
;

23 
u£
 
	gfutu»s
::
futu»
::{
loİ_â
, 
	gok
, 
	gLoİ
};

24 
u£
 
	gfutu»s
::
sync
::
mpsc
::
UnboundedS’d”
;

25 
u£
 
	gg½c
::{
C®lO±iÚ
, 
	gChªÃlBud”
, 
	gCl›ÁDu¶exReûiv”
, 
	gCl›ÁDu¶exS’d”
, 
	gEnvœÚm’t
,

26 
ResuÉ
 
as
 
	gG½cResuÉ
};

27 
u£
 
	gtokio_tim”
::
Tim”
;

28 
u£
 
	gkv´Ùo
::
pdpb
::{
E¼ÜTy³
, 
	gG‘Memb”sReque¡
, 
	gG‘Memb”sRe¥Ú£
, 
	gMemb”
,

29 
	gRegiÚH—¹b—tReque¡
, 
	gRegiÚH—¹b—tRe¥Ú£
, 
	gRe¥Ú£H—d”
};

30 
u£
 
	gkv´Ùo
::
pdpb_g½c
::
PdCl›Á
;

32 
u£
 
	gut
::{
E™h”
, 
	gHªdyRwLock
};

33 
u£
 
	gut
::
£cur™y
::
Secur™yMªag”
;

34 
u£
 
	gsu³r
::{
CÚfig
, 
	gE¼Ü
, 
	gPdFutu»
, 
	gResuÉ
, 
	gREQUEST_TIMEOUT
};

36 
pub
 
	sIÂ”
 {

37 
	m’v
: 
Arc
<
EnvœÚm’t
>,

38 
pub
 
	mhb_£nd”
: 
E™h”
<

39 
O±iÚ
<
Cl›ÁDu¶exS’d”
<
RegiÚH—¹b—tReque¡
>>,

40 
	mUnboundedS’d”
<
	mRegiÚH—¹b—tReque¡
>,

42 
pub
 
	mhb_»ûiv”
: 
E™h”
<
O±iÚ
<
Cl›ÁDu¶exReûiv”
<
RegiÚH—¹b—tRe¥Ú£
>>, 
	mTask
>,

43 
pub
 
	mş›Á
: 
PdCl›Á
,

44 
	mmemb”s
: 
G‘Memb”sRe¥Ú£
,

45 
	m£cur™y_mgr
: 
Arc
<
Secur™yMªag”
>,

47 
	mÏ¡_upd©e
: 
In¡ªt
,

50 
pub
 
	sH—¹b—tReûiv”
 {

51 
	m»ûiv”
: 
O±iÚ
<
Cl›ÁDu¶exReûiv”
<
RegiÚH—¹b—tRe¥Ú£
>>,

52 
	mšÃr
: 
Arc
<
RwLock
<
IÂ”
>>,

55 
im¶
 
SŒ—m
 
	gH—¹b—tReûiv”
 {

56 
ty³
 
	gI‹m
 = 
RegiÚH—¹b—tRe¥Ú£
;

57 
ty³
 
	gE¼Ü
 = 
E¼Ü
;

59 
â
 
pŞl
(&
mut
 
£lf
è-> 
	gPŞl
<
	gO±iÚ
<
	gS–f
::
I‹m
>, 
	gE¼Ü
> {

60 
	gloİ
 {

61 
Ët
 
Some
(
»f
 
mut
 
»ûiv”
èğ
£lf
.receiver {

62 
m©ch
 
»ûiv”
.
pŞl
() {

63 
Ok
(
Async
::
R—dy
(
Some
(
™em
))) =>  Ok(Async::Ready(Some(item))),

64 
Ok
(
Async
::
NÙR—dy
) =>  Ok(Async::NotReady),

66 
	g_
 => {}

70 
	g£lf
.
	g»ûiv”
.
ke
();

72 
Ët
 
mut
 
	gšÃr
 = 
£lf
.
šÃr
.
wl
();

73 
Ët
 
mut
 
	g»ûiv”
 = 
NÚe
;

74 
Ët
 
	gE™h”
::
Leá
(
»f
 
mut
 
»cv
èğ
šÃr
.
hb_»ûiv”
 {

75 
»ûiv”
 = 
»cv
.
ke
();

77 
	g»ûiv”
.
is_some
() {

78 
	g£lf
.
	g»ûiv”
 = 
»ûiv”
;

80 
	gšÃr
.
	ghb_»ûiv”
 = 
E™h”
::
Right
(
sk
::
cu¼’t
());

81  
Ok
(
Async
::
NÙR—dy
);

88 
pub
 
	sL—d”Cl›Á
 {

89 
	mtim”
: 
Tim”
,

90 
	mšÃr
: 
Arc
<
RwLock
<
IÂ”
>>,

93 
im¶
 
	gL—d”Cl›Á
 {

94 
pub
 
â
 
Ãw
(

95 
’v
: 
Arc
<
EnvœÚm’t
>,

96 
£cur™y_mgr
: 
Arc
<
Secur™yMªag”
>,

97 
ş›Á
: 
PdCl›Á
,

98 
memb”s
: 
G‘Memb”sRe¥Ú£
,

99 è-> 
	gL—d”Cl›Á
 {

100 
Ët
 (
tx
, 
rx
èğ
ş›Á
.
»giÚ_h—¹b—t
();

101 
	gL—d”Cl›Á
 {

102 
	gtim”
: 
Tim”
::(),

103 
	gšÃr
: 
Arc
::
Ãw
(
RwLock
::Ãw(
IÂ”
 {

104 
’v
:ƒnv,

105 
hb_£nd”
: 
E™h”
::
Leá
(
Some
(
tx
)),

106 
hb_»ûiv”
: 
E™h”
::
Leá
(
Some
(
rx
)),

107 
ş›Á
: client,

108 
memb”s
: members,

109 
£cur™y_mgr
: security_mgr,

111 
Ï¡_upd©e
: 
In¡ªt
::
now
(),

116 
pub
 
â
 
	ghªdË_»giÚ_h—¹b—t_»¥Ú£
<
	gF
>(&
	g£lf
, 
	gf
: 
F
è-> 
PdFutu»
<()>

117 
wh”e


118 
F
: 
Fn
(
RegiÚH—¹b—tRe¥Ú£
è+ 
S’d
 + 'static,

120 
Ët
 
»cv
 = 
H—¹b—tReûiv”
 {

121 
»ûiv”
: 
NÚe
,

122 
šÃr
: 
£lf
.šÃr.
şÚe
(),

124 
	gBox
::
Ãw
(

125 
»cv
.
fÜ_—ch
(
move
 |
»¥
| {

126 
f
(
»¥
);

127 
Ok
(())

128 }).
m­_”r
(|
e
| 
·nic
!("unexpectedƒrror: {:?}",ƒ)),

132 
pub
 
â
 
	g»que¡
<
	gReq
, 
	gRe¥
, 
	gF
>(&
	g£lf
, 
	g»q
: 
Req
, 
	gf
: 
F
, 
	g»Œy
: 
usize
è-> 
Reque¡
<Req, Resp, F>

133 
wh”e


134 
	gReq
: 
ClÚe
 + 'static,

135 
F
: 
FnMut
(&
RwLock
<
IÂ”
>, 
Req
è-> 
	gPdFutu»
<
	gRe¥
> + 
	gS’d
 + 'static,

137 
	gReque¡
 {

138 
	g»cÚÃù_couÁ
: 
»Œy
,

139 
	g»que¡_£Á
: 0,

140 
	gş›Á
: 
L—d”Cl›Á
 {

141 
tim”
: 
£lf
.tim”.
şÚe
(),

142 
	gšÃr
: 
£lf
.
šÃr
.
şÚe
(),

144 
	g»q
: 
»q
,

145 
	g»¥
: 
NÚe
,

146 
	gfunc
: 
f
,

150 
pub
 
â
 
g‘_Ëad”
(&
£lf
è-> 
	gMemb”
 {

151 
	g£lf
.
	gšÃr
.
¾
().
	gmemb”s
.
g‘_Ëad”
().
şÚe
()

155 
pub
 
â
 
»cÚÃù
(&
£lf
è-> 
	gResuÉ
<()> {

156 
Ët
 ((
ş›Á
, 
memb”s
), 
¡¬t
) = {

157 
Ët
 
šÃr
 = 
£lf
.šÃr.
¾
();

158 
	gšÃr
.
	gÏ¡_upd©e
.
–­£d
(è< 
	gDu¿tiÚ
::
äom_£cs
(
RECONNECT_INTERVAL_SEC
) {

160  
Ok
(());

163 
Ët
 
	g¡¬t
 = 
In¡ªt
::
now
();

165 
Œy_cÚÃù_Ëad”
(
šÃr
.
’v
.
şÚe
(), &šÃr.
£cur™y_mgr
, &šÃr.
memb”s
)?,

166 
	g¡¬t
,

171 
Ët
 
mut
 
	gšÃr
 = 
£lf
.
šÃr
.
wl
();

172 
Ët
 (
tx
, 
rx
èğ
ş›Á
.
»giÚ_h—¹b—t
();

173 
	gšÃr
.
	ghb_£nd”
 = 
E™h”
::
Leá
(
Some
(
tx
));

174 
Ët
 
	gE™h”
::
Right
(
»f
 
mut
 
sk
èğ
šÃr
.
hb_»ûiv”
 {

175 
sk
.
nÙify
();

177 
	gšÃr
.
	ghb_»ûiv”
 = 
E™h”
::
Leá
(
Some
(
rx
));

178 
	gšÃr
.
	gş›Á
 = 
ş›Á
;

179 
	gšÃr
.
	gmemb”s
 = 
memb”s
;

180 
	gšÃr
.
	gÏ¡_upd©e
 = 
In¡ªt
::
now
();

182 
	gw¬n
!("upd©šg PD cl›Á dÚe, s³Á {:?}", 
	g¡¬t
.
–­£d
());

183 
Ok
(())

187 
pub
 cÚ¡ 
	gRECONNECT_INTERVAL_SEC
: 
u64
 = 1;

190 
pub
 
	gReque¡
<
	gReq
, 
	gRe¥
, 
	gF
> {

191 
	g»cÚÃù_couÁ
: 
usize
,

192 
	g»que¡_£Á
: 
usize
,

194 
	gş›Á
: 
L—d”Cl›Á
,

196 
	g»q
: 
Req
,

197 
	g»¥
: 
O±iÚ
<
ResuÉ
<
Re¥
>>,

198 
	gfunc
: 
F
,

201 cÚ¡ 
	gMAX_REQUEST_COUNT
: 
usize
 = 3;

203 
	gim¶
<
	gReq
, 
	gRe¥
, 
	gF
> 
	gReque¡
<Req, Resp, F>

204 
wh”e


205 
	gReq
: 
ClÚe
 + 
S’d
 + 'static,

206 
Re¥
: 
S’d
 + 'static,

207 
F
: 
FnMut
(&
RwLock
<
IÂ”
>, 
Req
è-> 
	gPdFutu»
<
	gRe¥
> + 
	gS’d
 + 'static,

209 
â
 
»cÚÃù_if_Ãeded
(
mut
 
£lf
è-> 
	gBox
<
	gFutu»
<
	gI‹m
 = 
S–f
, 
	gE¼Ü
 = S–f> + 
S’d
> {

210 
debug
!("»cÚÃù„emašs: {}", 
£lf
.
»cÚÃù_couÁ
);

212 
	g£lf
.
	g»que¡_£Á
 < 
	gMAX_REQUEST_COUNT
 {

213  
	gBox
::
Ãw
(
ok
(
£lf
));

217 
	g£lf
.
	g»cÚÃù_couÁ
 -= 1;

220 
	gw¬n
!("updating PD client, blockheokio core");

221 
m©ch
 
	g£lf
.
	gş›Á
.
»cÚÃù
() {

222 
Ok
(
_
) => {

223 
£lf
.
»que¡_£Á
 = 0;

224 
	gBox
::
Ãw
(
ok
(
£lf
))

226 
E¼
(
_
è=> 
Box
::
Ãw
(

227 
£lf
.
ş›Á


228 .
tim”


229 .
¦“p
(
Du¿tiÚ
::
äom_£cs
(
RECONNECT_INTERVAL_SEC
))

230 .
th’
(|
_
| 
E¼
(
£lf
)),

235 
â
 
£nd_ªd_»ûive
(
mut
 
£lf
è-> 
	gBox
<
	gFutu»
<
	gI‹m
 = 
S–f
, 
	gE¼Ü
 = S–f> + 
S’d
> {

236 
£lf
.
»que¡_£Á
 += 1;

237 
	gdebug
!("»que¡ s’t: {}", 
	g£lf
.
	g»que¡_£Á
);

238 
Ët
 
	gr
 = 
£lf
.
»q
.
şÚe
();

240 
	gBox
::
Ãw
(
ok
(
£lf
).
ªd_th’
(|
mut
 
ùx
| {

241 
Ët
 
»q
 = (
ùx
.
func
)(&ùx.
ş›Á
.
šÃr
, 
r
);

242 
»q
.
th’
(|
»¥
| 
m©ch
„esp {

243 
Ok
(
»¥
) => {

244 
ùx
.
»¥
 = 
Some
(
Ok
(resp));

245 
Ok
(
ùx
)

247 
E¼
(
”r
) => {

248 
”rÜ
!("»que¡ faed: {:?}", 
”r
);

249 
E¼
(
ùx
)

255 
â
 
b»ak_Ü_cÚtšue
(
ùx
: 
»suÉ
::
ResuÉ
<
S–f
, S–f>è-> 
	gResuÉ
<
	gLoİ
<
	gS–f
, Self>> {

256 
Ët
 
	gùx
 = 
m©ch
 
ùx
 {

257 
Ok
(
ùx
è| 
E¼
(ctx) => ctx,

259 
Ët
 
	gdÚe
 = 
ùx
.
»cÚÃù_couÁ
 =ğ0 || ctx.
»¥
.
is_some
();

260 
	gdÚe
 {

261 
Ok
(
Loİ
::
B»ak
(
ùx
))

263 
Ok
(
Loİ
::
CÚtšue
(
ùx
))

267 
â
 
po¡_loİ
(
ùx
: 
ResuÉ
<
S–f
>è-> ResuÉ<
Re¥
> {

268 
Ët
 
ùx
 = ctx.
ex³ù
("end†oop with Ok(_)");

269 
	gùx
.
	g»¥
.
unw¿p_Ü_–£
(|| 
E¼
(
box_”r
!("failo„equest")))

274 
pub
 
â
 
execu‹
(
£lf
è-> 
	gPdFutu»
<
	gRe¥
> {

275 
Ët
 
	gùx
 = 
£lf
;

276 
	gBox
::
Ãw
(

277 
loİ_â
(
ùx
, |ctx| {

278 
ùx
.
»cÚÃù_if_Ãeded
()

279 .
ªd_th’
(
S–f
::
£nd_ªd_»ûive
)

280 .
th’
(
S–f
::
b»ak_Ü_cÚtšue
)

281 }).
th’
(
S–f
::
po¡_loİ
),

287 
pub
 
â
 
	gsync_»que¡
<
	gF
, 
	gR
>(
	gş›Á
: &
L—d”Cl›Á
, 
	g»Œy
: 
usize
, 
	gfunc
: 
F
è-> 
ResuÉ
<
R
>

288 
wh”e


289 
F
: 
Fn
(&
PdCl›Á
è-> 
G½cResuÉ
<
R
>,

291 
_
 
	gš
 0..
	g»Œy
 {

293 
Ët
 
	g»t
 = { 
func
(&
ş›Á
.
šÃr
.
¾
().ş›Á).
m­_”r
(
E¼Ü
::
G½c
) };

294 
m©ch
 
	g»t
 {

295 
Ok
(
r
) => {

296  
Ok
(
r
);

298 
E¼
(
e
) => {

299 
”rÜ
!("çØ»que¡: {:?}", 
e
);

300 
Ët
 
E¼
(
e
èğ
ş›Á
.
»cÚÃù
() {

301 
”rÜ
!("çØ»cÚÃù: {:?}", 
e
);

307 
E¼
(
box_”r
!("failo„equest"))

310 
pub
 
â
 
v®id©e_’dpošts
(

311 
’v
: 
Arc
<
EnvœÚm’t
>,

312 
cfg
: &
CÚfig
,

313 
£cur™y_mgr
: &
Secur™yMªag”
,

314 è-> 
	gResuÉ
<(
	gPdCl›Á
, 
	gG‘Memb”sRe¥Ú£
)> {

315 
Ët
 
	gËn
 = 
cfg
.
’dpošts
.
Ën
();

316 
Ët
 
mut
 
	g’dpošts_£t
 = 
HashS‘
::
w™h_ÿ·c™y
(
Ën
);

318 
Ët
 
mut
 
	gmemb”s
 = 
NÚe
;

319 
Ët
 
mut
 
	gşu¡”_id
 = 
NÚe
;

320 
•
 
	gš
 &
	gcfg
.
	g’dpošts
 {

321 !
	g’dpošts_£t
.
š£¹
(
•
) {

322  
E¼
(
box_”r
!("du¶iÿ‹ PDƒndpošˆ{}", 
•
));

325 
Ët
 (
_
, 
»¥
èğ
m©ch
 
cÚÃù
(
’v
.
şÚe
(), 
£cur™y_mgr
, 
•
) {

326 
Ok
(
»¥
) =>„esp,

328 
E¼
(
e
) => {

329 
”rÜ
!("PDƒndpošˆ{} faedØ»¥Úd: {:?}", 
•
, 
e
);

335 
Ët
 
	gcid
 = 
»¥
.
g‘_h—d”
().
g‘_şu¡”_id
();

336 
Ët
 
Some
(
§m¶e
èğ
şu¡”_id
 {

337 
§m¶e
 !ğ
cid
 {

338  
E¼
(
box_”r
!(

340 
§m¶e
,

341 
cid


345 
	gşu¡”_id
 = 
Some
(
cid
);

349 
	gmemb”s
.
is_nÚe
() {

350 
	gmemb”s
 = 
Some
(
»¥
);

354 
m©ch
 
	gmemb”s
 {

355 
Some
(
memb”s
) => {

356 
Ët
 (
ş›Á
, 
memb”s
èğ
Œy_cÚÃù_Ëad”
(
’v
.
şÚe
(), 
£cur™y_mgr
, &members)?;

357 
	gšfo
!("AÎ PDƒndpošt ¬cÚsi¡’t: {:?}", 
	gcfg
.
	g’dpošts
);

358 
Ok
((
ş›Á
, 
memb”s
))

360 
	g_
 => 
E¼
(
box_”r
!("PD cluster failedo„espond")),

364 
â
 
cÚÃù
(

365 
’v
: 
Arc
<
EnvœÚm’t
>,

366 
£cur™y_mgr
: &
Secur™yMªag”
,

367 
addr
: &
¡r
,

368 è-> 
	gResuÉ
<(
	gPdCl›Á
, 
	gG‘Memb”sRe¥Ú£
)> {

369 
	gdebug
!("cÚÃùØPDƒndpošt: {:?}", 
	gaddr
);

370 
Ët
 
	gaddr
 = 
addr
.
Œim_Ëá_m©ches
("http://")

371 .
Œim_Ëá_m©ches
("https://");

372 
Ët
 
	gcb
 = 
ChªÃlBud”
::
Ãw
(
’v
);

373 
Ët
 
	gchªÃl
 = 
£cur™y_mgr
.
cÚÃù
(
cb
, 
addr
);

374 
Ët
 
	gş›Á
 = 
PdCl›Á
::
Ãw
(
chªÃl
);

375 
Ët
 
	gİtiÚ
 = 
C®lO±iÚ
::().
timeout
(
Du¿tiÚ
::
äom_£cs
(
REQUEST_TIMEOUT
));

376 
m©ch
 
	gş›Á
.
g‘_memb”s_İt
(
G‘Memb”sReque¡
::
Ãw
(), 
İtiÚ
) {

377 
Ok
(
»¥
è=> Ok((
ş›Á
,„esp)),

378 
E¼
(
e
è=> E¼(
E¼Ü
::
G½c
(e)),

382 
pub
 
â
 
Œy_cÚÃù_Ëad”
(

383 
’v
: 
Arc
<
EnvœÚm’t
>,

384 
£cur™y_mgr
: &
Secur™yMªag”
,

385 
´evious
: &
G‘Memb”sRe¥Ú£
,

386 è-> 
	gResuÉ
<(
	gPdCl›Á
, 
	gG‘Memb”sRe¥Ú£
)> {

387 
Ët
 
	g´evious_Ëad”
 = 
´evious
.
g‘_Ëad”
();

388 
Ët
 
	gmemb”s
 = 
´evious
.
g‘_memb”s
();

389 
Ët
 
	gşu¡”_id
 = 
´evious
.
g‘_h—d”
().
g‘_şu¡”_id
();

390 
Ët
 
mut
 
	g»¥
 = 
NÚe
;

393 .
što_™”
()

394 .
f‹r
(|
m
| *m !ğ
´evious_Ëad”
)

395 .
chaš
(&[
´evious_Ëad”
.
şÚe
()])

397 
•
 
š
 
m
.
g‘_ş›Á_u¾s
() {

398 
m©ch
 
cÚÃù
(
’v
.
şÚe
(), 
£cur™y_mgr
, 
•
.
as_¡r
()) {

399 
Ok
((
_
, 
r
)) => {

400 
Ët
 
Ãw_şu¡”_id
 = 
r
.
g‘_h—d”
().
g‘_şu¡”_id
();

401 
	gÃw_şu¡”_id
 =ğ
şu¡”_id
 {

402 
»¥
 = 
Some
(
r
);

405 
	g·nic
!(

407 
	g•
,

408 
	gşu¡”_id
,

409 
	gÃw_şu¡”_id


413 
E¼
(
e
) => {

414 
”rÜ
!("çedØcÚÃùØ{}, {:?}", 
•
, 
e
);

422 
Ët
 
Some
(
»¥
) =„esp {

423 
Ët
 
Ëad”
 = 
»¥
.
g‘_Ëad”
().
şÚe
();

424 
•
 
š
 
	gËad”
.
g‘_ş›Á_u¾s
() {

425 
Ët
 
Ok
((
ş›Á
, 
_
)èğ
cÚÃù
(
’v
.
şÚe
(), 
£cur™y_mgr
, 
•
.
as_¡r
()) {

426 
	gšfo
!("cÚÃùØPD†—d” {:?}", 
	g•
);

427  
Ok
((
ş›Á
, 
»¥
));

432 
E¼
(
box_”r
!("çedØcÚÃùØ{:?}", 
memb”s
))

435 
pub
 
â
 
check_»¥_h—d”
(
h—d”
: &
Re¥Ú£H—d”
è-> 
ResuÉ
<()> {

436 !
h—d”
.
has_”rÜ
() {

437  
Ok
(());

440 
Ët
 
	g”r
 = 
h—d”
.
g‘_”rÜ
();

441 
m©ch
 
	g”r
.
g‘_f›ld_ty³
() {

442 
	gE¼ÜTy³
::
ALREADY_BOOTSTRAPPED
 => 
E¼
(
E¼Ü
::
Clu¡”BoÙ¡¿µed
(
h—d”
.
g‘_şu¡”_id
())),

443 
	gE¼ÜTy³
::
NOT_BOOTSTRAPPED
 => 
E¼
(
E¼Ü
::
Clu¡”NÙBoÙ¡¿µed
(
h—d”
.
g‘_şu¡”_id
())),

444 
	g_
 => 
E¼
(
box_”r
!(
”r
.
g‘_mes§ge
())),

	@src/raft/errors.rs

15 
u£
 
	g¡d
::{
cmp
, 
	gio
, 
	g»suÉ
};

16 
u£
 
	g¡d
::
”rÜ
;

18 
	gquick_”rÜ
! {

19 #[
d”ive
(
Debug
)]

20 
pub
 
	eE¼Ü
 {

21 
Io
(
”r
: 
io
::
E¼Ü
) {

22 
äom
()

23 
ÿu£
(
”r
)

24 
desütiÚ
(
”r
.description())

26 
StÜe
(
”r
: 
StÜageE¼Ü
) {

27 
äom
()

28 
ÿu£
(
”r
)

29 
desütiÚ
(
”r
.description())

31 
S‹pLoÿlMsg
 {

32 
desütiÚ
("raft: cannot step„aft†ocal message")

34 
S‹pP“rNÙFound
 {

35 
desütiÚ
("raft: cannot step‡s…eer‚ot found")

37 
CÚfigInv®id
(
desc
: 
SŒšg
) {

38 
desütiÚ
(
desc
)

40 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

41 
äom
()

42 
ÿu£
(
”r
.
as_»f
())

43 
desütiÚ
(
”r
.description())

44 
di¥Ïy
("unknowÀ”rÜ {:?}", 
”r
)

50 
im¶
 
	gcmp
::
P¬tŸlEq
 
E¼Ü
 {

51 #[
®low
(
m©ch_§me_¬ms
)]

52 
â
 
eq
(&
£lf
, 
Ùh”
: &
E¼Ü
è-> 
boŞ
 {

53 
m©ch
 (
£lf
, 
Ùh”
) {

54 (&
	gE¼Ü
::
S‹pP“rNÙFound
, &E¼Ü::S‹pP“rNÙFoundè=> 
Œue
,

55 (&
	gE¼Ü
::
StÜe
(
»f
 
e1
), &E¼Ü::StÜeÔeà
e2
)) =>ƒ1 ==ƒ2,

56 (&
	gE¼Ü
::
Io
(
»f
 
e1
), &E¼Ü::IoÔeà
e2
)è=>ƒ1.
kšd
() ==ƒ2.kind(),

57 (&
	gE¼Ü
::
S‹pLoÿlMsg
, &E¼Ü::S‹pLoÿlMsgè=> 
Œue
,

58 (&
	gE¼Ü
::
CÚfigInv®id
(
»f
 
e1
), &E¼Ü::CÚfigInv®idÔeà
e2
)) =>ƒ1 ==ƒ2,

59 
	g_
 => 
çl£
,

64 
	gquick_”rÜ
! {

65 #[
d”ive
(
Debug
)]

66 
pub
 
	eStÜageE¼Ü
 {

67 
	gCom·ùed
 {

68 
desütiÚ
("log compacted")

70 
	gUÇvaabË
 {

71 
desütiÚ
("log unavailable")

73 
	gSÇpshÙOutOfD©e
 {

74 
desütiÚ
("snapshot out of date")

76 
	gSÇpshÙTempÜ¬yUÇvaabË
 {

77 
desütiÚ
("snapshot isemporarily unavailable")

79 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

80 
äom
()

81 
ÿu£
(
”r
.
as_»f
())

82 
desütiÚ
(
”r
.description())

83 
di¥Ïy
("unknowÀ”rÜ {:?}", 
”r
)

88 
im¶
 
	gcmp
::
P¬tŸlEq
 
StÜageE¼Ü
 {

89 #[
®low
(
m©ch_§me_¬ms
)]

90 
â
 
eq
(&
£lf
, 
Ùh”
: &
StÜageE¼Ü
è-> 
boŞ
 {

91 
m©ch
 (
£lf
, 
Ùh”
) {

92 (&
	gStÜageE¼Ü
::
Com·ùed
, &StÜageE¼Ü::Com·ùedè=> 
Œue
,

93 (&
	gStÜageE¼Ü
::
UÇvaabË
, &StÜageE¼Ü::UÇvaabËè=> 
Œue
,

94 (&
	gStÜageE¼Ü
::
SÇpshÙOutOfD©e
, &StÜageE¼Ü::SÇpshÙOutOfD©eè=> 
Œue
,

96 &
	gStÜageE¼Ü
::
SÇpshÙTempÜ¬yUÇvaabË
,

97 &
	gStÜageE¼Ü
::
SÇpshÙTempÜ¬yUÇvaabË
,

98 è=> 
Œue
,

99 
	g_
 => 
çl£
,

104 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

106 #[
cfg
(
‹¡
)]

107 
mod
 
	g‹¡s
 {

108 
u£
 
	g¡d
::
io
;

109 
u£
 
	gsu³r
::*;

111 #[
‹¡
]

112 
â
 
‹¡_”rÜ_equ®
() {

113 
	gas£¹_eq
!(
	gE¼Ü
::
S‹pP“rNÙFound
, Error::StepPeerNotFound);

114 
	gas£¹_eq
!(

115 
	gE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
),

116 
	gE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
)

118 
	gas£¹_eq
!(

119 
	gE¼Ü
::
Io
(
io
::
E¼Ü
::
Ãw
(io::
E¼ÜKšd
::
UÃx³ùedEof
, "oh‚o!")),

120 
	gE¼Ü
::
Io
(
io
::
E¼Ü
::
Ãw
(io::
E¼ÜKšd
::
UÃx³ùedEof
, "oh yes!"))

122 
	gas£¹_Ã
!(

123 
	gE¼Ü
::
Io
(
io
::
E¼Ü
::
Ãw
(io::
E¼ÜKšd
::
NÙFound
, "error")),

124 
	gE¼Ü
::
Io
(
io
::
E¼Ü
::
Ãw
(io::
E¼ÜKšd
::
Brok’Pe
, "error"))

126 
	gas£¹_eq
!(
	gE¼Ü
::
S‹pLoÿlMsg
, Error::StepLocalMsg);

127 
	gas£¹_eq
!(

128 
	gE¼Ü
::
CÚfigInv®id
(
SŒšg
::
äom
("configƒrror")),

129 
	gE¼Ü
::
CÚfigInv®id
(
SŒšg
::
äom
("configƒrror"))

131 
	gas£¹_Ã
!(

132 
	gE¼Ü
::
CÚfigInv®id
(
SŒšg
::
äom
("configƒrror")),

133 
	gE¼Ü
::
CÚfigInv®id
(
SŒšg
::
äom
("otherƒrror"))

135 
	gas£¹_eq
!(

136 
	gE¼Ü
::
äom
(
io
::
E¼Ü
::
Ãw
(io::
E¼ÜKšd
::
Oth”
, "oh‚o!")),

137 
	gE¼Ü
::
äom
(
io
::
E¼Ü
::
Ãw
(io::
E¼ÜKšd
::
Oth”
, "oh yes!"))

139 
	gas£¹_Ã
!(

140 
	gE¼Ü
::
S‹pP“rNÙFound
,

141 
	gE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
)

143 
	gas£¹_Ã
!(
	gE¼Ü
::
Oth”
(
box
 
E¼Ü
::
S‹pLoÿlMsg
), Error::StepLocalMsg);

146 #[
‹¡
]

147 
â
 
‹¡_¡Üage_”rÜ_equ®
() {

148 
	gas£¹_eq
!(
	gStÜageE¼Ü
::
Com·ùed
, StorageError::Compacted);

149 
	gas£¹_eq
!(
	gStÜageE¼Ü
::
UÇvaabË
, StorageError::Unavailable);

150 
	gas£¹_eq
!(

151 
	gStÜageE¼Ü
::
SÇpshÙOutOfD©e
,

152 
	gStÜageE¼Ü
::
SÇpshÙOutOfD©e


154 
	gas£¹_eq
!(

155 
	gStÜageE¼Ü
::
SÇpshÙTempÜ¬yUÇvaabË
,

156 
	gStÜageE¼Ü
::
SÇpshÙTempÜ¬yUÇvaabË


158 
	gas£¹_Ã
!(
	gStÜageE¼Ü
::
Com·ùed
, StÜageE¼Ü::
UÇvaabË
);

159 
	gas£¹_Ã
!(

160 
	gStÜageE¼Ü
::
Oth”
(
box
 
StÜageE¼Ü
::
UÇvaabË
),

161 
	gStÜageE¼Ü
::
UÇvaabË


	@src/raft/log_unstable.rs

29 
u£
 
	gkv´Ùo
::
”aápb
::{
EÁry
, 
	gSÇpshÙ
};

35 #[
d”ive
(
Debug
, 
P¬tŸlEq
, 
DeçuÉ
)]

36 
pub
 
	sUn¡abË
 {

38 
pub
 
	m¢­shÙ
: 
O±iÚ
<
SÇpshÙ
>,

40 
pub
 
	m’Œ›s
: 
Vec
<
EÁry
>,

41 
pub
 
	moff£t
: 
u64
,

43 
pub
 
	mg
: 
SŒšg
,

47 
im¶
 
	gUn¡abË
 {

48 
pub
 
â
 
Ãw
(
off£t
: 
u64
, 
g
: 
SŒšg
è-> 
Un¡abË
 {

49 
Un¡abË
 {

50 
off£t
: offset,

51 
	g¢­shÙ
: 
NÚe
,

52 
	g’Œ›s
: 
vec
![],

53 
	gg
: 
g
,

58 
pub
 
â
 
maybe_fœ¡_šdex
(&
£lf
è-> 
	gO±iÚ
<
	gu64
> {

59 
	g£lf
.
	g¢­shÙ


60 .
as_»f
()

61 .
m­
(|
¢­
| sÇp.
g‘_m‘ad©a
().
g‘_šdex
() + 1)

66 
pub
 
â
 
maybe_Ï¡_šdex
(&
£lf
è-> 
	gO±iÚ
<
	gu64
> {

67 
m©ch
 
	g£lf
.
	g’Œ›s
.
Ën
() {

68 0 => 
£lf
.
¢­shÙ


69 .
as_»f
()

70 .
m­
(|
¢­
| sÇp.
g‘_m‘ad©a
().
g‘_šdex
()),

71 
	gËn
 => 
Some
(
£lf
.
off£t
 + 
Ën
 
as
 
u64
 - 1),

77 
pub
 
â
 
maybe_‹rm
(&
£lf
, 
idx
: 
u64
è-> 
O±iÚ
<u64> {

78 
idx
 < 
£lf
.
off£t
 {

79 
£lf
.
¢­shÙ
.
is_nÚe
() {

80  
NÚe
;

83 
Ët
 
	gm‘a
 = 
£lf
.
¢­shÙ
.
as_»f
().
unw¿p
().
g‘_m‘ad©a
();

84 
	gidx
 =ğ
m‘a
.
g‘_šdex
() {

85  
Some
(
m‘a
.
g‘_‹rm
());

87  
	gNÚe
;

89 
	g£lf
.
maybe_Ï¡_šdex
().
ªd_th’
(|
Ï¡
| {

90 
idx
 > 
Ï¡
 {

91  
NÚe
;

93 
Some
(
£lf
.
’Œ›s
[(
idx
 - s–f.
off£t
è
as
 
usize
].
g‘_‹rm
())

97 
pub
 
â
 
¡abË_to
(&
mut
 
£lf
, 
idx
: 
u64
, 
‹rm
: u64) {

98 
Ët
 
t
 = 
£lf
.
maybe_‹rm
(
idx
);

99 
	gt
.
is_nÚe
() {

103 
	gt
.
unw¿p
(è=ğ
‹rm
 && 
idx
 >ğ
£lf
.
off£t
 {

104 
Ët
 
¡¬t
 = 
idx
 + 1 - 
£lf
.
off£t
;

105 
	g£lf
.
	g’Œ›s
.
d¿š
(..
¡¬t
 
as
 
usize
);

106 
	g£lf
.
	goff£t
 = 
idx
 + 1;

110 
pub
 
â
 
¡abË_¢­_to
(&
mut
 
£lf
, 
idx
: 
u64
) {

111 
£lf
.
¢­shÙ
.
is_nÚe
() {

114 
	gidx
 =ğ
£lf
.
¢­shÙ
.
as_»f
().
unw¿p
().
g‘_m‘ad©a
().
g‘_šdex
() {

115 
£lf
.
¢­shÙ
 = 
NÚe
;

119 
pub
 
â
 
»¡Üe
(&
mut
 
£lf
, 
¢­
: 
SÇpshÙ
) {

120 
£lf
.
’Œ›s
.
ş—r
();

121 
	g£lf
.
	goff£t
 = 
¢­
.
g‘_m‘ad©a
().
g‘_šdex
() + 1;

122 
	g£lf
.
	g¢­shÙ
 = 
Some
(
¢­
);

126 
pub
 
â
 
Œunÿ‹_ªd_­³nd
(&
mut
 
£lf
, 
’ts
: &[
EÁry
]) {

127 
Ët
 
aá”
 = 
’ts
[0].
g‘_šdex
();

128 
	gaá”
 =ğ
£lf
.
off£t
 + s–f.
’Œ›s
.
Ën
(è
as
 
u64
 {

130 
£lf
.
’Œ›s
.
ex‹nd_äom_¦iû
(
’ts
);

131 } 
	gaá”
 <ğ
£lf
.
off£t
 {

134 
£lf
.
off£t
 = 
aá”
;

135 
	g£lf
.
	g’Œ›s
.
ş—r
();

136 
	g£lf
.
	g’Œ›s
.
ex‹nd_äom_¦iû
(
’ts
);

139 
Ët
 
	goff
 = 
£lf
.
off£t
;

140 
	g£lf
.
mu¡_check_outofbounds
(
off
, 
aá”
);

141 
	g£lf
.
	g’Œ›s
.
Œunÿ‹
((
aá”
 - 
off
è
as
 
usize
);

142 
	g£lf
.
	g’Œ›s
.
ex‹nd_äom_¦iû
(
’ts
);

146 
pub
 
â
 
¦iû
(&
£lf
, 
lo
: 
u64
, 
hi
: u64è-> &[
EÁry
] {

147 
£lf
.
mu¡_check_outofbounds
(
lo
, 
hi
);

148 
Ët
 
	gl
 = 
lo
 
as
 
usize
;

149 
Ët
 
	gh
 = 
hi
 
as
 
usize
;

150 
Ët
 
	goff
 = 
£lf
.
off£t
 
as
 
usize
;

151 &
	g£lf
.
	g’Œ›s
[
l
 - 
off
..
h
 - off]

154 
pub
 
â
 
mu¡_check_outofbounds
(&
£lf
, 
lo
: 
u64
, 
hi
: u64) {

155 
lo
 > 
hi
 {

156 
·nic
!("{} inv®id un¡abË.¦iû {} > {}", 
	g£lf
.
	gg
, 
	glo
, 
	ghi
)

158 
Ët
 
	guµ”
 = 
£lf
.
off£t
 + s–f.
’Œ›s
.
Ën
(è
as
 
u64
;

159 
	glo
 < 
	g£lf
.
	goff£t
 || 
	ghi
 > 
	guµ”
 {

160 
	g·nic
!(

162 
	g£lf
.
	gg
,

163 
	glo
,

164 
	ghi
,

165 
	g£lf
.
	goff£t
,

166 
	guµ”


173 #[
cfg
(
‹¡
)]

174 
mod
 
	g‹¡
 {

175 
u£
 
	gkv´Ùo
::
”aápb
::{
EÁry
, 
	gSÇpshÙ
};

176 
u£
 
	g¿á
::
log_un¡abË
::
Un¡abË
;

178 
â
 
Ãw_’Œy
(
šdex
: 
u64
, 
‹rm
: u64è-> 
EÁry
 {

179 
Ët
 
mut
 
e
 = 
EÁry
::
Ãw
();

180 
	ge
.
£t_‹rm
(
‹rm
);

181 
	ge
.
£t_šdex
(
šdex
);

182 
	ge


185 
â
 
Ãw_¢­shÙ
(
šdex
: 
u64
, 
‹rm
: u64è-> 
SÇpshÙ
 {

186 
u£
 
kv´Ùo
::
”aápb
::{
SÇpshÙ
, 
	gSÇpshÙM‘ad©a
};

187 
Ët
 
mut
 
	g¢­
 = 
SÇpshÙ
::
Ãw
();

188 
Ët
 
mut
 
	gm‘a
 = 
SÇpshÙM‘ad©a
::
Ãw
();

189 
	gm‘a
.
£t_šdex
(
šdex
);

190 
	gm‘a
.
£t_‹rm
(
‹rm
);

191 
	g¢­
.
£t_m‘ad©a
(
m‘a
);

192 
	g¢­


195 #[
‹¡
]

196 
â
 
‹¡_maybe_fœ¡_šdex
() {

198 
Ët
 
	g‹¡s
 = 
vec
![

200 (
Some
(
Ãw_’Œy
(5, 1)), 5, 
NÚe
, 
çl£
, 0),

201 (
NÚe
, 0, NÚe, 
çl£
, 0),

203 (
Some
(
Ãw_’Œy
(5, 1)), 5, Some(
Ãw_¢­shÙ
(4, 1)), 
Œue
, 5),

204 (
NÚe
, 5, 
Some
(
Ãw_¢­shÙ
(4, 1)), 
Œue
, 5),

207 
	g’Œ›s
, 
	goff£t
, 
	g¢­shÙ
, 
	gwok
, 
	gwšdex
è
š
 
	g‹¡s
 {

208 
Ët
 
	gu
 = 
Un¡abË
 {

209 
’Œ›s
:ƒÁr›s.
m­_Ü
(
vec
![], |
’Œy
| vec![entry]),

210 
off£t
: offset,

211 
¢­shÙ
: snapshot,

212 ..
DeçuÉ
::()

214 
Ët
 
	gšdex
 = 
u
.
maybe_fœ¡_šdex
();

215 
m©ch
 
	gšdex
 {

216 
	gNÚe
 => 
as£¹
!(!
wok
),

217 
Some
(
šdex
è=> 
as£¹_eq
!(šdex, 
	gwšdex
),

222 #[
‹¡
]

223 
â
 
‹¡_maybe_Ï¡_šdex
() {

225 
Ët
 
	g‹¡s
 = 
vec
![

226 (
Some
(
Ãw_’Œy
(5, 1)), 5, 
NÚe
, 
Œue
, 5),

227 (
Some
(
Ãw_’Œy
(5, 1)), 5, Some(
Ãw_¢­shÙ
(4, 1)), 
Œue
, 5),

229 (
NÚe
, 5, 
Some
(
Ãw_¢­shÙ
(4, 1)), 
Œue
, 4),

231 (
NÚe
, 0, NÚe, 
çl£
, 0),

234 
	g’Œ›s
, 
	goff£t
, 
	g¢­shÙ
, 
	gwok
, 
	gwšdex
è
š
 
	g‹¡s
 {

235 
Ët
 
	gu
 = 
Un¡abË
 {

236 
’Œ›s
:ƒÁr›s.
m­_Ü
(
vec
![], |
’Œy
| vec![entry]),

237 
off£t
: offset,

238 
¢­shÙ
: snapshot,

239 ..
DeçuÉ
::()

241 
Ët
 
	gšdex
 = 
u
.
maybe_Ï¡_šdex
();

242 
m©ch
 
	gšdex
 {

243 
	gNÚe
 => 
as£¹
!(!
wok
),

244 
Some
(
šdex
è=> 
as£¹_eq
!(šdex, 
	gwšdex
),

249 #[
‹¡
]

250 
â
 
‹¡_maybe_‹rm
() {

252 
Ët
 
	g‹¡s
 = 
vec
![

254 (
Some
(
Ãw_’Œy
(5, 1)), 5, 
NÚe
, 5, 
Œue
, 1),

255 (
Some
(
Ãw_’Œy
(5, 1)), 5, 
NÚe
, 6, 
çl£
, 0),

256 (
Some
(
Ãw_’Œy
(5, 1)), 5, 
NÚe
, 4, 
çl£
, 0),

258 
Some
(
Ãw_’Œy
(5, 1)),

260 
Some
(
Ãw_¢­shÙ
(4, 1)),

262 
Œue
,

266 
Some
(
Ãw_’Œy
(5, 1)),

268 
Some
(
Ãw_¢­shÙ
(4, 1)),

270 
çl£
,

275 
Some
(
Ãw_’Œy
(5, 1)),

277 
Some
(
Ãw_¢­shÙ
(4, 1)),

279 
Œue
,

283 
Some
(
Ãw_’Œy
(5, 1)),

285 
Some
(
Ãw_¢­shÙ
(4, 1)),

287 
çl£
,

290 (
NÚe
, 5, 
Some
(
Ãw_¢­shÙ
(4, 1)), 5, 
çl£
, 0),

291 (
NÚe
, 5, 
Some
(
Ãw_¢­shÙ
(4, 1)), 4, 
Œue
, 1),

292 (
NÚe
, 0, NÚe, 5, 
çl£
, 0),

295 
	g’Œ›s
, 
	goff£t
, 
	g¢­shÙ
, 
	gšdex
, 
	gwok
, 
	gw‹rm
è
š
 
	g‹¡s
 {

296 
Ët
 
	gu
 = 
Un¡abË
 {

297 
’Œ›s
:ƒÁr›s.
m­_Ü
(
vec
![], |
’Œy
| vec![entry]),

298 
off£t
: offset,

299 
¢­shÙ
: snapshot,

300 ..
DeçuÉ
::()

302 
Ët
 
	g‹rm
 = 
u
.
maybe_‹rm
(
šdex
);

303 
m©ch
 
	g‹rm
 {

304 
	gNÚe
 => 
as£¹
!(!
wok
),

305 
Some
(
‹rm
è=> 
as£¹_eq
!Ñ”m, 
	gw‹rm
),

311 #[
‹¡
]

312 
â
 
‹¡_»¡Üe
() {

313 
Ët
 
mut
 
	gu
 = 
Un¡abË
 {

314 
’Œ›s
: 
vec
![
Ãw_’Œy
(5, 1)],

315 
off£t
: 5,

316 
¢­shÙ
: 
Some
(
Ãw_¢­shÙ
(4, 1)),

317 ..
DeçuÉ
::()

320 
Ët
 
	gs
 = 
Ãw_¢­shÙ
(6, 2);

321 
	gu
.
»¡Üe
(
s
.
şÚe
());

323 
	gas£¹_eq
!(
	gu
.
	goff£t
, 
	gs
.
g‘_m‘ad©a
().
g‘_šdex
() + 1);

324 
	gas£¹
!(
	gu
.
	g’Œ›s
.
is_em±y
());

325 
	gas£¹_eq
!(
	gu
.
	g¢­shÙ
.
unw¿p
(), 
	gs
);

328 #[
‹¡
]

329 
â
 
‹¡_¡abË_to
() {

331 
Ët
 
	g‹¡s
 = 
vec
![

332 (
vec
![], 0, 
	gNÚe
, 5, 1, 0, 0),

334 (
	gvec
![
Ãw_’Œy
(5, 1)], 5, 
	gNÚe
, 5, 1, 6, 0),

335 (
	gvec
![
Ãw_’Œy
(5, 1),‚ew_’Œy(6, 0)], 5, 
	gNÚe
, 5, 1, 6, 1),

337 (
	gvec
![
Ãw_’Œy
(6, 2)], 5, 
	gNÚe
, 6, 1, 5, 1),

339 (
	gvec
![
Ãw_’Œy
(5, 1)], 5, 
	gNÚe
, 4, 1, 5, 1),

340 (
	gvec
![
Ãw_’Œy
(5, 1)], 5, 
	gNÚe
, 4, 2, 5, 1),

344 
	gvec
![
Ãw_’Œy
(5, 1)],

346 
Some
(
Ãw_¢­shÙ
(4, 1)),

354 
	gvec
![
Ãw_’Œy
(5, 1),‚ew_entry(6, 1)],

356 
Some
(
Ãw_¢­shÙ
(4, 1)),

364 
	gvec
![
Ãw_’Œy
(6, 2)],

366 
Some
(
Ãw_¢­shÙ
(5, 1)),

374 
	gvec
![
Ãw_’Œy
(5, 1)],

376 
Some
(
Ãw_¢­shÙ
(4, 1)),

384 
	gvec
![
Ãw_’Œy
(5, 2)],

386 
Some
(
Ãw_¢­shÙ
(4, 2)),

394 
	g’Œ›s
, 
	goff£t
, 
	g¢­shÙ
, 
	gšdex
, 
	g‹rm
, 
	gwoff£t
, 
	gwËn
è
š
 
	g‹¡s
 {

395 
Ët
 
mut
 
	gu
 = 
Un¡abË
 {

396 
’Œ›s
:ƒntries,

397 
off£t
: offset,

398 
¢­shÙ
: snapshot,

399 ..
DeçuÉ
::()

401 
	gu
.
¡abË_to
(
šdex
, 
‹rm
);

402 
	gas£¹_eq
!(
	gu
.
	goff£t
, 
	gwoff£t
);

403 
	gas£¹_eq
!(
	gu
.
	g’Œ›s
.
Ën
(), 
	gwËn
);

407 #[
‹¡
]

408 
â
 
‹¡_Œunÿ‹_ªd_­³nd
() {

410 
Ët
 
	g‹¡s
 = 
vec
![

413 
vec
![
Ãw_’Œy
(5, 1)],

415 
	gNÚe
,

416 
	gvec
![
Ãw_’Œy
(6, 1),‚ew_entry(7, 1)],

418 
	gvec
![
Ãw_’Œy
(5, 1),‚ew_entry(6, 1),‚ew_entry(7, 1)],

423 
	gvec
![
Ãw_’Œy
(5, 1)],

425 
	gNÚe
,

426 
	gvec
![
Ãw_’Œy
(5, 2),‚ew_entry(6, 2)],

428 
	gvec
![
Ãw_’Œy
(5, 2),‚ew_entry(6, 2)],

432 
	gvec
![
Ãw_’Œy
(5, 1)],

434 
	gNÚe
,

435 
	gvec
![
Ãw_’Œy
(4, 2),‚ew_entry(5, 2),‚ew_entry(6, 2)],

437 
	gvec
![
Ãw_’Œy
(4, 2),‚ew_entry(5, 2),‚ew_entry(6, 2)],

442 
	gvec
![
Ãw_’Œy
(5, 1),‚ew_entry(6, 1),‚ew_entry(7, 1)],

444 
	gNÚe
,

445 
	gvec
![
Ãw_’Œy
(6, 2)],

447 
	gvec
![
Ãw_’Œy
(5, 1),‚ew_entry(6, 2)],

451 
	gvec
![
Ãw_’Œy
(5, 1),‚ew_entry(6, 1),‚ew_entry(7, 1)],

453 
	gNÚe
,

454 
	gvec
![
Ãw_’Œy
(7, 2),‚ew_entry(8, 2)],

456 
	gvec
![

457 
Ãw_’Œy
(5, 1),

458 
Ãw_’Œy
(6, 1),

459 
Ãw_’Œy
(7, 2),

460 
Ãw_’Œy
(8, 2),

466 
	g’Œ›s
, 
	goff£t
, 
	g¢­shÙ
, 
	gto_­³nd
, 
	gwoff£t
, 
	gw’Œ›s
è
š
 
	g‹¡s
 {

467 
Ët
 
mut
 
	gu
 = 
Un¡abË
 {

468 
’Œ›s
:ƒntries,

469 
off£t
: offset,

470 
¢­shÙ
: snapshot,

471 ..
DeçuÉ
::()

473 
	gu
.
Œunÿ‹_ªd_­³nd
(&
to_­³nd
);

474 
	gas£¹_eq
!(
	gu
.
	goff£t
, 
	gwoff£t
);

475 
	gas£¹_eq
!(
	gu
.
	g’Œ›s
, 
	gw’Œ›s
);

	@src/raft/mod.rs

28 
mod
 
	g¿á_log
;

29 
pub
 
mod
 
	g¡Üage
;

30 
mod
 
	g¿á
;

31 
mod
 
	g´og»ss
;

32 
mod
 
	g”rÜs
;

33 
mod
 
	glog_un¡abË
;

34 
mod
 
	g¡©us
;

35 
pub
 
mod
 
	g¿w_node
;

36 
mod
 
	g»ad_Úly
;

38 
pub
 
u£
 
	g£lf
::
¡Üage
::{
RaáS‹
, 
	gStÜage
};

39 
pub
 
u£
 
	g£lf
::
”rÜs
::{
E¼Ü
, 
	gResuÉ
, 
	gStÜageE¼Ü
};

40 
pub
 
u£
 
	g£lf
::
¿á
::{
quÜum
, 
	gvÙe_»¥_msg_ty³
, 
	gCÚfig
, 
	gRaá
, 
	gSoáS‹
, 
	gS‹RŞe
, 
	gINVALID_ID
,

41 
	gINVALID_INDEX
};

42 
pub
 
u£
 
	g£lf
::
¿á_log
::{
RaáLog
, 
	gNO_LIMIT
};

43 
pub
 
u£
 
	g£lf
::
¿w_node
::{
is_em±y_¢­
, 
	gP“r
, 
	gRawNode
, 
	gR—dy
, 
	gSÇpshÙStus
};

44 
pub
 
u£
 
	g£lf
::
¡©us
::
Stus
;

45 
pub
 
u£
 
	g£lf
::
log_un¡abË
::
Un¡abË
;

46 
pub
 
u£
 
	g£lf
::
´og»ss
::{
Inæights
, 
	gProg»ss
, 
	gProg»ssS‹
};

47 
pub
 
u£
 
	g£lf
::
»ad_Úly
::{
R—dOÆyO±iÚ
, 
	gR—dS‹
};

48 
u£
 
	gut
::
cŞËùiÚs
::{
FÏtM­
, 
	gHashM­
, 
	gHashS‘
};

	@src/raft/progress.rs

29 
u£
 
	g¡d
::
cmp
;

31 #[
d”ive
(
Debug
, 
P¬tŸlEq
, 
ClÚe
, 
Cİy
)]

32 
pub
 
	eProg»ssS‹
 {

33 
	mProbe
,

34 
	mR•liÿ‹
,

35 
	mSÇpshÙ
,

38 
im¶
 
DeçuÉ
 
	gProg»ssS‹
 {

39 
â
 (è-> 
	gProg»ssS‹
 {

40 
	gProg»ssS‹
::
Probe


45 #[
d”ive
(
Debug
, 
DeçuÉ
, 
ClÚe
)]

46 
pub
 
	sProg»ss
 {

47 
pub
 
	mm©ched
: 
u64
,

48 
pub
 
	mÃxt_idx
: 
u64
,

58 
pub
 
	m¡©e
: 
Prog»ssS‹
,

61 
pub
 
	m·u£d
: 
boŞ
,

67 
pub
 
	m³ndšg_¢­shÙ
: 
u64
,

72 
pub
 
	m»ûÁ_aùive
: 
boŞ
,

81 
pub
 
	mšs
: 
Inæights
,

86 
im¶
 
	gProg»ss
 {

87 
â
 
»£t_¡©e
(&
mut
 
£lf
, 
¡©e
: 
Prog»ssS‹
) {

88 
£lf
.
·u£d
 = 
çl£
;

89 
	g£lf
.
	g³ndšg_¢­shÙ
 = 0;

90 
	g£lf
.
	g¡©e
 = 
¡©e
;

91 
	g£lf
.
	gšs
.
»£t
();

94 
pub
 
â
 
become_´obe
(&
mut
 
£lf
) {

98 
	g£lf
.
	g¡©e
 =ğ
Prog»ssS‹
::
SÇpshÙ
 {

99 
Ët
 
³ndšg_¢­shÙ
 = 
£lf
.pending_snapshot;

100 
	g£lf
.
»£t_¡©e
(
Prog»ssS‹
::
Probe
);

101 
	g£lf
.
	gÃxt_idx
 = 
cmp
::
max
(
£lf
.
m©ched
 + 1, 
³ndšg_¢­shÙ
 + 1);

103 
	g£lf
.
»£t_¡©e
(
Prog»ssS‹
::
Probe
);

104 
	g£lf
.
	gÃxt_idx
 = 
£lf
.
m©ched
 + 1;

108 
pub
 
â
 
become_»¶iÿ‹
(&
mut
 
£lf
) {

109 
	g£lf
.
»£t_¡©e
(
Prog»ssS‹
::
R•liÿ‹
);

110 
	g£lf
.
	gÃxt_idx
 = 
£lf
.
m©ched
 + 1;

113 
pub
 
â
 
become_¢­shÙ
(&
mut
 
£lf
, 
¢­shÙ_idx
: 
u64
) {

114 
£lf
.
»£t_¡©e
(
Prog»ssS‹
::
SÇpshÙ
);

115 
	g£lf
.
	g³ndšg_¢­shÙ
 = 
¢­shÙ_idx
;

118 
pub
 
â
 
¢­shÙ_çu»
(&
mut
 
£lf
) {

119 
	g£lf
.
	g³ndšg_¢­shÙ
 = 0;

124 
pub
 
â
 
maybe_¢­shÙ_abÜt
(&
£lf
è-> 
	gboŞ
 {

125 
	g£lf
.
	g¡©e
 =ğ
Prog»ssS‹
::
SÇpshÙ
 && 
£lf
.
m©ched
 >ğ£lf.
³ndšg_¢­shÙ


130 
pub
 
â
 
maybe_upd©e
(&
mut
 
£lf
, 
n
: 
u64
è-> 
boŞ
 {

131 
Ët
 
Ãed_upd©e
 = 
£lf
.
m©ched
 < 
n
;

132 
	gÃed_upd©e
 {

133 
	g£lf
.
	gm©ched
 = 
n
;

134 
	g£lf
.
»sume
();

137 
	g£lf
.
	gÃxt_idx
 < 
	gn
 + 1 {

138 
	g£lf
.
	gÃxt_idx
 = 
n
 + 1

141 
	gÃed_upd©e


144 
pub
 
â
 
İtimi¡ic_upd©e
(&
mut
 
£lf
, 
n
: 
u64
) {

145 
£lf
.
Ãxt_idx
 = 
n
 + 1;

150 
pub
 
â
 
maybe_deü_to
(&
mut
 
£lf
, 
»jeùed
: 
u64
, 
Ï¡
: u64è-> 
boŞ
 {

151 
£lf
.
¡©e
 =ğ
Prog»ssS‹
::
R•liÿ‹
 {

154 
»jeùed
 <ğ
£lf
.
m©ched
 {

155  
çl£
;

157 
	g£lf
.
	gÃxt_idx
 = 
£lf
.
m©ched
 + 1;

158  
	gŒue
;

162 
	g£lf
.
	gÃxt_idx
 =ğ0 || 
£lf
.
Ãxt_idx
 - 1 !ğ
»jeùed
 {

163  
çl£
;

166 
	g£lf
.
	gÃxt_idx
 = 
cmp
::
mš
(
»jeùed
, 
Ï¡
 + 1);

167 
	g£lf
.
	gÃxt_idx
 < 1 {

168 
	g£lf
.
	gÃxt_idx
 = 1;

170 
	g£lf
.
»sume
();

171 
	gŒue


174 
pub
 
â
 
is_·u£d
(&
£lf
è-> 
	gboŞ
 {

175 
m©ch
 
	g£lf
.
	g¡©e
 {

176 
	gProg»ssS‹
::
Probe
 => 
£lf
.
·u£d
,

177 
	gProg»ssS‹
::
R•liÿ‹
 => 
£lf
.
šs
.
fuÎ
(),

178 
	gProg»ssS‹
::
SÇpshÙ
 => 
Œue
,

182 
pub
 
â
 
»sume
(&
mut
 
£lf
) {

183 
	g£lf
.
	g·u£d
 = 
çl£
;

186 
pub
 
â
 
·u£
(&
mut
 
£lf
) {

187 
	g£lf
.
	g·u£d
 = 
Œue
;

192 #[
d”ive
(
Debug
, 
DeçuÉ
, 
ClÚe
)]

193 
pub
 
	sInæights
 {

195 
	m¡¬t
: 
usize
,

197 
	mcouÁ
: 
usize
,

200 
	mbufãr
: 
Vec
<
u64
>,

203 
im¶
 
	gInæights
 {

204 
pub
 
â
 
Ãw
(
ÿp
: 
usize
è-> 
Inæights
 {

205 
Inæights
 {

206 
bufãr
: 
Vec
::
w™h_ÿ·c™y
(
ÿp
),

207 ..
	gDeçuÉ
::()

212 
pub
 
â
 
fuÎ
(&
£lf
è-> 
boŞ
 {

213 
£lf
.
couÁ
 =ğ£lf.
ÿp
()

216 
pub
 
â
 
ÿp
(&
£lf
è-> 
usize
 {

217 
£lf
.
bufãr
.
ÿ·c™y
()

221 
pub
 
â
 
add
(&
mut
 
£lf
, 
šæight
: 
u64
) {

222 
£lf
.
fuÎ
() {

223 
·nic
!("cannot‡dd into‡ full inflights")

226 
Ët
 
mut
 
Ãxt
 = 
£lf
.
¡¬t
 + s–f.
couÁ
;

227 
	gÃxt
 >ğ
£lf
.
ÿp
() {

228 
Ãxt
 -ğ
£lf
.
ÿp
();

230 
	gas£¹
!(
	gÃxt
 <ğ
£lf
.
bufãr
.
Ën
());

231 
	gÃxt
 =ğ
£lf
.
bufãr
.
Ën
() {

232 
£lf
.
bufãr
.
push
(
šæight
);

234 
	g£lf
.
	gbufãr
[
Ãxt
] = 
šæight
;

236 
	g£lf
.
	gcouÁ
 += 1;

240 
pub
 
â
 
ä“_to
(&
mut
 
£lf
, 
to
: 
u64
) {

241 
£lf
.
couÁ
 =ğ0 || 
to
 < s–f.
bufãr
[£lf.
¡¬t
] {

246 
Ët
 
mut
 
	gi
 = 0u
size
;

247 
Ët
 
mut
 
	gidx
 = 
£lf
.
¡¬t
;

248 
	gi
 < 
	g£lf
.
	gcouÁ
 {

249 
	gto
 < 
	g£lf
.
	gbufãr
[
idx
] {

256 
	gidx
 += 1;

257 
	gidx
 >ğ
£lf
.
ÿp
() {

258 
idx
 -ğ
£lf
.
ÿp
();

261 
	gi
 += 1;

265 
	g£lf
.
	gcouÁ
 -ğ
i
;

266 
	g£lf
.
	g¡¬t
 = 
idx
;

269 
pub
 
â
 
ä“_fœ¡_Úe
(&
mut
 
£lf
) {

270 
Ët
 
	g¡¬t
 = 
£lf
.
bufãr
[£lf.
¡¬t
];

271 
	g£lf
.
ä“_to
(
¡¬t
);

276 
pub
 
â
 
»£t
(&
mut
 
£lf
) {

277 
	g£lf
.
	gcouÁ
 = 0;

278 
	g£lf
.
	g¡¬t
 = 0;

	@src/raft/raft.rs

29 
u£
 
	g¡d
::
cmp
;

31 
u£
 
	g¿nd
::{
£lf
, 
	gRng
};

32 
u£
 
	gkv´Ùo
::
”aápb
::{
EÁry
, 
	gEÁryTy³
, 
	gH¬dS‹
, 
	gMes§ge
, 
	gMes§geTy³
, 
	gSÇpshÙ
};

33 
u£
 
	g´Ùobuf
::
»³©ed
::
R•—‹dF›ld
;

35 
u£
 
	gsu³r
::
¡Üage
::
StÜage
;

36 
u£
 
	gsu³r
::
´og»ss
::{
Inæights
, 
	gProg»ss
, 
	gProg»ssS‹
};

37 
u£
 
	gsu³r
::
”rÜs
::{
E¼Ü
, 
	gResuÉ
, 
	gStÜageE¼Ü
};

38 
u£
 
	gsu³r
::
¿á_log
::{
£lf
, 
	gRaáLog
};

39 
u£
 
	gsu³r
::
»ad_Úly
::{
R—dOÆy
, 
	gR—dOÆyO±iÚ
, 
	gR—dS‹
};

40 
u£
 
	gsu³r
::
FÏtM­
;

44 cÚ¡ 
	gCAMPAIGN_PRE_ELECTION
: &'static [u8] = b"CampaignPreElection";

47 cÚ¡ 
CAMPAIGN_ELECTION
: &'static [u8] = b"CampaignElection";

49 cÚ¡ 
CAMPAIGN_TRANSFER
: &'static [u8] = b"CampaignTransfer";

51 #[
d”ive
(
Debug
, 
P¬tŸlEq
, 
ClÚe
, 
Cİy
)]

52 
pub
 
	eS‹RŞe
 {

53 
	mFŞlow”
,

54 
	mCªdid©e
,

55 
	mL—d”
,

56 
	mP»Cªdid©e
,

59 
im¶
 
DeçuÉ
 
	gS‹RŞe
 {

60 
â
 (è-> 
	gS‹RŞe
 {

61 
	gS‹RŞe
::
FŞlow”


66 
pub
 cÚ¡ 
INVALID_ID
: 
u64
 = 0;

68 
pub
 cÚ¡ 
	gINVALID_INDEX
: 
u64
 = 0;

71 #[
d”ive
(
DeçuÉ
)]

72 
pub
 
	sCÚfig
 {

74 
pub
 
	mid
: 
u64
,

82 
pub
 
	m³”s
: 
Vec
<
u64
>,

90 
pub
 
	m–eùiÚ_tick
: 
usize
,

94 
pub
 
	mh—¹b—t_tick
: 
usize
,

100 
pub
 
	m­¶›d
: 
u64
,

106 
pub
 
	mmax_size_³r_msg
: 
u64
,

111 
pub
 
	mmax_šæight_msgs
: 
usize
,

115 
pub
 
	mcheck_quÜum
: 
boŞ
,

120 
pub
 
	m´e_vÙe
: 
boŞ
,

123 
pub
 
	m»ad_Úly_İtiÚ
: 
R—dOÆyO±iÚ
,

128 
pub
 
	msk_bÿ¡_comm™
: 
boŞ
,

131 
pub
 
	mg
: 
SŒšg
,

134 
im¶
 
	gCÚfig
 {

135 
pub
 
â
 
v®id©e
(&
£lf
è-> 
	gResuÉ
<()> {

136 
	g£lf
.
	gid
 =ğ
INVALID_ID
 {

137  
E¼
(
E¼Ü
::
CÚfigInv®id
("šv®id‚odid".
to_owÃd
()));

140 
	g£lf
.
	gh—¹b—t_tick
 == 0 {

141  
E¼
(
E¼Ü
::
CÚfigInv®id
(

142 "h—¹b—ˆtick mu¡ g»©”hª 0".
to_owÃd
(),

146 
	g£lf
.
	g–eùiÚ_tick
 <ğ
£lf
.
h—¹b—t_tick
 {

147  
E¼
(
E¼Ü
::
CÚfigInv®id
(

148 "–eùiÚick mu¡ bg»©”hª h—¹b—ˆtick".
to_owÃd
(),

152 
	g£lf
.
	gmax_šæight_msgs
 == 0 {

153  
E¼
(
E¼Ü
::
CÚfigInv®id
(

154 "max inæighˆmes§ge mu¡ bg»©”hª 0".
to_owÃd
(),

158 
Ok
(())

164 #[
d”ive
(
DeçuÉ
, 
P¬tŸlEq
, 
Debug
)]

165 
pub
 
	sSoáS‹
 {

166 
pub
 
	mËad”_id
: 
u64
,

167 
pub
 
	m¿á_¡©e
: 
S‹RŞe
,

170 #[
d”ive
(
DeçuÉ
)]

171 
pub
 
	gRaá
<
	gT
: 
StÜage
> {

172 
pub
 
‹rm
: 
u64
,

173 
pub
 
	gvÙe
: 
u64
,

175 
pub
 
	gid
: 
u64
,

177 
pub
 
	g»ad_¡©es
: 
Vec
<
R—dS‹
>,

180 
pub
 
	g¿á_log
: 
RaáLog
<
T
>,

182 
pub
 
	gmax_šæight
: 
usize
,

183 
pub
 
	gmax_msg_size
: 
u64
,

184 
pub
 
	g´s
: 
FÏtM­
<
u64
, 
	gProg»ss
>,

186 
pub
 
	g¡©e
: 
S‹RŞe
,

188 
pub
 
	gvÙes
: 
FÏtM­
<
u64
, 
	gboŞ
>,

190 
pub
 
	gmsgs
: 
Vec
<
Mes§ge
>,

193 
pub
 
	gËad”_id
: 
u64
,

197 
pub
 
	gËad_Œªsã»e
: 
O±iÚ
<
u64
>,

200 
pub
 
	g³ndšg_cÚf
: 
boŞ
,

202 
pub
 
	g»ad_Úly
: 
R—dOÆy
,

208 
pub
 
	g–eùiÚ_–­£d
: 
usize
,

212 
	gh—¹b—t_–­£d
: 
usize
,

214 
pub
 
	gcheck_quÜum
: 
boŞ
,

215 
	g´e_vÙe
: 
boŞ
,

216 
	gsk_bÿ¡_comm™
: 
boŞ
,

218 
	gh—¹b—t_timeout
: 
usize
,

219 
	g–eùiÚ_timeout
: 
usize
,

224 
	g¿ndomized_–eùiÚ_timeout
: 
usize
,

228 
pub
 
	gbefÜe_¡•_¡©e
: 
O±iÚ
<
Box
<
FnMut
(&
Mes§ge
è-> 
boŞ
>>,

231 
	gg
: 
SŒšg
,

234 
â
 
Ãw_´og»ss
(
Ãxt_idx
: 
u64
, 
šs_size
: 
usize
è-> 
Prog»ss
 {

235 
Prog»ss
 {

236 
Ãxt_idx
:‚ext_idx,

237 
	gšs
: 
Inæights
::
Ãw
(
šs_size
),

238 ..
	gDeçuÉ
::()

242 
â
 
Ãw_mes§ge
(
to
: 
u64
, 
f›ld_ty³
: 
Mes§geTy³
, 
äom
: 
O±iÚ
<u64>è-> 
Mes§ge
 {

243 
Ët
 
mut
 
m
 = 
Mes§ge
::
Ãw
();

244 
	gm
.
£t_to
(
to
);

245 
Ët
 
Some
(
id
èğ
äom
 {

246 
m
.
£t_äom
(
id
);

248 
	gm
.
£t_msg_ty³
(
f›ld_ty³
);

249 
	gm


253 
pub
 
â
 
vÙe_»¥_msg_ty³
(
t
: 
Mes§geTy³
) -> MessageType {

254 
m©ch
 
t
 {

255 
Mes§geTy³
::
MsgReque¡VÙe
 => Mes§geTy³::
MsgReque¡VÙeRe¥Ú£
,

256 
	gMes§geTy³
::
MsgReque¡P»VÙe
 => 
Mes§geTy³
::
MsgReque¡P»VÙeRe¥Ú£
,

257 
	g_
 => 
·nic
!("NÙ‡ vÙmes§ge: {:?}", 
	gt
),

262 
pub
 
â
 
quÜum
(
tÙ®
: 
usize
) -> usize {

263 
tÙ®
 / 2 + 1

266 
im¶
<
T
: 
StÜage
> 
Raá
<T> {

267 
pub
 
â
 
Ãw
(
c
: &
CÚfig
, 
¡Üe
: 
T
è-> 
Raá
<T> {

268 
c
.
v®id©e
().
ex³ù
("configuration is invalid");

269 
Ët
 
	grs
 = 
¡Üe
.
š™Ÿl_¡©e
().
ex³ù
("");

270 
Ët
 
	g¿á_log
 = 
RaáLog
::
Ãw
(
¡Üe
, 
c
.
g
.
şÚe
());

271 
Ët
 
mut
 
	g³”s
: &[
u64
] = &
c
.
³”s
;

272 !
	grs
.
	gcÚf_¡©e
.
g‘_nodes
().
is_em±y
() {

273 !
	g³”s
.
is_em±y
() {

277 
	g·nic
!(

279 
	gc
.
	gg


282 
	g³”s
 = 
rs
.
cÚf_¡©e
.
g‘_nodes
();

284 
Ët
 
mut
 
	gr
 = 
Raá
 {

285 
id
: 
c
.id,

286 
»ad_¡©es
: 
DeçuÉ
::(),

287 
¿á_log
:„aft_log,

288 
max_šæight
: 
c
.
max_šæight_msgs
,

289 
max_msg_size
: 
c
.
max_size_³r_msg
,

290 
´s
: 
FÏtM­
::
w™h_ÿ·c™y
(
³”s
.
Ën
()),

291 
¡©e
: 
S‹RŞe
::
FŞlow”
,

292 
check_quÜum
: 
c
.check_quorum,

293 
´e_vÙe
: 
c
.pre_vote,

294 
»ad_Úly
: 
R—dOÆy
::
Ãw
(
c
.
»ad_Úly_İtiÚ
),

295 
h—¹b—t_timeout
: 
c
.
h—¹b—t_tick
,

296 
–eùiÚ_timeout
: 
c
.
–eùiÚ_tick
,

297 
vÙes
: 
DeçuÉ
::(),

298 
msgs
: 
DeçuÉ
::(),

299 
Ëad”_id
: 
DeçuÉ
::(),

300 
Ëad_Œªsã»e
: 
NÚe
,

301 
‹rm
: 
DeçuÉ
::(),

302 
–eùiÚ_–­£d
: 
DeçuÉ
::(),

303 
³ndšg_cÚf
: 
DeçuÉ
::(),

304 
befÜe_¡•_¡©e
: 
NÚe
,

305 
vÙe
: 
DeçuÉ
::(),

306 
h—¹b—t_–­£d
: 
DeçuÉ
::(),

307 
¿ndomized_–eùiÚ_timeout
: 0,

308 
sk_bÿ¡_comm™
: 
c
.skip_bcast_commit,

309 
g
: 
c
.g.
to_owÃd
(),

311 
p
 
š
 
	g³”s
 {

312 
	gr
.
	g´s
.
š£¹
(*
p
, 
Ãw_´og»ss
(1, 
r
.
max_šæight
));

314 
	grs
.
	gh¬d_¡©e
 !ğ
H¬dS‹
::
Ãw
() {

315 
r
.
lßd_¡©e
(
rs
.
h¬d_¡©e
);

317 
	gc
.
	g­¶›d
 > 0 {

318 
	gr
.
	g¿á_log
.
­¶›d_to
(
c
.
­¶›d
);

320 
Ët
 
	g‹rm
 = 
r
.
‹rm
;

321 
	gr
.
become_fŞlow”
(
‹rm
, 
INVALID_ID
);

322 
	gšfo
!(

325 
	gr
.
	gg
,

326 
	gr
.
nodes
(),

327 
	gr
.
	g‹rm
,

328 
	gr
.
	g¿á_log
.
	gcomm™‹d
,

329 
	gr
.
	g¿á_log
.
g‘_­¶›d
(),

330 
	gr
.
	g¿á_log
.
Ï¡_šdex
(),

331 
	gr
.
	g¿á_log
.
Ï¡_‹rm
()

333 
	gr


336 #[
šlše
]

337 
pub
 
â
 
g‘_¡Üe
(&
£lf
è-> &
	gT
 {

338 
	g£lf
.
	g¿á_log
.
g‘_¡Üe
()

341 #[
šlše
]

342 
pub
 
â
 
mut_¡Üe
(&
mut
 
£lf
è-> &muˆ
	gT
 {

343 
	g£lf
.
	g¿á_log
.
mut_¡Üe
()

346 #[
šlše
]

347 
pub
 
â
 
g‘_¢­
(&
£lf
è-> 
	gO±iÚ
<&
	gSÇpshÙ
> {

348 
	g£lf
.
	g¿á_log
.
g‘_un¡abË
().
	g¢­shÙ
.
as_»f
()

351 #[
šlše
]

352 
pub
 
â
 
³ndšg_»ad_couÁ
(&
£lf
è-> 
	gusize
 {

353 
	g£lf
.
	g»ad_Úly
.
³ndšg_»ad_couÁ
()

356 #[
šlše
]

357 
pub
 
â
 
»ady_»ad_couÁ
(&
£lf
è-> 
	gusize
 {

358 
	g£lf
.
	g»ad_¡©es
.
Ën
()

361 
pub
 
â
 
soá_¡©e
(&
£lf
è-> 
	gSoáS‹
 {

362 
	gSoáS‹
 {

363 
	gËad”_id
: 
£lf
.
Ëad”_id
,

364 
	g¿á_¡©e
: 
£lf
.
¡©e
,

368 
pub
 
â
 
h¬d_¡©e
(&
£lf
è-> 
	gH¬dS‹
 {

369 
Ët
 
mut
 
	ghs
 = 
H¬dS‹
::
Ãw
();

370 
	ghs
.
£t_‹rm
(
£lf
.
‹rm
);

371 
	ghs
.
£t_vÙe
(
£lf
.
vÙe
);

372 
	ghs
.
£t_comm™
(
£lf
.
¿á_log
.
comm™‹d
);

373 
	ghs


376 
pub
 
â
 
š_Ëa£
(&
£lf
è-> 
	gboŞ
 {

377 
	g£lf
.
	g¡©e
 =ğ
S‹RŞe
::
L—d”
 && 
£lf
.
check_quÜum


380 
â
 
quÜum
(&
£lf
è-> 
usize
 {

381 
quÜum
(
£lf
.
´s
.
Ën
())

385 
pub
 
â
 
£t_¿ndomized_–eùiÚ_timeout
(&
mut
 
£lf
, 
t
: 
usize
) {

386 
£lf
.
¿ndomized_–eùiÚ_timeout
 = 
t
;

389 
pub
 
â
 
g‘_–eùiÚ_timeout
(&
£lf
è-> 
	gusize
 {

390 
	g£lf
.
	g–eùiÚ_timeout


393 
pub
 
â
 
g‘_h—¹b—t_timeout
(&
£lf
è-> 
	gusize
 {

394 
	g£lf
.
	gh—¹b—t_timeout


397 
pub
 
â
 
g‘_¿ndomized_–eùiÚ_timeout
(&
£lf
è-> 
	gusize
 {

398 
	g£lf
.
	g¿ndomized_–eùiÚ_timeout


401 
pub
 
â
 
nodes
(&
£lf
è-> 
	gVec
<
	gu64
> {

402 
Ët
 
mut
 
	gnodes
 = 
Vec
::
w™h_ÿ·c™y
(
£lf
.
´s
.
Ën
());

403 
	gnodes
.
ex‹nd
(
£lf
.
´s
.
keys
());

404 
	gnodes
.
sÜt
();

405 
	gnodes


409 
â
 
£nd
(&
mut
 
£lf
, muˆ
m
: 
Mes§ge
) {

410 
m
.
£t_äom
(
£lf
.
id
);

411 
	gm
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgReque¡VÙe
 ||

412 
m
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgReque¡P»VÙe


414 
m
.
g‘_‹rm
() == 0 {

417 
·nic
!(

419 
£lf
.
g
,

420 
m
.
g‘_msg_ty³
()

424 
	gm
.
g‘_‹rm
() != 0 {

425 
·nic
!(

427 
£lf
.
g
,

428 
m
.
g‘_msg_ty³
(),

429 
m
.
g‘_‹rm
()

436 
	gm
.
g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgPrİo£
 &&

437 
m
.
g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgR—dIndex


439 
m
.
£t_‹rm
(
£lf
.
‹rm
);

442 
	g£lf
.
	gmsgs
.
push
(
m
);

445 
â
 
´•¬e_£nd_¢­shÙ
(&
mut
 
£lf
, 
m
: &muˆ
Mes§ge
, 
to
: 
u64
è-> 
boŞ
 {

446 
Ët
 
´
 = 
£lf
.
´s
.
g‘_mut
(&
to
).
unw¿p
();

447 !
	g´
.
	g»ûÁ_aùive
 {

448 
	gdebug
!(

450 
	g£lf
.
	gg
,

451 
	gto


453  
	gçl£
;

456 
	gm
.
£t_msg_ty³
(
Mes§geTy³
::
MsgSÇpshÙ
);

457 
Ët
 
	g¢­shÙ_r
 = 
£lf
.
¿á_log
.
¢­shÙ
();

458 
Ët
 
E¼
(
e
èğ
¢­shÙ_r
 {

459 
e
 =ğ
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
SÇpshÙTempÜ¬yUÇvaabË
) {

460 
debug
!(

463 
£lf
.
g
,

464 
to


466  
	gçl£
;

468 
	g·nic
!("{} uÃx³ùedƒ¼Ü: {:?}", 
	g£lf
.
	gg
, 
	ge
);

470 
Ët
 
	g¢­shÙ
 = 
¢­shÙ_r
.
unw¿p
();

471 
	g¢­shÙ
.
g‘_m‘ad©a
().
g‘_šdex
() == 0 {

472 
·nic
!("{}‚“d‚Ú-em±y sÇpshÙ", 
£lf
.
g
);

474 
Ët
 (
sšdex
, 
¡”m
) = (

475 
¢­shÙ
.
g‘_m‘ad©a
().
g‘_šdex
(),

476 
	g¢­shÙ
.
g‘_m‘ad©a
().
g‘_‹rm
(),

478 
	gm
.
£t_¢­shÙ
(
¢­shÙ
);

479 
	gdebug
!(

482 
	g£lf
.
	gg
,

483 
	g£lf
.
	g¿á_log
.
fœ¡_šdex
(),

484 
	g£lf
.
	g¿á_log
.
	gcomm™‹d
,

485 
	gsšdex
,

486 
	g¡”m
,

487 
	gto
,

488 
	g´


490 
	g´
.
become_¢­shÙ
(
sšdex
);

491 
	gdebug
!(

493 
	g£lf
.
	gg
,

494 
	gto
,

495 
	g´


497 
	gŒue


500 
â
 
´•¬e_£nd_’Œ›s
(&
mut
 
£lf
, 
m
: &muˆ
Mes§ge
, 
to
: 
u64
, 
‹rm
: u64, 
’ts
: 
Vec
<
EÁry
>) {

501 
Ët
 
´
 = 
£lf
.
´s
.
g‘_mut
(&
to
).
unw¿p
();

502 
	gm
.
£t_msg_ty³
(
Mes§geTy³
::
MsgAµ’d
);

503 
	gm
.
£t_šdex
(
´
.
Ãxt_idx
 - 1);

504 
	gm
.
£t_log_‹rm
(
‹rm
);

505 
	gm
.
£t_’Œ›s
(
R•—‹dF›ld
::
äom_vec
(
’ts
));

506 
	gm
.
£t_comm™
(
£lf
.
¿á_log
.
comm™‹d
);

507 !
	gm
.
g‘_’Œ›s
().
is_em±y
() {

508 
m©ch
 
	g´
.
	g¡©e
 {

509 
	gProg»ssS‹
::
R•liÿ‹
 => {

510 
Ët
 
Ï¡
 = 
m
.
g‘_’Œ›s
().Ï¡().
unw¿p
().
g‘_šdex
();

511 
	g´
.
İtimi¡ic_upd©e
(
Ï¡
);

512 
	g´
.
	gšs
.
add
(
Ï¡
);

514 
	gProg»ssS‹
::
Probe
 => 
´
.
·u£
(),

515 
	g_
 => 
·nic
!(

517 
	g£lf
.
	gg
,

518 
	g´
.
	g¡©e


525 
pub
 
â
 
£nd_­³nd
(&
mut
 
£lf
, 
to
: 
u64
) {

526 
Ët
 (
‹rm
, 
’ts
) = {

527 
Ët
 
´
 = &
£lf
.
´s
[&
to
];

528 
	g´
.
is_·u£d
() {

532 
	g£lf
.
	g¿á_log
.
‹rm
(
´
.
Ãxt_idx
 - 1),

533 
	g£lf
.
	g¿á_log
.
’Œ›s
(
´
.
Ãxt_idx
, 
£lf
.
max_msg_size
),

536 
Ët
 
mut
 
	gm
 = 
Mes§ge
::
Ãw
();

537 
	gm
.
£t_to
(
to
);

538 
	g‹rm
.
is_”r
(è|| 
	g’ts
.is_err() {

540 !
	g£lf
.
´•¬e_£nd_¢­shÙ
(&
mut
 
m
, 
to
) {

544 
	g£lf
.
´•¬e_£nd_’Œ›s
(&
mut
 
m
, 
to
, 
‹rm
.
unw¿p
(), 
’ts
.unwrap());

546 
	g£lf
.
£nd
(
m
);

550 
â
 
£nd_h—¹b—t
(&
mut
 
£lf
, 
to
: 
u64
, 
ùx
: 
O±iÚ
<
Vec
<
u8
>>) {

557 
Ët
 
mut
 
m
 = 
Mes§ge
::
Ãw
();

558 
	gm
.
£t_to
(
to
);

559 
	gm
.
£t_msg_ty³
(
Mes§geTy³
::
MsgH—¹b—t
);

560 
Ët
 
	gcomm™
 = 
cmp
::
mš
(
£lf
.
´s
[&
to
].
m©ched
, s–f.
¿á_log
.
comm™‹d
);

561 
	gm
.
£t_comm™
(
comm™
);

562 
Ët
 
Some
(
cÚ‹xt
èğ
ùx
 {

563 
m
.
£t_cÚ‹xt
(
cÚ‹xt
);

565 
	g£lf
.
£nd
(
m
);

570 
pub
 
â
 
bÿ¡_­³nd
(&
mut
 
£lf
) {

572 
Ët
 
	gids
: 
Vec
<
_
> = 
£lf
.
´s
.
keys
().
şÚed
().
cŞËù
();

573 
id
 
š
 
	gids
 {

574 
	gid
 =ğ
£lf
.
id
 {

577 
	g£lf
.
£nd_­³nd
(
id
);

582 
pub
 
â
 
bÿ¡_h—¹b—t
(&
mut
 
£lf
) {

583 
Ët
 
	gùx
 = 
£lf
.
»ad_Úly
.
Ï¡_³ndšg_»que¡_ùx
();

584 
	g£lf
.
bÿ¡_h—¹b—t_w™h_ùx
(
ùx
)

587 
pub
 
â
 
bÿ¡_h—¹b—t_w™h_ùx
(&
mut
 
£lf
, 
ùx
: 
O±iÚ
<
Vec
<
u8
>>) {

589 
Ët
 
ids
: 
Vec
<
_
> = 
£lf
.
´s
.
keys
().
şÚed
().
cŞËù
();

590 
id
 
š
 
	gids
 {

591 
	gid
 =ğ
£lf
.
id
 {

594 
	g£lf
.
£nd_h—¹b—t
(
id
, 
ùx
.
şÚe
());

601 
pub
 
â
 
maybe_comm™
(&
mut
 
£lf
è-> 
	gboŞ
 {

602 
Ët
 
mut
 
	gmis_¬r
 = [0; 5];

603 
Ët
 
mut
 
	gmis_vec
;

604 
Ët
 
	gmis
 = 
£lf
.
´s
.
Ën
() <= 5 {

605 &
mut
 
mis_¬r
[..
£lf
.
´s
.
Ën
()]

607 
mis_vec
 = 
vec
![0; 
£lf
.
´s
.
Ën
()];

608 
	gmis_vec
.
as_mut_¦iû
()

610 
	gi
, 
	g´
è
š
 
	g£lf
.
	g´s
.
v®ues
().
’um”©e
() {

611 
	gmis
[
i
] = 
´
.
m©ched
;

614 
	gmis
.
sÜt_by
(|
a
, 
b
| b.
cmp
(a));

615 
Ët
 
	gmci
 = 
mis
[
£lf
.
quÜum
() - 1];

616 
	g£lf
.
	g¿á_log
.
maybe_comm™
(
mci
, 
£lf
.
‹rm
)

619 
pub
 
â
 
»£t
(&
mut
 
£lf
, 
‹rm
: 
u64
) {

620 
£lf
.
‹rm
 !=erm {

621 
£lf
.
‹rm
 =erm;

622 
	g£lf
.
	gvÙe
 = 
INVALID_ID
;

624 
	g£lf
.
	gËad”_id
 = 
INVALID_ID
;

625 
	g£lf
.
»£t_¿ndomized_–eùiÚ_timeout
();

626 
	g£lf
.
	g–eùiÚ_–­£d
 = 0;

627 
	g£lf
.
	gh—¹b—t_–­£d
 = 0;

629 
	g£lf
.
abÜt_Ëad”_Œªsãr
();

631 
	g£lf
.
	gvÙes
 = 
FÏtM­
::();

632 
Ët
 (
Ï¡_šdex
, 
max_šæight
èğ(
£lf
.
¿á_log
.Ï¡_šdex(), 
	g£lf
.
	gmax_šæight
);

633 
Ët
 
	g£lf_id
 = 
£lf
.
id
;

634 
	gid
, 
	gp
è
	gš
 &
mut
 
	g£lf
.
	g´s
 {

635 *
	gp
 = 
Ãw_´og»ss
(
Ï¡_šdex
 + 1, 
max_šæight
);

636 
	gid
 =ğ&
£lf_id
 {

637 
p
.
m©ched
 = 
Ï¡_šdex
;

640 
	g£lf
.
	g³ndšg_cÚf
 = 
çl£
;

641 
	g£lf
.
	g»ad_Úly
 = 
R—dOÆy
::
Ãw
(
£lf
.
»ad_Úly
.
İtiÚ
);

644 
pub
 
â
 
­³nd_’Œy
(&
mut
 
£lf
, 
es
: &muˆ[
EÁry
]) {

645 
Ët
 
li
 = 
£lf
.
¿á_log
.
Ï¡_šdex
();

646 
	gi
, 
	ge
è
š
 
	ges
.
™”_mut
().
’um”©e
() {

647 
	ge
.
£t_‹rm
(
£lf
.
‹rm
);

648 
	ge
.
£t_šdex
(
li
 + 1 + 
i
 
as
 
u64
);

650 
	g£lf
.
	g¿á_log
.
­³nd
(
es
);

651 
	g£lf
.
	g´s


652 .
g‘_mut
(&
£lf
.
id
)

653 .
unw¿p
()

654 .
maybe_upd©e
(
£lf
.
¿á_log
.
Ï¡_šdex
());

656 
	g£lf
.
maybe_comm™
();

660 
pub
 
â
 
tick
(&
mut
 
£lf
è-> 
	gboŞ
 {

661 
m©ch
 
	g£lf
.
	g¡©e
 {

662 
	gS‹RŞe
::
FŞlow”
 | 
S‹RŞe
::
P»Cªdid©e
 | S‹RŞe::
Cªdid©e
 => {

663 
£lf
.
tick_–eùiÚ
()

665 
S‹RŞe
::
L—d”
 => 
£lf
.
tick_h—¹b—t
(),

672 
pub
 
â
 
tick_–eùiÚ
(&
mut
 
£lf
è-> 
	gboŞ
 {

673 
	g£lf
.
	g–eùiÚ_–­£d
 += 1;

674 !
	g£lf
.
·ss_–eùiÚ_timeout
(è|| !£lf.
´omÙabË
() {

675  
	gçl£
;

678 
	g£lf
.
	g–eùiÚ_–­£d
 = 0;

679 
Ët
 
	gm
 = 
Ãw_mes§ge
(
INVALID_ID
, 
Mes§geTy³
::
MsgHup
, 
Some
(
£lf
.
id
));

680 
	g£lf
.
¡•
(
m
).
is_ok
();

681 
	gŒue


686 
â
 
tick_h—¹b—t
(&
mut
 
£lf
è-> 
	gboŞ
 {

687 
	g£lf
.
	gh—¹b—t_–­£d
 += 1;

688 
	g£lf
.
	g–eùiÚ_–­£d
 += 1;

690 
Ët
 
mut
 
	ghas_»ady
 = 
çl£
;

691 
	g£lf
.
	g–eùiÚ_–­£d
 >ğ
£lf
.
–eùiÚ_timeout
 {

692 
£lf
.
–eùiÚ_–­£d
 = 0;

693 
	g£lf
.
	gcheck_quÜum
 {

694 
Ët
 
	gm
 = 
Ãw_mes§ge
(
INVALID_ID
, 
Mes§geTy³
::
MsgCheckQuÜum
, 
Some
(
£lf
.
id
));

695 
	ghas_»ady
 = 
Œue
;

696 
	g£lf
.
¡•
(
m
).
is_ok
();

698 
	g£lf
.
	g¡©e
 =ğ
S‹RŞe
::
L—d”
 && 
£lf
.
Ëad_Œªsã»e
.
is_some
() {

699 
£lf
.
abÜt_Ëad”_Œªsãr
()

703 
£lf
.
¡©e
 !ğ
S‹RŞe
::
L—d”
 {

704  
has_»ady
;

707 
	g£lf
.
	gh—¹b—t_–­£d
 >ğ
£lf
.
h—¹b—t_timeout
 {

708 
£lf
.
h—¹b—t_–­£d
 = 0;

709 
	ghas_»ady
 = 
Œue
;

710 
Ët
 
	gm
 = 
Ãw_mes§ge
(
INVALID_ID
, 
Mes§geTy³
::
MsgB—t
, 
Some
(
£lf
.
id
));

711 
	g£lf
.
¡•
(
m
).
is_ok
();

713 
	ghas_»ady


716 
pub
 
â
 
become_fŞlow”
(&
mut
 
£lf
, 
‹rm
: 
u64
, 
Ëad”_id
: u64) {

717 
£lf
.
»£t
(
‹rm
);

718 
	g£lf
.
	gËad”_id
 = 
Ëad”_id
;

719 
	g£lf
.
	g¡©e
 = 
S‹RŞe
::
FŞlow”
;

720 
	gšfo
!("{} beÿmfŞlow”‡ˆ‹rm {}", 
	g£lf
.
	gg
, s–f.
	g‹rm
);

724 
pub
 
â
 
become_ÿndid©e
(&
mut
 
£lf
) {

725 
	gas£¹_Ã
!(

726 
	g£lf
.
	g¡©e
,

727 
	gS‹RŞe
::
L—d”
,

730 
Ët
 
	g‹rm
 = 
£lf
.
‹rm
 + 1;

731 
	g£lf
.
»£t
(
‹rm
);

732 
Ët
 
	gid
 = 
£lf
.
id
;

733 
	g£lf
.
	gvÙe
 = 
id
;

734 
	g£lf
.
	g¡©e
 = 
S‹RŞe
::
Cªdid©e
;

735 
	gšfo
!("{} beÿmÿndid©©”m {}", 
	g£lf
.
	gg
, s–f.
	g‹rm
);

738 
pub
 
â
 
become_´e_ÿndid©e
(&
mut
 
£lf
) {

739 
	gas£¹_Ã
!(

740 
	g£lf
.
	g¡©e
,

741 
	gS‹RŞe
::
L—d”
,

747 
	g£lf
.
	g¡©e
 = 
S‹RŞe
::
P»Cªdid©e
;

748 
	gšfo
!("{} beÿm´e-ÿndid©©”m {}", 
	g£lf
.
	gg
, s–f.
	g‹rm
);

752 
pub
 
â
 
become_Ëad”
(&
mut
 
£lf
) {

753 
	gas£¹_Ã
!(

754 
	g£lf
.
	g¡©e
,

755 
	gS‹RŞe
::
FŞlow”
,

758 
Ët
 
	g‹rm
 = 
£lf
.
‹rm
;

759 
	g£lf
.
»£t
(
‹rm
);

760 
	g£lf
.
	gËad”_id
 = 
£lf
.
id
;

761 
	g£lf
.
	g¡©e
 = 
S‹RŞe
::
L—d”
;

762 
Ët
 
	gbegš
 = 
£lf
.
¿á_log
.
comm™‹d
 + 1;

763 
Ët
 
	g’ts
 = 
£lf
.
¿á_log


764 .
’Œ›s
(
begš
, 
¿á_log
::
NO_LIMIT
)

765 .
ex³ù
("unexpectedƒrror getting uncommittedƒntries");

766 
Ët
 
	gncÚf
 = 
£lf
.
num_³ndšg_cÚf
(&
’ts
);

767 
	gncÚf
 > 1 {

768 
	g·nic
!("{} uÃx³ùed doubË uncomm™‹d cÚfigƒÁry", 
	g£lf
.
	gg
);

771 
	gncÚf
 == 1 {

772 
£lf
.
³ndšg_cÚf
 = 
Œue
;

774 
	g£lf
.
­³nd_’Œy
(&
mut
 [
EÁry
::
Ãw
()]);

775 
	gšfo
!("{} beÿmËad”‡ˆ‹rm {}", 
	g£lf
.
	gg
, s–f.
	g‹rm
);

778 
â
 
num_³ndšg_cÚf
(&
£lf
, 
’ts
: &[
EÁry
]è-> 
usize
 {

779 
’ts
.
što_™”
()

780 .
f‹r
(|
e
|ƒ.
g‘_’Œy_ty³
(è=ğ
EÁryTy³
::
EÁryCÚfChªge
)

781 .
couÁ
()

784 
â
 
ÿm·ign
(&
mut
 
£lf
, 
ÿm·ign_ty³
: &[
u8
]) {

785 
Ët
 (
vÙe_msg
, 
‹rm
èğ
ÿm·ign_ty³
 =ğ
CAMPAIGN_PRE_ELECTION
 {

786 
£lf
.
become_´e_ÿndid©e
();

788 (
	gMes§geTy³
::
MsgReque¡P»VÙe
, 
	g£lf
.
	g‹rm
 + 1)

790 
	g£lf
.
become_ÿndid©e
();

791 (
	gMes§geTy³
::
MsgReque¡VÙe
, 
	g£lf
.
	g‹rm
)

793 
Ët
 
	gid
 = 
£lf
.
id
;

794 
	g£lf
.
quÜum
(è=ğ
£lf
.
pŞl
(
id
, 
vÙe_»¥_msg_ty³
(
vÙe_msg
), 
Œue
) {

797 
	gÿm·ign_ty³
 =ğ
CAMPAIGN_PRE_ELECTION
 {

798 
£lf
.
ÿm·ign
(
CAMPAIGN_ELECTION
);

800 
	g£lf
.
become_Ëad”
();

804 
Ët
 
	gids
: 
Vec
<
_
> = 
£lf
.
´s
.
keys
().
şÚed
().
cŞËù
();

805 
id
 
š
 
	gids
 {

806 
	gid
 =ğ
£lf
.
id
 {

809 
	gšfo
!(

811 
	g£lf
.
	gg
,

812 
	g£lf
.
	g¿á_log
.
Ï¡_‹rm
(),

813 
	g£lf
.
	g¿á_log
.
Ï¡_šdex
(),

814 
	gvÙe_msg
,

815 
	gid
,

816 
	g£lf
.
	g‹rm


818 
Ët
 
mut
 
	gm
 = 
Ãw_mes§ge
(
id
, 
vÙe_msg
, 
NÚe
);

819 
	gm
.
£t_‹rm
(
‹rm
);

820 
	gm
.
£t_šdex
(
£lf
.
¿á_log
.
Ï¡_šdex
());

821 
	gm
.
£t_log_‹rm
(
£lf
.
¿á_log
.
Ï¡_‹rm
());

822 
	gÿm·ign_ty³
 =ğ
CAMPAIGN_TRANSFER
 {

823 
m
.
£t_cÚ‹xt
(
ÿm·ign_ty³
.
to_vec
());

825 
	g£lf
.
£nd
(
m
);

829 
â
 
pŞl
(&
mut
 
£lf
, 
id
: 
u64
, 
t
: 
Mes§geTy³
, 
v
: 
boŞ
è-> 
usize
 {

830 
v
 {

831 
šfo
!(

833 
	g£lf
.
	gg
,

834 
	gt
,

835 
	gid
,

836 
	g£lf
.
	g‹rm


839 
	gšfo
!(

841 
	g£lf
.
	gg
,

842 
	gt
,

843 
	gid
,

844 
	g£lf
.
	g‹rm


847 
	g£lf
.
	gvÙes
.
’Œy
(
id
).
Ü_š£¹
(
v
);

848 
	g£lf
.
	gvÙes
.
v®ues
().
f‹r
(|
x
| **x).
couÁ
()

851 
pub
 
â
 
¡•
(&
mut
 
£lf
, 
m
: 
Mes§ge
è-> 
ResuÉ
<()> {

854 
m
.
g‘_‹rm
() == 0 {

856 } 
m
.
g‘_‹rm
(è> 
£lf
.
‹rm
 {

857 
m
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgReque¡VÙe
 ||

858 
m
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgReque¡P»VÙe


860 
Ët
 
fÜû
 = 
m
.
g‘_cÚ‹xt
(è=ğ
CAMPAIGN_TRANSFER
;

861 
Ët
 
	gš_Ëa£
 = 
£lf
.
check_quÜum
 && s–f.
Ëad”_id
 !ğ
INVALID_ID
 &&

862 
£lf
.
–eùiÚ_–­£d
 < s–f.
–eùiÚ_timeout
;

863 !
	gfÜû
 && 
	gš_Ëa£
 {

867 
	gšfo
!(

871 
	g£lf
.
	gg
,

872 
	g£lf
.
	g¿á_log
.
Ï¡_‹rm
(),

873 
	g£lf
.
	g¿á_log
.
Ï¡_šdex
(),

874 
	g£lf
.
	gvÙe
,

875 
	gm
.
g‘_msg_ty³
(),

876 
	gm
.
g‘_äom
(),

877 
	gm
.
g‘_log_‹rm
(),

878 
	gm
.
g‘_šdex
(),

879 
	g£lf
.
	g‹rm
,

880 
	g£lf
.
	g–eùiÚ_timeout
 - s–f.
	g–eùiÚ_–­£d


883  
Ok
(());

887 
	gm
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgReque¡P»VÙe
 ||

888 (
m
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgReque¡P»VÙeRe¥Ú£
 && !m.
g‘_»jeù
())

900 
šfo
!(

902 
£lf
.
g
,

903 
£lf
.
‹rm
,

904 
m
.
g‘_msg_ty³
(),

905 
m
.
g‘_äom
(),

906 
m
.
g‘_‹rm
()

908 
	gm
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgAµ’d
 ||

909 
m
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgH—¹b—t
 ||

910 
m
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgSÇpshÙ


912 
£lf
.
become_fŞlow”
(
m
.
g‘_‹rm
(), m.
g‘_äom
());

914 
	g£lf
.
become_fŞlow”
(
m
.
g‘_‹rm
(), 
INVALID_ID
);

917 } 
	gm
.
g‘_‹rm
(è< 
	g£lf
.
	g‹rm
 {

918 
	g£lf
.
	gcheck_quÜum
 &&

919 (
	gm
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgH—¹b—t
 ||

920 
m
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgAµ’d
)

934 
Ët
 
to_£nd
 = 
Ãw_mes§ge
(
m
.
g‘_äom
(), 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 
NÚe
);

935 
	g£lf
.
£nd
(
to_£nd
);

938 
	gšfo
!(

940 
	g£lf
.
	gg
,

941 
	g£lf
.
	g‹rm
,

942 
	gm
.
g‘_msg_ty³
(),

943 
	gm
.
g‘_äom
(),

944 
	gm
.
g‘_‹rm
()

947  
Ok
(());

950 
Ët
 
Some
(
»f
 
mut
 
f
èğ
£lf
.
befÜe_¡•_¡©e
 {

951 !
f
(&
m
) {

953  
Ok
(());

958 
m©ch
 
	gm
.
g‘_msg_ty³
() {

959 
	gMes§geTy³
::
MsgHup
 => 
£lf
.
¡©e
 !ğ
S‹RŞe
::
L—d”
 {

960 
Ët
 
’ts
 = 
£lf
.
¿á_log


961 .
¦iû
(

962 
£lf
.
¿á_log
.
­¶›d
 + 1,

963 
£lf
.
¿á_log
.
comm™‹d
 + 1,

964 
¿á_log
::
NO_LIMIT
,

966 .
ex³ù
("unexpectedƒrror getting unappliedƒntries");

967 
Ët
 
	gn
 = 
£lf
.
num_³ndšg_cÚf
(&
’ts
);

968 
	gn
 !ğ0 && 
£lf
.
¿á_log
.
comm™‹d
 > s–f.¿á_log.
­¶›d
 {

969 
w¬n
!(

972 
£lf
.
g
,

973 
£lf
.
‹rm
,

974 
n


976  
Ok
(());

978 
	gšfo
!(

980 
	g£lf
.
	gg
,

981 
	g£lf
.
	g‹rm


983 
	g£lf
.
	g´e_vÙe
 {

984 
	g£lf
.
ÿm·ign
(
CAMPAIGN_PRE_ELECTION
);

986 
	g£lf
.
ÿm·ign
(
CAMPAIGN_ELECTION
);

989 
	gdebug
!("{} ignÜšg MsgHu°beÿu£‡Ì—dy†—d”", 
	g£lf
.
	gg
);

991 
	gMes§geTy³
::
MsgReque¡VÙe
 | 
Mes§geTy³
::
MsgReque¡P»VÙe
 => {

994 ià(
£lf
.
vÙe
 =ğ
INVALID_ID
 || 
m
.
g‘_‹rm
(è> s–f.
‹rm
 ||

995 
£lf
.
vÙe
 =ğ
m
.
g‘_äom
()) &&

996 
£lf
.
¿á_log
.
is_up_to_d©e
(
m
.
g‘_šdex
(), m.
g‘_log_‹rm
())

998 
	g£lf
.
log_vÙe_­´ove
(&
m
);

999 
Ët
 
mut
 
	gto_£nd
 =

1000 
Ãw_mes§ge
(
m
.
g‘_äom
(), 
vÙe_»¥_msg_ty³
(m.
g‘_msg_ty³
()), 
NÚe
);

1001 
	gto_£nd
.
£t_»jeù
(
çl£
);

1002 
	g£lf
.
£nd
(
to_£nd
);

1003 
	gm
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgReque¡VÙe
 {

1005 
£lf
.
–eùiÚ_–­£d
 = 0;

1006 
	g£lf
.
	gvÙe
 = 
m
.
g‘_äom
();

1009 
	g£lf
.
log_vÙe_»jeù
(&
m
);

1010 
Ët
 
mut
 
	gto_£nd
 =

1011 
Ãw_mes§ge
(
m
.
g‘_äom
(), 
vÙe_»¥_msg_ty³
(m.
g‘_msg_ty³
()), 
NÚe
);

1012 
	gto_£nd
.
£t_»jeù
(
Œue
);

1013 
	g£lf
.
£nd
(
to_£nd
);

1016 
	g_
 => 
m©ch
 
£lf
.
¡©e
 {

1017 
S‹RŞe
::
P»Cªdid©e
 | S‹RŞe::
Cªdid©e
 => 
£lf
.
¡•_ÿndid©e
(
m
),

1018 
	gS‹RŞe
::
FŞlow”
 => 
£lf
.
¡•_fŞlow”
(
m
),

1019 
	gS‹RŞe
::
L—d”
 => 
£lf
.
¡•_Ëad”
(
m
),

1023 
Ok
(())

1026 
â
 
log_vÙe_­´ove
(&
£lf
, 
m
: &
Mes§ge
) {

1027 
šfo
!(

1030 
	g£lf
.
	gg
,

1031 
	g£lf
.
	g¿á_log
.
Ï¡_‹rm
(),

1032 
	g£lf
.
	g¿á_log
.
Ï¡_šdex
(),

1033 
	g£lf
.
	gvÙe
,

1034 
	gm
.
g‘_msg_ty³
(),

1035 
	gm
.
g‘_äom
(),

1036 
	gm
.
g‘_log_‹rm
(),

1037 
	gm
.
g‘_šdex
(),

1038 
	g£lf
.
	g‹rm


1042 
â
 
log_vÙe_»jeù
(&
£lf
, 
m
: &
Mes§ge
) {

1043 
šfo
!(

1046 
	g£lf
.
	gg
,

1047 
	g£lf
.
	g¿á_log
.
Ï¡_‹rm
(),

1048 
	g£lf
.
	g¿á_log
.
Ï¡_šdex
(),

1049 
	g£lf
.
	gvÙe
,

1050 
	gm
.
g‘_msg_ty³
(),

1051 
	gm
.
g‘_äom
(),

1052 
	gm
.
g‘_log_‹rm
(),

1053 
	gm
.
g‘_šdex
(),

1054 
	g£lf
.
	g‹rm


1058 
â
 
hªdË_­³nd_»¥Ú£
(

1059 &
mut
 
£lf
,

1060 
m
: &
Mes§ge
,

1061 
Şd_·u£d
: &
mut
 
boŞ
,

1062 
£nd_­³nd
: &
mut
 
boŞ
,

1063 
maybe_comm™
: &
mut
 
boŞ
,

1065 
	g£lf
.
	g´s
.
g‘_mut
(&
m
.
g‘_äom
()).
unw¿p
().
	g»ûÁ_aùive
 = 
Œue
;

1066 
	gm
.
g‘_»jeù
() {

1067 
Ët
 
	g´
 = 
£lf
.
´s
.
g‘_mut
(&
m
.
g‘_äom
()).
unw¿p
();

1068 
	gdebug
!(

1070 
	g£lf
.
	gg
,

1071 
	gm
.
g‘_»jeù_hšt
(),

1072 
	gm
.
g‘_äom
(),

1073 
	gm
.
g‘_šdex
()

1075 
	g´
.
maybe_deü_to
(
m
.
g‘_šdex
(), m.
g‘_»jeù_hšt
()) {

1076 
	gdebug
!(

1078 
	g£lf
.
	gg
,

1079 
	gm
.
g‘_äom
(),

1080 
	g´


1082 
	g´
.
	g¡©e
 =ğ
Prog»ssS‹
::
R•liÿ‹
 {

1083 
´
.
become_´obe
();

1085 *
	g£nd_­³nd
 = 
Œue
;

1091 
Ët
 
	g´
 = 
£lf
.
´s
.
g‘_mut
(&
m
.
g‘_äom
()).
unw¿p
();

1092 *
	gŞd_·u£d
 = 
´
.
is_·u£d
();

1093 !
	g´
.
maybe_upd©e
(
m
.
g‘_šdex
()) {

1099 
Ët
 
Some
(
Ëad_Œªsã»e
èğ
£lf
.lead_transferee {

1100 
m
.
g‘_äom
(è=ğ
Ëad_Œªsã»e
 &&

1101 
£lf
.
´s
.
g‘_mut
(&
m
.
g‘_äom
()).
unw¿p
().
m©ched
 =ğ£lf.
¿á_log
.
Ï¡_šdex
()

1103 
šfo
!(

1105 
£lf
.
g
,

1106 
m
.
g‘_äom
()

1108 
	g£lf
.
£nd_timeout_now
(
m
.
g‘_äom
());

1112 
Ët
 
	g´
 = 
£lf
.
´s
.
g‘_mut
(&
m
.
g‘_äom
()).
unw¿p
();

1113 
m©ch
 
	g´
.
	g¡©e
 {

1114 
	gProg»ssS‹
::
Probe
 => 
´
.
become_»¶iÿ‹
(),

1115 
	gProg»ssS‹
::
SÇpshÙ
 => {

1116 !
´
.
maybe_¢­shÙ_abÜt
() {

1119 
	gdebug
!(

1122 
	g£lf
.
	gg
,

1123 
	gm
.
g‘_äom
(),

1124 
	g´


1126 
	g´
.
become_´obe
();

1128 
	gProg»ssS‹
::
R•liÿ‹
 => 
´
.
šs
.
ä“_to
(
m
.
g‘_šdex
()),

1130 *
	gmaybe_comm™
 = 
Œue
;

1133 
â
 
hªdË_Œªsãr_Ëad”
(&
mut
 
£lf
, 
m
: &
Mes§ge
) {

1134 
Ët
 
Ëad_Œªsã»e
 = 
m
.
g‘_äom
();

1135 
Ët
 
	gÏ¡_Ëad_Œªsã»e
 = 
£lf
.
Ëad_Œªsã»e
;

1136 
	gÏ¡_Ëad_Œªsã»e
.
is_some
() {

1137 
	gÏ¡_Ëad_Œªsã»e
.
unw¿p
(è=ğ
Ëad_Œªsã»e
 {

1138 
šfo
!(

1141 
£lf
.
g
,

1142 
£lf
.
‹rm
,

1143 
Ëad_Œªsã»e
,

1144 
Ëad_Œªsã»e


1148 
	g£lf
.
abÜt_Ëad”_Œªsãr
();

1149 
	gšfo
!(

1151 
	g£lf
.
	gg
,

1152 
	g£lf
.
	g‹rm
,

1153 
	gÏ¡_Ëad_Œªsã»e
.
unw¿p
()

1156 
	gËad_Œªsã»e
 =ğ
£lf
.
id
 {

1157 
debug
!(

1159 
£lf
.
g


1164 
	gšfo
!(

1166 
	g£lf
.
	gg
,

1167 
	g£lf
.
	g‹rm
,

1168 
	gËad_Œªsã»e


1172 
	g£lf
.
	g–eùiÚ_–­£d
 = 0;

1173 
	g£lf
.
	gËad_Œªsã»e
 = 
Some
(
Ëad_Œªsã»e
);

1174 
	g£lf
.
	g´s
[&
m
.
g‘_äom
()].
	gm©ched
 =ğ
£lf
.
¿á_log
.
Ï¡_šdex
() {

1175 
£lf
.
£nd_timeout_now
(
Ëad_Œªsã»e
);

1176 
	gšfo
!(

1178 
	g£lf
.
	gg
,

1179 
	gËad_Œªsã»e
,

1180 
	gËad_Œªsã»e


1183 
	g£lf
.
£nd_­³nd
(
Ëad_Œªsã»e
);

1187 
â
 
hªdË_¢­shÙ_¡©us
(&
mut
 
£lf
, 
m
: &
Mes§ge
) {

1188 
Ët
 
´
 = 
£lf
.
´s
.
g‘_mut
(&
m
.
g‘_äom
()).
unw¿p
();

1189 
	gm
.
g‘_»jeù
() {

1190 
	g´
.
¢­shÙ_çu»
();

1191 
	g´
.
become_´obe
();

1192 
	gdebug
!(

1194 
	g£lf
.
	gg
,

1195 
	gm
.
g‘_äom
(),

1196 
	g´


1199 
	g´
.
become_´obe
();

1200 
	gdebug
!(

1202 
	g£lf
.
	gg
,

1203 
	gm
.
g‘_äom
(),

1204 
	g´


1210 
	g´
.
·u£
();

1214 
â
 
check_mes§ge_w™h_´og»ss
(

1215 &
mut
 
£lf
,

1216 
m
: &
mut
 
Mes§ge
,

1217 
£nd_­³nd
: &
mut
 
boŞ
,

1218 
Şd_·u£d
: &
mut
 
boŞ
,

1219 
maybe_comm™
: &
mut
 
boŞ
,

1220 
mÜe_to_£nd
: &
mut
 
O±iÚ
<
Mes§ge
>,

1222 !
	g£lf
.
	g´s
.
cÚšs_key
(&
m
.
g‘_äom
()) {

1223 
	gdebug
!("{}‚Ø´og»s avaabË fÜ {}", 
	g£lf
.
	gg
, 
	gm
.
g‘_äom
());

1226 
m©ch
 
	gm
.
g‘_msg_ty³
() {

1227 
	gMes§geTy³
::
MsgAµ’dRe¥Ú£
 => {

1228 
£lf
.
hªdË_­³nd_»¥Ú£
(
m
, 
Şd_·u£d
, 
£nd_­³nd
, 
maybe_comm™
);

1230 
	gMes§geTy³
::
MsgH—¹b—tRe¥Ú£
 => {

1232 
Ët
 
´
 = 
£lf
.
´s
.
g‘_mut
(&
m
.
g‘_äom
()).
unw¿p
();

1233 
	g´
.
	g»ûÁ_aùive
 = 
Œue
;

1234 
	g´
.
»sume
();

1237 
	g´
.
	g¡©e
 =ğ
Prog»ssS‹
::
R•liÿ‹
 && 
´
.
šs
.
fuÎ
() {

1238 
´
.
šs
.
ä“_fœ¡_Úe
();

1240 
	g´
.
	gm©ched
 < 
	g£lf
.
	g¿á_log
.
Ï¡_šdex
() {

1241 *
	g£nd_­³nd
 = 
Œue
;

1245 
	g£lf
.
	g»ad_Úly
.
	gİtiÚ
 !ğ
R—dOÆyO±iÚ
::
Saã
 || 
m
.
g‘_cÚ‹xt
().
is_em±y
() {

1249 
Ët
 
	gack_couÁ
 = 
£lf
.
»ad_Úly
.
»cv_ack
(
m
);

1250 
	gack_couÁ
 < 
	g£lf
.
quÜum
() {

1254 
Ët
 
	grss
 = 
£lf
.
»ad_Úly
.
advªû
(
m
);

1255 
rs
 
š
 
	grss
 {

1256 
Ët
 
mut
 
	g»q
 = 
rs
.
»q
;

1257 
	g»q
.
g‘_äom
(è=ğ
INVALID_ID
 || 
»q
.g‘_äom(è=ğ
£lf
.
id
 {

1259 
Ët
 
rs
 = 
R—dS‹
 {

1260 
šdex
: 
rs
.index,

1261 
»que¡_ùx
: 
»q
.
ke_’Œ›s
()[0].
ke_d©a
(),

1263 
	g£lf
.
	g»ad_¡©es
.
push
(
rs
);

1265 
Ët
 
mut
 
	gto_£nd
 = 
Mes§ge
::
Ãw
();

1266 
	gto_£nd
.
£t_to
(
»q
.
g‘_äom
());

1267 
	gto_£nd
.
£t_msg_ty³
(
Mes§geTy³
::
MsgR—dIndexRe¥
);

1268 
	gto_£nd
.
£t_šdex
(
rs
.
šdex
);

1269 
	gto_£nd
.
£t_’Œ›s
(
»q
.
ke_’Œ›s
());

1270 *
	gmÜe_to_£nd
 = 
Some
(
to_£nd
);

1274 
	gMes§geTy³
::
MsgSÇpStus
 => {

1275 
£lf
.
´s
[&
m
.
g‘_äom
()].
¡©e
 !ğ
Prog»ssS‹
::
SÇpshÙ
 {

1278 
	g£lf
.
hªdË_¢­shÙ_¡©us
(
m
);

1280 
	gMes§geTy³
::
MsgUÄ—chabË
 => {

1281 
Ët
 
´
 = 
£lf
.
´s
.
g‘_mut
(&
m
.
g‘_äom
()).
unw¿p
();

1284 
	g´
.
	g¡©e
 =ğ
Prog»ssS‹
::
R•liÿ‹
 {

1285 
´
.
become_´obe
();

1287 
	gdebug
!(

1289 
	g£lf
.
	gg
,

1290 
	gm
.
g‘_äom
(),

1291 
	g´


1294 
	gMes§geTy³
::
MsgT¿nsãrL—d”
 => {

1295 
£lf
.
hªdË_Œªsãr_Ëad”
(
m
);

1297 
	g_
 => {}

1301 
â
 
¡•_Ëad”
(&
mut
 
£lf
, muˆ
m
: 
Mes§ge
) {

1303 
m©ch
 
m
.
g‘_msg_ty³
() {

1304 
Mes§geTy³
::
MsgB—t
 => {

1305 
£lf
.
bÿ¡_h—¹b—t
();

1308 
	gMes§geTy³
::
MsgCheckQuÜum
 => {

1309 !
£lf
.
check_quÜum_aùive
() {

1310 
w¬n
!(

1312 
£lf
.
g


1314 
Ët
 
	g‹rm
 = 
£lf
.
‹rm
;

1315 
	g£lf
.
become_fŞlow”
(
‹rm
, 
INVALID_ID
);

1319 
	gMes§geTy³
::
MsgPrİo£
 => {

1320 
m
.
g‘_’Œ›s
().
is_em±y
() {

1321 
·nic
!("{} s‹µedƒm±y MsgPrİ", 
£lf
.
g
);

1323 !
	g£lf
.
	g´s
.
cÚšs_key
(&
£lf
.
id
) {

1329 
	g£lf
.
	gËad_Œªsã»e
.
is_some
() {

1330 
	gdebug
!(

1333 
	g£lf
.
	gg
,

1334 
	g£lf
.
	g‹rm
,

1335 
	g£lf
.
	gËad_Œªsã»e
.
unw¿p
()

1340 
e
 
š
 
	gm
.
mut_’Œ›s
().
™”_mut
() {

1341 
	ge
.
g‘_’Œy_ty³
(è=ğ
EÁryTy³
::
EÁryCÚfChªge
 {

1342 
£lf
.
³ndšg_cÚf
 {

1343 
šfo
!(

1346 
e


1348 *
	ge
 = 
EÁry
::
Ãw
();

1349 
	ge
.
£t_’Œy_ty³
(
EÁryTy³
::
EÁryNÜm®
);

1351 
	g£lf
.
	g³ndšg_cÚf
 = 
Œue
;

1354 
	g£lf
.
­³nd_’Œy
(&
mut
 
m
.
mut_’Œ›s
());

1355 
	g£lf
.
bÿ¡_­³nd
();

1358 
	gMes§geTy³
::
MsgR—dIndex
 => {

1359 
£lf
.
¿á_log
.
‹rm
(£lf.¿á_log.
comm™‹d
).
unw¿p_Ü
(0) != self.term {

1365 
	g£lf
.
quÜum
() > 1 {

1370 
m©ch
 
	g£lf
.
	g»ad_Úly
.
	gİtiÚ
 {

1371 
	gR—dOÆyO±iÚ
::
Saã
 => {

1372 
Ët
 
ùx
 = 
m
.
g‘_’Œ›s
()[0].
g‘_d©a
().
to_vec
();

1373 
	g£lf
.
	g»ad_Úly
.
add_»que¡
(
£lf
.
¿á_log
.
comm™‹d
, 
m
);

1374 
	g£lf
.
bÿ¡_h—¹b—t_w™h_ùx
(
Some
(
ùx
));

1376 
	gR—dOÆyO±iÚ
::
L—£Ba£d
 => {

1377 
Ët
 
mut
 
»ad_šdex
 = 
INVALID_INDEX
;

1378 
	g£lf
.
	gcheck_quÜum
 {

1379 
	g»ad_šdex
 = 
£lf
.
¿á_log
.
comm™‹d


1381 
	gm
.
g‘_äom
(è=ğ
INVALID_ID
 || 
m
.g‘_äom(è=ğ
£lf
.
id
 {

1383 
Ët
 
rs
 = 
R—dS‹
 {

1384 
šdex
: 
£lf
.
¿á_log
.
comm™‹d
,

1385 
»que¡_ùx
: 
m
.
ke_’Œ›s
()[0].
ke_d©a
(),

1387 
	g£lf
.
	g»ad_¡©es
.
push
(
rs
);

1389 
Ët
 
mut
 
	gto_£nd
 = 
Mes§ge
::
Ãw
();

1390 
	gto_£nd
.
£t_to
(
m
.
g‘_äom
());

1391 
	gto_£nd
.
£t_msg_ty³
(
Mes§geTy³
::
MsgR—dIndexRe¥
);

1392 
	gto_£nd
.
£t_šdex
(
»ad_šdex
);

1393 
	gto_£nd
.
£t_’Œ›s
(
m
.
ke_’Œ›s
());

1394 
	g£lf
.
£nd
(
to_£nd
);

1399 
Ët
 
	grs
 = 
R—dS‹
 {

1400 
šdex
: 
£lf
.
¿á_log
.
comm™‹d
,

1401 
»que¡_ùx
: 
m
.
ke_’Œ›s
()[0].
ke_d©a
(),

1403 
	g£lf
.
	g»ad_¡©es
.
push
(
rs
);

1407 
	g_
 => {}

1410 
Ët
 
mut
 
	g£nd_­³nd
 = 
çl£
;

1411 
Ët
 
mut
 
	gmaybe_comm™
 = 
çl£
;

1412 
Ët
 
mut
 
	gŞd_·u£d
 = 
çl£
;

1413 
Ët
 
mut
 
	gmÜe_to_£nd
 = 
NÚe
;

1414 
	g£lf
.
check_mes§ge_w™h_´og»ss
(

1415 &
mut
 
m
,

1416 &
mut
 
£nd_­³nd
,

1417 &
mut
 
Şd_·u£d
,

1418 &
mut
 
maybe_comm™
,

1419 &
mut
 
mÜe_to_£nd
,

1421 
	gmaybe_comm™
 {

1422 
	g£lf
.
maybe_comm™
() {

1423 
	g£lf
.
should_bÿ¡_comm™
() {

1424 
	g£lf
.
bÿ¡_­³nd
();

1426 } 
	gŞd_·u£d
 {

1429 
	g£nd_­³nd
 = 
Œue
;

1433 
	g£nd_­³nd
 {

1434 
	g£lf
.
£nd_­³nd
(
m
.
g‘_äom
());

1436 
Ët
 
Some
(
to_£nd
èğ
mÜe_to_£nd
 {

1437 
£lf
.
£nd
(
to_£nd
)

1443 
â
 
¡•_ÿndid©e
(&
mut
 
£lf
, 
m
: 
Mes§ge
) {

1444 
Ët
 
‹rm
 = 
£lf
.term;

1445 
m©ch
 
	gm
.
g‘_msg_ty³
() {

1446 
	gMes§geTy³
::
MsgPrİo£
 => {

1447 
šfo
!("{}‚ØËad”‡ˆ‹rm {}; drİpšg…rİo§l", 
£lf
.
g
, 
‹rm
);

1450 
	gMes§geTy³
::
MsgAµ’d
 => {

1451 
£lf
.
become_fŞlow”
(
‹rm
, 
m
.
g‘_äom
());

1452 
	g£lf
.
hªdË_­³nd_’Œ›s
(
m
);

1454 
	gMes§geTy³
::
MsgH—¹b—t
 => {

1455 
£lf
.
become_fŞlow”
(
‹rm
, 
m
.
g‘_äom
());

1456 
	g£lf
.
hªdË_h—¹b—t
(
m
);

1458 
	gMes§geTy³
::
MsgSÇpshÙ
 => {

1459 
£lf
.
become_fŞlow”
(
‹rm
, 
m
.
g‘_äom
());

1460 
	g£lf
.
hªdË_¢­shÙ
(
m
);

1462 
	gMes§geTy³
::
MsgReque¡P»VÙeRe¥Ú£
 | 
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£
 => {

1466 ià(
£lf
.
¡©e
 =ğ
S‹RŞe
::
P»Cªdid©e
 &&

1467 
m
.
g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgReque¡P»VÙeRe¥Ú£
) ||

1468 (
£lf
.
¡©e
 =ğ
S‹RŞe
::
Cªdid©e
 &&

1469 
m
.
g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£
)

1474 
Ët
 
	ggr
 = 
£lf
.
pŞl
(
m
.
g‘_äom
(), m.
g‘_msg_ty³
(), !m.
g‘_»jeù
());

1475 
	gšfo
!(

1477 
	g£lf
.
	gg
,

1478 
	g£lf
.
quÜum
(),

1479 
	ggr
,

1480 
	gm
.
g‘_msg_ty³
(),

1481 
	g£lf
.
	gvÙes
.
Ën
(è- 
	ggr


1483 
	g£lf
.
quÜum
(è=ğ
gr
 {

1484 
£lf
.
¡©e
 =ğ
S‹RŞe
::
P»Cªdid©e
 {

1485 
£lf
.
ÿm·ign
(
CAMPAIGN_ELECTION
);

1487 
	g£lf
.
become_Ëad”
();

1488 
	g£lf
.
bÿ¡_­³nd
();

1490 } 
	g£lf
.
quÜum
(è=ğ
£lf
.
vÙes
.
Ën
(è- 
gr
 {

1491 
£lf
.
become_fŞlow”
(
‹rm
, 
INVALID_ID
);

1494 
	gMes§geTy³
::
MsgTimeoutNow
 => 
debug
!(

1496 
	g£lf
.
	gg
,

1497 
	g£lf
.
	g‹rm
,

1498 
	g£lf
.
	g¡©e
,

1499 
	gm
.
g‘_äom
()

1501 
	g_
 => {}

1505 
â
 
¡•_fŞlow”
(&
mut
 
£lf
, muˆ
m
: 
Mes§ge
) {

1506 
m©ch
 
m
.
g‘_msg_ty³
() {

1507 
Mes§geTy³
::
MsgPrİo£
 => {

1508 
£lf
.
Ëad”_id
 =ğ
INVALID_ID
 {

1509 
šfo
!(

1511 
£lf
.
g
,

1512 
£lf
.
‹rm


1516 
	gm
.
£t_to
(
£lf
.
Ëad”_id
);

1517 
	g£lf
.
£nd
(
m
);

1519 
	gMes§geTy³
::
MsgAµ’d
 => {

1520 
£lf
.
–eùiÚ_–­£d
 = 0;

1521 
	g£lf
.
	gËad”_id
 = 
m
.
g‘_äom
();

1522 
	g£lf
.
hªdË_­³nd_’Œ›s
(
m
);

1524 
	gMes§geTy³
::
MsgH—¹b—t
 => {

1525 
£lf
.
–eùiÚ_–­£d
 = 0;

1526 
	g£lf
.
	gËad”_id
 = 
m
.
g‘_äom
();

1527 
	g£lf
.
hªdË_h—¹b—t
(
m
);

1529 
	gMes§geTy³
::
MsgSÇpshÙ
 => {

1530 
£lf
.
–eùiÚ_–­£d
 = 0;

1531 
	g£lf
.
	gËad”_id
 = 
m
.
g‘_äom
();

1532 
	g£lf
.
hªdË_¢­shÙ
(
m
);

1534 
	gMes§geTy³
::
MsgT¿nsãrL—d”
 => {

1535 
£lf
.
Ëad”_id
 =ğ
INVALID_ID
 {

1536 
šfo
!(

1538 
£lf
.
g
,

1539 
£lf
.
‹rm


1543 
	gm
.
£t_to
(
£lf
.
Ëad”_id
);

1544 
	g£lf
.
£nd
(
m
);

1546 
	gMes§geTy³
::
MsgTimeoutNow
 => {

1547 
£lf
.
´omÙabË
() {

1548 
šfo
!(

1551 
£lf
.
g
,

1552 
£lf
.
‹rm
,

1553 
m
.
g‘_äom
()

1558 
	g£lf
.
ÿm·ign
(
CAMPAIGN_TRANSFER
);

1560 
	gšfo
!(

1562 
	g£lf
.
	gg
,

1563 
	gm
.
g‘_äom
()

1567 
	gMes§geTy³
::
MsgR—dIndex
 => {

1568 
£lf
.
Ëad”_id
 =ğ
INVALID_ID
 {

1569 
šfo
!(

1571 
£lf
.
g
,

1572 
£lf
.
‹rm


1576 
	gm
.
£t_to
(
£lf
.
Ëad”_id
);

1577 
	g£lf
.
£nd
(
m
);

1579 
	gMes§geTy³
::
MsgR—dIndexRe¥
 => {

1580 
m
.
g‘_’Œ›s
().
Ën
() != 1 {

1581 
”rÜ
!(

1583 
£lf
.
g
,

1584 
m
.
g‘_äom
(),

1585 
m
.
g‘_’Œ›s
().
Ën
()

1589 
Ët
 
	grs
 = 
R—dS‹
 {

1590 
šdex
: 
m
.
g‘_šdex
(),

1591 
»que¡_ùx
: 
m
.
ke_’Œ›s
()[0].
ke_d©a
(),

1593 
	g£lf
.
	g»ad_¡©es
.
push
(
rs
);

1595 
	g_
 => {}

1600 
pub
 
â
 
hªdË_­³nd_’Œ›s
(&
mut
 
£lf
, 
m
: 
Mes§ge
) {

1601 
m
.
g‘_šdex
(è< 
£lf
.
¿á_log
.
comm™‹d
 {

1602 
Ët
 
mut
 
to_£nd
 = 
Mes§ge
::
Ãw
();

1603 
	gto_£nd
.
£t_to
(
m
.
g‘_äom
());

1604 
	gto_£nd
.
£t_msg_ty³
(
Mes§geTy³
::
MsgAµ’dRe¥Ú£
);

1605 
	gto_£nd
.
£t_šdex
(
£lf
.
¿á_log
.
comm™‹d
);

1606 
	g£lf
.
£nd
(
to_£nd
);

1609 
Ët
 
mut
 
	gto_£nd
 = 
Mes§ge
::
Ãw
();

1610 
	gto_£nd
.
£t_to
(
m
.
g‘_äom
());

1611 
	gto_£nd
.
£t_msg_ty³
(
Mes§geTy³
::
MsgAµ’dRe¥Ú£
);

1612 
m©ch
 
	g£lf
.
	g¿á_log
.
maybe_­³nd
(

1613 
m
.
g‘_šdex
(),

1614 
m
.
g‘_log_‹rm
(),

1615 
m
.
g‘_comm™
(),

1616 
m
.
g‘_’Œ›s
(),

1618 
Some
(
mÏ¡_šdex
) => {

1619 
to_£nd
.
£t_šdex
(
mÏ¡_šdex
);

1620 
	g£lf
.
£nd
(
to_£nd
);

1622 
	gNÚe
 => {

1623 
debug
!(

1626 
£lf
.
g
,

1627 
£lf
.
¿á_log
.
‹rm
(
m
.
g‘_šdex
()).
unw¿p_Ü
(0),

1628 
m
.
g‘_šdex
(),

1629 
m
.
g‘_log_‹rm
(),

1630 
m
.
g‘_šdex
(),

1631 
m
.
g‘_äom
()

1633 
	gto_£nd
.
£t_šdex
(
m
.
g‘_šdex
());

1634 
	gto_£nd
.
£t_»jeù
(
Œue
);

1635 
	gto_£nd
.
£t_»jeù_hšt
(
£lf
.
¿á_log
.
Ï¡_šdex
());

1636 
	g£lf
.
£nd
(
to_£nd
);

1642 
pub
 
â
 
hªdË_h—¹b—t
(&
mut
 
£lf
, muˆ
m
: 
Mes§ge
) {

1643 
£lf
.
¿á_log
.
comm™_to
(
m
.
g‘_comm™
());

1644 
Ët
 
mut
 
	gto_£nd
 = 
Mes§ge
::
Ãw
();

1645 
	gto_£nd
.
£t_to
(
m
.
g‘_äom
());

1646 
	gto_£nd
.
£t_msg_ty³
(
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
);

1647 
	gto_£nd
.
£t_cÚ‹xt
(
m
.
ke_cÚ‹xt
());

1648 
	g£lf
.
£nd
(
to_£nd
);

1651 
â
 
hªdË_¢­shÙ
(&
mut
 
£lf
, muˆ
m
: 
Mes§ge
) {

1652 
Ët
 (
sšdex
, 
¡”m
) = (

1653 
m
.
g‘_¢­shÙ
().
g‘_m‘ad©a
().
g‘_šdex
(),

1654 
	gm
.
g‘_¢­shÙ
().
g‘_m‘ad©a
().
g‘_‹rm
(),

1656 
	g£lf
.
»¡Üe
(
m
.
ke_¢­shÙ
()) {

1657 
	gšfo
!(

1659 
	g£lf
.
	gg
,

1660 
	g£lf
.
	g¿á_log
.
	gcomm™‹d
,

1661 
	gsšdex
,

1662 
	g¡”m


1664 
Ët
 
mut
 
	gto_£nd
 = 
Mes§ge
::
Ãw
();

1665 
	gto_£nd
.
£t_to
(
m
.
g‘_äom
());

1666 
	gto_£nd
.
£t_msg_ty³
(
Mes§geTy³
::
MsgAµ’dRe¥Ú£
);

1667 
	gto_£nd
.
£t_šdex
(
£lf
.
¿á_log
.
Ï¡_šdex
());

1668 
	g£lf
.
£nd
(
to_£nd
);

1670 
	gšfo
!(

1672 
	g£lf
.
	gg
,

1673 
	g£lf
.
	g¿á_log
.
	gcomm™‹d
,

1674 
	gsšdex
,

1675 
	g¡”m


1677 
Ët
 
mut
 
	gto_£nd
 = 
Mes§ge
::
Ãw
();

1678 
	gto_£nd
.
£t_to
(
m
.
g‘_äom
());

1679 
	gto_£nd
.
£t_msg_ty³
(
Mes§geTy³
::
MsgAµ’dRe¥Ú£
);

1680 
	gto_£nd
.
£t_šdex
(
£lf
.
¿á_log
.
comm™‹d
);

1681 
	g£lf
.
£nd
(
to_£nd
);

1685 
â
 
»¡Üe_¿á
(&
mut
 
£lf
, 
¢­
: &
SÇpshÙ
è-> 
O±iÚ
<
boŞ
> {

1686 
Ët
 
m‘a
 = 
¢­
.
g‘_m‘ad©a
();

1687 
	g£lf
.
	g¿á_log
.
m©ch_‹rm
(
m‘a
.
g‘_šdex
(), m‘a.
g‘_‹rm
()) {

1688 
	gšfo
!(

1691 
	g£lf
.
	gg
,

1692 
	g£lf
.
	g¿á_log
.
	gcomm™‹d
,

1693 
	g£lf
.
	g¿á_log
.
Ï¡_šdex
(),

1694 
	g£lf
.
	g¿á_log
.
Ï¡_‹rm
(),

1695 
	gm‘a
.
g‘_šdex
(),

1696 
	gm‘a
.
g‘_‹rm
()

1698 
	g£lf
.
	g¿á_log
.
comm™_to
(
m‘a
.
g‘_šdex
());

1699  
Some
(
çl£
);

1702 
	gšfo
!(

1705 
	g£lf
.
	gg
,

1706 
	g£lf
.
	g¿á_log
.
	gcomm™‹d
,

1707 
	g£lf
.
	g¿á_log
.
Ï¡_šdex
(),

1708 
	g£lf
.
	g¿á_log
.
Ï¡_‹rm
(),

1709 
	gm‘a
.
g‘_šdex
(),

1710 
	gm‘a
.
g‘_‹rm
()

1712 
	g£lf
.
	g´s
 = 
FÏtM­
::
w™h_ÿ·c™y
(
m‘a
.
g‘_cÚf_¡©e
().
g‘_nodes
().
Ën
());

1713 &
n
 
š
 
	gm‘a
.
g‘_cÚf_¡©e
().
g‘_nodes
() {

1714 
Ët
 
	gÃxt_idx
 = 
£lf
.
¿á_log
.
Ï¡_šdex
() + 1;

1715 
Ët
 
	gm©ched
 = 
n
 =ğ
£lf
.
id
 { 
Ãxt_idx
 - 1 } { 0 };

1716 
	g£lf
.
£t_´og»ss
(
n
, 
m©ched
, 
Ãxt_idx
);

1717 
	gšfo
!(

1719 
	g£lf
.
	gg
,

1720 
	gn
,

1721 
	g£lf
.
	g´s
[&
n
]

1724 
	gNÚe


1729 
pub
 
â
 
»¡Üe
(&
mut
 
£lf
, 
¢­
: 
SÇpshÙ
è-> 
boŞ
 {

1730 
¢­
.
g‘_m‘ad©a
().
g‘_šdex
(è< 
£lf
.
¿á_log
.
comm™‹d
 {

1731  
çl£
;

1733 
Ët
 
Some
(
b
èğ
£lf
.
»¡Üe_¿á
(&
¢­
) {

1734  
b
;

1736 
	g£lf
.
	g¿á_log
.
»¡Üe
(
¢­
);

1737 
	gŒue


1740 
pub
 
â
 
should_bÿ¡_comm™
(&
£lf
è-> 
	gboŞ
 {

1741 !
	g£lf
.
	gsk_bÿ¡_comm™
 || s–f.
	g³ndšg_cÚf


1746 
pub
 
â
 
´omÙabË
(&
£lf
è-> 
	gboŞ
 {

1747 
	g£lf
.
	g´s
.
cÚšs_key
(&
£lf
.
id
)

1750 
pub
 
â
 
add_node
(&
mut
 
£lf
, 
id
: 
u64
) {

1751 
£lf
.
³ndšg_cÚf
 = 
çl£
;

1752 
	g£lf
.
	g´s
.
cÚšs_key
(&
id
) {

1757 
Ët
 
	gÏ¡_šdex
 = 
£lf
.
¿á_log
.
Ï¡_šdex
();

1758 
	g£lf
.
£t_´og»ss
(
id
, 0, 
Ï¡_šdex
 + 1);

1761 
pub
 
â
 
»move_node
(&
mut
 
£lf
, 
id
: 
u64
) {

1762 
£lf
.
d–_´og»ss
(
id
);

1763 
	g£lf
.
	g³ndšg_cÚf
 = 
çl£
;

1766 
	g£lf
.
	g´s
.
is_em±y
() {

1772 
	g£lf
.
maybe_comm™
() {

1773 
	g£lf
.
bÿ¡_­³nd
();

1776 
	g£lf
.
	g¡©e
 =ğ
S‹RŞe
::
L—d”
 && 
£lf
.
Ëad_Œªsã»e
 =ğ
Some
(
id
) {

1777 
£lf
.
abÜt_Ëad”_Œªsãr
()

1781 
pub
 
â
 
»£t_³ndšg_cÚf
(&
mut
 
£lf
) {

1782 
£lf
.
³ndšg_cÚf
 = 
çl£
;

1785 
pub
 
â
 
£t_´og»ss
(&
mut
 
£lf
, 
id
: 
u64
, 
m©ched
: u64, 
Ãxt_idx
: u64) {

1786 
Ët
 
mut
 
p
 = 
Ãw_´og»ss
(
Ãxt_idx
, 
£lf
.
max_šæight
);

1787 
	gp
.
	gm©ched
 = 
m©ched
;

1788 
	g£lf
.
	g´s
.
š£¹
(
id
, 
p
);

1791 
â
 
d–_´og»ss
(&
mut
 
£lf
, 
id
: 
u64
) {

1792 
£lf
.
´s
.
»move
(&
id
);

1796 
pub
 
â
 
lßd_¡©e
(&
mut
 
£lf
, 
hs
: 
H¬dS‹
) {

1797 
hs
.
g‘_comm™
(è< 
£lf
.
¿á_log
.
comm™‹d
 ||

1798 
hs
.
g‘_comm™
(è> 
£lf
.
¿á_log
.
Ï¡_šdex
()

1800 
·nic
!(

1802 
	g£lf
.
	gg
,

1803 
	ghs
.
g‘_comm™
(),

1804 
	g£lf
.
	g¿á_log
.
	gcomm™‹d
,

1805 
	g£lf
.
	g¿á_log
.
Ï¡_šdex
()

1808 
	g£lf
.
	g¿á_log
.
	gcomm™‹d
 = 
hs
.
g‘_comm™
();

1809 
	g£lf
.
	g‹rm
 = 
hs
.
g‘_‹rm
();

1810 
	g£lf
.
	gvÙe
 = 
hs
.
g‘_vÙe
();

1816 
pub
 
â
 
·ss_–eùiÚ_timeout
(&
£lf
è-> 
	gboŞ
 {

1817 
	g£lf
.
	g–eùiÚ_–­£d
 >ğ
£lf
.
¿ndomized_–eùiÚ_timeout


1820 
pub
 
â
 
»£t_¿ndomized_–eùiÚ_timeout
(&
mut
 
£lf
) {

1821 
Ët
 
	g´ev_timeout
 = 
£lf
.
¿ndomized_–eùiÚ_timeout
;

1822 
Ët
 
	gtimeout
 =

1823 
£lf
.
–eùiÚ_timeout
 + 
¿nd
::
th»ad_ºg
().
g’_¿nge
(0, self.election_timeout);

1824 
	gdebug
!(

1826 
	g£lf
.
	gg
,

1827 
	g´ev_timeout
,

1828 
	gtimeout
,

1829 
	g£lf
.
	g–eùiÚ_–­£d


1831 
	g£lf
.
	g¿ndomized_–eùiÚ_timeout
 = 
timeout
;

1838 
â
 
check_quÜum_aùive
(&
mut
 
£lf
è-> 
	gboŞ
 {

1839 
Ët
 
mut
 
	gaù
 = 0;

1840 
Ët
 
	g£lf_id
 = 
£lf
.
id
;

1841 
	gid
, 
	gp
è
	gš
 &
mut
 
	g£lf
.
	g´s
 {

1842 
	gid
 =ğ&
£lf_id
 {

1844 
aù
 += 1;

1848 
	gp
.
	g»ûÁ_aùive
 {

1849 
	gaù
 += 1;

1852 
	gp
.
	g»ûÁ_aùive
 = 
çl£
;

1854 
	gaù
 >ğ
£lf
.
quÜum
()

1857 
pub
 
â
 
£nd_timeout_now
(&
mut
 
£lf
, 
to
: 
u64
) {

1858 
Ët
 
msg
 = 
Ãw_mes§ge
(
to
, 
Mes§geTy³
::
MsgTimeoutNow
, 
NÚe
);

1859 
	g£lf
.
£nd
(
msg
);

1862 
pub
 
â
 
abÜt_Ëad”_Œªsãr
(&
mut
 
£lf
) {

1863 
	g£lf
.
	gËad_Œªsã»e
 = 
NÚe
;

	@src/raft/raft_log.rs

29 
u£
 
	g¿á
::
¡Üage
::
StÜage
;

30 
u£
 
	g¿á
::
log_un¡abË
::
Un¡abË
;

31 
u£
 
	gkv´Ùo
::
”aápb
::{
EÁry
, 
	gSÇpshÙ
};

32 
u£
 
	g¿á
::
”rÜs
::{
E¼Ü
, 
	gResuÉ
, 
	gStÜageE¼Ü
};

33 
u£
 
	g¡d
::
cmp
;

34 
u£
 
	gut
;

36 
pub
 
u£
 
	gut
::
NO_LIMIT
;

39 #[
d”ive
(
DeçuÉ
)]

40 
pub
 
	gRaáLog
<
	gT
: 
StÜage
> {

42 
pub
 
¡Üe
: 
T
,

46 
pub
 
	gun¡abË
: 
Un¡abË
,

50 
pub
 
	gcomm™‹d
: 
u64
,

55 
pub
 
	g­¶›d
: 
u64
,

57 
pub
 
	gg
: 
SŒšg
,

60 
	gim¶
<
	gT
> 
ToSŒšg
 
	gRaáLog
<T>

61 
wh”e


62 
	gT
: 
StÜage
,

64 
â
 
to_¡ršg
(&
£lf
è-> 
	gSŒšg
 {

65 
	gfÜm©
!(

67 
	g£lf
.
	gcomm™‹d
,

68 
	g£lf
.
	g­¶›d
,

69 
	g£lf
.
	gun¡abË
.
	goff£t
,

70 
	g£lf
.
	gun¡abË
.
	g’Œ›s
.
Ën
()

75 
	gim¶
<
	gT
: 
StÜage
> 
RaáLog
<
T
> {

76 
pub
 
â
 
Ãw
(
¡Üage
: 
T
, 
g
: 
SŒšg
è-> 
RaáLog
<T> {

77 
Ët
 
fœ¡_šdex
 = 
¡Üage
.fœ¡_šdex().
unw¿p
();

78 
Ët
 
	gÏ¡_šdex
 = 
¡Üage
.
Ï¡_šdex
().
unw¿p
();

81 
	gRaáLog
 {

82 
	g¡Üe
: 
¡Üage
,

83 
	gcomm™‹d
: 
fœ¡_šdex
 - 1,

84 
	g­¶›d
: 
fœ¡_šdex
 - 1,

85 
	gun¡abË
: 
Un¡abË
::
Ãw
(
Ï¡_šdex
 + 1, 
g
.
şÚe
()),

86 
	gg
: 
g
,

90 
pub
 
â
 
Ï¡_‹rm
(&
£lf
è-> 
	gu64
 {

91 
m©ch
 
	g£lf
.
‹rm
(
£lf
.
Ï¡_šdex
()) {

92 
Ok
(
t
) =>,

93 
E¼
(
e
è=> 
·nic
!(

95 
	g£lf
.
	gg
,

96 
	ge


101 #[
šlše
]

102 
pub
 
â
 
g‘_¡Üe
(&
£lf
è-> &
	gT
 {

103 &
	g£lf
.
	g¡Üe


106 #[
šlše
]

107 
pub
 
â
 
mut_¡Üe
(&
mut
 
£lf
è-> &muˆ
	gT
 {

108 &
mut
 
	g£lf
.
	g¡Üe


111 
pub
 
â
 
‹rm
(&
£lf
, 
idx
: 
u64
è-> 
ResuÉ
<u64> {

113 
Ët
 
dummy_idx
 = 
£lf
.
fœ¡_šdex
() - 1;

114 
	gidx
 < 
	gdummy_idx
 || idx > 
	g£lf
.
Ï¡_šdex
() {

115  
Ok
(0u64);

118 
m©ch
 
	g£lf
.
	gun¡abË
.
maybe_‹rm
(
idx
) {

119 
Some
(
‹rm
è=> 
Ok
(term),

120 
	g_
 => 
£lf
.
¡Üe
.
‹rm
(
idx
).
m­_”r
(|
e
| {

121 
m©ch
 
e
 {

122 
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
) |

123 
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
UÇvaabË
) => {}

124 
_
 => 
·nic
!("{} uÃx³ùedƒ¼Ü: {:?}", 
£lf
.
g
, 
e
),

126 
e


131 
pub
 
â
 
fœ¡_šdex
(&
£lf
è-> 
	gu64
 {

132 
m©ch
 
	g£lf
.
	gun¡abË
.
maybe_fœ¡_šdex
() {

133 
Some
(
idx
) => idx,

134 
	gNÚe
 => 
£lf
.
¡Üe
.
fœ¡_šdex
().
unw¿p
(),

138 
pub
 
â
 
Ï¡_šdex
(&
£lf
è-> 
	gu64
 {

139 
m©ch
 
	g£lf
.
	gun¡abË
.
maybe_Ï¡_šdex
() {

140 
Some
(
idx
) => idx,

141 
	gNÚe
 => 
£lf
.
¡Üe
.
Ï¡_šdex
().
unw¿p
(),

157 
pub
 
â
 
fšd_cÚæiù
(&
£lf
, 
’ts
: &[
EÁry
]è-> 
u64
 {

158 
e
 
š
 
’ts
 {

159 !
£lf
.
m©ch_‹rm
(
e
.
g‘_šdex
(),ƒ.
g‘_‹rm
()) {

160 
	ge
.
g‘_šdex
(è<ğ
£lf
.
Ï¡_šdex
() {

161 
šfo
!(

163 
£lf
.
g
,

164 
e
.
g‘_šdex
(),

165 
£lf
.
‹rm
(
e
.
g‘_šdex
()).
unw¿p_Ü
(0),

166 
e
.
g‘_‹rm
()

169  
	ge
.
g‘_šdex
();

175 
pub
 
â
 
m©ch_‹rm
(&
£lf
, 
idx
: 
u64
, 
‹rm
: u64è-> 
boŞ
 {

176 
£lf
.
‹rm
(
idx
).
m­
(|
t
| =ğ‹rm).
unw¿p_Ü
(
çl£
)

181 
pub
 
â
 
maybe_­³nd
(

182 &
mut
 
£lf
,

183 
idx
: 
u64
,

184 
‹rm
: 
u64
,

185 
comm™‹d
: 
u64
,

186 
’ts
: &[
EÁry
],

187 è-> 
	gO±iÚ
<
	gu64
> {

188 
Ët
 
	gÏ¡_Ãw_šdex
 = 
idx
 + 
’ts
.
Ën
(è
as
 
u64
;

189 
	g£lf
.
m©ch_‹rm
(
idx
, 
‹rm
) {

190 
Ët
 
	gcÚæiù_idx
 = 
£lf
.
fšd_cÚæiù
(
’ts
);

191 
	gcÚæiù_idx
 == 0 {

192 } 
cÚæiù_idx
 <ğ
£lf
.
comm™‹d
 {

193 
·nic
!(

195 
£lf
.
g
,

196 
cÚæiù_idx
,

197 
£lf
.
comm™‹d


200 
Ët
 
off£t
 = 
idx
 + 1;

201 
	g£lf
.
­³nd
(&
’ts
[(
cÚæiù_idx
 - 
off£t
è
as
 
usize
..]);

203 
	g£lf
.
comm™_to
(
cmp
::
mš
(
comm™‹d
, 
Ï¡_Ãw_šdex
));

204  
Some
(
Ï¡_Ãw_šdex
);

206 
	gNÚe


209 
pub
 
â
 
comm™_to
(&
mut
 
£lf
, 
to_comm™
: 
u64
) {

211 
£lf
.
comm™‹d
 >ğ
to_comm™
 {

214 
	g£lf
.
Ï¡_šdex
(è< 
	gto_comm™
 {

215 
	g·nic
!(

217 
	g£lf
.
	gg
,

218 
	gto_comm™
,

219 
	g£lf
.
Ï¡_šdex
()

222 
	g£lf
.
	gcomm™‹d
 = 
to_comm™
;

225 
pub
 
â
 
­¶›d_to
(&
mut
 
£lf
, 
idx
: 
u64
) {

226 
idx
 == 0 {

229 
	g£lf
.
	gcomm™‹d
 < 
	gidx
 || idx < s–f.
	g­¶›d
 {

230 
	g·nic
!(

232 
	g£lf
.
	gg
,

233 
	gidx
,

234 
	g£lf
.
	g­¶›d
,

235 
	g£lf
.
	gcomm™‹d


238 
	g£lf
.
	g­¶›d
 = 
idx
;

241 
pub
 
â
 
g‘_­¶›d
(&
£lf
è-> 
	gu64
 {

242 
	g£lf
.
	g­¶›d


245 
pub
 
â
 
¡abË_to
(&
mut
 
£lf
, 
idx
: 
u64
, 
‹rm
: u64) {

246 
£lf
.
un¡abË
.
¡abË_to
(
idx
, 
‹rm
)

249 
pub
 
â
 
¡abË_¢­_to
(&
mut
 
£lf
, 
idx
: 
u64
) {

250 
£lf
.
un¡abË
.
¡abË_¢­_to
(
idx
)

253 
pub
 
â
 
g‘_un¡abË
(&
£lf
è-> &
Un¡abË
 {

254 &
£lf
.
un¡abË


257 
pub
 
â
 
­³nd
(&
mut
 
£lf
, 
’ts
: &[
EÁry
]è-> 
u64
 {

258 
’ts
.
is_em±y
() {

259  
£lf
.
Ï¡_šdex
();

262 
Ët
 
	gaá”
 = 
’ts
[0].
g‘_šdex
() - 1;

263 
	gaá”
 < 
	g£lf
.
	gcomm™‹d
 {

264 
	g·nic
!(

266 
	g£lf
.
	gg
,

267 
	gaá”
,

268 
	g£lf
.
	gcomm™‹d


271 
	g£lf
.
	gun¡abË
.
Œunÿ‹_ªd_­³nd
(
’ts
);

272 
	g£lf
.
Ï¡_šdex
()

275 
pub
 
â
 
un¡abË_’Œ›s
(&
£lf
è-> 
	gO±iÚ
<&[
EÁry
]> {

276 
	g£lf
.
	gun¡abË
.
	g’Œ›s
.
is_em±y
() {

277  
	gNÚe
;

279 
Some
(&
£lf
.
un¡abË
.
’Œ›s
)

282 
pub
 
â
 
’Œ›s
(&
£lf
, 
idx
: 
u64
, 
max_size
: u64è-> 
ResuÉ
<
Vec
<
EÁry
>> {

283 
Ët
 
Ï¡
 = 
£lf
.
Ï¡_šdex
();

284 
	gidx
 > 
	gÏ¡
 {

285  
Ok
(
Vec
::
Ãw
());

287 
	g£lf
.
¦iû
(
idx
, 
Ï¡
 + 1, 
max_size
)

290 
pub
 
â
 
®l_’Œ›s
(&
£lf
è-> 
	gVec
<
	gEÁry
> {

291 
Ët
 
	gfœ¡_šdex
 = 
£lf
.
fœ¡_šdex
();

292 
m©ch
 
	g£lf
.
’Œ›s
(
fœ¡_šdex
, 
NO_LIMIT
) {

293 
E¼
(
e
) => {

295 
e
 =ğ
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
) {

296  
£lf
.
®l_’Œ›s
();

298 
	g·nic
!("{} uÃx³ùedƒ¼Ü: {:?}", 
	g£lf
.
	gg
, 
	ge
);

300 
Ok
(
’ts
) =>ƒnts,

310 
pub
 
â
 
is_up_to_d©e
(&
£lf
, 
Ï¡_šdex
: 
u64
, 
‹rm
: u64è-> 
boŞ
 {

311 
‹rm
 > 
£lf
.
Ï¡_‹rm
(è|| (‹rm =ğ£lf.Ï¡_‹rm(è&& 
Ï¡_šdex
 >= self.last_index())

314 
pub
 
â
 
Ãxt_’Œ›s_sšû
(&
£lf
, 
sšû_idx
: 
u64
è-> 
O±iÚ
<
Vec
<
EÁry
>> {

315 
Ët
 
off£t
 = 
cmp
::
max
(
sšû_idx
 + 1, 
£lf
.
fœ¡_šdex
());

316 
Ët
 
	gcomm™‹d
 = 
£lf
.
comm™‹d
;

317 
	gcomm™‹d
 + 1 > 
	goff£t
 {

318 
m©ch
 
	g£lf
.
¦iû
(
off£t
, 
comm™‹d
 + 1, 
NO_LIMIT
) {

319 
Ok
(
vec
è=>  
Some
(vec),

320 
E¼
(
e
è=> 
·nic
!("{} {}", 
	g£lf
.
	gg
, 
	ge
),

323 
	gNÚe


329 
pub
 
â
 
Ãxt_’Œ›s
(&
£lf
è-> 
	gO±iÚ
<
	gVec
<
	gEÁry
>> {

330 
	g£lf
.
Ãxt_’Œ›s_sšû
(
£lf
.
­¶›d
)

333 
pub
 
â
 
has_Ãxt_’Œ›s_sšû
(&
£lf
, 
sšû_idx
: 
u64
è-> 
boŞ
 {

334 
Ët
 
off£t
 = 
cmp
::
max
(
sšû_idx
 + 1, 
£lf
.
fœ¡_šdex
());

335 
	g£lf
.
	gcomm™‹d
 + 1 > 
	goff£t


338 
pub
 
â
 
has_Ãxt_’Œ›s
(&
£lf
è-> 
	gboŞ
 {

339 
	g£lf
.
has_Ãxt_’Œ›s_sšû
(
£lf
.
­¶›d
)

342 
pub
 
â
 
¢­shÙ
(&
£lf
è-> 
	gResuÉ
<
	gSÇpshÙ
> {

343 
	g£lf
.
	gun¡abË


344 .
	g¢­shÙ


345 .
şÚe
()

346 .
m­_Ü_–£
(|| 
£lf
.
¡Üe
.
¢­shÙ
(), 
Ok
)

349 
â
 
mu¡_check_outofbounds
(&
£lf
, 
low
: 
u64
, 
high
: u64è-> 
O±iÚ
<
E¼Ü
> {

350 
low
 > 
high
 {

351 
·nic
!("{} inv®id sliû {} > {}", 
	g£lf
.
	gg
, 
	glow
, 
	ghigh
)

353 
Ët
 
	gfœ¡_šdex
 = 
£lf
.
fœ¡_šdex
();

354 
	glow
 < 
	gfœ¡_šdex
 {

355  
Some
(
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
));

358 
Ët
 
	gËngth
 = 
£lf
.
Ï¡_šdex
(è+ 1 - 
fœ¡_šdex
;

359 
	glow
 < 
	gfœ¡_šdex
 || 
	ghigh
 > fœ¡_šdex + 
	gËngth
 {

360 
	g·nic
!(

362 
	g£lf
.
	gg
,

363 
	glow
,

364 
	ghigh
,

365 
	gfœ¡_šdex
,

366 
	g£lf
.
Ï¡_šdex
()

369 
	gNÚe


372 
pub
 
â
 
maybe_comm™
(&
mut
 
£lf
, 
max_šdex
: 
u64
, 
‹rm
: u64è-> 
boŞ
 {

373 
max_šdex
 > 
£lf
.
comm™‹d
 && s–f.
‹rm
(max_šdex).
unw¿p_Ü
(0) ==erm {

374 
£lf
.
comm™_to
(
max_šdex
);

375 
	gŒue


377 
	gçl£


381 
pub
 
â
 
¦iû
(&
£lf
, 
low
: 
u64
, 
high
: u64, 
max_size
: u64è-> 
ResuÉ
<
Vec
<
EÁry
>> {

382 
Ët
 
”r
 = 
£lf
.
mu¡_check_outofbounds
(
low
, 
high
);

383 
	g”r
.
is_some
() {

384  
E¼
(
”r
.
unw¿p
());

388 
Ët
 
mut
 
	g’ts
 = 
vec
![];

389 
	glow
 =ğ
high
 {

390  
Ok
(
’ts
);

393 
	glow
 < 
	g£lf
.
	gun¡abË
.
	goff£t
 {

394 
Ët
 
	g¡Üed_’Œ›s
 = 
£lf
.
¡Üe


395 .
’Œ›s
(
low
, 
cmp
::
mš
(
high
, 
£lf
.
un¡abË
.
off£t
), 
max_size
);

396 
	g¡Üed_’Œ›s
.
is_”r
() {

397 
Ët
 
	ge
 = 
¡Üed_’Œ›s
.
unw¿p_”r
();

398 
m©ch
 
	ge
 {

399 
	gE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
è=>  
E¼
(
e
),

400 
	gE¼Ü
::
StÜe
(
StÜageE¼Ü
::
UÇvaabË
è=> 
·nic
!(

402 
	g£lf
.
	gg
,

403 
	glow
,

404 
	gcmp
::
mš
(
high
, 
£lf
.
un¡abË
.
off£t
)

406 
	g_
 => 
·nic
!("{} uÃx³ùedƒ¼Ü: {:?}", 
	g£lf
.
	gg
, 
	ge
),

409 
	g’ts
 = 
¡Üed_’Œ›s
.
unw¿p
();

410 ià(
	g’ts
.
Ën
(è
as
 
	gu64
è< 
	gcmp
::
mš
(
high
, 
£lf
.
un¡abË
.
off£t
è- 
	glow
 {

411  
Ok
(
’ts
);

415 
	ghigh
 > 
	g£lf
.
	gun¡abË
.
	goff£t
 {

416 
Ët
 
	goff£t
 = 
£lf
.
un¡abË
.
off£t
;

417 
Ët
 
	gun¡abË
 = 
£lf
.
un¡abË
.
¦iû
(
cmp
::
max
(
low
, 
off£t
), 
high
);

418 
	g’ts
.
ex‹nd_äom_¦iû
(
un¡abË
);

420 
	gut
::
lim™_size
(&
mut
 
’ts
, 
max_size
);

421 
Ok
(
’ts
)

424 
pub
 
â
 
»¡Üe
(&
mut
 
£lf
, 
¢­shÙ
: 
SÇpshÙ
) {

425 
šfo
!(

427 
	g£lf
.
	gg
,

428 
	g£lf
.
to_¡ršg
(),

429 
	g¢­shÙ
.
g‘_m‘ad©a
().
g‘_šdex
(),

430 
	g¢­shÙ
.
g‘_m‘ad©a
().
g‘_‹rm
()

432 
	g£lf
.
	gcomm™‹d
 = 
¢­shÙ
.
g‘_m‘ad©a
().
g‘_šdex
();

433 
	g£lf
.
	gun¡abË
.
»¡Üe
(
¢­shÙ
);

438 #[
cfg
(
‹¡
)]

439 
mod
 
	g‹¡
 {

440 
u£
 
	g¿á
::
¿á_log
::{
£lf
, 
	gRaáLog
};

441 
u£
 
	g¿á
::
¡Üage
::
MemStÜage
;

442 
u£
 
	gkv´Ùo
::
”aápb
;

443 
u£
 
	g¿á
::
”rÜs
::{
E¼Ü
, 
	gStÜageE¼Ü
};

444 
u£
 
	g´Ùobuf
;

446 
â
 
Ãw_¿á_log
(
s
: 
MemStÜage
è-> 
RaáLog
<MemStorage> {

447 
RaáLog
::
Ãw
(
s
, 
SŒšg
::
äom
(""))

450 
â
 
Ãw_’Œy
(
šdex
: 
u64
, 
‹rm
: u64è-> 
”aápb
::
EÁry
 {

451 
Ët
 
mut
 
e
 = 
”aápb
::
EÁry
::
Ãw
();

452 
	ge
.
£t_‹rm
(
‹rm
);

453 
	ge
.
£t_šdex
(
šdex
);

454 
	ge


457 
â
 
Ãw_¢­shÙ
(
m‘a_šdex
: 
u64
, 
m‘a_‹rm
: u64è-> 
”aápb
::
SÇpshÙ
 {

458 
Ët
 
mut
 
m‘a
 = 
”aápb
::
SÇpshÙM‘ad©a
::
Ãw
();

459 
	gm‘a
.
£t_šdex
(
m‘a_šdex
);

460 
	gm‘a
.
£t_‹rm
(
m‘a_‹rm
);

461 
Ët
 
mut
 
	g¢­shÙ
 = 
”aápb
::
SÇpshÙ
::
Ãw
();

462 
	g¢­shÙ
.
£t_m‘ad©a
(
m‘a
);

463 
	g¢­shÙ


466 #[
‹¡
]

467 
â
 
‹¡_fšd_cÚæiù
() {

468 
Ët
 
	g´evious_’ts
 = 
vec
![
Ãw_’Œy
(1, 1),‚ew_entry(2, 2),‚ew_entry(3, 3)];

469 
Ët
 
	g‹¡s
 = 
vec
![

471 (
vec
![], 0),

472 (
	gvec
![], 0),

474 (
	gvec
![
Ãw_’Œy
(1, 1),‚ew_entry(2, 2),‚ew_entry(3, 3)], 0),

475 (
	gvec
![
Ãw_’Œy
(2, 2),‚ew_entry(3, 3)], 0),

476 (
	gvec
![
Ãw_’Œy
(3, 3)], 0),

479 
	gvec
![

480 
Ãw_’Œy
(1, 1),

481 
Ãw_’Œy
(2, 2),

482 
Ãw_’Œy
(3, 3),

483 
Ãw_’Œy
(4, 4),

484 
Ãw_’Œy
(5, 4),

489 
	gvec
![

490 
Ãw_’Œy
(2, 2),

491 
Ãw_’Œy
(3, 3),

492 
Ãw_’Œy
(4, 4),

493 
Ãw_’Œy
(5, 4),

497 (
	gvec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 4)], 4),

498 (
	gvec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 4)], 4),

500 (
	gvec
![
Ãw_’Œy
(1, 4),‚ew_entry(2, 4)], 1),

501 (
	gvec
![
Ãw_’Œy
(2, 1),‚ew_entry(3, 4),‚ew_entry(4, 4)], 2),

503 
	gvec
![

504 
Ãw_’Œy
(3, 1),

505 
Ãw_’Œy
(4, 2),

506 
Ãw_’Œy
(5, 4),

507 
Ãw_’Œy
(6, 4),

512 
	gi
, &(
»f
 
	g’ts
, 
	gwcÚæiù
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

513 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

514 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

515 
	g¿á_log
.
­³nd
(&
´evious_’ts
);

516 
Ët
 
	ggcÚæiù
 = 
¿á_log
.
fšd_cÚæiù
(
’ts
);

517 
	ggcÚæiù
 !ğ
wcÚæiù
 {

518 
·nic
!("#{}: cÚæiù = {}, wªˆ{}", 
i
, 
gcÚæiù
, 
wcÚæiù
)

523 #[
‹¡
]

524 
â
 
‹¡_is_up_to_d©e
() {

525 
Ët
 
	g´evious_’ts
 = 
vec
![
Ãw_’Œy
(1, 1),‚ew_entry(2, 2),‚ew_entry(3, 3)];

526 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

527 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

528 
	g¿á_log
.
­³nd
(&
´evious_’ts
);

529 
Ët
 
	g‹¡s
 = 
vec
![

531 (
¿á_log
.
Ï¡_šdex
(è- 1, 4, 
Œue
),

532 (
¿á_log
.
Ï¡_šdex
(), 4, 
Œue
),

533 (
¿á_log
.
Ï¡_šdex
(è+ 1, 4, 
Œue
),

535 (
¿á_log
.
Ï¡_šdex
(è- 1, 2, 
çl£
),

536 (
¿á_log
.
Ï¡_šdex
(), 2, 
çl£
),

537 (
¿á_log
.
Ï¡_šdex
(è+ 1, 2, 
çl£
),

539 (
¿á_log
.
Ï¡_šdex
(è- 1, 3, 
çl£
),

540 (
¿á_log
.
Ï¡_šdex
(), 3, 
Œue
),

541 (
¿á_log
.
Ï¡_šdex
(è+ 1, 3, 
Œue
),

543 
	gi
, &(
	gÏ¡_šdex
, 
	g‹rm
, 
	gup_to_d©e
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

544 
Ët
 
	gg_up_to_d©e
 = 
¿á_log
.
is_up_to_d©e
(
Ï¡_šdex
, 
‹rm
);

545 
	gg_up_to_d©e
 !ğ
up_to_d©e
 {

546 
·nic
!("#{}: u±od©ğ{}, wªˆ{}", 
i
, 
g_up_to_d©e
, 
up_to_d©e
);

551 #[
‹¡
]

552 
â
 
‹¡_­³nd
() {

553 
Ët
 
	g´evious_’ts
 = 
vec
![
Ãw_’Œy
(1, 1),‚ew_entry(2, 2)];

554 
Ët
 
	g‹¡s
 = 
vec
![

555 (
vec
![], 2, 
	gvec
![
Ãw_’Œy
(1, 1),‚ew_entry(2, 2)], 3),

557 
	gvec
![
Ãw_’Œy
(3, 2)],

559 
	gvec
![
Ãw_’Œy
(1, 1),‚ew_entry(2, 2),‚ew_entry(3, 2)],

563 (
	gvec
![
Ãw_’Œy
(1, 2)], 1, vec![new_entry(1, 2)], 1),

566 
	gvec
![
Ãw_’Œy
(2, 3),‚ew_entry(3, 3)],

568 
	gvec
![
Ãw_’Œy
(1, 1),‚ew_entry(2, 3),‚ew_entry(3, 3)],

572 
	gi
, &(
»f
 
	g’ts
, 
	gwšdex
,„eà
	gw’ts
, 
	gwun¡abË
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

573 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

574 
	g¡Üe
.
wl
().
­³nd
(&
´evious_’ts
).
ex³ù
("append failed");

575 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

576 
Ët
 
	gšdex
 = 
¿á_log
.
­³nd
(
’ts
);

577 
	gšdex
 !ğ
wšdex
 {

578 
·nic
!("#{}:†a¡_šdex = {}, wªˆ{}", 
i
, 
šdex
, 
wšdex
);

580 
m©ch
 
	g¿á_log
.
’Œ›s
(1, 
¿á_log
::
NO_LIMIT
) {

581 
E¼
(
e
è=> 
·nic
!("#{}: uÃx³ùedƒ¼Ü {}", 
	gi
, 
	ge
),

582 
Ok
(
»f
 
g
è
	gg
 !ğ
w’ts
 => 
·nic
!("#{}:†ogEÁ ğ{:?}, wªˆ{:?}", 
	gi
, &g, &
	gw’ts
),

583 
	g_
 => {

584 
Ët
 
goff
 = 
¿á_log
.
un¡abË
.
off£t
;

585 
	ggoff
 !ğ
wun¡abË
 {

586 
·nic
!("#{}: un¡abË = {}, wªˆ{}", 
i
, 
goff
, 
wun¡abË
);

593 #[
‹¡
]

594 
â
 
‹¡_com·ùiÚ_side_efãùs
() {

595 
Ët
 
	gÏ¡_šdex
 = 1000u64;

596 
Ët
 
	gun¡abË_šdex
 = 750u64;

597 
Ët
 
	gÏ¡_‹rm
 = 
Ï¡_šdex
;

598 
Ët
 
	g¡Üage
 = 
MemStÜage
::
Ãw
();

599 
i
 
	gš
 1..(
	gun¡abË_šdex
 + 1) {

600 
	g¡Üage


601 .
wl
()

602 .
­³nd
(&[
Ãw_’Œy
(
i
 
as
 
u64
, i‡s u64)])

603 .
ex³ù
("append failed");

605 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üage
);

606 
i
 
š
 
	gun¡abË_šdex
..
	gÏ¡_šdex
 {

607 
	g¿á_log
.
­³nd
(&[
Ãw_’Œy
(
i
 
as
 
u64
 + 1, i‡s u64 + 1)]);

610 
	gas£¹
!(

611 
	g¿á_log
.
maybe_comm™
(
Ï¡_šdex
, 
Ï¡_‹rm
),

614 
Ët
 
	gcomm™‹d
 = 
¿á_log
.
comm™‹d
;

615 
	g¿á_log
.
­¶›d_to
(
comm™‹d
);

616 
Ët
 
	goff£t
 = 500u64;

617 
	g¿á_log
.
	g¡Üe
.
wl
().
com·ù
(
off£t
).
ex³ù
("compact failed");

619 
	gas£¹_eq
!(
	gÏ¡_šdex
, 
	g¿á_log
.
Ï¡_šdex
());

621 
j
 
š
 
	goff£t
..
	g¿á_log
.
Ï¡_šdex
() + 1 {

622 
	gas£¹_eq
!(
	gj
, 
	g¿á_log
.
‹rm
(
j
).
ex³ù
(""));

623 !
	g¿á_log
.
m©ch_‹rm
(
j
, j) {

624 
	g·nic
!("m©ch_‹rm({}èğçl£, wªˆŒue", 
	gj
);

629 
Ët
 
	gun¡abË_’ts
 = 
¿á_log
.
un¡abË_’Œ›s
().
ex³ù
("should have content.");

630 
	gas£¹_eq
!(250, 
	gun¡abË_’ts
.
Ën
());

631 
	gas£¹_eq
!(751, 
	gun¡abË_’ts
[0].
g‘_šdex
());

634 
Ët
 
mut
 
	g´ev
 = 
¿á_log
.
Ï¡_šdex
();

635 
	g¿á_log
.
­³nd
(&[
Ãw_’Œy
(
´ev
 + 1,…rev + 1)]);

636 
	gas£¹_eq
!(
	g´ev
 + 1, 
	g¿á_log
.
Ï¡_šdex
());

638 
	g´ev
 = 
¿á_log
.
Ï¡_šdex
();

639 
Ët
 
	g’ts
 = 
¿á_log


640 .
’Œ›s
(
´ev
, 
¿á_log
::
NO_LIMIT
)

641 .
ex³ù
("unexpectedƒrror");

642 
	gas£¹_eq
!(1, 
	g’ts
.
Ën
());

645 #[
‹¡
]

646 
â
 
‹¡_‹rm_w™h_un¡abË_¢­shÙ
() {

647 
Ët
 
	g¡Üage¢­i
 = 10064;

648 
Ët
 
	gun¡abË¢­i
 = 
¡Üage¢­i
 + 5;

649 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

650 
	g¡Üe


651 .
wl
()

652 .
­¶y_¢­shÙ
(
Ãw_¢­shÙ
(
¡Üage¢­i
, 1))

653 .
ex³ù
("apply failed.");

654 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

655 
	g¿á_log
.
»¡Üe
(
Ãw_¢­shÙ
(
un¡abË¢­i
, 1));

657 
Ët
 
	g‹¡s
 = 
vec
![

659 (
¡Üage¢­i
, 0),

661 (
¡Üage¢­i
 + 1, 0),

662 (
un¡abË¢­i
 - 1, 0),

664 (
un¡abË¢­i
, 1),

667 
	gi
, &(
	gšdex
, 
	gw
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

668 
Ët
 
	g‹rm
 = 
¿á_log
.
‹rm
(
šdex
).
ex³ù
("");

669 
	g‹rm
 !ğ
w
 {

670 
·nic
!("#{}:‡ˆğ{}, wªˆ{}", 
i
, 
‹rm
, 
w
);

675 #[
‹¡
]

676 
â
 
‹¡_‹rm
() {

677 
Ët
 
	goff£t
 = 100u64;

678 
Ët
 
	gnum
 = 100u64;

680 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

681 
	g¡Üe


682 .
wl
()

683 .
­¶y_¢­shÙ
(
Ãw_¢­shÙ
(
off£t
, 1))

684 .
ex³ù
("apply failed.");

685 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

686 
i
 
	gš
 1..
	gnum
 {

687 
	g¿á_log
.
­³nd
(&[
Ãw_’Œy
(
off£t
 + 
i
, i)]);

690 
Ët
 
	g‹¡s
 = 
vec
![

691 (
off£t
 - 1, 0),

692 (
off£t
, 1),

693 (
off£t
 + 
num
 / 2,‚um / 2),

694 (
off£t
 + 
num
 - 1,‚um - 1),

695 (
off£t
 + 
num
, 0),

698 
	gi
, &(
	gšdex
, 
	gw
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

699 
Ët
 
	g‹rm
 = 
¿á_log
.
‹rm
(
šdex
).
ex³ù
("");

700 
	g‹rm
 !ğ
w
 {

701 
·nic
!("#{}:‡ˆğ{}, wªˆ{}", 
i
, 
‹rm
, 
w
);

706 #[
‹¡
]

707 
â
 
‹¡_log_»¡Üe
() {

708 
Ët
 (
šdex
, 
‹rm
) = (1000u64, 1000u64);

709 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

710 
	g¡Üe


711 .
wl
()

712 .
­¶y_¢­shÙ
(
Ãw_¢­shÙ
(
šdex
, 
‹rm
))

713 .
ex³ù
("apply failed.");

714 
Ët
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

716 
	gas£¹
!(
	g¿á_log
.
®l_’Œ›s
().
is_em±y
());

717 
	gas£¹_eq
!(
	gšdex
 + 1, 
	g¿á_log
.
fœ¡_šdex
());

718 
	gas£¹_eq
!(
	gšdex
, 
	g¿á_log
.
	gcomm™‹d
);

719 
	gas£¹_eq
!(
	gšdex
 + 1, 
	g¿á_log
.
	gun¡abË
.
	goff£t
);

720 
Ët
 
	gaùu®_‹rm
 = 
¿á_log
.
‹rm
(
šdex
).
ex³ù
("");

721 
	gas£¹_eq
!(
	g‹rm
, 
	gaùu®_‹rm
);

724 #[
‹¡
]

725 
â
 
‹¡_¡abË_to_w™h_¢­
() {

726 
Ët
 (
¢­_šdex
, 
¢­_‹rm
) = (5u64, 2u64);

727 
Ët
 
	g‹¡s
 = 
vec
![

728 (
¢­_šdex
 + 1, 
¢­_‹rm
, 
vec
![], 
	g¢­_šdex
 + 1),

729 (
	g¢­_šdex
, 
	g¢­_‹rm
, 
	gvec
![], snap_index + 1),

730 (
	g¢­_šdex
 - 1, 
	g¢­_‹rm
, 
	gvec
![], snap_index + 1),

732 (
	g¢­_šdex
 + 1, 
	g¢­_‹rm
 + 1, 
	gvec
![], snap_index + 1),

733 (
	g¢­_šdex
, 
	g¢­_‹rm
 + 1, 
	gvec
![], snap_index + 1),

734 (
	g¢­_šdex
 - 1, 
	g¢­_‹rm
 + 1, 
	gvec
![], snap_index + 1),

737 
	g¢­_šdex
 + 1,

738 
	g¢­_‹rm
,

739 
	gvec
![
Ãw_’Œy
(
¢­_šdex
 + 1, 
¢­_‹rm
)],

740 
	g¢­_šdex
 + 2,

743 
	g¢­_šdex
,

744 
	g¢­_‹rm
,

745 
	gvec
![
Ãw_’Œy
(
¢­_šdex
 + 1, 
¢­_‹rm
)],

746 
	g¢­_šdex
 + 1,

749 
	g¢­_šdex
 - 1,

750 
	g¢­_‹rm
,

751 
	gvec
![
Ãw_’Œy
(
¢­_šdex
 + 1, 
¢­_‹rm
)],

752 
	g¢­_šdex
 + 1,

756 
	g¢­_šdex
 + 1,

757 
	g¢­_‹rm
 + 1,

758 
	gvec
![
Ãw_’Œy
(
¢­_šdex
 + 1, 
¢­_‹rm
)],

759 
	g¢­_šdex
 + 1,

762 
	g¢­_šdex
,

763 
	g¢­_‹rm
 + 1,

764 
	gvec
![
Ãw_’Œy
(
¢­_šdex
 + 1, 
¢­_‹rm
)],

765 
	g¢­_šdex
 + 1,

768 
	g¢­_šdex
 - 1,

769 
	g¢­_‹rm
 + 1,

770 
	gvec
![
Ãw_’Œy
(
¢­_šdex
 + 1, 
¢­_‹rm
)],

771 
	g¢­_šdex
 + 1,

775 
	gi
, &(
	g¡abËi
, 
	g¡abËt
, 
»f
 
	gÃw_’ts
, 
	gwun¡abË
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

776 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

777 
	g¡Üe


778 .
wl
()

779 .
­¶y_¢­shÙ
(
Ãw_¢­shÙ
(
¢­_šdex
, 
¢­_‹rm
))

780 .
ex³ù
("");

781 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

782 
	g¿á_log
.
­³nd
(
Ãw_’ts
);

783 
	g¿á_log
.
¡abË_to
(
¡abËi
, 
¡abËt
);

784 
	g¿á_log
.
	gun¡abË
.
	goff£t
 !ğ
wun¡abË
 {

785 
·nic
!(

787 
i
,

788 
¿á_log
.
un¡abË
.
off£t
,

789 
wun¡abË


795 #[
‹¡
]

796 
â
 
‹¡_¡abË_to
() {

797 
Ët
 
	g‹¡s
 = 
vec
![(1, 1, 2), (2, 2, 3), (2, 1, 1), (3, 1, 1)];

798 
	gi
, &(
	g¡abËi
, 
	g¡abËt
, 
	gwun¡abË
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

799 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

800 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

801 
	g¿á_log
.
­³nd
(&[
Ãw_’Œy
(1, 1),‚ew_entry(2, 2)]);

802 
	g¿á_log
.
¡abË_to
(
¡abËi
, 
¡abËt
);

803 
	g¿á_log
.
	gun¡abË
.
	goff£t
 !ğ
wun¡abË
 {

804 
·nic
!(

806 
i
,

807 
¿á_log
.
un¡abË
.
off£t
,

808 
wun¡abË


816 #[
‹¡
]

817 
â
 
‹¡_un¡abË_’ts
() {

818 
Ët
 
	g´evious_’ts
 = 
vec
![
Ãw_’Œy
(1, 1),‚ew_entry(2, 2)];

819 
Ët
 
	g‹¡s
 = 
vec
![(3, vec![]), (1, 
	g´evious_’ts
.
şÚe
())];

821 
	gi
, &(
	gun¡abË
, 
»f
 
	gw’ts
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

823 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

824 
	g¡Üe


825 .
wl
()

826 .
­³nd
(&
´evious_’ts
[..(
un¡abË
 - 1)])

827 .
ex³ù
("");

830 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

831 
	g¿á_log
.
­³nd
(&
´evious_’ts
[(
un¡abË
 - 1)..]);

833 
Ët
 
	g’ts
 = 
¿á_log
.
un¡abË_’Œ›s
().
unw¿p_Ü
(&[]).
to_vec
();

834 
Ët
 
	gl
 = 
’ts
.
Ën
();

835 
	gl
 > 0 {

836 
	g¿á_log
.
¡abË_to
(
’ts
[
l
 - 1].
g‘_šdex
(),ƒÁs[È- 
i
].
g‘_‹rm
());

838 &
	g’ts
 !ğ
w’ts
 {

839 
·nic
!("#{}: un¡abËEÁ ğ{:?}, wªˆ{:?}", 
i
, 
’ts
, 
w’ts
);

841 
Ët
 
	gw
 = 
´evious_’ts
[´evious_’ts.
Ën
(è- 1].
g‘_šdex
() + 1;

842 
Ët
 
	gg
 = 
¿á_log
.
un¡abË
.
off£t
;

843 
	gg
 !ğ
w
 {

844 
·nic
!("#{}: un¡abË = {}, wªˆ{}", 
i
, 
g
, 
w
);

849 #[
‹¡
]

850 
â
 
‹¡_Ãxt_’ts
() {

851 
Ët
 
	g’ts
 = [
Ãw_’Œy
(4, 1),‚ew_entry(5, 1),‚ew_entry(6, 1)];

852 
Ët
 
	g‹¡s
 = 
vec
![

853 (0, 
Some
(&
’ts
[..2])),

854 (3, 
Some
(&
’ts
[..2])),

855 (4, 
Some
(&
’ts
[1..2])),

856 (5, 
	gNÚe
),

858 
	gi
, &(
	g­¶›d
, 
»f
 
	gex³ù_’Œ›s
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

859 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

860 
	g¡Üe
.
wl
().
­¶y_¢­shÙ
(
Ãw_¢­shÙ
(3, 1)).
ex³ù
("");

861 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

862 
	g¿á_log
.
­³nd
(&
’ts
);

863 
	g¿á_log
.
maybe_comm™
(5, 1);

864 
	g¿á_log
.
­¶›d_to
(
­¶›d
);

866 
Ët
 
	gÃxt_’Œ›s
 = 
¿á_log
.
Ãxt_’Œ›s
();

867 
	gÃxt_’Œ›s
 !ğ
ex³ù_’Œ›s
.
m­
(|
n
|‚.
to_vec
()) {

868 
·nic
!(

870 
i
,

871 
Ãxt_’Œ›s
,

872 
ex³ù_’Œ›s


878 #[
‹¡
]

879 
â
 
‹¡_has_Ãxt_’ts
() {

880 
Ët
 
	g’ts
 = [
Ãw_’Œy
(4, 1),‚ew_entry(5, 1),‚ew_entry(6, 1)];

881 
Ët
 
	g‹¡s
 = 
vec
![(0, 
Œue
), (3,rue), (4,rue), (5, 
çl£
)];

883 
	gi
, &(
	g­¶›d
, 
	ghas_Ãxt
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

884 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

885 
	g¡Üe
.
wl
().
­¶y_¢­shÙ
(
Ãw_¢­shÙ
(3, 1)).
ex³ù
("");

886 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

887 
	g¿á_log
.
­³nd
(&
’ts
);

888 
	g¿á_log
.
maybe_comm™
(5, 1);

889 
	g¿á_log
.
­¶›d_to
(
­¶›d
);

891 
Ët
 
	gaùu®_has_Ãxt
 = 
¿á_log
.
has_Ãxt_’Œ›s
();

892 
	gaùu®_has_Ãxt
 !ğ
has_Ãxt
 {

893 
·nic
!("#{}: hasNexˆğ{}, wªˆ{}", 
i
, 
aùu®_has_Ãxt
, 
has_Ãxt
);

898 #[
‹¡
]

899 
â
 
‹¡_¦iû
() {

900 
Ët
 (
off£t
, 
num
) = (100u64, 100u64);

901 
Ët
 (
Ï¡
, 
h®f
èğ(
off£t
 + 
num
, 
	goff£t
 + 
	gnum
 / 2);

902 
Ët
 
	gh®ã
 = 
Ãw_’Œy
(
h®f
, half);

903 
Ët
 
	gh®ã_size
 = 
´Ùobuf
::
Mes§ge
::
compu‹_size
(&
h®ã
è
as
 
u64
;

905 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

906 
	g¡Üe


907 .
wl
()

908 .
­¶y_¢­shÙ
(
Ãw_¢­shÙ
(
off£t
, 0))

909 .
ex³ù
("");

910 
i
 
	gš
 1..(
	gnum
 / 2) {

911 
	g¡Üe


912 .
wl
()

913 .
­³nd
(&[
Ãw_’Œy
(
off£t
 + 
i
, offset + i)])

914 .
ex³ù
("");

916 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

917 
i
 
š
 (
num
 / 2)..
	gnum
 {

918 
	g¿á_log
.
­³nd
(&[
Ãw_’Œy
(
off£t
 + 
i
, offset + i)]);

921 
Ët
 
	g‹¡s
 = 
vec
![

923 (
off£t
 - 1, off£ˆ+ 1, 
¿á_log
::
NO_LIMIT
, 
vec
![], 
	gçl£
),

924 (
	goff£t
, off£ˆ+ 1, 
	g¿á_log
::
NO_LIMIT
, 
	gvec
![], 
	gçl£
),

926 
	gh®f
 - 1,

927 
	gh®f
 + 1,

928 
	g¿á_log
::
NO_LIMIT
,

929 
	gvec
![
Ãw_’Œy
(
h®f
 - 1, half - 1),‚ew_entry(half, half)],

930 
	gçl£
,

933 
	gh®f
,

934 
	gh®f
 + 1,

935 
	g¿á_log
::
NO_LIMIT
,

936 
	gvec
![
Ãw_’Œy
(
h®f
, half)],

937 
	gçl£
,

940 
	gÏ¡
 - 1,

941 
	gÏ¡
,

942 
	g¿á_log
::
NO_LIMIT
,

943 
	gvec
![
Ãw_’Œy
(
Ï¡
 - 1,†ast - 1)],

944 
	gçl£
,

946 (
	gÏ¡
,†a¡ + 1, 
	g¿á_log
::
NO_LIMIT
, 
	gvec
![], 
	gŒue
),

950 
	gh®f
 - 1,

951 
	gh®f
 + 1,

953 
	gvec
![
Ãw_’Œy
(
h®f
 - 1, half - 1)],

954 
	gçl£
,

957 
	gh®f
 - 1,

958 
	gh®f
 + 1,

959 
	gh®ã_size
 + 1,

960 
	gvec
![
Ãw_’Œy
(
h®f
 - 1, half - 1)],

961 
	gçl£
,

964 
	gh®f
 - 2,

965 
	gh®f
 + 1,

966 
	gh®ã_size
 + 1,

967 
	gvec
![
Ãw_’Œy
(
h®f
 - 2, half - 2)],

968 
	gçl£
,

971 
	gh®f
 - 1,

972 
	gh®f
 + 1,

973 
	gh®ã_size
 * 2,

974 
	gvec
![
Ãw_’Œy
(
h®f
 - 1, half - 1),‚ew_entry(half, half)],

975 
	gçl£
,

978 
	gh®f
 - 1,

979 
	gh®f
 + 2,

980 
	gh®ã_size
 * 3,

981 
	gvec
![

982 
Ãw_’Œy
(
h®f
 - 1, half - 1),

983 
Ãw_’Œy
(
h®f
, half),

984 
Ãw_’Œy
(
h®f
 + 1, half + 1),

986 
	gçl£
,

989 
	gh®f
,

990 
	gh®f
 + 2,

991 
	gh®ã_size
,

992 
	gvec
![
Ãw_’Œy
(
h®f
, half)],

993 
	gçl£
,

996 
	gh®f
,

997 
	gh®f
 + 2,

998 
	gh®ã_size
 * 2,

999 
	gvec
![
Ãw_’Œy
(
h®f
, half),‚ew_entry(half + 1, half + 1)],

1000 
	gçl£
,

1004 
	gi
, &(
	gäom
, 
	gto
, 
	glim™
, 
»f
 
	gw
, 
	gw·nic
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

1005 
Ët
 
	g»s
 = 
»cov”_§ã
!(|| 
¿á_log
.
¦iû
(
äom
, 
to
, 
lim™
));

1006 
	g»s
.
is_”r
(è^ 
	gw·nic
 {

1007 
	g·nic
!("#{}:…ªiøğ{}, wªˆ{}: {:?}", 
	gi
, 
	gŒue
, 
	gçl£
, 
	g»s
);

1009 
	g»s
.
is_”r
() {

1012 
Ët
 
	g¦iû_»s
 = 
»s
.
unw¿p
();

1013 
	gäom
 <ğ
off£t
 && 
¦iû_»s
 !ğ
E¼
(
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
)) {

1014 
Ët
 
”r
 = 
¦iû_»s
.err();

1015 
	g·nic
!("#{}:ƒ¼ = {:?}, wªˆ{}", 
	gi
, 
	g”r
, 
	gStÜageE¼Ü
::
Com·ùed
);

1017 
	gäom
 > 
	goff£t
 && 
	g¦iû_»s
.
is_”r
() {

1018 
	g·nic
!("#{}: uÃx³ùedƒ¼Ü {}", 
	gi
, 
	g¦iû_»s
.
unw¿p_”r
());

1020 
Ët
 
Ok
(
»f
 
g
èğ
¦iû_»s
 {

1021 
g
 !ğ
w
 {

1022 
·nic
!("#{}: from {}Ø{} = {:?}, wªˆ{:?}", 
i
, 
äom
, 
to
, 
g
, 
w
);

1036 #[
‹¡
]

1037 
â
 
‹¡_log_maybe_­³nd
() {

1038 
Ët
 
	g´evious_’ts
 = 
vec
![
Ãw_’Œy
(1, 1),‚ew_entry(2, 2),‚ew_entry(3, 3)];

1039 
Ët
 (
Ï¡_šdex
, 
Ï¡_‹rm
, 
comm™
) = (3u64, 3u64, 1u64);

1041 
Ët
 
	g‹¡s
 = 
vec
![

1044 
Ï¡_‹rm
 - 1,

1045 
Ï¡_šdex
,

1046 
Ï¡_šdex
,

1047 
vec
![
Ãw_’Œy
(
Ï¡_šdex
 + 1, 4)],

1048 
	gNÚe
,

1049 
	gcomm™
,

1050 
	gçl£
,

1054 
	gÏ¡_‹rm
,

1055 
	gÏ¡_šdex
 + 1,

1056 
	gÏ¡_šdex
,

1057 
	gvec
![
Ãw_’Œy
(
Ï¡_šdex
 + 2, 4)],

1058 
	gNÚe
,

1059 
	gcomm™
,

1060 
	gçl£
,

1064 
	gÏ¡_‹rm
,

1065 
	gÏ¡_šdex
,

1066 
	gÏ¡_šdex
,

1067 
	gvec
![],

1068 
Some
(
Ï¡_šdex
),

1069 
	gÏ¡_šdex
,

1070 
	gçl£
,

1073 
	gÏ¡_‹rm
,

1074 
	gÏ¡_šdex
,

1075 
	gÏ¡_šdex
 + 1,

1076 
	gvec
![],

1077 
Some
(
Ï¡_šdex
),

1078 
	gÏ¡_šdex
,

1079 
	gçl£
,

1082 
	gÏ¡_‹rm
,

1083 
	gÏ¡_šdex
,

1084 
	gÏ¡_šdex
 - 1,

1085 
	gvec
![],

1086 
Some
(
Ï¡_šdex
),

1087 
	gÏ¡_šdex
 - 1,

1088 
	gçl£
,

1091 
	gÏ¡_‹rm
,

1092 
	gÏ¡_šdex
,

1094 
	gvec
![],

1095 
Some
(
Ï¡_šdex
),

1096 
	gcomm™
,

1097 
	gçl£
,

1099 (0, 0, 
	gÏ¡_šdex
, 
	gvec
![], 
Some
(0), 
	gcomm™
, 
	gçl£
),

1101 
	gÏ¡_‹rm
,

1102 
	gÏ¡_šdex
,

1103 
	gÏ¡_šdex
,

1104 
	gvec
![
Ãw_’Œy
(
Ï¡_šdex
 + 1, 4)],

1105 
Some
(
Ï¡_šdex
 + 1),

1106 
	gÏ¡_šdex
,

1107 
	gçl£
,

1110 
	gÏ¡_‹rm
,

1111 
	gÏ¡_šdex
,

1112 
	gÏ¡_šdex
 + 1,

1113 
	gvec
![
Ãw_’Œy
(
Ï¡_šdex
 + 1, 4)],

1114 
Some
(
Ï¡_šdex
 + 1),

1115 
	gÏ¡_šdex
 + 1,

1116 
	gçl£
,

1119 
	gÏ¡_‹rm
,

1120 
	gÏ¡_šdex
,

1121 
	gÏ¡_šdex
 + 2,

1122 
	gvec
![
Ãw_’Œy
(
Ï¡_šdex
 + 1, 4)],

1123 
Some
(
Ï¡_šdex
 + 1),

1124 
	gÏ¡_šdex
 + 1,

1125 
	gçl£
,

1129 
	gÏ¡_‹rm
,

1130 
	gÏ¡_šdex
,

1131 
	gÏ¡_šdex
 + 2,

1132 
	gvec
![
Ãw_’Œy
(
Ï¡_šdex
 + 1, 4),‚ew_entry(last_index + 2, 4)],

1133 
Some
(
Ï¡_šdex
 + 2),

1134 
	gÏ¡_šdex
 + 2,

1135 
	gçl£
,

1139 
	gÏ¡_‹rm
 - 1,

1140 
	gÏ¡_šdex
 - 1,

1141 
	gÏ¡_šdex
,

1142 
	gvec
![
Ãw_’Œy
(
Ï¡_šdex
, 4)],

1143 
Some
(
Ï¡_šdex
),

1144 
	gÏ¡_šdex
,

1145 
	gçl£
,

1148 
	gÏ¡_‹rm
 - 2,

1149 
	gÏ¡_šdex
 - 2,

1150 
	gÏ¡_šdex
,

1151 
	gvec
![
Ãw_’Œy
(
Ï¡_šdex
 - 1, 4)],

1152 
Some
(
Ï¡_šdex
 - 1),

1153 
	gÏ¡_šdex
 - 1,

1154 
	gçl£
,

1157 
	gÏ¡_‹rm
 - 3,

1158 
	gÏ¡_šdex
 - 3,

1159 
	gÏ¡_šdex
,

1160 
	gvec
![
Ãw_’Œy
(
Ï¡_šdex
 - 2, 4)],

1161 
Some
(
Ï¡_šdex
 - 2),

1162 
	gÏ¡_šdex
 - 2,

1163 
	gŒue
,

1166 
	gÏ¡_‹rm
 - 2,

1167 
	gÏ¡_šdex
 - 2,

1168 
	gÏ¡_šdex
,

1169 
	gvec
![
Ãw_’Œy
(
Ï¡_šdex
 - 1, 4),‚ew_entry(last_index, 4)],

1170 
Some
(
Ï¡_šdex
),

1171 
	gÏ¡_šdex
,

1172 
	gçl£
,

1176 
	gi
, &(
	glog_‹rm
, 
	gšdex
, 
	gcomm™‹d
, 
»f
 
	g’ts
, 
	gwÏ¡i
, 
	gwcomm™
, 
	gw·nic
)è
š


1177 
	g‹¡s
.
™”
().
’um”©e
()

1179 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

1180 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

1181 
	g¿á_log
.
­³nd
(&
´evious_’ts
);

1182 
	g¿á_log
.
	gcomm™‹d
 = 
comm™
;

1183 
Ët
 
	g»s
 = 
»cov”_§ã
!(|| 
¿á_log
.
maybe_­³nd
(
šdex
, 
log_‹rm
, 
comm™‹d
, 
’ts
));

1184 
	g»s
.
is_”r
(è^ 
	gw·nic
 {

1185 
	g·nic
!("#{}:…ªiøğ{}, wªˆ{}", 
	gi
, 
	g»s
.
is_”r
(), 
	gw·nic
);

1187 
	g»s
.
is_”r
() {

1190 
Ët
 
	ggÏ¡i
 = 
»s
.
unw¿p
();

1191 
Ët
 
	ggcomm™‹d
 = 
¿á_log
.
comm™‹d
;

1192 
	ggÏ¡i
 !ğ
wÏ¡i
 {

1193 
·nic
!("#{}:†a¡šdex = {:?}, wªˆ{:?}", 
i
, 
gÏ¡i
, 
wÏ¡i
);

1195 
	ggcomm™‹d
 !ğ
wcomm™
 {

1196 
·nic
!("#{}: comm™‹d = {}, wªˆ{}", 
i
, 
gcomm™‹d
, 
wcomm™
);

1198 
Ët
 
	g’ts_Ën
 = 
’ts
.
Ën
(è
as
 
u64
;

1199 
	ggÏ¡i
.
is_some
(è&& 
	g’ts_Ën
 != 0 {

1200 
Ët
 (
äom
, 
to
) = (

1201 
¿á_log
.
Ï¡_šdex
(è- 
’ts_Ën
 + 1,

1202 
	g¿á_log
.
Ï¡_šdex
() + 1,

1204 
Ët
 
	gg’ts
 = 
¿á_log
.
¦iû
(
äom
, 
to
,„aá_log::
NO_LIMIT
).
ex³ù
("");

1205 &
	gg’ts
 !ğ
’ts
 {

1206 
·nic
!("#{}:‡µ’dedƒÁr› ğ{:?}, wªˆ{:?}", 
i
, 
g’ts
, 
’ts
);

1212 #[
‹¡
]

1213 
â
 
‹¡_comm™_to
() {

1214 
Ët
 
	g´evious_’ts
 = 
vec
![
Ãw_’Œy
(1, 1),‚ew_entry(2, 2),‚ew_entry(3, 3)];

1215 
Ët
 
	g´evious_comm™
 = 2u64;

1216 
Ët
 
	g‹¡s
 = 
vec
![

1217 (3, 3, 
çl£
),

1218 (1, 2, 
çl£
),

1219 (4, 0, 
Œue
),

1221 
	gi
, &(
	gcomm™
, 
	gwcomm™
, 
	gw·nic
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

1222 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

1223 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

1224 
	g¿á_log
.
­³nd
(&
´evious_’ts
);

1225 
	g¿á_log
.
	gcomm™‹d
 = 
´evious_comm™
;

1226 
Ët
 
	ghas_·nic
 = 
»cov”_§ã
!(|| 
¿á_log
.
comm™_to
(
comm™
)).
is_”r
();

1227 
	ghas_·nic
 ^ 
	gw·nic
 {

1228 
	g·nic
!("#{}:…ªiøğ{}, wªˆ{}", 
	gi
, 
	ghas_·nic
, 
	gw·nic
)

1230 !
	ghas_·nic
 && 
	g¿á_log
.
	gcomm™‹d
 !ğ
wcomm™
 {

1231 
Ët
 
aùu®_comm™‹d
 = 
¿á_log
.
comm™‹d
;

1232 
	g·nic
!("#{}: comm™‹d = {}, wªˆ{}", 
	gi
, 
	gaùu®_comm™‹d
, 
	gwcomm™
);

1238 #[
‹¡
]

1239 
â
 
‹¡_com·ùiÚ
() {

1240 
Ët
 
	g‹¡s
 = 
vec
![

1242 (1000, 
vec
![1001u64], 
	gvec
![0u
size
], 
	gçl£
),

1245 
	gvec
![300, 500, 800, 900],

1246 
	gvec
![700, 500, 200, 100],

1247 
	gŒue
,

1250 (1000, 
	gvec
![300, 299], vec![700, 0], 
	gçl£
),

1253 
	gi
, &(
	gÏ¡_šdex
, 
»f
 
	gcom·ù
,„eà
	gwËá
, 
	gw®low
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

1254 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

1255 
i
 
	gš
 1u64..(
	gÏ¡_šdex
 + 1) {

1256 
	g¡Üe
.
wl
().
­³nd
(&[
Ãw_’Œy
(
i
, 0)]).
ex³ù
("");

1258 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

1259 
	g¿á_log
.
maybe_comm™
(
Ï¡_šdex
, 0);

1260 
Ët
 
	gcomm™‹d
 = 
¿á_log
.
comm™‹d
;

1261 
	g¿á_log
.
­¶›d_to
(
comm™‹d
);

1263 
	gj
, 
	gidx
è
š
 
	gcom·ù
.
što_™”
().
’um”©e
() {

1264 
Ët
 
	g»s
 = 
»cov”_§ã
!(|| 
¿á_log
.
¡Üe
.
wl
().
com·ù
(*
idx
));

1265 
	g»s
.
is_”r
() {

1266 
	gw®low
 {

1267 
	g·nic
!("#{}: has_·niøğŒue, wªˆçl£: {:?}", 
	gi
, 
	g»s
);

1271 
Ët
 
	gcom·ù_»s
 = 
»s
.
unw¿p
();

1272 
Ët
 
E¼
(
e
èğ
com·ù_»s
 {

1273 
w®low
 {

1274 
·nic
!("#{}.{}‡Îow = f®£, wªˆŒue,ƒ¼Ü: {}", 
i
, 
j
, 
e
);

1278 
Ët
 
	gl
 = 
¿á_log
.
®l_’Œ›s
().
Ën
();

1279 
	gl
 !ğ
wËá
[
j
] {

1280 
·nic
!("#{}.{}†’ = {}, wªˆ{}", 
i
, 
j
, 
l
, 
wËá
[j]);

1286 #[
‹¡
]

1287 
â
 
‹¡_is_outofbounds
() {

1288 
Ët
 (
off£t
, 
num
) = (100u64, 100u64);

1289 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

1290 
	g¡Üe


1291 .
wl
()

1292 .
­¶y_¢­shÙ
(
Ãw_¢­shÙ
(
off£t
, 0))

1293 .
ex³ù
("");

1294 
Ët
 
mut
 
	g¿á_log
 = 
Ãw_¿á_log
(
¡Üe
);

1295 
i
 
	gš
 1u64..(
	gnum
 + 1) {

1296 
	g¿á_log
.
­³nd
(&[
Ãw_’Œy
(
i
 + 
off£t
, 0)]);

1298 
Ët
 
	gfœ¡
 = 
off£t
 + 1;

1299 
Ët
 
	g‹¡s
 = 
vec
![

1300 (
fœ¡
 - 2, fœ¡ + 1, 
çl£
, 
Œue
),

1301 (
fœ¡
 - 1, fœ¡ + 1, 
çl£
, 
Œue
),

1302 (
fœ¡
, fœ¡, 
çl£
, false),

1303 (
fœ¡
 + 
num
 / 2, fœ¡ +‚um / 2, 
çl£
, false),

1304 (
fœ¡
 + 
num
 - 1, fœ¡ +‚um - 1, 
çl£
, false),

1305 (
fœ¡
 + 
num
, fœ¡ +‚um, 
çl£
, false),

1306 (
fœ¡
 + 
num
, fœ¡ +‚um + 1, 
Œue
, 
çl£
),

1307 (
fœ¡
 + 
num
 + 1, fœ¡ +‚um + 1, 
Œue
, 
çl£
),

1310 
	gi
, &(
	glo
, 
	ghi
, 
	gw·nic
, 
	gw_”r_com·ùed
)è
š
 
	g‹¡s
.
™”
().
’um”©e
() {

1311 
Ët
 
	g»s
 = 
»cov”_§ã
!(|| 
¿á_log
.
mu¡_check_outofbounds
(
lo
, 
hi
));

1312 
	g»s
.
is_”r
(è^ 
	gw·nic
 {

1313 
	g·nic
!(

1315 
	gi
,

1316 
	g»s
.
is_”r
(),

1317 
	gw·nic
,

1318 
	g»s


1321 
	g»s
.
is_”r
() {

1324 
Ët
 
	gcheck_»s
 = 
»s
.
unw¿p
();

1325 
	gw_”r_com·ùed
 && 
	gcheck_»s
 !ğ
Some
(
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
)) {

1326 
·nic
!(

1328 
i
,

1329 
check_»s
,

1330 
StÜageE¼Ü
::
Com·ùed


1333 !
	gw_”r_com·ùed
 && 
	gcheck_»s
.
is_some
() {

1334 
	g·nic
!("#{}: uÃx³ùedƒ¼ {:?}", 
	gi
, 
	gcheck_»s
)

	@src/raft/raw_node.rs

29 
u£
 
	g¡d
::
mem
;

31 
u£
 
	g¿á
::
”rÜs
::{
E¼Ü
, 
	gResuÉ
};

32 
u£
 
	g¿á
::
StÜage
;

33 
u£
 
	g´Ùobuf
::{
£lf
, 
	gR•—‹dF›ld
};

34 
u£
 
	gkv´Ùo
::
”aápb
::{
CÚfChªge
, 
	gCÚfChªgeTy³
, 
	gCÚfS‹
, 
	gEÁry
, 
	gEÁryTy³
, 
	gH¬dS‹
,

35 
	gMes§ge
, 
	gMes§geTy³
, 
	gSÇpshÙ
};

36 
u£
 
	gsu³r
::
¿á
::{
CÚfig
, 
	gRaá
, 
	gSoáS‹
, 
	gINVALID_ID
};

37 
u£
 
	gsu³r
::
Stus
;

38 
u£
 
	gsu³r
::
»ad_Úly
::
R—dS‹
;

40 #[
d”ive
(
Debug
, 
DeçuÉ
)]

41 
pub
 
	sP“r
 {

42 
pub
 
	mid
: 
u64
,

43 
pub
 
	mcÚ‹xt
: 
O±iÚ
<
Vec
<
u8
>>,

46 #[
d”ive
(
Debug
, 
P¬tŸlEq
, 
Cİy
, 
ClÚe
)]

47 
pub
 
	eSÇpshÙStus
 {

48 
	mFšish
,

49 
	mFau»
,

52 
â
 
is_loÿl_msg
(
t
: 
Mes§geTy³
è-> 
boŞ
 {

53 
m©ch
 
t
 {

54 
Mes§geTy³
::
MsgHup
 |

55 
Mes§geTy³
::
MsgB—t
 |

56 
Mes§geTy³
::
MsgUÄ—chabË
 |

57 
Mes§geTy³
::
MsgSÇpStus
 |

58 
Mes§geTy³
::
MsgCheckQuÜum
 => 
Œue
,

59 
	g_
 => 
çl£
,

63 
â
 
is_»¥Ú£_msg
(
t
: 
Mes§geTy³
è-> 
boŞ
 {

64 
m©ch
 
t
 {

65 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
 |

66 
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£
 |

67 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
 |

68 
Mes§geTy³
::
MsgUÄ—chabË
 |

69 
Mes§geTy³
::
MsgReque¡P»VÙeRe¥Ú£
 => 
Œue
,

70 
	g_
 => 
çl£
,

74 
pub
 
â
 
is_em±y_¢­
(
s
: &
SÇpshÙ
è-> 
boŞ
 {

75 
s
.
g‘_m‘ad©a
().
g‘_šdex
() == 0

81 #[
d”ive
(
DeçuÉ
, 
Debug
, 
P¬tŸlEq
)]

82 
pub
 
	sR—dy
 {

86 
pub
 
	mss
: 
O±iÚ
<
SoáS‹
>,

91 
pub
 
	mhs
: 
O±iÚ
<
H¬dS‹
>,

97 
pub
 
	m»ad_¡©es
: 
Vec
<
R—dS‹
>,

101 
pub
 
	m’Œ›s
: 
Vec
<
EÁry
>,

104 
pub
 
	m¢­shÙ
: 
SÇpshÙ
,

109 
pub
 
	mcomm™‹d_’Œ›s
: 
O±iÚ
<
Vec
<
EÁry
>>,

115 
pub
 
	mmes§ges
: 
Vec
<
Mes§ge
>,

119 
pub
 
	mmu¡_sync
: 
boŞ
,

122 
im¶
 
	gR—dy
 {

123 
â
 
	gÃw
<
	gT
: 
StÜage
>(

124 
¿á
: &
mut
 
Raá
<
T
>,

125 
	g´ev_ss
: &
SoáS‹
,

126 
	g´ev_hs
: &
H¬dS‹
,

127 
	gsšû_idx
: 
O±iÚ
<
u64
>,

128 è-> 
	gR—dy
 {

129 
Ët
 
mut
 
	grd
 = 
R—dy
 {

130 
’Œ›s
: 
¿á
.
¿á_log
.
un¡abË_’Œ›s
().
unw¿p_Ü
(&[]).
to_vec
(),

131 ..
DeçuÉ
::()

133 !
	g¿á
.
	gmsgs
.
is_em±y
() {

134 
	gmem
::
sw­
(&
mut
 
¿á
.
msgs
, &muˆ
rd
.
mes§ges
);

136 
	grd
.
	gcomm™‹d_’Œ›s
 = 
Some
(

137 (
m©ch
 
sšû_idx
 {

138 
NÚe
 => 
¿á
.
¿á_log
.
Ãxt_’Œ›s
(),

139 
Some
(
idx
è=> 
¿á
.
¿á_log
.
Ãxt_’Œ›s_sšû
(idx),

140 }).
unw¿p_Ü_–£
(
Vec
::
Ãw
),

142 
Ët
 
	gss
 = 
¿á
.
soá_¡©e
();

143 &
	gss
 !ğ
´ev_ss
 {

144 
rd
.
ss
 = 
Some
(ss);

146 
Ët
 
	ghs
 = 
¿á
.
h¬d_¡©e
();

147 &
	ghs
 !ğ
´ev_hs
 {

148 
hs
.
g‘_vÙe
(è!ğ
´ev_hs
.g‘_vÙe(è|| hs.
g‘_‹rm
() !=…rev_hs.get_term() {

149 
rd
.
mu¡_sync
 = 
Œue
;

151 
	grd
.
	ghs
 = 
Some
(
hs
);

153 
	g¿á
.
	g¿á_log
.
g‘_un¡abË
().
	g¢­shÙ
.
is_some
() {

154 
	grd
.
	g¢­shÙ
 = 
¿á
.
¿á_log
.
g‘_un¡abË
().
¢­shÙ
.
şÚe
().
unw¿p
();

156 !
	g¿á
.
	g»ad_¡©es
.
is_em±y
() {

157 
	grd
.
	g»ad_¡©es
 = 
¿á
.
»ad_¡©es
.
şÚe
();

159 
	grd


166 
pub
 
	gRawNode
<
	gT
: 
StÜage
> {

167 
pub
 
¿á
: 
Raá
<
T
>,

168 
	g´ev_ss
: 
SoáS‹
,

169 
	g´ev_hs
: 
H¬dS‹
,

172 
	gim¶
<
	gT
: 
StÜage
> 
RawNode
<
T
> {

174 
pub
 
â
 
Ãw
(
cÚfig
: &
CÚfig
, 
¡Üe
: 
T
, 
³”s
: &[
P“r
]è-> 
ResuÉ
<
RawNode
<T>> {

175 
as£¹_Ã
!(
cÚfig
.
id
, 0, "config.id must‚ot be zero");

176 
Ët
 
	gr
 = 
Raá
::
Ãw
(
cÚfig
, 
¡Üe
);

177 
Ët
 
mut
 
	gº
 = 
RawNode
 {

178 
¿á
: 
r
,

179 
´ev_hs
: 
DeçuÉ
::(),

180 
´ev_ss
: 
DeçuÉ
::(),

182 
Ët
 
	gÏ¡_šdex
 = 
º
.
¿á
.
g‘_¡Üe
().
Ï¡_šdex
().
ex³ù
("");

183 
	gÏ¡_šdex
 == 0 {

184 
º
.
¿á
.
become_fŞlow”
(1, 
INVALID_ID
);

185 
Ët
 
mut
 
	g’ts
 = 
Vec
::
w™h_ÿ·c™y
(
³”s
.
Ën
());

186 
	gi
, 
	g³”
è
š
 
	g³”s
.
™”
().
’um”©e
() {

187 
Ët
 
mut
 
	gcc
 = 
CÚfChªge
::
Ãw
();

188 
	gcc
.
£t_chªge_ty³
(
CÚfChªgeTy³
::
AddNode
);

189 
	gcc
.
£t_node_id
(
³”
.
id
);

190 
	g³”
.
	gcÚ‹xt
.
is_some
() {

191 
	gcc
.
£t_cÚ‹xt
(
³”
.
cÚ‹xt
.
as_»f
().
unw¿p
().
şÚe
());

193 
Ët
 
	gd©a
 =

194 
´Ùobuf
::
Mes§ge
::
wr™e_to_by‹s
(&
cc
).
ex³ù
("unexpected marshalƒrror");

195 
Ët
 
mut
 
	ge
 = 
EÁry
::
Ãw
();

196 
	ge
.
£t_’Œy_ty³
(
EÁryTy³
::
EÁryCÚfChªge
);

197 
	ge
.
£t_‹rm
(1);

198 
	ge
.
£t_šdex
(
i
 
as
 
u64
 + 1);

199 
	ge
.
£t_d©a
(
d©a
);

200 
	g’ts
.
push
(
e
);

202 
	gº
.
	g¿á
.
	g¿á_log
.
­³nd
(&
’ts
);

203 
	gº
.
	g¿á
.
	g¿á_log
.
	gcomm™‹d
 = 
’ts
.
Ën
(è
as
 
u64
;

204 
³”
 
š
 
	g³”s
 {

205 
	gº
.
	g¿á
.
add_node
(
³”
.
id
);

208 
	gº
.
	g´ev_ss
 = 
º
.
¿á
.
soá_¡©e
();

209 
	gÏ¡_šdex
 == 0 {

210 
º
.
´ev_hs
 = 
DeçuÉ
::();

212 
	gº
.
	g´ev_hs
 = 
º
.
¿á
.
h¬d_¡©e
();

214 
Ok
(
º
)

217 
â
 
comm™_»ady
(&
mut
 
£lf
, 
rd
: 
R—dy
) {

218 
rd
.
ss
.
is_some
() {

219 
£lf
.
´ev_ss
 = 
rd
.
ss
.
unw¿p
();

221 
Ët
 
Some
(
e
èğ
rd
.
hs
 {

222 
e
 !ğ
H¬dS‹
::
Ãw
() {

223 
£lf
.
´ev_hs
 = 
e
;

226 !
	grd
.
	g’Œ›s
.
is_em±y
() {

227 
Ët
 
	ge
 = 
rd
.
’Œ›s
.
Ï¡
().
unw¿p
();

228 
	g£lf
.
	g¿á
.
	g¿á_log
.
¡abË_to
(
e
.
g‘_šdex
(),ƒ.
g‘_‹rm
());

230 
	grd
.
	g¢­shÙ
 !ğ
SÇpshÙ
::
Ãw
() {

231 
£lf
.
¿á


232 .
¿á_log


233 .
¡abË_¢­_to
(
rd
.
¢­shÙ
.
g‘_m‘ad©a
().
g‘_šdex
());

235 !
	grd
.
	g»ad_¡©es
.
is_em±y
() {

236 
	g£lf
.
	g¿á
.
	g»ad_¡©es
.
ş—r
();

240 
â
 
comm™_­¶y
(&
mut
 
£lf
, 
­¶›d
: 
u64
) {

241 
£lf
.
¿á
.
¿á_log
.
­¶›d_to
(
­¶›d
);

247 
pub
 
â
 
tick
(&
mut
 
£lf
è-> 
	gboŞ
 {

248 
	g£lf
.
	g¿á
.
tick
()

252 
pub
 
â
 
ÿm·ign
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

253 
Ët
 
mut
 
	gm
 = 
Mes§ge
::
Ãw
();

254 
	gm
.
£t_msg_ty³
(
Mes§geTy³
::
MsgHup
);

255 
	g£lf
.
	g¿á
.
¡•
(
m
)

259 
pub
 
â
 
´İo£
(&
mut
 
£lf
, 
d©a
: 
Vec
<
u8
>, 
sync_log
: 
boŞ
è-> 
ResuÉ
<()> {

260 
Ët
 
mut
 
m
 = 
Mes§ge
::
Ãw
();

261 
	gm
.
£t_msg_ty³
(
Mes§geTy³
::
MsgPrİo£
);

262 
	gm
.
£t_äom
(
£lf
.
¿á
.
id
);

263 
Ët
 
mut
 
	ge
 = 
EÁry
::
Ãw
();

264 
	ge
.
£t_d©a
(
d©a
);

265 
	gsync_log
 {

266 
	ge
.
£t_sync_log
(
Œue
);

268 
	gm
.
£t_’Œ›s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
e
]));

269 
	g£lf
.
	g¿á
.
¡•
(
m
)

273 
pub
 
â
 
´İo£_cÚf_chªge
(&
mut
 
£lf
, 
cc
: 
CÚfChªge
è-> 
ResuÉ
<()> {

274 
Ët
 
d©a
 = 
box_Œy
!(
´Ùobuf
::
Mes§ge
::
wr™e_to_by‹s
(&
cc
));

275 
Ët
 
mut
 
	gm
 = 
Mes§ge
::
Ãw
();

276 
	gm
.
£t_msg_ty³
(
Mes§geTy³
::
MsgPrİo£
);

277 
Ët
 
mut
 
	ge
 = 
EÁry
::
Ãw
();

278 
	ge
.
£t_’Œy_ty³
(
EÁryTy³
::
EÁryCÚfChªge
);

279 
	ge
.
£t_d©a
(
d©a
);

280 
	ge
.
£t_sync_log
(
Œue
);

281 
	gm
.
£t_’Œ›s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
e
]));

282 
	g£lf
.
	g¿á
.
¡•
(
m
)

285 
pub
 
â
 
­¶y_cÚf_chªge
(&
mut
 
£lf
, 
cc
: &
CÚfChªge
è-> 
CÚfS‹
 {

286 
cc
.
g‘_node_id
(è=ğ
INVALID_ID
 {

287 
£lf
.
¿á
.
»£t_³ndšg_cÚf
();

288 
Ët
 
mut
 
	gcs
 = 
CÚfS‹
::
Ãw
();

289 
	gcs
.
£t_nodes
(
£lf
.
¿á
.
nodes
());

290  
	gcs
;

292 
Ët
 
	gnid
 = 
cc
.
g‘_node_id
();

293 
m©ch
 
	gcc
.
g‘_chªge_ty³
() {

294 
	gCÚfChªgeTy³
::
AddNode
 => 
£lf
.
¿á
.
add_node
(
nid
),

295 
	gCÚfChªgeTy³
::
RemoveNode
 => 
£lf
.
¿á
.
»move_node
(
nid
),

296 
	gCÚfChªgeTy³
::
AddL—º”Node
 => 
unim¶em’‹d
!(),

298 
Ët
 
mut
 
	gcs
 = 
CÚfS‹
::
Ãw
();

299 
	gcs
.
£t_nodes
(
£lf
.
¿á
.
nodes
());

300 
	gcs


304 
pub
 
â
 
¡•
(&
mut
 
£lf
, 
m
: 
Mes§ge
è-> 
ResuÉ
<()> {

306 
is_loÿl_msg
(
m
.
g‘_msg_ty³
()) {

307  
E¼
(
E¼Ü
::
S‹pLoÿlMsg
);

309 
	g£lf
.
	g¿á
.
	g´s
.
cÚšs_key
(&
m
.
g‘_äom
()è|| !
is_»¥Ú£_msg
(m.
g‘_msg_ty³
()) {

310  
	g£lf
.
	g¿á
.
¡•
(
m
);

312 
E¼
(
E¼Ü
::
S‹pP“rNÙFound
)

315 
pub
 
â
 
»ady_sšû
(&
mut
 
£lf
, 
­¶›d_idx
: 
u64
è-> 
R—dy
 {

316 
R—dy
::
Ãw
(

317 &
mut
 
£lf
.
¿á
,

318 &
£lf
.
´ev_ss
,

319 &
£lf
.
´ev_hs
,

320 
Some
(
­¶›d_idx
),

325 
pub
 
â
 
»ady
(&
mut
 
£lf
è-> 
	gR—dy
 {

326 
	gR—dy
::
Ãw
(&
mut
 
£lf
.
¿á
, &£lf.
´ev_ss
, &£lf.
´ev_hs
, 
NÚe
)

329 
pub
 
â
 
has_»ady_sšû
(&
£lf
, 
­¶›d_idx
: 
O±iÚ
<
u64
>è-> 
boŞ
 {

330 
Ët
 
¿á
 = &
£lf
.raft;

331 !
	g¿á
.
	gmsgs
.
is_em±y
(è||„aá.
	g¿á_log
.
un¡abË_’Œ›s
().
is_some
() {

332  
	gŒue
;

334 !
	g¿á
.
	g»ad_¡©es
.
is_em±y
() {

335  
	gŒue
;

337 
	g£lf
.
g‘_¢­
().
m­_Ü
(
çl£
, |
s
| !
is_em±y_¢­
(s)) {

338  
	gŒue
;

340 
Ët
 
	ghas_uÇµl›d_’Œ›s
 = 
m©ch
 
­¶›d_idx
 {

341 
NÚe
 => 
¿á
.
¿á_log
.
has_Ãxt_’Œ›s
(),

342 
Some
(
idx
è=> 
¿á
.
¿á_log
.
has_Ãxt_’Œ›s_sšû
(idx),

344 
	ghas_uÇµl›d_’Œ›s
 {

345  
	gŒue
;

347 
	g¿á
.
soá_¡©e
(è!ğ
£lf
.
´ev_ss
 {

348  
Œue
;

350 
Ët
 
	ghs
 = 
¿á
.
h¬d_¡©e
();

351 
	ghs
 !ğ
H¬dS‹
::
Ãw
(è&& 
hs
 !ğ
£lf
.
´ev_hs
 {

352  
Œue
;

354 
	gçl£


359 
pub
 
â
 
has_»ady
(&
£lf
è-> 
	gboŞ
 {

360 
	g£lf
.
has_»ady_sšû
(
NÚe
)

363 #[
šlše
]

364 
pub
 
â
 
g‘_¢­
(&
£lf
è-> 
	gO±iÚ
<&
	gSÇpshÙ
> {

365 
	g£lf
.
	g¿á
.
g‘_¢­
()

370 
pub
 
â
 
advªû
(&
mut
 
£lf
, 
rd
: 
R—dy
) {

371 
£lf
.
advªû_­³nd
(
rd
);

373 
Ët
 
	gcomm™_idx
 = 
£lf
.
´ev_hs
.
g‘_comm™
();

374 
	gcomm™_idx
 != 0 {

384 
£lf
.
advªû_­¶y
(
comm™_idx
);

388 
pub
 
â
 
advªû_­³nd
(&
mut
 
£lf
, 
rd
: 
R—dy
) {

389 
£lf
.
comm™_»ady
(
rd
);

392 
pub
 
â
 
advªû_­¶y
(&
mut
 
£lf
, 
­¶›d
: 
u64
) {

393 
£lf
.
comm™_­¶y
(
­¶›d
);

397 
pub
 
â
 
¡©us
(&
£lf
è-> 
	gStus
 {

398 
	gStus
::
Ãw
(&
£lf
.
¿á
)

402 
pub
 
â
 
»pÜt_uÄ—chabË
(&
mut
 
£lf
, 
id
: 
u64
) {

403 
Ët
 
mut
 
m
 = 
Mes§ge
::
Ãw
();

404 
	gm
.
£t_msg_ty³
(
Mes§geTy³
::
MsgUÄ—chabË
);

405 
	gm
.
£t_äom
(
id
);

407 
	g£lf
.
	g¿á
.
¡•
(
m
).
is_ok
();

411 
pub
 
â
 
»pÜt_¢­shÙ
(&
mut
 
£lf
, 
id
: 
u64
, 
¡©us
: 
SÇpshÙStus
) {

412 
Ët
 
»j
 = 
¡©us
 =ğ
SÇpshÙStus
::
Fau»
;

413 
Ët
 
mut
 
	gm
 = 
Mes§ge
::
Ãw
();

414 
	gm
.
£t_msg_ty³
(
Mes§geTy³
::
MsgSÇpStus
);

415 
	gm
.
£t_äom
(
id
);

416 
	gm
.
£t_»jeù
(
»j
);

418 
	g£lf
.
	g¿á
.
¡•
(
m
).
is_ok
();

422 
pub
 
â
 
Œªsãr_Ëad”
(&
mut
 
£lf
, 
Œªsã»e
: 
u64
) {

423 
Ët
 
mut
 
m
 = 
Mes§ge
::
Ãw
();

424 
	gm
.
£t_msg_ty³
(
Mes§geTy³
::
MsgT¿nsãrL—d”
);

425 
	gm
.
£t_äom
(
Œªsã»e
);

426 
	g£lf
.
	g¿á
.
¡•
(
m
).
is_ok
();

433 
pub
 
â
 
»ad_šdex
(&
mut
 
£lf
, 
rùx
: 
Vec
<
u8
>) {

434 
Ët
 
mut
 
m
 = 
Mes§ge
::
Ãw
();

435 
	gm
.
£t_msg_ty³
(
Mes§geTy³
::
MsgR—dIndex
);

436 
Ët
 
mut
 
	ge
 = 
EÁry
::
Ãw
();

437 
	ge
.
£t_d©a
(
rùx
);

438 
	gm
.
£t_’Œ›s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
e
]));

439 
	g£lf
.
	g¿á
.
¡•
(
m
).
is_ok
();

442 #[
šlše
]

443 
pub
 
â
 
g‘_¡Üe
(&
£lf
è-> &
	gT
 {

444 
	g£lf
.
	g¿á
.
g‘_¡Üe
()

447 #[
šlše
]

448 
pub
 
â
 
mut_¡Üe
(&
mut
 
£lf
è-> &muˆ
	gT
 {

449 
	g£lf
.
	g¿á
.
mut_¡Üe
()

453 #[
cfg
(
‹¡
)]

454 
mod
 
	g‹¡
 {

455 
u£
 
	gkv´Ùo
::
”aápb
::
Mes§geTy³
;

456 
u£
 
	gsu³r
::
is_loÿl_msg
;

458 #[
‹¡
]

459 
â
 
‹¡_is_loÿl_msg
() {

460 
Ët
 
	g‹¡s
 = 
vec
![

461 (
Mes§geTy³
::
MsgHup
, 
Œue
),

462 (
Mes§geTy³
::
MsgB—t
, 
Œue
),

463 (
Mes§geTy³
::
MsgUÄ—chabË
, 
Œue
),

464 (
Mes§geTy³
::
MsgSÇpStus
, 
Œue
),

465 (
Mes§geTy³
::
MsgCheckQuÜum
, 
Œue
),

466 (
Mes§geTy³
::
MsgPrİo£
, 
çl£
),

467 (
Mes§geTy³
::
MsgAµ’d
, 
çl£
),

468 (
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 
çl£
),

469 (
Mes§geTy³
::
MsgReque¡VÙe
, 
çl£
),

470 (
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£
, 
çl£
),

471 (
Mes§geTy³
::
MsgSÇpshÙ
, 
çl£
),

472 (
Mes§geTy³
::
MsgH—¹b—t
, 
çl£
),

473 (
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 
çl£
),

474 (
Mes§geTy³
::
MsgT¿nsãrL—d”
, 
çl£
),

475 (
Mes§geTy³
::
MsgTimeoutNow
, 
çl£
),

476 (
Mes§geTy³
::
MsgR—dIndex
, 
çl£
),

477 (
Mes§geTy³
::
MsgR—dIndexRe¥
, 
çl£
),

478 (
Mes§geTy³
::
MsgReque¡P»VÙe
, 
çl£
),

479 (
Mes§geTy³
::
MsgReque¡P»VÙeRe¥Ú£
, 
çl£
),

481 
	gmsg_ty³
, 
	g»suÉ
è
š
 
	g‹¡s
 {

482 
	gas£¹_eq
!(
is_loÿl_msg
(
msg_ty³
), 
	g»suÉ
);

	@src/raft/read_only.rs

28 
u£
 
	g¡d
::
cŞËùiÚs
::
VecDeque
;

30 
u£
 
	gkv´Ùo
::
”aápb
::
Mes§ge
;

32 
u£
 
	gsu³r
::{
HashM­
, 
	gHashS‘
};

34 #[
d”ive
(
Debug
, 
P¬tŸlEq
, 
ClÚe
, 
Cİy
)]

35 
pub
 
	eR—dOÆyO±iÚ
 {

38 
	mSaã
,

44 
	mL—£Ba£d
,

47 
im¶
 
DeçuÉ
 
	gR—dOÆyO±iÚ
 {

48 
â
 (è-> 
	gR—dOÆyO±iÚ
 {

49 
	gR—dOÆyO±iÚ
::
Saã


58 #[
d”ive
(
DeçuÉ
, 
Debug
, 
P¬tŸlEq
, 
ClÚe
)]

59 
pub
 
	sR—dS‹
 {

60 
pub
 
	mšdex
: 
u64
,

61 
pub
 
	m»que¡_ùx
: 
Vec
<
u8
>,

64 #[
d”ive
(
DeçuÉ
, 
Debug
, 
ClÚe
)]

65 
pub
 
	sR—dIndexStus
 {

66 
pub
 
	m»q
: 
Mes§ge
,

67 
pub
 
	mšdex
: 
u64
,

68 
pub
 
	macks
: 
HashS‘
<
u64
>,

71 #[
d”ive
(
DeçuÉ
, 
Debug
, 
ClÚe
)]

72 
pub
 
	sR—dOÆy
 {

73 
pub
 
	mİtiÚ
: 
R—dOÆyO±iÚ
,

74 
pub
 
	m³ndšg_»ad_šdex
: 
HashM­
<
Vec
<
u8
>, 
	mR—dIndexStus
>,

75 
pub
 
	m»ad_šdex_queue
: 
VecDeque
<
Vec
<
u8
>>,

78 
im¶
 
	gR—dOÆy
 {

79 
pub
 
â
 
Ãw
(
İtiÚ
: 
R—dOÆyO±iÚ
è-> 
R—dOÆy
 {

80 
R—dOÆy
 {

81 
İtiÚ
: option,

82 
	g³ndšg_»ad_šdex
: 
HashM­
::(),

83 
	g»ad_šdex_queue
: 
VecDeque
::
Ãw
(),

91 
pub
 
â
 
add_»que¡
(&
mut
 
£lf
, 
šdex
: 
u64
, 
m
: 
Mes§ge
) {

92 
Ët
 
ùx
 = 
m
.
g‘_’Œ›s
()[0].
g‘_d©a
().
to_vec
();

93 
	g£lf
.
	g³ndšg_»ad_šdex
.
cÚšs_key
(&
ùx
) {

96 
Ët
 
	g¡©us
 = 
R—dIndexStus
 {

97 
»q
: 
m
,

98 
šdex
: index,

99 
acks
: 
HashS‘
::(),

101 
	g£lf
.
	g³ndšg_»ad_šdex
.
š£¹
(
ùx
.
şÚe
(), 
¡©us
);

102 
	g£lf
.
	g»ad_šdex_queue
.
push_back
(
ùx
);

108 
pub
 
â
 
»cv_ack
(&
mut
 
£lf
, 
m
: &
Mes§ge
è-> 
usize
 {

109 
m©ch
 
£lf
.
³ndšg_»ad_šdex
.
g‘_mut
(
m
.
g‘_cÚ‹xt
()) {

110 
NÚe
 => 0,

111 
Some
(
rs
) => {

112 
rs
.
acks
.
š£¹
(
m
.
g‘_äom
());

114 
	grs
.
	gacks
.
Ën
() + 1

122 
pub
 
â
 
advªû
(&
mut
 
£lf
, 
m
: &
Mes§ge
è-> 
Vec
<
R—dIndexStus
> {

123 
Ët
 
mut
 
rss
 = 
vec
![];

124 
Ët
 
Some
(
i
èğ
£lf
.
»ad_šdex_queue
.
™”
().
pos™iÚ
(|
x
| {

125 !
£lf
.
³ndšg_»ad_šdex
.
cÚšs_key
(
x
) {

126 
·nic
!("cannot find correspond„ead state from…ending map");

128 *
x
 =ğ
m
.
g‘_cÚ‹xt
()

130 
_
 
	gš
 0..
	gi
 + 1 {

131 
Ët
 
	grs
 = 
£lf
.
»ad_šdex_queue
.
pİ_äÚt
().
unw¿p
();

132 
Ët
 
	g¡©us
 = 
£lf
.
³ndšg_»ad_šdex
.
»move
(&
rs
).
unw¿p
();

133 
	grss
.
push
(
¡©us
);

136 
	grss


141 
pub
 
â
 
Ï¡_³ndšg_»que¡_ùx
(&
£lf
è-> 
	gO±iÚ
<
	gVec
<
	gu8
>> {

142 
	g£lf
.
	g»ad_šdex_queue
.
back
().
şÚed
()

145 #[
šlše
]

146 
pub
 
â
 
³ndšg_»ad_couÁ
(&
£lf
è-> 
	gusize
 {

147 
	g£lf
.
	g»ad_šdex_queue
.
Ën
()

	@src/raft/status.rs

28 
u£
 
	gkv´Ùo
::
”aápb
::
H¬dS‹
;

30 
u£
 
	g¿á
::
¿á
::{
Raá
, 
	gSoáS‹
, 
	gS‹RŞe
};

31 
u£
 
	g¿á
::
¡Üage
::
StÜage
;

32 
u£
 
	g¿á
::
´og»ss
::
Prog»ss
;

34 
u£
 
	gsu³r
::
FÏtM­
;

36 #[
d”ive
(
DeçuÉ
)]

37 
pub
 
	sStus
 {

38 
pub
 
	mid
: 
u64
,

39 
pub
 
	mhs
: 
H¬dS‹
,

40 
pub
 
	mss
: 
SoáS‹
,

41 
pub
 
	m­¶›d
: 
u64
,

42 
pub
 
	m´og»ss
: 
FÏtM­
<
u64
, 
	mProg»ss
>,

45 
im¶
 
	gStus
 {

47 
pub
 
â
 
	gÃw
<
	gT
: 
StÜage
>(
¿á
: &
Raá
<
T
>è-> 
Stus
 {

48 
Ët
 
mut
 
s
 = 
Stus
 {

49 
id
: 
¿á
.id,

50 ..
DeçuÉ
::()

52 
	gs
.
	ghs
 = 
¿á
.
h¬d_¡©e
();

53 
	gs
.
	gss
 = 
¿á
.
soá_¡©e
();

54 
	gs
.
	g­¶›d
 = 
¿á
.
¿á_log
.
g‘_­¶›d
();

55 
	gs
.
	gss
.
	g¿á_¡©e
 =ğ
S‹RŞe
::
L—d”
 {

56 
s
.
´og»ss
 = 
¿á
.
´s
.
şÚe
();

58 
	gs


	@src/raft/storage.rs

29 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gRwLock
, 
	gRwLockR—dGu¬d
, 
	gRwLockWr™eGu¬d
};

31 
u£
 
	gkv´Ùo
::
”aápb
::{
CÚfS‹
, 
	gEÁry
, 
	gH¬dS‹
, 
	gSÇpshÙ
};

32 
u£
 
	g¿á
::
”rÜs
::{
E¼Ü
, 
	gResuÉ
, 
	gStÜageE¼Ü
};

33 
u£
 
	gut
::{
£lf
, 
	gHªdyRwLock
};

35 #[
d”ive
(
Debug
, 
ClÚe
)]

36 
pub
 
	sRaáS‹
 {

37 
pub
 
	mh¬d_¡©e
: 
H¬dS‹
,

38 
pub
 
	mcÚf_¡©e
: 
CÚfS‹
,

47 
pub
 
Œa™
 
	gStÜage
 {

49 
â
 
š™Ÿl_¡©e
(&
£lf
è-> 
	gResuÉ
<
	gRaáS‹
>;

53 
â
 
’Œ›s
(&
£lf
, 
low
: 
u64
, 
high
: u64, 
max_size
: u64è-> 
ResuÉ
<
Vec
<
EÁry
>>;

58 
â
 
‹rm
(&
£lf
, 
idx
: 
u64
è-> 
ResuÉ
<u64>;

63 
â
 
fœ¡_šdex
(&
£lf
è-> 
	gResuÉ
<
	gu64
>;

65 
â
 
Ï¡_šdex
(&
£lf
è-> 
	gResuÉ
<
	gu64
>;

70 
â
 
¢­shÙ
(&
£lf
è-> 
	gResuÉ
<
	gSÇpshÙ
>;

73 
pub
 
	sMemStÜageCÜe
 {

74 
	mh¬d_¡©e
: 
H¬dS‹
,

75 
	m¢­shÙ
: 
SÇpshÙ
,

78 
	m’Œ›s
: 
Vec
<
EÁry
>,

81 
im¶
 
DeçuÉ
 
	gMemStÜageCÜe
 {

82 
â
 (è-> 
	gMemStÜageCÜe
 {

83 
	gMemStÜageCÜe
 {

85 
	g’Œ›s
: 
vec
![
EÁry
::
Ãw
()],

86 
	gh¬d_¡©e
: 
H¬dS‹
::
Ãw
(),

87 
	g¢­shÙ
: 
SÇpshÙ
::
Ãw
(),

92 
im¶
 
	gMemStÜageCÜe
 {

94 
pub
 
â
 
£t_h¬d¡©e
(&
mut
 
£lf
, 
hs
: 
H¬dS‹
) {

95 
£lf
.
h¬d_¡©e
 = 
hs
;

98 
â
 
šÃr_Ï¡_šdex
(&
£lf
è-> 
	gu64
 {

99 
	g£lf
.
	g’Œ›s
[0].
g‘_šdex
(è+ s–f.’Œ›s.
Ën
(è
as
 
	gu64
 - 1

104 
pub
 
â
 
­¶y_¢­shÙ
(&
mut
 
£lf
, 
¢­shÙ
: 
SÇpshÙ
è-> 
ResuÉ
<()> {

106 
Ët
 
šdex
 = 
£lf
.
¢­shÙ
.
g‘_m‘ad©a
().
g‘_šdex
();

107 
Ët
 
	g¢­shÙ_šdex
 = 
¢­shÙ
.
g‘_m‘ad©a
().
g‘_šdex
();

108 
	gšdex
 >ğ
¢­shÙ_šdex
 {

109  
E¼
(
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
SÇpshÙOutOfD©e
));

112 
Ët
 
mut
 
	ge
 = 
EÁry
::
Ãw
();

113 
	ge
.
£t_‹rm
(
¢­shÙ
.
g‘_m‘ad©a
().
g‘_‹rm
());

114 
	ge
.
£t_šdex
(
¢­shÙ
.
g‘_m‘ad©a
().
g‘_šdex
());

115 
	g£lf
.
	g’Œ›s
 = 
vec
![
e
];

116 
	g£lf
.
	g¢­shÙ
 = 
¢­shÙ
;

117 
Ok
(())

124 
pub
 
â
 
ü—‹_¢­shÙ
(

125 &
mut
 
£lf
,

126 
idx
: 
u64
,

127 
cs
: 
O±iÚ
<
CÚfS‹
>,

128 
d©a
: 
Vec
<
u8
>,

129 è-> 
	gResuÉ
<&
	gSÇpshÙ
> {

130 
	gidx
 <ğ
£lf
.
¢­shÙ
.
g‘_m‘ad©a
().
g‘_šdex
() {

131  
E¼
(
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
SÇpshÙOutOfD©e
));

134 
Ët
 
	goff£t
 = 
£lf
.
’Œ›s
[0].
g‘_šdex
();

135 
	gidx
 > 
	g£lf
.
šÃr_Ï¡_šdex
() {

136 
	g·nic
!(

138 
	gidx
,

139 
	g£lf
.
šÃr_Ï¡_šdex
()

142 
	g£lf
.
	g¢­shÙ
.
mut_m‘ad©a
().
£t_šdex
(
idx
);

143 
	g£lf
.
	g¢­shÙ


144 .
mut_m‘ad©a
()

145 .
£t_‹rm
(
£lf
.
’Œ›s
[(
idx
 - 
off£t
è
as
 
usize
].
g‘_‹rm
());

146 
Ët
 
Some
(
cs
) = cs {

147 
£lf
.
¢­shÙ
.
mut_m‘ad©a
().
£t_cÚf_¡©e
(
cs
)

149 
£lf
.
¢­shÙ
.
£t_d©a
(
d©a
);

150 
Ok
(&
£lf
.
¢­shÙ
)

156 
pub
 
â
 
com·ù
(&
mut
 
£lf
, 
com·ù_šdex
: 
u64
è-> 
ResuÉ
<()> {

157 
Ët
 
off£t
 = 
£lf
.
’Œ›s
[0].
g‘_šdex
();

158 
	gcom·ù_šdex
 <ğ
off£t
 {

159  
E¼
(
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
));

161 
	gcom·ù_šdex
 > 
	g£lf
.
šÃr_Ï¡_šdex
() {

162 
	g·nic
!(

164 
	gcom·ù_šdex
,

165 
	g£lf
.
šÃr_Ï¡_šdex
()

169 
Ët
 
	gi
 = (
com·ù_šdex
 - 
off£t
è
as
 
usize
;

170 
Ët
 
	g’Œ›s
 = 
£lf
.
’Œ›s
.
d¿š
(
i
..).
cŞËù
();

171 
	g£lf
.
	g’Œ›s
 = 
’Œ›s
;

172 
Ok
(())

178 
pub
 
â
 
­³nd
(&
mut
 
£lf
, 
’ts
: &[
EÁry
]è-> 
ResuÉ
<()> {

179 
’ts
.
is_em±y
() {

180  
Ok
(());

182 
Ët
 
	gfœ¡
 = 
£lf
.
’Œ›s
[0].
g‘_šdex
() + 1;

183 
Ët
 
	gÏ¡
 = 
’ts
[0].
g‘_šdex
(è+ƒÁs.
Ën
(è
as
 
u64
 - 1;

185 
	gÏ¡
 < 
	gfœ¡
 {

186  
Ok
(());

189 
Ët
 
	g‹
: &[
EÁry
] = 
fœ¡
 > 
’ts
[0].
g‘_šdex
() {

190 
Ët
 
¡¬t
 = (
fœ¡
 - 
’ts
[0].
g‘_šdex
()è
as
 
usize
;

191 &
	g’ts
[
¡¬t
..
’ts
.
Ën
()]

193 
	g’ts


197 
Ët
 
	goff£t
 = 
‹
[0].
g‘_šdex
(è- 
£lf
.
’Œ›s
[0].get_index();

198 
	g£lf
.
	g’Œ›s
.
Ën
(è
as
 
	gu64
 > 
	goff£t
 {

199 
Ët
 
mut
 
	gÃw_’Œ›s
: 
Vec
<
EÁry
> = 
vec
![];

200 
	gÃw_’Œ›s
.
ex‹nd_äom_¦iû
(&
£lf
.
’Œ›s
[..
off£t
 
as
 
usize
]);

201 
	gÃw_’Œ›s
.
ex‹nd_äom_¦iû
(
‹
);

202 
	g£lf
.
	g’Œ›s
 = 
Ãw_’Œ›s
;

203 } 
	g£lf
.
	g’Œ›s
.
Ën
(è
as
 
	gu64
 =ğ
off£t
 {

204 
£lf
.
’Œ›s
.
ex‹nd_äom_¦iû
(
‹
);

206 
	g·nic
!(

208 
	g£lf
.
šÃr_Ï¡_šdex
(),

209 
	g‹
[0].
g‘_šdex
()

213 
Ok
(())

219 #[
d”ive
(
ClÚe
, 
DeçuÉ
)]

220 
pub
 
	sMemStÜage
 {

221 
	mcÜe
: 
Arc
<
RwLock
<
MemStÜageCÜe
>>,

224 
im¶
 
	gMemStÜage
 {

225 
pub
 
â
 
Ãw
(è-> 
	gMemStÜage
 {

226 
	gMemStÜage
 {

227 ..
	gDeçuÉ
::()

231 
pub
 
â
 
¾
(&
£lf
è-> 
RwLockR—dGu¬d
<
MemStÜageCÜe
> {

232 
£lf
.
cÜe
.
¾
()

235 
pub
 
â
 
wl
(&
£lf
è-> 
RwLockWr™eGu¬d
<
MemStÜageCÜe
> {

236 
£lf
.
cÜe
.
wl
()

240 
im¶
 
StÜage
 
MemStÜage
 {

242 
â
 
š™Ÿl_¡©e
(&
£lf
è-> 
ResuÉ
<
RaáS‹
> {

243 
Ët
 
cÜe
 = 
£lf
.
¾
();

244 
Ok
(
RaáS‹
 {

245 
h¬d_¡©e
: 
cÜe
.h¬d_¡©e.
şÚe
(),

246 
cÚf_¡©e
: 
cÜe
.
¢­shÙ
.
g‘_m‘ad©a
().
g‘_cÚf_¡©e
().
şÚe
(),

251 
â
 
’Œ›s
(&
£lf
, 
low
: 
u64
, 
high
: u64, 
max_size
: u64è-> 
ResuÉ
<
Vec
<
EÁry
>> {

252 
Ët
 
cÜe
 = 
£lf
.
¾
();

253 
Ët
 
	goff£t
 = 
cÜe
.
’Œ›s
[0].
g‘_šdex
();

254 
	glow
 <ğ
off£t
 {

255  
E¼
(
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
));

258 
	ghigh
 > 
	gcÜe
.
šÃr_Ï¡_šdex
() + 1 {

259 
	g·nic
!("index out of bound")

262 
	gcÜe
.
	g’Œ›s
.
Ën
() == 1 {

263  
E¼
(
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
UÇvaabË
));

266 
Ët
 
	glo
 = (
low
 - 
off£t
è
as
 
usize
;

267 
Ët
 
	ghi
 = (
high
 - 
off£t
è
as
 
usize
;

268 
Ët
 
mut
 
	g’ts
 = 
cÜe
.
’Œ›s
[
lo
..
hi
].
to_vec
();

269 
	gut
::
lim™_size
(&
mut
 
’ts
, 
max_size
);

270 
Ok
(
’ts
)

274 
â
 
‹rm
(&
£lf
, 
idx
: 
u64
è-> 
ResuÉ
<u64> {

275 
Ët
 
cÜe
 = 
£lf
.
¾
();

276 
Ët
 
	goff£t
 = 
cÜe
.
’Œ›s
[0].
g‘_šdex
();

277 
	gidx
 < 
	goff£t
 {

278  
E¼
(
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
));

280 
	gidx
 - 
	goff£t
 >ğ
cÜe
.
’Œ›s
.
Ën
(è
as
 
u64
 {

281  
E¼
(
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
UÇvaabË
));

283 
Ok
(
cÜe
.
’Œ›s
[(
idx
 - 
off£t
è
as
 
usize
].
g‘_‹rm
())

287 
â
 
fœ¡_šdex
(&
£lf
è-> 
	gResuÉ
<
	gu64
> {

288 
Ët
 
	gcÜe
 = 
£lf
.
¾
();

289 
Ok
(
cÜe
.
’Œ›s
[0].
g‘_šdex
() + 1)

293 
â
 
Ï¡_šdex
(&
£lf
è-> 
	gResuÉ
<
	gu64
> {

294 
Ët
 
	gcÜe
 = 
£lf
.
¾
();

295 
Ok
(
cÜe
.
šÃr_Ï¡_šdex
())

299 
â
 
¢­shÙ
(&
£lf
è-> 
	gResuÉ
<
	gSÇpshÙ
> {

300 
Ët
 
	gcÜe
 = 
£lf
.
¾
();

301 
Ok
(
cÜe
.
¢­shÙ
.
şÚe
())

305 #[
cfg
(
‹¡
)]

306 
mod
 
	g‹¡
 {

307 
u£
 
	g´Ùobuf
;

308 
u£
 
	gkv´Ùo
::
”aápb
::{
CÚfS‹
, 
	gEÁry
, 
	gSÇpshÙ
};

309 
u£
 
	g¿á
::{
E¼Ü
 
as
 
RaáE¼Ü
, 
	gStÜageE¼Ü
};

310 
u£
 
	g¿á
::
¡Üage
::{
MemStÜage
, 
	gStÜage
};

314 
â
 
Ãw_’Œy
(
šdex
: 
u64
, 
‹rm
: u64è-> 
EÁry
 {

315 
Ët
 
mut
 
e
 = 
EÁry
::
Ãw
();

316 
	ge
.
£t_‹rm
(
‹rm
);

317 
	ge
.
£t_šdex
(
šdex
);

318 
	ge


321 
â
 
	gsize_of
<
	gT
: 
´Ùobuf
::
Mes§ge
>(
m
: &
T
è-> 
u32
 {

322 
m
.
compu‹_size
()

325 
â
 
Ãw_¢­shÙ
(
šdex
: 
u64
, 
‹rm
: u64, 
nodes
: 
Vec
<u64>, 
d©a
: Vec<
u8
>è-> 
SÇpshÙ
 {

326 
Ët
 
mut
 
s
 = 
SÇpshÙ
::
Ãw
();

327 
	gs
.
mut_m‘ad©a
().
£t_šdex
(
šdex
);

328 
	gs
.
mut_m‘ad©a
().
£t_‹rm
(
‹rm
);

329 
	gs
.
mut_m‘ad©a
().
mut_cÚf_¡©e
().
£t_nodes
(
nodes
);

330 
	gs
.
£t_d©a
(
d©a
);

331 
	gs


334 #[
‹¡
]

335 
â
 
‹¡_¡Üage_‹rm
() {

336 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

337 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

338 (2, 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
))),

339 (3, 
Ok
(3)),

340 (4, 
Ok
(4)),

341 (5, 
Ok
(5)),

342 (6, 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
UÇvaabË
))),

345 
	gi
, (
	gidx
, 
	gw‹rm
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

346 
Ët
 
	g¡Üage
 = 
MemStÜage
::
Ãw
();

347 
	g¡Üage
.
wl
().
	g’Œ›s
 = 
’ts
.
şÚe
();

349 
Ët
 
	gt
 = 
¡Üage
.
‹rm
(
idx
);

350 
	gt
 !ğ
w‹rm
 {

351 
·nic
!("#{}:ƒx³ù„e {:?}, gÙ {:?}", 
i
, 
w‹rm
, 
t
);

356 #[
‹¡
]

357 
â
 
‹¡_¡Üage_’Œ›s
() {

358 
Ët
 
	g’ts
 = 
vec
![

359 
Ãw_’Œy
(3, 3),

360 
Ãw_’Œy
(4, 4),

361 
Ãw_’Œy
(5, 5),

362 
Ãw_’Œy
(6, 6),

364 
Ët
 
	gmax_u64
 = 
u64
::
max_v®ue
();

365 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

369 
max_u64
,

370 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
)),

375 
max_u64
,

376 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
)),

378 (4, 5, 
max_u64
, 
Ok
(
vec
![
Ãw_’Œy
(4, 4)])),

379 (4, 6, 
	gmax_u64
, 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5)])),

383 
	gmax_u64
,

384 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5),‚ew_entry(6, 6)]),

387 (4, 7, 0, 
Ok
(
vec
![
Ãw_’Œy
(4, 4)])),

392 (
size_of
(&
’ts
[1]è+ size_of(&’ts[2])è
as
 
	gu64
,

393 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5)]),

398 (
size_of
(&
’ts
[1]è+ size_of(&’ts[2]è+ size_of(&’ts[3]è/ 2è
as
 
	gu64
,

399 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5)]),

404 (
size_of
(&
’ts
[1]è+ size_of(&’ts[2]è+ size_of(&’ts[3]è- 1è
as
 
	gu64
,

405 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5)]),

411 (
size_of
(&
’ts
[1]è+ size_of(&’ts[2]è+ size_of(&’ts[3])è
as
 
	gu64
,

412 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5),‚ew_entry(6, 6)]),

415 
	gi
, (
	glo
, 
	ghi
, 
	gmaxsize
, 
	gw’Œ›s
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

416 
Ët
 
	g¡Üage
 = 
MemStÜage
::
Ãw
();

417 
	g¡Üage
.
wl
().
	g’Œ›s
 = 
’ts
.
şÚe
();

418 
Ët
 
	ge
 = 
¡Üage
.
’Œ›s
(
lo
, 
hi
, 
maxsize
);

419 
	ge
 !ğ
w’Œ›s
 {

420 
·nic
!("#{}:ƒx³ùƒÁr› {:?}, gÙ {:?}", 
i
, 
w’Œ›s
, 
e
);

425 #[
‹¡
]

426 
â
 
‹¡_¡Üage_Ï¡_šdex
() {

427 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

428 
Ët
 
	g¡Üage
 = 
MemStÜage
::
Ãw
();

429 
	g¡Üage
.
wl
().
	g’Œ›s
 = 
’ts
;

431 
Ët
 
	gw»suÉ
 = 
Ok
(5);

432 
Ët
 
	g»suÉ
 = 
¡Üage
.
Ï¡_šdex
();

433 
	g»suÉ
 !ğ
w»suÉ
 {

434 
·nic
!("wªˆ{:?}, gÙ {:?}", 
w»suÉ
, 
»suÉ
);

437 
	g¡Üage


438 .
wl
()

439 .
­³nd
(&[
Ãw_’Œy
(6, 5)])

440 .
ex³ù
("append failed");

441 
Ët
 
	gw»suÉ
 = 
Ok
(6);

442 
Ët
 
	g»suÉ
 = 
¡Üage
.
Ï¡_šdex
();

443 
	g»suÉ
 !ğ
w»suÉ
 {

444 
·nic
!("wªˆ{:?}, gÙ {:?}", 
w»suÉ
, 
»suÉ
);

448 #[
‹¡
]

449 
â
 
‹¡_¡Üage_fœ¡_šdex
() {

450 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

451 
Ët
 
	g¡Üage
 = 
MemStÜage
::
Ãw
();

452 
	g¡Üage
.
wl
().
	g’Œ›s
 = 
’ts
;

454 
Ët
 
	gw»suÉ
 = 
Ok
(4);

455 
Ët
 
	g»suÉ
 = 
¡Üage
.
fœ¡_šdex
();

456 
	g»suÉ
 !ğ
w»suÉ
 {

457 
·nic
!("wªˆ{:?}, gÙ {:?}", 
w»suÉ
, 
»suÉ
);

460 
	g¡Üage
.
wl
().
com·ù
(4).
ex³ù
("compact failed");

461 
Ët
 
	gw»suÉ
 = 
Ok
(5);

462 
Ët
 
	g»suÉ
 = 
¡Üage
.
fœ¡_šdex
();

463 
	g»suÉ
 !ğ
w»suÉ
 {

464 
·nic
!("wªˆ{:?}, gÙ {:?}", 
w»suÉ
, 
»suÉ
);

468 #[
‹¡
]

469 
â
 
‹¡_¡Üage_com·ù
() {

470 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

471 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

472 (2, 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
)), 3, 3, 3),

473 (3, 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
)), 3, 3, 3),

474 (4, 
Ok
(()), 4, 4, 2),

475 (5, 
Ok
(()), 5, 5, 1),

477 
	gi
, (
	gidx
, 
	gw»suÉ
, 
	gwšdex
, 
	gw‹rm
, 
	gwËn
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

478 
Ët
 
	g¡Üage
 = 
MemStÜage
::
Ãw
();

479 
	g¡Üage
.
wl
().
	g’Œ›s
 = 
’ts
.
şÚe
();

481 
Ët
 
	g»suÉ
 = 
¡Üage
.
wl
().
com·ù
(
idx
);

482 
	g»suÉ
 !ğ
w»suÉ
 {

483 
·nic
!("#{}: wªˆ{:?}, gÙ {:?}", 
i
, 
w»suÉ
, 
»suÉ
);

485 
Ët
 
	gšdex
 = 
¡Üage
.
wl
().
’Œ›s
[0].
g‘_šdex
();

486 
	gšdex
 !ğ
wšdex
 {

487 
·nic
!("#{}: wªˆ{}, index {}", 
i
, 
wšdex
, 
šdex
);

489 
Ët
 
	g‹rm
 = 
¡Üage
.
wl
().
’Œ›s
[0].
g‘_‹rm
();

490 
	g‹rm
 !ğ
w‹rm
 {

491 
·nic
!("#{}: wªˆ{},”m {}", 
i
, 
w‹rm
, 
‹rm
);

493 
Ët
 
	gËn
 = 
¡Üage
.
wl
().
’Œ›s
.
Ën
();

494 
	gËn
 !ğ
wËn
 {

495 
·nic
!("#{}: wªˆ{},”m {}", 
i
, 
wËn
, 
Ën
);

500 #[
‹¡
]

501 
â
 
‹¡_¡Üage_ü—‹_¢­shÙ
() {

502 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

503 
Ët
 
	gnodes
 = 
vec
![1, 2, 3];

504 
Ët
 
mut
 
	gcs
 = 
CÚfS‹
::
Ãw
();

505 
	gcs
.
£t_nodes
(
nodes
.
şÚe
());

506 
Ët
 
	gd©a
 = 
b
"d©a".
to_vec
();

508 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

509 (4, 
Ok
(
Ãw_¢­shÙ
(4, 4, 
nodes
.
şÚe
(), 
d©a
.clone()))),

510 (5, 
Ok
(
Ãw_¢­shÙ
(5, 5, 
nodes
.
şÚe
(), 
d©a
.clone()))),

512 
	gi
, (
	gidx
, 
	gw»suÉ
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

513 
Ët
 
	g¡Üage
 = 
MemStÜage
::
Ãw
();

514 
	g¡Üage
.
wl
().
	g’Œ›s
 = 
’ts
.
şÚe
();

516 
	g¡Üage


517 .
wl
()

518 .
ü—‹_¢­shÙ
(
idx
, 
Some
(
cs
.
şÚe
()), 
d©a
.clone())

519 .
ex³ù
("create snapshot failed");

520 
Ët
 
	g»suÉ
 = 
¡Üage
.
¢­shÙ
();

521 
	g»suÉ
 !ğ
w»suÉ
 {

522 
·nic
!("#{}: wªˆ{:?}, gÙ {:?}", 
i
, 
w»suÉ
, 
»suÉ
);

527 #[
‹¡
]

528 
â
 
‹¡_¡Üage_­³nd
() {

529 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

530 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

532 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)],

533 
Ok
(()),

534 
	gvec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)],

537 
	gvec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 6),‚ew_entry(5, 6)],

538 
Ok
(()),

539 
	gvec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 6),‚ew_entry(5, 6)],

542 
	gvec
![

543 
Ãw_’Œy
(3, 3),

544 
Ãw_’Œy
(4, 4),

545 
Ãw_’Œy
(5, 5),

546 
Ãw_’Œy
(6, 5),

548 
Ok
(()),

549 
	gvec
![

550 
Ãw_’Œy
(3, 3),

551 
Ãw_’Œy
(4, 4),

552 
Ãw_’Œy
(5, 5),

553 
Ãw_’Œy
(6, 5),

558 
	gvec
![
Ãw_’Œy
(2, 3),‚ew_entry(3, 3),‚ew_entry(4, 5)],

559 
Ok
(()),

560 
	gvec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 5)],

564 
	gvec
![
Ãw_’Œy
(4, 5)],

565 
Ok
(()),

566 
	gvec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 5)],

570 
	gvec
![
Ãw_’Œy
(6, 6)],

571 
Ok
(()),

572 
	gvec
![

573 
Ãw_’Œy
(3, 3),

574 
Ãw_’Œy
(4, 4),

575 
Ãw_’Œy
(5, 5),

576 
Ãw_’Œy
(6, 6),

580 
	gi
, (
	g’Œ›s
, 
	gw»suÉ
, 
	gw’Œ›s
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

581 
Ët
 
	g¡Üage
 = 
MemStÜage
::
Ãw
();

582 
	g¡Üage
.
wl
().
	g’Œ›s
 = 
’ts
.
şÚe
();

584 
Ët
 
	g»suÉ
 = 
¡Üage
.
wl
().
­³nd
(&
’Œ›s
);

585 
	g»suÉ
 !ğ
w»suÉ
 {

586 
·nic
!("#{}: wªˆ{:?}, gÙ {:?}", 
i
, 
w»suÉ
, 
»suÉ
);

588 
Ët
 
	ge
 = &
¡Üage
.
wl
().
’Œ›s
;

589 *
	ge
 !ğ
w’Œ›s
 {

590 
·nic
!("#{}: wªˆ{:?},ƒÁr› {:?}", 
i
, 
w’Œ›s
, 
e
);

595 #[
‹¡
]

596 
â
 
‹¡_¡Üage_­¶y_¢­shÙ
() {

597 
Ët
 
	gnodes
 = 
vec
![1, 2, 3];

598 
Ët
 
	gd©a
 = 
b
"d©a".
to_vec
();

600 
Ët
 
	g¢­shÙs
 = 
vec
![

601 
Ãw_¢­shÙ
(4, 4, 
nodes
.
şÚe
(), 
d©a
.clone()),

602 
Ãw_¢­shÙ
(3, 3, 
nodes
.
şÚe
(), 
d©a
.clone()),

605 
Ët
 
	g¡Üage
 = 
MemStÜage
::
Ãw
();

608 
Ët
 
	gi
 = 0;

609 
Ët
 
	gw»suÉ
 = 
Ok
(());

610 
Ët
 
	gr
 = 
¡Üage
.
wl
().
­¶y_¢­shÙ
(
¢­shÙs
[
i
].
şÚe
());

611 
	gr
 !ğ
w»suÉ
 {

612 
·nic
!("#{}: wªˆ{:?}, gÙ {:?}", 
i
, 
w»suÉ
, 
r
);

616 
Ët
 
	gi
 = 1;

617 
Ët
 
	gw»suÉ
 = 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
SÇpshÙOutOfD©e
));

618 
Ët
 
	gr
 = 
¡Üage
.
wl
().
­¶y_¢­shÙ
(
¢­shÙs
[
i
].
şÚe
());

619 
	gr
 !ğ
w»suÉ
 {

620 
·nic
!("#{}: wªˆ{:?}, gÙ {:?}", 
i
, 
w»suÉ
, 
r
);

	@src/raftstore/coprocessor/config.rs

14 
u£
 
	gut
::
cÚfig
::
R—dabËSize
;

15 
u£
 
	gsu³r
::
ResuÉ
;

17 #[
d”ive
(
ClÚe
, 
Debug
, 
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
)]

18 #[
£rde
()]

19 #[
£rde
(
»Çme_®l
 = "kebab-case")]

20 
pub
 
	sCÚfig
 {

23 
pub
 
	m¥l™_»giÚ_Ú_bË
: 
boŞ
,

28 
pub
 
	m»giÚ_max_size
: 
R—dabËSize
,

29 
pub
 
	m»giÚ_¥l™_size
: 
R—dabËSize
,

33 
pub
 cÚ¡ 
	gSPLIT_SIZE_MB
: 
u64
 = 96;

35 
im¶
 
DeçuÉ
 
	gCÚfig
 {

36 
â
 (è-> 
	gCÚfig
 {

37 
Ët
 
	g¥l™_size
 = 
R—dabËSize
::
mb
(
SPLIT_SIZE_MB
);

38 
	gCÚfig
 {

39 
	g¥l™_»giÚ_Ú_bË
: 
çl£
,

40 
	g»giÚ_¥l™_size
: 
¥l™_size
,

41 
	g»giÚ_max_size
: 
¥l™_size
 / 2 * 3,

46 
im¶
 
	gCÚfig
 {

47 
pub
 
â
 
v®id©e
(&
£lf
è-> 
	gResuÉ
<()> {

48 
	g£lf
.
	g»giÚ_max_size
.0 < s–f.
	g»giÚ_¥l™_size
.0 {

49  
E¼
(
box_”r
!(

51 
£lf
.
»giÚ_max_size
.0,

52 
£lf
.
»giÚ_¥l™_size
.0

56 
Ok
(())

60 #[
cfg
(
‹¡
)]

61 
mod
 
	g‹¡s
 {

62 
u£
 
	gsu³r
::*;

64 #[
‹¡
]

65 
â
 
‹¡_cÚfig_v®id©e
() {

66 
Ët
 
mut
 
	gcfg
 = 
CÚfig
::();

67 
	gcfg
.
v®id©e
().
unw¿p
();

69 
	gcfg
 = 
CÚfig
::();

70 
	gcfg
.
	g»giÚ_max_size
 = 
R—dabËSize
(10);

71 
	gcfg
.
	g»giÚ_¥l™_size
 = 
R—dabËSize
(20);

72 
	gas£¹
!(
	gcfg
.
v®id©e
().
is_”r
());

	@src/raftstore/coprocessor/dispatcher.rs

15 
u£
 
	grocksdb
::
DB
;

17 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
RaáCmdReque¡
, 
	gRaáCmdRe¥Ú£
};

18 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

20 
u£
 
	gut
::
Œª¥Üt
::{
R‘ryabËS’dCh
, 
	gS’d”
};

21 
u£
 
	g¿á¡Üe
::
¡Üe
::
msg
::
Msg
;

23 
u£
 
	gsu³r
::*;

25 
	gEÁry
<
	gT
> {

26 
	g´iÜ™y
: 
u32
,

27 
	gob£rv”
: 
T
,

31 
pub
 
ty³
 
	gBoxAdmšOb£rv”
 = 
Box
<
AdmšOb£rv”
 + 
S’d
 + 
Sync
>;

32 
pub
 
ty³
 
	gBoxQu”yOb£rv”
 = 
Box
<
Qu”yOb£rv”
 + 
S’d
 + 
Sync
>;

33 
pub
 
ty³
 
	gBoxS¶™CheckOb£rv”
 = 
Box
<
S¶™CheckOb£rv”
 + 
S’d
 + 
Sync
>;

36 #[
d”ive
(
DeçuÉ
)]

37 
pub
 
	sRegi¡ry
 {

38 
	madmš_ob£rv”s
: 
Vec
<
EÁry
<
BoxAdmšOb£rv”
>>,

39 
	mqu”y_ob£rv”s
: 
Vec
<
EÁry
<
BoxQu”yOb£rv”
>>,

40 
	m¥l™_check_ob£rv”s
: 
Vec
<
EÁry
<
BoxS¶™CheckOb£rv”
>>,

44 
	gmaüo_ruËs
! 
	gpush
 {

45 (
	g$p
:
ex´
, 
	g$t
:
id’t
, 
	g$vec
:expr) => {

46 
$t
.
¡¬t
();

47 
Ët
 
	ge
 = 
EÁry
 { 
´iÜ™y
: 
$p
, 
ob£rv”
: 
$t
 };

48 
Ët
 
	gvec
 = &
mut
 
$vec
;

49 
	gvec
.
push
(
e
);

50 
	gvec
.
sÜt_by
(|
l
, 
r
|†.
´iÜ™y
.
cmp
(&r.priority));

54 
im¶
 
	gRegi¡ry
 {

55 
pub
 
â
 
»gi¡”_admš_ob£rv”
(&
mut
 
£lf
, 
´iÜ™y
: 
u32
, 
ao
: 
BoxAdmšOb£rv”
) {

56 
push
!(
´iÜ™y
, 
	gao
, 
	g£lf
.
	gadmš_ob£rv”s
);

59 
pub
 
â
 
»gi¡”_qu”y_ob£rv”
(&
mut
 
£lf
, 
´iÜ™y
: 
u32
, 
qo
: 
BoxQu”yOb£rv”
) {

60 
push
!(
´iÜ™y
, 
	gqo
, 
	g£lf
.
	gqu”y_ob£rv”s
);

63 
pub
 
â
 
»gi¡”_¥l™_check_ob£rv”
(&
mut
 
£lf
, 
´iÜ™y
: 
u32
, 
sco
: 
BoxS¶™CheckOb£rv”
) {

64 
push
!(
´iÜ™y
, 
	gsco
, 
	g£lf
.
	g¥l™_check_ob£rv”s
);

69 #[
d”ive
(
DeçuÉ
)]

70 
pub
 
	sCİroûssÜHo¡
 {

71 
pub
 
	m»gi¡ry
: 
Regi¡ry
,

74 
im¶
 
	gCİroûssÜHo¡
 {

75 
pub
 
â
 
	gÃw
<
	gC
: 
S’d”
<
Msg
> + 
S’d
 + 
Sync
 + 'static>(

76 
cfg
: 
CÚfig
,

77 
	gch
: 
R‘ryabËS’dCh
<
Msg
, 
	gC
>,

78 è-> 
	gCİroûssÜHo¡
 {

79 
Ët
 
mut
 
	g»gi¡ry
 = 
Regi¡ry
::();

80 
Ët
 
	g¥l™_size_check_ob£rv”
 =

81 
SizeCheckOb£rv”
::
Ãw
(
cfg
.
»giÚ_max_size
.0, cfg.
»giÚ_¥l™_size
.0, 
ch
);

82 
	g»gi¡ry
.
»gi¡”_¥l™_check_ob£rv”
(

83 
SIZE_CHECK_OBSERVER_PRIORITY
,

84 
Box
::
Ãw
(
¥l™_size_check_ob£rv”
),

86 
	gcfg
.
	g¥l™_»giÚ_Ú_bË
 {

87 
	g»gi¡ry
.
»gi¡”_¥l™_check_ob£rv”
(

88 
TABLE_CHECK_OBSERVER_PRIORITY
,

89 
Box
::
Ãw
(
TabËCheckOb£rv”
::()),

92 
	gCİroûssÜHo¡
 { 
	g»gi¡ry
: 
»gi¡ry
 }

96 
pub
 
â
 
´e_´İo£
(&
£lf
, 
»giÚ
: &
RegiÚ
, 
»q
: &
mut
 
RaáCmdReque¡
è-> 
ResuÉ
<()> {

97 
Ët
 
mut
 
ùx
 = 
Ob£rv”CÚ‹xt
::
Ãw
(
»giÚ
);

98 !
	g»q
.
has_admš_»que¡
() {

99 
o
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	gqu”y_ob£rv”s
 {

100 
	go
.
	gob£rv”
.
´e_´İo£_qu”y
(&
mut
 
ùx
, 
»q
.
mut_»que¡s
())?;

101 
	gùx
.
	gby·ss
 {

102  
Ok
(());

106 
o
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	gadmš_ob£rv”s
 {

107 
	go
.
	gob£rv”


108 .
´e_´İo£_admš
(&
mut
 
ùx
, 
»q
.
mut_admš_»que¡
())?;

109 
	gùx
.
	gby·ss
 {

110  
Ok
(());

114 
Ok
(())

118 
pub
 
â
 
´e_­¶y
(&
£lf
, 
»giÚ
: &
RegiÚ
, 
»q
: &
RaáCmdReque¡
) {

119 
Ët
 
mut
 
ùx
 = 
Ob£rv”CÚ‹xt
::
Ãw
(
»giÚ
);

120 !
	g»q
.
has_admš_»que¡
() {

121 
o
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	gqu”y_ob£rv”s
 {

122 
	go
.
	gob£rv”
.
´e_­¶y_qu”y
(&
mut
 
ùx
, 
»q
.
g‘_»que¡s
());

123 
	gùx
.
	gby·ss
 {

128 
o
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	gadmš_ob£rv”s
 {

129 
	go
.
	gob£rv”


130 .
´e_­¶y_admš
(&
mut
 
ùx
, 
»q
.
g‘_admš_»que¡
());

131 
	gùx
.
	gby·ss
 {

138 
pub
 
â
 
po¡_­¶y
(&
£lf
, 
»giÚ
: &
RegiÚ
, 
»¥
: &
mut
 
RaáCmdRe¥Ú£
) {

139 
Ët
 
mut
 
ùx
 = 
Ob£rv”CÚ‹xt
::
Ãw
(
»giÚ
);

140 !
	g»¥
.
has_admš_»¥Ú£
() {

141 
o
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	gqu”y_ob£rv”s
 {

142 
	go
.
	gob£rv”
.
po¡_­¶y_qu”y
(&
mut
 
ùx
, 
»¥
.
mut_»¥Ú£s
());

143 
	gùx
.
	gby·ss
 {

148 
o
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	gadmš_ob£rv”s
 {

149 
	go
.
	gob£rv”


150 .
po¡_­¶y_admš
(&
mut
 
ùx
, 
»¥
.
mut_admš_»¥Ú£
());

151 
	gùx
.
	gby·ss
 {

158 
pub
 
â
 
Ãw_¥l™_check_¡©us
(&
£lf
, 
»giÚ
: &
RegiÚ
, 
’gše
: &
DB
è-> 
S¶™CheckStus
 {

159 
Ët
 
mut
 
ob_ùx
 = 
Ob£rv”CÚ‹xt
::
Ãw
(
»giÚ
);

160 
Ët
 
mut
 
	g¥l™_¡©us
 = 
S¶™CheckStus
::();

161 
’Œy
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	g¥l™_check_ob£rv”s
 {

162 
	g’Œy


163 .
	gob£rv”


164 .
Ãw_¥l™_check_¡©us
(&
mut
 
ob_ùx
, &muˆ
¥l™_¡©us
, 
’gše
);

166 
	g¥l™_¡©us


170 
pub
 
â
 
Ú_¥l™_check
(

171 &
£lf
,

172 
»giÚ
: &
RegiÚ
,

173 
¥l™_¡©us
: &
mut
 
S¶™CheckStus
,

174 
key
: &[
u8
],

175 
v®ue_size
: 
u64
,

176 è-> 
	gO±iÚ
<
	gVec
<
	gu8
>> {

177 
Ët
 
mut
 
	gob_ùx
 = 
Ob£rv”CÚ‹xt
::
Ãw
(
»giÚ
);

178 
’Œy
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	g¥l™_check_ob£rv”s
 {

179 
Ët
 
Some
(
¥l™_key
èğ
’Œy


180 .
ob£rv”


181 .
Ú_¥l™_check
(&
mut
 
ob_ùx
, 
¥l™_¡©us
, 
key
, 
v®ue_size
)

183  
Some
(
¥l™_key
);

186 
	gNÚe


189 
pub
 
â
 
shutdown
(&
£lf
) {

190 
’Œy
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	gadmš_ob£rv”s
 {

191 
	g’Œy
.
	gob£rv”
.
¡İ
();

193 
’Œy
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	gqu”y_ob£rv”s
 {

194 
	g’Œy
.
	gob£rv”
.
¡İ
();

196 
’Œy
 
	gš
 &
	g£lf
.
	g»gi¡ry
.
	g¥l™_check_ob£rv”s
 {

197 
	g’Œy
.
	gob£rv”
.
¡İ
();

202 #[
cfg
(
‹¡
)]

203 
mod
 
	g‹¡
 {

204 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::*;

205 
u£
 
	g¡d
::
sync
::*;

206 
u£
 
	g¡d
::
sync
::
©omic
::*;

207 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

209 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

210 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
AdmšReque¡
, 
	gAdmšRe¥Ú£
, 
	gRaáCmdReque¡
, 
	gRaáCmdRe¥Ú£
,

211 
	gReque¡
, 
	gRe¥Ú£
};

213 #[
d”ive
(
ClÚe
, 
DeçuÉ
)]

214 
	sTe¡CİroûssÜ
 {

215 
	gby·ss
: 
Arc
<
AtomicBoŞ
>,

216 
	gÿÎed
: 
Arc
<
AtomicUsize
>,

217 
	g»tuº_”r
: 
Arc
<
AtomicBoŞ
>,

220 
im¶
 
CİroûssÜ
 
	gTe¡CİroûssÜ
 {}

222 
im¶
 
AdmšOb£rv”
 
	gTe¡CİroûssÜ
 {

223 
â
 
´e_´İo£_admš
(&
£lf
, 
ùx
: &
mut
 
Ob£rv”CÚ‹xt
, 
_
: &muˆ
AdmšReque¡
è-> 
ResuÉ
<()> {

224 
£lf
.
ÿÎed
.
ãtch_add
(1, 
Ord”šg
::
SeqC¡
);

225 
	gùx
.
	gby·ss
 = 
£lf
.
by·ss
.
lßd
(
Ord”šg
::
SeqC¡
);

226 
	g£lf
.
	g»tuº_”r
.
lßd
(
Ord”šg
::
SeqC¡
) {

227  
E¼
(
box_”r
!("error"));

229 
Ok
(())

232 
â
 
´e_­¶y_admš
(&
£lf
, 
ùx
: &
mut
 
Ob£rv”CÚ‹xt
, 
_
: &
AdmšReque¡
) {

233 
£lf
.
ÿÎed
.
ãtch_add
(2, 
Ord”šg
::
SeqC¡
);

234 
	gùx
.
	gby·ss
 = 
£lf
.
by·ss
.
lßd
(
Ord”šg
::
SeqC¡
);

237 
â
 
po¡_­¶y_admš
(&
£lf
, 
ùx
: &
mut
 
Ob£rv”CÚ‹xt
, 
_
: &muˆ
AdmšRe¥Ú£
) {

238 
£lf
.
ÿÎed
.
ãtch_add
(3, 
Ord”šg
::
SeqC¡
);

239 
	gùx
.
	gby·ss
 = 
£lf
.
by·ss
.
lßd
(
Ord”šg
::
SeqC¡
);

243 
im¶
 
Qu”yOb£rv”
 
	gTe¡CİroûssÜ
 {

244 
â
 
´e_´İo£_qu”y
(

245 &
£lf
,

246 
ùx
: &
mut
 
Ob£rv”CÚ‹xt
,

247 
_
: &
mut
 
R•—‹dF›ld
<
Reque¡
>,

248 è-> 
	gResuÉ
<()> {

249 
	g£lf
.
	gÿÎed
.
ãtch_add
(4, 
Ord”šg
::
SeqC¡
);

250 
	gùx
.
	gby·ss
 = 
£lf
.
by·ss
.
lßd
(
Ord”šg
::
SeqC¡
);

251 
	g£lf
.
	g»tuº_”r
.
lßd
(
Ord”šg
::
SeqC¡
) {

252  
E¼
(
box_”r
!("error"));

254 
Ok
(())

257 
â
 
´e_­¶y_qu”y
(&
£lf
, 
ùx
: &
mut
 
Ob£rv”CÚ‹xt
, 
_
: &[
Reque¡
]) {

258 
£lf
.
ÿÎed
.
ãtch_add
(5, 
Ord”šg
::
SeqC¡
);

259 
	gùx
.
	gby·ss
 = 
£lf
.
by·ss
.
lßd
(
Ord”šg
::
SeqC¡
);

262 
â
 
po¡_­¶y_qu”y
(&
£lf
, 
ùx
: &
mut
 
Ob£rv”CÚ‹xt
, 
_
: &muˆ
R•—‹dF›ld
<
Re¥Ú£
>) {

263 
£lf
.
ÿÎed
.
ãtch_add
(6, 
Ord”šg
::
SeqC¡
);

264 
	gùx
.
	gby·ss
 = 
£lf
.
by·ss
.
lßd
(
Ord”šg
::
SeqC¡
);

268 
	gmaüo_ruËs
! 
	gas£¹_®l
 {

269 (
	g$rg‘
:
ex´
, 
	g$ex³ù
:expr) => ({

270 
c
, 
e
è
š
 (
$rg‘
).
™”
().
z
(
$ex³ù
) {

271 
as£¹_eq
!(
c
.
lßd
(
Ord”šg
::
SeqC¡
), *
e
);

276 
	gmaüo_ruËs
! 
	g£t_®l
 {

277 (
	g$rg‘
:
ex´
, 
	g$v
:expr) => ({

278 
v
 
š
 
$rg‘
 {

279 
v
.
¡Üe
(
$v
, 
Ord”šg
::
SeqC¡
);

284 #[
‹¡
]

285 
â
 
‹¡_Œigg”_right_hook
() {

286 
Ët
 
mut
 
	gho¡
 = 
CİroûssÜHo¡
::();

287 
Ët
 
	gob
 = 
Te¡CİroûssÜ
::();

288 
	gho¡
.
	g»gi¡ry


289 .
»gi¡”_admš_ob£rv”
(1, 
Box
::
Ãw
(
ob
.
şÚe
()));

290 
	gho¡
.
	g»gi¡ry


291 .
»gi¡”_qu”y_ob£rv”
(1, 
Box
::
Ãw
(
ob
.
şÚe
()));

292 
Ët
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

293 
Ët
 
mut
 
	gadmš_»q
 = 
RaáCmdReque¡
::
Ãw
();

294 
	gadmš_»q
.
£t_admš_»que¡
(
AdmšReque¡
::
Ãw
());

295 
	gho¡
.
´e_´İo£
(&
»giÚ
, &
mut
 
admš_»q
).
unw¿p
();

296 
	gas£¹_®l
!(&[&
ob
.
ÿÎed
], &[1]);

297 
	gho¡
.
´e_­¶y
(&
»giÚ
, &
admš_»q
);

298 
	gas£¹_®l
!(&[&
ob
.
ÿÎed
], &[3]);

299 
Ët
 
mut
 
	gadmš_»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

300 
	gadmš_»¥
.
£t_admš_»¥Ú£
(
AdmšRe¥Ú£
::
Ãw
());

301 
	gho¡
.
po¡_­¶y
(&
»giÚ
, &
mut
 
admš_»¥
);

302 
	gas£¹_®l
!(&[&
ob
.
ÿÎed
], &[6]);

304 
Ët
 
mut
 
	gqu”y_»q
 = 
RaáCmdReque¡
::
Ãw
();

305 
	gqu”y_»q
.
£t_»que¡s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
Reque¡
::
Ãw
()]));

306 
	gho¡
.
´e_´İo£
(&
»giÚ
, &
mut
 
qu”y_»q
).
unw¿p
();

307 
	gas£¹_®l
!(&[&
ob
.
ÿÎed
], &[10]);

308 
	gho¡
.
´e_­¶y
(&
»giÚ
, &
qu”y_»q
);

309 
	gas£¹_®l
!(&[&
ob
.
ÿÎed
], &[15]);

310 
	gho¡
.
po¡_­¶y
(&
»giÚ
, &
mut
 
RaáCmdRe¥Ú£
::
Ãw
());

311 
	gas£¹_®l
!(&[&
ob
.
ÿÎed
], &[21]);

314 #[
‹¡
]

315 
â
 
‹¡_Üd”
() {

316 
Ët
 
mut
 
	gho¡
 = 
CİroûssÜHo¡
::();

318 
Ët
 
	gob1
 = 
Te¡CİroûssÜ
::();

319 
	gho¡
.
	g»gi¡ry


320 .
»gi¡”_admš_ob£rv”
(3, 
Box
::
Ãw
(
ob1
.
şÚe
()));

321 
	gho¡
.
	g»gi¡ry


322 .
»gi¡”_qu”y_ob£rv”
(3, 
Box
::
Ãw
(
ob1
.
şÚe
()));

323 
Ët
 
	gob2
 = 
Te¡CİroûssÜ
::();

324 
	gho¡
.
	g»gi¡ry


325 .
»gi¡”_admš_ob£rv”
(2, 
Box
::
Ãw
(
ob2
.
şÚe
()));

326 
	gho¡
.
	g»gi¡ry


327 .
»gi¡”_qu”y_ob£rv”
(2, 
Box
::
Ãw
(
ob2
.
şÚe
()));

329 
Ët
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

330 
Ët
 
mut
 
	gadmš_»q
 = 
RaáCmdReque¡
::
Ãw
();

331 
	gadmš_»q
.
£t_admš_»que¡
(
AdmšReque¡
::
Ãw
());

332 
Ët
 
mut
 
	gadmš_»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

333 
	gadmš_»¥
.
£t_admš_»¥Ú£
(
AdmšRe¥Ú£
::
Ãw
());

334 
Ët
 
	gqu”y_»q
 = 
RaáCmdReque¡
::
Ãw
();

335 
Ët
 
	gqu”y_»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

337 
Ët
 
	gÿ£s
 = 
vec
![(0, 
admš_»q
, 
admš_»¥
), (3, 
qu”y_»q
, 
qu”y_»¥
)];

339 
	gba£_scÜe
, 
mut
 
	g»q
, muˆ
	g»¥
è
š
 
	gÿ£s
 {

340 
	g£t_®l
!(&[&
ob1
.
»tuº_”r
, &
ob2
.»tuº_”r], 
	gçl£
);

341 
	g£t_®l
!(&[&
ob1
.
ÿÎed
, &
ob2
.called], 0);

342 
	g£t_®l
!(&[&
ob1
.
by·ss
, &
ob2
.by·ss], 
	gŒue
);

344 
	gho¡
.
´e_´İo£
(&
»giÚ
, &
mut
 
»q
).
unw¿p
();

347 
	gas£¹_®l
!(&[&
ob1
.
ÿÎed
, &
ob2
.ÿÎed], &[0, 
ba£_scÜe
 + 1]);

349 
	gho¡
.
´e_­¶y
(&
»giÚ
, &
»q
);

350 
	gas£¹_®l
!(&[&
ob1
.
ÿÎed
, &
ob2
.ÿÎed], &[0, 
ba£_scÜe
 * 2 + 3]);

352 
	gho¡
.
po¡_­¶y
(&
»giÚ
, &
mut
 
»¥
);

353 
	gas£¹_®l
!(&[&
ob1
.
ÿÎed
, &
ob2
.ÿÎed], &[0, 
ba£_scÜe
 * 3 + 6]);

355 
	g£t_®l
!(&[&
ob2
.
by·ss
], 
	gçl£
);

356 
	g£t_®l
!(&[&
ob2
.
ÿÎed
], 0);

358 
	gho¡
.
´e_´İo£
(&
»giÚ
, &
mut
 
»q
).
unw¿p
();

360 
	gas£¹_®l
!(

361 &[&
ob1
.
ÿÎed
, &
ob2
.called],

362 &[
ba£_scÜe
 + 1, base_score + 1]

365 
	g£t_®l
!(&[&
ob1
.
ÿÎed
, &
ob2
.called], 0);

368 
	g£t_®l
!(&[&
ob2
.
»tuº_”r
], 
	gŒue
);

369 
	gho¡
.
´e_´İo£
(&
»giÚ
, &
mut
 
»q
).
unw¿p_”r
();

370 
	gas£¹_®l
!(&[&
ob1
.
ÿÎed
, &
ob2
.ÿÎed], &[0, 
ba£_scÜe
 + 1]);

	@src/raftstore/coprocessor/error.rs

14 
u£
 
	g¡d
::
»suÉ
::
ResuÉ
 
as
 
StdResuÉ
;

15 
u£
 
	g¡d
::
”rÜ
::
E¼Ü
 
as
 
StdE¼Ü
;

18 
	gquick_”rÜ
!{

19 #[
d”ive
(
Debug
)]

20 
pub
 
	eE¼Ü
 {

21 
Oth”
(
”r
: 
Box
<
StdE¼Ü
 + 
Sync
 + 
S’d
>) {

22 
äom
()

23 
ÿu£
(
”r
.
as_»f
())

24 
desütiÚ
(
”r
.description())

25 
di¥Ïy
("{}", 
”r
)

30 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
StdResuÉ
<
T
, 
	gE¼Ü
>;

	@src/raftstore/coprocessor/metrics.rs

14 
u£
 
	g´om‘heus
::{
expÚ’tŸl_buck‘s
, 
	gHi¡og¿m
};

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gREGION_SIZE_HISTOGRAM
: 
Hi¡og¿m
 =

18 
»gi¡”_hi¡og¿m
!(

21 
expÚ’tŸl_buck‘s
(4096.0, 2.0, 20).
unw¿p
()

22 ).
unw¿p
();

	@src/raftstore/coprocessor/mod.rs

14 
u£
 
	grocksdb
::
DB
;

15 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
AdmšReque¡
, 
	gAdmšRe¥Ú£
, 
	gReque¡
, 
	gRe¥Ú£
};

16 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

17 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

19 
pub
 
mod
 
	gdi¥©ch”
;

20 
pub
 
mod
 
	g¥l™_ob£rv”
;

21 
pub
 
mod
 
	gcÚfig
;

22 
mod
 
	g»giÚ_¢­shÙ
;

23 
mod
 
	g”rÜ
;

24 
mod
 
	gm‘rics
;

25 
mod
 
	g¥l™_check
;

27 
pub
 
u£
 
	g£lf
::
cÚfig
::
CÚfig
;

28 
pub
 
u£
 
	g£lf
::
»giÚ_¢­shÙ
::{
RegiÚI‹¿tÜ
, 
	gRegiÚSÇpshÙ
};

29 
pub
 
u£
 
	g£lf
::
di¥©ch”
::{
CİroûssÜHo¡
, 
	gRegi¡ry
};

30 
pub
 
u£
 
	g£lf
::
”rÜ
::{
E¼Ü
, 
	gResuÉ
};

31 
pub
 
u£
 
	g£lf
::
¥l™_check
::{
SizeCheckOb£rv”
, 
Stus
 
as
 
	gS¶™CheckStus
, 
	gTabËCheckOb£rv”
,

32 
	gSIZE_CHECK_OBSERVER_PRIORITY
, 
	gTABLE_CHECK_OBSERVER_PRIORITY
};

36 
pub
 
Œa™
 
	gCİroûssÜ
 {

37 
â
 
¡¬t
(&
£lf
) {}

38 
â
 
¡İ
(&
£lf
) {}

42 
pub
 
	gOb£rv”CÚ‹xt
<'a> {

43 
	g»giÚ
: &'a Region,

45 
pub
 
by·ss
: 
boŞ
,

48 
	gim¶
<'a> Ob£rv”CÚ‹xt<'
	ga
> {

49 
pub
 
â
 
Ãw
(
»giÚ
: &
RegiÚ
è-> 
Ob£rv”CÚ‹xt
 {

50 
Ob£rv”CÚ‹xt
 {

51 
»giÚ
:„egion,

52 
	gby·ss
: 
çl£
,

56 
pub
 
â
 
»giÚ
(&
£lf
è-> &
	gRegiÚ
 {

57 
	g£lf
.
	g»giÚ


61 
pub
 
Œa™
 
	gAdmšOb£rv”
: 
CİroûssÜ
 {

63 
â
 
´e_´İo£_admš
(&
£lf
, 
_
: &
mut
 
Ob£rv”CÚ‹xt
, _: &muˆ
AdmšReque¡
è-> 
ResuÉ
<()> {

64 
Ok
(())

68 
â
 
´e_­¶y_admš
(&
£lf
, 
_
: &
mut
 
Ob£rv”CÚ‹xt
, _: &
AdmšReque¡
) {}

71 
â
 
po¡_­¶y_admš
(&
£lf
, 
_
: &
mut
 
Ob£rv”CÚ‹xt
, _: &muˆ
AdmšRe¥Ú£
) {}

74 
pub
 
Œa™
 
Qu”yOb£rv”
: 
CİroûssÜ
 {

78 
â
 
´e_´İo£_qu”y
(

79 &
£lf
,

80 
_
: &
mut
 
Ob£rv”CÚ‹xt
,

81 
_
: &
mut
 
R•—‹dF›ld
<
Reque¡
>,

82 è-> 
	gResuÉ
<()> {

83 
Ok
(())

87 
â
 
´e_­¶y_qu”y
(&
£lf
, 
_
: &
mut
 
Ob£rv”CÚ‹xt
, _: &[
Reque¡
]) {}

90 
â
 
po¡_­¶y_qu”y
(&
£lf
, 
_
: &
mut
 
Ob£rv”CÚ‹xt
, _: &muˆ
R•—‹dF›ld
<
Re¥Ú£
>) {}

93 
pub
 
Œa™
 
S¶™CheckOb£rv”
: 
CİroûssÜ
 {

100 
â
 
Ãw_¥l™_check_¡©us
(&
£lf
, 
_
: &
mut
 
Ob£rv”CÚ‹xt
, _: &muˆ
S¶™CheckStus
, _: &
DB
) {}

103 
â
 
Ú_¥l™_check
(

104 &
£lf
,

105 
_
: &
mut
 
Ob£rv”CÚ‹xt
,

106 
_
: &
mut
 
S¶™CheckStus
,

107 
_
: &[
u8
],

108 
_
: 
u64
,

109 è-> 
	gO±iÚ
<
	gVec
<
	gu8
>> {

110 
	gNÚe


	@src/raftstore/coprocessor/region_snapshot.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

15 
u£
 
	grocksdb
::{
DBI‹¿tÜ
, 
	gDBVeùÜ
, 
	gS“kKey
, 
	gTabËPrİ”t›sCŞËùiÚ
, 
	gDB
};

16 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

18 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::{
I‹rO±iÚ
, 
	gP“kabË
, 
	gSÇpshÙ
, 
	gSyncSÇpshÙ
};

19 
u£
 
	g¿á¡Üe
::
¡Üe
::{
keys
, 
	gut
, 
	gP“rStÜage
};

20 
u£
 
	g¿á¡Üe
::
ResuÉ
;

26 
pub
 
	sRegiÚSÇpshÙ
 {

27 
	m¢­
: 
SyncSÇpshÙ
,

28 
	m»giÚ
: 
Arc
<
RegiÚ
>,

31 
im¶
 
	gRegiÚSÇpshÙ
 {

32 
pub
 
â
 
Ãw
(
ps
: &
P“rStÜage
è-> 
RegiÚSÇpshÙ
 {

33 
RegiÚSÇpshÙ
::
äom_¢­shÙ
(
ps
.
¿w_¢­shÙ
().
što_sync
(),…s.
g‘_»giÚ
().
şÚe
())

36 
pub
 
â
 
äom_¿w
(
db
: 
Arc
<
DB
>, 
»giÚ
: 
RegiÚ
è-> 
RegiÚSÇpshÙ
 {

37 
RegiÚSÇpshÙ
::
äom_¢­shÙ
(
SÇpshÙ
::
Ãw
(
db
).
što_sync
(), 
»giÚ
)

40 
pub
 
â
 
äom_¢­shÙ
(
¢­
: 
SyncSÇpshÙ
, 
»giÚ
: 
RegiÚ
è-> 
RegiÚSÇpshÙ
 {

41 
RegiÚSÇpshÙ
 {

42 
¢­
: snap,

43 
	g»giÚ
: 
Arc
::
Ãw
(
»giÚ
),

47 
pub
 
â
 
şÚe
(&
£lf
è-> 
	gRegiÚSÇpshÙ
 {

48 
	gRegiÚSÇpshÙ
 {

49 
	g¢­
: 
£lf
.
¢­
.
şÚe
(),

50 
	g»giÚ
: 
£lf
.
»giÚ
.
şÚe
(),

54 
pub
 
â
 
g‘_»giÚ
(&
£lf
è-> &
	gRegiÚ
 {

55 &
	g£lf
.
	g»giÚ


58 
pub
 
â
 
™”
(&
£lf
, 
™”_İt
: 
I‹rO±iÚ
è-> 
RegiÚI‹¿tÜ
 {

59 
RegiÚI‹¿tÜ
::
Ãw
(&
£lf
.
¢­
, s–f.
»giÚ
.
şÚe
(), 
™”_İt
)

62 
pub
 
â
 
™”_cf
(&
£lf
, 
cf
: &
¡r
, 
™”_İt
: 
I‹rO±iÚ
è-> 
ResuÉ
<
RegiÚI‹¿tÜ
> {

63 
Ok
(
RegiÚI‹¿tÜ
::
Ãw_cf
(

64 &
£lf
.
¢­
,

65 
£lf
.
»giÚ
.
şÚe
(),

66 
™”_İt
,

67 
cf
,

73 
pub
 
â
 
	gsÿn
<
	gF
>(

74 &
	g£lf
,

75 
	g¡¬t_key
: &[
u8
],

76 
	g’d_key
: &[
u8
],

77 
	gfl_ÿche
: 
boŞ
,

78 
	gf
: &
mut
 
F
,

79 è-> 
	gResuÉ
<()>

80 
wh”e


81 
	gF
: 
FnMut
(&[
u8
], &[u8]è-> 
	gResuÉ
<
	gboŞ
>,

83 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
Some
(
’d_key
.
to_vec
()), 
fl_ÿche
);

84 
	g£lf
.
sÿn_im¶
(
£lf
.
™”
(
™”_İt
), 
¡¬t_key
, 
f
)

88 
pub
 
â
 
	gsÿn_cf
<
	gF
>(

89 &
	g£lf
,

90 
	gcf
: &
¡r
,

91 
	g¡¬t_key
: &[
u8
],

92 
	g’d_key
: &[
u8
],

93 
	gfl_ÿche
: 
boŞ
,

94 
	gf
: &
mut
 
F
,

95 è-> 
	gResuÉ
<()>

96 
wh”e


97 
	gF
: 
FnMut
(&[
u8
], &[u8]è-> 
	gResuÉ
<
	gboŞ
>,

99 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
Some
(
’d_key
.
to_vec
()), 
fl_ÿche
);

100 
	g£lf
.
sÿn_im¶
(
£lf
.
™”_cf
(
cf
, 
™”_İt
)?, 
¡¬t_key
, 
f
)

103 
â
 
	gsÿn_im¶
<
	gF
>(&
	g£lf
, 
mut
 
	g™
: 
RegiÚI‹¿tÜ
, 
	g¡¬t_key
: &[
u8
], 
	gf
: &muˆ
F
è-> 
ResuÉ
<()>

104 
wh”e


105 
F
: 
FnMut
(&[
u8
], &[u8]è-> 
	gResuÉ
<
	gboŞ
>,

107 !
	g™
.
£ek
(
¡¬t_key
)? {

108  
Ok
(());

110 
	g™
.
v®id
() {

111 
Ët
 
	gr
 = 
f
(
™
.
key
(), it.
v®ue
())?;

113 !
	gr
 || !
	g™
.
Ãxt
() {

118 
Ok
(())

121 
pub
 
â
 
g‘_´İ”t›s_cf
(&
£lf
, 
cf
: &
¡r
è-> 
ResuÉ
<
TabËPrİ”t›sCŞËùiÚ
> {

122 
ut
::
g‘_»giÚ_´İ”t›s_cf
(&
£lf
.
¢­
.
g‘_db
(), 
cf
, s–f.
g‘_»giÚ
())

125 
pub
 
â
 
g‘_¡¬t_key
(&
£lf
è-> &[
u8
] {

126 
	g£lf
.
	g»giÚ
.
g‘_¡¬t_key
()

129 
pub
 
â
 
g‘_’d_key
(&
£lf
è-> &[
u8
] {

130 
	g£lf
.
	g»giÚ
.
g‘_’d_key
()

134 
im¶
 
P“kabË
 
	gRegiÚSÇpshÙ
 {

135 
â
 
g‘_v®ue
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
DBVeùÜ
>> {

136 
ut
::
check_key_š_»giÚ
(
key
, &
£lf
.
»giÚ
)?;

137 
Ët
 
	gd©a_key
 = 
keys
::
d©a_key
(
key
);

138 
	g£lf
.
	g¢­
.
g‘_v®ue
(&
d©a_key
)

141 
â
 
g‘_v®ue_cf
(&
£lf
, 
cf
: &
¡r
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
DBVeùÜ
>> {

142 
ut
::
check_key_š_»giÚ
(
key
, &
£lf
.
»giÚ
)?;

143 
Ët
 
	gd©a_key
 = 
keys
::
d©a_key
(
key
);

144 
	g£lf
.
	g¢­
.
g‘_v®ue_cf
(
cf
, &
d©a_key
)

151 
pub
 
	sRegiÚI‹¿tÜ
 {

152 
	m™”
: 
DBI‹¿tÜ
<
Arc
<
DB
>>,

153 
	mv®id
: 
boŞ
,

154 
	m»giÚ
: 
Arc
<
RegiÚ
>,

155 
	m¡¬t_key
: 
Vec
<
u8
>,

156 
	m’d_key
: 
Vec
<
u8
>,

159 
â
 
£t_uµ”_bound
(
™”_İt
: 
I‹rO±iÚ
, 
»giÚ
: &
RegiÚ
) -> IterOption {

160 
Ët
 
uµ”_bound
 = 
m©ch
 
™”_İt
.upper_bound() {

161 
Some
(
k
è!k.
is_em±y
(è=> 
keys
::
d©a_key
(k),

162 
	g_
 => 
keys
::
’c_’d_key
(
»giÚ
),

164 
	g™”_İt
.
£t_uµ”_bound
(
uµ”_bound
)

168 
im¶
 
	gRegiÚI‹¿tÜ
 {

169 
pub
 
â
 
Ãw
(
¢­
: &
SÇpshÙ
, 
»giÚ
: 
Arc
<
RegiÚ
>, 
mut
 
™”_İt
: 
I‹rO±iÚ
è-> 
RegiÚI‹¿tÜ
 {

170 
™”_İt
 = 
£t_uµ”_bound
(™”_İt, &
»giÚ
);

171 
Ët
 
	g™”
 = 
¢­
.
db_™”©Ü
(
™”_İt
);

172 
	gRegiÚI‹¿tÜ
 {

173 
	g™”
: 
™”
,

174 
	gv®id
: 
çl£
,

175 
	g¡¬t_key
: 
keys
::
’c_¡¬t_key
(&
»giÚ
),

176 
	g’d_key
: 
keys
::
’c_’d_key
(&
»giÚ
),

177 
	g»giÚ
: 
»giÚ
,

181 
pub
 
â
 
Ãw_cf
(

182 
¢­
: &
SÇpshÙ
,

183 
»giÚ
: 
Arc
<
RegiÚ
>,

184 
mut
 
™”_İt
: 
I‹rO±iÚ
,

185 
cf
: &
¡r
,

186 è-> 
	gRegiÚI‹¿tÜ
 {

187 
	g™”_İt
 = 
£t_uµ”_bound
(
™”_İt
, &
»giÚ
);

188 
Ët
 
	g™”
 = 
¢­
.
db_™”©Ü_cf
(
cf
, 
™”_İt
).
unw¿p
();

189 
	gRegiÚI‹¿tÜ
 {

190 
	g™”
: 
™”
,

191 
	gv®id
: 
çl£
,

192 
	g¡¬t_key
: 
keys
::
’c_¡¬t_key
(&
»giÚ
),

193 
	g’d_key
: 
keys
::
’c_’d_key
(&
»giÚ
),

194 
	g»giÚ
: 
»giÚ
,

198 
pub
 
â
 
£ek_to_fœ¡
(&
mut
 
£lf
è-> 
	gboŞ
 {

199 
	g£lf
.
	gv®id
 = 
£lf
.
™”
.
£ek
(£lf.
¡¬t_key
.
as_¦iû
().
što
());

201 
	g£lf
.
upd©e_v®id
(
Œue
)

204 #[
šlše
]

205 
â
 
upd©e_v®id
(&
mut
 
£lf
, 
fÜw¬d
: 
boŞ
) -> bool {

206 
£lf
.
v®id
 {

207 
Ët
 
key
 = 
£lf
.
™”
.key();

208 
	g£lf
.
	gv®id
 = 
fÜw¬d
 {

209 
key
 < 
£lf
.
’d_key
.
as_¦iû
()

211 
key
 >ğ
£lf
.
¡¬t_key
.
as_¦iû
()

214 
	g£lf
.
	gv®id


217 
pub
 
â
 
£ek_to_Ï¡
(&
mut
 
£lf
è-> 
	gboŞ
 {

218 !
	g£lf
.
	g™”
.
£ek
(
£lf
.
’d_key
.
as_¦iû
().
što
()è&& !£lf.™”.£ek(
S“kKey
::
End
) {

219 
£lf
.
v®id
 = 
çl£
;

220  
	g£lf
.
	gv®id
;

223 
	g£lf
.
	g™”
.
key
(è>ğ
£lf
.
’d_key
.
as_¦iû
(è&& s–f.
™”
.
´ev
() {}

225 
£lf
.
v®id
 = s–f.
™”
.valid();

226 
	g£lf
.
upd©e_v®id
(
çl£
)

229 
pub
 
â
 
£ek
(&
mut
 
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
boŞ
> {

230 
£lf
.
should_£ekabË
(
key
)?;

231 
Ët
 
	gkey
 = 
keys
::
d©a_key
(
key
);

232 
	gkey
 =ğ
£lf
.
’d_key
 {

233 
£lf
.
v®id
 = 
çl£
;

235 
	g£lf
.
	gv®id
 = 
£lf
.
™”
.
£ek
(
key
.
as_¦iû
().
što
());

238 
Ok
(
£lf
.
upd©e_v®id
(
Œue
))

241 
pub
 
â
 
£ek_fÜ_´ev
(&
mut
 
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
boŞ
> {

242 
£lf
.
should_£ekabË
(
key
)?;

243 
Ët
 
	gkey
 = 
keys
::
d©a_key
(
key
);

244 
	g£lf
.
	gv®id
 = 
£lf
.
™”
.
£ek_fÜ_´ev
(
key
.
as_¦iû
().
što
());

245 
	g£lf
.
	gv®id
 && s–f.
	g™”
.
key
(è=ğ
£lf
.
’d_key
.
as_¦iû
() {

246 
£lf
.
v®id
 = s–f.
™”
.
´ev
();

248 
Ok
(
£lf
.
upd©e_v®id
(
çl£
))

251 
pub
 
â
 
´ev
(&
mut
 
£lf
è-> 
	gboŞ
 {

252 !
	g£lf
.
	gv®id
 {

253  
	gçl£
;

255 
	g£lf
.
	gv®id
 = 
£lf
.
™”
.
´ev
();

257 
	g£lf
.
upd©e_v®id
(
çl£
)

260 
pub
 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gboŞ
 {

261 !
	g£lf
.
	gv®id
 {

262  
	gçl£
;

264 
	g£lf
.
	gv®id
 = 
£lf
.
™”
.
Ãxt
();

266 
	g£lf
.
upd©e_v®id
(
Œue
)

269 #[
šlše
]

270 
pub
 
â
 
key
(&
£lf
è-> &[
u8
] {

271 
	gas£¹
!(
	g£lf
.
	gv®id
);

272 
	gkeys
::
Üigš_key
(
£lf
.
™”
.
key
())

275 #[
šlše
]

276 
pub
 
â
 
v®ue
(&
£lf
è-> &[
u8
] {

277 
as£¹
!(
£lf
.
v®id
);

278 
	g£lf
.
	g™”
.
v®ue
()

281 #[
šlše
]

282 
pub
 
â
 
v®id
(&
£lf
è-> 
	gboŞ
 {

283 
	g£lf
.
	gv®id


286 #[
šlše
]

287 
pub
 
â
 
should_£ekabË
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<()> {

288 
ut
::
check_key_š_»giÚ_šşusive
(
key
, &
£lf
.
»giÚ
)

292 #[
cfg
(
‹¡
)]

293 
mod
 
	g‹¡s
 {

294 
u£
 
	g¡d
::
ûÎ
::
RefC–l
;

295 
u£
 
	g¡d
::
rc
::
Rc
;

296 
u£
 
	g¡d
::
sync
::
Arc
;

297 
u£
 
	g¡d
::
·th
::
P©h
;

299 
u£
 
	g‹mpdœ
::
TempDœ
;

300 
u£
 
	grocksdb
::{
Wr™abË
, 
	gDB
};

301 
u£
 
	gkv´Ùo
::
m‘­b
::{
P“r
, 
	gRegiÚ
};

303 
u£
 
	g¿á¡Üe
::
ResuÉ
;

304 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::*;

305 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
::*;

306 
u£
 
	g¿á¡Üe
::
¡Üe
::{
CacheQu”ySts
, 
	gP“rStÜage
};

307 
u£
 
	g¡Üage
::{
CFSti¡ics
, 
	gCursÜ
, 
	gKey
, 
	gSÿnMode
, 
	gALL_CFS
, 
	gCF_DEFAULT
};

308 
u£
 
	gut
::{
esÿ³
, 
	grocksdb
, 
	gwÜk”
};

310 
u£
 
	gsu³r
::*;

312 
ty³
 
	gD©aS‘
 = 
Vec
<(Vec<
u8
>, 
	gVec
<
	gu8
>)>;

314 
â
 
Ãw_‹mp_’gše
(
·th
: &
TempDœ
è-> (
Arc
<
DB
>, 
	gArc
<
	gDB
>) {

315 
Ët
 
	g¿á_·th
 = 
·th
.·th().
još
(
P©h
::
Ãw
("raft"));

317 
	gArc
::
Ãw
(

318 
rocksdb
::
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), 
ALL_CFS
).unwrap(),

320 
	gArc
::
Ãw
(

321 
rocksdb
::
Ãw_’gše
(
¿á_·th
.
to_¡r
().
unw¿p
(), &[
CF_DEFAULT
]).unwrap(),

326 
â
 
Ãw_³”_¡Üage
(
’gše
: 
Arc
<
DB
>, 
¿á_’gše
: Arc<DB>, 
r
: &
RegiÚ
è-> 
P“rStÜage
 {

327 
Ët
 
m‘rics
 = 
Rc
::
Ãw
(
RefC–l
::Ãw(
CacheQu”ySts
::()));

328 
	gP“rStÜage
::
Ãw
(

329 
’gše
,

330 
¿á_’gše
,

331 
r
,

332 
wÜk”
::
dummy_scheduËr
(),

333 "".
to_owÃd
(),

334 
m‘rics
,

335 ).
unw¿p
()

338 
â
 
lßd_deçuÉ_d©a£t
(
’gše
: 
Arc
<
DB
>, 
¿á_’gše
: Arc<DB>è-> (
P“rStÜage
, 
	gD©aS‘
) {

339 
Ët
 
mut
 
	gr
 = 
RegiÚ
::
Ãw
();

340 
	gr
.
mut_³”s
().
push
(
P“r
::
Ãw
());

341 
	gr
.
£t_id
(10);

342 
	gr
.
£t_¡¬t_key
(
b
"a2".
to_vec
());

343 
	gr
.
£t_’d_key
(
b
"a7".
to_vec
());

345 
Ët
 
	gba£_d©a
 = 
vec
![

346 (
b
"a1".
to_vec
(), b"v1".to_vec()),

347 (
b
"a3".
to_vec
(), b"v3".to_vec()),

348 (
b
"a5".
to_vec
(), b"v5".to_vec()),

349 (
b
"a7".
to_vec
(), b"v7".to_vec()),

352 &(
»f
 
	gk
,„eà
	gv
è
	gš
 &
	gba£_d©a
 {

353 
	g’gše
.
put
(&
d©a_key
(
k
), 
v
).
ex³ù
("");

355 
Ët
 
	g¡Üe
 = 
Ãw_³”_¡Üage
(
’gše
.
şÚe
(), 
¿á_’gše
.şÚe(), &
r
);

356 (
	g¡Üe
, 
	gba£_d©a
)

359 #[
‹¡
]

360 
â
 
‹¡_³ekabË
() {

361 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("‹¡-¿á¡Üe").
unw¿p
();

362 
Ët
 (
’gše
, 
¿á_’gše
èğ
Ãw_‹mp_’gše
(&
·th
);

363 
Ët
 
mut
 
	gr
 = 
RegiÚ
::
Ãw
();

364 
	gr
.
£t_id
(10);

365 
	gr
.
£t_¡¬t_key
(
b
"key0".
to_vec
());

366 
	gr
.
£t_’d_key
(
b
"key4".
to_vec
());

367 
Ët
 
	g¡Üe
 = 
Ãw_³”_¡Üage
(
’gše
.
şÚe
(), 
¿á_’gše
.şÚe(), &
r
);

369 
Ët
 (
key1
, 
v®ue1
èğ(
b
"key1", 2u64);

370 
	g’gše
.
put_u64
(&
d©a_key
(
key1
), 
v®ue1
).
ex³ù
("");

371 
Ët
 (
key2
, 
v®ue2
èğ(
b
"key2", 2
	gi64
);

372 
	g’gše
.
put_i64
(&
d©a_key
(
key2
), 
v®ue2
).
ex³ù
("");

373 
Ët
 
	gkey3
 = 
b
"key3";

374 
	g’gše
.
put_msg
(&
d©a_key
(
key3
), &
r
).
ex³ù
("");

376 
Ët
 
	g¢­
 = 
RegiÚSÇpshÙ
::
Ãw
(&
¡Üe
);

377 
Ët
 
	gv1
 = 
¢­
.
g‘_u64
(
key1
).
ex³ù
("");

378 
	gas£¹_eq
!(
	gv1
, 
Some
(
v®ue1
));

379 
Ët
 
	gv2
 = 
¢­
.
g‘_i64
(
key2
).
ex³ù
("");

380 
	gas£¹_eq
!(
	gv2
, 
Some
(
v®ue2
));

381 
Ët
 
	gv3
 = 
¢­
.
g‘_msg
(
key3
).
ex³ù
("");

382 
	gas£¹_eq
!(
	gv3
, 
Some
(
r
));

384 
Ët
 
	gv0
 = 
¢­
.
g‘_v®ue
(
b
"key0").
ex³ù
("");

385 
	gas£¹
!(
	gv0
.
is_nÚe
());

387 
Ët
 
	gv4
 = 
¢­
.
g‘_v®ue
(
b
"key5");

388 
	gas£¹
!(
	gv4
.
is_”r
());

391 #[
®low
(
ty³_com¶ex™y
)]

392 #[
‹¡
]

393 
â
 
‹¡_™”©e
() {

394 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("‹¡-¿á¡Üe").
unw¿p
();

395 
Ët
 (
’gše
, 
¿á_’gše
èğ
Ãw_‹mp_’gše
(&
·th
);

396 
Ët
 (
¡Üe
, 
ba£_d©a
èğ
lßd_deçuÉ_d©a£t
(
’gše
.
şÚe
(), 
¿á_’gše
.clone());

398 
Ët
 
	g¢­
 = 
RegiÚSÇpshÙ
::
Ãw
(&
¡Üe
);

399 
Ët
 
mut
 
	gd©a
 = 
vec
![];

400 
	g¢­
.
sÿn
(
b
"a2", &[0xFF, 0xFF], 
çl£
, &
mut
 |
key
, 
v®ue
| {

401 
d©a
.
push
((
key
.
to_vec
(), 
v®ue
.to_vec()));

402 
Ok
(
Œue
)

403 }).
unw¿p
();

405 
	gas£¹_eq
!(
	gd©a
.
Ën
(), 2);

406 
	gas£¹_eq
!(
	gd©a
, &
	gba£_d©a
[1..3]);

408 
Ët
 
	g£ek_bË
: 
Vec
<(
_
, 
	g_
, 
	gO±iÚ
<(&[
u8
], &[u8])>, O±iÚ<(&[u8], &[u8])>)> = 
vec
![

409 (
b
"a1", 
çl£
, 
NÚe
, None),

410 (
b
"a2", 
Œue
, 
Some
((b"a3", b"v3")), 
NÚe
),

411 (
b
"a3", 
Œue
, 
Some
((b"a3", b"v3")), Some((b"a3", b"v3"))),

412 (
b
"a4", 
Œue
, 
Some
((b"a5", b"v5")), Some((b"a3", b"v3"))),

413 (
b
"a6", 
Œue
, 
NÚe
, 
Some
((b"a5", b"v5"))),

414 (
b
"a7", 
Œue
, 
NÚe
, 
Some
((b"a5", b"v5"))),

415 (
b
"a8", 
çl£
, 
NÚe
, None),

417 
Ët
 
	guµ”_bounds
: 
Vec
<
O±iÚ
<&[
u8
]>> = 
vec
![
NÚe
, 
Some
(
b
"a7")];

418 
uµ”_bound
 
š
 
	guµ”_bounds
 {

419 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
uµ”_bound
.
m­
(|
v
| v.
to_vec
()), 
Œue
);

420 
Ët
 
mut
 
	g™”
 = 
¢­
.
™”
(
™”_İt
);

421 
	g£ek_key
, 
	gš_¿nge
, 
	g£ek_exp
, 
	g´ev_exp
è
š
 
	g£ek_bË
.
şÚe
() {

422 
Ët
 
	gcheck_»s
 =

423 |
™”
: &
RegiÚI‹¿tÜ
, 
	g»s
: 
ResuÉ
<
boŞ
>, 
	gexp
: 
O±iÚ
<(&[
u8
], &[u8])>| {

424 !
	gš_¿nge
 {

425 
	gas£¹
!(
	g»s
.
is_”r
(), "ex°çed‡ˆ{}", 
esÿ³
(
£ek_key
));

428 
	gexp
.
is_nÚe
() {

429 
	gas£¹
!(!
	g»s
.
unw¿p
(), "ex°nÚ© {}", 
esÿ³
(
£ek_key
));

433 
	gas£¹
!(
	g»s
.
unw¿p
(), "should sucûed‡ˆ{}", 
esÿ³
(
£ek_key
));

434 
Ët
 (
exp_key
, 
exp_v®
èğ
exp
.
unw¿p
();

435 
	gas£¹_eq
!(
	g™”
.
key
(), 
	gexp_key
);

436 
	gas£¹_eq
!(
	g™”
.
v®ue
(), 
	gexp_v®
);

438 
Ët
 
	g£ek_»s
 = 
™”
.
£ek
(
£ek_key
);

439 
check_»s
(&
™”
, 
£ek_»s
, 
£ek_exp
);

440 
Ët
 
	g´ev_»s
 = 
™”
.
£ek_fÜ_´ev
(
£ek_key
);

441 
check_»s
(&
™”
, 
´ev_»s
, 
´ev_exp
);

445 
	gd©a
.
ş—r
();

446 
	g¢­
.
sÿn
(
b
"a2", &[0xFF, 0xFF], 
çl£
, &
mut
 |
key
, 
v®ue
| {

447 
d©a
.
push
((
key
.
to_vec
(), 
v®ue
.to_vec()));

448 
Ok
(
çl£
)

449 }).
unw¿p
();

451 
	gas£¹_eq
!(
	gd©a
.
Ën
(), 1);

453 
Ët
 
mut
 
	g™”
 = 
¢­
.
™”
(
I‹rO±iÚ
::());

454 
	gas£¹
!(
	g™”
.
£ek_to_fœ¡
());

455 
Ët
 
mut
 
	g»s
 = 
vec
![];

456 
	gloİ
 {

457 
	g»s
.
push
((
™”
.
key
().
to_vec
(), i‹r.
v®ue
().to_vec()));

458 !
	g™”
.
Ãxt
() {

462 
	gas£¹_eq
!(
	g»s
, 
	gba£_d©a
[1..3].
to_vec
());

465 
Ët
 
mut
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

466 
	g»giÚ
.
mut_³”s
().
push
(
P“r
::
Ãw
());

467 
Ët
 
	g¡Üe
 = 
Ãw_³”_¡Üage
(
’gše
.
şÚe
(), 
¿á_’gše
.şÚe(), &
»giÚ
);

468 
Ët
 
	g¢­
 = 
RegiÚSÇpshÙ
::
Ãw
(&
¡Üe
);

469 
	gd©a
.
ş—r
();

470 
	g¢­
.
sÿn
(
b
"", &[0xFF, 0xFF], 
çl£
, &
mut
 |
key
, 
v®ue
| {

471 
d©a
.
push
((
key
.
to_vec
(), 
v®ue
.to_vec()));

472 
Ok
(
Œue
)

473 }).
unw¿p
();

475 
	gas£¹_eq
!(
	gd©a
.
Ën
(), 4);

476 
	gas£¹_eq
!(
	gd©a
, 
	gba£_d©a
);

478 
Ët
 
mut
 
	g™”
 = 
¢­
.
™”
(
I‹rO±iÚ
::());

479 
	gas£¹
!(
	g™”
.
£ek
(
b
"a1").
unw¿p
());

481 
	gas£¹
!(
	g™”
.
£ek_to_fœ¡
());

482 
Ët
 
mut
 
	g»s
 = 
vec
![];

483 
	gloİ
 {

484 
	g»s
.
push
((
™”
.
key
().
to_vec
(), i‹r.
v®ue
().to_vec()));

485 !
	g™”
.
Ãxt
() {

489 
	gas£¹_eq
!(
	g»s
, 
	gba£_d©a
);

492 
Ët
 
	g¡Üe
 = 
Ãw_³”_¡Üage
(
’gše
.
şÚe
(), 
¿á_’gše
.şÚe(), &
»giÚ
);

493 
Ët
 
	g¢­
 = 
RegiÚSÇpshÙ
::
Ãw
(&
¡Üe
);

494 
Ët
 
mut
 
	g™”
 = 
¢­
.
™”
(
I‹rO±iÚ
::
Ãw
(
Some
(
b
"a5".
to_vec
()), 
Œue
));

495 
	gas£¹
!(
	g™”
.
£ek_to_fœ¡
());

496 
Ët
 
mut
 
	g»s
 = 
vec
![];

497 
	gloİ
 {

498 
	g»s
.
push
((
™”
.
key
().
to_vec
(), i‹r.
v®ue
().to_vec()));

499 !
	g™”
.
Ãxt
() {

503 
	gas£¹_eq
!(
	g»s
, 
	gba£_d©a
[0..2].
to_vec
());

506 #[
‹¡
]

507 
â
 
‹¡_»v”£_™”©e
() {

508 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("‹¡-¿á¡Üe").
unw¿p
();

509 
Ët
 (
’gše
, 
¿á_’gše
èğ
Ãw_‹mp_’gše
(&
·th
);

510 
Ët
 (
¡Üe
, 
‹¡_d©a
èğ
lßd_deçuÉ_d©a£t
(
’gše
.
şÚe
(), 
¿á_’gše
.clone());

512 
Ët
 
	g¢­
 = 
RegiÚSÇpshÙ
::
Ãw
(&
¡Üe
);

513 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

514 
Ët
 
mut
 
	g™”
 = 
CursÜ
::
Ãw
(
Box
::Ãw(
¢­
.
™”
(
I‹rO±iÚ
::())), 
SÿnMode
::
Mixed
);

515 
	gas£¹
!(!
	g™”
.
»v”£_£ek
(

516 &
Key
::
äom_’coded
(
b
"a2".
to_vec
()),

517 &
mut
 
¡©i¡ics


518 ).
unw¿p
());

519 
	gas£¹
!(

520 
	g™”
.
»v”£_£ek
(&
Key
::
äom_’coded
(
b
"a7".
to_vec
()), &
mut
 
¡©i¡ics
)

521 .
unw¿p
()

523 
Ët
 
mut
 
	g·œ
 = (
™”
.
key
().
to_vec
(), 
	g™”
.
v®ue
().to_vec());

524 
	gas£¹_eq
!(
	g·œ
, (
	gb
"a5".
to_vec
(), b"v5".to_vec()));

525 
	gas£¹
!(

526 
	g™”
.
»v”£_£ek
(&
Key
::
äom_’coded
(
b
"a5".
to_vec
()), &
mut
 
¡©i¡ics
)

527 .
unw¿p
()

529 
	g·œ
 = (
™”
.
key
().
to_vec
(), 
	g™”
.
v®ue
().to_vec());

530 
	gas£¹_eq
!(
	g·œ
, (
	gb
"a3".
to_vec
(), b"v3".to_vec()));

531 
	gas£¹
!(!
	g™”
.
»v”£_£ek
(

532 &
Key
::
äom_’coded
(
b
"a3".
to_vec
()),

533 &
mut
 
¡©i¡ics


534 ).
unw¿p
());

535 
	gas£¹
!(

536 
	g™”
.
»v”£_£ek
(&
Key
::
äom_’coded
(
b
"a1".
to_vec
()), &
mut
 
¡©i¡ics
)

537 .
is_”r
()

539 
	gas£¹
!(

540 
	g™”
.
»v”£_£ek
(&
Key
::
äom_’coded
(
b
"a8".
to_vec
()), &
mut
 
¡©i¡ics
)

541 .
is_”r
()

544 
	gas£¹
!(
	g™”
.
£ek_to_Ï¡
(&
mut
 
¡©i¡ics
));

545 
Ët
 
mut
 
	g»s
 = 
vec
![];

546 
	gloİ
 {

547 
	g»s
.
push
((
™”
.
key
().
to_vec
(), i‹r.
v®ue
().to_vec()));

548 !
	g™”
.
´ev
(&
mut
 
¡©i¡ics
) {

552 
Ët
 
mut
 
	gex³ù
 = 
‹¡_d©a
[1..3].
to_vec
();

553 
	gex³ù
.
»v”£
();

554 
	gas£¹_eq
!(
	g»s
, 
	gex³ù
);

557 
Ët
 
mut
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

558 
	g»giÚ
.
mut_³”s
().
push
(
P“r
::
Ãw
());

559 
Ët
 
	g¡Üe
 = 
Ãw_³”_¡Üage
(
’gše
.
şÚe
(), 
¿á_’gše
.şÚe(), &
»giÚ
);

560 
Ët
 
	g¢­
 = 
RegiÚSÇpshÙ
::
Ãw
(&
¡Üe
);

561 
Ët
 
mut
 
	g™”
 = 
CursÜ
::
Ãw
(
Box
::Ãw(
¢­
.
™”
(
I‹rO±iÚ
::())), 
SÿnMode
::
Mixed
);

562 
	gas£¹
!(!
	g™”
.
»v”£_£ek
(

563 &
Key
::
äom_’coded
(
b
"a1".
to_vec
()),

564 &
mut
 
¡©i¡ics


565 ).
unw¿p
());

566 
	gas£¹
!(

567 
	g™”
.
»v”£_£ek
(&
Key
::
äom_’coded
(
b
"a2".
to_vec
()), &
mut
 
¡©i¡ics
)

568 .
unw¿p
()

570 
Ët
 
	g·œ
 = (
™”
.
key
().
to_vec
(), 
	g™”
.
v®ue
().to_vec());

571 
	gas£¹_eq
!(
	g·œ
, (
	gb
"a1".
to_vec
(), b"v1".to_vec()));

572 
kv_·œs
 
š
 
	g‹¡_d©a
.
wšdows
(2) {

573 
Ët
 
	g£ek_key
 = 
Key
::
äom_’coded
(
kv_·œs
[1].0.ş
Úe
());

574 
	gas£¹
!(

575 
	g™”
.
»v”£_£ek
(&
£ek_key
, &
mut
 
¡©i¡ics
).
unw¿p
(),

577 
	g£ek_key


579 
Ët
 
	g·œ
 = (
™”
.
key
().
to_vec
(), 
	g™”
.
v®ue
().to_vec());

580 
	gas£¹_eq
!(
	g·œ
, 
	gkv_·œs
[0]);

583 
	gas£¹
!(
	g™”
.
£ek_to_Ï¡
(&
mut
 
¡©i¡ics
));

584 
Ët
 
mut
 
	g»s
 = 
vec
![];

585 
	gloİ
 {

586 
	g»s
.
push
((
™”
.
key
().
to_vec
(), i‹r.
v®ue
().to_vec()));

587 !
	g™”
.
´ev
(&
mut
 
¡©i¡ics
) {

591 
Ët
 
mut
 
	gex³ù
 = 
‹¡_d©a
.
şÚe
();

592 
	gex³ù
.
»v”£
();

593 
	gas£¹_eq
!(
	g»s
, 
	gex³ù
);

	@src/raftstore/coprocessor/split_check/mod.rs

14 
mod
 
	gbË
;

15 
mod
 
	gsize
;

17 
u£
 
	g£lf
::
size
::
SizeStus
;

18 
u£
 
	g£lf
::
bË
::
TabËStus
;

20 
pub
 
u£
 
	g£lf
::
size
::
SizeCheckOb£rv”
;

21 
pub
 cÚ¡ 
	gSIZE_CHECK_OBSERVER_PRIORITY
: 
u32
 = 200;

22 
pub
 
u£
 
	g£lf
::
bË
::
TabËCheckOb£rv”
;

25 
pub
 cÚ¡ 
	gTABLE_CHECK_OBSERVER_PRIORITY
: 
u32
 = 
SIZE_CHECK_OBSERVER_PRIORITY
 - 1;

27 #[
d”ive
(
DeçuÉ
)]

28 
pub
 
	sStus
 {

30 
	mbË
: 
O±iÚ
<
TabËStus
>,

32 
	msize
: 
O±iÚ
<
SizeStus
>,

35 
im¶
 
	gStus
 {

36 
pub
 
â
 
sk
(&
£lf
è-> 
	gboŞ
 {

37 
	g£lf
.
	gbË
.
is_nÚe
(è&& s–f.
	gsize
.is_none()

	@src/raftstore/coprocessor/split_check/size.rs

14 
u£
 
	grocksdb
::
DB
;

15 
u£
 
	g¿á¡Üe
::
¡Üe
::{
ut
, 
	gMsg
};

16 
u£
 
	gut
::
Œª¥Üt
::{
R‘ryabËS’dCh
, 
	gS’d”
};

18 
u£
 
	gsu³r
::
su³r
::{
CİroûssÜ
, 
	gOb£rv”CÚ‹xt
, 
	gS¶™CheckOb£rv”
};

19 
u£
 
	gsu³r
::
su³r
::
m‘rics
::*;

20 
u£
 
	gsu³r
::
Stus
;

22 #[
d”ive
(
DeçuÉ
)]

23 
pub
 
	sSizeStus
 {

24 
	mcu¼’t_size
: 
u64
,

25 
	m¥l™_key
: 
O±iÚ
<
Vec
<
u8
>>,

28 
pub
 
	gSizeCheckOb£rv”
<
	gC
> {

29 
	g»giÚ_max_size
: 
u64
,

30 
	g¥l™_size
: 
u64
,

31 
	gch
: 
R‘ryabËS’dCh
<
Msg
, 
	gC
>,

34 
	gim¶
<
	gC
: 
S’d”
<
Msg
>> 
SizeCheckOb£rv”
<
C
> {

35 
pub
 
â
 
Ãw
(

36 
»giÚ_max_size
: 
u64
,

37 
¥l™_size
: 
u64
,

38 
ch
: 
R‘ryabËS’dCh
<
Msg
, 
C
>,

39 è-> 
	gSizeCheckOb£rv”
<
	gC
> {

40 
	gSizeCheckOb£rv”
 {

41 
	g»giÚ_max_size
,

42 
	g¥l™_size
,

43 
	gch
,

48 
	gim¶
<
	gC
> 
CİroûssÜ
 
	gSizeCheckOb£rv”
<C> {}

50 
	gim¶
<
	gC
: 
S’d”
<
Msg
> + 
S’d
> 
S¶™CheckOb£rv”
 
SizeCheckOb£rv”
<
C
> {

51 
â
 
Ãw_¥l™_check_¡©us
(&
£lf
, 
ùx
: &
mut
 
Ob£rv”CÚ‹xt
, 
¡©us
: &muˆ
Stus
, 
’gše
: &
DB
) {

52 
Ët
 
size_¡©us
 = 
SizeStus
::();

53 
Ët
 
	g»giÚ
 = 
ùx
.
»giÚ
();

54 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

55 
Ët
 
	g»giÚ_size
 = 
m©ch
 
ut
::
g‘_»giÚ_­´oxim©e_size
(
’gše
, 
»giÚ
) {

56 
Ok
(
size
) => size,

57 
E¼
(
e
) => {

58 
”rÜ
!(

60 
»giÚ_id
,

61 
e


64 
	g¡©us
.
	gsize
 = 
Some
(
size_¡©us
);

69 
Ët
 
	g»s
 = 
Msg
::
Aµroxim©eRegiÚSize
 {

70 
»giÚ_id
:„egion_id,

71 
»giÚ_size
:„egion_size,

73 
Ët
 
E¼
(
e
èğ
£lf
.
ch
.
Œy_£nd
(
»s
) {

74 
”rÜ
!(

76 
»giÚ_id
,

77 
e


81 
	gREGION_SIZE_HISTOGRAM
.
ob£rve
(
»giÚ_size
 
as
 
f64
);

82 
	g»giÚ_size
 >ğ
£lf
.
»giÚ_max_size
 {

83 
šfo
!(

85 
»giÚ
.
g‘_id
(),

86 
»giÚ_size
,

87 
£lf
.
»giÚ_max_size


90 
	g¡©us
.
	gsize
 = 
Some
(
size_¡©us
);

94 
â
 
Ú_¥l™_check
(

95 &
£lf
,

96 
_
: &
mut
 
Ob£rv”CÚ‹xt
,

97 
¡©us
: &
mut
 
Stus
,

98 
key
: &[
u8
],

99 
v®ue_size
: 
u64
,

100 è-> 
	gO±iÚ
<
	gVec
<
	gu8
>> {

101 
Ët
 
Some
(
size_¡©us
èğ
¡©us
.
size
.
as_mut
() {

102 
size_¡©us
.
cu¼’t_size
 +ğ
key
.
Ën
(è
as
 
u64
 + 
v®ue_size
;

103 
	gsize_¡©us
.
	gcu¼’t_size
 > 
	g£lf
.
	g¥l™_size
 && size_¡©us.
	g¥l™_key
.
is_nÚe
() {

104 
	gsize_¡©us
.
	g¥l™_key
 = 
Some
(
key
.
to_vec
());

106 
	gsize_¡©us
.
	gcu¼’t_size
 >ğ
£lf
.
»giÚ_max_size
 {

107 
size_¡©us
.
¥l™_key
.
ke
()

109 
NÚe


112 
	gNÚe


117 #[
cfg
(
‹¡
)]

118 
mod
 
	g‹¡s
 {

119 
u£
 
	g¡d
::
sync
::
Arc
;

120 
u£
 
	g¡d
::
sync
::
mpsc
;

122 
u£
 
	g‹mpdœ
::
TempDœ
;

123 
u£
 
	grocksdb
::
Wr™abË
;

124 
u£
 
	gkv´Ùo
::
m‘­b
::
P“r
;

125 
u£
 
	grocksdb
::{
CŞumnFamyO±iÚs
, 
	gDBO±iÚs
};

126 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

128 
u£
 
	g¡Üage
::
ALL_CFS
;

129 
u£
 
	g¿á¡Üe
::
¡Üe
::{
keys
, 
	gMsg
, 
	gS¶™CheckRuÂ”
, 
	gS¶™CheckTask
};

130 
u£
 
	gut
::
rocksdb
::{
Ãw_’gše_İt
, 
	gCFO±iÚs
};

131 
u£
 
	gut
::
wÜk”
::
RuÂabË
;

132 
u£
 
	gut
::
Œª¥Üt
::
R‘ryabËS’dCh
;

133 
u£
 
	gut
::
´İ”t›s
::
SizePrİ”t›sCŞËùÜFaùÜy
;

134 
u£
 
	gut
::
cÚfig
::
R—dabËSize
;

136 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::{
CÚfig
, 
	gCİroûssÜHo¡
};

138 #[
‹¡
]

139 
â
 
‹¡_¥l™_check
() {

140 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("‹¡-¿á¡Üe").
unw¿p
();

141 
Ët
 
	g·th_¡r
 = 
·th
.·th().
to_¡r
().
unw¿p
();

142 
Ët
 
	gdb_İts
 = 
DBO±iÚs
::
Ãw
();

143 
Ët
 
mut
 
	gcf_İts
 = 
CŞumnFamyO±iÚs
::
Ãw
();

144 
Ët
 
	gf
 = 
Box
::
Ãw
(
SizePrİ”t›sCŞËùÜFaùÜy
::());

145 
	gcf_İts
.
add_bË_´İ”t›s_cŞËùÜ_çùÜy
("tikv.size-cŞËùÜ", 
f
);

146 
Ët
 
	gcfs_İts
 = 
ALL_CFS


147 .
™”
()

148 .
m­
(|
cf
| 
CFO±iÚs
::
Ãw
(cf, 
cf_İts
.
şÚe
()))

149 .
cŞËù
();

150 
Ët
 
	g’gše
 = 
Arc
::
Ãw
(
Ãw_’gše_İt
(
·th_¡r
, 
db_İts
, 
cfs_İts
).
unw¿p
());

152 
Ët
 
mut
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

153 
	g»giÚ
.
£t_id
(1);

154 
	g»giÚ
.
£t_¡¬t_key
(
vec
![]);

155 
	g»giÚ
.
£t_’d_key
(
vec
![]);

156 
	g»giÚ
.
mut_³”s
().
push
(
P“r
::
Ãw
());

157 
	g»giÚ
.
mut_»giÚ_•och
().
£t_v”siÚ
(2);

158 
	g»giÚ
.
mut_»giÚ_•och
().
£t_cÚf_v”
(5);

160 
Ët
 (
tx
, 
rx
èğ
mpsc
::
sync_chªÃl
(100);

161 
Ët
 
	gch
 = 
R‘ryabËS’dCh
::
Ãw
(
tx
, "test-split");

162 
Ët
 
mut
 
	gcfg
 = 
CÚfig
::();

163 
	gcfg
.
	g»giÚ_max_size
 = 
R—dabËSize
(100);

164 
	gcfg
.
	g»giÚ_¥l™_size
 = 
R—dabËSize
(60);

166 
Ët
 
mut
 
	gruÂabË
 = 
S¶™CheckRuÂ”
::
Ãw
(

167 
’gše
.
şÚe
(),

168 
ch
.
şÚe
(),

169 
Arc
::
Ãw
(
CİroûssÜHo¡
::Ãw(
cfg
, 
ch
.
şÚe
())),

173 
i
 
	gš
 0..7 {

174 
Ët
 
	gs
 = 
keys
::
d©a_key
(
fÜm©
!("{:04}", 
i
).
as_by‹s
());

175 
	g’gše
.
put
(&
s
, &s).
unw¿p
();

178 
	gruÂabË
.
run
(
S¶™CheckTask
::
Ãw
(&
»giÚ
));

180 
m©ch
 
	grx
.
Œy_»cv
() {

181 
Ok
(
Msg
::
Aµroxim©eRegiÚSize
 { 
»giÚ_id
, .. }) => {

182 
as£¹_eq
!(
»giÚ_id
, 
»giÚ
.
g‘_id
());

184 
	gÙh”s
 => 
·nic
!("expect„ecvƒmpty, but got {:?}", others),

187 
i
 
	gš
 7..11 {

188 
Ët
 
	gs
 = 
keys
::
d©a_key
(
fÜm©
!("{:04}", 
i
).
as_by‹s
());

189 
	g’gše
.
put
(&
s
, &s).
unw¿p
();

194 
	g’gše
.
æush
(
Œue
).
unw¿p
();

196 
	gruÂabË
.
run
(
S¶™CheckTask
::
Ãw
(&
»giÚ
));

197 
m©ch
 
	grx
.
Œy_»cv
() {

198 
Ok
(
Msg
::
Aµroxim©eRegiÚSize
 { 
»giÚ_id
, .. }) => {

199 
as£¹_eq
!(
»giÚ_id
, 
»giÚ
.
g‘_id
());

201 
	gÙh”s
 => 
·nic
!("expect‡pproximate„egion size, but got {:?}", others),

203 
m©ch
 
	grx
.
Œy_»cv
() {

204 
Ok
(
Msg
::
S¶™RegiÚ
 {

205 
»giÚ_id
,

206 
»giÚ_•och
,

207 
¥l™_key
,

210 
as£¹_eq
!(
»giÚ_id
, 
»giÚ
.
g‘_id
());

211 
	gas£¹_eq
!(&
	g»giÚ_•och
, 
	g»giÚ
.
g‘_»giÚ_•och
());

212 
	gas£¹_eq
!(
	g¥l™_key
, 
	gb
"0006");

214 
	gÙh”s
 => 
·nic
!("expect split check„esult, but got {:?}", others),

218 
i
 
	gš
 0..6 {

219 
Ët
 
	gs
 = 
keys
::
d©a_key
(
fÜm©
!("{:04}", 
i
).
as_by‹s
());

220 
cf
 
š
 
	gALL_CFS
 {

221 
Ët
 
	ghªdË
 = 
’gše
.
cf_hªdË
(
cf
).
unw¿p
();

222 
	g’gše
.
put_cf
(
hªdË
, &
s
, &s).
unw¿p
();

225 
cf
 
š
 
	gALL_CFS
 {

226 
Ët
 
	ghªdË
 = 
’gše
.
cf_hªdË
(
cf
).
unw¿p
();

227 
	g’gše
.
æush_cf
(
hªdË
, 
Œue
).
unw¿p
();

230 
	gruÂabË
.
run
(
S¶™CheckTask
::
Ãw
(&
»giÚ
));

231 
m©ch
 
	grx
.
Œy_»cv
() {

232 
Ok
(
Msg
::
Aµroxim©eRegiÚSize
 { 
»giÚ_id
, .. }) => {

233 
as£¹_eq
!(
»giÚ_id
, 
»giÚ
.
g‘_id
());

235 
	gÙh”s
 => 
·nic
!("expect‡pproximate„egion size, but got {:?}", others),

237 
m©ch
 
	grx
.
Œy_»cv
() {

238 
Ok
(
Msg
::
S¶™RegiÚ
 {

239 
»giÚ_id
,

240 
»giÚ_•och
,

241 
¥l™_key
,

244 
as£¹_eq
!(
»giÚ_id
, 
»giÚ
.
g‘_id
());

245 
	gas£¹_eq
!(&
	g»giÚ_•och
, 
	g»giÚ
.
g‘_»giÚ_•och
());

246 
	gas£¹_eq
!(
	g¥l™_key
, 
	gb
"0003");

248 
	gÙh”s
 => 
·nic
!("expect split check„esult, but got {:?}", others),

251 
drİ
(
rx
);

253 
	gruÂabË
.
run
(
S¶™CheckTask
::
Ãw
(&
»giÚ
));

	@src/raftstore/coprocessor/split_check/table.rs

14 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

16 
u£
 
	grocksdb
::{
S“kKey
, 
	gDB
};

17 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

19 
u£
 
	g¡Üage
::
CF_WRITE
;

20 
u£
 
	g¡Üage
::
ty³s
::
Key
;

21 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
;

22 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::{
I‹rO±iÚ
, 
	gI‹¿bË
};

23 
u£
 
	gcİroûssÜ
::
codec
::
bË
 
as
 
bË_codec
;

24 
u£
 
	gut
::
esÿ³
;

26 
u£
 
	gsu³r
::
su³r
::{
CİroûssÜ
, 
	gOb£rv”CÚ‹xt
, 
	gResuÉ
, 
	gS¶™CheckOb£rv”
};

27 
u£
 
	gsu³r
::
Stus
;

29 #[
d”ive
(
DeçuÉ
)]

30 
pub
 
	sTabËStus
 {

31 
	mfœ¡_’coded_bË_´efix
: 
O±iÚ
<
Vec
<
u8
>>,

32 
	mÏ¡_’coded_bË_´efix
: 
O±iÚ
<
Vec
<
u8
>>,

35 #[
d”ive
(
DeçuÉ
)]

36 
pub
 
	gTabËCheckOb£rv”
;

38 
im¶
 
CİroûssÜ
 
	gTabËCheckOb£rv”
 {}

40 
im¶
 
S¶™CheckOb£rv”
 
	gTabËCheckOb£rv”
 {

41 
â
 
Ãw_¥l™_check_¡©us
(&
£lf
, 
ùx
: &
mut
 
Ob£rv”CÚ‹xt
, 
¡©us
: &muˆ
Stus
, 
’gše
: &
DB
) {

42 
Ët
 
mut
 
bË_¡©us
 = 
TabËStus
::();

43 
Ët
 
	gsk
 = 
befÜe_check
(&
mut
 
bË_¡©us
, 
’gše
, 
ùx
.
»giÚ
());

44 !
	gsk
 {

45 
	g¡©us
.
	gbË
 = 
Some
(
bË_¡©us
);

49 
â
 
Ú_¥l™_check
(

50 &
£lf
,

51 
_
: &
mut
 
Ob£rv”CÚ‹xt
,

52 
¡©us
: &
mut
 
Stus
,

53 
key
: &[
u8
],

54 
_
: 
u64
,

55 è-> 
	gO±iÚ
<
	gVec
<
	gu8
>> {

56 
Ët
 
Some
(
»f
 
mut
 
bË_¡©us
èğ
¡©us
.
bË
 {

57 
check_key
(
bË_¡©us
, 
key
)

59 
NÚe


65 
â
 
befÜe_check
(
¡©us
: &
mut
 
TabËStus
, 
’gše
: &
DB
, 
»giÚ
: &
RegiÚ
è-> 
boŞ
 {

66 
is_§me_bË
(
»giÚ
.
g‘_¡¬t_key
(),„egiÚ.
g‘_’d_key
()) {

68  
	gŒue
;

71 
Ët
 
	g’d_key
 = 
m©ch
 
Ï¡_key_of_»giÚ
(
’gše
, 
»giÚ
) {

72 
Ok
(
Some
(
’d_key
)) =>ƒnd_key,

73 
Ok
(
NÚe
è=>  
Œue
,

74 
E¼
(
”r
) => {

75 
”rÜ
!(

77 
»giÚ
.
g‘_id
(),

78 
”r


80  
	gŒue
;

84 
Ët
 
	g’coded_¡¬t_key
 = 
»giÚ
.
g‘_¡¬t_key
();

85 
Ët
 
	g’coded_’d_key
 = 
keys
::
Üigš_key
(&
’d_key
);

87 
	g’coded_¡¬t_key
.
Ën
(è< 
	gbË_codec
::
TABLE_PREFIX_KEY_LEN
 ||

88 
’coded_’d_key
.
Ën
(è< 
bË_codec
::
TABLE_PREFIX_KEY_LEN


92  
çl£
;

97 
m©ch
 (

98 
’coded_¡¬t_key
[..
bË_codec
::
TABLE_PREFIX_LEN
].
cmp
ÑabË_codec::
TABLE_PREFIX
),

99 
’coded_’d_key
[..
bË_codec
::
TABLE_PREFIX_LEN
].
cmp
ÑabË_codec::
TABLE_PREFIX
),

102 (
	gOrd”šg
::
Less
, Ord”šg::Lessè| (
Ord”šg
::
G»©”
, Ord”šg::G»©”è=> 
Œue
,

106 (
	gOrd”šg
::
Less
, Ord”šg::
G»©”
è=> 
çl£
,

108 (
	gOrd”šg
::
Less
, Ord”šg::
Equ®
) => {

111 
¡©us
.
Ï¡_’coded_bË_´efix
 = 
to_’coded_bË_´efix
(
’coded_’d_key
);

112 
	gçl£


115 (
	gOrd”šg
::
Equ®
, Ordering::Equal) => {

116 
is_§me_bË
(
’coded_¡¬t_key
, 
’coded_’d_key
) {

118 
Œue


124 
¡©us
.
Ï¡_’coded_bË_´efix
 = 
to_’coded_bË_´efix
(
’coded_’d_key
);

125 
	gçl£


129 (
	gOrd”šg
::
Equ®
, Ord”šg::
G»©”
) => {

131 
¡©us
.
fœ¡_’coded_bË_´efix
 = 
to_’coded_bË_´efix
(
’coded_¡¬t_key
);

132 
	gçl£


134 
	g_
 => 
·nic
!(

136 
esÿ³
(
’coded_¡¬t_key
),

137 
esÿ³
(
’coded_’d_key
)

145 
â
 
check_key
(
¡©us
: &
mut
 
TabËStus
, 
cu¼’t_d©a_key
: &[
u8
]è-> 
O±iÚ
<
Vec
<u8>> {

146 
Ët
 
Some
(
Ï¡_’coded_bË_´efix
èğ
¡©us
.Ï¡_’coded_bË_´efix.
ke
() {

148  
Some
(
keys
::
d©a_key
(&
Ï¡_’coded_bË_´efix
));

151 
Ët
 
	gcu¼’t_’coded_key
 = 
keys
::
Üigš_key
(
cu¼’t_d©a_key
);

153 
Ët
 
	g¥l™_key
 = 
¡©us
.
fœ¡_’coded_bË_´efix
.
is_some
() {

154 !
is_§me_bË
(

155 
¡©us
.
fœ¡_’coded_bË_´efix
.
as_»f
().
unw¿p
(),

156 
cu¼’t_’coded_key
,

159 
Some
(
cu¼’t_’coded_key
)

161 
NÚe


163 } 
is_bË_key
(
cu¼’t_’coded_key
) {

165 
Some
(
cu¼’t_’coded_key
)

167 
NÚe


169 
Ët
 
Some
(
key
èğ
¥l™_key
 {

170 
to_’coded_bË_´efix
(
key
).
m­
(|
k
| 
keys
::
d©a_key
(&k))

172 
NÚe


176 
â
 
Ï¡_key_of_»giÚ
(
db
: &
DB
, 
»giÚ
: &
RegiÚ
è-> 
ResuÉ
<
O±iÚ
<
Vec
<
u8
>>> {

177 
Ët
 
’d_key
 = 
keys
::
’c_’d_key
(
»giÚ
);

178 
Ët
 
mut
 
	gÏ¡_key
 = 
NÚe
;

180 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
Some
(
’d_key
), 
çl£
);

181 
Ët
 
mut
 
	g™”
 = 
box_Œy
!(
db
.
Ãw_™”©Ü_cf
(
CF_WRITE
, 
™”_İt
));

184 
	g™”
.
£ek
(
S“kKey
::
End
) {

185 
Ët
 
key
 = 
™”
.key().
to_vec
();

186 
	gÏ¡_key
 = 
Some
(
key
);

189 
m©ch
 
	gÏ¡_key
 {

190 
Some
(
lk
è=> 
Ok
(Some(lk)),

191 
	gNÚe
 => 
Ok
(
NÚe
),

195 
â
 
to_’coded_bË_´efix
(
’coded_key
: &[
u8
]è-> 
O±iÚ
<
Vec
<u8>> {

196 
Ët
 
Ok
(
¿w_key
èğ
Key
::
äom_’coded
(
’coded_key
.
to_vec
()).
¿w
() {

197 
bË_codec
::
exŒaù_bË_´efix
(&
¿w_key
)

198 .
m­
(|
k
| 
Key
::
äom_¿w
(k).
’coded
().
to_vec
())

199 .
ok
()

201 
NÚe


207 cÚ¡ 
ENCODED_TABLE_TABLE_PREFIX
: 
usize
 = 
bË_codec
::
TABLE_PREFIX_KEY_LEN
 + 1;

209 
â
 
is_bË_key
(
’coded_key
: &[
u8
]è-> 
boŞ
 {

210 
’coded_key
.
¡¬ts_w™h
(
bË_codec
::
TABLE_PREFIX
) &&

211 
’coded_key
.
Ën
(è>ğ
ENCODED_TABLE_TABLE_PREFIX


214 
â
 
is_§me_bË
(
Ëá_key
: &[
u8
], 
right_key
: &[u8]è-> 
boŞ
 {

215 
is_bË_key
(
Ëá_key
è&& is_bË_key(
right_key
) &&

216 
Ëá_key
[..
ENCODED_TABLE_TABLE_PREFIX
] =ğ
right_key
[..ENCODED_TABLE_TABLE_PREFIX]

219 #[
cfg
(
‹¡
)]

220 
mod
 
‹¡
 {

221 
u£
 
¡d
::
io
::
Wr™e
;

222 
u£
 
	g¡d
::
sync
::
Arc
;

223 
u£
 
	g¡d
::
sync
::
mpsc
;

225 
u£
 
	g‹mpdœ
::
TempDœ
;

226 
u£
 
	grocksdb
::
Wr™abË
;

227 
u£
 
	gkv´Ùo
::
m‘­b
::
P“r
;

229 
u£
 
	g¡Üage
::
ALL_CFS
;

230 
u£
 
	g¡Üage
::
ty³s
::
Key
;

231 
u£
 
	g¿á¡Üe
::
¡Üe
::{
Msg
, 
	gS¶™CheckRuÂ”
, 
	gS¶™CheckTask
};

232 
u£
 
	gut
::
rocksdb
::
Ãw_’gše
;

233 
u£
 
	gut
::
wÜk”
::
RuÂabË
;

234 
u£
 
	gut
::
Œª¥Üt
::
R‘ryabËS’dCh
;

235 
u£
 
	gut
::
cÚfig
::
R—dabËSize
;

236 
u£
 
	gut
::
codec
::
numb”
::
Numb”Encod”
;

237 
u£
 
	gcİroûssÜ
::
codec
::
bË
::{
TABLE_PREFIX
, 
	gTABLE_PREFIX_KEY_LEN
};

239 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::{
CÚfig
, 
	gCİroûssÜHo¡
};

240 
u£
 
	gsu³r
::*;

244 
â
 
g’_bË_´efix
(
bË_id
: 
i64
è-> 
Vec
<
u8
> {

245 
Ët
 
mut
 
buf
 = 
Vec
::
w™h_ÿ·c™y
(
TABLE_PREFIX_KEY_LEN
);

246 
	gbuf
.
wr™e_®l
(
TABLE_PREFIX
).
unw¿p
();

247 
	gbuf
.
’code_i64
(
bË_id
).
unw¿p
();

248 
	gbuf


251 #[
‹¡
]

252 
â
 
‹¡_Ï¡_key_of_»giÚ
() {

253 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("‹¡_Ï¡_key_of_»giÚ").
unw¿p
();

254 
Ët
 
	g’gše
 = 
Arc
::
Ãw
(
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), 
ALL_CFS
).unwrap());

255 
Ët
 
	gwr™e_cf
 = 
’gše
.
cf_hªdË
(
CF_WRITE
).
unw¿p
();

257 
Ët
 
mut
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

258 
	g»giÚ
.
£t_id
(1);

259 
	g»giÚ
.
mut_³”s
().
push
(
P“r
::
Ãw
());

262 
Ët
 
	g·ddšg
 = 
b
"_r00000005";

264 
Ët
 
mut
 
	gd©a_keys
 = 
vec
![];

265 
i
 
	gš
 1..3 {

266 
Ët
 
mut
 
	gkey
 = 
g’_bË_´efix
(
i
);

267 
	gkey
.
ex‹nd_äom_¦iû
(
·ddšg
);

268 
Ët
 
	gk
 = 
keys
::
d©a_key
(
Key
::
äom_¿w
(&
key
).
’coded
());

269 
	g’gše
.
put_cf
(
wr™e_cf
, &
k
, &k).
unw¿p
();

270 
	gd©a_keys
.
push
(
k
)

273 
ty³
 
	gCa£
 = (
O±iÚ
<
i64
>, 
	gO±iÚ
<
	gi64
>, O±iÚ<
	gVec
<
	gu8
>>);

274 
Ët
 
mut
 
	gcheck_ÿ£s
 = |
ÿ£s
: 
Vec
<
Ca£
>| 
¡¬t_id
, 
	g’d_id
, 
	gwªt
è
š
 
	gÿ£s
 {

275 
	g»giÚ
.
£t_¡¬t_key
(

276 
¡¬t_id


277 .
m­
(|
id
| 
Key
::
äom_¿w
(&
g’_bË_´efix
(id)).
’coded
().
to_vec
())

278 .
unw¿p_Ü_–£
(
Vec
::
Ãw
),

280 
	g»giÚ
.
£t_’d_key
(

281 
’d_id


282 .
m­
(|
id
| 
Key
::
äom_¿w
(&
g’_bË_´efix
(id)).
’coded
().
to_vec
())

283 .
unw¿p_Ü_–£
(
Vec
::
Ãw
),

285 
	gas£¹_eq
!(
Ï¡_key_of_»giÚ
(&
’gše
, &
»giÚ
).
unw¿p
(), 
	gwªt
);

288 
check_ÿ£s
(
vec
![

290 (
NÚe
, NÚe, 
d©a_keys
.
g‘
(1).
şÚed
()),

292 (
NÚe
, 
Some
(1), None),

294 (
Some
(1), 
NÚe
, 
d©a_keys
.
g‘
(1).
şÚed
()),

296 (
Some
(1), Some(2), 
d©a_keys
.
g‘
(0).
şÚed
()),

300 #[
‹¡
]

301 
â
 
‹¡_bË_check_ob£rv”
() {

302 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("‹¡_bË_check_ob£rv”").
unw¿p
();

303 
Ët
 
	g’gše
 = 
Arc
::
Ãw
(
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), 
ALL_CFS
).unwrap());

304 
Ët
 
	gwr™e_cf
 = 
’gše
.
cf_hªdË
(
CF_WRITE
).
unw¿p
();

306 
Ët
 
mut
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

307 
	g»giÚ
.
£t_id
(1);

308 
	g»giÚ
.
mut_³”s
().
push
(
P“r
::
Ãw
());

309 
	g»giÚ
.
mut_»giÚ_•och
().
£t_v”siÚ
(2);

310 
	g»giÚ
.
mut_»giÚ_•och
().
£t_cÚf_v”
(5);

312 
Ët
 (
tx
, 
rx
èğ
mpsc
::
sync_chªÃl
(100);

313 
Ët
 
	gch
 = 
R‘ryabËS’dCh
::
Ãw
(
tx
, "test-split-table");

314 
Ët
 (
¡x
, 
_rx
èğ
mpsc
::
sync_chªÃl
::<
Msg
>(100);

315 
Ët
 
	gsch
 = 
R‘ryabËS’dCh
::
Ãw
(
¡x
, "test-split-size");

317 
Ët
 
mut
 
	gcfg
 = 
CÚfig
::();

319 
	gcfg
.
	g¥l™_»giÚ_Ú_bË
 = 
Œue
;

322 
	gcfg
.
	g»giÚ_max_size
 = 
R—dabËSize
::
gb
(2);

323 
	gcfg
.
	g»giÚ_¥l™_size
 = 
R—dabËSize
::
gb
(1);

326 
Ët
 
	gcİroûssÜ
 = 
CİroûssÜHo¡
::
Ãw
(
cfg
, 
sch
);

327 
Ët
 
mut
 
	gruÂabË
 = 
S¶™CheckRuÂ”
::
Ãw
(
’gše
.
şÚe
(), 
ch
.şÚe(), 
Arc
::Ãw(
cİroûssÜ
));

329 
ty³
 
	gCa£
 = (
O±iÚ
<
Vec
<
u8
>>, 
	gO±iÚ
<
	gVec
<
	gu8
>>, O±iÚ<
	gi64
>);

330 
Ët
 
mut
 
	gcheck_ÿ£s
 =

331 |
ÿ£s
: 
Vec
<
Ca£
>| 
’coded_¡¬t_key
, 
	g’coded_’d_key
, 
	gbË_id
è
š
 
	gÿ£s
 {

332 
	g»giÚ
.
£t_¡¬t_key
(
’coded_¡¬t_key
.
unw¿p_Ü_–£
(
Vec
::
Ãw
));

333 
	g»giÚ
.
£t_’d_key
(
’coded_’d_key
.
unw¿p_Ü_–£
(
Vec
::
Ãw
));

334 
	gruÂabË
.
run
(
S¶™CheckTask
::
Ãw
(&
»giÚ
));

336 
Ët
 
Some
(
id
èğ
bË_id
 {

337 
Ët
 
key
 = 
Key
::
äom_¿w
(&
g’_bË_´efix
(
id
));

338 
m©ch
 
	grx
.
Œy_»cv
() {

339 
Ok
(
Msg
::
S¶™RegiÚ
 { 
¥l™_key
, .. }) => {

340 
as£¹_eq
!(&
¥l™_key
, 
key
.
’coded
());

342 
	gÙh”s
 => 
·nic
!("ex³ù {:?}, buˆgÙ {:?}", 
	gkey
, others),

345 
m©ch
 
	grx
.
Œy_»cv
() {

346 
E¼
(
mpsc
::
TryRecvE¼Ü
::
Em±y
) => (),

347 
	gÙh”s
 => 
·nic
!("expectƒmpty, but got {:?}", others),

352 
Ët
 
	gg’_’coded_bË_´efix
 = |
bË_id
| {

353 
Ët
 
key
 = 
Key
::
äom_¿w
(&
g’_bË_´efix
(
bË_id
));

354 
	gkey
.
’coded
().
to_vec
()

358 
Ët
 
	g·ddšg
 = 
b
"_r00000005";

362 
i
 
	gš
 1..4 {

363 
	gi
 % 2 == 0 {

368 
Ët
 
mut
 
	gkey
 = 
g’_bË_´efix
(
i
);

369 
	gkey
.
ex‹nd_äom_¦iû
(
·ddšg
);

370 
Ët
 
	gs
 = 
keys
::
d©a_key
(
Key
::
äom_¿w
(&
key
).
’coded
());

371 
	g’gše
.
put_cf
(
wr™e_cf
, &
s
, &s).
unw¿p
();

374 
check_ÿ£s
(
vec
![

376 (
NÚe
, NÚe, 
Some
(1)),

378 (
Some
(
g’_’coded_bË_´efix
(1)), 
NÚe
, Some(3)),

381 
Some
(
g’_’coded_bË_´efix
(1)),

382 
Some
(
g’_’coded_bË_´efix
(5)),

383 
Some
(3),

387 
Some
(
g’_’coded_bË_´efix
(2)),

388 
Some
(
g’_’coded_bË_´efix
(4)),

389 
Some
(3),

394 
i
 
	gš
 1..4 {

395 
Ët
 
mut
 
	gkey
 = 
g’_bË_´efix
(3);

396 
	gkey
.
ex‹nd_äom_¦iû
(
fÜm©
!("{:?}{}", 
·ddšg
, 
i
).
as_by‹s
());

397 
Ët
 
	gs
 = 
keys
::
d©a_key
(
Key
::
äom_¿w
(&
key
).
’coded
());

398 
	g’gše
.
put_cf
(
wr™e_cf
, &
s
, &s).
unw¿p
();

401 
check_ÿ£s
(
vec
![

403 (
Some
(
g’_’coded_bË_´efix
(1)), 
NÚe
, Some(3)),

405 (
Some
(
g’_’coded_bË_´efix
(3)), 
NÚe
, None),

408 
Some
(
g’_’coded_bË_´efix
(3)),

409 
Some
(
g’_’coded_bË_´efix
(5)),

410 
NÚe
,

415 
i
 
	gš
 0..3 {

417 
Ët
 
	gkey
 = 
fÜm©
!("m{:?}{}", 
	g·ddšg
, 
	gi
);

418 
Ët
 
	gs
 = 
keys
::
d©a_key
(
Key
::
äom_¿w
(
key
.
as_by‹s
()).
’coded
());

419 
	g’gše
.
put_cf
(
wr™e_cf
, &
s
, &s).
unw¿p
();

420 
Ët
 
	gkey
 = 
fÜm©
!("u{:?}{}", 
	g·ddšg
, 
	gi
);

421 
Ët
 
	gs
 = 
keys
::
d©a_key
(
Key
::
äom_¿w
(
key
.
as_by‹s
()).
’coded
());

422 
	g’gše
.
put_cf
(
wr™e_cf
, &
s
, &s).
unw¿p
();

425 
check_ÿ£s
(
vec
![

427 (
NÚe
, NÚe, 
Some
(1)),

429 (
NÚe
, 
Some
(
g’_’coded_bË_´efix
(1)), None),

431 (
NÚe
, 
Some
(
g’_’coded_bË_´efix
(3)), Some(1)),

433 (
NÚe
, 
Some
(
b
"s".
to_vec
()), None),

435 (
Some
(
b
"u".
to_vec
()), 
NÚe
, None),

437 (
Some
(
g’_’coded_bË_´efix
(3)), 
NÚe
, None),

439 (
Some
(
g’_’coded_bË_´efix
(1)), 
NÚe
, Some(3)),

	@src/raftstore/coprocessor/split_observer.rs

14 
u£
 
	gsu³r
::{
AdmšOb£rv”
, 
	gCİroûssÜ
, 
	gOb£rv”CÚ‹xt
, 
ResuÉ
 
as
 
	gCİResuÉ
};

15 
u£
 
	gcİroûssÜ
::
codec
::
bË
;

16 
u£
 
	gut
::
codec
::
by‹s
::{
’code_by‹s
, 
	gBy‹sDecod”
};

18 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
AdmšCmdTy³
, 
	gAdmšReque¡
, 
	gS¶™Reque¡
};

19 
u£
 
	g¡d
::
»suÉ
::
ResuÉ
 
as
 
StdResuÉ
;

24 
pub
 
	gS¶™Ob£rv”
;

26 
ty³
 
	gResuÉ
<
	gT
> = 
StdResuÉ
<
T
, 
	gSŒšg
>;

28 
im¶
 
	gS¶™Ob£rv”
 {

29 
â
 
Ú_¥l™
(&
£lf
, 
ùx
: &
mut
 
Ob£rv”CÚ‹xt
, 
¥l™
: &muˆ
S¶™Reque¡
è-> 
ResuÉ
<()> {

30 
¥l™
.
g‘_¥l™_key
().
is_em±y
() {

31  
E¼
("¥l™ key i ex³ùed!".
to_owÃd
());

34 
Ët
 
mut
 
	gkey
 = 
m©ch
 
¥l™
.
g‘_¥l™_key
().
decode_by‹s
(
çl£
) {

35 
Ok
(
x
) => x,

36 
E¼
(
_
è=>  
Ok
(()),

43 
	gkey
.
¡¬ts_w™h
(
bË
::
TABLE_PREFIX
è&& 
key
.
Ën
(è>abË::
TABLE_PREFIX_KEY_LEN
 &&

44 
key
[
bË
::
TABLE_PREFIX_KEY_LEN
..].
¡¬ts_w™h
ÑabË::
RECORD_PREFIX_SEP
)

47 
key
.
Œunÿ‹
(
bË
::
PREFIX_LEN
 +abË::
ID_LEN
);

50 
Ët
 
	g»giÚ_¡¬t_key
 = 
ùx
.
»giÚ
().
g‘_¡¬t_key
();

52 
Ët
 
	gkey
 = 
’code_by‹s
(&
key
);

53 &*
	gkey
 <ğ
»giÚ_¡¬t_key
 {

54  
E¼
("nØÃedØ¥l™".
to_owÃd
());

57 
	g¥l™
.
£t_¥l™_key
(
key
);

58 
Ok
(())

62 
im¶
 
CİroûssÜ
 
	gS¶™Ob£rv”
 {}

64 
im¶
 
AdmšOb£rv”
 
	gS¶™Ob£rv”
 {

65 
â
 
´e_´İo£_admš
(

66 &
£lf
,

67 
ùx
: &
mut
 
Ob£rv”CÚ‹xt
,

68 
»q
: &
mut
 
AdmšReque¡
,

69 è-> 
	gCİResuÉ
<()> {

70 
	g»q
.
g‘_cmd_ty³
(è!ğ
AdmšCmdTy³
::
S¶™
 {

71  
Ok
(());

73 !
	g»q
.
has_¥l™
() {

74 
	gbox_Œy
!(
E¼
(

77 .
to_owÃd
()

80 
Ët
 
E¼
(
e
èğ
£lf
.
Ú_¥l™
(
ùx
, 
»q
.
mut_¥l™
()) {

81 
	g”rÜ
!("çedØhªdË s¶™„eq: {:?}", 
	ge
);

82  
E¼
(
box_”r
!(
e
));

84 
Ok
(())

88 #[
cfg
(
‹¡
)]

89 
mod
 
	g‹¡
 {

90 
u£
 
	gsu³r
::*;

91 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::
Ob£rv”CÚ‹xt
;

92 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::
AdmšOb£rv”
;

93 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

94 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
AdmšCmdTy³
, 
	gAdmšReque¡
, 
	gS¶™Reque¡
};

95 
u£
 
	gcİroûssÜ
::
codec
::{
d©um
, 
	gbË
, 
	gD©um
};

96 
u£
 
	gut
::
codec
::
numb”
::
Numb”Encod”
;

97 
u£
 
	gut
::
codec
::
by‹s
::
’code_by‹s
;

98 
u£
 
	gby‹Üd”
::{
BigEndŸn
, 
	gWr™eBy‹sExt
};

100 
â
 
Ãw_¥l™_»que¡
(
key
: &[
u8
]è-> 
AdmšReque¡
 {

101 
Ët
 
mut
 
»q
 = 
AdmšReque¡
::
Ãw
();

102 
	g»q
.
£t_cmd_ty³
(
AdmšCmdTy³
::
S¶™
);

103 
Ët
 
mut
 
	g¥l™_»q
 = 
S¶™Reque¡
::
Ãw
();

104 
	g¥l™_»q
.
£t_¥l™_key
(
key
.
to_vec
());

105 
	g»q
.
£t_¥l™
(
¥l™_»q
);

106 
	g»q


109 
â
 
Ãw_row_key
(
bË_id
: 
i64
, 
row_id
: i64, 
cŞumn_id
: 
u64
, 
v”siÚ_id
: u64è-> 
Vec
<
u8
> {

110 
Ët
 
mut
 
buf
 = 
Vec
::
w™h_ÿ·c™y
(
bË
::
ID_LEN
);

111 
	gbuf
.
’code_i64
(
row_id
).
unw¿p
();

112 
Ët
 
mut
 
	gkey
 = 
bË
::
’code_row_key
(
bË_id
, &
buf
);

113 
	gcŞumn_id
 > 0 {

114 
	gkey
.
	gwr™e_u64
::<
BigEndŸn
>(
cŞumn_id
).
unw¿p
();

116 
	gkey
 = 
’code_by‹s
(&
key
);

117 
	gkey
.
	gwr™e_u64
::<
BigEndŸn
>(
v”siÚ_id
).
unw¿p
();

118 
	gkey


121 
â
 
Ãw_šdex_key
(
bË_id
: 
i64
, 
idx_id
: i64, 
d©ums
: &[
D©um
], 
v”siÚ_id
: 
u64
è-> 
Vec
<
u8
> {

122 
Ët
 
mut
 
key
 =

123 
bË
::
’code_šdex_£ek_key
(
bË_id
, 
idx_id
, &
d©um
::
’code_key
(
d©ums
).
unw¿p
());

124 
	gkey
 = 
’code_by‹s
(&
key
);

125 
	gkey
.
	gwr™e_u64
::<
BigEndŸn
>(
v”siÚ_id
).
unw¿p
();

126 
	gkey


129 #[
‹¡
]

130 
â
 
‹¡_fÜg‘_’code
() {

131 
Ët
 
	g»giÚ_¡¬t_key
 = 
Ãw_row_key
(256, 1, 0, 0);

132 
Ët
 
	gkey
 = 
Ãw_row_key
(256, 2, 1, 0);

133 
Ët
 
mut
 
	gr
 = 
RegiÚ
::
Ãw
();

134 
	gr
.
£t_id
(10);

135 
	gr
.
£t_¡¬t_key
(
»giÚ_¡¬t_key
);

137 
Ët
 
mut
 
	gùx
 = 
Ob£rv”CÚ‹xt
::
Ãw
(&
r
);

138 
Ët
 
	gob£rv”
 = 
S¶™Ob£rv”
;

140 
Ët
 
mut
 
	g»q
 = 
Ãw_¥l™_»que¡
(&
key
);

141 
	gob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
).
unw¿p
();

142 
Ët
 
	gex³ù_key
 = 
Ãw_row_key
(256, 2, 0, 0);

143 
Ët
 
	gËn
 = 
ex³ù_key
.
Ën
();

144 
	gas£¹_eq
!(
	g»q
.
g‘_¥l™
().
g‘_¥l™_key
(), &
	gex³ù_key
[..
Ën
 - 8]);

147 #[
‹¡
]

148 
â
 
‹¡_¥l™
() {

149 
Ët
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

150 
Ët
 
mut
 
	gùx
 = 
Ob£rv”CÚ‹xt
::
Ãw
(&
»giÚ
);

151 
Ët
 
mut
 
	g»q
 = 
AdmšReque¡
::
Ãw
();

153 
Ët
 
	gob£rv”
 = 
S¶™Ob£rv”
;

155 
Ët
 
	g»¥
 = 
ob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
);

157 
	gas£¹
!(
	g»¥
.
is_ok
());

158 
	gas£¹
!(!
	g»q
.
has_¥l™
(), "only split„eq should be handle.");

160 
	g»q
 = 
Ãw_¥l™_»que¡
(
b
"test");

161 
	gas£¹
!(
	gob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
).
is_ok
());

162 
	gas£¹_eq
!(
	g»q
.
g‘_¥l™
().
g‘_¥l™_key
(), 
	gb
"test");

164 
Ët
 
mut
 
	gkey
 = 
’code_by‹s
(
b
"db:1");

165 
	gkey
.
	gwr™e_u64
::<
BigEndŸn
>(0).
unw¿p
();

166 
Ët
 
mut
 
	gex³ù_key
 = 
’code_by‹s
(
b
"db:1");

167 
	g»q
 = 
Ãw_¥l™_»que¡
(&
key
);

168 
	gas£¹
!(
	gob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
).
is_ok
());

169 
	gas£¹_eq
!(
	g»q
.
g‘_¥l™
().
g‘_¥l™_key
(), &*
	gex³ù_key
);

171 
	gkey
 = 
Ãw_row_key
(1, 2, 0, 0);

172 
	g»q
 = 
Ãw_¥l™_»que¡
(&
key
);

173 
	gex³ù_key
 = 
key
[..key.
Ën
(è- 8].
to_vec
();

174 
	gas£¹
!(
	gob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
).
is_ok
());

175 
	gas£¹_eq
!(
	g»q
.
g‘_¥l™
().
g‘_¥l™_key
(), &*
	gex³ù_key
);

177 
	gkey
 = 
Ãw_row_key
(1, 2, 1, 0);

178 
	g»q
 = 
Ãw_¥l™_»que¡
(&
key
);

179 
	gas£¹
!(
	gob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
).
is_ok
());

180 
	gas£¹_eq
!(
	g»q
.
g‘_¥l™
().
g‘_¥l™_key
(), &*
	gex³ù_key
);

182 
	gkey
 = 
Ãw_row_key
(1, 2, 1, 1);

183 
	g»q
 = 
Ãw_¥l™_»que¡
(&
key
);

184 
	gas£¹
!(
	gob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
).
is_ok
());

185 
	gas£¹_eq
!(
	g»q
.
g‘_¥l™
().
g‘_¥l™_key
(), &*
	gex³ù_key
);

187 
	gkey
 = 
Ãw_šdex_key
(1, 2, &[
D©um
::
I64
(1), D©um::
By‹s
(
b
"brgege".
to_vec
())], 0);

188 
	g»q
 = 
Ãw_¥l™_»que¡
(&
key
);

189 
	gex³ù_key
 = 
key
[..key.
Ën
(è- 8].
to_vec
();

190 
	gas£¹
!(
	gob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
).
is_ok
());

191 
	gas£¹_eq
!(
	g»q
.
g‘_¥l™
().
g‘_¥l™_key
(), &*
	gex³ù_key
);

193 
	gkey
 = 
Ãw_šdex_key
(1, 2, &[
D©um
::
I64
(1), D©um::
By‹s
(
b
"brgege".
to_vec
())], 5);

194 
	g»q
 = 
Ãw_¥l™_»que¡
(&
key
);

195 
	gob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
).
unw¿p
();

196 
	gas£¹_eq
!(
	g»q
.
g‘_¥l™
().
g‘_¥l™_key
(), &*
	gex³ù_key
);

198 
	gex³ù_key
 = 
’code_by‹s
(

199 
b
"t\x80\x00\x00\x00\x00\x00\x00\xea_r\x80\x00\x00\x00\x00\x05\x82\x7f",

201 
	gkey
 = 
ex³ù_key
.
şÚe
();

202 
	gkey
.
ex‹nd_äom_¦iû
(
b
"\x80\x00\x00\x00\x00\x00\x00\xd3");

203 
	g»q
 = 
Ãw_¥l™_»que¡
(&
key
);

204 
	gob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
).
unw¿p
();

205 
	gas£¹_eq
!(
	g»q
.
g‘_¥l™
().
g‘_¥l™_key
(), &*
	gex³ù_key
);

208 
	gex³ù_key
 = 
’code_by‹s
(
b
"t\x80\x00\x00\x00\x00\x00\x00\xea");

209 
	g»q
 = 
Ãw_¥l™_»que¡
(&
ex³ù_key
);

210 
	gob£rv”
.
´e_´İo£_admš
(&
mut
 
ùx
, &muˆ
»q
).
unw¿p
();

211 
	gas£¹_eq
!(
	g»q
.
g‘_¥l™
().
g‘_¥l™_key
(), &*
	gex³ù_key
);

	@src/raftstore/errors.rs

14 
u£
 
	g¡d
::
”rÜ
;

15 
u£
 
	g¡d
::
»suÉ
;

16 
u£
 
	g¡d
::
io
;

17 
u£
 
	g¡d
::
Ãt
;

19 
u£
 
	g´Ùobuf
::{
PrÙobufE¼Ü
, 
	gR•—‹dF›ld
};

21 
u£
 
	gut
::
codec
;

22 
u£
 
	gpd
;

23 
u£
 
	g¿á
;

24 
u£
 
	gkv´Ùo
::{
”rÜpb
, 
	gm‘­b
};

26 
u£
 
	gsu³r
::
cİroûssÜ
::
E¼Ü
 
as
 
CİE¼Ü
;

27 
u£
 
	gut
::{
esÿ³
, 
	gŒª¥Üt
};

29 cÚ¡ 
	gRAFTSTORE_IS_BUSY
: &'static str = "raftstore is busy";

31 
quick_”rÜ
!{

32 #[
d”ive
(
Debug
)]

33 
pub
 
	eE¼Ü
 {

34 
RaáEÁryTooL¬ge
(
»giÚ_id
: 
u64
, 
’Œy_size
: u64) {

35 
desütiÚ
("raftƒntry isoo†arge")

36 
di¥Ïy
("¿áƒÁry i toØÏrge,„egiÚ {},ƒÁry siz{}", 
»giÚ_id
, 
’Œy_size
)

38 
StÜeNÙM©ch
(
to_¡Üe_id
: 
u64
, 
my_¡Üe_id
: u64) {

39 
desütiÚ
("store is‚ot match")

40 
di¥Ïy
("tØ¡Üid {}, mš{}", 
to_¡Üe_id
, 
my_¡Üe_id
)

42 
RegiÚNÙFound
(
»giÚ_id
: 
u64
) {

43 
desütiÚ
("region is‚ot found")

44 
di¥Ïy
("»giÚ {}‚Ù found", 
»giÚ_id
)

46 
RegiÚNÙIn™Ÿlized
(
»giÚ_id
: 
u64
) {

47 
desütiÚ
("region has‚ot been initialized yet.")

48 
di¥Ïy
("»giÚ {}‚Ù in™Ÿlized y‘", 
»giÚ_id
)

50 
NÙL—d”
(
»giÚ_id
: 
u64
, 
Ëad”
: 
O±iÚ
<
m‘­b
::
P“r
>) {

51 
desütiÚ
("peer is‚ot†eader")

52 
di¥Ïy
("³” i nÙ†—d” fÜ„egiÚ {},†—d” may {:?}", 
»giÚ_id
, 
Ëad”
)

54 
KeyNÙInRegiÚ
(
key
: 
Vec
<
u8
>, 
»giÚ
: 
m‘­b
::
RegiÚ
) {

55 
desütiÚ
("key is‚ot in„egion")

56 
di¥Ïy
("key {} is‚ot in„egion key„ange [{}, {}) for„egion {}",

57 
esÿ³
(
key
),

58 
esÿ³
(
»giÚ
.
g‘_¡¬t_key
()),

59 
esÿ³
(
»giÚ
.
g‘_’d_key
()),

60 
»giÚ
.
g‘_id
())

62 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

63 
äom
()

64 
ÿu£
(
”r
.
as_»f
())

65 
desütiÚ
(
”r
.description())

66 
di¥Ïy
("{:?}", 
”r
)

70 
Io
(
”r
: 
io
::
E¼Ü
) {

71 
äom
()

72 
ÿu£
(
”r
)

73 
desütiÚ
(
”r
.description())

74 
di¥Ïy
("IØ{}", 
”r
)

78 
RocksDb
(
msg
: 
SŒšg
) {

79 
äom
()

80 
desütiÚ
("RocksDbƒrror")

81 
di¥Ïy
("RocksDb {}", 
msg
)

83 
PrÙobuf
(
”r
: 
PrÙobufE¼Ü
) {

84 
äom
()

85 
ÿu£
(
”r
)

86 
desütiÚ
(
”r
.description())

87 
di¥Ïy
("PrÙobuà{}", 
”r
)

89 
Codec
(
”r
: 
codec
::
E¼Ü
) {

90 
äom
()

91 
ÿu£
(
”r
)

92 
desütiÚ
(
”r
.description())

93 
di¥Ïy
("Codeø{}", 
”r
)

95 
AddrP¬£
(
”r
: 
Ãt
::
AddrP¬£E¼Ü
) {

96 
äom
()

97 
ÿu£
(
”r
)

98 
desütiÚ
(
”r
.description())

99 
di¥Ïy
("AddrP¬£ {}", 
”r
)

101 
Pd
(
”r
: 
pd
::
E¼Ü
) {

102 
äom
()

103 
ÿu£
(
”r
)

104 
desütiÚ
(
”r
.description())

105 
di¥Ïy
("Pd {}", 
”r
)

107 
Raá
(
”r
: 
¿á
::
E¼Ü
) {

108 
äom
()

109 
ÿu£
(
”r
)

110 
desütiÚ
(
”r
.description())

111 
di¥Ïy
("Raá {}", 
”r
)

113 
Timeout
(
msg
: 
SŒšg
) {

114 
desütiÚ
("requestimeout")

115 
di¥Ïy
("Timeouˆ{}", 
msg
)

117 
SËEpoch
(
msg
: 
SŒšg
, 
Ãw_»giÚs
: 
Vec
<
m‘­b
::
RegiÚ
>) {

118 
desütiÚ
("region is stale")

119 
di¥Ïy
("SËEpoch {}", 
msg
)

121 
	gSËCommªd
 {

122 
desütiÚ
("stale command")

124 
CİroûssÜ
(
”r
: 
CİE¼Ü
) {

125 
äom
()

126 
ÿu£
(
”r
)

127 
desütiÚ
(
”r
.description())

128 
di¥Ïy
("CİroûssÜ {}", 
”r
)

130 
T¿n¥Üt
(
”r
: 
Œª¥Üt
::
E¼Ü
) {

131 
äom
()

132 
ÿu£
(
”r
)

133 
desütiÚ
(
”r
.description())

134 
di¥Ïy
("T¿n¥Üˆ{}", 
”r
)

140 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

142 
im¶
 
	gIÁo
<
	g”rÜpb
::
E¼Ü
> Error {

143 
â
 
što
(
£lf
è-> 
”rÜpb
::
E¼Ü
 {

144 
Ët
 
mut
 
”rÜpb
 =ƒ¼Üpb::
E¼Ü
::
Ãw
();

145 
	g”rÜpb
.
£t_mes§ge
(
”rÜ
::
E¼Ü
::
desütiÚ
(&
£lf
).
to_owÃd
());

147 
m©ch
 
	g£lf
 {

148 
	gE¼Ü
::
RegiÚNÙFound
(
»giÚ_id
) => {

149 
”rÜpb
.
mut_»giÚ_nÙ_found
().
£t_»giÚ_id
(
»giÚ_id
);

151 
	gE¼Ü
::
NÙL—d”
(
»giÚ_id
, 
Ëad”
) => {

152 
Ët
 
Some
(
Ëad”
) =†eader {

153 
”rÜpb
.
mut_nÙ_Ëad”
().
£t_Ëad”
(
Ëad”
);

155 
	g”rÜpb
.
mut_nÙ_Ëad”
().
£t_»giÚ_id
(
»giÚ_id
);

157 
	gE¼Ü
::
RaáEÁryTooL¬ge
(
»giÚ_id
, 
’Œy_size
) => {

158 
”rÜpb
.
mut_¿á_’Œy_too_Ïrge
().
£t_»giÚ_id
(
»giÚ_id
);

159 
	g”rÜpb


160 .
mut_¿á_’Œy_too_Ïrge
()

161 .
£t_’Œy_size
(
’Œy_size
);

163 
	gE¼Ü
::
StÜeNÙM©ch
(..è=> 
”rÜpb
.
£t_¡Üe_nÙ_m©ch
Ó¼Üpb::StÜeNÙM©ch::
Ãw
()),

164 
	gE¼Ü
::
KeyNÙInRegiÚ
(
key
, 
»giÚ
) => {

165 
”rÜpb
.
mut_key_nÙ_š_»giÚ
().
£t_key
(
key
);

166 
	g”rÜpb


167 .
mut_key_nÙ_š_»giÚ
()

168 .
£t_»giÚ_id
(
»giÚ
.
g‘_id
());

169 
	g”rÜpb


170 .
mut_key_nÙ_š_»giÚ
()

171 .
£t_¡¬t_key
(
»giÚ
.
g‘_¡¬t_key
().
to_vec
());

172 
	g”rÜpb


173 .
mut_key_nÙ_š_»giÚ
()

174 .
£t_’d_key
(
»giÚ
.
g‘_’d_key
().
to_vec
());

176 
	gE¼Ü
::
SËEpoch
(
_
, 
Ãw_»giÚs
) => {

177 
Ët
 
mut
 
e
 = 
”rÜpb
::
SËEpoch
::
Ãw
();

178 
	ge
.
£t_Ãw_»giÚs
(
R•—‹dF›ld
::
äom_vec
(
Ãw_»giÚs
));

179 
	g”rÜpb
.
£t_¡®e_•och
(
e
);

181 
	gE¼Ü
::
SËCommªd
 => {

182 
”rÜpb
.
£t_¡®e_commªd
Ó¼Üpb::
SËCommªd
::
Ãw
());

184 
	gE¼Ü
::
T¿n¥Üt
(
Œª¥Üt
::
E¼Ü
::
Disÿrd
(
_
)) => {

185 
Ët
 
mut
 
£rv”_is_busy_”r
 = 
”rÜpb
::
S”v”IsBusy
::
Ãw
();

186 
	g£rv”_is_busy_”r
.
£t_»asÚ
(
RAFTSTORE_IS_BUSY
.
to_owÃd
());

187 
	g”rÜpb
.
£t_£rv”_is_busy
(
£rv”_is_busy_”r
);

189 
	g_
 => {}

192 
	g”rÜpb


	@src/raftstore/mod.rs

15 
pub
 
mod
 
	g¡Üe
;

16 
pub
 
mod
 
	g”rÜs
;

17 
pub
 
mod
 
	gcİroûssÜ
;

18 
pub
 
u£
 
	g£lf
::
”rÜs
::{
E¼Ü
, 
	gResuÉ
};

	@src/raftstore/store/bootstrap.rs

14 
u£
 
	grocksdb
::{
Wr™abË
, 
	gWr™eB©ch
, 
	gDB
};

15 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
RegiÚLoÿlS‹
, 
	gStÜeId’t
};

16 
u£
 
	gkv´Ùo
::
m‘­b
;

17 
u£
 
	g¿á¡Üe
::
ResuÉ
;

18 
u£
 
	gsu³r
::
keys
;

19 
u£
 
	gsu³r
::
’gše
::{
I‹¿bË
, 
	gMubË
};

20 
u£
 
	gsu³r
::
³”_¡Üage
::{
wr™e_š™Ÿl_­¶y_¡©e
, 
	gwr™e_š™Ÿl_¿á_¡©e
};

21 
u£
 
	gsu³r
::
¡Üe
::
Engšes
;

22 
u£
 
	gut
::
rocksdb
;

23 
u£
 
	g¡Üage
::{
CF_DEFAULT
, 
	gCF_RAFT
};

25 cÚ¡ 
	gINIT_EPOCH_VER
: 
u64
 = 1;

26 cÚ¡ 
	gINIT_EPOCH_CONF_VER
: 
u64
 = 1;

29 
â
 
is_¿nge_em±y
(
’gše
: &
DB
, 
cf
: &
¡r
, 
¡¬t_key
: &[
u8
], 
’d_key
: &[u8]è-> 
ResuÉ
<
boŞ
> {

30 
Ët
 
mut
 
couÁ
: 
u32
 = 0;

31 
	g’gše
.
sÿn_cf
(
cf
, 
¡¬t_key
, 
’d_key
, 
çl£
, &
mut
 |
_
, _| {

32 
couÁ
 += 1;

33 
Ok
(
çl£
)

36 
Ok
(
couÁ
 == 0)

40 
pub
 
â
 
boÙ¡¿p_¡Üe
(
’gšes
: &
Engšes
, 
şu¡”_id
: 
u64
, 
¡Üe_id
: u64è-> 
ResuÉ
<()> {

41 
Ët
 
mut
 
id’t
 = 
StÜeId’t
::
Ãw
();

43 !
is_¿nge_em±y
(&
’gšes
.
kv_’gše
, 
CF_DEFAULT
, 
keys
::
MIN_KEY
, keys::
MAX_KEY
)? {

44  
E¼
(
box_”r
!("kv store is‚otƒmpty‡nd has‡lready had data."));

47 !
is_¿nge_em±y
(

48 &
’gšes
.
¿á_’gše
,

49 
CF_DEFAULT
,

50 
keys
::
MIN_KEY
,

51 
keys
::
MAX_KEY
,

53  
E¼
(
box_”r
!(

58 
Ët
 
	gid’t_key
 = 
keys
::
¡Üe_id’t_key
();

60 
	gid’t
.
£t_şu¡”_id
(
şu¡”_id
);

61 
	gid’t
.
£t_¡Üe_id
(
¡Üe_id
);

63 
	g’gšes
.
	gkv_’gše
.
put_msg
(&
id’t_key
, &
id’t
)?;

64 
	g’gšes
.
	gkv_’gše
.
sync_w®
()?;

65 
Ok
(())

69 
pub
 
â
 
wr™e_´•¬e_boÙ¡¿p
(
’gšes
: &
Engšes
, 
»giÚ
: &
m‘­b
::
RegiÚ
è-> 
ResuÉ
<()> {

70 
Ët
 
mut
 
¡©e
 = 
RegiÚLoÿlS‹
::
Ãw
();

71 
	g¡©e
.
£t_»giÚ
(
»giÚ
.
şÚe
());

73 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

74 
	gwb
.
put_msg
(&
keys
::
´•¬e_boÙ¡¿p_key
(), 
»giÚ
)?;

75 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(&
’gšes
.
kv_’gše
, 
CF_RAFT
)?;

76 
	gwb
.
put_msg_cf
(
hªdË
, &
keys
::
»giÚ_¡©e_key
(
»giÚ
.
g‘_id
()), &
¡©e
)?;

77 
wr™e_š™Ÿl_­¶y_¡©e
(&
’gšes
.
kv_’gše
, &
wb
, 
»giÚ
.
g‘_id
())?;

78 
	g’gšes
.
	gkv_’gše
.
wr™e
(
wb
)?;

79 
	g’gšes
.
	gkv_’gše
.
sync_w®
()?;

81 
Ët
 
	g¿á_wb
 = 
Wr™eB©ch
::
Ãw
();

82 
wr™e_š™Ÿl_¿á_¡©e
(&
¿á_wb
, 
»giÚ
.
g‘_id
())?;

83 
	g’gšes
.
	g¿á_’gše
.
wr™e
(
¿á_wb
)?;

84 
	g’gšes
.
	g¿á_’gše
.
sync_w®
()?;

85 
Ok
(())

89 
pub
 
â
 
ş—r_´•¬e_boÙ¡¿p
(
’gšes
: &
Engšes
, 
»giÚ_id
: 
u64
è-> 
ResuÉ
<()> {

90 
’gšes


91 .
¿á_’gše


92 .
d–‘e
(&
keys
::
¿á_¡©e_key
(
»giÚ_id
))?;

93 
	g’gšes
.
	g¿á_’gše
.
sync_w®
()?;

95 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

96 
	gwb
.
d–‘e
(&
keys
::
´•¬e_boÙ¡¿p_key
())?;

98 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(&
’gšes
.
kv_’gše
, 
CF_RAFT
)?;

99 
	gwb
.
d–‘e_cf
(
hªdË
, &
keys
::
»giÚ_¡©e_key
(
»giÚ_id
))?;

100 
	gwb
.
d–‘e_cf
(
hªdË
, &
keys
::
­¶y_¡©e_key
(
»giÚ_id
))?;

101 
	g’gšes
.
	gkv_’gše
.
wr™e
(
wb
)?;

102 
	g’gšes
.
	gkv_’gše
.
sync_w®
()?;

103 
Ok
(())

107 
pub
 
â
 
ş—r_´•¬e_boÙ¡¿p_¡©e
(
’gšes
: &
Engšes
è-> 
ResuÉ
<()> {

108 
’gšes
.
kv_’gše
.
d–‘e
(&
keys
::
´•¬e_boÙ¡¿p_key
())?;

109 
	g’gšes
.
	gkv_’gše
.
sync_w®
()?;

110 
Ok
(())

114 
pub
 
â
 
´•¬e_boÙ¡¿p
(

115 
’gšes
: &
Engšes
,

116 
¡Üe_id
: 
u64
,

117 
»giÚ_id
: 
u64
,

118 
³”_id
: 
u64
,

119 è-> 
	gResuÉ
<
	gm‘­b
::
RegiÚ
> {

120 
Ët
 
mut
 
»giÚ
 = 
m‘­b
::
RegiÚ
::
Ãw
();

121 
	g»giÚ
.
£t_id
(
»giÚ_id
);

122 
	g»giÚ
.
£t_¡¬t_key
(
keys
::
EMPTY_KEY
.
to_vec
());

123 
	g»giÚ
.
£t_’d_key
(
keys
::
EMPTY_KEY
.
to_vec
());

124 
	g»giÚ
.
mut_»giÚ_•och
().
£t_v”siÚ
(
INIT_EPOCH_VER
);

125 
	g»giÚ
.
mut_»giÚ_•och
().
£t_cÚf_v”
(
INIT_EPOCH_CONF_VER
);

127 
Ët
 
mut
 
	g³”
 = 
m‘­b
::
P“r
::
Ãw
();

128 
	g³”
.
£t_¡Üe_id
(
¡Üe_id
);

129 
	g³”
.
£t_id
(
³”_id
);

130 
	g»giÚ
.
mut_³”s
().
push
(
³”
);

132 
wr™e_´•¬e_boÙ¡¿p
(
’gšes
, &
»giÚ
)?;

134 
Ok
(
»giÚ
)

138 #[
cfg
(
‹¡
)]

139 
mod
 
	g‹¡s
 {

140 
u£
 
	g¡d
::
sync
::
Arc
;

141 
u£
 
	g‹mpdœ
::
TempDœ
;

143 
u£
 
	gsu³r
::*;

144 
u£
 
	gut
::
rocksdb
;

145 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::
P“kabË
;

146 
u£
 
	g¿á¡Üe
::
¡Üe
::{
keys
, 
	gEngšes
};

147 
u£
 
	g¡Üage
::
CF_DEFAULT
;

149 #[
‹¡
]

150 
â
 
‹¡_boÙ¡¿p
() {

151 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("v¬").
unw¿p
();

152 
Ët
 
	g¿á_·th
 = 
·th
.·th().
još
("raft");

153 
Ët
 
	gkv_’gše
 = 
Arc
::
Ãw
(

154 
rocksdb
::
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), &[
CF_DEFAULT
, 
CF_RAFT
]).unwrap(),

156 
Ët
 
	g¿á_’gše
 = 
Arc
::
Ãw
(

157 
rocksdb
::
Ãw_’gše
(
¿á_·th
.
to_¡r
().
unw¿p
(), &[
CF_DEFAULT
]).unwrap(),

159 
Ët
 
	g’gšes
 = 
Engšes
::
Ãw
(
kv_’gše
.
şÚe
(), 
¿á_’gše
.clone());

161 
	gas£¹
!(
boÙ¡¿p_¡Üe
(&
’gšes
, 1, 1).
is_ok
());

162 
	gas£¹
!(
boÙ¡¿p_¡Üe
(&
’gšes
, 1, 1).
is_”r
());

164 
	gas£¹
!(
´•¬e_boÙ¡¿p
(&
’gšes
, 1, 1, 1).
is_ok
());

165 
	gas£¹
!(

166 
	gkv_’gše


167 .
g‘_v®ue
(&
keys
::
´•¬e_boÙ¡¿p_key
())

168 .
unw¿p
()

169 .
is_some
()

171 
	gas£¹
!(

172 
	gkv_’gše


173 .
g‘_v®ue_cf
(
CF_RAFT
, &
keys
::
»giÚ_¡©e_key
(1))

174 .
unw¿p
()

175 .
is_some
()

177 
	gas£¹
!(

178 
	gkv_’gše


179 .
g‘_v®ue_cf
(
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(1))

180 .
unw¿p
()

181 .
is_some
()

183 
	gas£¹
!(

184 
	g¿á_’gše


185 .
g‘_v®ue
(&
keys
::
¿á_¡©e_key
(1))

186 .
unw¿p
()

187 .
is_some
()

190 
	gas£¹
!(
ş—r_´•¬e_boÙ¡¿p_¡©e
(&
’gšes
).
is_ok
());

191 
	gas£¹
!(
ş—r_´•¬e_boÙ¡¿p
(&
’gšes
, 1).
is_ok
());

192 
	gas£¹
!(

193 
is_¿nge_em±y
(

194 &
kv_’gše
,

195 
CF_RAFT
,

196 &
keys
::
»giÚ_m‘a_´efix
(1),

197 &
keys
::
»giÚ_m‘a_´efix
(2)

198 ).
unw¿p
()

200 
	gas£¹
!(

201 
is_¿nge_em±y
(

202 &
¿á_’gše
,

203 
CF_DEFAULT
,

204 &
keys
::
»giÚ_¿á_´efix
(1),

205 &
keys
::
»giÚ_¿á_´efix
(2)

206 ).
unw¿p
()

	@src/raftstore/store/cmd_resp.rs

14 
u£
 
	g¡d
::
”rÜ
;

16 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::
RaáCmdRe¥Ú£
;

17 
u£
 
	g¿á¡Üe
::
E¼Ü
;

19 
pub
 
â
 
	$bšd_‹rm
(
»¥
: &
mut
 
RaáCmdRe¥Ú£
, 
‹rm
: 
u64
) {

20 
‹rm
 == 0 {

24 
»¥
.
	`mut_h—d”
().
	`£t_cu¼’t_‹rm
(
‹rm
);

25 
	}
}

27 
pub
 
â
 
	$bšd_”rÜ
(
»¥
: &
mut
 
RaáCmdRe¥Ú£
, 
”r
: 
E¼Ü
) {

28 
»¥
.
	`mut_h—d”
().
	`£t_”rÜ
(
”r
.
	`što
());

29 
	}
}

31 
pub
 
â
 
Ãw_”rÜ
(
”r
: 
E¼Ü
è-> 
RaáCmdRe¥Ú£
 {

32 
Ët
 
mut
 
»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

33 
bšd_”rÜ
(&
mut
 
»¥
, 
”r
);

34 
	g»¥


37 
pub
 
â
 
”r_»¥
(
e
: 
E¼Ü
, 
‹rm
: 
u64
è-> 
RaáCmdRe¥Ú£
 {

38 
Ët
 
mut
 
»¥
 = 
Ãw_”rÜ
(
e
);

39 
bšd_‹rm
(&
mut
 
»¥
, 
‹rm
);

40 
	g»¥


43 
pub
 
â
 
	gmes§ge_”rÜ
<
	gE
>(
	g”r
: 
E
è-> 
RaáCmdRe¥Ú£


44 
wh”e


45 
E
: 
IÁo
<
Box
<
”rÜ
::
E¼Ü
 + 
S’d
 + 
Sync
>>,

47 
Ãw_”rÜ
(
E¼Ü
::
Oth”
(
”r
.
što
()))

	@src/raftstore/store/config.rs

14 
u£
 
	g¡d
::
u64
;

16 
u£
 
	gtime
::
Du¿tiÚ
 
as
 
TimeDu¿tiÚ
;

18 
u£
 
	g¿á¡Üe
::{
cİroûssÜ
, 
	gResuÉ
};

19 
u£
 
	gut
::
cÚfig
::{
R—dabËDu¿tiÚ
, 
	gR—dabËSize
};

21 #[
d”ive
(
ClÚe
, 
Debug
, 
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
)]

22 #[
£rde
()]

23 #[
£rde
(
»Çme_®l
 = "kebab-case")]

24 
pub
 
	sCÚfig
 {

26 
pub
 
	msync_log
: 
boŞ
,

27 
pub
 
	m¿ádb_·th
: 
SŒšg
,

30 
pub
 
	mÿ·c™y
: 
R—dabËSize
,

33 
pub
 
	m¿á_ba£_tick_š‹rv®
: 
R—dabËDu¿tiÚ
,

34 
pub
 
	m¿á_h—¹b—t_ticks
: 
usize
,

35 
pub
 
	m¿á_–eùiÚ_timeout_ticks
: 
usize
,

36 
pub
 
	m¿á_max_size_³r_msg
: 
R—dabËSize
,

37 
pub
 
	m¿á_max_šæight_msgs
: 
usize
,

39 
pub
 
	m¿á_’Œy_max_size
: 
R—dabËSize
,

42 
pub
 
	m¿á_log_gc_tick_š‹rv®
: 
R—dabËDu¿tiÚ
,

44 
pub
 
	m¿á_log_gc_th»shŞd
: 
u64
,

46 
pub
 
	m¿á_log_gc_couÁ_lim™
: 
u64
,

49 
pub
 
	m¿á_log_gc_size_lim™
: 
R—dabËSize
,

52 
pub
 
	m¥l™_»giÚ_check_tick_š‹rv®
: 
R—dabËDu¿tiÚ
,

55 
pub
 
	m»giÚ_¥l™_check_diff
: 
R—dabËSize
,

57 
pub
 
	m»giÚ_com·ù_check_š‹rv®
: 
R—dabËDu¿tiÚ
,

60 
pub
 
	m»giÚ_com·ù_d–‘e_keys_couÁ
: 
u64
,

61 
pub
 
	mpd_h—¹b—t_tick_š‹rv®
: 
R—dabËDu¿tiÚ
,

62 
pub
 
	mpd_¡Üe_h—¹b—t_tick_š‹rv®
: 
R—dabËDu¿tiÚ
,

63 
pub
 
	m¢­_mgr_gc_tick_š‹rv®
: 
R—dabËDu¿tiÚ
,

64 
pub
 
	m¢­_gc_timeout
: 
R—dabËDu¿tiÚ
,

65 
pub
 
	mlock_cf_com·ù_š‹rv®
: 
R—dabËDu¿tiÚ
,

66 
pub
 
	mlock_cf_com·ù_by‹s_th»shŞd
: 
R—dabËSize
,

68 
pub
 
	mnÙify_ÿ·c™y
: 
usize
,

69 
pub
 
	mmes§ges_³r_tick
: 
usize
,

73 
pub
 
	mmax_³”_down_du¿tiÚ
: 
R—dabËDu¿tiÚ
,

78 
pub
 
	mmax_Ëad”_missšg_du¿tiÚ
: 
R—dabËDu¿tiÚ
,

80 
pub
 
	m¢­_­¶y_b©ch_size
: 
R—dabËSize
,

83 
pub
 
	mcÚsi¡’cy_check_š‹rv®
: 
R—dabËDu¿tiÚ
,

85 
pub
 
	m»pÜt_»giÚ_æow_š‹rv®
: 
R—dabËDu¿tiÚ
,

88 
pub
 
	m¿á_¡Üe_max_Ëad”_Ëa£
: 
R—dabËDu¿tiÚ
,

91 
pub
 
	mright_d”ive_wh’_¥l™
: 
boŞ
,

93 
pub
 
	m®low_»move_Ëad”
: 
boŞ
,

97 #[
doc
(
hidd’
)]

98 #[
£rde
(
sk_£rŸlizšg
)]

99 
pub
 
	m»giÚ_max_size
: 
R—dabËSize
,

100 #[
doc
(
hidd’
)]

101 #[
£rde
(
sk_£rŸlizšg
)]

102 
pub
 
	m»giÚ_¥l™_size
: 
R—dabËSize
,

105 
im¶
 
DeçuÉ
 
	gCÚfig
 {

106 
â
 (è-> 
	gCÚfig
 {

107 
Ët
 
	g¥l™_size
 = 
R—dabËSize
::
mb
(
cİroûssÜ
::
cÚfig
::
SPLIT_SIZE_MB
);

108 
	gCÚfig
 {

109 
	gsync_log
: 
Œue
,

110 
	g¿ádb_·th
: 
SŒšg
::
Ãw
(),

111 
	gÿ·c™y
: 
R—dabËSize
(0),

112 
	g¿á_ba£_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
£cs
(1),

113 
	g¿á_h—¹b—t_ticks
: 2,

114 
	g¿á_–eùiÚ_timeout_ticks
: 10,

115 
	g¿á_max_size_³r_msg
: 
R—dabËSize
::
mb
(1),

116 
	g¿á_max_šæight_msgs
: 256,

117 
	g¿á_’Œy_max_size
: 
R—dabËSize
::
mb
(8),

118 
	g¿á_log_gc_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
£cs
(10),

119 
	g¿á_log_gc_th»shŞd
: 50,

121 
	g¿á_log_gc_couÁ_lim™
: 
¥l™_size
 * 3 / 4 / 
R—dabËSize
::
kb
(1),

122 
	g¿á_log_gc_size_lim™
: 
¥l™_size
 * 3 / 4,

123 
	g¥l™_»giÚ_check_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
£cs
(10),

124 
	g»giÚ_¥l™_check_diff
: 
¥l™_size
 / 16,

126 
	g»giÚ_com·ù_check_š‹rv®
: 
R—dabËDu¿tiÚ
::
£cs
(0),

127 
	g»giÚ_com·ù_d–‘e_keys_couÁ
: 1
_000_000
,

128 
	gpd_h—¹b—t_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
mšu‹s
(1),

129 
	gpd_¡Üe_h—¹b—t_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
£cs
(10),

130 
	gnÙify_ÿ·c™y
: 40960,

131 
	g¢­_mgr_gc_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
mšu‹s
(1),

132 
	g¢­_gc_timeout
: 
R—dabËDu¿tiÚ
::
hours
(4),

133 
	gmes§ges_³r_tick
: 4096,

134 
	gmax_³”_down_du¿tiÚ
: 
R—dabËDu¿tiÚ
::
mšu‹s
(5),

135 
	gmax_Ëad”_missšg_du¿tiÚ
: 
R—dabËDu¿tiÚ
::
hours
(2),

136 
	g¢­_­¶y_b©ch_size
: 
R—dabËSize
::
mb
(10),

137 
	glock_cf_com·ù_š‹rv®
: 
R—dabËDu¿tiÚ
::
mšu‹s
(10),

138 
	glock_cf_com·ù_by‹s_th»shŞd
: 
R—dabËSize
::
mb
(256),

141 
	gcÚsi¡’cy_check_š‹rv®
: 
R—dabËDu¿tiÚ
::
£cs
(0),

142 
	g»pÜt_»giÚ_æow_š‹rv®
: 
R—dabËDu¿tiÚ
::
mšu‹s
(1),

143 
	g¿á_¡Üe_max_Ëad”_Ëa£
: 
R—dabËDu¿tiÚ
::
£cs
(9),

144 
	gright_d”ive_wh’_¥l™
: 
Œue
,

145 
	g®low_»move_Ëad”
: 
çl£
,

148 
	g»giÚ_max_size
: 
R—dabËSize
(0),

149 
	g»giÚ_¥l™_size
: 
R—dabËSize
(0),

154 
im¶
 
	gCÚfig
 {

155 
pub
 
â
 
Ãw
(è-> 
	gCÚfig
 {

156 
	gCÚfig
::()

159 
pub
 
â
 
¿á_¡Üe_max_Ëad”_Ëa£
(&
£lf
è-> 
TimeDu¿tiÚ
 {

160 
TimeDu¿tiÚ
::
äom_¡d
(
£lf
.
¿á_¡Üe_max_Ëad”_Ëa£
.0).
unw¿p
()

163 
pub
 
â
 
v®id©e
(&
£lf
è-> 
ResuÉ
<()> {

164 
£lf
.
¿á_h—¹b—t_ticks
 == 0 {

165  
E¼
(
box_”r
!("heartbeatick must greaterhan 0"));

168 
	g£lf
.
	g¿á_–eùiÚ_timeout_ticks
 != 10 {

169 
w¬n
!(

175 
	g£lf
.
	g¿á_–eùiÚ_timeout_ticks
 <ğ
£lf
.
¿á_h—¹b—t_ticks
 {

176  
E¼
(
box_”r
!(

181 
	g£lf
.
	g¿á_log_gc_th»shŞd
 < 1 {

182  
E¼
(
box_”r
!(

184 
£lf
.
¿á_log_gc_th»shŞd


188 
	g£lf
.
	g¿á_log_gc_size_lim™
.0 == 0 {

189  
E¼
(
box_”r
!("raft†og gc size†imit should†argehan 0."));

192 
Ët
 
	g–eùiÚ_timeout
 =

193 
£lf
.
¿á_ba£_tick_š‹rv®
.
as_mlis
(è* s–f.
¿á_–eùiÚ_timeout_ticks
 
as
 
u64
;

194 
Ët
 
	gËa£
 = 
£lf
.
¿á_¡Üe_max_Ëad”_Ëa£
.
as_mlis
(è
as
 
u64
;

195 
	g–eùiÚ_timeout
 < 
	gËa£
 {

196  
E¼
(
box_”r
!(

198 
–eùiÚ_timeout
,

199 
Ëa£


203 
Ok
(())

207 #[
cfg
(
‹¡
)]

208 
mod
 
	g‹¡s
 {

209 
u£
 
	gsu³r
::*;

211 
u£
 
	gut
::
cÚfig
::*;

213 #[
‹¡
]

214 
â
 
‹¡_cÚfig_v®id©e
() {

215 
Ët
 
mut
 
	gcfg
 = 
CÚfig
::
Ãw
();

216 
	gas£¹
!(
	gcfg
.
v®id©e
().
is_ok
());

218 
	gcfg
.
	g¿á_h—¹b—t_ticks
 = 0;

219 
	gas£¹
!(
	gcfg
.
v®id©e
().
is_”r
());

221 
	gcfg
 = 
CÚfig
::
Ãw
();

222 
	gcfg
.
	g¿á_–eùiÚ_timeout_ticks
 = 10;

223 
	gcfg
.
	g¿á_h—¹b—t_ticks
 = 10;

224 
	gas£¹
!(
	gcfg
.
v®id©e
().
is_”r
());

226 
	gcfg
.
	g¿á_h—¹b—t_ticks
 = 11;

227 
	gas£¹
!(
	gcfg
.
v®id©e
().
is_”r
());

229 
	gcfg
 = 
CÚfig
::
Ãw
();

230 
	gcfg
.
	g¿á_log_gc_th»shŞd
 = 0;

231 
	gas£¹
!(
	gcfg
.
v®id©e
().
is_”r
());

233 
	gcfg
 = 
CÚfig
::
Ãw
();

234 
	gcfg
.
	g¿á_log_gc_size_lim™
 = 
R—dabËSize
(0);

235 
	gas£¹
!(
	gcfg
.
v®id©e
().
is_”r
());

237 
	gcfg
 = 
CÚfig
::
Ãw
();

238 
	gcfg
.
	g¿á_ba£_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
£cs
(1);

239 
	gcfg
.
	g¿á_–eùiÚ_timeout_ticks
 = 10;

240 
	gcfg
.
	g¿á_¡Üe_max_Ëad”_Ëa£
 = 
R—dabËDu¿tiÚ
::
£cs
(20);

241 
	gas£¹
!(
	gcfg
.
v®id©e
().
is_”r
());

	@src/raftstore/store/engine.rs

14 
u£
 
	g¡d
::
İtiÚ
::
O±iÚ
;

15 
u£
 
	g¡d
::
İs
::
D”ef
;

16 
u£
 
	g¡d
::
sync
::
Arc
;

17 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDebug
, 
	gFÜm©‹r
};

19 
u£
 
	grocksdb
::{
CFHªdË
, 
	gDBI‹¿tÜ
, 
	gDBVeùÜ
, 
	gR—dO±iÚs
, 
	gWr™abË
, 
	gWr™eB©ch
, 
	gDB
};

20 
u£
 
	grocksdb
::
rocksdb_İtiÚs
::
Un§ãSÇp
;

21 
u£
 
	g´Ùobuf
;

22 
u£
 
	gby‹Üd”
::{
BigEndŸn
, 
	gBy‹Ord”
};

23 
u£
 
	gut
::
rocksdb
;

25 
u£
 
	g¿á¡Üe
::
ResuÉ
;

26 
u£
 
	g¿á¡Üe
::
E¼Ü
;

28 
pub
 
	sSÇpshÙ
 {

29 
	mdb
: 
Arc
<
DB
>,

30 
	m¢­
: 
Un§ãSÇp
,

35 
un§ã
 
im¶
 
S’d
 
	gSÇpshÙ
 {}

36 
un§ã
 
im¶
 
Sync
 
	gSÇpshÙ
 {}

38 #[
d”ive
(
Debug
, 
ClÚe
)]

39 
pub
 
SyncSÇpshÙ
(
Arc
<
SÇpshÙ
>);

41 
im¶
 
D”ef
 
	gSyncSÇpshÙ
 {

42 
ty³
 
	gT¬g‘
 = 
SÇpshÙ
;

44 
â
 
d”ef
(&
£lf
è-> &
	gSÇpshÙ
 {

45 &
	g£lf
.0

49 
im¶
 
	gSyncSÇpshÙ
 {

50 
pub
 
â
 
Ãw
(
db
: 
Arc
<
DB
>è-> 
SyncSÇpshÙ
 {

51 
SyncSÇpshÙ
(
Arc
::
Ãw
(
SÇpshÙ
::Ãw(
db
)))

54 
pub
 
â
 
şÚe
(&
£lf
è-> 
SyncSÇpshÙ
 {

55 
SyncSÇpshÙ
(
£lf
.0.ş
Úe
())

59 
im¶
 
SÇpshÙ
 {

60 
pub
 
â
 
Ãw
(
db
: 
Arc
<
DB
>è-> 
SÇpshÙ
 {

61 
un§ã
 {

62 
SÇpshÙ
 {

63 
¢­
: 
db
.
un§ã_¢­
(),

64 
	gdb
: 
db
,

69 
pub
 
â
 
što_sync
(
£lf
è-> 
	gSyncSÇpshÙ
 {

70 
SyncSÇpshÙ
(
Arc
::
Ãw
(
£lf
))

73 
pub
 
â
 
cf_Çmes
(&
£lf
è-> 
Vec
<&
¡r
> {

74 
£lf
.
db
.
cf_Çmes
()

77 
pub
 
â
 
cf_hªdË
(&
£lf
, 
cf
: &
¡r
è-> 
ResuÉ
<&
CFHªdË
> {

78 
rocksdb
::
g‘_cf_hªdË
(&
£lf
.
db
, 
cf
).
m­_”r
(
E¼Ü
::
äom
)

81 
pub
 
â
 
g‘_db
(&
£lf
è-> 
Arc
<
DB
> {

82 
£lf
.
db
.
şÚe
()

85 
pub
 
â
 
db_™”©Ü
(&
£lf
, 
™”_İt
: 
I‹rO±iÚ
è-> 
DBI‹¿tÜ
<
Arc
<
DB
>> {

86 
Ët
 
mut
 
İt
 = 
™”_İt
.
bud_»ad_İts
();

87 
	gun§ã
 {

88 
	gİt
.
£t_¢­shÙ
(&
£lf
.
¢­
);

90 
	gDBI‹¿tÜ
::
Ãw
(
£lf
.
db
.
şÚe
(), 
İt
)

93 
pub
 
â
 
db_™”©Ü_cf
(&
£lf
, 
cf
: &
¡r
, 
™”_İt
: 
I‹rO±iÚ
è-> 
ResuÉ
<
DBI‹¿tÜ
<
Arc
<
DB
>>> {

94 
Ët
 
hªdË
 = 
rocksdb
::
g‘_cf_hªdË
(&
£lf
.
db
, 
cf
)?;

95 
Ët
 
mut
 
	gİt
 = 
™”_İt
.
bud_»ad_İts
();

96 
	gun§ã
 {

97 
	gİt
.
£t_¢­shÙ
(&
£lf
.
¢­
);

99 
Ok
(
DBI‹¿tÜ
::
Ãw_cf
(
£lf
.
db
.
şÚe
(), 
hªdË
, 
İt
))

103 
im¶
 
Debug
 
	gSÇpshÙ
 {

104 
â
 
fmt
(&
£lf
, fmt: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

105 
wr™e
!(
fmt
, "Engine Snapshot Impl")

109 
im¶
 
Drİ
 
	gSÇpshÙ
 {

110 
â
 
drİ
(&
mut
 
£lf
) {

111 
	gun§ã
 {

112 
	g£lf
.
	gdb
.
»Ëa£_¢­
(&
£lf
.
¢­
);

118 
pub
 
Œa™
 
	gP“kabË
 {

119 
â
 
g‘_v®ue
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
DBVeùÜ
>>;

120 
â
 
g‘_v®ue_cf
(&
£lf
, 
cf
: &
¡r
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
DBVeùÜ
>>;

122 
â
 
	gg‘_msg
<
	gM
>(&
	g£lf
, 
	gkey
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
M
>>

123 
wh”e


124 
M
: 
´Ùobuf
::
Mes§ge
 +…rÙobuf::
Mes§geStic
,

126 
Ët
 
	gv®ue
 = 
£lf
.
g‘_v®ue
(
key
)?;

128 
	gv®ue
.
is_nÚe
() {

129  
Ok
(
NÚe
);

132 
Ët
 
mut
 
	gm
 = 
M
::
Ãw
();

133 
	gm
.
m”ge_äom_by‹s
(&
v®ue
.
unw¿p
())?;

134 
Ok
(
Some
(
m
))

137 
â
 
	gg‘_msg_cf
<
	gM
>(&
	g£lf
, 
	gcf
: &
¡r
, 
	gkey
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
M
>>

138 
wh”e


139 
M
: 
´Ùobuf
::
Mes§ge
 +…rÙobuf::
Mes§geStic
,

141 
Ët
 
	gv®ue
 = 
£lf
.
g‘_v®ue_cf
(
cf
, 
key
)?;

143 
	gv®ue
.
is_nÚe
() {

144  
Ok
(
NÚe
);

147 
Ët
 
mut
 
	gm
 = 
M
::
Ãw
();

148 
	gm
.
m”ge_äom_by‹s
(&
v®ue
.
unw¿p
())?;

149 
Ok
(
Some
(
m
))

152 
â
 
g‘_u64
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
u64
>> {

153 
Ët
 
v®ue
 = 
£lf
.
g‘_v®ue
(
key
)?;

155 
	gv®ue
.
is_nÚe
() {

156  
Ok
(
NÚe
);

159 
Ët
 
	gv®ue
 = 
v®ue
.
unw¿p
();

160 
	gv®ue
.
Ën
() != 8 {

161  
E¼
(
box_”r
!("Ãed 8 by‹s, buˆÚly gÙ {}", 
v®ue
.
Ën
()));

164 
Ët
 
	gn
 = 
BigEndŸn
::
»ad_u64
(&
v®ue
);

165 
Ok
(
Some
(
n
))

168 
â
 
g‘_i64
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
i64
>> {

169 
Ët
 
r
 = 
£lf
.
g‘_u64
(
key
)?;

170 
m©ch
 
	gr
 {

171 
	gNÚe
 => 
Ok
(
NÚe
),

172 
Some
(
n
è=> 
Ok
(SomeÒ 
as
 
i64
)),

177 #[
d”ive
(
ClÚe
, 
P¬tŸlEq
)]

178 
	eS“kMode
 {

179 
	mTÙ®Ord”
,

180 
	mP»fix
,

183 
pub
 
	sI‹rO±iÚ
 {

184 
	muµ”_bound
: 
O±iÚ
<
Vec
<
u8
>>,

185 
	m´efix_§me_as_¡¬t
: 
boŞ
,

186 
	mfl_ÿche
: 
boŞ
,

187 
	m£ek_mode
: 
S“kMode
,

190 
im¶
 
	gI‹rO±iÚ
 {

191 
pub
 
â
 
Ãw
(
uµ”_bound
: 
O±iÚ
<
Vec
<
u8
>>, 
fl_ÿche
: 
boŞ
è-> 
I‹rO±iÚ
 {

192 
I‹rO±iÚ
 {

193 
uµ”_bound
: upper_bound,

194 
	g´efix_§me_as_¡¬t
: 
çl£
,

195 
	gfl_ÿche
: 
fl_ÿche
,

196 
	g£ek_mode
: 
S“kMode
::
TÙ®Ord”
,

200 #[
šlše
]

201 
pub
 
â
 
u£_´efix_£ek
(
mut
 
£lf
è-> 
	gI‹rO±iÚ
 {

202 
	g£lf
.
	g£ek_mode
 = 
S“kMode
::
P»fix
;

203 
	g£lf


206 #[
šlše
]

207 
pub
 
â
 
tÙ®_Üd”_£ek_u£d
(&
£lf
è-> 
	gboŞ
 {

208 
	g£lf
.
	g£ek_mode
 =ğ
S“kMode
::
TÙ®Ord”


211 #[
šlše
]

212 
pub
 
â
 
uµ”_bound
(&
£lf
è-> 
O±iÚ
<&[
u8
]> {

213 
£lf
.
uµ”_bound
.
as_»f
().
m­
(|
v
| v.
as_¦iû
())

216 #[
šlše
]

217 
pub
 
â
 
£t_uµ”_bound
(
mut
 
£lf
, 
bound
: 
Vec
<
u8
>è-> 
I‹rO±iÚ
 {

218 
£lf
.
uµ”_bound
 = 
Some
(
bound
);

219 
	g£lf


222 #[
šlše
]

223 
pub
 
â
 
£t_´efix_§me_as_¡¬t
(
mut
 
£lf
, 
’abË
: 
boŞ
è-> 
I‹rO±iÚ
 {

224 
£lf
.
´efix_§me_as_¡¬t
 = 
’abË
;

225 
	g£lf


228 
pub
 
â
 
bud_»ad_İts
(&
£lf
è-> 
	gR—dO±iÚs
 {

229 
Ët
 
mut
 
	gİts
 = 
R—dO±iÚs
::
Ãw
();

230 
	gİts
.
fl_ÿche
(
£lf
.fill_cache);

231 
	g£lf
.
tÙ®_Üd”_£ek_u£d
() {

232 
	gİts
.
£t_tÙ®_Üd”_£ek
(
Œue
);

233 } 
	g£lf
.
	g´efix_§me_as_¡¬t
 {

234 
	gİts
.
£t_´efix_§me_as_¡¬t
(
Œue
);

236 
Ët
 
Some
(
»f
 
key
èğ
£lf
.
uµ”_bound
 {

237 
İts
.
£t_™”©e_uµ”_bound
(
key
);

239 
	gİts


243 
im¶
 
DeçuÉ
 
	gI‹rO±iÚ
 {

244 
â
 (è-> 
	gI‹rO±iÚ
 {

245 
	gI‹rO±iÚ
 {

246 
	guµ”_bound
: 
NÚe
,

247 
	g´efix_§me_as_¡¬t
: 
çl£
,

248 
	gfl_ÿche
: 
Œue
,

249 
	g£ek_mode
: 
S“kMode
::
TÙ®Ord”
,

255 
pub
 
Œa™
 
	gI‹¿bË
 {

256 
â
 
Ãw_™”©Ü
(&
£lf
, 
™”_İt
: 
I‹rO±iÚ
è-> 
DBI‹¿tÜ
<&
DB
>;

257 
â
 
Ãw_™”©Ü_cf
(&
£lf
, &
¡r
, 
™”_İt
: 
I‹rO±iÚ
è-> 
ResuÉ
<
DBI‹¿tÜ
<&
DB
>>;

260 
â
 
	gsÿn
<
	gF
>(&
	g£lf
, 
	g¡¬t_key
: &[
u8
], 
	g’d_key
: &[u8], 
	gfl_ÿche
: 
boŞ
, 
	gf
: &
mut
 
F
è-> 
ResuÉ
<()>

261 
wh”e


262 
F
: 
FnMut
(&[
u8
], &[u8]è-> 
	gResuÉ
<
	gboŞ
>,

264 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
Some
(
’d_key
.
to_vec
()), 
fl_ÿche
);

265 
sÿn_im¶
(
£lf
.
Ãw_™”©Ü
(
™”_İt
), 
¡¬t_key
, 
f
)

269 
â
 
	gsÿn_cf
<
	gF
>(

270 &
	g£lf
,

271 
	gcf
: &
¡r
,

272 
	g¡¬t_key
: &[
u8
],

273 
	g’d_key
: &[
u8
],

274 
	gfl_ÿche
: 
boŞ
,

275 
	gf
: &
mut
 
F
,

276 è-> 
	gResuÉ
<()>

277 
wh”e


278 
	gF
: 
FnMut
(&[
u8
], &[u8]è-> 
	gResuÉ
<
	gboŞ
>,

280 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
Some
(
’d_key
.
to_vec
()), 
fl_ÿche
);

281 
sÿn_im¶
(
£lf
.
Ãw_™”©Ü_cf
(
cf
, 
™”_İt
)?, 
¡¬t_key
, 
f
)

285 
â
 
£ek
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<(
Vec
<u8>, 
	gVec
<
	gu8
>)>> {

286 
Ët
 
mut
 
	g™”
 = 
£lf
.
Ãw_™”©Ü
(
I‹rO±iÚ
::());

287 
	g™”
.
£ek
(
key
.
što
());

288 
Ok
(
™”
.
kv
())

292 
â
 
£ek_cf
(&
£lf
, 
cf
: &
¡r
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<(
Vec
<u8>, 
	gVec
<
	gu8
>)>> {

293 
Ët
 
mut
 
	g™”
 = 
£lf
.
Ãw_™”©Ü_cf
(
cf
, 
I‹rO±iÚ
::())?;

294 
	g™”
.
£ek
(
key
.
što
());

295 
Ok
(
™”
.
kv
())

299 
â
 
	gsÿn_im¶
<
	gF
>(
mut
 
	g™
: 
DBI‹¿tÜ
<&
DB
>, 
	g¡¬t_key
: &[
u8
], 
	gf
: &muˆ
F
è-> 
ResuÉ
<()>

300 
wh”e


301 
F
: 
FnMut
(&[
u8
], &[u8]è-> 
	gResuÉ
<
	gboŞ
>,

303 
	g™
.
£ek
(
¡¬t_key
.
što
());

304 
	g™
.
v®id
() {

305 
Ët
 
	gr
 = 
f
(
™
.
key
(), it.
v®ue
())?;

307 !
	gr
 || !
	g™
.
Ãxt
() {

312 
Ok
(())

315 
im¶
 
P“kabË
 
	gDB
 {

316 
â
 
g‘_v®ue
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
DBVeùÜ
>> {

317 
Ët
 
v
 = 
£lf
.
g‘
(
key
)?;

318 
Ok
(
v
)

321 
â
 
g‘_v®ue_cf
(&
£lf
, 
cf
: &
¡r
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
DBVeùÜ
>> {

322 
Ët
 
hªdË
 = 
rocksdb
::
g‘_cf_hªdË
(
£lf
, 
cf
)?;

323 
Ët
 
	gv
 = 
£lf
.
g‘_cf
(
hªdË
, 
key
)?;

324 
Ok
(
v
)

328 
im¶
 
I‹¿bË
 
	gDB
 {

329 
â
 
Ãw_™”©Ü
(&
£lf
, 
™”_İt
: 
I‹rO±iÚ
è-> 
DBI‹¿tÜ
<&
DB
> {

330 
£lf
.
™”_İt
(™”_İt.
bud_»ad_İts
())

333 
â
 
Ãw_™”©Ü_cf
(&
£lf
, 
cf
: &
¡r
, 
™”_İt
: 
I‹rO±iÚ
è-> 
ResuÉ
<
DBI‹¿tÜ
<&
DB
>> {

334 
Ët
 
hªdË
 = 
rocksdb
::
g‘_cf_hªdË
(
£lf
, 
cf
)?;

335 
Ët
 
	g»adİts
 = 
™”_İt
.
bud_»ad_İts
();

336 
Ok
(
DBI‹¿tÜ
::
Ãw_cf
(
£lf
, 
hªdË
, 
»adİts
))

340 
im¶
 
P“kabË
 
	gSÇpshÙ
 {

341 
â
 
g‘_v®ue
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
DBVeùÜ
>> {

342 
Ët
 
mut
 
İt
 = 
R—dO±iÚs
::
Ãw
();

343 
	gun§ã
 {

344 
	gİt
.
£t_¢­shÙ
(&
£lf
.
¢­
);

346 
Ët
 
	gv
 = 
£lf
.
db
.
g‘_İt
(
key
, &
İt
)?;

347 
Ok
(
v
)

350 
â
 
g‘_v®ue_cf
(&
£lf
, 
cf
: &
¡r
, 
key
: &[
u8
]è-> 
ResuÉ
<
O±iÚ
<
DBVeùÜ
>> {

351 
Ët
 
hªdË
 = 
rocksdb
::
g‘_cf_hªdË
(&
£lf
.
db
, 
cf
)?;

352 
Ët
 
mut
 
	gİt
 = 
R—dO±iÚs
::
Ãw
();

353 
	gun§ã
 {

354 
	gİt
.
£t_¢­shÙ
(&
£lf
.
¢­
);

356 
Ët
 
	gv
 = 
£lf
.
db
.
g‘_cf_İt
(
hªdË
, 
key
, &
İt
)?;

357 
Ok
(
v
)

361 
im¶
 
I‹¿bË
 
	gSÇpshÙ
 {

362 
â
 
Ãw_™”©Ü
(&
£lf
, 
™”_İt
: 
I‹rO±iÚ
è-> 
DBI‹¿tÜ
<&
DB
> {

363 
Ët
 
mut
 
İt
 = 
™”_İt
.
bud_»ad_İts
();

364 
	gun§ã
 {

365 
	gİt
.
£t_¢­shÙ
(&
£lf
.
¢­
);

367 
	gDBI‹¿tÜ
::
Ãw
(&
£lf
.
db
, 
İt
)

370 
â
 
Ãw_™”©Ü_cf
(&
£lf
, 
cf
: &
¡r
, 
™”_İt
: 
I‹rO±iÚ
è-> 
ResuÉ
<
DBI‹¿tÜ
<&
DB
>> {

371 
Ët
 
hªdË
 = 
rocksdb
::
g‘_cf_hªdË
(&
£lf
.
db
, 
cf
)?;

372 
Ët
 
mut
 
	gİt
 = 
™”_İt
.
bud_»ad_İts
();

373 
	gun§ã
 {

374 
	gİt
.
£t_¢­shÙ
(&
£lf
.
¢­
);

376 
Ok
(
DBI‹¿tÜ
::
Ãw_cf
(&
£lf
.
db
, 
hªdË
, 
İt
))

380 
pub
 
Œa™
 
	gMubË
: 
Wr™abË
 {

381 
â
 
put_msg
<
M
: 
´Ùobuf
::
Mes§ge
>(&
£lf
, 
	gkey
: &[
u8
], 
	gm
: &Mè-> 
ResuÉ
<()> {

382 
Ët
 
v®ue
 = 
m
.
wr™e_to_by‹s
()?;

383 
	g£lf
.
put
(
key
, &
v®ue
)?;

384 
Ok
(())

387 
â
 
	gput_msg_cf
<
	gM
: 
´Ùobuf
::
Mes§ge
>(&
£lf
, 
	gcf
: &
CFHªdË
, 
	gkey
: &[
u8
], 
	gm
: &
M
è-> 
ResuÉ
<()> {

388 
Ët
 
v®ue
 = 
m
.
wr™e_to_by‹s
()?;

389 
	g£lf
.
put_cf
(
cf
, 
key
, &
v®ue
)?;

390 
Ok
(())

393 
â
 
put_u64
(&
£lf
, 
key
: &[
u8
], 
n
: 
u64
è-> 
ResuÉ
<()> {

394 
Ët
 
mut
 
v®ue
 = 
vec
![0; 8];

395 
	gBigEndŸn
::
wr™e_u64
(&
mut
 
v®ue
, 
n
);

396 
	g£lf
.
put
(
key
, &
v®ue
)?;

397 
Ok
(())

400 
â
 
put_i64
(&
£lf
, 
key
: &[
u8
], 
n
: 
i64
è-> 
ResuÉ
<()> {

401 
£lf
.
put_u64
(
key
, 
n
 
as
 
u64
)

404 
â
 
d–
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<()> {

405 
£lf
.
d–‘e
(
key
)?;

406 
Ok
(())

410 
im¶
 
MubË
 
	gDB
 {}

411 
im¶
 
MubË
 
	gWr™eB©ch
 {}

413 #[
cfg
(
‹¡
)]

414 
mod
 
	g‹¡s
 {

415 
u£
 
	g¡d
::
sync
::
Arc
;

416 
u£
 
	g‹mpdœ
::
TempDœ
;

417 
u£
 
	grocksdb
::
Wr™abË
;

418 
u£
 
	gsu³r
::*;

419 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

421 #[
‹¡
]

422 
â
 
‹¡_ba£
() {

423 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("v¬").
unw¿p
();

424 
Ët
 
	gcf
 = "cf";

425 
Ët
 
	g’gše
 = 
Arc
::
Ãw
(

426 
rocksdb
::
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), &[
cf
]).unwrap(),

429 
Ët
 
mut
 
	gr
 = 
RegiÚ
::
Ãw
();

430 
	gr
.
£t_id
(10);

432 
Ët
 
	gkey
 = 
b
"key";

433 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(&
’gše
, 
cf
).
unw¿p
();

434 
	g’gše
.
put_msg
(
key
, &
r
).
unw¿p
();

435 
	g’gše
.
put_msg_cf
(
hªdË
, 
key
, &
r
).
unw¿p
();

437 
Ët
 
	g¢­
 = 
SÇpshÙ
::
Ãw
(
’gše
.
şÚe
());

439 
Ët
 
mut
 
	gr1
: 
RegiÚ
 = 
’gše
.
g‘_msg
(
key
).
unw¿p
().unwrap();

440 
	gas£¹_eq
!(
	gr
, 
	gr1
);

441 
Ët
 
	gr1_cf
: 
RegiÚ
 = 
’gše
.
g‘_msg_cf
(
cf
, 
key
).
unw¿p
().unwrap();

442 
	gas£¹_eq
!(
	gr
, 
	gr1_cf
);

444 
Ët
 
mut
 
	gr2
: 
RegiÚ
 = 
¢­
.
g‘_msg
(
key
).
unw¿p
().unwrap();

445 
	gas£¹_eq
!(
	gr
, 
	gr2
);

446 
Ët
 
	gr2_cf
: 
RegiÚ
 = 
¢­
.
g‘_msg_cf
(
cf
, 
key
).
unw¿p
().unwrap();

447 
	gas£¹_eq
!(
	gr
, 
	gr2_cf
);

449 
	gr
.
£t_id
(11);

450 
	g’gše
.
put_msg
(
key
, &
r
).
unw¿p
();

451 
	gr1
 = 
’gše
.
g‘_msg
(
key
).
unw¿p
().unwrap();

452 
	gr2
 = 
¢­
.
g‘_msg
(
key
).
unw¿p
().unwrap();

453 
	gas£¹_Ã
!(
	gr1
, 
	gr2
);

455 
Ët
 
	gb
: 
O±iÚ
<
RegiÚ
> = 
’gše
.
g‘_msg
(
b
"missšg_key").
unw¿p
();

456 
	gas£¹
!(
	gb
.
is_nÚe
());

458 
	g’gše
.
put_i64
(
key
, -1).
unw¿p
();

459 
	gas£¹_eq
!(
	g’gše
.
g‘_i64
(
key
).
unw¿p
(), 
Some
(-1));

460 
	gas£¹
!(
	g’gše
.
g‘_i64
(
b
"missšg_key").
unw¿p
().
is_nÚe
());

462 
Ët
 
	g¢­
 = 
SÇpshÙ
::
Ãw
(
’gše
.
şÚe
());

463 
	gas£¹_eq
!(
	g¢­
.
g‘_i64
(
key
).
unw¿p
(), 
Some
(-1));

464 
	gas£¹
!(
	g¢­
.
g‘_i64
(
b
"missšg_key").
unw¿p
().
is_nÚe
());

466 
	g’gše
.
put_u64
(
key
, 1).
unw¿p
();

467 
	gas£¹_eq
!(
	g’gše
.
g‘_u64
(
key
).
unw¿p
(), 
Some
(1));

468 
	gas£¹_eq
!(
	g¢­
.
g‘_i64
(
key
).
unw¿p
(), 
Some
(-1));

471 #[
‹¡
]

472 
â
 
‹¡_³ekabË
() {

473 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("v¬").
unw¿p
();

474 
Ët
 
	gcf
 = "cf";

475 
Ët
 
	g’gše
 = 
rocksdb
::
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), &[
cf
]).unwrap();

477 
	g’gše
.
put
(
b
"k1", b"v1").
unw¿p
();

478 
Ët
 
	ghªdË
 = 
’gše
.
cf_hªdË
("cf").
unw¿p
();

479 
	g’gše
.
put_cf
(
hªdË
, 
b
"k1", b"v2").
unw¿p
();

481 
	gas£¹_eq
!(&*
	g’gše
.
g‘_v®ue
(
b
"k1").
unw¿p
().unw¿p(), 
	gb
"v1");

482 
	gas£¹
!(
	g’gše
.
g‘_v®ue_cf
("foo", 
b
"k1").
is_”r
());

483 
	gas£¹_eq
!(&*
	g’gše
.
g‘_v®ue_cf
(
cf
, 
b
"k1").
unw¿p
().unw¿p(), 
	gb
"v2");

486 #[
‹¡
]

487 
â
 
‹¡_sÿn
() {

488 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("v¬").
unw¿p
();

489 
Ët
 
	gcf
 = "cf";

490 
Ët
 
	g’gše
 = 
Arc
::
Ãw
(

491 
rocksdb
::
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), &[
cf
]).unwrap(),

493 
Ët
 
	ghªdË
 = 
’gše
.
cf_hªdË
(
cf
).
unw¿p
();

495 
	g’gše
.
put
(
b
"a1", b"v1").
unw¿p
();

496 
	g’gše
.
put
(
b
"a2", b"v2").
unw¿p
();

497 
	g’gše
.
put_cf
(
hªdË
, 
b
"a1", b"v1").
unw¿p
();

498 
	g’gše
.
put_cf
(
hªdË
, 
b
"a2", b"v22").
unw¿p
();

500 
Ët
 
mut
 
	gd©a
 = 
vec
![];

501 
	g’gše


502 .
sÿn
(
b
"", &[0xFF, 0xFF], 
çl£
, &
mut
 |
key
, 
v®ue
| {

503 
d©a
.
push
((
key
.
to_vec
(), 
v®ue
.to_vec()));

504 
Ok
(
Œue
)

506 .
unw¿p
();

507 
	gas£¹_eq
!(

508 
	gd©a
,

509 
	gvec
![

510 (
b
"a1".
to_vec
(), b"v1".to_vec()),

511 (
b
"a2".
to_vec
(), b"v2".to_vec()),

514 
	gd©a
.
ş—r
();

516 
	g’gše


517 .
sÿn_cf
(
cf
, 
b
"", &[0xFF, 0xFF], 
çl£
, &
mut
 |
key
, 
v®ue
| {

518 
d©a
.
push
((
key
.
to_vec
(), 
v®ue
.to_vec()));

519 
Ok
(
Œue
)

521 .
unw¿p
();

522 
	gas£¹_eq
!(

523 
	gd©a
,

524 
	gvec
![

525 (
b
"a1".
to_vec
(), b"v1".to_vec()),

526 (
b
"a2".
to_vec
(), b"v22".to_vec()),

529 
	gd©a
.
ş—r
();

531 
Ët
 
	g·œ
 = 
’gše
.
£ek
(
b
"a1").
unw¿p
().unwrap();

532 
	gas£¹_eq
!(
	g·œ
, (
	gb
"a1".
to_vec
(), b"v1".to_vec()));

533 
	gas£¹
!(
	g’gše
.
£ek
(
b
"a3").
unw¿p
().
is_nÚe
());

534 
Ët
 
	g·œ_cf
 = 
’gše
.
£ek_cf
(
cf
, 
b
"a1").
unw¿p
().unwrap();

535 
	gas£¹_eq
!(
	g·œ_cf
, (
	gb
"a1".
to_vec
(), b"v1".to_vec()));

536 
	gas£¹
!(
	g’gše
.
£ek_cf
(
cf
, 
b
"a3").
unw¿p
().
is_nÚe
());

538 
Ët
 
mut
 
	gšdex
 = 0;

539 
	g’gše


540 .
sÿn
(
b
"", &[0xFF, 0xFF], 
çl£
, &
mut
 |
key
, 
v®ue
| {

541 
d©a
.
push
((
key
.
to_vec
(), 
v®ue
.to_vec()));

542 
šdex
 += 1;

543 
Ok
(
šdex
 != 1)

545 .
unw¿p
();

547 
	gas£¹_eq
!(
	gd©a
.
Ën
(), 1);

549 
Ët
 
	g¢­
 = 
SÇpshÙ
::
Ãw
(
’gše
.
şÚe
());

551 
	g’gše
.
put
(
b
"a3", b"v3").
unw¿p
();

552 
	gas£¹
!(
	g’gše
.
£ek
(
b
"a3").
unw¿p
().
is_some
());

554 
Ët
 
	g·œ
 = 
¢­
.
£ek
(
b
"a1").
unw¿p
().unwrap();

555 
	gas£¹_eq
!(
	g·œ
, (
	gb
"a1".
to_vec
(), b"v1".to_vec()));

556 
	gas£¹
!(
	g¢­
.
£ek
(
b
"a3").
unw¿p
().
is_nÚe
());

558 
	gd©a
.
ş—r
();

560 
	g¢­
.
sÿn
(
b
"", &[0xFF, 0xFF], 
çl£
, &
mut
 |
key
, 
v®ue
| {

561 
d©a
.
push
((
key
.
to_vec
(), 
v®ue
.to_vec()));

562 
Ok
(
Œue
)

563 }).
unw¿p
();

565 
	gas£¹_eq
!(
	gd©a
.
Ën
(), 2);

	@src/raftstore/store/keys.rs

14 
u£
 
	gby‹Üd”
::{
BigEndŸn
, 
	gBy‹Ord”
, 
	gWr™eBy‹sExt
};

16 
u£
 
	g¿á¡Üe
::
ResuÉ
;

17 
u£
 
	gut
::
esÿ³
;

18 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

19 
u£
 
	g¡d
::
mem
;

21 
pub
 cÚ¡ 
	gMIN_KEY
: &'static [u8] = &[];

22 
pub
 cÚ¡ 
MAX_KEY
: &'static [u8] = &[0xFF];

24 
pub
 cÚ¡ 
EMPTY_KEY
: &'static [u8] = &[];

27 
pub
 cÚ¡ 
LOCAL_PREFIX
: 
u8
 = 0x01;

28 
pub
 cÚ¡ 
	gLOCAL_MIN_KEY
: &'static [u8] = &[LOCAL_PREFIX];

29 
pub
 cÚ¡ 
LOCAL_MAX_KEY
: &'static [u8] = &[LOCAL_PREFIX + 1];

31 
pub
 cÚ¡ 
DATA_PREFIX
: 
u8
 = 
b
'z';

32 
pub
 cÚ¡ 
	gDATA_PREFIX_KEY
: &'static [u8] = &[DATA_PREFIX];

33 
pub
 cÚ¡ 
DATA_MIN_KEY
: &'static [u8] = &[DATA_PREFIX];

34 
pub
 cÚ¡ 
DATA_MAX_KEY
: &'static [u8] = &[DATA_PREFIX + 1];

37 
pub
 cÚ¡ 
STORE_IDENT_KEY
: &'static [u8] = &[LOCAL_PREFIX, 0x01];

38 
pub
 cÚ¡ 
PREPARE_BOOTSTRAP_KEY
: &'static [u8] = &[LOCAL_PREFIX, 0x02];

43 
pub
 cÚ¡ 
REGION_RAFT_PREFIX
: 
u8
 = 0x02;

44 
pub
 cÚ¡ 
	gREGION_RAFT_PREFIX_KEY
: &'static [u8] = &[LOCAL_PREFIX, REGION_RAFT_PREFIX];

45 
pub
 cÚ¡ 
REGION_META_PREFIX
: 
u8
 = 0x03;

46 
pub
 cÚ¡ 
	gREGION_META_PREFIX_KEY
: &'static [u8] = &[LOCAL_PREFIX, REGION_META_PREFIX];

47 
pub
 cÚ¡ 
REGION_META_MIN_KEY
: &'static [u8] = &[LOCAL_PREFIX, REGION_META_PREFIX];

48 
pub
 cÚ¡ 
REGION_META_MAX_KEY
: &'static [u8] = &[LOCAL_PREFIX, REGION_META_PREFIX + 1];

52 
pub
 cÚ¡ 
RAFT_LOG_SUFFIX
: 
u8
 = 0x01;

53 
pub
 cÚ¡ 
	gRAFT_STATE_SUFFIX
: 
u8
 = 0x02;

54 
pub
 cÚ¡ 
	gAPPLY_STATE_SUFFIX
: 
u8
 = 0x03;

55 
pub
 cÚ¡ 
	gSNAPSHOT_RAFT_STATE_SUFFIX
: 
u8
 = 0x04;

58 
pub
 cÚ¡ 
	gREGION_STATE_SUFFIX
: 
u8
 = 0x01;

60 
pub
 
â
 
¡Üe_id’t_key
(è-> 
	gVec
<
	gu8
> {

61 
	gSTORE_IDENT_KEY
.
to_vec
()

64 
pub
 
â
 
´•¬e_boÙ¡¿p_key
(è-> 
	gVec
<
	gu8
> {

65 
	gPREPARE_BOOTSTRAP_KEY
.
to_vec
()

68 
â
 
make_»giÚ_id_key
(
»giÚ_id
: 
u64
, 
suffix
: 
u8
, 
exŒa_ÿp
: 
usize
è-> 
Vec
<u8> {

69 
Ët
 
mut
 
key
 = 
Vec
::
w™h_ÿ·c™y
(

70 
REGION_RAFT_PREFIX_KEY
.
Ën
(è+ 
mem
::
size_of
::<
u64
>(è+ mem::size_of::<
u8
>(è+ 
exŒa_ÿp
,

72 
	gkey
.
ex‹nd_äom_¦iû
(
REGION_RAFT_PREFIX_KEY
);

74 
	gkey
.
	gwr™e_u64
::<
BigEndŸn
>(
»giÚ_id
).
unw¿p
();

75 
	gkey
.
push
(
suffix
);

76 
	gkey


79 
pub
 
â
 
»giÚ_¿á_´efix
(
»giÚ_id
: 
u64
è-> 
Vec
<
u8
> {

80 
Ët
 
mut
 
key
 = 
Vec
::
w™h_ÿ·c™y
(
REGION_RAFT_PREFIX_KEY
.
Ën
(è+ 
mem
::
size_of
::<
u64
>());

81 
	gkey
.
ex‹nd_äom_¦iû
(
REGION_RAFT_PREFIX_KEY
);

83 
	gkey
.
	gwr™e_u64
::<
BigEndŸn
>(
»giÚ_id
).
unw¿p
();

84 
	gkey


87 
pub
 
â
 
»giÚ_¿á_´efix_Ën
(è-> 
	gusize
 {

89 
	gREGION_RAFT_PREFIX_KEY
.
Ën
(è+ 
	gmem
::
size_of
::<
u64
>() + 1

92 
pub
 
â
 
¿á_log_key
(
»giÚ_id
: 
u64
, 
log_šdex
: u64è-> 
Vec
<
u8
> {

93 
Ët
 
mut
 
key
 = 
make_»giÚ_id_key
(
»giÚ_id
, 
RAFT_LOG_SUFFIX
, 
mem
::
size_of
::<
u64
>());

95 
	gkey
.
	gwr™e_u64
::<
BigEndŸn
>(
log_šdex
).
unw¿p
();

96 
	gkey


99 
pub
 
â
 
¿á_¡©e_key
(
»giÚ_id
: 
u64
è-> 
Vec
<
u8
> {

100 
make_»giÚ_id_key
(
»giÚ_id
, 
RAFT_STATE_SUFFIX
, 0)

103 
pub
 
â
 
¢­shÙ_¿á_¡©e_key
(
»giÚ_id
: 
u64
è-> 
Vec
<
u8
> {

104 
make_»giÚ_id_key
(
»giÚ_id
, 
SNAPSHOT_RAFT_STATE_SUFFIX
, 0)

107 
pub
 
â
 
­¶y_¡©e_key
(
»giÚ_id
: 
u64
è-> 
Vec
<
u8
> {

108 
make_»giÚ_id_key
(
»giÚ_id
, 
APPLY_STATE_SUFFIX
, 0)

112 
pub
 
â
 
¿á_log_šdex
(
key
: &[
u8
]è-> 
ResuÉ
<
u64
> {

113 
Ët
 
ex³ù_key_Ën
 = 
REGION_RAFT_PREFIX_KEY
.
Ën
(è+ 
mem
::
size_of
::<
u64
>() +

114 
mem
::
size_of
::<
u8
>(è+ mem::size_of::<
u64
>();

115 
	gkey
.
Ën
(è!ğ
ex³ù_key_Ën
 {

116  
E¼
(
box_”r
!("key {} i nÙ‡ v®id„aá†og key", 
esÿ³
(
key
)));

118 
Ok
(
BigEndŸn
::
»ad_u64
(

119 &
key
[
ex³ù_key_Ën
 - 
mem
::
size_of
::<
u64
>()..],

124 
pub
 
â
 
decode_¿á_log_key
(
key
: &[
u8
]è-> 
ResuÉ
<(
u64
, 
	gu64
)> {

125 
Ët
 
	gsuffix_idx
 = 
REGION_RAFT_PREFIX_KEY
.
Ën
(è+ 
mem
::
size_of
::<
u64
>();

126 
Ët
 
	gex³ù_key_Ën
 = 
suffix_idx
 + 
mem
::
size_of
::<
u8
>(è+ mem::size_of::<
u64
>();

127 
	gkey
.
Ën
(è!ğ
ex³ù_key_Ën
 || !
key
.
¡¬ts_w™h
(
REGION_RAFT_PREFIX_KEY
) ||

128 
key
[
suffix_idx
] !ğ
RAFT_LOG_SUFFIX


130  
E¼
(
box_”r
!("key {} i nÙ‡ v®id„aá†og key", 
esÿ³
(
key
)));

132 
Ët
 
	g»giÚ_id
 = 
BigEndŸn
::
»ad_u64
(&
key
[
REGION_RAFT_PREFIX_KEY
.
Ën
()..
suffix_idx
]);

133 
Ët
 
	gšdex
 = 
BigEndŸn
::
»ad_u64
(&
key
[
suffix_idx
 + 
mem
::
size_of
::<
u8
>()..]);

134 
Ok
((
»giÚ_id
, 
šdex
))

137 
pub
 
â
 
¿á_log_´efix
(
»giÚ_id
: 
u64
è-> 
Vec
<
u8
> {

138 
make_»giÚ_id_key
(
»giÚ_id
, 
RAFT_LOG_SUFFIX
, 0)

141 
â
 
make_»giÚ_m‘a_key
(
»giÚ_id
: 
u64
, 
suffix
: 
u8
è-> 
Vec
<u8> {

142 
Ët
 
mut
 
key
 = 
Vec
::
w™h_ÿ·c™y
(

143 
REGION_META_PREFIX_KEY
.
Ën
(è+ 
mem
::
size_of
::<
u64
>(è+ mem::size_of::<
u8
>(),

145 
	gkey
.
ex‹nd_äom_¦iû
(
REGION_META_PREFIX_KEY
);

147 
	gkey
.
	gwr™e_u64
::<
BigEndŸn
>(
»giÚ_id
).
unw¿p
();

148 
	gkey
.
push
(
suffix
);

149 
	gkey


153 
pub
 
â
 
decode_»giÚ_m‘a_key
(
key
: &[
u8
]è-> 
ResuÉ
<(
u64
, 
	gu8
)> {

154 
	gREGION_META_PREFIX_KEY
.
Ën
(è+ 
	gmem
::
size_of
::<
u64
>(è+ 
mem
::size_of::<
u8
>(è!ğ
key
.len() {

155  
E¼
(
box_”r
!(

157 
esÿ³
(
key
)

161 !
	gkey
.
¡¬ts_w™h
(
REGION_META_PREFIX_KEY
) {

162  
E¼
(
box_”r
!(

164 
esÿ³
(
key
)

168 
Ët
 
	g»giÚ_id
 = 
BigEndŸn
::
»ad_u64
(

169 &
key
[
REGION_META_PREFIX_KEY
.
Ën
()..REGION_META_PREFIX_KEY.Ën(è+ 
mem
::
size_of
::<
u64
>()],

172 
Ok
((
»giÚ_id
, 
key
[key.
Ën
() - 1]))

175 
pub
 
â
 
»giÚ_m‘a_´efix
(
»giÚ_id
: 
u64
è-> 
Vec
<
u8
> {

176 
Ët
 
mut
 
key
 = 
Vec
::
w™h_ÿ·c™y
(
REGION_META_PREFIX_KEY
.
Ën
(è+ 
mem
::
size_of
::<
u64
>());

177 
	gkey
.
ex‹nd_äom_¦iû
(
REGION_META_PREFIX_KEY
);

178 
	gkey
.
	gwr™e_u64
::<
BigEndŸn
>(
»giÚ_id
).
unw¿p
();

179 
	gkey


182 
pub
 
â
 
»giÚ_¡©e_key
(
»giÚ_id
: 
u64
è-> 
Vec
<
u8
> {

183 
make_»giÚ_m‘a_key
(
»giÚ_id
, 
REGION_STATE_SUFFIX
)

186 
pub
 
â
 
v®id©e_d©a_key
(
key
: &[
u8
]è-> 
boŞ
 {

187 
key
.
¡¬ts_w™h
(
DATA_PREFIX_KEY
)

190 
pub
 
â
 
d©a_key
(
key
: &[
u8
]è-> 
Vec
<u8> {

191 
Ët
 
mut
 
v
 = 
Vec
::
w™h_ÿ·c™y
(
DATA_PREFIX_KEY
.
Ën
(è+ 
key
.len());

192 
	gv
.
ex‹nd_äom_¦iû
(
DATA_PREFIX_KEY
);

193 
	gv
.
ex‹nd_äom_¦iû
(
key
);

194 
	gv


197 
pub
 
â
 
Üigš_key
(
key
: &[
u8
]) -> &[u8] {

198 
as£¹
!(
v®id©e_d©a_key
(
key
), "šv®id d©¨key {:?}", 
esÿ³
(key));

199 &
	gkey
[
DATA_PREFIX_KEY
.
Ën
()..]

203 
pub
 
â
 
’c_¡¬t_key
(
»giÚ
: &
RegiÚ
è-> 
Vec
<
u8
> {

206 
as£¹
!(!
»giÚ
.
g‘_³”s
().
is_em±y
());

207 
d©a_key
(
»giÚ
.
g‘_¡¬t_key
())

211 
pub
 
â
 
’c_’d_key
(
»giÚ
: &
RegiÚ
è-> 
Vec
<
u8
> {

214 
as£¹
!(!
»giÚ
.
g‘_³”s
().
is_em±y
());

215 
d©a_’d_key
(
»giÚ
.
g‘_’d_key
())

218 #[
šlše
]

219 
pub
 
â
 
d©a_’d_key
(
»giÚ_’d_key
: &[
u8
]è-> 
Vec
<u8> {

220 
»giÚ_’d_key
.
is_em±y
() {

221 
DATA_MAX_KEY
.
to_vec
()

223 
d©a_key
(
»giÚ_’d_key
)

227 #[
cfg
(
‹¡
)]

228 
mod
 
‹¡s
 {

229 
u£
 
su³r
::*;

230 
u£
 
	gby‹Üd”
::{
BigEndŸn
, 
	gWr™eBy‹sExt
};

231 
u£
 
	gkv´Ùo
::
m‘­b
::{
P“r
, 
	gRegiÚ
};

232 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

234 #[
‹¡
]

235 
â
 
‹¡_»giÚ_id_key
() {

236 
Ët
 
	g»giÚ_ids
 = 
vec
![0, 1, 1024, ::
¡d
::
u64
::
MAX
];

237 
»giÚ_id
 
š
 
	g»giÚ_ids
 {

238 
Ët
 
	g´efix
 = 
»giÚ_¿á_´efix
(
»giÚ_id
);

240 
	gas£¹
!(
¿á_log_´efix
(
»giÚ_id
).
¡¬ts_w™h
(&
´efix
));

241 
	gas£¹
!(
¿á_log_key
(
»giÚ_id
, 1).
¡¬ts_w™h
(&
´efix
));

242 
	gas£¹
!(
¿á_¡©e_key
(
»giÚ_id
).
¡¬ts_w™h
(&
´efix
));

243 
	gas£¹
!(
­¶y_¡©e_key
(
»giÚ_id
).
¡¬ts_w™h
(&
´efix
));

247 
Ët
 
	gtbls
 = 
vec
![

248 (1, 0, 
Ord”šg
::
G»©”
),

249 (1, 1, 
Ord”šg
::
Equ®
),

250 (1, 2, 
Ord”šg
::
Less
),

252 
	glid
, 
	grid
, 
	gÜd”
è
š
 
	gtbls
 {

253 
Ët
 
	glhs
 = 
»giÚ_¿á_´efix
(
lid
);

254 
Ët
 
	grhs
 = 
»giÚ_¿á_´efix
(
rid
);

255 
	gas£¹_eq
!(
	glhs
.
·¹Ÿl_cmp
(&
rhs
), 
Some
(
Üd”
));

257 
Ët
 
	glhs
 = 
¿á_¡©e_key
(
lid
);

258 
Ët
 
	grhs
 = 
¿á_¡©e_key
(
rid
);

259 
	gas£¹_eq
!(
	glhs
.
·¹Ÿl_cmp
(&
rhs
), 
Some
(
Üd”
));

261 
Ët
 
	glhs
 = 
­¶y_¡©e_key
(
lid
);

262 
Ët
 
	grhs
 = 
­¶y_¡©e_key
(
rid
);

263 
	gas£¹_eq
!(
	glhs
.
·¹Ÿl_cmp
(&
rhs
), 
Some
(
Üd”
));

267 #[
‹¡
]

268 
â
 
‹¡_¿á_log_sÜt
() {

269 
Ët
 
	gtbls
 = 
vec
![

270 (1, 1, 1, 2, 
Ord”šg
::
Less
),

271 (2, 1, 1, 2, 
Ord”šg
::
G»©”
),

272 (1, 1, 1, 1, 
Ord”šg
::
Equ®
),

275 
	glid
, 
	gl_log_id
, 
	grid
, 
	gr_log_id
, 
	gÜd”
è
š
 
	gtbls
 {

276 
Ët
 
	glhs
 = 
¿á_log_key
(
lid
, 
l_log_id
);

277 
Ët
 
	grhs
 = 
¿á_log_key
(
rid
, 
r_log_id
);

278 
	gas£¹_eq
!(
	glhs
.
·¹Ÿl_cmp
(&
rhs
), 
Some
(
Üd”
));

282 #[
‹¡
]

283 
â
 
‹¡_»giÚ_m‘a_key
() {

284 
Ët
 
	gids
 = 
vec
![1, 1024, 
u64
::
max_v®ue
()];

285 
id
 
š
 
	gids
 {

286 
Ët
 
	g´efix
 = 
»giÚ_m‘a_´efix
(
id
);

287 
Ët
 
	gšfo_key
 = 
»giÚ_¡©e_key
(
id
);

288 
	gas£¹
!(
	gšfo_key
.
¡¬ts_w™h
(&
´efix
));

290 
	gas£¹_eq
!(

291 
decode_»giÚ_m‘a_key
(&
šfo_key
).
unw¿p
(),

292 (
	gid
, 
	gREGION_STATE_SUFFIX
)

297 
Ët
 
	gtbls
: 
Vec
<(
u64
, 
	gu64
, 
	gOrd”šg
)> = 
vec
![

298 (1, 2, 
Ord”šg
::
Less
),

299 (1, 1, 
Ord”šg
::
Equ®
),

300 (2, 1, 
Ord”šg
::
G»©”
),

303 
	glkey
, 
	grkey
, 
	gÜd”
è
š
 
	gtbls
 {

304 
Ët
 
	glhs
 = 
»giÚ_¡©e_key
(
lkey
);

305 
Ët
 
	grhs
 = 
»giÚ_¡©e_key
(
rkey
);

306 
	gas£¹_eq
!(
	glhs
.
·¹Ÿl_cmp
(&
rhs
), 
Some
(
Üd”
));

310 #[
‹¡
]

311 
â
 
‹¡_¿á_log_key
() {

312 
»giÚ_id
 
	gš
 1..10 {

313 
idx_id
 
	gš
 1..10 {

314 
Ët
 
	gkey
 = 
¿á_log_key
(
»giÚ_id
, 
idx_id
);

315 
	gas£¹_eq
!(
	gidx_id
, 
¿á_log_šdex
(&
key
).
unw¿p
());

316 
	gas£¹_eq
!((
	g»giÚ_id
, 
	gidx_id
), 
decode_¿á_log_key
(&
key
).
unw¿p
());

320 
Ët
 
mut
 
	g¡©e_key
 = 
¿á_¡©e_key
(1);

322 
	gas£¹
!(
decode_¿á_log_key
(&
¡©e_key
).
is_”r
());

324 
	g¡©e_key
.
	gwr™e_u64
::<
BigEndŸn
>(2).
unw¿p
();

326 
	gas£¹
!(
decode_¿á_log_key
(&
¡©e_key
).
is_”r
());

328 
Ët
 
mut
 
	g»giÚ_¡©e_key
 = 
»giÚ_¡©e_key
(1);

329 
	g»giÚ_¡©e_key
.
	gwr™e_u64
::<
BigEndŸn
>(2).
unw¿p
();

331 
	gas£¹
!(
decode_¿á_log_key
(&
»giÚ_¡©e_key
).
is_”r
());

334 #[
‹¡
]

335 
â
 
‹¡_d©a_key
() {

336 
	gas£¹
!(
v®id©e_d©a_key
(&
d©a_key
(
b
"abc")));

337 
	gas£¹
!(!
v®id©e_d©a_key
(
b
"abc"));

339 
Ët
 
mut
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

341 
	gas£¹
!(
	g»cov”_§ã
!(|| 
’c_¡¬t_key
(&
»giÚ
)).
is_”r
());

342 
	gas£¹
!(
	g»cov”_§ã
!(|| 
’c_’d_key
(&
»giÚ
)).
is_”r
());

344 
	g»giÚ
.
mut_³”s
().
push
(
P“r
::
Ãw
());

345 
	gas£¹_eq
!(
’c_¡¬t_key
(&
»giÚ
), 
	gvec
![
DATA_PREFIX
]);

346 
	gas£¹_eq
!(
’c_’d_key
(&
»giÚ
), 
	gvec
![
DATA_PREFIX
 + 1]);

348 
	g»giÚ
.
£t_¡¬t_key
(
vec
![1]);

349 
	g»giÚ
.
£t_’d_key
(
vec
![2]);

350 
	gas£¹_eq
!(
’c_¡¬t_key
(&
»giÚ
), 
	gvec
![
DATA_PREFIX
, 1]);

351 
	gas£¹_eq
!(
’c_’d_key
(&
»giÚ
), 
	gvec
![
DATA_PREFIX
, 2]);

	@src/raftstore/store/local_metrics.rs

15 
u£
 
	g´om‘heus
::
loÿl
::
LoÿlHi¡og¿m
;

17 
u£
 
	gsu³r
::
m‘rics
::*;

20 #[
d”ive
(
Debug
, 
DeçuÉ
, 
ClÚe
)]

21 
pub
 
	sRaáR—dyM‘rics
 {

22 
pub
 
	mmes§ge
: 
u64
,

23 
pub
 
	mcomm™
: 
u64
,

24 
pub
 
	m­³nd
: 
u64
,

25 
pub
 
	m¢­shÙ
: 
u64
,

26 
pub
 
	m³ndšg_»giÚ
: 
u64
,

27 
pub
 
	mhas_»ady_»giÚ
: 
u64
,

30 
im¶
 
	gRaáR—dyM‘rics
 {

32 
â
 
æush
(&
mut
 
£lf
) {

34 
	g£lf
.
	gmes§ge
 > 0 {

35 
	gSTORE_RAFT_READY_COUNTER_VEC


36 .
w™h_Ïb–_v®ues
(&["message"])

37 .
šc_by
(
£lf
.
mes§ge
 
as
 
f64
)

38 .
unw¿p
();

39 
	g£lf
.
	gmes§ge
 = 0;

41 
	g£lf
.
	gcomm™
 > 0 {

42 
	gSTORE_RAFT_READY_COUNTER_VEC


43 .
w™h_Ïb–_v®ues
(&["commit"])

44 .
šc_by
(
£lf
.
comm™
 
as
 
f64
)

45 .
unw¿p
();

46 
	g£lf
.
	gcomm™
 = 0;

48 
	g£lf
.
	g­³nd
 > 0 {

49 
	gSTORE_RAFT_READY_COUNTER_VEC


50 .
w™h_Ïb–_v®ues
(&["append"])

51 .
šc_by
(
£lf
.
­³nd
 
as
 
f64
)

52 .
unw¿p
();

53 
	g£lf
.
	g­³nd
 = 0;

55 
	g£lf
.
	g¢­shÙ
 > 0 {

56 
	gSTORE_RAFT_READY_COUNTER_VEC


57 .
w™h_Ïb–_v®ues
(&["snapshot"])

58 .
šc_by
(
£lf
.
¢­shÙ
 
as
 
f64
)

59 .
unw¿p
();

60 
	g£lf
.
	g¢­shÙ
 = 0;

62 
	g£lf
.
	g³ndšg_»giÚ
 > 0 {

63 
	gSTORE_RAFT_READY_COUNTER_VEC


64 .
w™h_Ïb–_v®ues
(&["pending_region"])

65 .
šc_by
(
£lf
.
³ndšg_»giÚ
 
as
 
f64
)

66 .
unw¿p
();

67 
	g£lf
.
	g³ndšg_»giÚ
 = 0;

69 
	g£lf
.
	ghas_»ady_»giÚ
 > 0 {

70 
	gSTORE_RAFT_READY_COUNTER_VEC


71 .
w™h_Ïb–_v®ues
(&["has_ready_region"])

72 .
šc_by
(
£lf
.
has_»ady_»giÚ
 
as
 
f64
)

73 .
unw¿p
();

74 
	g£lf
.
	ghas_»ady_»giÚ
 = 0;

80 #[
d”ive
(
Debug
, 
DeçuÉ
, 
ClÚe
)]

81 
pub
 
	sRaáMes§geM‘rics
 {

82 
pub
 
	m­³nd
: 
u64
,

83 
pub
 
	m­³nd_»¥
: 
u64
,

84 
pub
 
	mvÙe
: 
u64
,

85 
pub
 
	mvÙe_»¥
: 
u64
,

86 
pub
 
	m¢­shÙ
: 
u64
,

87 
pub
 
	mh—¹b—t
: 
u64
,

88 
pub
 
	mh—¹b—t_»¥
: 
u64
,

89 
pub
 
	mŒªsãr_Ëad”
: 
u64
,

90 
pub
 
	mtimeout_now
: 
u64
,

93 
im¶
 
	gRaáMes§geM‘rics
 {

95 
â
 
æush
(&
mut
 
£lf
) {

97 
	g£lf
.
	g­³nd
 > 0 {

98 
	gSTORE_RAFT_SENT_MESSAGE_COUNTER_VEC


99 .
w™h_Ïb–_v®ues
(&["append"])

100 .
šc_by
(
£lf
.
­³nd
 
as
 
f64
)

101 .
unw¿p
();

102 
	g£lf
.
	g­³nd
 = 0;

104 
	g£lf
.
	g­³nd_»¥
 > 0 {

105 
	gSTORE_RAFT_SENT_MESSAGE_COUNTER_VEC


106 .
w™h_Ïb–_v®ues
(&["append_resp"])

107 .
šc_by
(
£lf
.
­³nd_»¥
 
as
 
f64
)

108 .
unw¿p
();

109 
	g£lf
.
	g­³nd_»¥
 = 0;

111 
	g£lf
.
	gvÙe
 > 0 {

112 
	gSTORE_RAFT_SENT_MESSAGE_COUNTER_VEC


113 .
w™h_Ïb–_v®ues
(&["vote"])

114 .
šc_by
(
£lf
.
vÙe
 
as
 
f64
)

115 .
unw¿p
();

116 
	g£lf
.
	gvÙe
 = 0;

118 
	g£lf
.
	gvÙe_»¥
 > 0 {

119 
	gSTORE_RAFT_SENT_MESSAGE_COUNTER_VEC


120 .
w™h_Ïb–_v®ues
(&["vote_resp"])

121 .
šc_by
(
£lf
.
vÙe_»¥
 
as
 
f64
)

122 .
unw¿p
();

123 
	g£lf
.
	gvÙe_»¥
 = 0;

125 
	g£lf
.
	g¢­shÙ
 > 0 {

126 
	gSTORE_RAFT_SENT_MESSAGE_COUNTER_VEC


127 .
w™h_Ïb–_v®ues
(&["snapshot"])

128 .
šc_by
(
£lf
.
¢­shÙ
 
as
 
f64
)

129 .
unw¿p
();

130 
	g£lf
.
	g¢­shÙ
 = 0;

132 
	g£lf
.
	gh—¹b—t
 > 0 {

133 
	gSTORE_RAFT_SENT_MESSAGE_COUNTER_VEC


134 .
w™h_Ïb–_v®ues
(&["heartbeat"])

135 .
šc_by
(
£lf
.
h—¹b—t
 
as
 
f64
)

136 .
unw¿p
();

137 
	g£lf
.
	gh—¹b—t
 = 0;

139 
	g£lf
.
	gh—¹b—t_»¥
 > 0 {

140 
	gSTORE_RAFT_SENT_MESSAGE_COUNTER_VEC


141 .
w™h_Ïb–_v®ues
(&["heartbeat_resp"])

142 .
šc_by
(
£lf
.
h—¹b—t_»¥
 
as
 
f64
)

143 .
unw¿p
();

144 
	g£lf
.
	gh—¹b—t_»¥
 = 0;

146 
	g£lf
.
	gŒªsãr_Ëad”
 > 0 {

147 
	gSTORE_RAFT_SENT_MESSAGE_COUNTER_VEC


148 .
w™h_Ïb–_v®ues
(&["transfer_leader"])

149 .
šc_by
(
£lf
.
Œªsãr_Ëad”
 
as
 
f64
)

150 .
unw¿p
();

151 
	g£lf
.
	gŒªsãr_Ëad”
 = 0;

153 
	g£lf
.
	gtimeout_now
 > 0 {

154 
	gSTORE_RAFT_SENT_MESSAGE_COUNTER_VEC


155 .
w™h_Ïb–_v®ues
(&["timeout_now"])

156 .
šc_by
(
£lf
.
timeout_now
 
as
 
f64
)

157 .
unw¿p
();

158 
	g£lf
.
	gtimeout_now
 = 0;

163 #[
d”ive
(
Debug
, 
DeçuÉ
, 
ClÚe
)]

164 
pub
 
	sRaáMes§geDrİM‘rics
 {

165 
pub
 
	mmism©ch_¡Üe_id
: 
u64
,

166 
pub
 
	mmism©ch_»giÚ_•och
: 
u64
,

167 
pub
 
	m¡®e_msg
: 
u64
,

168 
pub
 
	m»giÚ_ov”Ïp
: 
u64
,

169 
pub
 
	m»giÚ_no_³”
: 
u64
,

170 
pub
 
	m»giÚ_tomb¡Úe_³”
: 
u64
,

171 
pub
 
	m»giÚ_nÚexi¡’t
: 
u64
,

172 
pub
 
	m­¶yšg_¢­
: 
u64
,

175 
im¶
 
	gRaáMes§geDrİM‘rics
 {

176 
â
 
æush
(&
mut
 
£lf
) {

177 
	g£lf
.
	gmism©ch_¡Üe_id
 > 0 {

178 
	gSTORE_RAFT_DROPPED_MESSAGE_COUNTER_VEC


179 .
w™h_Ïb–_v®ues
(&["mismatch_store_id"])

180 .
šc_by
(
£lf
.
mism©ch_¡Üe_id
 
as
 
f64
)

181 .
unw¿p
();

182 
	g£lf
.
	gmism©ch_¡Üe_id
 = 0;

184 
	g£lf
.
	gmism©ch_»giÚ_•och
 > 0 {

185 
	gSTORE_RAFT_DROPPED_MESSAGE_COUNTER_VEC


186 .
w™h_Ïb–_v®ues
(&["mismatch_region_epoch"])

187 .
šc_by
(
£lf
.
mism©ch_»giÚ_•och
 
as
 
f64
)

188 .
unw¿p
();

189 
	g£lf
.
	gmism©ch_»giÚ_•och
 = 0;

191 
	g£lf
.
	g¡®e_msg
 > 0 {

192 
	gSTORE_RAFT_DROPPED_MESSAGE_COUNTER_VEC


193 .
w™h_Ïb–_v®ues
(&["stale_msg"])

194 .
šc_by
(
£lf
.
¡®e_msg
 
as
 
f64
)

195 .
unw¿p
();

196 
	g£lf
.
	g¡®e_msg
 = 0;

198 
	g£lf
.
	g»giÚ_ov”Ïp
 > 0 {

199 
	gSTORE_RAFT_DROPPED_MESSAGE_COUNTER_VEC


200 .
w™h_Ïb–_v®ues
(&["region_overlap"])

201 .
šc_by
(
£lf
.
»giÚ_ov”Ïp
 
as
 
f64
)

202 .
unw¿p
();

203 
	g£lf
.
	g»giÚ_ov”Ïp
 = 0;

205 
	g£lf
.
	g»giÚ_no_³”
 > 0 {

206 
	gSTORE_RAFT_DROPPED_MESSAGE_COUNTER_VEC


207 .
w™h_Ïb–_v®ues
(&["region_no_peer"])

208 .
šc_by
(
£lf
.
»giÚ_no_³”
 
as
 
f64
)

209 .
unw¿p
();

210 
	g£lf
.
	g»giÚ_no_³”
 = 0;

212 
	g£lf
.
	g»giÚ_tomb¡Úe_³”
 > 0 {

213 
	gSTORE_RAFT_DROPPED_MESSAGE_COUNTER_VEC


214 .
w™h_Ïb–_v®ues
(&["region_tombstone_peer"])

215 .
šc_by
(
£lf
.
»giÚ_tomb¡Úe_³”
 
as
 
f64
)

216 .
unw¿p
();

217 
	g£lf
.
	g»giÚ_tomb¡Úe_³”
 = 0;

219 
	g£lf
.
	g»giÚ_nÚexi¡’t
 > 0 {

220 
	gSTORE_RAFT_DROPPED_MESSAGE_COUNTER_VEC


221 .
w™h_Ïb–_v®ues
(&["region_nonexistent"])

222 .
šc_by
(
£lf
.
»giÚ_nÚexi¡’t
 
as
 
f64
)

223 .
unw¿p
();

224 
	g£lf
.
	g»giÚ_nÚexi¡’t
 = 0;

226 
	g£lf
.
	g­¶yšg_¢­
 > 0 {

227 
	gSTORE_RAFT_DROPPED_MESSAGE_COUNTER_VEC


228 .
w™h_Ïb–_v®ues
(&["applying_snap"])

229 .
šc_by
(
£lf
.
­¶yšg_¢­
 
as
 
f64
)

230 .
unw¿p
();

231 
	g£lf
.
	g­¶yšg_¢­
 = 0;

237 #[
d”ive
(
ClÚe
)]

238 
pub
 
	sRaáPrİo£M‘rics
 {

239 
pub
 
	m®l
: 
u64
,

240 
pub
 
	mloÿl_»ad
: 
u64
,

241 
pub
 
	m»ad_šdex
: 
u64
,

242 
pub
 
	mnÜm®
: 
u64
,

243 
pub
 
	mŒªsãr_Ëad”
: 
u64
,

244 
pub
 
	mcÚf_chªge
: 
u64
,

245 
pub
 
	m»que¡_wa™_time
: 
LoÿlHi¡og¿m
,

248 
im¶
 
DeçuÉ
 
	gRaáPrİo£M‘rics
 {

249 
â
 (è-> 
	gRaáPrİo£M‘rics
 {

250 
	gRaáPrİo£M‘rics
 {

251 
	g®l
: 0,

252 
	gloÿl_»ad
: 0,

253 
	g»ad_šdex
: 0,

254 
	gnÜm®
: 0,

255 
	gŒªsãr_Ëad”
: 0,

256 
	gcÚf_chªge
: 0,

257 
	g»que¡_wa™_time
: 
REQUEST_WAIT_TIME_HISTOGRAM
.
loÿl
(),

262 
im¶
 
	gRaáPrİo£M‘rics
 {

264 
â
 
æush
(&
mut
 
£lf
) {

266 
	g£lf
.
	g®l
 > 0 {

267 
	gPEER_PROPOSAL_COUNTER_VEC


268 .
w™h_Ïb–_v®ues
(&["all"])

269 .
šc_by
(
£lf
.
®l
 
as
 
f64
)

270 .
unw¿p
();

271 
	g£lf
.
	g®l
 = 0;

273 
	g£lf
.
	gloÿl_»ad
 > 0 {

274 
	gPEER_PROPOSAL_COUNTER_VEC


275 .
w™h_Ïb–_v®ues
(&["local_read"])

276 .
šc_by
(
£lf
.
loÿl_»ad
 
as
 
f64
)

277 .
unw¿p
();

278 
	g£lf
.
	gloÿl_»ad
 = 0;

280 
	g£lf
.
	g»ad_šdex
 > 0 {

281 
	gPEER_PROPOSAL_COUNTER_VEC


282 .
w™h_Ïb–_v®ues
(&["read_index"])

283 .
šc_by
(
£lf
.
»ad_šdex
 
as
 
f64
)

284 .
unw¿p
();

285 
	g£lf
.
	g»ad_šdex
 = 0;

287 
	g£lf
.
	gnÜm®
 > 0 {

288 
	gPEER_PROPOSAL_COUNTER_VEC


289 .
w™h_Ïb–_v®ues
(&["normal"])

290 .
šc_by
(
£lf
.
nÜm®
 
as
 
f64
)

291 .
unw¿p
();

292 
	g£lf
.
	gnÜm®
 = 0;

294 
	g£lf
.
	gŒªsãr_Ëad”
 > 0 {

295 
	gPEER_PROPOSAL_COUNTER_VEC


296 .
w™h_Ïb–_v®ues
(&["transfer_leader"])

297 .
šc_by
(
£lf
.
Œªsãr_Ëad”
 
as
 
f64
)

298 .
unw¿p
();

299 
	g£lf
.
	gŒªsãr_Ëad”
 = 0;

301 
	g£lf
.
	gcÚf_chªge
 > 0 {

302 
	gPEER_PROPOSAL_COUNTER_VEC


303 .
w™h_Ïb–_v®ues
(&["conf_change"])

304 .
šc_by
(
£lf
.
cÚf_chªge
 
as
 
f64
)

305 .
unw¿p
();

306 
	g£lf
.
	gcÚf_chªge
 = 0;

308 
	g£lf
.
	g»que¡_wa™_time
.
æush
();

314 #[
d”ive
(
ClÚe
)]

315 
pub
 
	sRaáM‘rics
 {

316 
pub
 
	m»ady
: 
RaáR—dyM‘rics
,

317 
pub
 
	mmes§ge
: 
RaáMes§geM‘rics
,

318 
pub
 
	mmes§ge_drİ³d
: 
RaáMes§geDrİM‘rics
,

319 
pub
 
	m´İo£
: 
RaáPrİo£M‘rics
,

320 
pub
 
	m´oûss_tick
: 
LoÿlHi¡og¿m
,

321 
pub
 
	m´oûss_»ady
: 
LoÿlHi¡og¿m
,

322 
pub
 
	m­³nd_log
: 
LoÿlHi¡og¿m
,

325 
im¶
 
DeçuÉ
 
	gRaáM‘rics
 {

326 
â
 (è-> 
	gRaáM‘rics
 {

327 
	gRaáM‘rics
 {

328 
	g»ady
: 
DeçuÉ
::(),

329 
	gmes§ge
: 
DeçuÉ
::(),

330 
	gmes§ge_drİ³d
: 
DeçuÉ
::(),

331 
	g´İo£
: 
DeçuÉ
::(),

332 
	g´oûss_tick
: 
PEER_RAFT_PROCESS_DURATION


333 .
w™h_Ïb–_v®ues
(&["tick"])

334 .
loÿl
(),

335 
	g´oûss_»ady
: 
PEER_RAFT_PROCESS_DURATION


336 .
w™h_Ïb–_v®ues
(&["ready"])

337 .
loÿl
(),

338 
	g­³nd_log
: 
PEER_APPEND_LOG_HISTOGRAM
.
loÿl
(),

343 
im¶
 
	gRaáM‘rics
 {

345 
pub
 
â
 
æush
(&
mut
 
£lf
) {

346 
	g£lf
.
	g»ady
.
æush
();

347 
	g£lf
.
	gmes§ge
.
æush
();

348 
	g£lf
.
	g´İo£
.
æush
();

349 
	g£lf
.
	g´oûss_tick
.
æush
();

350 
	g£lf
.
	g´oûss_»ady
.
æush
();

351 
	g£lf
.
	g­³nd_log
.
æush
();

352 
	g£lf
.
	gmes§ge_drİ³d
.
æush
();

	@src/raftstore/store/metrics.rs

14 
u£
 
	g´om‘heus
::*;

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gPEER_PROPOSAL_COUNTER_VEC
: 
CouÁ”Vec
 =

18 
»gi¡”_couÁ”_vec
!(

22 ).
unw¿p
();

24 
pub
 
»f
 
	gPEER_ADMIN_CMD_COUNTER_VEC
: 
CouÁ”Vec
 =

25 
»gi¡”_couÁ”_vec
!(

29 ).
unw¿p
();

31 
pub
 
»f
 
	gPEER_APPEND_LOG_HISTOGRAM
: 
Hi¡og¿m
 =

32 
»gi¡”_hi¡og¿m
!(

35 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

36 ).
unw¿p
();

38 
pub
 
»f
 
	gSTORE_APPLY_LOG_HISTOGRAM
: 
Hi¡og¿m
 =

39 
»gi¡”_hi¡og¿m
!(

42 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

43 ).
unw¿p
();

45 
pub
 
»f
 
	gSTORE_RAFT_READY_COUNTER_VEC
: 
CouÁ”Vec
 =

46 
»gi¡”_couÁ”_vec
!(

50 ).
unw¿p
();

52 
pub
 
»f
 
	gSTORE_RAFT_SENT_MESSAGE_COUNTER_VEC
: 
CouÁ”Vec
 =

53 
»gi¡”_couÁ”_vec
!(

57 ).
unw¿p
();

59 
pub
 
»f
 
	gSTORE_RAFT_DROPPED_MESSAGE_COUNTER_VEC
: 
CouÁ”Vec
 =

60 
»gi¡”_couÁ”_vec
!(

64 ).
unw¿p
();

66 
pub
 
»f
 
	gSTORE_PD_HEARTBEAT_GAUGE_VEC
: 
GaugeVec
 =

67 
»gi¡”_gauge_vec
!(

71 ).
unw¿p
();

73 
pub
 
»f
 
	gSTORE_SNAPSHOT_TRAFFIC_GAUGE_VEC
: 
GaugeVec
 =

74 
»gi¡”_gauge_vec
!(

78 ).
unw¿p
();

80 
pub
 
»f
 
	gSTORE_SNAPSHOT_VALIDATION_FAILURE_COUNTER
: 
CouÁ”Vec
 =

81 
»gi¡”_couÁ”_vec
!(

85 ).
unw¿p
();

87 
pub
 
»f
 
	gPEER_RAFT_PROCESS_DURATION
: 
Hi¡og¿mVec
 =

88 
»gi¡”_hi¡og¿m_vec
!(

92 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

93 ).
unw¿p
();

95 
pub
 
»f
 
	gPEER_PROPOSE_LOG_SIZE_HISTOGRAM
: 
Hi¡og¿m
 =

96 
»gi¡”_hi¡og¿m
!(

99 
	gvec
![256.0, 512.0, 1024.0, 4096.0, 65536.0, 262144.0, 524288.0, 1048576.0,

101 ).
unw¿p
();

103 
pub
 
»f
 
	gREGION_HASH_COUNTER_VEC
: 
CouÁ”Vec
 =

104 
»gi¡”_couÁ”_vec
!(

108 ).
unw¿p
();

110 
pub
 
»f
 
	gREGION_MAX_LOG_LAG
: 
Hi¡og¿m
 =

111 
»gi¡”_hi¡og¿m
!(

114 
	gvec
![2.0, 4.0, 8.0, 16.0, 32.0, 64.0, 128.0, 256.0,

116 ).
unw¿p
();

118 
pub
 
»f
 
	gREQUEST_WAIT_TIME_HISTOGRAM
: 
Hi¡og¿m
 =

119 
»gi¡”_hi¡og¿m
!(

122 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

123 ).
unw¿p
();

125 
pub
 
»f
 
	gPEER_GC_RAFT_LOG_COUNTER
: 
CouÁ”
 =

126 
»gi¡”_couÁ”
!(

129 ).
unw¿p
();

131 
pub
 
»f
 
	gSNAPSHOT_CF_KV_COUNT
: 
Hi¡og¿mVec
 =

132 
»gi¡”_hi¡og¿m_vec
!(

136 
expÚ’tŸl_buck‘s
(100.0, 2.0, 20).
unw¿p
()

137 ).
unw¿p
();

139 
pub
 
»f
 
	gSNAPSHOT_CF_SIZE
: 
Hi¡og¿mVec
 =

140 
»gi¡”_hi¡og¿m_vec
!(

144 
expÚ’tŸl_buck‘s
(1024.0, 2.0, 22).
unw¿p
()

145 ).
unw¿p
();

147 
pub
 
»f
 
	gSNAPSHOT_BUILD_TIME_HISTOGRAM
: 
Hi¡og¿m
 =

148 
»gi¡”_hi¡og¿m
!(

151 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

152 ).
unw¿p
();

154 
pub
 
»f
 
	gSNAPSHOT_KV_COUNT_HISTOGRAM
: 
Hi¡og¿m
 =

155 
»gi¡”_hi¡og¿m
!(

158 
expÚ’tŸl_buck‘s
(100.0, 2.0, 20).
unw¿p
()

159 ).
unw¿p
();

161 
pub
 
»f
 
	gSNAPSHOT_SIZE_HISTOGRAM
: 
Hi¡og¿m
 =

162 
»gi¡”_hi¡og¿m
!(

165 
expÚ’tŸl_buck‘s
(1024.0, 2.0, 22).
unw¿p
()

166 ).
unw¿p
();

168 
pub
 
»f
 
	gRAFT_ENTRY_FETCHES
: 
CouÁ”Vec
 =

169 
»gi¡”_couÁ”_vec
!(

173 ).
unw¿p
();

175 
pub
 
»f
 
	gBATCH_SNAPSHOT_COMMANDS
: 
Hi¡og¿m
 =

176 
»gi¡”_hi¡og¿m
!(

179 
	gvec
![1.0, 2.0, 4.0, 6.0, 8.0, 10.0, 12.0, 14.0, 16.0, 18.0,

181 ).
unw¿p
();

	@src/raftstore/store/mod.rs

14 
pub
 
mod
 
	g’gše
;

15 
pub
 
mod
 
	gkeys
;

16 
pub
 
mod
 
	gmsg
;

17 
pub
 
mod
 
	gcÚfig
;

18 
pub
 
mod
 
	gŒª¥Üt
;

19 
pub
 
mod
 
	gboÙ¡¿p
;

20 
pub
 
mod
 
	gcmd_»¥
;

21 
pub
 
mod
 
	gut
;

22 
pub
 
mod
 
	g¡Üe
;

24 
mod
 
	g³”
;

25 
mod
 
	g³”_¡Üage
;

26 
mod
 
	g¢­
;

27 
mod
 
	gwÜk”
;

28 
mod
 
	gm‘rics
;

29 
mod
 
	gloÿl_m‘rics
;

31 
pub
 
u£
 
	g£lf
::
msg
::{
B©chC®lback
, 
	gC®lback
, 
	gMsg
, 
	gSignifiÿÁMsg
, 
	gTick
};

32 
pub
 
u£
 
	g£lf
::
¡Üe
::{
ü—‹_ev’t_loİ
, 
	gEngšes
, 
	gStÜe
, 
	gStÜeChªÃl
, 
	gStÜeSt
};

33 
pub
 
u£
 
	g£lf
::
cÚfig
::
CÚfig
;

34 
pub
 
u£
 
	g£lf
::
Œª¥Üt
::
T¿n¥Üt
;

35 
pub
 
u£
 
	g£lf
::
³”
::{
P“r
, 
	gP“rSt
};

36 
pub
 
u£
 
	g£lf
::
boÙ¡¿p
::{
boÙ¡¿p_¡Üe
, 
	gş—r_´•¬e_boÙ¡¿p
, 
	gş—r_´•¬e_boÙ¡¿p_¡©e
,

37 
	g´•¬e_boÙ¡¿p
, 
	gwr™e_´•¬e_boÙ¡¿p
};

38 
pub
 
u£
 
	g£lf
::
’gše
::{
I‹¿bË
, 
	gMubË
, 
	gP“kabË
};

39 
pub
 
u£
 
	g£lf
::
³”_¡Üage
::{
do_¢­shÙ
, 
	gwr™e_³”_¡©e
, 
	gCacheQu”ySts
, 
	gP“rStÜage
,

40 
	gSÇpS‹
, 
	gRAFT_INIT_LOG_INDEX
, 
	gRAFT_INIT_LOG_TERM
};

41 
pub
 
u£
 
	g£lf
::
¢­
::{
check_abÜt
, 
	gcİy_¢­shÙ
, 
	gAµlyO±iÚs
, 
	gSÇpEÁry
, 
	gSÇpKey
, 
	gSÇpMªag”
,

42 
	gSÇpshÙ
, 
	gSÇpshÙD–‘”
, 
	gSÇpshÙSti¡ics
};

45 #[
cfg
(
‹¡
)]

46 
pub
 
u£
 
	g£lf
::
wÜk”
::{
S¶™CheckRuÂ”
, 
	gS¶™CheckTask
};

	@src/raftstore/store/msg.rs

14 
u£
 
	g¡d
::
time
::
In¡ªt
;

15 
u£
 
	g¡d
::
boxed
::
FnBox
;

16 
u£
 
	g¡d
::
fmt
;

18 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

19 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
RaáCmdReque¡
, 
	gRaáCmdRe¥Ú£
};

20 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚEpoch
;

21 
u£
 
	g¿á
::
SÇpshÙStus
;

22 
u£
 
	gut
::
esÿ³
;

24 
pub
 
ty³
 
	gC®lback
 = 
Box
<
FnBox
(
RaáCmdRe¥Ú£
è+ 
S’d
>;

25 
pub
 
ty³
 
	gB©chC®lback
 = 
Box
<
FnBox
(
Vec
<
O±iÚ
<
RaáCmdRe¥Ú£
>>è+ 
S’d
>;

27 #[
d”ive
(
Debug
, 
ClÚe
, 
Cİy
)]

28 
pub
 
	eTick
 {

29 
	mRaá
,

30 
	mRaáLogGc
,

31 
	mS¶™RegiÚCheck
,

32 
	mCom·ùCheck
,

33 
	mPdH—¹b—t
,

34 
	mPdStÜeH—¹b—t
,

35 
	mSÇpGc
,

36 
	mCom·ùLockCf
,

37 
	mCÚsi¡’cyCheck
,

40 #[
d”ive
(
Debug
, 
P¬tŸlEq
)]

41 
pub
 
	eSignifiÿÁMsg
 {

42 
	mSÇpshÙStus
 {

43 
	m»giÚ_id
: 
u64
,

44 
	mto_³”_id
: 
u64
,

45 
	m¡©us
: 
SÇpshÙStus
,

47 
	mUÄ—chabË
 { 
	m»giÚ_id
: 
u64
, 
	mto_³”_id
: u64 },

50 
pub
 
	eMsg
 {

51 
	mQu™
,

54 
RaáMes§ge
(RaftMessage),

56 
	mRaáCmd
 {

57 
	m£nd_time
: 
In¡ªt
,

58 
	m»que¡
: 
RaáCmdReque¡
,

59 
	mÿÎback
: 
C®lback
,

62 
	mB©chRaáSÇpCmds
 {

63 
	m£nd_time
: 
In¡ªt
,

64 
	mb©ch
: 
Vec
<
RaáCmdReque¡
>,

65 
	mÚ_fšished
: 
B©chC®lback
,

68 
	mS¶™RegiÚ
 {

69 
	m»giÚ_id
: 
u64
,

70 
	m»giÚ_•och
: 
RegiÚEpoch
,

73 
	m¥l™_key
: 
Vec
<
u8
>,

74 
	mÿÎback
: 
O±iÚ
<
C®lback
>,

78 
	mSÇpshÙSts
,

81 
	mCompu‹HashResuÉ
 {

82 
	m»giÚ_id
: 
u64
,

83 
	mšdex
: 
u64
,

84 
	mhash
: 
Vec
<
u8
>,

88 
	mAµroxim©eRegiÚSize
 { 
	m»giÚ_id
: 
u64
, 
	m»giÚ_size
: u64 },

91 
im¶
 
	gfmt
::
Debug
 
Msg
 {

92 
â
 
fmt
(&
£lf
, fmt: &
mut
 fmt::
FÜm©‹r
è-> fmt::
ResuÉ
 {

93 
m©ch
 *
£lf
 {

94 
Msg
::
Qu™
 => 
wr™e
!(
fmt
, "Quit"),

95 
	gMsg
::
RaáMes§ge
(
_
è=> 
wr™e
!(
fmt
, "Raft Message"),

96 
	gMsg
::
RaáCmd
 { .. } => 
wr™e
!(
fmt
, "Raft Command"),

97 
	gMsg
::
B©chRaáSÇpCmds
 { .. } => 
wr™e
!(
fmt
, "Batch Raft Commands"),

98 
	gMsg
::
SÇpshÙSts
 => 
wr™e
!(
fmt
, "Snapshot stats"),

99 
	gMsg
::
Compu‹HashResuÉ
 {

100 
»giÚ_id
,

101 
	gšdex
,

102 
»f
 
	ghash
,

103 } => 
wr™e
!(

104 
fmt
,

106 
	g»giÚ_id
,

107 
	gšdex
,

108 
esÿ³
(
hash
)

110 
	gMsg
::
S¶™RegiÚ
 {

111 
»f
 
»giÚ_id
,

112 
»f
 
	g¥l™_key
,

114 } => 
wr™e
!(
fmt
, "S¶™„egiÚ {}‡ˆkey {:?}", 
	g»giÚ_id
, 
	g¥l™_key
),

115 
	gMsg
::
Aµroxim©eRegiÚSize
 {

116 
»giÚ_id
,

117 
	g»giÚ_size
,

118 } => 
wr™e
!(

119 
fmt
,

121 
	g»giÚ_id
,

122 
	g»giÚ_size


128 
im¶
 
	gMsg
 {

129 
pub
 
â
 
Ãw_¿á_cmd
(
»que¡
: 
RaáCmdReque¡
, 
ÿÎback
: 
C®lback
è-> 
Msg
 {

130 
Msg
::
RaáCmd
 {

131 
£nd_time
: 
In¡ªt
::
now
(),

132 
	g»que¡
: 
»que¡
,

133 
	gÿÎback
: 
ÿÎback
,

137 
pub
 
â
 
Ãw_b©ch_¿á_¢­shÙ_cmd
(

138 
b©ch
: 
Vec
<
RaáCmdReque¡
>,

139 
Ú_fšished
: 
B©chC®lback
,

140 è-> 
	gMsg
 {

141 
	gMsg
::
B©chRaáSÇpCmds
 {

142 
£nd_time
: 
In¡ªt
::
now
(),

143 
	gb©ch
: 
b©ch
,

144 
	gÚ_fšished
: 
Ú_fšished
,

149 #[
cfg
(
‹¡
)]

150 
mod
 
	g‹¡s
 {

151 
u£
 
	g¡d
::
th»ad
;

152 
u£
 
	g¡d
::
boxed
::
FnBox
;

153 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

155 
u£
 
	gmio
::{
Ev’tLoİ
, 
	gHªdËr
};

157 
u£
 
	gsu³r
::*;

158 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
RaáCmdReque¡
, 
	gRaáCmdRe¥Ú£
};

159 
u£
 
	g¿á¡Üe
::
E¼Ü
;

160 
u£
 
	gut
::
Œª¥Üt
::
S’dCh
;

162 
â
 
ÿÎ_commªd
(

163 
£ndch
: &
S’dCh
<
Msg
>,

164 
»que¡
: 
RaáCmdReque¡
,

165 
timeout
: 
Du¿tiÚ
,

166 è-> 
	gResuÉ
<
	gRaáCmdRe¥Ú£
, 
	gE¼Ü
> {

167 
	gwa™_İ
!(

168 |
	gcb
: 
Box
<
FnBox
(
RaáCmdRe¥Ú£
) + 'static + Send>| {

169 
£ndch
.
Œy_£nd
(
Msg
::
Ãw_¿á_cmd
(
»que¡
, 
cb
)).
unw¿p
()

171 
	gtimeout


172 ).
ok_Ü_–£
(|| {

173 
E¼Ü
::
Timeout
(
fÜm©
!("»que¡imeouˆfÜ {:?}", 
timeout
))

177 
	gTe¡HªdËr
;

179 
im¶
 
HªdËr
 
	gTe¡HªdËr
 {

180 
ty³
 
	gTimeout
 = ();

181 
ty³
 
	gMes§ge
 = 
Msg
;

183 
â
 
nÙify
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>, 
msg
: S–f::
Mes§ge
) {

184 
m©ch
 
msg
 {

185 
Msg
::
Qu™
 => 
ev’t_loİ
.
shutdown
(),

186 
	gMsg
::
RaáCmd
 {

187 
ÿÎback
, 
	g»que¡
, ..

190 
»que¡
.
g‘_h—d”
().
g‘_»giÚ_id
(è=ğ
u64
::
max_v®ue
() {

191 
th»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(100));

193 
	gÿÎback
.
ÿÎ_box
((
RaáCmdRe¥Ú£
::
Ãw
(),));

196 
	g_
 => 
uÄ—chabË
!(),

201 #[
‹¡
]

202 
â
 
	$‹¡_£nd”
() {

203 
Ët
 
mut
 
ev’t_loİ
 = 
Ev’tLoİ
::
	`Ãw
().
	`unw¿p
();

204 
Ët
 
£ndch
 = &
S’dCh
::
	`Ãw
(
ev’t_loİ
.
	`chªÃl
(), "test-sender");

206 
Ët
 
t
 = 
th»ad
::
	`¥awn
(
move
 || { 
ev’t_loİ
.
	`run
(&
mut
 
Te¡HªdËr
).
	`unw¿p
(); });

208 
Ët
 
mut
 
»que¡
 = 
RaáCmdReque¡
::
	`Ãw
();

209 
»que¡
.
	`mut_h—d”
().
	`£t_»giÚ_id
(
u64
::
	`max_v®ue
());

210 
as£¹
!(
	`ÿÎ_commªd
(
£ndch
, 
»que¡
.
	`şÚe
(), 
Du¿tiÚ
::
	`äom_mlis
(500)).
	`is_ok
());

211 
m©ch
 
	`ÿÎ_commªd
(
£ndch
, 
»que¡
, 
Du¿tiÚ
::
	`äom_mlis
(10)) {

212 
	`E¼
(
E¼Ü
::
	`Timeout
(
_
)) => {}

213 
_
 => 
·nic
!("should failed withimeout"),

216 
£ndch
.
	`Œy_£nd
(
Msg
::
Qu™
).
	`unw¿p
();

218 
t
.
	`još
().
	`unw¿p
();

219 
	}
}

	@src/raftstore/store/peer.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

15 
u£
 
	g¡d
::
rc
::
Rc
;

16 
u£
 
	g¡d
::
ûÎ
::
RefC–l
;

17 
u£
 
	g¡d
::
cŞËùiÚs
::
VecDeque
;

18 
u£
 
	g¡d
::{
cmp
, 
	gmem
, 
	g¦iû
};

19 
u£
 
	g¡d
::
time
::{
Du¿tiÚ
, 
	gIn¡ªt
};

21 
u£
 
	gtime
::
Time¥ec
;

22 
u£
 
	grocksdb
::{
Wr™eB©ch
, 
	gDB
};

23 
u£
 
	grocksdb
::
rocksdb_İtiÚs
::
Wr™eO±iÚs
;

24 
u£
 
	g´Ùobuf
::{
£lf
, 
	gMes§ge
, 
	gMes§geStic
};

25 
u£
 
	gkv´Ùo
::
m‘­b
;

26 
u£
 
	gkv´Ùo
::
”aápb
::{
£lf
, 
	gCÚfChªgeTy³
, 
	gMes§geTy³
};

27 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
AdmšCmdTy³
, 
	gAdmšRe¥Ú£
, 
	gCmdTy³
, 
	gRaáCmdReque¡
, 
	gRaáCmdRe¥Ú£
,

28 
	gT¿nsãrL—d”Reque¡
, 
	gT¿nsãrL—d”Re¥Ú£
};

29 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
P“rS‹
, 
	gRaáMes§ge
};

30 
u£
 
	gkv´Ùo
::
pdpb
::
P“rSts
;

32 
u£
 
	g¿á
::{
£lf
, 
	gProg»ss
, 
	gProg»ssS‹
, 
	gRawNode
, 
	gR—dy
, 
	gSÇpshÙStus
, 
	gS‹RŞe
, 
	gINVALID_INDEX
};

33 
u£
 
	g¿á¡Üe
::{
E¼Ü
, 
	gResuÉ
};

34 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::
CİroûssÜHo¡
;

35 
u£
 
	g¿á¡Üe
::
¡Üe
::
CÚfig
;

36 
u£
 
	g¿á¡Üe
::
¡Üe
::
wÜk”
::{
­¶y
, 
	gPrİo§l
, 
	gRegiÚPrİo§l
};

37 
u£
 
	g¿á¡Üe
::
¡Üe
::
wÜk”
::
­¶y
::
ExecResuÉ
;

39 
u£
 
	gut
::
wÜk”
::{
Futu»WÜk”
, 
	gScheduËr
};

40 
u£
 
	g¿á¡Üe
::
¡Üe
::
wÜk”
::{
Aµly
, 
	gAµlyRes
, 
	gAµlyTask
};

41 
u£
 
	gut
::{
E™h”
, 
	gMu¡CÚsumeVec
};

42 
u£
 
	gut
::
time
::
mÚÙÚic_¿w_now
;

43 
u£
 
	gut
::
cŞËùiÚs
::{
FÏtM­
, 
FÏtM­V®ues
 
as
 
	gV®ues
, 
	gHashS‘
};

45 
u£
 
	gpd
::{
PdTask
, 
	gINVALID_ID
};

47 
u£
 
	gsu³r
::
¡Üe
::{
De¡royP“rJob
, 
	gStÜe
, 
	gStÜeSt
};

48 
u£
 
	gsu³r
::
³”_¡Üage
::{
wr™e_³”_¡©e
, 
	gAµlySÇpResuÉ
, 
	gInvokeCÚ‹xt
, 
	gP“rStÜage
};

49 
u£
 
	gsu³r
::
ut
;

50 
u£
 
	gsu³r
::
msg
::
C®lback
;

51 
u£
 
	gsu³r
::
cmd_»¥
;

52 
u£
 
	gsu³r
::
Œª¥Üt
::
T¿n¥Üt
;

53 
u£
 
	gsu³r
::
’gše
::
SÇpshÙ
;

54 
u£
 
	gsu³r
::
m‘rics
::*;

55 
u£
 
	gsu³r
::
loÿl_m‘rics
::{
RaáMes§geM‘rics
, 
	gRaáM‘rics
, 
	gRaáPrİo£M‘rics
, 
	gRaáR—dyM‘rics
};

57 cÚ¡ 
	gTRANSFER_LEADER_ALLOW_LOG_LAG
: 
u64
 = 10;

58 cÚ¡ 
	gDEFAULT_APPEND_WB_SIZE
: 
usize
 = 4 * 1024;

60 
	sR—dIndexReque¡
 {

61 
	mid
: 
u64
,

62 
	mcmds
: 
Mu¡CÚsumeVec
<(
RaáCmdReque¡
, 
	mC®lback
)>,

63 
	m»Ãw_Ëa£_time
: 
Time¥ec
,

66 
im¶
 
	gR—dIndexReque¡
 {

67 
â
 
bš¬y_id
(&
£lf
è-> &[
u8
] {

68 
	gun§ã
 {

69 
Ët
 
	gid
 = &
£lf
.
id
 
as
 *cÚ¡ 
u64
‡ *cÚ¡ 
u8
;

70 
	g¦iû
::
äom_¿w_·¹s
(
id
, 8)

75 #[
d”ive
(
DeçuÉ
)]

76 
	sR—dIndexQueue
 {

77 
	mid_®loÿtÜ
: 
u64
,

78 
	m»ads
: 
VecDeque
<
R—dIndexReque¡
>,

79 
	m»ady_út
: 
usize
,

82 
im¶
 
	gR—dIndexQueue
 {

83 
â
 
Ãxt_id
(&
mut
 
£lf
è-> 
	gu64
 {

84 
	g£lf
.
	gid_®loÿtÜ
 += 1;

85 
	g£lf
.
	gid_®loÿtÜ


88 
â
 
ş—r_uncomm™‹d
(&
mut
 
£lf
, 
‹rm
: 
u64
) {

89 
mut
 
»ad
 
š
 
£lf
.
»ads
.
d¿š
(£lf.
»ady_út
..) {

90 
_
, 
	gcb
è
š
 
	g»ad
.
	gcmds
.
d¿š
(..) {

91 
	g­¶y
::
nÙify_¡®e_»q
(
‹rm
, 
cb
);

98 #[
d”ive
(
Debug
)]

99 
pub
 
	eSËS‹
 {

100 
	mV®id
,

101 
	mToV®id©e
,

104 
pub
 
	sPrİo§lM‘a
 {

105 
pub
 
	mšdex
: 
u64
,

106 
pub
 
	m‹rm
: 
u64
,

108 
pub
 
	m»Ãw_Ëa£_time
: 
O±iÚ
<
Time¥ec
>,

111 #[
d”ive
(
DeçuÉ
)]

112 
	sPrİo§lQueue
 {

113 
	mqueue
: 
VecDeque
<
Prİo§lM‘a
>,

116 
im¶
 
	gPrİo§lQueue
 {

117 
â
 
pİ
(&
mut
 
£lf
, 
‹rm
: 
u64
è-> 
O±iÚ
<
Prİo§lM‘a
> {

118 
£lf
.
queue
.
pİ_äÚt
().
ªd_th’
(|
m‘a
| {

119 
m‘a
.
‹rm
 >erm {

120 
£lf
.
queue
.
push_äÚt
(
m‘a
);

121  
NÚe
;

123 
Some
(
m‘a
)

127 
â
 
push
(&
mut
 
£lf
, 
m‘a
: 
Prİo§lM‘a
) {

128 
£lf
.
queue
.
push_back
(
m‘a
);

131 
â
 
ş—r
(&
mut
 
£lf
) {

132 
	g£lf
.
	gqueue
.
ş—r
();

136 
pub
 
	gR—dyCÚ‹xt
<'a, T: '
	ga
> {

137 
pub
 
	gkv_wb
: 
Wr™eB©ch
,

138 
pub
 
	g¿á_wb
: 
Wr™eB©ch
,

139 
pub
 
	gsync_log
: 
boŞ
,

140 
pub
 
	gm‘rics
: &'a mut RaftMetrics,

141 
pub
 
Œªs
: &'a T,

142 
pub
 
»ady_»s
: 
Vec
<(
R—dy
, 
	gInvokeCÚ‹xt
)>,

145 
	gim¶
<'a, T> R—dyCÚ‹xt<'
	ga
, 
	gT
> {

146 
pub
 
â
 
Ãw
(
m‘rics
: &'¨muˆRaáM‘rics,: &'
a
 
T
, 
ÿp
: 
usize
è-> 
R—dyCÚ‹xt
<'a, T> {

147 
R—dyCÚ‹xt
 {

148 
kv_wb
: 
Wr™eB©ch
::
Ãw
(),

149 
	g¿á_wb
: 
Wr™eB©ch
::
w™h_ÿ·c™y
(
DEFAULT_APPEND_WB_SIZE
),

150 
	gsync_log
: 
çl£
,

151 
	gm‘rics
: 
m‘rics
,

152 
	gŒªs
: 
t
,

153 
	g»ady_»s
: 
Vec
::
w™h_ÿ·c™y
(
ÿp
),

160 #[
šlše
]

161 
pub
 
â
 
	g·r£_d©a_©
<
	gT
: 
Mes§ge
 + 
Mes§geStic
>(
d©a
: &[
u8
], 
	gšdex
: 
u64
, 
	gg
: &
¡r
è-> 
T
 {

162 
´Ùobuf
::
·r£_äom_by‹s
::<
T
>(
d©a
).
unw¿p_Ü_–£
(|
e
| {

163 
·nic
!("{} d©¨i cÜru±ed‡ˆ{}: {:?}", 
g
, 
šdex
, 
e
);

167 
pub
 
	sCÚsi¡’cyS‹
 {

168 
pub
 
	mÏ¡_check_time
: 
In¡ªt
,

170 
pub
 
	mšdex
: 
u64
,

171 
pub
 
	mhash
: 
Vec
<
u8
>,

174 
	eReque¡PŞicy
 {

176 
	mR—dLoÿl
,

178 
	mR—dIndex
,

179 
	mPrİo£NÜm®
,

180 
	mPrİo£T¿nsãrL—d”
,

181 
	mPrİo£CÚfChªge
,

184 #[
d”ive
(
DeçuÉ
, 
ClÚe
)]

185 
pub
 
	sP“rSt
 {

186 
pub
 
	mwr™‹n_by‹s
: 
u64
,

187 
pub
 
	mwr™‹n_keys
: 
u64
,

190 
pub
 
	sP“r
 {

191 
	mkv_’gše
: 
Arc
<
DB
>,

192 
	m¿á_’gše
: 
Arc
<
DB
>,

193 
	mcfg
: 
Rc
<
CÚfig
>,

194 
	m³”_ÿche
: 
RefC–l
<
FÏtM­
<
u64
, 
	mm‘­b
::
P“r
>>,

195 
pub
 
	m³”
: 
m‘­b
::
P“r
,

196 
	m»giÚ_id
: 
u64
,

197 
pub
 
	m¿á_group
: 
RawNode
<
P“rStÜage
>,

198 
	m´İo§ls
: 
Prİo§lQueue
,

199 
	m­¶y_´İo§ls
: 
Vec
<
Prİo§l
>,

200 
	m³ndšg_»ads
: 
R—dIndexQueue
,

202 
pub
 
	m³”_h—¹b—ts
: 
FÏtM­
<
u64
, 
	mIn¡ªt
>,

203 
	mcİroûssÜ_ho¡
: 
Arc
<
CİroûssÜHo¡
>,

205 
pub
 
	msize_diff_hšt
: 
u64
,

207 
pub
 
	md–‘e_keys_hšt
: 
u64
,

209 
pub
 
	m­´oxim©e_size
: 
O±iÚ
<
u64
>,

211 
pub
 
	mcÚsi¡’cy_¡©e
: 
CÚsi¡’cyS‹
,

213 
pub
 
	mg
: 
SŒšg
,

216 
pub
 
	mÏ¡_­¶yšg_idx
: 
u64
,

217 
pub
 
	mÏ¡_com·ùed_idx
: 
u64
,

219 
pub
 
	m¿á_log_size_hšt
: 
u64
,

221 
pub
 
	m¿á_’Œy_max_size
: 
u64
,

223 
	m­¶y_scheduËr
: 
ScheduËr
<
AµlyTask
>,

225 
pub
 
	m³ndšg_»move
: 
boŞ
,

227 
	mm¬ked_to_be_checked
: 
boŞ
,

229 
	mËad”_missšg_time
: 
O±iÚ
<
In¡ªt
>,

247 
	mËad”_Ëa£_expœed_time
: 
O±iÚ
<
E™h”
<
Time¥ec
, 
	mTime¥ec
>>,

250 
	m³ndšg_mes§ges
: 
Vec
<
”aápb
::
Mes§ge
>,

252 
pub
 
	m³”_¡©
: 
P“rSt
,

255 
im¶
 
	gP“r
 {

259 
pub
 
â
 
	gü—‹
<
	gT
, 
	gC
>(
	g¡Üe
: &
mut
 
StÜe
<
T
, C>, 
	g»giÚ
: &
m‘­b
::
RegiÚ
è-> 
ResuÉ
<
P“r
> {

260 
Ët
 
¡Üe_id
 = 
¡Üe
.store_id();

261 
Ët
 
	g³”_id
 = 
m©ch
 
ut
::
fšd_³”
(
»giÚ
, 
¡Üe_id
) {

262 
	gNÚe
 => {

263  
E¼
(
box_”r
!(

265 
¡Üe_id
,

266 
»giÚ


269 
Some
(
³”
è=>…“r.
g‘_id
(),

272 
	gšfo
!(

274 
	g»giÚ
.
g‘_id
(),

275 
	g³”_id


277 
	gP“r
::
Ãw
(
¡Üe
, 
»giÚ
, 
³”_id
)

283 
pub
 
â
 
	g»¶iÿ‹
<
	gT
, 
	gC
>(
	g¡Üe
: &
mut
 
StÜe
<
T
, C>, 
	g»giÚ_id
: 
u64
, 
	g³”_id
: u64è-> 
ResuÉ
<
P“r
> {

285 
šfo
!("[»giÚ {}]„•liÿ‹…“¸w™h id {}", 
	g»giÚ_id
, 
	g³”_id
);

287 
Ët
 
mut
 
	g»giÚ
 = 
m‘­b
::
RegiÚ
::
Ãw
();

288 
	g»giÚ
.
£t_id
(
»giÚ_id
);

289 
	gP“r
::
Ãw
(
¡Üe
, &
»giÚ
, 
³”_id
)

292 
â
 
	gÃw
<
	gT
, 
	gC
>(
	g¡Üe
: &
mut
 
StÜe
<
T
, C>, 
	g»giÚ
: &
m‘­b
::
RegiÚ
, 
	g³”_id
: 
u64
è-> 
ResuÉ
<
P“r
> {

293 
³”_id
 =ğ
¿á
::
INVALID_ID
 {

294  
E¼
(
box_”r
!("invalid…eer id"));

297 
Ët
 
	gcfg
 = 
¡Üe
.
cÚfig
();

299 
Ët
 
	g¡Üe_id
 = 
¡Üe
.
¡Üe_id
();

300 
Ët
 
	gsched
 = 
¡Üe
.
¢­_scheduËr
();

301 
Ët
 
	g³”_ÿche
 = 
FÏtM­
::();

302 
Ët
 
	gg
 = 
fÜm©
!("[»giÚ {}] {}", 
	g»giÚ
.
g‘_id
(), 
	g³”_id
);

304 
Ët
 
	gps
 = 
P“rStÜage
::
Ãw
(

305 
¡Üe
.
kv_’gše
(),

306 
¡Üe
.
¿á_’gše
(),

307 
»giÚ
,

308 
sched
,

309 
g
.
şÚe
(),

310 
¡Üe
.
’Œy_ÿche_m‘r›s
.
şÚe
(),

313 
Ët
 
	g­¶›d_šdex
 = 
ps
.
­¶›d_šdex
();

315 
Ët
 
	g¿á_cfg
 = 
¿á
::
CÚfig
 {

316 
id
: 
³”_id
,

317 
³”s
: 
vec
![],

318 
–eùiÚ_tick
: 
cfg
.
¿á_–eùiÚ_timeout_ticks
,

319 
h—¹b—t_tick
: 
cfg
.
¿á_h—¹b—t_ticks
,

320 
max_size_³r_msg
: 
cfg
.
¿á_max_size_³r_msg
.0,

321 
max_šæight_msgs
: 
cfg
.
¿á_max_šæight_msgs
,

322 
­¶›d
: 
­¶›d_šdex
,

323 
check_quÜum
: 
Œue
,

324 
g
:ag.
şÚe
(),

325 
sk_bÿ¡_comm™
: 
Œue
,

326 ..
DeçuÉ
::()

329 
Ët
 
	g¿á_group
 = 
RawNode
::
Ãw
(&
¿á_cfg
, 
ps
, &[])?;

331 
Ët
 
mut
 
	g³”
 = 
P“r
 {

332 
kv_’gše
: 
¡Üe
.kv_engine(),

333 
¿á_’gše
: 
¡Üe
.raft_engine(),

334 
³”
: 
ut
::
Ãw_³”
(
¡Üe_id
, 
³”_id
),

335 
»giÚ_id
: 
»giÚ
.
g‘_id
(),

336 
¿á_group
:„aft_group,

337 
´İo§ls
: 
DeçuÉ
::(),

338 
­¶y_´İo§ls
: 
vec
![],

339 
³ndšg_»ads
: 
DeçuÉ
::(),

340 
³”_ÿche
: 
RefC–l
::
Ãw
(peer_cache),

341 
³”_h—¹b—ts
: 
FÏtM­
::(),

342 
cİroûssÜ_ho¡
: 
¡Üe
.cİroûssÜ_ho¡.
şÚe
(),

343 
size_diff_hšt
: 0,

344 
d–‘e_keys_hšt
: 0,

345 
­´oxim©e_size
: 
NÚe
,

346 
­¶y_scheduËr
: 
¡Üe
.apply_scheduler(),

347 
³ndšg_»move
: 
çl£
,

348 
m¬ked_to_be_checked
: 
çl£
,

349 
Ëad”_missšg_time
: 
Some
(
In¡ªt
::
now
()),

350 
g
:ag,

351 
Ï¡_­¶yšg_idx
: 
­¶›d_šdex
,

352 
Ï¡_com·ùed_idx
: 0,

353 
cÚsi¡’cy_¡©e
: 
CÚsi¡’cyS‹
 {

354 
Ï¡_check_time
: 
In¡ªt
::
now
(),

355 
šdex
: 
INVALID_INDEX
,

356 
hash
: 
vec
![],

358 
¿á_log_size_hšt
: 0,

359 
¿á_’Œy_max_size
: 
cfg
.raft_entry_max_size.0,

360 
cfg
: cfg,

361 
Ëad”_Ëa£_expœed_time
: 
NÚe
,

362 
³ndšg_mes§ges
: 
vec
![],

363 
³”_¡©
: 
P“rSt
::(),

367 
	g»giÚ
.
g‘_³”s
().
Ën
(è=ğ1 && 
»giÚ
.g‘_³”s()[0].
g‘_¡Üe_id
(è=ğ
¡Üe_id
 {

368 
³”
.
¿á_group
.
ÿm·ign
()?;

371 
Ok
(
³”
)

374 #[
šlše
]

375 
â
 
Ãxt_´İo§l_šdex
(&
£lf
è-> 
	gu64
 {

376 
	g£lf
.
	g¿á_group
.
	g¿á
.
	g¿á_log
.
Ï¡_šdex
() + 1

379 
pub
 
â
 
m¬k_to_be_checked
(&
mut
 
£lf
, 
³ndšg_¿á_groups
: &muˆ
HashS‘
<
u64
>) {

380 !
£lf
.
m¬ked_to_be_checked
 {

381 
£lf
.
m¬ked_to_be_checked
 = 
Œue
;

382 
	g³ndšg_¿á_groups
.
š£¹
(
£lf
.
»giÚ_id
);

386 
pub
 
â
 
maybe_de¡roy
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gDe¡royP“rJob
> {

387 
Ët
 
	gš™Ÿlized
 = 
£lf
.
g‘_¡Üe
().
is_š™Ÿlized
();

388 
Ët
 
	gasync_»move
 = 
£lf
.
is_­¶yšg_¢­shÙ
() {

389 !
£lf
.
mut_¡Üe
().
ÿnûl_­¶yšg_¢­
() {

390 
šfo
!(

393 
£lf
.
g
,

394 
£lf
.
³”_id
()

396  
	gNÚe
;

399 
	gçl£


401 
	gš™Ÿlized


403 
	g£lf
.
	g³ndšg_»move
 = 
Œue
;

404 
Some
(
De¡royP“rJob
 {

405 
async_»move
:‡sync_remove,

406 
š™Ÿlized
: initialized,

407 
»giÚ_id
: 
£lf
.region_id,

408 
³”
: 
£lf
.³”.
şÚe
(),

412 
pub
 
â
 
de¡roy
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

413 
Ët
 
	gt
 = 
In¡ªt
::
now
();

415 
Ët
 
	g»giÚ
 = 
£lf
.
g‘_¡Üe
().
g‘_»giÚ
().
şÚe
();

416 
	gšfo
!("{} begšØde¡roy", 
	g£lf
.
	gg
);

419 
Ët
 
	gkv_wb
 = 
Wr™eB©ch
::
Ãw
();

420 
Ët
 
	g¿á_wb
 = 
Wr™eB©ch
::
Ãw
();

421 
	g£lf
.
mut_¡Üe
().
ş—r_m‘a
(&
kv_wb
, &
¿á_wb
)?;

422 
wr™e_³”_¡©e
(&
£lf
.
kv_’gše
, &
kv_wb
, &
»giÚ
, 
P“rS‹
::
Tomb¡Úe
)?;

424 
Ët
 
mut
 
	gwr™e_İts
 = 
Wr™eO±iÚs
::
Ãw
();

425 
	gwr™e_İts
.
£t_sync
(
£lf
.
cfg
.
sync_log
);

426 
	g£lf
.
	gkv_’gše
.
wr™e_İt
(
kv_wb
, &
wr™e_İts
)?;

427 
	g£lf
.
	g¿á_’gše
.
wr™e_İt
(
¿á_wb
, &
wr™e_İts
)?;

429 
	g£lf
.
g‘_¡Üe
().
is_š™Ÿlized
() {

432 
Ët
 
E¼
(
e
èğ
£lf
.
g‘_¡Üe
().
ş—r_d©a
() {

433 
”rÜ
!("{} faedØscheduË cË¬ d©¨sk: {:?}", 
£lf
.
g
, 
e
);

437 
mut
 
»ad
 
š
 
	g£lf
.
	g³ndšg_»ads
.
	g»ads
.
d¿š
(..) {

438 
	g_
, 
	gcb
è
š
 
	g»ad
.
	gcmds
.
d¿š
(..) {

439 
	g­¶y
::
nÙify_»q_»giÚ_»moved
(
»giÚ
.
g‘_id
(), 
cb
);

443 
´İo§l
 
š
 
	g£lf
.
	g­¶y_´İo§ls
.
d¿š
(..) {

444 
	g­¶y
::
nÙify_»q_»giÚ_»moved
(
»giÚ
.
g‘_id
(), 
´İo§l
.
cb
);

447 
	gšfo
!("{} de¡roy it£lf,ake {:?}", 
	g£lf
.
	gg
, 
	gt
.
–­£d
());

449 
Ok
(())

452 
pub
 
â
 
is_š™Ÿlized
(&
£lf
è-> 
	gboŞ
 {

453 
	g£lf
.
g‘_¡Üe
().
is_š™Ÿlized
()

456 
pub
 
â
 
kv_’gše
(&
£lf
è-> 
	gArc
<
	gDB
> {

457 
	g£lf
.
	gkv_’gše
.
şÚe
()

460 
pub
 
â
 
¿á_’gše
(&
£lf
è-> 
	gArc
<
	gDB
> {

461 
	g£lf
.
	g¿á_’gše
.
şÚe
()

464 
pub
 
â
 
»giÚ
(&
£lf
è-> &
	gm‘­b
::
RegiÚ
 {

465 
£lf
.
g‘_¡Üe
().
g‘_»giÚ
()

468 
pub
 
â
 
³”_id
(&
£lf
è-> 
u64
 {

469 
£lf
.
³”
.
g‘_id
()

472 
pub
 
â
 
g‘_¿á_¡©us
(&
£lf
è-> 
¿á
::
Stus
 {

473 
£lf
.
¿á_group
.
¡©us
()

476 
pub
 
â
 
Ëad”_id
(&
£lf
è-> 
u64
 {

477 
£lf
.
¿á_group
.
¿á
.
Ëad”_id


480 
pub
 
â
 
is_Ëad”
(&
£lf
è-> 
boŞ
 {

481 
£lf
.
¿á_group
.
¿á
.
¡©e
 =ğ
S‹RŞe
::
L—d”


484 #[
šlše
]

485 
pub
 
â
 
g‘_¡Üe
(&
£lf
è-> &
P“rStÜage
 {

486 
£lf
.
¿á_group
.
g‘_¡Üe
()

489 #[
šlše
]

490 
pub
 
â
 
mut_¡Üe
(&
mut
 
£lf
è-> &muˆ
P“rStÜage
 {

491 
£lf
.
¿á_group
.
mut_¡Üe
()

494 #[
šlše
]

495 
pub
 
â
 
is_­¶yšg_¢­shÙ
(&
£lf
è-> 
boŞ
 {

496 
£lf
.
g‘_¡Üe
().
is_­¶yšg_¢­shÙ
()

499 #[
šlše
]

500 
pub
 
â
 
has_³ndšg_¢­shÙ
(&
£lf
è-> 
boŞ
 {

501 
£lf
.
¿á_group
.
g‘_¢­
().
is_some
()

504 
â
 
add_»ady_m‘ric
(&
£lf
, 
»ady
: &
R—dy
, 
m‘rics
: &
mut
 
RaáR—dyM‘rics
) {

505 
m‘rics
.
mes§ge
 +ğ
»ady
.
mes§ges
.
Ën
(è
as
 
u64
;

506 
	gm‘rics
.
	gcomm™
 +ğ
»ady


507 .
comm™‹d_’Œ›s


508 .
as_»f
()

509 .
m­_Ü
(0, |
v
| v.
Ën
(è
as
 
u64
);

510 
	gm‘rics
.
	g­³nd
 +ğ
»ady
.
’Œ›s
.
Ën
(è
as
 
u64
;

512 !
	g¿á
::
is_em±y_¢­
(&
»ady
.
¢­shÙ
) {

513 
m‘rics
.
¢­shÙ
 += 1;

517 #[
šlše
]

518 
â
 
	g£nd
<
	gT
, 
	gI
>(&
mut
 
	g£lf
, 
	gŒªs
: &
T
, 
	gmsgs
: 
I
, 
	gm‘rics
: &muˆ
RaáMes§geM‘rics
è-> 
ResuÉ
<()>

519 
wh”e


520 
T
: 
T¿n¥Üt
,

521 
	gI
: 
IÁoI‹¿tÜ
<
I‹m
 = 
”aápb
::
Mes§ge
>,

523 
msg
 
š
 
	gmsgs
 {

524 
Ët
 
	gmsg_ty³
 = 
msg
.
g‘_msg_ty³
();

526 
	g£lf
.
£nd_¿á_mes§ge
(
msg
, 
Œªs
)?;

528 
m©ch
 
	gmsg_ty³
 {

529 
	gMes§geTy³
::
MsgAµ’d
 => 
m‘rics
.
­³nd
 += 1,

530 
	gMes§geTy³
::
MsgAµ’dRe¥Ú£
 => 
m‘rics
.
­³nd_»¥
 += 1,

531 
	gMes§geTy³
::
MsgReque¡VÙe
 => 
m‘rics
.
vÙe
 += 1,

532 
	gMes§geTy³
::
MsgReque¡VÙeRe¥Ú£
 => 
m‘rics
.
vÙe_»¥
 += 1,

533 
	gMes§geTy³
::
MsgSÇpshÙ
 => 
m‘rics
.
¢­shÙ
 += 1,

534 
	gMes§geTy³
::
MsgH—¹b—t
 => 
m‘rics
.
h—¹b—t
 += 1,

535 
	gMes§geTy³
::
MsgH—¹b—tRe¥Ú£
 => 
m‘rics
.
h—¹b—t_»¥
 += 1,

536 
	gMes§geTy³
::
MsgT¿nsãrL—d”
 => 
m‘rics
.
Œªsãr_Ëad”
 += 1,

537 
	gMes§geTy³
::
MsgTimeoutNow
 => {

544 
£lf
.
Ëad”_Ëa£_expœed_time
 = 
Some
(
E™h”
::
Right
(

545 
£lf
.
Ãxt_Ëa£_expœed_time
(
mÚÙÚic_¿w_now
()),

548 
	gm‘rics
.
	gtimeout_now
 += 1;

550 
	g_
 => {}

553 
Ok
(())

556 
pub
 
â
 
¡•
(&
mut
 
£lf
, 
m
: 
”aápb
::
Mes§ge
è-> 
ResuÉ
<()> {

557 
£lf
.
is_Ëad”
(è&& 
m
.
g‘_äom
(è!ğ
INVALID_ID
 {

558 
£lf
.
³”_h—¹b—ts
.
š£¹
(
m
.
g‘_äom
(), 
In¡ªt
::
now
());

560 
	g£lf
.
	g¿á_group
.
¡•
(
m
)?;

561 
Ok
(())

564 
pub
 
â
 
check_³”s
(&
mut
 
£lf
) {

565 !
	g£lf
.
is_Ëad”
() {

566 
	g£lf
.
	g³”_h—¹b—ts
.
ş—r
();

570 
	g£lf
.
	g³”_h—¹b—ts
.
Ën
(è=ğ
£lf
.
»giÚ
().
g‘_³”s
().len() {

575 
³”
 
š
 
	g£lf
.
»giÚ
().
g‘_³”s
().
to_owÃd
() {

576 
	g£lf
.
	g³”_h—¹b—ts


577 .
’Œy
(
³”
.
g‘_id
())

578 .
Ü_š£¹_w™h
(
In¡ªt
::
now
);

582 
pub
 
â
 
cŞËù_down_³”s
(&
£lf
, 
max_du¿tiÚ
: 
Du¿tiÚ
è-> 
Vec
<
P“rSts
> {

583 
Ët
 
mut
 
down_³”s
 = 
Vec
::
Ãw
();

584 
p
 
š
 
	g£lf
.
»giÚ
().
g‘_³”s
() {

585 
	gp
.
g‘_id
(è=ğ
£lf
.
³”
.get_id() {

588 
Ët
 
Some
(
š¡ªt
èğ
£lf
.
³”_h—¹b—ts
.
g‘
(&
p
.
g‘_id
()) {

589 
š¡ªt
.
–­£d
(è>ğ
max_du¿tiÚ
 {

590 
Ët
 
mut
 
¡©s
 = 
P“rSts
::
Ãw
();

591 
	g¡©s
.
£t_³”
(
p
.
şÚe
());

592 
	g¡©s
.
£t_down_£cÚds
(
š¡ªt
.
–­£d
().
as_£cs
());

593 
	gdown_³”s
.
push
(
¡©s
);

597 
	gdown_³”s


600 
pub
 
â
 
cŞËù_³ndšg_³”s
(&
£lf
è-> 
	gVec
<
	gm‘­b
::
P“r
> {

601 
Ët
 
mut
 
³ndšg_³”s
 = 
Vec
::
w™h_ÿ·c™y
(
£lf
.
»giÚ
().
g‘_³”s
().
Ën
());

602 
Ët
 
	g¡©us
 = 
£lf
.
¿á_group
.
¡©us
();

603 
Ët
 
	gŒunÿ‹d_idx
 = 
£lf
.
g‘_¡Üe
().
Œunÿ‹d_šdex
();

604 
	gid
, 
	g´og»ss
è
š
 
	g¡©us
.progress {

605 
	gid
 =ğ
£lf
.
³”
.
g‘_id
() {

608 
	g´og»ss
.
	gm©ched
 < 
	gŒunÿ‹d_idx
 {

609 
Ët
 
Some
(
p
èğ
£lf
.
g‘_³”_äom_ÿche
(
id
) {

610 
³ndšg_³”s
.
push
(
p
);

614 
	g³ndšg_³”s


617 
pub
 
â
 
check_¡®e_¡©e
(&
mut
 
£lf
, 
d
: 
Du¿tiÚ
è-> 
SËS‹
 {

619 
£lf
.
Ëad”_id
(è=ğ
¿á
::
INVALID_ID
 {

620 
£lf
.
Ëad”_missšg_time
.
is_nÚe
() {

621 
£lf
.
Ëad”_missšg_time
 = 
Some
(
In¡ªt
::
now
())

623 } 
£lf
.
is_š™Ÿlized
() {

630 
£lf
.
Ëad”_missšg_time
 = 
NÚe


634 
Ët
 
du¿tiÚ
 = 
m©ch
 
£lf
.
Ëad”_missšg_time
 {

635 
Some
(
t
è=>.
–­£d
(),

636 
	gNÚe
 => 
Du¿tiÚ
::
Ãw
(0, 0),

638 
	gdu¿tiÚ
 >ğ
d
 {

641 
£lf
.
Ëad”_missšg_time
 = 
NÚe
;

642  
	gSËS‹
::
ToV®id©e
;

644 
	gSËS‹
::
V®id


647 
â
 
Ãxt_Ëa£_expœed_time
(&
£lf
, 
£nd_to_quÜum_ts
: 
Time¥ec
) -> Timespec {

652 
£nd_to_quÜum_ts
 + 
£lf
.
cfg
.
¿á_¡Üe_max_Ëad”_Ëa£
()

655 
â
 
Ú_rŞe_chªged
(&
mut
 
£lf
, 
»ady
: &
R—dy
, 
wÜk”
: &
Futu»WÜk”
<
PdTask
>) {

657 
Ët
 
Some
(
»f
 
ss
èğ
»ady
.ss {

658 
m©ch
 
ss
.
¿á_¡©e
 {

659 
S‹RŞe
::
L—d”
 => {

668 
Ët
 
Ãxt_expœed_time
 = 
£lf
.
Ãxt_Ëa£_expœed_time
(
mÚÙÚic_¿w_now
());

669 
	g£lf
.
	gËad”_Ëa£_expœed_time
 = 
Some
(
E™h”
::
Leá
(
Ãxt_expœed_time
));

670 
	gdebug
!(

672 
	g£lf
.
	gg
,

673 
	gÃxt_expœed_time


675 
	g£lf
.
h—¹b—t_pd
(
wÜk”
)

677 
	gS‹RŞe
::
FŞlow”
 => {

678 
£lf
.
Ëad”_Ëa£_expœed_time
 = 
NÚe
;

680 
	g_
 => {}

685 #[
šlše
]

686 
pub
 
â
 
»ady_to_hªdË_³ndšg_¢­
(&
£lf
è-> 
	gboŞ
 {

693 
	g£lf
.
	gÏ¡_­¶yšg_idx
 =ğ
£lf
.
g‘_¡Üe
().
­¶›d_šdex
()

696 #[
šlše
]

697 
pub
 
â
 
»ady_to_hªdË_»ad
(&
£lf
è-> 
	gboŞ
 {

700 
	g£lf
.
g‘_¡Üe
().
	g­¶›d_šdex_‹rm
 =ğ
£lf
.
‹rm
()

703 
pub
 
â
 
ke_­¶y_´İo§ls
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gRegiÚPrİo§l
> {

704 
	g£lf
.
	g­¶y_´İo§ls
.
is_em±y
() {

705  
	gNÚe
;

708 
Ët
 
	g´İo§ls
 = 
mem
::
»¶aû
(&
mut
 
£lf
.
­¶y_´İo§ls
, 
vec
![]);

709 
Ët
 
	g»giÚ_´İo§l
 = 
RegiÚPrİo§l
::
Ãw
(
£lf
.
³”_id
(), s–f.
»giÚ_id
, 
´İo§ls
);

710 
Some
(
»giÚ_´İo§l
)

713 
pub
 
â
 
	ghªdË_¿á_»ady_­³nd
<
	gT
: 
T¿n¥Üt
>(

714 &
mut
 
£lf
,

715 
	gùx
: &
mut
 
R—dyCÚ‹xt
<
T
>,

716 
	gwÜk”
: &
Futu»WÜk”
<
PdTask
>,

718 
	g£lf
.
	gm¬ked_to_be_checked
 = 
çl£
;

719 
	g£lf
.
	g³ndšg_»move
 {

722 
	g£lf
.
mut_¡Üe
().
check_­¶yšg_¢­
() {

726 
	gdebug
!(

728 
	g£lf
.
	gg


733 !
	g£lf
.
	g³ndšg_mes§ges
.
is_em±y
() {

734 
	gç_pošt
!("raft_before_follower_send");

735 
Ët
 
	gmes§ges
 = 
mem
::
»¶aû
(&
mut
 
£lf
.
³ndšg_mes§ges
, 
vec
![]);

736 
	g£lf
.
£nd
(
ùx
.
Œªs
, 
mes§ges
, &
mut
 ctx.
m‘rics
.
mes§ge
)

737 .
unw¿p_Ü_–£
(|
e
| {

738 
w¬n
!("{} cË¬ sÇpshÙ…’dšg mes§ge ”¸{:?}", 
£lf
.
g
, 
e
);

742 
	g£lf
.
has_³ndšg_¢­shÙ
(è&& !£lf.
»ady_to_hªdË_³ndšg_¢­
() {

743 
	gdebug
!(

745 
	g£lf
.
	gg
,

746 
	g£lf
.
g‘_¡Üe
().
­¶›d_šdex
(),

747 
	g£lf
.
	gÏ¡_­¶yšg_idx


752 !
	g£lf
.
	g¿á_group


753 .
has_»ady_sšû
(
Some
(
£lf
.
Ï¡_­¶yšg_idx
))

758 
	gdebug
!("{} hªdË„aá„—dy", 
	g£lf
.
	gg
);

760 
Ët
 
mut
 
	g»ady
 = 
£lf
.
¿á_group
.
»ady_sšû
(£lf.
Ï¡_­¶yšg_idx
);

762 
	g£lf
.
Ú_rŞe_chªged
(&
»ady
, 
wÜk”
);

764 
	g£lf
.
add_»ady_m‘ric
(&
»ady
, &
mut
 
ùx
.
m‘rics
.ready);

768 
	g£lf
.
is_Ëad”
() {

769 
	gç_pošt
!("raft_before_leader_send");

770 
Ët
 
	gmsgs
 = 
»ady
.
mes§ges
.
d¿š
(..);

771 
	g£lf
.
£nd
(
ùx
.
Œªs
, 
msgs
, &
mut
 ctx.
m‘rics
.
mes§ge
)

772 .
unw¿p_Ü_–£
(|
e
| {

774 
w¬n
!("{}†—d” s’d mes§ge ”¸{:?}", 
£lf
.
g
, 
e
);

778 
Ët
 
	gšvoke_ùx
 = 
m©ch
 
£lf
.
mut_¡Üe
().
hªdË_¿á_»ady
(
ùx
, &
»ady
) {

779 
Ok
(
r
) =>„,

780 
E¼
(
e
) => {

783 
·nic
!("{} faedØhªdË„aá„—dy: {:?}", 
£lf
.
g
, 
e
);

787 
	gùx
.
	g»ady_»s
.
push
((
»ady
, 
švoke_ùx
));

790 
pub
 
â
 
	gpo¡_¿á_»ady_­³nd
<
	gT
: 
T¿n¥Üt
>(

791 &
mut
 
£lf
,

792 
	gm‘rics
: &
mut
 
RaáM‘rics
,

793 
	gŒªs
: &
T
,

794 
	g»ady
: &
mut
 
R—dy
,

795 
	gšvoke_ùx
: 
InvokeCÚ‹xt
,

796 è-> 
	gO±iÚ
<
	gAµlySÇpResuÉ
> {

797 
	gšvoke_ùx
.
has_¢­shÙ
() {

799 
	g£lf
.
	g¿á_log_size_hšt
 = 0;

802 
Ët
 
	g­¶y_¢­_»suÉ
 = 
£lf
.
mut_¡Üe
().
po¡_»ady
(
švoke_ùx
);

804 !
	g£lf
.
is_Ëad”
() {

805 
	gç_pošt
!("raft_before_follower_send");

806 
	g£lf
.
is_­¶yšg_¢­shÙ
() {

807 
	g£lf
.
	g³ndšg_mes§ges
 = 
mem
::
»¶aû
(&
mut
 
»ady
.
mes§ges
, 
vec
![]);

809 
	g£lf
.
£nd
(
Œªs
, 
»ady
.
mes§ges
.
d¿š
(..), &
mut
 
m‘rics
.
mes§ge
)

810 .
unw¿p_Ü_–£
(|
e
| {

811 
w¬n
!("{} fŞlow” s’d mes§ge ”¸{:?}", 
£lf
.
g
, 
e
);

816 
	g­¶y_¢­_»suÉ
.
is_some
() {

817 
Ët
 
	g»g
 = 
AµlyTask
::(
£lf
);

818 
	g£lf
.
	g­¶y_scheduËr
.
scheduË
(
»g
).
unw¿p
();

821 
	g­¶y_¢­_»suÉ


824 
pub
 
â
 
hªdË_¿á_»ady_­¶y
(&
mut
 
£lf
, muˆ
»ady
: 
R—dy
, 
­¶y_sks
: &muˆ
Vec
<
Aµly
>) {

832 
£lf
.
is_­¶yšg_¢­shÙ
() {

834 
£lf
.
Ï¡_­¶yšg_idx
 = s–f.
g‘_¡Üe
().
Œunÿ‹d_šdex
();

836 
Ët
 
	gcomm™‹d_’Œ›s
 = 
»ady
.
comm™‹d_’Œ›s
.
ke
().
unw¿p
();

838 
Ët
 
mut
 
	gto_be_upd©ed
 = 
£lf
.
is_Ëad”
();

839 !
	gto_be_upd©ed
 {

843 
	g£lf
.
	g´İo§ls
.
ş—r
();

845 
’Œy
 
š
 
	gcomm™‹d_’Œ›s
.
™”
().
»v
() {

847 
	g£lf
.
	g¿á_log_size_hšt
 +ğ
’Œy
.
g‘_d©a
().
Ën
(è
as
 
u64
;

848 
	gto_be_upd©ed
 {

849 
	gto_be_upd©ed
 = !
£lf
.
maybe_upd©e_Ëa£
(
’Œy
);

852 !
	gcomm™‹d_’Œ›s
.
is_em±y
() {

853 
	g£lf
.
	gÏ¡_­¶yšg_idx
 = 
comm™‹d_’Œ›s
.
Ï¡
().
unw¿p
().
g‘_šdex
();

854 
	g­¶y_sks
.
push
(
Aµly
::
Ãw
(
£lf
.
»giÚ_id
, s–f.
‹rm
(), 
comm™‹d_’Œ›s
));

858 
	g£lf
.
­¶y_»ads
(&
»ady
);

860 
	g£lf
.
	g¿á_group
.
advªû_­³nd
(
»ady
);

861 
	g£lf
.
is_­¶yšg_¢­shÙ
() {

864 
	g£lf
.
	g¿á_group
.
advªû_­¶y
(
£lf
.
Ï¡_­¶yšg_idx
);

868 
â
 
­¶y_»ads
(&
mut
 
£lf
, 
»ady
: &
R—dy
) {

869 
Ët
 
mut
 
´İo£_time
 = 
NÚe
;

870 
	g£lf
.
»ady_to_hªdË_»ad
() {

871 
¡©e
 
	gš
 &
	g»ady
.
	g»ad_¡©es
 {

872 
Ët
 
mut
 
	g»ad
 = 
£lf
.
³ndšg_»ads
.
»ads
.
pİ_äÚt
().
unw¿p
();

873 
	gas£¹_eq
!(
	g¡©e
.
	g»que¡_ùx
.
as_¦iû
(), 
	g»ad
.
bš¬y_id
());

874 
	g»q
, 
	gcb
è
š
 
	g»ad
.
	gcmds
.
d¿š
(..) {

878 
cb
(
£lf
.
hªdË_»ad
(
»q
));

880 
	g´İo£_time
 = 
Some
(
»ad
.
»Ãw_Ëa£_time
);

883 
¡©e
 
	gš
 &
	g»ady
.
	g»ad_¡©es
 {

884 
Ët
 
	g»ad
 = &
£lf
.
³ndšg_»ads
.
»ads
[£lf.³ndšg_»ads.
»ady_út
];

885 
	gas£¹_eq
!(
	g¡©e
.
	g»que¡_ùx
.
as_¦iû
(), 
	g»ad
.
bš¬y_id
());

886 
	g£lf
.
	g³ndšg_»ads
.
	g»ady_út
 += 1;

887 
	g´İo£_time
 = 
Some
(
»ad
.
»Ãw_Ëa£_time
);

893 
	g»ady
.
	gss
.
is_some
() {

894 
Ët
 
	g‹rm
 = 
£lf
.
‹rm
();

896 
	g£lf
.
	g³ndšg_»ads
.
ş—r_uncomm™‹d
(
‹rm
);

899 
Ët
 
Some
(
E™h”
::
Right
(
_
)èğ
£lf
.
Ëad”_Ëa£_expœed_time
 {

903 
Ët
 
Some
(
´İo£_time
) =…ropose_time {

904 
£lf
.
upd©e_Ëa£_w™h
(
´İo£_time
);

908 
pub
 
â
 
po¡_­¶y
(

909 &
mut
 
£lf
,

910 
»s
: &
AµlyRes
,

911 
groups
: &
mut
 
HashS‘
<
u64
>,

912 
¡Üe_¡©
: &
mut
 
StÜeSt
,

914 
	g£lf
.
is_­¶yšg_¢­shÙ
() {

915 
	g·nic
!("{} should‚Ù‡µlyšg sÇpshÙ.", 
	g£lf
.
	gg
);

918 
Ët
 
	ghas_¥l™
 = 
»s
.
exec_»s
.
™”
().
ªy
(|
e
| 
m©ch
 *e {

919 
ExecResuÉ
::
S¶™RegiÚ
 { .. } => 
Œue
,

920 
_
 => 
çl£
,

923 
	g£lf
.
	g¿á_group


924 .
advªû_­¶y
(
»s
.
­¶y_¡©e
.
g‘_­¶›d_šdex
());

925 
	g£lf
.
mut_¡Üe
().
	g­¶y_¡©e
 = 
»s
.
­¶y_¡©e
.
şÚe
();

926 
	g£lf
.
mut_¡Üe
().
	g­¶›d_šdex_‹rm
 = 
»s
.
­¶›d_šdex_‹rm
;

927 
	g£lf
.
	g³”_¡©
.
	gwr™‹n_keys
 +ğ
»s
.
m‘rics
.
wr™‹n_keys
;

928 
	g£lf
.
	g³”_¡©
.
	gwr™‹n_by‹s
 +ğ
»s
.
m‘rics
.
wr™‹n_by‹s
;

929 
	g¡Üe_¡©
.
	g’gše_tÙ®_by‹s_wr™‹n
 +ğ
»s
.
m‘rics
.
wr™‹n_by‹s
;

930 
	g¡Üe_¡©
.
	g’gše_tÙ®_keys_wr™‹n
 +ğ
»s
.
m‘rics
.
wr™‹n_keys
;

932 
Ët
 
	gdiff
 = 
has_¥l™
 {

933 
£lf
.
d–‘e_keys_hšt
 = 
»s
.
m‘rics
.delete_keys_hint;

934 
	g»s
.
	gm‘rics
.
	gsize_diff_hšt


936 
	g£lf
.
	gd–‘e_keys_hšt
 +ğ
»s
.
m‘rics
.
d–‘e_keys_hšt
;

937 
	g£lf
.
size_diff_hšt
 
as
 
	gi64
 + 
	g»s
.
	gm‘rics
.
	gsize_diff_hšt


939 
	g£lf
.
	gsize_diff_hšt
 = 
cmp
::
max
(
diff
, 0è
as
 
	gu64
;

941 
	g£lf
.
has_³ndšg_¢­shÙ
(è&& s–f.
»ady_to_hªdË_³ndšg_¢­
() {

942 
	g£lf
.
m¬k_to_be_checked
(
groups
);

945 
	g£lf
.
	g³ndšg_»ads
.
	g»ady_út
 > 0 && s–f.
»ady_to_hªdË_»ad
() {

946 
_
 
	gš
 0..
	g£lf
.
	g³ndšg_»ads
.
	g»ady_út
 {

947 
Ët
 
mut
 
	g»ad
 = 
£lf
.
³ndšg_»ads
.
»ads
.
pİ_äÚt
().
unw¿p
();

948 
	g»q
, 
	gcb
è
š
 
	g»ad
.
	gcmds
.
d¿š
(..) {

949 
cb
(
£lf
.
hªdË_»ad
(
»q
));

952 
	g£lf
.
	g³ndšg_»ads
.
	g»ady_út
 = 0;

956 
â
 
upd©e_Ëa£_w™h
(&
mut
 
£lf
, 
´İo£_time
: 
Time¥ec
) {

958 
£lf
.
Ëad”_Ëa£_expœed_time
.
is_some
() {

959 
Ët
 
cu¼’t_expœed_time
 =

960 
m©ch
 
£lf
.
Ëad”_Ëa£_expœed_time
.
as_»f
().
unw¿p
().as_ref() {

961 
E™h”
::
Leá
(
§ã_expœed_time
) => *safe_expired_time,

962 
	gE™h”
::
Right
(
un§ã_expœed_time
) => *unsafe_expired_time,

967 
Ët
 
	gÃxt_expœed_time
 = 
£lf
.
Ãxt_Ëa£_expœed_time
(
´İo£_time
);

970 
	gcu¼’t_expœed_time
 < 
	gÃxt_expœed_time
 {

971 
	gdebug
!(

973 
	g£lf
.
	gg
,

974 
	gcu¼’t_expœed_time
,

975 
	gÃxt_expœed_time


977 
	g£lf
.
	gËad”_Ëa£_expœed_time
 = 
Some
(
E™h”
::
Leá
(
Ãxt_expœed_time
));

979 } 
	g£lf
.
is_Ëad”
() {

983 
Ët
 
	gÃxt_expœed_time
 = 
£lf
.
Ãxt_Ëa£_expœed_time
(
´İo£_time
);

984 
	gdebug
!(

986 
	g£lf
.
	gg
,

987 
	gÃxt_expœed_time


989 
	g£lf
.
	gËad”_Ëa£_expœed_time
 = 
Some
(
E™h”
::
Leá
(
Ãxt_expœed_time
));

996 
â
 
maybe_upd©e_Ëa£
(&
mut
 
£lf
, 
’Œy
: &
”aápb
::
EÁry
è-> 
boŞ
 {

997 
Ët
 
´İo£_time
 = 
m©ch
 
£lf
.
fšd_´İo£_time
(
’Œy
.
g‘_šdex
(),ƒÁry.
g‘_‹rm
()) {

998 
Some
(
t
) =>,

999 
	g_
 =>  
çl£
,

1002 
	g£lf
.
upd©e_Ëa£_w™h
(
´İo£_time
);

1004 
	gŒue


1007 
pub
 
â
 
maybe_ÿm·ign
(

1008 &
mut
 
£lf
,

1009 
Ï¡_³”
: &
P“r
,

1010 
³ndšg_¿á_groups
: &
mut
 
HashS‘
<
u64
>,

1011 è-> 
	gboŞ
 {

1012 
	g£lf
.
»giÚ
().
g‘_³”s
().
Ën
() <= 1 {

1014  
çl£
;

1017 !
	gÏ¡_³”
.
is_Ëad”
() {

1018  
	gçl£
;

1023 
Ët
 
	g_
 = 
£lf
.
¿á_group
.
ÿm·ign
();

1024 
	g£lf
.
m¬k_to_be_checked
(
³ndšg_¿á_groups
);

1026 
	gŒue


1029 
â
 
fšd_´İo£_time
(&
mut
 
£lf
, 
šdex
: 
u64
, 
‹rm
: u64è-> 
O±iÚ
<
Time¥ec
> {

1030 
Ët
 
Some
(
m‘a
èğ
£lf
.
´İo§ls
.
pİ
(
‹rm
) {

1031 
m‘a
.
šdex
 =ğšdex && m‘a.
‹rm
 ==erm {

1032  
Some
(
m‘a
.
»Ãw_Ëa£_time
.
unw¿p
());

1035 
	gNÚe


1041 
pub
 
â
 
´İo£
(

1042 &
mut
 
£lf
,

1043 
cb
: 
C®lback
,

1044 
»q
: 
RaáCmdReque¡
,

1045 
mut
 
”r_»¥
: 
RaáCmdRe¥Ú£
,

1046 
m‘rics
: &
mut
 
RaáPrİo£M‘rics
,

1047 è-> 
	gboŞ
 {

1048 
	g£lf
.
	g³ndšg_»move
 {

1049  
	gçl£
;

1052 
	gm‘rics
.
	g®l
 += 1;

1054 
Ët
 
mut
 
	gis_cÚf_chªge
 = 
çl£
;

1056 
Ët
 
	g»s
 = 
m©ch
 
£lf
.
g‘_hªdË_pŞicy
(&
»q
) {

1057 
Ok
(
Reque¡PŞicy
::
R—dLoÿl
) => {

1058 
£lf
.
»ad_loÿl
(
»q
, 
cb
, 
m‘rics
);

1059  
	gçl£
;

1061 
Ok
(
Reque¡PŞicy
::
R—dIndex
è=>  
£lf
.
»ad_šdex
(
»q
, 
cb
, 
m‘rics
),

1062 
Ok
(
Reque¡PŞicy
::
Prİo£NÜm®
è=> 
£lf
.
´İo£_nÜm®
(
»q
, 
m‘rics
),

1063 
Ok
(
Reque¡PŞicy
::
Prİo£T¿nsãrL—d”
) => {

1064  
£lf
.
´İo£_Œªsãr_Ëad”
(
»q
, 
cb
, 
m‘rics
)

1066 
Ok
(
Reque¡PŞicy
::
Prİo£CÚfChªge
) => {

1067 
is_cÚf_chªge
 = 
Œue
;

1068 
	g£lf
.
´İo£_cÚf_chªge
(
»q
, 
m‘rics
)

1070 
E¼
(
e
) => Err(e),

1073 
m©ch
 
	g»s
 {

1074 
E¼
(
e
) => {

1075 
cmd_»¥
::
bšd_”rÜ
(&
mut
 
”r_»¥
, 
e
);

1076 
cb
(
”r_»¥
);

1077 
	gçl£


1079 
Ok
(
idx
) => {

1080 
Ët
 
m‘a
 = 
Prİo§lM‘a
 {

1081 
šdex
: 
idx
,

1082 
‹rm
: 
£lf
.term(),

1083 
»Ãw_Ëa£_time
: 
NÚe
,

1085 
	g£lf
.
po¡_´İo£
(
m‘a
, 
is_cÚf_chªge
, 
cb
);

1086 
	gŒue


1094 
pub
 
â
 
´İo£_¢­shÙ
(

1095 &
mut
 
£lf
,

1096 
»q
: 
RaáCmdReque¡
,

1097 
m‘rics
: &
mut
 
RaáPrİo£M‘rics
,

1098 è-> 
	gO±iÚ
<
	gRaáCmdRe¥Ú£
> {

1099 
	g£lf
.
	g³ndšg_»move
 {

1100 
Ët
 
mut
 
	g»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

1101 
	gcmd_»¥
::
bšd_”rÜ
(&
mut
 
»¥
, 
box_”r
!("peer is…ending„emove"));

1102  
Some
(
»¥
);

1104 
	gm‘rics
.
	g®l
 += 1;

1108 
m©ch
 
	g£lf
.
g‘_hªdË_pŞicy
(&
»q
) {

1109 
Ok
(
Reque¡PŞicy
::
R—dLoÿl
) => {

1110 
m‘rics
.
loÿl_»ad
 += 1;

1111 
Some
(
£lf
.
hªdË_»ad
(
»q
))

1114 
Ok
(
Reque¡PŞicy
::
R—dIndex
è=> 
NÚe
,

1115 
Ok
(
_
è=> 
uÄ—chabË
!(),

1116 
E¼
(
e
) => {

1117 
Ët
 
mut
 
»¥
 = 
cmd_»¥
::
Ãw_”rÜ
(
e
);

1118 
	gcmd_»¥
::
bšd_‹rm
(&
mut
 
»¥
, 
£lf
.
‹rm
());

1119 
Some
(
»¥
)

1124 
â
 
po¡_´İo£
(&
mut
 
£lf
, muˆ
m‘a
: 
Prİo§lM‘a
, 
is_cÚf_chªge
: 
boŞ
, 
cb
: 
C®lback
) {

1126 
m‘a
.
»Ãw_Ëa£_time
 = 
Some
(
mÚÙÚic_¿w_now
());

1128 
Ët
 
	gp
 = 
Prİo§l
::
Ãw
(
is_cÚf_chªge
, 
m‘a
.
šdex
, m‘a.
‹rm
, 
cb
);

1129 
	g£lf
.
	g­¶y_´İo§ls
.
push
(
p
);

1131 
	g£lf
.
	g´İo§ls
.
push
(
m‘a
);

1134 
â
 
g‘_hªdË_pŞicy
(&
mut
 
£lf
, 
»q
: &
RaáCmdReque¡
è-> 
ResuÉ
<
Reque¡PŞicy
> {

1135 
»q
.
has_admš_»que¡
() {

1136 
­¶y
::
g‘_chªge_³”_cmd
(
»q
).
is_some
() {

1137  
Ok
(
Reque¡PŞicy
::
Prİo£CÚfChªge
);

1139 
g‘_Œªsãr_Ëad”_cmd
(
»q
).
is_some
() {

1140  
Ok
(
Reque¡PŞicy
::
Prİo£T¿nsãrL—d”
);

1142  
Ok
(
Reque¡PŞicy
::
Prİo£NÜm®
);

1145 
Ët
 
mut
 
	gis_»ad
 = 
çl£
;

1146 
Ët
 
mut
 
	gis_wr™e
 = 
çl£
;

1147 
r
 
š
 
	g»q
.
g‘_»que¡s
() {

1148 
m©ch
 
	gr
.
g‘_cmd_ty³
() {

1149 
	gCmdTy³
::
G‘
 | 
CmdTy³
::
SÇp
 => 
is_»ad
 = 
Œue
,

1150 
	gCmdTy³
::
D–‘e
 | 
CmdTy³
::
Put
 | CmdTy³::
D–‘eRªge
 => 
is_wr™e
 = 
Œue
,

1151 
	gCmdTy³
::
P»wr™e
 | 
CmdTy³
::
Inv®id
 => {

1152  
E¼
(
box_”r
!(

1154 
r
.
g‘_cmd_ty³
()

1159 
	gis_»ad
 && 
	gis_wr™e
 {

1160  
E¼
(
box_”r
!("read‡nd write can't be mixed in one batch."));

1164 
	gis_wr™e
 {

1165  
Ok
(
Reque¡PŞicy
::
Prİo£NÜm®
);

1168 ià(
	g»q
.
has_h—d”
(è&&„eq.
g‘_h—d”
().
g‘_»ad_quÜum
()) ||

1169 !
	g£lf
.
	g¿á_group
.
	g¿á
.
š_Ëa£
()

1171  
Ok
(
Reque¡PŞicy
::
R—dIndex
);

1176 
	g£lf
.
g‘_¡Üe
().
	g­¶›d_šdex_‹rm
 !ğ
£lf
.
¿á_group
.
¿á
.
‹rm
 {

1178  
Ok
(
Reque¡PŞicy
::
R—dIndex
);

1182 
	g£lf
.
	gËad”_Ëa£_expœed_time
.
is_nÚe
() {

1183  
Ok
(
Reque¡PŞicy
::
R—dIndex
);

1186 
Ët
 
Some
(
E™h”
::
Leá
(
§ã_expœed_time
)èğ
£lf
.
Ëad”_Ëa£_expœed_time
 {

1187 
mÚÙÚic_¿w_now
(è<ğ
§ã_expœed_time
 {

1188  
Ok
(
Reque¡PŞicy
::
R—dLoÿl
);

1191 
	gdebug
!(

1193 
	g£lf
.
	gg
,

1194 
	g§ã_expœed_time


1197 
	g£lf
.
	gËad”_Ëa£_expœed_time
 = 
NÚe
;

1201 
Ok
(
Reque¡PŞicy
::
R—dIndex
)

1210 
â
 
couÁ_h—Éhy_node
(&
£lf
, 
´og»ss
: 
V®ues
<
u64
, 
Prog»ss
>è-> 
	gusize
 {

1211 
Ët
 
mut
 
	gh—Éhy
 = 0;

1212 
´
 
š
 
	g´og»ss
 {

1213 
	g´
.
	gm©ched
 >ğ
£lf
.
g‘_¡Üe
().
Œunÿ‹d_šdex
() {

1214 
h—Éhy
 += 1;

1217 
	gh—Éhy


1231 
â
 
check_cÚf_chªge
(&
£lf
, 
cmd
: &
RaáCmdReque¡
è-> 
ResuÉ
<()> {

1232 
Ët
 
chªge_³”
 = 
­¶y
::
g‘_chªge_³”_cmd
(
cmd
).
unw¿p
();

1234 
Ët
 
	gchªge_ty³
 = 
chªge_³”
.
g‘_chªge_ty³
();

1235 
Ët
 
	g³”
 = 
chªge_³”
.
g‘_³”
();

1237 
	gchªge_ty³
 =ğ
CÚfChªgeTy³
::
RemoveNode
 && !
£lf
.
cfg
.
®low_»move_Ëad”
 &&

1238 
³”
.
g‘_id
(è=ğ
£lf
.
³”_id
()

1240 
w¬n
!(

1242 
£lf
.
g
,

1243 
chªge_³”


1245  
E¼
(
box_”r
!("ignore„emove†eader"));

1248 
Ët
 
mut
 
	g¡©us
 = 
£lf
.
¿á_group
.
¡©us
();

1249 
Ët
 
	gtÙ®
 = 
¡©us
.
´og»ss
.
Ën
();

1250 
	gtÙ®
 == 1 {

1252  
Ok
(());

1255 
m©ch
 
	gchªge_ty³
 {

1256 
	gCÚfChªgeTy³
::
AddNode
 => {

1257 
¡©us
.
´og»ss
.
š£¹
(
³”
.
g‘_id
(), 
Prog»ss
::());

1259 
	gCÚfChªgeTy³
::
RemoveNode
 => {

1260 
¡©us
.
´og»ss
.
»move
(&
³”
.
g‘_id
()).
is_nÚe
() {

1262  
Ok
(());

1265 
	gCÚfChªgeTy³
::
AddL—º”Node
 => 
unim¶em’‹d
!(),

1267 
Ët
 
	gh—Éhy
 = 
£lf
.
couÁ_h—Éhy_node
(
¡©us
.
´og»ss
.
v®ues
());

1268 
Ët
 
	gquÜum_aá”_chªge
 = 
¿á
::
quÜum
(
¡©us
.
´og»ss
.
Ën
());

1269 
	gh—Éhy
 >ğ
quÜum_aá”_chªge
 {

1270  
Ok
(());

1273 
	gPEER_ADMIN_CMD_COUNTER_VEC


1274 .
w™h_Ïb–_v®ues
(&["conf_change", "reject_unsafe"])

1275 .
šc
();

1277 
	gšfo
!(

1280 
	g£lf
.
	gg
,

1281 
	gchªge_³”
,

1282 
	gtÙ®
,

1283 
	gh—Éhy
,

1284 
	gquÜum_aá”_chªge


1286 
E¼
(
box_”r
!(

1289 
chªge_³”
,

1290 
tÙ®
,

1291 
h—Éhy
,

1292 
quÜum_aá”_chªge


1296 
â
 
Œªsãr_Ëad”
(&
mut
 
£lf
, 
³”
: &
m‘­b
::
P“r
) {

1297 
šfo
!("{}¿nsã¸Ëad”Ø{:?}", 
	g£lf
.
	gg
, 
	g³”
);

1299 
	g£lf
.
	g¿á_group
.
Œªsãr_Ëad”
(
³”
.
g‘_id
());

1302 
â
 
is_Œªsãr_Ëad”_®lowed
(&
£lf
, 
³”
: &
m‘­b
::
P“r
è-> 
boŞ
 {

1303 
Ët
 
³”_id
 = 
³”
.
g‘_id
();

1304 
Ët
 
	g¡©us
 = 
£lf
.
¿á_group
.
¡©us
();

1306 !
	g¡©us
.
	g´og»ss
.
cÚšs_key
(&
³”_id
) {

1307  
	gçl£
;

1310 
´og»ss
 
š
 
	g¡©us
.
	g´og»ss
.
v®ues
() {

1311 
	g´og»ss
.
	g¡©e
 =ğ
Prog»ssS‹
::
SÇpshÙ
 {

1312  
çl£
;

1316 
Ët
 
	gÏ¡_šdex
 = 
£lf
.
g‘_¡Üe
().
Ï¡_šdex
();

1317 
	gÏ¡_šdex
 <ğ
¡©us
.
´og»ss
[&
³”_id
].
m©ched
 + 
TRANSFER_LEADER_ALLOW_LOG_LAG


1320 
â
 
»ad_loÿl
(&
mut
 
£lf
, 
»q
: 
RaáCmdReque¡
, 
cb
: 
C®lback
, 
m‘rics
: &muˆ
RaáPrİo£M‘rics
) {

1321 
m‘rics
.
loÿl_»ad
 += 1;

1322 
cb
(
£lf
.
hªdË_»ad
(
»q
));

1325 
â
 
»ad_šdex
(

1326 &
mut
 
£lf
,

1327 
»q
: 
RaáCmdReque¡
,

1328 
cb
: 
C®lback
,

1329 
m‘rics
: &
mut
 
RaáPrİo£M‘rics
,

1330 è-> 
	gboŞ
 {

1331 
	gm‘rics
.
	g»ad_šdex
 += 1;

1333 
Ët
 
	g»Ãw_Ëa£_time
 = 
mÚÙÚic_¿w_now
();

1334 
Ët
 
Some
(
»ad
èğ
£lf
.
³ndšg_»ads
.
»ads
.
back_mut
() {

1335 
»ad
.
»Ãw_Ëa£_time
 + 
£lf
.
cfg
.
¿á_¡Üe_max_Ëad”_Ëa£
() >„enew_lease_time {

1336 
»ad
.
cmds
.
push
((
»q
, 
cb
));

1337  
	gçl£
;

1342 
Ët
 
	gÏ¡_³ndšg_»ad_couÁ
 = 
£lf
.
¿á_group
.
¿á
.
³ndšg_»ad_couÁ
();

1343 
Ët
 
	gÏ¡_»ady_»ad_couÁ
 = 
£lf
.
¿á_group
.
¿á
.
»ady_»ad_couÁ
();

1345 
Ët
 
	gid
 = 
£lf
.
³ndšg_»ads
.
Ãxt_id
();

1346 
Ët
 
	gùx
: [
u8
; 8] = 
un§ã
 { 
mem
::
Œªsmu‹
(
id
) };

1347 
	g£lf
.
	g¿á_group
.
»ad_šdex
(
ùx
.
to_vec
());

1349 
Ët
 
	g³ndšg_»ad_couÁ
 = 
£lf
.
¿á_group
.
¿á
.
³ndšg_»ad_couÁ
();

1350 
Ët
 
	g»ady_»ad_couÁ
 = 
£lf
.
¿á_group
.
¿á
.
»ady_»ad_couÁ
();

1352 
	g³ndšg_»ad_couÁ
 =ğ
Ï¡_³ndšg_»ad_couÁ
 &&

1353 
»ady_»ad_couÁ
 =ğ
Ï¡_»ady_»ad_couÁ


1356 
­¶y
::
nÙify_¡®e_»q
(
£lf
.
‹rm
(), 
cb
);

1357  
	gçl£
;

1360 
Ët
 
mut
 
	gv
 = 
Mu¡CÚsumeVec
::
w™h_ÿ·c™y
("callback of index„ead", 1);

1361 
	gv
.
push
((
»q
, 
cb
));

1362 
	g£lf
.
	g³ndšg_»ads
.
	g»ads
.
push_back
(
R—dIndexReque¡
 {

1363 
id
: id,

1364 
cmds
: 
v
,

1365 
»Ãw_Ëa£_time
:„enew_lease_time,

1368 
m©ch
 
	g£lf
.
	gËad”_Ëa£_expœed_time
 {

1369 
Some
(
E™h”
::
Right
(
_
)) => {}

1370 
_
 =>  
Œue
,

1376 
Ët
 
	g»q
 = 
RaáCmdReque¡
::
Ãw
();

1377 
Ët
 
Ok
(
šdex
èğ
£lf
.
´İo£_nÜm®
(
»q
, 
m‘rics
) {

1378 
Ët
 
	gm‘a
 = 
Prİo§lM‘a
 {

1379 
šdex
: index,

1380 
‹rm
: 
£lf
.term(),

1381 
»Ãw_Ëa£_time
: 
Some
(renew_lease_time),

1383 
	g£lf
.
po¡_´İo£
(
m‘a
, 
çl£
, 
box
 |
_
| {});

1386 
	gŒue


1389 
â
 
´İo£_nÜm®
(

1390 &
mut
 
£lf
,

1391 
mut
 
»q
: 
RaáCmdReque¡
,

1392 
m‘rics
: &
mut
 
RaáPrİo£M‘rics
,

1393 è-> 
	gResuÉ
<
	gu64
> {

1394 
	gm‘rics
.
	gnÜm®
 += 1;

1397 
	g£lf
.
	gcİroûssÜ_ho¡
.
´e_´İo£
(
£lf
.
»giÚ
(), &
mut
 
»q
)?;

1398 
Ët
 
	gd©a
 = 
»q
.
wr™e_to_by‹s
()?;

1401 
	gPEER_PROPOSE_LOG_SIZE_HISTOGRAM
.
ob£rve
(
d©a
.
Ën
(è
as
 
f64
);

1403 
	gd©a
.
Ën
(è
as
 
	gu64
 > 
	g£lf
.
	g¿á_’Œy_max_size
 {

1404 
	g”rÜ
!("’Œy i toØÏrge,ƒÁry siz{}", 
	gd©a
.
Ën
());

1405  
E¼
(
E¼Ü
::
RaáEÁryTooL¬ge
(
£lf
.
»giÚ_id
, 
d©a
.
Ën
(è
as
 
u64
));

1408 
Ët
 
	gsync_log
 = 
g‘_sync_log_äom_»que¡
(&
»q
);

1409 
Ët
 
	g´İo£_šdex
 = 
£lf
.
Ãxt_´İo§l_šdex
();

1410 
	g£lf
.
	g¿á_group
.
´İo£
(
d©a
, 
sync_log
)?;

1411 
	g£lf
.
Ãxt_´İo§l_šdex
(è=ğ
´İo£_šdex
 {

1414  
E¼
(
E¼Ü
::
NÙL—d”
(
£lf
.
»giÚ_id
, 
NÚe
));

1417 
Ok
(
´İo£_šdex
)

1421 
â
 
´İo£_Œªsãr_Ëad”
(

1422 &
mut
 
£lf
,

1423 
»q
: 
RaáCmdReque¡
,

1424 
cb
: 
C®lback
,

1425 
m‘rics
: &
mut
 
RaáPrİo£M‘rics
,

1426 è-> 
	gboŞ
 {

1427 
	gm‘rics
.
	gŒªsãr_Ëad”
 += 1;

1429 
Ët
 
	gŒªsãr_Ëad”
 = 
g‘_Œªsãr_Ëad”_cmd
(&
»q
).
unw¿p
();

1430 
Ët
 
	g³”
 = 
Œªsãr_Ëad”
.
g‘_³”
();

1432 
Ët
 
	gŒªsã¼ed
 = 
£lf
.
is_Œªsãr_Ëad”_®lowed
(
³”
) {

1433 
£lf
.
Œªsãr_Ëad”
(
³”
);

1434 
	gŒue


1436 
	gšfo
!(

1438 
	g£lf
.
	gg
,

1439 
	g»q


1441 
	gçl£


1446 
cb
(
make_Œªsãr_Ëad”_»¥Ú£
());

1448 
	gŒªsã¼ed


1451 
â
 
´İo£_cÚf_chªge
(

1452 &
mut
 
£lf
,

1453 
»q
: 
RaáCmdReque¡
,

1454 
m‘rics
: &
mut
 
RaáPrİo£M‘rics
,

1455 è-> 
	gResuÉ
<
	gu64
> {

1456 
	g£lf
.
	g¿á_group
.
	g¿á
.
	g³ndšg_cÚf
 {

1457 
	gšfo
!("{}h”i ¨³ndšg cÚàchªge,ry†©”", 
	g£lf
.
	gg
);

1458  
E¼
(
box_”r
!(

1460 
£lf
.
g


1464 
	g£lf
.
check_cÚf_chªge
(&
»q
)?;

1466 
	gm‘rics
.
	gcÚf_chªge
 += 1;

1468 
Ët
 
	gd©a
 = 
»q
.
wr™e_to_by‹s
()?;

1471 
	gPEER_PROPOSE_LOG_SIZE_HISTOGRAM
.
ob£rve
(
d©a
.
Ën
(è
as
 
f64
);

1473 
Ët
 
	gchªge_³”
 = 
­¶y
::
g‘_chªge_³”_cmd
(&
»q
).
unw¿p
();

1475 
Ët
 
mut
 
	gcc
 = 
”aápb
::
CÚfChªge
::
Ãw
();

1476 
	gcc
.
£t_chªge_ty³
(
chªge_³”
.
g‘_chªge_ty³
());

1477 
	gcc
.
£t_node_id
(
chªge_³”
.
g‘_³”
().
g‘_id
());

1478 
	gcc
.
£t_cÚ‹xt
(
d©a
);

1480 
	gšfo
!(

1482 
	g£lf
.
	gg
,

1483 
	gcc
.
g‘_chªge_ty³
(),

1484 
	gcc
.
g‘_node_id
()

1487 
Ët
 
	g´İo£_šdex
 = 
£lf
.
Ãxt_´İo§l_šdex
();

1488 
	g£lf
.
	g¿á_group
.
´İo£_cÚf_chªge
(
cc
)?;

1489 
	g£lf
.
Ãxt_´İo§l_šdex
(è=ğ
´İo£_šdex
 {

1492  
E¼
(
E¼Ü
::
NÙL—d”
(
£lf
.
»giÚ_id
, 
NÚe
));

1495 
Ok
(
´İo£_šdex
)

1498 
â
 
hªdË_»ad
(&
mut
 
£lf
, 
»q
: 
RaáCmdReque¡
è-> 
RaáCmdRe¥Ú£
 {

1499 
Ët
 
mut
 
»¥
 = 
£lf
.
exec_»ad
(&
»q
).
unw¿p_Ü_–£
(|
e
| {

1500 
m©ch
 
e
 {

1501 
E¼Ü
::
SËEpoch
(..è=> 
šfo
!("{} sËƒpochƒ¼: {:?}", 
£lf
.
g
, 
e
),

1502 
_
 => 
”rÜ
!("{}ƒxecu‹„aá commªdƒ¼: {:?}", 
£lf
.
g
, 
e
),

1504 
cmd_»¥
::
Ãw_”rÜ
(
e
)

1507 
	gcmd_»¥
::
bšd_‹rm
(&
mut
 
»¥
, 
£lf
.
‹rm
());

1508 
	g»¥


1511 
pub
 
â
 
‹rm
(&
£lf
è-> 
	gu64
 {

1512 
	g£lf
.
	g¿á_group
.
	g¿á
.
	g‹rm


1515 
pub
 
â
 
¡İ
(&
mut
 
£lf
) {

1516 
	g£lf
.
mut_¡Üe
().
ÿnûl_­¶yšg_¢­
();

1517 
mut
 
»ad
 
š
 
	g£lf
.
	g³ndšg_»ads
.
	g»ads
.
d¿š
(..) {

1518 
	g»ad
.
	gcmds
.
ş—r
();

1523 
pub
 
â
 
check_•och
(
»giÚ
: &
m‘­b
::
RegiÚ
, 
»q
: &
RaáCmdReque¡
è-> 
ResuÉ
<()> {

1524 
Ët
 (
mut
 
check_v”
, muˆ
check_cÚf_v”
èğ(
çl£
, 
	gçl£
);

1525 
	g»q
.
has_admš_»que¡
() {

1526 
m©ch
 
	g»q
.
g‘_admš_»que¡
().
g‘_cmd_ty³
() {

1527 
	gAdmšCmdTy³
::
Com·ùLog
 |

1528 
AdmšCmdTy³
::
Inv®idAdmš
 |

1529 
AdmšCmdTy³
::
Compu‹Hash
 |

1530 
AdmšCmdTy³
::
V”ifyHash
 => {}

1531 
AdmšCmdTy³
::
S¶™
 => 
check_v”
 = 
Œue
,

1532 
	gAdmšCmdTy³
::
ChªgeP“r
 => 
check_cÚf_v”
 = 
Œue
,

1533 
	gAdmšCmdTy³
::
T¿nsãrL—d”
 => {

1534 
check_v”
 = 
Œue
;

1535 
	gcheck_cÚf_v”
 = 
Œue
;

1540 
	gcheck_v”
 = 
Œue
;

1543 !
	gcheck_v”
 && !
	gcheck_cÚf_v”
 {

1544  
Ok
(());

1547 !
	g»q
.
g‘_h—d”
().
has_»giÚ_•och
() {

1548  
E¼
(
box_”r
!("missingƒpoch!"));

1551 
Ët
 
	gäom_•och
 = 
»q
.
g‘_h—d”
().
g‘_»giÚ_•och
();

1552 
Ët
 
	gÏ‹¡_•och
 = 
»giÚ
.
g‘_»giÚ_•och
();

1555 ià(
	gcheck_cÚf_v”
 && 
	gäom_•och
.
g‘_cÚf_v”
(è< 
	gÏ‹¡_•och
.get_conf_ver()) ||

1556 (
	gcheck_v”
 && 
	gäom_•och
.
g‘_v”siÚ
(è< 
	gÏ‹¡_•och
.get_version())

1558 
	gdebug
!(

1560 
	g»giÚ
.
g‘_id
(),

1561 
	gäom_•och
,

1562 
	gÏ‹¡_•och


1564  
E¼
(
E¼Ü
::
SËEpoch
(

1565 
fÜm©
!(

1568 
»giÚ
.
g‘_id
(),

1569 
Ï‹¡_•och
,

1570 
äom_•och


1572 
vec
![
»giÚ
.
to_owÃd
()],

1576 
Ok
(())

1579 
im¶
 
	gP“r
 {

1580 
pub
 
â
 
š£¹_³”_ÿche
(&
mut
 
£lf
, 
³”
: 
m‘­b
::
P“r
) {

1581 
£lf
.
³”_ÿche
.
bÜrow_mut
().
š£¹
(
³”
.
g‘_id
(),…eer);

1584 
pub
 
â
 
»move_³”_äom_ÿche
(&
mut
 
£lf
, 
³”_id
: 
u64
) {

1585 
£lf
.
³”_ÿche
.
bÜrow_mut
().
»move
(&
³”_id
);

1588 
pub
 
â
 
g‘_³”_äom_ÿche
(&
£lf
, 
³”_id
: 
u64
è-> 
O±iÚ
<
m‘­b
::
P“r
> {

1589 
Ët
 
Some
(
³”
èğ
£lf
.
³”_ÿche
.
bÜrow
().
g‘
(&
³”_id
) {

1590  
Some
(
³”
.
şÚe
());

1594 
³”
 
š
 
	g£lf
.
g‘_¡Üe
().
g‘_»giÚ
().
g‘_³”s
() {

1595 
	g³”
.
g‘_id
(è=ğ
³”_id
 {

1596 
£lf
.
³”_ÿche
.
bÜrow_mut
().
š£¹
(
³”_id
, 
³”
.
şÚe
());

1597  
Some
(
³”
.
şÚe
());

1601 
	gNÚe


1604 
pub
 
â
 
h—¹b—t_pd
(&
£lf
, 
wÜk”
: &
Futu»WÜk”
<
PdTask
>) {

1605 
Ët
 
sk
 = 
PdTask
::
H—¹b—t
 {

1606 
»giÚ
: 
£lf
.»giÚ().
şÚe
(),

1607 
³”
: 
£lf
.³”.
şÚe
(),

1608 
down_³”s
: 
£lf
.
cŞËù_down_³”s
(£lf.
cfg
.
max_³”_down_du¿tiÚ
.0),

1609 
³ndšg_³”s
: 
£lf
.
cŞËù_³ndšg_³”s
(),

1610 
wr™‹n_by‹s
: 
£lf
.
³”_¡©
.written_bytes,

1611 
wr™‹n_keys
: 
£lf
.
³”_¡©
.written_keys,

1612 
»giÚ_size
: 
£lf
.
­´oxim©e_size
,

1614 
Ët
 
E¼
(
e
èğ
wÜk”
.
scheduË
(
sk
) {

1615 
”rÜ
!("{} faedØnÙify…d: {}", 
£lf
.
g
, 
e
);

1619 
â
 
	g£nd_¿á_mes§ge
<
	gT
: 
T¿n¥Üt
>(&
mut
 
£lf
, 
	gmsg
: 
”aápb
::
Mes§ge
, 
	gŒªs
: &
T
è-> 
ResuÉ
<()> {

1620 
Ët
 
mut
 
£nd_msg
 = 
RaáMes§ge
::
Ãw
();

1621 
	g£nd_msg
.
£t_»giÚ_id
(
£lf
.
»giÚ_id
);

1623 
	g£nd_msg
.
£t_»giÚ_•och
(
£lf
.
»giÚ
().
g‘_»giÚ_•och
().
şÚe
());

1625 
Ët
 
	gäom_³”
 = 
£lf
.
³”
.
şÚe
();

1627 
Ët
 
	gto_³”
 = 
m©ch
 
£lf
.
g‘_³”_äom_ÿche
(
msg
.
g‘_to
()) {

1628 
Some
(
p
) =>…,

1629 
	gNÚe
 => {

1630  
E¼
(
box_”r
!(

1632 
msg
.
g‘_to
(),

1633 
£lf
.
»giÚ_id


1638 
Ët
 
	gto_³”_id
 = 
to_³”
.
g‘_id
();

1639 
Ët
 
	gto_¡Üe_id
 = 
to_³”
.
g‘_¡Üe_id
();

1640 
Ët
 
	gmsg_ty³
 = 
msg
.
g‘_msg_ty³
();

1641 
	gdebug
!(

1643 
	g£lf
.
	gg
,

1644 
	gmsg_ty³
,

1645 
	gmsg
.
compu‹_size
(),

1646 
	gäom_³”
.
g‘_id
(),

1647 
	gto_³”_id


1650 
	g£nd_msg
.
£t_äom_³”
(
äom_³”
);

1651 
	g£nd_msg
.
£t_to_³”
(
to_³”
);

1661 
	g£lf
.
g‘_¡Üe
().
is_š™Ÿlized
() &&

1662 (
	gmsg_ty³
 =ğ
Mes§geTy³
::
MsgReque¡VÙe
 ||

1664 (
msg_ty³
 =ğ
Mes§geTy³
::
MsgH—¹b—t
 && 
msg
.
g‘_comm™
(è=ğ
INVALID_INDEX
))

1666 
Ët
 
»giÚ
 = 
£lf
.region();

1667 
	g£nd_msg
.
£t_¡¬t_key
(
»giÚ
.
g‘_¡¬t_key
().
to_vec
());

1668 
	g£nd_msg
.
£t_’d_key
(
»giÚ
.
g‘_’d_key
().
to_vec
());

1671 
	g£nd_msg
.
£t_mes§ge
(
msg
);

1673 
Ët
 
E¼
(
e
èğ
Œªs
.
£nd
(
£nd_msg
) {

1674 
w¬n
!(

1676 
£lf
.
g
,

1677 
to_³”_id
,

1678 
to_¡Üe_id
,

1679 
e


1683 
	g£lf
.
	g¿á_group
.
»pÜt_uÄ—chabË
(
to_³”_id
);

1684 
	gmsg_ty³
 =ğ
”aápb
::
Mes§geTy³
::
MsgSÇpshÙ
 {

1685 
£lf
.
¿á_group


1686 .
»pÜt_¢­shÙ
(
to_³”_id
, 
SÇpshÙStus
::
Fau»
);

1690 
Ok
(())

1693 
â
 
exec_»ad
(&
mut
 
£lf
, 
»q
: &
RaáCmdReque¡
è-> 
ResuÉ
<
RaáCmdRe¥Ú£
> {

1694 
check_•och
(
£lf
.
»giÚ
(), 
»q
)?;

1695 
Ët
 
mut
 
	g¢­
 = 
NÚe
;

1696 
Ët
 
	g»que¡s
 = 
»q
.
g‘_»que¡s
();

1697 
Ët
 
mut
 
	g»¥Ú£s
 = 
Vec
::
w™h_ÿ·c™y
(
»que¡s
.
Ën
());

1699 
»q
 
š
 
	g»que¡s
 {

1700 
Ët
 
	gcmd_ty³
 = 
»q
.
g‘_cmd_ty³
();

1701 
Ët
 
mut
 
	g»¥
 = 
m©ch
 
cmd_ty³
 {

1702 
CmdTy³
::
G‘
 => {

1703 
¢­
.
is_nÚe
() {

1704 
¢­
 = 
Some
(
SÇpshÙ
::
Ãw
(
£lf
.
kv_’gše
.
şÚe
()));

1706 
	g­¶y
::
do_g‘
(&
£lf
.
g
, s–f.
»giÚ
(), 
¢­
.
as_»f
().
unw¿p
(), 
»q
)?

1708 
	gCmdTy³
::
SÇp
 => 
­¶y
::
do_¢­
(
£lf
.
»giÚ
().
to_owÃd
())?,

1709 
	gCmdTy³
::
P»wr™e
 |

1710 
CmdTy³
::
Put
 |

1711 
CmdTy³
::
D–‘e
 |

1712 
CmdTy³
::
D–‘eRªge
 |

1713 
CmdTy³
::
Inv®id
 => 
uÄ—chabË
!(),

1716 
	g»¥
.
£t_cmd_ty³
(
cmd_ty³
);

1718 
	g»¥Ú£s
.
push
(
»¥
);

1721 
Ët
 
mut
 
	g»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

1722 
	g»¥
.
£t_»¥Ú£s
(
´Ùobuf
::
R•—‹dF›ld
::
äom_vec
(
»¥Ú£s
));

1723 
Ok
(
»¥
)

1727 
â
 
g‘_Œªsãr_Ëad”_cmd
(
msg
: &
RaáCmdReque¡
è-> 
O±iÚ
<&
T¿nsãrL—d”Reque¡
> {

1728 !
msg
.
has_admš_»que¡
() {

1729  
NÚe
;

1731 
Ët
 
	g»q
 = 
msg
.
g‘_admš_»que¡
();

1732 !
	g»q
.
has_Œªsãr_Ëad”
() {

1733  
	gNÚe
;

1736 
Some
(
»q
.
g‘_Œªsãr_Ëad”
())

1739 
â
 
g‘_sync_log_äom_»que¡
(
msg
: &
RaáCmdReque¡
è-> 
boŞ
 {

1740 
msg
.
has_admš_»que¡
() {

1741 
Ët
 
»q
 = 
msg
.
g‘_admš_»que¡
();

1742  
	g»q
.
g‘_cmd_ty³
(è=ğ
AdmšCmdTy³
::
ChªgeP“r
 ||

1743 
»q
.
g‘_cmd_ty³
(è=ğ
AdmšCmdTy³
::
S¶™
;

1746 
	gmsg
.
g‘_h—d”
().
g‘_sync_log
()

1749 
â
 
make_Œªsãr_Ëad”_»¥Ú£
(è-> 
	gRaáCmdRe¥Ú£
 {

1750 
Ët
 
mut
 
	g»¥Ú£
 = 
AdmšRe¥Ú£
::
Ãw
();

1751 
	g»¥Ú£
.
£t_cmd_ty³
(
AdmšCmdTy³
::
T¿nsãrL—d”
);

1752 
	g»¥Ú£
.
£t_Œªsãr_Ëad”
(
T¿nsãrL—d”Re¥Ú£
::
Ãw
());

1753 
Ët
 
mut
 
	g»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

1754 
	g»¥
.
£t_admš_»¥Ú£
(
»¥Ú£
);

1755 
	g»¥


	@src/raftstore/store/peer_storage.rs

14 
u£
 
	g¡d
::
sync
::{
£lf
, 
	gArc
};

15 
u£
 
	g¡d
::
sync
::
mpsc
::{
£lf
, 
	gReûiv”
, 
	gTryRecvE¼Ü
};

16 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

17 
u£
 
	g¡d
::
rc
::
Rc
;

18 
u£
 
	g¡d
::
ûÎ
::
RefC–l
;

19 
u£
 
	g¡d
::{
cmp
, 
	g”rÜ
, 
	gu64
};

20 
u£
 
	g¡d
::
time
::
In¡ªt
;

21 
u£
 
	g¡d
::
cŞËùiÚs
::
VecDeque
;

23 
u£
 
	grocksdb
::{
Wr™abË
, 
	gWr™eB©ch
, 
	gDB
};

24 
u£
 
	g´Ùobuf
::
Mes§ge
;

26 
u£
 
	gkv´Ùo
::
m‘­b
::{
£lf
, 
	gRegiÚ
};

27 
u£
 
	gkv´Ùo
::
”aápb
::{
CÚfS‹
, 
	gEÁry
, 
	gH¬dS‹
, 
	gSÇpshÙ
};

28 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
P“rS‹
, 
	gRaáAµlyS‹
, 
	gRaáLoÿlS‹
, 
	gRaáSÇpshÙD©a
,

29 
	gRegiÚLoÿlS‹
};

30 
u£
 
	gut
::
wÜk”
::
ScheduËr
;

31 
u£
 
	gut
::{
£lf
, 
	grocksdb
};

32 
u£
 
	g¿á
::{
£lf
, 
E¼Ü
 
as
 
	gRaáE¼Ü
, 
	gRaáS‹
, 
	gR—dy
, 
	gStÜage
, 
	gStÜageE¼Ü
};

33 
u£
 
	g¿á¡Üe
::{
E¼Ü
, 
	gResuÉ
};

34 
u£
 
	gsu³r
::
wÜk”
::
RegiÚTask
;

35 
u£
 
	gsu³r
::
keys
::{
£lf
, 
	g’c_’d_key
, 
	g’c_¡¬t_key
};

36 
u£
 
	gsu³r
::
’gše
::{
I‹¿bË
, 
	gMubË
, 
	gP“kabË
, 
SÇpshÙ
 
as
 
	gDbSÇpshÙ
};

37 
u£
 
	gsu³r
::
³”
::
R—dyCÚ‹xt
;

38 
u£
 
	gsu³r
::
m‘rics
::*;

39 
u£
 
	gsu³r
::{
SÇpEÁry
, 
	gSÇpKey
, 
	gSÇpMªag”
, 
	gSÇpshÙSti¡ics
};

40 
u£
 
	g¡Üage
::
CF_RAFT
;

44 
pub
 cÚ¡ 
	gRAFT_INIT_LOG_TERM
: 
u64
 = 5;

45 
pub
 cÚ¡ 
	gRAFT_INIT_LOG_INDEX
: 
u64
 = 5;

46 cÚ¡ 
	gMAX_SNAP_TRY_CNT
: 
usize
 = 5;

47 cÚ¡ 
	gRAFT_LOG_MULTI_GET_CNT
: 
u64
 = 8;

50 cÚ¡ 
	gMAX_CACHE_CAPACITY
: 
usize
 = 1024 - 1;

51 cÚ¡ 
	gSHRINK_CACHE_CAPACITY
: 
usize
 = 64;

53 
pub
 cÚ¡ 
	gJOB_STATUS_PENDING
: 
usize
 = 0;

54 
pub
 cÚ¡ 
	gJOB_STATUS_RUNNING
: 
usize
 = 1;

55 
pub
 cÚ¡ 
	gJOB_STATUS_CANCELLING
: 
usize
 = 2;

56 
pub
 cÚ¡ 
	gJOB_STATUS_CANCELLED
: 
usize
 = 3;

57 
pub
 cÚ¡ 
	gJOB_STATUS_FINISHED
: 
usize
 = 4;

58 
pub
 cÚ¡ 
	gJOB_STATUS_FAILED
: 
usize
 = 5;

61 #[
d”ive
(
Debug
)]

62 
pub
 
	eSÇpS‹
 {

63 
	mR–ax
,

64 
G’”©šg
(
Reûiv”
<
SÇpshÙ
>),

65 
Aµlyšg
(
Arc
<
AtomicUsize
>),

66 
	mAµlyAbÜ‹d
,

69 
im¶
 
P¬tŸlEq
 
	gSÇpS‹
 {

70 
â
 
eq
(&
£lf
, 
Ùh”
: &
SÇpS‹
è-> 
boŞ
 {

71 
m©ch
 (
£lf
, 
Ùh”
) {

72 (&
	gSÇpS‹
::
R–ax
, &SnapState::Relax) |

73 (&
SÇpS‹
::
AµlyAbÜ‹d
, &
	gSÇpS‹
::ApplyAborted) |

74 (&
SÇpS‹
::
G’”©šg
(
_
), &
	gSÇpS‹
::G’”©šg(_)è=> 
Œue
,

75 (&
	gSÇpS‹
::
Aµlyšg
(
»f
 
b1
), &SÇpS‹::AµlyšgÔeà
b2
)) => {

76 
b1
.
lßd
(
Ord”šg
::
R–axed
è=ğ
b2
.load(Ordering::Relaxed)

78 
_
 => 
çl£
,

85 
pub
 
â
 
com·ù_¿á_log
(

86 
g
: &
¡r
,

87 
¡©e
: &
mut
 
RaáAµlyS‹
,

88 
com·ù_šdex
: 
u64
,

89 
com·ù_‹rm
: 
u64
,

90 è-> 
	gResuÉ
<()> {

91 
	gdebug
!("{} com·ù†ogƒÁr› tØ´iÜØ{}", 
	gg
, 
	gcom·ù_šdex
);

93 
	gcom·ù_šdex
 <ğ
¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_šdex
() {

94  
E¼
(
box_”r
!("tryoruncate compactedƒntries"));

95 } 
	gcom·ù_šdex
 > 
	g¡©e
.
g‘_­¶›d_šdex
() {

96  
E¼
(
box_”r
!(

98 
com·ù_šdex
,

99 
¡©e
.
g‘_­¶›d_šdex
()

105 
	g¡©e
.
mut_Œunÿ‹d_¡©e
().
£t_šdex
(
com·ù_šdex
);

106 
	g¡©e
.
mut_Œunÿ‹d_¡©e
().
£t_‹rm
(
com·ù_‹rm
);

108 
Ok
(())

111 #[
šlše
]

112 
pub
 
â
 
fœ¡_šdex
(
¡©e
: &
RaáAµlyS‹
è-> 
u64
 {

113 
¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_šdex
() + 1

116 #[
šlše
]

117 
pub
 
â
 
Ï¡_šdex
(
¡©e
: &
RaáLoÿlS‹
è-> 
u64
 {

118 
¡©e
.
g‘_Ï¡_šdex
()

121 #[
d”ive
(
DeçuÉ
)]

122 
	sEÁryCache
 {

123 
ÿche
: 
VecDeque
<
EÁry
>,

126 
im¶
 
	gEÁryCache
 {

127 
â
 
fœ¡_šdex
(&
£lf
è-> 
	gu64
 {

128 
	g£lf
.
	gÿche
.
äÚt
().
m­_Ü
(
u64
::
MAX
, |
e
|ƒ.
g‘_šdex
())

131 
â
 
ãtch_’Œ›s_to
(

132 &
£lf
,

133 
begš
: 
u64
,

134 
’d
: 
u64
,

135 
mut
 
ãtched_size
: 
u64
,

136 
max_size
: 
u64
,

137 
’ts
: &
mut
 
Vec
<
EÁry
>,

139 
	gbegš
 >ğ
’d
 {

142 
	gas£¹
!(!
	g£lf
.
	gÿche
.
is_em±y
());

143 
Ët
 
	gÿche_low
 = 
£lf
.
ÿche
.
äÚt
().
unw¿p
().
g‘_šdex
();

144 
Ët
 
	g¡¬t_idx
 = 
begš
.
checked_sub
(
ÿche_low
).
unw¿p
(è
as
 
usize
;

145 
Ët
 
	glim™_idx
 = 
’d
.
checked_sub
(
ÿche_low
).
unw¿p
(è
as
 
usize
;

147 
Ët
 
mut
 
	g’d_idx
 = 
¡¬t_idx
;

148 
	g£lf
.
	gÿche


149 .
™”
()

150 .
sk
(
¡¬t_idx
)

151 .
ke_whe
(|
e
| {

152 
Ët
 
cur_idx
 = 
’d_idx
 
as
 
u64
 + 
ÿche_low
;

153 
as£¹_eq
!(
e
.
g‘_šdex
(), 
cur_idx
);

154 
Ët
 
m
 = 
e
.
compu‹_size
(è
as
 
u64
;

155 
ãtched_size
 +ğ
m
;

156 
ãtched_size
 =ğ
m
 {

157 
’d_idx
 += 1;

158 
ãtched_size
 <ğ
max_size
 && 
’d_idx
 < 
lim™_idx


159 } 
ãtched_size
 <ğ
max_size
 {

160 
’d_idx
 += 1;

161 
’d_idx
 < 
lim™_idx


163 
çl£


166 .
couÁ
();

169 
	gas£¹
!(
	g’d_idx
 =ğ
lim™_idx
 || 
ãtched_size
 > 
max_size
);

170 
Ët
 (
fœ¡
, 
£cÚd
èğ
ut
::
¦iûs_š_¿nge
(&
£lf
.
ÿche
, 
¡¬t_idx
, 
’d_idx
);

171 
	g’ts
.
ex‹nd_äom_¦iû
(
fœ¡
);

172 
	g’ts
.
ex‹nd_äom_¦iû
(
£cÚd
);

175 
â
 
­³nd
(&
mut
 
£lf
, 
g
: &
¡r
, 
’Œ›s
: &[
EÁry
]) {

176 
’Œ›s
.
is_em±y
() {

179 
Ët
 
Some
(
ÿche_Ï¡_šdex
èğ
£lf
.
ÿche
.
back
().
m­
(|
e
|ƒ.
g‘_šdex
()) {

180 
Ët
 
fœ¡_šdex
 = 
’Œ›s
[0].
g‘_šdex
();

181 
	gÿche_Ï¡_šdex
 >ğ
fœ¡_šdex
 {

182 
£lf
.
ÿche
.
äÚt
().
unw¿p
().
g‘_šdex
(è>ğ
fœ¡_šdex
 {

183 
£lf
.
ÿche
.
ş—r
();

185 
Ët
 
	gËá
 = 
£lf
.
ÿche
.
Ën
(è- (
ÿche_Ï¡_šdex
 - 
fœ¡_šdex
 + 1è
as
 
usize
;

186 
	g£lf
.
	gÿche
.
Œunÿ‹
(
Ëá
);

188 
	g£lf
.
	gÿche
.
Ën
(è+ 
	g’Œ›s
.Ën(è< 
	gSHRINK_CACHE_CAPACITY
 &&

189 
	g£lf
.
	gÿche
.
ÿ·c™y
(è> 
	gSHRINK_CACHE_CAPACITY


191 
	g£lf
.
	gÿche
.
shršk_to_f™
();

193 } 
	gÿche_Ï¡_šdex
 + 1 < 
	gfœ¡_šdex
 {

194 
	g·nic
!(

196 
	gg
,

197 
	gÿche_Ï¡_šdex
,

198 
	gfœ¡_šdex


202 
Ët
 
mut
 
	g¡¬t_idx
 = 0;

203 
Ët
 
Some
(
Ën
èğ(
£lf
.
ÿche
.Ën(è+ 
’Œ›s
.Ën()).
checked_sub
(
MAX_CACHE_CAPACITY
) {

204 
Ën
 < 
£lf
.
ÿche
.len() {

205 
£lf
.
ÿche
.
d¿š
(..
Ën
);

207 
	g¡¬t_idx
 = 
Ën
 - 
£lf
.
ÿche
.len();

208 
	g£lf
.
	gÿche
.
ş—r
();

211 
e
 
	gš
 &
	g’Œ›s
[
¡¬t_idx
..] {

212 
	g£lf
.
	gÿche
.
push_back
(
e
.
to_owÃd
());

216 
pub
 
â
 
com·ù_to
(&
mut
 
£lf
, 
idx
: 
u64
) {

217 
Ët
 
ÿche_fœ¡_idx
 = 
m©ch
 
£lf
.
ÿche
.
äÚt
() {

218 
NÚe
 => ,

219 
Some
(
e
è=>ƒ.
g‘_šdex
(),

222 
	gÿche_fœ¡_idx
 > 
	gidx
 {

225 
Ët
 
	gÿche_Ï¡_idx
 = 
£lf
.
ÿche
.
back
().
unw¿p
().
g‘_šdex
();

226 
	g£lf
.
	gÿche


227 .
d¿š
(..(
cmp
::
mš
(
ÿche_Ï¡_idx
, 
idx
è- 
ÿche_fœ¡_idx
è
as
 
usize
);

228 
	g£lf
.
	gÿche
.
Ën
(è< 
	gSHRINK_CACHE_CAPACITY
 &&

229 
	g£lf
.
	gÿche
.
ÿ·c™y
(è> 
	gSHRINK_CACHE_CAPACITY


233 
	g£lf
.
	gÿche
.
shršk_to_f™
();

238 #[
d”ive
(
DeçuÉ
)]

239 
pub
 
	sCacheQu”ySts
 {

240 
pub
 
	mh™
: 
u64
,

241 
pub
 
	mmiss
: 
u64
,

244 
im¶
 
	gCacheQu”ySts
 {

245 
pub
 
â
 
æush
(&
mut
 
£lf
) {

246 
	gRAFT_ENTRY_FETCHES


247 .
w™h_Ïb–_v®ues
(&["hit"])

248 .
šc_by
(
£lf
.
h™
 
as
 
f64
)

249 .
unw¿p
();

250 
	gRAFT_ENTRY_FETCHES


251 .
w™h_Ïb–_v®ues
(&["miss"])

252 .
šc_by
(
£lf
.
miss
 
as
 
f64
)

253 .
unw¿p
();

254 
	g£lf
.
	gh™
 = 0;

255 
	g£lf
.
	gmiss
 = 0;

259 
pub
 
	sP“rStÜage
 {

260 
pub
 
	mkv_’gše
: 
Arc
<
DB
>,

261 
pub
 
	m¿á_’gše
: 
Arc
<
DB
>,

263 
pub
 
	m»giÚ
: 
m‘­b
::
RegiÚ
,

264 
pub
 
	m¿á_¡©e
: 
RaáLoÿlS‹
,

265 
pub
 
	m­¶y_¡©e
: 
RaáAµlyS‹
,

266 
pub
 
	m­¶›d_šdex_‹rm
: 
u64
,

267 
pub
 
	mÏ¡_‹rm
: 
u64
,

269 
	m¢­_¡©e
: 
RefC–l
<
SÇpS‹
>,

270 
	m»giÚ_sched
: 
ScheduËr
<
RegiÚTask
>,

271 
	m¢­_Œ›d_út
: 
RefC–l
<
usize
>,

273 
	mÿche
: 
EÁryCache
,

274 
	m¡©s
: 
Rc
<
RefC–l
<
CacheQu”ySts
>>,

276 
pub
 
	mg
: 
SŒšg
,

279 
â
 
	g¡Üage_”rÜ
<
	gE
>(
	g”rÜ
: 
E
è-> 
¿á
::
E¼Ü


280 
wh”e


281 
E
: 
IÁo
<
Box
<
”rÜ
::
E¼Ü
 + 
S’d
 + 
Sync
>>,

283 
	g¿á
::
E¼Ü
::
StÜe
(
StÜageE¼Ü
::
Oth”
(
”rÜ
.
što
()))

286 
im¶
 
From
<
E¼Ü
> 
RaáE¼Ü
 {

287 
â
 
äom
(
”r
: 
E¼Ü
è-> 
RaáE¼Ü
 {

288 
¡Üage_”rÜ
(
”r
)

292 
im¶
<
T
> 
From
<
sync
::
PoisÚE¼Ü
<T>> 
RaáE¼Ü
 {

293 
â
 
äom
(
_
: 
sync
::
PoisÚE¼Ü
<
T
>è-> 
RaáE¼Ü
 {

294 
¡Üage_”rÜ
("lock failed")

298 
pub
 
	sAµlySÇpResuÉ
 {

300 
pub
 
´ev_»giÚ
: 
m‘­b
::
RegiÚ
,

301 
pub
 
	m»giÚ
: 
m‘­b
::
RegiÚ
,

304 
pub
 
	sInvokeCÚ‹xt
 {

305 
pub
 
	m»giÚ_id
: 
u64
,

306 
pub
 
	m¿á_¡©e
: 
RaáLoÿlS‹
,

307 
pub
 
	m­¶y_¡©e
: 
RaáAµlyS‹
,

308 
	mÏ¡_‹rm
: 
u64
,

309 
pub
 
	m¢­_»giÚ
: 
O±iÚ
<
RegiÚ
>,

312 
im¶
 
	gInvokeCÚ‹xt
 {

313 
pub
 
â
 
Ãw
(
¡Üe
: &
P“rStÜage
è-> 
InvokeCÚ‹xt
 {

314 
InvokeCÚ‹xt
 {

315 
»giÚ_id
: 
¡Üe
.
g‘_»giÚ_id
(),

316 
	g¿á_¡©e
: 
¡Üe
.
¿á_¡©e
.
şÚe
(),

317 
	g­¶y_¡©e
: 
¡Üe
.
­¶y_¡©e
.
şÚe
(),

318 
	gÏ¡_‹rm
: 
¡Üe
.
Ï¡_‹rm
,

319 
	g¢­_»giÚ
: 
NÚe
,

323 #[
šlše
]

324 
pub
 
â
 
has_¢­shÙ
(&
£lf
è-> 
	gboŞ
 {

325 
	g£lf
.
	g¢­_»giÚ
.
is_some
()

328 #[
šlše
]

329 
pub
 
â
 
§ve_¿á_¡©e_to
(&
£lf
, 
¿á_wb
: &
mut
 
Wr™eB©ch
è-> 
ResuÉ
<()> {

330 
¿á_wb


331 .
put_msg
(&
keys
::
¿á_¡©e_key
(
£lf
.
»giÚ_id
), &£lf.
¿á_¡©e
)?;

332 
Ok
(())

335 #[
šlše
]

336 
pub
 
â
 
§ve_¢­shÙ_¿á_¡©e_to
(

337 &
£lf
,

338 
¢­shÙ_šdex
: 
u64
,

339 
kv_’gše
: &
DB
,

340 
kv_wb
: &
mut
 
Wr™eB©ch
,

341 è-> 
	gResuÉ
<()> {

342 
Ët
 
mut
 
	g¢­shÙ_¿á_¡©e
 = 
£lf
.
¿á_¡©e
.
şÚe
();

343 
	g¢­shÙ_¿á_¡©e


344 .
mut_h¬d_¡©e
()

345 .
£t_comm™
(
¢­shÙ_šdex
);

346 
	g¢­shÙ_¿á_¡©e
.
£t_Ï¡_šdex
(
¢­shÙ_šdex
);

348 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(
kv_’gše
, 
CF_RAFT
)?;

349 
	gkv_wb
.
put_msg_cf
(

350 
hªdË
,

351 &
keys
::
¢­shÙ_¿á_¡©e_key
(
£lf
.
»giÚ_id
),

352 &
¢­shÙ_¿á_¡©e
,

354 
Ok
(())

357 #[
šlše
]

358 
pub
 
â
 
§ve_­¶y_¡©e_to
(&
£lf
, 
kv_’gše
: &
DB
, 
kv_wb
: &
mut
 
Wr™eB©ch
è-> 
ResuÉ
<()> {

359 
Ët
 
hªdË
 = 
rocksdb
::
g‘_cf_hªdË
(
kv_’gše
, 
CF_RAFT
)?;

360 
	gkv_wb
.
put_msg_cf
(

361 
hªdË
,

362 &
keys
::
­¶y_¡©e_key
(
£lf
.
»giÚ_id
),

363 &
£lf
.
­¶y_¡©e
,

365 
Ok
(())

369 
pub
 
â
 
»cov”_äom_­¶yšg_¡©e
(

370 
kv_’gše
: &
DB
,

371 
¿á_’gše
: &
DB
,

372 
¿á_wb
: &
Wr™eB©ch
,

373 
»giÚ_id
: 
u64
,

374 è-> 
	gResuÉ
<()> {

375 
Ët
 
	g¢­shÙ_¿á_¡©e_key
 = 
keys
::
¢­shÙ_¿á_¡©e_key
(
»giÚ_id
);

376 
Ët
 
	g¢­shÙ_¿á_¡©e
: 
RaáLoÿlS‹
 =

377 
m©ch
 
box_Œy
!(
kv_’gše
.
g‘_msg_cf
(
CF_RAFT
, &
¢­shÙ_¿á_¡©e_key
)) {

378 
Some
(
¡©e
) => state,

379 
	gNÚe
 => {

380  
E¼
(
box_”r
!(

383 
»giÚ_id


388 
Ët
 
	g¿á_¡©e_key
 = 
keys
::
¿á_¡©e_key
(
»giÚ_id
);

389 
Ët
 
	g¿á_¡©e
: 
RaáLoÿlS‹
 = 
m©ch
 
box_Œy
!(
¿á_’gše
.
g‘_msg
(&
¿á_¡©e_key
)) {

390 
Some
(
¡©e
) => state,

391 
	gNÚe
 => 
RaáLoÿlS‹
::
Ãw
(),

400 
Ï¡_šdex
(&
¢­shÙ_¿á_¡©e
è>†a¡_šdex(&
¿á_¡©e
) {

401 
	g¿á_wb
.
put_msg
(&
¿á_¡©e_key
, &
¢­shÙ_¿á_¡©e
)?;

403 
Ok
(())

406 
â
 
š™_¿á_¡©e
(
¿á_’gše
: &
DB
, 
»giÚ
: &
RegiÚ
è-> 
ResuÉ
<
RaáLoÿlS‹
> {

407 
Ët
 
¡©e_key
 = 
keys
::
¿á_¡©e_key
(
»giÚ
.
g‘_id
());

408 
Ok
(
m©ch
 
¿á_’gše
.
g‘_msg
(&
¡©e_key
)? {

409 
Some
(
s
) => s,

410 
NÚe
 => {

411 
Ët
 
mut
 
¿á_¡©e
 = 
RaáLoÿlS‹
::
Ãw
();

412 !
»giÚ
.
g‘_³”s
().
is_em±y
() {

414 
¿á_¡©e
.
£t_Ï¡_šdex
(
RAFT_INIT_LOG_INDEX
);

415 
¿á_¡©e
.
mut_h¬d_¡©e
().
£t_‹rm
(
RAFT_INIT_LOG_TERM
);

416 
¿á_¡©e
.
mut_h¬d_¡©e
().
£t_comm™
(
RAFT_INIT_LOG_INDEX
);

417 
¿á_’gše
.
put_msg
(&
¡©e_key
, &
¿á_¡©e
)?;

419 
¿á_¡©e


424 
â
 
š™_­¶y_¡©e
(
kv_’gše
: &
DB
, 
»giÚ
: &
RegiÚ
è-> 
ResuÉ
<
RaáAµlyS‹
> {

425 
Ok
(
m©ch
 
Œy
!(

426 
kv_’gše
.
g‘_msg_cf
(
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(
»giÚ
.
g‘_id
()))

428 
Some
(
s
) => s,

429 
NÚe
 => {

430 
Ët
 
mut
 
­¶y_¡©e
 = 
RaáAµlyS‹
::
Ãw
();

431 !
»giÚ
.
g‘_³”s
().
is_em±y
() {

432 
­¶y_¡©e
.
£t_­¶›d_šdex
(
RAFT_INIT_LOG_INDEX
);

433 
Ët
 
¡©e
 = 
­¶y_¡©e
.
mut_Œunÿ‹d_¡©e
();

434 
¡©e
.
£t_šdex
(
RAFT_INIT_LOG_INDEX
);

435 
¡©e
.
£t_‹rm
(
RAFT_INIT_LOG_TERM
);

437 
­¶y_¡©e


442 
â
 
š™_Ï¡_‹rm
(

443 
¿á_’gše
: &
DB
,

444 
»giÚ
: &
RegiÚ
,

445 
¿á_¡©e
: &
RaáLoÿlS‹
,

446 
­¶y_¡©e
: &
RaáAµlyS‹
,

447 è-> 
	gResuÉ
<
	gu64
> {

448 
Ët
 
	gÏ¡_idx
 = 
¿á_¡©e
.
g‘_Ï¡_šdex
();

449 
	gÏ¡_idx
 == 0 {

450  
Ok
(0);

451 } 
	gÏ¡_idx
 =ğ
RAFT_INIT_LOG_INDEX
 {

452  
Ok
(
RAFT_INIT_LOG_TERM
);

453 } 
	gÏ¡_idx
 =ğ
­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_šdex
() {

454  
Ok
(
­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_‹rm
());

456 
	gas£¹
!(
	gÏ¡_idx
 > 
	gRAFT_INIT_LOG_INDEX
);

458 
Ët
 
	gÏ¡_log_key
 = 
keys
::
¿á_log_key
(
»giÚ
.
g‘_id
(), 
Ï¡_idx
);

459 
Ok
(
m©ch
 
¿á_’gše
.
g‘_msg
::<
EÁry
>(&
Ï¡_log_key
)? {

460 
NÚe
 => {

461  
E¼
(
box_”r
!(

463 
»giÚ
.
g‘_id
(),

464 
Ï¡_idx


467 
Some
(
e
è=>ƒ.
g‘_‹rm
(),

471 
im¶
 
	gP“rStÜage
 {

472 
pub
 
â
 
Ãw
(

473 
kv_’gše
: 
Arc
<
DB
>,

474 
¿á_’gše
: 
Arc
<
DB
>,

475 
»giÚ
: &
m‘­b
::
RegiÚ
,

476 
»giÚ_sched
: 
ScheduËr
<
RegiÚTask
>,

477 
g
: 
SŒšg
,

478 
¡©s
: 
Rc
<
RefC–l
<
CacheQu”ySts
>>,

479 è-> 
	gResuÉ
<
	gP“rStÜage
> {

480 
	gdebug
!("ü—tšg stÜagÚ {} fÜ {:?}", 
	gkv_’gše
.
·th
(), 
	g»giÚ
);

481 
Ët
 
	g¿á_¡©e
 = 
š™_¿á_¡©e
(&
¿á_’gše
, 
»giÚ
)?;

482 
Ët
 
	g­¶y_¡©e
 = 
š™_­¶y_¡©e
(&
kv_’gše
, 
»giÚ
)?;

483 
	g¿á_¡©e
.
g‘_Ï¡_šdex
(è< 
	g­¶y_¡©e
.
g‘_­¶›d_šdex
() {

484 
	g·nic
!(

486 
	gg
,

487 
	g¿á_¡©e
.
g‘_Ï¡_šdex
(),

488 
	g­¶y_¡©e
.
g‘_­¶›d_šdex
()

491 
Ët
 
	gÏ¡_‹rm
 = 
š™_Ï¡_‹rm
(&
¿á_’gše
, 
»giÚ
, &
¿á_¡©e
, &
­¶y_¡©e
)?;

493 
Ok
(
P“rStÜage
 {

494 
kv_’gše
: kv_engine,

495 
¿á_’gše
:„aft_engine,

496 
»giÚ
:„egiÚ.
şÚe
(),

497 
¿á_¡©e
:„aft_state,

498 
­¶y_¡©e
:‡pply_state,

499 
¢­_¡©e
: 
RefC–l
::
Ãw
(
SÇpS‹
::
R–ax
),

500 
»giÚ_sched
:„egion_sched,

501 
¢­_Œ›d_út
: 
RefC–l
::
Ãw
(0),

502 
g
:ag,

503 
­¶›d_šdex_‹rm
: 
RAFT_INIT_LOG_TERM
,

504 
Ï¡_‹rm
:†ast_term,

505 
ÿche
: 
EÁryCache
::(),

506 
¡©s
: stats,

510 
pub
 
â
 
is_š™Ÿlized
(&
£lf
è-> 
	gboŞ
 {

511 !
	g£lf
.
	g»giÚ
.
g‘_³”s
().
is_em±y
()

514 
pub
 
â
 
š™Ÿl_¡©e
(&
£lf
è-> 
	g¿á
::
ResuÉ
<
RaáS‹
> {

515 
Ët
 
h¬d_¡©e
 = 
£lf
.
¿á_¡©e
.
g‘_h¬d_¡©e
().
şÚe
();

516 
Ët
 
mut
 
	gcÚf_¡©e
 = 
CÚfS‹
::
Ãw
();

517 
	gh¬d_¡©e
 =ğ
H¬dS‹
::
Ãw
() {

518 
as£¹
!(

519 !
£lf
.
is_š™Ÿlized
(),

522 
£lf
.
»giÚ
,

523 
£lf
.
¿á_¡©e


526  
Ok
(
RaáS‹
 {

527 
h¬d_¡©e
: hard_state,

528 
cÚf_¡©e
: conf_state,

532 
p
 
š
 
	g£lf
.
	g»giÚ
.
g‘_³”s
() {

533 
	gcÚf_¡©e
.
mut_nodes
().
push
(
p
.
g‘_id
());

536 
Ok
(
RaáS‹
 {

537 
h¬d_¡©e
: hard_state,

538 
cÚf_¡©e
: conf_state,

542 
â
 
check_¿nge
(&
£lf
, 
low
: 
u64
, 
high
: u64è-> 
¿á
::
ResuÉ
<()> {

543 
low
 > 
high
 {

544  
E¼
(
¡Üage_”rÜ
(

545 
fÜm©
!("low: {} i g»©”h© high: {}", 
low
, 
high
),

547 } 
	glow
 <ğ
£lf
.
Œunÿ‹d_šdex
() {

548  
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
));

549 } 
	ghigh
 > 
	g£lf
.
Ï¡_šdex
() + 1 {

550  
E¼
(
¡Üage_”rÜ
(
fÜm©
!(

552 
high
,

553 
£lf
.
Ï¡_šdex
()

556 
Ok
(())

559 
pub
 
â
 
’Œ›s
(&
£lf
, 
low
: 
u64
, 
high
: u64, 
max_size
: u64è-> 
¿á
::
ResuÉ
<
Vec
<
EÁry
>> {

560 
£lf
.
check_¿nge
(
low
, 
high
)?;

561 
Ët
 
mut
 
	g’ts
 = 
Vec
::
w™h_ÿ·c™y
((
high
 - 
low
è
as
 
usize
);

562 
	glow
 =ğ
high
 {

563  
Ok
(
’ts
);

565 
Ët
 
	gÿche_low
 = 
£lf
.
ÿche
.
fœ¡_šdex
();

566 
	ghigh
 <ğ
ÿche_low
 {

568 
£lf
.
¡©s
.
bÜrow_mut
().
miss
 += 1;

569 
	g£lf
.
ãtch_’Œ›s_to
(
low
, 
high
, 
max_size
, &
mut
 
’ts
)?;

570  
Ok
(
’ts
);

572 
Ët
 
mut
 
	gãtched_size
 = 0;

573 
Ët
 
	gbegš_idx
 = 
low
 < 
ÿche_low
 {

574 
£lf
.
¡©s
.
bÜrow_mut
().
miss
 += 1;

575 
	gãtched_size
 = 
£lf
.
ãtch_’Œ›s_to
(
low
, 
ÿche_low
, 
max_size
, &
mut
 
’ts
)?;

576 
	gãtched_size
 > 
	gmax_size
 {

578  
Ok
(
’ts
);

580 
	gÿche_low


582 
	glow


585 
	g£lf
.
	g¡©s
.
bÜrow_mut
().
	gh™
 += 1;

586 
	g£lf
.
	gÿche


587 .
ãtch_’Œ›s_to
(
begš_idx
, 
high
, 
ãtched_size
, 
max_size
, &
mut
 
’ts
);

588 
Ok
(
’ts
)

591 
â
 
ãtch_’Œ›s_to
(

592 &
£lf
,

593 
low
: 
u64
,

594 
high
: 
u64
,

595 
max_size
: 
u64
,

596 
buf
: &
mut
 
Vec
<
EÁry
>,

597 è-> 
	g¿á
::
ResuÉ
<
u64
> {

598 
Ët
 
mut
 
tÙ®_size
: 
u64
 = 0;

599 
Ët
 
mut
 
	gÃxt_šdex
 = 
low
;

600 
Ët
 
mut
 
	gexûeded_max_size
 = 
çl£
;

601 
	ghigh
 - 
	glow
 <ğ
RAFT_LOG_MULTI_GET_CNT
 {

604 
i
 
š
 
low
..
high
 {

605 
Ët
 
key
 = 
keys
::
¿á_log_key
(
£lf
.
g‘_»giÚ_id
(), 
i
);

606 
m©ch
 
	gbox_Œy
!(
	g£lf
.
	g¿á_’gše
.
g‘
(&
key
)) {

607 
	gNÚe
 =>  
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
UÇvaabË
)),

608 
Some
(
v
) => {

609 
Ët
 
mut
 
’Œy
 = 
EÁry
::
Ãw
();

610 
	gbox_Œy
!(
	g’Œy
.
m”ge_äom_by‹s
(&
v
));

611 
	gas£¹_eq
!(
	g’Œy
.
g‘_šdex
(), 
	gi
);

612 
	gtÙ®_size
 +ğ
v
.
Ën
(è
as
 
u64
;

613 
	gbuf
.
is_em±y
(è|| 
	gtÙ®_size
 <ğ
max_size
 {

614 
buf
.
push
(
’Œy
);

616 
	gtÙ®_size
 > 
	gmax_size
 {

622  
Ok
(
tÙ®_size
);

625 
Ët
 
	g¡¬t_key
 = 
keys
::
¿á_log_key
(
£lf
.
g‘_»giÚ_id
(), 
low
);

626 
Ët
 
	g’d_key
 = 
keys
::
¿á_log_key
(
£lf
.
g‘_»giÚ_id
(), 
high
);

627 
	g£lf
.
	g¿á_’gše
.
sÿn
(

628 &
¡¬t_key
,

629 &
’d_key
,

630 
Œue
,

631 &
mut
 |
_
, 
v®ue
| {

632 
Ët
 
mut
 
’Œy
 = 
EÁry
::
Ãw
();

633 
’Œy
.
m”ge_äom_by‹s
(
v®ue
)?;

636 
’Œy
.
g‘_šdex
(è!ğ
Ãxt_šdex
 {

637  
Ok
(
çl£
);

639 
Ãxt_šdex
 += 1;

641 
tÙ®_size
 +ğ
v®ue
.
Ën
(è
as
 
u64
;

642 
exûeded_max_size
 = 
tÙ®_size
 > 
max_size
;

643 !
exûeded_max_size
 || 
buf
.
is_em±y
() {

644 
buf
.
push
(
’Œy
);

646 
Ok
(!
exûeded_max_size
)

652 
	gbuf
.
Ën
(è=ğ(
high
 - 
low
è
as
 
usize
 || 
exûeded_max_size
 {

653  
Ok
(
tÙ®_size
);

657 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
UÇvaabË
))

660 
pub
 
â
 
‹rm
(&
£lf
, 
idx
: 
u64
è-> 
¿á
::
ResuÉ
<u64> {

661 
idx
 =ğ
£lf
.
Œunÿ‹d_šdex
() {

662  
Ok
(
£lf
.
Œunÿ‹d_‹rm
());

664 
	g£lf
.
check_¿nge
(
idx
, idx + 1)?;

665 
	g£lf
.
Œunÿ‹d_‹rm
(è=ğ
£lf
.
Ï¡_‹rm
 || 
idx
 =ğ£lf.
Ï¡_šdex
() {

666  
Ok
(
£lf
.
Ï¡_‹rm
);

668 
Ët
 
	g’Œ›s
 = 
£lf
.
’Œ›s
(
idx
, idx + 1, 
¿á
::
NO_LIMIT
)?;

669 
Ok
(
’Œ›s
[0].
g‘_‹rm
())

672 #[
šlše
]

673 
pub
 
â
 
fœ¡_šdex
(&
£lf
è-> 
	gu64
 {

674 
fœ¡_šdex
(&
£lf
.
­¶y_¡©e
)

677 #[
šlše
]

678 
pub
 
â
 
Ï¡_šdex
(&
£lf
è-> 
	gu64
 {

679 
Ï¡_šdex
(&
£lf
.
¿á_¡©e
)

682 #[
šlše
]

683 
pub
 
â
 
­¶›d_šdex
(&
£lf
è-> 
	gu64
 {

684 
	g£lf
.
	g­¶y_¡©e
.
g‘_­¶›d_šdex
()

687 #[
šlše
]

688 
pub
 
â
 
comm™‹d_šdex
(&
£lf
è-> 
	gu64
 {

689 
	g£lf
.
	g¿á_¡©e
.
g‘_h¬d_¡©e
().
g‘_comm™
()

692 #[
šlše
]

693 
pub
 
â
 
Œunÿ‹d_šdex
(&
£lf
è-> 
	gu64
 {

694 
	g£lf
.
	g­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_šdex
()

697 #[
šlše
]

698 
pub
 
â
 
Œunÿ‹d_‹rm
(&
£lf
è-> 
	gu64
 {

699 
	g£lf
.
	g­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_‹rm
()

702 
pub
 
â
 
g‘_»giÚ
(&
£lf
è-> &
	gm‘­b
::
RegiÚ
 {

703 &
£lf
.
»giÚ


706 
pub
 
â
 
¿w_¢­shÙ
(&
£lf
è-> 
DbSÇpshÙ
 {

707 
DbSÇpshÙ
::
Ãw
(
£lf
.
kv_’gše
.
şÚe
())

710 
â
 
v®id©e_¢­
(&
£lf
, 
¢­
: &
SÇpshÙ
è-> 
boŞ
 {

711 
Ët
 
idx
 = 
¢­
.
g‘_m‘ad©a
().
g‘_šdex
();

712 
	gidx
 < 
	g£lf
.
Œunÿ‹d_šdex
() {

714 
	gšfo
!(

716 
	g£lf
.
	gg
,

717 
	gidx
,

718 
	g£lf
.
Œunÿ‹d_šdex
()

720 
	gSTORE_SNAPSHOT_VALIDATION_FAILURE_COUNTER


721 .
w™h_Ïb–_v®ues
(&["stale"])

722 .
šc
();

723  
	gçl£
;

726 
Ët
 
mut
 
	g¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

727 
Ët
 
E¼
(
e
èğ
¢­_d©a
.
m”ge_äom_by‹s
(
¢­
.
g‘_d©a
()) {

728 
”rÜ
!(

730 
£lf
.
g
,

731 
e


733 
	gSTORE_SNAPSHOT_VALIDATION_FAILURE_COUNTER


734 .
w™h_Ïb–_v®ues
(&["decode"])

735 .
šc
();

736  
	gçl£
;

738 
Ët
 
	g¢­_•och
 = 
¢­_d©a
.
g‘_»giÚ
().
g‘_»giÚ_•och
();

739 
Ët
 
	gÏ‹¡_•och
 = 
£lf
.
g‘_»giÚ
().
g‘_»giÚ_•och
();

740 
	g¢­_•och
.
g‘_cÚf_v”
(è< 
	gÏ‹¡_•och
.get_conf_ver() {

741 
	gšfo
!(

743 
	g£lf
.
	gg
,

744 
	g¢­_•och
,

745 
	gÏ‹¡_•och


747 
	gSTORE_SNAPSHOT_VALIDATION_FAILURE_COUNTER


748 .
w™h_Ïb–_v®ues
(&["epoch"])

749 .
šc
();

750  
	gçl£
;

753 
	gŒue


756 
pub
 
â
 
¢­shÙ
(&
£lf
è-> 
	g¿á
::
ResuÉ
<
SÇpshÙ
> {

757 
Ët
 
mut
 
¢­_¡©e
 = 
£lf
.¢­_¡©e.
bÜrow_mut
();

758 
Ët
 
mut
 
	gŒ›d_út
 = 
£lf
.
¢­_Œ›d_út
.
bÜrow_mut
();

760 
Ët
 (
mut
 
Œ›d
, muˆ
¢­
èğ(
çl£
, 
	gNÚe
);

761 
Ët
 
	gSÇpS‹
::
G’”©šg
(
»f
 
»cv
èğ*
¢­_¡©e
 {

762 
Œ›d
 = 
Œue
;

763 
m©ch
 
	g»cv
.
Œy_»cv
() {

764 
E¼
(
TryRecvE¼Ü
::
DiscÚÃùed
) => {}

765 
E¼
(
TryRecvE¼Ü
::
Em±y
) => {

766  
E¼
(
¿á
::
E¼Ü
::
StÜe
(

767 
¿á
::
StÜageE¼Ü
::
SÇpshÙTempÜ¬yUÇvaabË
,

770 
Ok
(
s
è=> 
¢­
 = 
Some
(s),

774 
	gŒ›d
 {

775 *
	g¢­_¡©e
 = 
SÇpS‹
::
R–ax
;

776 
m©ch
 
	g¢­
 {

777 
Some
(
s
) => {

778 *
Œ›d_út
 = 0;

779 
	g£lf
.
v®id©e_¢­
(&
s
) {

780  
Ok
(
s
);

783 
	gNÚe
 => {

784 
w¬n
!(

786 
£lf
.
g
,

787 *
Œ›d_út


793 
	gSÇpS‹
::
R–ax
 !ğ*
¢­_¡©e
 {

794 
·nic
!("{} uÃx³ùed s‹: {:?}", 
£lf
.
g
, *
¢­_¡©e
);

797 *
	gŒ›d_út
 >ğ
MAX_SNAP_TRY_CNT
 {

798 
Ët
 
út
 = *
Œ›d_út
;

799 *
	gŒ›d_út
 = 0;

800  
E¼
(
¿á
::
E¼Ü
::
StÜe
(

801 
box_”r
!("çedØg‘ sÇpshÙ‡á” {}imes", 
út
),

805 
	gšfo
!("{}„eque¡šg sÇpshÙ...", 
	g£lf
.
	gg
);

806 *
	gŒ›d_út
 += 1;

807 
Ët
 (
tx
, 
rx
èğ
mpsc
::
sync_chªÃl
(1);

808 *
	g¢­_¡©e
 = 
SÇpS‹
::
G’”©šg
(
rx
);

810 
Ët
 
	gsk
 = 
RegiÚTask
::
G’
 {

811 
»giÚ_id
: 
£lf
.
g‘_»giÚ_id
(),

812 
nÙif›r
: 
tx
,

814 
Ët
 
E¼
(
e
èğ
£lf
.
»giÚ_sched
.
scheduË
(
sk
) {

815 
”rÜ
!(

817 
£lf
.
g
,

818 
e


822 
E¼
(
¿á
::
E¼Ü
::
StÜe
(

823 
¿á
::
StÜageE¼Ü
::
SÇpshÙTempÜ¬yUÇvaabË
,

830 
pub
 
â
 
	g­³nd
<
	gT
>(

831 &
mut
 
	g£lf
,

832 
	gšvoke_ùx
: &
mut
 
InvokeCÚ‹xt
,

833 
	g’Œ›s
: &[
EÁry
],

834 
	g»ady_ùx
: &
mut
 
R—dyCÚ‹xt
<
T
>,

835 è-> 
	gResuÉ
<
	gu64
> {

836 
	gdebug
!("{}‡µ’d {}ƒÁr›s", 
	g£lf
.
	gg
, 
	g’Œ›s
.
Ën
());

837 
Ët
 
	g´ev_Ï¡_šdex
 = 
švoke_ùx
.
¿á_¡©e
.
g‘_Ï¡_šdex
();

838 
	g’Œ›s
.
is_em±y
() {

839  
Ok
(
´ev_Ï¡_šdex
);

842 
Ët
 (
Ï¡_šdex
, 
Ï¡_‹rm
) = {

843 
Ët
 
e
 = 
’Œ›s
.
Ï¡
().
unw¿p
();

844 (
	ge
.
g‘_šdex
(),ƒ.
g‘_‹rm
())

847 
’Œy
 
š
 
	g’Œ›s
 {

848 
	g’Œy
.
g‘_sync_log
() {

849 
	g»ady_ùx
.
	gsync_log
 = 
Œue
;

851 
	g»ady_ùx
.
	g¿á_wb
.
put_msg
(

852 &
keys
::
¿á_log_key
(
£lf
.
g‘_»giÚ_id
(), 
’Œy
.
g‘_šdex
()),

853 
’Œy
,

858 
i
 
š
 (
Ï¡_šdex
 + 1)..(
	g´ev_Ï¡_šdex
 + 1) {

859 
	g»ady_ùx


860 .
	g¿á_wb


861 .
d–‘e
(&
keys
::
¿á_log_key
(
£lf
.
g‘_»giÚ_id
(), 
i
))?;

864 
	gšvoke_ùx
.
	g¿á_¡©e
.
£t_Ï¡_šdex
(
Ï¡_šdex
);

865 
	gšvoke_ùx
.
	gÏ¡_‹rm
 = 
Ï¡_‹rm
;

868 
	g£lf
.
	gÿche
.
­³nd
(&
£lf
.
g
, 
’Œ›s
);

869 
Ok
(
Ï¡_šdex
)

872 
pub
 
â
 
com·ù_to
(&
mut
 
£lf
, 
idx
: 
u64
) {

873 
£lf
.
ÿche
.
com·ù_to
(
idx
);

877 
pub
 
â
 
­¶y_¢­shÙ
(

878 &
mut
 
£lf
,

879 
ùx
: &
mut
 
InvokeCÚ‹xt
,

880 
¢­
: &
SÇpshÙ
,

881 
kv_wb
: &
Wr™eB©ch
,

882 
¿á_wb
: &
Wr™eB©ch
,

883 è-> 
	gResuÉ
<()> {

884 
	gšfo
!("{} begšØ­¶y sÇpshÙ", 
	g£lf
.
	gg
);

886 
Ët
 
mut
 
	g¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

887 
	g¢­_d©a
.
m”ge_äom_by‹s
(
¢­
.
g‘_d©a
())?;

889 
Ët
 
	g»giÚ_id
 = 
£lf
.
g‘_»giÚ_id
();

891 
Ët
 
	g»giÚ
 = 
¢­_d©a
.
ke_»giÚ
();

892 
	g»giÚ
.
g‘_id
(è!ğ
»giÚ_id
 {

893  
E¼
(
box_”r
!(

895 
»giÚ_id
,

896 
»giÚ
.
g‘_id
()

900 
	g£lf
.
is_š™Ÿlized
() {

902 
	g£lf
.
ş—r_m‘a
(
kv_wb
, 
¿á_wb
)?;

905 
wr™e_³”_¡©e
(&
£lf
.
kv_’gše
, 
kv_wb
, &
»giÚ
, 
P“rS‹
::
Aµlyšg
)?;

907 
Ët
 
	gÏ¡_šdex
 = 
¢­
.
g‘_m‘ad©a
().
g‘_šdex
();

909 
	gùx
.
	g¿á_¡©e
.
£t_Ï¡_šdex
(
Ï¡_šdex
);

910 
	gùx
.
	gÏ¡_‹rm
 = 
¢­
.
g‘_m‘ad©a
().
g‘_‹rm
();

911 
	gùx
.
	g­¶y_¡©e
.
£t_­¶›d_šdex
(
Ï¡_šdex
);

915 
	gùx
.
	g­¶y_¡©e
.
mut_Œunÿ‹d_¡©e
().
£t_šdex
(
Ï¡_šdex
);

916 
	gùx
.
	g­¶y_¡©e


917 .
mut_Œunÿ‹d_¡©e
()

918 .
£t_‹rm
(
¢­
.
g‘_m‘ad©a
().
g‘_‹rm
());

920 
	gšfo
!(

922 
	g£lf
.
	gg
,

923 
	g»giÚ
,

924 
	gùx
.
	g­¶y_¡©e


927 
	gùx
.
	g¢­_»giÚ
 = 
Some
(
»giÚ
);

928 
Ok
(())

932 
pub
 
â
 
ş—r_m‘a
(&
mut
 
£lf
, 
kv_wb
: &
Wr™eB©ch
, 
¿á_wb
: &Wr™eB©chè-> 
ResuÉ
<()> {

933 
Ët
 
»giÚ_id
 = 
£lf
.
g‘_»giÚ_id
();

934 
ş—r_m‘a
(

935 &
£lf
.
kv_’gše
,

936 &
£lf
.
¿á_’gše
,

937 
kv_wb
,

938 
¿á_wb
,

939 
»giÚ_id
,

940 &
£lf
.
¿á_¡©e
,

942 
	g£lf
.
	gÿche
 = 
EÁryCache
::();

943 
Ok
(())

948 
pub
 
â
 
ş—r_d©a
(&
£lf
è-> 
	gResuÉ
<()> {

949 
Ët
 (
¡¬t_key
, 
’d_key
) = (

950 
’c_¡¬t_key
(
£lf
.
g‘_»giÚ
()),

951 
’c_’d_key
(
£lf
.
g‘_»giÚ
()),

953 
Ët
 
	g»giÚ_id
 = 
£lf
.
g‘_»giÚ_id
();

954 
	gbox_Œy
!(

955 
	g£lf
.
	g»giÚ_sched


956 .
scheduË
(
RegiÚTask
::
de¡roy
(
»giÚ_id
, 
¡¬t_key
, 
’d_key
))

958 
Ok
(())

962 
â
 
ş—r_exŒa_d©a
(&
£lf
, 
Ãw_»giÚ
: &
m‘­b
::
RegiÚ
è-> 
ResuÉ
<()> {

963 
Ët
 (
Şd_¡¬t_key
, 
Şd_’d_key
) = (

964 
’c_¡¬t_key
(
£lf
.
g‘_»giÚ
()),

965 
’c_’d_key
(
£lf
.
g‘_»giÚ
()),

967 
Ët
 (
Ãw_¡¬t_key
, 
Ãw_’d_key
èğ(
’c_¡¬t_key
(
Ãw_»giÚ
), 
’c_’d_key
(new_region));

968 
Ët
 
	g»giÚ_id
 = 
Ãw_»giÚ
.
g‘_id
();

969 
	gŞd_¡¬t_key
 < 
	gÃw_¡¬t_key
 {

970 
	gbox_Œy
!(

971 
	g£lf
.
	g»giÚ_sched


972 .
scheduË
(
RegiÚTask
::
de¡roy
(
»giÚ_id
, 
Şd_¡¬t_key
, 
Ãw_¡¬t_key
))

975 
	gÃw_’d_key
 < 
	gŞd_’d_key
 {

976 
	gbox_Œy
!(

977 
	g£lf
.
	g»giÚ_sched


978 .
scheduË
(
RegiÚTask
::
de¡roy
(
»giÚ_id
, 
Ãw_’d_key
, 
Şd_’d_key
))

981 
Ok
(())

984 
pub
 
â
 
g‘_¿á_’gše
(&
£lf
è-> 
	gArc
<
	gDB
> {

985 
	g£lf
.
	g¿á_’gše
.
şÚe
()

989 #[
šlše
]

990 
pub
 
â
 
is_­¶yšg_¢­shÙ
(&
£lf
è-> 
	gboŞ
 {

991 
m©ch
 *
	g£lf
.
	g¢­_¡©e
.
bÜrow
() {

992 
	gSÇpS‹
::
Aµlyšg
(
_
è=> 
Œue
,

993 
	g_
 => 
çl£
,

998 #[
šlše
]

999 
pub
 
â
 
check_­¶yšg_¢­
(&
mut
 
£lf
è-> 
	gboŞ
 {

1000 
Ët
 
	gÃw_¡©e
 = 
m©ch
 *
£lf
.
¢­_¡©e
.
bÜrow
() {

1001 
SÇpS‹
::
Aµlyšg
(
»f
 
¡©us
) => {

1002 
Ët
 
s
 = 
¡©us
.
lßd
(
Ord”šg
::
R–axed
);

1003 
	gs
 =ğ
JOB_STATUS_FINISHED
 {

1004 
SÇpS‹
::
R–ax


1005 } 
s
 =ğ
JOB_STATUS_CANCELLED
 {

1006 
SÇpS‹
::
AµlyAbÜ‹d


1007 } 
s
 =ğ
JOB_STATUS_FAILED
 {

1009 
·nic
!("{}‡µlyšg sÇpshÙ faed", 
£lf
.
g
);

1011  
	gŒue
;

1014 
	g_
 =>  
çl£
,

1016 *
	g£lf
.
	g¢­_¡©e
.
bÜrow_mut
(èğ
Ãw_¡©e
;

1017 
	gçl£


1020 #[
šlše
]

1021 
pub
 
â
 
is_ÿnûlšg_¢­
(&
£lf
è-> 
	gboŞ
 {

1022 
m©ch
 *
	g£lf
.
	g¢­_¡©e
.
bÜrow
() {

1023 
	gSÇpS‹
::
Aµlyšg
(
»f
 
¡©us
) => {

1024 
¡©us
.
lßd
(
Ord”šg
::
R–axed
è=ğ
JOB_STATUS_CANCELLING


1026 
_
 => 
çl£
,

1031 
pub
 
â
 
ÿnûl_­¶yšg_¢­
(&
mut
 
£lf
è-> 
	gboŞ
 {

1032 
Ët
 
	gis_ÿnûÎed
 = 
m©ch
 *
£lf
.
¢­_¡©e
.
bÜrow
() {

1033 
SÇpS‹
::
Aµlyšg
(
»f
 
¡©us
) => status

1034 .
com·»_ªd_sw­
(
JOB_STATUS_PENDING
, 
JOB_STATUS_CANCELLING
, 
Ord”šg
::
SeqC¡
) ==

1035 
JOB_STATUS_PENDING


1037 
Œue


1038 } 
¡©us


1039 .
com·»_ªd_sw­
(
JOB_STATUS_RUNNING
, 
JOB_STATUS_CANCELLING
, 
Ord”šg
::
SeqC¡
) ==

1040 
JOB_STATUS_RUNNING


1042  
çl£
;

1044 
	gçl£


1046 
	g_
 =>  
çl£
,

1048 
	gis_ÿnûÎed
 {

1049 *
	g£lf
.
	g¢­_¡©e
.
bÜrow_mut
(èğ
SÇpS‹
::
AµlyAbÜ‹d
;

1050  
	gŒue
;

1054 !
	g£lf
.
check_­¶yšg_¢­
()

1057 #[
šlše
]

1058 
pub
 
â
 
£t_¢­_¡©e
(&
mut
 
£lf
, 
¡©e
: 
SÇpS‹
) {

1059 *
£lf
.
¢­_¡©e
.
bÜrow_mut
(èğ
¡©e


1062 #[
šlše
]

1063 
pub
 
â
 
is_¢­_¡©e
(&
£lf
, 
¡©e
: 
SÇpS‹
è-> 
boŞ
 {

1064 *
£lf
.
¢­_¡©e
.
bÜrow
(è=ğ
¡©e


1067 
pub
 
â
 
g‘_»giÚ_id
(&
£lf
è-> 
u64
 {

1068 
£lf
.
»giÚ
.
g‘_id
()

1071 
pub
 
â
 
scheduË_­¶yšg_¢­shÙ
(&
mut
 
£lf
) {

1072 
Ët
 
¡©us
 = 
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_PENDING
));

1073 
	g£lf
.
£t_¢­_¡©e
(
SÇpS‹
::
Aµlyšg
(
¡©us
.
şÚe
()));

1074 
Ët
 
	gsk
 = 
RegiÚTask
::
Aµly
 {

1075 
»giÚ_id
: 
£lf
.
g‘_»giÚ_id
(),

1076 
¡©us
: status,

1079 
	g£lf
.
	g»giÚ_sched


1080 .
scheduË
(
sk
)

1081 .
ex³ù
("snap‡pply job should‚ot fail");

1091 
pub
 
â
 
	ghªdË_¿á_»ady
<
	gT
>(

1092 &
mut
 
	g£lf
,

1093 
	g»ady_ùx
: &
mut
 
R—dyCÚ‹xt
<
T
>,

1094 
	g»ady
: &
R—dy
,

1095 è-> 
	gResuÉ
<
	gInvokeCÚ‹xt
> {

1096 
Ët
 
mut
 
	gùx
 = 
InvokeCÚ‹xt
::
Ãw
(
£lf
);

1097 
Ët
 
	g¢­shÙ_šdex
 = 
¿á
::
is_em±y_¢­
(&
»ady
.
¢­shÙ
) {

1100 
ç_pošt
!("raft_before_apply_snap");

1101 
	g£lf
.
­¶y_¢­shÙ
(

1102 &
mut
 
ùx
,

1103 &
»ady
.
¢­shÙ
,

1104 &
»ady_ùx
.
kv_wb
,

1105 &
»ady_ùx
.
¿á_wb
,

1107 
	gç_pošt
!("raft_after_apply_snap");

1109 
Ï¡_šdex
(&
ùx
.
¿á_¡©e
)

1112 
	g»ady
.
	gmu¡_sync
 {

1113 
	g»ady_ùx
.
	gsync_log
 = 
Œue
;

1116 !
	g»ady
.
	g’Œ›s
.
is_em±y
() {

1117 
	g£lf
.
­³nd
(&
mut
 
ùx
, &
»ady
.
’Œ›s
, 
»ady_ùx
)?;

1122 
	gùx
.
	g¿á_¡©e
.
g‘_Ï¡_šdex
() > 0 {

1123 
Ët
 
Some
(
»f
 
hs
èğ
»ady
.hs {

1124 
ùx
.
¿á_¡©e
.
£t_h¬d_¡©e
(
hs
.
şÚe
());

1128 
	gùx
.
	g¿á_¡©e
 !ğ
£lf
.
¿á_¡©e
 {

1129 
ùx
.
§ve_¿á_¡©e_to
(&
mut
 
»ady_ùx
.
¿á_wb
)?;

1130 
	g¢­shÙ_šdex
 > 0 {

1135 
	gùx
.
§ve_¢­shÙ_¿á_¡©e_to
(

1136 
¢­shÙ_šdex
,

1137 &
£lf
.
kv_’gše
,

1138 &
mut
 
»ady_ùx
.
kv_wb
,

1144 
	gùx
.
	g­¶y_¡©e
 !ğ
£lf
.
­¶y_¡©e
 {

1145 
ùx
.
§ve_­¶y_¡©e_to
(&
£lf
.
kv_’gše
, &
mut
 
»ady_ùx
.
kv_wb
)?;

1148 
Ok
(
ùx
)

1152 
pub
 
â
 
po¡_»ady
(&
mut
 
£lf
, 
ùx
: 
InvokeCÚ‹xt
è-> 
O±iÚ
<
AµlySÇpResuÉ
> {

1153 
£lf
.
¿á_¡©e
 = 
ùx
.raft_state;

1154 
	g£lf
.
	g­¶y_¡©e
 = 
ùx
.
­¶y_¡©e
;

1155 
	g£lf
.
	gÏ¡_‹rm
 = 
ùx
.
Ï¡_‹rm
;

1157 
Ët
 
	g¢­_»giÚ
 = 
m©ch
 
ùx
.
¢­_»giÚ
 {

1158 
Some
(
r
) =>„,

1159 
	gNÚe
 =>  
NÚe
,

1162 
	g£lf
.
is_š™Ÿlized
() {

1163 
Ët
 
E¼
(
e
èğ
£lf
.
ş—r_exŒa_d©a
(&£lf.
»giÚ
) {

1168 
”rÜ
!(

1170 
£lf
.
g
,

1171 
e


1176 
	g£lf
.
scheduË_­¶yšg_¢­shÙ
();

1177 
Ët
 
	g´ev_»giÚ
 = 
£lf
.
»giÚ
.
şÚe
();

1178 
	g£lf
.
	g»giÚ
 = 
¢­_»giÚ
;

1180 
Some
(
AµlySÇpResuÉ
 {

1181 
´ev_»giÚ
:…rev_region,

1182 
»giÚ
: 
£lf
.»giÚ.
şÚe
(),

1188 
pub
 
â
 
ş—r_m‘a
(

1189 
kv_’gše
: &
DB
,

1190 
¿á_’gše
: &
DB
,

1191 
kv_wb
: &
Wr™eB©ch
,

1192 
¿á_wb
: &
Wr™eB©ch
,

1193 
»giÚ_id
: 
u64
,

1194 
¿á_¡©e
: &
RaáLoÿlS‹
,

1195 è-> 
	gResuÉ
<()> {

1196 
Ët
 
	gt
 = 
In¡ªt
::
now
();

1197 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(
kv_’gše
, 
CF_RAFT
)?;

1198 
	gkv_wb
.
d–‘e_cf
(
hªdË
, &
keys
::
»giÚ_¡©e_key
(
»giÚ_id
))?;

1199 
	gkv_wb
.
d–‘e_cf
(
hªdË
, &
keys
::
­¶y_¡©e_key
(
»giÚ_id
))?;

1201 
Ët
 
	gÏ¡_šdex
 = 
Ï¡_šdex
(
¿á_¡©e
);

1202 
Ët
 
mut
 
	gfœ¡_šdex
 = 
Ï¡_šdex
 + 1;

1203 
Ët
 
	gbegš_log_key
 = 
keys
::
¿á_log_key
(
»giÚ_id
, 0);

1204 
Ët
 
	g’d_log_key
 = 
keys
::
¿á_log_key
(
»giÚ_id
, 
fœ¡_šdex
);

1205 
	g¿á_’gše
.
sÿn
(

1206 &
begš_log_key
,

1207 &
’d_log_key
,

1208 
çl£
,

1209 &
mut
 |
key
, 
_
| {

1210 
fœ¡_šdex
 = 
keys
::
¿á_log_šdex
(
key
).
unw¿p
();

1211 
Ok
(
çl£
)

1214 
id
 
š
 
	gfœ¡_šdex
..
	gÏ¡_šdex
 + 1 {

1215 
	g¿á_wb
.
d–‘e
(&
keys
::
¿á_log_key
(
»giÚ_id
, 
id
))?;

1217 
	g¿á_wb
.
d–‘e
(&
keys
::
¿á_¡©e_key
(
»giÚ_id
))?;

1219 
	gšfo
!(

1221 
	g»giÚ_id
,

1222 
	gÏ¡_šdex
 + 1 - 
	gfœ¡_šdex
,

1223 
	gt
.
–­£d
()

1225 
Ok
(())

1228 
pub
 
â
 
do_¢­shÙ
(

1229 
mgr
: 
SÇpMªag”
,

1230 
¿á_db
: &
DB
,

1231 
¢­
: &
DbSÇpshÙ
,

1232 
»giÚ_id
: 
u64
,

1233 è-> 
	g¿á
::
ResuÉ
<
SÇpshÙ
> {

1234 
debug
!("[»giÚ {}] begšØg’”©¨¢­shÙ", 
	g»giÚ_id
);

1236 
Ët
 
	g­¶y_¡©e
: 
RaáAµlyS‹
 =

1237 
m©ch
 
¢­
.
g‘_msg_cf
(
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(
»giÚ_id
))? {

1238 
NÚe
 => {

1239  
E¼
(
box_”r
!(

1241 
»giÚ_id


1244 
Some
(
¡©e
) => state,

1247 
Ët
 
	gidx
 = 
­¶y_¡©e
.
g‘_­¶›d_šdex
();

1248 
Ët
 
	g‹rm
 = 
idx
 =ğ
­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_šdex
() {

1249 
­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_‹rm
()

1251 
m©ch
 
¿á_db


1252 .
g‘_msg
::<
EÁry
>(&
keys
::
¿á_log_key
(
»giÚ_id
, 
idx
))?

1254 
NÚe
 =>  
E¼
(
box_”r
!("’Œy {} oà{}‚Ù found.", 
idx
, 
»giÚ_id
)),

1255 
Some
(
’Œy
è=>ƒÁry.
g‘_‹rm
(),

1259 
Ët
 
	gkey
 = 
SÇpKey
::
Ãw
(
»giÚ_id
, 
‹rm
, 
idx
);

1261 
	gmgr
.(
	gkey
.
şÚe
(), 
	gSÇpEÁry
::
G’”©šg
);

1262 
	gdeãr
!(
	gmgr
.
d”egi¡”
(&
key
, &
SÇpEÁry
::
G’”©šg
));

1264 
Ët
 
	g¡©e
: 
RegiÚLoÿlS‹
 = 
¢­
.
g‘_msg_cf
(
CF_RAFT
, &
keys
::
»giÚ_¡©e_key
(
key
.
»giÚ_id
))

1265 .
ªd_th’
(|
»s
| 
m©ch
„es {

1266 
NÚe
 => 
E¼
(
box_”r
!("could‚ot find„egion info")),

1267 
Some
(
¡©e
è=> 
Ok
(state),

1270 
	g¡©e
.
g‘_¡©e
(è!ğ
P“rS‹
::
NÜm®
 {

1271  
E¼
(
box_”r
!("¢­ job fÜ {} s“m ¡®e, sk.", 
»giÚ_id
));

1274 
Ët
 
mut
 
	g¢­shÙ
 = 
SÇpshÙ
::
Ãw
();

1277 
	g¢­shÙ
.
mut_m‘ad©a
().
£t_šdex
(
key
.
idx
);

1278 
	g¢­shÙ
.
mut_m‘ad©a
().
£t_‹rm
(
key
.
‹rm
);

1280 
Ët
 
mut
 
	gcÚf_¡©e
 = 
CÚfS‹
::
Ãw
();

1281 
p
 
š
 
	g¡©e
.
g‘_»giÚ
().
g‘_³”s
() {

1282 
	gcÚf_¡©e
.
mut_nodes
().
push
(
p
.
g‘_id
());

1285 
	g¢­shÙ
.
mut_m‘ad©a
().
£t_cÚf_¡©e
(
cÚf_¡©e
);

1287 
Ët
 
mut
 
	gs
 = 
mgr
.
g‘_¢­shÙ_fÜ_budšg
(&
key
, 
¢­
)?;

1289 
Ët
 
mut
 
	g¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

1290 
	g¢­_d©a
.
£t_»giÚ
(
¡©e
.
g‘_»giÚ
().
şÚe
());

1291 
Ët
 
mut
 
	g¡©
 = 
SÇpshÙSti¡ics
::
Ãw
();

1292 
	gs
.
bud
(

1293 
¢­
,

1294 
¡©e
.
g‘_»giÚ
(),

1295 &
mut
 
¢­_d©a
,

1296 &
mut
 
¡©
,

1297 
Box
::
Ãw
(
mgr
.
şÚe
()),

1299 
Ët
 
mut
 
	gv
 = 
vec
![];

1300 
	gbox_Œy
!(
	g¢­_d©a
.
wr™e_to_vec
(&
mut
 
v
));

1301 
	g¢­shÙ
.
£t_d©a
(
v
);

1303 
	gSNAPSHOT_KV_COUNT_HISTOGRAM
.
ob£rve
(
¡©
.
kv_couÁ
 
as
 
f64
);

1304 
	gSNAPSHOT_SIZE_HISTOGRAM
.
ob£rve
(
¡©
.
size
 
as
 
f64
);

1306 
Ok
(
¢­shÙ
)

1310 
pub
 
â
 
	gwr™e_š™Ÿl_¿á_¡©e
<
	gT
: 
MubË
>(
¿á_wb
: &
T
, 
	g»giÚ_id
: 
u64
è-> 
ResuÉ
<()> {

1311 
Ët
 
mut
 
¿á_¡©e
 = 
RaáLoÿlS‹
::
Ãw
();

1312 
	g¿á_¡©e
.
£t_Ï¡_šdex
(
RAFT_INIT_LOG_INDEX
);

1313 
	g¿á_¡©e
.
mut_h¬d_¡©e
().
£t_‹rm
(
RAFT_INIT_LOG_TERM
);

1314 
	g¿á_¡©e
.
mut_h¬d_¡©e
().
£t_comm™
(
RAFT_INIT_LOG_INDEX
);

1316 
	g¿á_wb


1317 .
put_msg
(&
keys
::
¿á_¡©e_key
(
»giÚ_id
), &
¿á_¡©e
)?;

1318 
Ok
(())

1323 
pub
 
â
 
	gwr™e_š™Ÿl_­¶y_¡©e
<
	gT
: 
MubË
>(

1324 
kv_’gše
: &
DB
,

1325 
	gkv_wb
: &
T
,

1326 
	g»giÚ_id
: 
u64
,

1327 è-> 
	gResuÉ
<()> {

1328 
Ët
 
mut
 
	g­¶y_¡©e
 = 
RaáAµlyS‹
::
Ãw
();

1329 
	g­¶y_¡©e
.
£t_­¶›d_šdex
(
RAFT_INIT_LOG_INDEX
);

1330 
	g­¶y_¡©e


1331 .
mut_Œunÿ‹d_¡©e
()

1332 .
£t_šdex
(
RAFT_INIT_LOG_INDEX
);

1333 
	g­¶y_¡©e


1334 .
mut_Œunÿ‹d_¡©e
()

1335 .
£t_‹rm
(
RAFT_INIT_LOG_TERM
);

1337 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(
kv_’gše
, 
CF_RAFT
)?;

1338 
	gkv_wb


1339 .
put_msg_cf
(
hªdË
, &
keys
::
­¶y_¡©e_key
(
»giÚ_id
), &
­¶y_¡©e
)?;

1340 
Ok
(())

1343 
pub
 
â
 
	gwr™e_³”_¡©e
<
	gT
: 
MubË
>(

1344 
kv_’gše
: &
DB
,

1345 
	gkv_wb
: &
T
,

1346 
	g»giÚ
: &
m‘­b
::
RegiÚ
,

1347 
	g¡©e
: 
P“rS‹
,

1348 è-> 
	gResuÉ
<()> {

1349 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

1350 
Ët
 
mut
 
	g»giÚ_¡©e
 = 
RegiÚLoÿlS‹
::
Ãw
();

1351 
	g»giÚ_¡©e
.
£t_¡©e
(
¡©e
);

1352 
	g»giÚ_¡©e
.
£t_»giÚ
(
»giÚ
.
şÚe
());

1353 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(
kv_’gše
, 
CF_RAFT
)?;

1354 
	gkv_wb


1355 .
put_msg_cf
(
hªdË
, &
keys
::
»giÚ_¡©e_key
(
»giÚ_id
), &
»giÚ_¡©e
)?;

1356 
Ok
(())

1359 
im¶
 
StÜage
 
	gP“rStÜage
 {

1360 
â
 
š™Ÿl_¡©e
(&
£lf
è-> 
	g¿á
::
ResuÉ
<
RaáS‹
> {

1361 
£lf
.
š™Ÿl_¡©e
()

1364 
â
 
’Œ›s
(&
£lf
, 
low
: 
u64
, 
high
: u64, 
max_size
: u64è-> 
¿á
::
ResuÉ
<
Vec
<
EÁry
>> {

1365 
£lf
.
’Œ›s
(
low
, 
high
, 
max_size
)

1368 
â
 
‹rm
(&
£lf
, 
idx
: 
u64
è-> 
¿á
::
ResuÉ
<u64> {

1369 
£lf
.
‹rm
(
idx
)

1372 
â
 
fœ¡_šdex
(&
£lf
è-> 
¿á
::
ResuÉ
<
u64
> {

1373 
Ok
(
£lf
.
fœ¡_šdex
())

1376 
â
 
Ï¡_šdex
(&
£lf
è-> 
¿á
::
ResuÉ
<
u64
> {

1377 
Ok
(
£lf
.
Ï¡_šdex
())

1380 
â
 
¢­shÙ
(&
£lf
è-> 
¿á
::
ResuÉ
<
SÇpshÙ
> {

1381 
£lf
.
¢­shÙ
()

1385 #[
cfg
(
‹¡
)]

1386 
mod
 
‹¡
 {

1387 
u£
 
¡d
::
sync
::*;

1388 
u£
 
	g¡d
::
sync
::
©omic
::*;

1389 
u£
 
	g¡d
::
sync
::
mpsc
::*;

1390 
u£
 
	g¡d
::
rc
::
Rc
;

1391 
u£
 
	g¡d
::
ûÎ
::
RefC–l
;

1392 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

1393 
u£
 
	g¡d
::
·th
::
P©h
;

1394 
u£
 
	gkv´Ùo
::
”aápb
::{
CÚfS‹
, 
	gEÁry
};

1395 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáSÇpshÙD©a
;

1396 
u£
 
	g¿á
::{
E¼Ü
 
as
 
RaáE¼Ü
, 
	gStÜageE¼Ü
};

1397 
u£
 
	g‹mpdœ
::*;

1398 
u£
 
	g´Ùobuf
;

1399 
u£
 
	g¿á¡Üe
::
¡Üe
::{
boÙ¡¿p
, 
	gEngšes
};

1400 
u£
 
	g¿á¡Üe
::
¡Üe
::
wÜk”
::
RegiÚRuÂ”
;

1401 
u£
 
	g¿á¡Üe
::
¡Üe
::
wÜk”
::
RegiÚTask
;

1402 
u£
 
	g¿á¡Üe
::
¡Üe
::
loÿl_m‘rics
::
RaáM‘rics
;

1403 
u£
 
	gut
::
wÜk”
::{
ScheduËr
, 
	gWÜk”
};

1404 
u£
 
	gut
::
rocksdb
::
Ãw_’gše
;

1405 
u£
 
	g¡Üage
::{
ALL_CFS
, 
	gCF_DEFAULT
};

1406 
u£
 
	gkv´Ùo
::
”aápb
::
H¬dS‹
;

1407 
u£
 
	grocksdb
::
Wr™eB©ch
;

1409 
u£
 
	gsu³r
::*;

1411 
â
 
Ãw_¡Üage
(
sched
: 
ScheduËr
<
RegiÚTask
>, 
·th
: &
TempDœ
è-> 
P“rStÜage
 {

1412 
Ët
 
kv_db
 = 
Arc
::
Ãw
(
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), 
ALL_CFS
).unwrap());

1413 
Ët
 
	g¿á_·th
 = 
·th
.·th().
još
(
P©h
::
Ãw
("raft"));

1414 
Ët
 
	g¿á_db
 = 
Arc
::
Ãw
(

1415 
Ãw_’gše
(
¿á_·th
.
to_¡r
().
unw¿p
(), &[
CF_DEFAULT
]).unwrap(),

1417 
Ët
 
	g’gšes
 = 
Engšes
::
Ãw
(
kv_db
.
şÚe
(), 
¿á_db
.clone());

1418 
	gboÙ¡¿p
::
boÙ¡¿p_¡Üe
(&
’gšes
, 1, 1).
ex³ù
("");

1419 
Ët
 
	g»giÚ
 = 
boÙ¡¿p
::
´•¬e_boÙ¡¿p
(&
’gšes
, 1, 1, 1).
ex³ù
("");

1420 
Ët
 
	gm‘rics
 = 
Rc
::
Ãw
(
RefC–l
::Ãw(
CacheQu”ySts
::()));

1421 
	gP“rStÜage
::
Ãw
(
kv_db
, 
¿á_db
, &
»giÚ
, 
sched
, "".
to_owÃd
(), 
m‘rics
).
unw¿p
()

1424 
â
 
Ãw_¡Üage_äom_’ts
(

1425 
sched
: 
ScheduËr
<
RegiÚTask
>,

1426 
·th
: &
TempDœ
,

1427 
’ts
: &[
EÁry
],

1428 è-> 
	gP“rStÜage
 {

1429 
Ët
 
mut
 
	g¡Üe
 = 
Ãw_¡Üage
(
sched
, 
·th
);

1430 
Ët
 
mut
 
	gkv_wb
 = 
Wr™eB©ch
::
Ãw
();

1431 
Ët
 
mut
 
	gùx
 = 
InvokeCÚ‹xt
::
Ãw
(&
¡Üe
);

1432 
Ët
 
mut
 
	gm‘rics
 = 
RaáM‘rics
::();

1433 
Ët
 
	gŒªs
 = 0;

1434 
Ët
 
mut
 
	g»ady_ùx
 = 
R—dyCÚ‹xt
::
Ãw
(&muˆ
m‘rics
, &
Œªs
, 
’ts
.
Ën
());

1435 
	g¡Üe


1436 .
­³nd
(&
mut
 
ùx
, &
’ts
[1..], &muˆ
»ady_ùx
)

1437 .
ex³ù
("");

1438 
	gùx
.
	g­¶y_¡©e


1439 .
mut_Œunÿ‹d_¡©e
()

1440 .
£t_šdex
(
’ts
[0].
g‘_šdex
());

1441 
	gùx
.
	g­¶y_¡©e


1442 .
mut_Œunÿ‹d_¡©e
()

1443 .
£t_‹rm
(
’ts
[0].
g‘_‹rm
());

1444 
	gùx
.
	g­¶y_¡©e


1445 .
£t_­¶›d_šdex
(
’ts
.
Ï¡
().
unw¿p
().
g‘_šdex
());

1446 
	gùx
.
§ve_­¶y_¡©e_to
(&
¡Üe
.
kv_’gše
, &
mut
 
kv_wb
)

1447 .
unw¿p
();

1448 
	g¡Üe
.
	g¿á_’gše
.
wr™e
(
»ady_ùx
.
¿á_wb
).
ex³ù
("");

1449 
	g¡Üe
.
	gkv_’gše
.
wr™e
(
kv_wb
).
ex³ù
("");

1450 
	g¡Üe
.
	g¿á_¡©e
 = 
ùx
.
¿á_¡©e
;

1451 
	g¡Üe
.
	g­¶y_¡©e
 = 
ùx
.
­¶y_¡©e
;

1452 
	g¡Üe


1455 
â
 
­³nd_’ts
(
¡Üe
: &
mut
 
P“rStÜage
, 
’ts
: &[
EÁry
]) {

1456 
Ët
 
mut
 
ùx
 = 
InvokeCÚ‹xt
::
Ãw
(
¡Üe
);

1457 
Ët
 
mut
 
	gm‘rics
 = 
RaáM‘rics
::();

1458 
Ët
 
	gŒªs
 = 0;

1459 
Ët
 
mut
 
	g»ady_ùx
 = 
R—dyCÚ‹xt
::
Ãw
(&muˆ
m‘rics
, &
Œªs
, 
’ts
.
Ën
());

1460 
	g¡Üe
.
­³nd
(&
mut
 
ùx
, 
’ts
, &muˆ
»ady_ùx
).
unw¿p
();

1461 
	gùx
.
§ve_¿á_¡©e_to
(&
mut
 
»ady_ùx
.
¿á_wb
).
unw¿p
();

1462 
	g¡Üe
.
	g¿á_’gše
.
wr™e
(
»ady_ùx
.
¿á_wb
).
ex³ù
("");

1463 
	g¡Üe
.
	g¿á_¡©e
 = 
ùx
.
¿á_¡©e
;

1466 
â
 
v®id©e_ÿche
(
¡Üe
: &
P“rStÜage
, 
exp_’ts
: &[
EÁry
]) {

1467 
as£¹_eq
!(
¡Üe
.
ÿche
.ÿche, 
	gexp_’ts
);

1468 
e
 
š
 
	gexp_’ts
 {

1469 
Ët
 
	gkey
 = 
keys
::
¿á_log_key
(
¡Üe
.
g‘_»giÚ_id
(), 
e
.
g‘_šdex
());

1470 
Ët
 
	gby‹s
 = 
¡Üe
.
¿á_’gše
.
g‘
(&
key
).
unw¿p
().unwrap();

1471 
Ët
 
mut
 
	g’Œy
 = 
EÁry
::
Ãw
();

1472 
	g’Œy
.
m”ge_äom_by‹s
(&
by‹s
).
unw¿p
();

1473 
	gas£¹_eq
!(
	g’Œy
, *
	ge
);

1477 
â
 
Ãw_’Œy
(
šdex
: 
u64
, 
‹rm
: u64è-> 
EÁry
 {

1478 
Ët
 
mut
 
e
 = 
EÁry
::
Ãw
();

1479 
	ge
.
£t_šdex
(
šdex
);

1480 
	ge
.
£t_‹rm
(
‹rm
);

1481 
	ge


1484 
â
 
	gsize_of
<
	gT
: 
´Ùobuf
::
Mes§ge
>(
m
: &
T
è-> 
u32
 {

1485 
m
.
compu‹_size
()

1488 #[
‹¡
]

1489 
â
 
‹¡_¡Üage_‹rm
() {

1490 
Ët
 
’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

1492 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

1493 (2, 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
))),

1494 (3, 
Ok
(3)),

1495 (4, 
Ok
(4)),

1496 (5, 
Ok
(5)),

1498 
	gi
, (
	gidx
, 
	gw‹rm
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

1499 
Ët
 
	gtd
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

1500 
Ët
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

1501 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

1502 
Ët
 
	g¡Üe
 = 
Ãw_¡Üage_äom_’ts
(
sched
, &
td
, &
’ts
);

1503 
Ët
 
	gt
 = 
¡Üe
.
‹rm
(
idx
);

1504 
	gw‹rm
 !ğ
t
 {

1505 
·nic
!("#{}:ƒx³ù„e {:?}, gÙ {:?}", 
i
, 
w‹rm
, 
t
);

1510 
â
 
g‘_m‘a_key_couÁ
(
¡Üe
: &
P“rStÜage
è-> 
usize
 {

1511 
Ët
 
»giÚ_id
 = 
¡Üe
.
g‘_»giÚ_id
();

1512 
Ët
 
mut
 
	gcouÁ
 = 0;

1513 
Ët
 (
m‘a_¡¬t
, 
m‘a_’d
) = (

1514 
keys
::
»giÚ_m‘a_´efix
(
»giÚ_id
),

1515 
	gkeys
::
»giÚ_m‘a_´efix
(
»giÚ_id
 + 1),

1517 
	g¡Üe


1518 .
	gkv_’gše


1519 .
sÿn_cf
(
CF_RAFT
, &
m‘a_¡¬t
, &
m‘a_’d
, 
çl£
, &
mut
 |
_
, _| {

1520 
couÁ
 += 1;

1521 
Ok
(
Œue
)

1523 .
unw¿p
();

1525 
Ët
 (
¿á_¡¬t
, 
¿á_’d
) = (

1526 
keys
::
»giÚ_¿á_´efix
(
»giÚ_id
),

1527 
	gkeys
::
»giÚ_¿á_´efix
(
»giÚ_id
 + 1),

1529 
	g¡Üe


1530 .
	gkv_’gše


1531 .
sÿn_cf
(
CF_RAFT
, &
¿á_¡¬t
, &
¿á_’d
, 
çl£
, &
mut
 |
_
, _| {

1532 
couÁ
 += 1;

1533 
Ok
(
Œue
)

1535 .
unw¿p
();

1537 
	g¡Üe


1538 .
	g¿á_’gše


1539 .
sÿn
(&
¿á_¡¬t
, &
¿á_’d
, 
çl£
, &
mut
 |
_
, _| {

1540 
couÁ
 += 1;

1541 
Ok
(
Œue
)

1543 .
unw¿p
();

1545 
	gcouÁ


1548 #[
‹¡
]

1549 
â
 
‹¡_¡Üage_ş—r_m‘a
() {

1550 
Ët
 
	gtd
 = 
TempDœ
::
Ãw
("tikv-¡Üe").
unw¿p
();

1551 
Ët
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

1552 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

1553 
Ët
 
mut
 
	g¡Üe
 = 
Ãw_¡Üage_äom_’ts
(
sched
, &
td
, &[
Ãw_’Œy
(3, 3),‚ew_entry(4, 4)]);

1554 
­³nd_’ts
(&
mut
 
¡Üe
, &[
Ãw_’Œy
(5, 5),‚ew_entry(6, 6)]);

1556 
	gas£¹_eq
!(6, 
g‘_m‘a_key_couÁ
(&
¡Üe
));

1558 
Ët
 
	gkv_wb
 = 
Wr™eB©ch
::
Ãw
();

1559 
Ët
 
	g¿á_wb
 = 
Wr™eB©ch
::
Ãw
();

1560 
	g¡Üe
.
ş—r_m‘a
(&
kv_wb
, &
¿á_wb
).
unw¿p
();

1561 
	g¡Üe
.
	gkv_’gše
.
wr™e
(
kv_wb
).
unw¿p
();

1562 
	g¡Üe
.
	g¿á_’gše
.
wr™e
(
¿á_wb
).
unw¿p
();

1564 
	gas£¹_eq
!(0, 
g‘_m‘a_key_couÁ
(&
¡Üe
));

1567 #[
‹¡
]

1568 
â
 
‹¡_¡Üage_’Œ›s
() {

1569 
Ët
 
	g’ts
 = 
vec
![

1570 
Ãw_’Œy
(3, 3),

1571 
Ãw_’Œy
(4, 4),

1572 
Ãw_’Œy
(5, 5),

1573 
Ãw_’Œy
(6, 6),

1575 
Ët
 
	gmax_u64
 = 
u64
::
max_v®ue
();

1576 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

1580 
max_u64
,

1581 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
)),

1586 
max_u64
,

1587 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
)),

1589 (4, 5, 
max_u64
, 
Ok
(
vec
![
Ãw_’Œy
(4, 4)])),

1590 (4, 6, 
	gmax_u64
, 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5)])),

1594 
	gmax_u64
,

1595 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5),‚ew_entry(6, 6)]),

1598 (4, 7, 0, 
Ok
(
vec
![
Ãw_’Œy
(4, 4)])),

1603 (
size_of
(&
’ts
[1]è+ size_of(&’ts[2])è
as
 
	gu64
,

1604 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5)]),

1609 (
size_of
(&
’ts
[1]è+ size_of(&’ts[2]è+ size_of(&’ts[3]è/ 2è
as
 
	gu64
,

1610 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5)]),

1615 (
size_of
(&
’ts
[1]è+ size_of(&’ts[2]è+ size_of(&’ts[3]è- 1è
as
 
	gu64
,

1616 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5)]),

1622 (
size_of
(&
’ts
[1]è+ size_of(&’ts[2]è+ size_of(&’ts[3])è
as
 
	gu64
,

1623 
Ok
(
vec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5),‚ew_entry(6, 6)]),

1627 
	gi
, (
	glo
, 
	ghi
, 
	gmaxsize
, 
	gw’Œ›s
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

1628 
Ët
 
	gtd
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

1629 
Ët
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

1630 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

1631 
Ët
 
	g¡Üe
 = 
Ãw_¡Üage_äom_’ts
(
sched
, &
td
, &
’ts
);

1632 
Ët
 
	ge
 = 
¡Üe
.
’Œ›s
(
lo
, 
hi
, 
maxsize
);

1633 
	ge
 !ğ
w’Œ›s
 {

1634 
·nic
!("#{}:ƒx³ùƒÁr› {:?}, gÙ {:?}", 
i
, 
w’Œ›s
, 
e
);

1642 #[
‹¡
]

1643 
â
 
‹¡_¡Üage_com·ù
() {

1644 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

1645 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

1646 (2, 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
))),

1647 (3, 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Com·ùed
))),

1648 (4, 
Ok
(())),

1649 (5, 
Ok
(())),

1651 
	gi
, (
	gidx
, 
	gw”r
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

1652 
Ët
 
	gtd
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

1653 
Ët
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

1654 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

1655 
Ët
 
	g¡Üe
 = 
Ãw_¡Üage_äom_’ts
(
sched
, &
td
, &
’ts
);

1656 
Ët
 
mut
 
	gùx
 = 
InvokeCÚ‹xt
::
Ãw
(&
¡Üe
);

1657 
Ët
 
	g»s
 = 
¡Üe
.
‹rm
(
idx
).
m­_”r
(
From
::
äom
).
ªd_th’
(|term| {

1658 
com·ù_¿á_log
(&
¡Üe
.
g
, &
mut
 
ùx
.
­¶y_¡©e
, 
idx
, 
‹rm
)

1661 
	g»s
.
is_”r
(è^ 
	gw”r
.is_err() {

1662 
	g·nic
!("#{}: wªˆ{:?}, gÙ {:?}", 
	gi
, 
	gw”r
, 
	g»s
);

1664 
	g»s
.
is_ok
() {

1665 
Ët
 
mut
 
	gkv_wb
 = 
Wr™eB©ch
::
Ãw
();

1666 
	gùx
.
§ve_­¶y_¡©e_to
(&
¡Üe
.
kv_’gše
, &
mut
 
kv_wb
)

1667 .
unw¿p
();

1668 
	g¡Üe
.
	gkv_’gše
.
wr™e
(
kv_wb
).
ex³ù
("");

1673 #[
‹¡
]

1674 
â
 
‹¡_¡Üage_ü—‹_¢­shÙ
() {

1675 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

1676 
Ët
 
mut
 
	gcs
 = 
CÚfS‹
::
Ãw
();

1677 
	gcs
.
£t_nodes
(
vec
![1, 2, 3]);

1679 
Ët
 
	gtd
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

1680 
Ët
 
	g¢­_dœ
 = 
TempDœ
::
Ãw
("¢­_dœ").
unw¿p
();

1681 
Ët
 
	gmgr
 = 
SÇpMªag”
::
Ãw
(
¢­_dœ
.
·th
().
to_¡r
().
unw¿p
(), 
NÚe
, None);

1682 
Ët
 
mut
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

1683 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

1684 
Ët
 
mut
 
	gs
 = 
Ãw_¡Üage_äom_’ts
(
sched
, &
td
, &
’ts
);

1685 
Ët
 
	gruÂ”
 = 
RegiÚRuÂ”
::
Ãw
(
s
.
kv_’gše
.
şÚe
(), s.
¿á_’gše
.şÚe(), 
mgr
, 0);

1686 
	gwÜk”
.
¡¬t
(
ruÂ”
).
unw¿p
();

1687 
Ët
 
	g¢­
 = 
s
.
¢­shÙ
();

1688 
Ët
 
	guÇvaabË
 = 
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
SÇpshÙTempÜ¬yUÇvaabË
);

1689 
	gas£¹_eq
!(
	g¢­
.
unw¿p_”r
(), 
	guÇvaabË
);

1690 
	gas£¹_eq
!(*
	gs
.
	g¢­_Œ›d_út
.
bÜrow
(), 1);

1692 
Ët
 
	g¢­
 = 
m©ch
 *
s
.
¢­_¡©e
.
bÜrow
() {

1693 
SÇpS‹
::
G’”©šg
(
»f
 
rx
è=>„x.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
(),

1694 
»f
 
	gs
 => 
·nic
!("unexpected state: {:?}", s),

1696 
	gas£¹_eq
!(
	g¢­
.
g‘_m‘ad©a
().
g‘_šdex
(), 5);

1697 
	gas£¹_eq
!(
	g¢­
.
g‘_m‘ad©a
().
g‘_‹rm
(), 5);

1698 
	gas£¹
!(!
	g¢­
.
g‘_d©a
().
is_em±y
());

1700 
Ët
 
mut
 
	gd©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

1701 
	g´Ùobuf
::
Mes§ge
::
m”ge_äom_by‹s
(&
mut
 
d©a
, 
¢­
.
g‘_d©a
()).
ex³ù
("");

1702 
	gas£¹_eq
!(
	gd©a
.
g‘_»giÚ
().
g‘_id
(), 1);

1703 
	gas£¹_eq
!(
	gd©a
.
g‘_»giÚ
().
g‘_³”s
().
Ën
(), 1);

1705 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1706 
	gs
.
£t_¢­_¡©e
(
SÇpS‹
::
G’”©šg
(
rx
));

1708 
	gas£¹_eq
!(
	gs
.
¢­shÙ
().
unw¿p_”r
(), 
	guÇvaabË
);

1709 
	gas£¹_eq
!(*
	gs
.
	g¢­_Œ›d_út
.
bÜrow
(), 1);

1711 
	gtx
.
£nd
(
¢­
.
şÚe
()).
unw¿p
();

1712 
	gas£¹_eq
!(
	gs
.
¢­shÙ
(), 
Ok
(
¢­
.
şÚe
()));

1713 
	gas£¹_eq
!(*
	gs
.
	g¢­_Œ›d_út
.
bÜrow
(), 0);

1715 
Ët
 
mut
 
	gùx
 = 
InvokeCÚ‹xt
::
Ãw
(&
s
);

1716 
Ët
 
mut
 
	gkv_wb
 = 
Wr™eB©ch
::
Ãw
();

1717 
Ët
 
mut
 
	gm‘rics
 = 
RaáM‘rics
::();

1718 
Ët
 
	gŒªs
 = 0;

1719 
Ët
 
mut
 
	g»ady_ùx
 = 
R—dyCÚ‹xt
::
Ãw
(&muˆ
m‘rics
, &
Œªs
, 2);

1720 
	gs
.
­³nd
(

1721 &
mut
 
ùx
,

1722 &[
Ãw_’Œy
(6, 5),‚ew_entry(7, 5)],

1723 &
mut
 
»ady_ùx
,

1724 ).
unw¿p
();

1725 
Ët
 
mut
 
	ghs
 = 
H¬dS‹
::
Ãw
();

1726 
	ghs
.
£t_comm™
(7);

1727 
	ghs
.
£t_‹rm
(5);

1728 
	gùx
.
	g¿á_¡©e
.
£t_h¬d_¡©e
(
hs
);

1729 
	gùx
.
	g¿á_¡©e
.
£t_Ï¡_šdex
(7);

1730 
	gùx
.
	g­¶y_¡©e
.
£t_­¶›d_šdex
(7);

1731 
	gùx
.
§ve_¿á_¡©e_to
(&
mut
 
»ady_ùx
.
¿á_wb
).
unw¿p
();

1732 
	gùx
.
§ve_­¶y_¡©e_to
(&
s
.
kv_’gše
, &
mut
 
kv_wb
).
unw¿p
();

1733 
	gs
.
	gkv_’gše
.
wr™e
(
kv_wb
).
unw¿p
();

1734 
	gs
.
	g¿á_’gše
.
wr™e
(
»ady_ùx
.
¿á_wb
).
unw¿p
();

1735 
	gs
.
	g­¶y_¡©e
 = 
ùx
.
­¶y_¡©e
;

1736 
	gs
.
	g¿á_¡©e
 = 
ùx
.
¿á_¡©e
;

1737 
	gùx
 = 
InvokeCÚ‹xt
::
Ãw
(&
s
);

1738 
Ët
 
	g‹rm
 = 
s
.
‹rm
(7).
unw¿p
();

1739 
com·ù_¿á_log
(&
s
.
g
, &
mut
 
ùx
.
­¶y_¡©e
, 7, 
‹rm
).
unw¿p
();

1740 
	gkv_wb
 = 
Wr™eB©ch
::
Ãw
();

1741 
	gùx
.
§ve_­¶y_¡©e_to
(&
s
.
kv_’gše
, &
mut
 
kv_wb
).
unw¿p
();

1742 
	gs
.
	gkv_’gše
.
wr™e
(
kv_wb
).
unw¿p
();

1743 
	gs
.
	g­¶y_¡©e
 = 
ùx
.
­¶y_¡©e
;

1744 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1745 
	gtx
.
£nd
(
¢­
.
şÚe
()).
unw¿p
();

1746 
	gs
.
£t_¢­_¡©e
(
SÇpS‹
::
G’”©šg
(
rx
));

1747 *
	gs
.
	g¢­_Œ›d_út
.
bÜrow_mut
() = 1;

1749 
	gas£¹_eq
!(
	gs
.
¢­shÙ
().
unw¿p_”r
(), 
	guÇvaabË
);

1750 
	gas£¹_eq
!(*
	gs
.
	g¢­_Œ›d_út
.
bÜrow
(), 1);

1752 
m©ch
 *
	gs
.
	g¢­_¡©e
.
bÜrow
() {

1753 
	gSÇpS‹
::
G’”©šg
(
»f
 
rx
) => {

1754 
rx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

1755 
	gwÜk”
.
¡İ
().
unw¿p
().
još
().unwrap();

1756 
m©ch
 
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)) {

1757 
E¼
(
RecvTimeoutE¼Ü
::
DiscÚÃùed
) => {}

1758 
»s
 => 
·nic
!("uÃx³ùed„esuÉ: {:?}", 
	g»s
),

1761 
»f
 
	gs
 => 
·nic
!("unexpected state {:?}", s),

1764 
	gas£¹_eq
!(
	gs
.
¢­shÙ
().
unw¿p_”r
(), 
	guÇvaabË
);

1765 
	gas£¹_eq
!(*
	gs
.
	g¢­_Œ›d_út
.
bÜrow
(), 2);

1767 
út
 
	gš
 2..
	gsu³r
::
MAX_SNAP_TRY_CNT
 {

1769 
as£¹_eq
!(
s
.
¢­shÙ
().
unw¿p_”r
(), 
	guÇvaabË
);

1770 
	gas£¹_eq
!(*
	gs
.
	g¢­_Œ›d_út
.
bÜrow
(), 
	gút
 + 1);

1774 
m©ch
 
	gs
.
¢­shÙ
() {

1775 
E¼
(
RaáE¼Ü
::
StÜe
(
StÜageE¼Ü
::
Oth”
(
_
))) => {}

1776 
»s
 => 
·nic
!("uÃx³ùed„es: {:?}", 
	g»s
),

1780 #[
‹¡
]

1781 
â
 
‹¡_¡Üage_­³nd
() {

1782 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

1783 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

1785 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)],

1786 
	gvec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5)],

1789 
	gvec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 6),‚ew_entry(5, 6)],

1790 
	gvec
![
Ãw_’Œy
(4, 6),‚ew_entry(5, 6)],

1793 
	gvec
![

1794 
Ãw_’Œy
(3, 3),

1795 
Ãw_’Œy
(4, 4),

1796 
Ãw_’Œy
(5, 5),

1797 
Ãw_’Œy
(6, 5),

1799 
	gvec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5),‚ew_entry(6, 5)],

1803 
	gvec
![
Ãw_’Œy
(2, 3),‚ew_entry(3, 3),‚ew_entry(4, 5)],

1804 
	gvec
![
Ãw_’Œy
(4, 5)],

1807 (
	gvec
![
Ãw_’Œy
(4, 5)], vec![new_entry(4, 5)]),

1810 
	gvec
![
Ãw_’Œy
(6, 5)],

1811 
	gvec
![
Ãw_’Œy
(4, 4),‚ew_entry(5, 5),‚ew_entry(6, 5)],

1814 
	gi
, (
	g’Œ›s
, 
	gw’Œ›s
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

1815 
Ët
 
	gtd
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

1816 
Ët
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

1817 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

1818 
Ët
 
mut
 
	g¡Üe
 = 
Ãw_¡Üage_äom_’ts
(
sched
, &
td
, &
’ts
);

1819 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1820 
Ët
 
	gli
 = 
¡Üe
.
Ï¡_šdex
();

1821 
Ët
 
	gaùu®_’Œ›s
 = 
¡Üe
.
’Œ›s
(4, 
li
 + 1, 
u64
::
max_v®ue
()).
ex³ù
("");

1822 
	gaùu®_’Œ›s
 !ğ
w’Œ›s
 {

1823 
·nic
!("#{}: wªˆ{:?}, gÙ {:?}", 
i
, 
w’Œ›s
, 
aùu®_’Œ›s
);

1828 #[
‹¡
]

1829 
â
 
‹¡_¡Üage_ÿche_ãtch
() {

1830 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

1831 
Ët
 
	gtd
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

1832 
Ët
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

1833 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

1834 
Ët
 
mut
 
	g¡Üe
 = 
Ãw_¡Üage_äom_’ts
(
sched
, &
td
, &
’ts
);

1835 
	g¡Üe
.
	gÿche
.ÿche.
ş—r
();

1837 
Ët
 
mut
 
	g»s
 = 
¡Üe
.
’Œ›s
(4, 6, 
u64
::
max_v®ue
()).
unw¿p
();

1838 
	gas£¹_eq
!(*
	g»s
, 
	g’ts
[1..]);

1840 
Ët
 
	g’Œ›s
 = 
vec
![
Ãw_’Œy
(6, 5),‚ew_entry(7, 5)];

1841 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1842 
v®id©e_ÿche
(&
¡Üe
, &
’Œ›s
);

1845 
	g»s
 = 
¡Üe
.
’Œ›s
(6, 8, 
u64
::
max_v®ue
()).
unw¿p
();

1846 
	gas£¹_eq
!(
	g»s
, 
	g’Œ›s
);

1849 
	g»s
 = 
¡Üe
.
’Œ›s
(4, 8, 0).
unw¿p
();

1850 
	gas£¹_eq
!(
	g»s
, 
	gvec
![
Ãw_’Œy
(4, 4)]);

1851 
Ët
 
mut
 
	gsize
 = 
’ts
[1..].
™”
().
m­
(|
e
|ƒ.
compu‹_size
(è
as
 
u64
).
sum
();

1852 
	g»s
 = 
¡Üe
.
’Œ›s
(4, 8, 
size
).
unw¿p
();

1853 
Ët
 
mut
 
	gexp_»s
 = 
’ts
[1..].
to_vec
();

1854 
	gas£¹_eq
!(
	g»s
, 
	gexp_»s
);

1855 
e
 
	gš
 &
	g’Œ›s
 {

1856 
	gsize
 +ğ
e
.
compu‹_size
(è
as
 
u64
;

1857 
	gexp_»s
.
push
(
e
.
şÚe
());

1858 
	g»s
 = 
¡Üe
.
’Œ›s
(4, 8, 
size
).
unw¿p
();

1859 
	gas£¹_eq
!(
	g»s
, 
	gexp_»s
);

1863 
low
 
	gš
 4..9 {

1864 
high
 
š
 
	glow
..9 {

1865 
Ët
 
	g»s
 = 
¡Üe
.
’Œ›s
(
low
, 
high
, 
u64
::
max_v®ue
()).
unw¿p
();

1866 
	gas£¹_eq
!(*
	g»s
, 
	gexp_»s
[
low
 
as
 
usize
 - 4..
high
‡s usize - 4]);

1871 #[
‹¡
]

1872 
â
 
‹¡_¡Üage_ÿche_upd©e
() {

1873 
Ët
 
	g’ts
 = 
vec
![
Ãw_’Œy
(3, 3),‚ew_entry(4, 4),‚ew_entry(5, 5)];

1874 
Ët
 
	gtd
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

1875 
Ët
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

1876 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

1877 
Ët
 
mut
 
	g¡Üe
 = 
Ãw_¡Üage_äom_’ts
(
sched
, &
td
, &
’ts
);

1878 
	g¡Üe
.
	gÿche
.ÿche.
ş—r
();

1881 
Ët
 
mut
 
	g’Œ›s
 = 
vec
![
Ãw_’Œy
(6, 5),‚ew_entry(7, 5)];

1882 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1883 
v®id©e_ÿche
(&
¡Üe
, &
’Œ›s
);

1886 
	g’Œ›s
 = 
vec
![
Ãw_’Œy
(6, 6),‚ew_entry(7, 6)];

1887 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1888 
v®id©e_ÿche
(&
¡Üe
, &
’Œ›s
);

1891 
	g’Œ›s
 = 
vec
![
Ãw_’Œy
(5, 6),‚ew_entry(6, 6)];

1892 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1893 
v®id©e_ÿche
(&
¡Üe
, &
’Œ›s
);

1896 
	g’Œ›s
 = 
vec
![
Ãw_’Œy
(6, 7),‚ew_entry(7, 7)];

1897 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1898 
Ët
 
mut
 
	gexp_»s
 = 
vec
![
Ãw_’Œy
(5, 6),‚ew_entry(6, 7),‚ew_entry(7, 7)];

1899 
v®id©e_ÿche
(&
¡Üe
, &
exp_»s
);

1902 
	g’Œ›s
 = 
vec
![
Ãw_’Œy
(8, 7),‚ew_entry(9, 7)];

1903 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1904 
	gexp_»s
.
ex‹nd_äom_¦iû
(&
’Œ›s
);

1905 
v®id©e_ÿche
(&
¡Üe
, &
exp_»s
);

1908 
	g’Œ›s
 = 
vec
![
Ãw_’Œy
(7, 8)];

1909 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1910 
	gexp_»s
.
Œunÿ‹
(2);

1911 
	gexp_»s
.
push
(
Ãw_’Œy
(7, 8));

1912 
v®id©e_ÿche
(&
¡Üe
, &
exp_»s
);

1914 
Ët
 
	gÿp
 = 
MAX_CACHE_CAPACITY
 
as
 
u64
;

1917 
	g’Œ›s
 = (3..ÿ
p
 + 1).
m­
(|
i
| 
Ãw_’Œy
(˜+ 5, 8)).
cŞËù
();

1918 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1919 
	gexp_»s
.
»move
(0);

1920 
	gexp_»s
.
ex‹nd_äom_¦iû
(&
’Œ›s
);

1921 
v®id©e_ÿche
(&
¡Üe
, &
exp_»s
);

1924 
	g’Œ›s
 = (0..ÿ
p
 + 1).
m­
(|
i
| 
Ãw_’Œy
(˜+ 
ÿp
 + 6, 8)).
cŞËù
();

1925 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1926 
	gexp_»s
 = 
’Œ›s
[’Œ›s.
Ën
(è- 
ÿp
 
as
 
usize
..].
to_vec
();

1927 
v®id©e_ÿche
(&
¡Üe
, &
exp_»s
);

1930 
	g¡Üe
.
com·ù_to
(
ÿp
 + 10);

1931 
	gexp_»s
 = (
ÿp
 + 10..ÿ
p
 * 2 + 7).
m­
(|
i
| 
Ãw_’Œy
(i, 8)).
cŞËù
();

1932 
v®id©e_ÿche
(&
¡Üe
, &
exp_»s
);

1935 
	gas£¹
!(
	g¡Üe
.
	gÿche
.ÿche.
ÿ·c™y
(è>ğ
ÿp
 
as
 
usize
);

1936 
	g¡Üe
.
com·ù_to
(
ÿp
 * 2);

1937 
	gexp_»s
 = (
ÿp
 * 2..ÿ
p
 * 2 + 7).
m­
(|
i
| 
Ãw_’Œy
(i, 8)).
cŞËù
();

1938 
v®id©e_ÿche
(&
¡Üe
, &
exp_»s
);

1939 
	gas£¹
!(
	g¡Üe
.
	gÿche
.ÿche.
ÿ·c™y
(è< 
ÿp
 
as
 
	gusize
);

1942 
	g’Œ›s
 = (0..ÿ
p
 + 1).
m­
(|
i
| 
Ãw_’Œy
(i, 8)).
cŞËù
();

1943 
­³nd_’ts
(&
mut
 
¡Üe
, &
’Œ›s
);

1944 
	gas£¹
!(
	g¡Üe
.
	gÿche
.ÿche.
ÿ·c™y
(è>ğ
ÿp
 
as
 
usize
);

1945 
­³nd_’ts
(&
mut
 
¡Üe
, &[
Ãw_’Œy
(6, 8)]);

1946 
	gexp_»s
 = (1..7).
m­
(|
i
| 
Ãw_’Œy
(i, 8)).
cŞËù
();

1947 
v®id©e_ÿche
(&
¡Üe
, &
exp_»s
);

1948 
	gas£¹
!(
	g¡Üe
.
	gÿche
.ÿche.
ÿ·c™y
(è< 
ÿp
 
as
 
	gusize
);

1951 #[
‹¡
]

1952 
â
 
‹¡_¡Üage_­¶y_¢­shÙ
() {

1953 
Ët
 
	g’ts
 = 
vec
![

1954 
Ãw_’Œy
(3, 3),

1955 
Ãw_’Œy
(4, 4),

1956 
Ãw_’Œy
(5, 5),

1957 
Ãw_’Œy
(6, 6),

1959 
Ët
 
mut
 
	gcs
 = 
CÚfS‹
::
Ãw
();

1960 
	gcs
.
£t_nodes
(
vec
![1, 2, 3]);

1962 
Ët
 
	gtd1
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

1963 
Ët
 
	g¢­_dœ
 = 
TempDœ
::
Ãw
("¢­").
unw¿p
();

1964 
Ët
 
	gmgr
 = 
SÇpMªag”
::
Ãw
(
¢­_dœ
.
·th
().
to_¡r
().
unw¿p
(), 
NÚe
, None);

1965 
Ët
 
mut
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

1966 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

1967 
Ët
 
	gs1
 = 
Ãw_¡Üage_äom_’ts
(
sched
.
şÚe
(), &
td1
, &
’ts
);

1968 
Ët
 
	gruÂ”
 =

1969 
RegiÚRuÂ”
::
Ãw
(
s1
.
kv_’gše
.
şÚe
(), s1.
¿á_’gše
.şÚe(), 
mgr
.clone(), 0);

1970 
	gwÜk”
.
¡¬t
(
ruÂ”
).
unw¿p
();

1971 
	gas£¹
!(
	gs1
.
¢­shÙ
().
is_”r
());

1972 
Ët
 
	g¢­1
 = 
m©ch
 *
s1
.
¢­_¡©e
.
bÜrow
() {

1973 
SÇpS‹
::
G’”©šg
(
»f
 
rx
è=>„x.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
(),

1974 
»f
 
	gs
 => 
·nic
!("unexpected state: {:?}", s),

1976 
	gas£¹_eq
!(
	gs1
.
Œunÿ‹d_šdex
(), 3);

1977 
	gas£¹_eq
!(
	gs1
.
Œunÿ‹d_‹rm
(), 3);

1979 
Ët
 
	gtd2
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

1980 
Ët
 
mut
 
	gs2
 = 
Ãw_¡Üage
(
sched
.
şÚe
(), &
td2
);

1981 
	gas£¹_eq
!(
	gs2
.
fœ¡_šdex
(), s2.
­¶›d_šdex
() + 1);

1982 
Ët
 
mut
 
	gùx
 = 
InvokeCÚ‹xt
::
Ãw
(&
s2
);

1983 
	gas£¹_Ã
!(
	gùx
.
	gÏ¡_‹rm
, 
	g¢­1
.
g‘_m‘ad©a
().
g‘_‹rm
());

1984 
Ët
 
	gkv_wb
 = 
Wr™eB©ch
::
Ãw
();

1985 
Ët
 
	g¿á_wb
 = 
Wr™eB©ch
::
Ãw
();

1986 
	gs2
.
­¶y_¢­shÙ
(&
mut
 
ùx
, &
¢­1
, &
kv_wb
, &
¿á_wb
)

1987 .
unw¿p
();

1988 
	gas£¹_eq
!(
	gùx
.
	gÏ¡_‹rm
, 
	g¢­1
.
g‘_m‘ad©a
().
g‘_‹rm
());

1989 
	gas£¹_eq
!(
	gùx
.
	g­¶y_¡©e
.
g‘_­¶›d_šdex
(), 6);

1990 
	gas£¹_eq
!(
	gùx
.
	g¿á_¡©e
.
g‘_Ï¡_šdex
(), 6);

1991 
	gas£¹_eq
!(
	gùx
.
	g­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_šdex
(), 6);

1992 
	gas£¹_eq
!(
	gùx
.
	g­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_‹rm
(), 6);

1993 
	gas£¹_eq
!(
	gs2
.
fœ¡_šdex
(), s2.
­¶›d_šdex
() + 1);

1994 
v®id©e_ÿche
(&
s2
, &[]);

1996 
Ët
 
	gtd3
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

1997 
Ët
 
	g’ts
 = &[
Ãw_’Œy
(3, 3),‚ew_entry(4, 3)];

1998 
Ët
 
mut
 
	gs3
 = 
Ãw_¡Üage_äom_’ts
(
sched
, &
td3
, 
’ts
);

1999 
v®id©e_ÿche
(&
s3
, &
’ts
[1..]);

2000 
Ët
 
mut
 
	gùx
 = 
InvokeCÚ‹xt
::
Ãw
(&
s3
);

2001 
	gas£¹_Ã
!(
	gùx
.
	gÏ¡_‹rm
, 
	g¢­1
.
g‘_m‘ad©a
().
g‘_‹rm
());

2002 
Ët
 
	gkv_wb
 = 
Wr™eB©ch
::
Ãw
();

2003 
Ët
 
	g¿á_wb
 = 
Wr™eB©ch
::
Ãw
();

2004 
	gs3
.
­¶y_¢­shÙ
(&
mut
 
ùx
, &
¢­1
, &
kv_wb
, &
¿á_wb
)

2005 .
unw¿p
();

2006 
	gas£¹_eq
!(
	gùx
.
	gÏ¡_‹rm
, 
	g¢­1
.
g‘_m‘ad©a
().
g‘_‹rm
());

2007 
	gas£¹_eq
!(
	gùx
.
	g­¶y_¡©e
.
g‘_­¶›d_šdex
(), 6);

2008 
	gas£¹_eq
!(
	gùx
.
	g¿á_¡©e
.
g‘_Ï¡_šdex
(), 6);

2009 
	gas£¹_eq
!(
	gùx
.
	g­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_šdex
(), 6);

2010 
	gas£¹_eq
!(
	gùx
.
	g­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_‹rm
(), 6);

2011 
v®id©e_ÿche
(&
s3
, &[]);

2014 #[
‹¡
]

2015 
â
 
‹¡_ÿnûlšg_¢­shÙ
() {

2016 
Ët
 
	gtd
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

2017 
Ët
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

2018 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

2019 
Ët
 
mut
 
	gs
 = 
Ãw_¡Üage
(
sched
, &
td
);

2022 
	gs
.
	g¢­_¡©e
 = 
RefC–l
::
Ãw
(
SÇpS‹
::
Aµlyšg
(

2023 
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_PENDING
)),

2025 
	gas£¹
!(
	gs
.
ÿnûl_­¶yšg_¢­
());

2026 
	gas£¹_eq
!(*
	gs
.
	g¢­_¡©e
.
bÜrow
(), 
	gSÇpS‹
::
AµlyAbÜ‹d
);

2029 
	gs
.
	g¢­_¡©e
 = 
RefC–l
::
Ãw
(
SÇpS‹
::
Aµlyšg
(

2030 
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_RUNNING
)),

2032 
	gas£¹
!(!
	gs
.
ÿnûl_­¶yšg_¢­
());

2033 
	gas£¹_eq
!(

2034 *
	gs
.
	g¢­_¡©e
.
bÜrow
(),

2035 
	gSÇpS‹
::
Aµlyšg
(
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_CANCELLING
)))

2038 
	gas£¹
!(!
	gs
.
ÿnûl_­¶yšg_¢­
());

2040 
	gs
.
	g¢­_¡©e
 = 
RefC–l
::
Ãw
(
SÇpS‹
::
Aµlyšg
(

2041 
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_CANCELLED
)),

2044 
	gas£¹
!(
	gs
.
ÿnûl_­¶yšg_¢­
());

2045 
	gas£¹_eq
!(*
	gs
.
	g¢­_¡©e
.
bÜrow
(), 
	gSÇpS‹
::
AµlyAbÜ‹d
);

2047 
	gs
.
	g¢­_¡©e
 = 
RefC–l
::
Ãw
(
SÇpS‹
::
Aµlyšg
(

2048 
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_FINISHED
)),

2050 
	gas£¹
!(
	gs
.
ÿnûl_­¶yšg_¢­
());

2051 
	gas£¹_eq
!(*
	gs
.
	g¢­_¡©e
.
bÜrow
(), 
	gSÇpS‹
::
R–ax
);

2053 
	gs
.
	g¢­_¡©e
 = 
RefC–l
::
Ãw
(
SÇpS‹
::
Aµlyšg
(

2054 
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_FAILED
)),

2056 
Ët
 
	g»s
 = 
»cov”_§ã
!(|| 
s
.
ÿnûl_­¶yšg_¢­
());

2057 
	gas£¹
!(
	g»s
.
is_”r
());

2060 #[
‹¡
]

2061 
â
 
‹¡_Œy_fšish_¢­shÙ
() {

2062 
Ët
 
	gtd
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

2063 
Ët
 
	gwÜk”
 = 
WÜk”
::
Ãw
("snap_manager");

2064 
Ët
 
	gsched
 = 
wÜk”
.
scheduËr
();

2065 
Ët
 
mut
 
	gs
 = 
Ãw_¡Üage
(
sched
, &
td
);

2068 
Ët
 
mut
 
	g¢­_¡©e
 = 
SÇpS‹
::
Aµlyšg
(
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_PENDING
)));

2069 
	gs
.
	g¢­_¡©e
 = 
RefC–l
::
Ãw
(
¢­_¡©e
);

2070 
	gas£¹
!(
	gs
.
check_­¶yšg_¢­
());

2071 
	gas£¹_eq
!(

2072 *
	gs
.
	g¢­_¡©e
.
bÜrow
(),

2073 
	gSÇpS‹
::
Aµlyšg
(
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_PENDING
)))

2077 
	g¢­_¡©e
 = 
SÇpS‹
::
Aµlyšg
(
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_RUNNING
)));

2078 
	gs
.
	g¢­_¡©e
 = 
RefC–l
::
Ãw
(
¢­_¡©e
);

2079 
	gas£¹
!(
	gs
.
check_­¶yšg_¢­
());

2080 
	gas£¹_eq
!(

2081 *
	gs
.
	g¢­_¡©e
.
bÜrow
(),

2082 
	gSÇpS‹
::
Aµlyšg
(
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_RUNNING
)))

2085 
	g¢­_¡©e
 = 
SÇpS‹
::
Aµlyšg
(
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_CANCELLED
)));

2086 
	gs
.
	g¢­_¡©e
 = 
RefC–l
::
Ãw
(
¢­_¡©e
);

2087 
	gas£¹
!(!
	gs
.
check_­¶yšg_¢­
());

2088 
	gas£¹_eq
!(*
	gs
.
	g¢­_¡©e
.
bÜrow
(), 
	gSÇpS‹
::
AµlyAbÜ‹d
);

2090 
	gas£¹
!(!
	gs
.
check_­¶yšg_¢­
());

2091 
	gas£¹_eq
!(*
	gs
.
	g¢­_¡©e
.
bÜrow
(), 
	gSÇpS‹
::
AµlyAbÜ‹d
);

2093 
	gs
.
	g¢­_¡©e
 = 
RefC–l
::
Ãw
(
SÇpS‹
::
Aµlyšg
(

2094 
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_FINISHED
)),

2096 
	gas£¹
!(!
	gs
.
check_­¶yšg_¢­
());

2097 
	gas£¹_eq
!(*
	gs
.
	g¢­_¡©e
.
bÜrow
(), 
	gSÇpS‹
::
R–ax
);

2099 
	gas£¹
!(!
	gs
.
check_­¶yšg_¢­
());

2100 
	gas£¹_eq
!(*
	gs
.
	g¢­_¡©e
.
bÜrow
(), 
	gSÇpS‹
::
R–ax
);

2102 
	gs
.
	g¢­_¡©e
 = 
RefC–l
::
Ãw
(
SÇpS‹
::
Aµlyšg
(

2103 
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_FAILED
)),

2105 
Ët
 
	g»s
 = 
»cov”_§ã
!(|| 
s
.
check_­¶yšg_¢­
());

2106 
	gas£¹
!(
	g»s
.
is_”r
());

	@src/raftstore/store/snap.rs

14 
u£
 
	g¡d
::
”rÜ
;

15 
u£
 
	g¡d
::
io
::{
£lf
, 
	gE¼ÜKšd
, 
	gR—d
, 
	gWr™e
};

16 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

17 
u£
 
	g¡d
::
fs
::{
£lf
, 
	gM‘ad©a
};

18 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gRwLock
};

19 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

20 
u£
 
	g¡d
::
·th
::
P©h
;

21 
u£
 
	g¡d
::
»suÉ
;

22 
u£
 
	g¡d
::
¡r
;

23 
u£
 
	g¡d
::
time
;

24 
u£
 
	g¡d
::
th»ad
;

26 
u£
 
	g´Ùobuf
::
Mes§ge
;

27 
u£
 
	grocksdb
::{
CFHªdË
, 
	gWr™abË
, 
	gWr™eB©ch
, 
	gDB
};

28 
u£
 
	gkv´Ùo
::
”aápb
::
SÇpshÙ
 
as
 
RaáSÇpshÙ
;

29 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

30 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáSÇpshÙD©a
;

32 
u£
 
	g¿á¡Üe
::
ResuÉ
 
as
 
RaáStÜeResuÉ
;

33 
u£
 
	g¿á¡Üe
::
”rÜs
::
E¼Ü
 
as
 
RaáStÜeE¼Ü
;

34 
u£
 
	g¿á¡Üe
::
¡Üe
::
Msg
;

35 
u£
 
	g¿á¡Üe
::
¡Üe
::
ut
::
check_key_š_»giÚ
;

36 
u£
 
	g¡Üage
::{
CfName
, 
	gCF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_WRITE
};

37 
u£
 
	gut
::
Œª¥Üt
::
S’dCh
;

38 
u£
 
	gut
::
io_lim™”
::{
IOLim™”
, 
	gLim™Wr™”
};

39 
u£
 
	gut
::
HªdyRwLock
;

40 
u£
 
	gut
::
cŞËùiÚs
::{
HashM­
, 
HashM­EÁry
 
as
 
	gEÁry
};

41 
u£
 
	gut
::
codec
::
by‹s
::{
By‹sEncod”
, 
	gCom·ùBy‹sDecod”
};

43 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::{
I‹¿bË
, 
SÇpshÙ
 
as
 
	gDbSÇpshÙ
};

44 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
::{
£lf
, 
	g’c_’d_key
, 
	g’c_¡¬t_key
};

47 
u£
 
	g¿á¡Üe
::
¡Üe
::
m‘rics
::{
SNAPSHOT_BUILD_TIME_HISTOGRAM
, 
	gSNAPSHOT_CF_KV_COUNT
,

48 
	gSNAPSHOT_CF_SIZE
};

49 
u£
 
	g¿á¡Üe
::
¡Üe
::
³”_¡Üage
::
JOB_STATUS_CANCELLING
;

52 
pub
 cÚ¡ 
	gSNAPSHOT_CFS
: &'static [CfName] = &[CF_DEFAULT, CF_LOCK, CF_WRITE];

55 cÚ¡ 
SNAP_GEN_PREFIX
: &'static str = "gen";

57 cÚ¡ 
SNAP_REV_PREFIX
: &'static str = "rev";

59 cÚ¡ 
TMP_FILE_SUFFIX
: &'static str = ".tmp";

60 cÚ¡ 
SST_FILE_SUFFIX
: &'static str = ".sst";

62 cÚ¡ 
DELETE_RETRY_MAX_TIMES
: 
u32
 = 6;

63 cÚ¡ 
	gDELETE_RETRY_TIME_MILLIS
: 
u64
 = 500;

65 
	gquick_”rÜ
! {

66 #[
d”ive
(
Debug
)]

67 
pub
 
	eE¼Ü
 {

68 
	gAbÜt
 {

69 
desütiÚ
("abort")

70 
di¥Ïy
("abort")

72 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

73 
äom
()

74 
ÿu£
(
”r
.
as_»f
())

75 
desütiÚ
(
”r
.description())

76 
di¥Ïy
("¢­ faed {:?}", 
”r
)

81 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

84 #[
šlše
]

85 
â
 
¶aš_fe_u£d
(
cf
: &
¡r
è-> 
boŞ
 {

86 
cf
 =ğ
CF_LOCK


89 #[
šlše
]

90 
pub
 
â
 
check_abÜt
(
¡©us
: &
AtomicUsize
è-> 
ResuÉ
<()> {

91 
¡©us
.
lßd
(
Ord”šg
::
R–axed
è=ğ
JOB_STATUS_CANCELLING
 {

92  
E¼
(
E¼Ü
::
AbÜt
);

94 
Ok
(())

97 #[
d”ive
(
ClÚe
, 
Hash
, 
P¬tŸlEq
, 
Eq
, 
P¬tŸlOrd
, 
Ord
, 
Debug
)]

98 
pub
 
	sSÇpKey
 {

99 
pub
 
	m»giÚ_id
: 
u64
,

100 
pub
 
	m‹rm
: 
u64
,

101 
pub
 
	midx
: 
u64
,

104 
im¶
 
	gSÇpKey
 {

105 #[
šlše
]

106 
pub
 
â
 
Ãw
(
»giÚ_id
: 
u64
, 
‹rm
: u64, 
idx
: u64è-> 
SÇpKey
 {

107 
SÇpKey
 {

108 
»giÚ_id
:„egion_id,

109 
	g‹rm
: 
‹rm
,

110 
	gidx
: 
idx
,

114 
pub
 
â
 
äom_»giÚ_¢­
(
»giÚ_id
: 
u64
, 
¢­
: &
RaáSÇpshÙ
è-> 
SÇpKey
 {

115 
Ët
 
šdex
 = 
¢­
.
g‘_m‘ad©a
().
g‘_šdex
();

116 
Ët
 
	g‹rm
 = 
¢­
.
g‘_m‘ad©a
().
g‘_‹rm
();

117 
	gSÇpKey
::
Ãw
(
»giÚ_id
, 
‹rm
, 
šdex
)

120 
pub
 
â
 
äom_¢­
(
¢­
: &
RaáSÇpshÙ
è-> 
io
::
ResuÉ
<
SÇpKey
> {

121 
Ët
 
mut
 
¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

122 
Ët
 
E¼
(
e
èğ
¢­_d©a
.
m”ge_äom_by‹s
(
¢­
.
g‘_d©a
()) {

123  
E¼
(
io
::
E¼Ü
::
Ãw
(
E¼ÜKšd
::
Oth”
, 
e
));

126 
Ok
(
SÇpKey
::
äom_»giÚ_¢­
(

127 
¢­_d©a
.
g‘_»giÚ
().
g‘_id
(),

128 
¢­
,

133 
im¶
 
Di¥Ïy
 
	gSÇpKey
 {

134 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

135 
wr™e
!(
f
, "{}_{}_{}", 
	g£lf
.
	g»giÚ_id
, s–f.
	g‹rm
, s–f.
	gidx
)

139 #[
d”ive
(
DeçuÉ
)]

140 
pub
 
	sSÇpshÙSti¡ics
 {

141 
pub
 
	msize
: 
u64
,

142 
pub
 
	mkv_couÁ
: 
usize
,

145 
im¶
 
	gSÇpshÙSti¡ics
 {

146 
pub
 
â
 
Ãw
(è-> 
	gSÇpshÙSti¡ics
 {

147 
	gSÇpshÙSti¡ics
 {

148 ..
	gDeçuÉ
::()

153 
pub
 
	sAµlyO±iÚs
 {

154 
pub
 
db
: 
Arc
<
DB
>,

155 
pub
 
	m»giÚ
: 
RegiÚ
,

156 
pub
 
	mabÜt
: 
Arc
<
AtomicUsize
>,

157 
pub
 
	mwr™e_b©ch_size
: 
usize
,

167 
pub
 
Œa™
 
	gSÇpshÙ
: 
R—d
 + 
Wr™e
 + 
S’d
 {

168 
â
 
bud
(

169 &
mut
 
£lf
,

170 
¢­
: &
DbSÇpshÙ
,

171 
»giÚ
: &
RegiÚ
,

172 
¢­_d©a
: &
mut
 
RaáSÇpshÙD©a
,

173 
¡©
: &
mut
 
SÇpshÙSti¡ics
,

174 
d–‘”
: 
Box
<
SÇpshÙD–‘”
>,

175 è-> 
	gRaáStÜeResuÉ
<()>;

176 
â
 
·th
(&
£lf
è-> &
	g¡r
;

177 
â
 
exi¡s
(&
£lf
è-> 
	gboŞ
;

178 
â
 
d–‘e
(&
£lf
);

179 
â
 
m‘a
(&
£lf
è-> 
	gio
::
ResuÉ
<
M‘ad©a
>;

180 
â
 
tÙ®_size
(&
£lf
è-> 
	gio
::
ResuÉ
<
u64
>;

181 
â
 
§ve
(&
mut
 
£lf
è-> 
	gio
::
ResuÉ
<()>;

182 
â
 
­¶y
(&
mut
 
£lf
, 
İtiÚs
: 
AµlyO±iÚs
è-> 
ResuÉ
<()>;

187 
pub
 
â
 
cİy_¢­shÙ
(
mut
 
äom
: 
Box
<
SÇpshÙ
>, muˆ
to
: Box<SÇpshÙ>è-> 
io
::
ResuÉ
<()> {

188 !
to
.
exi¡s
() {

189 
io
::
cİy
(&
mut
 
äom
, &muˆ
to
)?;

190 
	gto
.
§ve
()?;

192 
Ok
(())

198 
pub
 
Œa™
 
	gSÇpshÙD–‘”
 {

200 
â
 
d–‘e_¢­shÙ
(&
£lf
, 
key
: &
SÇpKey
, 
¢­
: &
SÇpshÙ
, 
check_’Œy
: 
boŞ
) -> bool;

204 
pub
 
â
 
»Œy_d–‘e_¢­shÙ
(

205 
d–‘”
: 
Box
<
SÇpshÙD–‘”
>,

206 
key
: &
SÇpKey
,

207 
¢­
: &
SÇpshÙ
,

208 è-> 
	gboŞ
 {

209 
Ët
 
	gd
 = 
time
::
Du¿tiÚ
::
äom_mlis
(
DELETE_RETRY_TIME_MILLIS
);

210 
_
 
	gš
 0..DELE
	gTE_RETRY_MAX_TIMES
 {

211 
	gd–‘”
.
d–‘e_¢­shÙ
(
key
, 
¢­
, 
Œue
) {

212  
	gŒue
;

214 
	gth»ad
::
¦“p
(
d
);

216 
	gçl£


219 
u£
 
	g¡d
::
fs
::{
Fe
, 
	gO³nO±iÚs
};

220 
u£
 
	g¡d
::
·th
::
P©hBuf
;

221 
u£
 
	g¡d
::
time
::
In¡ªt
;

222 
u£
 
	güc
::
üc32
::{
£lf
, 
	gDige¡
, 
	gHash”32
};

223 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

224 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
SÇpshÙCFFe
, 
	gSÇpshÙM‘a
};

225 
u£
 
	grocksdb
::{
DBCom´essiÚTy³
, 
	gEnvO±iÚs
, 
	gInge¡Ex‹º®FeO±iÚs
, 
	gS¡FeWr™”
};

226 
u£
 
	gut
::
rocksdb
;

227 
u£
 
	gut
::
time
::
du¿tiÚ_to_£c
;

228 
u£
 
	gut
::
fe
::{
d–‘e_fe_if_exi¡
, 
	gfe_exi¡s
, 
	gg‘_fe_size
};

229 
u£
 
	gut
::
rocksdb
::
g‘_ç¡e¡_suµÜ‹d_com´essiÚ_ty³
;

231 
pub
 cÚ¡ 
	gSNAPSHOT_VERSION
: 
u64
 = 2;

232 cÚ¡ 
	gMETA_FILE_SUFFIX
: &'static str = ".meta";

233 cÚ¡ 
DIGEST_BUFFER_SIZE
: 
usize
 = 10240;

236 
â
 
ÿlc_üc32
(
p
: &
P©hBuf
è-> 
io
::
ResuÉ
<
u32
> {

237 
Ët
 
mut
 
dige¡
 = 
Dige¡
::
Ãw
(
üc32
::
IEEE
);

238 
Ët
 
mut
 
	gf
 = 
O³nO±iÚs
::
Ãw
().
»ad
(
Œue
).
İ’
(&
p
)?;

239 
Ët
 
mut
 
	gbuf
 = 
vec
![0; 
DIGEST_BUFFER_SIZE
];

240 
	gloİ
 {

241 
m©ch
 
	gf
.
»ad
(&
mut
 
buf
[..]) {

242 
Ok
(0) => {

243  
Ok
(
dige¡
.
sum32
());

245 
Ok
(
n
) => {

246 
dige¡
.
wr™e
(&
buf
[..
n
]);

248 
E¼
(
»f
 
e
è
	ge
.
kšd
(è=ğ
E¼ÜKšd
::
IÁ”ru±ed
 => {}

249 
E¼
(
”r
) =>  Err(err),

254 
â
 
g’_¢­shÙ_m‘a
(
cf_fes
: &[
CfFe
]è-> 
RaáStÜeResuÉ
<
SÇpshÙM‘a
> {

255 
Ët
 
mut
 
m‘a
 = 
Vec
::
w™h_ÿ·c™y
(
cf_fes
.
Ën
());

256 
cf_fe
 
š
 
	gcf_fes
 {

257 
	gSNAPSHOT_CFS
.
™”
().
fšd
(|&
cf
| 
cf_fe
.cà=ğ*cf).
is_nÚe
() {

258  
E¼
(
box_”r
!(

260 
cf_fe
.
cf


264 
Ët
 
mut
 
	gcf_fe_m‘a
 = 
SÇpshÙCFFe
::
Ãw
();

265 
	gcf_fe_m‘a
.
£t_cf
(
cf_fe
.
cf
.
to_owÃd
());

266 
	gcf_fe_m‘a
.
£t_size
(
cf_fe
.
size
);

267 
	gcf_fe_m‘a
.
£t_checksum
(
cf_fe
.
checksum
);

268 
	gm‘a
.
push
(
cf_fe_m‘a
);

270 
Ët
 
mut
 
	g¢­shÙ_m‘a
 = 
SÇpshÙM‘a
::
Ãw
();

271 
	g¢­shÙ_m‘a
.
£t_cf_fes
(
R•—‹dF›ld
::
äom_vec
(
m‘a
));

272 
Ok
(
¢­shÙ_m‘a
)

275 
â
 
check_fe_size
(
·th
: &
P©hBuf
, 
ex³ùed_size
: 
u64
è-> 
RaáStÜeResuÉ
<()> {

276 
Ët
 
size
 = 
g‘_fe_size
(
·th
)?;

277 
	gsize
 !ğ
ex³ùed_size
 {

278  
E¼
(
box_”r
!(

280 
size
,

281 
·th
.
di¥Ïy
(),

282 
ex³ùed_size


285 
Ok
(())

288 
â
 
check_fe_checksum
(
·th
: &
P©hBuf
, 
ex³ùed_checksum
: 
u32
è-> 
RaáStÜeResuÉ
<()> {

289 
Ët
 
checksum
 = 
ÿlc_üc32
(
·th
)?;

290 
	gchecksum
 !ğ
ex³ùed_checksum
 {

291  
E¼
(
box_”r
!(

293 
checksum
,

294 
·th
.
di¥Ïy
(),

295 
ex³ùed_checksum


298 
Ok
(())

301 
â
 
check_fe_size_ªd_checksum
(

302 
·th
: &
P©hBuf
,

303 
ex³ùed_size
: 
u64
,

304 
ex³ùed_checksum
: 
u32
,

305 è-> 
	gRaáStÜeResuÉ
<()> {

306 
check_fe_size
(
·th
, 
ex³ùed_size
).
ªd_th’
(|
_
| 
check_fe_checksum
Õ©h, 
ex³ùed_checksum
))

309 #[
d”ive
(
DeçuÉ
)]

310 
	sCfFe
 {

311 
pub
 
	mcf
: 
CfName
,

312 
pub
 
	m·th
: 
P©hBuf
,

313 
pub
 
	mtmp_·th
: 
P©hBuf
,

314 
pub
 
	ms¡_wr™”
: 
O±iÚ
<
S¡FeWr™”
>,

315 
pub
 
	mfe
: 
O±iÚ
<
Fe
>,

316 
pub
 
	mkv_couÁ
: 
u64
,

317 
pub
 
	msize
: 
u64
,

318 
pub
 
	mwr™‹n_size
: 
u64
,

319 
pub
 
	mchecksum
: 
u32
,

320 
pub
 
	mwr™e_dige¡
: 
O±iÚ
<
Dige¡
>,

323 #[
d”ive
(
DeçuÉ
)]

324 
	sM‘aFe
 {

325 
pub
 
	mm‘a
: 
SÇpshÙM‘a
,

326 
pub
 
	m·th
: 
P©hBuf
,

327 
pub
 
	mfe
: 
O±iÚ
<
Fe
>,

330 
pub
 
	mtmp_·th
: 
P©hBuf
,

333 
pub
 
	sSÇp
 {

334 
	mkey
: 
SÇpKey
,

335 
	mdi¥Ïy_·th
: 
SŒšg
,

336 
	mcf_fes
: 
Vec
<
CfFe
>,

337 
	mcf_šdex
: 
usize
,

338 
	mm‘a_fe
: 
M‘aFe
,

339 
	msize_Œack
: 
Arc
<
RwLock
<
u64
>>,

340 
	mlim™”
: 
O±iÚ
<
Arc
<
IOLim™”
>>,

343 
im¶
 
	gSÇp
 {

344 
â
 
	gÃw
<
	gT
: 
IÁo
<
P©hBuf
>>(

345 
dœ
: 
T
,

346 
	gkey
: &
SÇpKey
,

347 
	gsize_Œack
: 
Arc
<
RwLock
<
u64
>>,

348 
	gis_£ndšg
: 
boŞ
,

349 
	gto_bud
: 
boŞ
,

350 
	gd–‘”
: 
Box
<
SÇpshÙD–‘”
>,

351 
	glim™”
: 
O±iÚ
<
Arc
<
IOLim™”
>>,

352 è-> 
	gRaáStÜeResuÉ
<
	gSÇp
> {

353 
Ët
 
	gdœ_·th
 = 
dœ
.
što
();

354 !
	gdœ_·th
.
exi¡s
() {

355 
	gfs
::
ü—‹_dœ_®l
(
dœ_·th
.
as_·th
())?;

357 
Ët
 
	g¢­_´efix
 = 
is_£ndšg
 {

358 
SNAP_GEN_PREFIX


360 
SNAP_REV_PREFIX


362 
Ët
 
	g´efix
 = 
fÜm©
!("{}_{}", 
	g¢­_´efix
, 
	gkey
);

363 
Ët
 
	gdi¥Ïy_·th
 = 
SÇp
::
g‘_di¥Ïy_·th
(&
dœ_·th
, &
´efix
);

365 
Ët
 
mut
 
	gcf_fes
 = 
Vec
::
w™h_ÿ·c™y
(
SNAPSHOT_CFS
.
Ën
());

366 
cf
 
š
 
	gSNAPSHOT_CFS
 {

367 
Ët
 
	gf’ame
 = 
fÜm©
!("{}_{}{}", 
	g´efix
, 
	gcf
, 
	gSST_FILE_SUFFIX
);

368 
Ët
 
	g·th
 = 
dœ_·th
.
još
(&
f’ame
);

369 
Ët
 
	gtmp_·th
 = 
dœ_·th
.
još
(
fÜm©
!("{}{}", 
f’ame
, 
TMP_FILE_SUFFIX
));

370 
Ët
 
	gcf_fe
 = 
CfFe
 {

371 
cf
: cf,

372 
·th
:…ath,

373 
tmp_·th
:mp_path,

374 ..
DeçuÉ
::()

376 
	gcf_fes
.
push
(
cf_fe
);

379 
Ët
 
	gm‘a_f’ame
 = 
fÜm©
!("{}{}", 
	g´efix
, 
	gMETA_FILE_SUFFIX
);

380 
Ët
 
	gm‘a_·th
 = 
dœ_·th
.
još
(&
m‘a_f’ame
);

381 
Ët
 
	gm‘a_tmp_·th
 = 
dœ_·th
.
još
(
fÜm©
!("{}{}", 
m‘a_f’ame
, 
TMP_FILE_SUFFIX
));

382 
Ët
 
	gm‘a_fe
 = 
M‘aFe
 {

383 
·th
: 
m‘a_·th
,

384 
tmp_·th
: 
m‘a_tmp_·th
,

385 ..
DeçuÉ
::()

388 
Ët
 
mut
 
	gs
 = 
SÇp
 {

389 
key
: key.
şÚe
(),

390 
di¥Ïy_·th
: display_path,

391 
cf_fes
: cf_files,

392 
cf_šdex
: 0,

393 
m‘a_fe
: meta_file,

394 
size_Œack
: size_track,

395 
lim™”
:†imiter,

399 
fe_exi¡s
(&
s
.
m‘a_fe
.
·th
) {

400 
Ët
 
E¼
(
e
èğ
s
.
lßd_¢­shÙ_m‘a
() {

401 !
to_bud
 {

402  
E¼
(
e
);

404 
	gw¬n
!(

406 
	gs
.
·th
(),

407 
	ge


409 !
»Œy_d–‘e_¢­shÙ
(
d–‘”
, 
key
, &
s
) {

410 
	gw¬n
!(

412 
	gs
.
·th
()

414  
E¼
(
e
);

418 
Ok
(
s
)

421 
pub
 
â
 
	gÃw_fÜ_budšg
<
	gT
: 
IÁo
<
P©hBuf
>>(

422 
dœ
: 
T
,

423 
	gkey
: &
SÇpKey
,

424 
	g¢­
: &
DbSÇpshÙ
,

425 
	gsize_Œack
: 
Arc
<
RwLock
<
u64
>>,

426 
	gd–‘”
: 
Box
<
SÇpshÙD–‘”
>,

427 
	glim™”
: 
O±iÚ
<
Arc
<
IOLim™”
>>,

428 è-> 
	gRaáStÜeResuÉ
<
	gSÇp
> {

429 
Ët
 
mut
 
	gs
 = 
SÇp
::
Ãw
(
dœ
, 
key
, 
size_Œack
, 
Œue
,rue, 
d–‘”
, 
lim™”
)?;

430 
	gs
.
š™_fÜ_budšg
(
¢­
)?;

431 
Ok
(
s
)

434 
pub
 
â
 
	gÃw_fÜ_£ndšg
<
	gT
: 
IÁo
<
P©hBuf
>>(

435 
dœ
: 
T
,

436 
	gkey
: &
SÇpKey
,

437 
	gsize_Œack
: 
Arc
<
RwLock
<
u64
>>,

438 
	gd–‘”
: 
Box
<
SÇpshÙD–‘”
>,

439 è-> 
	gRaáStÜeResuÉ
<
	gSÇp
> {

440 
Ët
 
mut
 
	gs
 = 
SÇp
::
Ãw
(
dœ
, 
key
, 
size_Œack
, 
Œue
, 
çl£
, 
d–‘”
, 
NÚe
)?;

442 !
	gs
.
exi¡s
() {

444  
Ok
(
s
);

446 
cf_fe
 
	gš
 &
mut
 
	gs
.
	gcf_fes
 {

448 
	gcf_fe
.
	gsize
 > 0 {

449 
Ët
 
	gfe
 = 
Fe
::
İ’
(&
cf_fe
.
·th
)?;

450 
	gcf_fe
.
	gfe
 = 
Some
(
fe
);

453 
Ok
(
s
)

456 
pub
 
â
 
	gÃw_fÜ_»ûivšg
<
	gT
: 
IÁo
<
P©hBuf
>>(

457 
dœ
: 
T
,

458 
	gkey
: &
SÇpKey
,

459 
	g¢­shÙ_m‘a
: 
SÇpshÙM‘a
,

460 
	gsize_Œack
: 
Arc
<
RwLock
<
u64
>>,

461 
	gd–‘”
: 
Box
<
SÇpshÙD–‘”
>,

462 
	glim™”
: 
O±iÚ
<
Arc
<
IOLim™”
>>,

463 è-> 
	gRaáStÜeResuÉ
<
	gSÇp
> {

464 
Ët
 
mut
 
	gs
 = 
SÇp
::
Ãw
(
dœ
, 
key
, 
size_Œack
, 
çl£
, f®£, 
d–‘”
, 
lim™”
)?;

465 
	gs
.
£t_¢­shÙ_m‘a
(
¢­shÙ_m‘a
)?;

467 
	gs
.
exi¡s
() {

468  
Ok
(
s
);

470 
cf_fe
 
	gš
 &
mut
 
	gs
.
	gcf_fes
 {

471 
	gcf_fe
.
	gsize
 == 0 {

474 
Ët
 
	gf
 = 
O³nO±iÚs
::
Ãw
()

475 .
wr™e
(
Œue
)

476 .
ü—‹_Ãw
(
Œue
)

477 .
İ’
(&
cf_fe
.
tmp_·th
)?;

478 
	gcf_fe
.
	gfe
 = 
Some
(
f
);

479 
	gcf_fe
.
	gwr™e_dige¡
 = 
Some
(
Dige¡
::
Ãw
(
üc32
::
IEEE
));

481 
Ët
 
	gf
 = 
O³nO±iÚs
::
Ãw
()

482 .
wr™e
(
Œue
)

483 .
ü—‹_Ãw
(
Œue
)

484 .
İ’
(&
s
.
m‘a_fe
.
tmp_·th
)?;

485 
	gs
.
	gm‘a_fe
.
	gfe
 = 
Some
(
f
);

486 
Ok
(
s
)

489 
pub
 
â
 
	gÃw_fÜ_­¶yšg
<
	gT
: 
IÁo
<
P©hBuf
>>(

490 
dœ
: 
T
,

491 
	gkey
: &
SÇpKey
,

492 
	gsize_Œack
: 
Arc
<
RwLock
<
u64
>>,

493 
	gd–‘”
: 
Box
<
SÇpshÙD–‘”
>,

494 è-> 
	gRaáStÜeResuÉ
<
	gSÇp
> {

495 
Ët
 
	gs
 = 
SÇp
::
Ãw
(
dœ
, 
key
, 
size_Œack
, 
çl£
, f®£, 
d–‘”
, 
NÚe
)?;

496 
Ok
(
s
)

499 
â
 
š™_fÜ_budšg
(&
mut
 
£lf
, 
¢­
: &
DbSÇpshÙ
è-> 
RaáStÜeResuÉ
<()> {

500 
£lf
.
exi¡s
() {

501  
Ok
(());

503 
cf_fe
 
	gš
 &
mut
 
	g£lf
.
	gcf_fes
 {

504 
¶aš_fe_u£d
(
cf_fe
.
cf
) {

505 
Ët
 
	gf
 = 
O³nO±iÚs
::
Ãw
()

506 .
wr™e
(
Œue
)

507 .
ü—‹
(
Œue
)

508 .
Œunÿ‹
(
Œue
)

509 .
İ’
(&
cf_fe
.
tmp_·th
)?;

510 
	gcf_fe
.
	gfe
 = 
Some
(
f
);

512 
Ët
 
	ghªdË
 = 
¢­
.
cf_hªdË
(
cf_fe
.
cf
)?;

513 
Ët
 
mut
 
	gio_İtiÚs
 = 
¢­
.
g‘_db
().
g‘_İtiÚs_cf
(
hªdË
).
şÚe
();

514 
	gio_İtiÚs
.
com´essiÚ
(
g‘_ç¡e¡_suµÜ‹d_com´essiÚ_ty³
());

518 
	gio_İtiÚs
.
com´essiÚ_³r_Ëv–
(&[]);

519 
	gio_İtiÚs
.
bÙtommo¡_com´essiÚ
(
DBCom´essiÚTy³
::
Di§bË
);

520 
Ët
 
mut
 
	gwr™”
 = 
S¡FeWr™”
::
Ãw
(
EnvO±iÚs
::Ãw(), 
io_İtiÚs
);

521 
	gbox_Œy
!(
	gwr™”
.
İ’
(
cf_fe
.
tmp_·th
.
as_·th
().
to_¡r
().
unw¿p
()));

522 
	gcf_fe
.
	gs¡_wr™”
 = 
Some
(
wr™”
);

525 
Ët
 
	gfe
 = 
O³nO±iÚs
::
Ãw
()

526 .
wr™e
(
Œue
)

527 .
ü—‹_Ãw
(
Œue
)

528 .
İ’
(&
£lf
.
m‘a_fe
.
tmp_·th
)?;

529 
	g£lf
.
	gm‘a_fe
.
	gfe
 = 
Some
(
fe
);

530 
Ok
(())

533 
â
 
»ad_¢­shÙ_m‘a
(&
mut
 
£lf
è-> 
	gRaáStÜeResuÉ
<
	gSÇpshÙM‘a
> {

534 
Ët
 
	gsize
 = 
g‘_fe_size
(&
£lf
.
m‘a_fe
.
·th
)?;

535 
Ët
 
mut
 
	gfe
 = 
Fe
::
İ’
(&
£lf
.
m‘a_fe
.
·th
)?;

536 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(
size
 
as
 
usize
);

537 
	gfe
.
»ad_to_’d
(&
mut
 
buf
)?;

538 
Ët
 
mut
 
	g¢­shÙ_m‘a
 = 
SÇpshÙM‘a
::
Ãw
();

539 
	g¢­shÙ_m‘a
.
m”ge_äom_by‹s
(&
buf
)?;

540 
Ok
(
¢­shÙ_m‘a
)

543 
â
 
£t_¢­shÙ_m‘a
(&
mut
 
£lf
, 
¢­shÙ_m‘a
: 
SÇpshÙM‘a
è-> 
RaáStÜeResuÉ
<()> {

544 
¢­shÙ_m‘a
.
g‘_cf_fes
().
Ën
(è!ğ
£lf
.
cf_fes
.len() {

545  
E¼
(
box_”r
!(

547 
SNAPSHOT_CFS
.
Ën
(),

548 
¢­shÙ_m‘a
.
g‘_cf_fes
().
Ën
()

551 
	gi
, 
	gcf_fe
è
š
 
	g£lf
.
	gcf_fes
.
™”_mut
().
’um”©e
() {

552 
Ët
 
	gm‘a
 = 
¢­shÙ_m‘a
.
g‘_cf_fes
().
g‘
(
i
).
unw¿p
();

553 
	gm‘a
.
g‘_cf
(è!ğ
cf_fe
.
cf
 {

554  
E¼
(
box_”r
!(

556 
i
,

557 
cf_fe
.
cf
,

558 
m‘a
.
g‘_cf
()

561 
fe_exi¡s
(&
cf_fe
.
·th
) {

563 
check_fe_size
(&
cf_fe
.
·th
, 
m‘a
.
g‘_size
())?;

565 
	gcf_fe
.
	gsize
 = 
m‘a
.
g‘_size
();

566 
	gcf_fe
.
	gchecksum
 = 
m‘a
.
g‘_checksum
();

568 
	g£lf
.
	gm‘a_fe
.
	gm‘a
 = 
¢­shÙ_m‘a
;

569 
Ok
(())

572 
â
 
lßd_¢­shÙ_m‘a
(&
mut
 
£lf
è-> 
	gRaáStÜeResuÉ
<()> {

573 
Ët
 
	g¢­shÙ_m‘a
 = 
£lf
.
»ad_¢­shÙ_m‘a
()?;

574 
	g£lf
.
£t_¢­shÙ_m‘a
(
¢­shÙ_m‘a
)?;

577 !
	g£lf
.
exi¡s
() {

578  
E¼
(
box_”r
!(

580 
£lf
.
·th
()

583 
Ok
(())

586 
â
 
g‘_di¥Ïy_·th
(
dœ_·th
: &
P©hBuf
, 
´efix
: &
¡r
è-> 
SŒšg
 {

587 
Ët
 
cf_Çmes
 = "(".
to_owÃd
(è+ &
SNAPSHOT_CFS
.
još
("|") + ")";

588 
	gfÜm©
!(

590 
	gdœ_·th
.
di¥Ïy
(),

591 
	g´efix
,

592 
	gcf_Çmes
,

593 
	gSST_FILE_SUFFIX


597 
â
 
v®id©e
(&
£lf
è-> 
	gRaáStÜeResuÉ
<()> {

598 
cf_fe
 
	gš
 &
	g£lf
.
	gcf_fes
 {

599 
	gcf_fe
.
	gsize
 == 0 {

604 
check_fe_size_ªd_checksum
(&
cf_fe
.
·th
, cf_fe.
size
, cf_fe.
checksum
)?;

606 
Ok
(())

609 
â
 
sw™ch_to_cf_fe
(&
mut
 
£lf
, 
cf
: &
¡r
è-> 
io
::
ResuÉ
<()> {

610 
m©ch
 
£lf
.
cf_fes
.
™”
().
pos™iÚ
(|
x
| x.
cf
 == cf) {

611 
Some
(
šdex
) => {

612 
£lf
.
cf_šdex
 = 
šdex
;

613 
Ok
(())

615 
	gNÚe
 => 
E¼
(
io
::
E¼Ü
::
Ãw
(

616 
E¼ÜKšd
::
Oth”
,

617 
fÜm©
!("çØfšd cà{}", 
cf
),

622 
â
 
add_kv
(&
mut
 
£lf
, 
k
: &[
u8
], 
v
: &[u8]è-> 
io
::
ResuÉ
<()> {

623 
Ët
 
cf_fe
 = &
mut
 
£lf
.
cf_fes
[£lf.
cf_šdex
];

624 
Ët
 
	gwr™”
 = 
cf_fe
.
s¡_wr™”
.
as_mut
().
unw¿p
();

625 
Ët
 
E¼
(
e
èğ
wr™”
.
put
(
k
, 
v
) {

626  
E¼
(
io
::
E¼Ü
::
Ãw
(
E¼ÜKšd
::
Oth”
, 
e
));

628 
	gcf_fe
.
	gkv_couÁ
 += 1;

629 
Ok
(())

632 
â
 
§ve_cf_fes
(&
mut
 
£lf
è-> 
	gio
::
ResuÉ
<()> {

633 
cf_fe
 
š
 &
mut
 
£lf
.
cf_fes
 {

634 
¶aš_fe_u£d
(
cf_fe
.
cf
) {

635 
Ët
 
_
 = 
cf_fe
.
fe
.
ke
();

636 } 
	gcf_fe
.
	gkv_couÁ
 == 0 {

637 
Ët
 
_
 = 
cf_fe
.
s¡_wr™”
.
ke
().
unw¿p
();

639 
Ët
 
mut
 
	gwr™”
 = 
cf_fe
.
s¡_wr™”
.
ke
().
unw¿p
();

640 
Ët
 
E¼
(
e
èğ
wr™”
.
fšish
() {

641  
E¼
(
io
::
E¼Ü
::
Ãw
(
E¼ÜKšd
::
Oth”
, 
e
));

644 
Ët
 
	gsize
 = 
g‘_fe_size
(&
cf_fe
.
tmp_·th
)?;

645 
	gsize
 > 0 {

646 
	gfs
::
»Çme
(&
cf_fe
.
tmp_·th
, &cf_fe.
·th
)?;

647 
	gcf_fe
.
	gsize
 = 
size
;

649 
Ët
 
mut
 
	gsize_Œack
 = 
£lf
.
size_Œack
.
wl
();

650 *
	gsize_Œack
 = 
size_Œack
.
§tu¿tšg_add
(
size
);

652 
	gcf_fe
.
	gchecksum
 = 
ÿlc_üc32
(&
cf_fe
.
·th
)?;

655 
d–‘e_fe_if_exi¡
(&
cf_fe
.
tmp_·th
);

658 
Ok
(())

661 
â
 
§ve_m‘a_fe
(&
mut
 
£lf
è-> 
	gRaáStÜeResuÉ
<()> {

662 
Ët
 
mut
 
	gv
 = 
vec
![];

663 
	gbox_Œy
!(
	g£lf
.
	gm‘a_fe
.
	gm‘a
.
wr™e_to_vec
(&
mut
 
v
));

665 
Ët
 
mut
 
	gf
 = 
£lf
.
m‘a_fe
.
fe
.
ke
().
unw¿p
();

666 
	gf
.
wr™e_®l
(&
v
[..])?;

667 
	gf
.
æush
()?;

669 
	gfs
::
»Çme
(&
£lf
.
m‘a_fe
.
tmp_·th
, &£lf.m‘a_fe.
·th
)?;

670 
Ok
(())

673 
â
 
do_bud
(

674 &
mut
 
£lf
,

675 
¢­
: &
DbSÇpshÙ
,

676 
»giÚ
: &
RegiÚ
,

677 
¡©
: &
mut
 
SÇpshÙSti¡ics
,

678 
d–‘”
: 
Box
<
SÇpshÙD–‘”
>,

679 è-> 
	gRaáStÜeResuÉ
<()> {

680 
	g£lf
.
exi¡s
() {

681 
m©ch
 
	g£lf
.
v®id©e
() {

682 
Ok
(()) =>  Ok(()),

683 
E¼
(
e
) => {

684 
”rÜ
!(

686 
»giÚ
.
g‘_id
(),

687 
£lf
.
·th
(),

688 
e


690 !
»Œy_d–‘e_¢­shÙ
(
d–‘”
, &
£lf
.
key
, self) {

691 
	g”rÜ
!(

694 
	g£lf
.
·th
()

696  
E¼
(
e
);

698 
	g£lf
.
š™_fÜ_budšg
(
¢­
)?;

703 
Ët
 
mut
 
	g¢­_key_couÁ
 = 0;

704 
Ët
 (
begš_key
, 
’d_key
èğ(
’c_¡¬t_key
(
»giÚ
), 
’c_’d_key
(region));

705 
cf
 
š
 
	gSNAPSHOT_CFS
 {

706 
	g£lf
.
sw™ch_to_cf_fe
(
cf
)?;

707 
Ët
 (
cf_key_couÁ
, 
cf_size
èğ
¶aš_fe_u£d
(
cf
) {

708 
Ët
 
fe
 = 
£lf
.
cf_fes
[£lf.
cf_šdex
].fe.
as_mut
().
unw¿p
();

709 
bud_¶aš_cf_fe
(
fe
, 
¢­
, 
cf
, &
begš_key
, &
’d_key
)?

711 
Ët
 
mut
 
	gkey_couÁ
 = 0;

712 
Ët
 
mut
 
	gsize
 = 0;

713 
Ët
 
	gba£
 = 
£lf
.
lim™”


714 .
as_»f
()

715 .
m­_Ü
(0 
as
 
i64
, |
l
|†.
g‘_max_by‹s_³r_time
());

716 
Ët
 
mut
 
	gby‹s
: 
i64
 = 0;

717 
	g¢­
.
sÿn_cf
(

718 
cf
,

719 &
begš_key
,

720 &
’d_key
,

721 
çl£
,

722 &
mut
 |
key
, 
v®ue
| {

723 
Ët
 
l
 = 
key
.
Ën
(è+ 
v®ue
.len();

724 
Ët
 
Some
(
»f
 
lim™”
èğ
£lf
.limiter {

725 
by‹s
 >ğ
ba£
 {

726 
by‹s
 = 0;

727 
lim™”
.
»que¡
(
ba£
);

729 
by‹s
 +ğ
l
 
as
 
i64
;

731 
size
 +ğ
l
;

732 
key_couÁ
 += 1;

733 
£lf
.
add_kv
(
key
, 
v®ue
)?;

734 
Ok
(
Œue
)

737 (
	gkey_couÁ
, 
	gsize
)

739 
	g¢­_key_couÁ
 +ğ
cf_key_couÁ
;

740 
	gSNAPSHOT_CF_KV_COUNT


741 .
w™h_Ïb–_v®ues
(&[
cf
])

742 .
ob£rve
(
cf_key_couÁ
 
as
 
f64
);

743 
	gSNAPSHOT_CF_SIZE


744 .
w™h_Ïb–_v®ues
(&[
cf
])

745 .
ob£rve
(
cf_size
 
as
 
f64
);

746 
	gšfo
!(

748 
	g»giÚ
.
g‘_id
(),

749 
	g£lf
.
·th
(),

750 
	gcf
,

751 
	gcf_key_couÁ
,

752 
	gcf_size


756 
	g£lf
.
§ve_cf_fes
()?;

757 
	g¡©
.
	gkv_couÁ
 = 
¢­_key_couÁ
;

759 
Ët
 
	g¢­shÙ_m‘a
 = 
g’_¢­shÙ_m‘a
(&
£lf
.
cf_fes
[..])?;

760 
	g£lf
.
	gm‘a_fe
.
	gm‘a
 = 
¢­shÙ_m‘a
;

761 
	g£lf
.
§ve_m‘a_fe
()?;

763 
Ok
(())

767 
pub
 
â
 
	gbud_¶aš_cf_fe
<
	gE
: 
By‹sEncod”
>(

768 
’cod”
: &
mut
 
E
,

769 
	g¢­
: &
DbSÇpshÙ
,

770 
	gcf
: &
¡r
,

771 
	g¡¬t_key
: &[
u8
],

772 
	g’d_key
: &[
u8
],

773 è-> 
	gRaáStÜeResuÉ
<(
	gusize
, usize)> {

774 
Ët
 
mut
 
	gcf_key_couÁ
 = 0;

775 
Ët
 
mut
 
	gcf_size
 = 0;

776 
	g¢­
.
sÿn_cf
(

777 
cf
,

778 
¡¬t_key
,

779 
’d_key
,

780 
çl£
,

781 &
mut
 |
key
, 
v®ue
| {

782 
cf_key_couÁ
 += 1;

783 
cf_size
 +ğ
key
.
Ën
(è+ 
v®ue
.len();

784 
’cod”
.
’code_com·ù_by‹s
(
key
)?;

785 
’cod”
.
’code_com·ù_by‹s
(
v®ue
)?;

786 
Ok
(
Œue
)

790 
	gbox_Œy
!(
	g’cod”
.
’code_com·ù_by‹s
(
b
""));

791 
Ok
((
cf_key_couÁ
, 
cf_size
))

794 
â
 
	g­¶y_¶aš_cf_fe
<
	gD
: 
Com·ùBy‹sDecod”
>(

795 
decod”
: &
mut
 
D
,

796 
	gİtiÚs
: &
AµlyO±iÚs
,

797 
	ghªdË
: &
CFHªdË
,

798 è-> 
	gResuÉ
<()> {

799 
Ët
 
mut
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

800 
Ët
 
mut
 
	gb©ch_size
 = 0;

801 
	gloİ
 {

802 
check_abÜt
(&
İtiÚs
.
abÜt
)?;

803 
Ët
 
	gkey
 = 
box_Œy
!(
decod”
.
decode_com·ù_by‹s
());

804 
	gkey
.
is_em±y
() {

805 
	gb©ch_size
 > 0 {

806 
	gbox_Œy
!(
	gİtiÚs
.
	gdb
.
wr™e
(
wb
));

810 
	gbox_Œy
!(
check_key_š_»giÚ
(
keys
::
Üigš_key
(&
key
), &
İtiÚs
.
»giÚ
));

811 
	gb©ch_size
 +ğ
key
.
Ën
();

812 
Ët
 
	gv®ue
 = 
box_Œy
!(
decod”
.
decode_com·ù_by‹s
());

813 
	gb©ch_size
 +ğ
v®ue
.
Ën
();

814 
	gbox_Œy
!(
	gwb
.
put_cf
(
hªdË
, &
key
, &
v®ue
));

815 
	gb©ch_size
 >ğ
İtiÚs
.
wr™e_b©ch_size
 {

816 
box_Œy
!(
İtiÚs
.
db
.
wr™e
(
wb
));

817 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

818 
	gb©ch_size
 = 0;

821 
Ok
(())

824 
im¶
 
SÇpshÙ
 
	gSÇp
 {

825 
â
 
bud
(

826 &
mut
 
£lf
,

827 
¢­
: &
DbSÇpshÙ
,

828 
»giÚ
: &
RegiÚ
,

829 
¢­_d©a
: &
mut
 
RaáSÇpshÙD©a
,

830 
¡©
: &
mut
 
SÇpshÙSti¡ics
,

831 
d–‘”
: 
Box
<
SÇpshÙD–‘”
>,

832 è-> 
	gRaáStÜeResuÉ
<()> {

833 
Ët
 
	gt
 = 
In¡ªt
::
now
();

834 
	g£lf
.
do_bud
(
¢­
, 
»giÚ
, 
¡©
, 
d–‘”
)?;

836 
Ët
 
	gtÙ®_size
 = 
£lf
.
tÙ®_size
()?;

837 
	g¡©
.
	gsize
 = 
tÙ®_size
;

839 
	g¢­_d©a
.
£t_fe_size
(
tÙ®_size
);

840 
	g¢­_d©a
.
£t_v”siÚ
(
SNAPSHOT_VERSION
);

841 
	g¢­_d©a
.
£t_m‘a
(
£lf
.
m‘a_fe
.
m‘a
.
şÚe
());

843 
	gSNAPSHOT_BUILD_TIME_HISTOGRAM
.
ob£rve
(
du¿tiÚ_to_£c
(
t
.
–­£d
()è
as
 
f64
);

844 
	gšfo
!(

846 
	g»giÚ
.
g‘_id
(),

847 
	g£lf
.
·th
(),

848 
	gtÙ®_size
,

849 
	g¡©
.
	gkv_couÁ
,

850 
	gt
.
–­£d
()

853 
Ok
(())

856 
â
 
·th
(&
£lf
è-> &
	g¡r
 {

857 &
	g£lf
.
	gdi¥Ïy_·th


860 
â
 
exi¡s
(&
£lf
è-> 
	gboŞ
 {

861 
	g£lf
.
	gcf_fes


862 .
™”
()

863 .
®l
(|
cf_fe
| cf_fe.
size
 =ğ0 || 
fe_exi¡s
(&cf_fe.
·th
)) &&

864 
fe_exi¡s
(&
£lf
.
m‘a_fe
.
·th
)

867 
â
 
d–‘e
(&
£lf
) {

868 
	gdebug
!("d–‘šg {}", 
	g£lf
.
·th
());

869 
cf_fe
 
	gš
 &
	g£lf
.
	gcf_fes
 {

870 
d–‘e_fe_if_exi¡
(&
cf_fe
.
tmp_·th
);

871 
fe_exi¡s
(&
cf_fe
.
·th
) {

872 
Ët
 
mut
 
	gsize_Œack
 = 
£lf
.
size_Œack
.
wl
();

873 *
	gsize_Œack
 = 
size_Œack
.
§tu¿tšg_sub
(
cf_fe
.
size
);

875 
d–‘e_fe_if_exi¡
(&
cf_fe
.
·th
);

877 
d–‘e_fe_if_exi¡
(&
£lf
.
m‘a_fe
.
tmp_·th
);

878 
d–‘e_fe_if_exi¡
(&
£lf
.
m‘a_fe
.
·th
);

881 
â
 
m‘a
(&
£lf
è-> 
	gio
::
ResuÉ
<
M‘ad©a
> {

882 
fs
::
m‘ad©a
(&
£lf
.
m‘a_fe
.
·th
)

885 
â
 
tÙ®_size
(&
£lf
è-> 
io
::
ResuÉ
<
u64
> {

886 
Ok
(
£lf
.
cf_fes
.
™”
().
fŞd
(0, |
acc
, 
x
|‡cø+ x.
size
))

889 
â
 
§ve
(&
mut
 
£lf
è-> 
	gio
::
ResuÉ
<()> {

890 
debug
!("§všgØ{}", 
	g£lf
.
·th
());

891 
cf_fe
 
	gš
 &
mut
 
	g£lf
.
	gcf_fes
 {

892 
	gcf_fe
.
	gsize
 == 0 {

899 
Ët
 
mut
 
	gfe
 = 
cf_fe
.
fe
.
ke
().
unw¿p
();

900 
	gfe
.
æush
()?;

902 
	gcf_fe
.
	gwr™‹n_size
 !ğ
cf_fe
.
size
 {

903  
E¼
(
io
::
E¼Ü
::
Ãw
(

904 
E¼ÜKšd
::
Oth”
,

905 
fÜm©
!(

908 
cf_fe
.
·th
.
di¥Ïy
(),

909 
cf_fe
.
cf
,

910 
cf_fe
.
wr™‹n_size
,

911 
cf_fe
.
size


915 
Ët
 
	gchecksum
 = 
cf_fe
.
wr™e_dige¡
.
as_»f
().
unw¿p
().
sum32
();

916 
	gchecksum
 !ğ
cf_fe
.
checksum
 {

917  
E¼
(
io
::
E¼Ü
::
Ãw
(

918 
E¼ÜKšd
::
Oth”
,

919 
fÜm©
!(

923 
cf_fe
.
·th
.
di¥Ïy
(),

924 
cf_fe
.
cf
,

925 
checksum
,

926 
cf_fe
.
checksum


931 
	gfs
::
»Çme
(&
cf_fe
.
tmp_·th
, &cf_fe.
·th
)?;

932 
Ët
 
mut
 
	gsize_Œack
 = 
£lf
.
size_Œack
.
wl
();

933 *
	gsize_Œack
 = 
size_Œack
.
§tu¿tšg_add
(
cf_fe
.
size
);

936 
Ët
 
mut
 
	gv
 = 
vec
![];

937 
	g£lf
.
	gm‘a_fe
.
	gm‘a
.
wr™e_to_vec
(&
mut
 
v
)?;

938 
	g£lf
.
	gm‘a_fe
.
	gfe
.
ke
().
unw¿p
().
wr™e_®l
(&
v
[..])?;

939 
	gfs
::
»Çme
(&
£lf
.
m‘a_fe
.
tmp_·th
, &£lf.m‘a_fe.
·th
)?;

940 
Ok
(())

943 
â
 
­¶y
(&
mut
 
£lf
, 
İtiÚs
: 
AµlyO±iÚs
è-> 
ResuÉ
<()> {

944 
box_Œy
!(
£lf
.
v®id©e
());

946 
cf_fe
 
	gš
 &
mut
 
	g£lf
.
	gcf_fes
 {

947 
	gcf_fe
.
	gsize
 == 0 {

952 
check_abÜt
(&
İtiÚs
.
abÜt
)?;

953 
Ët
 
	gcf_hªdË
 = 
box_Œy
!(
rocksdb
::
g‘_cf_hªdË
(&
İtiÚs
.
db
, 
cf_fe
.
cf
));

954 
¶aš_fe_u£d
(
cf_fe
.
cf
) {

955 
Ët
 
mut
 
	gfe
 = 
box_Œy
!(
Fe
::
İ’
(&
cf_fe
.
·th
));

956 
­¶y_¶aš_cf_fe
(&
mut
 
fe
, &
İtiÚs
, 
cf_hªdË
)?;

958 
Ët
 
	gšge¡_İt
 = 
Inge¡Ex‹º®FeO±iÚs
::
Ãw
();

962 
Ët
 
	g·th
 = 
cf_fe
.
·th
.
as_·th
().
to_¡r
().
unw¿p
();

963 
	gbox_Œy
!(

964 
	gİtiÚs


965 .
	gdb


966 .
šge¡_ex‹º®_fe_cf
(
cf_hªdË
, &
šge¡_İt
, &[
·th
])

970 
Ok
(())

974 
im¶
 
R—d
 
	gSÇp
 {

975 
â
 
»ad
(&
mut
 
£lf
, 
buf
: &muˆ[
u8
]è-> 
io
::
ResuÉ
<
usize
> {

976 
buf
.
is_em±y
() {

977  
Ok
(0);

979 
	g£lf
.
	gcf_šdex
 < s–f.
	gcf_fes
.
Ën
() {

980 
Ët
 
	gcf_fe
 = &
mut
 
£lf
.
cf_fes
[£lf.
cf_šdex
];

981 
	gcf_fe
.
	gsize
 == 0 {

982 
£lf
.
cf_šdex
 += 1;

985 
m©ch
 
	gcf_fe
.
	gfe
.
as_mut
().
unw¿p
().
»ad
(
buf
) {

986 
Ok
(0) => {

988 
£lf
.
cf_šdex
 += 1;

990 
Ok
(
n
) => {

991  
Ok
(
n
);

993 
	ge
 =>  
e
,

996 
Ok
(0)

1000 
im¶
 
Wr™e
 
	gSÇp
 {

1001 
â
 
wr™e
(&
mut
 
£lf
, 
buf
: &[
u8
]è-> 
io
::
ResuÉ
<
usize
> {

1002 
buf
.
is_em±y
() {

1003  
Ok
(0);

1006 
Ët
 
mut
 
	gÃxt_buf
 = 
buf
;

1007 
	g£lf
.
	gcf_šdex
 < s–f.
	gcf_fes
.
Ën
() {

1008 
Ët
 
	gcf_fe
 = &
mut
 
£lf
.
cf_fes
[£lf.
cf_šdex
];

1009 
	gcf_fe
.
	gsize
 == 0 {

1010 
£lf
.
cf_šdex
 += 1;

1014 
Ët
 
	gËá
 = (
cf_fe
.
size
 - cf_fe.
wr™‹n_size
è
as
 
usize
;

1015 
	gËá
 == 0 {

1016 
£lf
.
cf_šdex
 += 1;

1020 
Ët
 
mut
 
	gfe
 = 
Lim™Wr™”
::
Ãw
(
£lf
.
lim™”
.
şÚe
(), 
cf_fe
.
fe
.
as_mut
().
unw¿p
());

1021 
Ët
 
	gdige¡
 = 
cf_fe
.
wr™e_dige¡
.
as_mut
().
unw¿p
();

1023 
	gÃxt_buf
.
Ën
(è> 
	gËá
 {

1024 
	gfe
.
wr™e_®l
(&
Ãxt_buf
[0..Ëf
t
])?;

1025 
	gdige¡
.
wr™e
(&
Ãxt_buf
[0..Ëf
t
]);

1026 
	gcf_fe
.
	gwr™‹n_size
 +ğ
Ëá
 
as
 
u64
;

1027 
	g£lf
.
	gcf_šdex
 += 1;

1028 
	gÃxt_buf
 = &
Ãxt_buf
[
Ëá
..];

1030 
	gfe
.
wr™e_®l
(
Ãxt_buf
)?;

1031 
	gdige¡
.
wr™e
(
Ãxt_buf
);

1032 
	gcf_fe
.
	gwr™‹n_size
 +ğ
Ãxt_buf
.
Ën
(è
as
 
u64
;

1033  
Ok
(
buf
.
Ën
());

1036 
Ët
 
	gn
 = 
buf
.
Ën
(è- 
Ãxt_buf
.len();

1037 
Ok
(
n
)

1040 
â
 
æush
(&
mut
 
£lf
è-> 
	gio
::
ResuÉ
<()> {

1041 
Ët
 
Some
(
cf_fe
èğ
£lf
.
cf_fes
.
g‘_mut
(£lf.
cf_šdex
) {

1042 
Ët
 
fe
 = 
cf_fe
.fe.
as_mut
().
unw¿p
();

1043 
	gfe
.
æush
()?;

1045 
Ok
(())

1049 
im¶
 
Drİ
 
	gSÇp
 {

1050 
â
 
drİ
(&
mut
 
£lf
) {

1052 
	g£lf
.
	gcf_fes


1053 .
™”
()

1054 .
ªy
(|
cf_fe
| 
fe_exi¡s
(&cf_fe.
tmp_·th
)) ||

1055 
fe_exi¡s
(&
£lf
.
m‘a_fe
.
tmp_·th
)

1057 
	g£lf
.
d–‘e
();

1061 !
	g£lf
.
exi¡s
() {

1062 
	g£lf
.
d–‘e
();

1068 #[
d”ive
(
P¬tŸlEq
, 
Debug
)]

1069 
pub
 
	eSÇpEÁry
 {

1070 
	mG’”©šg
 = 1,

1071 
	mS’dšg
 = 2,

1072 
	mReûivšg
 = 3,

1073 
	mAµlyšg
 = 4,

1077 
pub
 
	sSÇpSts
 {

1078 
pub
 
	m£ndšg_couÁ
: 
usize
,

1079 
pub
 
	m»ûivšg_couÁ
: 
usize
,

1082 
	sSÇpMªag”CÜe
 {

1083 
	mba£
: 
SŒšg
,

1084 
	m»gi¡ry
: 
HashM­
<
SÇpKey
, 
	mVec
<
	mSÇpEÁry
>>,

1086 
	m¢­_size
: 
Arc
<
RwLock
<
u64
>>,

1089 
â
 
nÙify_¡©s
(
ch
: 
O±iÚ
<&
S’dCh
<
Msg
>>) {

1090 
Ët
 
Some
(
ch
) = ch {

1091 
Ët
 
E¼
(
e
èğ
ch
.
Œy_£nd
(
Msg
::
SÇpshÙSts
) {

1092 
”rÜ
!("nÙify sÇpshÙ st çed {:?}", 
e
)

1098 #[
d”ive
(
ClÚe
)]

1099 
pub
 
	sSÇpMªag”
 {

1101 
	mcÜe
: 
Arc
<
RwLock
<
SÇpMªag”CÜe
>>,

1102 
	mch
: 
O±iÚ
<
S’dCh
<
Msg
>>,

1103 
	mlim™”
: 
O±iÚ
<
Arc
<
IOLim™”
>>,

1106 
im¶
 
	gSÇpMªag”
 {

1107 
pub
 
â
 
	gÃw
<
	gT
: 
IÁo
<
SŒšg
>>(

1108 
·th
: 
T
,

1109 
	gch
: 
O±iÚ
<
S’dCh
<
Msg
>>,

1110 
	glim™”
: 
O±iÚ
<
Arc
<
IOLim™”
>>,

1111 è-> 
	gSÇpMªag”
 {

1112 
	gSÇpMªag”
 {

1113 
	gcÜe
: 
Arc
::
Ãw
(
RwLock
::Ãw(
SÇpMªag”CÜe
 {

1114 
ba£
: 
·th
.
što
(),

1115 
»gi¡ry
: 
m­
![],

1116 
¢­_size
: 
Arc
::
Ãw
(
RwLock
::new(0)),

1118 
	gch
: 
ch
,

1119 
	glim™”
: 
lim™”
,

1123 
pub
 
â
 
š™
(&
£lf
è-> 
	gio
::
ResuÉ
<()> {

1125 
Ët
 
cÜe
 = 
£lf
.cÜe.
wl
();

1126 
Ët
 
	g·th
 = 
P©h
::
Ãw
(&
cÜe
.
ba£
);

1127 !
	g·th
.
exi¡s
() {

1128 
	gfs
::
ü—‹_dœ_®l
(
·th
)?;

1129  
Ok
(());

1131 !
	g·th
.
is_dœ
() {

1132  
E¼
(
io
::
E¼Ü
::
Ãw
(

1133 
E¼ÜKšd
::
Oth”
,

1134 
fÜm©
!("{} should b¨dœeùÜy", 
·th
.
di¥Ïy
()),

1137 
Ët
 
mut
 
	gsize
 = 
cÜe
.
¢­_size
.
wl
();

1138 
f
 
š
 
	gfs
::
»ad_dœ
(
·th
)? {

1139 
Ët
 
p
 = 
f
?;

1140 
	gp
.
fe_ty³
()?.
is_fe
() {

1141 
Ët
 
Some
(
s
èğ
p
.
fe_Çme
().
to_¡r
() {

1142 
s
.
’ds_w™h
(
TMP_FILE_SUFFIX
) {

1143 
fs
::
»move_fe
(
p
.
·th
())?;

1144 } 
	gs
.
’ds_w™h
(
SST_FILE_SUFFIX
) {

1145 
Ët
 
	gËn
 = 
p
.
m‘ad©a
()?.
Ën
();

1146 *
	gsize
 +ğ
Ën
;

1151 
Ok
(())

1155 
pub
 
â
 
li¡_idË_¢­
(&
£lf
è-> 
	gio
::
ResuÉ
<
Vec
<(
SÇpKey
, 
	gboŞ
)>> {

1156 
Ët
 
	gcÜe
 = 
£lf
.
cÜe
.
¾
();

1157 
Ët
 
	g·th
 = 
P©h
::
Ãw
(&
cÜe
.
ba£
);

1158 
Ët
 
	g»ad_dœ
 = 
fs
::
»ad_dœ
(
·th
)?;

1160 
Ët
 
mut
 
	gv
: 
Vec
<
_
> = 
»ad_dœ


1161 .
f‹r_m­
(|
p
| {

1162 
Ët
 
p
 = 
m©ch
… {

1163 
E¼
(
e
) => {

1164 
”rÜ
!("çedØli¡ cÚ‹Á oà{}: {:?}", 
cÜe
.
ba£
, 
e
);

1165  
NÚe
;

1167 
Ok
(
p
) =>…,

1169 
m©ch
 
p
.
fe_ty³
() {

1170 
Ok
(
t
èt.
is_fe
() => {}

1171 
_
 =>  
NÚe
,

1173 
Ët
 
fe_Çme
 = 
p
.file_name();

1174 
Ët
 
Çme
 = 
m©ch
 
fe_Çme
.
to_¡r
() {

1175 
NÚe
 =>  None,

1176 
Some
(
n
) =>‚,

1178 
Ët
 
is_£ndšg
 = 
Çme
.
¡¬ts_w™h
(
SNAP_GEN_PREFIX
);

1179 
Ët
 
numb”s
: 
Vec
<
u64
> = 
Çme
.
¥l™
('.').
Ãxt
().
m­_Ü_–£
(

1180 || 
vec
![],

1181 |
s
| {

1182 
s
.
¥l™
('_')

1183 .
sk
(1)

1184 .
f‹r_m­
(|
s
| s.
·r£
().
ok
())

1185 .
cŞËù
()

1188 
numb”s
.
Ën
() != 3 {

1189 
”rÜ
!("çedØ·r£ sÇpkey from {}", 
Çme
);

1190  
NÚe
;

1192 
Ët
 
¢­_key
 = 
SÇpKey
::
Ãw
(
numb”s
[0],‚umbers[1],‚umbers[2]);

1193 
cÜe
.
»gi¡ry
.
cÚšs_key
(&
¢­_key
) {

1195  
NÚe
;

1197 
Some
((
¢­_key
, 
is_£ndšg
))

1199 .
cŞËù
();

1200 
	gv
.
sÜt
();

1201 
	gv
.
dedup
();

1202 
Ok
(
v
)

1205 #[
šlše
]

1206 
pub
 
â
 
has_»gi¡”ed
(&
£lf
, 
key
: &
SÇpKey
è-> 
boŞ
 {

1207 
£lf
.
cÜe
.
¾
().
»gi¡ry
.
cÚšs_key
(
key
)

1210 
pub
 
â
 
g‘_¢­shÙ_fÜ_budšg
(

1211 &
£lf
,

1212 
key
: &
SÇpKey
,

1213 
¢­
: &
DbSÇpshÙ
,

1214 è-> 
	gRaáStÜeResuÉ
<
	gBox
<
	gSÇpshÙ
>> {

1215 
Ët
 (
dœ
, 
¢­_size
) = {

1216 
Ët
 
cÜe
 = 
£lf
.cÜe.
¾
();

1217 (
	gcÜe
.
	gba£
.
şÚe
(), cÜe.
	g¢­_size
.clone())

1219 
Ët
 
	gf
 = 
SÇp
::
Ãw_fÜ_budšg
(

1220 
dœ
,

1221 
key
,

1222 
¢­
,

1223 
¢­_size
,

1224 
Box
::
Ãw
(
£lf
.
şÚe
()),

1225 
£lf
.
lim™”
.
şÚe
(),

1227 
Ok
(
Box
::
Ãw
(
f
))

1230 
pub
 
â
 
g‘_¢­shÙ_fÜ_£ndšg
(&
£lf
, 
key
: &
SÇpKey
è-> 
RaáStÜeResuÉ
<
Box
<
SÇpshÙ
>> {

1231 
Ët
 
cÜe
 = 
£lf
.cÜe.
¾
();

1232 
Ët
 
	gs
 = 
SÇp
::
Ãw_fÜ_£ndšg
(

1233 &
cÜe
.
ba£
,

1234 
key
,

1235 
cÜe
.
¢­_size
.
şÚe
(),

1236 
Box
::
Ãw
(
£lf
.
şÚe
()),

1238 
Ok
(
Box
::
Ãw
(
s
))

1241 
pub
 
â
 
g‘_¢­shÙ_fÜ_»ûivšg
(

1242 &
£lf
,

1243 
key
: &
SÇpKey
,

1244 
d©a
: &[
u8
],

1245 è-> 
	gRaáStÜeResuÉ
<
	gBox
<
	gSÇpshÙ
>> {

1246 
Ët
 
	gcÜe
 = 
£lf
.
cÜe
.
¾
();

1247 
Ët
 
mut
 
	g¢­shÙ_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

1248 
	g¢­shÙ_d©a
.
m”ge_äom_by‹s
(
d©a
)?;

1249 
Ët
 
	gf
 = 
SÇp
::
Ãw_fÜ_»ûivšg
(

1250 &
cÜe
.
ba£
,

1251 
key
,

1252 
¢­shÙ_d©a
.
ke_m‘a
(),

1253 
cÜe
.
¢­_size
.
şÚe
(),

1254 
Box
::
Ãw
(
£lf
.
şÚe
()),

1255 
£lf
.
lim™”
.
şÚe
(),

1257 
Ok
(
Box
::
Ãw
(
f
))

1260 
pub
 
â
 
g‘_¢­shÙ_fÜ_­¶yšg
(&
£lf
, 
key
: &
SÇpKey
è-> 
RaáStÜeResuÉ
<
Box
<
SÇpshÙ
>> {

1261 
Ët
 
cÜe
 = 
£lf
.cÜe.
¾
();

1262 
Ët
 
	gs
 = 
SÇp
::
Ãw_fÜ_­¶yšg
(

1263 &
cÜe
.
ba£
,

1264 
key
,

1265 
cÜe
.
¢­_size
.
şÚe
(),

1266 
Box
::
Ãw
(
£lf
.
şÚe
()),

1268 !
	gs
.
exi¡s
() {

1269  
E¼
(
RaáStÜeE¼Ü
::
Oth”
(
From
::
äom
(

1270 
fÜm©
!("¢­shÙ oà{:?}‚Ùƒxi¡s.", 
key
).
to_¡ršg
(),

1273 
Ok
(
Box
::
Ãw
(
s
))

1279 #[
®low
(
Ët_ªd_»tuº
)]

1280 
pub
 
â
 
g‘_tÙ®_¢­_size
(&
£lf
è-> 
u64
 {

1281 
Ët
 
cÜe
 = 
£lf
.cÜe.
¾
();

1282 
Ët
 
	gsize
 = *
cÜe
.
¢­_size
.
¾
();

1283 
	gsize


1286 
pub
 
â
 (&
	g£lf
, 
	gkey
: 
SÇpKey
, 
	g’Œy
: 
SÇpEÁry
) {

1287 
debug
!("»gi¡” [key: {},ƒÁry: {:?}]", 
	gkey
, 
	g’Œy
);

1288 
Ët
 
mut
 
	gcÜe
 = 
£lf
.
cÜe
.
wl
();

1289 
m©ch
 
	gcÜe
.
	g»gi¡ry
.
’Œy
(
key
) {

1290 
	gEÁry
::
Occup›d
(
mut
 
e
) => {

1291 
e
.
g‘
().
cÚšs
(&
’Œy
) {

1292 
w¬n
!("{} i »gi¡”ed mÜthª 1ime!!!", 
e
.
key
());

1295 
	ge
.
g‘_mut
().
push
(
’Œy
);

1297 
	gEÁry
::
VaÿÁ
(
e
) => {

1298 
e
.
š£¹
(
vec
![
’Œy
]);

1302 
nÙify_¡©s
(
£lf
.
ch
.
as_»f
());

1305 
pub
 
â
 
d”egi¡”
(&
£lf
, 
key
: &
SÇpKey
, 
’Œy
: &
SÇpEÁry
) {

1306 
debug
!("d”egi¡” [key: {},ƒÁry: {:?}]", 
	gkey
, 
	g’Œy
);

1307 
Ët
 
mut
 
	gÃed_ş—n
 = 
çl£
;

1308 
Ët
 
mut
 
	ghªdËd
 = 
çl£
;

1309 
Ët
 
mut
 
	gcÜe
 = 
£lf
.
cÜe
.
wl
();

1310 
Ët
 
Some
(
e
èğ
cÜe
.
»gi¡ry
.
g‘_mut
(
key
) {

1311 
Ët
 
Ï¡_Ën
 = 
e
.
Ën
();

1312 
	ge
.
»š
(|
e
|ƒ !ğ
’Œy
);

1313 
	gÃed_ş—n
 = 
e
.
is_em±y
();

1314 
	ghªdËd
 = 
Ï¡_Ën
 > 
e
.
Ën
();

1316 
	gÃed_ş—n
 {

1317 
	gcÜe
.
	g»gi¡ry
.
»move
(
key
);

1319 
	ghªdËd
 {

1320 
nÙify_¡©s
(
£lf
.
ch
.
as_»f
());

1323 
	gw¬n
!("¡®d”egi¡” key: {} {:?}", 
	gkey
, 
	g’Œy
);

1326 
pub
 
â
 
¡©s
(&
£lf
è-> 
	gSÇpSts
 {

1327 
Ët
 
	gcÜe
 = 
£lf
.
cÜe
.
¾
();

1329 
Ët
 (
mut
 
£ndšg_út
, muˆ
»ûivšg_út
) = (0, 0);

1330 
v
 
š
 
	gcÜe
.
	g»gi¡ry
.
v®ues
() {

1331 
Ët
 (
mut
 
is_£ndšg
, muˆ
is_»ûivšg
èğ(
çl£
, 
	gçl£
);

1332 
s
 
š
 
	gv
 {

1333 
m©ch
 *
	gs
 {

1334 
	gSÇpEÁry
::
S’dšg
 | 
SÇpEÁry
::
G’”©šg
 => 
is_£ndšg
 = 
Œue
,

1335 
	gSÇpEÁry
::
Reûivšg
 | 
SÇpEÁry
::
Aµlyšg
 => 
is_»ûivšg
 = 
Œue
,

1338 
	gis_£ndšg
 {

1339 
	g£ndšg_út
 += 1;

1341 
	gis_»ûivšg
 {

1342 
	g»ûivšg_út
 += 1;

1346 
	gSÇpSts
 {

1347 
	g£ndšg_couÁ
: 
£ndšg_út
,

1348 
	g»ûivšg_couÁ
: 
»ûivšg_út
,

1353 
im¶
 
SÇpshÙD–‘”
 
	gSÇpMªag”
 {

1354 
â
 
d–‘e_¢­shÙ
(&
£lf
, 
key
: &
SÇpKey
, 
¢­
: &
SÇpshÙ
, 
check_’Œy
: 
boŞ
) -> bool {

1355 
Ët
 
cÜe
 = 
£lf
.cÜe.
¾
();

1356 
	gcheck_’Œy
 {

1357 
Ët
 
Some
(
e
èğ
cÜe
.
»gi¡ry
.
g‘
(
key
) {

1358 
e
.
Ën
() > 1 {

1359 
šfo
!(

1362 
¢­
.
·th
(),

1363 
e


1365  
	gçl£
;

1368 } 
	gcÜe
.
	g»gi¡ry
.
cÚšs_key
(
key
) {

1369 
	gšfo
!("skØd–‘{} sšû it' »gi¡”ed", 
	g¢­
.
·th
());

1370  
	gçl£
;

1372 
	g¢­
.
d–‘e
();

1373 
	gŒue


1377 #[
cfg
(
‹¡
)]

1378 
mod
 
	g‹¡
 {

1379 
u£
 
	g¡d
::
io
::{
£lf
, 
	gR—d
, 
	gS“k
, 
	gS“kFrom
, 
	gWr™e
};

1380 
u£
 
	g¡d
::
fs
::{
£lf
, 
	gFe
, 
	gO³nO±iÚs
};

1381 
u£
 
	g¡d
::
sync
::*;

1382 
u£
 
	g¡d
::
sync
::
©omic
::
AtomicUsize
;

1383 
u£
 
	g¡d
::
sync
::
Arc
;

1384 
u£
 
	g‹mpdœ
::
TempDœ
;

1385 
u£
 
	g´Ùobuf
::
Mes§ge
;

1387 
u£
 
	gsu³r
::{
AµlyO±iÚs
, 
	gSÇp
, 
	gSÇpEÁry
, 
	gSÇpKey
, 
	gSÇpMªag”
, 
	gSÇpshÙ
, 
	gSÇpshÙD–‘”
,

1388 
	gSÇpshÙSti¡ics
, 
	gMETA_FILE_SUFFIX
, 
	gSNAPSHOT_CFS
, 
	gSNAP_GEN_PREFIX
};

1390 
u£
 
	g¡d
::
·th
::
P©hBuf
;

1391 
u£
 
	gkv´Ùo
::
m‘­b
::{
P“r
, 
	gRegiÚ
};

1392 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
RaáSÇpshÙD©a
, 
	gSÇpshÙM‘a
};

1393 
u£
 
	grocksdb
::
DB
;

1395 
u£
 
	g¡Üage
::{
ALL_CFS
, 
	gCF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_RAFT
, 
	gCF_WRITE
};

1396 
u£
 
	gut
::{
rocksdb
, 
	gHªdyRwLock
};

1397 
u£
 
	g¿á¡Üe
::
ResuÉ
;

1398 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
;

1399 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::{
I‹¿bË
, 
	gMubË
, 
	gP“kabË
, 
SÇpshÙ
 
as
 
	gDbSÇpshÙ
};

1400 
u£
 
	g¿á¡Üe
::
¡Üe
::
³”_¡Üage
::
JOB_STATUS_RUNNING
;

1402 cÚ¡ 
	gTEST_STORE_ID
: 
u64
 = 1;

1403 cÚ¡ 
	gTEST_KEY
: &[
u8
] = 
b
"akey";

1404 cÚ¡ 
	gTEST_WRITE_BATCH_SIZE
: 
usize
 = 10 * 1024 * 1024;

1405 cÚ¡ 
	gTEST_META_FILE_BUFFER_SIZE
: 
usize
 = 1000;

1406 cÚ¡ 
	gBYTE_SIZE
: 
usize
 = 1;

1408 #[
d”ive
(
ClÚe
)]

1409 
	gDummyD–‘”
;

1411 
im¶
 
SÇpshÙD–‘”
 
	gDummyD–‘”
 {

1412 
â
 
d–‘e_¢­shÙ
(&
£lf
, 
_
: &
SÇpKey
, 
¢­
: &
SÇpshÙ
, _: 
boŞ
) -> bool {

1413 
¢­
.
d–‘e
();

1414 
	gŒue


1418 
pub
 
â
 
g‘_‹¡_em±y_db
(
·th
: &
TempDœ
è-> 
ResuÉ
<
Arc
<
DB
>> {

1419 
Ët
 
p
 = 
·th
.·th().
to_¡r
().
unw¿p
();

1420 
Ët
 
	gdb
 = 
rocksdb
::
Ãw_’gše
(
p
, 
ALL_CFS
)?;

1421 
Ok
(
Arc
::
Ãw
(
db
))

1424 
pub
 
â
 
g‘_‹¡_db
(
·th
: &
TempDœ
è-> 
ResuÉ
<
Arc
<
DB
>> {

1425 
Ët
 
p
 = 
·th
.·th().
to_¡r
().
unw¿p
();

1426 
Ët
 
	gdb
 = 
rocksdb
::
Ãw_’gše
(
p
, 
ALL_CFS
)?;

1427 
Ët
 
	gkey
 = 
keys
::
d©a_key
(
TEST_KEY
);

1429 
	gi
, 
	gcf
è
š
 
	gALL_CFS
.
™”
().
’um”©e
() {

1430 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(&
db
, 
cf
)?;

1431 
Ët
 
mut
 
	gp
 = 
P“r
::
Ãw
();

1432 
	gp
.
£t_¡Üe_id
(
TEST_STORE_ID
);

1433 
	gp
.
£t_id
((
i
 + 1è
as
 
u64
);

1434 
	gdb
.
put_msg_cf
(
hªdË
, &
key
[..], &
p
)?;

1436 
Ok
(
Arc
::
Ãw
(
db
))

1439 
pub
 
â
 
g‘_kv_couÁ
(
¢­
: &
DbSÇpshÙ
è-> 
usize
 {

1440 
Ët
 
mut
 
kv_couÁ
 = 0;

1441 
cf
 
š
 
	gSNAPSHOT_CFS
 {

1442 
	g¢­
.
sÿn_cf
(

1443 
cf
,

1444 &
keys
::
d©a_key
(
b
"a"),

1445 &
keys
::
d©a_key
(
b
"z"),

1446 
çl£
,

1447 &
mut
 |
_
, _| {

1448 
kv_couÁ
 += 1;

1449 
Ok
(
Œue
)

1451 ).
unw¿p
();

1453 
	gkv_couÁ


1456 
pub
 
â
 
g‘_‹¡_»giÚ
(
»giÚ_id
: 
u64
, 
¡Üe_id
: u64, 
³”_id
: u64è-> 
RegiÚ
 {

1457 
Ët
 
mut
 
³”
 = 
P“r
::
Ãw
();

1458 
	g³”
.
£t_¡Üe_id
(
¡Üe_id
);

1459 
	g³”
.
£t_id
(
³”_id
);

1460 
Ët
 
mut
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

1461 
	g»giÚ
.
£t_id
(
»giÚ_id
);

1462 
	g»giÚ
.
£t_¡¬t_key
(
b
"a".
to_vec
());

1463 
	g»giÚ
.
£t_’d_key
(
b
"z".
to_vec
());

1464 
	g»giÚ
.
mut_»giÚ_•och
().
£t_v”siÚ
(1);

1465 
	g»giÚ
.
mut_»giÚ_•och
().
£t_cÚf_v”
(1);

1466 
	g»giÚ
.
mut_³”s
().
push
(
³”
.
şÚe
());

1467 
	g»giÚ


1470 
pub
 
â
 
as£¹_eq_db
(
ex³ùed_db
: 
Arc
<
DB
>, 
db
: &DB) {

1471 
Ët
 
key
 = 
keys
::
d©a_key
(
TEST_KEY
);

1472 
cf
 
š
 
	gSNAPSHOT_CFS
 {

1473 
Ët
 
	gp1
: 
O±iÚ
<
P“r
> = 
ex³ùed_db
.
g‘_msg_cf
(
cf
, &
key
[..]).
unw¿p
();

1474 
	gp1
.
is_some
() {

1475 
Ët
 
	gp2
: 
O±iÚ
<
P“r
> = 
db
.
g‘_msg_cf
(
cf
, &
key
[..]).
unw¿p
();

1476 !
	gp2
.
is_some
() {

1477 
	g·nic
!("cà{}:ƒx³ù key {:?} ha v®ue", 
	gcf
, 
	gkey
);

1479 
Ët
 
	gp1
 = 
p1
.
unw¿p
();

1480 
Ët
 
	gp2
 = 
p2
.
unw¿p
();

1481 
	gp2
 !ğ
p1
 {

1482 
·nic
!(

1484 
cf
,

1485 
key
,

1486 
p2
,

1487 
p1


1494 #[
‹¡
]

1495 
â
 
‹¡_g’_¢­shÙ_m‘a
() {

1496 
Ët
 
mut
 
	gcf_fe
 = 
Vec
::
w™h_ÿ·c™y
(
su³r
::
SNAPSHOT_CFS
.
Ën
());

1497 
	gi
, 
	gcf
è
š
 
	gsu³r
::
SNAPSHOT_CFS
.
™”
().
’um”©e
() {

1498 
Ët
 
f
 = 
su³r
::
CfFe
 {

1499 
cf
: cf,

1500 
size
: 100 * (
i
 + 1è
as
 
u64
,

1501 
checksum
: 1000 * (
i
 + 1è
as
 
u32
,

1502 ..
DeçuÉ
::()

1504 
	gcf_fe
.
push
(
f
);

1506 
Ët
 
	gm‘a
 = 
su³r
::
g’_¢­shÙ_m‘a
(&
cf_fe
).
unw¿p
();

1507 
	gi
, 
	gcf_fe_m‘a
è
š
 
	gm‘a
.
g‘_cf_fes
().
™”
().
’um”©e
() {

1508 
	gcf_fe_m‘a
.
g‘_cf
(è!ğ
cf_fe
[
i
].
cf
 {

1509 
·nic
!(

1511 
i
,

1512 
cf_fe
[
i
].
cf
,

1513 
cf_fe_m‘a
.
g‘_cf
()

1516 
	gcf_fe_m‘a
.
g‘_size
(è!ğ
cf_fe
[
i
].
size
 {

1517 
·nic
!(

1519 
i
,

1520 
cf_fe
[
i
].
size
,

1521 
cf_fe_m‘a
.
g‘_size
()

1524 
	gcf_fe_m‘a
.
g‘_checksum
(è!ğ
cf_fe
[
i
].
checksum
 {

1525 
·nic
!(

1527 
i
,

1528 
cf_fe
[
i
].
checksum
,

1529 
cf_fe_m‘a
.
g‘_checksum
()

1535 #[
‹¡
]

1536 
â
 
‹¡_di¥Ïy_·th
() {

1537 
Ët
 
	gdœ
 = 
TempDœ
::
Ãw
("‹¡-di¥Ïy-·th").
unw¿p
();

1538 
Ët
 
	gkey
 = 
SÇpKey
::
Ãw
(1, 1, 1);

1539 
Ët
 
	g´efix
 = 
fÜm©
!("{}_{}", 
	gSNAP_GEN_PREFIX
, 
	gkey
);

1540 
Ët
 
	gdi¥Ïy_·th
 = 
SÇp
::
g‘_di¥Ïy_·th
(&
dœ
.
što_·th
(), &
´efix
);

1541 
	gas£¹_Ã
!(
	gdi¥Ïy_·th
, "");

1544 #[
‹¡
]

1545 
â
 
‹¡_em±y_¢­_fe
() {

1546 
‹¡_¢­_fe
(
g‘_‹¡_em±y_db
);

1549 #[
‹¡
]

1550 
â
 
‹¡_nÚ_em±y_¢­_fe
() {

1551 
‹¡_¢­_fe
(
g‘_‹¡_db
);

1554 
â
 
‹¡_¢­_fe
(
g‘_db
: fn(
p
: &
TempDœ
è-> 
ResuÉ
<
Arc
<
DB
>>) {

1555 
Ët
 
»giÚ_id
 = 1;

1556 
Ët
 
	g»giÚ
 = 
g‘_‹¡_»giÚ
(
»giÚ_id
, 1, 1);

1557 
Ët
 
	g¤c_db_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-fe-db-¤c").
unw¿p
();

1558 
Ët
 
	gdb
 = 
g‘_db
(&
¤c_db_dœ
).
unw¿p
();

1559 
Ët
 
	g¢­shÙ
 = 
DbSÇpshÙ
::
Ãw
(
db
.
şÚe
());

1561 
Ët
 
	g¤c_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-fe-¤c").
unw¿p
();

1562 
Ët
 
	gkey
 = 
SÇpKey
::
Ãw
(
»giÚ_id
, 1, 1);

1563 
Ët
 
	gsize_Œack
 = 
Arc
::
Ãw
(
RwLock
::new(0));

1564 
Ët
 
	gd–‘”
 = 
Box
::
Ãw
(
DummyD–‘”
 {});

1565 
Ët
 
mut
 
	gs1
 = 
SÇp
::
Ãw_fÜ_budšg
(

1566 
¤c_dœ
.
·th
(),

1567 &
key
,

1568 &
¢­shÙ
,

1569 
size_Œack
.
şÚe
(),

1570 
d–‘”
.
şÚe
(),

1571 
NÚe
,

1572 ).
unw¿p
();

1574 
	gas£¹
!(!
	gs1
.
exi¡s
());

1575 
	gas£¹_eq
!(*
	gsize_Œack
.
¾
(), 0);

1577 
Ët
 
mut
 
	g¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

1578 
	g¢­_d©a
.
£t_»giÚ
(
»giÚ
.
şÚe
());

1579 
Ët
 
mut
 
	g¡©
 = 
SÇpshÙSti¡ics
::
Ãw
();

1580 
	gs1
.
bud
(

1581 &
¢­shÙ
,

1582 &
»giÚ
,

1583 &
mut
 
¢­_d©a
,

1584 &
mut
 
¡©
,

1585 
d–‘”
.
şÚe
(),

1586 ).
unw¿p
();

1589 
	gas£¹
!(
	gs1
.
exi¡s
());

1590 
Ët
 
	gtÙ®_size
 = 
s1
.
tÙ®_size
().
unw¿p
();

1592 
Ët
 
	gsize
 = *
size_Œack
.
¾
();

1593 
	gas£¹_eq
!(
	gsize
, 
	gtÙ®_size
);

1594 
	gas£¹_eq
!(
	g¡©
.
size
 
as
 
	gu64
, 
	gsize
);

1595 
	gas£¹_eq
!(
	g¡©
.
	gkv_couÁ
, 
g‘_kv_couÁ
(&
¢­shÙ
));

1598 
Ët
 
mut
 
	gs2
 =

1599 
SÇp
::
Ãw_fÜ_£ndšg
(
¤c_dœ
.
·th
(), &
key
, 
size_Œack
.
şÚe
(), 
d–‘”
.clone())

1600 .
unw¿p
();

1601 
	gas£¹
!(
	gs2
.
exi¡s
());

1604 
Ët
 
	g_
 = 
s2
.
m‘a
().
unw¿p
();

1606 
Ët
 
	gd¡_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-fe-d¡").
unw¿p
();

1608 
Ët
 
mut
 
	gs3
 = 
SÇp
::
Ãw_fÜ_»ûivšg
(

1609 
d¡_dœ
.
·th
(),

1610 &
key
,

1611 
¢­_d©a
.
ke_m‘a
(),

1612 
size_Œack
.
şÚe
(),

1613 
d–‘”
.
şÚe
(),

1614 
NÚe
,

1615 ).
unw¿p
();

1616 
	gas£¹
!(!
	gs3
.
exi¡s
());

1619 
Ët
 
	gcİy_size
 = 
io
::
cİy
(&
mut
 
s2
, &muˆ
s3
).
unw¿p
();

1620 
	gas£¹_eq
!(
	gcİy_size
, 
	gsize
);

1621 
	gas£¹
!(!
	gs3
.
exi¡s
());

1622 
	gs3
.
§ve
().
unw¿p
();

1623 
	gas£¹
!(
	gs3
.
exi¡s
());

1626 
	gas£¹_eq
!(*
	gsize_Œack
.
¾
(), 
	gsize
 * 2);

1629 
	gs2
.
d–‘e
();

1630 
	gas£¹
!(!
	gs2
.
exi¡s
());

1631 
	gas£¹
!(!
	gs1
.
exi¡s
());

1632 
	gas£¹_eq
!(*
	gsize_Œack
.
¾
(), 
	gsize
);

1635 
Ët
 
mut
 
	gs4
 =

1636 
SÇp
::
Ãw_fÜ_­¶yšg
(
d¡_dœ
.
·th
(), &
key
, 
size_Œack
.
şÚe
(), 
d–‘”
).
unw¿p
();

1637 
	gas£¹
!(
	gs4
.
exi¡s
());

1639 
Ët
 
	gd¡_db_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-fe-db-d¡").
unw¿p
();

1640 
Ët
 
	gd¡_db_·th
 = 
d¡_db_dœ
.
·th
().
to_¡r
().
unw¿p
();

1642 
Ët
 
	gd¡_cfs
 = [
CF_WRITE
, 
CF_DEFAULT
, 
CF_LOCK
, 
CF_RAFT
];

1643 
Ët
 
	gd¡_db
 = 
Arc
::
Ãw
(
rocksdb
::
Ãw_’gše
(
d¡_db_·th
, &
d¡_cfs
).
unw¿p
());

1644 
Ët
 
	gİtiÚs
 = 
AµlyO±iÚs
 {

1645 
db
: 
d¡_db
.
şÚe
(),

1646 
»giÚ
:„egiÚ.
şÚe
(),

1647 
abÜt
: 
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_RUNNING
)),

1648 
wr™e_b©ch_size
: 
TEST_WRITE_BATCH_SIZE
,

1651 
	gas£¹
!(
	gs4
.
­¶y
(
İtiÚs
).
is_ok
());

1654 
	gs4
.
d–‘e
();

1655 
	gas£¹
!(!
	gs4
.
exi¡s
());

1656 
	gas£¹
!(!
	gs3
.
exi¡s
());

1657 
	gas£¹_eq
!(*
	gsize_Œack
.
¾
(), 0);

1660 
as£¹_eq_db
(
db
, 
d¡_db
.
as_»f
());

1663 #[
‹¡
]

1664 
â
 
‹¡_em±y_¢­_v®id©iÚ
() {

1665 
‹¡_¢­_v®id©iÚ
(
g‘_‹¡_em±y_db
);

1668 #[
‹¡
]

1669 
â
 
‹¡_nÚ_em±y_¢­_v®id©iÚ
() {

1670 
‹¡_¢­_v®id©iÚ
(
g‘_‹¡_db
);

1673 
â
 
‹¡_¢­_v®id©iÚ
(
g‘_db
: fn(
p
: &
TempDœ
è-> 
ResuÉ
<
Arc
<
DB
>>) {

1674 
Ët
 
»giÚ_id
 = 1;

1675 
Ët
 
	g»giÚ
 = 
g‘_‹¡_»giÚ
(
»giÚ_id
, 1, 1);

1676 
Ët
 
	gdb_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-v®id©iÚ-db").
unw¿p
();

1677 
Ët
 
	gdb
 = 
g‘_db
(&
db_dœ
).
unw¿p
();

1678 
Ët
 
	g¢­shÙ
 = 
DbSÇpshÙ
::
Ãw
(
db
.
şÚe
());

1680 
Ët
 
	gdœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-v®id©iÚ").
unw¿p
();

1681 
Ët
 
	gkey
 = 
SÇpKey
::
Ãw
(
»giÚ_id
, 1, 1);

1682 
Ët
 
	gsize_Œack
 = 
Arc
::
Ãw
(
RwLock
::new(0));

1683 
Ët
 
	gd–‘”
 = 
Box
::
Ãw
(
DummyD–‘”
 {});

1684 
Ët
 
mut
 
	gs1
 = 
SÇp
::
Ãw_fÜ_budšg
(

1685 
dœ
.
·th
(),

1686 &
key
,

1687 &
¢­shÙ
,

1688 
size_Œack
.
şÚe
(),

1689 
d–‘”
.
şÚe
(),

1690 
NÚe
,

1691 ).
unw¿p
();

1692 
	gas£¹
!(!
	gs1
.
exi¡s
());

1694 
Ët
 
mut
 
	g¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

1695 
	g¢­_d©a
.
£t_»giÚ
(
»giÚ
.
şÚe
());

1696 
Ët
 
mut
 
	g¡©
 = 
SÇpshÙSti¡ics
::
Ãw
();

1697 
	gs1
.
bud
(

1698 &
¢­shÙ
,

1699 &
»giÚ
,

1700 &
mut
 
¢­_d©a
,

1701 &
mut
 
¡©
,

1702 
d–‘”
.
şÚe
(),

1703 ).
unw¿p
();

1704 
	gas£¹
!(
	gs1
.
exi¡s
());

1706 
Ët
 
mut
 
	gs2
 = 
SÇp
::
Ãw_fÜ_budšg
(

1707 
dœ
.
·th
(),

1708 &
key
,

1709 &
¢­shÙ
,

1710 
size_Œack
.
şÚe
(),

1711 
d–‘”
.
şÚe
(),

1712 
NÚe
,

1713 ).
unw¿p
();

1714 
	gas£¹
!(
	gs2
.
exi¡s
());

1716 
	gs2
.
bud
(&
¢­shÙ
, &
»giÚ
, &
mut
 
¢­_d©a
, &muˆ
¡©
, 
d–‘”
)

1717 .
unw¿p
();

1718 
	gas£¹
!(
	gs2
.
exi¡s
());

1722 
â
 
	gcÜru±_¢­shÙ_size_š
<
	gT
: 
IÁo
<
P©hBuf
>>(
dœ
: 
T
) {

1723 
Ët
 
dœ_·th
 = 
dœ
.
što
();

1724 
Ët
 
	g»ad_dœ
 = 
fs
::
»ad_dœ
(
dœ_·th
).
unw¿p
();

1725 
p
 
š
 
	g»ad_dœ
 {

1726 
	gp
.
is_ok
() {

1727 
Ët
 
	ge
 = 
p
.
as_»f
().
unw¿p
();

1728 !
	ge
.
fe_Çme
()

1729 .
što_¡ršg
()

1730 .
unw¿p
()

1731 .
’ds_w™h
(
META_FILE_SUFFIX
)

1733 
Ët
 
mut
 
	gf
 = 
O³nO±iÚs
::
Ãw
().
­³nd
(
Œue
).
İ’
(
e
.
·th
()).
unw¿p
();

1734 
	gf
.
wr™e_®l
(
b
"xxxxx").
unw¿p
();

1741 
â
 
	gcÜru±_¢­shÙ_checksum_š
<
	gT
: 
IÁo
<
P©hBuf
>>(
dœ
: 
T
è-> 
Vec
<
SÇpshÙM‘a
> {

1742 
Ët
 
dœ_·th
 = 
dœ
.
što
();

1743 
Ët
 
mut
 
	g»s
 = 
Vec
::
Ãw
();

1744 
Ët
 
	g»ad_dœ
 = 
fs
::
»ad_dœ
(
dœ_·th
).
unw¿p
();

1745 
p
 
š
 
	g»ad_dœ
 {

1746 
	gp
.
is_ok
() {

1747 
Ët
 
	ge
 = 
p
.
as_»f
().
unw¿p
();

1748 
	ge
.
fe_Çme
()

1749 .
što_¡ršg
()

1750 .
unw¿p
()

1751 .
’ds_w™h
(
META_FILE_SUFFIX
)

1753 
Ët
 
mut
 
	g¢­shÙ_m‘a
 = 
SÇpshÙM‘a
::
Ãw
();

1754 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(
TEST_META_FILE_BUFFER_SIZE
);

1756 
Ët
 
mut
 
	gf
 = 
O³nO±iÚs
::
Ãw
().
»ad
(
Œue
).
İ’
(
e
.
·th
()).
unw¿p
();

1757 
	gf
.
»ad_to_’d
(&
mut
 
buf
).
unw¿p
();

1760 
	g¢­shÙ_m‘a
.
m”ge_äom_by‹s
(&
buf
).
unw¿p
();

1762 
cf
 
š
 
	g¢­shÙ_m‘a
.
mut_cf_fes
().
™”_mut
() {

1763 
Ët
 
	gcÜru±ed_checksum
 = 
cf
.
g‘_checksum
() + 100;

1764 
	gcf
.
£t_checksum
(
cÜru±ed_checksum
);

1767 
	gbuf
.
ş—r
();

1768 
	g¢­shÙ_m‘a
.
wr™e_to_vec
(&
mut
 
buf
).
unw¿p
();

1770 
Ët
 
mut
 
	gf
 = 
O³nO±iÚs
::
Ãw
()

1771 .
wr™e
(
Œue
)

1772 .
Œunÿ‹
(
Œue
)

1773 .
İ’
(
e
.
·th
())

1774 .
unw¿p
();

1775 
	gf
.
wr™e_®l
(&
buf
[..]).
unw¿p
();

1776 
	gf
.
æush
().
unw¿p
();

1779 
	g»s
.
push
(
¢­shÙ_m‘a
);

1783 
	g»s


1787 
â
 
	gcÜru±_¢­shÙ_m‘a_fe
<
	gT
: 
IÁo
<
P©hBuf
>>(
dœ
: 
T
è-> 
usize
 {

1788 
Ët
 
mut
 
tÙ®
 = 0;

1789 
Ët
 
	gdœ_·th
 = 
dœ
.
što
();

1790 
Ët
 
	g»ad_dœ
 = 
fs
::
»ad_dœ
(
dœ_·th
).
unw¿p
();

1791 
p
 
š
 
	g»ad_dœ
 {

1792 
	gp
.
is_ok
() {

1793 
Ët
 
	ge
 = 
p
.
as_»f
().
unw¿p
();

1794 
	ge
.
fe_Çme
()

1795 .
što_¡ršg
()

1796 .
unw¿p
()

1797 .
’ds_w™h
(
META_FILE_SUFFIX
)

1799 
Ët
 
mut
 
	gf
 = 
O³nO±iÚs
::
Ãw
()

1800 .
»ad
(
Œue
)

1801 .
wr™e
(
Œue
)

1802 .
İ’
(
e
.
·th
())

1803 .
unw¿p
();

1806 
Ët
 
	gpos
 = 
S“kFrom
::
End
(-(
BYTE_SIZE
 
as
 
i64
));

1807 
	gf
.
£ek
(
pos
).
unw¿p
();

1808 
Ët
 
mut
 
	gbuf
 = [0; 
BYTE_SIZE
];

1809 
	gf
.
»ad_exaù
(&
mut
 
buf
[..]).
unw¿p
();

1810 
	gbuf
[0] ^ğ
u8
::
max_v®ue
();

1811 
	gf
.
£ek
(
pos
).
unw¿p
();

1812 
	gf
.
wr™e_®l
(&
buf
[..]).
unw¿p
();

1813 
	gtÙ®
 += 1;

1817 
	gtÙ®


1820 
â
 
cİy_¢­shÙ
(

1821 
äom_dœ
: &
TempDœ
,

1822 
to_dœ
: &
TempDœ
,

1823 
key
: &
SÇpKey
,

1824 
size_Œack
: 
Arc
<
RwLock
<
u64
>>,

1825 
¢­shÙ_m‘a
: 
SÇpshÙM‘a
,

1826 
d–‘”
: 
Box
<
DummyD–‘”
>,

1828 
Ët
 
mut
 
	gäom
 =

1829 
SÇp
::
Ãw_fÜ_£ndšg
(
äom_dœ
.
·th
(), 
key
, 
size_Œack
.
şÚe
(), 
d–‘”
.clone())

1830 .
unw¿p
();

1831 
	gas£¹
!(
	gäom
.
exi¡s
());

1833 
Ët
 
mut
 
	gto
 = 
SÇp
::
Ãw_fÜ_»ûivšg
(

1834 
to_dœ
.
·th
(),

1835 
key
,

1836 
¢­shÙ_m‘a
,

1837 
size_Œack
.
şÚe
(),

1838 
d–‘”
,

1839 
NÚe
,

1840 ).
unw¿p
();

1842 
	gas£¹
!(!
	gto
.
exi¡s
());

1843 
Ët
 
	g_
 = 
io
::
cİy
(&
mut
 
äom
, &muˆ
to
).
unw¿p
();

1844 
	gto
.
§ve
().
unw¿p
();

1845 
	gas£¹
!(
	gto
.
exi¡s
());

1848 #[
‹¡
]

1849 
â
 
‹¡_¢­_cÜru±iÚ_Ú_size_Ü_checksum
() {

1850 
Ët
 
	g»giÚ_id
 = 1;

1851 
Ët
 
	g»giÚ
 = 
g‘_‹¡_»giÚ
(
»giÚ_id
, 1, 1);

1852 
Ët
 
	gdb_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-cÜru±iÚ-db").
unw¿p
();

1853 
Ët
 
	gdb
 = 
g‘_‹¡_db
(&
db_dœ
).
unw¿p
();

1854 
Ët
 
	g¢­shÙ
 = 
DbSÇpshÙ
::
Ãw
(
db
);

1856 
Ët
 
	gdœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-cÜru±iÚ").
unw¿p
();

1857 
Ët
 
	gkey
 = 
SÇpKey
::
Ãw
(
»giÚ_id
, 1, 1);

1858 
Ët
 
	gsize_Œack
 = 
Arc
::
Ãw
(
RwLock
::new(0));

1859 
Ët
 
	gd–‘”
 = 
Box
::
Ãw
(
DummyD–‘”
 {});

1860 
Ët
 
mut
 
	gs1
 = 
SÇp
::
Ãw_fÜ_budšg
(

1861 
dœ
.
·th
(),

1862 &
key
,

1863 &
¢­shÙ
,

1864 
size_Œack
.
şÚe
(),

1865 
d–‘”
.
şÚe
(),

1866 
NÚe
,

1867 ).
unw¿p
();

1868 
	gas£¹
!(!
	gs1
.
exi¡s
());

1870 
Ët
 
mut
 
	g¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

1871 
	g¢­_d©a
.
£t_»giÚ
(
»giÚ
.
şÚe
());

1872 
Ët
 
mut
 
	g¡©
 = 
SÇpshÙSti¡ics
::
Ãw
();

1873 
	gs1
.
bud
(

1874 &
¢­shÙ
,

1875 &
»giÚ
,

1876 &
mut
 
¢­_d©a
,

1877 &
mut
 
¡©
,

1878 
d–‘”
.
şÚe
(),

1879 ).
unw¿p
();

1880 
	gas£¹
!(
	gs1
.
exi¡s
());

1882 
cÜru±_¢­shÙ_size_š
(
dœ
.
·th
());

1884 
	gas£¹
!(

1885 
	gSÇp
::
Ãw_fÜ_£ndšg
(
dœ
.
·th
(), &
key
, 
size_Œack
.
şÚe
(), 
d–‘”
.şÚe()).
is_”r
()

1888 
Ët
 
mut
 
	gs2
 = 
SÇp
::
Ãw_fÜ_budšg
(

1889 
dœ
.
·th
(),

1890 &
key
,

1891 &
¢­shÙ
,

1892 
size_Œack
.
şÚe
(),

1893 
d–‘”
.
şÚe
(),

1894 
NÚe
,

1895 ).
unw¿p
();

1896 
	gas£¹
!(!
	gs2
.
exi¡s
());

1897 
	gs2
.
bud
(

1898 &
¢­shÙ
,

1899 &
»giÚ
,

1900 &
mut
 
¢­_d©a
,

1901 &
mut
 
¡©
,

1902 
d–‘”
.
şÚe
(),

1903 ).
unw¿p
();

1904 
	gas£¹
!(
	gs2
.
exi¡s
());

1906 
Ët
 
	gd¡_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-cÜru±iÚ-d¡").
unw¿p
();

1907 
cİy_¢­shÙ
(

1908 &
dœ
,

1909 &
d¡_dœ
,

1910 &
key
,

1911 
size_Œack
.
şÚe
(),

1912 
¢­_d©a
.
g‘_m‘a
().
şÚe
(),

1913 
d–‘”
.
şÚe
(),

1916 
Ët
 
mut
 
	gm‘as
 = 
cÜru±_¢­shÙ_checksum_š
(
d¡_dœ
.
·th
());

1917 
	gas£¹_eq
!(1, 
	gm‘as
.
Ën
());

1918 
Ët
 
	g¢­_m‘a
 = 
m‘as
.
pİ
().
unw¿p
();

1920 
Ët
 
mut
 
	gs5
 =

1921 
SÇp
::
Ãw_fÜ_­¶yšg
(
d¡_dœ
.
·th
(), &
key
, 
size_Œack
.
şÚe
(), 
d–‘”
.clone())

1922 .
unw¿p
();

1923 
	gas£¹
!(
	gs5
.
exi¡s
());

1925 
Ët
 
	gd¡_db_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-cÜru±iÚ-d¡-db").
unw¿p
();

1926 
Ët
 
	gd¡_db
 = 
g‘_‹¡_em±y_db
(&
d¡_db_dœ
).
unw¿p
();

1927 
Ët
 
	gİtiÚs
 = 
AµlyO±iÚs
 {

1928 
db
: 
d¡_db
.
şÚe
(),

1929 
»giÚ
:„egiÚ.
şÚe
(),

1930 
abÜt
: 
Arc
::
Ãw
(
AtomicUsize
::Ãw(
JOB_STATUS_RUNNING
)),

1931 
wr™e_b©ch_size
: 
TEST_WRITE_BATCH_SIZE
,

1933 
	gas£¹
!(
	gs5
.
­¶y
(
İtiÚs
).
is_”r
());

1935 
cÜru±_¢­shÙ_size_š
(
d¡_dœ
.
·th
());

1936 
	gas£¹
!(

1937 
	gSÇp
::
Ãw_fÜ_»ûivšg
(

1938 
d¡_dœ
.
·th
(),

1939 &
key
,

1940 
¢­_m‘a
,

1941 
size_Œack
.
şÚe
(),

1942 
d–‘”
.
şÚe
(),

1943 
NÚe
,

1944 ).
is_”r
()

1946 
	gas£¹
!(

1947 
	gSÇp
::
Ãw_fÜ_­¶yšg
(
d¡_dœ
.
·th
(), &
key
, 
size_Œack
.
şÚe
(), 
d–‘”
.clone())

1948 .
is_”r
()

1952 #[
‹¡
]

1953 
â
 
‹¡_¢­_cÜru±iÚ_Ú_m‘a_fe
() {

1954 
Ët
 
	g»giÚ_id
 = 1;

1955 
Ët
 
	g»giÚ
 = 
g‘_‹¡_»giÚ
(
»giÚ_id
, 1, 1);

1956 
Ët
 
	gdb_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­shÙ-cÜru±iÚ-m‘a-db").
unw¿p
();

1957 
Ët
 
	gdb
 = 
g‘_‹¡_db
(&
db_dœ
).
unw¿p
();

1958 
Ët
 
	g¢­shÙ
 = 
DbSÇpshÙ
::
Ãw
(
db
);

1960 
Ët
 
	gdœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-cÜru±iÚ-m‘a").
unw¿p
();

1961 
Ët
 
	gkey
 = 
SÇpKey
::
Ãw
(
»giÚ_id
, 1, 1);

1962 
Ët
 
	gsize_Œack
 = 
Arc
::
Ãw
(
RwLock
::new(0));

1963 
Ët
 
	gd–‘”
 = 
Box
::
Ãw
(
DummyD–‘”
 {});

1964 
Ët
 
mut
 
	gs1
 = 
SÇp
::
Ãw_fÜ_budšg
(

1965 
dœ
.
·th
(),

1966 &
key
,

1967 &
¢­shÙ
,

1968 
size_Œack
.
şÚe
(),

1969 
d–‘”
.
şÚe
(),

1970 
NÚe
,

1971 ).
unw¿p
();

1972 
	gas£¹
!(!
	gs1
.
exi¡s
());

1974 
Ët
 
mut
 
	g¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

1975 
	g¢­_d©a
.
£t_»giÚ
(
»giÚ
.
şÚe
());

1976 
Ët
 
mut
 
	g¡©
 = 
SÇpshÙSti¡ics
::
Ãw
();

1977 
	gs1
.
bud
(

1978 &
¢­shÙ
,

1979 &
»giÚ
,

1980 &
mut
 
¢­_d©a
,

1981 &
mut
 
¡©
,

1982 
d–‘”
.
şÚe
(),

1983 ).
unw¿p
();

1984 
	gas£¹
!(
	gs1
.
exi¡s
());

1986 
	gas£¹_eq
!(1, 
cÜru±_¢­shÙ_m‘a_fe
(
dœ
.
·th
()));

1988 
	gas£¹
!(

1989 
	gSÇp
::
Ãw_fÜ_£ndšg
(
dœ
.
·th
(), &
key
, 
size_Œack
.
şÚe
(), 
d–‘”
.şÚe()).
is_”r
()

1992 
Ët
 
mut
 
	gs2
 = 
SÇp
::
Ãw_fÜ_budšg
(

1993 
dœ
.
·th
(),

1994 &
key
,

1995 &
¢­shÙ
,

1996 
size_Œack
.
şÚe
(),

1997 
d–‘”
.
şÚe
(),

1998 
NÚe
,

1999 ).
unw¿p
();

2000 
	gas£¹
!(!
	gs2
.
exi¡s
());

2001 
	gs2
.
bud
(

2002 &
¢­shÙ
,

2003 &
»giÚ
,

2004 &
mut
 
¢­_d©a
,

2005 &
mut
 
¡©
,

2006 
d–‘”
.
şÚe
(),

2007 ).
unw¿p
();

2008 
	gas£¹
!(
	gs2
.
exi¡s
());

2010 
Ët
 
	gd¡_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-cÜru±iÚ-m‘a-d¡").
unw¿p
();

2011 
cİy_¢­shÙ
(

2012 &
dœ
,

2013 &
d¡_dœ
,

2014 &
key
,

2015 
size_Œack
.
şÚe
(),

2016 
¢­_d©a
.
g‘_m‘a
().
şÚe
(),

2017 
d–‘”
.
şÚe
(),

2020 
	gas£¹_eq
!(1, 
cÜru±_¢­shÙ_m‘a_fe
(
d¡_dœ
.
·th
()));

2022 
	gas£¹
!(

2023 
	gSÇp
::
Ãw_fÜ_­¶yšg
(
d¡_dœ
.
·th
(), &
key
, 
size_Œack
.
şÚe
(), 
d–‘”
.clone())

2024 .
is_”r
()

2026 
	gas£¹
!(

2027 
	gSÇp
::
Ãw_fÜ_»ûivšg
(

2028 
d¡_dœ
.
·th
(),

2029 &
key
,

2030 
¢­_d©a
.
ke_m‘a
(),

2031 
size_Œack
.
şÚe
(),

2032 
d–‘”
.
şÚe
(),

2033 
NÚe
,

2034 ).
is_”r
()

2038 #[
‹¡
]

2039 
â
 
‹¡_¢­_mgr_ü—‹_dœ
() {

2041 
Ët
 
	g‹mp_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-mgr-ü—‹-dœ").
unw¿p
();

2042 
Ët
 
	g‹mp_·th
 = 
‹mp_dœ
.
·th
().
još
("snap1");

2043 
Ët
 
	g·th
 = 
‹mp_·th
.
to_¡r
().
unw¿p
().
to_owÃd
();

2044 
	gas£¹
!(!
	g‹mp_·th
.
exi¡s
());

2045 
Ët
 
mut
 
	gmgr
 = 
SÇpMªag”
::
Ãw
(
·th
, 
NÚe
, None);

2046 
	gmgr
.
š™
().
unw¿p
();

2047 
	gas£¹
!(
	g‹mp_·th
.
exi¡s
());

2050 
Ët
 
	g‹mp_·th2
 = 
‹mp_dœ
.
·th
().
još
("snap2");

2051 
Ët
 
	g·th2
 = 
‹mp_·th2
.
to_¡r
().
unw¿p
().
to_owÃd
();

2052 
	gFe
::
ü—‹
(
‹mp_·th2
).
unw¿p
();

2053 
	gmgr
 = 
SÇpMªag”
::
Ãw
(
·th2
, 
NÚe
, None);

2054 
	gas£¹
!(
	gmgr
.
š™
().
is_”r
());

2057 #[
‹¡
]

2058 
â
 
‹¡_¢­_mgr_v2
() {

2059 
Ët
 
	g‹mp_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-mgr-v2").
unw¿p
();

2060 
Ët
 
	g·th
 = 
‹mp_dœ
.
·th
().
to_¡r
().
unw¿p
().
to_owÃd
();

2061 
Ët
 
	gmgr
 = 
SÇpMªag”
::
Ãw
(
·th
.
şÚe
(), 
NÚe
, None);

2062 
	gmgr
.
š™
().
unw¿p
();

2063 
	gas£¹_eq
!(
	gmgr
.
g‘_tÙ®_¢­_size
(), 0);

2065 
Ët
 
	gdb_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-mgr-d–‘e-‹mp-fes-v2-db").
unw¿p
();

2066 
Ët
 
	g¢­shÙ
 = 
DbSÇpshÙ
::
Ãw
(
g‘_‹¡_db
(&
db_dœ
).
unw¿p
());

2067 
Ët
 
	gkey1
 = 
SÇpKey
::
Ãw
(1, 1, 1);

2068 
Ët
 
	gsize_Œack
 = 
Arc
::
Ãw
(
RwLock
::new(0));

2069 
Ët
 
	gd–‘”
 = 
Box
::
Ãw
(
mgr
.
şÚe
());

2070 
Ët
 
mut
 
	gs1
 = 
SÇp
::
Ãw_fÜ_budšg
(

2071 &
·th
,

2072 &
key1
,

2073 &
¢­shÙ
,

2074 
size_Œack
.
şÚe
(),

2075 
d–‘”
.
şÚe
(),

2076 
NÚe
,

2077 ).
unw¿p
();

2078 
Ët
 
mut
 
	g»giÚ
 = 
g‘_‹¡_»giÚ
(1, 1, 1);

2079 
Ët
 
mut
 
	g¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

2080 
	g¢­_d©a
.
£t_»giÚ
(
»giÚ
.
şÚe
());

2081 
Ët
 
mut
 
	g¡©
 = 
SÇpshÙSti¡ics
::
Ãw
();

2082 
	gs1
.
bud
(

2083 &
¢­shÙ
,

2084 &
»giÚ
,

2085 &
mut
 
¢­_d©a
,

2086 &
mut
 
¡©
,

2087 
d–‘”
.
şÚe
(),

2088 ).
unw¿p
();

2089 
Ët
 
mut
 
	gs
 =

2090 
SÇp
::
Ãw_fÜ_£ndšg
(&
·th
, &
key1
, 
size_Œack
.
şÚe
(), 
d–‘”
.şÚe()).
unw¿p
();

2091 
Ët
 
	gex³ùed_size
 = 
s
.
tÙ®_size
().
unw¿p
();

2092 
Ët
 
mut
 
	gs2
 = 
SÇp
::
Ãw_fÜ_»ûivšg
(

2093 &
·th
,

2094 &
key1
,

2095 
¢­_d©a
.
g‘_m‘a
().
şÚe
(),

2096 
size_Œack
.
şÚe
(),

2097 
d–‘”
.
şÚe
(),

2098 
NÚe
,

2099 ).
unw¿p
();

2100 
Ët
 
	gn
 = 
io
::
cİy
(&
mut
 
s
, &muˆ
s2
).
unw¿p
();

2101 
	gas£¹_eq
!(
	gn
, 
	gex³ùed_size
);

2102 
	gs2
.
§ve
().
unw¿p
();

2104 
Ët
 
	gkey2
 = 
SÇpKey
::
Ãw
(2, 1, 1);

2105 
	g»giÚ
.
£t_id
(2);

2106 
	g¢­_d©a
.
£t_»giÚ
(
»giÚ
);

2107 
Ët
 
	gs3
 = 
SÇp
::
Ãw_fÜ_budšg
(

2108 &
·th
,

2109 &
key2
,

2110 &
¢­shÙ
,

2111 
size_Œack
.
şÚe
(),

2112 
d–‘”
.
şÚe
(),

2113 
NÚe
,

2114 ).
unw¿p
();

2115 
Ët
 
	gs4
 = 
SÇp
::
Ãw_fÜ_»ûivšg
(

2116 &
·th
,

2117 &
key2
,

2118 
¢­_d©a
.
ke_m‘a
(),

2119 
size_Œack
.
şÚe
(),

2120 
d–‘”
.
şÚe
(),

2121 
NÚe
,

2122 ).
unw¿p
();

2124 
	gas£¹
!(
	gs1
.
exi¡s
());

2125 
	gas£¹
!(
	gs2
.
exi¡s
());

2126 
	gas£¹
!(!
	gs3
.
exi¡s
());

2127 
	gas£¹
!(!
	gs4
.
exi¡s
());

2129 
Ët
 
	gmgr
 = 
SÇpMªag”
::
Ãw
(
·th
, 
NÚe
, None);

2130 
	gmgr
.
š™
().
unw¿p
();

2131 
	gas£¹_eq
!(
	gmgr
.
g‘_tÙ®_¢­_size
(), 
	gex³ùed_size
 * 2);

2133 
	gas£¹
!(
	gs1
.
exi¡s
());

2134 
	gas£¹
!(
	gs2
.
exi¡s
());

2135 
	gas£¹
!(!
	gs3
.
exi¡s
());

2136 
	gas£¹
!(!
	gs4
.
exi¡s
());

2138 
	gmgr
.
g‘_¢­shÙ_fÜ_£ndšg
(&
key1
).
unw¿p
().
d–‘e
();

2139 
	gas£¹_eq
!(
	gmgr
.
g‘_tÙ®_¢­_size
(), 
	gex³ùed_size
);

2140 
	gmgr
.
g‘_¢­shÙ_fÜ_­¶yšg
(&
key1
).
unw¿p
().
d–‘e
();

2141 
	gas£¹_eq
!(
	gmgr
.
g‘_tÙ®_¢­_size
(), 0);

2144 
â
 
check_»gi¡ry_¬ound_d”egi¡”
(
mgr
: 
SÇpMªag”
, 
key
: &
SÇpKey
, 
’Œy
: &
SÇpEÁry
) {

2145 
Ët
 
¢­_keys
 = 
mgr
.
li¡_idË_¢­
().
unw¿p
();

2146 
	gas£¹
!(
	g¢­_keys
.
is_em±y
());

2147 
	gas£¹
!(
	gmgr
.
has_»gi¡”ed
(
key
));

2148 
	gmgr
.
d”egi¡”
(
key
, 
’Œy
);

2149 
Ët
 
mut
 
	g¢­_keys
 = 
mgr
.
li¡_idË_¢­
().
unw¿p
();

2150 
	gas£¹_eq
!(
	g¢­_keys
.
Ën
(), 1);

2151 
Ët
 
	g¢­_key
 = 
¢­_keys
.
pİ
().
unw¿p
().0;

2152 
	gas£¹_eq
!(
	g¢­_key
, *
	gkey
);

2153 
	gas£¹
!(!
	gmgr
.
has_»gi¡”ed
(&
¢­_key
));

2156 #[
‹¡
]

2157 
â
 
‹¡_¢­_d–‘iÚ_Ú_»gi¡ry
() {

2158 
Ët
 
	g¤c_‹mp_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-d–‘iÚ-Ú-»gi¡ry-¤c").
unw¿p
();

2159 
Ët
 
	g¤c_·th
 = 
¤c_‹mp_dœ
.
·th
().
to_¡r
().
unw¿p
().
to_owÃd
();

2160 
Ët
 
	g¤c_mgr
 = 
SÇpMªag”
::
Ãw
(
¤c_·th
.
şÚe
(), 
NÚe
, None);

2161 
	g¤c_mgr
.
š™
().
unw¿p
();

2163 
Ët
 
	g¤c_db_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-d–‘iÚ-Ú-»gi¡ry-¤c-db").
unw¿p
();

2164 
Ët
 
	gdb
 = 
g‘_‹¡_db
(&
¤c_db_dœ
).
unw¿p
();

2165 
Ët
 
	g¢­shÙ
 = 
DbSÇpshÙ
::
Ãw
(
db
);

2167 
Ët
 
	gkey
 = 
SÇpKey
::
Ãw
(1, 1, 1);

2168 
Ët
 
	g»giÚ
 = 
g‘_‹¡_»giÚ
(1, 1, 1);

2171 
	g¤c_mgr
.(
	gkey
.
şÚe
(), 
	gSÇpEÁry
::
G’”©šg
);

2172 
Ët
 
mut
 
	gs1
 = 
¤c_mgr
.
g‘_¢­shÙ_fÜ_budšg
(&
key
, &
¢­shÙ
).
unw¿p
();

2173 
Ët
 
mut
 
	g¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

2174 
	g¢­_d©a
.
£t_»giÚ
(
»giÚ
.
şÚe
());

2175 
Ët
 
mut
 
	g¡©
 = 
SÇpshÙSti¡ics
::
Ãw
();

2176 
	gs1
.
bud
(

2177 &
¢­shÙ
,

2178 &
»giÚ
,

2179 &
mut
 
¢­_d©a
,

2180 &
mut
 
¡©
,

2181 
Box
::
Ãw
(
¤c_mgr
.
şÚe
()),

2182 ).
unw¿p
();

2183 
Ët
 
mut
 
	gv
 = 
vec
![];

2184 
	g¢­_d©a
.
wr™e_to_vec
(&
mut
 
v
).
unw¿p
();

2186 
check_»gi¡ry_¬ound_d”egi¡”
(
¤c_mgr
.
şÚe
(), &
key
, &
SÇpEÁry
::
G’”©šg
);

2189 
	g¤c_mgr
.(
	gkey
.
şÚe
(), 
	gSÇpEÁry
::
S’dšg
);

2190 
Ët
 
mut
 
	gs2
 = 
¤c_mgr
.
g‘_¢­shÙ_fÜ_£ndšg
(&
key
).
unw¿p
();

2191 
Ët
 
	gex³ùed_size
 = 
s2
.
tÙ®_size
().
unw¿p
();

2193 
Ët
 
	gd¡_‹mp_dœ
 = 
TempDœ
::
Ãw
("‹¡-¢­-d–‘iÚ-Ú-»gi¡ry-d¡").
unw¿p
();

2194 
Ët
 
	gd¡_·th
 = 
d¡_‹mp_dœ
.
·th
().
to_¡r
().
unw¿p
().
to_owÃd
();

2195 
Ët
 
	gd¡_mgr
 = 
SÇpMªag”
::
Ãw
(
d¡_·th
.
şÚe
(), 
NÚe
, None);

2196 
	gd¡_mgr
.
š™
().
unw¿p
();

2199 
	gd¡_mgr
.(
	gkey
.
şÚe
(), 
	gSÇpEÁry
::
Reûivšg
);

2200 
Ët
 
mut
 
	gs3
 = 
d¡_mgr
.
g‘_¢­shÙ_fÜ_»ûivšg
(&
key
, &
v
[..]).
unw¿p
();

2201 
Ët
 
	gn
 = 
io
::
cİy
(&
mut
 
s2
, &muˆ
s3
).
unw¿p
();

2202 
	gas£¹_eq
!(
	gn
, 
	gex³ùed_size
);

2203 
	gs3
.
§ve
().
unw¿p
();

2205 
check_»gi¡ry_¬ound_d”egi¡”
(
¤c_mgr
.
şÚe
(), &
key
, &
SÇpEÁry
::
S’dšg
);

2206 
check_»gi¡ry_¬ound_d”egi¡”
(
d¡_mgr
.
şÚe
(), &
key
, &
SÇpEÁry
::
Reûivšg
);

2209 
Ët
 
mut
 
	g¢­_keys
 = 
d¡_mgr
.
li¡_idË_¢­
().
unw¿p
();

2210 
	gas£¹_eq
!(
	g¢­_keys
.
Ën
(), 1);

2211 
Ët
 
	g¢­_key
 = 
¢­_keys
.
pİ
().
unw¿p
().0;

2212 
	gas£¹_eq
!(
	g¢­_key
, 
	gkey
);

2213 
	gas£¹
!(!
	gd¡_mgr
.
has_»gi¡”ed
(&
¢­_key
));

2214 
	gd¡_mgr
.(
	gkey
.
şÚe
(), 
	gSÇpEÁry
::
Aµlyšg
);

2215 
Ët
 
	gs4
 = 
d¡_mgr
.
g‘_¢­shÙ_fÜ_­¶yšg
(&
key
).
unw¿p
();

2216 
Ët
 
	gs5
 = 
d¡_mgr
.
g‘_¢­shÙ_fÜ_­¶yšg
(&
key
).
unw¿p
();

2217 
	gd¡_mgr
.
d–‘e_¢­shÙ
(&
key
, 
s4
.
as_»f
(), 
çl£
);

2218 
	gas£¹
!(
	gs5
.
exi¡s
());

	@src/raftstore/store/store.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

15 
u£
 
	g¡d
::
sync
::
mpsc
::{
£lf
, 
Reûiv”
 
as
 
	gStdReûiv”
, 
	gTryRecvE¼Ü
};

16 
u£
 
	g¡d
::
rc
::
Rc
;

17 
u£
 
	g¡d
::
ûÎ
::
RefC–l
;

18 
u£
 
	g¡d
::
cŞËùiÚs
::
BT»eM­
;

19 
u£
 
	g¡d
::
cŞËùiÚs
::
Bound
::{
Exşuded
, 
	gInşuded
, 
	gUnbounded
};

20 
u£
 
	g¡d
::
time
::{
Du¿tiÚ
, 
	gIn¡ªt
};

21 
u£
 
	g¡d
::
th»ad
;

22 
u£
 
	g¡d
::
u64
;

24 
u£
 
	grocksdb
::{
Wr™eB©ch
, 
	gDB
};

25 
u£
 
	grocksdb
::
rocksdb_İtiÚs
::
Wr™eO±iÚs
;

26 
u£
 
	gmio
::{
£lf
, 
	gEv’tLoİ
, 
	gEv’tLoİCÚfig
, 
	gS’d”
};

27 
u£
 
	g´Ùobuf
;

28 
u£
 
	gtime
::{
£lf
, 
	gTime¥ec
};

30 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
P“rS‹
, 
	gRaáMes§ge
, 
	gRaáSÇpshÙD©a
, 
	gRaáTrunÿ‹dS‹
,

31 
	gRegiÚLoÿlS‹
};

32 
u£
 
	gkv´Ùo
::
”aápb
::{
CÚfChªgeTy³
, 
	gMes§geTy³
};

33 
u£
 
	gkv´Ùo
::
pdpb
::
StÜeSts
;

34 
u£
 
	gut
::{
esÿ³
, 
	grocksdb
};

35 
u£
 
	gut
::
time
::{
du¿tiÚ_to_£c
, 
	gSlowTim”
};

36 
u£
 
	gpd
::{
PdCl›Á
, 
	gPdRuÂ”
, 
	gPdTask
};

37 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
AdmšCmdTy³
, 
	gAdmšReque¡
, 
	gRaáCmdReque¡
, 
	gRaáCmdRe¥Ú£
,

38 
	gStusCmdTy³
, 
	gStusRe¥Ú£
};

39 
u£
 
	g´Ùobuf
::
Mes§ge
;

40 
u£
 
	g¿á
::{
£lf
, 
	gSÇpshÙStus
, 
	gINVALID_INDEX
};

41 
u£
 
	g¿á¡Üe
::{
E¼Ü
, 
	gResuÉ
};

42 
u£
 
	gkv´Ùo
::
m‘­b
;

43 
u£
 
	gut
::
wÜk”
::{
Futu»WÜk”
, 
	gScheduËr
, 
	gStİ³d
, 
	gWÜk”
};

44 
u£
 
	gut
::
Œª¥Üt
::
S’dCh
;

45 
u£
 
	gut
::
RšgQueue
;

46 
u£
 
	gut
::
cŞËùiÚs
::{
HashM­
, 
	gHashS‘
};

47 
u£
 
	g¡Üage
::{
CF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_RAFT
, 
	gCF_WRITE
};

48 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::
CİroûssÜHo¡
;

49 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::
¥l™_ob£rv”
::
S¶™Ob£rv”
;

50 
u£
 
	gsu³r
::
wÜk”
::{
AµlyRuÂ”
, 
	gAµlyTask
, 
	gAµlyTaskRes
, 
	gCom·ùRuÂ”
, 
	gCom·ùTask
,

51 
	gCÚsi¡’cyCheckRuÂ”
, 
	gCÚsi¡’cyCheckTask
, 
	gRaálogGcRuÂ”
, 
	gRaálogGcTask
,

52 
	gRegiÚRuÂ”
, 
	gRegiÚTask
, 
	gS¶™CheckRuÂ”
, 
	gS¶™CheckTask
};

53 
u£
 
	gsu³r
::
wÜk”
::
­¶y
::{
ChªgeP“r
, 
	gExecResuÉ
};

54 
u£
 
	gsu³r
::{
ut
, 
	gMsg
, 
	gSignifiÿÁMsg
, 
	gSÇpKey
, 
	gSÇpMªag”
, 
	gSÇpshÙD–‘”
, 
	gTick
};

55 
u£
 
	gsu³r
::
keys
::{
£lf
, 
	gd©a_’d_key
, 
	gd©a_key
, 
	g’c_’d_key
, 
	g’c_¡¬t_key
};

56 
u£
 
	gsu³r
::
’gše
::{
I‹¿bË
, 
	gP“kabË
, 
SÇpshÙ
 
as
 
	gEngšeSÇpshÙ
};

57 
u£
 
	gsu³r
::
cÚfig
::
CÚfig
;

58 
u£
 
	gsu³r
::
³”
::{
£lf
, 
	gCÚsi¡’cyS‹
, 
	gP“r
, 
	gR—dyCÚ‹xt
, 
	gSËS‹
};

59 
u£
 
	gsu³r
::
³”_¡Üage
::{
£lf
, 
	gAµlySÇpResuÉ
, 
	gCacheQu”ySts
};

60 
u£
 
	gsu³r
::
msg
::{
B©chC®lback
, 
	gC®lback
};

61 
u£
 
	gsu³r
::
cmd_»¥
::{
bšd_‹rm
, 
	gÃw_”rÜ
};

62 
u£
 
	gsu³r
::
Œª¥Üt
::
T¿n¥Üt
;

63 
u£
 
	gsu³r
::
m‘rics
::*;

64 
u£
 
	gsu³r
::
loÿl_m‘rics
::
RaáM‘rics
;

66 
ty³
 
	gKey
 = 
Vec
<
u8
>;

68 cÚ¡ 
	gMIO_TICK_RATIO
: 
u64
 = 10;

69 cÚ¡ 
	gPENDING_VOTES_CAP
: 
usize
 = 20;

71 #[
d”ive
(
ClÚe
)]

72 
pub
 
	sEngšes
 {

73 
pub
 
	mkv_’gše
: 
Arc
<
DB
>,

74 
pub
 
	m¿á_’gše
: 
Arc
<
DB
>,

77 
im¶
 
	gEngšes
 {

78 
pub
 
â
 
Ãw
(
kv_’gše
: 
Arc
<
DB
>, 
¿á_’gše
: Arc<DB>è-> 
Engšes
 {

79 
Engšes
 {

80 
kv_’gše
: kv_engine,

81 
	g¿á_’gše
: 
¿á_’gše
,

87 
pub
 
	sStÜeChªÃl
 {

88 
pub
 
	m£nd”
: 
S’d”
<
Msg
>,

89 
pub
 
	msignifiÿÁ_msg_»ûiv”
: 
StdReûiv”
<
SignifiÿÁMsg
>,

92 
pub
 
	sStÜeSt
 {

93 
pub
 
	mlock_cf_by‹s_wr™‹n
: 
u64
,

95 
pub
 
	m’gše_tÙ®_by‹s_wr™‹n
: 
u64
,

96 
pub
 
	m’gše_tÙ®_keys_wr™‹n
: 
u64
,

98 
pub
 
	m’gše_Ï¡_tÙ®_by‹s_wr™‹n
: 
u64
,

99 
pub
 
	m’gše_Ï¡_tÙ®_keys_wr™‹n
: 
u64
,

102 
im¶
 
DeçuÉ
 
	gStÜeSt
 {

103 
â
 (è-> 
	gStÜeSt
 {

104 
	gStÜeSt
 {

105 
	glock_cf_by‹s_wr™‹n
: 0,

106 
	g’gše_tÙ®_by‹s_wr™‹n
: 0,

107 
	g’gše_tÙ®_keys_wr™‹n
: 0,

109 
	g’gše_Ï¡_tÙ®_by‹s_wr™‹n
: 0,

110 
	g’gše_Ï¡_tÙ®_keys_wr™‹n
: 0,

115 
pub
 
	sDe¡royP“rJob
 {

116 
pub
 
	mš™Ÿlized
: 
boŞ
,

117 
pub
 
	masync_»move
: 
boŞ
,

118 
pub
 
	m»giÚ_id
: 
u64
,

119 
pub
 
	m³”
: 
m‘­b
::
P“r
,

122 
pub
 
	sStÜeInfo
 {

123 
pub
 
	m’gše
: 
Arc
<
DB
>,

124 
pub
 
	mÿ·c™y
: 
u64
,

127 
pub
 
	gStÜe
<
	gT
, 
	gC
: 'static> {

128 
cfg
: 
Rc
<
CÚfig
>,

129 
	gkv_’gše
: 
Arc
<
DB
>,

130 
	g¿á_’gše
: 
Arc
<
DB
>,

131 
	g¡Üe
: 
m‘­b
::
StÜe
,

132 
	g£ndch
: 
S’dCh
<
Msg
>,

134 
	gsignifiÿÁ_msg_»ûiv”
: 
StdReûiv”
<
SignifiÿÁMsg
>,

137 
	g»giÚ_³”s
: 
HashM­
<
u64
, 
	gP“r
>,

138 
	g³ndšg_¿á_groups
: 
HashS‘
<
u64
>,

140 
	g»giÚ_¿nges
: 
BT»eM­
<
Key
, 
	gu64
>,

142 
	g³ndšg_¢­shÙ_»giÚs
: 
Vec
<
m‘­b
::
RegiÚ
>,

143 
	g¥l™_check_wÜk”
: 
WÜk”
<
S¶™CheckTask
>,

144 
	g»giÚ_wÜk”
: 
WÜk”
<
RegiÚTask
>,

145 
	g¿álog_gc_wÜk”
: 
WÜk”
<
RaálogGcTask
>,

146 
	gcom·ù_wÜk”
: 
WÜk”
<
Com·ùTask
>,

147 
	gpd_wÜk”
: 
Futu»WÜk”
<
PdTask
>,

148 
	gcÚsi¡’cy_check_wÜk”
: 
WÜk”
<
CÚsi¡’cyCheckTask
>,

149 
pub
 
	g­¶y_wÜk”
: 
WÜk”
<
AµlyTask
>,

150 
	g­¶y_»s_»ûiv”
: 
O±iÚ
<
StdReûiv”
<
AµlyTaskRes
>>,

152 
	gŒªs
: 
T
,

153 
	gpd_ş›Á
: 
Arc
<
C
>,

155 
pub
 
	gcİroûssÜ_ho¡
: 
Arc
<
CİroûssÜHo¡
>,

157 
	g¢­_mgr
: 
SÇpMªag”
,

159 
	g¿á_m‘rics
: 
RaáM‘rics
,

160 
pub
 
	g’Œy_ÿche_m‘r›s
: 
Rc
<
RefC–l
<
CacheQu”ySts
>>,

162 
	gg
: 
SŒšg
,

164 
	g¡¬t_time
: 
Time¥ec
,

165 
	gis_busy
: 
boŞ
,

167 
	g³ndšg_vÙes
: 
RšgQueue
<
RaáMes§ge
>,

169 
	g¡Üe_¡©
: 
StÜeSt
,

172 
pub
 
â
 
	gü—‹_ev’t_loİ
<
	gT
, 
	gC
>(
	gcfg
: &
CÚfig
è-> 
ResuÉ
<
Ev’tLoİ
<
StÜe
<
T
, C>>>

173 
wh”e


174 
	gT
: 
T¿n¥Üt
,

175 
	gC
: 
PdCl›Á
,

177 
Ët
 
mut
 
	gcÚfig
 = 
Ev’tLoİCÚfig
::
Ãw
();

179 
	gcÚfig
.
tim”_tick_ms
(
cfg
.
¿á_ba£_tick_š‹rv®
.
as_mlis
(è/ 
MIO_TICK_RATIO
);

180 
	gcÚfig
.
nÙify_ÿ·c™y
(
cfg
.notify_capacity);

181 
	gcÚfig
.
mes§ges_³r_tick
(
cfg
.messages_per_tick);

182 
Ët
 
	gev’t_loİ
 = 
Ev’tLoİ
::
cÚfigu»d
(
cÚfig
)?;

183 
Ok
(
ev’t_loİ
)

186 
	gim¶
<
	gT
, 
	gC
> 
	gStÜe
<T, C> {

187 #[
®low
(
too_mªy_¬gum’ts
)]

188 
pub
 
â
 
Ãw
(

189 
ch
: 
StÜeChªÃl
,

190 
m‘a
: 
m‘­b
::
StÜe
,

191 
cfg
: 
CÚfig
,

192 
’gšes
: 
Engšes
,

193 
Œªs
: 
T
,

194 
pd_ş›Á
: 
Arc
<
C
>,

195 
mgr
: 
SÇpMªag”
,

196 
pd_wÜk”
: 
Futu»WÜk”
<
PdTask
>,

197 
mut
 
cİroûssÜ_ho¡
: 
CİroûssÜHo¡
,

198 è-> 
	gResuÉ
<
	gStÜe
<
	gT
, 
	gC
>> {

200 
	gcfg
.
v®id©e
()?;

202 
Ët
 
	g£ndch
 = 
S’dCh
::
Ãw
(
ch
.
£nd”
, "raftstore");

203 
Ët
 
	gg
 = 
fÜm©
!("[¡Ü{}]", 
	gm‘a
.
g‘_id
());

206 
	gcİroûssÜ_ho¡


207 .
	g»gi¡ry


208 .
»gi¡”_admš_ob£rv”
(100, 
box
 
S¶™Ob£rv”
);

210 
Ët
 
mut
 
	gs
 = 
StÜe
 {

211 
cfg
: 
Rc
::
Ãw
(cfg),

212 
¡Üe
: 
m‘a
,

213 
kv_’gše
: 
’gšes
.kv_engine,

214 
¿á_’gše
: 
’gšes
.raft_engine,

215 
£ndch
: sendch,

216 
signifiÿÁ_msg_»ûiv”
: 
ch
.significant_msg_receiver,

217 
»giÚ_³”s
: 
HashM­
::(),

218 
³ndšg_¿á_groups
: 
HashS‘
::(),

219 
¥l™_check_wÜk”
: 
WÜk”
::
Ãw
("split check worker"),

220 
»giÚ_wÜk”
: 
WÜk”
::
Ãw
("snapshot worker"),

221 
¿álog_gc_wÜk”
: 
WÜk”
::
Ãw
("raft gc worker"),

222 
com·ù_wÜk”
: 
WÜk”
::
Ãw
("compact worker"),

223 
pd_wÜk”
:…d_worker,

224 
cÚsi¡’cy_check_wÜk”
: 
WÜk”
::
Ãw
("consistency check worker"),

225 
­¶y_wÜk”
: 
WÜk”
::
Ãw
("apply worker"),

226 
­¶y_»s_»ûiv”
: 
NÚe
,

227 
»giÚ_¿nges
: 
BT»eM­
::
Ãw
(),

228 
³ndšg_¢­shÙ_»giÚs
: 
vec
![],

229 
Œªs
:rans,

230 
pd_ş›Á
:…d_client,

231 
cİroûssÜ_ho¡
: 
Arc
::
Ãw
(coprocessor_host),

232 
¢­_mgr
: 
mgr
,

233 
¿á_m‘rics
: 
RaáM‘rics
::(),

234 
’Œy_ÿche_m‘r›s
: 
Rc
::
Ãw
(
RefC–l
::Ãw(
CacheQu”ySts
::())),

235 
³ndšg_vÙes
: 
RšgQueue
::
w™h_ÿ·c™y
(
PENDING_VOTES_CAP
),

236 
g
:ag,

237 
¡¬t_time
: 
time
::
g‘_time
(),

238 
is_busy
: 
çl£
,

239 
¡Üe_¡©
: 
StÜeSt
::(),

241 
	gs
.
š™
()?;

242 
Ok
(
s
)

248 
â
 
š™
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

250 
Ët
 
	g¡¬t_key
 = 
keys
::
REGION_META_MIN_KEY
;

251 
Ët
 
	g’d_key
 = 
keys
::
REGION_META_MAX_KEY
;

252 
Ët
 
	gkv_’gše
 = 
£lf
.
kv_’gše
.
şÚe
();

253 
Ët
 
mut
 
	gtÙ®_couÁ
 = 0;

254 
Ët
 
mut
 
	gtomeb¡Úe_couÁ
 = 0;

255 
Ët
 
mut
 
	g­¶yšg_couÁ
 = 0;

257 
Ët
 
	gt
 = 
In¡ªt
::
now
();

258 
Ët
 
mut
 
	gkv_wb
 = 
Wr™eB©ch
::
Ãw
();

259 
Ët
 
mut
 
	g¿á_wb
 = 
Wr™eB©ch
::
Ãw
();

260 
Ët
 
mut
 
	g­¶yšg_»giÚs
 = 
vec
![];

261 
	gkv_’gše
.
sÿn_cf
(

262 
CF_RAFT
,

263 
¡¬t_key
,

264 
’d_key
,

265 
çl£
,

266 &
mut
 |
key
, 
v®ue
| {

267 
Ët
 (
»giÚ_id
, 
suffix
èğ
keys
::
decode_»giÚ_m‘a_key
(
key
)?;

268 
suffix
 !ğ
keys
::
REGION_STATE_SUFFIX
 {

269  
Ok
(
Œue
);

272 
tÙ®_couÁ
 += 1;

274 
Ët
 
loÿl_¡©e
 = 
´Ùobuf
::
·r£_äom_by‹s
::<
RegiÚLoÿlS‹
>(
v®ue
)?;

275 
Ët
 
»giÚ
 = 
loÿl_¡©e
.
g‘_»giÚ
();

276 
loÿl_¡©e
.
g‘_¡©e
(è=ğ
P“rS‹
::
Tomb¡Úe
 {

277 
tomeb¡Úe_couÁ
 += 1;

278 
debug
!(

280 
»giÚ
,

281 
£lf
.
¡Üe_id
()

283 
£lf
.
ş—r_¡®e_m‘a
(&
mut
 
kv_wb
, &muˆ
¿á_wb
, 
»giÚ
);

284  
Ok
(
Œue
);

286 
loÿl_¡©e
.
g‘_¡©e
(è=ğ
P“rS‹
::
Aµlyšg
 {

289 
³”_¡Üage
::
»cov”_äom_­¶yšg_¡©e
(

290 &
£lf
.
kv_’gše
,

291 &
£lf
.
¿á_’gše
,

292 &
¿á_wb
,

293 
»giÚ_id
,

295 
­¶yšg_couÁ
 += 1;

296 
­¶yšg_»giÚs
.
push
(
»giÚ
.
şÚe
());

297  
Ok
(
Œue
);

300 
Ët
 
³”
 = 
P“r
::
ü—‹
(
£lf
, 
»giÚ
)?;

301 
£lf
.
»giÚ_¿nges
.
š£¹
(
’c_’d_key
(
»giÚ
), 
»giÚ_id
);

304 
£lf
.
»giÚ_³”s
.
š£¹
(
»giÚ_id
, 
³”
);

305 
Ok
(
Œue
)

309 !
	gkv_wb
.
is_em±y
() {

310 
	g£lf
.
	gkv_’gše
.
wr™e
(
kv_wb
).
unw¿p
();

311 
	g£lf
.
	gkv_’gše
.
sync_w®
().
unw¿p
();

313 !
	g¿á_wb
.
is_em±y
() {

314 
	g£lf
.
	g¿á_’gše
.
wr™e
(
¿á_wb
).
unw¿p
();

315 
	g£lf
.
	g¿á_’gše
.
sync_w®
().
unw¿p
();

319 
»giÚ
 
š
 
	g­¶yšg_»giÚs
 {

320 
	gšfo
!(

322 
	g»giÚ
,

323 
	g£lf
.
¡Üe_id
()

325 
Ët
 
mut
 
	g³”
 = 
P“r
::
ü—‹
(
£lf
, &
»giÚ
)?;

326 
	g³”
.
mut_¡Üe
().
scheduË_­¶yšg_¢­shÙ
();

327 
	g£lf
.
	g»giÚ_¿nges


328 .
š£¹
(
’c_’d_key
(&
»giÚ
),„egiÚ.
g‘_id
());

329 
	g£lf
.
	g»giÚ_³”s
.
š£¹
(
»giÚ
.
g‘_id
(), 
³”
);

332 
	gšfo
!(

335 
	g£lf
.
	gg
,

336 
	gtÙ®_couÁ
,

337 
	gtomeb¡Úe_couÁ
,

338 
	g­¶yšg_couÁ
,

339 
	gt
.
–­£d
()

342 
	g£lf
.
ş—r_¡®e_d©a
()?;

344 
Ok
(())

347 
â
 
ş—r_¡®e_m‘a
(

348 &
mut
 
£lf
,

349 
kv_wb
: &
mut
 
Wr™eB©ch
,

350 
¿á_wb
: &
mut
 
Wr™eB©ch
,

351 
»giÚ
: &
m‘­b
::
RegiÚ
,

353 
Ët
 
	g¿á_key
 = 
keys
::
¿á_¡©e_key
(
»giÚ
.
g‘_id
());

354 
Ët
 
	g¿á_¡©e
 = 
m©ch
 
£lf
.
¿á_’gše
.
g‘_msg
(&
¿á_key
).
unw¿p
() {

356 
NÚe
 => ,

357 
Some
(
v®ue
) => value,

360 
	g³”_¡Üage
::
ş—r_m‘a
(

361 &
£lf
.
kv_’gše
,

362 &
£lf
.
¿á_’gše
,

363 
kv_wb
,

364 
¿á_wb
,

365 
»giÚ
.
g‘_id
(),

366 &
¿á_¡©e
,

367 ).
unw¿p
();

368 
	g³”_¡Üage
::
wr™e_³”_¡©e
(&
£lf
.
kv_’gše
, 
kv_wb
, 
»giÚ
, 
P“rS‹
::
Tomb¡Úe
)

369 .
unw¿p
();

373 
â
 
ş—r_¡®e_d©a
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

374 
Ët
 
	gt
 = 
In¡ªt
::
now
();

375 
Ët
 
mut
 
	gÏ¡_¡¬t_key
 = 
keys
::
d©a_key
(
b
"");

376 
»giÚ_id
 
š
 
	g£lf
.
	g»giÚ_¿nges
.
v®ues
() {

377 
Ët
 
	g»giÚ
 = 
£lf
.
»giÚ_³”s
[
»giÚ_id
].
»giÚ
();

378 
Ët
 
	g¡¬t_key
 = 
keys
::
’c_¡¬t_key
(
»giÚ
);

379 
	grocksdb
::
roughly_ş—nup_¿nge
(&
£lf
.
kv_’gše
, &
Ï¡_¡¬t_key
, &
¡¬t_key
)?;

380 
	gÏ¡_¡¬t_key
 = 
keys
::
’c_’d_key
(
»giÚ
);

383 
	grocksdb
::
roughly_ş—nup_¿nge
(&
£lf
.
kv_’gše
, &
Ï¡_¡¬t_key
, 
keys
::
DATA_MAX_KEY
)?;

385 
	gšfo
!(

387 
	g£lf
.
	gg
,

388 
	gt
.
–­£d
()

390 
Ok
(())

393 
pub
 
â
 
g‘_£ndch
(&
£lf
è-> 
	gS’dCh
<
	gMsg
> {

394 
	g£lf
.
	g£ndch
.
şÚe
()

397 #[
šlše
]

398 
pub
 
â
 
g‘_¢­_mgr
(&
£lf
è-> 
	gSÇpMªag”
 {

399 
	g£lf
.
	g¢­_mgr
.
şÚe
()

402 
pub
 
â
 
¢­_scheduËr
(&
£lf
è-> 
	gScheduËr
<
	gRegiÚTask
> {

403 
	g£lf
.
	g»giÚ_wÜk”
.
scheduËr
()

406 
pub
 
â
 
­¶y_scheduËr
(&
£lf
è-> 
	gScheduËr
<
	gAµlyTask
> {

407 
	g£lf
.
	g­¶y_wÜk”
.
scheduËr
()

410 
pub
 
â
 
kv_’gše
(&
£lf
è-> 
	gArc
<
	gDB
> {

411 
	g£lf
.
	gkv_’gše
.
şÚe
()

414 
pub
 
â
 
¿á_’gše
(&
£lf
è-> 
	gArc
<
	gDB
> {

415 
	g£lf
.
	g¿á_’gše
.
şÚe
()

418 
pub
 
â
 
¡Üe_id
(&
£lf
è-> 
	gu64
 {

419 
	g£lf
.
	g¡Üe
.
g‘_id
()

422 
pub
 
â
 
g‘_³”s
(&
£lf
è-> &
	gHashM­
<
	gu64
, 
	gP“r
> {

423 &
	g£lf
.
	g»giÚ_³”s


426 
pub
 
â
 
cÚfig
(&
£lf
è-> 
	gRc
<
	gCÚfig
> {

427 
	g£lf
.
	gcfg
.
şÚe
()

430 
â
 
pŞl_signifiÿÁ_msg
(&
mut
 
£lf
) {

432 
	gloİ
 {

433 
m©ch
 
	g£lf
.
	gsignifiÿÁ_msg_»ûiv”
.
Œy_»cv
() {

434 
Ok
(
SignifiÿÁMsg
::
SÇpshÙStus
 {

435 
»giÚ_id
,

436 
to_³”_id
,

437 
¡©us
,

440 
£lf
.
»pÜt_¢­shÙ_¡©us
(
»giÚ_id
, 
to_³”_id
, 
¡©us
);

442 
Ok
(
SignifiÿÁMsg
::
UÄ—chabË
 {

443 
»giÚ_id
,

444 
to_³”_id
,

445 }è=> 
Ët
 
Some
(
³”
èğ
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
) {

446 
³”
.
¿á_group
.
»pÜt_uÄ—chabË
(
to_³”_id
);

448 
E¼
(
TryRecvE¼Ü
::
Em±y
) => {

452 
E¼
(
e
) => {

453 
”rÜ
!(

455 
£lf
.
g
,

456 
e


464 
â
 
»pÜt_¢­shÙ_¡©us
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
to_³”_id
: u64, 
¡©us
: 
SÇpshÙStus
) {

465 
Ët
 
Some
(
³”
èğ
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
) {

466 
Ët
 
to_³”
 = 
m©ch
 
³”
.
g‘_³”_äom_ÿche
(
to_³”_id
) {

467 
Some
(
³”
) =>…eer,

468 
	gNÚe
 => {

470 
w¬n
!(

472 
»giÚ_id
,

473 
to_³”_id
,

474 
¡©us


479 
	gšfo
!(

481 
	g»giÚ_id
,

482 
	gto_³”
,

483 
	g¡©us


485 
	g³”
.
	g¿á_group
.
»pÜt_¢­shÙ
(
to_³”_id
, 
¡©us
)

490 
	gim¶
<
	gT
: 
T¿n¥Üt
, 
	gC
: 
PdCl›Á
> 
StÜe
<
T
, C> {

491 
pub
 
â
 
run
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>è-> 
ResuÉ
<()> {

492 
£lf
.
¢­_mgr
.
š™
()?;

494 
	g£lf
.
»gi¡”_¿á_ba£_tick
(
ev’t_loİ
);

495 
	g£lf
.
»gi¡”_¿á_gc_log_tick
(
ev’t_loİ
);

496 
	g£lf
.
»gi¡”_¥l™_»giÚ_check_tick
(
ev’t_loİ
);

497 
	g£lf
.
»gi¡”_com·ù_check_tick
(
ev’t_loİ
);

498 
	g£lf
.
»gi¡”_pd_¡Üe_h—¹b—t_tick
(
ev’t_loİ
);

499 
	g£lf
.
»gi¡”_pd_h—¹b—t_tick
(
ev’t_loİ
);

500 
	g£lf
.
»gi¡”_¢­_mgr_gc_tick
(
ev’t_loİ
);

501 
	g£lf
.
»gi¡”_com·ù_lock_cf_tick
(
ev’t_loİ
);

502 
	g£lf
.
»gi¡”_cÚsi¡’cy_check_tick
(
ev’t_loİ
);

504 
Ët
 
	g¥l™_check_ruÂ”
 = 
S¶™CheckRuÂ”
::
Ãw
(

505 
£lf
.
kv_’gše
.
şÚe
(),

506 
£lf
.
£ndch
.
şÚe
(),

507 
£lf
.
cİroûssÜ_ho¡
.
şÚe
(),

510 
	gbox_Œy
!(
	g£lf
.
	g¥l™_check_wÜk”
.
¡¬t
(
¥l™_check_ruÂ”
));

512 
Ët
 
	gruÂ”
 = 
RegiÚRuÂ”
::
Ãw
(

513 
£lf
.
kv_’gše
.
şÚe
(),

514 
£lf
.
¿á_’gše
.
şÚe
(),

515 
£lf
.
¢­_mgr
.
şÚe
(),

516 
£lf
.
cfg
.
¢­_­¶y_b©ch_size
.0 
as
 
usize
,

518 
	gbox_Œy
!(
	g£lf
.
	g»giÚ_wÜk”
.
¡¬t
(
ruÂ”
));

520 
Ët
 
	g¿álog_gc_ruÂ”
 = 
RaálogGcRuÂ”
::
Ãw
(
NÚe
);

521 
	gbox_Œy
!(
	g£lf
.
	g¿álog_gc_wÜk”
.
¡¬t
(
¿álog_gc_ruÂ”
));

523 
Ët
 
	gcom·ù_ruÂ”
 = 
Com·ùRuÂ”
::
Ãw
(
£lf
.
kv_’gše
.
şÚe
());

524 
	gbox_Œy
!(
	g£lf
.
	gcom·ù_wÜk”
.
¡¬t
(
com·ù_ruÂ”
));

526 
Ët
 
	gpd_ruÂ”
 = 
PdRuÂ”
::
Ãw
(

527 
£lf
.
¡Üe_id
(),

528 
£lf
.
pd_ş›Á
.
şÚe
(),

529 
£lf
.
£ndch
.
şÚe
(),

530 
£lf
.
kv_’gše
.
şÚe
(),

532 
	gbox_Œy
!(
	g£lf
.
	gpd_wÜk”
.
¡¬t
(
pd_ruÂ”
));

534 
Ët
 
	gcÚsi¡’cy_check_ruÂ”
 = 
CÚsi¡’cyCheckRuÂ”
::
Ãw
(
£lf
.
£ndch
.
şÚe
());

535 
	gbox_Œy
!(

536 
	g£lf
.
	gcÚsi¡’cy_check_wÜk”


537 .
¡¬t
(
cÚsi¡’cy_check_ruÂ”
)

540 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

541 
Ët
 
	g­¶y_ruÂ”
 = 
AµlyRuÂ”
::
Ãw
(
£lf
, 
tx
, s–f.
cfg
.
sync_log
);

542 
	g£lf
.
	g­¶y_»s_»ûiv”
 = 
Some
(
rx
);

543 
	gbox_Œy
!(
	g£lf
.
	g­¶y_wÜk”
.
¡¬t
(
­¶y_ruÂ”
));

545 
	gev’t_loİ
.
run
(
£lf
)?;

546 
Ok
(())

549 
â
 
¡İ
(&
mut
 
£lf
) {

550 
	gšfo
!("starto stop„aftstore.");

553 
³”
 
š
 
	g£lf
.
	g»giÚ_³”s
.
v®ues_mut
() {

554 
	g³”
.
¡İ
();

558 
Ët
 
mut
 
	ghªdËs
: 
Vec
<
O±iÚ
<
th»ad
::
JošHªdË
<()>>> = 
vec
![];

559 
	ghªdËs
.
push
(
£lf
.
¥l™_check_wÜk”
.
¡İ
());

560 
	ghªdËs
.
push
(
£lf
.
»giÚ_wÜk”
.
¡İ
());

561 
	ghªdËs
.
push
(
£lf
.
¿álog_gc_wÜk”
.
¡İ
());

562 
	ghªdËs
.
push
(
£lf
.
com·ù_wÜk”
.
¡İ
());

563 
	ghªdËs
.
push
(
£lf
.
pd_wÜk”
.
¡İ
());

564 
	ghªdËs
.
push
(
£lf
.
cÚsi¡’cy_check_wÜk”
.
¡İ
());

565 
	ghªdËs
.
push
(
£lf
.
­¶y_wÜk”
.
¡İ
());

567 
h
 
š
 
	ghªdËs
 {

568 
Ët
 
Some
(
h
) = h {

569 
h
.
još
().
unw¿p
();

573 
	g£lf
.
	gcİroûssÜ_ho¡
.
shutdown
();

575 
	gšfo
!("stop„aftstore finished.");

578 
â
 
»gi¡”_¿á_ba£_tick
(&
£lf
, 
ev’t_loİ
: &
mut
 
Ev’tLoİ
<
S–f
>) {

581 
Ët
 
E¼
(
e
èğ
»gi¡”_tim”
(

582 
ev’t_loİ
,

583 
Tick
::
Raá
,

584 
£lf
.
cfg
.
¿á_ba£_tick_š‹rv®
.
as_mlis
(),

586 
	g”rÜ
!("{}„egi¡”„aá ba£ickƒ¼: {:?}", 
	g£lf
.
	gg
, 
	ge
);

590 
â
 
Ú_¿á_ba£_tick
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>) {

591 
Ët
 
tim”
 = 
£lf
.
¿á_m‘rics
.
´oûss_tick
.
¡¬t_cßr£_tim”
();

592 
³”
 
	gš
 &
mut
 
	g£lf
.
	g»giÚ_³”s
.
v®ues_mut
() {

593 
	g³”
.
	g³ndšg_»move
 {

599 
	g³”
.
is_­¶yšg_¢­shÙ
(è||…“r.
has_³ndšg_¢­shÙ
() {

601 
	g³”
.
m¬k_to_be_checked
(&
mut
 
£lf
.
³ndšg_¿á_groups
);

605 
	g³”
.
	g¿á_group
.
tick
() {

606 
	g³”
.
m¬k_to_be_checked
(&
mut
 
£lf
.
³ndšg_¿á_groups
);

624 
Ët
 
	gmax_missšg_du¿tiÚ
 = 
£lf
.
cfg
.
max_Ëad”_missšg_du¿tiÚ
.0;

625 
Ët
 
	gSËS‹
::
ToV®id©e
 = 
³”
.
check_¡®e_¡©e
(
max_missšg_du¿tiÚ
) {

627 
šfo
!(

630 
³”
.
g


632 
Ët
 
	gsk
 = 
PdTask
::
V®id©eP“r
 {

633 
³”
:…“r.³”.
şÚe
(),

634 
»giÚ
: 
³”
.»giÚ().
şÚe
(),

636 
Ët
 
E¼
(
e
èğ
£lf
.
pd_wÜk”
.
scheduË
(
sk
) {

637 
”rÜ
!("{} faedØnÙify…d: {}", 
³”
.
g
, 
e
)

642 
	g£lf
.
pŞl_signifiÿÁ_msg
();

644 
	gtim”
.
ob£rve_du¿tiÚ
();

646 
	g£lf
.
	g¿á_m‘rics
.
æush
();

647 
	g£lf
.
	g’Œy_ÿche_m‘r›s
.
bÜrow_mut
().
æush
();

649 
	g£lf
.
»gi¡”_¿á_ba£_tick
(
ev’t_loİ
);

652 
â
 
pŞl_­¶y
(&
mut
 
£lf
) {

653 
	gloİ
 {

654 
m©ch
 
	g£lf
.
	g­¶y_»s_»ûiv”
.
as_»f
().
unw¿p
().
Œy_»cv
() {

655 
Ok
(
AµlyTaskRes
::
Aµlys
(
muÉi_»s
)è=> 
»s
 
š
 multi_res {

656 
Ët
 
Some
(
p
èğ
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»s
.
»giÚ_id
) {

657 
debug
!("{}‡synø­¶y fšish: {:?}", 
p
.
g
, 
»s
);

658 
	gp
.
po¡_­¶y
(&
»s
, &
mut
 
£lf
.
³ndšg_¿á_groups
, &muˆ£lf.
¡Üe_¡©
);

660 
	g£lf
.
	g¡Üe_¡©
.
	glock_cf_by‹s_wr™‹n
 +ğ
»s
.
m‘rics
.
lock_cf_wr™‹n_by‹s
;

661 
	g£lf
.
Ú_»ady_»suÉ
(
»s
.
»giÚ_id
,„es.
exec_»s
);

663 
Ok
(
AµlyTaskRes
::
De¡roy
(
p
)) => {

664 
Ët
 
¡Üe_id
 = 
£lf
.store_id();

665 
	g£lf
.
de¡roy_³”
(
p
.
»giÚ_id
(), 
ut
::
Ãw_³”
(
¡Üe_id
,….
id
()));

667 
E¼
(
TryRecvE¼Ü
::
Em±y
) => ,

668 
E¼
(
e
è=> 
·nic
!("uÃx³ùedƒ¼Ü {:?}", 
	ge
),

677 
â
 
maybe_ü—‹_³”
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
msg
: &
RaáMes§ge
è-> 
ResuÉ
<
boŞ
> {

678 
Ët
 
rg‘
 = 
msg
.
g‘_to_³”
();

681 
Ët
 
mut
 
	ghas_³”
 = 
çl£
;

682 
Ët
 
mut
 
	gjob
 = 
NÚe
;

683 
Ët
 
Some
(
p
èğ
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
) {

684 
has_³”
 = 
Œue
;

685 
Ët
 
	grg‘_³”_id
 = 
rg‘
.
g‘_id
();

686 
	gp
.
³”_id
(è< 
	grg‘_³”_id
 {

687 
	gjob
 = 
p
.
maybe_de¡roy
();

688 
	gjob
.
is_nÚe
() {

689 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	g­¶yšg_¢­
 += 1;

690  
Ok
(
çl£
);

692 } 
	gp
.
³”_id
(è> 
	grg‘_³”_id
 {

693 
	gšfo
!(

695 
	g»giÚ_id
,

696 
	grg‘_³”_id
,

697 
	gp
.
³”_id
()

699 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	g¡®e_msg
 += 1;

700  
Ok
(
çl£
);

704 
Ët
 
Some
(
job
) = job {

705 
šfo
!(

707 
»giÚ_id
,

708 
job
.
³”


710 !
	g£lf
.
hªdË_de¡roy_³”
(
job
) {

711  
Ok
(
çl£
);

713 
	ghas_³”
 = 
çl£
;

716 
	ghas_³”
 {

717  
Ok
(
Œue
);

720 
Ët
 
	gmes§ge
 = 
msg
.
g‘_mes§ge
();

721 
Ët
 
	gmsg_ty³
 = 
mes§ge
.
g‘_msg_ty³
();

722 
	gmsg_ty³
 !ğ
Mes§geTy³
::
MsgReque¡VÙe
 &&

723 (
msg_ty³
 !ğ
Mes§geTy³
::
MsgH—¹b—t
 || 
mes§ge
.
g‘_comm™
(è!ğ
INVALID_INDEX
)

725 
debug
!(

727 
rg‘
,

728 
msg_ty³


730 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	g¡®e_msg
 += 1;

731  
Ok
(
çl£
);

734 
Ët
 
	g¡¬t_key
 = 
d©a_key
(
msg
.
g‘_¡¬t_key
());

735 
Ët
 
Some
((
_
, &
exi¡_»giÚ_id
)èğ
£lf
.
»giÚ_¿nges


736 .
¿nge
((
Exşuded
(
¡¬t_key
), 
Unbounded
::<
Key
>))

737 .
Ãxt
()

739 
Ët
 
exi¡_»giÚ
 = 
£lf
.
»giÚ_³”s
[&
exi¡_»giÚ_id
].
»giÚ
();

740 
’c_¡¬t_key
(
exi¡_»giÚ
è< 
d©a_’d_key
(
msg
.
g‘_’d_key
()) {

741 
	gdebug
!("msg {:?} i ov”Ïµed w™h„egiÚ {:?}", 
	gmsg
, 
	gexi¡_»giÚ
);

742 
	gut
::
is_fœ¡_vÙe_msg
(
msg
) {

743 
£lf
.
³ndšg_vÙes
.
push
(
msg
.
to_owÃd
());

745 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	g»giÚ_ov”Ïp
 += 1;

746  
Ok
(
çl£
);

750 
Ët
 
	g³”
 = 
P“r
::
»¶iÿ‹
(
£lf
, 
»giÚ_id
, 
rg‘
.
g‘_id
())?;

753 
	g£lf
.
	g»giÚ_³”s
.
š£¹
(
»giÚ_id
, 
³”
);

754 
Ok
(
Œue
)

757 
â
 
Ú_¿á_mes§ge
(&
mut
 
£lf
, muˆ
msg
: 
RaáMes§ge
è-> 
ResuÉ
<()> {

758 
Ët
 
»giÚ_id
 = 
msg
.
g‘_»giÚ_id
();

759 !
	g£lf
.
v®id©e_¿á_msg
(&
msg
) {

760  
Ok
(());

763 
	gmsg
.
g‘_is_tomb¡Úe
() {

765 
	g£lf
.
hªdË_gc_³”_msg
(&
msg
);

766  
Ok
(());

769 
	g£lf
.
check_msg
(&
msg
)? {

770  
Ok
(());

773 !
	g£lf
.
maybe_ü—‹_³”
(
»giÚ_id
, &
msg
)? {

774  
Ok
(());

777 
Ët
 
Some
(
key
èğ
£lf
.
check_¢­shÙ
(&
msg
)? {

782 
Ët
 
s
 = 
£lf
.
¢­_mgr
.
g‘_¢­shÙ_fÜ_­¶yšg
(&
key
)?;

783 
	g£lf
.
	g¢­_mgr
.
d–‘e_¢­shÙ
(&
key
, 
s
.
as_»f
(), 
çl£
);

784  
Ok
(());

787 
Ët
 
	g³”
 = 
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
).
unw¿p
();

788 
	g³”
.
š£¹_³”_ÿche
(
msg
.
ke_äom_³”
());

789 
	g³”
.
¡•
(
msg
.
ke_mes§ge
())?;

792 
	g³”
.
m¬k_to_be_checked
(&
mut
 
£lf
.
³ndšg_¿á_groups
);

794 
Ok
(())

798 
â
 
v®id©e_¿á_msg
(&
mut
 
£lf
, 
msg
: &
RaáMes§ge
è-> 
boŞ
 {

799 
Ët
 
»giÚ_id
 = 
msg
.
g‘_»giÚ_id
();

800 
Ët
 
	gäom
 = 
msg
.
g‘_äom_³”
();

801 
Ët
 
	gto
 = 
msg
.
g‘_to_³”
();

803 
	gdebug
!(

805 
	g»giÚ_id
,

806 
	gmsg
.
g‘_mes§ge
().
g‘_msg_ty³
(),

807 
	gäom
.
g‘_id
(),

808 
	gto
.
g‘_id
()

811 
	gto
.
g‘_¡Üe_id
(è!ğ
£lf
.
¡Üe_id
() {

812 
w¬n
!(

814 
»giÚ_id
,

815 
to
.
g‘_¡Üe_id
(),

816 
£lf
.
¡Üe_id
()

818 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	gmism©ch_¡Üe_id
 += 1;

819  
	gçl£
;

822 !
	gmsg
.
has_»giÚ_•och
() {

823 
	g”rÜ
!(

825 
	g»giÚ_id


827 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	gmism©ch_»giÚ_•och
 += 1;

828  
	gçl£
;

831 
	gŒue


834 
â
 
check_msg
(&
mut
 
£lf
, 
msg
: &
RaáMes§ge
è-> 
ResuÉ
<
boŞ
> {

835 
Ët
 
»giÚ_id
 = 
msg
.
g‘_»giÚ_id
();

836 
Ët
 
	gäom_•och
 = 
msg
.
g‘_»giÚ_•och
();

837 
Ët
 
	gmsg_ty³
 = 
msg
.
g‘_mes§ge
().
g‘_msg_ty³
();

838 
Ët
 
	gis_vÙe_msg
 = 
msg_ty³
 =ğ
Mes§geTy³
::
MsgReque¡VÙe
;

839 
Ët
 
	gäom_¡Üe_id
 = 
msg
.
g‘_äom_³”
().
g‘_¡Üe_id
();

859 
Ët
 
	gŒªs
 = &
£lf
.
Œªs
;

860 
Ët
 
	g¿á_m‘rics
 = &
mut
 
£lf
.
¿á_m‘rics
;

861 
Ët
 
Some
(
³”
èğ
£lf
.
»giÚ_³”s
.
g‘
(&
»giÚ_id
) {

862 
Ët
 
»giÚ
 = 
³”
.region();

863 
Ët
 
	g•och
 = 
»giÚ
.
g‘_»giÚ_•och
();

865 
	gut
::
is_•och_¡®e
(
äom_•och
, 
•och
) &&

866 
	gut
::
fšd_³”
(
»giÚ
, 
äom_¡Üe_id
).
is_nÚe
()

869 
	gS–f
::
hªdË_¡®e_msg
(
Œªs
, 
msg
, 
•och
, 
is_vÙe_msg
, 
¿á_m‘rics
);

870  
Ok
(
Œue
);

873  
Ok
(
çl£
);

877 
Ët
 
	g¡©e_key
 = 
keys
::
»giÚ_¡©e_key
(
»giÚ_id
);

878 
Ët
 
Some
(
loÿl_¡©e
èğ
£lf
.
kv_’gše


879 .
g‘_msg_cf
::<
RegiÚLoÿlS‹
>(
CF_RAFT
, &
	g¡©e_key
)?

881 
	gloÿl_¡©e
.
g‘_¡©e
(è!ğ
P“rS‹
::
Tomb¡Úe
 {

883 
¿á_m‘rics
.
mes§ge_drİ³d
.
»giÚ_nÚexi¡’t
 += 1;

884 
	gut
::
is_fœ¡_vÙe_msg
(
msg
) {

885 
£lf
.
³ndšg_vÙes
.
push
(
msg
.
to_owÃd
());

886 
	gšfo
!(

888 
	g»giÚ_id


890  
Ok
(
Œue
);

892  
E¼
(
box_”r
!(

894 
»giÚ_id
,

895 
loÿl_¡©e


898 
Ët
 
	g»giÚ
 = 
loÿl_¡©e
.
g‘_»giÚ
();

899 
Ët
 
	g»giÚ_•och
 = 
»giÚ
.
g‘_»giÚ_•och
();

901 
	gut
::
is_•och_¡®e
(
äom_•och
, 
»giÚ_•och
) {

902 
	gšfo
!(

905 
	g»giÚ_id
,

906 
	g»giÚ_•och
,

907 
	gmsg_ty³
,

910 
Ët
 
	gnÙ_exi¡
 = 
ut
::
fšd_³”
(
»giÚ
, 
äom_¡Üe_id
).
is_nÚe
();

911 
	gS–f
::
hªdË_¡®e_msg
(

912 
Œªs
,

913 
msg
,

914 
»giÚ_•och
,

915 
is_vÙe_msg
 && 
nÙ_exi¡
,

916 
¿á_m‘rics
,

919  
Ok
(
Œue
);

922 
	gäom_•och
.
g‘_cÚf_v”
(è=ğ
»giÚ_•och
.get_conf_ver() {

923 
¿á_m‘rics
.
mes§ge_drİ³d
.
»giÚ_tomb¡Úe_³”
 += 1;

924  
E¼
(
box_”r
!(

927 
»giÚ_•och
,

928 
msg_ty³


933 
Ok
(
çl£
)

936 
â
 
hªdË_¡®e_msg
(

937 
Œªs
: &
T
,

938 
msg
: &
RaáMes§ge
,

939 
cur_•och
: &
m‘­b
::
RegiÚEpoch
,

940 
Ãed_gc
: 
boŞ
,

941 
¿á_m‘rics
: &
mut
 
RaáM‘rics
,

943 
Ët
 
	g»giÚ_id
 = 
msg
.
g‘_»giÚ_id
();

944 
Ët
 
	gäom_³”
 = 
msg
.
g‘_äom_³”
();

945 
Ët
 
	gto_³”
 = 
msg
.
g‘_to_³”
();

946 
Ët
 
	gmsg_ty³
 = 
msg
.
g‘_mes§ge
().
g‘_msg_ty³
();

948 !
	gÃed_gc
 {

949 
	gšfo
!(

951 
	g»giÚ_id
,

952 
	gmsg_ty³
,

953 
	gcur_•och


955 
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	g¡®e_msg
 += 1;

959 
	gšfo
!(

961 
	g»giÚ_id
,

962 
	gmsg_ty³
,

963 
	gcur_•och


966 
Ët
 
mut
 
	ggc_msg
 = 
RaáMes§ge
::
Ãw
();

967 
	ggc_msg
.
£t_»giÚ_id
(
»giÚ_id
);

968 
	ggc_msg
.
£t_äom_³”
(
to_³”
.
şÚe
());

969 
	ggc_msg
.
£t_to_³”
(
äom_³”
.
şÚe
());

970 
	ggc_msg
.
£t_»giÚ_•och
(
cur_•och
.
şÚe
());

971 
	ggc_msg
.
£t_is_tomb¡Úe
(
Œue
);

972 
Ët
 
E¼
(
e
èğ
Œªs
.
£nd
(
gc_msg
) {

973 
”rÜ
!("[»giÚ {}] s’d gømes§gçed {:?}", 
»giÚ_id
, 
e
);

977 
â
 
hªdË_gc_³”_msg
(&
mut
 
£lf
, 
msg
: &
RaáMes§ge
) {

978 
Ët
 
»giÚ_id
 = 
msg
.
g‘_»giÚ_id
();

980 
Ët
 
mut
 
	gjob
 = 
NÚe
;

981 
Ët
 
Some
(
³”
èğ
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
) {

982 
Ët
 
äom_•och
 = 
msg
.
g‘_»giÚ_•och
();

983 
	gut
::
is_•och_¡®e
(
³”
.
g‘_¡Üe
().
»giÚ
.
g‘_»giÚ_•och
(), 
äom_•och
) {

984 
	g³”
.³” !ğ*
msg
.
g‘_to_³”
() {

985 
šfo
!("[»giÚ {}]„eûiv¡®gømes§ge, ignÜe.", 
»giÚ_id
);

986 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	g¡®e_msg
 += 1;

990 
	gšfo
!(

992 
	g»giÚ_id
,

993 
	gmsg
.
g‘_to_³”
()

995 
	gjob
 = 
³”
.
maybe_de¡roy
();

996 
	gjob
.
is_nÚe
() {

997 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	g­¶yšg_¢­
 += 1;

1003 
Ët
 
Some
(
job
) = job {

1004 
£lf
.
hªdË_de¡roy_³”
(
job
);

1008 
â
 
check_¢­shÙ
(&
mut
 
£lf
, 
msg
: &
RaáMes§ge
è-> 
ResuÉ
<
O±iÚ
<
SÇpKey
>> {

1009 
Ët
 
»giÚ_id
 = 
msg
.
g‘_»giÚ_id
();

1012 
	g£lf
.
	g»giÚ_³”s
[&
»giÚ_id
].
g‘_¡Üe
().
is_š™Ÿlized
() ||

1013 !
	gmsg
.
g‘_mes§ge
().
has_¢­shÙ
()

1015  
Ok
(
NÚe
);

1018 
Ët
 
	g¢­
 = 
msg
.
g‘_mes§ge
().
g‘_¢­shÙ
();

1019 
Ët
 
	gkey
 = 
SÇpKey
::
äom_»giÚ_¢­
(
»giÚ_id
, 
¢­
);

1020 
Ët
 
mut
 
	g¢­_d©a
 = 
RaáSÇpshÙD©a
::
Ãw
();

1021 
	g¢­_d©a
.
m”ge_äom_by‹s
(
¢­
.
g‘_d©a
())?;

1022 
Ët
 
	g¢­_»giÚ
 = 
¢­_d©a
.
ke_»giÚ
();

1023 
Ët
 
	g³”_id
 = 
msg
.
g‘_to_³”
().
g‘_id
();

1024 
	g¢­_»giÚ


1025 .
g‘_³”s
()

1026 .
što_™”
()

1027 .
®l
(|
p
|….
g‘_id
(è!ğ
³”_id
)

1029 
šfo
!(

1031 
¢­_»giÚ
.
g‘_id
(),

1032 
¢­_»giÚ
,

1033 
msg
.
g‘_to_³”
()

1035 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	g»giÚ_no_³”
 += 1;

1036  
Ok
(
Some
(
key
));

1038 
Ët
 
Some
((
_
, &
exi¡_»giÚ_id
)èğ
£lf
.
»giÚ_¿nges


1039 .
¿nge
((
Exşuded
(
’c_¡¬t_key
(&
¢­_»giÚ
)), 
Unbounded
::<
Key
>))

1040 .
Ãxt
()

1042 
Ët
 
exi¡_»giÚ
 = 
£lf
.
»giÚ_³”s
[&
exi¡_»giÚ_id
].
»giÚ
();

1043 
’c_¡¬t_key
(
exi¡_»giÚ
è< 
’c_’d_key
(&
¢­_»giÚ
) {

1044 
	gšfo
!("»giÚ ov”Ïµed {:?}, {:?}", 
	gexi¡_»giÚ
, 
	g¢­_»giÚ
);

1045 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	g»giÚ_ov”Ïp
 += 1;

1046  
Ok
(
Some
(
key
));

1049 
»giÚ
 
	gš
 &
	g£lf
.
	g³ndšg_¢­shÙ_»giÚs
 {

1050 
’c_¡¬t_key
(
»giÚ
è< 
’c_’d_key
(&
¢­_»giÚ
) &&

1051 
’c_’d_key
(
»giÚ
è> 
’c_¡¬t_key
(&
¢­_»giÚ
) &&

1053 
	g»giÚ
.
g‘_id
(è!ğ
¢­_»giÚ
.get_id()

1055 
šfo
!("³ndšg„egiÚ ov”Ïµed {:?}, {:?}", 
»giÚ
, 
¢­_»giÚ
);

1056 
	g£lf
.
	g¿á_m‘rics
.
	gmes§ge_drİ³d
.
	g»giÚ_ov”Ïp
 += 1;

1057  
Ok
(
Some
(
key
));

1061 
	g£lf
.
	g¢­_mgr
.
g‘_¢­shÙ_fÜ_­¶yšg
(&
key
)?;

1063 
	g£lf
.
	g³ndšg_¢­shÙ_»giÚs
.
push
(
¢­_»giÚ
);

1065 
Ok
(
NÚe
)

1068 
â
 
Ú_¿á_»ady
(&
mut
 
£lf
) {

1069 
Ët
 
	gt
 = 
SlowTim”
::
Ãw
();

1070 
Ët
 
	g³ndšg_couÁ
 = 
£lf
.
³ndšg_¿á_groups
.
Ën
();

1071 
Ët
 
	g´evious_»ady_m‘rics
 = 
£lf
.
¿á_m‘rics
.
»ady
.
şÚe
();

1073 
	g£lf
.
	g¿á_m‘rics
.
	g»ady
.
	g³ndšg_»giÚ
 +ğ
³ndšg_couÁ
 
as
 
u64
;

1075 
Ët
 
mut
 
	g»giÚ_´İo§ls
 = 
Vec
::
w™h_ÿ·c™y
(
³ndšg_couÁ
);

1076 
Ët
 (
kv_wb
, 
¿á_wb
, 
­³nd_»s
, 
sync_log
) = {

1077 
Ët
 
mut
 
ùx
 = 
R—dyCÚ‹xt
::
Ãw
(&muˆ
£lf
.
¿á_m‘rics
, &£lf.
Œªs
, 
³ndšg_couÁ
);

1078 
»giÚ_id
 
š
 
	g£lf
.
	g³ndšg_¿á_groups
.
d¿š
() {

1079 
Ët
 
Some
(
³”
èğ
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
) {

1080 
Ët
 
Some
(
»giÚ_´İo§l
èğ
³”
.
ke_­¶y_´İo§ls
() {

1081 
»giÚ_´İo§ls
.
push
(
»giÚ_´İo§l
);

1083 
	g³”
.
hªdË_¿á_»ady_­³nd
(&
mut
 
ùx
, &
£lf
.
pd_wÜk”
);

1086 (
	gùx
.
	gkv_wb
, ctx.
	g¿á_wb
, ctx.
	g»ady_»s
, ctx.
	gsync_log
)

1089 !
	g»giÚ_´İo§ls
.
is_em±y
() {

1090 
	g£lf
.
	g­¶y_wÜk”


1091 .
scheduË
(
AµlyTask
::
Prİo§ls
(
»giÚ_´İo§ls
))

1092 .
unw¿p
();

1097 
	g£lf
.
	gŒªs
.
æush
();

1100 
	g£lf
.
	g¿á_m‘rics
.
	g»ady
.
	ghas_»ady_»giÚ
 +ğ
­³nd_»s
.
Ën
(è
as
 
u64
;

1105 
	gç_pošt
!("raft_before_save");

1106 !
	gkv_wb
.
is_em±y
() {

1108 
Ët
 
mut
 
	gwr™e_İts
 = 
Wr™eO±iÚs
::
Ãw
();

1109 
	gwr™e_İts
.
£t_sync
(
Œue
);

1110 
	g£lf
.
	gkv_’gše


1111 .
wr™e_İt
(
kv_wb
, &
wr™e_İts
)

1112 .
unw¿p_Ü_–£
(|
e
| {

1113 
·nic
!("{} faedØ§v­³nd s‹„esuÉ: {:?}", 
£lf
.
g
, 
e
);

1116 
	gç_pošt
!("raft_between_save");

1118 !
	g¿á_wb
.
is_em±y
() {

1120 
Ët
 
mut
 
	gwr™e_İts
 = 
Wr™eO±iÚs
::
Ãw
();

1121 
	gwr™e_İts
.
£t_sync
(
£lf
.
cfg
.
sync_log
 || sync_log);

1122 
	g£lf
.
	g¿á_’gše


1123 .
wr™e_İt
(
¿á_wb
, &
wr™e_İts
)

1124 .
unw¿p_Ü_–£
(|
e
| {

1125 
·nic
!("{} faedØ§v¿á‡µ’d„esuÉ: {:?}", 
£lf
.
g
, 
e
);

1128 
	gç_pošt
!("raft_after_save");

1130 
Ët
 
mut
 
	g»ady_»suÉs
 = 
Vec
::
w™h_ÿ·c™y
(
­³nd_»s
.
Ën
());

1131 
mut
 
	g»ady
, 
	gšvoke_ùx
è
š
 
	g­³nd_»s
 {

1132 
Ët
 
	g»giÚ_id
 = 
švoke_ùx
.
»giÚ_id
;

1133 
Ët
 
	g»s
 =

1134 
£lf
.
»giÚ_³”s


1135 .
g‘_mut
(&
»giÚ_id
)

1136 .
unw¿p
()

1137 .
po¡_¿á_»ady_­³nd
(

1138 &
mut
 
£lf
.
¿á_m‘rics
,

1139 &
£lf
.
Œªs
,

1140 &
mut
 
»ady
,

1141 
švoke_ùx
,

1143 
	g»ady_»suÉs
.
push
((
»giÚ_id
, 
»ady
, 
»s
));

1146 
	g£lf
.
	g¿á_m‘rics


1147 .
	g­³nd_log


1148 .
ob£rve
(
du¿tiÚ_to_£c
(
t
.
–­£d
()è
as
 
f64
);

1150 
	g¦ow_log
!(

1151 
	gt
,

1154 
	g£lf
.
	gg
,

1155 
	g³ndšg_couÁ
,

1156 
	g»ady_»suÉs
.
ÿ·c™y
(),

1157 
	g£lf
.
	g¿á_m‘rics
.
	g»ady
.
	g­³nd
 - 
	g´evious_»ady_m‘rics
.append,

1158 
	g£lf
.
	g¿á_m‘rics
.
	g»ady
.
	gmes§ge
 - 
	g´evious_»ady_m‘rics
.message,

1159 
	g£lf
.
	g¿á_m‘rics
.
	g»ady
.
	g¢­shÙ
 - 
	g´evious_»ady_m‘rics
.snapshot

1162 
Ët
 
mut
 
	g­¶y_sks
 = 
Vec
::
w™h_ÿ·c™y
(
»ady_»suÉs
.
Ën
());

1163 
	g»giÚ_id
, 
	g»ady
, 
	g»s
è
š
 
	g»ady_»suÉs
 {

1164 
	g£lf
.
	g»giÚ_³”s


1165 .
g‘_mut
(&
»giÚ_id
)

1166 .
unw¿p
()

1167 .
hªdË_¿á_»ady_­¶y
(
»ady
, &
mut
 
­¶y_sks
);

1168 
Ët
 
Some
(
­¶y_»suÉ
èğ
»s
 {

1169 
£lf
.
Ú_»ady_­¶y_¢­shÙ
(
­¶y_»suÉ
);

1172 
	g£lf
.
	g­¶y_wÜk”


1173 .
scheduË
(
AµlyTask
::
­¶›s
(
­¶y_sks
))

1174 .
unw¿p
();

1176 
Ët
 
	gdur
 = 
t
.
–­£d
();

1177 !
	g£lf
.
	gis_busy
 {

1178 
Ët
 
	g–eùiÚ_timeout
 = 
Du¿tiÚ
::
äom_mlis
(

1179 
£lf
.
cfg
.
¿á_ba£_tick_š‹rv®
.
as_mlis
() *

1180 
£lf
.
cfg
.
¿á_–eùiÚ_timeout_ticks
 
as
 
u64
,

1182 
	gdur
 >ğ
–eùiÚ_timeout
 {

1183 
£lf
.
is_busy
 = 
Œue
;

1187 
	g£lf
.
	g¿á_m‘rics


1188 .
	g´oûss_»ady


1189 .
ob£rve
(
du¿tiÚ_to_£c
(
dur
è
as
 
f64
);

1191 
	g£lf
.
	gŒªs
.
æush
();

1193 
	g¦ow_log
!(
	gt
, "{} oÀ{}„egiÚ ¿á„—dy", 
	g£lf
.
	gg
, 
	g³ndšg_couÁ
);

1196 
â
 
hªdË_de¡roy_³”
(&
mut
 
£lf
, 
job
: 
De¡royP“rJob
è-> 
boŞ
 {

1197 
job
.
š™Ÿlized
 {

1198 
£lf
.
­¶y_wÜk”


1199 .
scheduË
(
AµlyTask
::
de¡roy
(
job
.
»giÚ_id
))

1200 .
unw¿p
();

1202 
	gjob
.
	gasync_»move
 {

1203 
	gšfo
!(

1205 
	gjob
.
	g»giÚ_id
,

1206 
	gjob
.
	g³”
.
g‘_id
()

1208 
	gçl£


1210 
	g£lf
.
de¡roy_³”
(
job
.
»giÚ_id
, job.
³”
);

1211 
	gŒue


1215 
pub
 
â
 
de¡roy_³”
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
³”
: 
m‘­b
::
P“r
) {

1224 
Ët
 
mut
 
p
 = 
m©ch
 
£lf
.
»giÚ_³”s
.
»move
(&
»giÚ_id
) {

1225 
NÚe
 => ,

1226 
Some
(
p
è=> p.
³”_id
(è=ğ
³”
.
g‘_id
() {

1227 
p


1229 
as£¹
!(
p
.
³”_id
(è> 
³”
.
g‘_id
());

1231 
	g£lf
.
	g»giÚ_³”s
.
š£¹
(
»giÚ_id
, 
p
);

1236 
	gšfo
!("[»giÚ {}] de¡roy…“¸{:?}", 
	g»giÚ_id
, 
	g³”
);

1238 
	gas£¹
!(!
	gp
.
is_­¶yšg_¢­shÙ
());

1239 
Ët
 
	gsk
 = 
PdTask
::
De¡royP“r
 {

1240 
»giÚ_id
:„egion_id,

1242 
Ët
 
E¼
(
e
èğ
£lf
.
pd_wÜk”
.
scheduË
(
sk
) {

1243 
”rÜ
!("{} faedØnÙify…d: {}", 
£lf
.
g
, 
e
);

1245 
Ët
 
	gis_š™Ÿlized
 = 
p
.
is_š™Ÿlized
();

1246 
Ët
 
E¼
(
e
èğ
p
.
de¡roy
() {

1251 
·nic
!(

1253 
»giÚ_id
,

1254 
³”
,

1255 
£lf
.
¡Üe_id
(),

1256 
e


1260 
	gis_š™Ÿlized
 &&

1261 
	g£lf
.
	g»giÚ_¿nges


1262 .
»move
(&
’c_’d_key
(
p
.
»giÚ
()))

1263 .
is_nÚe
()

1265 
	g·nic
!(

1267 
	g»giÚ_id
,

1268 
	g³”
,

1269 
	g£lf
.
¡Üe_id
()

1275 
â
 
Ú_»ady_chªge_³”
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
ı
: 
ChªgeP“r
) {

1276 
Ët
 
my_³”_id
;

1277 
Ët
 
	gchªge_ty³
 = 
ı
.
cÚf_chªge
.
g‘_chªge_ty³
();

1278 
Ët
 
Some
(
p
èğ
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
) {

1279 
p
.
¿á_group
.
­¶y_cÚf_chªge
(&
ı
.
cÚf_chªge
);

1280 
	gı
.
	gcÚf_chªge
.
g‘_node_id
(è=ğ
¿á
::
INVALID_ID
 {

1284 
	gp
.
mut_¡Üe
().
	g»giÚ
 = 
ı
.
»giÚ
;

1285 
	gp
.
is_Ëad”
() {

1287 
	gšfo
!(

1289 
	gp
.
	gg
,

1290 
	gp
.
»giÚ
()

1292 
	gp
.
h—¹b—t_pd
(&
£lf
.
pd_wÜk”
);

1295 
m©ch
 
	gchªge_ty³
 {

1296 
	gCÚfChªgeTy³
::
AddNode
 => {

1298 
Ët
 
³”
 = 
ı
.³”.
şÚe
();

1299 
	gp
.
	g³”_h—¹b—ts
.
š£¹
(
³”
.
g‘_id
(), 
In¡ªt
::
now
());

1300 
	gp
.
š£¹_³”_ÿche
(
³”
);

1302 
	gCÚfChªgeTy³
::
RemoveNode
 => {

1304 
p
.
³”_h—¹b—ts
.
»move
(&
ı
.
³”
.
g‘_id
());

1305 
	gp
.
»move_³”_äom_ÿche
(
ı
.
³”
.
g‘_id
());

1307 
	gCÚfChªgeTy³
::
AddL—º”Node
 => 
unim¶em’‹d
!(),

1310 
	gmy_³”_id
 = 
p
.
³”_id
();

1312 
	g·nic
!("{} missšg„egiÚ {}", 
	g£lf
.
	gg
, 
	g»giÚ_id
);

1315 
Ët
 
	g³”
 = 
ı
.
³”
;

1318 
	gchªge_ty³
 =ğ
CÚfChªgeTy³
::
RemoveNode
 && 
³”
.
g‘_¡Üe_id
(è=ğ
£lf
.
¡Üe_id
() {

1319 
my_³”_id
 =ğ
³”
.
g‘_id
() {

1320 
£lf
.
de¡roy_³”
(
»giÚ_id
, 
³”
)

1322 
·nic
!("{}ryšgØ»movunknowÀ³” {:?}", 
£lf
.
g
, 
³”
);

1327 
â
 
Ú_»ady_com·ù_log
(

1328 &
mut
 
£lf
,

1329 
»giÚ_id
: 
u64
,

1330 
fœ¡_šdex
: 
u64
,

1331 
¡©e
: 
RaáTrunÿ‹dS‹
,

1333 
Ët
 
	g³”
 = 
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
).
unw¿p
();

1334 
Ët
 
	gtÙ®_út
 = 
³”
.
Ï¡_­¶yšg_idx
 - 
fœ¡_šdex
;

1336 
Ët
 
	g»maš_út
 = 
³”
.
Ï¡_­¶yšg_idx
 - 
¡©e
.
g‘_šdex
() - 1;

1337 
	g³”
.
	g¿á_log_size_hšt
 = 
³”
.
¿á_log_size_hšt
 * 
»maš_út
 / 
tÙ®_út
;

1338 
Ët
 
	gsk
 = 
RaálogGcTask
 {

1339 
¿á_’gše
: 
³”
.
g‘_¡Üe
().
g‘_¿á_’gše
().
şÚe
(),

1340 
»giÚ_id
: 
³”
.
g‘_¡Üe
().
g‘_»giÚ_id
(),

1341 
¡¬t_idx
: 
³”
.
Ï¡_com·ùed_idx
,

1342 
’d_idx
: 
¡©e
.
g‘_šdex
() + 1,

1344 
	g³”
.
	gÏ¡_com·ùed_idx
 = 
sk
.
’d_idx
;

1345 
	g³”
.
mut_¡Üe
().
com·ù_to
(
sk
.
’d_idx
);

1346 
Ët
 
E¼
(
e
èğ
£lf
.
¿álog_gc_wÜk”
.
scheduË
(
sk
) {

1347 
”rÜ
!(

1349 
»giÚ_id
,

1350 
e


1355 
â
 
Ú_»ady_¥l™_»giÚ
(

1356 &
mut
 
£lf
,

1357 
»giÚ_id
: 
u64
,

1358 
Ëá
: 
m‘­b
::
RegiÚ
,

1359 
right
: 
m‘­b
::
RegiÚ
,

1360 
right_d”ive
: 
boŞ
,

1362 
Ët
 (
Üigš_»giÚ
, 
Ãw_»giÚ
èğ
right_d”ive
 {

1363 (
right
.
şÚe
(), 
Ëá
.clone())

1365 (
Ëá
.
şÚe
(), 
right
.clone())

1368 
	g£lf
.
	g»giÚ_³”s


1369 .
g‘_mut
(&
»giÚ_id
)

1370 .
unw¿p
()

1371 .
mut_¡Üe
()

1372 .
	g»giÚ
 = 
Üigš_»giÚ
.
şÚe
();

1373 
Ët
 
	gÃw_»giÚ_id
 = 
Ãw_»giÚ
.
g‘_id
();

1374 
Ët
 
Some
(
³”
èğ
£lf
.
»giÚ_³”s
.
g‘
(&
Ãw_»giÚ_id
) {

1378 
³”
.
g‘_¡Üe
().
is_š™Ÿlized
() {

1379 
·nic
!("du¶iÿ‹d„egiÚ {} fÜ s¶™„egiÚ", 
Ãw_»giÚ_id
);

1383 
Ët
 
mut
 
	gÿm·igÃd
 = 
çl£
;

1384 
Ët
 
	g³”
;

1385 
m©ch
 
	gP“r
::
ü—‹
(
£lf
, &
Ãw_»giÚ
) {

1386 
E¼
(
e
) => {

1389 
·nic
!("ü—‹‚ew s¶™„egiÚ {:?}ƒ¼ {:?}", 
Ãw_»giÚ
, 
e
);

1391 
Ok
(
mut
 
Ãw_³”
) => {

1392 
³”
 
š
 
Ãw_»giÚ
.
g‘_³”s
() {

1394 
Ãw_³”
.
š£¹_³”_ÿche
(
³”
.
şÚe
());

1396 
	g³”
 = 
Ãw_³”
.
³”
.
şÚe
();

1397 
Ët
 
Some
(
Üigš_³”
èğ
£lf
.
»giÚ_³”s
.
g‘
(&
»giÚ_id
) {

1400 
Ãw_³”
.
³”_¡©
 = 
Üigš_³”
.³”_¡©.
şÚe
();

1402 
	gÿm·igÃd
 =

1403 
Ãw_³”
.
maybe_ÿm·ign
(
Üigš_³”
, &
mut
 
£lf
.
³ndšg_¿á_groups
);

1405 
	gÜigš_³”
.
is_Ëad”
() {

1407 
	gright_d”ive
 {

1408 
	g£lf
.
»pÜt_¥l™_pd
(&
Ãw_³”
, 
Üigš_³”
);

1410 
	g£lf
.
»pÜt_¥l™_pd
(
Üigš_³”
, &
Ãw_³”
);

1416 
	gšfo
!("š£¹‚ew„egiÚ Ëá: {:?},„ight:{:?}", 
	gËá
, 
	gright
);

1417 
	g£lf
.
	g»giÚ_¿nges


1418 .
š£¹
(
’c_’d_key
(&
Ëá
),†eá.
g‘_id
())

1419 .
is_some
()

1421 
	g·nic
!("»giÚ should‚Ùƒxi¡, {:?}", 
	gËá
);

1423 
	g£lf
.
	g»giÚ_¿nges


1424 .
š£¹
(
’c_’d_key
(&
right
),„ight.
g‘_id
())

1425 .
is_nÚe
()

1427 
	g·nic
!("»giÚ shouldƒxi¡, {:?}", 
	gright
);

1432 
	gright_d”ive
 {

1433 
	g£lf
.
	g»giÚ_³”s


1434 .
g‘_mut
(&
»giÚ_id
)

1435 .
unw¿p
()

1436 .
	gsize_diff_hšt
 = 
£lf
.
cfg
.
»giÚ_¥l™_check_diff
.0;

1438 
	gÃw_³”
.
	gsize_diff_hšt
 = 
£lf
.
cfg
.
»giÚ_¥l™_check_diff
.0;

1440 
	g£lf
.
	g­¶y_wÜk”


1441 .
scheduË
(
AµlyTask
::(&
Ãw_³”
))

1442 .
unw¿p
();

1443 
	g£lf
.
	g»giÚ_³”s
.
š£¹
(
Ãw_»giÚ_id
, 
Ãw_³”
);

1447 !
	gÿm·igÃd
 {

1448 
Ët
 
Some
(
msg
èğ
£lf
.
³ndšg_vÙes


1449 .
sw­_»move_äÚt
(|
m
| m.
g‘_to_³”
(è=ğ&
³”
)

1451 
Ët
 
_
 = 
£lf
.
Ú_¿á_mes§ge
(
msg
);

1456 
â
 
»pÜt_¥l™_pd
(&
£lf
, 
Ëá
: &
P“r
, 
right
: &Peer) {

1457 
Ët
 
Ëá_»giÚ
 = 
Ëá
.
»giÚ
();

1458 
Ët
 
	gright_»giÚ
 = 
right
.
»giÚ
();

1460 
	gšfo
!(

1462 
	gËá_»giÚ
,

1463 
	gright_»giÚ


1465 
	gright
.
h—¹b—t_pd
(&
£lf
.
pd_wÜk”
);

1466 
	gËá
.
h—¹b—t_pd
(&
£lf
.
pd_wÜk”
);

1470 
Ët
 
	gsk
 = 
PdTask
::
R•ÜtS¶™
 {

1471 
Ëá
: 
Ëá_»giÚ
.
şÚe
(),

1472 
right
: 
right_»giÚ
.
şÚe
(),

1475 
Ët
 
E¼
(
e
èğ
£lf
.
pd_wÜk”
.
scheduË
(
sk
) {

1476 
”rÜ
!("{} faedØnÙify…d: {}", 
£lf
.
g
, 
e
);

1480 
â
 
Ú_»ady_­¶y_¢­shÙ
(&
mut
 
£lf
, 
­¶y_»suÉ
: 
AµlySÇpResuÉ
) {

1481 
Ët
 
´ev_»giÚ
 = 
­¶y_»suÉ
.prev_region;

1482 
Ët
 
	g»giÚ
 = 
­¶y_»suÉ
.
»giÚ
;

1483 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

1485 
	gšfo
!(

1487 
	g»giÚ_id
,

1488 
	g»giÚ


1491 !
	g´ev_»giÚ
.
g‘_³”s
().
is_em±y
() {

1492 
	gšfo
!(

1494 
	g»giÚ_id
,

1495 
	g´ev_»giÚ
,

1496 
	g»giÚ


1499 
	g£lf
.
	g»giÚ_¿nges


1500 .
»move
(&
’c_’d_key
(&
´ev_»giÚ
))

1501 .
is_nÚe
()

1503 
	g·nic
!(

1505 
	g»giÚ_id
,

1506 
	g´ev_»giÚ


1511 
	g£lf
.
	g»giÚ_¿nges


1512 .
š£¹
(
’c_’d_key
(&
»giÚ
),„egiÚ.
g‘_id
());

1515 
â
 
Ú_»ady_»suÉ
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
exec_»suÉs
: 
Vec
<
ExecResuÉ
>) {

1517 
»suÉ
 
š
 
exec_»suÉs
 {

1518 
m©ch
 
»suÉ
 {

1519 
ExecResuÉ
::
ChªgeP“r
(
ı
è=> 
£lf
.
Ú_»ady_chªge_³”
(
»giÚ_id
, cp),

1520 
	gExecResuÉ
::
Com·ùLog
 { 
fœ¡_šdex
, 
	g¡©e
 } => {

1521 
£lf
.
Ú_»ady_com·ù_log
(
»giÚ_id
, 
fœ¡_šdex
, 
¡©e
)

1523 
ExecResuÉ
::
S¶™RegiÚ
 {

1524 
Ëá
,

1525 
right
,

1526 
right_d”ive
,

1527 } => 
£lf
.
Ú_»ady_¥l™_»giÚ
(
»giÚ_id
, 
Ëá
, 
right
, 
right_d”ive
),

1528 
	gExecResuÉ
::
Compu‹Hash
 {

1529 
»giÚ
,

1530 
	gšdex
,

1531 
	g¢­
,

1532 } => 
£lf
.
Ú_»ady_compu‹_hash
(
»giÚ
, 
šdex
, 
¢­
),

1533 
	gExecResuÉ
::
V”ifyHash
 { 
šdex
, 
	ghash
 } => {

1534 
£lf
.
Ú_»ady_v”ify_hash
(
»giÚ_id
, 
šdex
, 
hash
)

1536 
ExecResuÉ
::
D–‘eRªge
 { .. } => {

1543 
â
 
´e_´İo£_¿á_commªd
(

1544 &
mut
 
£lf
,

1545 
msg
: &
RaáCmdReque¡
,

1546 è-> 
	gResuÉ
<
	gO±iÚ
<
	gRaáCmdRe¥Ú£
>> {

1547 
	g£lf
.
v®id©e_¡Üe_id
(
msg
)?;

1548 
	gmsg
.
has_¡©us_»que¡
() {

1550 
Ët
 
	g»¥
 = 
£lf
.
execu‹_¡©us_commªd
(
msg
)?;

1551  
Ok
(
Some
(
»¥
));

1553 
	g£lf
.
v®id©e_»giÚ
(
msg
)?;

1554 
Ok
(
NÚe
)

1557 
â
 
´İo£_¿á_commªd
(&
mut
 
£lf
, 
msg
: 
RaáCmdReque¡
, 
cb
: 
C®lback
) {

1558 
m©ch
 
£lf
.
´e_´İo£_¿á_commªd
(&
msg
) {

1559 
Ok
(
Some
(
»¥
)) => {

1560 
cb
.
ÿÎ_box
((
»¥
,));

1563 
E¼
(
e
) => {

1564 
cb
.
ÿÎ_box
((
Ãw_”rÜ
(
e
),));

1567 
	g_
 => (),

1575 
Ët
 
mut
 
	g»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

1576 
Ët
 
	g»giÚ_id
 = 
msg
.
g‘_h—d”
().
g‘_»giÚ_id
();

1577 
Ët
 
	g³”
 = 
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
).
unw¿p
();

1578 
Ët
 
	g‹rm
 = 
³”
.
‹rm
();

1579 
bšd_‹rm
(&
mut
 
»¥
, 
‹rm
);

1580 
	g³”
.
´İo£
(
cb
, 
msg
, 
»¥
, &
mut
 
£lf
.
¿á_m‘rics
.propose) {

1581 
	g³”
.
m¬k_to_be_checked
(&
mut
 
£lf
.
³ndšg_¿á_groups
);

1588 
â
 
´İo£_b©ch_¿á_¢­shÙ_commªd
(

1589 &
mut
 
£lf
,

1590 
b©ch
: 
Vec
<
RaáCmdReque¡
>,

1591 
Ú_fšished
: 
B©chC®lback
,

1593 
Ët
 
	gsize
 = 
b©ch
.
Ën
();

1594 
	gBATCH_SNAPSHOT_COMMANDS
.
ob£rve
(
size
 
as
 
f64
);

1595 
Ët
 
mut
 
	g»t
 = 
Vec
::
w™h_ÿ·c™y
(
size
);

1596 
msg
 
š
 
	gb©ch
 {

1597 
m©ch
 
	g£lf
.
´e_´İo£_¿á_commªd
(&
msg
) {

1598 
Ok
(
Some
(
»¥
)) => {

1599 
»t
.
push
(
Some
(
»¥
));

1602 
E¼
(
e
) => {

1603 
»t
.
push
(
Some
(
Ãw_”rÜ
(
e
)));

1606 
	g_
 => (),

1609 
Ët
 
	g»giÚ_id
 = 
msg
.
g‘_h—d”
().
g‘_»giÚ_id
();

1610 
Ët
 
	g³”
 = 
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
).
unw¿p
();

1611 
	g»t
.
push
(
³”
.
´İo£_¢­shÙ
(
msg
, &
mut
 
£lf
.
¿á_m‘rics
.
´İo£
));

1613 
	gÚ_fšished
.
ÿÎ_box
((
»t
,));

1616 
â
 
v®id©e_¡Üe_id
(&
£lf
, 
msg
: &
RaáCmdReque¡
è-> 
ResuÉ
<()> {

1617 
Ët
 
¡Üe_id
 = 
msg
.
g‘_h—d”
().
g‘_³”
().
g‘_¡Üe_id
();

1618 
	g¡Üe_id
 !ğ
£lf
.
¡Üe
.
g‘_id
() {

1619  
E¼
(
E¼Ü
::
StÜeNÙM©ch
(
¡Üe_id
, 
£lf
.
¡Üe
.
g‘_id
()));

1621 
Ok
(())

1624 
â
 
v®id©e_»giÚ
(&
£lf
, 
msg
: &
RaáCmdReque¡
è-> 
ResuÉ
<()> {

1625 
Ët
 
»giÚ_id
 = 
msg
.
g‘_h—d”
().
g‘_»giÚ_id
();

1626 
Ët
 
	g³”_id
 = 
msg
.
g‘_h—d”
().
g‘_³”
().
g‘_id
();

1628 
Ët
 
	g³”
 = 
m©ch
 
£lf
.
»giÚ_³”s
.
g‘
(&
»giÚ_id
) {

1629 
Some
(
³”
) =>…eer,

1630 
	gNÚe
 =>  
E¼
(
E¼Ü
::
RegiÚNÙFound
(
»giÚ_id
)),

1632 !
	g³”
.
is_Ëad”
() {

1633  
E¼
(
E¼Ü
::
NÙL—d”
(

1634 
»giÚ_id
,

1635 
³”
.
g‘_³”_äom_ÿche
Õ“r.
Ëad”_id
()),

1638 
	g³”
.
³”_id
() !=…eer_id {

1639  
E¼
(
box_”r
!(

1641 
³”
.
³”_id
(),

1642 
³”_id


1646 
Ët
 
	gh—d”
 = 
msg
.
g‘_h—d”
();

1648 
	gh—d”
.
g‘_‹rm
(è> 0 && 
	g³”
.
‹rm
() > header.get_term() + 1 {

1649  
E¼
(
E¼Ü
::
SËCommªd
);

1652 
Ët
 
	g»s
 = 
³”
::
check_•och
Õ“r.
»giÚ
(), 
msg
);

1653 
Ët
 
E¼
(
E¼Ü
::
SËEpoch
(
msg
, 
mut
 
Ãw_»giÚs
)èğ
»s
 {

1658 
Ët
 
siblšg_»giÚ_id
 = 
£lf
.
fšd_siblšg_»giÚ
(
³”
.
»giÚ
());

1659 
Ët
 
Some
(
siblšg_»giÚ_id
) = sibling_region_id {

1660 
Ët
 
siblšg_»giÚ
 = 
£lf
.
»giÚ_³”s
[&
siblšg_»giÚ_id
].
»giÚ
();

1661 
	gÃw_»giÚs
.
push
(
siblšg_»giÚ
.
to_owÃd
());

1663  
E¼
(
E¼Ü
::
SËEpoch
(
msg
, 
Ãw_»giÚs
));

1665 
	g»s


1668 
pub
 
â
 
fšd_siblšg_»giÚ
(&
£lf
, 
»giÚ
: &
m‘­b
::
RegiÚ
è-> 
O±iÚ
<
u64
> {

1669 
Ët
 
¡¬t
 = 
£lf
.
cfg
.
right_d”ive_wh’_¥l™
 {

1670 
Inşuded
(
’c_¡¬t_key
(
»giÚ
))

1672 
Exşuded
(
’c_’d_key
(
»giÚ
))

1674 
	g£lf
.
	g»giÚ_¿nges


1675 .
¿nge
((
¡¬t
, 
Unbounded
::<
Key
>))

1676 .
Ãxt
()

1677 .
m­
(|(
_
, &
»giÚ_id
)|„egion_id)

1680 
â
 
»gi¡”_¿á_gc_log_tick
(&
£lf
, 
ev’t_loİ
: &
mut
 
Ev’tLoİ
<
S–f
>) {

1681 
Ët
 
E¼
(
e
èğ
»gi¡”_tim”
(

1682 
ev’t_loİ
,

1683 
Tick
::
RaáLogGc
,

1684 
£lf
.
cfg
.
¿á_log_gc_tick_š‹rv®
.
as_mlis
(),

1689 
	g”rÜ
!("{}„egi¡”„aá gølogickƒ¼: {:?}", 
	g£lf
.
	gg
, 
	ge
);

1693 #[
®low
(
if_§me_th’_–£
)]

1694 
â
 
Ú_¿á_gc_log_tick
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>) {

1695 
Ët
 
mut
 
tÙ®_gc_logs
 = 0;

1697 &
	g»giÚ_id
, 
	g³”
è
	gš
 &
mut
 
	g£lf
.
	g»giÚ_³”s
 {

1698 !
	g³”
.
is_Ëad”
() {

1714 
Ët
 
	g»¶iÿ‹d_idx
 = 
³”
.
¿á_group


1715 .
¡©us
()

1716 .
´og»ss


1717 .
v®ues
()

1718 .
m­
(|
p
|….
m©ched
)

1719 .
mš
()

1720 .
unw¿p
();

1722 
	g»¶iÿ‹d_idx
 > 0 {

1723 
Ët
 
	gÏ¡_idx
 = 
³”
.
¿á_group
.
¿á
.
¿á_log
.
Ï¡_šdex
();

1724 
	gas£¹
!(

1725 
	gÏ¡_idx
 >ğ
»¶iÿ‹d_idx
,

1727 
	gÏ¡_idx
,

1728 
	g»¶iÿ‹d_idx


1730 
	gREGION_MAX_LOG_LAG
.
ob£rve
((
Ï¡_idx
 - 
»¶iÿ‹d_idx
è
as
 
f64
);

1732 
Ët
 
	g­¶›d_idx
 = 
³”
.
g‘_¡Üe
().
­¶›d_šdex
();

1733 
Ët
 
	gfœ¡_idx
 = 
³”
.
g‘_¡Üe
().
fœ¡_šdex
();

1734 
Ët
 
mut
 
	gcom·ù_idx
;

1735 
	g­¶›d_idx
 > 
	gfœ¡_idx
 &&

1736 
	g­¶›d_idx
 - 
	gfœ¡_idx
 >ğ
£lf
.
cfg
.
¿á_log_gc_couÁ_lim™


1738 
com·ù_idx
 = 
­¶›d_idx
;

1739 } 
	g³”
.
	g¿á_log_size_hšt
 >ğ
£lf
.
cfg
.
¿á_log_gc_size_lim™
.0 {

1740 
com·ù_idx
 = 
­¶›d_idx
;

1741 } 
	g»¶iÿ‹d_idx
 < 
	gfœ¡_idx
 ||

1742 
	g»¶iÿ‹d_idx
 - 
	gfœ¡_idx
 <ğ
£lf
.
cfg
.
¿á_log_gc_th»shŞd


1746 
	gcom·ù_idx
 = 
»¶iÿ‹d_idx
;

1750 
	gas£¹
!(
	gcom·ù_idx
 > 0);

1751 
	gcom·ù_idx
 -= 1;

1752 
	gcom·ù_idx
 < 
	gfœ¡_idx
 {

1757 
	gtÙ®_gc_logs
 +ğ
com·ù_idx
 - 
fœ¡_idx
;

1759 
Ët
 
	g‹rm
 = 
³”
.
¿á_group
.
¿á
.
¿á_log
.
‹rm
(
com·ù_idx
).
unw¿p
();

1762 
Ët
 
	g»que¡
 = 
Ãw_com·ù_log_»que¡
(
»giÚ_id
, 
³”
.³”.
şÚe
(), 
com·ù_idx
, 
‹rm
);

1764 
Ët
 
E¼
(
e
èğ
£lf
.
£ndch


1765 .
Œy_£nd
(
Msg
::
Ãw_¿á_cmd
(
»que¡
, 
Box
::
Ãw
(|
_
| {})))

1767 
”rÜ
!("{} s’d com·ù†og {}ƒ¼ {:?}", 
	g³”
.
	gg
, 
	gcom·ù_idx
, 
	ge
);

1771 
	gPEER_GC_RAFT_LOG_COUNTER


1772 .
šc_by
(
tÙ®_gc_logs
 
as
 
f64
)

1773 .
unw¿p
();

1774 
	g£lf
.
»gi¡”_¿á_gc_log_tick
(
ev’t_loİ
);

1777 
â
 
»gi¡”_¥l™_»giÚ_check_tick
(&
£lf
, 
ev’t_loİ
: &
mut
 
Ev’tLoİ
<
S–f
>) {

1778 
Ët
 
E¼
(
e
èğ
»gi¡”_tim”
(

1779 
ev’t_loİ
,

1780 
Tick
::
S¶™RegiÚCheck
,

1781 
£lf
.
cfg
.
¥l™_»giÚ_check_tick_š‹rv®
.
as_mlis
(),

1783 
	g”rÜ
!("{}„egi¡” s¶™„egiÚ checkickƒ¼: {:?}", 
	g£lf
.
	gg
, 
	ge
);

1787 
â
 
Ú_¥l™_»giÚ_check_tick
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>) {

1791 
£lf
.
¥l™_check_wÜk”
.
is_busy
() {

1792 
£lf
.
»gi¡”_¥l™_»giÚ_check_tick
(
ev’t_loİ
);

1795 
³”
 
š
 
	g£lf
.
	g»giÚ_³”s
.
v®ues_mut
() {

1796 !
	g³”
.
is_Ëad”
() {

1803 
	g³”
.
	g­´oxim©e_size
.
is_some
() &&

1804 
	g³”
.
	gsize_diff_hšt
 < 
	g£lf
.
	gcfg
.
	g»giÚ_¥l™_check_diff
.0

1808 
Ët
 
	gsk
 = 
S¶™CheckTask
::
Ãw
(
³”
.
»giÚ
());

1809 
Ët
 
E¼
(
e
èğ
£lf
.
¥l™_check_wÜk”
.
scheduË
(
sk
) {

1810 
”rÜ
!("{} faedØscheduË s¶™ check: {}", 
£lf
.
g
, 
e
);

1812 
	g³”
.
	gsize_diff_hšt
 = 0;

1815 
	g£lf
.
»gi¡”_¥l™_»giÚ_check_tick
(
ev’t_loİ
);

1818 
â
 
»gi¡”_com·ù_check_tick
(&
£lf
, 
ev’t_loİ
: &
mut
 
Ev’tLoİ
<
S–f
>) {

1819 
Ët
 
E¼
(
e
èğ
»gi¡”_tim”
(

1820 
ev’t_loİ
,

1821 
Tick
::
Com·ùCheck
,

1822 
£lf
.
cfg
.
»giÚ_com·ù_check_š‹rv®
.
as_mlis
(),

1824 
	g”rÜ
!("{}„egi¡” com·ù checkickƒ¼: {:?}", 
	g£lf
.
	gg
, 
	ge
);

1828 
â
 
Ú_com·ù_check_tick
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>) {

1829 
³”
 
š
 
£lf
.
»giÚ_³”s
.
v®ues_mut
() {

1830 
³”
.
d–‘e_keys_hšt
 < 
£lf
.
cfg
.
»giÚ_com·ù_d–‘e_keys_couÁ
 {

1833 &
cf
 
	gš
 &[
CF_DEFAULT
, 
CF_WRITE
] {

1834 
Ët
 
	gsk
 = 
Com·ùTask
 {

1835 
cf_Çme
: 
SŒšg
::
äom
(
cf
),

1836 
¡¬t_key
: 
Some
(
keys
::
’c_¡¬t_key
(
³”
.
»giÚ
())),

1837 
’d_key
: 
Some
(
keys
::
’c_’d_key
(
³”
.
»giÚ
())),

1839 
Ët
 
E¼
(
e
èğ
£lf
.
com·ù_wÜk”
.
scheduË
(
sk
) {

1840 
”rÜ
!("{} faedØscheduË com·ùask: {}", 
£lf
.
g
, 
e
);

1843 
	g³”
.
	gd–‘e_keys_hšt
 = 0;

1847 
	g£lf
.
»gi¡”_com·ù_check_tick
(
ev’t_loİ
);

1850 
â
 
Ú_´•¬e_¥l™_»giÚ
(

1851 &
mut
 
£lf
,

1852 
»giÚ_id
: 
u64
,

1853 
»giÚ_•och
: 
m‘­b
::
RegiÚEpoch
,

1854 
¥l™_key
: 
Vec
<
u8
>,

1855 
cb
: 
O±iÚ
<
C®lback
>,

1857 
Ët
 
E¼
(
e
èğ
£lf
.
v®id©e_¥l™_»giÚ
(
»giÚ_id
, &
»giÚ_•och
, &
¥l™_key
) {

1858 
	gcb
.
m­
(|
cb
| cb(
Ãw_”rÜ
(
e
)));

1861 
Ët
 
	g³”
 = &
£lf
.
»giÚ_³”s
[&
»giÚ_id
];

1862 
Ët
 
	g»giÚ
 = 
³”
.
»giÚ
();

1863 
Ët
 
	gsk
 = 
PdTask
::
AskS¶™
 {

1864 
»giÚ
:„egiÚ.
şÚe
(),

1865 
¥l™_key
: split_key,

1866 
³”
:…“r.³”.
şÚe
(),

1867 
right_d”ive
: 
£lf
.
cfg
.
right_d”ive_wh’_¥l™
,

1868 
ÿÎback
: 
cb
,

1870 
Ët
 
E¼
(
Stİ³d
(
t
)èğ
£lf
.
pd_wÜk”
.
scheduË
(
sk
) {

1871 
”rÜ
!("{} faedØnÙify…dØ¥l™: Stİ³d", 
³”
.
g
);

1872 
m©ch
 
	gt
 {

1873 
	gPdTask
::
AskS¶™
 { 
ÿÎback
, .. } => {

1874 
ÿÎback
.
m­
(|
cb
| cb(
Ãw_”rÜ
(
box_”r
!("failedo split: Stopped"))));

1876 
	g_
 => 
uÄ—chabË
!(),

1881 
â
 
v®id©e_¥l™_»giÚ
(

1882 &
mut
 
£lf
,

1883 
»giÚ_id
: 
u64
,

1884 
•och
: &
m‘­b
::
RegiÚEpoch
,

1885 
¥l™_key
: &[
u8
],

1886 è-> 
	gResuÉ
<()> {

1887 
	g¥l™_key
.
is_em±y
() {

1888 
	g”rÜ
!("[»giÚ {}] s¶™ key should‚Ù bem±y!!!", 
	g»giÚ_id
);

1889  
E¼
(
box_”r
!(

1891 
»giÚ_id


1894 
Ët
 
	g³”
 = 
m©ch
 
£lf
.
»giÚ_³”s
.
g‘
(&
»giÚ_id
) {

1895 
NÚe
 => {

1896 
šfo
!(

1898 
»giÚ_id
,

1899 
£lf
.
¡Üe_id
()

1901  
E¼
(
E¼Ü
::
RegiÚNÙFound
(
»giÚ_id
));

1903 
Some
(
³”
) => {

1904 !
³”
.
is_Ëad”
() {

1906 
šfo
!(

1908 
»giÚ_id
,

1909 
£lf
.
¡Üe_id
()

1911  
E¼
(
E¼Ü
::
NÙL—d”
(

1912 
»giÚ_id
,

1913 
³”
.
g‘_³”_äom_ÿche
Õ“r.
Ëad”_id
()),

1916 
	g³”


1920 
Ët
 
	g»giÚ
 = 
³”
.
»giÚ
();

1922 
	g»giÚ
.
g‘_»giÚ_•och
().
g‘_v”siÚ
(è!ğ
•och
.get_version() {

1923 
šfo
!(

1925 
³”
.
g
,

1926 
»giÚ
.
g‘_»giÚ_•och
(),

1927 
•och


1929  
E¼
(
box_”r
!(

1931 
³”
.
g
,

1932 
»giÚ
.
g‘_»giÚ_•och
(),

1933 
•och


1936 
Ok
(())

1939 
â
 
Ú_­´oxim©e_»giÚ_size
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
»giÚ_size
: u64) {

1940 
Ët
 
³”
 = 
m©ch
 
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
) {

1941 
Some
(
³”
) =>…eer,

1942 
	gNÚe
 => {

1943 
w¬n
!(

1945 
»giÚ_id
,

1946 
»giÚ_size
,

1951 
	g³”
.
	g­´oxim©e_size
 = 
Some
(
»giÚ_size
);

1954 
â
 
Ú_pd_h—¹b—t_tick
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>) {

1955 
³”
 
š
 
£lf
.
»giÚ_³”s
.
v®ues_mut
() {

1956 
³”
.
check_³”s
();

1958 
Ët
 
mut
 
	gËad”_couÁ
 = 0;

1959 
³”
 
š
 
	g£lf
.
	g»giÚ_³”s
.
v®ues
() {

1960 
	g³”
.
is_Ëad”
() {

1961 
	gËad”_couÁ
 += 1;

1962 
	g³”
.
h—¹b—t_pd
(&
£lf
.
pd_wÜk”
);

1965 
	gSTORE_PD_HEARTBEAT_GAUGE_VEC


1966 .
w™h_Ïb–_v®ues
(&["leader"])

1967 .
£t
(
Ëad”_couÁ
 
as
 
f64
);

1968 
	gSTORE_PD_HEARTBEAT_GAUGE_VEC


1969 .
w™h_Ïb–_v®ues
(&["region"])

1970 .
£t
(
£lf
.
»giÚ_³”s
.
Ën
(è
as
 
f64
);

1972 
	g£lf
.
»gi¡”_pd_h—¹b—t_tick
(
ev’t_loİ
);

1976 
â
 
»gi¡”_pd_h—¹b—t_tick
(&
£lf
, 
ev’t_loİ
: &
mut
 
Ev’tLoİ
<
S–f
>) {

1977 
Ët
 
E¼
(
e
èğ
»gi¡”_tim”
(

1978 
ev’t_loİ
,

1979 
Tick
::
PdH—¹b—t
,

1980 
£lf
.
cfg
.
pd_h—¹b—t_tick_š‹rv®
.
as_mlis
(),

1982 
	g”rÜ
!("{}„egi¡”…d h—¹b—ˆtickƒ¼: {:?}", 
	g£lf
.
	gg
, 
	ge
);

1986 
â
 
¡Üe_h—¹b—t_pd
(&
mut
 
£lf
) {

1987 
Ët
 
mut
 
	g¡©s
 = 
StÜeSts
::
Ãw
();

1989 
Ët
 
	gu£d_size
 = 
£lf
.
¢­_mgr
.
g‘_tÙ®_¢­_size
();

1990 
	g¡©s
.
£t_u£d_size
(
u£d_size
);

1991 
	g¡©s
.
£t_¡Üe_id
(
£lf
.
¡Üe_id
());

1992 
	g¡©s
.
£t_»giÚ_couÁ
(
£lf
.
»giÚ_³”s
.
Ën
(è
as
 
u32
);

1994 
Ët
 
	g¢­_¡©s
 = 
£lf
.
¢­_mgr
.
¡©s
();

1995 
	g¡©s
.
£t_£ndšg_¢­_couÁ
(
¢­_¡©s
.
£ndšg_couÁ
 
as
 
u32
);

1996 
	g¡©s
.
£t_»ûivšg_¢­_couÁ
(
¢­_¡©s
.
»ûivšg_couÁ
 
as
 
u32
);

1997 
	gSTORE_SNAPSHOT_TRAFFIC_GAUGE_VEC


1998 .
w™h_Ïb–_v®ues
(&["sending"])

1999 .
£t
(
¢­_¡©s
.
£ndšg_couÁ
 
as
 
f64
);

2000 
	gSTORE_SNAPSHOT_TRAFFIC_GAUGE_VEC


2001 .
w™h_Ïb–_v®ues
(&["receiving"])

2002 .
£t
(
¢­_¡©s
.
»ûivšg_couÁ
 
as
 
f64
);

2004 
Ët
 
mut
 
	g­¶y_¢­shÙ_couÁ
 = 0;

2005 
³”
 
š
 
	g£lf
.
	g»giÚ_³”s
.
v®ues_mut
() {

2006 
	g³”
.
mut_¡Üe
().
check_­¶yšg_¢­
() {

2007 
	g­¶y_¢­shÙ_couÁ
 += 1;

2011 
	g¡©s
.
£t_­¶yšg_¢­_couÁ
(
­¶y_¢­shÙ_couÁ
 
as
 
u32
);

2012 
	gSTORE_SNAPSHOT_TRAFFIC_GAUGE_VEC


2013 .
w™h_Ïb–_v®ues
(&["applying"])

2014 .
£t
(
­¶y_¢­shÙ_couÁ
 
as
 
f64
);

2016 
	g¡©s
.
£t_¡¬t_time
(
£lf
.
¡¬t_time
.
£c
 
as
 
u32
);

2019 
	g¡©s
.
£t_by‹s_wr™‹n
(

2020 
£lf
.
¡Üe_¡©
.
’gše_tÙ®_by‹s_wr™‹n
 -

2021 
£lf
.
¡Üe_¡©
.
’gše_Ï¡_tÙ®_by‹s_wr™‹n
,

2023 
	g¡©s
.
£t_keys_wr™‹n
(

2024 
£lf
.
¡Üe_¡©
.
’gše_tÙ®_keys_wr™‹n
 -

2025 
£lf
.
¡Üe_¡©
.
’gše_Ï¡_tÙ®_keys_wr™‹n
,

2027 
	g£lf
.
	g¡Üe_¡©
.
	g’gše_Ï¡_tÙ®_by‹s_wr™‹n
 =

2028 
£lf
.
¡Üe_¡©
.
’gše_tÙ®_by‹s_wr™‹n
;

2029 
	g£lf
.
	g¡Üe_¡©
.
	g’gše_Ï¡_tÙ®_keys_wr™‹n
 = 
£lf
.
¡Üe_¡©
.
’gše_tÙ®_keys_wr™‹n
;

2031 
	g¡©s
.
£t_is_busy
(
£lf
.
is_busy
);

2032 
	g£lf
.
	gis_busy
 = 
çl£
;

2034 
Ët
 
	g¡Üe_šfo
 = 
StÜeInfo
 {

2035 
’gše
: 
£lf
.
kv_’gše
.
şÚe
(),

2036 
ÿ·c™y
: 
£lf
.
cfg
.capacity.0,

2039 
Ët
 
	gsk
 = 
PdTask
::
StÜeH—¹b—t
 {

2040 
¡©s
: stats,

2041 
¡Üe_šfo
: store_info,

2043 
Ët
 
E¼
(
e
èğ
£lf
.
pd_wÜk”
.
scheduË
(
sk
) {

2044 
”rÜ
!("{} faedØnÙify…d: {}", 
£lf
.
g
, 
e
);

2048 
â
 
Ú_pd_¡Üe_h—¹b—t_tick
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>) {

2049 
£lf
.
¡Üe_h—¹b—t_pd
();

2050 
	g£lf
.
»gi¡”_pd_¡Üe_h—¹b—t_tick
(
ev’t_loİ
);

2053 
â
 
hªdË_¢­_mgr_gc
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

2054 
Ët
 
	g¢­_keys
 = 
£lf
.
¢­_mgr
.
li¡_idË_¢­
()?;

2055 
	g¢­_keys
.
is_em±y
() {

2056  
Ok
(());

2058 
Ët
 (
mut
 
Ï¡_»giÚ_id
, muˆ
com·ùed_idx
, muˆ
com·ùed_‹rm
èğ(0, 
	gu64
::
MAX
, u64::MAX);

2059 
Ët
 
mut
 
	gis_­¶yšg_¢­
 = 
çl£
;

2060 
	gkey
, 
	gis_£ndšg
è
š
 
	g¢­_keys
 {

2061 
	gÏ¡_»giÚ_id
 !ğ
key
.
»giÚ_id
 {

2062 
Ï¡_»giÚ_id
 = 
key
.
»giÚ_id
;

2063 
m©ch
 
	g£lf
.
	g»giÚ_³”s
.
g‘
(&
key
.
»giÚ_id
) {

2064 
	gNÚe
 => {

2066 
com·ùed_idx
 = 
u64
::
MAX
;

2067 
	gcom·ùed_‹rm
 = 
u64
::
MAX
;

2068 
	gis_­¶yšg_¢­
 = 
çl£
;

2070 
Some
(
³”
) => {

2071 
Ët
 
s
 = 
³”
.
g‘_¡Üe
();

2072 
	gcom·ùed_idx
 = 
s
.
Œunÿ‹d_šdex
();

2073 
	gcom·ùed_‹rm
 = 
s
.
Œunÿ‹d_‹rm
();

2074 
	gis_­¶yšg_¢­
 = 
s
.
is_­¶yšg_¢­shÙ
();

2079 
	gis_£ndšg
 {

2080 
Ët
 
	gs
 = 
£lf
.
¢­_mgr
.
g‘_¢­shÙ_fÜ_£ndšg
(&
key
)?;

2081 
	gkey
.
	g‹rm
 < 
	gcom·ùed_‹rm
 || key.
	gidx
 < 
	gcom·ùed_idx
 {

2082 
	gšfo
!(

2084 
	gkey
.
	g»giÚ_id
,

2085 
	gkey


2087 
	g£lf
.
	g¢­_mgr
.
d–‘e_¢­shÙ
(&
key
, 
s
.
as_»f
(), 
çl£
);

2088 } 
Ët
 
Ok
(
m‘a
èğ
s
.meta() {

2089 
Ët
 
modif›d
 = 
box_Œy
!(
m‘a
.modified());

2090 
Ët
 
Ok
(
–­£d
èğ
modif›d
.elapsed() {

2091 
–­£d
 > 
£lf
.
cfg
.
¢­_gc_timeout
.0 {

2092 
šfo
!(

2094 
key
.
»giÚ_id
,

2095 
key


2097 
	g£lf
.
	g¢­_mgr
.
d–‘e_¢­shÙ
(&
key
, 
s
.
as_»f
(), 
çl£
);

2101 } 
	gkey
.
	g‹rm
 <ğ
com·ùed_‹rm
 &&

2102 (
key
.
idx
 < 
com·ùed_idx
 || key.idx =ğcom·ùed_idx && !
is_­¶yšg_¢­
)

2104 
šfo
!(

2106 
key
.
»giÚ_id
,

2107 
key


2109 
Ët
 
	ga
 = 
£lf
.
¢­_mgr
.
g‘_¢­shÙ_fÜ_­¶yšg
(&
key
)?;

2110 
	g£lf
.
	g¢­_mgr
.
d–‘e_¢­shÙ
(&
key
, 
a
.
as_»f
(), 
çl£
);

2113 
Ok
(())

2116 
â
 
Ú_¢­_mgr_gc
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>) {

2117 
Ët
 
E¼
(
e
èğ
£lf
.
hªdË_¢­_mgr_gc
() {

2118 
”rÜ
!("{} faedØgø¢­ mªag”: {:?}", 
£lf
.
g
, 
e
);

2120 
	g£lf
.
»gi¡”_¢­_mgr_gc_tick
(
ev’t_loİ
);

2123 
â
 
Ú_com·ù_lock_cf
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>) {

2125 
£lf
.
¡Üe_¡©
.
lock_cf_by‹s_wr™‹n
 > s–f.
cfg
.
lock_cf_com·ù_by‹s_th»shŞd
.0 {

2126 
£lf
.
¡Üe_¡©
.
lock_cf_by‹s_wr™‹n
 = 0;

2127 
Ët
 
	gsk
 = 
Com·ùTask
 {

2128 
cf_Çme
: 
SŒšg
::
äom
(
CF_LOCK
),

2129 
¡¬t_key
: 
NÚe
,

2130 
’d_key
: 
NÚe
,

2132 
Ët
 
E¼
(
e
èğ
£lf
.
com·ù_wÜk”
.
scheduË
(
sk
) {

2133 
”rÜ
!(

2135 
£lf
.
g
,

2136 
e


2141 
	g£lf
.
»gi¡”_com·ù_lock_cf_tick
(
ev’t_loİ
);

2144 
â
 
»gi¡”_pd_¡Üe_h—¹b—t_tick
(&
£lf
, 
ev’t_loİ
: &
mut
 
Ev’tLoİ
<
S–f
>) {

2145 
Ët
 
E¼
(
e
èğ
»gi¡”_tim”
(

2146 
ev’t_loİ
,

2147 
Tick
::
PdStÜeH—¹b—t
,

2148 
£lf
.
cfg
.
pd_¡Üe_h—¹b—t_tick_š‹rv®
.
as_mlis
(),

2150 
	g”rÜ
!("{}„egi¡”…d stÜh—¹b—ˆtickƒ¼: {:?}", 
	g£lf
.
	gg
, 
	ge
);

2154 
â
 
»gi¡”_¢­_mgr_gc_tick
(&
£lf
, 
ev’t_loİ
: &
mut
 
Ev’tLoİ
<
S–f
>) {

2155 
Ët
 
E¼
(
e
èğ
»gi¡”_tim”
(

2156 
ev’t_loİ
,

2157 
Tick
::
SÇpGc
,

2158 
£lf
.
cfg
.
¢­_mgr_gc_tick_š‹rv®
.
as_mlis
(),

2160 
	g”rÜ
!("{}„egi¡” sÇ°mg¸gøtickƒ¼: {:?}", 
	g£lf
.
	gg
, 
	ge
);

2164 
â
 
»gi¡”_com·ù_lock_cf_tick
(&
£lf
, 
ev’t_loİ
: &
mut
 
Ev’tLoİ
<
S–f
>) {

2165 
Ët
 
E¼
(
e
èğ
»gi¡”_tim”
(

2166 
ev’t_loİ
,

2167 
Tick
::
Com·ùLockCf
,

2168 
£lf
.
cfg
.
lock_cf_com·ù_š‹rv®
.
as_mlis
(),

2170 
	g”rÜ
!("{}„egi¡” com·ù cf-lockickƒ¼: {:?}", 
	g£lf
.
	gg
, 
	ge
);

2178 
â
 
v”ify_ªd_¡Üe_hash
(

2179 
»giÚ_id
: 
u64
,

2180 
¡©e
: &
mut
 
CÚsi¡’cyS‹
,

2181 
ex³ùed_šdex
: 
u64
,

2182 
ex³ùed_hash
: 
Vec
<
u8
>,

2183 è-> 
	gboŞ
 {

2184 
	gex³ùed_šdex
 < 
	g¡©e
.
	gšdex
 {

2185 
	gREGION_HASH_COUNTER_VEC


2186 .
w™h_Ïb–_v®ues
(&["verify", "miss"])

2187 .
šc
();

2188 
	gw¬n
!(

2190 
	g»giÚ_id
,

2191 
	g¡©e
.
	gšdex
,

2192 
	gex³ùed_šdex


2194  
	gçl£
;

2197 
	g¡©e
.
	gšdex
 =ğ
ex³ùed_šdex
 {

2198 
¡©e
.
hash
.
is_em±y
() {

2199 
w¬n
!(

2201 
»giÚ_id


2203  
	gçl£
;

2205 
	g¡©e
.
	ghash
 !ğ
ex³ùed_hash
 {

2206 
·nic
!(

2208 
»giÚ_id
,

2209 
¡©e
.
šdex
,

2210 
esÿ³
(&
ex³ùed_hash
),

2211 
esÿ³
(&
¡©e
.
hash
)

2214 
	gšfo
!(

2216 
	g»giÚ_id
,

2217 
	g¡©e
.
	gšdex


2219 
	gREGION_HASH_COUNTER_VEC


2220 .
w™h_Ïb–_v®ues
(&["verify", "matched"])

2221 .
šc
();

2222 
	g¡©e
.
	ghash
 = 
vec
![];

2223  
	gçl£
;

2226 
	g¡©e
.
	gšdex
 !ğ
INVALID_INDEX
 && !
¡©e
.
hash
.
is_em±y
() {

2229 
REGION_HASH_COUNTER_VEC


2230 .
w™h_Ïb–_v®ues
(&["verify", "miss"])

2231 .
šc
();

2232 
	gw¬n
!(

2234 
	g»giÚ_id
,

2235 
	g¡©e
.
	gšdex
,

2236 
	gex³ùed_šdex


2240 
	gšfo
!(

2242 
	g»giÚ_id
,

2243 
	gex³ùed_šdex


2245 
	g¡©e
.
	gšdex
 = 
ex³ùed_šdex
;

2246 
	g¡©e
.
	ghash
 = 
ex³ùed_hash
;

2247 
	gŒue


2250 
	gim¶
<
	gT
: 
T¿n¥Üt
, 
	gC
: 
PdCl›Á
> 
StÜe
<
T
, C> {

2251 
â
 
»gi¡”_cÚsi¡’cy_check_tick
(&
£lf
, 
ev’t_loİ
: &
mut
 
Ev’tLoİ
<
S–f
>) {

2252 
Ët
 
E¼
(
e
èğ
»gi¡”_tim”
(

2253 
ev’t_loİ
,

2254 
Tick
::
CÚsi¡’cyCheck
,

2255 
£lf
.
cfg
.
cÚsi¡’cy_check_š‹rv®
.
as_mlis
(),

2257 
	g”rÜ
!("{}„egi¡” cÚsi¡’cy checkickƒ¼: {:?}", 
	g£lf
.
	gg
, 
	ge
);

2261 
â
 
Ú_cÚsi¡’cy_check_tick
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>) {

2262 
£lf
.
cÚsi¡’cy_check_wÜk”
.
is_busy
() {

2265 
£lf
.
»gi¡”_cÚsi¡’cy_check_tick
(
ev’t_loİ
);

2268 
Ët
 (
mut
 
ÿndid©e_id
, muˆ
ÿndid©e_check_time
èğ(0, 
	gIn¡ªt
::
now
());

2269 &
	g»giÚ_id
, 
	g³”
è
	gš
 &
mut
 
	g£lf
.
	g»giÚ_³”s
 {

2270 !
	g³”
.
is_Ëad”
() {

2273 
	g³”
.
	gcÚsi¡’cy_¡©e
.
	gÏ¡_check_time
 < 
	gÿndid©e_check_time
 {

2274 
	gÿndid©e_id
 = 
»giÚ_id
;

2275 
	gÿndid©e_check_time
 = 
³”
.
cÚsi¡’cy_¡©e
.
Ï¡_check_time
;

2279 
	gÿndid©e_id
 != 0 {

2280 
Ët
 
³”
 = &
£lf
.
»giÚ_³”s
[&
ÿndid©e_id
];

2282 
	gšfo
!("{} schedulšg cÚsi¡’ˆcheck", 
	g³”
.
	gg
);

2283 
Ët
 
	gmsg
 = 
Msg
::
Ãw_¿á_cmd
(

2284 
Ãw_compu‹_hash_»que¡
(
ÿndid©e_id
, 
³”
.³”.
şÚe
()),

2285 
Box
::
Ãw
(|
_
| {}),

2288 
Ët
 
E¼
(
e
èğ
£lf
.
£ndch
.
£nd
(
msg
) {

2289 
”rÜ
!("{} faedØscheduË cÚsi¡’ˆcheck: {:?}", 
³”
.
g
, 
e
);

2293 
	g£lf
.
»gi¡”_cÚsi¡’cy_check_tick
(
ev’t_loİ
);

2296 
â
 
Ú_»ady_compu‹_hash
(&
mut
 
£lf
, 
»giÚ
: 
m‘­b
::
RegiÚ
, 
šdex
: 
u64
, 
¢­
: 
EngšeSÇpshÙ
) {

2297 
Ët
 
»giÚ_id
 = 
»giÚ
.
g‘_id
();

2298 
	g£lf
.
	g»giÚ_³”s


2299 .
g‘_mut
(&
»giÚ_id
)

2300 .
unw¿p
()

2301 .
	gcÚsi¡’cy_¡©e


2302 .
	gÏ¡_check_time
 = 
In¡ªt
::
now
();

2303 
Ët
 
	gsk
 = 
CÚsi¡’cyCheckTask
::
compu‹_hash
(
»giÚ
, 
šdex
, 
¢­
);

2304 
	gšfo
!("[»giÚ {}] scheduË {}", 
	g»giÚ_id
, 
	gsk
);

2305 
Ët
 
E¼
(
e
èğ
£lf
.
cÚsi¡’cy_check_wÜk”
.
scheduË
(
sk
) {

2306 
”rÜ
!("[»giÚ {}] scheduË faed: {:?}", 
»giÚ_id
, 
e
);

2310 
â
 
Ú_»ady_v”ify_hash
(

2311 &
mut
 
£lf
,

2312 
»giÚ_id
: 
u64
,

2313 
ex³ùed_šdex
: 
u64
,

2314 
ex³ùed_hash
: 
Vec
<
u8
>,

2316 
Ët
 
	g¡©e
 = 
m©ch
 
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
) {

2317 
NÚe
 => {

2318 
w¬n
!(

2320 
»giÚ_id
,

2321 
ex³ùed_šdex


2325 
Some
(
p
è=> &
mut
….
cÚsi¡’cy_¡©e
,

2328 
v”ify_ªd_¡Üe_hash
(
»giÚ_id
, 
¡©e
, 
ex³ùed_šdex
, 
ex³ùed_hash
);

2331 
â
 
Ú_hash_compu‹d
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
šdex
: u64, 
hash
: 
Vec
<
u8
>) {

2332 
Ët
 (
¡©e
, 
³”
èğ
m©ch
 
£lf
.
»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
) {

2333 
NÚe
 => {

2334 
w¬n
!(

2336 
»giÚ_id
,

2337 
šdex


2341 
Some
(
p
è=> (&
mut
….
cÚsi¡’cy_¡©e
, &
	gp
.
	g³”
),

2344 !
v”ify_ªd_¡Üe_hash
(
»giÚ_id
, 
¡©e
, 
šdex
, 
hash
) {

2348 
Ët
 
	gmsg
 = 
Msg
::
Ãw_¿á_cmd
(

2349 
Ãw_v”ify_hash_»que¡
(
»giÚ_id
, 
³”
.
şÚe
(), 
¡©e
),

2350 
Box
::
Ãw
(|
_
| {}),

2352 
Ët
 
E¼
(
e
èğ
£lf
.
£ndch
.
£nd
(
msg
) {

2353 
”rÜ
!(

2355 
»giÚ_id
,

2356 
šdex
,

2357 
e


2363 
â
 
Ãw_admš_»que¡
(
»giÚ_id
: 
u64
, 
³”
: 
m‘­b
::
P“r
è-> 
RaáCmdReque¡
 {

2364 
Ët
 
mut
 
»que¡
 = 
RaáCmdReque¡
::
Ãw
();

2365 
	g»que¡
.
mut_h—d”
().
£t_»giÚ_id
(
»giÚ_id
);

2366 
	g»que¡
.
mut_h—d”
().
£t_³”
(
³”
);

2367 
	g»que¡


2370 
â
 
Ãw_v”ify_hash_»que¡
(

2371 
»giÚ_id
: 
u64
,

2372 
³”
: 
m‘­b
::
P“r
,

2373 
¡©e
: &
CÚsi¡’cyS‹
,

2374 è-> 
	gRaáCmdReque¡
 {

2375 
Ët
 
mut
 
	g»que¡
 = 
Ãw_admš_»que¡
(
»giÚ_id
, 
³”
);

2377 
Ët
 
mut
 
	gadmš
 = 
AdmšReque¡
::
Ãw
();

2378 
	gadmš
.
£t_cmd_ty³
(
AdmšCmdTy³
::
V”ifyHash
);

2379 
	gadmš
.
mut_v”ify_hash
().
£t_šdex
(
¡©e
.
šdex
);

2380 
	gadmš
.
mut_v”ify_hash
().
£t_hash
(
¡©e
.
hash
.
şÚe
());

2381 
	g»que¡
.
£t_admš_»que¡
(
admš
);

2382 
	g»que¡


2385 
â
 
Ãw_compu‹_hash_»que¡
(
»giÚ_id
: 
u64
, 
³”
: 
m‘­b
::
P“r
è-> 
RaáCmdReque¡
 {

2386 
Ët
 
mut
 
»que¡
 = 
Ãw_admš_»que¡
(
»giÚ_id
, 
³”
);

2388 
Ët
 
mut
 
	gadmš
 = 
AdmšReque¡
::
Ãw
();

2389 
	gadmš
.
£t_cmd_ty³
(
AdmšCmdTy³
::
Compu‹Hash
);

2390 
	g»que¡
.
£t_admš_»que¡
(
admš
);

2391 
	g»que¡


2394 
â
 
	g»gi¡”_tim”
<
	gT
: 
T¿n¥Üt
, 
	gC
: 
PdCl›Á
>(

2395 
ev’t_loİ
: &
mut
 
Ev’tLoİ
<
StÜe
<
T
, 
	gC
>>,

2396 
	gtick
: 
Tick
,

2397 
	gd–ay
: 
u64
,

2398 è-> 
	gResuÉ
<()> {

2401 
	gd–ay
 == 0 {

2403  
Ok
(());

2405 
Ët
 
E¼
(
e
èğ
ev’t_loİ
.
timeout_ms
(
tick
, 
d–ay
) {

2406  
E¼
(
box_”r
!(

2407 "çedØ»gi¡”imeouˆ[{:?}, d–ay: {:?}ms]: {:?}",
j


2408 
tick
,

2409 
d–ay
,

2410 
e


2413 
Ok
(())

2416 
â
 
Ãw_com·ù_log_»que¡
(

2417 
»giÚ_id
: 
u64
,

2418 
³”
: 
m‘­b
::
P“r
,

2419 
com·ù_šdex
: 
u64
,

2420 
com·ù_‹rm
: 
u64
,

2421 è-> 
	gRaáCmdReque¡
 {

2422 
Ët
 
mut
 
	g»que¡
 = 
Ãw_admš_»que¡
(
»giÚ_id
, 
³”
);

2424 
Ët
 
mut
 
	gadmš
 = 
AdmšReque¡
::
Ãw
();

2425 
	gadmš
.
£t_cmd_ty³
(
AdmšCmdTy³
::
Com·ùLog
);

2426 
	gadmš
.
mut_com·ù_log
().
£t_com·ù_šdex
(
com·ù_šdex
);

2427 
	gadmš
.
mut_com·ù_log
().
£t_com·ù_‹rm
(
com·ù_‹rm
);

2428 
	g»que¡
.
£t_admš_»que¡
(
admš
);

2429 
	g»que¡


2432 
	gim¶
<
	gT
: 
T¿n¥Üt
, 
	gC
: 
PdCl›Á
> 
mio
::
HªdËr
 
StÜe
<
T
, C> {

2433 
ty³
 
	gTimeout
 = 
Tick
;

2434 
ty³
 
	gMes§ge
 = 
Msg
;

2436 
â
 
nÙify
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>, 
msg
: 
Msg
) {

2437 
m©ch
 
msg
 {

2438 
Msg
::
RaáMes§ge
(
d©a
è=> 
Ët
 
E¼
(
e
èğ
£lf
.
Ú_¿á_mes§ge
(data) {

2439 
”rÜ
!("{} hªdË„aá mes§g”r: {:?}", 
£lf
.
g
, 
e
);

2441 
	gMsg
::
RaáCmd
 {

2442 
£nd_time
,

2443 
	g»que¡
,

2444 
	gÿÎback
,

2446 
£lf
.
¿á_m‘rics


2447 .
´İo£


2448 .
»que¡_wa™_time


2449 .
ob£rve
(
du¿tiÚ_to_£c
(
£nd_time
.
–­£d
()è
as
 
f64
);

2450 
	g£lf
.
´İo£_¿á_commªd
(
»que¡
, 
ÿÎback
)

2453 
	gMsg
::
B©chRaáSÇpCmds
 {

2454 
£nd_time
,

2455 
	gb©ch
,

2456 
	gÚ_fšished
,

2458 
£lf
.
¿á_m‘rics


2459 .
´İo£


2460 .
»que¡_wa™_time


2461 .
ob£rve
(
du¿tiÚ_to_£c
(
£nd_time
.
–­£d
()è
as
 
f64
);

2462 
	g£lf
.
´İo£_b©ch_¿á_¢­shÙ_commªd
(
b©ch
, 
Ú_fšished
);

2464 
	gMsg
::
Qu™
 => {

2465 
šfo
!("{}„eûivqu™ mes§ge", 
£lf
.
g
);

2466 
	gev’t_loİ
.
shutdown
();

2468 
	gMsg
::
SÇpshÙSts
 => 
£lf
.
¡Üe_h—¹b—t_pd
(),

2469 
	gMsg
::
Compu‹HashResuÉ
 {

2470 
»giÚ_id
,

2471 
	gšdex
,

2472 
	ghash
,

2474 
£lf
.
Ú_hash_compu‹d
(
»giÚ_id
, 
šdex
, 
hash
);

2476 
	gMsg
::
S¶™RegiÚ
 {

2477 
»giÚ_id
,

2478 
	g»giÚ_•och
,

2479 
	g¥l™_key
,

2480 
	gÿÎback
,

2482 
šfo
!(

2484 
»giÚ_id
,

2485 
¥l™_key


2487 
	g£lf
.
Ú_´•¬e_¥l™_»giÚ
(
»giÚ_id
, 
»giÚ_•och
, 
¥l™_key
, 
ÿÎback
);

2489 
	gMsg
::
Aµroxim©eRegiÚSize
 {

2490 
»giÚ_id
,

2491 
	g»giÚ_size
,

2492 } => 
£lf
.
Ú_­´oxim©e_»giÚ_size
(
»giÚ_id
, 
»giÚ_size
),

2496 
â
 
timeout
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>,imeout: 
Tick
) {

2497 
Ët
 
t
 = 
SlowTim”
::
Ãw
();

2498 
m©ch
 
	gtimeout
 {

2499 
	gTick
::
Raá
 => 
£lf
.
Ú_¿á_ba£_tick
(
ev’t_loİ
),

2500 
	gTick
::
RaáLogGc
 => 
£lf
.
Ú_¿á_gc_log_tick
(
ev’t_loİ
),

2501 
	gTick
::
S¶™RegiÚCheck
 => 
£lf
.
Ú_¥l™_»giÚ_check_tick
(
ev’t_loİ
),

2502 
	gTick
::
Com·ùCheck
 => 
£lf
.
Ú_com·ù_check_tick
(
ev’t_loİ
),

2503 
	gTick
::
PdH—¹b—t
 => 
£lf
.
Ú_pd_h—¹b—t_tick
(
ev’t_loİ
),

2504 
	gTick
::
PdStÜeH—¹b—t
 => 
£lf
.
Ú_pd_¡Üe_h—¹b—t_tick
(
ev’t_loİ
),

2505 
	gTick
::
SÇpGc
 => 
£lf
.
Ú_¢­_mgr_gc
(
ev’t_loİ
),

2506 
	gTick
::
Com·ùLockCf
 => 
£lf
.
Ú_com·ù_lock_cf
(
ev’t_loİ
),

2507 
	gTick
::
CÚsi¡’cyCheck
 => 
£lf
.
Ú_cÚsi¡’cy_check_tick
(
ev’t_loİ
),

2509 
	g¦ow_log
!(
	gt
, "{} hªdËimeouˆ{:?}", 
	g£lf
.
	gg
, 
	gtimeout
);

2513 
â
 
tick
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S–f
>) {

2514 !
ev’t_loİ
.
is_ruÂšg
() {

2515 
£lf
.
¡İ
();

2520 !
	g£lf
.
	g³ndšg_¿á_groups
.
is_em±y
() {

2521 
	g£lf
.
Ú_¿á_»ady
();

2524 
	g£lf
.
pŞl_­¶y
();

2526 
	g£lf
.
	g³ndšg_¢­shÙ_»giÚs
.
ş—r
();

2530 
	gim¶
<
	gT
: 
T¿n¥Üt
, 
	gC
: 
PdCl›Á
> 
StÜe
<
T
, C> {

2532 
â
 
mut_rg‘_³”
(&
mut
 
£lf
, 
»que¡
: &
RaáCmdReque¡
è-> 
ResuÉ
<&muˆ
P“r
> {

2533 
Ët
 
»giÚ_id
 = 
»que¡
.
g‘_h—d”
().
g‘_»giÚ_id
();

2534 
m©ch
 
	g£lf
.
	g»giÚ_³”s
.
g‘_mut
(&
»giÚ_id
) {

2535 
	gNÚe
 => 
E¼
(
E¼Ü
::
RegiÚNÙFound
(
»giÚ_id
)),

2536 
Some
(
³”
è=> 
Ok
(peer),

2544 
â
 
execu‹_¡©us_commªd
(&
mut
 
£lf
, 
»que¡
: &
RaáCmdReque¡
è-> 
ResuÉ
<
RaáCmdRe¥Ú£
> {

2545 
Ët
 
cmd_ty³
 = 
»que¡
.
g‘_¡©us_»que¡
().
g‘_cmd_ty³
();

2546 
Ët
 
	g»giÚ_id
 = 
»que¡
.
g‘_h—d”
().
g‘_»giÚ_id
();

2548 
Ët
 
mut
 
	g»¥Ú£
 = 
m©ch
 
cmd_ty³
 {

2549 
StusCmdTy³
::
RegiÚL—d”
 => 
£lf
.
execu‹_»giÚ_Ëad”
(
»que¡
),

2550 
	gStusCmdTy³
::
RegiÚD‘a
 => 
£lf
.
execu‹_»giÚ_d‘a
(
»que¡
),

2551 
	gStusCmdTy³
::
Inv®idStus
 => 
E¼
(
box_”r
!("invalid status command!")),

2553 
	g»¥Ú£
.
£t_cmd_ty³
(
cmd_ty³
);

2555 
Ët
 
mut
 
	g»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

2556 
	g»¥
.
£t_¡©us_»¥Ú£
(
»¥Ú£
);

2558 
Ët
 
Some
(
³”
èğ
£lf
.
»giÚ_³”s
.
g‘
(&
»giÚ_id
) {

2559 
bšd_‹rm
(&
mut
 
»¥
, 
³”
.
‹rm
());

2561 
Ok
(
»¥
)

2564 
â
 
execu‹_»giÚ_Ëad”
(&
mut
 
£lf
, 
»que¡
: &
RaáCmdReque¡
è-> 
ResuÉ
<
StusRe¥Ú£
> {

2565 
Ët
 
³”
 = 
£lf
.
mut_rg‘_³”
(
»que¡
)?;

2567 
Ët
 
mut
 
	g»¥
 = 
StusRe¥Ú£
::
Ãw
();

2568 
Ët
 
Some
(
Ëad”
èğ
³”
.
g‘_³”_äom_ÿche
Õ“r.
Ëad”_id
()) {

2569 
»¥
.
mut_»giÚ_Ëad”
().
£t_Ëad”
(
Ëad”
);

2572 
Ok
(
»¥
)

2575 
â
 
execu‹_»giÚ_d‘a
(&
mut
 
£lf
, 
»que¡
: &
RaáCmdReque¡
è-> 
ResuÉ
<
StusRe¥Ú£
> {

2576 
Ët
 
³”
 = 
£lf
.
mut_rg‘_³”
(
»que¡
)?;

2577 !
	g³”
.
g‘_¡Üe
().
is_š™Ÿlized
() {

2578 
Ët
 
	g»giÚ_id
 = 
»que¡
.
g‘_h—d”
().
g‘_»giÚ_id
();

2579  
E¼
(
E¼Ü
::
RegiÚNÙIn™Ÿlized
(
»giÚ_id
));

2581 
Ët
 
mut
 
	g»¥
 = 
StusRe¥Ú£
::
Ãw
();

2582 
	g»¥
.
mut_»giÚ_d‘a
().
£t_»giÚ
(
³”
.
»giÚ
().
şÚe
());

2583 
Ët
 
Some
(
Ëad”
èğ
³”
.
g‘_³”_äom_ÿche
Õ“r.
Ëad”_id
()) {

2584 
»¥
.
mut_»giÚ_d‘a
().
£t_Ëad”
(
Ëad”
);

2587 
Ok
(
»¥
)

	@src/raftstore/store/transport.rs

14 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

16 
u£
 
	g¿á¡Üe
::
ResuÉ
;

19 
pub
 
Œa™
 
	gT¿n¥Üt
: 
S’d
 + 
ClÚe
 {

20 
â
 
£nd
(&
£lf
, 
msg
: 
RaáMes§ge
è-> 
ResuÉ
<()>;

22 
â
 
æush
(&
mut
 
£lf
);

	@src/raftstore/store/util.rs

14 
u£
 
	g¡d
::
İtiÚ
::
O±iÚ
;

16 
u£
 
	gkv´Ùo
::
m‘­b
;

17 
u£
 
	gkv´Ùo
::
”aápb
::{
£lf
, 
	gCÚfChªgeTy³
, 
	gMes§geTy³
};

18 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

19 
u£
 
	g¿á¡Üe
::{
E¼Ü
, 
	gResuÉ
};

20 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
;

21 
u£
 
	grocksdb
::{
Rªge
, 
	gTabËPrİ”t›sCŞËùiÚ
, 
	gWr™abË
, 
	gWr™eB©ch
, 
	gDB
};

22 
u£
 
	g¡Üage
::
LARGE_CFS
;

23 
u£
 
	gut
::
´İ”t›s
::
SizePrİ”t›s
;

24 
u£
 
	gut
::
rocksdb
 
as
 
rocksdb_ut
;

25 
u£
 
	gsu³r
::
’gše
::{
I‹rO±iÚ
, 
	gI‹¿bË
};

27 
u£
 
	gsu³r
::
³”_¡Üage
;

29 
pub
 
â
 
fšd_³”
(
»giÚ
: &
m‘­b
::
RegiÚ
, 
¡Üe_id
: 
u64
è-> 
O±iÚ
<&m‘­b::
P“r
> {

30 
³”
 
š
 
»giÚ
.
g‘_³”s
() {

31 
³”
.
g‘_¡Üe_id
(è=ğ
¡Üe_id
 {

32  
Some
(
³”
);

36 
	gNÚe


39 
pub
 
â
 
»move_³”
(
»giÚ
: &
mut
 
m‘­b
::
RegiÚ
, 
¡Üe_id
: 
u64
è-> 
O±iÚ
<m‘­b::
P“r
> {

40 
»giÚ


41 .
g‘_³”s
()

42 .
™”
()

43 .
pos™iÚ
(|
x
| x.
g‘_¡Üe_id
(è=ğ
¡Üe_id
)

44 .
m­
(|
i
| 
»giÚ
.
mut_³”s
().
»move
(i))

48 
pub
 
â
 
Ãw_³”
(
¡Üe_id
: 
u64
, 
³”_id
: u64è-> 
m‘­b
::
P“r
 {

49 
Ët
 
mut
 
³”
 = 
m‘­b
::
P“r
::
Ãw
();

50 
	g³”
.
£t_¡Üe_id
(
¡Üe_id
);

51 
	g³”
.
£t_id
(
³”_id
);

52 
	g³”


56 
pub
 
â
 
check_key_š_»giÚ_šşusive
(
key
: &[
u8
], 
»giÚ
: &
m‘­b
::
RegiÚ
è-> 
ResuÉ
<()> {

57 
Ët
 
’d_key
 = 
»giÚ
.
g‘_’d_key
();

58 
Ët
 
	g¡¬t_key
 = 
»giÚ
.
g‘_¡¬t_key
();

59 
	gkey
 >ğ
¡¬t_key
 && (
’d_key
.
is_em±y
(è|| 
key
 <=ƒnd_key) {

60 
Ok
(())

62 
E¼
(
E¼Ü
::
KeyNÙInRegiÚ
(
key
.
to_vec
(), 
»giÚ
.
şÚe
()))

67 
pub
 
â
 
check_key_š_»giÚ
(
key
: &[
u8
], 
»giÚ
: &
m‘­b
::
RegiÚ
è-> 
ResuÉ
<()> {

68 
Ët
 
’d_key
 = 
»giÚ
.
g‘_’d_key
();

69 
Ët
 
	g¡¬t_key
 = 
»giÚ
.
g‘_¡¬t_key
();

70 
	gkey
 >ğ
¡¬t_key
 && (
’d_key
.
is_em±y
(è|| 
key
 <ƒnd_key) {

71 
Ok
(())

73 
E¼
(
E¼Ü
::
KeyNÙInRegiÚ
(
key
.
to_vec
(), 
»giÚ
.
şÚe
()))

77 #[
šlše
]

78 
pub
 
â
 
is_fœ¡_vÙe_msg
(
msg
: &
RaáMes§ge
è-> 
boŞ
 {

79 
msg
.
g‘_mes§ge
().
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgReque¡VÙe
 &&

80 
msg
.
g‘_mes§ge
().
g‘_‹rm
(è=ğ
³”_¡Üage
::
RAFT_INIT_LOG_TERM
 + 1

83 cÚ¡ 
STR_CONF_CHANGE_ADD_NODE
: &'static str = "AddNode";

84 cÚ¡ 
STR_CONF_CHANGE_REMOVE_NODE
: &'static str = "RemoveNode";

86 
pub
 
â
 
cÚf_chªge_ty³_¡r
(
cÚf_ty³
: &
”aápb
::
CÚfChªgeTy³
) -> &'static str {

87 
m©ch
 *
cÚf_ty³
 {

88 
CÚfChªgeTy³
::
AddNode
 => 
STR_CONF_CHANGE_ADD_NODE
,

89 
	gCÚfChªgeTy³
::
RemoveNode
 => 
STR_CONF_CHANGE_REMOVE_NODE
,

90 
	gCÚfChªgeTy³
::
AddL—º”Node
 => 
unim¶em’‹d
!(),

94 cÚ¡ 
	gMAX_DELETE_KEYS_COUNT
: 
usize
 = 10000;

96 
pub
 
â
 
d–‘e_®l_š_¿nge
(
db
: &
DB
, 
¡¬t_key
: &[
u8
], 
’d_key
: &[u8]è-> 
ResuÉ
<()> {

97 
¡¬t_key
 >ğ
’d_key
 {

98  
Ok
(());

101 
cf
 
š
 
	gdb
.
cf_Çmes
() {

102 
d–‘e_®l_š_¿nge_cf
(
db
, 
cf
, 
¡¬t_key
, 
’d_key
)?;

105 
Ok
(())

108 
pub
 
â
 
d–‘e_®l_š_¿nge_cf
(
db
: &
DB
, 
cf
: &
¡r
, 
¡¬t_key
: &[
u8
], 
’d_key
: &[u8]è-> 
ResuÉ
<()> {

109 
Ët
 
hªdË
 = 
rocksdb_ut
::
g‘_cf_hªdË
(
db
, 
cf
)?;

110 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
Some
(
’d_key
.
to_vec
()), 
çl£
);

111 
Ët
 
mut
 
	g™
 = 
db
.
Ãw_™”©Ü_cf
(
cf
, 
™”_İt
)?;

112 
Ët
 
mut
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

113 
	g™
.
£ek
(
¡¬t_key
.
što
());

114 
	g™
.
v®id
() {

115 
	gwb
.
d–‘e_cf
(
hªdË
, 
™
.
key
())?;

116 
	gwb
.
couÁ
(è=ğ
MAX_DELETE_KEYS_COUNT
 {

119 
db
.
wr™e
(
wb
)?;

120 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

123 !
	g™
.
Ãxt
() {

128 
	gwb
.
couÁ
() > 0 {

129 
	gdb
.
wr™e
(
wb
)?;

132 
Ok
(())

136 
pub
 
â
 
is_•och_¡®e
(
•och
: &
m‘­b
::
RegiÚEpoch
, 
check_•och
: &m‘­b::RegiÚEpochè-> 
boŞ
 {

137 
•och
.
g‘_v”siÚ
(è< 
check_•och
.get_version() ||

138 
•och
.
g‘_cÚf_v”
(è< 
check_•och
.get_conf_ver()

141 
pub
 
â
 
g‘_»giÚ_´İ”t›s_cf
(

142 
db
: &
DB
,

143 
câame
: &
¡r
,

144 
»giÚ
: &
m‘­b
::
RegiÚ
,

145 è-> 
	gResuÉ
<
	gTabËPrİ”t›sCŞËùiÚ
> {

146 
Ët
 
	gcf
 = 
rocksdb_ut
::
g‘_cf_hªdË
(
db
, 
câame
)?;

147 
Ët
 
	g¡¬t
 = 
keys
::
’c_¡¬t_key
(
»giÚ
);

148 
Ët
 
	g’d
 = 
keys
::
’c_’d_key
(
»giÚ
);

149 
Ët
 
	g¿nge
 = 
Rªge
::
Ãw
(&
¡¬t
, &
’d
);

150 
	gdb
.
g‘_´İ”t›s_of_bËs_š_¿nge
(
cf
, &[
¿nge
])

151 .
m­_”r
(|
e
|ƒ.
što
())

154 
pub
 
â
 
g‘_»giÚ_­´oxim©e_size_cf
(

155 
db
: &
DB
,

156 
câame
: &
¡r
,

157 
»giÚ
: &
m‘­b
::
RegiÚ
,

158 è-> 
	gResuÉ
<
	gu64
> {

159 
Ët
 
	gcf
 = 
rocksdb_ut
::
g‘_cf_hªdË
(
db
, 
câame
)?;

160 
Ët
 
	g¡¬t
 = 
keys
::
’c_¡¬t_key
(
»giÚ
);

161 
Ët
 
	g’d
 = 
keys
::
’c_’d_key
(
»giÚ
);

162 
Ët
 
	g¿nge
 = 
Rªge
::
Ãw
(&
¡¬t
, &
’d
);

163 
Ët
 (
_
, 
mut
 
size
èğ
db
.
g‘_­´oxim©e_membË_¡©s_cf
(
cf
, &
¿nge
);

164 
Ët
 
	gcŞËùiÚ
 = 
db
.
g‘_´İ”t›s_of_bËs_š_¿nge
(
cf
, &[
¿nge
])?;

165 
	g_
, 
	gv
è
	gš
 &*
	gcŞËùiÚ
 {

166 
Ët
 
	g´İs
 = 
SizePrİ”t›s
::
decode
(
v
.
u£r_cŞËùed_´İ”t›s
())?;

167 
	gsize
 +ğ
´İs
.
g‘_­´oxim©e_size_š_¿nge
(&
¡¬t
, &
’d
);

169 
Ok
(
size
)

172 
pub
 
â
 
g‘_»giÚ_­´oxim©e_size
(
db
: &
DB
, 
»giÚ
: &
m‘­b
::
RegiÚ
è-> 
ResuÉ
<
u64
> {

173 
Ët
 
mut
 
size
 = 0;

174 
câame
 
š
 
	gLARGE_CFS
 {

175 
	gsize
 +ğ
g‘_»giÚ_­´oxim©e_size_cf
(
db
, 
câame
, 
»giÚ
)?

177 
Ok
(
size
)

180 #[
cfg
(
‹¡
)]

181 
mod
 
	g‹¡s
 {

182 
u£
 
	g¡d
::
´oûss
;

184 
u£
 
	gkv´Ùo
::
m‘­b
;

185 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

186 
u£
 
	gkv´Ùo
::
”aápb
::{
CÚfChªgeTy³
, 
	gMes§ge
, 
	gMes§geTy³
};

188 
u£
 
	gsu³r
::*;

189 
u£
 
	g¿á¡Üe
::
¡Üe
::
³”_¡Üage
;

190 
u£
 
	gut
::
´İ”t›s
::
SizePrİ”t›sCŞËùÜFaùÜy
;

192 
u£
 
	grocksdb
::{
CŞumnFamyO±iÚs
, 
	gDBO±iÚs
, 
	gS“kKey
, 
	gWr™abË
, 
	gWr™eB©ch
, 
	gDB
};

193 
u£
 
	gut
::
rocksdb
::{
g‘_cf_hªdË
, 
	gÃw_’gše_İt
, 
	gCFO±iÚs
};

194 
u£
 
	g¡Üage
::
ALL_CFS
;

195 
u£
 
	g‹mpdœ
::
TempDœ
;

198 #[
‹¡
]

199 
â
 
‹¡_check_key_š_»giÚ
() {

200 
Ët
 
	g‹¡_ÿ£s
 = 
vec
![

201 ("", "", "", 
Œue
,rue),

202 ("", "", "6", 
Œue
,rue),

203 ("", "3", "6", 
çl£
, false),

204 ("4", "3", "6", 
Œue
,rue),

205 ("4", "3", "", 
Œue
,rue),

206 ("2", "3", "6", 
çl£
, false),

207 ("", "3", "6", 
çl£
, false),

208 ("", "3", "", 
çl£
, false),

209 ("6", "3", "6", 
çl£
, 
Œue
),

211 
	gkey
, 
	g¡¬t_key
, 
	g’d_key
, 
	gis_š_»giÚ
, 
	gis_š_»giÚ_šşusive
è
š
 
	g‹¡_ÿ£s
 {

212 
Ët
 
mut
 
	g»giÚ
 = 
m‘­b
::
RegiÚ
::
Ãw
();

213 
	g»giÚ
.
£t_¡¬t_key
(
¡¬t_key
.
as_by‹s
().
to_vec
());

214 
	g»giÚ
.
£t_’d_key
(
’d_key
.
as_by‹s
().
to_vec
());

215 
Ët
 
mut
 
	g»suÉ
 = 
check_key_š_»giÚ
(
key
.
as_by‹s
(), &
»giÚ
);

216 
	gas£¹_eq
!(
	g»suÉ
.
is_ok
(), 
	gis_š_»giÚ
);

217 
	g»suÉ
 = 
check_key_š_»giÚ_šşusive
(
key
.
as_by‹s
(), &
»giÚ
);

218 
	gas£¹_eq
!(
	g»suÉ
.
is_ok
(), 
	gis_š_»giÚ_šşusive
)

222 #[
‹¡
]

223 
â
 
‹¡_³”
() {

224 
Ët
 
mut
 
	g»giÚ
 = 
m‘­b
::
RegiÚ
::
Ãw
();

225 
	g»giÚ
.
£t_id
(1);

226 
	g»giÚ
.
mut_³”s
().
push
(
Ãw_³”
(1, 1));

228 
	gas£¹
!(
fšd_³”
(&
»giÚ
, 1).
is_some
());

229 
	gas£¹
!(
fšd_³”
(&
»giÚ
, 10).
is_nÚe
());

231 
	gas£¹
!(
»move_³”
(&
mut
 
»giÚ
, 1).
is_some
());

232 
	gas£¹
!(
»move_³”
(&
mut
 
»giÚ
, 1).
is_nÚe
());

233 
	gas£¹
!(
fšd_³”
(&
»giÚ
, 1).
is_nÚe
());

237 #[
‹¡
]

238 
â
 
‹¡_fœ¡_vÙe_msg
() {

239 
Ët
 
	gtbl
 = 
vec
![

241 
Mes§geTy³
::
MsgReque¡VÙe
,

242 
³”_¡Üage
::
RAFT_INIT_LOG_TERM
 + 1,

243 
Œue
,

246 
Mes§geTy³
::
MsgReque¡VÙe
,

247 
³”_¡Üage
::
RAFT_INIT_LOG_TERM
,

248 
çl£
,

251 
Mes§geTy³
::
MsgHup
,

252 
³”_¡Üage
::
RAFT_INIT_LOG_TERM
 + 1,

253 
çl£
,

257 
	gmsg_ty³
, 
	g‹rm
, 
	gis_vÙe
è
š
 
	gtbl
 {

258 
Ët
 
mut
 
	gmsg
 = 
Mes§ge
::
Ãw
();

259 
	gmsg
.
£t_msg_ty³
(
msg_ty³
);

260 
	gmsg
.
£t_‹rm
(
‹rm
);

262 
Ët
 
mut
 
	gm
 = 
RaáMes§ge
::
Ãw
();

263 
	gm
.
£t_mes§ge
(
msg
);

264 
	gas£¹_eq
!(
is_fœ¡_vÙe_msg
(&
m
), 
	gis_vÙe
);

268 #[
‹¡
]

269 
â
 
‹¡_cÚf_chªge_ty³_¡r
() {

270 
	gas£¹_eq
!(

271 
cÚf_chªge_ty³_¡r
(&
CÚfChªgeTy³
::
AddNode
),

272 
	gSTR_CONF_CHANGE_ADD_NODE


274 
	gas£¹_eq
!(

275 
cÚf_chªge_ty³_¡r
(&
CÚfChªgeTy³
::
RemoveNode
),

276 
	gSTR_CONF_CHANGE_REMOVE_NODE


280 #[
‹¡
]

281 
â
 
‹¡_•och_¡®e
() {

282 
Ët
 
mut
 
	g•och
 = 
m‘­b
::
RegiÚEpoch
::
Ãw
();

283 
	g•och
.
£t_v”siÚ
(10);

284 
	g•och
.
£t_cÚf_v”
(10);

286 
Ët
 
	gtbl
 = 
vec
![

287 (11, 10, 
Œue
),

288 (10, 11, 
Œue
),

289 (10, 10, 
çl£
),

290 (10, 9, 
çl£
),

293 
	gv”siÚ
, 
	gcÚf_v”siÚ
, 
	gis_¡®e
è
š
 
	gtbl
 {

294 
Ët
 
mut
 
	gcheck_•och
 = 
m‘­b
::
RegiÚEpoch
::
Ãw
();

295 
	gcheck_•och
.
£t_v”siÚ
(
v”siÚ
);

296 
	gcheck_•och
.
£t_cÚf_v”
(
cÚf_v”siÚ
);

297 
	gas£¹_eq
!(
is_•och_¡®e
(&
•och
, &
check_•och
), 
	gis_¡®e
);

301 
â
 
make_»giÚ
(
id
: 
u64
, 
¡¬t_key
: 
Vec
<
u8
>, 
’d_key
: Vec<u8>è-> 
m‘­b
::
RegiÚ
 {

302 
Ët
 
mut
 
³”
 = 
m‘­b
::
P“r
::
Ãw
();

303 
	g³”
.
£t_id
(
id
);

304 
	g³”
.
£t_¡Üe_id
(
id
);

305 
Ët
 
mut
 
	g»giÚ
 = 
m‘­b
::
RegiÚ
::
Ãw
();

306 
	g»giÚ
.
£t_id
(
id
);

307 
	g»giÚ
.
£t_¡¬t_key
(
¡¬t_key
);

308 
	g»giÚ
.
£t_’d_key
(
’d_key
);

309 
	g»giÚ
.
mut_³”s
().
push
(
³”
);

310 
	g»giÚ


313 #[
‹¡
]

314 
â
 
‹¡_»giÚ_­´oxim©e_size
() {

315 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("_‹¡_¿á¡Üe_»giÚ_­´oxim©e_size").
ex³ù
("");

316 
Ët
 
	g·th_¡r
 = 
·th
.·th().
to_¡r
().
unw¿p
();

317 
Ët
 
	gdb_İts
 = 
DBO±iÚs
::
Ãw
();

318 
Ët
 
mut
 
	gcf_İts
 = 
CŞumnFamyO±iÚs
::
Ãw
();

319 
	gcf_İts
.
£t_Ëv–_z”o_fe_num_com·ùiÚ_Œigg”
(10);

320 
Ët
 
	gf
 = 
Box
::
Ãw
(
SizePrİ”t›sCŞËùÜFaùÜy
::());

321 
	gcf_İts
.
add_bË_´İ”t›s_cŞËùÜ_çùÜy
("tikv.size-cŞËùÜ", 
f
);

322 
Ët
 
	gcfs_İts
 = 
LARGE_CFS


323 .
™”
()

324 .
m­
(|
cf
| 
CFO±iÚs
::
Ãw
(cf, 
cf_İts
.
şÚe
()))

325 .
cŞËù
();

326 
Ët
 
	gdb
 = 
rocksdb_ut
::
Ãw_’gše_İt
(
·th_¡r
, 
db_İts
, 
cfs_İts
).
unw¿p
();

328 
Ët
 
	gÿ£s
 = [("a", 1024), ("b", 2048), ("c", 4096)];

329 
Ët
 
	gcf_size
 = 2 + 1024 + 2 + 2048 + 2 + 4096;

330 &(
	gkey
, 
	gvËn
è
	gš
 &
	gÿ£s
 {

331 
câame
 
š
 
	gLARGE_CFS
 {

332 
Ët
 
	gk1
 = 
keys
::
d©a_key
(
b
" ");

333 
Ët
 
	gv1
 = 
vec
![];

334 
Ët
 
	gk2
 = 
keys
::
d©a_key
(
key
.
as_by‹s
());

335 
Ët
 
	gv2
 = 
vec
![0; 
vËn
 
as
 
usize
];

336 
	gas£¹_eq
!(
	gk2
.
Ën
(), 2);

337 
Ët
 
	gcf
 = 
db
.
cf_hªdË
(
câame
).
unw¿p
();

338 
	gdb
.
put_cf
(
cf
, &
k1
, &
v1
).
unw¿p
();

339 
	gdb
.
put_cf
(
cf
, &
k2
, &
v2
).
unw¿p
();

340 
	gdb
.
æush_cf
(
cf
, 
Œue
).
unw¿p
();

344 
Ët
 
	g»giÚ
 = 
make_»giÚ
(1, 
vec
![], vec![]);

345 
Ët
 
	gsize
 = 
g‘_»giÚ_­´oxim©e_size
(&
db
, &
»giÚ
).
unw¿p
();

346 
	gas£¹_eq
!(
	gsize
, 
cf_size
 * 
	gLARGE_CFS
.
Ën
(è
as
 
	gu64
);

347 
câame
 
š
 
	gLARGE_CFS
 {

348 
Ët
 
	gsize
 = 
g‘_»giÚ_­´oxim©e_size_cf
(&
db
, 
câame
, &
»giÚ
).
unw¿p
();

349 
	gas£¹_eq
!(
	gsize
, 
	gcf_size
);

353 
â
 
check_d©a
(
db
: &
DB
, 
cfs
: &[&
¡r
], 
ex³ùed
: &[(&[
u8
], &[u8])]) {

354 
cf
 
š
 
	gcfs
 {

355 
Ët
 
	ghªdË
 = 
g‘_cf_hªdË
(
db
, 
cf
).
unw¿p
();

356 
Ët
 
mut
 
	g™”
 = 
db
.
™”_cf
(
hªdË
);

357 
	g™”
.
£ek
(
S“kKey
::
S¹
);

358 &(
	gk
, 
	gv
è
š
 
	gex³ùed
 {

359 
	gas£¹_eq
!(
	gk
, 
	g™”
.
key
());

360 
	gas£¹_eq
!(
	gv
, 
	g™”
.
v®ue
());

361 
	g™”
.
Ãxt
();

363 
	gas£¹
!(!
	g™”
.
v®id
());

367 #[
‹¡
]

368 
â
 
‹¡_d–‘e_®l_š_¿nge
() {

369 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("_¿á¡Üe_ut_d–‘e_®l_š_¿nge").
ex³ù
("");

370 
Ët
 
	g·th_¡r
 = 
·th
.·th().
to_¡r
().
unw¿p
();

372 
Ët
 
	gcfs_İts
 = 
ALL_CFS


373 .
što_™”
()

374 .
m­
(|
cf
| 
CFO±iÚs
::
Ãw
(cf, 
CŞumnFamyO±iÚs
::new()))

375 .
cŞËù
();

376 
Ët
 
	gdb
 = 
Ãw_’gše_İt
(
·th_¡r
, 
DBO±iÚs
::
Ãw
(), 
cfs_İts
).
unw¿p
();

378 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

379 
Ët
 
	gkvs
: 
Vec
<(&[
u8
], &[u8])> = 
vec
![

380 (
b
"k1", b"v1"),

381 (
b
"k2", b"v2"),

382 (
b
"k3", b"v3"),

383 (
b
"k4", b"v4"),

385 
Ët
 
	gkvs_Ëá
: 
Vec
<(&[
u8
], &[u8])> = 
vec
![(
b
"k1", b"v1"), (b"k4", b"v4")];

387 &(
	gk
, 
	gv
è
š
 
	gkvs
.
as_¦iû
() {

388 
cf
 
š
 
	gALL_CFS
 {

389 
Ët
 
	ghªdË
 = 
g‘_cf_hªdË
(&
db
, 
cf
).
unw¿p
();

390 
	gwb
.
put_cf
(
hªdË
, 
k
, 
v
).
unw¿p
();

393 
	gdb
.
wr™e
(
wb
).
unw¿p
();

394 
check_d©a
(&
db
, 
ALL_CFS
, 
kvs
.
as_¦iû
());

397 
d–‘e_®l_š_¿nge
(&
db
, 
b
"k2", b"k4").
unw¿p
();

398 
check_d©a
(&
db
, 
ALL_CFS
, 
kvs_Ëá
.
as_¦iû
());

401 
â
 
ex™_w™h_”r
(
msg
: 
SŒšg
) -> ! {

402 
”rÜ
!("{}", 
	gmsg
);

403 
	g´oûss
::
ex™
(1)

406 #[
‹¡
]

407 
â
 
‹¡_d–‘e_¿nge_´efix_bloom_ÿ£
() {

408 
Ët
 
·th
 = 
TempDœ
::
Ãw
("_¿á¡Üe_ut_d–‘e_¿nge_´efix_bloom").
ex³ù
("");

409 
Ët
 
	g·th_¡r
 = 
·th
.·th().
to_¡r
().
unw¿p
();

411 
Ët
 
mut
 
	gİts
 = 
DBO±iÚs
::
Ãw
();

412 
	gİts
.
ü—‹_if_missšg
(
Œue
);

414 
Ët
 
mut
 
	gcf_İts
 = 
CŞumnFamyO±iÚs
::
Ãw
();

416 
	gcf_İts


417 .
£t_´efix_exŒaùÜ
(

419 
Box
::
Ãw
(
rocksdb_ut
::
FixedSuffixSliûT¿nsfÜm
::new(8)),

421 .
unw¿p_Ü_–£
(|
”r
| 
ex™_w™h_”r
(
fÜm©
!("{:?}",ƒrr)));

423 
	gcf_İts
.
£t_membË_´efix_bloom_size_¿tio
(0.1 
as
 
f64
);

424 
Ët
 
	gcf
 = "default";

425 
Ët
 
	gdb
 = 
DB
::
İ’_cf
(
İts
, 
·th_¡r
, 
vec
![(
cf
, 
cf_İts
)]).
unw¿p
();

426 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

427 
Ët
 
	gkvs
: 
Vec
<(&[
u8
], &[u8])> = 
vec
![

428 (
b
"kabcdefg1", b"v1"),

429 (
b
"kabcdefg2", b"v2"),

430 (
b
"kabcdefg3", b"v3"),

431 (
b
"kabcdefg4", b"v4"),

433 
Ët
 
	gkvs_Ëá
: 
Vec
<(&[
u8
], &[u8])> = 
vec
![(
b
"kabcdefg1", b"v1"), (b"kabcdefg4", b"v4")];

435 &(
	gk
, 
	gv
è
š
 
	gkvs
.
as_¦iû
() {

436 
Ët
 
	ghªdË
 = 
g‘_cf_hªdË
(&
db
, 
cf
).
unw¿p
();

437 
	gwb
.
put_cf
(
hªdË
, 
k
, 
v
).
unw¿p
();

439 
	gdb
.
wr™e
(
wb
).
unw¿p
();

440 
check_d©a
(&
db
, &[
cf
], 
kvs
.
as_¦iû
());

443 
d–‘e_®l_š_¿nge
(&
db
, 
b
"kabcdefg2", b"kabcdefg4").
unw¿p
();

444 
check_d©a
(&
db
, &[
cf
], 
kvs_Ëá
.
as_¦iû
());

	@src/raftstore/store/worker/apply.rs

15 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	g¡d
::
sync
::
mpsc
::
S’d”
;

17 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDebug
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

18 
u£
 
	g¡d
::
rc
::
Rc
;

19 
u£
 
	g¡d
::
cŞËùiÚs
::
VecDeque
;

20 
u£
 
	g¡d
::
mem
;

22 
u£
 
	grocksdb
::{
Wr™abË
, 
	gWr™eB©ch
, 
	gDB
};

23 
u£
 
	grocksdb
::
rocksdb_İtiÚs
::
Wr™eO±iÚs
;

24 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

26 
u£
 
	gkv´Ùo
::
m‘­b
::{
P“r
 
as
 
P“rM‘a
, 
	gRegiÚ
};

27 
u£
 
	gkv´Ùo
::
”aápb
::{
CÚfChªge
, 
	gCÚfChªgeTy³
, 
	gEÁry
, 
	gEÁryTy³
};

28 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
P“rS‹
, 
	gRaáAµlyS‹
, 
	gRaáTrunÿ‹dS‹
};

29 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
AdmšCmdTy³
, 
	gAdmšReque¡
, 
	gAdmšRe¥Ú£
, 
	gChªgeP“rReque¡
, 
	gCmdTy³
,

30 
	gRaáCmdReque¡
, 
	gRaáCmdRe¥Ú£
, 
	gReque¡
, 
	gRe¥Ú£
};

32 
u£
 
	gut
::
wÜk”
::
RuÂabË
;

33 
u£
 
	gut
::{
esÿ³
, 
	grocksdb
, 
	gMu¡CÚsumeVec
};

34 
u£
 
	gut
::
time
::{
du¿tiÚ_to_£c
, 
	gSlowTim”
};

35 
u£
 
	gut
::
cŞËùiÚs
::{
HashM­
, 
HashM­EÁry
 
as
 
	gM­EÁry
};

36 
u£
 
	g¡Üage
::{
ALL_CFS
, 
	gCF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_RAFT
};

37 
u£
 
	g¿á¡Üe
::{
E¼Ü
, 
	gResuÉ
};

38 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::
CİroûssÜHo¡
;

39 
u£
 
	g¿á¡Üe
::
¡Üe
::{
cmd_»¥
, 
	gkeys
, 
	gut
, 
	gStÜe
};

40 
u£
 
	g¿á¡Üe
::
¡Üe
::
msg
::
C®lback
;

41 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::{
MubË
, 
	gP“kabË
, 
	gSÇpshÙ
};

42 
u£
 
	g¿á¡Üe
::
¡Üe
::
³”_¡Üage
::{
£lf
, 
	gcom·ù_¿á_log
, 
	gwr™e_š™Ÿl_­¶y_¡©e
,

43 
	gwr™e_³”_¡©e
};

44 
u£
 
	g¿á¡Üe
::
¡Üe
::
³”
::{
check_•och
, 
	g·r£_d©a_©
, 
	gP“r
};

45 
u£
 
	g¿á¡Üe
::
¡Üe
::
m‘rics
::*;

47 
u£
 
	gsu³r
::
m‘rics
::*;

49 cÚ¡ 
	gWRITE_BATCH_MAX_KEYS
: 
usize
 = 128;

50 cÚ¡ 
	gDEFAULT_APPLY_WB_SIZE
: 
usize
 = 4 * 1024;

52 
pub
 
	sP’dšgCmd
 {

53 
pub
 
	mšdex
: 
u64
,

54 
pub
 
	m‹rm
: 
u64
,

55 
pub
 
	mcb
: 
O±iÚ
<
C®lback
>,

58 
im¶
 
	gP’dšgCmd
 {

59 
â
 
Ãw
(
šdex
: 
u64
, 
‹rm
: u64, 
cb
: 
C®lback
è-> 
P’dšgCmd
 {

60 
P’dšgCmd
 {

61 
šdex
: index,

62 
	g‹rm
: 
‹rm
,

63 
	gcb
: 
Some
(
cb
),

68 
im¶
 
Drİ
 
	gP’dšgCmd
 {

69 
â
 
drİ
(&
mut
 
£lf
) {

70 
	g£lf
.
	gcb
.
is_some
() {

71 
	g·nic
!(

73 
	g£lf
.
	gšdex
,

74 
	g£lf
.
	g‹rm


80 
im¶
 
Debug
 
	gP’dšgCmd
 {

81 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

82 
wr™e
!(

83 
f
,

85 
	g£lf
.
	gšdex
,

86 
	g£lf
.
	g‹rm
,

87 
	g£lf
.
	gcb
.
is_some
()

92 #[
d”ive
(
DeçuÉ
, 
Debug
)]

93 
pub
 
	sP’dšgCmdQueue
 {

94 
	mnÜm®s
: 
VecDeque
<
P’dšgCmd
>,

95 
	mcÚf_chªge
: 
O±iÚ
<
P’dšgCmd
>,

98 
im¶
 
	gP’dšgCmdQueue
 {

99 
â
 
pİ_nÜm®
(&
mut
 
£lf
, 
‹rm
: 
u64
è-> 
O±iÚ
<
P’dšgCmd
> {

100 
£lf
.
nÜm®s
.
pİ_äÚt
().
ªd_th’
(|
cmd
| {

101 
cmd
.
‹rm
 >erm {

102 
£lf
.
nÜm®s
.
push_äÚt
(
cmd
);

103  
NÚe
;

105 
Some
(
cmd
)

109 
â
 
­³nd_nÜm®
(&
mut
 
£lf
, 
cmd
: 
P’dšgCmd
) {

110 
£lf
.
nÜm®s
.
push_back
(
cmd
);

113 
â
 
ke_cÚf_chªge
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gP’dšgCmd
> {

116 
	g£lf
.
	gcÚf_chªge
.
ke
()

120 
â
 
£t_cÚf_chªge
(&
mut
 
£lf
, 
cmd
: 
P’dšgCmd
) {

121 
£lf
.
cÚf_chªge
 = 
Some
(
cmd
);

125 #[
d”ive
(
DeçuÉ
, 
Debug
)]

126 
pub
 
	sChªgeP“r
 {

127 
pub
 
	mcÚf_chªge
: 
CÚfChªge
,

128 
pub
 
	m³”
: 
P“rM‘a
,

129 
pub
 
	m»giÚ
: 
RegiÚ
,

132 #[
d”ive
(
Debug
)]

133 
pub
 
	sRªge
 {

134 
pub
 
	mcf
: 
SŒšg
,

135 
pub
 
	m¡¬t_key
: 
Vec
<
u8
>,

136 
pub
 
	m’d_key
: 
Vec
<
u8
>,

139 
im¶
 
	gRªge
 {

140 
â
 
Ãw
(
cf
: 
SŒšg
, 
¡¬t_key
: 
Vec
<
u8
>, 
’d_key
: Vec<u8>è-> 
Rªge
 {

141 
Rªge
 {

142 
cf
: cf,

143 
	g¡¬t_key
: 
¡¬t_key
,

144 
	g’d_key
: 
’d_key
,

149 #[
d”ive
(
Debug
)]

150 
pub
 
	eExecResuÉ
 {

151 
ChªgeP“r
(ChangePeer),

152 
	mCom·ùLog
 {

153 
	m¡©e
: 
RaáTrunÿ‹dS‹
,

154 
	mfœ¡_šdex
: 
u64
,

156 
	mS¶™RegiÚ
 {

157 
	mËá
: 
RegiÚ
,

158 
	mright
: 
RegiÚ
,

159 
	mright_d”ive
: 
boŞ
,

161 
	mCompu‹Hash
 {

162 
	m»giÚ
: 
RegiÚ
,

163 
	mšdex
: 
u64
,

164 
	m¢­
: 
SÇpshÙ
,

166 
	mV”ifyHash
 { 
	mšdex
: 
u64
, 
	mhash
: 
Vec
<
u8
> },

167 
	mD–‘eRªge
 { 
	m¿nges
: 
Vec
<
Rªge
> },

170 
	gAµlyCÚ‹xt
<'a> {

171 
	gho¡
: &'a CoprocessorHost,

172 
wb
: 
Wr™eB©ch
,

173 
	gcbs
: 
Mu¡CÚsumeVec
<(
C®lback
, 
	gRaáCmdRe¥Ú£
)>,

174 
	gwb_Ï¡_by‹s
: 
u64
,

175 
	gwb_Ï¡_keys
: 
u64
,

176 
	gsync_log
: 
boŞ
,

177 
	gexec_ùx
: 
O±iÚ
<
ExecCÚ‹xt
>,

180 
	gim¶
<'a> AµlyCÚ‹xt<'
	ga
> {

181 
â
 
Ãw
(
ho¡
: &
CİroûssÜHo¡
è-> 
AµlyCÚ‹xt
 {

182 
AµlyCÚ‹xt
 {

183 
ho¡
: host,

184 
	gwb
: 
Wr™eB©ch
::
w™h_ÿ·c™y
(
DEFAULT_APPLY_WB_SIZE
),

185 
	gcbs
: 
Mu¡CÚsumeVec
::
Ãw
("callback of‡pply context"),

186 
	gwb_Ï¡_by‹s
: 0,

187 
	gwb_Ï¡_keys
: 0,

188 
	gsync_log
: 
çl£
,

189 
	gexec_ùx
: 
NÚe
,

193 
pub
 
â
 
m¬k_Ï¡_by‹s_ªd_keys
(&
mut
 
£lf
) {

194 
	g£lf
.
	gwb_Ï¡_by‹s
 = 
£lf
.
wb
.
d©a_size
(è
as
 
u64
;

195 
	g£lf
.
	gwb_Ï¡_keys
 = 
£lf
.
wb
.
couÁ
(è
as
 
u64
;

198 
pub
 
â
 
d–_by‹s
(&
£lf
è-> 
	gu64
 {

199 
	g£lf
.
	gwb
.
d©a_size
(è
as
 
	gu64
 - s–f.
	gwb_Ï¡_by‹s


202 
pub
 
â
 
d–_keys
(&
£lf
è-> 
	gu64
 {

203 
	g£lf
.
	gwb
.
couÁ
(è
as
 
	gu64
 - s–f.
	gwb_Ï¡_keys


208 
â
 
	$nÙify_»giÚ_»moved
(
»giÚ_id
: 
u64
, 
³”_id
: u64, 
mut
 
cmd
: 
P’dšgCmd
) {

209 
debug
!(

211 
»giÚ_id
,

212 
³”_id
,

213 
cmd
.
šdex
,

214 
cmd
.
‹rm


216 
	`nÙify_»q_»giÚ_»moved
(
»giÚ_id
, 
cmd
.
cb
.
	`ke
().
	`unw¿p
());

217 
	}
}

219 
pub
 
â
 
	$nÙify_»q_»giÚ_»moved
(
»giÚ_id
: 
u64
, 
cb
: 
C®lback
) {

220 
Ët
 
»giÚ_nÙ_found
 = 
E¼Ü
::
	`RegiÚNÙFound
(
»giÚ_id
);

221 
Ët
 
»¥
 = 
cmd_»¥
::
	`Ãw_”rÜ
(
»giÚ_nÙ_found
);

222 
	`cb
(
»¥
);

223 
	}
}

226 
â
 
	$nÙify_¡®e_commªd
(
g
: &
¡r
, 
‹rm
: 
u64
, 
mut
 
cmd
: 
P’dšgCmd
) {

227 
šfo
!(

229 
g
,

230 
cmd
.
šdex
,

231 
cmd
.
‹rm


233 
	`nÙify_¡®e_»q
(
‹rm
, 
cmd
.
cb
.
	`ke
().
	`unw¿p
());

234 
	}
}

236 
pub
 
â
 
	$nÙify_¡®e_»q
(
‹rm
: 
u64
, 
cb
: 
C®lback
) {

237 
Ët
 
»¥
 = 
cmd_»¥
::
	`”r_»¥
(
E¼Ü
::
SËCommªd
, 
‹rm
);

238 
	`cb
(
»¥
);

239 
	}
}

241 
â
 
should_æush_to_’gše
(
cmd
: &
RaáCmdReque¡
, 
wb_keys
: 
usize
è-> 
boŞ
 {

243 
cmd
.
has_admš_»que¡
() &&

244 
cmd
.
g‘_admš_»que¡
().
g‘_cmd_ty³
(è=ğ
AdmšCmdTy³
::
Compu‹Hash


246  
Œue
;

250 
	gwb_keys
 >ğ
WRITE_BATCH_MAX_KEYS
 {

251  
Œue
;

256 
»q
 
š
 
	gcmd
.
g‘_»que¡s
() {

257 
	g»q
.
has_d–‘e_¿nge
() {

258  
	gŒue
;

262 
	gçl£


265 #[
d”ive
(
Debug
)]

266 
pub
 
	sAµlyD–eg©e
 {

268 
	mid
: 
u64
,

270 
	mg
: 
SŒšg
,

271 
	m’gše
: 
Arc
<
DB
>,

272 
	m»giÚ
: 
RegiÚ
,

275 
	m³ndšg_»move
: 
boŞ
,

280 
	m­¶y_¡©e
: 
RaáAµlyS‹
,

281 
	m­¶›d_šdex_‹rm
: 
u64
,

282 
	m‹rm
: 
u64
,

283 
	m³ndšg_cmds
: 
P’dšgCmdQueue
,

284 
	mm‘rics
: 
AµlyM‘rics
,

287 
im¶
 
	gAµlyD–eg©e
 {

288 
pub
 
â
 
»giÚ_id
(&
£lf
è-> 
	gu64
 {

289 
	g£lf
.
	g»giÚ
.
g‘_id
()

292 
pub
 
â
 
id
(&
£lf
è-> 
	gu64
 {

293 
	g£lf
.
	gid


296 
â
 
äom_³”
(
³”
: &
P“r
è-> 
AµlyD–eg©e
 {

297 
Ët
 
»g
 = 
Regi¡¿tiÚ
::
Ãw
(
³”
);

298 
	gAµlyD–eg©e
::
äom_»gi¡¿tiÚ
(
³”
.
kv_’gše
(), 
»g
)

301 
â
 
äom_»gi¡¿tiÚ
(
db
: 
Arc
<
DB
>, 
»g
: 
Regi¡¿tiÚ
è-> 
AµlyD–eg©e
 {

302 
AµlyD–eg©e
 {

303 
id
: 
»g
.id,

304 
	gg
: 
fÜm©
!("[»giÚ {}] {}", 
	g»g
.
	g»giÚ
.
g‘_id
(),„eg.
	gid
),

305 
	g’gše
: 
db
,

306 
	g»giÚ
: 
»g
.
»giÚ
,

307 
	g³ndšg_»move
: 
çl£
,

308 
	g­¶y_¡©e
: 
»g
.
­¶y_¡©e
,

309 
	g­¶›d_šdex_‹rm
: 
»g
.
­¶›d_šdex_‹rm
,

310 
	g‹rm
: 
»g
.
‹rm
,

311 
	g³ndšg_cmds
: 
DeçuÉ
::(),

312 
	gm‘rics
: 
DeçuÉ
::(),

316 
â
 
hªdË_¿á_comm™‹d_’Œ›s
(

317 &
mut
 
£lf
,

318 
­¶y_ùx
: &
mut
 
AµlyCÚ‹xt
,

319 
comm™‹d_’Œ›s
: 
Vec
<
EÁry
>,

320 è-> 
	gVec
<
	gExecResuÉ
> {

321 
	gcomm™‹d_’Œ›s
.
is_em±y
() {

322  
	gvec
![];

327 
Ët
 
mut
 
	g»suÉs
 = 
vec
![];

328 
’Œy
 
š
 
	gcomm™‹d_’Œ›s
 {

329 
	g£lf
.
	g³ndšg_»move
 {

334 
Ët
 
	gex³ù_šdex
 = 
£lf
.
­¶y_¡©e
.
g‘_­¶›d_šdex
() + 1;

335 
	gex³ù_šdex
 !ğ
’Œy
.
g‘_šdex
() {

336 
·nic
!(

338 
£lf
.
g
,

339 
ex³ù_šdex
,

340 
’Œy
.
g‘_šdex
()

344 
Ët
 
	g»s
 = 
m©ch
 
’Œy
.
g‘_’Œy_ty³
() {

345 
EÁryTy³
::
EÁryNÜm®
 => 
£lf
.
hªdË_¿á_’Œy_nÜm®
(
­¶y_ùx
, 
’Œy
),

346 
	gEÁryTy³
::
EÁryCÚfChªge
 => 
£lf
.
hªdË_¿á_’Œy_cÚf_chªge
(
­¶y_ùx
, 
’Œy
),

349 
Ët
 
Some
(
»s
) =„es {

350 
»suÉs
.
push
(
»s
);

354 !
	g£lf
.
	g³ndšg_»move
 {

355 
	g£lf
.
wr™e_­¶y_¡©e
(&
­¶y_ùx
.
wb
);

358 
	g£lf
.
upd©e_m‘rics
(
­¶y_ùx
);

359 
	g­¶y_ùx
.
m¬k_Ï¡_by‹s_ªd_keys
();

361 
	g»suÉs


364 
â
 
upd©e_m‘rics
(&
mut
 
£lf
, 
­¶y_ùx
: &
AµlyCÚ‹xt
) {

365 
£lf
.
m‘rics
.
wr™‹n_by‹s
 +ğ
­¶y_ùx
.
d–_by‹s
();

366 
	g£lf
.
	gm‘rics
.
	gwr™‹n_keys
 +ğ
­¶y_ùx
.
d–_keys
();

369 
â
 
wr™e_­¶y_¡©e
(&
£lf
, 
wb
: &
Wr™eB©ch
) {

370 
rocksdb
::
g‘_cf_hªdË
(&
£lf
.
’gše
, 
CF_RAFT
)

371 .
m­_”r
(
From
::
äom
)

372 .
ªd_th’
(|
hªdË
| {

373 
wb
.
put_msg_cf
(

374 
hªdË
,

375 &
keys
::
­¶y_¡©e_key
(
£lf
.
»giÚ
.
g‘_id
()),

376 &
£lf
.
­¶y_¡©e
,

379 .
unw¿p_Ü_–£
(|
e
| {

380 
·nic
!(

382 
£lf
.
g
,

383 
e


388 
â
 
hªdË_¿á_’Œy_nÜm®
(

389 &
mut
 
£lf
,

390 
­¶y_ùx
: &
mut
 
AµlyCÚ‹xt
,

391 
’Œy
: 
EÁry
,

392 è-> 
	gO±iÚ
<
	gExecResuÉ
> {

393 
Ët
 
	gšdex
 = 
’Œy
.
g‘_šdex
();

394 
Ët
 
	g‹rm
 = 
’Œy
.
g‘_‹rm
();

395 
Ët
 
	gd©a
 = 
’Œy
.
g‘_d©a
();

397 !
	gd©a
.
is_em±y
() {

398 
Ët
 
	gcmd
 = 
·r£_d©a_©
(
d©a
, 
šdex
, &
£lf
.
g
);

400 
should_æush_to_’gše
(&
cmd
, 
­¶y_ùx
.
wb
.
couÁ
()) {

401 
	g£lf
.
wr™e_­¶y_¡©e
(&
­¶y_ùx
.
wb
);

403 
	g£lf
.
upd©e_m‘rics
(
­¶y_ùx
);

404 
Ët
 
	gwb
 = 
Wr™eB©ch
::
w™h_ÿ·c™y
(
DEFAULT_APPLY_WB_SIZE
);

406 
	g£lf
.
	g’gše


407 .
wr™e
(
mem
::
»¶aû
(&
mut
 
­¶y_ùx
.
wb
, wb))

408 .
unw¿p_Ü_–£
(|
e
| {

409 
·nic
!("{} faedØwr™tØ’gše,ƒ¼Ü: {:?}", 
£lf
.
g
, 
e
)

413 
	gcb
, 
mut
 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

414 
	g­¶y_ùx
.
	gho¡
.
po¡_­¶y
(&
£lf
.
»giÚ
, &
mut
 
»¥
);

415 
cb
(
»¥
);

417 
	g­¶y_ùx
.
m¬k_Ï¡_by‹s_ªd_keys
();

420  
	g£lf
.
´oûss_¿á_cmd
(
­¶y_ùx
, 
šdex
, 
‹rm
, 
cmd
);

424 
Ët
 
mut
 
	g¡©e
 = 
£lf
.
­¶y_¡©e
.
şÚe
();

425 
	g¡©e
.
£t_­¶›d_šdex
(
šdex
);

426 
	g£lf
.
	g­¶y_¡©e
 = 
¡©e
;

427 
	g£lf
.
	g­¶›d_šdex_‹rm
 = 
‹rm
;

428 
	gas£¹
!(
	g‹rm
 > 0);

429 
Ët
 
Some
(
mut
 
cmd
èğ
£lf
.
³ndšg_cmds
.
pİ_nÜm®
(
‹rm
 - 1) {

431 
­¶y_ùx
.
cbs
.
push
((

432 
cmd
.
cb
.
ke
().
unw¿p
(),

433 
cmd_»¥
::
”r_»¥
(
E¼Ü
::
SËCommªd
, 
‹rm
),

436 
	gNÚe


439 
â
 
hªdË_¿á_’Œy_cÚf_chªge
(

440 &
mut
 
£lf
,

441 
­¶y_ùx
: &
mut
 
AµlyCÚ‹xt
,

442 
’Œy
: 
EÁry
,

443 è-> 
	gO±iÚ
<
	gExecResuÉ
> {

444 
Ët
 
	gšdex
 = 
’Œy
.
g‘_šdex
();

445 
Ët
 
	g‹rm
 = 
’Œy
.
g‘_‹rm
();

446 
Ët
 
	gcÚf_chªge
: 
CÚfChªge
 = 
·r£_d©a_©
(
’Œy
.
g‘_d©a
(), 
šdex
, &
£lf
.
g
);

447 
Ët
 
	gcmd
 = 
·r£_d©a_©
(
cÚf_chªge
.
g‘_cÚ‹xt
(), 
šdex
, &
£lf
.
g
);

448 
Some
(

449 
£lf
.
´oûss_¿á_cmd
(
­¶y_ùx
, 
šdex
, 
‹rm
, 
cmd
)

450 .
m­_Ü_–£
(

453 
ExecResuÉ
::
ChªgeP“r
(
DeçuÉ
::())

455 |
mut
 
»s
| {

456 
Ët
 
ExecResuÉ
::
ChªgeP“r
(
»f
 
mut
 
ı
èğ
»s
 {

457 
ı
.
cÚf_chªge
 = conf_change;

459 
·nic
!(

461 
£lf
.
g
,

462 
»s
,

463 
cÚf_chªge
,

464 
šdex


467 
»s


473 
â
 
fšd_cb
(&
mut
 
£lf
, 
šdex
: 
u64
, 
‹rm
: u64, 
cmd
: &
RaáCmdReque¡
è-> 
O±iÚ
<
C®lback
> {

474 
g‘_chªge_³”_cmd
(
cmd
).
is_some
() {

475 
Ët
 
Some
(
mut
 
cmd
èğ
£lf
.
³ndšg_cmds
.
ke_cÚf_chªge
() {

476 
cmd
.
šdex
 =ğšdex && cmd.
‹rm
 ==erm {

477  
Some
(
cmd
.
cb
.
ke
().
unw¿p
());

479 
nÙify_¡®e_commªd
(&
£lf
.
g
, s–f.
‹rm
, 
cmd
);

482  
	gNÚe
;

484 
Ët
 
Some
(
mut
 
h—d
èğ
£lf
.
³ndšg_cmds
.
pİ_nÜm®
(
‹rm
) {

485 
h—d
.
šdex
 =ğšdex && h—d.
‹rm
 ==erm {

486  
Some
(
h—d
.
cb
.
ke
().
unw¿p
());

490 
nÙify_¡®e_commªd
(&
£lf
.
g
, s–f.
‹rm
, 
h—d
);

492 
	gNÚe


495 
â
 
´oûss_¿á_cmd
(

496 &
mut
 
£lf
,

497 
­¶y_ùx
: &
mut
 
AµlyCÚ‹xt
,

498 
šdex
: 
u64
,

499 
‹rm
: 
u64
,

500 
cmd
: 
RaáCmdReque¡
,

501 è-> 
	gO±iÚ
<
	gExecResuÉ
> {

502 
	gšdex
 == 0 {

503 
·nic
!(

505 
£lf
.
g


509 
	gcmd
.
has_admš_»que¡
() {

510 
	g­¶y_ùx
.
	gsync_log
 = 
Œue
;

513 
Ët
 
	gcmd_cb
 = 
£lf
.
fšd_cb
(
šdex
, 
‹rm
, &
cmd
);

514 
	g­¶y_ùx
.
	gho¡
.
´e_­¶y
(&
£lf
.
»giÚ
, &
cmd
);

515 
Ët
 (
mut
 
»¥
, 
exec_»suÉ
èğ
£lf
.
­¶y_¿á_cmd
(
­¶y_ùx
, 
šdex
, 
‹rm
, 
cmd
);

517 
	gdebug
!("{}‡µl›d commªd‡ˆlog index {}", 
	g£lf
.
	gg
, 
	gšdex
);

519 
Ët
 
	gcb
 = 
m©ch
 
cmd_cb
 {

520 
NÚe
 =>  
exec_»suÉ
,

521 
Some
(
cb
) => cb,

526 
	gcmd_»¥
::
bšd_‹rm
(&
mut
 
»¥
, 
£lf
.
‹rm
);

527 
	g­¶y_ùx
.
	gcbs
.
push
((
cb
, 
»¥
));

529 
	gexec_»suÉ


538 
â
 
­¶y_¿á_cmd
(

539 &
mut
 
£lf
,

540 
ùx
: &
mut
 
AµlyCÚ‹xt
,

541 
šdex
: 
u64
,

542 
‹rm
: 
u64
,

543 
»q
: 
RaáCmdReque¡
,

544 è-> (
	gRaáCmdRe¥Ú£
, 
	gO±iÚ
<
	gExecResuÉ
>) {

546 
	gas£¹
!(!
	g£lf
.
	g³ndšg_»move
);

548 
	gùx
.
	gexec_ùx
 = 
Some
(
£lf
.
Ãw_ùx
(
šdex
, 
‹rm
, 
»q
));

549 
	gùx
.
	gwb
.
£t_§ve_pošt
();

550 
Ët
 (
»¥
, 
exec_»suÉ
èğ
£lf
.
exec_¿á_cmd
(
ùx
).
unw¿p_Ü_–£
(|
e
| {

552 
ùx
.
wb
.
rŞlback_to_§ve_pošt
().
unw¿p
();

553 
m©ch
 
e
 {

554 
E¼Ü
::
SËEpoch
(..è=> 
šfo
!("{} sËƒpochƒ¼: {:?}", 
£lf
.
g
, 
e
),

555 
_
 => 
”rÜ
!("{}ƒxecu‹„aá commªdƒ¼: {:?}", 
£lf
.
g
, 
e
),

557 (
cmd_»¥
::
Ãw_”rÜ
(
e
), 
NÚe
)

560 
Ët
 
mut
 
	gexec_ùx
 = 
ùx
.
exec_ùx
.
ke
().
unw¿p
();

561 
	gexec_ùx
.
	g­¶y_¡©e
.
£t_­¶›d_šdex
(
šdex
);

563 
	g£lf
.
	g­¶y_¡©e
 = 
exec_ùx
.
­¶y_¡©e
;

564 
	g£lf
.
	g­¶›d_šdex_‹rm
 = 
‹rm
;

566 
Ët
 
Some
(
»f
 
exec_»suÉ
) =ƒxec_result {

567 
m©ch
 *
exec_»suÉ
 {

568 
ExecResuÉ
::
ChªgeP“r
(
»f
 
ı
) => {

569 
£lf
.
»giÚ
 = 
ı
.»giÚ.
şÚe
();

571 
	gExecResuÉ
::
Compu‹Hash
 { .. } |

572 
ExecResuÉ
::
V”ifyHash
 { .. } |

573 
ExecResuÉ
::
Com·ùLog
 { .. } |

574 
ExecResuÉ
::
D–‘eRªge
 { .. } => {}

575 
ExecResuÉ
::
S¶™RegiÚ
 {

576 
»f
 
Ëá
,

577 
»f
 
right
,

578 
right_d”ive
,

580 
right_d”ive
 {

581 
£lf
.
»giÚ
 = 
right
.
şÚe
();

583 
	g£lf
.
	g»giÚ
 = 
Ëá
.
şÚe
();

585 
	g£lf
.
	gm‘rics
.
	gsize_diff_hšt
 = 0;

586 
	g£lf
.
	gm‘rics
.
	gd–‘e_keys_hšt
 = 0;

591 (
	g»¥
, 
	gexec_»suÉ
)

598 
â
 
ş—r_³ndšg_commªds
(&
mut
 
£lf
) {

599 !
	g£lf
.
	g³ndšg_cmds
.
	gnÜm®s
.
is_em±y
() {

600 
	gšfo
!(

602 
	g£lf
.
	gg
,

603 
	g£lf
.
	g³ndšg_cmds
.
	gnÜm®s
.
Ën
()

605 
Ët
 
Some
(
mut
 
cmd
èğ
£lf
.
³ndšg_cmds
.
nÜm®s
.
pİ_äÚt
() {

606 
cmd
.
cb
.
ke
();

609 
Ët
 
Some
(
mut
 
cmd
èğ
£lf
.
³ndšg_cmds
.
cÚf_chªge
.
ke
() {

610 
šfo
!("{} cË¬…’dšg cÚàchªge", 
£lf
.
g
);

611 
	gcmd
.
	gcb
.
ke
();

615 
â
 
de¡roy
(&
mut
 
£lf
) {

616 
cmd
 
š
 
	g£lf
.
	g³ndšg_cmds
.
	gnÜm®s
.
d¿š
(..) {

617 
nÙify_»giÚ_»moved
(
£lf
.
»giÚ
.
g‘_id
(), s–f.
id
, 
cmd
);

619 
Ët
 
Some
(
cmd
èğ
£lf
.
³ndšg_cmds
.
cÚf_chªge
.
ke
() {

620 
nÙify_»giÚ_»moved
(
£lf
.
»giÚ
.
g‘_id
(), s–f.
id
, 
cmd
);

624 
â
 
ş—r_®l_commªds_as_¡®e
(&
mut
 
£lf
) {

625 
cmd
 
š
 
	g£lf
.
	g³ndšg_cmds
.
	gnÜm®s
.
d¿š
(..) {

626 
nÙify_¡®e_commªd
(&
£lf
.
g
, s–f.
‹rm
, 
cmd
);

628 
Ët
 
Some
(
cmd
èğ
£lf
.
³ndšg_cmds
.
cÚf_chªge
.
ke
() {

629 
nÙify_¡®e_commªd
(&
£lf
.
g
, s–f.
‹rm
, 
cmd
);

633 
â
 
Ãw_ùx
(&
£lf
, 
šdex
: 
u64
, 
‹rm
: u64, 
»q
: 
RaáCmdReque¡
è-> 
ExecCÚ‹xt
 {

634 
ExecCÚ‹xt
 {

635 
­¶y_¡©e
: 
£lf
.­¶y_¡©e.
şÚe
(),

636 
	g»q
: 
Rc
::
Ãw
(
»q
),

637 
	gšdex
: 
šdex
,

638 
	g‹rm
: 
‹rm
,

643 
	sExecCÚ‹xt
 {

644 
	m­¶y_¡©e
: 
RaáAµlyS‹
,

648 
	m»q
: 
Rc
<
RaáCmdReque¡
>,

649 
	mšdex
: 
u64
,

650 
	m‹rm
: 
u64
,

654 
im¶
 
	gAµlyD–eg©e
 {

656 
â
 
exec_¿á_cmd
(

657 &
mut
 
£lf
,

658 
ùx
: &
mut
 
AµlyCÚ‹xt
,

659 è-> 
	gResuÉ
<(
	gRaáCmdRe¥Ú£
, 
	gO±iÚ
<
	gExecResuÉ
>)> {

660 
Ët
 
	g»q
 = 
ùx
.
exec_ùx
.
as_»f
().
unw¿p
().
»q
.
şÚe
();

661 
check_•och
(&
£lf
.
»giÚ
, &
»q
)?;

662 
	g»q
.
has_admš_»que¡
() {

663 
	g£lf
.
exec_admš_cmd
(
ùx
, 
»q
.
g‘_admš_»que¡
())

665 
	g£lf
.
exec_wr™e_cmd
(
ùx
, 
»q
.
g‘_»que¡s
())

669 
â
 
exec_admš_cmd
(

670 &
mut
 
£lf
,

671 
ùx
: &
mut
 
AµlyCÚ‹xt
,

672 
»que¡
: &
AdmšReque¡
,

673 è-> 
	gResuÉ
<(
	gRaáCmdRe¥Ú£
, 
	gO±iÚ
<
	gExecResuÉ
>)> {

674 
Ët
 
	gcmd_ty³
 = 
»que¡
.
g‘_cmd_ty³
();

675 
	gšfo
!(

677 
	g£lf
.
	gg
,

678 
	g»que¡
,

679 
	gùx
.
	gexec_ùx
.
as_»f
().
unw¿p
().
	g‹rm
,

680 
	gùx
.
	gexec_ùx
.
as_»f
().
unw¿p
().
	gšdex


683 
Ët
 (
mut
 
»¥Ú£
, 
exec_»suÉ
èğ
m©ch
 
cmd_ty³
 {

684 
AdmšCmdTy³
::
ChªgeP“r
 => 
£lf
.
exec_chªge_³”
(
ùx
, 
»que¡
),

685 
	gAdmšCmdTy³
::
S¶™
 => 
£lf
.
exec_¥l™
(
ùx
, 
»que¡
),

686 
	gAdmšCmdTy³
::
Com·ùLog
 => 
£lf
.
exec_com·ù_log
(
ùx
, 
»que¡
),

687 
	gAdmšCmdTy³
::
T¿nsãrL—d”
 => 
E¼
(
box_”r
!("transfer†eader won'tƒxec")),

688 
	gAdmšCmdTy³
::
Compu‹Hash
 => 
£lf
.
exec_compu‹_hash
(
ùx
, 
»que¡
),

689 
	gAdmšCmdTy³
::
V”ifyHash
 => 
£lf
.
exec_v”ify_hash
(
ùx
, 
»que¡
),

690 
	gAdmšCmdTy³
::
Inv®idAdmš
 => 
E¼
(
box_”r
!("unsupported‡dmin commandype")),

692 
	g»¥Ú£
.
£t_cmd_ty³
(
cmd_ty³
);

694 
Ët
 
mut
 
	g»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

695 
Ët
 
	guuid
 = 
ùx
.
exec_ùx


696 .
as_»f
()

697 .
unw¿p
()

698 .
»q


699 .
g‘_h—d”
()

700 .
g‘_uuid
()

701 .
to_vec
();

702 
	g»¥
.
mut_h—d”
().
£t_uuid
(
uuid
);

703 
	g»¥
.
£t_admš_»¥Ú£
(
»¥Ú£
);

704 
Ok
((
»¥
, 
exec_»suÉ
))

707 
â
 
exec_chªge_³”
(

708 &
mut
 
£lf
,

709 
ùx
: &
mut
 
AµlyCÚ‹xt
,

710 
»que¡
: &
AdmšReque¡
,

711 è-> 
	gResuÉ
<(
	gAdmšRe¥Ú£
, 
	gO±iÚ
<
	gExecResuÉ
>)> {

712 
Ët
 
	g»que¡
 = 
»que¡
.
g‘_chªge_³”
();

713 
Ët
 
	g³”
 = 
»que¡
.
g‘_³”
();

714 
Ët
 
	g¡Üe_id
 = 
³”
.
g‘_¡Üe_id
();

715 
Ët
 
	gchªge_ty³
 = 
»que¡
.
g‘_chªge_ty³
();

716 
Ët
 
mut
 
	g»giÚ
 = 
£lf
.
»giÚ
.
şÚe
();

718 
	gšfo
!(

720 
	g£lf
.
	gg
,

721 
	gut
::
cÚf_chªge_ty³_¡r
(&
chªge_ty³
),

722 
	g»giÚ
.
g‘_»giÚ_•och
()

726 
Ët
 
	gexi¡s
 = 
ut
::
fšd_³”
(&
»giÚ
, 
¡Üe_id
).
is_some
();

727 
Ët
 
	gcÚf_v”
 = 
»giÚ
.
g‘_»giÚ_•och
().
g‘_cÚf_v”
() + 1;

729 
	g»giÚ
.
mut_»giÚ_•och
().
£t_cÚf_v”
(
cÚf_v”
);

731 
m©ch
 
	gchªge_ty³
 {

732 
	gCÚfChªgeTy³
::
AddNode
 => {

733 
PEER_ADMIN_CMD_COUNTER_VEC


734 .
w™h_Ïb–_v®ues
(&["add_peer", "all"])

735 .
šc
();

737 
	gexi¡s
 {

738 
	g”rÜ
!(

740 
	g£lf
.
	gg
,

741 
	g³”
,

742 
	g£lf
.
	g»giÚ


744  
E¼
(
box_”r
!(

746 
³”
,

747 
£lf
.
»giÚ


753 
	g»giÚ
.
mut_³”s
().
push
(
³”
.
şÚe
());

755 
	gPEER_ADMIN_CMD_COUNTER_VEC


756 .
w™h_Ïb–_v®ues
(&["add_peer", "success"])

757 .
šc
();

759 
	gšfo
!(

761 
	g£lf
.
	gg
,

762 
	g³”
,

763 
	g£lf
.
	g»giÚ


766 
	gCÚfChªgeTy³
::
RemoveNode
 => {

767 
PEER_ADMIN_CMD_COUNTER_VEC


768 .
w™h_Ïb–_v®ues
(&["remove_peer", "all"])

769 .
šc
();

771 !
	gexi¡s
 {

772 
	g”rÜ
!(

774 
	g£lf
.
	gg
,

775 
	g³”
,

776 
	g£lf
.
	g»giÚ


778  
E¼
(
box_”r
!(

780 
³”
,

781 
£lf
.
»giÚ


785 
	g£lf
.
	gid
 =ğ
³”
.
g‘_id
() {

788 
£lf
.
³ndšg_»move
 = 
Œue
;

791 
	gut
::
»move_³”
(&
mut
 
»giÚ
, 
¡Üe_id
).
unw¿p
();

793 
	gPEER_ADMIN_CMD_COUNTER_VEC


794 .
w™h_Ïb–_v®ues
(&["remove_peer", "success"])

795 .
šc
();

797 
	gšfo
!(

799 
	g£lf
.
	gg
,

800 
	g³”
.
g‘_id
(),

801 
	g£lf
.
	g»giÚ


804 
	gCÚfChªgeTy³
::
AddL—º”Node
 => 
unim¶em’‹d
!(),

807 
Ët
 
	g¡©e
 = 
£lf
.
³ndšg_»move
 {

808 
P“rS‹
::
Tomb¡Úe


810 
P“rS‹
::
NÜm®


812 
Ët
 
E¼
(
e
èğ
wr™e_³”_¡©e
(&
£lf
.
’gše
, &
ùx
.
wb
, &
»giÚ
, 
¡©e
) {

813 
	g·nic
!("{} faedØupd©»giÚ s‹: {:?}", 
	g£lf
.
	gg
, 
	ge
);

816 
Ët
 
mut
 
	g»¥
 = 
AdmšRe¥Ú£
::
Ãw
();

817 
	g»¥
.
mut_chªge_³”
().
£t_»giÚ
(
»giÚ
.
şÚe
());

819 
Ok
((

820 
»¥
,

821 
Some
(
ExecResuÉ
::
ChªgeP“r
(ChangePeer {

822 
cÚf_chªge
: 
DeçuÉ
::(),

823 
³”
:…“r.
şÚe
(),

824 
»giÚ
:„egion,

829 
â
 
exec_¥l™
(

830 &
mut
 
£lf
,

831 
ùx
: &
mut
 
AµlyCÚ‹xt
,

832 
»q
: &
AdmšReque¡
,

833 è-> 
	gResuÉ
<(
	gAdmšRe¥Ú£
, 
	gO±iÚ
<
	gExecResuÉ
>)> {

834 
	gPEER_ADMIN_CMD_COUNTER_VEC


835 .
w™h_Ïb–_v®ues
(&["split", "all"])

836 .
šc
();

838 
Ët
 
	g¥l™_»q
 = 
»q
.
g‘_¥l™
();

839 
Ët
 
	gright_d”ive
 = 
¥l™_»q
.
g‘_right_d”ive
();

840 
	g¥l™_»q
.
g‘_¥l™_key
().
is_em±y
() {

841  
E¼
(
box_”r
!("missing split key"));

844 
Ët
 
	g¥l™_key
 = 
¥l™_»q
.
g‘_¥l™_key
();

845 
Ët
 
mut
 
	g»giÚ
 = 
£lf
.
»giÚ
.
şÚe
();

846 
	g¥l™_key
 <ğ
»giÚ
.
g‘_¡¬t_key
() {

847  
E¼
(
box_”r
!("šv®id s¶™„eque¡: {:?}", 
¥l™_»q
));

850 
	gut
::
check_key_š_»giÚ
(
¥l™_key
, &
»giÚ
)?;

852 
	gšfo
!(

854 
	g£lf
.
	gg
,

855 
esÿ³
(
¥l™_key
),

856 
	g»giÚ


860 
Ët
 
	gÃw_»giÚ_id
 = 
¥l™_»q
.
g‘_Ãw_»giÚ_id
();

864 
Ët
 
mut
 
	gÃw_»giÚ
 = 
»giÚ
.
şÚe
();

865 
	gÃw_»giÚ
.
£t_id
(
Ãw_»giÚ_id
);

866 
	gright_d”ive
 {

867 
	g»giÚ
.
£t_¡¬t_key
(
¥l™_key
.
to_vec
());

868 
	gÃw_»giÚ
.
£t_’d_key
(
¥l™_key
.
to_vec
());

870 
	g»giÚ
.
£t_’d_key
(
¥l™_key
.
to_vec
());

871 
	gÃw_»giÚ
.
£t_¡¬t_key
(
¥l™_key
.
to_vec
());

875 
Ët
 
	gÃw_³”_ids
 = 
¥l™_»q
.
g‘_Ãw_³”_ids
();

876 
	gÃw_³”_ids
.
Ën
(è!ğ
Ãw_»giÚ
.
g‘_³”s
().len() {

877  
E¼
(
box_”r
!(

879 
Ãw_»giÚ
.
g‘_³”s
().
Ën
(),

880 
Ãw_³”_ids
.
Ën
()

884 
	g³”
, &
	g³”_id
è
š
 
	gÃw_»giÚ
.
mut_³”s
().
™”_mut
().
z
(
Ãw_³”_ids
) {

885 
	g³”
.
£t_id
(
³”_id
);

889 
Ët
 
	g»giÚ_v”
 = 
»giÚ
.
g‘_»giÚ_•och
().
g‘_v”siÚ
() + 1;

890 
	g»giÚ
.
mut_»giÚ_•och
().
£t_v”siÚ
(
»giÚ_v”
);

891 
	gÃw_»giÚ
.
mut_»giÚ_•och
().
£t_v”siÚ
(
»giÚ_v”
);

892 
wr™e_³”_¡©e
(&
£lf
.
’gše
, &
ùx
.
wb
, &
»giÚ
, 
P“rS‹
::
NÜm®
)

893 .
ªd_th’
(|
_
| {

894 
wr™e_³”_¡©e
(&
£lf
.
’gše
, &
ùx
.
wb
, &
Ãw_»giÚ
, 
P“rS‹
::
NÜm®
)

896 .
ªd_th’
(|
_
| {

897 
wr™e_š™Ÿl_­¶y_¡©e
(&
£lf
.
’gše
, &
ùx
.
wb
, 
Ãw_»giÚ
.
g‘_id
())

899 .
unw¿p_Ü_–£
(|
e
| {

900 
·nic
!(

902 
£lf
.
g
,

903 
Ãw_»giÚ
,

904 
e


908 
Ët
 
mut
 
	g»¥
 = 
AdmšRe¥Ú£
::
Ãw
();

909 
	gright_d”ive
 {

910 
	g»¥
.
mut_¥l™
().
£t_Ëá
(
Ãw_»giÚ
.
şÚe
());

911 
	g»¥
.
mut_¥l™
().
£t_right
(
»giÚ
.
şÚe
());

913 
	g»¥
.
mut_¥l™
().
£t_Ëá
(
»giÚ
.
şÚe
());

914 
	g»¥
.
mut_¥l™
().
£t_right
(
Ãw_»giÚ
.
şÚe
());

917 
	gPEER_ADMIN_CMD_COUNTER_VEC


918 .
w™h_Ïb–_v®ues
(&["split", "success"])

919 .
šc
();

921 
	gright_d”ive
 {

922 
Ok
((

923 
»¥
,

924 
Some
(
ExecResuÉ
::
S¶™RegiÚ
 {

925 
Ëá
: 
Ãw_»giÚ
,

926 
right
: 
»giÚ
,

927 
right_d”ive
: 
Œue
,

931 
Ok
((

932 
»¥
,

933 
Some
(
ExecResuÉ
::
S¶™RegiÚ
 {

934 
Ëá
: 
»giÚ
,

935 
right
: 
Ãw_»giÚ
,

936 
right_d”ive
: 
çl£
,

942 
â
 
exec_com·ù_log
(

943 &
mut
 
£lf
,

944 
ùx
: &
mut
 
AµlyCÚ‹xt
,

945 
»q
: &
AdmšReque¡
,

946 è-> 
	gResuÉ
<(
	gAdmšRe¥Ú£
, 
	gO±iÚ
<
	gExecResuÉ
>)> {

947 
	gPEER_ADMIN_CMD_COUNTER_VEC


948 .
w™h_Ïb–_v®ues
(&["compact", "all"])

949 .
šc
();

951 
Ët
 
	gcom·ù_šdex
 = 
»q
.
g‘_com·ù_log
().
g‘_com·ù_šdex
();

952 
Ët
 
	g»¥
 = 
AdmšRe¥Ú£
::
Ãw
();

953 
Ët
 
	g­¶y_¡©e
 = &
mut
 
ùx
.
exec_ùx
.
as_mut
().
unw¿p
().
­¶y_¡©e
;

954 
Ët
 
	gfœ¡_šdex
 = 
³”_¡Üage
::
fœ¡_šdex
(
­¶y_¡©e
);

955 
	gcom·ù_šdex
 <ğ
fœ¡_šdex
 {

956 
debug
!(

958 
£lf
.
g
,

959 
com·ù_šdex
,

960 
fœ¡_šdex


962  
Ok
((
»¥
, 
NÚe
));

965 
Ët
 
	gcom·ù_‹rm
 = 
»q
.
g‘_com·ù_log
().
g‘_com·ù_‹rm
();

967 
	gcom·ù_‹rm
 == 0 {

968 
šfo
!(

970 
£lf
.
g
,

971 
»q
.
g‘_com·ù_log
()

974  
E¼
(
box_”r
!(

980 
com·ù_¿á_log
(&
£lf
.
g
, 
­¶y_¡©e
, 
com·ù_šdex
, 
com·ù_‹rm
)?;

982 
	gPEER_ADMIN_CMD_COUNTER_VEC


983 .
w™h_Ïb–_v®ues
(&["compact", "success"])

984 .
šc
();

986 
Ok
((

987 
»¥
,

988 
Some
(
ExecResuÉ
::
Com·ùLog
 {

989 
¡©e
: 
­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
şÚe
(),

990 
fœ¡_šdex
: first_index,

995 
â
 
exec_wr™e_cmd
(

996 &
mut
 
£lf
,

997 
ùx
: &
AµlyCÚ‹xt
,

998 
»que¡s
: &[
Reque¡
],

999 è-> 
	gResuÉ
<(
	gRaáCmdRe¥Ú£
, 
	gO±iÚ
<
	gExecResuÉ
>)> {

1000 
Ët
 
mut
 
	g»¥Ú£s
 = 
Vec
::
w™h_ÿ·c™y
(
»que¡s
.
Ën
());

1002 
Ët
 
mut
 
	g¿nges
 = 
vec
![];

1003 
»q
 
š
 
	g»que¡s
 {

1004 
Ët
 
	gcmd_ty³
 = 
»q
.
g‘_cmd_ty³
();

1005 
Ët
 
mut
 
	g»¥
 = 
m©ch
 
cmd_ty³
 {

1006 
CmdTy³
::
Put
 => 
£lf
.
hªdË_put
(
ùx
, 
»q
),

1007 
	gCmdTy³
::
D–‘e
 => 
£lf
.
hªdË_d–‘e
(
ùx
, 
»q
),

1008 
	gCmdTy³
::
D–‘eRªge
 => 
£lf
.
hªdË_d–‘e_¿nge
(
»q
, &
mut
 
¿nges
),

1013 
	gCmdTy³
::
SÇp
 | 
CmdTy³
::
G‘
 => {

1014 
w¬n
!("{} sk„—dÚly commªd: {:?}", 
£lf
.
g
, 
»q
);

1017 
	gCmdTy³
::
P»wr™e
 | 
CmdTy³
::
Inv®id
 => {

1018 
E¼
(
box_”r
!("invalid cmdype, message maybe currupted"))

1022 
	g»¥
.
£t_cmd_ty³
(
cmd_ty³
);

1024 
	g»¥Ú£s
.
push
(
»¥
);

1027 
Ët
 
mut
 
	g»¥
 = 
RaáCmdRe¥Ú£
::
Ãw
();

1028 
Ët
 
	guuid
 = 
ùx
.
exec_ùx


1029 .
as_»f
()

1030 .
unw¿p
()

1031 .
»q


1032 .
g‘_h—d”
()

1033 .
g‘_uuid
()

1034 .
to_vec
();

1035 
	g»¥
.
mut_h—d”
().
£t_uuid
(
uuid
);

1036 
	g»¥
.
£t_»¥Ú£s
(
R•—‹dF›ld
::
äom_vec
(
»¥Ú£s
));

1038 
Ët
 
	gexec_»s
 = 
¿nges
.
is_em±y
() {

1039 
NÚe


1041 
Some
(
ExecResuÉ
::
D–‘eRªge
 { 
¿nges
:„anges })

1044 
Ok
((
»¥
, 
exec_»s
))

1047 
â
 
hªdË_put
(&
mut
 
£lf
, 
ùx
: &
AµlyCÚ‹xt
, 
»q
: &
Reque¡
è-> 
ResuÉ
<
Re¥Ú£
> {

1048 
Ët
 (
key
, 
v®ue
èğ(
»q
.
g‘_put
().
g‘_key
(), 
	g»q
.g‘_put().
g‘_v®ue
());

1049 
check_d©a_key
(
key
, &
£lf
.
»giÚ
)?;

1051 
Ët
 
	g»¥
 = 
Re¥Ú£
::
Ãw
();

1052 
Ët
 
	gkey
 = 
keys
::
d©a_key
(
key
);

1053 
	g£lf
.
	gm‘rics
.
	gsize_diff_hšt
 +ğ
key
.
Ën
(è
as
 
i64
;

1054 
	g£lf
.
	gm‘rics
.
	gsize_diff_hšt
 +ğ
v®ue
.
Ën
(è
as
 
i64
;

1055 !
	g»q
.
g‘_put
().
g‘_cf
().
is_em±y
() {

1056 
Ët
 
	gcf
 = 
»q
.
g‘_put
().
g‘_cf
();

1058 
	gcf
 =ğ
CF_LOCK
 {

1059 
£lf
.
m‘rics
.
lock_cf_wr™‹n_by‹s
 +ğ
key
.
Ën
(è
as
 
u64
;

1060 
	g£lf
.
	gm‘rics
.
	glock_cf_wr™‹n_by‹s
 +ğ
v®ue
.
Ën
(è
as
 
u64
;

1063 
	grocksdb
::
g‘_cf_hªdË
(&
£lf
.
’gše
, 
cf
)

1064 .
ªd_th’
(|
hªdË
| 
ùx
.
wb
.
put_cf
(hªdË, &
key
, 
v®ue
))

1065 .
unw¿p_Ü_–£
(|
e
| {

1066 
·nic
!(

1068 
£lf
.
g
,

1069 
esÿ³
(&
key
),

1070 
esÿ³
(
v®ue
),

1071 
cf
,

1072 
e


1076 
	gùx
.
	gwb
.
put
(&
key
, 
v®ue
).
unw¿p_Ü_–£
(|
e
| {

1077 
·nic
!(

1079 
£lf
.
g
,

1080 
esÿ³
(&
key
),

1081 
esÿ³
(
v®ue
),

1082 
e


1086 
Ok
(
»¥
)

1089 
â
 
hªdË_d–‘e
(&
mut
 
£lf
, 
ùx
: &
AµlyCÚ‹xt
, 
»q
: &
Reque¡
è-> 
ResuÉ
<
Re¥Ú£
> {

1090 
Ët
 
key
 = 
»q
.
g‘_d–‘e
().
g‘_key
();

1091 
check_d©a_key
(
key
, &
£lf
.
»giÚ
)?;

1093 
Ët
 
	gkey
 = 
keys
::
d©a_key
(
key
);

1095 
	g£lf
.
	gm‘rics
.
	gsize_diff_hšt
 -ğ
key
.
Ën
(è
as
 
i64
;

1096 
Ët
 
	g»¥
 = 
Re¥Ú£
::
Ãw
();

1097 !
	g»q
.
g‘_d–‘e
().
g‘_cf
().
is_em±y
() {

1098 
Ët
 
	gcf
 = 
»q
.
g‘_d–‘e
().
g‘_cf
();

1100 
	grocksdb
::
g‘_cf_hªdË
(&
£lf
.
’gše
, 
cf
)

1101 .
ªd_th’
(|
hªdË
| 
ùx
.
wb
.
d–‘e_cf
(hªdË, &
key
))

1102 .
unw¿p_Ü_–£
(|
e
| {

1103 
·nic
!("{} faedØd–‘{}: {:?}", 
£lf
.
g
, 
esÿ³
(&
key
), 
e
)

1106 
	gcf
 =ğ
CF_LOCK
 {

1108 
£lf
.
m‘rics
.
lock_cf_wr™‹n_by‹s
 +ğ
key
.
Ën
(è
as
 
u64
;

1110 
	g£lf
.
	gm‘rics
.
	gd–‘e_keys_hšt
 += 1;

1113 
	gùx
.
	gwb
.
d–‘e
(&
key
).
unw¿p_Ü_–£
(|
e
| {

1114 
·nic
!("{} faedØd–‘{}: {:?}", 
£lf
.
g
, 
esÿ³
(&
key
), 
e
)

1116 
	g£lf
.
	gm‘rics
.
	gd–‘e_keys_hšt
 += 1;

1119 
Ok
(
»¥
)

1122 
â
 
hªdË_d–‘e_¿nge
(&
mut
 
£lf
, 
»q
: &
Reque¡
, 
¿nges
: &muˆ
Vec
<
Rªge
>è-> 
ResuÉ
<
Re¥Ú£
> {

1123 
Ët
 
s_key
 = 
»q
.
g‘_d–‘e_¿nge
().
g‘_¡¬t_key
();

1124 
Ët
 
	ge_key
 = 
»q
.
g‘_d–‘e_¿nge
().
g‘_’d_key
();

1125 !
	ge_key
.
is_em±y
(è&& 
	gs_key
 >ğ
e_key
 {

1126  
E¼
(
box_”r
!(

1128 
s_key
,

1129 
e_key


1132 
check_d©a_key
(
s_key
, &
£lf
.
»giÚ
)?;

1133 
Ët
 
	g’d_key
 = 
keys
::
d©a_’d_key
(
e_key
);

1134 
Ët
 
	g»giÚ_’d_key
 = 
keys
::
d©a_’d_key
(
£lf
.
»giÚ
.
g‘_’d_key
());

1135 
	g’d_key
 > 
	g»giÚ_’d_key
 {

1136  
E¼
(
E¼Ü
::
KeyNÙInRegiÚ
(
e_key
.
to_vec
(), 
£lf
.
»giÚ
.
şÚe
()));

1139 
Ët
 
	g»¥
 = 
Re¥Ú£
::
Ãw
();

1140 
Ët
 
mut
 
	gcf
 = 
»q
.
g‘_d–‘e_¿nge
().
g‘_cf
();

1141 
	gcf
.
is_em±y
() {

1142 
	gcf
 = 
CF_DEFAULT
;

1144 
	gALL_CFS
.
™”
().
fšd
(|
x
| **x =ğ
cf
).
is_nÚe
() {

1145  
E¼
(
box_”r
!("šv®id d–‘¿ngcommªd, cf: {:?}", 
cf
));

1147 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(&
£lf
.
’gše
, 
cf
).
unw¿p
();

1149 
Ët
 
	g¡¬t_key
 = 
keys
::
d©a_key
(
s_key
);

1152 
	g£lf
.
	g’gše


1153 .
d–‘e_fe_š_¿nge_cf
(
hªdË
, &
¡¬t_key
, &
’d_key
)

1154 .
unw¿p_Ü_–£
(|
e
| {

1155 
·nic
!(

1157 
£lf
.
g
,

1158 
esÿ³
(&
¡¬t_key
),

1159 
esÿ³
(&
’d_key
),

1160 
e


1165 
	gut
::
d–‘e_®l_š_¿nge_cf
(&
£lf
.
’gše
, 
cf
, &
¡¬t_key
, &
’d_key
).
unw¿p_Ü_–£
(|
e
| {

1166 
·nic
!(

1168 
£lf
.
g
,

1169 
esÿ³
(&
¡¬t_key
),

1170 
esÿ³
(&
’d_key
),

1171 
cf
,

1172 
e


1176 
	g¿nges
.
push
(
Rªge
::
Ãw
(
cf
.
to_owÃd
(), 
¡¬t_key
, 
’d_key
));

1178 
Ok
(
»¥
)

1182 
pub
 
â
 
g‘_chªge_³”_cmd
(
msg
: &
RaáCmdReque¡
è-> 
O±iÚ
<&
ChªgeP“rReque¡
> {

1183 !
msg
.
has_admš_»que¡
() {

1184  
NÚe
;

1186 
Ët
 
	g»q
 = 
msg
.
g‘_admš_»que¡
();

1187 !
	g»q
.
has_chªge_³”
() {

1188  
	gNÚe
;

1191 
Some
(
»q
.
g‘_chªge_³”
())

1194 
â
 
check_d©a_key
(
key
: &[
u8
], 
»giÚ
: &
RegiÚ
è-> 
ResuÉ
<()> {

1196 
ut
::
check_key_š_»giÚ
(
key
, 
»giÚ
)?;

1198 
Ok
(())

1201 
pub
 
â
 
do_g‘
(
g
: &
¡r
, 
»giÚ
: &
RegiÚ
, 
¢­
: &
SÇpshÙ
, 
»q
: &
Reque¡
è-> 
ResuÉ
<
Re¥Ú£
> {

1203 
Ët
 
key
 = 
»q
.
g‘_g‘
().
g‘_key
();

1204 
check_d©a_key
(
key
, 
»giÚ
)?;

1206 
Ët
 
mut
 
	g»¥
 = 
Re¥Ú£
::
Ãw
();

1207 
Ët
 
	g»s
 = !
»q
.
g‘_g‘
().
g‘_cf
().
is_em±y
() {

1208 
Ët
 
cf
 = 
»q
.
g‘_g‘
().
g‘_cf
();

1210 
	g¢­
.
g‘_v®ue_cf
(
cf
, &
keys
::
d©a_key
(
key
)).
unw¿p_Ü_–£
(

1211 |
e
| {

1212 
·nic
!(

1214 
g
,

1215 
esÿ³
(
key
),

1216 
cf
,

1217 
e


1222 
	g¢­
.
g‘_v®ue
(&
keys
::
d©a_key
(
key
))

1223 .
unw¿p_Ü_–£
(|
e
| 
·nic
!("{} faedØg‘ {}: {:?}", 
g
, 
esÿ³
(
key
),ƒ))

1225 
Ët
 
Some
(
»s
) =„es {

1226 
»¥
.
mut_g‘
().
£t_v®ue
(
»s
.
to_vec
());

1229 
Ok
(
»¥
)

1232 
pub
 
â
 
do_¢­
(
»giÚ
: 
RegiÚ
è-> 
ResuÉ
<
Re¥Ú£
> {

1233 
Ët
 
mut
 
»¥
 = 
Re¥Ú£
::
Ãw
();

1234 
	g»¥
.
mut_¢­
().
£t_»giÚ
(
»giÚ
);

1235 
Ok
(
»¥
)

1239 
im¶
 
	gAµlyD–eg©e
 {

1240 
â
 
exec_compu‹_hash
(

1241 &
£lf
,

1242 
ùx
: &
AµlyCÚ‹xt
,

1243 
_
: &
AdmšReque¡
,

1244 è-> 
	gResuÉ
<(
	gAdmšRe¥Ú£
, 
	gO±iÚ
<
	gExecResuÉ
>)> {

1245 
Ët
 
	g»¥
 = 
AdmšRe¥Ú£
::
Ãw
();

1246 
Ok
((

1247 
»¥
,

1248 
Some
(
ExecResuÉ
::
Compu‹Hash
 {

1249 
»giÚ
: 
£lf
.»giÚ.
şÚe
(),

1250 
šdex
: 
ùx
.
exec_ùx
.
as_»f
().
unw¿p
().index,

1255 
¢­
: 
SÇpshÙ
::
Ãw
(
£lf
.
’gše
.
şÚe
()),

1260 
â
 
exec_v”ify_hash
(

1261 &
£lf
,

1262 
_
: &
AµlyCÚ‹xt
,

1263 
»q
: &
AdmšReque¡
,

1264 è-> 
	gResuÉ
<(
	gAdmšRe¥Ú£
, 
	gO±iÚ
<
	gExecResuÉ
>)> {

1265 
Ët
 
	gv”ify_»q
 = 
»q
.
g‘_v”ify_hash
();

1266 
Ët
 
	gšdex
 = 
v”ify_»q
.
g‘_šdex
();

1267 
Ët
 
	ghash
 = 
v”ify_»q
.
g‘_hash
().
to_vec
();

1268 
Ët
 
	g»¥
 = 
AdmšRe¥Ú£
::
Ãw
();

1269 
Ok
((

1270 
»¥
,

1271 
Some
(
ExecResuÉ
::
V”ifyHash
 {

1272 
šdex
: index,

1273 
hash
: hash,

1279 
pub
 
	sAµly
 {

1280 
	m»giÚ_id
: 
u64
,

1281 
	m‹rm
: 
u64
,

1282 
	m’Œ›s
: 
Vec
<
EÁry
>,

1285 
im¶
 
	gAµly
 {

1286 
pub
 
â
 
Ãw
(
»giÚ_id
: 
u64
, 
‹rm
: u64, 
’Œ›s
: 
Vec
<
EÁry
>è-> 
Aµly
 {

1287 
Aµly
 {

1288 
»giÚ_id
:„egion_id,

1289 
	g‹rm
: 
‹rm
,

1290 
	g’Œ›s
: 
’Œ›s
,

1295 #[
d”ive
(
DeçuÉ
, 
ClÚe
)]

1296 
pub
 
	sRegi¡¿tiÚ
 {

1297 
pub
 
	mid
: 
u64
,

1298 
pub
 
	m‹rm
: 
u64
,

1299 
pub
 
	m­¶y_¡©e
: 
RaáAµlyS‹
,

1300 
pub
 
	m­¶›d_šdex_‹rm
: 
u64
,

1301 
pub
 
	m»giÚ
: 
RegiÚ
,

1304 
im¶
 
	gRegi¡¿tiÚ
 {

1305 
pub
 
â
 
Ãw
(
³”
: &
P“r
è-> 
Regi¡¿tiÚ
 {

1306 
Regi¡¿tiÚ
 {

1307 
id
: 
³”
.
³”_id
(),

1308 
	g‹rm
: 
³”
.
‹rm
(),

1309 
	g­¶y_¡©e
: 
³”
.
g‘_¡Üe
().
­¶y_¡©e
.
şÚe
(),

1310 
	g­¶›d_šdex_‹rm
: 
³”
.
g‘_¡Üe
().
­¶›d_šdex_‹rm
,

1311 
	g»giÚ
: 
³”
.
»giÚ
().
şÚe
(),

1316 
pub
 
	sPrİo§l
 {

1317 
	mis_cÚf_chªge
: 
boŞ
,

1318 
	mšdex
: 
u64
,

1319 
	m‹rm
: 
u64
,

1320 
pub
 
	mcb
: 
C®lback
,

1323 
im¶
 
	gPrİo§l
 {

1324 
pub
 
â
 
Ãw
(
is_cÚf_chªge
: 
boŞ
, 
šdex
: 
u64
, 
‹rm
: u64, 
cb
: 
C®lback
è-> 
Prİo§l
 {

1325 
Prİo§l
 {

1326 
is_cÚf_chªge
: is_conf_change,

1327 
	gšdex
: 
šdex
,

1328 
	g‹rm
: 
‹rm
,

1329 
	gcb
: 
cb
,

1334 
pub
 
	sRegiÚPrİo§l
 {

1335 
	mid
: 
u64
,

1336 
	m»giÚ_id
: 
u64
,

1337 
	m´İs
: 
Vec
<
Prİo§l
>,

1340 
im¶
 
	gRegiÚPrİo§l
 {

1341 
pub
 
â
 
Ãw
(
id
: 
u64
, 
»giÚ_id
: u64, 
´İs
: 
Vec
<
Prİo§l
>è-> 
RegiÚPrİo§l
 {

1342 
RegiÚPrİo§l
 {

1343 
id
: id,

1344 
	g»giÚ_id
: 
»giÚ_id
,

1345 
	g´İs
: 
´İs
,

1350 
pub
 
	sDe¡roy
 {

1351 
	m»giÚ_id
: 
u64
,

1355 
pub
 
	eTask
 {

1356 
Aµl›s
(
Vec
<
Aµly
>),

1357 
Regi¡¿tiÚ
(Registration),

1358 
Prİo§ls
(
Vec
<
RegiÚPrİo§l
>),

1359 
De¡roy
(Destroy),

1362 
im¶
 
	gTask
 {

1363 
pub
 
â
 
­¶›s
×µl›s: 
Vec
<
Aµly
>è-> 
Task
 {

1364 
Task
::
Aµl›s
(
­¶›s
)

1367 
pub
 
â
 (
³”
: &
P“r
è-> 
Task
 {

1368 
Task
::
Regi¡¿tiÚ
(Regi¡¿tiÚ::
Ãw
(
³”
))

1371 
pub
 
â
 
de¡roy
(
»giÚ_id
: 
u64
è-> 
Task
 {

1372 
Task
::
De¡roy
(Destroy {

1373 
»giÚ_id
:„egion_id,

1378 
im¶
 
Di¥Ïy
 
	gTask
 {

1379 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

1380 
m©ch
 *
£lf
 {

1381 
Task
::
Aµl›s
(
»f
 
a
è=> 
wr™e
!(
f
, "asynø­¶y couÁ {}", 
	ga
.
Ën
()),

1382 
	gTask
::
Prİo§ls
(
»f
 
p
è=> 
wr™e
!(
f
, "»giÚ…rİo§ÈcouÁ {}", 
	gp
.
Ën
()),

1383 
	gTask
::
Regi¡¿tiÚ
(
»f
 
r
) => {

1384 
wr™e
!(
f
, "[»giÚ {}] Reg {:?}", 
r
.
»giÚ
.
g‘_id
(),„.
­¶y_¡©e
)

1386 
Task
::
De¡roy
(
»f
 
d
è=> 
wr™e
!(
f
, "[»giÚ {}] de¡roy", 
	gd
.
	g»giÚ_id
),

1391 #[
d”ive
(
DeçuÉ
, 
ClÚe
, 
Debug
, 
P¬tŸlEq
)]

1392 
pub
 
	sAµlyM‘rics
 {

1394 
pub
 
	msize_diff_hšt
: 
i64
,

1396 
pub
 
	md–‘e_keys_hšt
: 
u64
,

1398 
pub
 
	mwr™‹n_by‹s
: 
u64
,

1399 
pub
 
	mwr™‹n_keys
: 
u64
,

1400 
pub
 
	mlock_cf_wr™‹n_by‹s
: 
u64
,

1403 #[
d”ive
(
Debug
)]

1404 
pub
 
	sAµlyRes
 {

1405 
pub
 
	m»giÚ_id
: 
u64
,

1406 
pub
 
	m­¶y_¡©e
: 
RaáAµlyS‹
,

1407 
pub
 
	m­¶›d_šdex_‹rm
: 
u64
,

1408 
pub
 
	mexec_»s
: 
Vec
<
ExecResuÉ
>,

1409 
pub
 
	mm‘rics
: 
AµlyM‘rics
,

1412 #[
d”ive
(
Debug
)]

1413 
pub
 
	eTaskRes
 {

1414 
Aµlys
(
Vec
<
AµlyRes
>),

1415 
De¡roy
(
AµlyD–eg©e
),

1419 
pub
 
	sRuÂ”
 {

1420 
	mdb
: 
Arc
<
DB
>,

1421 
	mho¡
: 
Arc
<
CİroûssÜHo¡
>,

1422 
	md–eg©es
: 
HashM­
<
u64
, 
	mAµlyD–eg©e
>,

1423 
	mnÙif›r
: 
S’d”
<
TaskRes
>,

1424 
	msync_log
: 
boŞ
,

1425 
	mg
: 
SŒšg
,

1428 
im¶
 
	gRuÂ”
 {

1429 
pub
 
â
 
	gÃw
<
	gT
, 
	gC
>(
	g¡Üe
: &
StÜe
<
T
, C>, 
	gnÙif›r
: 
S’d”
<
TaskRes
>, 
	gsync_log
: 
boŞ
è-> 
RuÂ”
 {

1430 
Ët
 
mut
 
d–eg©es
 =

1431 
HashM­
::
w™h_ÿ·c™y_ªd_hash”
(
¡Üe
.
g‘_³”s
().
Ën
(), 
DeçuÉ
::());

1432 &
	g»giÚ_id
, 
	gp
è
š
 
	g¡Üe
.
g‘_³”s
() {

1433 
	gd–eg©es
.
š£¹
(
»giÚ_id
, 
AµlyD–eg©e
::
äom_³”
(
p
));

1435 
	gRuÂ”
 {

1436 
	gdb
: 
¡Üe
.
kv_’gše
(),

1437 
	gho¡
: 
¡Üe
.
cİroûssÜ_ho¡
.
şÚe
(),

1438 
	gd–eg©es
: 
d–eg©es
,

1439 
	gnÙif›r
: 
nÙif›r
,

1440 
	gsync_log
: 
sync_log
,

1441 
	gg
: 
fÜm©
!("[¡Ü{}]", 
	g¡Üe
.
¡Üe_id
()),

1445 
â
 
hªdË_­¶›s
(&
mut
 
£lf
, 
­¶ys
: 
Vec
<
Aµly
>) {

1446 
Ët
 
t
 = 
SlowTim”
::
Ãw
();

1448 
Ët
 
mut
 
	g­¶ys_»s
 = 
Vec
::
w™h_ÿ·c™y
(
­¶ys
.
Ën
());

1449 
Ët
 
mut
 
	g­¶y_ùx
 = 
AµlyCÚ‹xt
::
Ãw
(
£lf
.
ho¡
.
as_»f
());

1450 
Ët
 
mut
 
	gcomm™‹d_couÁ
 = 0;

1451 
­¶y
 
š
 
	g­¶ys
 {

1452 
	g­¶y
.
	g’Œ›s
.
is_em±y
() {

1455 
Ët
 
mut
 
	ge
 = 
m©ch
 
£lf
.
d–eg©es
.
’Œy
(
­¶y
.
»giÚ_id
) {

1456 
M­EÁry
::
VaÿÁ
(
_
) => {

1457 
”rÜ
!("[»giÚ {}] i missšg", 
­¶y
.
»giÚ_id
);

1460 
	gM­EÁry
::
Occup›d
(
e
) =>ƒ,

1463 
Ët
 
	gd–eg©e
 = 
e
.
g‘_mut
();

1464 
	gd–eg©e
.
	gm‘rics
 = 
AµlyM‘rics
::();

1465 
	gd–eg©e
.
	g‹rm
 = 
­¶y
.
‹rm
;

1466 
	gcomm™‹d_couÁ
 +ğ
­¶y
.
’Œ›s
.
Ën
();

1467 
Ët
 
	g»suÉs
 = 
d–eg©e
.
hªdË_¿á_comm™‹d_’Œ›s
(&
mut
 
­¶y_ùx
, 
­¶y
.
’Œ›s
);

1469 
	gd–eg©e
.
	g³ndšg_»move
 {

1470 
	gd–eg©e
.
de¡roy
();

1473 
	g­¶ys_»s
.
push
(
AµlyRes
 {

1474 
»giÚ_id
: 
­¶y
.region_id,

1475 
­¶y_¡©e
: 
d–eg©e
.­¶y_¡©e.
şÚe
(),

1476 
exec_»s
: 
»suÉs
,

1477 
m‘rics
: 
d–eg©e
.m‘rics.
şÚe
(),

1478 
­¶›d_šdex_‹rm
: 
d–eg©e
.applied_index_term,

1481 
	ge
.
g‘
().
	g³ndšg_»move
 {

1482 
	ge
.
»move
();

1491 
Ët
 
mut
 
	gwr™e_İts
 = 
Wr™eO±iÚs
::
Ãw
();

1492 
	gwr™e_İts
.
£t_sync
(
£lf
.
sync_log
 && 
­¶y_ùx
.sync_log);

1493 !
	g­¶y_ùx
.
	gwb
.
is_em±y
() {

1494 
	g£lf
.
	gdb


1495 .
wr™e_İt
(
­¶y_ùx
.
wb
, &
wr™e_İts
)

1496 .
unw¿p_Ü_–£
(|
e
| 
·nic
!("failedo writeoƒngine,ƒrror: {:?}",ƒ));

1500 
	gcb
, 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

1501 
cb
(
»¥
);

1504 !
	g­¶ys_»s
.
is_em±y
() {

1505 
	g£lf
.
	gnÙif›r
.
£nd
(
TaskRes
::
Aµlys
(
­¶ys_»s
)).
unw¿p
();

1508 
	gSTORE_APPLY_LOG_HISTOGRAM
.
ob£rve
(
du¿tiÚ_to_£c
(
t
.
–­£d
()è
as
 
f64
);

1510 
	g¦ow_log
!(

1511 
	gt
,

1513 
	g£lf
.
	gg
,

1514 
	gcomm™‹d_couÁ


1518 
â
 
hªdË_´İo§ls
(&
mut
 
£lf
, 
´İo§ls
: 
Vec
<
RegiÚPrİo§l
>) {

1519 
Ët
 
mut
 
´İo£_num
 = 0;

1520 
»giÚ_´İo§l
 
š
 
	g´İo§ls
 {

1521 
	g´İo£_num
 +ğ
»giÚ_´İo§l
.
´İs
.
Ën
();

1522 
Ët
 
	gd–eg©e
 = 
m©ch
 
£lf
.
d–eg©es
.
g‘_mut
(&
»giÚ_´İo§l
.
»giÚ_id
) {

1523 
Some
(
d
) => d,

1524 
	gNÚe
 => {

1525 
p
 
š
 
»giÚ_´İo§l
.
´İs
 {

1526 
Ët
 
cmd
 = 
P’dšgCmd
::
Ãw
(
p
.
šdex
,….
‹rm
,….
cb
);

1527 
nÙify_»giÚ_»moved
(
»giÚ_´İo§l
.
»giÚ_id
,„egiÚ_´İo§l.
id
, 
cmd
);

1532 
	gas£¹_eq
!(
	gd–eg©e
.
	gid
, 
	g»giÚ_´İo§l
.id);

1533 
p
 
š
 
	g»giÚ_´İo§l
.
	g´İs
 {

1534 
Ët
 
	gcmd
 = 
P’dšgCmd
::
Ãw
(
p
.
šdex
,….
‹rm
,….
cb
);

1535 
	gp
.
	gis_cÚf_chªge
 {

1536 
Ët
 
Some
(
cmd
èğ
d–eg©e
.
³ndšg_cmds
.
ke_cÚf_chªge
() {

1541 
nÙify_¡®e_commªd
(&
d–eg©e
.
g
, d–eg©e.
‹rm
, 
cmd
);

1543 
	gd–eg©e
.
	g³ndšg_cmds
.
£t_cÚf_chªge
(
cmd
);

1545 
	gd–eg©e
.
	g³ndšg_cmds
.
­³nd_nÜm®
(
cmd
);

1549 
	gAPPLY_PROPOSAL
.
ob£rve
(
´İo£_num
 
as
 
f64
);

1552 
â
 
hªdË_»gi¡¿tiÚ
(&
mut
 
£lf
, 
s
: 
Regi¡¿tiÚ
) {

1553 
Ët
 
³”_id
 = 
s
.
id
;

1554 
Ët
 
	g»giÚ_id
 = 
s
.
»giÚ
.
g‘_id
();

1555 
Ët
 
	g‹rm
 = 
s
.
‹rm
;

1556 
Ët
 
	gd–eg©e
 = 
AµlyD–eg©e
::
äom_»gi¡¿tiÚ
(
£lf
.
db
.
şÚe
(), 
s
);

1557 
	gšfo
!(

1559 
	gd–eg©e
.
	gg
,

1560 
	gd–eg©e
.
	g‹rm


1562 
Ët
 
Some
(
mut
 
Şd_d–eg©e
èğ
£lf
.
d–eg©es
.
š£¹
(
»giÚ_id
, 
d–eg©e
) {

1563 
	gas£¹_eq
!(
	gŞd_d–eg©e
.
	gid
, 
	g³”_id
);

1564 
	gŞd_d–eg©e
.
	g‹rm
 = 
‹rm
;

1565 
	gŞd_d–eg©e
.
ş—r_®l_commªds_as_¡®e
();

1569 
â
 
hªdË_de¡roy
(&
mut
 
£lf
, 
d
: 
De¡roy
) {

1572 
Ët
 
Some
(
mut
 
m‘a
èğ
£lf
.
d–eg©es
.
»move
(&
d
.
»giÚ_id
) {

1573 
šfo
!("{}„emoväom‡µly d–eg©es", 
m‘a
.
g
);

1574 
	gm‘a
.
de¡roy
();

1575 
	g£lf
.
	gnÙif›r
.
£nd
(
TaskRes
::
De¡roy
(
m‘a
)).
unw¿p
();

1579 
â
 
hªdË_shutdown
(&
mut
 
£lf
) {

1580 
p
 
š
 
	g£lf
.
	gd–eg©es
.
v®ues_mut
() {

1581 
	gp
.
ş—r_³ndšg_commªds
();

1586 
im¶
 
	gRuÂabË
<
	gTask
> 
	gRuÂ”
 {

1587 
â
 
run
(&
mut
 
£lf
, 
sk
: 
Task
) {

1588 
m©ch
 
sk
 {

1589 
Task
::
Aµl›s
(
a
è=> 
£lf
.
hªdË_­¶›s
(a),

1590 
	gTask
::
Prİo§ls
(
´İs
è=> 
£lf
.
hªdË_´İo§ls
(props),

1591 
	gTask
::
Regi¡¿tiÚ
(
s
è=> 
£lf
.
hªdË_»gi¡¿tiÚ
(s),

1592 
	gTask
::
De¡roy
(
d
è=> 
£lf
.
hªdË_de¡roy
(d),

1596 
â
 
shutdown
(&
mut
 
£lf
) {

1597 
	g£lf
.
hªdË_shutdown
();

1601 #[
cfg
(
‹¡
)]

1602 
mod
 
	g‹¡s
 {

1603 
u£
 
	g¡d
::
sync
::*;

1605 
u£
 
	g‹mpdœ
::
TempDœ
;

1606 
u£
 
	grocksdb
::{
Wr™abË
, 
	gWr™eB©ch
, 
	gDB
};

1607 
u£
 
	g´Ùobuf
::
Mes§ge
;

1608 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚEpoch
;

1609 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::
CmdTy³
;

1611 
u£
 
	gsu³r
::*;

1612 
u£
 
	g¡Üage
::{
ALL_CFS
, 
	gCF_WRITE
};

1613 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

1615 
pub
 
â
 
ü—‹_tmp_’gše
(
·th
: &
¡r
è-> (
TempDœ
, 
	gArc
<
	gDB
>) {

1616 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
(
·th
).
unw¿p
();

1617 
Ët
 
	gdb
 = 
Arc
::
Ãw
(

1618 
rocksdb
::
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), 
ALL_CFS
).unwrap(),

1620 (
	g·th
, 
	gdb
)

1623 
â
 
Ãw_ruÂ”
(
db
: 
Arc
<
DB
>, 
ho¡
: Arc<
CİroûssÜHo¡
>, 
tx
: 
S’d”
<
TaskRes
>è-> 
RuÂ”
 {

1624 
RuÂ”
 {

1625 
db
: db,

1626 
	gho¡
: 
ho¡
,

1627 
	gd–eg©es
: 
HashM­
::(),

1628 
	gnÙif›r
: 
tx
,

1629 
	gsync_log
: 
çl£
,

1630 
	gg
: "".
to_owÃd
(),

1634 
pub
 
â
 
Ãw_’Œy
(
‹rm
: 
u64
, 
šdex
: u64, 
»q
: 
O±iÚ
<
RaáCmdReque¡
>è-> 
EÁry
 {

1635 
Ët
 
mut
 
e
 = 
EÁry
::
Ãw
();

1636 
	ge
.
£t_šdex
(
šdex
);

1637 
	ge
.
£t_‹rm
(
‹rm
);

1638 
	g»q
.
m­
(|
r
| 
e
.
£t_d©a
Ô.
wr™e_to_by‹s
().
unw¿p
()));

1639 
	ge


1642 #[
‹¡
]

1643 
â
 
‹¡_should_æush_to_’gše
() {

1645 
Ët
 
mut
 
	g»q
 = 
RaáCmdReque¡
::
Ãw
();

1646 
	g»q
.
mut_admš_»que¡
()

1647 .
£t_cmd_ty³
(
AdmšCmdTy³
::
Compu‹Hash
);

1648 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

1649 
	gas£¹_eq
!(
should_æush_to_’gše
(&
»q
, 
wb
.
couÁ
()), 
	gŒue
);

1652 
Ët
 
	g»q
 = 
RaáCmdReque¡
::
Ãw
();

1653 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

1654 
i
 
	gš
 0..
	gWRITE_BATCH_MAX_KEYS
 {

1655 
Ët
 
	gkey
 = 
fÜm©
!("key_{}", 
	gi
);

1656 
	gwb
.
put
(
key
.
as_by‹s
(), 
b
"v®ue").
unw¿p
();

1658 
	gas£¹_eq
!(
should_æush_to_’gše
(&
»q
, 
wb
.
couÁ
()), 
	gŒue
);

1661 
Ët
 
	g»q
 = 
RaáCmdReque¡
::
Ãw
();

1662 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

1663 
i
 
	gš
 0..
	gWRITE_BATCH_MAX_KEYS
 - 1 {

1664 
Ët
 
	gkey
 = 
fÜm©
!("key_{}", 
	gi
);

1665 
	gwb
.
put
(
key
.
as_by‹s
(), 
b
"v®ue").
unw¿p
();

1667 
	gas£¹_eq
!(
should_æush_to_’gše
(&
»q
, 
wb
.
couÁ
()), 
	gçl£
);

1670 #[
‹¡
]

1671 
â
 
‹¡_basic_æow
() {

1672 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

1673 
Ët
 (
_tmp
, 
db
èğ
ü—‹_tmp_’gše
("apply-basic");

1674 
Ët
 
	gho¡
 = 
Arc
::
Ãw
(
CİroûssÜHo¡
::());

1675 
Ët
 
mut
 
	gruÂ”
 = 
Ãw_ruÂ”
(
db
.
şÚe
(), 
ho¡
, 
tx
);

1677 
Ët
 
mut
 
	g»g
 = 
Regi¡¿tiÚ
::();

1678 
	g»g
.
	gid
 = 1;

1679 
	g»g
.
	g»giÚ
.
£t_id
(2);

1680 
	g»g
.
	g­¶y_¡©e
.
£t_­¶›d_šdex
(3);

1681 
	g»g
.
	g‹rm
 = 4;

1682 
	g»g
.
	g­¶›d_šdex_‹rm
 = 5;

1683 
	gruÂ”
.
run
(
Task
::
Regi¡¿tiÚ
(
»g
.
şÚe
()));

1684 
	gas£¹
!(
	gruÂ”
.
	gd–eg©es
.
g‘
(&2).
is_some
());

1686 
Ët
 
	gd–eg©e
 = &
ruÂ”
.
d–eg©es
[&2];

1687 
	gas£¹_eq
!(
	gd–eg©e
.
	gid
, 1);

1688 
	gas£¹_eq
!(
	gd–eg©e
.
	gg
, "[region 2] 1");

1689 
	gas£¹_eq
!(
	gd–eg©e
.
	g»giÚ
, 
	g»g
.region);

1690 
	gas£¹
!(!
	gd–eg©e
.
	g³ndšg_»move
);

1691 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶y_¡©e
, 
	g»g
.apply_state);

1692 
	gas£¹_eq
!(
	gd–eg©e
.
	g‹rm
, 
	g»g
.term);

1693 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶›d_šdex_‹rm
, 
	g»g
.applied_index_term);

1696 
Ët
 (
»¥_tx
, 
»¥_rx
èğ
mpsc
::
chªÃl
();

1697 
Ët
 
	gp
 = 
Prİo§l
::
Ãw
(

1698 
çl£
,

1701 
box
 
move
 |
»¥
| { 
»¥_tx
.
£nd
Ôe¥).
unw¿p
(); },

1703 
Ët
 
	g»giÚ_´İo§l
 = 
RegiÚPrİo§l
::
Ãw
(1, 1, 
vec
![
p
]);

1704 
	gruÂ”
.
run
(
Task
::
Prİo§ls
(
vec
![
»giÚ_´İo§l
]));

1706 
	gas£¹
!(
	grx
.
Œy_»cv
().
is_”r
());

1707 
Ët
 
	g»¥
 = 
»¥_rx
.
Œy_»cv
().
unw¿p
();

1708 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_»giÚ_nÙ_found
());

1710 
Ët
 (
cc_tx
, 
cc_rx
èğ
mpsc
::
chªÃl
();

1711 
Ët
 
	gpİs
 = 
vec
![

1712 
Prİo§l
::
Ãw
(
çl£
, 2, 0, 
box
 |
_
| {}),

1713 
Prİo§l
::
Ãw
(
Œue
, 3, 0, 
box
 
move
 |
»¥
| { 
cc_tx
.
£nd
Ôe¥).
unw¿p
(); }),

1715 
Ët
 
	g»giÚ_´İo§l
 = 
RegiÚPrİo§l
::
Ãw
(1, 2, 
pİs
);

1716 
	gruÂ”
.
run
(
Task
::
Prİo§ls
(
vec
![
»giÚ_´İo§l
]));

1717 
	gas£¹
!(
	grx
.
Œy_»cv
().
is_”r
());

1719 
Ët
 
	gnÜm®s
 = &
ruÂ”
.
d–eg©es
[&2].
³ndšg_cmds
.
nÜm®s
;

1720 
	gas£¹_eq
!(
	gnÜm®s
.
back
().
m­
(|
c
| c.
šdex
), 
Some
(2));

1722 
	gas£¹
!(
	grx
.
Œy_»cv
().
is_”r
());

1724 
Ët
 
	gcc
 = &
ruÂ”
.
d–eg©es
[&2].
³ndšg_cmds
.
cÚf_chªge
;

1725 
	gas£¹_eq
!(
	gcc
.
as_»f
().
m­
(|
c
| c.
šdex
), 
Some
(3));

1728 
Ët
 
	gp
 = 
Prİo§l
::
Ãw
(
Œue
, 4, 0, 
box
 
move
 |
_
| {});

1729 
Ët
 
	g»giÚ_´İo§l
 = 
RegiÚPrİo§l
::
Ãw
(1, 2, 
vec
![
p
]);

1730 
	gruÂ”
.
run
(
Task
::
Prİo§ls
(
vec
![
»giÚ_´İo§l
]));

1731 
	gas£¹
!(
	grx
.
Œy_»cv
().
is_”r
());

1733 
Ët
 
	gcc
 = &
ruÂ”
.
d–eg©es
[&2].
³ndšg_cmds
.
cÚf_chªge
;

1734 
	gas£¹_eq
!(
	gcc
.
as_»f
().
m­
(|
c
| c.
šdex
), 
Some
(4));

1737 
Ët
 
	gcc_»¥
 = 
cc_rx
.
Œy_»cv
().
unw¿p
();

1738 
	gas£¹
!(
	gcc_»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_¡®e_commªd
());

1740 
	gruÂ”
.
run
(
Task
::
­¶›s
(

1741 
vec
![
Aµly
::
Ãw
(1, 1, vec![
Ãw_’Œy
(2, 3, 
NÚe
)])],

1744 
	gas£¹
!(
	grx
.
Œy_»cv
().
is_”r
());

1746 
	gruÂ”
.
run
(
Task
::
­¶›s
(
vec
![
Aµly
::
Ãw
(2, 11, vec![])]));

1748 
	gas£¹
!(
	grx
.
Œy_»cv
().
is_”r
());

1749 
	gas£¹_eq
!(
	gruÂ”
.
	gd–eg©es
[&2].
	g‹rm
, 
	g»g
.term);

1751 
Ët
 
	g­¶y_¡©e_key
 = 
keys
::
­¶y_¡©e_key
(2);

1752 
	gas£¹
!(
	gdb
.
g‘
(&
­¶y_¡©e_key
).
unw¿p
().
is_nÚe
());

1753 
	gruÂ”
.
run
(
Task
::
­¶›s
(

1754 
vec
![
Aµly
::
Ãw
(2, 11, vec![
Ãw_’Œy
(5, 4, 
NÚe
)])],

1756 
Ët
 
	g»s
 = 
m©ch
 
rx
.
Œy_»cv
() {

1757 
Ok
(
TaskRes
::
Aµlys
(
»s
)) =>„es,

1758 
	ge
 => 
·nic
!("unexpected‡pply„esult: {:?}",ƒ),

1760 
	gas£¹_eq
!(
	g»s
.
Ën
(), 1);

1761 
Ët
 
	g­¶y_»s
 = &
»s
[0];

1762 
	gas£¹_eq
!(
	g­¶y_»s
.
	g»giÚ_id
, 2);

1763 
	gas£¹_eq
!(
	g­¶y_»s
.
	g­¶y_¡©e
.
g‘_­¶›d_šdex
(), 4);

1764 
	gas£¹
!(
	g­¶y_»s
.
	gexec_»s
.
is_em±y
());

1766 
	gas£¹_eq
!(
	g­¶y_»s
.
	gm‘rics
.
	gwr™‹n_keys
, 1);

1767 
	gas£¹_eq
!(
	g­¶y_»s
.
	g­¶›d_šdex_‹rm
, 5);

1769 
Ët
 
	gd–eg©e
 = &
ruÂ”
.
d–eg©es
[&2];

1770 
	gas£¹_eq
!(
	gd–eg©e
.
	g‹rm
, 11);

1771 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶›d_šdex_‹rm
, 5);

1772 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶y_¡©e
.
g‘_­¶›d_šdex
(), 4);

1773 
Ët
 
	g­¶y_¡©e
: 
RaáAµlyS‹
 =

1774 
db
.
g‘_msg_cf
(
CF_RAFT
, &
­¶y_¡©e_key
).
unw¿p
().unwrap();

1775 
	gas£¹_eq
!(
	g­¶y_¡©e
, 
	gd–eg©e
.apply_state);

1778 
	gruÂ”
.
run
(
Task
::
de¡roy
(2));

1779 
Ët
 
	gde¡roy_»s
 = 
m©ch
 
rx
.
Œy_»cv
() {

1780 
Ok
(
TaskRes
::
De¡roy
(
d
)) => d,

1781 
	ge
 => 
·nic
!("expected destroy„esult, but got {:?}",ƒ),

1783 
	gas£¹_eq
!(
	gde¡roy_»s
.
	gid
, 1);

1784 
	gas£¹_eq
!(
	gde¡roy_»s
.
	g­¶›d_šdex_‹rm
, 5);

1786 
	gruÂ”
.
shutdown
();

1789 
	sEÁryBud”
 {

1790 
	g’Œy
: 
EÁry
,

1791 
	g»q
: 
RaáCmdReque¡
,

1794 
im¶
 
	gEÁryBud”
 {

1795 
â
 
Ãw
(
šdex
: 
u64
, 
‹rm
: u64è-> 
EÁryBud”
 {

1796 
Ët
 
»q
 = 
RaáCmdReque¡
::
Ãw
();

1797 
Ët
 
mut
 
	g’Œy
 = 
EÁry
::
Ãw
();

1798 
	g’Œy
.
£t_šdex
(
šdex
);

1799 
	g’Œy
.
£t_‹rm
(
‹rm
);

1800 
	gEÁryBud”
 {

1801 
	g’Œy
: 
’Œy
,

1802 
	g»q
: 
»q
,

1806 
â
 
ÿ±u»_»¥
(

1807 
£lf
,

1808 
d–eg©e
: &
mut
 
AµlyD–eg©e
,

1809 
tx
: 
S’d”
<
RaáCmdRe¥Ú£
>,

1810 è-> 
	gEÁryBud”
 {

1811 
Ët
 
	gcmd
 = 
P’dšgCmd
::
Ãw
(

1812 
£lf
.
’Œy
.
g‘_šdex
(),

1813 
£lf
.
’Œy
.
g‘_‹rm
(),

1814 
box
 
move
 |
r
| 
tx
.
£nd
Ô).
unw¿p
(),

1816 
	gd–eg©e
.
	g³ndšg_cmds
.
­³nd_nÜm®
(
cmd
);

1817 
	g£lf


1820 
â
 
•och
(
mut
 
£lf
, 
cÚf_v”
: 
u64
, 
v”siÚ
: u64è-> 
EÁryBud”
 {

1821 
Ët
 
mut
 
•och
 = 
RegiÚEpoch
::
Ãw
();

1822 
	g•och
.
£t_v”siÚ
(
v”siÚ
);

1823 
	g•och
.
£t_cÚf_v”
(
cÚf_v”
);

1824 
	g£lf
.
	g»q
.
mut_h—d”
().
£t_»giÚ_•och
(
•och
);

1825 
	g£lf


1828 
â
 
put
(
£lf
, 
key
: &[
u8
], 
v®ue
: &[u8]è-> 
EÁryBud”
 {

1829 
£lf
.
add_put_»q
(
NÚe
, 
key
, 
v®ue
)

1832 
â
 
put_cf
(
£lf
, 
cf
: &
¡r
, 
key
: &[
u8
], 
v®ue
: &[u8]è-> 
EÁryBud”
 {

1833 
£lf
.
add_put_»q
(
Some
(
cf
), 
key
, 
v®ue
)

1836 
â
 
add_put_»q
(
mut
 
£lf
, 
cf
: 
O±iÚ
<&
¡r
>, 
key
: &[
u8
], 
v®ue
: &[u8]è-> 
EÁryBud”
 {

1837 
Ët
 
mut
 
cmd
 = 
Reque¡
::
Ãw
();

1838 
	gcmd
.
£t_cmd_ty³
(
CmdTy³
::
Put
);

1839 
Ët
 
Some
(
cf
) = cf {

1840 
cmd
.
mut_put
().
£t_cf
(
cf
.
to_owÃd
());

1842 
	gcmd
.
mut_put
().
£t_key
(
key
.
to_vec
());

1843 
	gcmd
.
mut_put
().
£t_v®ue
(
v®ue
.
to_vec
());

1844 
	g£lf
.
	g»q
.
mut_»que¡s
().
push
(
cmd
);

1845 
	g£lf


1848 
â
 
d–‘e
(
£lf
, 
key
: &[
u8
]è-> 
EÁryBud”
 {

1849 
£lf
.
add_d–‘e_»q
(
NÚe
, 
key
)

1852 
â
 
d–‘e_cf
(
£lf
, 
cf
: &
¡r
, 
key
: &[
u8
]è-> 
EÁryBud”
 {

1853 
£lf
.
add_d–‘e_»q
(
Some
(
cf
), 
key
)

1856 
â
 
d–‘e_¿nge
(
£lf
, 
¡¬t_key
: &[
u8
], 
’d_key
: &[u8]è-> 
EÁryBud”
 {

1857 
£lf
.
add_d–‘e_¿nge_»q
(
NÚe
, 
¡¬t_key
, 
’d_key
)

1860 
â
 
d–‘e_¿nge_cf
(
£lf
, 
cf
: &
¡r
, 
¡¬t_key
: &[
u8
], 
’d_key
: &[u8]è-> 
EÁryBud”
 {

1861 
£lf
.
add_d–‘e_¿nge_»q
(
Some
(
cf
), 
¡¬t_key
, 
’d_key
)

1864 
â
 
add_d–‘e_»q
(
mut
 
£lf
, 
cf
: 
O±iÚ
<&
¡r
>, 
key
: &[
u8
]è-> 
EÁryBud”
 {

1865 
Ët
 
mut
 
cmd
 = 
Reque¡
::
Ãw
();

1866 
	gcmd
.
£t_cmd_ty³
(
CmdTy³
::
D–‘e
);

1867 
Ët
 
Some
(
cf
) = cf {

1868 
cmd
.
mut_d–‘e
().
£t_cf
(
cf
.
to_owÃd
());

1870 
	gcmd
.
mut_d–‘e
().
£t_key
(
key
.
to_vec
());

1871 
	g£lf
.
	g»q
.
mut_»que¡s
().
push
(
cmd
);

1872 
	g£lf


1875 
â
 
add_d–‘e_¿nge_»q
(

1876 
mut
 
£lf
,

1877 
cf
: 
O±iÚ
<&
¡r
>,

1878 
¡¬t_key
: &[
u8
],

1879 
’d_key
: &[
u8
],

1880 è-> 
	gEÁryBud”
 {

1881 
Ët
 
mut
 
	gcmd
 = 
Reque¡
::
Ãw
();

1882 
	gcmd
.
£t_cmd_ty³
(
CmdTy³
::
D–‘eRªge
);

1883 
Ët
 
Some
(
cf
) = cf {

1884 
cmd
.
mut_d–‘e_¿nge
().
£t_cf
(
cf
.
to_owÃd
());

1886 
	gcmd
.
mut_d–‘e_¿nge
().
£t_¡¬t_key
(
¡¬t_key
.
to_vec
());

1887 
	gcmd
.
mut_d–‘e_¿nge
().
£t_’d_key
(
’d_key
.
to_vec
());

1888 
	g£lf
.
	g»q
.
mut_»que¡s
().
push
(
cmd
);

1889 
	g£lf


1892 
â
 
bud
(
mut
 
£lf
è-> 
	gEÁry
 {

1893 
	g£lf
.
	g’Œy
.
£t_d©a
(
£lf
.
»q
.
wr™e_to_by‹s
().
unw¿p
());

1894 
	g£lf
.
	g’Œy


1898 #[
‹¡
]

1899 
â
 
‹¡_hªdË_¿á_comm™‹d_’Œ›s
() {

1900 
Ët
 (
_·th
, 
db
èğ
ü—‹_tmp_’gše
("test-delegate");

1901 
Ët
 
mut
 
	g»g
 = 
Regi¡¿tiÚ
::();

1902 
	g»g
.
	g»giÚ
.
£t_’d_key
(
b
"k5".
to_vec
());

1903 
	g»g
.
	g»giÚ
.
mut_»giÚ_•och
().
£t_v”siÚ
(3);

1904 
Ët
 
mut
 
	gd–eg©e
 = 
AµlyD–eg©e
::
äom_»gi¡¿tiÚ
(
db
.
şÚe
(), 
»g
);

1905 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

1907 
Ët
 
	gput_’Œy
 = 
EÁryBud”
::
Ãw
(1, 1)

1908 .
put
(
b
"k1", b"v1")

1909 .
put
(
b
"k2", b"v1")

1910 .
put
(
b
"k3", b"v1")

1911 .
•och
(1, 3)

1912 .
ÿ±u»_»¥
(&
mut
 
d–eg©e
, 
tx
.
şÚe
())

1913 .
bud
();

1914 
Ët
 
	gho¡
 = 
CİroûssÜHo¡
::();

1915 
Ët
 
mut
 
	g­¶y_ùx
 = 
AµlyCÚ‹xt
::
Ãw
(&
ho¡
);

1916 
Ët
 
	g»s
 = 
d–eg©e
.
hªdË_¿á_comm™‹d_’Œ›s
(&
mut
 
­¶y_ùx
, 
vec
![
put_’Œy
]);

1917 
	gdb
.
wr™e
(
­¶y_ùx
.
wb
).
unw¿p
();

1918 
	gcb
, 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

1919 
cb
(
»¥
);

1921 
	gas£¹
!(
	g»s
.
is_em±y
());

1922 
Ët
 
	g»¥
 = 
rx
.
Œy_»cv
().
unw¿p
();

1923 
	gas£¹
!(!
	g»¥
.
g‘_h—d”
().
has_”rÜ
(), "{:?}",„esp);

1924 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
().
Ën
(), 3);

1925 
Ët
 
	gdk_k1
 = 
keys
::
d©a_key
(
b
"k1");

1926 
Ët
 
	gdk_k2
 = 
keys
::
d©a_key
(
b
"k2");

1927 
Ët
 
	gdk_k3
 = 
keys
::
d©a_key
(
b
"k3");

1928 
	gas£¹_eq
!(
	gdb
.
g‘
(&
dk_k1
).
unw¿p
().unw¿p(), 
	gb
"v1");

1929 
	gas£¹_eq
!(
	gdb
.
g‘
(&
dk_k2
).
unw¿p
().unw¿p(), 
	gb
"v1");

1930 
	gas£¹_eq
!(
	gdb
.
g‘
(&
dk_k3
).
unw¿p
().unw¿p(), 
	gb
"v1");

1931 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶›d_šdex_‹rm
, 1);

1932 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶y_¡©e
.
g‘_­¶›d_šdex
(), 1);

1934 
Ët
 
	glock_wr™‹n_by‹s
 = 
d–eg©e
.
m‘rics
.
lock_cf_wr™‹n_by‹s
;

1935 
Ët
 
	gwr™‹n_by‹s
 = 
d–eg©e
.
m‘rics
.
wr™‹n_by‹s
;

1936 
Ët
 
	gwr™‹n_keys
 = 
d–eg©e
.
m‘rics
.
wr™‹n_keys
;

1937 
Ët
 
	gsize_diff_hšt
 = 
d–eg©e
.
m‘rics
.
size_diff_hšt
;

1938 
Ët
 
	gput_’Œy
 = 
EÁryBud”
::
Ãw
(2, 2)

1939 .
put_cf
(
CF_LOCK
, 
b
"k1", b"v1")

1940 .
•och
(1, 3)

1941 .
bud
();

1942 
Ët
 
mut
 
	g­¶y_ùx
 = 
AµlyCÚ‹xt
::
Ãw
(&
ho¡
);

1943 
	gd–eg©e
.
hªdË_¿á_comm™‹d_’Œ›s
(&
mut
 
­¶y_ùx
, 
vec
![
put_’Œy
]);

1944 
	gdb
.
wr™e
(
­¶y_ùx
.
wb
).
unw¿p
();

1945 
	gcb
, 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

1946 
cb
(
»¥
);

1948 
Ët
 
	glock_hªdË
 = 
db
.
cf_hªdË
(
CF_LOCK
).
unw¿p
();

1949 
	gas£¹_eq
!(
	gdb
.
g‘_cf
(
lock_hªdË
, &
dk_k1
).
unw¿p
().unw¿p(), 
	gb
"v1");

1950 
	gas£¹_eq
!(

1951 
	gd–eg©e
.
	gm‘rics
.
	glock_cf_wr™‹n_by‹s
,

1952 
	glock_wr™‹n_by‹s
 + 5

1954 
	gas£¹
!(
	gd–eg©e
.
	gm‘rics
.
	gwr™‹n_by‹s
 >ğ
wr™‹n_by‹s
 + 5);

1955 
	gas£¹_eq
!(
	gd–eg©e
.
	gm‘rics
.
	gwr™‹n_keys
, written_keys + 2);

1956 
	gas£¹_eq
!(
	gd–eg©e
.
	gm‘rics
.
	gsize_diff_hšt
, size_diff_hint + 5);

1957 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶›d_šdex_‹rm
, 2);

1958 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶y_¡©e
.
g‘_­¶›d_šdex
(), 2);

1960 
Ët
 
	gput_’Œy
 = 
EÁryBud”
::
Ãw
(3, 2)

1961 .
put
(
b
"k2", b"v2")

1962 .
•och
(1, 1)

1963 .
ÿ±u»_»¥
(&
mut
 
d–eg©e
, 
tx
.
şÚe
())

1964 .
bud
();

1965 
Ët
 
mut
 
	g­¶y_ùx
 = 
AµlyCÚ‹xt
::
Ãw
(&
ho¡
);

1966 
	gd–eg©e
.
hªdË_¿á_comm™‹d_’Œ›s
(&
mut
 
­¶y_ùx
, 
vec
![
put_’Œy
]);

1967 
	gdb
.
wr™e
(
­¶y_ùx
.
wb
).
unw¿p
();

1968 
	gcb
, 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

1969 
cb
(
»¥
);

1971 
Ët
 
	g»¥
 = 
rx
.
Œy_»cv
().
unw¿p
();

1972 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_¡®e_•och
());

1973 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶›d_šdex_‹rm
, 2);

1974 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶y_¡©e
.
g‘_­¶›d_šdex
(), 3);

1976 
Ët
 
	gput_’Œy
 = 
EÁryBud”
::
Ãw
(4, 2)

1977 .
put
(
b
"k3", b"v3")

1978 .
put
(
b
"k5", b"v5")

1979 .
•och
(1, 3)

1980 .
ÿ±u»_»¥
(&
mut
 
d–eg©e
, 
tx
.
şÚe
())

1981 .
bud
();

1982 
Ët
 
mut
 
	g­¶y_ùx
 = 
AµlyCÚ‹xt
::
Ãw
(&
ho¡
);

1983 
	gd–eg©e
.
hªdË_¿á_comm™‹d_’Œ›s
(&
mut
 
­¶y_ùx
, 
vec
![
put_’Œy
]);

1984 
	gdb
.
wr™e
(
­¶y_ùx
.
wb
).
unw¿p
();

1985 
	gcb
, 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

1986 
cb
(
»¥
);

1988 
Ët
 
	g»¥
 = 
rx
.
Œy_»cv
().
unw¿p
();

1989 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_key_nÙ_š_»giÚ
());

1990 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶›d_šdex_‹rm
, 2);

1991 
	gas£¹_eq
!(
	gd–eg©e
.
	g­¶y_¡©e
.
g‘_­¶›d_šdex
(), 4);

1993 
	gas£¹_eq
!(
	gdb
.
g‘
(&
dk_k3
).
unw¿p
().unw¿p(), 
	gb
"v1");

1995 
	gEÁryBud”
::
Ãw
(5, 2)

1996 .
ÿ±u»_»¥
(&
mut
 
d–eg©e
, 
tx
.
şÚe
())

1997 .
bud
();

1998 
Ët
 
	gput_’Œy
 = 
EÁryBud”
::
Ãw
(5, 3)

1999 .
d–‘e
(
b
"k1")

2000 .
d–‘e_cf
(
CF_LOCK
, 
b
"k1")

2001 .
d–‘e_cf
(
CF_WRITE
, 
b
"k1")

2002 .
•och
(1, 3)

2003 .
ÿ±u»_»¥
(&
mut
 
d–eg©e
, 
tx
.
şÚe
())

2004 .
bud
();

2005 
Ët
 
	glock_wr™‹n_by‹s
 = 
d–eg©e
.
m‘rics
.
lock_cf_wr™‹n_by‹s
;

2006 
Ët
 
	gd–‘e_keys_hšt
 = 
d–eg©e
.
m‘rics
.
d–‘e_keys_hšt
;

2007 
Ët
 
	gsize_diff_hšt
 = 
d–eg©e
.
m‘rics
.
size_diff_hšt
;

2008 
Ët
 
mut
 
	g­¶y_ùx
 = 
AµlyCÚ‹xt
::
Ãw
(&
ho¡
);

2009 
	gd–eg©e
.
hªdË_¿á_comm™‹d_’Œ›s
(&
mut
 
­¶y_ùx
, 
vec
![
put_’Œy
]);

2010 
	gdb
.
wr™e
(
­¶y_ùx
.
wb
).
unw¿p
();

2011 
	gcb
, 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

2012 
cb
(
»¥
);

2014 
Ët
 
	g»¥
 = 
rx
.
Œy_»cv
().
unw¿p
();

2016 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_¡®e_commªd
());

2017 
Ët
 
	g»¥
 = 
rx
.
Œy_»cv
().
unw¿p
();

2018 
	gas£¹
!(!
	g»¥
.
g‘_h—d”
().
has_”rÜ
(), "{:?}",„esp);

2019 
	gas£¹
!(
	gdb
.
g‘
(&
dk_k1
).
unw¿p
().
is_nÚe
());

2020 
	gas£¹_eq
!(

2021 
	gd–eg©e
.
	gm‘rics
.
	glock_cf_wr™‹n_by‹s
,

2022 
	glock_wr™‹n_by‹s
 + 3

2024 
	gas£¹_eq
!(
	gd–eg©e
.
	gm‘rics
.
	gd–‘e_keys_hšt
, delete_keys_hint + 2);

2025 
	gas£¹_eq
!(
	gd–eg©e
.
	gm‘rics
.
	gsize_diff_hšt
, size_diff_hint - 9);

2027 
Ët
 
	gd–‘e_’Œy
 = 
EÁryBud”
::
Ãw
(6, 3)

2028 .
d–‘e
(
b
"k5")

2029 .
•och
(1, 3)

2030 .
ÿ±u»_»¥
(&
mut
 
d–eg©e
, 
tx
.
şÚe
())

2031 .
bud
();

2032 
Ët
 
mut
 
	g­¶y_ùx
 = 
AµlyCÚ‹xt
::
Ãw
(&
ho¡
);

2033 
	gd–eg©e
.
hªdË_¿á_comm™‹d_’Œ›s
(&
mut
 
­¶y_ùx
, 
vec
![
d–‘e_’Œy
]);

2034 
	gdb
.
wr™e
(
­¶y_ùx
.
wb
).
unw¿p
();

2035 
	gcb
, 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

2036 
cb
(
»¥
);

2038 
Ët
 
	g»¥
 = 
rx
.
Œy_»cv
().
unw¿p
();

2039 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_key_nÙ_š_»giÚ
());

2041 
Ët
 
	gd–‘e_¿nge_’Œy
 = 
EÁryBud”
::
Ãw
(7, 3)

2042 .
d–‘e_¿nge
(
b
"", b"")

2043 .
•och
(1, 3)

2044 .
ÿ±u»_»¥
(&
mut
 
d–eg©e
, 
tx
.
şÚe
())

2045 .
bud
();

2046 
Ët
 
mut
 
	g­¶y_ùx
 = 
AµlyCÚ‹xt
::
Ãw
(&
ho¡
);

2047 
	gd–eg©e
.
hªdË_¿á_comm™‹d_’Œ›s
(&
mut
 
­¶y_ùx
, 
vec
![
d–‘e_¿nge_’Œy
]);

2048 
	gdb
.
wr™e
(
­¶y_ùx
.
wb
).
unw¿p
();

2049 
	gcb
, 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

2050 
cb
(
»¥
);

2052 
Ët
 
	g»¥
 = 
rx
.
Œy_»cv
().
unw¿p
();

2053 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_key_nÙ_š_»giÚ
());

2054 
	gas£¹_eq
!(
	gdb
.
g‘
(&
dk_k3
).
unw¿p
().unw¿p(), 
	gb
"v1");

2056 
Ët
 
	gd–‘e_¿nge_’Œy
 = 
EÁryBud”
::
Ãw
(8, 3)

2057 .
d–‘e_¿nge_cf
(
CF_DEFAULT
, 
b
"", b"k5")

2058 .
d–‘e_¿nge_cf
(
CF_LOCK
, 
b
"", b"k5")

2059 .
d–‘e_¿nge_cf
(
CF_WRITE
, 
b
"", b"k5")

2060 .
•och
(1, 3)

2061 .
ÿ±u»_»¥
(&
mut
 
d–eg©e
, 
tx
.
şÚe
())

2062 .
bud
();

2063 
Ët
 
mut
 
	g­¶y_ùx
 = 
AµlyCÚ‹xt
::
Ãw
(&
ho¡
);

2064 
	gd–eg©e
.
hªdË_¿á_comm™‹d_’Œ›s
(&
mut
 
­¶y_ùx
, 
vec
![
d–‘e_¿nge_’Œy
]);

2065 
	gdb
.
wr™e
(
­¶y_ùx
.
wb
).
unw¿p
();

2066 
	gcb
, 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

2067 
cb
(
»¥
);

2069 
Ët
 
	g»¥
 = 
rx
.
Œy_»cv
().
unw¿p
();

2070 
	gas£¹
!(!
	g»¥
.
g‘_h—d”
().
has_”rÜ
(), "{:?}",„esp);

2071 
	gas£¹
!(
	gdb
.
g‘
(&
dk_k1
).
unw¿p
().
is_nÚe
());

2072 
	gas£¹
!(
	gdb
.
g‘
(&
dk_k2
).
unw¿p
().
is_nÚe
());

2073 
	gas£¹
!(
	gdb
.
g‘
(&
dk_k3
).
unw¿p
().
is_nÚe
());

2075 
Ët
 
mut
 
	g’Œ›s
 = 
vec
![];

2076 
i
 
	gš
 0..
	gWRITE_BATCH_MAX_KEYS
 {

2077 
Ët
 
	gput_’Œy
 = 
EÁryBud”
::
Ãw
(
i
 
as
 
u64
 + 9, 2)

2078 .
put
(
b
"k", b"v")

2079 .
•och
(1, 3)

2080 .
ÿ±u»_»¥
(&
mut
 
d–eg©e
, 
tx
.
şÚe
())

2081 .
bud
();

2082 
	g’Œ›s
.
push
(
put_’Œy
);

2084 
Ët
 
mut
 
	g­¶y_ùx
 = 
AµlyCÚ‹xt
::
Ãw
(&
ho¡
);

2085 
	gd–eg©e
.
hªdË_¿á_comm™‹d_’Œ›s
(&
mut
 
­¶y_ùx
, 
’Œ›s
);

2086 
	gdb
.
wr™e
(
­¶y_ùx
.
wb
).
unw¿p
();

2087 
	gcb
, 
	g»¥
è
š
 
	g­¶y_ùx
.
	gcbs
.
d¿š
(..) {

2088 
cb
(
»¥
);

2090 
_
 
	gš
 0..
	gWRITE_BATCH_MAX_KEYS
 {

2091 
	grx
.
Œy_»cv
().
unw¿p
();

2093 
	gas£¹_eq
!(

2094 
	gd–eg©e
.
	g­¶y_¡©e
.
g‘_­¶›d_šdex
(),

2095 
WRITE_BATCH_MAX_KEYS
 
as
 
	gu64
 + 8

	@src/raftstore/store/worker/compact.rs

14 
u£
 
	gut
::
wÜk”
::
RuÂabË
;

15 
u£
 
	gut
::
rocksdb
;

16 
u£
 
	gut
::
esÿ³
;

17 
u£
 
	gut
::
rocksdb
::
com·ù_¿nge
;

19 
u£
 
	grocksdb
::
DB
;

20 
u£
 
	g¡d
::
sync
::
Arc
;

21 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

22 
u£
 
	g¡d
::
”rÜ
;

23 
u£
 
	gsu³r
::
m‘rics
::
COMPACT_RANGE_CF
;

25 
pub
 
	sTask
 {

26 
pub
 
	mcf_Çme
: 
SŒšg
,

27 
pub
 
	m¡¬t_key
: 
O±iÚ
<
Vec
<
u8
>>,

28 
pub
 
	m’d_key
: 
O±iÚ
<
Vec
<
u8
>>,

31 
im¶
 
Di¥Ïy
 
	gTask
 {

32 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

33 
wr™e
!(

34 
f
,

36 
	g£lf
.
	gcf_Çme
,

37 
	g£lf
.
	g¡¬t_key
.
as_»f
().
m­
(|
k
| 
esÿ³
(k)),

38 
	g£lf
.
	g’d_key
.
as_»f
().
m­
(|
k
| 
esÿ³
(k))

43 
	gquick_”rÜ
! {

44 #[
d”ive
(
Debug
)]

45 
pub
 
	eE¼Ü
 {

46 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

47 
äom
()

48 
ÿu£
(
”r
.
as_»f
())

49 
desütiÚ
(
”r
.description())

50 
di¥Ïy
("com·ù faed {:?}", 
”r
)

55 
pub
 
	sRuÂ”
 {

56 
	m’gše
: 
Arc
<
DB
>,

59 
im¶
 
	gRuÂ”
 {

60 
pub
 
â
 
Ãw
(
’gše
: 
Arc
<
DB
>è-> 
RuÂ”
 {

61 
RuÂ”
 { 
’gše
:ƒngine }

64 
pub
 
â
 
com·ù_¿nge_cf
(

65 &
mut
 
£lf
,

66 
cf_Çme
: 
SŒšg
,

67 
¡¬t_key
: 
O±iÚ
<
Vec
<
u8
>>,

68 
’d_key
: 
O±iÚ
<
Vec
<
u8
>>,

69 è-> 
	gResuÉ
<(), 
	gE¼Ü
> {

70 
Ët
 
	ghªdË
 = 
box_Œy
!(
rocksdb
::
g‘_cf_hªdË
(&
£lf
.
’gše
, &
cf_Çme
));

71 
Ët
 
	gcom·ù_¿nge_tim”
 = 
COMPACT_RANGE_CF


72 .
w™h_Ïb–_v®ues
(&[&
cf_Çme
])

73 .
¡¬t_cßr£_tim”
();

74 
Ët
 
	g¡¬t
 = 
¡¬t_key
.
as_»f
().
m­
(
Vec
::
as_¦iû
);

75 
Ët
 
	g’d
 = 
’d_key
.
as_»f
().
m­
(
Vec
::
as_¦iû
);

76 
com·ù_¿nge
(&
£lf
.
’gše
, 
hªdË
, 
¡¬t
, 
’d
, 
çl£
);

77 
	gcom·ù_¿nge_tim”
.
ob£rve_du¿tiÚ
();

78 
Ok
(())

82 
im¶
 
	gRuÂabË
<
	gTask
> 
	gRuÂ”
 {

83 
â
 
run
(&
mut
 
£lf
, 
sk
: 
Task
) {

84 
Ët
 
cf
 = 
sk
.
cf_Çme
.
şÚe
();

85 
Ët
 
E¼
(
e
èğ
£lf
.
com·ù_¿nge_cf
(
sk
.
cf_Çme
,ask.
¡¬t_key
,ask.
’d_key
) {

86 
	g”rÜ
!("execu‹ com·ù„ªgfÜ cà{} faed,ƒ¼ {}", &
	gcf
, 
	ge
);

88 
	gšfo
!("com·ù„ªgfÜ cà{} fšished", &
	gcf
);

93 #[
cfg
(
‹¡
)]

94 
mod
 
	g‹¡
 {

95 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

96 
u£
 
	g¡d
::
th»ad
::
¦“p
;

97 
u£
 
	gut
::
rocksdb
::
Ãw_’gše
;

98 
u£
 
	g‹mpdœ
::
TempDœ
;

99 
u£
 
	g¡Üage
::
CF_WRITE
;

100 
u£
 
	grocksdb
::{
Wr™abË
, 
	gWr™eB©ch
};

101 
u£
 
	gsu³r
::*;

103 cÚ¡ 
	gROCKSDB_TOTAL_SST_FILES_SIZE
: &'static str = "rocksdb.total-sst-files-size";

105 #[
‹¡
]

106 
â
 
‹¡_com·ù_¿nge
() {

107 
Ët
 
·th
 = 
TempDœ
::
Ãw
("com·ù-¿nge-‹¡").
unw¿p
();

108 
Ët
 
	gdb
 = 
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), &[
CF_WRITE
]).unwrap();

109 
Ët
 
	gdb
 = 
Arc
::
Ãw
(
db
);

111 
Ët
 
mut
 
	gruÂ”
 = 
RuÂ”
::
Ãw
(
db
.
şÚe
());

113 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(&
db
, 
CF_WRITE
).
unw¿p
();

116 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

117 
i
 
	gš
 0..1000 {

118 
Ët
 
	gk
 = 
fÜm©
!("key_{}", 
	gi
);

119 
	gwb
.
put_cf
(
hªdË
, 
k
.
as_by‹s
(), 
b
"whatever content")

120 .
unw¿p
();

122 
	gdb
.
wr™e
(
wb
).
unw¿p
();

123 
	gdb
.
æush_cf
(
hªdË
, 
Œue
).
unw¿p
();

126 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

127 
i
 
	gš
 0..1000 {

128 
Ët
 
	gk
 = 
fÜm©
!("key_{}", 
	gi
);

129 
	gwb
.
put_cf
(
hªdË
, 
k
.
as_by‹s
(), 
b
"whatever content")

130 .
unw¿p
();

132 
	gdb
.
wr™e
(
wb
).
unw¿p
();

133 
	gdb
.
æush_cf
(
hªdË
, 
Œue
).
unw¿p
();

136 
Ët
 
	gŞd_s¡_fes_size
 = 
db
.
g‘_´İ”ty_št_cf
(
hªdË
, 
ROCKSDB_TOTAL_SST_FILES_SIZE
)

137 .
unw¿p
();

140 
	gruÂ”
.
run
(
Task
 {

141 
cf_Çme
: 
SŒšg
::
äom
(
CF_WRITE
),

142 
¡¬t_key
: 
NÚe
,

143 
’d_key
: 
NÚe
,

145 
¦“p
(
Du¿tiÚ
::
äom_£cs
(5));

148 
Ët
 
	gÃw_s¡_fes_size
 = 
db
.
g‘_´İ”ty_št_cf
(
hªdË
, 
ROCKSDB_TOTAL_SST_FILES_SIZE
)

149 .
unw¿p
();

150 
	gas£¹
!(
	gŞd_s¡_fes_size
 > 
	gÃw_s¡_fes_size
);

	@src/raftstore/store/worker/consistency_check.rs

15 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

17 
u£
 
	güc
::
üc32
::{
£lf
, 
	gDige¡
, 
	gHash”32
};

18 
u£
 
	gby‹Üd”
::{
BigEndŸn
, 
	gWr™eBy‹sExt
};

20 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

21 
u£
 
	g¿á¡Üe
::
¡Üe
::{
keys
, 
	gMsg
};

22 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::{
I‹¿bË
, 
	gP“kabË
, 
	gSÇpshÙ
};

23 
u£
 
	g¡Üage
::
CF_RAFT
;

24 
u£
 
	gut
::
wÜk”
::
RuÂabË
;

26 
u£
 
	gsu³r
::
m‘rics
::*;

27 
u£
 
	g¿á¡Üe
::
¡Üe
::
m‘rics
::*;

28 
u£
 
	gsu³r
::
MsgS’d”
;

31 
pub
 
	eTask
 {

32 
	mCompu‹Hash
 {

33 
	mšdex
: 
u64
,

34 
	m»giÚ
: 
RegiÚ
,

35 
	m¢­
: 
SÇpshÙ
,

39 
im¶
 
	gTask
 {

40 
pub
 
â
 
compu‹_hash
(
»giÚ
: 
RegiÚ
, 
šdex
: 
u64
, 
¢­
: 
SÇpshÙ
è-> 
Task
 {

41 
Task
::
Compu‹Hash
 {

42 
»giÚ
:„egion,

43 
	gšdex
: 
šdex
,

44 
	g¢­
: 
¢­
,

49 
im¶
 
Di¥Ïy
 
	gTask
 {

50 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

51 
m©ch
 *
£lf
 {

52 
Task
::
Compu‹Hash
 {

53 
»f
 
»giÚ
, 
	gšdex
, ..

54 } => 
wr™e
!(
f
, "Compu‹ Hash Task fÜ {:?}‡ˆ{}", 
	g»giÚ
, 
	gšdex
),

59 
pub
 
	gRuÂ”
<
	gC
: 
MsgS’d”
> {

60 
ch
: 
C
,

63 
	gim¶
<
	gC
: 
MsgS’d”
> 
RuÂ”
<
C
> {

64 
pub
 
â
 
Ãw
(
ch
: 
C
è-> 
RuÂ”
<C> {

65 
RuÂ”
 { 
ch
: ch }

68 
â
 
compu‹_hash
(&
mut
 
£lf
, 
»giÚ
: 
RegiÚ
, 
šdex
: 
u64
, 
¢­
: 
SÇpshÙ
) {

69 
Ët
 
»giÚ_id
 = 
»giÚ
.
g‘_id
();

70 
	gšfo
!("[»giÚ {}] computšg hash‡ˆ{}", 
	g»giÚ_id
, 
	gšdex
);

71 
	gREGION_HASH_COUNTER_VEC


72 .
w™h_Ïb–_v®ues
(&["compute", "all"])

73 .
šc
();

75 
Ët
 
	gtim”
 = 
REGION_HASH_HISTOGRAM
.
¡¬t_cßr£_tim”
();

76 
Ët
 
mut
 
	gdige¡
 = 
Dige¡
::
Ãw
(
üc32
::
IEEE
);

77 
Ët
 
mut
 
	gcf_Çmes
 = 
¢­
.
cf_Çmes
();

78 
	gcf_Çmes
.
sÜt
();

79 
Ët
 
	g¡¬t_key
 = 
keys
::
’c_¡¬t_key
(&
»giÚ
);

80 
Ët
 
	g’d_key
 = 
keys
::
’c_’d_key
(&
»giÚ
);

81 
cf
 
š
 
	gcf_Çmes
 {

82 
Ët
 
	g»s
 = 
¢­
.
sÿn_cf
(
cf
, &
¡¬t_key
, &
’d_key
, 
çl£
, &
mut
 |
k
, 
v
| {

83 
dige¡
.
wr™e
(
k
);

84 
dige¡
.
wr™e
(
v
);

85 
Ok
(
Œue
)

87 
Ët
 
E¼
(
e
èğ
»s
 {

88 
REGION_HASH_COUNTER_VEC


89 .
w™h_Ïb–_v®ues
(&["compute", "failed"])

90 .
šc
();

91 
	g”rÜ
!("[»giÚ {}] faedØÿlcuÏ‹ hash: {:?}", 
	g»giÚ_id
, 
	ge
);

95 
Ët
 
	g»giÚ_¡©e_key
 = 
keys
::
»giÚ_¡©e_key
(
»giÚ_id
);

96 
	gdige¡
.
wr™e
(&
»giÚ_¡©e_key
);

97 
m©ch
 
	g¢­
.
g‘_v®ue_cf
(
CF_RAFT
, &
»giÚ_¡©e_key
) {

98 
E¼
(
e
) => {

99 
REGION_HASH_COUNTER_VEC


100 .
w™h_Ïb–_v®ues
(&["compute", "failed"])

101 .
šc
();

102 
	g”rÜ
!("[»giÚ {}] faedØg‘„egiÚ s‹: {:?}", 
	g»giÚ_id
, 
	ge
);

105 
Ok
(
Some
(
v
)è=> 
dige¡
.
wr™e
(&v),

106 
Ok
(
NÚe
è=> 
dige¡
.
wr™e
(
b
""),

108 
Ët
 
	gsum
 = 
dige¡
.
sum32
();

109 
	gtim”
.
ob£rve_du¿tiÚ
();

111 
Ët
 
mut
 
	gchecksum
 = 
Vec
::
w™h_ÿ·c™y
(4);

112 
	gchecksum
.
	gwr™e_u32
::<
BigEndŸn
>(
sum
).
unw¿p
();

113 
Ët
 
	gmsg
 = 
Msg
::
Compu‹HashResuÉ
 {

114 
»giÚ_id
:„egion_id,

115 
šdex
: index,

116 
hash
: 
checksum
,

118 
Ët
 
E¼
(
e
èğ
£lf
.
ch
.
Œy_£nd
(
msg
) {

119 
w¬n
!(

121 
»giÚ_id
,

122 
e


128 
	gim¶
<
	gC
: 
MsgS’d”
> 
RuÂabË
<
Task
> 
RuÂ”
<
C
> {

129 
â
 
run
(&
mut
 
£lf
, 
sk
: 
Task
) {

130 
m©ch
 
sk
 {

131 
Task
::
Compu‹Hash
 {

132 
»giÚ
,

133 
	gšdex
,

134 
	g¢­
,

135 } => 
£lf
.
compu‹_hash
(
»giÚ
, 
šdex
, 
¢­
),

140 #[
cfg
(
‹¡
)]

141 
mod
 
	g‹¡
 {

142 
u£
 
	grocksdb
::
Wr™abË
;

143 
u£
 
	g‹mpdœ
::
TempDœ
;

144 
u£
 
	g¡Üage
::{
CF_DEFAULT
, 
	gCF_RAFT
};

145 
u£
 
	güc
::
üc32
::{
£lf
, 
	gDige¡
, 
	gHash”32
};

146 
u£
 
	g¡d
::
sync
::{
mpsc
, 
	gArc
};

147 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

148 
u£
 
	gby‹Üd”
::{
BigEndŸn
, 
	gWr™eBy‹sExt
};

149 
u£
 
	gkv´Ùo
::
m‘­b
::*;

150 
u£
 
	gut
::
rocksdb
::
Ãw_’gše
;

151 
u£
 
	gut
::
wÜk”
::
RuÂabË
;

152 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::
SÇpshÙ
;

153 
u£
 
	g¿á¡Üe
::
¡Üe
::{
keys
, 
	gMsg
};

154 
u£
 
	gsu³r
::*;

156 #[
‹¡
]

157 
â
 
‹¡_cÚsi¡’cy_check
() {

158 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("tikv-¡Üe-‹¡").
unw¿p
();

159 
Ët
 
	gdb
 = 
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), &[
CF_DEFAULT
, 
CF_RAFT
]).unwrap();

160 
Ët
 
	gdb
 = 
Arc
::
Ãw
(
db
);

162 
Ët
 
mut
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

163 
	g»giÚ
.
mut_³”s
().
push
(
P“r
::
Ãw
());

165 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

166 
Ët
 
mut
 
	gruÂ”
 = 
RuÂ”
::
Ãw
(
tx
);

167 
Ët
 
mut
 
	gdige¡
 = 
Dige¡
::
Ãw
(
üc32
::
IEEE
);

168 
Ët
 
	gkvs
 = 
vec
![(
b
"k1", b"v1"), (b"k2", b"v2")];

169 
	gk
, 
	gv
è
š
 
	gkvs
 {

170 
Ët
 
	gkey
 = 
keys
::
d©a_key
(
k
);

171 
	gdb
.
put
(&
key
, 
v
).
unw¿p
();

173 
	gdige¡
.
wr™e
(&
key
);

174 
	gdige¡
.
wr™e
(
v
);

178 
	gdige¡
.
wr™e
(&
keys
::
»giÚ_¡©e_key
(
»giÚ
.
g‘_id
()));

179 
	gdige¡
.
wr™e
(
b
"");

180 
Ët
 
	gsum
 = 
dige¡
.
sum32
();

181 
	gruÂ”
.
run
(
Task
::
Compu‹Hash
 {

182 
šdex
: 10,

183 
»giÚ
:„egiÚ.
şÚe
(),

184 
¢­
: 
SÇpshÙ
::
Ãw
(
db
.
şÚe
()),

186 
Ët
 
mut
 
	gchecksum_by‹s
 = 
vec
![];

187 
	gchecksum_by‹s
.
	gwr™e_u32
::<
BigEndŸn
>(
sum
).
unw¿p
();

189 
Ët
 
	g»s
 = 
rx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

190 
m©ch
 
	g»s
 {

191 
	gMsg
::
Compu‹HashResuÉ
 {

192 
»giÚ_id
,

193 
	gšdex
,

194 
	ghash
,

196 
as£¹_eq
!(
»giÚ_id
, 
»giÚ
.
g‘_id
());

197 
	gas£¹_eq
!(
	gšdex
, 10);

198 
	gas£¹_eq
!(
	ghash
, 
	gchecksum_by‹s
);

200 
	ge
 => 
·nic
!("unexpected {:?}",ƒ),

	@src/raftstore/store/worker/metrics.rs

14 
u£
 
	g´om‘heus
::{
expÚ’tŸl_buck‘s
, 
	gCouÁ”Vec
, 
	gHi¡og¿m
, 
	gHi¡og¿mVec
};

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gSNAP_COUNTER_VEC
: 
CouÁ”Vec
 =

18 
»gi¡”_couÁ”_vec
!(

22 ).
unw¿p
();

24 
pub
 
»f
 
	gCHECK_SPILT_COUNTER_VEC
: 
CouÁ”Vec
 =

25 
»gi¡”_couÁ”_vec
!(

29 ).
unw¿p
();

31 
pub
 
»f
 
	gSNAP_HISTOGRAM
: 
Hi¡og¿mVec
 =

32 
»gi¡”_hi¡og¿m_vec
!(

36 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

37 ).
unw¿p
();

39 
pub
 
»f
 
	gCHECK_SPILT_HISTOGRAM
: 
Hi¡og¿m
 =

40 
»gi¡”_hi¡og¿m
!(

43 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

44 ).
unw¿p
();

46 
pub
 
»f
 
	gCOMPACT_RANGE_CF
: 
Hi¡og¿mVec
 =

47 
»gi¡”_hi¡og¿m_vec
!(

51 ).
unw¿p
();

53 
pub
 
»f
 
	gREGION_HASH_HISTOGRAM
: 
Hi¡og¿m
 =

54 
»gi¡”_hi¡og¿m
!(

57 ).
unw¿p
();

59 
pub
 
»f
 
	gAPPLY_PROPOSAL
: 
Hi¡og¿m
 =

60 
»gi¡”_hi¡og¿m
!(

63 
expÚ’tŸl_buck‘s
(1.0, 2.0, 20).
unw¿p
()

64 ).
unw¿p
();

	@src/raftstore/store/worker/mod.rs

15 
u£
 
	g¿á¡Üe
::
¡Üe
::
msg
::
Msg
;

16 
u£
 
	g¿á¡Üe
;

17 
u£
 
	gut
::
Œª¥Üt
::
S’dCh
;

18 
u£
 
	g¡d
::
sync
::
mpsc
::
S’d”
;

20 
pub
 
Œa™
 
	gMsgS’d”
 {

21 
â
 
£nd
(&
£lf
, 
msg
: 
Msg
è-> 
¿á¡Üe
::
ResuÉ
<()>;

23 
â
 
Œy_£nd
(&
£lf
, 
msg
: 
Msg
è-> 
¿á¡Üe
::
ResuÉ
<()>;

26 
im¶
 
MsgS’d”
 
	gS’dCh
<
	gMsg
> {

27 
â
 
£nd
(&
£lf
, 
msg
: 
Msg
è-> 
¿á¡Üe
::
ResuÉ
<()> {

28 
S’dCh
::
£nd
(
£lf
, 
msg
).
m­_”r
(|
e
| 
box_”r
!("{:?}",ƒ))

31 
â
 
Œy_£nd
(&
£lf
, 
msg
: 
Msg
è-> 
¿á¡Üe
::
ResuÉ
<()> {

32 
S’dCh
::
Œy_£nd
(
£lf
, 
msg
).
m­_”r
(|
e
| 
box_”r
!("{:?}",ƒ))

36 
im¶
 
MsgS’d”
 
	gS’d”
<
	gMsg
> {

37 
â
 
£nd
(&
£lf
, 
msg
: 
Msg
è-> 
¿á¡Üe
::
ResuÉ
<()> {

38 
S’d”
::
£nd
(
£lf
, 
msg
).
unw¿p
();

39 
Ok
(())

42 
â
 
Œy_£nd
(&
£lf
, 
msg
: 
Msg
è-> 
¿á¡Üe
::
ResuÉ
<()> {

43 
S’d”
::
£nd
(
£lf
, 
msg
).
unw¿p
();

44 
Ok
(())

48 
mod
 
	g»giÚ
;

49 
mod
 
	g¥l™_check
;

50 
mod
 
	gcom·ù
;

51 
mod
 
	g¿álog_gc
;

52 
mod
 
	gm‘rics
;

53 
mod
 
	gcÚsi¡’cy_check
;

54 
pub
 
mod
 
	g­¶y
;

56 
pub
 
u£
 
	g£lf
::
»giÚ
::{
RuÂ”
 
as
 
RegiÚRuÂ”
, 
Task
‡ 
	gRegiÚTask
};

57 
pub
 
u£
 
	g£lf
::
¥l™_check
::{
RuÂ”
 
as
 
S¶™CheckRuÂ”
, 
Task
‡ 
	gS¶™CheckTask
};

58 
pub
 
u£
 
	g£lf
::
com·ù
::{
RuÂ”
 
as
 
Com·ùRuÂ”
, 
Task
‡ 
	gCom·ùTask
};

59 
pub
 
u£
 
	g£lf
::
¿álog_gc
::{
RuÂ”
 
as
 
RaálogGcRuÂ”
, 
Task
‡ 
	gRaálogGcTask
};

60 
pub
 
u£
 
	g£lf
::
cÚsi¡’cy_check
::{
RuÂ”
 
as
 
CÚsi¡’cyCheckRuÂ”
, 
Task
‡ 
	gCÚsi¡’cyCheckTask
};

61 
pub
 
u£
 
	g£lf
::
­¶y
::{
Aµly
, 
	gAµlyM‘rics
, 
	gAµlyRes
, 
	gPrİo§l
, 
	gRegiÚPrİo§l
, 
	gRegi¡¿tiÚ
,

62 
RuÂ”
 
as
 
	gAµlyRuÂ”
, 
Task
‡ 
	gAµlyTask
, 
TaskRes
‡ 
	gAµlyTaskRes
};

	@src/raftstore/store/worker/raftlog_gc.rs

14 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
;

15 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::
I‹¿bË
;

16 
u£
 
	gut
::
wÜk”
::
RuÂabË
;

18 
u£
 
	grocksdb
::{
Wr™abË
, 
	gWr™eB©ch
, 
	gDB
};

19 
u£
 
	g¡d
::
sync
::
Arc
;

20 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

21 
u£
 
	g¡d
::
”rÜ
;

22 
u£
 
	g¡d
::
sync
::
mpsc
::
S’d”
;

24 
pub
 
	sTask
 {

25 
pub
 
	m¿á_’gše
: 
Arc
<
DB
>,

26 
pub
 
	m»giÚ_id
: 
u64
,

27 
pub
 
	m¡¬t_idx
: 
u64
,

28 
pub
 
	m’d_idx
: 
u64
,

31 
pub
 
	sTaskRes
 {

32 
pub
 
	mcŞËùed
: 
u64
,

35 
im¶
 
Di¥Ïy
 
	gTask
 {

36 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

37 
wr™e
!(

38 
f
,

40 
	g£lf
.
	g»giÚ_id
,

41 
	g£lf
.
	g¡¬t_idx
,

42 
	g£lf
.
	g’d_idx


47 
	gquick_”rÜ
! {

48 #[
d”ive
(
Debug
)]

49 
	eE¼Ü
 {

50 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

51 
äom
()

52 
ÿu£
(
”r
.
as_»f
())

53 
desütiÚ
(
”r
.description())

54 
di¥Ïy
("¿álog gøçed {:?}", 
”r
)

59 
pub
 
	sRuÂ”
 {

60 
	mch
: 
O±iÚ
<
S’d”
<
TaskRes
>>,

63 
im¶
 
	gRuÂ”
 {

64 
pub
 
â
 
Ãw
(
ch
: 
O±iÚ
<
S’d”
<
TaskRes
>>è-> 
RuÂ”
 {

65 
RuÂ”
 { 
ch
: ch }

69 
â
 
gc_¿á_log
(

70 &
mut
 
£lf
,

71 
¿á_’gše
: 
Arc
<
DB
>,

72 
»giÚ_id
: 
u64
,

73 
¡¬t_idx
: 
u64
,

74 
’d_idx
: 
u64
,

75 è-> 
	gResuÉ
<
	gu64
, 
	gE¼Ü
> {

76 
Ët
 
mut
 
	gfœ¡_idx
 = 
¡¬t_idx
;

77 
	gfœ¡_idx
 == 0 {

78 
Ët
 
¡¬t_key
 = 
keys
::
¿á_log_key
(
»giÚ_id
, 0);

79 
	gfœ¡_idx
 = 
’d_idx
;

80 
Ët
 
Some
((
k
, 
_
)èğ
box_Œy
!(
¿á_’gše
.
£ek
(&
¡¬t_key
)) {

81 
fœ¡_idx
 = 
box_Œy
!(
keys
::
¿á_log_šdex
(&
k
));

84 
	gfœ¡_idx
 >ğ
’d_idx
 {

85 
šfo
!("[»giÚ {}]‚ØÃedØgc", 
»giÚ_id
);

86  
Ok
(0);

88 
Ët
 
	g¿á_wb
 = 
Wr™eB©ch
::
Ãw
();

89 
idx
 
š
 
	gfœ¡_idx
..
	g’d_idx
 {

90 
Ët
 
	gkey
 = 
keys
::
¿á_log_key
(
»giÚ_id
, 
idx
);

91 
	gbox_Œy
!(
	g¿á_wb
.
d–‘e
(&
key
));

94 
	g¿á_’gše
.
wr™e
(
¿á_wb
).
unw¿p
();

95 
Ok
(
’d_idx
 - 
fœ¡_idx
)

98 
â
 
»pÜt_cŞËùed
(&
£lf
, 
cŞËùed
: 
u64
) {

99 
£lf
.
ch
.
is_nÚe
() {

102 
	g£lf
.
	gch


103 .
as_»f
()

104 .
unw¿p
()

105 .
£nd
(
TaskRes
 {

106 
cŞËùed
: collected,

108 .
unw¿p
();

112 
im¶
 
	gRuÂabË
<
	gTask
> 
	gRuÂ”
 {

113 
â
 
run
(&
mut
 
£lf
, 
sk
: 
Task
) {

114 
debug
!(

116 
	gsk
.
	g»giÚ_id
,

117 
	gsk
.
	g’d_idx


119 
m©ch
 
	g£lf
.
gc_¿á_log
(

120 
sk
.
¿á_’gše
,

121 
sk
.
»giÚ_id
,

122 
sk
.
¡¬t_idx
,

123 
sk
.
’d_idx
,

125 
E¼
(
e
) => {

126 
”rÜ
!("[»giÚ {}] faedØgc: {:?}", 
sk
.
»giÚ_id
, 
e
);

127 
	g£lf
.
»pÜt_cŞËùed
(0);

129 
Ok
(
n
) => {

130 
debug
!("[»giÚ {}] cŞËùed {}†ogƒÁr›s", 
sk
.
»giÚ_id
, 
n
);

131 
	g£lf
.
»pÜt_cŞËùed
(
n
);

137 #[
cfg
(
‹¡
)]

138 
mod
 
	g‹¡
 {

139 
u£
 
	g¡d
::
sync
::
mpsc
;

140 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

141 
u£
 
	gut
::
rocksdb
::
Ãw_’gše
;

142 
u£
 
	g‹mpdœ
::
TempDœ
;

143 
u£
 
	g¡Üage
::
CF_DEFAULT
;

144 
u£
 
	gsu³r
::*;

146 #[
‹¡
]

147 
â
 
‹¡_gc_¿á_log
() {

148 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("gc-¿á-log-‹¡").
unw¿p
();

149 
Ët
 
	g¿á_db
 = 
Ãw_’gše
(
·th
.·th().
to_¡r
().
unw¿p
(), &[
CF_DEFAULT
]).unwrap();

150 
Ët
 
	g¿á_db
 = 
Arc
::
Ãw
(
¿á_db
);

152 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

153 
Ët
 
mut
 
	gruÂ”
 = 
RuÂ”
::
Ãw
(
Some
(
tx
));

156 
Ët
 
	g»giÚ_id
 = 1;

157 
Ët
 
	g¿á_wb
 = 
Wr™eB©ch
::
Ãw
();

158 
i
 
	gš
 0..100 {

159 
Ët
 
	gk
 = 
keys
::
¿á_log_key
(
»giÚ_id
, 
i
);

160 
	g¿á_wb
.
put
(&
k
, 
b
"’Œy").
unw¿p
();

162 
	g¿á_db
.
wr™e
(
¿á_wb
).
unw¿p
();

164 
Ët
 
	gtbls
 = 
vec
![

166 
Task
 {

167 
¿á_’gše
: 
¿á_db
.
şÚe
(),

168 
»giÚ_id
:„egion_id,

169 
¡¬t_idx
: 0,

170 
’d_idx
: 10,

177 
Task
 {

178 
¿á_’gše
: 
¿á_db
.
şÚe
(),

179 
»giÚ_id
:„egion_id,

180 
¡¬t_idx
: 0,

181 
’d_idx
: 50,

188 
Task
 {

189 
¿á_’gše
: 
¿á_db
.
şÚe
(),

190 
»giÚ_id
:„egion_id,

191 
¡¬t_idx
: 50,

192 
’d_idx
: 50,

199 
Task
 {

200 
¿á_’gše
: 
¿á_db
.
şÚe
(),

201 
»giÚ_id
:„egion_id,

202 
¡¬t_idx
: 50,

203 
’d_idx
: 60,

211 
	gsk
, 
	gex³ùed_cŞËùd
, 
	gnÙ_exi¡_¿nge
, 
	gexi¡_¿nge
è
š
 
	gtbls
 {

212 
	gruÂ”
.
run
(
sk
);

213 
Ët
 
	g»s
 = 
rx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

214 
	gas£¹_eq
!(
	g»s
.
	gcŞËùed
, 
	gex³ùed_cŞËùd
);

215 
¿á_log_mu¡_nÙ_exi¡
(&
¿á_db
, 1, 
nÙ_exi¡_¿nge
.0,‚ot_exist_range.1);

216 
¿á_log_mu¡_exi¡
(&
¿á_db
, 1, 
exi¡_¿nge
.0,ƒxist_range.1);

220 
â
 
¿á_log_mu¡_nÙ_exi¡
(
¿á_’gše
: &
DB
, 
»giÚ_id
: 
u64
, 
¡¬t_idx
: u64, 
’d_idx
: u64) {

221 
i
 
š
 
¡¬t_idx
..
’d_idx
 {

222 
Ët
 
k
 = 
keys
::
¿á_log_key
(
»giÚ_id
, 
i
);

223 
	gas£¹
!(
	g¿á_’gše
.
g‘
(&
k
).
unw¿p
().
is_nÚe
());

227 
â
 
¿á_log_mu¡_exi¡
(
¿á_’gše
: &
DB
, 
»giÚ_id
: 
u64
, 
¡¬t_idx
: u64, 
’d_idx
: u64) {

228 
i
 
š
 
¡¬t_idx
..
’d_idx
 {

229 
Ët
 
k
 = 
keys
::
¿á_log_key
(
»giÚ_id
, 
i
);

230 
	gas£¹
!(
	g¿á_’gše
.
g‘
(&
k
).
unw¿p
().
is_some
());

	@src/raftstore/store/worker/region.rs

15 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

16 
u£
 
	g¡d
::
sync
::
Arc
;

17 
u£
 
	g¡d
::
sync
::
mpsc
::
SyncS’d”
;

18 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

19 
u£
 
	g¡d
::
time
::
In¡ªt
;

21 
u£
 
	grocksdb
::{
Wr™abË
, 
	gWr™eB©ch
, 
	gDB
};

22 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
P“rS‹
, 
	gRaáAµlyS‹
, 
	gRegiÚLoÿlS‹
};

23 
u£
 
	gkv´Ùo
::
”aápb
::
SÇpshÙ
 
as
 
RaáSÇpshÙ
;

25 
u£
 
	gut
::
th»adpoŞ
::{
DeçuÉCÚ‹xt
, 
	gTh»adPoŞ
, 
	gTh»adPoŞBud”
};

26 
u£
 
	gut
::
wÜk”
::
RuÂabË
;

27 
u£
 
	gut
::{
esÿ³
, 
	grocksdb
};

28 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::{
MubË
, 
	gSÇpshÙ
};

29 
u£
 
	g¿á¡Üe
::
¡Üe
::
³”_¡Üage
::{
JOB_STATUS_CANCELLED
, 
	gJOB_STATUS_CANCELLING
,

30 
	gJOB_STATUS_FAILED
, 
	gJOB_STATUS_FINISHED
, 
	gJOB_STATUS_PENDING
,

31 
	gJOB_STATUS_RUNNING
};

32 
u£
 
	g¿á¡Üe
::
¡Üe
::{
£lf
, 
	gcheck_abÜt
, 
	gkeys
, 
	gAµlyO±iÚs
, 
	gP“kabË
, 
	gSÇpEÁry
, 
	gSÇpKey
,

33 
	gSÇpMªag”
};

34 
u£
 
	g¿á¡Üe
::
¡Üe
::
¢­
::{
E¼Ü
, 
	gResuÉ
};

35 
u£
 
	g¡Üage
::
CF_RAFT
;

37 
u£
 
	gsu³r
::
m‘rics
::*;

38 
u£
 
	gsu³r
::
su³r
::
ut
;

40 cÚ¡ 
	gGENERATE_POOL_SIZE
: 
usize
 = 2;

43 
pub
 
	eTask
 {

44 
	mG’
 {

45 
	m»giÚ_id
: 
u64
,

46 
	mnÙif›r
: 
SyncS’d”
<
RaáSÇpshÙ
>,

48 
	mAµly
 {

49 
	m»giÚ_id
: 
u64
,

50 
	m¡©us
: 
Arc
<
AtomicUsize
>,

55 
	mDe¡roy
 {

56 
	m»giÚ_id
: 
u64
,

57 
	m¡¬t_key
: 
Vec
<
u8
>,

58 
	m’d_key
: 
Vec
<
u8
>,

62 
im¶
 
	gTask
 {

63 
pub
 
â
 
de¡roy
(
»giÚ_id
: 
u64
, 
¡¬t_key
: 
Vec
<
u8
>, 
’d_key
: Vec<u8>è-> 
Task
 {

64 
Task
::
De¡roy
 {

65 
»giÚ_id
:„egion_id,

66 
	g¡¬t_key
: 
¡¬t_key
,

67 
	g’d_key
: 
’d_key
,

72 
im¶
 
Di¥Ïy
 
	gTask
 {

73 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

74 
m©ch
 *
£lf
 {

75 
Task
::
G’
 { 
»giÚ_id
, .. } => 
wr™e
!(
f
, "SÇ°g’ fÜ {}", 
	g»giÚ_id
),

76 
	gTask
::
Aµly
 { 
»giÚ_id
, .. } => 
wr™e
!(
f
, "SÇ°­¶y fÜ {}", 
	g»giÚ_id
),

77 
	gTask
::
De¡roy
 {

78 
»giÚ_id
,

79 
»f
 
	g¡¬t_key
,

80 
»f
 
	g’d_key
,

81 } => 
wr™e
!(

82 
f
,

84 
	g»giÚ_id
,

85 
esÿ³
(
¡¬t_key
),

86 
esÿ³
(
’d_key
)

92 #[
d”ive
(
ClÚe
)]

93 
	sSÇpCÚ‹xt
 {

94 
	mkv_db
: 
Arc
<
DB
>,

95 
	m¿á_db
: 
Arc
<
DB
>,

96 
	mb©ch_size
: 
usize
,

97 
	mmgr
: 
SÇpMªag”
,

100 
im¶
 
	gSÇpCÚ‹xt
 {

101 
â
 
g’”©e_¢­
(&
£lf
, 
»giÚ_id
: 
u64
, 
nÙif›r
: 
SyncS’d”
<
RaáSÇpshÙ
>è-> 
ResuÉ
<()> {

103 
Ët
 
¿á_db
 = 
£lf
.¿á_db.
şÚe
();

104 
Ët
 
	g¿w_¢­
 = 
SÇpshÙ
::
Ãw
(
£lf
.
kv_db
.
şÚe
());

106 
Ët
 
	g¢­
 = 
box_Œy
!(
¡Üe
::
do_¢­shÙ
(

107 
£lf
.
mgr
.
şÚe
(),

108 &
¿á_db
,

109 &
¿w_¢­
,

110 
»giÚ_id


114 
	gç_pošt
!("hªdË_g’", 
	g»giÚ_id
 =ğ1, |
	g_
| 
Ok
(()));

115 
Ët
 
E¼
(
e
èğ
nÙif›r
.
Œy_£nd
(
¢­
) {

116 
šfo
!(

119 
»giÚ_id
,

120 
e


123 
Ok
(())

126 
â
 
hªdË_g’
(&
£lf
, 
»giÚ_id
: 
u64
, 
nÙif›r
: 
SyncS’d”
<
RaáSÇpshÙ
>) {

127 
SNAP_COUNTER_VEC


128 .
w™h_Ïb–_v®ues
(&["generate", "all"])

129 .
šc
();

130 
Ët
 
	gg’_hi¡og¿m
 = 
SNAP_HISTOGRAM
.
w™h_Ïb–_v®ues
(&["generate"]);

131 
Ët
 
	gtim”
 = 
g’_hi¡og¿m
.
¡¬t_cßr£_tim”
();

133 
Ët
 
E¼
(
e
èğ
£lf
.
g’”©e_¢­
(
»giÚ_id
, 
nÙif›r
) {

134 
	g”rÜ
!("[»giÚ {}] faedØg’”©¢­: {:?}!!!", 
	g»giÚ_id
, 
	ge
);

138 
	gSNAP_COUNTER_VEC


139 .
w™h_Ïb–_v®ues
(&["generate", "success"])

140 .
šc
();

141 
	gtim”
.
ob£rve_du¿tiÚ
();

144 
â
 
­¶y_¢­
(&
£lf
, 
»giÚ_id
: 
u64
, 
abÜt
: 
Arc
<
AtomicUsize
>è-> 
ResuÉ
<()> {

145 
šfo
!("[»giÚ {}] begš‡µly sÇ°d©a", 
	g»giÚ_id
);

146 
	gç_pošt
!("apply_snap");

147 
check_abÜt
(&
abÜt
)?;

148 
Ët
 
	g»giÚ_key
 = 
keys
::
»giÚ_¡©e_key
(
»giÚ_id
);

149 
Ët
 
mut
 
	g»giÚ_¡©e
: 
RegiÚLoÿlS‹
 =

150 
m©ch
 
box_Œy
!(
£lf
.
kv_db
.
g‘_msg_cf
(
CF_RAFT
, &
»giÚ_key
)) {

151 
Some
(
¡©e
) => state,

152 
	gNÚe
 => {

153  
E¼
(
box_”r
!(

155 
esÿ³
(&
»giÚ_key
)

161 
Ët
 
	g»giÚ
 = 
»giÚ_¡©e
.
g‘_»giÚ
().
şÚe
();

162 
Ët
 
	g¡¬t_key
 = 
keys
::
’c_¡¬t_key
(&
»giÚ
);

163 
Ët
 
	g’d_key
 = 
keys
::
’c_’d_key
(&
»giÚ
);

164 
check_abÜt
(&
abÜt
)?;

165 
	gbox_Œy
!(
	gut
::
d–‘e_®l_š_¿nge
(&
£lf
.
kv_db
, &
¡¬t_key
, &
’d_key
));

166 
check_abÜt
(&
abÜt
)?;

168 
Ët
 
	g¡©e_key
 = 
keys
::
­¶y_¡©e_key
(
»giÚ_id
);

169 
Ët
 
	g­¶y_¡©e
: 
RaáAµlyS‹
 =

170 
m©ch
 
box_Œy
!(
£lf
.
kv_db
.
g‘_msg_cf
(
CF_RAFT
, &
¡©e_key
)) {

171 
Some
(
¡©e
) => state,

172 
	gNÚe
 => {

173  
E¼
(
box_”r
!(

175 
esÿ³
(&
¡©e_key
)

179 
Ët
 
	g‹rm
 = 
­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_‹rm
();

180 
Ët
 
	gidx
 = 
­¶y_¡©e
.
g‘_Œunÿ‹d_¡©e
().
g‘_šdex
();

181 
Ët
 
	g¢­_key
 = 
SÇpKey
::
Ãw
(
»giÚ_id
, 
‹rm
, 
idx
);

182 
	g£lf
.
	gmgr
.(
	g¢­_key
.
şÚe
(), 
	gSÇpEÁry
::
Aµlyšg
);

183 
	gdeãr
!({

184 
	g£lf
.
	gmgr
.
d”egi¡”
(&
¢­_key
, &
SÇpEÁry
::
Aµlyšg
);

186 
Ët
 
mut
 
	gs
 = 
box_Œy
!(
£lf
.
mgr
.
g‘_¢­shÙ_fÜ_­¶yšg
(&
¢­_key
));

187 !
	gs
.
exi¡s
() {

188  
E¼
(
box_”r
!("missšg sÇpshÙ f{}", 
s
.
·th
()));

190 
check_abÜt
(&
abÜt
)?;

191 
Ët
 
	gtim”
 = 
In¡ªt
::
now
();

192 
Ët
 
	gİtiÚs
 = 
AµlyO±iÚs
 {

193 
db
: 
£lf
.
kv_db
.
şÚe
(),

194 
»giÚ
:„egiÚ.
şÚe
(),

195 
abÜt
:‡bÜt.
şÚe
(),

196 
wr™e_b©ch_size
: 
£lf
.
b©ch_size
,

198 
	gs
.
­¶y
(
İtiÚs
)?;

200 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

201 
	g»giÚ_¡©e
.
£t_¡©e
(
P“rS‹
::
NÜm®
);

202 
Ët
 
	ghªdË
 = 
box_Œy
!(
rocksdb
::
g‘_cf_hªdË
(&
£lf
.
kv_db
, 
CF_RAFT
));

203 
	gbox_Œy
!(
	gwb
.
put_msg_cf
(
hªdË
, &
»giÚ_key
, &
»giÚ_¡©e
));

204 
	gbox_Œy
!(
	gwb
.
d–‘e_cf
(

205 
hªdË
,

206 &
keys
::
¢­shÙ_¿á_¡©e_key
(
»giÚ_id
)

208 
	g£lf
.
	gkv_db
.
wr™e
(
wb
).
unw¿p_Ü_–£
(|
e
| {

209 
·nic
!("{} faedØ§v­¶y_¢­„esuÉ: {:?}", 
»giÚ_id
, 
e
);

211 
	gšfo
!(

213 
	g»giÚ_id
,

214 
	gtim”
.
–­£d
()

216 
Ok
(())

219 
â
 
hªdË_­¶y
(&
£lf
, 
»giÚ_id
: 
u64
, 
¡©us
: 
Arc
<
AtomicUsize
>) {

220 
¡©us
.
com·»_ªd_sw­
(
JOB_STATUS_PENDING
, 
JOB_STATUS_RUNNING
, 
Ord”šg
::
SeqC¡
);

221 
	gSNAP_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["­¶y", "®l"]).
šc
();

222 
Ët
 
	g­¶y_hi¡og¿m
 = 
SNAP_HISTOGRAM
.
w™h_Ïb–_v®ues
(&["apply"]);

223 
Ët
 
	gtim”
 = 
­¶y_hi¡og¿m
.
¡¬t_cßr£_tim”
();

225 
m©ch
 
	g£lf
.
­¶y_¢­
(
»giÚ_id
, 
¡©us
.
şÚe
()) {

226 
Ok
(()) => {

227 
¡©us
.
sw­
(
JOB_STATUS_FINISHED
, 
Ord”šg
::
SeqC¡
);

228 
	gSNAP_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["­¶y", "sucûss"]).
šc
();

230 
E¼
(
E¼Ü
::
AbÜt
) => {

231 
w¬n
!("­¶yšg sÇpshÙ fÜ„egiÚ {} i abÜ‹d.", 
»giÚ_id
);

232 
	gas£¹_eq
!(

233 
	g¡©us
.
sw­
(
JOB_STATUS_CANCELLED
, 
Ord”šg
::
SeqC¡
),

234 
	gJOB_STATUS_CANCELLING


236 
	gSNAP_COUNTER_VEC


237 .
w™h_Ïb–_v®ues
(&["apply", "abort"])

238 .
šc
();

240 
E¼
(
e
) => {

241 
”rÜ
!("çedØ­¶y sÇp: {:?}!!!", 
e
);

242 
	g¡©us
.
sw­
(
JOB_STATUS_FAILED
, 
Ord”šg
::
SeqC¡
);

243 
	gSNAP_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["­¶y", "ç"]).
šc
();

247 
	gtim”
.
ob£rve_du¿tiÚ
();

250 
â
 
hªdË_de¡roy
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
¡¬t_key
: 
Vec
<
u8
>, 
’d_key
: Vec<u8>) {

251 
šfo
!(

253 
	g»giÚ_id
,

254 
esÿ³
(&
¡¬t_key
),

255 
esÿ³
(&
’d_key
)

257 
Ët
 
E¼
(
e
èğ
ut
::
d–‘e_®l_š_¿nge
(&
£lf
.
kv_db
, &
¡¬t_key
, &
’d_key
) {

258 
	g”rÜ
!(

260 
esÿ³
(&
¡¬t_key
),

261 
esÿ³
(&
’d_key
),

262 
	ge


268 
pub
 
	sRuÂ”
 {

269 
	mpoŞ
: 
Th»adPoŞ
<
DeçuÉCÚ‹xt
>,

270 
	mùx
: 
SÇpCÚ‹xt
,

273 
im¶
 
	gRuÂ”
 {

274 
pub
 
â
 
Ãw
(
kv_db
: 
Arc
<
DB
>, 
¿á_db
: Arc<DB>, 
mgr
: 
SÇpMªag”
, 
b©ch_size
: 
usize
è-> 
RuÂ”
 {

275 
RuÂ”
 {

276 
poŞ
: 
Th»adPoŞBud”
::
w™h_deçuÉ_çùÜy
(
thd_Çme
!("snap generator"))

277 .
th»ad_couÁ
(
GENERATE_POOL_SIZE
)

278 .
bud
(),

279 
	gùx
: 
SÇpCÚ‹xt
 {

280 
kv_db
: kv_db,

281 
	g¿á_db
: 
¿á_db
,

282 
	gmgr
: 
mgr
,

283 
	gb©ch_size
: 
b©ch_size
,

289 
im¶
 
	gRuÂabË
<
	gTask
> 
	gRuÂ”
 {

290 
â
 
run
(&
mut
 
£lf
, 
sk
: 
Task
) {

291 
m©ch
 
sk
 {

292 
Task
::
G’
 {

293 
»giÚ_id
,

294 
	gnÙif›r
,

298 
Ët
 
ùx
 = 
£lf
.ùx.
şÚe
();

299 
	g£lf
.
	gpoŞ


300 .
execu‹
(
move
 |
_
| 
ùx
.
hªdË_g’
(
»giÚ_id
, 
nÙif›r
))

302 
	gTask
::
Aµly
 { 
»giÚ_id
, 
	g¡©us
 } => 
£lf
.
ùx
.
hªdË_­¶y
ÔegiÚ_id, 
¡©us
),

303 
	gTask
::
De¡roy
 {

304 
»giÚ_id
,

305 
	g¡¬t_key
,

306 
	g’d_key
,

307 } => 
£lf
.
ùx
.
hªdË_de¡roy
(
»giÚ_id
, 
¡¬t_key
, 
’d_key
),

311 
â
 
shutdown
(&
mut
 
£lf
) {

312 
Ët
 
E¼
(
e
èğ
£lf
.
poŞ
.
¡İ
() {

313 
w¬n
!("Stİh»adpoŞ faed w™h {:?}", 
e
);

	@src/raftstore/store/worker/split_check.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

15 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

16 
u£
 
	g¡d
::
cŞËùiÚs
::
Bš¬yH—p
;

17 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

19 
u£
 
	grocksdb
::{
DBI‹¿tÜ
, 
	gDB
};

20 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚEpoch
;

21 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

23 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::
CİroûssÜHo¡
;

24 
u£
 
	g¿á¡Üe
::
¡Üe
::{
keys
, 
	gMsg
};

25 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::{
I‹rO±iÚ
, 
	gI‹¿bË
};

26 
u£
 
	g¿á¡Üe
::
ResuÉ
;

27 
u£
 
	gut
::
esÿ³
;

28 
u£
 
	gut
::
Œª¥Üt
::{
R‘ryabËS’dCh
, 
	gS’d”
};

29 
u£
 
	gut
::
wÜk”
::
RuÂabË
;

30 
u£
 
	g¡Üage
::{
CfName
, 
	gLARGE_CFS
};

32 
u£
 
	gsu³r
::
m‘rics
::*;

34 #[
d”ive
(
P¬tŸlEq
, 
Eq
)]

35 
	sKeyEÁry
 {

36 
	mkey
: 
O±iÚ
<
Vec
<
u8
>>,

37 
	mpos
: 
usize
,

38 
	mv®ue_size
: 
usize
,

41 
im¶
 
	gKeyEÁry
 {

42 
â
 
Ãw
(
key
: 
Vec
<
u8
>, 
pos
: 
usize
, 
v®ue_size
: usizeè-> 
KeyEÁry
 {

43 
KeyEÁry
 {

44 
key
: 
Some
(key),

45 
	gpos
: 
pos
,

46 
	gv®ue_size
: 
v®ue_size
,

50 
â
 
ke
(&
mut
 
£lf
è-> 
	gKeyEÁry
 {

51 
	gKeyEÁry
::
Ãw
(
£lf
.
key
.
ke
().
unw¿p
(), s–f.
pos
, s–f.
v®ue_size
)

55 
im¶
 
P¬tŸlOrd
 
	gKeyEÁry
 {

56 
â
 
·¹Ÿl_cmp
(&
£lf
, 
rhs
: &
KeyEÁry
è-> 
O±iÚ
<
Ord”šg
> {

58 
Some
(

59 
£lf
.
key


60 .
as_»f
()

61 .
unw¿p
()

62 .
cmp
(
rhs
.
key
.
as_»f
().
unw¿p
())

63 .
»v”£
(),

68 
im¶
 
Ord
 
	gKeyEÁry
 {

69 
â
 
cmp
(&
£lf
, 
rhs
: &
KeyEÁry
è-> 
Ord”šg
 {

70 
£lf
.
·¹Ÿl_cmp
(
rhs
).
unw¿p
()

74 
M”gedI‹¿tÜ
<'a> {

75 
™”s
: 
Vec
<
DBI‹¿tÜ
<&'a DB>>,

76 
h—p
: 
Bš¬yH—p
<
KeyEÁry
>,

79 
	gim¶
<'a> M”gedI‹¿tÜ<'
	ga
> {

80 
â
 
Ãw
(

81 
db
: &'a DB,

82 
cfs
: &[
CfName
],

83 
¡¬t_key
: &[
u8
],

84 
’d_key
: &[
u8
],

85 
fl_ÿche
: 
boŞ
,

86 è-> 
	gResuÉ
<
	gM”gedI‹¿tÜ
<'a>> {

87 
Ët
 
mut
 
	g™”s
 = 
Vec
::
w™h_ÿ·c™y
(
cfs
.
Ën
());

88 
Ët
 
mut
 
	gh—p
 = 
Bš¬yH—p
::
w™h_ÿ·c™y
(
cfs
.
Ën
());

89 
	gpos
, 
	gcf
è
š
 
	gcfs
.
što_™”
().
’um”©e
() {

90 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
Some
(
’d_key
.
to_vec
()), 
fl_ÿche
);

91 
Ët
 
mut
 
	g™”
 = 
db
.
Ãw_™”©Ü_cf
(
cf
, 
™”_İt
)?;

92 
	g™”
.
£ek
(
¡¬t_key
.
što
()) {

93 
	gh—p
.
push
(
KeyEÁry
::
Ãw
(
™”
.
key
().
to_vec
(), 
pos
, i‹r.
v®ue
().
Ën
()));

95 
	g™”s
.
push
(
™”
);

97 
Ok
(
M”gedI‹¿tÜ
 {

98 
™”s
: iters,

99 
h—p
: heap,

103 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gKeyEÁry
> {

104 
Ët
 
	gpos
 = 
m©ch
 
£lf
.
h—p
.
³ek
() {

105 
NÚe
 =>  None,

106 
Some
(
e
è=>ƒ.
pos
,

108 
Ët
 
	g™”
 = &
mut
 
£lf
.
™”s
[
pos
];

109 
	g™”
.
Ãxt
() {

111 
Ët
 
	ge
 = 
KeyEÁry
::
Ãw
(
™”
.
key
().
to_vec
(), 
pos
, i‹r.
v®ue
().
Ën
());

112 
Ët
 
mut
 
	gäÚt
 = 
£lf
.
h—p
.
³ek_mut
().
unw¿p
();

113 
Ët
 
	g»s
 = 
äÚt
.
ke
();

114 *
	gäÚt
 = 
e
;

115 
Some
(
»s
)

117 
	g£lf
.
	gh—p
.
pİ
()

123 
pub
 
	sTask
 {

124 
	m»giÚ
: 
RegiÚ
,

127 
im¶
 
	gTask
 {

128 
pub
 
â
 
Ãw
(
»giÚ
: &
RegiÚ
è-> 
Task
 {

129 
Task
 {

130 
»giÚ
:„egiÚ.
şÚe
(),

135 
im¶
 
Di¥Ïy
 
	gTask
 {

136 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

137 
wr™e
!(
f
, "S¶™ Check Task fÜ {}", 
	g£lf
.
	g»giÚ
.
g‘_id
())

141 
pub
 
	gRuÂ”
<
	gC
> {

142 
	g’gše
: 
Arc
<
DB
>,

143 
	gch
: 
R‘ryabËS’dCh
<
Msg
, 
	gC
>,

144 
	gcİroûssÜ
: 
Arc
<
CİroûssÜHo¡
>,

147 
	gim¶
<
	gC
: 
S’d”
<
Msg
>> 
RuÂ”
<
C
> {

148 
pub
 
â
 
Ãw
(

149 
’gše
: 
Arc
<
DB
>,

150 
ch
: 
R‘ryabËS’dCh
<
Msg
, 
C
>,

151 
cİroûssÜ
: 
Arc
<
CİroûssÜHo¡
>,

152 è-> 
	gRuÂ”
<
	gC
> {

153 
	gRuÂ”
 {

154 
	g’gše
: 
’gše
,

155 
	gch
: 
ch
,

156 
	gcİroûssÜ
: 
cİroûssÜ
,

160 
â
 
check_¥l™
(&
mut
 
£lf
, 
»giÚ
: &
RegiÚ
) {

161 
Ët
 
mut
 
¥l™_ùx
 = 
£lf
.
cİroûssÜ


162 .
Ãw_¥l™_check_¡©us
(
»giÚ
, &
£lf
.
’gše
);

163 
	g¥l™_ùx
.
sk
() {

167 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

168 
Ët
 
	g¡¬t_key
 = 
keys
::
’c_¡¬t_key
(
»giÚ
);

169 
Ët
 
	g’d_key
 = 
keys
::
’c_’d_key
(
»giÚ
);

170 
	gdebug
!(

172 
	g»giÚ_id
,

173 
esÿ³
(&
¡¬t_key
),

174 
esÿ³
(&
’d_key
)

176 
	gCHECK_SPILT_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["®l"]).
šc
();

178 
Ët
 
mut
 
	g¥l™_key
 = 
NÚe
;

179 
Ët
 
	gcİroûssÜ
 = &
mut
 
£lf
.
cİroûssÜ
;

181 
Ët
 
	gtim”
 = 
CHECK_SPILT_HISTOGRAM
.
¡¬t_cßr£_tim”
();

182 
Ët
 
	g»s
 = 
M”gedI‹¿tÜ
::
Ãw
(
£lf
.
’gše
.
as_»f
(), 
LARGE_CFS
, &
¡¬t_key
, &
’d_key
, 
çl£
)

183 .
m­
(|
mut
 
™”
| 
Ët
 
Some
(
e
èğ™”.
Ãxt
() {

184 
Ët
 
Some
(
key
èğ
cİroûssÜ
.
Ú_¥l™_check
(

185 
»giÚ
,

186 &
mut
 
¥l™_ùx
,

187 
e
.
key
.
as_»f
().
unw¿p
(),

188 
e
.
v®ue_size
 
as
 
u64
,

190 
¥l™_key
 = 
Some
(
key
);

194 
	gtim”
.
ob£rve_du¿tiÚ
();

196 
Ët
 
E¼
(
e
èğ
»s
 {

197 
”rÜ
!("[»giÚ {}] faedØsÿÀ¥l™ key: {}", 
»giÚ_id
, 
e
);

201 
Ët
 
Some
(
¥l™_key
) = split_key {

202 
Ët
 
»giÚ_•och
 = 
»giÚ
.
g‘_»giÚ_•och
().
şÚe
();

203 
Ët
 
	g»s
 = 
£lf
.
ch


204 .
Œy_£nd
(
Ãw_¥l™_»giÚ
(
»giÚ_id
, 
»giÚ_•och
, 
¥l™_key
));

205 
Ët
 
E¼
(
e
èğ
»s
 {

206 
w¬n
!("[»giÚ {}] faedØ£nd check„esuÉ: {}", 
»giÚ_id
, 
e
);

209 
	gCHECK_SPILT_COUNTER_VEC


210 .
w™h_Ïb–_v®ues
(&["success"])

211 .
šc
();

213 
	gdebug
!(

215 
	g»giÚ_id
,

218 
	gCHECK_SPILT_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["ignÜe"]).
šc
();

223 
	gim¶
<
	gC
: 
S’d”
<
Msg
>> 
RuÂabË
<
Task
> 
RuÂ”
<
C
> {

224 
â
 
run
(&
mut
 
£lf
, 
sk
: 
Task
) {

225 
Ët
 
»giÚ
 = &
sk
.region;

226 
	g£lf
.
check_¥l™
(
»giÚ
);

230 
â
 
Ãw_¥l™_»giÚ
(
»giÚ_id
: 
u64
, 
•och
: 
RegiÚEpoch
, 
¥l™_key
: 
Vec
<
u8
>è-> 
Msg
 {

231 
Ët
 
key
 = 
keys
::
Üigš_key
(
¥l™_key
.
as_¦iû
()).
to_vec
();

232 
	gMsg
::
S¶™RegiÚ
 {

233 
»giÚ_id
:„egion_id,

234 
	g»giÚ_•och
: 
•och
,

235 
	g¥l™_key
: 
key
,

236 
	gÿÎback
: 
NÚe
,

	@src/server/config.rs

14 
u£
 
	g¡d
::
ascii
::
AsciiExt
;

16 
u£
 
	gsys_šfo
;

18 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

19 
u£
 
	gut
::
cÚfig
::{
£lf
, 
	gR—dabËSize
};

20 
u£
 
	gut
::
io_lim™”
::
DEFAULT_SNAP_MAX_BYTES_PER_SEC
;

21 
u£
 
	gsu³r
::
ResuÉ
;

23 
pub
 
u£
 
	g¿á¡Üe
::
¡Üe
::
CÚfig
 
as
 
RaáStÜeCÚfig
;

24 
pub
 
u£
 
	g¡Üage
::
CÚfig
 
as
 
StÜageCÚfig
;

26 
pub
 cÚ¡ 
	gDEFAULT_CLUSTER_ID
: 
u64
 = 0;

27 
pub
 cÚ¡ 
	gDEFAULT_LISTENING_ADDR
: &'static str = "127.0.0.1:20160";

28 cÚ¡ 
DEFAULT_ADVERTISE_LISTENING_ADDR
: &'static str = "";

29 cÚ¡ 
DEFAULT_NOTIFY_CAPACITY
: 
usize
 = 40960;

30 cÚ¡ 
	gDEFAULT_GRPC_CONCURRENCY
: 
usize
 = 4;

31 cÚ¡ 
	gDEFAULT_GRPC_CONCURRENT_STREAM
: 
usize
 = 1024;

32 cÚ¡ 
	gDEFAULT_GRPC_RAFT_CONN_NUM
: 
usize
 = 10;

33 cÚ¡ 
	gDEFAULT_GRPC_STREAM_INITIAL_WINDOW_SIZE
: 
u64
 = 2 * 1024 * 1024;

34 cÚ¡ 
	gDEFAULT_MESSAGES_PER_TICK
: 
usize
 = 4096;

37 cÚ¡ 
	gDEFAULT_ENDPOINT_STACK_SIZE_MB
: 
u64
 = 10;

43 
pub
 cÚ¡ 
	gDEFAULT_MAX_RUNNING_TASK_COUNT
: 
usize
 = 2 
as
 usize * 1000;

46 
pub
 cÚ¡ 
	gDEFAULT_ENDPOINT_BATCH_ROW_LIMIT
: 
usize
 = 64;

48 #[
d”ive
(
ClÚe
, 
Debug
, 
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
)]

49 #[
£rde
()]

50 #[
£rde
(
»Çme_®l
 = "kebab-case")]

51 
pub
 
	sCÚfig
 {

52 #[
£rde
(
sk
)]

53 
pub
 
	mşu¡”_id
: 
u64
,

56 
pub
 
	maddr
: 
SŒšg
,

60 
pub
 
	madv”ti£_addr
: 
SŒšg
,

61 
pub
 
	mnÙify_ÿ·c™y
: 
usize
,

62 
pub
 
	mmes§ges_³r_tick
: 
usize
,

63 
pub
 
	mg½c_cÚcu¼’cy
: 
usize
,

64 
pub
 
	mg½c_cÚcu¼’t_¡»am
: 
usize
,

65 
pub
 
	mg½c_¿á_cÚn_num
: 
usize
,

66 
pub
 
	mg½c_¡»am_š™Ÿl_wšdow_size
: 
R—dabËSize
,

67 
pub
 
	m’d_pošt_cÚcu¼’cy
: 
usize
,

68 
pub
 
	m’d_pošt_max_sks
: 
usize
,

69 
pub
 
	m’d_pošt_¡ack_size
: 
R—dabËSize
,

70 
pub
 
	m’d_pošt_»cursiÚ_lim™
: 
u32
,

71 
pub
 
	m’d_pošt_b©ch_row_lim™
: 
usize
,

72 
pub
 
	m¢­_max_wr™e_by‹s_³r_£c
: 
R—dabËSize
,

75 #[
£rde
(
w™h
 = "config::order_map_serde")]

76 
pub
 
	mÏb–s
: 
HashM­
<
SŒšg
, 
	mSŒšg
>,

79 
im¶
 
DeçuÉ
 
	gCÚfig
 {

80 
â
 (è-> 
	gCÚfig
 {

81 
Ët
 
	gıu_num
 = 
sys_šfo
::
ıu_num
().
unw¿p
();

82 
Ët
 
	gcÚcu¼’cy
 = 
ıu_num
 > 8 {

83 (
ıu_num
 
as
 
f64
 * 0.8èa 
usize


87 
	gCÚfig
 {

88 
	gşu¡”_id
: 
DEFAULT_CLUSTER_ID
,

89 
	gaddr
: 
DEFAULT_LISTENING_ADDR
.
to_owÃd
(),

90 
	gÏb–s
: 
HashM­
::(),

91 
	gadv”ti£_addr
: 
DEFAULT_ADVERTISE_LISTENING_ADDR
.
to_owÃd
(),

92 
	gnÙify_ÿ·c™y
: 
DEFAULT_NOTIFY_CAPACITY
,

93 
	gmes§ges_³r_tick
: 
DEFAULT_MESSAGES_PER_TICK
,

94 
	gg½c_cÚcu¼’cy
: 
DEFAULT_GRPC_CONCURRENCY
,

95 
	gg½c_cÚcu¼’t_¡»am
: 
DEFAULT_GRPC_CONCURRENT_STREAM
,

96 
	gg½c_¿á_cÚn_num
: 
DEFAULT_GRPC_RAFT_CONN_NUM
,

97 
	gg½c_¡»am_š™Ÿl_wšdow_size
: 
R—dabËSize
(
DEFAULT_GRPC_STREAM_INITIAL_WINDOW_SIZE
),

98 
	g’d_pošt_cÚcu¼’cy
: 
cÚcu¼’cy
,

99 
	g’d_pošt_max_sks
: 
DEFAULT_MAX_RUNNING_TASK_COUNT
,

100 
	g’d_pošt_¡ack_size
: 
R—dabËSize
::
mb
(
DEFAULT_ENDPOINT_STACK_SIZE_MB
),

101 
	g’d_pošt_»cursiÚ_lim™
: 1000,

102 
	g’d_pošt_b©ch_row_lim™
: 
DEFAULT_ENDPOINT_BATCH_ROW_LIMIT
,

103 
	g¢­_max_wr™e_by‹s_³r_£c
: 
R—dabËSize
(
DEFAULT_SNAP_MAX_BYTES_PER_SEC
),

108 
im¶
 
	gCÚfig
 {

109 
pub
 
â
 
v®id©e
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

110 
	gbox_Œy
!(
	gcÚfig
::
check_addr
(&
£lf
.
addr
));

111 !
	g£lf
.
	gadv”ti£_addr
.
is_em±y
() {

112 
	gbox_Œy
!(
	gcÚfig
::
check_addr
(&
£lf
.
adv”ti£_addr
));

114 
	gšfo
!("no‡dvertise-addr is specified, fall backo‡ddr.");

115 
	g£lf
.
	gadv”ti£_addr
 = 
£lf
.
addr
.
şÚe
();

117 
	g£lf
.
	gadv”ti£_addr
.
¡¬ts_w™h
("0.") {

118  
E¼
(
box_”r
!(

120 
£lf
.
adv”ti£_addr


124 
	g£lf
.
	g’d_pošt_cÚcu¼’cy
 == 0 {

125  
E¼
(
box_”r
!("server.end-point-concurrency should‚ot be 0."));

128 
	g£lf
.
	g’d_pošt_max_sks
 == 0 {

129  
E¼
(
box_”r
!("server.end-point-max-tasks should‚ot be 0."));

136 
	g£lf
.
	g’d_pošt_¡ack_size
.0 < 
	gR—dabËSize
::
mb
(2).0 {

137  
E¼
(
box_”r
!("server.end-point-stack-size isoo small."));

140 
	g£lf
.
	g’d_pošt_»cursiÚ_lim™
 < 100 {

141  
E¼
(
box_”r
!("server.end-point-recursion-limit isoo small"));

144 
	gk
, 
	gv
è
	gš
 &
	g£lf
.
	gÏb–s
 {

145 
v®id©e_Ïb–
(
k
, "key")?;

146 
v®id©e_Ïb–
(
v
, "value")?;

149 
Ok
(())

153 
â
 
v®id©e_Ïb–
(
s
: &
¡r
, 

: &¡rè-> 
ResuÉ
<()> {

154 
Ët
 
»pÜt_”r
 = || {

155 
box_”r
!(

157 

,

158 
s


161 
	gs
.
is_em±y
() {

162  
E¼
(
»pÜt_”r
());

164 
Ët
 
mut
 
	gchrs
 = 
s
.
ch¬s
();

165 
Ët
 
	gfœ¡_ch¬
 = 
chrs
.
Ãxt
().
unw¿p
();

166 !
	gfœ¡_ch¬
.
is_ascii_®phªum”ic
() {

167  
E¼
(
»pÜt_”r
());

169 
Ët
 
	gÏ¡_ch¬
 = 
m©ch
 
chrs
.
Ãxt_back
() {

170 
NÚe
 =>  
Ok
(()),

171 
Some
(
c
) => c,

173 !
	gÏ¡_ch¬
.
is_ascii_®phªum”ic
() {

174  
E¼
(
»pÜt_”r
());

176 
c
 
š
 
	gchrs
 {

177 !
	gc
.
is_ascii_®phªum”ic
(è&& !"-._".
cÚšs
(
c
) {

178  
E¼
(
»pÜt_”r
());

181 
Ok
(())

184 #[
cfg
(
‹¡
)]

185 
mod
 
	g‹¡s
 {

186 
u£
 
	gsu³r
::*;

188 #[
‹¡
]

189 
â
 
‹¡_cÚfig_v®id©e
() {

190 
Ët
 
mut
 
	gcfg
 = 
CÚfig
::();

191 
	gas£¹
!(
	gcfg
.
	gadv”ti£_addr
.
is_em±y
());

192 
	gcfg
.
v®id©e
().
unw¿p
();

193 
	gas£¹_eq
!(
	gcfg
.
	gaddr
, cfg.
	gadv”ti£_addr
);

195 
Ët
 
mut
 
	gšv®id_cfg
 = 
cfg
.
şÚe
();

196 
	gšv®id_cfg
.
	g’d_pošt_cÚcu¼’cy
 = 0;

197 
	gas£¹
!(
	gšv®id_cfg
.
v®id©e
().
is_”r
());

199 
Ët
 
mut
 
	gšv®id_cfg
 = 
cfg
.
şÚe
();

200 
	gšv®id_cfg
.
	g’d_pošt_¡ack_size
 = 
R—dabËSize
::
mb
(1);

201 
	gas£¹
!(
	gšv®id_cfg
.
v®id©e
().
is_”r
());

203 
Ët
 
mut
 
	gšv®id_cfg
 = 
cfg
.
şÚe
();

204 
	gšv®id_cfg
.
	g’d_pošt_max_sks
 = 0;

205 
	gas£¹
!(
	gšv®id_cfg
.
v®id©e
().
is_”r
());

207 
Ët
 
mut
 
	gšv®id_cfg
 = 
cfg
.
şÚe
();

208 
	gšv®id_cfg
.
	g’d_pošt_»cursiÚ_lim™
 = 0;

209 
	gas£¹
!(
	gšv®id_cfg
.
v®id©e
().
is_”r
());

211 
	gšv®id_cfg
 = 
CÚfig
::();

212 
	gšv®id_cfg
.
	gaddr
 = "0.0.0.0:1000".
to_owÃd
();

213 
	gas£¹
!(
	gšv®id_cfg
.
v®id©e
().
is_”r
());

214 
	gšv®id_cfg
.
	gadv”ti£_addr
 = "127.0.0.1:1000".
to_owÃd
();

215 
	gšv®id_cfg
.
v®id©e
().
unw¿p
();

217 
	gcfg
.
	gÏb–s
.
š£¹
("k1".
to_owÃd
(), "v1".to_owned());

218 
	gcfg
.
v®id©e
().
unw¿p
();

219 
	gcfg
.
	gÏb–s
.
š£¹
("k2".
to_owÃd
(), "v2?".to_owned());

220 
	gas£¹
!(
	gcfg
.
v®id©e
().
is_”r
());

223 #[
‹¡
]

224 
â
 
‹¡_¡Üe_Ïb–s
() {

225 
Ët
 
	gšv®id_ÿ£s
 = 
vec
!["", "123*", ".123", "ğŸ’–"];

227 
š
 
	gšv®id_ÿ£s
 {

228 
	gas£¹
!(
v®id©e_Ïb–
(, "dummy").
is_”r
());

231 
Ët
 
	gv®id_ÿ£s
 = 
vec
![

242 
š
 
	gv®id_ÿ£s
 {

243 
v®id©e_Ïb–
(, "dummy").
unw¿p
();

	@src/server/debug.rs

14 
u£
 
	g¡d
::{
”rÜ
, 
	g»suÉ
};

15 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

16 
u£
 
	g¡d
::
sync
::
Arc
;

18 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

20 
u£
 
	grocksdb
::{
Kv
, 
	gS“kKey
, 
	gWr™eB©ch
, 
	gWr™eO±iÚs
, 
	gDB
};

21 
u£
 
	gkv´Ùo
::
m‘­b
::
RegiÚ
;

22 
u£
 
	gkv´Ùo
::
kv½ıb
::{
LockInfo
, 
	gMvccInfo
, 
	gOp
, 
	gV®ueInfo
, 
	gWr™eInfo
};

23 
u£
 
	gkv´Ùo
::
debugpb
::
DB
 
as
 
DBTy³
;

24 
u£
 
	gkv´Ùo
::
”aápb
::
EÁry
;

25 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::*;

27 
u£
 
	g¿á¡Üe
::
¡Üe
::
wr™e_³”_¡©e
;

28 
u£
 
	g¿á¡Üe
::
¡Üe
::{
keys
, 
	gEngšes
, 
	gI‹¿bË
, 
	gP“kabË
};

29 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::
I‹rO±iÚ
;

30 
u£
 
	g¡Üage
::{
is_shÜt_v®ue
, 
	gCF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_RAFT
, 
	gCF_WRITE
};

31 
u£
 
	g¡Üage
::
ty³s
::{
Œunÿ‹_ts
, 
	gKey
};

32 
u£
 
	g¡Üage
::
mvcc
::{
Lock
, 
	gWr™e
, 
	gWr™eTy³
};

33 
u£
 
	gut
::
esÿ³
;

34 
u£
 
	gut
::
rocksdb
::{
com·ù_¿nge
, 
	gg‘_cf_hªdË
};

36 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

37 
ty³
 
	gDBI‹¿tÜ
 = ::
rocksdb
::
DBI‹¿tÜ
<
Arc
<
DB
>>;

39 
	gquick_”rÜ
!{

40 #[
d”ive
(
Debug
)]

41 
pub
 
	eE¼Ü
 {

42 
Inv®idArgum’t
(
msg
: 
SŒšg
) {

43 
desütiÚ
(
msg
)

44 
di¥Ïy
("Inv®id Argum’ˆ{:?}", 
msg
)

46 
NÙFound
(
msg
: 
SŒšg
) {

47 
desütiÚ
(
msg
)

48 
di¥Ïy
("NÙ Found {:?}", 
msg
)

50 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

51 
äom
()

52 
ÿu£
(
”r
.
as_»f
())

53 
desütiÚ
(
”r
.description())

54 
di¥Ïy
("{:?}", 
”r
)

59 #[
d”ive
(
P¬tŸlEq
, 
Debug
, 
DeçuÉ
)]

60 
pub
 
	sRegiÚInfo
 {

61 
pub
 
	m¿á_loÿl_¡©e
: 
O±iÚ
<
RaáLoÿlS‹
>,

62 
pub
 
	m¿á_­¶y_¡©e
: 
O±iÚ
<
RaáAµlyS‹
>,

63 
pub
 
	m»giÚ_loÿl_¡©e
: 
O±iÚ
<
RegiÚLoÿlS‹
>,

66 
im¶
 
	gRegiÚInfo
 {

67 
â
 
Ãw
(

68 
¿á_loÿl
: 
O±iÚ
<
RaáLoÿlS‹
>,

69 
¿á_­¶y
: 
O±iÚ
<
RaáAµlyS‹
>,

70 
»giÚ_loÿl
: 
O±iÚ
<
RegiÚLoÿlS‹
>,

71 è-> 
	gS–f
 {

72 
	gRegiÚInfo
 {

73 
	g¿á_loÿl_¡©e
: 
¿á_loÿl
,

74 
	g¿á_­¶y_¡©e
: 
¿á_­¶y
,

75 
	g»giÚ_loÿl_¡©e
: 
»giÚ_loÿl
,

80 #[
d”ive
(
ClÚe
)]

81 
pub
 
	sDebugg”
 {

82 
	m’gšes
: 
Engšes
,

85 
im¶
 
	gDebugg”
 {

86 
pub
 
â
 
Ãw
(
’gšes
: 
Engšes
è-> 
Debugg”
 {

87 
Debugg”
 { 
’gšes
 }

91 
pub
 
â
 
g‘_®l_m‘a_»giÚs
(&
£lf
è-> 
ResuÉ
<
Vec
<
u64
>> {

92 
Ët
 
db
 = &
£lf
.
’gšes
.
kv_’gše
;

93 
Ët
 
	gcf
 = 
CF_RAFT
;

94 
Ët
 
	g¡¬t_key
 = 
keys
::
REGION_META_MIN_KEY
;

95 
Ët
 
	g’d_key
 = 
keys
::
REGION_META_MAX_KEY
;

96 
Ët
 
mut
 
	g»giÚs
 = 
Vec
::
w™h_ÿ·c™y
(128);

97 
	gbox_Œy
!(
	gdb
.
sÿn_cf
(
cf
, 
¡¬t_key
, 
’d_key
, 
çl£
, &
mut
 |
key
, 
_
| {

98 
Ët
 (
id
, 
suffix
èğ
keys
::
decode_»giÚ_m‘a_key
(
key
)?;

99 
suffix
 !ğ
keys
::
REGION_STATE_SUFFIX
 {

100  
Ok
(
Œue
);

102 
»giÚs
.
push
(
id
);

103 
Ok
(
Œue
)

105 
Ok
(
»giÚs
)

108 
â
 
g‘_db_äom_ty³
(&
£lf
, 
db
: 
DBTy³
è-> 
ResuÉ
<&
DB
> {

109 
m©ch
 
db
 {

110 
DBTy³
::
KV
 => 
Ok
(&
£lf
.
’gšes
.
kv_’gše
),

111 
	gDBTy³
::
RAFT
 => 
Ok
(&
£lf
.
’gšes
.
¿á_’gše
),

112 
	g_
 => 
E¼
(
box_”r
!("invalid DBTypeype")),

116 
pub
 
â
 
g‘
(&
£lf
, 
db
: 
DBTy³
, 
cf
: &
¡r
, 
key
: &[
u8
]è-> 
ResuÉ
<
Vec
<u8>> {

117 
v®id©e_db_ªd_cf
(
db
, 
cf
)?;

118 
Ët
 
	gdb
 = 
£lf
.
g‘_db_äom_ty³
(
db
)?;

119 
m©ch
 
	gdb
.
g‘_v®ue_cf
(
cf
, 
key
) {

120 
Ok
(
Some
(
v
)è=> Ok(v.
to_vec
()),

121 
Ok
(
NÚe
è=> 
E¼
(
E¼Ü
::
NÙFound
(

122 
fÜm©
!("v®ufÜ key {:?} iÀdb {:?}", 
key
, 
db
),

124 
E¼
(
e
è=> E¼(
box_”r
!(e)),

128 
pub
 
â
 
¿á_log
(&
£lf
, 
»giÚ_id
: 
u64
, 
log_šdex
: u64è-> 
ResuÉ
<
EÁry
> {

129 
Ët
 
key
 = 
keys
::
¿á_log_key
(
»giÚ_id
, 
log_šdex
);

130 
m©ch
 
	g£lf
.
	g’gšes
.
	g¿á_’gše
.
g‘_msg
(&
key
) {

131 
Ok
(
Some
(
’Œy
)) => Ok(entry),

132 
Ok
(
NÚe
è=> 
E¼
(
E¼Ü
::
NÙFound
(
fÜm©
!(

134 
»giÚ_id
,

135 
log_šdex


137 
E¼
(
e
è=> E¼(
box_”r
!(e)),

141 
pub
 
â
 
»giÚ_šfo
(&
£lf
, 
»giÚ_id
: 
u64
è-> 
ResuÉ
<
RegiÚInfo
> {

142 
Ët
 
¿á_¡©e_key
 = 
keys
::¿á_¡©e_key(
»giÚ_id
);

143 
Ët
 
	g¿á_¡©e
 = 
box_Œy
!(

144 
£lf
.
’gšes


145 .
¿á_’gše


146 .
g‘_msg
::<
RaáLoÿlS‹
>(&
¿á_¡©e_key
)

149 
Ët
 
	g­¶y_¡©e_key
 = 
keys
::
­¶y_¡©e_key
(
»giÚ_id
);

150 
Ët
 
	g­¶y_¡©e
 = 
box_Œy
!(

151 
£lf
.
’gšes


152 .
kv_’gše


153 .
g‘_msg_cf
::<
RaáAµlyS‹
>(
CF_RAFT
, &
	g­¶y_¡©e_key
)

156 
Ët
 
	g»giÚ_¡©e_key
 = 
keys
::
»giÚ_¡©e_key
(
»giÚ_id
);

157 
Ët
 
	g»giÚ_¡©e
 = 
box_Œy
!(

158 
£lf
.
’gšes


159 .
kv_’gše


160 .
g‘_msg_cf
::<
RegiÚLoÿlS‹
>(
CF_RAFT
, &
	g»giÚ_¡©e_key
)

163 
m©ch
 (
¿á_¡©e
, 
­¶y_¡©e
, 
»giÚ_¡©e
) {

164 (
	gNÚe
, NÚe, NÚeè=> 
E¼
(
E¼Ü
::
NÙFound
(
fÜm©
!("šfØfÜ„egiÚ {}", 
»giÚ_id
))),

165 (
	g¿á_¡©e
, 
	g­¶y_¡©e
, 
	g»giÚ_¡©e
) => {

166 
Ok
(
RegiÚInfo
::
Ãw
(
¿á_¡©e
, 
­¶y_¡©e
, 
»giÚ_¡©e
))

171 
pub
 
â
 
	g»giÚ_size
<
	gT
: 
AsRef
<
¡r
>>(

172 &
£lf
,

173 
	g»giÚ_id
: 
u64
,

174 
	gcfs
: 
Vec
<
T
>,

175 è-> 
	gResuÉ
<
	gVec
<(
	gT
, 
	gusize
)>> {

176 
Ët
 
	g»giÚ_¡©e_key
 = 
keys
::
»giÚ_¡©e_key
(
»giÚ_id
);

177 
m©ch
 
	g£lf
.
	g’gšes


178 .
	gkv_’gše


179 .
	gg‘_msg_cf
::<
RegiÚLoÿlS‹
>(
CF_RAFT
, &
	g»giÚ_¡©e_key
)

181 
Ok
(
Some
(
»giÚ_¡©e
)) => {

182 
Ët
 
»giÚ
 = 
»giÚ_¡©e
.
g‘_»giÚ
();

183 
Ët
 
	g¡¬t_key
 = &
keys
::
d©a_key
(
»giÚ
.
g‘_¡¬t_key
());

184 
Ët
 
	g’d_key
 = &
keys
::
d©a_’d_key
(
»giÚ
.
g‘_’d_key
());

185 
Ët
 
mut
 
	gsizes
 = 
vec
![];

186 
cf
 
š
 
	gcfs
 {

187 
Ët
 
mut
 
	gsize
 = 0;

188 
	gbox_Œy
!(
	g£lf
.
	g’gšes
.
	gkv_’gše
.
sÿn_cf
(

189 
cf
.
as_»f
(),

190 
¡¬t_key
,

191 
’d_key
,

192 
çl£
,

193 &
mut
 |
_
, 
v
| {

194 
size
 +ğ
v
.
Ën
();

195 
Ok
(
Œue
)

198 
	gsizes
.
push
((
cf
, 
size
));

200 
Ok
(
sizes
)

202 
Ok
(
NÚe
è=> 
E¼
(
E¼Ü
::
NÙFound
(
fÜm©
!("nÚ»giÚ {:?}", 
»giÚ_id
))),

203 
E¼
(
e
è=> E¼(
box_”r
!(e)),

207 
pub
 
â
 
sÿn_mvcc
(&
£lf
, 
¡¬t
: &[
u8
], 
’d
: &[u8], 
lim™
: 
u64
è-> 
ResuÉ
<
MvccInfoI‹¿tÜ
> {

208 
’d
.
is_em±y
(è&& 
lim™
 == 0 {

209  
E¼
(
E¼Ü
::
Inv®idArgum’t
("nØlim™‡ndo_key".
to_owÃd
()));

211 
	gMvccInfoI‹¿tÜ
::
Ãw
(&
£lf
.
’gšes
.
kv_’gše
, 
¡¬t
, 
’d
, 
lim™
)

215 
pub
 
â
 
com·ù
(&
£lf
, 
db
: 
DBTy³
, 
cf
: &
¡r
, 
¡¬t
: &[
u8
], 
’d
: &[u8]è-> 
ResuÉ
<()> {

216 
v®id©e_db_ªd_cf
(
db
, 
cf
)?;

217 
Ët
 
	gdb
 = 
£lf
.
g‘_db_äom_ty³
(
db
)?;

218 
Ët
 
	ghªdË
 = 
box_Œy
!(
g‘_cf_hªdË
(
db
, 
cf
));

219 
Ët
 
	g¡¬t
 = 
¡¬t
.
is_em±y
(è{ 
NÚe
 } { 
Some
(start) };

220 
Ët
 
	g’d
 = 
’d
.
is_em±y
(è{ 
NÚe
 } { 
Some
(end) };

221 
com·ù_¿nge
(
db
, 
hªdË
, 
¡¬t
, 
’d
, 
çl£
);

222 
Ok
(())

227 
pub
 
â
 
£t_»giÚ_tomb¡Úe
(&
£lf
, 
id
: 
u64
, 
»giÚ
: 
RegiÚ
è-> 
ResuÉ
<()> {

228 
Ët
 
db
 = &
£lf
.
’gšes
.
kv_’gše
;

229 
Ët
 
	gkey
 = 
keys
::
»giÚ_¡©e_key
(
id
);

231 
Ët
 
	gŞd_»giÚ
 = 
box_Œy
!(
db
.
g‘_msg_cf
::<
RegiÚLoÿlS‹
>(
CF_RAFT
, &
	gkey
))

232 .
ok_Ü_–£
(|| 
E¼Ü
::
Oth”
("NÙ‡ v®id„egiÚ".
što
()))

233 .
m­
(|
mut
 
»giÚ_loÿl_¡©e
|„egiÚ_loÿl_¡©e.
ke_»giÚ
())?;

235 
Ët
 
	g¡Üe_id
 = 
£lf
.
g‘_¡Üe_id
()?;

236 
Ët
 
	g³”_id
 = 
Şd_»giÚ


237 .
g‘_³”s
()

238 .
™”
()

239 .
fšd
(|
p
|….
g‘_¡Üe_id
(è=ğ
¡Üe_id
)

240 .
m­
(|
p
|….
g‘_id
())

241 .
ok_Ü_–£
(|| {

242 
E¼Ü
::
Oth”
("RegiÚLoÿlS‹ dÛ¢'ˆcÚš th³” it£lf".
što
())

245 
Ët
 
	gÃw_cÚf_v”
 = 
»giÚ
.
g‘_»giÚ_•och
().
g‘_cÚf_v”
();

246 
Ët
 
	gŞd_cÚf_v”
 = 
Şd_»giÚ
.
g‘_»giÚ_•och
().
g‘_cÚf_v”
();

250 
Ët
 
	gscheduËd
 = 
»giÚ


251 .
g‘_³”s
()

252 .
™”
()

253 .
fšd
(|
p
|….
g‘_¡Üe_id
(è=ğ
¡Üe_id
)

254 .
m­_Ü
(
Œue
, |
p
|….
g‘_id
(è!ğ
³”_id
);

256 
	gÃw_cÚf_v”
 > 
	gŞd_cÚf_v”
 && 
	gscheduËd
 {

257 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

259 
	gbox_Œy
!(
wr™e_³”_¡©e
(
db
, &
wb
, &
Şd_»giÚ
, 
P“rS‹
::
Tomb¡Úe
));

260 
Ët
 
mut
 
	gwr™e_İts
 = 
Wr™eO±iÚs
::
Ãw
();

261 
	gwr™e_İts
.
£t_sync
(
Œue
);

262 
	gbox_Œy
!(
	gdb
.
wr™e_İt
(
wb
, &
wr™e_İts
));

263 
Ok
(())

265 
E¼
(
box_”r
!("The…eer is still inarget…eers"))

269 
â
 
g‘_¡Üe_id
(&
£lf
è-> 
	gResuÉ
<
	gu64
> {

270 
Ët
 
	gdb
 = &
£lf
.
’gšes
.
kv_’gše
;

271 
	gdb
.
	gg‘_msg
::<
StÜeId’t
>(&
keys
::
¡Üe_id’t_key
())

272 .
m­_”r
(|
e
| 
box_”r
!(e))

273 .
ªd_th’
(|
id’t
| 
m©ch
 ident {

274 
Some
(
id’t
è=> 
Ok
(id’t.
g‘_¡Üe_id
()),

275 
NÚe
 => 
E¼
(
E¼Ü
::
NÙFound
("NØ¡Üid’ˆkey".
to_owÃd
())),

280 
pub
 
	sMvccInfoI‹¿tÜ
 {

281 
	mlim™
: 
u64
,

282 
	mcouÁ
: 
u64
,

283 
	mlock_™”
: 
DBI‹¿tÜ
,

284 
	mdeçuÉ_™”
: 
DBI‹¿tÜ
,

285 
	mwr™e_™”
: 
DBI‹¿tÜ
,

288 
im¶
 
	gMvccInfoI‹¿tÜ
 {

289 
â
 
Ãw
(
db
: &
Arc
<
DB
>, 
äom
: &[
u8
], 
to
: &[u8], 
lim™
: 
u64
è-> 
ResuÉ
<
S–f
> {

290 !
keys
::
v®id©e_d©a_key
(
äom
) {

291  
E¼
(
E¼Ü
::
Inv®idArgum’t
(

292 
fÜm©
!("äom‚Ú-mvcø¬— {:?}", 
äom
),

296 
Ët
 
	gg’_™”
 = |
cf
: &
¡r
| -> 
ResuÉ
<
_
> {

297 
Ët
 
to
 = to.
is_em±y
(è{ 
NÚe
 } { 
Some
(to) };

298 
Ët
 
	g»adİts
 = 
I‹rO±iÚ
::
Ãw
(
to
.
m­
(
Vec
::
äom
), 
çl£
).
bud_»ad_İts
();

299 
Ët
 
	ghªdË
 = 
box_Œy
!(
g‘_cf_hªdË
(
db
.
as_»f
(), 
cf
));

300 
Ët
 
mut
 
	g™”
 = 
DBI‹¿tÜ
::
Ãw_cf
(
db
.
şÚe
(), 
hªdË
, 
»adİts
);

301 
	g™”
.
£ek
(
S“kKey
::
äom
(from));

302 
Ok
(
™”
)

304 
Ok
(
MvccInfoI‹¿tÜ
 {

305 
lim™
:†imit,

306 
couÁ
: 0,

307 
lock_™”
: 
g’_™”
(
CF_LOCK
)?,

308 
deçuÉ_™”
: 
g’_™”
(
CF_DEFAULT
)?,

309 
wr™e_™”
: 
g’_™”
(
CF_WRITE
)?,

313 
â
 
Ãxt_lock
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<(
	gVec
<
	gu8
>, 
	gLockInfo
)>> {

314 
Ët
 
mut
 
	g™”
 = &muˆ
£lf
.
lock_™”
;

315 
Ët
 
Some
((
key
, 
v®ue
)èğ<&
mut
 
DBI‹¿tÜ
 
as
 
I‹¿tÜ
>::
Ãxt
(&muˆ
™”
) {

316 
Ët
 
lock
 = 
box_Œy
!(
Lock
::
·r£
(&
v®ue
));

317 
Ët
 
mut
 
	glock_šfo
 = 
LockInfo
::();

318 
	glock_šfo
.
£t_´im¬y_lock
(
lock
.
´im¬y
);

319 
	glock_šfo
.
£t_lock_v”siÚ
(
lock
.
ts
);

320 
	glock_šfo
.
£t_lock_‰l
(
lock
.
‰l
);

321 
	glock_šfo
.
£t_key
(
key
.
şÚe
());

322  
Ok
(
Some
((
key
, 
lock_šfo
)));

324 
Ok
(
NÚe
)

327 
â
 
Ãxt_deçuÉ
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<(
	gVec
<
	gu8
>, 
	gR•—‹dF›ld
<
	gV®ueInfo
>)>> {

328 
Ët
 
Some
((
´efix
, 
vec_kv
)èğ
S–f
::
Ãxt_grou³d
(&
mut
 
£lf
.
deçuÉ_™”
) {

329 
Ët
 
mut
 
v®ues
 = 
Vec
::
w™h_ÿ·c™y
(
vec_kv
.
Ën
());

330 
	gkey
, 
	gv®ue
è
š
 
	gvec_kv
 {

331 
Ët
 
mut
 
	gv®ue_šfo
 = 
V®ueInfo
::();

332 
	gv®ue_šfo
.
£t_is_shÜt_v®ue
(
is_shÜt_v®ue
(&
v®ue
));

333 
	gv®ue_šfo
.
£t_v®ue
(
v®ue
);

334 
Ët
 
	g’coded_key
 = 
Key
::
äom_’coded
(
keys
::
Üigš_key
(&
key
).
to_owÃd
());

335 
	gv®ue_šfo
.
£t_ts
(
box_Œy
!(
’coded_key
.
decode_ts
()));

336 
	gv®ues
.
push
(
v®ue_šfo
);

338  
Ok
(
Some
((
´efix
, 
R•—‹dF›ld
::
äom_vec
(
v®ues
))));

340 
Ok
(
NÚe
)

343 
â
 
Ãxt_wr™e
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<(
	gVec
<
	gu8
>, 
	gR•—‹dF›ld
<
	gWr™eInfo
>)>> {

344 
Ët
 
Some
((
´efix
, 
vec_kv
)èğ
S–f
::
Ãxt_grou³d
(&
mut
 
£lf
.
wr™e_™”
) {

345 
Ët
 
mut
 
wr™es
 = 
Vec
::
w™h_ÿ·c™y
(
vec_kv
.
Ën
());

346 
	gkey
, 
	gv®ue
è
š
 
	gvec_kv
 {

347 
Ët
 
	gwr™e
 = 
box_Œy
!(
Wr™e
::
·r£
(&
v®ue
));

348 
Ët
 
mut
 
	gwr™e_šfo
 = 
Wr™eInfo
::();

349 
	gwr™e_šfo
.
£t_¡¬t_ts
(
wr™e
.
¡¬t_ts
);

350 
m©ch
 
	gwr™e
.
	gwr™e_ty³
 {

351 
	gWr™eTy³
::
Put
 => 
wr™e_šfo
.
£t_f›ld_ty³
(
Op
::Put),

352 
	gWr™eTy³
::
D–‘e
 => 
wr™e_šfo
.
£t_f›ld_ty³
(
Op
::
D–
),

353 
	gWr™eTy³
::
Lock
 => 
wr™e_šfo
.
£t_f›ld_ty³
(
Op
::Lock),

354 
	gWr™eTy³
::
RŞlback
 => 
wr™e_šfo
.
£t_f›ld_ty³
(
Op
::Rollback),

356 
Ët
 
	g’coded_key
 = 
Key
::
äom_’coded
(
keys
::
Üigš_key
(&
key
).
to_owÃd
());

357 
	gwr™e_šfo
.
£t_comm™_ts
(
box_Œy
!(
’coded_key
.
decode_ts
()));

358 
	gwr™es
.
push
(
wr™e_šfo
);

360  
Ok
(
Some
((
´efix
, 
R•—‹dF›ld
::
äom_vec
(
wr™es
))));

362 
Ok
(
NÚe
)

365 
â
 
Ãxt_grou³d
(
™”
: &
mut
 
DBI‹¿tÜ
è-> 
O±iÚ
<(
Vec
<
u8
>, 
	gVec
<
	gKv
>)> {

366 
	g™”
.
v®id
() {

367 
Ët
 
	g´efix
 = 
Œunÿ‹_ts
(
™”
.
key
()).
to_vec
();

368 
Ët
 
mut
 
	gkvs
 = 
vec
![(
™”
.
key
().
to_vec
(), i‹r.
v®ue
().to_vec())];

369 
	g™”
.
Ãxt
(è&& i‹r.
key
().
¡¬ts_w™h
(&
´efix
) {

370 
	gkvs
.
push
((
™”
.
key
().
to_vec
(), i‹r.
v®ue
().to_vec()));

372  
Some
((
´efix
, 
kvs
));

374 
	gNÚe


377 
â
 
Ãxt_™em
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gO±iÚ
<(
	gVec
<
	gu8
>, 
	gMvccInfo
)>> {

378 
	g£lf
.
	glim™
 !ğ0 && 
£lf
.
couÁ
 >ğ£lf.
lim™
 {

379  
Ok
(
NÚe
);

382 
Ët
 
mut
 
	gmvcc_šfo
 = 
MvccInfo
::
Ãw
();

383 
Ët
 
mut
 
	gmš_´efix
 = 
Vec
::
Ãw
();

385 
Ët
 (
lock_ok
, 
wr™es_ok
èğ
m©ch
 (
£lf
.
lock_™”
.
v®id
(), s–f.
wr™e_™”
.valid()) {

386 (
	gçl£
, f®£è=>  
Ok
(
NÚe
),

387 (
	gŒue
,rue) => {

388 
Ët
 
´efix1
 = 
£lf
.
lock_™”
.
key
();

389 
Ët
 
	g´efix2
 = 
Œunÿ‹_ts
(
£lf
.
wr™e_™”
.
key
());

390 
m©ch
 
	g´efix1
.
cmp
(
´efix2
) {

391 
	gOrd”šg
::
Less
 => (
Œue
, 
	gçl£
),

392 
	gOrd”šg
::
Equ®
 => (
Œue
, 
	gŒue
),

393 
	g_
 => (
çl£
, 
	gŒue
),

396 
	gv®id_·œ
 => 
v®id_·œ
,

399 
	glock_ok
 {

400 
Ët
 
Some
((
´efix
, 
lock
)èğ
£lf
.
Ãxt_lock
()? {

401 
mvcc_šfo
.
£t_lock
(
lock
);

402 
	gmš_´efix
 = 
´efix
;

405 
	gwr™es_ok
 {

406 
Ët
 
Some
((
´efix
, 
wr™es
)èğ
£lf
.
Ãxt_wr™e
()? {

407 
mvcc_šfo
.
£t_wr™es
(
wr™es
);

408 
	gmš_´efix
 = 
´efix
;

411 
	g£lf
.
	gdeçuÉ_™”
.
v®id
() {

412 
m©ch
 
Œunÿ‹_ts
(
£lf
.
deçuÉ_™”
.
key
()).
cmp
(&
mš_´efix
) {

413 
	gOrd”šg
::
Equ®
 => 
Ët
 
Some
((
_
, 
v®ues
)èğ
£lf
.
Ãxt_deçuÉ
()? {

414 
mvcc_šfo
.
£t_v®ues
(
v®ues
);

416 
	gOrd”šg
::
G»©”
 => {}

417 
_
 => {

418 
Ët
 
”r_msg
 = 
fÜm©
!(

420 
esÿ³
(&
mš_´efix
),

421 
esÿ³
(
Œunÿ‹_ts
(
£lf
.
deçuÉ_™”
.
key
()))

423  
E¼
(
box_”r
!(
”r_msg
));

427 
	g£lf
.
	gcouÁ
 += 1;

428 
Ok
(
Some
((
mš_´efix
, 
mvcc_šfo
)))

432 
im¶
 
I‹¿tÜ
 
	gMvccInfoI‹¿tÜ
 {

433 
ty³
 
	gI‹m
 = 
ResuÉ
<(
Vec
<
u8
>, 
	gMvccInfo
)>;

435 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gResuÉ
<(
	gVec
<
	gu8
>, 
	gMvccInfo
)>> {

436 
m©ch
 
	g£lf
.
Ãxt_™em
() {

437 
Ok
(
Some
(
™em
)) => Some(Ok(item)),

438 
Ok
(
NÚe
) => None,

439 
E¼
(
e
è=> 
Some
(Err(e)),

444 
pub
 
â
 
v®id©e_db_ªd_cf
(
db
: 
DBTy³
, 
cf
: &
¡r
è-> 
ResuÉ
<()> {

445 
m©ch
 (
db
, 
cf
) {

446 (
	gDBTy³
::
KV
, 
	gCF_DEFAULT
) |

447 (
	gDBTy³
::
KV
, 
	gCF_WRITE
) |

448 (
	gDBTy³
::
KV
, 
	gCF_LOCK
) |

449 (
	gDBTy³
::
KV
, 
	gCF_RAFT
) |

450 (
	gDBTy³
::
RAFT
, 
	gCF_DEFAULT
è=> 
Ok
(()),

451 
	g_
 => 
E¼
(
E¼Ü
::
Inv®idArgum’t
(

452 
fÜm©
!("šv®id cà{:?} fÜ db {:?}", 
cf
, 
db
),

457 #[
cfg
(
‹¡
)]

458 
mod
 
	g‹¡s
 {

459 
u£
 
	g¡d
::
sync
::
Arc
;

461 
u£
 
	grocksdb
::{
CŞumnFamyO±iÚs
, 
	gDBO±iÚs
, 
	gWr™abË
};

462 
u£
 
	gkv´Ùo
::
m‘­b
;

463 
u£
 
	gkv´Ùo
::
”aápb
::
EÁryTy³
;

464 
u£
 
	g‹mpdœ
::
TempDœ
;

466 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::
MubË
;

467 
u£
 
	g¡Üage
::{
CF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_RAFT
, 
	gCF_WRITE
};

468 
u£
 
	g¡Üage
::
mvcc
::{
Lock
, 
	gLockTy³
};

469 
u£
 
	gut
::
rocksdb
::{
£lf
 
as
 
rocksdb_ut
, 
	gCFO±iÚs
};

470 
u£
 
	gsu³r
::*;

472 #[
‹¡
]

473 
â
 
‹¡_v®id©e_db_ªd_cf
() {

474 
Ët
 
	gv®id_ÿ£s
 = 
vec
![

475 (
DBTy³
::
KV
, 
CF_DEFAULT
),

476 (
DBTy³
::
KV
, 
CF_WRITE
),

477 (
DBTy³
::
KV
, 
CF_LOCK
),

478 (
DBTy³
::
KV
, 
CF_RAFT
),

479 (
DBTy³
::
RAFT
, 
CF_DEFAULT
),

481 
	gdb
, 
	gcf
è
š
 
	gv®id_ÿ£s
 {

482 
v®id©e_db_ªd_cf
(
db
, 
cf
).
unw¿p
();

485 
Ët
 
	gšv®id_ÿ£s
 = 
vec
![

486 (
DBTy³
::
RAFT
, 
CF_WRITE
),

487 (
DBTy³
::
RAFT
, 
CF_LOCK
),

488 (
DBTy³
::
RAFT
, 
CF_RAFT
),

489 (
DBTy³
::
INVALID
, 
CF_DEFAULT
),

490 (
DBTy³
::
INVALID
, "BAD_CF"),

492 
	gdb
, 
	gcf
è
š
 
	gšv®id_ÿ£s
 {

493 
v®id©e_db_ªd_cf
(
db
, 
cf
).
unw¿p_”r
();

497 
â
 
Ãw_debugg”
(è-> 
	gDebugg”
 {

498 
Ët
 
	gtmp
 = 
TempDœ
::
Ãw
("‹¡_debug").
unw¿p
();

499 
Ët
 
	g·th
 = 
tmp
.
·th
().
to_¡r
().
unw¿p
();

500 
Ët
 
	g’gše
 = 
Arc
::
Ãw
(

501 
rocksdb_ut
::
Ãw_’gše_İt
(

502 
·th
,

503 
DBO±iÚs
::
Ãw
(),

504 
vec
![

505 
CFO±iÚs
::
Ãw
(
CF_DEFAULT
, 
CŞumnFamyO±iÚs
::new()),

506 
CFO±iÚs
::
Ãw
(
CF_WRITE
, 
CŞumnFamyO±iÚs
::new()),

507 
CFO±iÚs
::
Ãw
(
CF_LOCK
, 
CŞumnFamyO±iÚs
::new()),

508 
CFO±iÚs
::
Ãw
(
CF_RAFT
, 
CŞumnFamyO±iÚs
::new()),

510 ).
unw¿p
(),

513 
Ët
 
	g’gšes
 = 
Engšes
::
Ãw
(
’gše
.
şÚe
(),ƒngine);

514 
	gDebugg”
::
Ãw
(
’gšes
)

517 #[
‹¡
]

518 
â
 
‹¡_g‘
() {

519 
Ët
 
debugg”
 = 
Ãw_debugg”
();

520 
Ët
 
	g’gše
 = &
debugg”
.
’gšes
.
kv_’gše
;

521 
Ët
 (
k
, 
v
èğ(
b
"k", 
	gb
"v");

522 
	g’gše
.
put
(
k
, 
v
).
unw¿p
();

523 
	gas£¹_eq
!(&*
	g’gše
.
g‘
(
k
).
unw¿p
().unw¿p(), 
	gv
);

525 
Ët
 
	ggÙ
 = 
debugg”
.
g‘
(
DBTy³
::
KV
, 
CF_DEFAULT
, 
k
).
unw¿p
();

526 
	gas£¹_eq
!(&
	ggÙ
, 
	gv
);

528 
m©ch
 
	gdebugg”
.
g‘
(
DBTy³
::
KV
, 
CF_DEFAULT
, 
b
"foo") {

529 
E¼
(
E¼Ü
::
NÙFound
(
_
)) => (),

530 
	g_
 => 
·nic
!("expect Error::NotFound(_)"),

534 #[
‹¡
]

535 
â
 
‹¡_¿á_log
() {

536 
Ët
 
	gdebugg”
 = 
Ãw_debugg”
();

537 
Ët
 
	g’gše
 = &
debugg”
.
’gšes
.
¿á_’gše
;

538 
Ët
 (
»giÚ_id
, 
log_šdex
) = (1, 1);

539 
Ët
 
	gkey
 = 
keys
::
¿á_log_key
(
»giÚ_id
, 
log_šdex
);

540 
Ët
 
mut
 
	g’Œy
 = 
EÁry
::
Ãw
();

541 
	g’Œy
.
£t_‹rm
(1);

542 
	g’Œy
.
£t_šdex
(1);

543 
	g’Œy
.
£t_’Œy_ty³
(
EÁryTy³
::
EÁryNÜm®
);

544 
	g’Œy
.
£t_d©a
(
vec
![42]);

545 
	g’gše
.
put_msg
(
key
.
as_¦iû
(), &
’Œy
).
unw¿p
();

546 
	gas£¹_eq
!(

547 
	g’gše
.
	gg‘_msg
::<
EÁry
>(
key
.
as_¦iû
()).
unw¿p
().unwrap(),

548 
	g’Œy


551 
	gas£¹_eq
!(
	gdebugg”
.
¿á_log
(
»giÚ_id
, 
log_šdex
).
unw¿p
(), 
	g’Œy
);

552 
m©ch
 
	gdebugg”
.
¿á_log
(
»giÚ_id
 + 1, 
log_šdex
 + 1) {

553 
E¼
(
E¼Ü
::
NÙFound
(
_
)) => (),

554 
	g_
 => 
·nic
!("expect Error::NotFound(_)"),

558 #[
‹¡
]

559 
â
 
‹¡_»giÚ_šfo
() {

560 
Ët
 
	gdebugg”
 = 
Ãw_debugg”
();

561 
Ët
 
	g¿á_’gše
 = &
debugg”
.
’gšes
.
¿á_’gše
;

562 
Ët
 
	gkv_’gše
 = &
debugg”
.
’gšes
.
kv_’gše
;

563 
Ët
 
	g¿á_cf
 = 
kv_’gše
.
cf_hªdË
(
CF_RAFT
).
unw¿p
();

564 
Ët
 
	g»giÚ_id
 = 1;

566 
Ët
 
	g¿á_¡©e_key
 = 
keys
::
¿á_¡©e_key
(
»giÚ_id
);

567 
Ët
 
mut
 
	g¿á_¡©e
 = 
RaáLoÿlS‹
::
Ãw
();

568 
	g¿á_¡©e
.
£t_Ï¡_šdex
(42);

569 
	g¿á_’gše
.
put_msg
(&
¿á_¡©e_key
, &
¿á_¡©e
).
unw¿p
();

570 
	gas£¹_eq
!(

571 
	g¿á_’gše


572 .
	gg‘_msg
::<
RaáLoÿlS‹
>(&
¿á_¡©e_key
)

573 .
unw¿p
()

574 .
unw¿p
(),

575 
	g¿á_¡©e


578 
Ët
 
	g­¶y_¡©e_key
 = 
keys
::
­¶y_¡©e_key
(
»giÚ_id
);

579 
Ët
 
mut
 
	g­¶y_¡©e
 = 
RaáAµlyS‹
::
Ãw
();

580 
	g­¶y_¡©e
.
£t_­¶›d_šdex
(42);

581 
	gkv_’gše


582 .
put_msg_cf
(
¿á_cf
, &
­¶y_¡©e_key
, &
­¶y_¡©e
)

583 .
unw¿p
();

584 
	gas£¹_eq
!(

585 
	gkv_’gše


586 .
	gg‘_msg_cf
::<
RaáAµlyS‹
>(
CF_RAFT
, &
	g­¶y_¡©e_key
)

587 .
unw¿p
()

588 .
unw¿p
(),

589 
	g­¶y_¡©e


592 
Ët
 
	g»giÚ_¡©e_key
 = 
keys
::
»giÚ_¡©e_key
(
»giÚ_id
);

593 
Ët
 
mut
 
	g»giÚ_¡©e
 = 
RegiÚLoÿlS‹
::
Ãw
();

594 
	g»giÚ_¡©e
.
£t_¡©e
(
P“rS‹
::
Tomb¡Úe
);

595 
	gkv_’gše


596 .
put_msg_cf
(
¿á_cf
, &
»giÚ_¡©e_key
, &
»giÚ_¡©e
)

597 .
unw¿p
();

598 
	gas£¹_eq
!(

599 
	gkv_’gše


600 .
	gg‘_msg_cf
::<
RegiÚLoÿlS‹
>(
CF_RAFT
, &
	g»giÚ_¡©e_key
)

601 .
unw¿p
()

602 .
unw¿p
(),

603 
	g»giÚ_¡©e


606 
	gas£¹_eq
!(

607 
	gdebugg”
.
»giÚ_šfo
(
»giÚ_id
).
unw¿p
(),

608 
	gRegiÚInfo
::
Ãw
(
Some
(
¿á_¡©e
), Some(
­¶y_¡©e
), Some(
»giÚ_¡©e
))

610 
m©ch
 
	gdebugg”
.
»giÚ_šfo
(
»giÚ_id
 + 1) {

611 
E¼
(
E¼Ü
::
NÙFound
(
_
)) => (),

612 
	g_
 => 
·nic
!("expect Error::NotFound(_)"),

617 #[
‹¡
]

618 
â
 
‹¡_»giÚ_size
() {

619 
Ët
 
	gdebugg”
 = 
Ãw_debugg”
();

620 
Ët
 
	g’gše
 = &
debugg”
.
’gšes
.
kv_’gše
;

622 
Ët
 
	g»giÚ_id
 = 1;

623 
Ët
 
	g»giÚ_¡©e_key
 = 
keys
::
»giÚ_¡©e_key
(
»giÚ_id
);

624 
Ët
 
mut
 
	g»giÚ
 = 
m‘­b
::
RegiÚ
::
Ãw
();

625 
	g»giÚ
.
£t_id
(
»giÚ_id
);

626 
	g»giÚ
.
£t_¡¬t_key
(
b
"a".
to_vec
());

627 
	g»giÚ
.
£t_’d_key
(
b
"zz".
to_vec
());

628 
Ët
 
mut
 
	g¡©e
 = 
RegiÚLoÿlS‹
::
Ãw
();

629 
	g¡©e
.
£t_»giÚ
(
»giÚ
);

630 
Ët
 
	gcf_¿á
 = 
’gše
.
cf_hªdË
(
CF_RAFT
).
unw¿p
();

631 
	g’gše


632 .
put_msg_cf
(
cf_¿á
, &
»giÚ_¡©e_key
, &
¡©e
)

633 .
unw¿p
();

635 
Ët
 
	gcfs
 = 
vec
![
CF_DEFAULT
, 
CF_LOCK
, 
CF_RAFT
, 
CF_WRITE
];

636 
Ët
 (
k
, 
v
èğ(
keys
::
d©a_key
(
b
"k"), 
	gb
"v");

637 
cf
 
	gš
 &
	gcfs
 {

638 
Ët
 
	gcf_hªdË
 = 
’gše
.
cf_hªdË
(
cf
).
unw¿p
();

639 
	g’gše
.
put_cf
(
cf_hªdË
, 
k
.
as_¦iû
(), 
v
).
unw¿p
();

642 
Ët
 
	gsizes
 = 
debugg”
.
»giÚ_size
(
»giÚ_id
, 
cfs
.
şÚe
()).
unw¿p
();

643 
	gas£¹_eq
!(
	gsizes
.
Ën
(), 4);

644 
	gcf
, 
	gsize
è
š
 
	gsizes
 {

645 
	gcfs
.
™”
().
fšd
(|&&
c
| c =ğ
cf
).
unw¿p
();

646 
	gas£¹
!(
	gsize
 > 0);

650 #[
‹¡
]

651 
â
 
‹¡_sÿn_mvcc
() {

652 
Ët
 
	gdebugg”
 = 
Ãw_debugg”
();

653 
Ët
 
	g’gše
 = &
debugg”
.
’gšes
.
kv_’gše
;

655 
Ët
 
	gcf_deçuÉ_d©a
 = 
vec
![(
b
"k1", b"v", 5), (b"k2", b"x", 10), (b"k3", b"y", 15)];

656 &(
	g´efix
, 
	gv®ue
, 
	gts
è
	gš
 &
	gcf_deçuÉ_d©a
 {

657 
Ët
 
	g’coded_key
 = 
Key
::
äom_¿w
(
´efix
).
­³nd_ts
(
ts
);

658 
Ët
 
	gkey
 = 
keys
::
d©a_key
(
’coded_key
.
’coded
().
as_¦iû
());

659 
	g’gše
.
put
(
key
.
as_¦iû
(), 
v®ue
).
unw¿p
();

662 
Ët
 
	glock_cf
 = 
’gše
.
cf_hªdË
(
CF_LOCK
).
unw¿p
();

663 
Ët
 
	gcf_lock_d©a
 = 
vec
![

664 (
b
"k1", 
LockTy³
::
Put
, b"v", 5),

665 (
b
"k4", 
LockTy³
::
Lock
, b"x", 10),

666 (
b
"k5", 
LockTy³
::
D–‘e
, b"y", 15),

668 &(
	g´efix
, 
	g
, 
	gv®ue
, 
	gv”siÚ
è
	gš
 &
	gcf_lock_d©a
 {

669 
Ët
 
	g’coded_key
 = 
Key
::
äom_¿w
(
´efix
);

670 
Ët
 
	gkey
 = 
keys
::
d©a_key
(
’coded_key
.
’coded
().
as_¦iû
());

671 
Ët
 
	glock
 = 
Lock
::
Ãw
(

, 
v®ue
.
to_vec
(), 
v”siÚ
, 0, 
NÚe
);

672 
Ët
 
	gv®ue
 = 
lock
.
to_by‹s
();

673 
	g’gše


674 .
put_cf
(
lock_cf
, 
key
.
as_¦iû
(), 
v®ue
.as_slice())

675 .
unw¿p
();

678 
Ët
 
	gwr™e_cf
 = 
’gše
.
cf_hªdË
(
CF_WRITE
).
unw¿p
();

679 
Ët
 
	gcf_wr™e_d©a
 = 
vec
![

680 (
b
"k2", 
Wr™eTy³
::
Put
, 5, 10),

681 (
b
"k3", 
Wr™eTy³
::
Put
, 15, 20),

682 (
b
"k6", 
Wr™eTy³
::
Lock
, 25, 30),

683 (
b
"k7", 
Wr™eTy³
::
RŞlback
, 35, 40),

685 &(
	g´efix
, 
	g
, 
	g¡¬t_ts
, 
	gcomm™_ts
è
	gš
 &
	gcf_wr™e_d©a
 {

686 
Ët
 
	g’coded_key
 = 
Key
::
äom_¿w
(
´efix
).
­³nd_ts
(
comm™_ts
);

687 
Ët
 
	gkey
 = 
keys
::
d©a_key
(
’coded_key
.
’coded
().
as_¦iû
());

688 
Ët
 
	gwr™e
 = 
Wr™e
::
Ãw
(

, 
¡¬t_ts
, 
NÚe
);

689 
Ët
 
	gv®ue
 = 
wr™e
.
to_by‹s
();

690 
	g’gše


691 .
put_cf
(
wr™e_cf
, 
key
.
as_¦iû
(), 
v®ue
.as_slice())

692 .
unw¿p
();

695 
Ët
 
mut
 
	gcouÁ
 = 0;

696 
key_ªd_mvcc
 
š
 
	gdebugg”
.
sÿn_mvcc
(
b
"z", &[], 10).
unw¿p
() {

697 
	gas£¹
!(
	gkey_ªd_mvcc
.
is_ok
());

698 
	gcouÁ
 += 1;

700 
	gas£¹_eq
!(
	gcouÁ
, 7);

	@src/server/errors.rs

14 
u£
 
	g¡d
::
”rÜ
;

15 
u£
 
	g¡d
::
»suÉ
;

16 
u£
 
	g¡d
::
io
::
E¼Ü
 
as
 
IoE¼Ü
;

17 
u£
 
	g¡d
::
Ãt
::
AddrP¬£E¼Ü
;

19 
u£
 
	gfutu»s
::
CªûËd
;

20 
u£
 
	g´Ùobuf
::
PrÙobufE¼Ü
;

21 
u£
 
	gg½c
::
E¼Ü
 
as
 
G½cE¼Ü
;

23 
u£
 
	gut
::
codec
::
E¼Ü
 
as
 
CodecE¼Ü
;

24 
u£
 
	gut
::
wÜk”
::
Stİ³d
;

25 
u£
 
	g¿á¡Üe
::
E¼Ü
 
as
 
RaáS”v”E¼Ü
;

26 
u£
 
	g¡Üage
::
’gše
::
E¼Ü
 
as
 
EngšeE¼Ü
;

27 
u£
 
	g¡Üage
::
E¼Ü
 
as
 
StÜageE¼Ü
;

28 
u£
 
	gpd
::
E¼Ü
 
as
 
PdE¼Ü
;

29 
u£
 
	gsu³r
::
¢­
::
Task
 
as
 
SÇpTask
;

30 
u£
 
	gcİroûssÜ
::
EndPoštTask
;

32 
	gquick_”rÜ
!{

33 #[
d”ive
(
Debug
)]

34 
pub
 
	eE¼Ü
 {

35 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

36 
äom
()

37 
ÿu£
(
”r
.
as_»f
())

38 
desütiÚ
(
”r
.description())

39 
di¥Ïy
("{:?}", 
”r
)

42 
Io
(
”r
: 
IoE¼Ü
) {

43 
äom
()

44 
ÿu£
(
”r
)

45 
di¥Ïy
("{:?}", 
”r
)

46 
desütiÚ
(
”r
.description())

48 
PrÙobuf
(
”r
: 
PrÙobufE¼Ü
) {

49 
äom
()

50 
ÿu£
(
”r
)

51 
desütiÚ
(
”r
.description())

53 
G½c
(
”r
: 
G½cE¼Ü
) {

54 
äom
()

55 
ÿu£
(
”r
)

56 
di¥Ïy
("{:?}", 
”r
)

57 
desütiÚ
(
”r
.description())

59 
Codec
(
”r
: 
CodecE¼Ü
) {

60 
äom
()

61 
ÿu£
(
”r
)

62 
di¥Ïy
("{:?}", 
”r
)

63 
desütiÚ
(
”r
.description())

65 
AddrP¬£
(
”r
: 
AddrP¬£E¼Ü
) {

66 
äom
()

67 
ÿu£
(
”r
)

68 
di¥Ïy
("{:?}", 
”r
)

69 
desütiÚ
(
”r
.description())

71 
RaáS”v”
(
”r
: 
RaáS”v”E¼Ü
) {

72 
äom
()

73 
ÿu£
(
”r
)

74 
di¥Ïy
("{:?}", 
”r
)

75 
desütiÚ
(
”r
.description())

77 
Engše
(
”r
: 
EngšeE¼Ü
) {

78 
äom
()

79 
ÿu£
(
”r
)

80 
di¥Ïy
("{:?}", 
”r
)

81 
desütiÚ
(
”r
.description())

83 
StÜage
(
”r
: 
StÜageE¼Ü
) {

84 
äom
()

85 
ÿu£
(
”r
)

86 
di¥Ïy
("{:?}", 
”r
)

87 
desütiÚ
(
”r
.description())

89 
Pd
(
”r
: 
PdE¼Ü
) {

90 
äom
()

91 
ÿu£
(
”r
)

92 
di¥Ïy
("{:?}", 
”r
)

93 
desütiÚ
(
”r
.description())

95 
SÇpWÜk”Stİ³d
(
”r
: 
Stİ³d
<
SÇpTask
>) {

96 
äom
()

97 
di¥Ïy
("{:?}", 
”r
)

99 
EndPoštStİ³d
(
”r
: 
Stİ³d
<
EndPoštTask
>) {

100 
äom
()

101 
di¥Ïy
("{:?}", 
”r
)

103 
	gSšk
 {

104 
desütiÚ
("failedo…oll from mpsc„eceiver")

106 
CªûËd
(
”r
: Canceled) {

107 
äom
()

108 
ÿu£
(
”r
)

109 
di¥Ïy
("{:?}", 
”r
)

110 
desütiÚ
(
”r
.description())

116 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

	@src/server/metrics.rs

14 
u£
 
	g´om‘heus
::*;

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gSEND_SNAP_HISTOGRAM
: 
Hi¡og¿m
 =

18 
»gi¡”_hi¡og¿m
!(

21 ).
unw¿p
();

23 
pub
 
»f
 
	gSNAP_TASK_COUNTER
: 
CouÁ”Vec
 =

24 
»gi¡”_couÁ”_vec
!(

28 ).
unw¿p
();

30 
pub
 
»f
 
	gGRPC_MSG_HISTOGRAM_VEC
: 
Hi¡og¿mVec
 =

31 
»gi¡”_hi¡og¿m_vec
!(

35 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

36 ).
unw¿p
();

38 
pub
 
»f
 
	gGRPC_MSG_FAIL_COUNTER
: 
CouÁ”Vec
 =

39 
»gi¡”_couÁ”_vec
!(

43 ).
unw¿p
();

45 
pub
 
»f
 
	gRAFT_MESSAGE_RECV_COUNTER
: 
CouÁ”
 =

46 
»gi¡”_couÁ”
!(

49 ).
unw¿p
();

51 
pub
 
»f
 
	gRESOLVE_STORE_COUNTER
: 
CouÁ”Vec
 =

52 
»gi¡”_couÁ”_vec
!(

56 ).
unw¿p
();

58 
pub
 
»f
 
	gREPORT_FAILURE_MSG_COUNTER
: 
CouÁ”Vec
 =

59 
»gi¡”_couÁ”_vec
!(

63 ).
unw¿p
();

	@src/server/mod.rs

14 
u£
 
	g¡d
::
boxed
::
FnBox
;

15 
u£
 
	gkv´Ùo
::
cİroûssÜ
::
Re¥Ú£
;

16 
mod
 
	gm‘rics
;

17 
mod
 
	g£rviû
;

18 
mod
 
	g¿á_ş›Á
;

20 
pub
 
mod
 
	gcÚfig
;

21 
pub
 
mod
 
	g”rÜs
;

22 
pub
 
mod
 
	g£rv”
;

23 
pub
 
mod
 
	gŒª¥Üt
;

24 
pub
 
mod
 
	gnode
;

25 
pub
 
mod
 
	g»sŞve
;

26 
pub
 
mod
 
	g¢­
;

27 
pub
 
mod
 
	gdebug
;

29 
pub
 
u£
 
	g£lf
::
cÚfig
::{
CÚfig
, 
	gDEFAULT_CLUSTER_ID
, 
	gDEFAULT_LISTENING_ADDR
};

30 
pub
 
u£
 
	g£lf
::
”rÜs
::{
E¼Ü
, 
	gResuÉ
};

31 
pub
 
u£
 
	g£lf
::
£rv”
::
S”v”
;

32 
pub
 
u£
 
	g£lf
::
Œª¥Üt
::{
S”v”RaáStÜeRou‹r
, 
	gS”v”T¿n¥Üt
};

33 
pub
 
u£
 
	g£lf
::
node
::{
ü—‹_¿á_¡Üage
, 
	gNode
};

34 
pub
 
u£
 
	g£lf
::
»sŞve
::{
PdStÜeAddrResŞv”
, 
	gStÜeAddrResŞv”
};

35 
pub
 
u£
 
	g£lf
::
¿á_ş›Á
::
RaáCl›Á
;

37 
pub
 
ty³
 
	gOnRe¥Ú£
 = 
Box
<
FnBox
(
Re¥Ú£
è+ 
S’d
>;

	@src/server/node.rs

14 
u£
 
	g¡d
::
th»ad
;

15 
u£
 
	g¡d
::
sync
::{
mpsc
, 
	gArc
};

16 
u£
 
	g¡d
::
sync
::
mpsc
::
Reûiv”
;

17 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

18 
u£
 
	g¡d
::
´oûss
;

20 
u£
 
	gmio
::
Ev’tLoİ
;

21 
u£
 
	grocksdb
::
DB
;

23 
u£
 
	gpd
::{
E¼Ü
 
as
 
PdE¼Ü
, 
	gPdCl›Á
, 
	gPdTask
, 
	gINVALID_ID
};

24 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
StÜeId’t
;

25 
u£
 
	gkv´Ùo
::
m‘­b
;

26 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

27 
u£
 
	gut
::
Œª¥Üt
::
S’dCh
;

28 
u£
 
	gut
::
wÜk”
::
Futu»WÜk”
;

29 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::
di¥©ch”
::
CİroûssÜHo¡
;

30 
u£
 
	g¿á¡Üe
::
¡Üe
::{
£lf
, 
	gkeys
, 
CÚfig
 
as
 
	gStÜeCÚfig
, 
	gEngšes
, 
	gMsg
, 
	gP“kabË
, 
	gSignifiÿÁMsg
,

31 
	gSÇpMªag”
, 
	gStÜe
, 
	gStÜeChªÃl
, 
	gT¿n¥Üt
};

32 
u£
 
	gsu³r
::
ResuÉ
;

33 
u£
 
	g£rv”
::
CÚfig
 
as
 
S”v”CÚfig
;

34 
u£
 
	g¡Üage
::{
CÚfig
 
as
 
StÜageCÚfig
, 
	gRaáKv
, 
	gStÜage
};

35 
u£
 
	gsu³r
::
Œª¥Üt
::
RaáStÜeRou‹r
;

37 cÚ¡ 
	gMAX_CHECK_CLUSTER_BOOTSTRAPPED_RETRY_COUNT
: 
u64
 = 60;

38 cÚ¡ 
	gCHECK_CLUSTER_BOOTSTRAPPED_RETRY_SECONDS
: 
u64
 = 3;

40 
pub
 
â
 
	gü—‹_¿á_¡Üage
<
	gS
>(
	grou‹r
: 
S
, 
	gdb
: 
Arc
<
DB
>, 
	gcfg
: &
StÜageCÚfig
è-> 
ResuÉ
<
StÜage
>

41 
wh”e


42 
S
: 
RaáStÜeRou‹r
 + 'static,

44 
Ët
 
’gše
 = 
box
 
RaáKv
::
Ãw
(
db
, 
rou‹r
);

45 
Ët
 
	g¡Üe
 = 
StÜage
::
äom_’gše
(
’gše
, 
cfg
)?;

46 
Ok
(
¡Üe
)

49 
â
 
check_»giÚ_•och
(
»giÚ
: &
m‘­b
::
RegiÚ
, 
Ùh”
: &m‘­b::RegiÚè-> 
ResuÉ
<()> {

50 
Ët
 
•och
 = 
»giÚ
.
g‘_»giÚ_•och
();

51 
Ët
 
	gÙh”_•och
 = 
Ùh”
.
g‘_»giÚ_•och
();

52 
	g•och
.
g‘_cÚf_v”
(è!ğ
Ùh”_•och
.get_conf_ver() {

53  
E¼
(
box_”r
!(

55 
•och
.
g‘_cÚf_v”
(),

56 
Ùh”_•och
.
g‘_cÚf_v”
()

59 
	g•och
.
g‘_v”siÚ
(è!ğ
Ùh”_•och
.get_version() {

60  
E¼
(
box_”r
!(

62 
•och
.
g‘_v”siÚ
(),

63 
Ùh”_•och
.
g‘_v”siÚ
()

66 
Ok
(())

71 
pub
 
	gNode
<
	gC
: 
PdCl›Á
 + 'static> {

72 
şu¡”_id
: 
u64
,

73 
	g¡Üe
: 
m‘­b
::
StÜe
,

74 
	g¡Üe_cfg
: 
StÜeCÚfig
,

75 
	g¡Üe_hªdË
: 
O±iÚ
<
th»ad
::
JošHªdË
<()>>,

76 
	gch
: 
S’dCh
<
Msg
>,

78 
	gpd_ş›Á
: 
Arc
<
C
>,

81 
	gim¶
<
	gC
> 
	gNode
<C>

82 
wh”e


83 
	gC
: 
PdCl›Á
,

85 
pub
 
â
 
	gÃw
<
	gT
>(

86 
	gev’t_loİ
: &
mut
 
Ev’tLoİ
<
StÜe
<
T
, 
	gC
>>,

87 
	gcfg
: &
S”v”CÚfig
,

88 
	g¡Üe_cfg
: &
StÜeCÚfig
,

89 
	gpd_ş›Á
: 
Arc
<
C
>,

90 è-> 
	gNode
<
	gC
>

91 
wh”e


92 
	gT
: 
T¿n¥Üt
 + 'static,

94 
Ët
 
mut
 
¡Üe
 = 
m‘­b
::
StÜe
::
Ãw
();

95 
	g¡Üe
.
£t_id
(
INVALID_ID
);

96 
	gcfg
.
	gadv”ti£_addr
.
is_em±y
() {

97 
	g¡Üe
.
£t_add»ss
(
cfg
.
addr
.
şÚe
());

99 
	g¡Üe
.
£t_add»ss
(
cfg
.
adv”ti£_addr
.
şÚe
())

102 
Ët
 
mut
 
	gÏb–s
 = 
Vec
::
Ãw
();

103 
	gk
, 
	gv
è
	gš
 &
	gcfg
.
	gÏb–s
 {

104 
Ët
 
mut
 
	gÏb–
 = 
m‘­b
::
StÜeLab–
::
Ãw
();

105 
	gÏb–
.
£t_key
(
k
.
to_owÃd
());

106 
	gÏb–
.
£t_v®ue
(
v
.
to_owÃd
());

107 
	gÏb–s
.
push
(
Ïb–
);

109 
	g¡Üe
.
£t_Ïb–s
(
R•—‹dF›ld
::
äom_vec
(
Ïb–s
));

111 
Ët
 
	gch
 = 
S’dCh
::
Ãw
(
ev’t_loİ
.
chªÃl
(), "raftstore");

112 
	gNode
 {

113 
	gşu¡”_id
: 
cfg
.
şu¡”_id
,

114 
	g¡Üe
: 
¡Üe
,

115 
	g¡Üe_cfg
: 
¡Üe_cfg
.
şÚe
(),

116 
	g¡Üe_hªdË
: 
NÚe
,

117 
	gpd_ş›Á
: 
pd_ş›Á
,

118 
	gch
: 
ch
,

122 #[
®low
(
too_mªy_¬gum’ts
)]

123 
pub
 
â
 
	g¡¬t
<
	gT
>(

124 &
mut
 
	g£lf
,

125 
	gev’t_loİ
: 
Ev’tLoİ
<
StÜe
<
T
, 
	gC
>>,

126 
	g’gšes
: 
Engšes
,

127 
	gŒªs
: 
T
,

128 
	g¢­_mgr
: 
SÇpMªag”
,

129 
	gsignifiÿÁ_msg_»ûiv”
: 
Reûiv”
<
SignifiÿÁMsg
>,

130 
	gpd_wÜk”
: 
Futu»WÜk”
<
PdTask
>,

131 
	gcİroûssÜ_ho¡
: 
CİroûssÜHo¡
,

132 è-> 
	gResuÉ
<()>

133 
wh”e


134 
	gT
: 
T¿n¥Üt
 + 'static,

136 
Ët
 
boÙ¡¿µed
 = 
£lf
.
check_şu¡”_boÙ¡¿µed
()?;

137 
Ët
 
mut
 
	g¡Üe_id
 = 
£lf
.
check_¡Üe
(&
’gšes
)?;

138 
	g¡Üe_id
 =ğ
INVALID_ID
 {

139 
¡Üe_id
 = 
£lf
.
boÙ¡¿p_¡Üe
(&
’gšes
)?;

140 } !
	gboÙ¡¿µed
 {

142  
E¼
(
box_”r
!(

146 
¡Üe_id
,

147 
£lf
.
şu¡”_id


151 
	g£lf
.
	g¡Üe
.
£t_id
(
¡Üe_id
);

152 
	g£lf
.
check_´•¬e_boÙ¡¿p_şu¡”
(&
’gšes
)?;

153 !
	gboÙ¡¿µed
 {

156 
Ët
 
	g»giÚ
 = 
£lf
.
´•¬e_boÙ¡¿p_şu¡”
(&
’gšes
, 
¡Üe_id
)?;

157 
	g£lf
.
boÙ¡¿p_şu¡”
(&
’gšes
, 
»giÚ
)?;

161 
	g£lf
.
	gpd_ş›Á
.
put_¡Üe
(
£lf
.
¡Üe
.
şÚe
())?;

162 
	g£lf
.
¡¬t_¡Üe
(

163 
ev’t_loİ
,

164 
¡Üe_id
,

165 
’gšes
,

166 
Œªs
,

167 
¢­_mgr
,

168 
signifiÿÁ_msg_»ûiv”
,

169 
pd_wÜk”
,

170 
cİroûssÜ_ho¡
,

172 
Ok
(())

175 
pub
 
â
 
id
(&
£lf
è-> 
	gu64
 {

176 
	g£lf
.
	g¡Üe
.
g‘_id
()

179 
pub
 
â
 
g‘_£ndch
(&
£lf
è-> 
	gS’dCh
<
	gMsg
> {

180 
	g£lf
.
	gch
.
şÚe
()

185 
â
 
check_¡Üe
(&
£lf
, 
’gšes
: &
Engšes
è-> 
ResuÉ
<
u64
> {

186 
Ët
 
»s
 = 
’gšes


187 .
kv_’gše


188 .
g‘_msg
::<
StÜeId’t
>(&
keys
::
¡Üe_id’t_key
())?;

189 
	g»s
.
is_nÚe
() {

190  
Ok
(
INVALID_ID
);

193 
Ët
 
	gid’t
 = 
»s
.
unw¿p
();

194 
	gid’t
.
g‘_şu¡”_id
(è!ğ
£lf
.
şu¡”_id
 {

195 
”rÜ
!(

198 
id’t
.
g‘_şu¡”_id
(),

199 
£lf
.
şu¡”_id


201 
	g´oûss
::
ex™
(1);

204 
Ët
 
	g¡Üe_id
 = 
id’t
.
g‘_¡Üe_id
();

205 
	g¡Üe_id
 =ğ
INVALID_ID
 {

206  
E¼
(
box_”r
!("šv®id stÜid’ˆ{:?}", 
id’t
));

209 
Ok
(
¡Üe_id
)

212 
â
 
®loc_id
(&
£lf
è-> 
	gResuÉ
<
	gu64
> {

213 
Ët
 
	gid
 = 
£lf
.
pd_ş›Á
.
®loc_id
()?;

214 
Ok
(
id
)

217 
â
 
boÙ¡¿p_¡Üe
(&
£lf
, 
’gšes
: &
Engšes
è-> 
ResuÉ
<
u64
> {

218 
Ët
 
¡Üe_id
 = 
£lf
.
®loc_id
()?;

219 
	gšfo
!("®loø¡Üid {} ", 
	g¡Üe_id
);

221 
	g¡Üe
::
boÙ¡¿p_¡Üe
(
’gšes
, 
£lf
.
şu¡”_id
, 
¡Üe_id
)?;

223 
Ok
(
¡Üe_id
)

226 
pub
 
â
 
´•¬e_boÙ¡¿p_şu¡”
(

227 &
£lf
,

228 
’gšes
: &
Engšes
,

229 
¡Üe_id
: 
u64
,

230 è-> 
	gResuÉ
<
	gm‘­b
::
RegiÚ
> {

231 
Ët
 
»giÚ_id
 = 
£lf
.
®loc_id
()?;

232 
	gšfo
!(

234 
	g»giÚ_id
,

235 
	g£lf
.
	gşu¡”_id
,

236 
	g¡Üe_id


238 
Ët
 
	g³”_id
 = 
£lf
.
®loc_id
()?;

239 
	gšfo
!(

241 
	g³”_id
,

242 
	g»giÚ_id


245 
Ët
 
	g»giÚ
 = 
¡Üe
::
´•¬e_boÙ¡¿p
(
’gšes
, 
¡Üe_id
, 
»giÚ_id
, 
³”_id
)?;

246 
Ok
(
»giÚ
)

249 
â
 
check_´•¬e_boÙ¡¿p_şu¡”
(&
£lf
, 
’gšes
: &
Engšes
è-> 
ResuÉ
<()> {

250 
Ët
 
»s
 = 
’gšes


251 .
kv_’gše


252 .
g‘_msg
::<
m‘­b
::
RegiÚ
>(&
keys
::
´•¬e_boÙ¡¿p_key
())?;

253 
	g»s
.
is_nÚe
() {

254  
Ok
(());

257 
Ët
 
	gfœ¡_»giÚ
 = 
»s
.
unw¿p
();

258 
_
 
	gš
 0..
	gMAX_CHECK_CLUSTER_BOOTSTRAPPED_RETRY_COUNT
 {

259 
m©ch
 
	g£lf
.
	gpd_ş›Á
.
g‘_»giÚ
(
b
"") {

260 
Ok
(
»giÚ
) => {

261 
»giÚ
.
g‘_id
(è=ğ
fœ¡_»giÚ
.get_id() {

262 
check_»giÚ_•och
(&
»giÚ
, &
fœ¡_»giÚ
)?;

263 
	g¡Üe
::
ş—r_´•¬e_boÙ¡¿p_¡©e
(
’gšes
)?;

265 
	g¡Üe
::
ş—r_´•¬e_boÙ¡¿p
(
’gšes
, 
fœ¡_»giÚ
.
g‘_id
())?;

267  
Ok
(());

270 
E¼
(
e
) => {

271 
w¬n
!("check clu¡”…»·» boÙ¡¿µed faed: {:?}", 
e
);

274 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_£cs
(

275 
CHECK_CLUSTER_BOOTSTRAPPED_RETRY_SECONDS
,

278 
E¼
(
box_”r
!("check cluster…repare bootstrapped failed"))

281 
â
 
boÙ¡¿p_şu¡”
(&
mut
 
£lf
, 
’gšes
: &
Engšes
, 
»giÚ
: 
m‘­b
::
RegiÚ
è-> 
ResuÉ
<()> {

282 
Ët
 
»giÚ_id
 = 
»giÚ
.
g‘_id
();

283 
m©ch
 
	g£lf
.
	gpd_ş›Á
.
boÙ¡¿p_şu¡”
(
£lf
.
¡Üe
.
şÚe
(), 
»giÚ
) {

284 
E¼
(
PdE¼Ü
::
Clu¡”BoÙ¡¿µed
(
_
)) => {

285 
”rÜ
!("şu¡” {} i ®»ady boÙ¡¿µed", 
£lf
.
şu¡”_id
);

286 
	g¡Üe
::
ş—r_´•¬e_boÙ¡¿p
(
’gšes
, 
»giÚ_id
)?;

287 
Ok
(())

290 
E¼
(
e
è=> 
·nic
!("boÙ¡¿°şu¡” {}ƒ¼: {:?}", 
	g£lf
.
	gşu¡”_id
, 
	ge
),

291 
Ok
(
_
) => {

292 
¡Üe
::
ş—r_´•¬e_boÙ¡¿p_¡©e
(
’gšes
)?;

293 
	gšfo
!("boÙ¡¿°şu¡” {} ok", 
	g£lf
.
	gşu¡”_id
);

294 
Ok
(())

299 
â
 
check_şu¡”_boÙ¡¿µed
(&
£lf
è-> 
	gResuÉ
<
	gboŞ
> {

300 
_
 
	gš
 0..
	gMAX_CHECK_CLUSTER_BOOTSTRAPPED_RETRY_COUNT
 {

301 
m©ch
 
	g£lf
.
	gpd_ş›Á
.
is_şu¡”_boÙ¡¿µed
() {

302 
Ok
(
b
) =>  Ok(b),

303 
E¼
(
e
) => {

304 
w¬n
!("check clu¡” boÙ¡¿µed faed: {:?}", 
e
);

307 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_£cs
(

308 
CHECK_CLUSTER_BOOTSTRAPPED_RETRY_SECONDS
,

311 
E¼
(
box_”r
!("check cluster bootstrapped failed"))

314 #[
®low
(
too_mªy_¬gum’ts
)]

315 
â
 
	g¡¬t_¡Üe
<
	gT
>(

316 &
mut
 
	g£lf
,

317 
mut
 
	gev’t_loİ
: 
Ev’tLoİ
<
StÜe
<
T
, 
	gC
>>,

318 
	g¡Üe_id
: 
u64
,

319 
	g’gšes
: 
Engšes
,

320 
	gŒªs
: 
T
,

321 
	g¢­_mgr
: 
SÇpMªag”
,

322 
	gsignifiÿÁ_msg_»ûiv”
: 
Reûiv”
<
SignifiÿÁMsg
>,

323 
	gpd_wÜk”
: 
Futu»WÜk”
<
PdTask
>,

324 
	gcİroûssÜ_ho¡
: 
CİroûssÜHo¡
,

325 è-> 
	gResuÉ
<()>

326 
wh”e


327 
	gT
: 
T¿n¥Üt
 + 'static,

329 
šfo
!("¡¬ˆ¿á stÜ{}h»ad", 
	g¡Üe_id
);

331 
	g£lf
.
	g¡Üe_hªdË
.
is_some
() {

332  
E¼
(
box_”r
!("{} i ®»ady s¹ed", 
¡Üe_id
));

335 
Ët
 
	gcfg
 = 
£lf
.
¡Üe_cfg
.
şÚe
();

336 
Ët
 
	gpd_ş›Á
 = 
£lf
.
pd_ş›Á
.
şÚe
();

337 
Ët
 
	g¡Üe
 = 
£lf
.
¡Üe
.
şÚe
();

338 
Ët
 
	g£nd”
 = 
ev’t_loİ
.
chªÃl
();

340 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

341 
Ët
 
	gbud”
 = 
th»ad
::
Bud”
::
Ãw
().
Çme
(
thd_Çme
!(
fÜm©
!("¿á¡Üe-{}", 
¡Üe_id
)));

342 
Ët
 
	gh
 = 
bud”
.
¥awn
(
move
 || {

343 
Ët
 
ch
 = 
StÜeChªÃl
 {

344 
£nd”
,

345 
signifiÿÁ_msg_»ûiv”
,

347 
Ët
 
mut
 
¡Üe
 = 
m©ch
 
StÜe
::
Ãw
(

348 
ch
,

349 
¡Üe
,

350 
cfg
,

351 
’gšes
,

352 
Œªs
,

353 
pd_ş›Á
,

354 
¢­_mgr
,

355 
pd_wÜk”
,

356 
cİroûssÜ_ho¡
,

358 
E¼
(
e
è=> 
·nic
!("cÚ¡ruù stÜ{}ƒ¼ {:?}", 
¡Üe_id
,ƒ),

359 
Ok
(
s
) => s,

361 
tx
.
£nd
(0).
unw¿p
();

362 
Ët
 
E¼
(
e
èğ
¡Üe
.
run
(&
mut
 
ev’t_loİ
) {

363 
”rÜ
!("¡Ü{}„uÀ”¸{:?}", 
¡Üe_id
, 
e
);

367 
	grx
.
»cv
().
unw¿p
();

369 
	g£lf
.
	g¡Üe_hªdË
 = 
Some
(
h
);

370 
Ok
(())

373 
â
 
¡İ_¡Üe
(&
mut
 
£lf
, 
¡Üe_id
: 
u64
è-> 
ResuÉ
<()> {

374 
šfo
!("¡İ„aá stÜ{}h»ad", 
	g¡Üe_id
);

375 
Ët
 
	gh
 = 
m©ch
 
£lf
.
¡Üe_hªdË
.
ke
() {

376 
NÚe
 =>  
Ok
(()),

377 
Some
(
h
) => h,

380 
	gbox_Œy
!(
	g£lf
.
	gch
.
£nd
(
Msg
::
Qu™
));

381 
Ët
 
E¼
(
e
èğ
h
.
još
() {

382  
E¼
(
box_”r
!("još stÜ{}h»adƒ¼ {:?}", 
¡Üe_id
, 
e
));

385 
Ok
(())

388 
pub
 
â
 
¡İ
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

389 
Ët
 
	g¡Üe_id
 = 
£lf
.
¡Üe
.
g‘_id
();

390 
	g£lf
.
¡İ_¡Üe
(
¡Üe_id
)

394 #[
cfg
(
‹¡
)]

395 
mod
 
	g‹¡s
 {

396 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
;

397 
u£
 
	gsu³r
::
check_»giÚ_•och
;

398 
u£
 
	gkv´Ùo
::
m‘­b
;

400 #[
‹¡
]

401 
â
 
‹¡_check_»giÚ_•och
() {

402 
Ët
 
mut
 
	gr1
 = 
m‘­b
::
RegiÚ
::
Ãw
();

403 
	gr1
.
£t_id
(1);

404 
	gr1
.
£t_¡¬t_key
(
keys
::
EMPTY_KEY
.
to_vec
());

405 
	gr1
.
£t_’d_key
(
keys
::
EMPTY_KEY
.
to_vec
());

406 
	gr1
.
mut_»giÚ_•och
().
£t_v”siÚ
(1);

407 
	gr1
.
mut_»giÚ_•och
().
£t_cÚf_v”
(1);

409 
Ët
 
mut
 
	gr2
 = 
m‘­b
::
RegiÚ
::
Ãw
();

410 
	gr2
.
£t_id
(1);

411 
	gr2
.
£t_¡¬t_key
(
keys
::
EMPTY_KEY
.
to_vec
());

412 
	gr2
.
£t_’d_key
(
keys
::
EMPTY_KEY
.
to_vec
());

413 
	gr2
.
mut_»giÚ_•och
().
£t_v”siÚ
(2);

414 
	gr2
.
mut_»giÚ_•och
().
£t_cÚf_v”
(1);

416 
Ët
 
mut
 
	gr3
 = 
m‘­b
::
RegiÚ
::
Ãw
();

417 
	gr3
.
£t_id
(1);

418 
	gr3
.
£t_¡¬t_key
(
keys
::
EMPTY_KEY
.
to_vec
());

419 
	gr3
.
£t_’d_key
(
keys
::
EMPTY_KEY
.
to_vec
());

420 
	gr3
.
mut_»giÚ_•och
().
£t_v”siÚ
(1);

421 
	gr3
.
mut_»giÚ_•och
().
£t_cÚf_v”
(2);

423 
	gas£¹
!(
check_»giÚ_•och
(&
r1
, &
r2
).
is_”r
());

424 
	gas£¹
!(
check_»giÚ_•och
(&
r1
, &
r3
).
is_”r
());

	@src/server/raft_client.rs

14 
u£
 
	g¡d
::
ffi
::
CSŒšg
;

15 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicBoŞ
, 
	gAtomicUsize
, 
	gOrd”šg
, 
	gATOMIC_USIZE_INIT
};

18 
u£
 
	gfutu»s
::
sync
::
mpsc
::{
£lf
, 
	gUnboundedS’d”
};

19 
u£
 
	gfutu»s
::
sync
::
ÚeshÙ
::{
£lf
, 
	gS’d”
};

20 
u£
 
	gfutu»s
::{
¡»am
, 
	gFutu»
, 
	gSšk
, 
	gSŒ—m
};

21 
u£
 
	gg½c
::{
ChªÃlBud”
, 
	gEnvœÚm’t
, 
	gWr™eFÏgs
};

22 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

23 
u£
 
	gkv´Ùo
::
tikvpb_g½c
::
TikvCl›Á
;

25 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

26 
u£
 
	gut
::
£cur™y
::
Secur™yMªag”
;

27 
u£
 
	gsu³r
::{
CÚfig
, 
	gE¼Ü
, 
	gResuÉ
};

28 
u£
 
	gsu³r
::
m‘rics
::*;

30 cÚ¡ 
	gMAX_GRPC_RECV_MSG_LEN
: 
usize
 = 10 * 1024 * 1024;

31 cÚ¡ 
	gMAX_GRPC_SEND_MSG_LEN
: 
usize
 = 10 * 1024 * 1024;

32 cÚ¡ 
	gINITIAL_BUFFER_CAP
: 
usize
 = 1024;

35 
	gCONN_ID
: 
AtomicUsize
 = 
ATOMIC_USIZE_INIT
;

37 
	sCÚn
 {

38 
	m¡»am
: 
UnboundedS’d”
<
Vec
<(
RaáMes§ge
, 
	mWr™eFÏgs
)>>,

39 
	mbufãr
: 
O±iÚ
<
Vec
<(
RaáMes§ge
, 
	mWr™eFÏgs
)>>,

40 
	m¡Üe_id
: 
u64
,

41 
	m®ive
: 
Arc
<
AtomicBoŞ
>,

43 
	m_ş›Á
: 
TikvCl›Á
,

44 
	m_şo£
: 
S’d”
<()>,

47 
im¶
 
	gCÚn
 {

48 
â
 
Ãw
(

49 
’v
: 
Arc
<
EnvœÚm’t
>,

50 
addr
: &
¡r
,

51 
cfg
: &
CÚfig
,

52 
£cur™y_mgr
: &
Secur™yMªag”
,

53 
¡Üe_id
: 
u64
,

54 è-> 
	gCÚn
 {

55 
	gšfo
!("£rv”:‚ew cÚÃùiÚ w™hikvƒndpošt: {}", 
	gaddr
);

57 
Ët
 
	g®ive
 = 
Arc
::
Ãw
(
AtomicBoŞ
::Ãw(
Œue
));

58 
Ët
 
	g®ive1
 = 
®ive
.
şÚe
();

59 
Ët
 
	gcb
 = 
ChªÃlBud”
::
Ãw
(
’v
)

60 .
¡»am_š™Ÿl_wšdow_size
(
cfg
.
g½c_¡»am_š™Ÿl_wšdow_size
.0 
as
 
usize
)

61 .
max_»ûive_mes§ge_Ën
(
MAX_GRPC_RECV_MSG_LEN
)

62 .
max_£nd_mes§ge_Ën
(
MAX_GRPC_SEND_MSG_LEN
)

64 .
¿w_cfg_št
(

65 
CSŒšg
::
Ãw
("¿ndom id").
unw¿p
(),

66 
CONN_ID
.
ãtch_add
(1, 
Ord”šg
::
SeqC¡
),

68 
Ët
 
	gchªÃl
 = 
£cur™y_mgr
.
cÚÃù
(
cb
, 
addr
);

69 
Ët
 
	gş›Á
 = 
TikvCl›Á
::
Ãw
(
chªÃl
);

70 
Ët
 (
tx
, 
rx
èğ
mpsc
::
unbounded
();

71 
Ët
 (
tx_şo£
, 
rx_şo£
èğ
ÚeshÙ
::
chªÃl
();

72 
Ët
 (
sšk
, 
_
èğ
ş›Á
.
¿á
();

73 
Ët
 
	gaddr
 = 
addr
.
to_owÃd
();

74 
	gş›Á
.
¥awn
(

75 
rx_şo£


76 .
m­_”r
(|
_
| ())

77 .
£Ëù
(

78 
sšk
.
sšk_m­_”r
(
E¼Ü
::
äom
)

79 .
£nd_®l
(

80 
rx
.
m­
(|
msgs
: 
Vec
<(
RaáMes§ge
, 
Wr™eFÏgs
)>| {

81 
¡»am
::
™”_ok
(
msgs
)

82 }).
æ©‹n
()

83 .
m­_”r
(|()| 
E¼Ü
::
Sšk
),

85 .
th’
(
move
 |
r
| {

86 
®ive
.
¡Üe
(
çl£
, 
Ord”šg
::
SeqC¡
);

87 
r


89 .
m­
(|
_
| ())

90 .
m­_”r
(
move
 |
e
| {

91 
Ët
 
¡Üe
 = 
¡Üe_id
.
to_¡ršg
();

92 
REPORT_FAILURE_MSG_COUNTER


93 .
w™h_Ïb–_v®ues
(&["uÄ—chabË", &*
¡Üe
])

94 .
šc
();

95 
w¬n
!("£nd„aámes§gtØ{} faed: {:?}", 
addr
, 
e
);

98 .
m­
(|
_
| ())

99 .
m­_”r
(|
_
| ()),

101 
	gCÚn
 {

102 
	g¡»am
: 
tx
,

103 
	gbufãr
: 
Some
(
Vec
::
w™h_ÿ·c™y
(
INITIAL_BUFFER_CAP
)),

104 
	g¡Üe_id
: 
¡Üe_id
,

105 
	g®ive
: 
®ive1
,

107 
	g_ş›Á
: 
ş›Á
,

108 
	g_şo£
: 
tx_şo£
,

114 
pub
 
	sRaáCl›Á
 {

115 
	m’v
: 
Arc
<
EnvœÚm’t
>,

116 
	mcÚns
: 
HashM­
<(
SŒšg
, 
	musize
), 
	mCÚn
>,

117 
pub
 
	maddrs
: 
HashM­
<
u64
, 
	mSŒšg
>,

118 
	mcfg
: 
Arc
<
CÚfig
>,

119 
	m£cur™y_mgr
: 
Arc
<
Secur™yMªag”
>,

122 
im¶
 
	gRaáCl›Á
 {

123 
pub
 
â
 
Ãw
(

124 
’v
: 
Arc
<
EnvœÚm’t
>,

125 
cfg
: 
Arc
<
CÚfig
>,

126 
£cur™y_mgr
: 
Arc
<
Secur™yMªag”
>,

127 è-> 
	gRaáCl›Á
 {

128 
	gRaáCl›Á
 {

129 
	g’v
: 
’v
,

130 
	gcÚns
: 
HashM­
::(),

131 
	gaddrs
: 
HashM­
::(),

132 
	gcfg
: 
cfg
,

133 
	g£cur™y_mgr
: 
£cur™y_mgr
,

137 
â
 
g‘_cÚn
(&
mut
 
£lf
, 
addr
: &
¡r
, 
»giÚ_id
: 
u64
, 
¡Üe_id
: u64è-> &muˆ
CÚn
 {

138 
Ët
 
šdex
 = 
»giÚ_id
 
as
 
usize
 % 
£lf
.
cfg
.
g½c_¿á_cÚn_num
;

139 
Ët
 
	gcfg
 = &
£lf
.
cfg
;

140 
Ët
 
	g£cur™y_mgr
 = &
£lf
.
£cur™y_mgr
;

141 
Ët
 
	g’v
 = &
£lf
.
’v
;

143 
	g£lf
.
	gcÚns


144 .
’Œy
((
addr
.
to_owÃd
(), 
šdex
))

145 .
Ü_š£¹_w™h
(|| 
CÚn
::
Ãw
(
’v
.
şÚe
(), 
addr
, 
cfg
, 
£cur™y_mgr
, 
¡Üe_id
))

148 
pub
 
â
 
£nd
(&
mut
 
£lf
, 
¡Üe_id
: 
u64
, 
addr
: &
¡r
, 
msg
: 
RaáMes§ge
è-> 
ResuÉ
<()> {

149 
Ët
 
cÚn
 = 
£lf
.
g‘_cÚn
(
addr
, 
msg
.
»giÚ_id
, 
¡Üe_id
);

150 
	gcÚn
.
	gbufãr


151 .
as_mut
()

152 .
unw¿p
()

153 .
push
((
msg
, 
Wr™eFÏgs
::().
bufãr_hšt
(
Œue
)));

154 
Ok
(())

158 
pub
 
â
 
æush
(&
mut
 
£lf
) {

159 
Ët
 
	gaddrs
 = &
mut
 
£lf
.
addrs
;

160 
	g£lf
.
	gcÚns
.
»š
(|&(
»f
 
addr
, 
_
), 
cÚn
| {

161 
Ët
 
¡Üe_id
 = 
cÚn
.store_id;

162 !
cÚn
.
®ive
.
lßd
(
Ord”šg
::
SeqC¡
) {

163 
Ët
 
Some
(
addr_cu¼’t
èğ
addrs
.
»move
(&
¡Üe_id
) {

164 
addr_cu¼’t
 !ğ*
addr
 {

165 
addrs
.
š£¹
(
¡Üe_id
, 
addr_cu¼’t
);

168  
çl£
;

171 
cÚn
.
bufãr
.
as_»f
().
unw¿p
().
is_em±y
() {

172  
Œue
;

175 
Ët
 
mut
 
msgs
 = 
cÚn
.
bufãr
.
ke
().
unw¿p
();

176 
msgs
.
Ï¡_mut
().
unw¿p
().1 = 
Wr™eFÏgs
::();

177 
Ët
 
E¼
(
e
èğ
cÚn
.
¡»am
.
unbounded_£nd
(
msgs
) {

178 
”rÜ
!(

180 
addr
,

181 
e


184 
Ët
 
Some
(
addr_cu¼’t
èğ
addrs
.
»move
(&
¡Üe_id
) {

185 
addr_cu¼’t
 !ğ*
addr
 {

186 
addrs
.
š£¹
(
¡Üe_id
, 
addr_cu¼’t
);

189  
çl£
;

192 
cÚn
.
bufãr
 = 
Some
(
Vec
::
w™h_ÿ·c™y
(
INITIAL_BUFFER_CAP
));

193 
Œue


198 
im¶
 
Drİ
 
	gRaáCl›Á
 {

199 
â
 
drİ
(&
mut
 
£lf
) {

201 
	g£lf
.
	gcÚns
.
ş—r
();

	@src/server/resolve.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

15 
u£
 
	g¡d
::
boxed
::
FnBox
;

16 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

17 
u£
 
	g¡d
::
time
::
In¡ªt
;

19 
u£
 
	gkv´Ùo
::
m‘­b
;

21 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

22 
u£
 
	gut
::
wÜk”
::{
RuÂabË
, 
	gScheduËr
, 
	gWÜk”
};

23 
u£
 
	gpd
::
PdCl›Á
;

25 
u£
 
	gsu³r
::
ResuÉ
;

26 
u£
 
	gsu³r
::
m‘rics
::*;

28 cÚ¡ 
	gSTORE_ADDRESS_REFRESH_SECONDS
: 
u64
 = 60;

30 
pub
 
ty³
 
	gC®lback
 = 
Box
<
FnBox
(
ResuÉ
<
SŒšg
>è+ 
S’d
>;

33 
pub
 
Œa™
 
	gStÜeAddrResŞv”
: 
S’d
 + 
ClÚe
 {

35 
â
 
»sŞve
(&
£lf
, 
¡Üe_id
: 
u64
, 
cb
: 
C®lback
è-> 
ResuÉ
<()>;

39 
pub
 
	sTask
 {

40 
	m¡Üe_id
: 
u64
,

41 
	mcb
: 
C®lback
,

44 
im¶
 
Di¥Ïy
 
	gTask
 {

45 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

46 
wr™e
!(
f
, "»sŞv¡Ü{}‡dd»ss", 
	g£lf
.
	g¡Üe_id
)

50 
	sStÜeAddr
 {

51 
	maddr
: 
SŒšg
,

52 
	mÏ¡_upd©e
: 
In¡ªt
,

55 
pub
 
	gRuÂ”
<
	gT
: 
PdCl›Á
> {

56 
pd_ş›Á
: 
Arc
<
T
>,

57 
	g¡Üe_addrs
: 
HashM­
<
u64
, 
	gStÜeAddr
>,

60 
	gim¶
<
	gT
: 
PdCl›Á
> 
RuÂ”
<
T
> {

61 
â
 
»sŞve
(&
mut
 
£lf
, 
¡Üe_id
: 
u64
è-> 
ResuÉ
<
SŒšg
> {

62 
Ët
 
Some
(
s
èğ
£lf
.
¡Üe_addrs
.
g‘
(&
¡Üe_id
) {

63 
Ët
 
now
 = 
In¡ªt
::now();

64 
Ët
 
	g–­£d
 = 
now
.
du¿tiÚ_sšû
(
s
.
Ï¡_upd©e
);

65 
	g–­£d
.
as_£cs
(è< 
	gSTORE_ADDRESS_REFRESH_SECONDS
 {

66  
Ok
(
s
.
addr
.
şÚe
());

70 
Ët
 
	gaddr
 = 
£lf
.
g‘_add»ss
(
¡Üe_id
)?;

72 
Ët
 
	gÿche
 = 
StÜeAddr
 {

73 
addr
:‡ddr.
şÚe
(),

74 
Ï¡_upd©e
: 
In¡ªt
::
now
(),

76 
	g£lf
.
	g¡Üe_addrs
.
š£¹
(
¡Üe_id
, 
ÿche
);

78 
Ok
(
addr
)

81 
â
 
g‘_add»ss
(&
mut
 
£lf
, 
¡Üe_id
: 
u64
è-> 
ResuÉ
<
SŒšg
> {

82 
Ët
 
pd_ş›Á
 = 
£lf
.pd_ş›Á.
şÚe
();

83 
Ët
 
	gs
 = 
box_Œy
!(
pd_ş›Á
.
g‘_¡Üe
(
¡Üe_id
));

84 
	gs
.
g‘_¡©e
(è=ğ
m‘­b
::
StÜeS‹
::
Tomb¡Úe
 {

85 
RESOLVE_STORE_COUNTER


86 .
w™h_Ïb–_v®ues
(&["tombstone"])

87 .
šc
();

88  
E¼
(
box_”r
!("¡Ü{} ha b“À»moved", 
¡Üe_id
));

90 
Ët
 
	gaddr
 = 
s
.
g‘_add»ss
().
to_owÃd
();

94 
	gaddr
.
is_em±y
() {

95  
E¼
(
box_”r
!("šv®idƒm±y‡dd»s fÜ stÜ{}", 
¡Üe_id
));

97 
Ok
(
addr
)

101 
	gim¶
<
	gT
: 
PdCl›Á
> 
RuÂabË
<
Task
> 
RuÂ”
<
T
> {

102 
â
 
run
(&
mut
 
£lf
, 
sk
: 
Task
) {

103 
Ët
 
¡Üe_id
 = 
sk
.store_id;

104 
Ët
 
	g»¥
 = 
£lf
.
»sŞve
(
¡Üe_id
);

105 
	gsk
.
	gcb
.
ÿÎ_box
((
»¥
,))

109 #[
d”ive
(
ClÚe
)]

110 
pub
 
	sPdStÜeAddrResŞv”
 {

111 
	msched
: 
ScheduËr
<
Task
>,

114 
im¶
 
	gPdStÜeAddrResŞv”
 {

115 
pub
 
â
 
Ãw
(
sched
: 
ScheduËr
<
Task
>è-> 
PdStÜeAddrResŞv”
 {

116 
PdStÜeAddrResŞv”
 { 
sched
: sched }

120 
pub
 
â
 
Ãw_»sŞv”
<
T
>(
pd_ş›Á
: 
Arc
<T>è-> 
ResuÉ
<(
WÜk”
<
Task
>, 
	gPdStÜeAddrResŞv”
)>

121 
wh”e


122 
	gT
: 
PdCl›Á
 + 'static,

124 
Ët
 
mut
 
wÜk”
 = 
WÜk”
::
Ãw
("store‡ddress„esolve worker");

126 
Ët
 
	gruÂ”
 = 
RuÂ”
 {

127 
pd_ş›Á
:…d_client,

128 
¡Üe_addrs
: 
HashM­
::(),

130 
	gbox_Œy
!(
	gwÜk”
.
¡¬t
(
ruÂ”
));

131 
Ët
 
	g»sŞv”
 = 
PdStÜeAddrResŞv”
 {

132 
sched
: 
wÜk”
.
scheduËr
(),

134 
Ok
((
wÜk”
, 
»sŞv”
))

137 
im¶
 
StÜeAddrResŞv”
 
	gPdStÜeAddrResŞv”
 {

138 
â
 
»sŞve
(&
£lf
, 
¡Üe_id
: 
u64
, 
cb
: 
C®lback
è-> 
ResuÉ
<()> {

139 
Ët
 
sk
 = 
Task
 {

140 
¡Üe_id
: store_id,

141 
cb
: cb,

143 
	gbox_Œy
!(
	g£lf
.
	gsched
.
scheduË
(
sk
));

144 
Ok
(())

148 #[
cfg
(
‹¡
)]

149 
mod
 
	g‹¡s
 {

150 
u£
 
	gsu³r
::*;

151 
u£
 
	g¡d
::
Ãt
::
Sock‘Addr
;

152 
u£
 
	g¡d
::
sync
::
Arc
;

153 
u£
 
	g¡d
::
time
::{
Du¿tiÚ
, 
	gIn¡ªt
};

154 
u£
 
	g¡d
::
İs
::
Sub
;

155 
u£
 
	g¡d
::
¡r
::
FromSŒ
;

156 
u£
 
	g¡d
::
th»ad
;

158 
u£
 
	gkv´Ùo
::
pdpb
;

159 
u£
 
	gkv´Ùo
::
m‘­b
;

160 
u£
 
	gpd
::{
PdCl›Á
, 
	gPdFutu»
, 
	gRegiÚSt
, 
	gResuÉ
};

161 
u£
 
	gut
;

162 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

164 cÚ¡ 
	gSTORE_ADDRESS_REFRESH_SECONDS
: 
u64
 = 60;

166 
	sMockPdCl›Á
 {

167 
	g¡¬t
: 
In¡ªt
,

168 
	g¡Üe
: 
m‘­b
::
StÜe
,

171 
im¶
 
PdCl›Á
 
	gMockPdCl›Á
 {

172 
â
 
g‘_şu¡”_id
(&
£lf
è-> 
	gResuÉ
<
	gu64
> {

173 
	gunim¶em’‹d
!();

175 
â
 
boÙ¡¿p_şu¡”
(&
£lf
, 
_
: 
m‘­b
::
StÜe
, _: m‘­b::
RegiÚ
è-> 
ResuÉ
<()> {

176 
unim¶em’‹d
!();

178 
â
 
is_şu¡”_boÙ¡¿µed
(&
£lf
è-> 
	gResuÉ
<
	gboŞ
> {

179 
	gunim¶em’‹d
!();

181 
â
 
®loc_id
(&
£lf
è-> 
	gResuÉ
<
	gu64
> {

182 
	gunim¶em’‹d
!();

184 
â
 
put_¡Üe
(&
£lf
, 
_
: 
m‘­b
::
StÜe
è-> 
ResuÉ
<()> {

185 
unim¶em’‹d
!();

187 
â
 
g‘_¡Üe
(&
£lf
, 
_
: 
u64
è-> 
ResuÉ
<
m‘­b
::
StÜe
> {

189 
Ët
 
mut
 
¡Üe
 = 
£lf
.¡Üe.
şÚe
();

190 
Ët
 
mut
 
	gsock
 = 
Sock‘Addr
::
äom_¡r
(
¡Üe
.
g‘_add»ss
()).
unw¿p
();

191 
	gsock
.
£t_pÜt
(
ut
::
time
::
du¿tiÚ_to_ms
(
£lf
.
¡¬t
.
–­£d
()è
as
 
u16
);

192 
	g¡Üe
.
£t_add»ss
(
fÜm©
!("{}:{}", 
sock
.

(), sock.
pÜt
()));

193 
Ok
(
¡Üe
)

195 
â
 
g‘_şu¡”_cÚfig
(&
£lf
è-> 
	gResuÉ
<
	gm‘­b
::
Clu¡”
> {

196 
unim¶em’‹d
!();

198 
â
 
g‘_»giÚ
(&
£lf
, 
_
: &[
u8
]è-> 
ResuÉ
<
m‘­b
::
RegiÚ
> {

199 
unim¶em’‹d
!();

201 
â
 
g‘_»giÚ_by_id
(&
£lf
, 
_
: 
u64
è-> 
PdFutu»
<
O±iÚ
<
m‘­b
::
RegiÚ
>> {

202 
unim¶em’‹d
!();

204 
â
 
»giÚ_h—¹b—t
(

205 &
£lf
,

206 
_
: 
m‘­b
::
RegiÚ
,

207 
_
: 
m‘­b
::
P“r
,

208 
_
: 
RegiÚSt
,

209 è-> 
	gPdFutu»
<()> {

210 
	gunim¶em’‹d
!();

213 
â
 
	ghªdË_»giÚ_h—¹b—t_»¥Ú£
<
	gF
>(&
	g£lf
, 
	g_
: 
u64
, _: 
F
è-> 
PdFutu»
<()>

214 
wh”e


215 
F
: 
Fn
(
pdpb
::
RegiÚH—¹b—tRe¥Ú£
è+ 
S’d
 + 'static,

217 
unim¶em’‹d
!()

220 
â
 
ask_¥l™
(&
£lf
, 
_
: 
m‘­b
::
RegiÚ
è-> 
PdFutu»
<
pdpb
::
AskS¶™Re¥Ú£
> {

221 
unim¶em’‹d
!();

223 
â
 
¡Üe_h—¹b—t
(&
£lf
, 
_
: 
pdpb
::
StÜeSts
è-> 
PdFutu»
<()> {

224 
unim¶em’‹d
!();

226 
â
 
»pÜt_¥l™
(&
£lf
, 
_
: 
m‘­b
::
RegiÚ
, _: m‘­b::RegiÚè-> 
PdFutu»
<()> {

227 
unim¶em’‹d
!();

231 
â
 
Ãw_¡Üe
(
addr
: &
¡r
, 
¡©e
: 
m‘­b
::
StÜeS‹
è-> m‘­b::
StÜe
 {

232 
Ët
 
mut
 
¡Üe
 = 
m‘­b
::
StÜe
::
Ãw
();

233 
	g¡Üe
.
£t_id
(1);

234 
	g¡Üe
.
£t_¡©e
(
¡©e
);

235 
	g¡Üe
.
£t_add»ss
(
addr
.
što
());

236 
	g¡Üe


239 
â
 
Ãw_ruÂ”
(
¡Üe
: 
m‘­b
::
StÜe
è-> 
RuÂ”
<
MockPdCl›Á
> {

240 
Ët
 
ş›Á
 = 
MockPdCl›Á
 {

241 
¡¬t
: 
In¡ªt
::
now
(),

242 
¡Üe
: store,

244 
	gRuÂ”
 {

245 
	gpd_ş›Á
: 
Arc
::
Ãw
(
ş›Á
),

246 
	g¡Üe_addrs
: 
HashM­
::(),

250 cÚ¡ 
	gSTORE_ADDR
: &'static str = "127.0.0.1:12345";

252 #[
‹¡
]

253 
â
 
‹¡_»sŞve_¡Üe_¡©e_up
() {

254 
Ët
 
¡Üe
 = 
Ãw_¡Üe
(
STORE_ADDR
, 
m‘­b
::
StÜeS‹
::
Up
);

255 
Ët
 
mut
 
	gruÂ”
 = 
Ãw_ruÂ”
(
¡Üe
);

256 
	gas£¹
!(
	gruÂ”
.
g‘_add»ss
(0).
is_ok
());

259 #[
‹¡
]

260 
â
 
‹¡_»sŞve_¡Üe_¡©e_ofæše
() {

261 
Ët
 
	g¡Üe
 = 
Ãw_¡Üe
(
STORE_ADDR
, 
m‘­b
::
StÜeS‹
::
Ofæše
);

262 
Ët
 
mut
 
	gruÂ”
 = 
Ãw_ruÂ”
(
¡Üe
);

263 
	gas£¹
!(
	gruÂ”
.
g‘_add»ss
(0).
is_ok
());

266 #[
‹¡
]

267 
â
 
‹¡_»sŞve_¡Üe_¡©e_tomb¡Úe
() {

268 
Ët
 
	g¡Üe
 = 
Ãw_¡Üe
(
STORE_ADDR
, 
m‘­b
::
StÜeS‹
::
Tomb¡Úe
);

269 
Ët
 
mut
 
	gruÂ”
 = 
Ãw_ruÂ”
(
¡Üe
);

270 
	gas£¹
!(
	gruÂ”
.
g‘_add»ss
(0).
is_”r
());

273 #[
‹¡
]

274 
â
 
‹¡_¡Üe_add»ss_»äesh
() {

275 
Ët
 
	g¡Üe
 = 
Ãw_¡Üe
(
STORE_ADDR
, 
m‘­b
::
StÜeS‹
::
Up
);

276 
Ët
 
	g¡Üe_id
 = 
¡Üe
.
g‘_id
();

277 
Ët
 
mut
 
	gruÂ”
 = 
Ãw_ruÂ”
(
¡Üe
);

279 
Ët
 
	gš‹rv®
 = 
Du¿tiÚ
::
äom_mlis
(2);

281 
Ët
 
mut
 
	gsock
 = 
ruÂ”
.
»sŞve
(
¡Üe_id
).
unw¿p
();

283 
	gth»ad
::
¦“p
(
š‹rv®
);

286 
Ët
 
	gs
 = 
ruÂ”
.
¡Üe_addrs
.
g‘_mut
(&
¡Üe_id
).
unw¿p
();

287 
Ët
 
	gnow
 = 
In¡ªt
::
now
();

288 
	gs
.
	gÏ¡_upd©e
 = 
now
.
sub
(
Du¿tiÚ
::
äom_£cs
(
STORE_ADDRESS_REFRESH_SECONDS
 + 1));

290 
Ët
 
mut
 
	gÃw_sock
 = 
ruÂ”
.
»sŞve
(
¡Üe_id
).
unw¿p
();

291 
	gas£¹_Ã
!(
	gsock
, 
	gÃw_sock
);

293 
	gth»ad
::
¦“p
(
š‹rv®
);

295 
	gruÂ”
.
	g¡Üe_addrs
.
»move
(&
¡Üe_id
);

296 
	gsock
 = 
Ãw_sock
;

297 
	gÃw_sock
 = 
ruÂ”
.
»sŞve
(
¡Üe_id
).
unw¿p
();

298 
	gas£¹_Ã
!(
	gsock
, 
	gÃw_sock
);

300 
	gth»ad
::
¦“p
(
š‹rv®
);

302 
	gsock
 = 
Ãw_sock
;

303 
	gÃw_sock
 = 
ruÂ”
.
»sŞve
(
¡Üe_id
).
unw¿p
();

304 
	gas£¹_eq
!(
	gsock
, 
	gÃw_sock
);

	@src/server/server.rs

14 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gRwLock
};

15 
u£
 
	g¡d
::
Ãt
::{
IpAddr
, 
	gSock‘Addr
};

16 
u£
 
	g¡d
::
¡r
::
FromSŒ
;

18 
u£
 
	gg½c
::{
ChªÃlBud”
, 
	gEnvBud”
, 
	gEnvœÚm’t
, 
S”v”
 
as
 
	gG½cS”v”
, 
	gS”v”Bud”
};

19 
u£
 
	gkv´Ùo
::
tikvpb_g½c
::*;

20 
u£
 
	gkv´Ùo
::
debugpb_g½c
::
ü—‹_debug
;

22 
u£
 
	gut
::
wÜk”
::{
Futu»ScheduËr
, 
	gWÜk”
};

23 
u£
 
	gut
::
£cur™y
::
Secur™yMªag”
;

24 
u£
 
	g¡Üage
::
StÜage
;

25 
u£
 
	g¿á¡Üe
::
¡Üe
::{
Engšes
, 
	gSÇpMªag”
};

27 
u£
 
	gsu³r
::{
CÚfig
, 
	gResuÉ
};

28 
u£
 
	gcİroûssÜ
::{
EndPoštHo¡
, 
	gEndPoštTask
};

29 
u£
 
	gsu³r
::
£rviû
::*;

30 
u£
 
	gsu³r
::
Œª¥Üt
::{
RaáStÜeRou‹r
, 
	gS”v”T¿n¥Üt
};

31 
u£
 
	gsu³r
::
»sŞve
::
StÜeAddrResŞv”
;

32 
u£
 
	gsu³r
::
¢­
::{
RuÂ”
 
as
 
SÇpHªdËr
, 
Task
‡ 
	gSÇpTask
};

33 
u£
 
	gsu³r
::
¿á_ş›Á
::
RaáCl›Á
;

34 
u£
 
	gpd
::
PdTask
;

36 cÚ¡ 
	gDEFAULT_COPROCESSOR_BATCH
: 
usize
 = 256;

37 cÚ¡ 
	gMAX_GRPC_RECV_MSG_LEN
: 
usize
 = 10 * 1024 * 1024;

39 
pub
 
	gS”v”
<
	gT
: 
RaáStÜeRou‹r
 + 'static, S: StoreAddrResolver + '> {

40 
’v
: 
Arc
<
EnvœÚm’t
>,

42 
	gg½c_£rv”
: 
G½cS”v”
,

43 
	gloÿl_addr
: 
Sock‘Addr
,

45 
	gŒªs
: 
S”v”T¿n¥Üt
<
T
, 
	gS
>,

46 
	g¿á_rou‹r
: 
T
,

48 
	g¡Üage
: 
StÜage
,

50 
	g’d_pošt_wÜk”
: 
WÜk”
<
EndPoštTask
>,

52 
	g¢­_mgr
: 
SÇpMªag”
,

53 
	g¢­_wÜk”
: 
WÜk”
<
SÇpTask
>,

54 
	gpd_scheduËr
: 
Futu»ScheduËr
<
PdTask
>,

57 
	gim¶
<
	gT
: 
RaáStÜeRou‹r
, 
	gS
: 
StÜeAddrResŞv”
 + 'static> Server<T, S> {

58 #[
®low
(
too_mªy_¬gum’ts
)]

59 
pub
 
â
 
Ãw
(

60 
cfg
: &
Arc
<
CÚfig
>,

61 
£cur™y_mgr
: &
Arc
<
Secur™yMªag”
>,

62 
»giÚ_¥l™_size
: 
usize
,

63 
¡Üage
: 
StÜage
,

64 
¿á_rou‹r
: 
T
,

65 
»sŞv”
: 
S
,

66 
¢­_mgr
: 
SÇpMªag”
,

67 
pd_scheduËr
: 
Futu»ScheduËr
<
PdTask
>,

68 
debug_’gšes
: 
O±iÚ
<
Engšes
>,

69 è-> 
	gResuÉ
<
	gS”v”
<
	gT
, 
	gS
>> {

70 
Ët
 
	g’v
 = 
Arc
::
Ãw
(

71 
EnvBud”
::
Ãw
()

72 .
cq_couÁ
(
cfg
.
g½c_cÚcu¼’cy
)

73 .
Çme_´efix
(
thd_Çme
!("grpc-server"))

74 .
bud
(),

76 
Ët
 
	g¿á_ş›Á
 = 
Arc
::
Ãw
(
RwLock
::Ãw(
RaáCl›Á
::new(

77 
’v
.
şÚe
(),

78 
cfg
.
şÚe
(),

79 
£cur™y_mgr
.
şÚe
(),

81 
Ët
 
	g’d_pošt_wÜk”
 = 
WÜk”
::
Ãw
("end-point-worker");

82 
Ët
 
	g¢­_wÜk”
 = 
WÜk”
::
Ãw
("snap-handler");

84 
Ët
 
	gkv_£rviû
 = 
KvS”viû
::
Ãw
(

85 
¡Üage
.
şÚe
(),

86 
’d_pošt_wÜk”
.
scheduËr
(),

87 
¿á_rou‹r
.
şÚe
(),

88 
¢­_wÜk”
.
scheduËr
(),

89 
cfg
.
’d_pošt_»cursiÚ_lim™
,

91 
Ët
 
	gaddr
 = 
Sock‘Addr
::
äom_¡r
(&
cfg
.
addr
)?;

92 
	gšfo
!("li¡’šg oÀ{}", 
	gaddr
);

93 
Ët
 
	g
 = 
fÜm©
!("{}", 
	gaddr
.

());

94 
Ët
 
	gchªÃl_¬gs
 = 
ChªÃlBud”
::
Ãw
(
’v
.
şÚe
())

95 .
¡»am_š™Ÿl_wšdow_size
(
cfg
.
g½c_¡»am_š™Ÿl_wšdow_size
.0 
as
 
usize
)

96 .
max_cÚcu¼’t_¡»am
(
cfg
.
g½c_cÚcu¼’t_¡»am
)

97 .
max_»ûive_mes§ge_Ën
(
MAX_GRPC_RECV_MSG_LEN
)

98 .
max_£nd_mes§ge_Ën
(
»giÚ_¥l™_size
 
as
 
usize
 * 4)

99 .
bud_¬gs
();

100 
Ët
 
	gg½c_£rv”
 = {

101 
Ët
 
mut
 
sb
 = 
S”v”Bud”
::
Ãw
(
’v
.
şÚe
())

102 .
chªÃl_¬gs
(channel_args)

103 .
»gi¡”_£rviû
(
ü—‹_tikv
(
kv_£rviû
));

104 
	gsb
 = 
£cur™y_mgr
.
bšd
(
sb
, &

, 
addr
.
pÜt
());

105 
Ët
 
Some
(
’gšes
èğ
debug_’gšes
 {

106 
sb
 = sb.
»gi¡”_£rviû
(
ü—‹_debug
(
DebugS”viû
::
Ãw
(
’gšes
)));

108 
	gsb
.
bud
()?

111 
Ët
 
	gaddr
 = {

112 
Ët
 (
»f
 
ho¡
, 
pÜt
èğ
g½c_£rv”
.
bšd_addrs
()[0];

113 
	gSock‘Addr
::
Ãw
(
IpAddr
::
äom_¡r
(
ho¡
)?, 
pÜt
 
as
 
u16
)

116 
Ët
 
	gŒªs
 = 
S”v”T¿n¥Üt
::
Ãw
(

117 
¿á_ş›Á
,

118 
¢­_wÜk”
.
scheduËr
(),

119 
¿á_rou‹r
.
şÚe
(),

120 
»sŞv”
,

123 
Ët
 
	gsvr
 = 
S”v”
 {

124 
’v
:ƒnv.
şÚe
(),

125 
g½c_£rv”
: grpc_server,

126 
loÿl_addr
: 
addr
,

127 
Œªs
:rans,

128 
¿á_rou‹r
:„aft_router,

129 
¡Üage
: storage,

130 
’d_pošt_wÜk”
:ƒnd_point_worker,

131 
¢­_mgr
: snap_mgr,

132 
¢­_wÜk”
: snap_worker,

133 
pd_scheduËr
:…d_scheduler,

136 
Ok
(
svr
)

139 
pub
 
â
 
Œª¥Üt
(&
£lf
è-> 
	gS”v”T¿n¥Üt
<
	gT
, 
	gS
> {

140 
	g£lf
.
	gŒªs
.
şÚe
()

143 
pub
 
â
 
¡¬t
(&
mut
 
£lf
, 
cfg
: 
Arc
<
CÚfig
>, 
£cur™y_mgr
: Arc<
Secur™yMªag”
>è-> 
ResuÉ
<()> {

144 
Ët
 
’d_pošt
 = 
EndPoštHo¡
::
Ãw
(

145 
£lf
.
¡Üage
.
g‘_’gše
(),

146 
£lf
.
’d_pošt_wÜk”
.
scheduËr
(),

147 &
cfg
,

148 
£lf
.
pd_scheduËr
.
şÚe
(),

150 
	gbox_Œy
!(

151 
	g£lf
.
	g’d_pošt_wÜk”


152 .
¡¬t_b©ch
(
’d_pošt
, 
DEFAULT_COPROCESSOR_BATCH
)

154 
Ët
 
	g¢­_ruÂ”
 = 
SÇpHªdËr
::
Ãw
(

155 
£lf
.
’v
.
şÚe
(),

156 
£lf
.
¢­_mgr
.
şÚe
(),

157 
£lf
.
¿á_rou‹r
.
şÚe
(),

158 
£cur™y_mgr
,

160 
	gbox_Œy
!(
	g£lf
.
	g¢­_wÜk”
.
¡¬t
(
¢­_ruÂ”
));

161 
	g£lf
.
	gg½c_£rv”
.
¡¬t
();

162 
	gšfo
!("TiKV is„eadyo serve");

163 
Ok
(())

166 
pub
 
â
 
¡İ
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

167 
	g£lf
.
	g’d_pošt_wÜk”
.
¡İ
();

168 
	g£lf
.
	g¢­_wÜk”
.
¡İ
();

169 
Ët
 
E¼
(
e
èğ
£lf
.
¡Üage
.
¡İ
() {

170 
”rÜ
!("çedØ¡İ stÜe: {:?}", 
e
);

172 
	g£lf
.
	gg½c_£rv”
.
shutdown
();

173 
Ok
(())

179 
pub
 
â
 
li¡’šg_addr
(&
£lf
è-> 
	gSock‘Addr
 {

180 
	g£lf
.
	gloÿl_addr


184 #[
cfg
(
‹¡
)]

185 
mod
 
	g‹¡s
 {

186 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

187 
u£
 
	g¡d
::
sync
::*;

188 
u£
 
	g¡d
::
sync
::
mpsc
::*;

189 
u£
 
	g¡d
::
sync
::
©omic
::*;

191 
u£
 
	gsu³r
::*;

192 
u£
 
	gsu³r
::
su³r
::{
CÚfig
, 
	gResuÉ
};

193 
u£
 
	gsu³r
::
su³r
::
Œª¥Üt
::
RaáStÜeRou‹r
;

194 
u£
 
	gsu³r
::
su³r
::
»sŞve
::{
C®lback
 
as
 
ResŞveC®lback
, 
	gStÜeAddrResŞv”
};

195 
u£
 
	g¡Üage
::{
CÚfig
 
as
 
StÜageCÚfig
, 
	gStÜage
};

196 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

197 
u£
 
	g¿á¡Üe
::
ResuÉ
 
as
 
RaáStÜeResuÉ
;

198 
u£
 
	g¿á¡Üe
::
¡Üe
::
Msg
 
as
 
StÜeMsg
;

199 
u£
 
	g¿á¡Üe
::
¡Üe
::*;

200 
u£
 
	g¿á¡Üe
::
¡Üe
::
Œª¥Üt
::
T¿n¥Üt
;

201 
u£
 
	gut
::
wÜk”
::
Futu»WÜk”
;

202 
u£
 
	gut
::
£cur™y
::
Secur™yCÚfig
;

204 #[
d”ive
(
ClÚe
)]

205 
	sMockResŞv”
 {

206 
	gquick_ç
: 
Arc
<
AtomicBoŞ
>,

207 
	gaddr
: 
Arc
<
Mu‹x
<
O±iÚ
<
SŒšg
>>>,

210 
im¶
 
StÜeAddrResŞv”
 
	gMockResŞv”
 {

211 
â
 
»sŞve
(&
£lf
, 
_
: 
u64
, 
cb
: 
ResŞveC®lback
è-> 
ResuÉ
<()> {

212 
£lf
.
quick_ç
.
lßd
(
Ord”šg
::
SeqC¡
) {

213  
E¼
(
box_”r
!("quick fail"));

215 
Ët
 
	gaddr
 = 
£lf
.
addr
.
lock
().
unw¿p
();

216 
cb
(

217 
addr
.
as_»f
()

218 .
m­
(|
s
| s.
to_owÃd
())

219 .
ok_Ü
(
box_”r
!("not set")),

221 
Ok
(())

225 #[
d”ive
(
ClÚe
)]

226 
	sTe¡RaáStÜeRou‹r
 {

227 
	gtx
: 
S’d”
<
usize
>,

228 
	gsignifiÿÁ_msg_£nd”
: 
S’d”
<
SignifiÿÁMsg
>,

231 
im¶
 
RaáStÜeRou‹r
 
	gTe¡RaáStÜeRou‹r
 {

232 
â
 
£nd
(&
£lf
, 
_
: 
StÜeMsg
è-> 
RaáStÜeResuÉ
<()> {

233 
£lf
.
tx
.
£nd
(1).
unw¿p
();

234 
Ok
(())

237 
â
 
Œy_£nd
(&
£lf
, 
_
: 
StÜeMsg
è-> 
RaáStÜeResuÉ
<()> {

238 
£lf
.
tx
.
£nd
(1).
unw¿p
();

239 
Ok
(())

242 
â
 
signifiÿÁ_£nd
(&
£lf
, 
msg
: 
SignifiÿÁMsg
è-> 
RaáStÜeResuÉ
<()> {

243 
£lf
.
signifiÿÁ_msg_£nd”
.
£nd
(
msg
).
unw¿p
();

244 
Ok
(())

248 
â
 
is_uÄ—chabË_to
(
msg
: &
SignifiÿÁMsg
, 
»giÚ_id
: 
u64
, 
to_³”_id
: u64è-> 
boŞ
 {

249 *
msg
 =ğ
SignifiÿÁMsg
::
UÄ—chabË
 {

250 
»giÚ_id
,

251 
to_³”_id
,

255 #[
‹¡
]

256 
â
 
‹¡_³”_»sŞve
() {

257 
Ët
 
mut
 
	gcfg
 = 
CÚfig
::();

258 
Ët
 
	g¡Üage_cfg
 = 
StÜageCÚfig
::();

259 
	gcfg
.
	gaddr
 = "127.0.0.1:0".
to_owÃd
();

261 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
Ãw
(&
¡Üage_cfg
).
unw¿p
();

262 
	g¡Üage
.
¡¬t
(&
¡Üage_cfg
).
unw¿p
();

264 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

265 
Ët
 (
signifiÿÁ_msg_£nd”
, 
signifiÿÁ_msg_»ûiv”
èğ
mpsc
::
chªÃl
();

266 
Ët
 
	grou‹r
 = 
Te¡RaáStÜeRou‹r
 {

267 
tx
:x,

268 
signifiÿÁ_msg_£nd”
: significant_msg_sender,

271 
Ët
 
	gaddr
 = 
Arc
::
Ãw
(
Mu‹x
::Ãw(
NÚe
));

272 
Ët
 
	gquick_ç
 = 
Arc
::
Ãw
(
AtomicBoŞ
::Ãw(
çl£
));

273 
Ët
 
	gpd_wÜk”
 = 
Futu»WÜk”
::
Ãw
("pd worker");

274 
Ët
 
	gcfg
 = 
Arc
::
Ãw
(
cfg
);

275 
Ët
 
	g£cur™y_mgr
 = 
Arc
::
Ãw
(
Secur™yMªag”
::Ãw(&
Secur™yCÚfig
::()).
unw¿p
());

276 
Ët
 
mut
 
	g£rv”
 = 
S”v”
::
Ãw
(

277 &
cfg
,

278 &
£cur™y_mgr
,

280 
¡Üage
,

281 
rou‹r
,

282 
MockResŞv”
 {

283 
quick_ç
: quick_ç.
şÚe
(),

284 
addr
:‡ddr.
şÚe
(),

286 
SÇpMªag”
::
Ãw
("", 
NÚe
, None),

287 
pd_wÜk”
.
scheduËr
(),

288 
NÚe
,

289 ).
unw¿p
();

291 
	g£rv”
.
¡¬t
(
cfg
, 
£cur™y_mgr
).
unw¿p
();

293 
Ët
 
mut
 
	gŒªs
 = 
£rv”
.
Œª¥Üt
();

294 
	gŒªs
.
»pÜt_uÄ—chabË
(
RaáMes§ge
::
Ãw
());

295 
Ët
 
mut
 
	g»¥
 = 
signifiÿÁ_msg_»ûiv”
.
Œy_»cv
().
unw¿p
();

296 
	gas£¹
!(
is_uÄ—chabË_to
(&
»¥
, 0, 0), "{:?}", 
	g»¥
);

298 
Ët
 
mut
 
	gmsg
 = 
RaáMes§ge
::
Ãw
();

299 
	gmsg
.
£t_»giÚ_id
(1);

300 
	gŒªs
.
£nd
(
msg
.
şÚe
()).
unw¿p
();

301 
	gŒªs
.
æush
();

302 
	g»¥
 = 
signifiÿÁ_msg_»ûiv”
.
Œy_»cv
().
unw¿p
();

303 
	gas£¹
!(
is_uÄ—chabË_to
(&
»¥
, 1, 0), "{:?}", 
	g»¥
);

305 *
	gaddr
.
lock
().
unw¿p
(èğ
Some
(
fÜm©
!("{}", 
£rv”
.
li¡’šg_addr
()));

307 
	gŒªs
.
£nd
(
msg
.
şÚe
()).
unw¿p
();

308 
	gŒªs
.
æush
();

309 
	gas£¹
!(
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(5)).
is_ok
());

311 
	gmsg
.
mut_to_³”
().
£t_¡Üe_id
(2);

312 
	gmsg
.
£t_»giÚ_id
(2);

313 
	gquick_ç
.
¡Üe
(
Œue
, 
Ord”šg
::
SeqC¡
);

314 
	gŒªs
.
£nd
(
msg
.
şÚe
()).
unw¿p
();

315 
	gŒªs
.
æush
();

316 
	g»¥
 = 
signifiÿÁ_msg_»ûiv”
.
Œy_»cv
().
unw¿p
();

317 
	gas£¹
!(
is_uÄ—chabË_to
(&
»¥
, 2, 0), "{:?}", 
	g»¥
);

318 
	g£rv”
.
¡İ
().
unw¿p
();

	@src/server/service/debug.rs

14 
u£
 
	gg½c
::{
E¼Ü
 
as
 
G½cE¼Ü
, 
	gWr™eFÏgs
};

15 
u£
 
	gg½c
::{
RpcCÚ‹xt
, 
	gRpcStus
, 
	gRpcStusCode
, 
	gS”v”SŒ—mšgSšk
, 
	gUÇrySšk
};

16 
u£
 
	gfutu»s
::{
futu»
, 
	g¡»am
, 
	gFutu»
, 
	gSŒ—m
};

17 
u£
 
	gfutu»s_ıupoŞ
::{
Bud”
, 
	gCpuPoŞ
};

18 
u£
 
	gkv´Ùo
::
debugpb_g½c
;

19 
u£
 
	gkv´Ùo
::
debugpb
::*;

20 
u£
 
	gç
;

22 
u£
 
	g¿á¡Üe
::
¡Üe
::
Engšes
;

23 
u£
 
	g£rv”
::
debug
::{
Debugg”
, 
	gE¼Ü
};

25 #[
d”ive
(
ClÚe
)]

26 
pub
 
	sS”viû
 {

27 
	mpoŞ
: 
CpuPoŞ
,

28 
	mdebugg”
: 
Debugg”
,

31 
im¶
 
	gS”viû
 {

32 
pub
 
â
 
Ãw
(
’gšes
: 
Engšes
è-> 
S”viû
 {

33 
Ët
 
poŞ
 = 
Bud”
::
Ãw
()

34 .
Çme_´efix
(
thd_Çme
!("debugger"))

35 .
poŞ_size
(1)

36 .
ü—‹
();

37 
Ët
 
	gdebugg”
 = 
Debugg”
::
Ãw
(
’gšes
);

38 
	gS”viû
 { 
	gpoŞ
, 
	gdebugg”
 }

41 
â
 
	ghªdË_»¥Ú£
<
	gF
, 
	gP
>(&
	g£lf
, 
	gùx
: 
RpcCÚ‹xt
, 
	gsšk
: 
UÇrySšk
<
P
>, 
	g»¥
: 
F
, 
	gg
: &'static str)

42 
wh”e


43 
P
: 
S’d
 + 'static,

44 
F
: 
Futu»
<
I‹m
 = 
P
, 
	gE¼Ü
 = 
E¼Ü
> + 
S’d
 + 'static,

46 
Ët
 
f
 = 
»¥
.
th’
(|
v
| 
m©ch
 v {

47 
Ok
(
»¥
è=> 
sšk
.
sucûss
(resp),

48 
E¼
(
e
) => {

49 
Ët
 
¡©us
 = 
S”viû
::
”rÜ_to_¡©us
(
e
);

50 
sšk
.
ç
(
¡©us
)

53 
	gùx
.
¥awn
(
f
.
m­_”r
(
move
 |
e
| 
S”viû
::
Ú_g½c_”rÜ
(
g
, &e)));

56 
â
 
”rÜ_to_¡©us
(
e
: 
E¼Ü
è-> 
RpcStus
 {

57 
Ët
 (
code
, 
msg
èğ
m©ch
 
e
 {

58 
E¼Ü
::
NÙFound
(
msg
è=> (
RpcStusCode
::NÙFound, 
Some
(msg)),

59 
	gE¼Ü
::
Inv®idArgum’t
(
msg
è=> (
RpcStusCode
::Inv®idArgum’t, 
Some
(msg)),

60 
	gE¼Ü
::
Oth”
(
e
è=> (
RpcStusCode
::
Unknown
, 
Some
(
fÜm©
!("{:?}",ƒ))),

62 
	gRpcStus
::
Ãw
(
code
, 
msg
)

65 
â
 
Ú_g½c_”rÜ
(
g
: &'static str,ƒ: &GrpcError) {

66 
”rÜ
!("{} faed: {:?}", 
g
, 
e
);

69 
â
 
”rÜ_to_g½c_”rÜ
(
g
: &'static str,ƒ: Error) -> GrpcError {

70 
Ët
 
¡©us
 = 
S”viû
::
”rÜ_to_¡©us
(
e
);

71 
Ët
 
e
 = 
G½cE¼Ü
::
RpcFau»
(
¡©us
);

72 
S”viû
::
Ú_g½c_”rÜ
(
g
, &
e
);

73 
e


77 
im¶
 
debugpb_g½c
::
Debug
 
S”viû
 {

78 
â
 
g‘
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
mut
 
»q
: 
G‘Reque¡
, 
sšk
: 
UÇrySšk
<
G‘Re¥Ú£
>) {

79 cÚ¡ 
TAG
: &'static str = "debug_get";

81 
Ët
 
db
 = 
»q
.
g‘_db
();

82 
Ët
 
cf
 = 
»q
.
ke_cf
();

83 
Ët
 
key
 = 
»q
.
ke_key
();

85 
Ët
 
f
 = 
£lf
.
poŞ


86 .
¥awn
(

87 
futu»
::
ok
(
£lf
.
debugg”
.
şÚe
())

88 .
ªd_th’
(
move
 |
debugg”
| debugg”.
g‘
(
db
, &
cf
, 
key
.
as_¦iû
())),

90 .
m­
(|
v®ue
| {

91 
Ët
 
mut
 
»¥
 = 
G‘Re¥Ú£
::
Ãw
();

92 
»¥
.
£t_v®ue
(
v®ue
);

93 
»¥


96 
£lf
.
hªdË_»¥Ú£
(
ùx
, 
sšk
, 
f
, 
TAG
);

99 
â
 
¿á_log
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
»q
: 
RaáLogReque¡
, 
sšk
: 
UÇrySšk
<
RaáLogRe¥Ú£
>) {

100 cÚ¡ 
TAG
: &'static str = "debug_raft_log";

102 
Ët
 
»giÚ_id
 = 
»q
.
g‘_»giÚ_id
();

103 
Ët
 
log_šdex
 = 
»q
.
g‘_log_šdex
();

105 
Ët
 
f
 = 
£lf
.
poŞ


106 .
¥awn
(

107 
futu»
::
ok
(
£lf
.
debugg”
.
şÚe
())

108 .
ªd_th’
(
move
 |
debugg”
| debugg”.
¿á_log
(
»giÚ_id
, 
log_šdex
)),

110 .
m­
(|
’Œy
| {

111 
Ët
 
mut
 
»¥
 = 
RaáLogRe¥Ú£
::
Ãw
();

112 
»¥
.
£t_’Œy
(
’Œy
);

113 
»¥


116 
£lf
.
hªdË_»¥Ú£
(
ùx
, 
sšk
, 
f
, 
TAG
);

119 
â
 
»giÚ_šfo
(

120 &
£lf
,

121 
ùx
: 
RpcCÚ‹xt
,

122 
»q
: 
RegiÚInfoReque¡
,

123 
sšk
: 
UÇrySšk
<
RegiÚInfoRe¥Ú£
>,

125 cÚ¡ 
TAG
: &'static str = "debug_region_log";

127 
Ët
 
»giÚ_id
 = 
»q
.
g‘_»giÚ_id
();

129 
Ët
 
f
 = 
£lf
.
poŞ


130 .
¥awn
(

131 
futu»
::
ok
(
£lf
.
debugg”
.
şÚe
())

132 .
ªd_th’
(
move
 |
debugg”
| debugg”.
»giÚ_šfo
(
»giÚ_id
)),

134 .
m­
(|
»giÚ_šfo
| {

135 
Ët
 
mut
 
»¥
 = 
RegiÚInfoRe¥Ú£
::
Ãw
();

136 
Ët
 
Some
(
¿á_loÿl_¡©e
èğ
»giÚ_šfo
.raft_local_state {

137 
»¥
.
£t_¿á_loÿl_¡©e
(
¿á_loÿl_¡©e
);

139 
Ët
 
Some
(
¿á_­¶y_¡©e
èğ
»giÚ_šfo
.raft_apply_state {

140 
»¥
.
£t_¿á_­¶y_¡©e
(
¿á_­¶y_¡©e
);

142 
Ët
 
Some
(
»giÚ_¡©e
èğ
»giÚ_šfo
.
»giÚ_loÿl_¡©e
 {

143 
»¥
.
£t_»giÚ_loÿl_¡©e
(
»giÚ_¡©e
);

145 
»¥


148 
£lf
.
hªdË_»¥Ú£
(
ùx
, 
sšk
, 
f
, 
TAG
);

151 
â
 
»giÚ_size
(

152 &
£lf
,

153 
ùx
: 
RpcCÚ‹xt
,

154 
mut
 
»q
: 
RegiÚSizeReque¡
,

155 
sšk
: 
UÇrySšk
<
RegiÚSizeRe¥Ú£
>,

157 cÚ¡ 
TAG
: &'static str = "debug_region_size";

159 
Ët
 
»giÚ_id
 = 
»q
.
g‘_»giÚ_id
();

160 
Ët
 
cfs
 = 
»q
.
ke_cfs
().
što_vec
();

162 
Ët
 
f
 = 
£lf
.
poŞ


163 .
¥awn
(

164 
futu»
::
ok
(
£lf
.
debugg”
.
şÚe
())

165 .
ªd_th’
(
move
 |
debugg”
| debugg”.
»giÚ_size
(
»giÚ_id
, 
cfs
)),

167 .
m­
(|
’Œ›s
| {

168 
Ët
 
mut
 
»¥
 = 
RegiÚSizeRe¥Ú£
::
Ãw
();

169 
»¥
.
£t_’Œ›s
(

170 
’Œ›s


171 .
što_™”
()

172 .
m­
(|(
cf
, 
size
)| {

173 
Ët
 
mut
 
’Œy
 = 
RegiÚSizeRe¥Ú£_EÁry
::
Ãw
();

174 
’Œy
.
£t_cf
(
cf
);

175 
’Œy
.
£t_size
(
size
 
as
 
u64
);

176 
’Œy


178 .
cŞËù
(),

180 
»¥


183 
£lf
.
hªdË_»¥Ú£
(
ùx
, 
sšk
, 
f
, 
TAG
);

186 
â
 
sÿn_mvcc
(

187 &
£lf
,

188 
_
: 
RpcCÚ‹xt
,

189 
mut
 
»q
: 
SÿnMvccReque¡
,

190 
sšk
: 
S”v”SŒ—mšgSšk
<
SÿnMvccRe¥Ú£
>,

192 
Ët
 
debugg”
 = 
£lf
.debugg”.
şÚe
();

193 
Ët
 
äom
 = 
»q
.
ke_äom_key
();

194 
Ët
 
to
 = 
»q
.
ke_to_key
();

195 
Ët
 
lim™
 = 
»q
.
g‘_lim™
();

196 
Ët
 
futu»
 = futu»::
»suÉ
(
debugg”
.
sÿn_mvcc
(&
äom
, &
to
, 
lim™
))

197 .
m­_”r
(|
e
| 
S”viû
::
”rÜ_to_g½c_”rÜ
("scan_mvcc",ƒ))

198 .
ªd_th’
(|
™”
| {

199 #[
®low
(
d•»ÿ‹d
)]

200 
¡»am
::
™”
(iter)

201 .
m­_”r
(|
e
| 
S”viû
::
”rÜ_to_g½c_”rÜ
("scan_mvcc",ƒ))

202 .
m­
(|(
key
, 
mvcc_šfo
)| {

203 
Ët
 
mut
 
»¥
 = 
SÿnMvccRe¥Ú£
::
Ãw
();

204 
»¥
.
£t_key
(
key
);

205 
»¥
.
£t_šfo
(
mvcc_šfo
);

206 (
»¥
, 
Wr™eFÏgs
::())

208 .
fÜw¬d
(
sšk
)

209 .
m­
(|
_
| ())

211 .
m­_”r
(|
e
| 
S”viû
::
Ú_g½c_”rÜ
("scan_mvcc", &e));

212 
£lf
.
poŞ
.
¥awn
(
futu»
).
fÜg‘
();

215 
â
 
com·ù
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
»q
: 
Com·ùReque¡
, 
sšk
: 
UÇrySšk
<
Com·ùRe¥Ú£
>) {

216 
Ët
 
debugg”
 = 
£lf
.debugg”.
şÚe
();

217 
Ët
 
f
 = 
£lf
.
poŞ
.
¥awn_â
(
move
 || {

218 
debugg”


219 .
com·ù
(

220 
»q
.
g‘_db
(),

221 
»q
.
g‘_cf
(),

222 
»q
.
g‘_äom_key
(),

223 
»q
.
g‘_to_key
(),

225 .
m­
(|
_
| 
Com·ùRe¥Ú£
::())

227 
£lf
.
hªdË_»¥Ú£
(
ùx
, 
sšk
, 
f
, "debug_compact");

230 
â
 
šjeù_ç_pošt
(

231 &
£lf
,

232 
ùx
: 
RpcCÚ‹xt
,

233 
mut
 
»q
: 
InjeùFaPoštReque¡
,

234 
sšk
: 
UÇrySšk
<
InjeùFaPoštRe¥Ú£
>,

236 cÚ¡ 
TAG
: &'static str = "debug_inject_fail_point";

238 
Ët
 
f
 = 
£lf
.
poŞ
.
¥awn_â
(
move
 || {

239 
Ët
 
Çme
 = 
»q
.
ke_Çme
();

240 
Çme
.
is_em±y
() {

241  
E¼
(
E¼Ü
::
Inv®idArgum’t
("Fau» Ty³ INVALID".
to_owÃd
()));

243 
Ët
 
aùiÚs
 = 
»q
.
g‘_aùiÚs
();

244 
Ët
 
E¼
(
e
èğ
ç
::
cfg
(
Çme
, 
aùiÚs
) {

245  
E¼
(
box_”r
!("{:?}", 
e
));

247 
Ok
(
InjeùFaPoštRe¥Ú£
::
Ãw
())

250 
£lf
.
hªdË_»¥Ú£
(
ùx
, 
sšk
, 
f
, 
TAG
);

253 
â
 
»cov”_ç_pošt
(

254 &
£lf
,

255 
ùx
: 
RpcCÚ‹xt
,

256 
mut
 
»q
: 
Recov”FaPoštReque¡
,

257 
sšk
: 
UÇrySšk
<
Recov”FaPoštRe¥Ú£
>,

259 cÚ¡ 
TAG
: &'static str = "debug_recover_fail_point";

261 
Ët
 
f
 = 
£lf
.
poŞ
.
¥awn_â
(
move
 || {

262 
Ët
 
Çme
 = 
»q
.
ke_Çme
();

263 
Çme
.
is_em±y
() {

264  
E¼
(
E¼Ü
::
Inv®idArgum’t
("Fau» Ty³ INVALID".
to_owÃd
()));

266 
ç
::
»move
(
Çme
);

267 
Ok
(
Recov”FaPoštRe¥Ú£
::
Ãw
())

270 
£lf
.
hªdË_»¥Ú£
(
ùx
, 
sšk
, 
f
, 
TAG
);

273 
â
 
li¡_ç_pošts
(

274 &
£lf
,

275 
ùx
: 
RpcCÚ‹xt
,

276 
_
: 
Li¡FaPoštsReque¡
,

277 
sšk
: 
UÇrySšk
<
Li¡FaPoštsRe¥Ú£
>,

279 cÚ¡ 
TAG
: &'static str = "debug_list_fail_points";

281 
Ët
 
f
 = 
£lf
.
poŞ
.
¥awn_â
(
move
 || {

282 
Ët
 
li¡
 = 
ç
::li¡().
što_™”
().
m­
(|(
Çme
, 
aùiÚs
)| {

283 
Ët
 
mut
 
’Œy
 = 
Li¡FaPoštsRe¥Ú£_EÁry
::
Ãw
();

284 
’Œy
.
£t_Çme
(
Çme
);

285 
’Œy
.
£t_aùiÚs
(
aùiÚs
);

286 
’Œy


288 
Ët
 
mut
 
»¥
 = 
Li¡FaPoštsRe¥Ú£
::
Ãw
();

289 
»¥
.
£t_’Œ›s
(
li¡
.
cŞËù
());

290 
Ok
(
»¥
)

293 
£lf
.
hªdË_»¥Ú£
(
ùx
, 
sšk
, 
f
, 
TAG
);

	@src/server/service/kv.rs

14 
u£
 
	g¡d
::
boxed
::
FnBox
;

15 
u£
 
	g¡d
::
fmt
::
Debug
;

16 
u£
 
	g¡d
::
io
::
Wr™e
;

17 
u£
 
	g¡d
::
™”
::{
£lf
, 
	gFromI‹¿tÜ
};

18 
u£
 
	g¡d
::
sync
::
Arc
;

19 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

20 
u£
 
	gmio
::
Tok’
;

21 
u£
 
	gg½c
::{
Cl›ÁSŒ—mšgSšk
, 
	gReque¡SŒ—m
, 
	gRpcCÚ‹xt
, 
	gRpcStus
, 
	gRpcStusCode
,

22 
	gS”v”SŒ—mšgSšk
, 
	gUÇrySšk
};

23 
u£
 
	gfutu»s
::{
futu»
, 
	gFutu»
, 
	gSŒ—m
};

24 
u£
 
	gfutu»s
::
sync
::
ÚeshÙ
;

25 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

26 
u£
 
	gkv´Ùo
::
tikvpb_g½c
;

27 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::*;

28 
u£
 
	gkv´Ùo
::
kv½ıb
::*;

29 
u£
 
	gkv´Ùo
::
cİroûssÜ
::*;

30 
u£
 
	gkv´Ùo
::
”rÜpb
::{
E¼Ü
 
as
 
RegiÚE¼Ü
, 
	gS”v”IsBusy
};

32 
u£
 
	gut
::
wÜk”
::
ScheduËr
;

33 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

34 
u£
 
	gut
::
buf
::
PeBufãr
;

35 
u£
 
	g¡Üage
::{
£lf
, 
	gKey
, 
	gMutiÚ
, 
	gO±iÚs
, 
	gStÜage
, 
	gV®ue
};

36 
u£
 
	g¡Üage
::
txn
::
E¼Ü
 
as
 
TxnE¼Ü
;

37 
u£
 
	g¡Üage
::
mvcc
::{
E¼Ü
 
as
 
MvccE¼Ü
, 
Wr™e
‡ 
	gMvccWr™e
, 
	gWr™eTy³
};

38 
u£
 
	g¡Üage
::
’gše
::
E¼Ü
 
as
 
EngšeE¼Ü
;

39 
u£
 
	g£rv”
::
Œª¥Üt
::
RaáStÜeRou‹r
;

40 
u£
 
	g£rv”
::
¢­
::
Task
 
as
 
SÇpTask
;

41 
u£
 
	g£rv”
::
m‘rics
::*;

42 
u£
 
	g£rv”
::
E¼Ü
;

43 
u£
 
	g¿á¡Üe
::
¡Üe
::
Msg
 
as
 
StÜeMes§ge
;

44 
u£
 
	gcİroûssÜ
::{
EndPoštTask
, 
	gReque¡Task
};

46 cÚ¡ 
	gSCHEDULER_IS_BUSY
: &'static str = "scheduler is busy";

48 #[
d”ive
(
ClÚe
)]

49 
pub
 
S”viû
<
T
: 
RaáStÜeRou‹r
 + 'static> {

51 
¡Üage
: 
StÜage
,

53 
	g’d_pošt_scheduËr
: 
ScheduËr
<
EndPoštTask
>,

55 
	gch
: 
T
,

57 
	g¢­_scheduËr
: 
ScheduËr
<
SÇpTask
>,

58 
	gtok’
: 
Arc
<
AtomicUsize
>,

59 
	g»cursiÚ_lim™
: 
u32
,

62 
	gim¶
<
	gT
: 
RaáStÜeRou‹r
 + 'static> Service<T> {

63 
pub
 
â
 
Ãw
(

64 
¡Üage
: 
StÜage
,

65 
’d_pošt_scheduËr
: 
ScheduËr
<
EndPoštTask
>,

66 
ch
: 
T
,

67 
¢­_scheduËr
: 
ScheduËr
<
SÇpTask
>,

68 
»cursiÚ_lim™
: 
u32
,

69 è-> 
	gS”viû
<
	gT
> {

70 
	gS”viû
 {

71 
	g¡Üage
: 
¡Üage
,

72 
	g’d_pošt_scheduËr
: 
’d_pošt_scheduËr
,

73 
	gch
: 
ch
,

74 
	g¢­_scheduËr
: 
¢­_scheduËr
,

75 
	gtok’
: 
Arc
::
Ãw
(
AtomicUsize
::new(1)),

76 
	g»cursiÚ_lim™
: 
»cursiÚ_lim™
,

80 
â
 
	g£nd_ç_¡©us
<
	gM
>(

81 &
	g£lf
,

82 
	gùx
: 
RpcCÚ‹xt
,

83 
	gsšk
: 
UÇrySšk
<
M
>,

84 
	g”r
: 
E¼Ü
,

85 
	gcode
: 
RpcStusCode
,

87 
Ët
 
	g¡©us
 = 
RpcStus
::
Ãw
(
code
, 
Some
(
fÜm©
!("{}", 
”r
)));

88 
	gùx
.
¥awn
(
sšk
.
ç
(
¡©us
).
m­_”r
(|
_
| ()));

92 
â
 
	gmake_ÿÎback
<
	gT
: 
Debug
 + 
S’d
 + 'static>() -> (Box<FnBox(T) + Send>, oneshot::Receiver<T>) {

93 
Ët
 (
tx
, 
rx
èğ
ÚeshÙ
::
chªÃl
();

94 
Ët
 
	gÿÎback
 = 
move
 |
»¥
| { 
tx
.
£nd
Ôe¥).
unw¿p
(); };

95 (
box
 
	gÿÎback
, 
	grx
)

98 
	gim¶
<
	gT
: 
RaáStÜeRou‹r
 + 'static>ikvpb_grpc::Tikv for Service<T> {

99 
â
 
kv_g‘
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
mut
 
»q
: 
G‘Reque¡
, 
sšk
: 
UÇrySšk
<
G‘Re¥Ú£
>) {

100 
Ët
 
Ïb–
 = "kv_get";

101 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


102 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

103 .
¡¬t_cßr£_tim”
();

105 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

106 
Ët
 
	g»s
 = 
£lf
.
¡Üage
.
async_g‘
(

107 
»q
.
ke_cÚ‹xt
(),

108 
Key
::
äom_¿w
(
»q
.
g‘_key
()),

109 
»q
.
g‘_v”siÚ
(),

110 
cb
,

112 
Ët
 
E¼
(
e
èğ
»s
 {

113 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

117 
Ët
 
	gfutu»
 = 
futu»


118 .
m­_”r
(
E¼Ü
::
äom
)

119 .
m­
(|
v
| {

120 
Ët
 
mut
 
»s
 = 
G‘Re¥Ú£
::
Ãw
();

121 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

122 
»s
.
£t_»giÚ_”rÜ
(
”r
);

124 
m©ch
 
v
 {

125 
Ok
(
Some
(
v®
)è=> 
»s
.
£t_v®ue
(val),

126 
Ok
(
NÚe
è=> 
»s
.
£t_v®ue
(
vec
![]),

127 
E¼
(
e
è=> 
»s
.
£t_”rÜ
(
exŒaù_key_”rÜ
(&e)),

130 
»s


132 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

133 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

134 .
m­_”r
(
move
 |
e
| {

135 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

136 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

139 
	gùx
.
¥awn
(
futu»
);

142 
â
 
kv_sÿn
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
mut
 
»q
: 
SÿnReque¡
, 
sšk
: 
UÇrySšk
<
SÿnRe¥Ú£
>) {

143 
Ët
 
Ïb–
 = "kv_scan";

144 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


145 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

146 .
¡¬t_cßr£_tim”
();

148 
Ët
 
	g¡Üage
 = 
£lf
.
¡Üage
.
şÚe
();

149 
Ët
 
mut
 
	gİtiÚs
 = 
O±iÚs
::();

150 
	gİtiÚs
.
	gkey_Úly
 = 
»q
.
g‘_key_Úly
();

152 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

153 
Ët
 
	g»s
 = 
¡Üage
.
async_sÿn
(

154 
»q
.
ke_cÚ‹xt
(),

155 
Key
::
äom_¿w
(
»q
.
g‘_¡¬t_key
()),

156 
»q
.
g‘_lim™
(è
as
 
usize
,

157 
»q
.
g‘_v”siÚ
(),

158 
İtiÚs
,

159 
cb
,

161 
Ët
 
E¼
(
e
èğ
»s
 {

162 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

166 
Ët
 
	gfutu»
 = 
futu»


167 .
m­_”r
(
E¼Ü
::
äom
)

168 .
m­
(|
v
| {

169 
Ët
 
mut
 
»¥
 = 
SÿnRe¥Ú£
::
Ãw
();

170 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

171 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

173 
»¥
.
£t_·œs
(
R•—‹dF›ld
::
äom_vec
(
exŒaù_kv_·œs
(
v
)));

175 
»¥


177 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

178 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

179 .
m­_”r
(
move
 |
e
| {

180 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

181 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

184 
	gùx
.
¥awn
(
futu»
);

187 
â
 
kv_´ewr™e
(

188 &
£lf
,

189 
ùx
: 
RpcCÚ‹xt
,

190 
mut
 
»q
: 
P»wr™eReque¡
,

191 
sšk
: 
UÇrySšk
<
P»wr™eRe¥Ú£
>,

193 
Ët
 
	gÏb–
 = "kv_prewrite";

194 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


195 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

196 .
¡¬t_cßr£_tim”
();

198 
Ët
 
	gmutiÚs
 = 
»q
.
ke_mutiÚs
()

199 .
što_™”
()

200 .
m­
(|
mut
 
x
| 
m©ch
 x.
g‘_İ
() {

201 
Op
::
Put
 => 
MutiÚ
::Put((
Key
::
äom_¿w
(
x
.
g‘_key
()), x.
ke_v®ue
())),

202 
Op
::
D–
 => 
MutiÚ
::
D–‘e
(
Key
::
äom_¿w
(
x
.
g‘_key
())),

203 
Op
::
Lock
 => 
MutiÚ
::Lock(
Key
::
äom_¿w
(
x
.
g‘_key
())),

204 
_
 => 
·nic
!("mismatch Op in…rewrite mutations"),

206 .
cŞËù
();

207 
Ët
 
mut
 
	gİtiÚs
 = 
O±iÚs
::();

208 
	gİtiÚs
.
	glock_‰l
 = 
»q
.
g‘_lock_‰l
();

209 
	gİtiÚs
.
	gsk_cÚ¡¿št_check
 = 
»q
.
g‘_sk_cÚ¡¿št_check
();

211 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

212 
Ët
 
	g»s
 = 
£lf
.
¡Üage
.
async_´ewr™e
(

213 
»q
.
ke_cÚ‹xt
(),

214 
mutiÚs
,

215 
»q
.
ke_´im¬y_lock
(),

216 
»q
.
g‘_¡¬t_v”siÚ
(),

217 
İtiÚs
,

218 
cb
,

220 
Ët
 
E¼
(
e
èğ
»s
 {

221 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

225 
Ët
 
	gfutu»
 = 
futu»


226 .
m­_”r
(
E¼Ü
::
äom
)

227 .
m­
(|
v
| {

228 
Ët
 
mut
 
»¥
 = 
P»wr™eRe¥Ú£
::
Ãw
();

229 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

230 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

232 
»¥
.
£t_”rÜs
(
R•—‹dF›ld
::
äom_vec
(
exŒaù_key_”rÜs
(
v
)));

234 
»¥


236 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

237 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

238 .
m­_”r
(
move
 |
e
| {

239 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

240 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

243 
	gùx
.
¥awn
(
futu»
);

246 
â
 
kv_comm™
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
mut
 
»q
: 
Comm™Reque¡
, 
sšk
: 
UÇrySšk
<
Comm™Re¥Ú£
>) {

247 
Ët
 
Ïb–
 = "kv_commit";

248 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


249 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

250 .
¡¬t_cßr£_tim”
();

252 
Ët
 
	gkeys
 = 
»q
.
g‘_keys
().
™”
().
m­
(|
x
| 
Key
::
äom_¿w
(x)).
cŞËù
();

254 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

255 
Ët
 
	g»s
 = 
£lf
.
¡Üage
.
async_comm™
(

256 
»q
.
ke_cÚ‹xt
(),

257 
keys
,

258 
»q
.
g‘_¡¬t_v”siÚ
(),

259 
»q
.
g‘_comm™_v”siÚ
(),

260 
cb
,

262 
Ët
 
E¼
(
e
èğ
»s
 {

263 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

267 
Ët
 
	gfutu»
 = 
futu»


268 .
m­_”r
(
E¼Ü
::
äom
)

269 .
m­
(|
v
| {

270 
Ët
 
mut
 
»¥
 = 
Comm™Re¥Ú£
::
Ãw
();

271 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

272 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

273 } 
Ët
 
E¼
(
e
èğ
v
 {

274 
»¥
.
£t_”rÜ
(
exŒaù_key_”rÜ
(&
e
));

276 
»¥


278 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

279 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

280 .
m­_”r
(
move
 |
e
| {

281 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

282 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

285 
	gùx
.
¥awn
(
futu»
);

288 
â
 
kv_impÜt
(&
£lf
, 
_
: 
RpcCÚ‹xt
, _: 
ImpÜtReque¡
, _: 
UÇrySšk
<
ImpÜtRe¥Ú£
>) {

289 
unim¶em’‹d
!();

292 
â
 
kv_ş—nup
(

293 &
£lf
,

294 
ùx
: 
RpcCÚ‹xt
,

295 
mut
 
»q
: 
CËªupReque¡
,

296 
sšk
: 
UÇrySšk
<
CËªupRe¥Ú£
>,

298 
Ët
 
	gÏb–
 = "kv_cleanup";

299 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


300 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

301 .
¡¬t_cßr£_tim”
();

303 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

304 
Ët
 
	g»s
 = 
£lf
.
¡Üage
.
async_ş—nup
(

305 
»q
.
ke_cÚ‹xt
(),

306 
Key
::
äom_¿w
(
»q
.
g‘_key
()),

307 
»q
.
g‘_¡¬t_v”siÚ
(),

308 
cb
,

310 
Ët
 
E¼
(
e
èğ
»s
 {

311 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

315 
Ët
 
	gfutu»
 = 
futu»


316 .
m­_”r
(
E¼Ü
::
äom
)

317 .
m­
(|
v
| {

318 
Ët
 
mut
 
»¥
 = 
CËªupRe¥Ú£
::
Ãw
();

319 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

320 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

321 } 
Ët
 
E¼
(
e
èğ
v
 {

322 
Ët
 
Some
(
ts
èğ
exŒaù_comm™‹d
(&
e
) {

323 
»¥
.
£t_comm™_v”siÚ
(
ts
);

325 
»¥
.
£t_”rÜ
(
exŒaù_key_”rÜ
(&
e
));

328 
»¥


330 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

331 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

332 .
m­_”r
(
move
 |
e
| {

333 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

334 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

337 
	gùx
.
¥awn
(
futu»
);

340 
â
 
kv_b©ch_g‘
(

341 &
£lf
,

342 
ùx
: 
RpcCÚ‹xt
,

343 
mut
 
»q
: 
B©chG‘Reque¡
,

344 
sšk
: 
UÇrySšk
<
B©chG‘Re¥Ú£
>,

346 
Ët
 
	gÏb–
 = "kv_batchget";

347 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


348 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

349 .
¡¬t_cßr£_tim”
();

351 
Ët
 
	gkeys
 = 
»q
.
g‘_keys
()

352 .
što_™”
()

353 .
m­
(|
x
| 
Key
::
äom_¿w
(x))

354 .
cŞËù
();

356 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

357 
Ët
 
	g»s
 = 
£lf
.
¡Üage


358 .
async_b©ch_g‘
(
»q
.
ke_cÚ‹xt
(), 
keys
,„eq.
g‘_v”siÚ
(), 
cb
);

359 
Ët
 
E¼
(
e
èğ
»s
 {

360 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

364 
Ët
 
	gfutu»
 = 
futu»


365 .
m­_”r
(
E¼Ü
::
äom
)

366 .
m­
(|
v
| {

367 
Ët
 
mut
 
»¥
 = 
B©chG‘Re¥Ú£
::
Ãw
();

368 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

369 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

371 
»¥
.
£t_·œs
(
R•—‹dF›ld
::
äom_vec
(
exŒaù_kv_·œs
(
v
)))

373 
»¥


375 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

376 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

377 .
m­_”r
(
move
 |
e
| {

378 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

379 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

382 
	gùx
.
¥awn
(
futu»
);

385 
â
 
kv_b©ch_rŞlback
(

386 &
£lf
,

387 
ùx
: 
RpcCÚ‹xt
,

388 
mut
 
»q
: 
B©chRŞlbackReque¡
,

389 
sšk
: 
UÇrySšk
<
B©chRŞlbackRe¥Ú£
>,

391 
Ët
 
	gÏb–
 = "kv_batch_rollback";

392 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


393 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

394 .
¡¬t_cßr£_tim”
();

396 
Ët
 
	gkeys
 = 
»q
.
g‘_keys
()

397 .
što_™”
()

398 .
m­
(|
x
| 
Key
::
äom_¿w
(x))

399 .
cŞËù
();

401 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

402 
Ët
 
	g»s
 = 
£lf
.
¡Üage


403 .
async_rŞlback
(
»q
.
ke_cÚ‹xt
(), 
keys
,„eq.
g‘_¡¬t_v”siÚ
(), 
cb
);

404 
Ët
 
E¼
(
e
èğ
»s
 {

405 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

409 
Ët
 
	gfutu»
 = 
futu»


410 .
m­_”r
(
E¼Ü
::
äom
)

411 .
m­
(|
v
| {

412 
Ët
 
mut
 
»¥
 = 
B©chRŞlbackRe¥Ú£
::
Ãw
();

413 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

414 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

415 } 
Ët
 
E¼
(
e
èğ
v
 {

416 
»¥
.
£t_”rÜ
(
exŒaù_key_”rÜ
(&
e
));

418 
»¥


420 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

421 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

422 .
m­_”r
(
move
 |
e
| {

423 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

424 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

427 
	gùx
.
¥awn
(
futu»
);

430 
â
 
kv_sÿn_lock
(

431 &
£lf
,

432 
ùx
: 
RpcCÚ‹xt
,

433 
mut
 
»q
: 
SÿnLockReque¡
,

434 
sšk
: 
UÇrySšk
<
SÿnLockRe¥Ú£
>,

436 
Ët
 
	gÏb–
 = "kv_scan_lock";

437 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


438 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

439 .
¡¬t_cßr£_tim”
();

441 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

442 
Ët
 
	g»s
 = 
£lf
.
¡Üage


443 .
async_sÿn_lock
(
»q
.
ke_cÚ‹xt
(),„eq.
g‘_max_v”siÚ
(), 
cb
);

444 
Ët
 
E¼
(
e
èğ
»s
 {

445 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

449 
Ët
 
	gfutu»
 = 
futu»


450 .
m­_”r
(
E¼Ü
::
äom
)

451 .
m­
(|
v
| {

452 
Ët
 
mut
 
»¥
 = 
SÿnLockRe¥Ú£
::
Ãw
();

453 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

454 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

456 
m©ch
 
v
 {

457 
Ok
(
locks
è=> 
»¥
.
£t_locks
(
R•—‹dF›ld
::
äom_vec
(locks)),

458 
E¼
(
e
è=> 
»¥
.
£t_”rÜ
(
exŒaù_key_”rÜ
(&e)),

461 
»¥


463 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

464 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

465 .
m­_”r
(
move
 |
e
| {

466 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

467 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

470 
	gùx
.
¥awn
(
futu»
);

473 
â
 
kv_»sŞve_lock
(

474 &
£lf
,

475 
ùx
: 
RpcCÚ‹xt
,

476 
mut
 
»q
: 
ResŞveLockReque¡
,

477 
sšk
: 
UÇrySšk
<
ResŞveLockRe¥Ú£
>,

479 
Ët
 
	gÏb–
 = "kv_resolve_lock";

480 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


481 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

482 .
¡¬t_cßr£_tim”
();

484 
Ët
 
	gtxn_¡©us
 = 
»q
.
g‘_¡¬t_v”siÚ
() > 0 {

485 
HashM­
::
äom_™”
(
™”
::
Úû
(

486 (
»q
.
g‘_¡¬t_v”siÚ
(),„eq.
g‘_comm™_v”siÚ
()),

489 
HashM­
::
äom_™”
(

490 
»q
.
ke_txn_šfos
()

491 .
što_™”
()

492 .
m­
(|
šfo
| (šfo.
txn
, info.
¡©us
)),

496 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

497 
Ët
 
	g»s
 = 
£lf
.
¡Üage


498 .
async_»sŞve_lock
(
»q
.
ke_cÚ‹xt
(), 
txn_¡©us
, 
cb
);

499 
Ët
 
E¼
(
e
èğ
»s
 {

500 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

504 
Ët
 
	gfutu»
 = 
futu»


505 .
m­_”r
(
E¼Ü
::
äom
)

506 .
m­
(|
v
| {

507 
Ët
 
mut
 
»¥
 = 
ResŞveLockRe¥Ú£
::
Ãw
();

508 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

509 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

510 } 
Ët
 
E¼
(
e
èğ
v
 {

511 
»¥
.
£t_”rÜ
(
exŒaù_key_”rÜ
(&
e
));

513 
»¥


515 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

516 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

517 .
m­_”r
(
move
 |
e
| {

518 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

519 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

522 
	gùx
.
¥awn
(
futu»
);

525 
â
 
kv_gc
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
mut
 
»q
: 
GCReque¡
, 
sšk
: 
UÇrySšk
<
GCRe¥Ú£
>) {

526 
Ët
 
Ïb–
 = "kv_gc";

527 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


528 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

529 .
¡¬t_cßr£_tim”
();

531 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

532 
Ët
 
	g»s
 = 
£lf
.
¡Üage


533 .
async_gc
(
»q
.
ke_cÚ‹xt
(),„eq.
g‘_§ã_pošt
(), 
cb
);

534 
Ët
 
E¼
(
e
èğ
»s
 {

535 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

539 
Ët
 
	gfutu»
 = 
futu»


540 .
m­_”r
(
E¼Ü
::
äom
)

541 .
m­
(|
v
| {

542 
Ët
 
mut
 
»¥
 = 
GCRe¥Ú£
::
Ãw
();

543 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

544 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

545 } 
Ët
 
E¼
(
e
èğ
v
 {

546 
»¥
.
£t_”rÜ
(
exŒaù_key_”rÜ
(&
e
));

548 
»¥


550 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

551 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

552 .
m­_”r
(
move
 |
e
| {

553 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

554 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

557 
	gùx
.
¥awn
(
futu»
);

560 
â
 
kv_d–‘e_¿nge
(

561 &
£lf
,

562 
ùx
: 
RpcCÚ‹xt
,

563 
mut
 
»q
: 
D–‘eRªgeReque¡
,

564 
sšk
: 
UÇrySšk
<
D–‘eRªgeRe¥Ú£
>,

566 
Ët
 
	gÏb–
 = "kv_delete_range";

567 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


568 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

569 .
¡¬t_cßr£_tim”
();

571 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

572 
Ët
 
	g»s
 = 
£lf
.
¡Üage
.
async_d–‘e_¿nge
(

573 
»q
.
ke_cÚ‹xt
(),

574 
Key
::
äom_¿w
(
»q
.
g‘_¡¬t_key
()),

575 
Key
::
äom_¿w
(
»q
.
g‘_’d_key
()),

576 
cb
,

578 
Ët
 
E¼
(
e
èğ
»s
 {

579 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

583 
Ët
 
	gfutu»
 = 
futu»


584 .
m­_”r
(
E¼Ü
::
äom
)

585 .
m­
(|
v
| {

586 
Ët
 
mut
 
»¥
 = 
D–‘eRªgeRe¥Ú£
::
Ãw
();

587 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

588 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

589 } 
Ët
 
E¼
(
e
èğ
v
 {

590 
»¥
.
£t_”rÜ
(
fÜm©
!("{}", 
e
));

592 
»¥


594 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

595 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

596 .
m­_”r
(
move
 |
e
| {

597 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

598 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

601 
	gùx
.
¥awn
(
futu»
);

604 
â
 
¿w_g‘
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
mut
 
»q
: 
RawG‘Reque¡
, 
sšk
: 
UÇrySšk
<
RawG‘Re¥Ú£
>) {

605 
Ët
 
Ïb–
 = "raw_get";

606 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


607 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

608 .
¡¬t_cßr£_tim”
();

610 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

611 
Ët
 
	g»s
 = 
£lf
.
¡Üage


612 .
async_¿w_g‘
(
»q
.
ke_cÚ‹xt
(),„eq.
ke_key
(), 
cb
);

613 
Ët
 
E¼
(
e
èğ
»s
 {

614 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

618 
Ët
 
	gfutu»
 = 
futu»


619 .
m­_”r
(
E¼Ü
::
äom
)

620 .
m­
(|
v
| {

621 
Ët
 
mut
 
»¥
 = 
RawG‘Re¥Ú£
::
Ãw
();

622 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

623 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

625 
m©ch
 
v
 {

626 
Ok
(
Some
(
v®
)è=> 
»¥
.
£t_v®ue
(val),

627 
Ok
(
NÚe
) => {}

628 
E¼
(
e
è=> 
»¥
.
£t_”rÜ
(
fÜm©
!("{}",ƒ)),

631 
»¥


633 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

634 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

635 .
m­_”r
(
move
 |
e
| {

636 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

637 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

640 
	gùx
.
¥awn
(
futu»
);

643 
â
 
¿w_sÿn
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
mut
 
»q
: 
RawSÿnReque¡
, 
sšk
: 
UÇrySšk
<
RawSÿnRe¥Ú£
>) {

644 
Ët
 
Ïb–
 = "raw_scan";

645 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


646 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

647 .
¡¬t_cßr£_tim”
();

649 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

650 
Ët
 
	g»s
 = 
£lf
.
¡Üage
.
async_¿w_sÿn
(

651 
»q
.
ke_cÚ‹xt
(),

652 
»q
.
ke_¡¬t_key
(),

653 
»q
.
g‘_lim™
(è
as
 
usize
,

654 
cb
,

656 
Ët
 
E¼
(
e
èğ
»s
 {

657 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

661 
Ët
 
	gfutu»
 = 
futu»


662 .
m­_”r
(
E¼Ü
::
äom
)

663 .
m­
(|
v
| {

664 
Ët
 
mut
 
»¥
 = 
RawSÿnRe¥Ú£
::
Ãw
();

665 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

666 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

668 
»¥
.
£t_kvs
(
R•—‹dF›ld
::
äom_vec
(
exŒaù_kv_·œs
(
v
)));

670 
»¥


672 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

673 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

674 .
m­_”r
(
move
 |
e
| {

675 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

676 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

679 
	gùx
.
¥awn
(
futu»
);

682 
â
 
¿w_put
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
mut
 
»q
: 
RawPutReque¡
, 
sšk
: 
UÇrySšk
<
RawPutRe¥Ú£
>) {

683 
Ët
 
Ïb–
 = "raw_put";

684 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


685 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

686 .
¡¬t_cßr£_tim”
();

688 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

689 
Ët
 
	g»s
 = 
£lf
.
¡Üage


690 .
async_¿w_put
(
»q
.
ke_cÚ‹xt
(),„eq.
ke_key
(),„eq.
ke_v®ue
(), 
cb
);

691 
Ët
 
E¼
(
e
èğ
»s
 {

692 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

696 
Ët
 
	gfutu»
 = 
futu»


697 .
m­_”r
(
E¼Ü
::
äom
)

698 .
m­
(|
v
| {

699 
Ët
 
mut
 
»¥
 = 
RawPutRe¥Ú£
::
Ãw
();

700 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

701 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

702 } 
Ët
 
E¼
(
e
èğ
v
 {

703 
»¥
.
£t_”rÜ
(
fÜm©
!("{}", 
e
));

705 
»¥


707 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

708 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

709 .
m­_”r
(
move
 |
e
| {

710 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

711 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

714 
	gùx
.
¥awn
(
futu»
);

717 
â
 
¿w_d–‘e
(

718 &
£lf
,

719 
ùx
: 
RpcCÚ‹xt
,

720 
mut
 
»q
: 
RawD–‘eReque¡
,

721 
sšk
: 
UÇrySšk
<
RawD–‘eRe¥Ú£
>,

723 
Ët
 
	gÏb–
 = "raw_delete";

724 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


725 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

726 .
¡¬t_cßr£_tim”
();

728 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

729 
Ët
 
	g»s
 = 
£lf
.
¡Üage


730 .
async_¿w_d–‘e
(
»q
.
ke_cÚ‹xt
(),„eq.
ke_key
(), 
cb
);

731 
Ët
 
E¼
(
e
èğ
»s
 {

732 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

736 
Ët
 
	gfutu»
 = 
futu»


737 .
m­_”r
(
E¼Ü
::
äom
)

738 .
m­
(|
v
| {

739 
Ët
 
mut
 
»¥
 = 
RawD–‘eRe¥Ú£
::
Ãw
();

740 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

741 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

742 } 
Ët
 
E¼
(
e
èğ
v
 {

743 
»¥
.
£t_”rÜ
(
fÜm©
!("{}", 
e
));

745 
»¥


747 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

748 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

749 .
m­_”r
(
move
 |
e
| {

750 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

751 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

754 
	gùx
.
¥awn
(
futu»
);

757 
â
 
cİroûssÜ
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
»q
: 
Reque¡
, 
sšk
: 
UÇrySšk
<
Re¥Ú£
>) {

758 
Ët
 
Ïb–
 = "coprocessor";

759 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


760 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

761 .
¡¬t_cßr£_tim”
();

763 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

764 
Ët
 
	g»s
 = 
£lf
.
’d_pošt_scheduËr
.
scheduË
(
EndPoštTask
::
Reque¡
(

765 
Reque¡Task
::
Ãw
(
»q
, 
cb
, 
£lf
.
»cursiÚ_lim™
),

767 
Ët
 
E¼
(
e
èğ
»s
 {

768 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

772 
Ët
 
	gfutu»
 = 
futu»


773 .
m­_”r
(
E¼Ü
::
äom
)

774 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

775 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

776 .
m­_”r
(
move
 |
e
| {

777 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

778 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

781 
	gùx
.
¥awn
(
futu»
);

784 
â
 
cİroûssÜ_¡»am
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
_
: 
Reque¡
, 
sšk
: 
S”v”SŒ—mšgSšk
<
Re¥Ú£
>) {

785 
Ët
 
f
 = 
sšk
.
ç
(
RpcStus
::
Ãw
(
RpcStusCode
::
Unim¶em’‹d
, 
NÚe
))

786 .
m­_”r
(|
e
| 
”rÜ
!("failedo„eport unimplemented method: {:?}",ƒ));

787 
	gùx
.
¥awn
(
f
);

790 
â
 
¿á
(

791 &
£lf
,

792 
ùx
: 
RpcCÚ‹xt
,

793 
¡»am
: 
Reque¡SŒ—m
<
RaáMes§ge
>,

794 
_
: 
Cl›ÁSŒ—mšgSšk
<
DÚe
>,

796 
Ët
 
	gch
 = 
£lf
.
ch
.
şÚe
();

797 
	gùx
.
¥awn
(

798 
¡»am


799 .
m­_”r
(
E¼Ü
::
äom
)

800 .
fÜ_—ch
(
move
 |
msg
| {

801 
RAFT_MESSAGE_RECV_COUNTER
.
šc
();

802 
futu»
::
»suÉ
(
ch
.
£nd_¿á_msg
(
msg
)).
m­_”r
(
E¼Ü
::
äom
)

804 .
m­_”r
(|
e
| 
”rÜ
!("send„aft msgo„aft store fail: {}",ƒ))

805 .
th’
(|
_
| 
futu»
::
ok
::<_, ()>(())),

809 
â
 
¢­shÙ
(

810 &
£lf
,

811 
ùx
: 
RpcCÚ‹xt
,

812 
¡»am
: 
Reque¡SŒ—m
<
SÇpshÙChunk
>,

813 
sšk
: 
Cl›ÁSŒ—mšgSšk
<
DÚe
>,

815 
Ët
 
	gtok’
 = 
Tok’
(
£lf
.
tok’
.
ãtch_add
(1, 
Ord”šg
::
SeqC¡
));

816 
Ët
 
	gsched
 = 
£lf
.
¢­_scheduËr
.
şÚe
();

817 
Ët
 
	gsched2
 = 
sched
.
şÚe
();

818 
	gùx
.
¥awn
(

819 
¡»am


820 .
m­_”r
(
E¼Ü
::
äom
)

821 .
fÜ_—ch
(
move
 |
mut
 
chunk
| {

822 
Ët
 
»s
 = 
chunk
.
has_mes§ge
() {

823 
sched


824 .
scheduË
(
SÇpTask
::
Regi¡”
(
tok’
, 
chunk
.
ke_mes§ge
()))

825 .
m­_”r
(
E¼Ü
::
äom
)

826 } !
chunk
.
g‘_d©a
().
is_em±y
() {

828 
Ët
 
mut
 
b
 = 
PeBufãr
::
Ãw
(
chunk
.
g‘_d©a
().
Ën
());

829 
b
.
wr™e_®l
(
chunk
.
g‘_d©a
()).
unw¿p
();

830 
sched


831 .
scheduË
(
SÇpTask
::
Wr™e
(
tok’
, 
b
))

832 .
m­_”r
(
E¼Ü
::
äom
)

834 
E¼
(
box_”r
!("empty chunk"))

836 
futu»
::
»suÉ
(
»s
)

838 .
th’
(
move
 |
»s
| {

839 
Ët
 
»s
 = 
m©ch
„es {

840 
Ok
(
_
è=> 
sched2
.
scheduË
(
SÇpTask
::
Clo£
(
tok’
)),

841 
E¼
(
e
) => {

842 
”rÜ
!("»ûiv¢­shÙƒ¼: {}", 
e
);

843 
sched2
.
scheduË
(
SÇpTask
::
Disÿrd
(
tok’
))

846 
futu»
::
»suÉ
(
»s
.
m­_”r
(
E¼Ü
::
äom
))

848 .
ªd_th’
(|
_
| 
sšk
.
sucûss
(
DÚe
::
Ãw
()).
m­_”r
(
E¼Ü
::
äom
))

849 .
th’
(|
_
| 
futu»
::
ok
::<_, ()>(())),

853 
â
 
mvcc_g‘_by_key
(

854 &
£lf
,

855 
ùx
: 
RpcCÚ‹xt
,

856 
mut
 
»q
: 
MvccG‘ByKeyReque¡
,

857 
sšk
: 
UÇrySšk
<
MvccG‘ByKeyRe¥Ú£
>,

859 
Ët
 
	gÏb–
 = "mvcc_get_by_key";

860 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


861 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

862 .
¡¬t_cßr£_tim”
();

864 
Ët
 
	g¡Üage
 = 
£lf
.
¡Üage
.
şÚe
();

866 
Ët
 
	gkey
 = 
Key
::
äom_¿w
(
»q
.
g‘_key
());

867 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

868 
Ët
 
	g»s
 = 
¡Üage
.
async_mvcc_by_key
(
»q
.
ke_cÚ‹xt
(), 
key
.
şÚe
(), 
cb
);

869 
Ët
 
E¼
(
e
èğ
»s
 {

870 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

874 
Ët
 
	gfutu»
 = 
futu»


875 .
m­_”r
(
E¼Ü
::
äom
)

876 .
m­
(|
v
| {

877 
Ët
 
mut
 
»¥
 = 
MvccG‘ByKeyRe¥Ú£
::
Ãw
();

878 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

879 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

881 
m©ch
 
v
 {

882 
Ok
(
mvcc
) => {

883 
»¥
.
£t_šfo
(
exŒaù_mvcc_šfo
(
key
, 
mvcc
));

885 
E¼
(
e
è=> 
»¥
.
£t_”rÜ
(
fÜm©
!("{}",ƒ)),

888 
»¥


890 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

891 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

892 .
m­_”r
(
move
 |
e
| {

893 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

894 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

897 
	gùx
.
¥awn
(
futu»
);

900 
â
 
mvcc_g‘_by_¡¬t_ts
(

901 &
£lf
,

902 
ùx
: 
RpcCÚ‹xt
,

903 
mut
 
»q
: 
MvccG‘ByS¹TsReque¡
,

904 
sšk
: 
UÇrySšk
<
MvccG‘ByS¹TsRe¥Ú£
>,

906 
Ët
 
	gÏb–
 = "mvcc_get_by_start_ts";

907 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


908 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

909 .
¡¬t_cßr£_tim”
();

911 
Ët
 
	g¡Üage
 = 
£lf
.
¡Üage
.
şÚe
();

913 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

915 
Ët
 
	g»s
 = 
¡Üage
.
async_mvcc_by_¡¬t_ts
(
»q
.
ke_cÚ‹xt
(),„eq.
g‘_¡¬t_ts
(), 
cb
);

916 
Ët
 
E¼
(
e
èğ
»s
 {

917 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

921 
Ët
 
	gfutu»
 = 
futu»


922 .
m­_”r
(
E¼Ü
::
äom
)

923 .
m­
(|
v
| {

924 
Ët
 
mut
 
»¥
 = 
MvccG‘ByS¹TsRe¥Ú£
::
Ãw
();

925 
Ët
 
Some
(
”r
èğ
exŒaù_»giÚ_”rÜ
(&
v
) {

926 
»¥
.
£t_»giÚ_”rÜ
(
”r
);

928 
m©ch
 
v
 {

929 
Ok
(
Some
((
k
, 
vv
))) => {

930 
»¥
.
£t_key
(
k
.
¿w
().
unw¿p
());

931 
»¥
.
£t_šfo
(
exŒaù_mvcc_šfo
(
k
, 
vv
));

933 
Ok
(
NÚe
) => {

934 
»¥
.
£t_šfo
(
DeçuÉ
::());

936 
E¼
(
e
è=> 
»¥
.
£t_”rÜ
(
fÜm©
!("{}",ƒ)),

939 
»¥


941 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

942 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

943 .
m­_”r
(
move
 |
e
| {

944 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

945 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

947 
	gùx
.
¥awn
(
futu»
);

950 
â
 
¥l™_»giÚ
(

951 &
£lf
,

952 
ùx
: 
RpcCÚ‹xt
,

953 
mut
 
»q
: 
S¶™RegiÚReque¡
,

954 
sšk
: 
UÇrySšk
<
S¶™RegiÚRe¥Ú£
>,

956 
Ët
 
	gÏb–
 = "split_region";

957 
Ët
 
	gtim”
 = 
GRPC_MSG_HISTOGRAM_VEC


958 .
w™h_Ïb–_v®ues
(&[
Ïb–
])

959 .
¡¬t_cßr£_tim”
();

961 
Ët
 (
cb
, 
futu»
èğ
make_ÿÎback
();

962 
Ët
 
	g»q
 = 
StÜeMes§ge
::
S¶™RegiÚ
 {

963 
»giÚ_id
: 
»q
.
g‘_cÚ‹xt
().
g‘_»giÚ_id
(),

964 
»giÚ_•och
: 
»q
.
ke_cÚ‹xt
().
ke_»giÚ_•och
(),

965 
¥l™_key
: 
Key
::
äom_¿w
(
»q
.
g‘_¥l™_key
()).
’coded
().
şÚe
(),

966 
ÿÎback
: 
Some
(
cb
),

969 
Ët
 
E¼
(
e
èğ
£lf
.
ch
.
Œy_£nd
(
»q
) {

970 
£lf
.
£nd_ç_¡©us
(
ùx
, 
sšk
, 
E¼Ü
::
äom
(
e
), 
RpcStusCode
::
ResourûExhau¡ed
);

974 
Ët
 
	gfutu»
 = 
futu»


975 .
m­_”r
(
E¼Ü
::
äom
)

976 .
m­
(|
mut
 
v
| {

977 
Ët
 
mut
 
»¥
 = 
S¶™RegiÚRe¥Ú£
::
Ãw
();

978 
v
.
g‘_h—d”
().
has_”rÜ
() {

979 
»¥
.
£t_»giÚ_”rÜ
(
v
.
mut_h—d”
().
ke_”rÜ
());

981 
Ët
 
admš_»¥
 = 
v
.
mut_admš_»¥Ú£
();

982 
Ët
 
¥l™_»¥
 = 
admš_»¥
.
mut_¥l™
();

983 
»¥
.
£t_Ëá
(
¥l™_»¥
.
ke_Ëá
());

984 
»¥
.
£t_right
(
¥l™_»¥
.
ke_right
());

986 
»¥


988 .
ªd_th’
(|
»s
| 
sšk
.
sucûss
Ôes).
m­_”r
(
E¼Ü
::
äom
))

989 .
m­
(|
_
| 
tim”
.
ob£rve_du¿tiÚ
())

990 .
m­_”r
(
move
 |
e
| {

991 
debug
!("{} faed: {:?}", 
Ïb–
, 
e
);

992 
GRPC_MSG_FAIL_COUNTER
.
w™h_Ïb–_v®ues
(&[
Ïb–
]).
šc
();

995 
	gùx
.
¥awn
(
futu»
);

999 
â
 
	gexŒaù_»giÚ_”rÜ
<
	gT
>(
	g»s
: &
¡Üage
::
ResuÉ
<
T
>è-> 
O±iÚ
<
RegiÚE¼Ü
> {

1000 
u£
 
¡Üage
::
E¼Ü
;

1001 
m©ch
 *
	g»s
 {

1003 
E¼
(
E¼Ü
::
Engše
(
EngšeE¼Ü
::
Reque¡
(
»f
 
e
))) |

1004 
E¼
(
E¼Ü
::
Txn
(
TxnE¼Ü
::
Engše
(
EngšeE¼Ü
::
Reque¡
(
»f
 
e
)))) |

1005 
E¼
(
E¼Ü
::
Txn
(
TxnE¼Ü
::
Mvcc
(
MvccE¼Ü
::
Engše
(
EngšeE¼Ü
::
Reque¡
(
»f
 
e
))))) => {

1006 
Some
(
e
.
to_owÃd
())

1008 
E¼
(
E¼Ü
::
SchedTooBusy
) => {

1009 
Ët
 
mut
 
”r
 = 
RegiÚE¼Ü
::
Ãw
();

1010 
Ët
 
mut
 
	g£rv”_is_busy_”r
 = 
S”v”IsBusy
::
Ãw
();

1011 
	g£rv”_is_busy_”r
.
£t_»asÚ
(
SCHEDULER_IS_BUSY
.
to_owÃd
());

1012 
	g”r
.
£t_£rv”_is_busy
(
£rv”_is_busy_”r
);

1013 
Some
(
”r
)

1015 
	g_
 => 
NÚe
,

1019 
â
 
exŒaù_comm™‹d
(
”r
: &
¡Üage
::
E¼Ü
è-> 
O±iÚ
<
u64
> {

1020 
m©ch
 *
”r
 {

1021 
¡Üage
::
E¼Ü
::
Txn
(
TxnE¼Ü
::
Mvcc
(
MvccE¼Ü
::
Comm™‹d
 { 
comm™_ts
 })è=> 
Some
(commit_ts),

1022 
	g_
 => 
NÚe
,

1026 
â
 
exŒaù_key_”rÜ
(
”r
: &
¡Üage
::
E¼Ü
è-> 
KeyE¼Ü
 {

1027 
Ët
 
mut
 
key_”rÜ
 = 
KeyE¼Ü
::
Ãw
();

1028 
m©ch
 *
	g”r
 {

1029 
	g¡Üage
::
E¼Ü
::
Txn
(

1030 
TxnE¼Ü
::
Mvcc
(
MvccE¼Ü
::
KeyIsLocked
 {

1031 
»f
 
key
,

1032 
»f
 
´im¬y
,

1033 
ts
,

1034 
‰l
,

1037 
Ët
 
mut
 
lock_šfo
 = 
LockInfo
::
Ãw
();

1038 
	glock_šfo
.
£t_key
(
key
.
to_owÃd
());

1039 
	glock_šfo
.
£t_´im¬y_lock
(
´im¬y
.
to_owÃd
());

1040 
	glock_šfo
.
£t_lock_v”siÚ
(
ts
);

1041 
	glock_šfo
.
£t_lock_‰l
(
‰l
);

1042 
	gkey_”rÜ
.
£t_locked
(
lock_šfo
);

1044 
	g¡Üage
::
E¼Ü
::
Txn
(
TxnE¼Ü
::
Mvcc
(
MvccE¼Ü
::
Wr™eCÚæiù
 { .. })) |

1045 
¡Üage
::
E¼Ü
::
Txn
(
TxnE¼Ü
::
Mvcc
(
MvccE¼Ü
::
TxnLockNÙFound
 { .. })) => {

1046 
w¬n
!("txÀcÚæiùs: {:?}", 
”r
);

1047 
	gkey_”rÜ
.
£t_»ŒyabË
(
fÜm©
!("{:?}", 
”r
));

1049 
	g_
 => {

1050 
”rÜ
!("txÀabÜts: {:?}", 
”r
);

1051 
	gkey_”rÜ
.
£t_abÜt
(
fÜm©
!("{:?}", 
”r
));

1054 
	gkey_”rÜ


1057 
â
 
exŒaù_kv_·œs
(
»s
: 
¡Üage
::
ResuÉ
<
Vec
<¡Üage::ResuÉ<¡Üage::
KvPaœ
>>>) -> Vec<KvPair> {

1058 
m©ch
 
»s
 {

1059 
Ok
(
»s
è=>„es.
što_™”
()

1060 .
m­
(|
r
| 
m©ch
„ {

1061 
Ok
((
key
, 
v®ue
)) => {

1062 
Ët
 
mut
 
·œ
 = 
KvPaœ
::
Ãw
();

1063 
·œ
.
£t_key
(
key
);

1064 
·œ
.
£t_v®ue
(
v®ue
);

1065 
·œ


1067 
E¼
(
e
) => {

1068 
Ët
 
mut
 
·œ
 = 
KvPaœ
::
Ãw
();

1069 
·œ
.
£t_”rÜ
(
exŒaù_key_”rÜ
(&
e
));

1070 
·œ


1073 .
cŞËù
(),

1074 
E¼
(
e
) => {

1075 
Ët
 
mut
 
·œ
 = 
KvPaœ
::
Ãw
();

1076 
	g·œ
.
£t_”rÜ
(
exŒaù_key_”rÜ
(&
e
));

1077 
	gvec
![
·œ
]

1082 
â
 
exŒaù_mvcc_šfo
(
key
: 
Key
, 
mvcc
: 
¡Üage
::
MvccInfo
) -> MvccInfo {

1083 
Ët
 
mut
 
mvcc_šfo
 = 
MvccInfo
::
Ãw
();

1084 
Ët
 
Some
(
lock
èğ
mvcc
.lock {

1085 
Ët
 
mut
 
lock_šfo
 = 
LockInfo
::
Ãw
();

1086 
	glock_šfo
.
£t_´im¬y_lock
(
lock
.
´im¬y
);

1087 
	glock_šfo
.
£t_key
(
key
.
¿w
().
unw¿p
());

1088 
	glock_šfo
.
£t_lock_‰l
(
lock
.
‰l
);

1089 
	glock_šfo
.
£t_lock_v”siÚ
(
lock
.
ts
);

1090 
	gmvcc_šfo
.
£t_lock
(
lock_šfo
);

1092 
Ët
 
	gvv
 = 
exŒaù_2pc_v®ues
(
mvcc
.
v®ues
);

1093 
Ët
 
	gvw
 = 
exŒaù_2pc_wr™es
(
mvcc
.
wr™es
);

1094 
	gmvcc_šfo
.
£t_wr™es
(
R•—‹dF›ld
::
äom_vec
(
vw
));

1095 
	gmvcc_šfo
.
£t_v®ues
(
R•—‹dF›ld
::
äom_vec
(
vv
));

1096 
	gmvcc_šfo


1099 
â
 
exŒaù_2pc_v®ues
(
»s
: 
Vec
<(
u64
, 
boŞ
, 
V®ue
)>è-> 
	gVec
<
	gV®ueInfo
> {

1100 
	g»s
.
što_™”
()

1101 .
m­
(|(
¡¬t_ts
, 
is_shÜt
, 
v®ue
)| {

1102 
Ët
 
mut
 
v®ue_šfo
 = 
V®ueInfo
::
Ãw
();

1103 
v®ue_šfo
.
£t_ts
(
¡¬t_ts
);

1104 
v®ue_šfo
.
£t_v®ue
(
v®ue
);

1105 
v®ue_šfo
.
£t_is_shÜt_v®ue
(
is_shÜt
);

1106 
v®ue_šfo


1108 .
cŞËù
()

1111 
â
 
exŒaù_2pc_wr™es
(
»s
: 
Vec
<(
u64
, 
MvccWr™e
)>è-> 
	gVec
<
	gWr™eInfo
> {

1112 
	g»s
.
što_™”
()

1113 .
m­
(|(
comm™_ts
, 
wr™e
)| {

1114 
Ët
 
mut
 
wr™e_šfo
 = 
Wr™eInfo
::
Ãw
();

1115 
wr™e_šfo
.
£t_¡¬t_ts
(
wr™e
.
¡¬t_ts
);

1116 
Ët
 
İ
 = 
m©ch
 
wr™e
.
wr™e_ty³
 {

1117 
Wr™eTy³
::
Put
 => 
Op
::Put,

1118 
Wr™eTy³
::
D–‘e
 => 
Op
::
D–
,

1119 
Wr™eTy³
::
Lock
 => 
Op
::Lock,

1120 
Wr™eTy³
::
RŞlback
 => 
Op
::Rollback,

1122 
wr™e_šfo
.
£t_f›ld_ty³
(
İ
);

1123 
wr™e_šfo
.
£t_comm™_ts
(
comm™_ts
);

1124 
wr™e_šfo


1126 .
cŞËù
()

1129 
â
 
exŒaù_key_”rÜs
(
»s
: 
¡Üage
::
ResuÉ
<
Vec
<¡Üage::ResuÉ<()>>>è-> Vec<
KeyE¼Ü
> {

1130 
m©ch
 
»s
 {

1131 
Ok
(
»s
è=>„es.
što_™”
()

1132 .
f‹r_m­
(|
x
| 
m©ch
 x {

1133 
E¼
(
e
è=> 
Some
(
exŒaù_key_”rÜ
(&e)),

1134 
Ok
(
_
è=> 
NÚe
,

1136 .
cŞËù
(),

1137 
E¼
(
e
è=> 
vec
![
exŒaù_key_”rÜ
(&e)],

	@src/server/service/mod.rs

14 
mod
 
	gkv
;

15 
mod
 
	gdebug
;

17 
pub
 
u£
 
	g£lf
::
kv
::
S”viû
 
as
 
KvS”viû
;

18 
pub
 
u£
 
	g£lf
::
debug
::
S”viû
 
as
 
DebugS”viû
;

	@src/server/snap.rs

14 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

15 
u£
 
	g¡d
::
boxed
::
FnBox
;

16 
u£
 
	g¡d
::
time
::
In¡ªt
;

17 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gRwLock
};

19 
u£
 
	gmio
::
Tok’
;

20 
u£
 
	gfutu»s
::{
Async
, 
	gFutu»
, 
	gPŞl
, 
	gSŒ—m
};

21 
u£
 
	gfutu»s
::
¡»am
::{
£lf
, 
	gOnû
};

22 
u£
 
	gg½c
::{
ChªÃlBud”
, 
	gEnvœÚm’t
, 
	gWr™eFÏgs
};

23 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
SÇpshÙChunk
;

24 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

25 
u£
 
	gkv´Ùo
::
tikvpb_g½c
::
TikvCl›Á
;

27 
u£
 
	g¿á¡Üe
::
¡Üe
::{
SÇpEÁry
, 
	gSÇpKey
, 
	gSÇpMªag”
, 
	gSÇpshÙ
};

28 
u£
 
	gut
::
th»adpoŞ
::{
DeçuÉCÚ‹xt
, 
	gTh»adPoŞ
, 
	gTh»adPoŞBud”
};

29 
u£
 
	gut
::
wÜk”
::
RuÂabË
;

30 
u£
 
	gut
::
buf
::
PeBufãr
;

31 
u£
 
	gut
::
£cur™y
::
Secur™yMªag”
;

32 
u£
 
	gut
::
cŞËùiÚs
::{
HashM­
, 
HashM­EÁry
 
as
 
	gEÁry
};

33 
u£
 
	gut
::
HªdyRwLock
;

35 
u£
 
	gsu³r
::
m‘rics
::*;

36 
u£
 
	gsu³r
::{
E¼Ü
, 
	gResuÉ
};

37 
u£
 
	gsu³r
::
Œª¥Üt
::
RaáStÜeRou‹r
;

39 
pub
 
ty³
 
	gC®lback
 = 
Box
<
FnBox
(
ResuÉ
<()>è+ 
S’d
>;

41 cÚ¡ 
	gDEFAULT_SENDER_POOL_SIZE
: 
usize
 = 3;

50 
pub
 
	eTask
 {

51 
Regi¡”
(
Tok’
, 
RaáMes§ge
),

52 
Wr™e
(
Tok’
, 
PeBufãr
),

53 
Clo£
(
Tok’
),

54 
Disÿrd
(
Tok’
),

55 
	mS’dTo
 {

56 
	maddr
: 
SŒšg
,

57 
	mmsg
: 
RaáMes§ge
,

58 
	mcb
: 
C®lback
,

62 
im¶
 
Di¥Ïy
 
	gTask
 {

63 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

64 
m©ch
 *
£lf
 {

65 
Task
::
Regi¡”
(
tok’
, 
»f
 
m‘a
è=> 
wr™e
!(
f
, "Regi¡” {:?}ok’: {:?}", 
	gm‘a
, 
	gtok’
),

66 
	gTask
::
Wr™e
(
tok’
, 
_
è=> 
wr™e
!(
f
, "Wr™¢­ fÜ {:?}", 
	gtok’
),

67 
	gTask
::
Clo£
(
tok’
è=> 
wr™e
!(
f
, "Clo£ f{:?}", 
	gtok’
),

68 
	gTask
::
Disÿrd
(
tok’
è=> 
wr™e
!(
f
, "Disÿrd f{:?}", 
	gtok’
),

69 
	gTask
::
S’dTo
 {

70 
»f
 
addr
,„eà
	gmsg
, ..

71 } => 
wr™e
!(
f
, "S’dTØSÇp[to: {}, sÇp: {:?}]", 
	gaddr
, 
	gmsg
),

76 
	sSÇpChunk
 {

77 
	m¢­
: 
Arc
<
RwLock
<
Box
<
SÇpshÙ
>>>,

78 
	m»maš_by‹s
: 
usize
,

81 cÚ¡ 
	gSNAP_CHUNK_LEN
: 
usize
 = 1024 * 1024;

83 
im¶
 
SŒ—m
 
	gSÇpChunk
 {

84 
ty³
 
	gI‹m
 = (
SÇpshÙChunk
, 
	gWr™eFÏgs
);

85 
ty³
 
	gE¼Ü
 = 
E¼Ü
;

87 
â
 
pŞl
(&
mut
 
£lf
è-> 
	gPŞl
<
	gO±iÚ
<
	gS–f
::
I‹m
>, 
	gE¼Ü
> {

88 
Ët
 
mut
 
	gbuf
 = 
m©ch
 
£lf
.
»maš_by‹s
 {

89 0 =>  
Ok
(
Async
::
R—dy
(
NÚe
)),

90 
n
 
	gn
 > 
	gSNAP_CHUNK_LEN
 => 
vec
![0; 
SNAP_CHUNK_LEN
],

91 
	gn
 => 
vec
![0; 
n
],

93 
Ët
 
	g»suÉ
 = 
£lf
.
¢­
.
wl
().
»ad_exaù
(
buf
.
as_mut_¦iû
());

94 
m©ch
 
	g»suÉ
 {

95 
Ok
(
_
) => {

96 
£lf
.
»maš_by‹s
 -ğ
buf
.
Ën
();

97 
Ët
 
mut
 
	gchunk
 = 
SÇpshÙChunk
::
Ãw
();

98 
	gchunk
.
£t_d©a
(
buf
);

99 
Ok
(
Async
::
R—dy
(

100 
Some
((
chunk
, 
Wr™eFÏgs
::().
bufãr_hšt
(
Œue
))),

103 
E¼
(
e
è=> E¼(
box_”r
!("failedo„ead snapshot chunk: {}",ƒ)),

111 
â
 
£nd_¢­
(

112 
’v
: 
Arc
<
EnvœÚm’t
>,

113 
mgr
: 
SÇpMªag”
,

114 
£cur™y_mgr
: 
Arc
<
Secur™yMªag”
>,

115 
addr
: &
¡r
,

116 
msg
: 
RaáMes§ge
,

117 è-> 
	gResuÉ
<()> {

118 
	gas£¹
!(
	gmsg
.
g‘_mes§ge
().
has_¢­shÙ
());

119 
Ët
 
	gtim”
 = 
In¡ªt
::
now
();

121 
Ët
 
	g£nd_tim”
 = 
SEND_SNAP_HISTOGRAM
.
¡¬t_cßr£_tim”
();

123 
Ët
 
	gkey
 = {

124 
Ët
 
¢­
 = 
msg
.
g‘_mes§ge
().
g‘_¢­shÙ
();

125 
	gSÇpKey
::
äom_¢­
(
¢­
)?

127 
	gmgr
.(
	gkey
.
şÚe
(), 
	gSÇpEÁry
::
S’dšg
);

128 
	gdeãr
!({

129 
	gmgr
.
d”egi¡”
(&
key
, &
SÇpEÁry
::
S’dšg
);

131 
Ët
 
	gs
 = 
box_Œy
!(
mgr
.
g‘_¢­shÙ_fÜ_£ndšg
(&
key
));

132 !
	gs
.
exi¡s
() {

133  
E¼
(
box_”r
!("missšg sÇ°fe: {:?}", 
s
.
·th
()));

135 
Ët
 
	gtÙ®_size
 = 
s
.
tÙ®_size
()?;

138 
Ët
 
	gs
 = 
Arc
::
Ãw
(
RwLock
::Ãw(
s
));

140 
Ët
 
	gchunks
 = {

141 
Ët
 
¢­_chunk
 = 
SÇpChunk
 {

142 
¢­
: 
s
.
şÚe
(),

143 
»maš_by‹s
: 
tÙ®_size
 
as
 
usize
,

145 
Ët
 
	gfœ¡
: 
Onû
<(
SÇpshÙChunk
, 
	g_
), 
	gE¼Ü
> = 
¡»am
::
Úû
({

146 
Ët
 
mut
 
chunk
 = 
SÇpshÙChunk
::
Ãw
();

147 
chunk
.
£t_mes§ge
(
msg
);

148 
Ok
((
chunk
, 
Wr™eFÏgs
::().
bufãr_hšt
(
Œue
)))

150 
	gfœ¡
.
chaš
(
¢­_chunk
)

153 
Ët
 
	gcb
 = 
ChªÃlBud”
::
Ãw
(
’v
);

154 
Ët
 
	gchªÃl
 = 
£cur™y_mgr
.
cÚÃù
(
cb
, 
addr
);

155 
Ët
 
	gş›Á
 = 
TikvCl›Á
::
Ãw
(
chªÃl
);

156 
Ët
 (
sšk
, 
»ûiv”
èğ
ş›Á
.
¢­shÙ
();

157 
Ët
 
	g£nd
 = 
chunks
.
fÜw¬d
(
sšk
);

158 
Ët
 
	g»s
 = 
£nd
.
ªd_th’
(|
_
| 
»ûiv”
.
m­_”r
(
E¼Ü
::
äom
))

159 .
ªd_th’
(|
_
| {

160 
šfo
!(

162 
key
.
»giÚ_id
,

163 
key
,

164 
tÙ®_size
,

165 
tim”
.
–­£d
()

167 
s
.
wl
().
d–‘e
();

168 
Ok
(())

170 .
wa™
()

171 .
m­_”r
(
E¼Ü
::
äom
);

173 
	g£nd_tim”
.
ob£rve_du¿tiÚ
();

174 
	g»s


177 
pub
 
	gRuÂ”
<
	gR
: 
RaáStÜeRou‹r
 + 'static> {

178 
’v
: 
Arc
<
EnvœÚm’t
>,

179 
	g¢­_mgr
: 
SÇpMªag”
,

180 
	gfes
: 
HashM­
<
Tok’
, (
	gBox
<
	gSÇpshÙ
>, 
	gRaáMes§ge
)>,

181 
	gpoŞ
: 
Th»adPoŞ
<
DeçuÉCÚ‹xt
>,

182 
	g¿á_rou‹r
: 
R
,

183 
	g£cur™y_mgr
: 
Arc
<
Secur™yMªag”
>,

186 
	gim¶
<
	gR
: 
RaáStÜeRou‹r
 + 'static> Runner<R> {

187 
pub
 
â
 
Ãw
(

188 
’v
: 
Arc
<
EnvœÚm’t
>,

189 
¢­_mgr
: 
SÇpMªag”
,

190 
r
: 
R
,

191 
£cur™y_mgr
: 
Arc
<
Secur™yMªag”
>,

192 è-> 
	gRuÂ”
<
	gR
> {

193 
	gRuÂ”
 {

194 
	g’v
: 
’v
,

195 
	g¢­_mgr
: 
¢­_mgr
,

196 
	gfes
: 
m­
![],

197 
	gpoŞ
: 
Th»adPoŞBud”
::
w™h_deçuÉ_çùÜy
(
thd_Çme
!("snap sender"))

198 .
th»ad_couÁ
(
DEFAULT_SENDER_POOL_SIZE
)

199 .
bud
(),

200 
	g¿á_rou‹r
: 
r
,

201 
	g£cur™y_mgr
: 
£cur™y_mgr
,

206 
	gim¶
<
	gR
: 
RaáStÜeRou‹r
 + 'static> Runnable<Task> for Runner<R> {

207 
â
 
	$run
(&
mut
 
£lf
, 
sk
: 
Task
) {

208 
m©ch
 
sk
 {

209 
Task
::
	`Regi¡”
(
tok’
, 
m‘a
) => {

210 
SNAP_TASK_COUNTER
.
	`w™h_Ïb–_v®ues
(&["»gi¡”"]).
	`šc
();

211 
Ët
 
mgr
 = 
£lf
.
¢­_mgr
.
	`şÚe
();

212 
Ët
 
key
 = 
m©ch
 
SÇpKey
::
	`äom_¢­
(
m‘a
.
	`g‘_mes§ge
().
	`g‘_¢­shÙ
()) {

213 
	`Ok
(
k
) => k,

214 
	`E¼
(
e
) => {

215 
”rÜ
!("çedØü—‹ sÇ°key fÜok’ {:?}: {:?}", 
tok’
, 
e
);

219 
m©ch
 
mgr
.
	`g‘_¢­shÙ_fÜ_»ûivšg
(

220 &
key
,

221 
m‘a
.
	`g‘_mes§ge
().
	`g‘_¢­shÙ
().
	`g‘_d©a
(),

223 
	`Ok
(
¢­
) => {

224 
¢­
.
	`exi¡s
() {

225 
šfo
!(

227 
¢­
.
	`·th
()

229 
Ët
 
	`E¼
(
e
èğ
£lf
.
¿á_rou‹r
.
	`£nd_¿á_msg
(
m‘a
) {

230 
”rÜ
!("£nd sÇpshÙ fÜ key {}ok’ {:?}: {:?}", 
key
, 
tok’
, 
e
);

234 
debug
!("begšØ»ûiv¢­ {:?}", 
m‘a
);

235 
mgr
.(
key
, 
SÇpEÁry
::
Reûivšg
);

236 
£lf
.
fes
.
	`š£¹
(
tok’
, (
¢­
, 
m‘a
));

238 
	`E¼
(
e
) => {

239 
”rÜ
!(

241 
tok’
,

242 
e


248 
Task
::
	`Wr™e
(
tok’
, 
mut
 
d©a
) => {

249 
SNAP_TASK_COUNTER
.
	`w™h_Ïb–_v®ues
(&["wr™e"]).
	`šc
();

250 
m©ch
 
£lf
.
fes
.
	`’Œy
(
tok’
) {

251 
EÁry
::
	`Occup›d
(
mut
 
e
) => {

252 
Ët
 
	`E¼
(
”r
èğ
d©a
.
	`wr™e_®l_to
(&
mut
 
e
.
	`g‘_mut
().0) {

253 
”rÜ
!(

255 
e
.
	`g‘_mut
().0.
	`·th
(),

256 
tok’
,

257 
”r


259 
	`Ët
 (
_
, 
msg
èğ
e
.
	`»move
();

260 
Ët
 
key
 = 
SÇpKey
::
	`äom_¢­
(
msg
.
	`g‘_mes§ge
().
	`g‘_¢­shÙ
()).
	`unw¿p
();

261 
£lf
.
¢­_mgr
.
	`d”egi¡”
(&
key
, &
SÇpEÁry
::
Reûivšg
);

264 
EÁry
::
	`VaÿÁ
(
_
è=> 
”rÜ
!("šv®id sÇ°tok’ {:?}", 
tok’
),

267 
Task
::
	`Clo£
(
tok’
) => {

268 
SNAP_TASK_COUNTER
.
	`w™h_Ïb–_v®ues
(&["şo£"]).
	`šc
();

269 
m©ch
 
£lf
.
fes
.
	`»move
(&
tok’
) {

270 
	`Some
((
mut
 
¢­
, 
msg
)) => {

271 
Ët
 
key
 = 
SÇpKey
::
	`äom_¢­
(
msg
.
	`g‘_mes§ge
().
	`g‘_¢­shÙ
()).
	`unw¿p
();

272 
šfo
!("§všg sÇpshÙØ{}", 
¢­
.
	`·th
());

273 
deãr
!({

274 
£lf
.
¢­_mgr
.
	`d”egi¡”
(&
key
, &
SÇpEÁry
::
Reûivšg
);

276 
Ët
 
	`E¼
(
e
èğ
¢­
.
	`§ve
() {

277 
”rÜ
!(

279 
¢­
.
	`·th
(),

280 
tok’
,

281 
e


285 
Ët
 
	`E¼
(
e
èğ
£lf
.
¿á_rou‹r
.
	`£nd_¿á_msg
(
msg
) {

286 
”rÜ
!("£nd sÇpshÙ fÜok’ {:?}ƒ¼ {:?}", 
tok’
, 
e
);

289 
NÚe
 => 
”rÜ
!("šv®id sÇ°tok’ {:?}", 
tok’
),

292 
Task
::
	`Disÿrd
(
tok’
) => {

293 
SNAP_TASK_COUNTER
.
	`w™h_Ïb–_v®ues
(&["disÿrd"]).
	`šc
();

294 
Ët
 
	`Some
((
_
, 
msg
)èğ
£lf
.
fes
.
	`»move
(&
tok’
) {

295 
debug
!("disÿrd sÇpshÙ: {:?}", 
msg
);

297 
Ët
 
key
 = 
SÇpKey
::
	`äom_¢­
(
msg
.
	`g‘_mes§ge
().
	`g‘_¢­shÙ
()).
	`unw¿p
();

298 
£lf
.
¢­_mgr
.
	`d”egi¡”
(&
key
, &
SÇpEÁry
::
Reûivšg
);

301 
Task
::
S’dTo
 { 
addr
, 
msg
, 
cb
 } => {

302 
SNAP_TASK_COUNTER
.
	`w™h_Ïb–_v®ues
(&["£nd"]).
	`šc
();

303 
Ët
 
’v
 = 
£lf
.’v.
	`şÚe
();

304 
Ët
 
mgr
 = 
£lf
.
¢­_mgr
.
	`şÚe
();

305 
Ët
 
£cur™y_mgr
 = 
£lf
.£cur™y_mgr.
	`şÚe
();

306 
£lf
.
poŞ
.
	`execu‹
(
move
 |
_
| {

307 
Ët
 
»s
 = 
	`£nd_¢­
(
’v
, 
mgr
, 
£cur™y_mgr
, &
addr
, 
msg
);

308 
»s
.
	`is_”r
() {

309 
”rÜ
!("çedØ£nd sÇ°tØ{}: {:?}", 
addr
, 
»s
);

311 
	`cb
(
»s
)

315 
	}
}

	@src/server/transport.rs

14 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gRwLock
};

15 
u£
 
	g¡d
::
sync
::
mpsc
::
S’d”
;

16 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

17 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::
RaáCmdReque¡
;

19 
u£
 
	gut
::
Œª¥Üt
::
S’dCh
;

20 
u£
 
	gut
::
HªdyRwLock
;

21 
u£
 
	gut
::
wÜk”
::{
ScheduËr
, 
	gStİ³d
};

22 
u£
 
	gut
::
cŞËùiÚs
::
HashS‘
;

23 
u£
 
	g¿á
::
SÇpshÙStus
;

24 
u£
 
	g¿á¡Üe
::
¡Üe
::{
B©chC®lback
, 
	gC®lback
, 
Msg
 
as
 
	gStÜeMsg
, 
	gSignifiÿÁMsg
, 
	gT¿n¥Üt
};

25 
u£
 
	g¿á¡Üe
::
ResuÉ
 
as
 
RaáStÜeResuÉ
;

26 
u£
 
	g£rv”
::
¿á_ş›Á
::
RaáCl›Á
;

27 
u£
 
	g£rv”
::
ResuÉ
;

28 
u£
 
	gsu³r
::
¢­
::
Task
 
as
 
SÇpTask
;

29 
u£
 
	gsu³r
::
»sŞve
::
StÜeAddrResŞv”
;

30 
u£
 
	gsu³r
::
m‘rics
::*;

32 
pub
 
Œa™
 
	gRaáStÜeRou‹r
: 
S’d
 + 
ClÚe
 {

34 
â
 
£nd
(&
£lf
, 
msg
: 
StÜeMsg
è-> 
RaáStÜeResuÉ
<()>;

37 
â
 
Œy_£nd
(&
£lf
, 
msg
: 
StÜeMsg
è-> 
RaáStÜeResuÉ
<()>;

40 
â
 
£nd_¿á_msg
(&
£lf
, 
msg
: 
RaáMes§ge
è-> 
RaáStÜeResuÉ
<()> {

41 
£lf
.
Œy_£nd
(
StÜeMsg
::
RaáMes§ge
(
msg
))

45 
â
 
£nd_commªd
(&
£lf
, 
»q
: 
RaáCmdReque¡
, 
cb
: 
C®lback
è-> 
RaáStÜeResuÉ
<()> {

46 
£lf
.
Œy_£nd
(
StÜeMsg
::
Ãw_¿á_cmd
(
»q
, 
cb
))

50 
â
 
£nd_b©ch_commªds
(

51 &
£lf
,

52 
b©ch
: 
Vec
<
RaáCmdReque¡
>,

53 
Ú_fšished
: 
B©chC®lback
,

54 è-> 
	gRaáStÜeResuÉ
<()> {

55 
	g£lf
.
Œy_£nd
(
StÜeMsg
::
Ãw_b©ch_¿á_¢­shÙ_cmd
(
b©ch
, 
Ú_fšished
))

59 
â
 
signifiÿÁ_£nd
(&
£lf
, 
msg
: 
SignifiÿÁMsg
è-> 
RaáStÜeResuÉ
<()>;

62 
â
 
»pÜt_uÄ—chabË
(&
£lf
, 
»giÚ_id
: 
u64
, 
to_³”_id
: u64è-> 
RaáStÜeResuÉ
<()> {

63 
£lf
.
signifiÿÁ_£nd
(
SignifiÿÁMsg
::
UÄ—chabË
 {

64 
»giÚ_id
,

65 
to_³”_id
,

70 
â
 
»pÜt_¢­shÙ_¡©us
(

71 &
£lf
,

72 
»giÚ_id
: 
u64
,

73 
to_³”_id
: 
u64
,

74 
¡©us
: 
SÇpshÙStus
,

75 è-> 
	gRaáStÜeResuÉ
<()> {

76 
	g£lf
.
signifiÿÁ_£nd
(
SignifiÿÁMsg
::
SÇpshÙStus
 {

77 
»giÚ_id
:„egion_id,

78 
to_³”_id
:o_peer_id,

79 
¡©us
: status,

84 #[
d”ive
(
ClÚe
)]

85 
pub
 
	sS”v”RaáStÜeRou‹r
 {

86 
pub
 
	mch
: 
S’dCh
<
StÜeMsg
>,

87 
pub
 
	msignifiÿÁ_msg_£nd”
: 
S’d”
<
SignifiÿÁMsg
>,

90 
im¶
 
	gS”v”RaáStÜeRou‹r
 {

91 
pub
 
â
 
Ãw
(

92 
ch
: 
S’dCh
<
StÜeMsg
>,

93 
signifiÿÁ_msg_£nd”
: 
S’d”
<
SignifiÿÁMsg
>,

94 è-> 
	gS”v”RaáStÜeRou‹r
 {

95 
	gS”v”RaáStÜeRou‹r
 {

96 
	gch
: 
ch
,

97 
	gsignifiÿÁ_msg_£nd”
: 
signifiÿÁ_msg_£nd”
,

102 
im¶
 
RaáStÜeRou‹r
 
	gS”v”RaáStÜeRou‹r
 {

103 
â
 
Œy_£nd
(&
£lf
, 
msg
: 
StÜeMsg
è-> 
RaáStÜeResuÉ
<()> {

104 
£lf
.
ch
.
Œy_£nd
(
msg
)?;

105 
Ok
(())

108 
â
 
£nd
(&
£lf
, 
msg
: 
StÜeMsg
è-> 
RaáStÜeResuÉ
<()> {

109 
£lf
.
ch
.
£nd
(
msg
)?;

110 
Ok
(())

113 
â
 
£nd_¿á_msg
(&
£lf
, 
msg
: 
RaáMes§ge
è-> 
RaáStÜeResuÉ
<()> {

114 
£lf
.
Œy_£nd
(
StÜeMsg
::
RaáMes§ge
(
msg
))

117 
â
 
£nd_commªd
(&
£lf
, 
»q
: 
RaáCmdReque¡
, 
cb
: 
C®lback
è-> 
RaáStÜeResuÉ
<()> {

118 
£lf
.
Œy_£nd
(
StÜeMsg
::
Ãw_¿á_cmd
(
»q
, 
cb
))

121 
â
 
£nd_b©ch_commªds
(

122 &
£lf
,

123 
b©ch
: 
Vec
<
RaáCmdReque¡
>,

124 
Ú_fšished
: 
B©chC®lback
,

125 è-> 
	gRaáStÜeResuÉ
<()> {

126 
	g£lf
.
Œy_£nd
(
StÜeMsg
::
Ãw_b©ch_¿á_¢­shÙ_cmd
(
b©ch
, 
Ú_fšished
))

129 
â
 
signifiÿÁ_£nd
(&
£lf
, 
msg
: 
SignifiÿÁMsg
è-> 
RaáStÜeResuÉ
<()> {

130 
Ët
 
E¼
(
e
èğ
£lf
.
signifiÿÁ_msg_£nd”
.
£nd
(
msg
) {

131  
E¼
(
box_”r
!("çedØ£ndsignifiÿÁ msg {:?}", 
e
));

134 
Ok
(())

138 
pub
 
	gS”v”T¿n¥Üt
<
	gT
, 
	gS
>

139 
wh”e


140 
	gT
: 
RaáStÜeRou‹r
 + 'static,

141 
S
: 
StÜeAddrResŞv”
 + 'static,

143 
¿á_ş›Á
: 
Arc
<
RwLock
<
RaáCl›Á
>>,

144 
	g¢­_scheduËr
: 
ScheduËr
<
SÇpTask
>,

145 
pub
 
	g¿á_rou‹r
: 
T
,

146 
	g»sŞvšg
: 
Arc
<
RwLock
<
HashS‘
<
u64
>>>,

147 
	g»sŞv”
: 
S
,

150 
	gim¶
<
	gT
, 
	gS
> 
ClÚe
 
	gS”v”T¿n¥Üt
<T, S>

151 
wh”e


152 
	gT
: 
RaáStÜeRou‹r
 + 'static,

153 
S
: 
StÜeAddrResŞv”
 + 'static,

155 
â
 
şÚe
(&
£lf
è-> 
S–f
 {

156 
S”v”T¿n¥Üt
 {

157 
¿á_ş›Á
: 
£lf
.¿á_ş›Á.
şÚe
(),

158 
	g¢­_scheduËr
: 
£lf
.
¢­_scheduËr
.
şÚe
(),

159 
	g¿á_rou‹r
: 
£lf
.
¿á_rou‹r
.
şÚe
(),

160 
	g»sŞvšg
: 
£lf
.
»sŞvšg
.
şÚe
(),

161 
	g»sŞv”
: 
£lf
.
»sŞv”
.
şÚe
(),

166 
	gim¶
<
	gT
: 
RaáStÜeRou‹r
 + '¡©ic, S: StÜeAddrResŞv” + '> 
S”v”T¿n¥Üt
<
T
, 
	gS
> {

167 
pub
 
â
 
Ãw
(

168 
¿á_ş›Á
: 
Arc
<
RwLock
<
RaáCl›Á
>>,

169 
¢­_scheduËr
: 
ScheduËr
<
SÇpTask
>,

170 
¿á_rou‹r
: 
T
,

171 
»sŞv”
: 
S
,

172 è-> 
	gS”v”T¿n¥Üt
<
	gT
, 
	gS
> {

173 
	gS”v”T¿n¥Üt
 {

174 
	g¿á_ş›Á
: 
¿á_ş›Á
,

175 
	g¢­_scheduËr
: 
¢­_scheduËr
,

176 
	g¿á_rou‹r
: 
¿á_rou‹r
,

177 
	g»sŞvšg
: 
Arc
::
Ãw
(
RwLock
::Ãw(
DeçuÉ
::())),

178 
	g»sŞv”
: 
»sŞv”
,

182 
â
 
£nd_¡Üe
(&
£lf
, 
¡Üe_id
: 
u64
, 
msg
: 
RaáMes§ge
) {

185 
Ët
 
addr
 = 
£lf
.
¿á_ş›Á
.
¾
().
addrs
.
g‘
(&
¡Üe_id
).
şÚed
();

186 
Ët
 
Some
(
addr
) =‡ddr {

187 
£lf
.
wr™e_d©a
(
¡Üe_id
, &
addr
, 
msg
);

192 
	g£lf
.
	g»sŞvšg
.
¾
().
cÚšs
(&
¡Üe_id
) {

193 
	gRESOLVE_STORE_COUNTER


194 .
w™h_Ïb–_v®ues
(&["resolving"])

195 .
šc
();

197 
	gdebug
!(

199 
	g¡Üe_id
,

200 
	gmsg


202 
	g£lf
.
»pÜt_uÄ—chabË
(
msg
);

206 
	gdebug
!("begšØ»sŞv¡Ü{}‡dd»ss", 
	g¡Üe_id
);

207 
	gRESOLVE_STORE_COUNTER
.
w™h_Ïb–_v®ues
(&["»sŞve"]).
šc
();

209 
	g£lf
.
	g»sŞvšg
.
wl
().
š£¹
(
¡Üe_id
);

210 
	g£lf
.
»sŞve
(
¡Üe_id
, 
msg
);

213 
â
 
»sŞve
(&
£lf
, 
¡Üe_id
: 
u64
, 
msg
: 
RaáMes§ge
) {

214 
Ët
 
Œªs
 = 
£lf
.
şÚe
();

215 
Ët
 
	gmsg1
 = 
msg
.
şÚe
();

216 
Ët
 
	gcb
 = 
box
 
move
 |
addr
: 
ResuÉ
<
SŒšg
>| {

218 
Œªs
.
»sŞvšg
.
wl
().
»move
(&
¡Üe_id
);

220 
Ët
 
E¼
(
e
èğ
addr
 {

221 
RESOLVE_STORE_COUNTER
.
w™h_Ïb–_v®ues
(&["çed"]).
šc
();

222 
	gdebug
!("»sŞv¡Ü{}‡dd»s çed {:?}", 
	g¡Üe_id
, 
	ge
);

223 
	gŒªs
.
»pÜt_uÄ—chabË
(
msg
);

227 
	gRESOLVE_STORE_COUNTER
.
w™h_Ïb–_v®ues
(&["sucûss"]).
šc
();

228 
Ët
 
	gaddr
 = 
addr
.
unw¿p
();

229 
	gšfo
!("»sŞv¡Ü{}‡dd»s ok,‡dd¸{}", 
	g¡Üe_id
, 
	gaddr
);

230 
	gŒªs
.
	g¿á_ş›Á
.
wl
().
	gaddrs
.
š£¹
(
¡Üe_id
, 
addr
.
şÚe
());

231 
	gŒªs
.
wr™e_d©a
(
¡Üe_id
, &
addr
, 
msg
);

233 
	gŒªs
.
	g¿á_ş›Á
.
wl
().
æush
();

235 
Ët
 
E¼
(
e
èğ
£lf
.
»sŞv”
.
»sŞve
(
¡Üe_id
, 
cb
) {

236 
	g”rÜ
!("ŒyØ»sŞv”¸{:?}", 
	ge
);

237 
	g£lf
.
	g»sŞvšg
.
wl
().
»move
(&
¡Üe_id
);

238 
	gRESOLVE_STORE_COUNTER
.
w™h_Ïb–_v®ues
(&["çed"]).
šc
();

239 
	gdebug
!("»sŞv¡Ü{}‡dd»s çed {:?}", 
	g¡Üe_id
, 
	ge
);

240 
	g£lf
.
»pÜt_uÄ—chabË
(
msg1
);

244 
â
 
wr™e_d©a
(&
£lf
, 
¡Üe_id
: 
u64
, 
addr
: &
¡r
, 
msg
: 
RaáMes§ge
) {

245 
msg
.
g‘_mes§ge
().
has_¢­shÙ
() {

246  
£lf
.
£nd_¢­shÙ_sock
(
addr
, 
msg
);

248 
Ët
 
E¼
(
e
èğ
£lf
.
¿á_ş›Á
.
wl
().
£nd
(
¡Üe_id
, 
addr
, 
msg
) {

249 
	g”rÜ
!("£nd„aá msgƒ¼ {:?}", 
	ge
);

253 
â
 
£nd_¢­shÙ_sock
(&
£lf
, 
addr
: &
¡r
, 
msg
: 
RaáMes§ge
) {

254 
Ët
 
»p
 = 
£lf
.
Ãw_¢­shÙ_»pÜ‹r
(&
msg
);

255 
Ët
 
	gcb
 = 
box
 
move
 |
»s
: 
ResuÉ
<()>| »s.
is_”r
() {

256 
»p
.
»pÜt
(
SÇpshÙStus
::
Fau»
);

258 
	g»p
.
»pÜt
(
SÇpshÙStus
::
Fšish
);

260 
Ët
 
E¼
(
Stİ³d
(
SÇpTask
::
S’dTo
 { 
cb
, .. })) =

261 
£lf
.
¢­_scheduËr
.
scheduË
(
SÇpTask
::
S’dTo
 {

262 
addr
:‡ddr.
to_owÃd
(),

263 
msg
: msg,

264 
cb
: cb,

266 
”rÜ
!("chªÃÈi şo£d, faedØscheduË sÇpshÙØ{}", 
addr
);

267 
cb
(
E¼
(
box_”r
!("failedo schedule snapshot")));

271 
â
 
Ãw_¢­shÙ_»pÜ‹r
(&
£lf
, 
msg
: &
RaáMes§ge
è-> 
SÇpshÙR•Ü‹r
<
T
> {

272 
Ët
 
»giÚ_id
 = 
msg
.
g‘_»giÚ_id
();

273 
Ët
 
	gto_³”_id
 = 
msg
.
g‘_to_³”
().
g‘_id
();

274 
Ët
 
	gto_¡Üe_id
 = 
msg
.
g‘_to_³”
().
g‘_¡Üe_id
();

276 
	gSÇpshÙR•Ü‹r
 {

277 
	g¿á_rou‹r
: 
£lf
.
¿á_rou‹r
.
şÚe
(),

278 
	g»giÚ_id
: 
»giÚ_id
,

279 
	gto_³”_id
: 
to_³”_id
,

280 
	gto_¡Üe_id
: 
to_¡Üe_id
,

284 
pub
 
â
 
»pÜt_uÄ—chabË
(&
£lf
, 
msg
: 
RaáMes§ge
) {

285 
Ët
 
»giÚ_id
 = 
msg
.
g‘_»giÚ_id
();

286 
Ët
 
	gto_³”_id
 = 
msg
.
g‘_to_³”
().
g‘_id
();

287 
Ët
 
	g¡Üe_id
 = 
msg
.
g‘_to_³”
().
g‘_¡Üe_id
();

289 
Ët
 
E¼
(
e
èğ
£lf
.
¿á_rou‹r
.
»pÜt_uÄ—chabË
(
»giÚ_id
, 
to_³”_id
) {

290 
	g”rÜ
!(

292 
	gto_³”_id
,

293 
	g¡Üe_id
,

294 
	g»giÚ_id
,

295 
	ge


300 
pub
 
â
 
æush_¿á_ş›Á
(&
mut
 
£lf
) {

301 
	g£lf
.
	g¿á_ş›Á
.
wl
().
æush
();

305 
	gim¶
<
	gT
, 
	gS
> 
T¿n¥Üt
 
	gS”v”T¿n¥Üt
<T, S>

306 
wh”e


307 
	gT
: 
RaáStÜeRou‹r
 + 'static,

308 
S
: 
StÜeAddrResŞv”
 + 'static,

310 
â
 
£nd
(&
£lf
, 
msg
: 
RaáMes§ge
è-> 
RaáStÜeResuÉ
<()> {

311 
Ët
 
to_¡Üe_id
 = 
msg
.
g‘_to_³”
().
g‘_¡Üe_id
();

312 
	g£lf
.
£nd_¡Üe
(
to_¡Üe_id
, 
msg
);

313 
Ok
(())

316 
â
 
æush
(&
mut
 
£lf
) {

317 
	g£lf
.
æush_¿á_ş›Á
();

321 
	gSÇpshÙR•Ü‹r
<
	gT
: 
RaáStÜeRou‹r
 + 'static> {

322 
¿á_rou‹r
: 
T
,

323 
	g»giÚ_id
: 
u64
,

324 
	gto_³”_id
: 
u64
,

325 
	gto_¡Üe_id
: 
u64
,

328 
	gim¶
<
	gT
: 
RaáStÜeRou‹r
 + 'static> SnapshotReporter<T> {

329 
pub
 
â
 
	$»pÜt
(&
£lf
, 
¡©us
: 
SÇpshÙStus
) {

330 
debug
!(

332 
£lf
.
to_³”_id
,

333 
£lf
.
»giÚ_id
,

334 
¡©us


337 
¡©us
 =ğ
SÇpshÙStus
::
Fau»
 {

338 
Ët
 
¡Üe
 = 
£lf
.
to_¡Üe_id
.
	`to_¡ršg
();

339 
REPORT_FAILURE_MSG_COUNTER


340 .
	`w™h_Ïb–_v®ues
(&["¢­shÙ", &*
¡Üe
])

341 .
	`šc
();

344 
Ët
 
	`E¼
(
e
èğ
£lf
.
¿á_rou‹r


345 .
	`»pÜt_¢­shÙ_¡©us
(
£lf
.
»giÚ_id
, s–f.
to_³”_id
, 
¡©us
)

347 
”rÜ
!(

349 
£lf
.
to_³”_id
,

350 
£lf
.
to_¡Üe_id
,

351 
£lf
.
»giÚ_id
,

352 
e


355 
	}
}

	@src/storage/config.rs

14 
u£
 
	g¡d
::
”rÜ
::
E¼Ü
;

16 
u£
 
	gsys_šfo
;

18 
u£
 
	gut
::
cÚfig
::{
£lf
, 
	gR—dabËSize
};

20 
pub
 cÚ¡ 
	gDEFAULT_DATA_DIR
: &'static str = "";

21 
pub
 cÚ¡ 
DEFAULT_ROCKSDB_SUB_DIR
: &'static str = "db";

22 cÚ¡ 
DEFAULT_GC_RATIO_THRESHOLD
: 
f64
 = 1.1;

23 cÚ¡ 
	gDEFAULT_MAX_KEY_SIZE
: 
usize
 = 4 * 1024;

24 cÚ¡ 
	gDEFAULT_SCHED_CAPACITY
: 
usize
 = 10240;

25 cÚ¡ 
	gDEFAULT_SCHED_MSG_PER_TICK
: 
usize
 = 1024;

26 cÚ¡ 
	gDEFAULT_SCHED_CONCURRENCY
: 
usize
 = 102400;

32 cÚ¡ 
	gDEFAULT_SCHED_PENDING_WRITE_MB
: 
u64
 = 100;

34 #[
d”ive
(
ClÚe
, 
Debug
, 
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
)]

35 #[
£rde
()]

36 #[
£rde
(
»Çme_®l
 = "kebab-case")]

37 
pub
 
	sCÚfig
 {

38 
pub
 
	md©a_dœ
: 
SŒšg
,

39 
pub
 
	mgc_¿tio_th»shŞd
: 
f64
,

40 
pub
 
	mmax_key_size
: 
usize
,

41 
pub
 
	mscheduËr_nÙify_ÿ·c™y
: 
usize
,

42 
pub
 
	mscheduËr_mes§ges_³r_tick
: 
usize
,

43 
pub
 
	mscheduËr_cÚcu¼’cy
: 
usize
,

44 
pub
 
	mscheduËr_wÜk”_poŞ_size
: 
usize
,

45 
pub
 
	mscheduËr_³ndšg_wr™e_th»shŞd
: 
R—dabËSize
,

48 
im¶
 
DeçuÉ
 
	gCÚfig
 {

49 
â
 (è-> 
	gCÚfig
 {

50 
Ët
 
	gtÙ®_ıu
 = 
sys_šfo
::
ıu_num
().
unw¿p
();

51 
	gCÚfig
 {

52 
	gd©a_dœ
: 
DEFAULT_DATA_DIR
.
to_owÃd
(),

53 
	ggc_¿tio_th»shŞd
: 
DEFAULT_GC_RATIO_THRESHOLD
,

54 
	gmax_key_size
: 
DEFAULT_MAX_KEY_SIZE
,

55 
	gscheduËr_nÙify_ÿ·c™y
: 
DEFAULT_SCHED_CAPACITY
,

56 
	gscheduËr_mes§ges_³r_tick
: 
DEFAULT_SCHED_MSG_PER_TICK
,

57 
	gscheduËr_cÚcu¼’cy
: 
DEFAULT_SCHED_CONCURRENCY
,

58 
	gscheduËr_wÜk”_poŞ_size
: 
tÙ®_ıu
 >= 16 { 8 } { 4 },

59 
	gscheduËr_³ndšg_wr™e_th»shŞd
: 
R—dabËSize
::
mb
(
DEFAULT_SCHED_PENDING_WRITE_MB
),

64 
im¶
 
	gCÚfig
 {

65 
pub
 
â
 
v®id©e
(&
mut
 
£lf
è-> 
	gResuÉ
<(), 
	gBox
<
	gE¼Ü
>> {

66 
	g£lf
.
	gd©a_dœ
 !ğ
DEFAULT_DATA_DIR
 {

67 
£lf
.
d©a_dœ
 = 
cÚfig
::
ÿnÚiÿlize_·th
(&self.data_dir)?

69 
Ok
(())

	@src/storage/engine/metrics.rs

14 
u£
 
	g´om‘heus
::{
expÚ’tŸl_buck‘s
, 
	gCouÁ”Vec
, 
	gHi¡og¿mVec
};

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gASYNC_REQUESTS_COUNTER_VEC
: 
CouÁ”Vec
 =

18 
»gi¡”_couÁ”_vec
!(

22 ).
unw¿p
();

24 
pub
 
»f
 
	gASYNC_REQUESTS_DURATIONS_VEC
: 
Hi¡og¿mVec
 =

25 
»gi¡”_hi¡og¿m_vec
!(

29 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

30 ).
unw¿p
();

	@src/storage/engine/mod.rs

14 
u£
 
	g¡d
::{
”rÜ
, 
	g»suÉ
};

15 
u£
 
	g¡d
::
fmt
::
Debug
;

16 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

17 
u£
 
	g¡d
::
boxed
::
FnBox
;

18 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

20 
pub
 
u£
 
	g£lf
::
rocksdb
::
EngšeRocksdb
;

21 
u£
 
	grocksdb
::
TabËPrİ”t›sCŞËùiÚ
;

22 
u£
 
	g¡Üage
::{
CfName
, 
	gKey
, 
	gV®ue
, 
	gCF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_WRITE
};

23 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

24 
u£
 
	gkv´Ùo
::
”rÜpb
::
E¼Ü
 
as
 
E¼ÜH—d”
;

26 
mod
 
	grocksdb
;

27 
pub
 
mod
 
	g¿ákv
;

28 
mod
 
	gm‘rics
;

29 
u£
 
	gsu³r
::
su³r
::
¿á¡Üe
::
¡Üe
::
’gše
::
I‹rO±iÚ
;

32 
pub
 cÚ¡ 
	gTEMP_DIR
: &'static str = "";

34 cÚ¡ 
SEEK_BOUND
: 
usize
 = 30;

35 cÚ¡ 
	gDEFAULT_TIMEOUT_SECS
: 
u64
 = 5;

37 cÚ¡ 
	gSTAT_TOTAL
: &'static str = "total";

38 cÚ¡ 
STAT_PROCESSED
: &'static str = "processed";

39 cÚ¡ 
STAT_GET
: &'static str = "get";

40 cÚ¡ 
STAT_NEXT
: &'static str = "next";

41 cÚ¡ 
STAT_PREV
: &'static str = "prev";

42 cÚ¡ 
STAT_SEEK
: &'static str = "seek";

43 cÚ¡ 
STAT_SEEK_FOR_PREV
: &'static str = "seek_for_prev";

44 cÚ¡ 
STAT_OVER_SEEK_BOUND
: &'static str = "over_seek_bound";

46 
pub
 
ty³
 
C®lback
<
T
> = 
Box
<
FnBox
((
CbCÚ‹xt
, 
ResuÉ
<T>)è+ 
	gS’d
>;

47 
pub
 
ty³
 
	gB©chResuÉs
<
	gT
> = 
Vec
<
O±iÚ
<(
CbCÚ‹xt
, 
	gResuÉ
<T>)>>;

48 
pub
 
ty³
 
	gB©chC®lback
<
	gT
> = 
Box
<
FnBox
(
B©chResuÉs
<
T
>è+ 
S’d
>;

50 #[
d”ive
(
ClÚe
, 
Debug
)]

51 
pub
 
	sCbCÚ‹xt
 {

52 
pub
 
	m‹rm
: 
O±iÚ
<
u64
>,

55 
im¶
 
	gCbCÚ‹xt
 {

56 
â
 
Ãw
(è-> 
	gCbCÚ‹xt
 {

57 
	gCbCÚ‹xt
 { 
	g‹rm
: 
NÚe
 }

61 #[
d”ive
(
Debug
)]

62 
pub
 
	eModify
 {

63 
D–‘e
(
CfName
, 
Key
),

64 
Put
(
CfName
, 
Key
, 
V®ue
),

65 
D–‘eRªge
(
CfName
, 
Key
, Key),

68 
pub
 
Œa™
 
	gEngše
: 
S’d
 + 
Debug
 {

69 
â
 
async_wr™e
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
b©ch
: 
Vec
<
Modify
>, 
ÿÎback
: 
C®lback
<()>è-> 
ResuÉ
<()>;

70 
â
 
async_¢­shÙ
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
ÿÎback
: 
C®lback
<
Box
<
SÇpshÙ
>>è-> 
ResuÉ
<()>;

78 
â
 
async_b©ch_¢­shÙ
(

79 &
£lf
,

80 
b©ch
: 
Vec
<
CÚ‹xt
>,

81 
Ú_fšished
: 
B©chC®lback
<
Box
<
SÇpshÙ
>>,

82 è-> 
	gResuÉ
<()>;

84 
â
 
wr™e
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
b©ch
: 
Vec
<
Modify
>è-> 
ResuÉ
<()> {

85 
Ët
 
timeout
 = 
Du¿tiÚ
::
äom_£cs
(
DEFAULT_TIMEOUT_SECS
);

86 
m©ch
 
	gwa™_İ
!(|
	gcb
| 
	g£lf
.
async_wr™e
(
ùx
, 
b©ch
, 
cb
).
unw¿p
(), 
	gtimeout
) {

87 
Some
((
_
, 
»s
)) =>„es,

88 
	gNÚe
 => 
E¼
(
E¼Ü
::
Timeout
(
timeout
)),

92 
â
 
¢­shÙ
(&
£lf
, 
ùx
: &
CÚ‹xt
è-> 
ResuÉ
<
Box
<
SÇpshÙ
>> {

93 
Ët
 
timeout
 = 
Du¿tiÚ
::
äom_£cs
(
DEFAULT_TIMEOUT_SECS
);

94 
m©ch
 
	gwa™_İ
!(|
	gcb
| 
	g£lf
.
async_¢­shÙ
(
ùx
, 
cb
).
unw¿p
(), 
	gtimeout
) {

95 
Some
((
_
, 
»s
)) =>„es,

96 
	gNÚe
 => 
E¼
(
E¼Ü
::
Timeout
(
timeout
)),

100 
â
 
put
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
key
: 
Key
, 
v®ue
: 
V®ue
è-> 
ResuÉ
<()> {

101 
£lf
.
put_cf
(
ùx
, 
CF_DEFAULT
, 
key
, 
v®ue
)

104 
â
 
put_cf
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
cf
: 
CfName
, 
key
: 
Key
, 
v®ue
: 
V®ue
è-> 
ResuÉ
<()> {

105 
£lf
.
wr™e
(
ùx
, 
vec
![
Modify
::
Put
(
cf
, 
key
, 
v®ue
)])

108 
â
 
d–‘e
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
key
: 
Key
è-> 
ResuÉ
<()> {

109 
£lf
.
d–‘e_cf
(
ùx
, 
CF_DEFAULT
, 
key
)

112 
â
 
d–‘e_cf
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
cf
: 
CfName
, 
key
: 
Key
è-> 
ResuÉ
<()> {

113 
£lf
.
wr™e
(
ùx
, 
vec
![
Modify
::
D–‘e
(
cf
, 
key
)])

117 
â
 
şÚe
(&
£lf
è-> 
	gBox
<
	gEngše
 + 'static>;

120 
pub
 
Œa™
 
	gSÇpshÙ
: 
S’d
 {

121 
â
 
g‘
(&
£lf
, 
key
: &
Key
è-> 
ResuÉ
<
O±iÚ
<
V®ue
>>;

122 
â
 
g‘_cf
(&
£lf
, 
cf
: 
CfName
, 
key
: &
Key
è-> 
ResuÉ
<
O±iÚ
<
V®ue
>>;

123 #[
®low
(
ÃedËss_liãtimes
)]

124 
â
 
™”
(&
£lf
, 
™”_İt
: 
I‹rO±iÚ
, 
mode
: 
SÿnMode
è-> 
ResuÉ
<
CursÜ
>;

125 #[
®low
(
ÃedËss_liãtimes
)]

126 
â
 
™”_cf
(&
£lf
, 
cf
: 
CfName
, 
™”_İt
: 
I‹rO±iÚ
, 
mode
: 
SÿnMode
è-> 
ResuÉ
<
CursÜ
>;

127 
â
 
g‘_´İ”t›s
(&
£lf
è-> 
	gResuÉ
<
	gTabËPrİ”t›sCŞËùiÚ
> {

128 
	g£lf
.
g‘_´İ”t›s_cf
(
CF_DEFAULT
)

130 
â
 
g‘_´İ”t›s_cf
(&
£lf
, 
_
: 
CfName
è-> 
ResuÉ
<
TabËPrİ”t›sCŞËùiÚ
> {

131 
E¼
(
E¼Ü
::
RocksDb
("nØu£¸´İ”t›s".
to_owÃd
()))

133 
â
 
şÚe
(&
£lf
è-> 
Box
<
SÇpshÙ
>;

136 
pub
 
Œa™
 
	gI‹¿tÜ
 {

137 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gboŞ
;

138 
â
 
´ev
(&
mut
 
£lf
è-> 
	gboŞ
;

139 
â
 
£ek
(&
mut
 
£lf
, 
key
: &
Key
è-> 
ResuÉ
<
boŞ
>;

140 
â
 
£ek_fÜ_´ev
(&
mut
 
£lf
, 
key
: &
Key
è-> 
ResuÉ
<
boŞ
>;

141 
â
 
£ek_to_fœ¡
(&
mut
 
£lf
è-> 
	gboŞ
;

142 
â
 
£ek_to_Ï¡
(&
mut
 
£lf
è-> 
	gboŞ
;

143 
â
 
v®id
(&
£lf
è-> 
	gboŞ
;

145 
â
 
v®id©e_key
(&
£lf
, 
_
: &
Key
è-> 
ResuÉ
<()> {

146 
Ok
(())

149 
â
 
key
(&
£lf
è-> &[
u8
];

150 
â
 
v®ue
(&
£lf
è-> &[
u8
];

153 
	gmaüo_ruËs
! 
	gÃ¬_loİ
 {

154 (
	g$cÚd
:
ex´
, 
	g$çÎback
:ex´, 
	g$¡
:expr) => ({

155 
Ët
 
mut
 
út
 = 0;

156 
	g$cÚd
 {

157 
	gút
 += 1;

158 
	gút
 >ğ
SEEK_BOUND
 {

159 
$¡
.
ov”_£ek_bound
 += 1;

160  
	g$çÎback
;

166 #[
d”ive
(
Debug
, 
P¬tŸlEq
, 
ClÚe
, 
Cİy
)]

167 
pub
 
	eSÿnMode
 {

168 
	mFÜw¬d
,

169 
	mBackw¬d
,

170 
	mMixed
,

174 #[
d”ive
(
DeçuÉ
, 
Cİy
, 
ClÚe
)]

175 
pub
 
	sCFSti¡ics
 {

178 
pub
 
	m´oûs£d
: 
usize
,

179 
pub
 
	mg‘
: 
usize
,

180 
pub
 
	mÃxt
: 
usize
,

181 
pub
 
	m´ev
: 
usize
,

182 
pub
 
	m£ek
: 
usize
,

183 
pub
 
	m£ek_fÜ_´ev
: 
usize
,

184 
pub
 
	mov”_£ek_bound
: 
usize
,

185 
pub
 
	mæow_¡©s
: 
FlowSti¡ics
,

188 #[
d”ive
(
DeçuÉ
, 
ClÚe
, 
Debug
, 
Cİy
)]

189 
pub
 
	sFlowSti¡ics
 {

190 
pub
 
	m»ad_keys
: 
usize
,

191 
pub
 
	m»ad_by‹s
: 
usize
,

194 
im¶
 
	gFlowSti¡ics
 {

195 
pub
 
â
 
add
(&
mut
 
£lf
, 
Ùh”
: &
S–f
) {

196 
£lf
.
»ad_by‹s
 = s–f.
»ad_keys
.
§tu¿tšg_add
(
Ùh”
.read_bytes);

197 
	g£lf
.
	g»ad_keys
 = 
£lf
.
»ad_keys
.
§tu¿tšg_add
(
Ùh”
.read_keys);

201 
im¶
 
	gCFSti¡ics
 {

202 #[
šlše
]

203 
pub
 
â
 
tÙ®_İ_couÁ
(&
£lf
è-> 
	gusize
 {

204 
	g£lf
.
	gg‘
 + s–f.
	gÃxt
 + s–f.
	g´ev
 + s–f.
	g£ek
 + s–f.
	g£ek_fÜ_´ev


207 
pub
 
â
 
d‘as
(&
£lf
è-> 
	gVec
<(&
	g¡r
, 
	gusize
)> {

208 
	gvec
![

209 (
STAT_TOTAL
, 
£lf
.
tÙ®_İ_couÁ
()),

210 (
STAT_PROCESSED
, 
£lf
.
´oûs£d
),

211 (
STAT_GET
, 
£lf
.
g‘
),

212 (
STAT_NEXT
, 
£lf
.
Ãxt
),

213 (
STAT_PREV
, 
£lf
.
´ev
),

214 (
STAT_SEEK
, 
£lf
.
£ek
),

215 (
STAT_SEEK_FOR_PREV
, 
£lf
.
£ek_fÜ_´ev
),

216 (
STAT_OVER_SEEK_BOUND
, 
£lf
.
ov”_£ek_bound
),

220 
pub
 
â
 
add
(&
mut
 
£lf
, 
Ùh”
: &
S–f
) {

221 
£lf
.
´oûs£d
 = s–f.´oûs£d.
§tu¿tšg_add
(
Ùh”
.processed);

222 
	g£lf
.
	gg‘
 = 
£lf
.
g‘
.
§tu¿tšg_add
(
Ùh”
.get);

223 
	g£lf
.
	gÃxt
 = 
£lf
.
Ãxt
.
§tu¿tšg_add
(
Ùh”
.next);

224 
	g£lf
.
	g´ev
 = 
£lf
.
´ev
.
§tu¿tšg_add
(
Ùh”
.prev);

225 
	g£lf
.
	g£ek
 = 
£lf
.
£ek
.
§tu¿tšg_add
(
Ùh”
.seek);

226 
	g£lf
.
	g£ek_fÜ_´ev
 = 
£lf
.
£ek_fÜ_´ev
.
§tu¿tšg_add
(
Ùh”
.seek_for_prev);

227 
	g£lf
.
	gov”_£ek_bound
 = 
£lf
.
ov”_£ek_bound
.
§tu¿tšg_add
(
Ùh”
.over_seek_bound);

228 
	g£lf
.
	gæow_¡©s
.
add
(&
Ùh”
.
æow_¡©s
);

232 #[
d”ive
(
DeçuÉ
, 
Cİy
, 
ClÚe
)]

233 
pub
 
	sSti¡ics
 {

234 
pub
 
	mlock
: 
CFSti¡ics
,

235 
pub
 
	mwr™e
: 
CFSti¡ics
,

236 
pub
 
	md©a
: 
CFSti¡ics
,

239 
im¶
 
	gSti¡ics
 {

240 
pub
 
â
 
tÙ®_İ_couÁ
(&
£lf
è-> 
	gusize
 {

241 
	g£lf
.
	glock
.
tÙ®_İ_couÁ
(è+ s–f.
	gwr™e
.tÙ®_İ_couÁ(è+ s–f.
	gd©a
.total_op_count()

244 
pub
 
â
 
tÙ®_´oûs£d
(&
£lf
è-> 
	gusize
 {

245 
	g£lf
.
	glock
.
	g´oûs£d
 + s–f.
	gwr™e
.´oûs£d + s–f.
	gd©a
.processed

248 
pub
 
â
 
d‘as
(&
£lf
è-> 
	gVec
<(&
	g¡r
, Vec<(&¡r, 
	gusize
)>)> {

249 
	gvec
![

250 (
CF_DEFAULT
, 
£lf
.
d©a
.
d‘as
()),

251 (
CF_LOCK
, 
£lf
.
lock
.
d‘as
()),

252 (
CF_WRITE
, 
£lf
.
wr™e
.
d‘as
()),

256 
pub
 
â
 
add
(&
mut
 
£lf
, 
Ùh”
: &
S–f
) {

257 
£lf
.
lock
.
add
(&
Ùh”
.lock);

258 
	g£lf
.
	gwr™e
.
add
(&
Ùh”
.
wr™e
);

259 
	g£lf
.
	gd©a
.
add
(&
Ùh”
.
d©a
);

263 #[
d”ive
(
DeçuÉ
)]

264 
pub
 
	sSti¡icsSumm¬y
 {

265 
pub
 
	m¡©
: 
Sti¡ics
,

266 
pub
 
	mcouÁ
: 
u64
,

269 
im¶
 
	gSti¡icsSumm¬y
 {

270 
pub
 
â
 
add_¡©i¡ics
(&
mut
 
£lf
, 
v
: &
Sti¡ics
) {

271 
£lf
.
¡©
.
add
(
v
);

272 
	g£lf
.
	gcouÁ
 += 1;

276 
pub
 
	sCursÜ
 {

277 
	m™”
: 
Box
<
I‹¿tÜ
>,

278 
	msÿn_mode
: 
SÿnMode
,

280 
	mmš_key
: 
O±iÚ
<
Vec
<
u8
>>,

281 
	mmax_key
: 
O±iÚ
<
Vec
<
u8
>>,

284 
im¶
 
	gCursÜ
 {

285 
pub
 
â
 
Ãw
(
™”
: 
Box
<
I‹¿tÜ
>, 
mode
: 
SÿnMode
è-> 
CursÜ
 {

286 
CursÜ
 {

287 
™”
: iter,

288 
	gsÿn_mode
: 
mode
,

289 
	gmš_key
: 
NÚe
,

290 
	gmax_key
: 
NÚe
,

294 
pub
 
â
 
£ek
(&
mut
 
£lf
, 
key
: &
Key
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
ResuÉ
<
boŞ
> {

295 
as£¹_Ã
!(
£lf
.
sÿn_mode
, 
	gSÿnMode
::
Backw¬d
);

296 
	g£lf
.
	gmax_key
.
as_»f
().
m­_Ü
(
çl£
, |
k
| k <ğ
key
.
’coded
()) {

297 
£lf
.
™”
.
v®id©e_key
(
key
)?;

298  
Ok
(
çl£
);

301 
	g£lf
.
	gsÿn_mode
 =ğ
SÿnMode
::
FÜw¬d
 && 
£lf
.
v®id
() &&

302 
£lf
.
™”
.
key
(è>ğkey.
’coded
().
as_¦iû
()

304  
Ok
(
Œue
);

307 
	g¡©i¡ics
.
	g£ek
 += 1;

309 !
	g£lf
.
	g™”
.
£ek
(
key
)? {

310 
	g£lf
.
	gmax_key
 = 
Some
(
key
.
’coded
().
to_owÃd
());

311  
Ok
(
çl£
);

313 
Ok
(
Œue
)

320 
pub
 
â
 
Ã¬_£ek
(&
mut
 
£lf
, 
key
: &
Key
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
ResuÉ
<
boŞ
> {

321 
as£¹_Ã
!(
£lf
.
sÿn_mode
, 
	gSÿnMode
::
Backw¬d
);

322 !
	g£lf
.
	g™”
.
v®id
() {

323  
	g£lf
.
£ek
(
key
, 
¡©i¡ics
);

325 
Ët
 
	gÜd
 = 
£lf
.
™”
.
key
().
cmp
(key.
’coded
());

326 
	gÜd
 =ğ
Ord”šg
::
Equ®
 ||

327 (
£lf
.
sÿn_mode
 =ğ
SÿnMode
::
FÜw¬d
 && 
Üd
 =ğ
Ord”šg
::
G»©”
)

329  
Ok
(
Œue
);

331 
	g£lf
.
	gmax_key
.
as_»f
().
m­_Ü
(
çl£
, |
k
| k <ğ
key
.
’coded
()) {

332 
£lf
.
™”
.
v®id©e_key
(
key
)?;

333  
Ok
(
çl£
);

335 
	gÜd
 =ğ
Ord”šg
::
G»©”
 {

336 
Ã¬_loİ
!(

337 
£lf
.
´ev
(
¡©i¡ics
è&& s–f.
™”
.
key
(è> key.
’coded
().
as_¦iû
(),

338 
£lf
.
£ek
(
key
, 
¡©i¡ics
),

339 
¡©i¡ics


341 
	g£lf
.
	g™”
.
v®id
() {

342 
	g£lf
.
	g™”
.
key
(è< 
	gkey
.
’coded
().
as_¦iû
() {

343 
	g£lf
.
Ãxt
(
¡©i¡ics
);

346 
	gas£¹
!(
	g£lf
.
£ek_to_fœ¡
(
¡©i¡ics
));

347  
Ok
(
Œue
);

351 
	gÃ¬_loİ
!(

352 
	g£lf
.
Ãxt
(
¡©i¡ics
è&& s–f.
	g™”
.
key
(è< 
	gkey
.
’coded
().
as_¦iû
(),

353 
	g£lf
.
£ek
(
key
, 
¡©i¡ics
),

354 
	g¡©i¡ics


357 !
	g£lf
.
	g™”
.
v®id
() {

358 
	g£lf
.
	gmax_key
 = 
Some
(
key
.
’coded
().
to_owÃd
());

359  
Ok
(
çl£
);

361 
Ok
(
Œue
)

368 
pub
 
â
 
g‘
(&
mut
 
£lf
, 
key
: &
Key
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
ResuÉ
<
O±iÚ
<&[
u8
]>> {

369 
£lf
.
sÿn_mode
 !ğ
SÿnMode
::
Backw¬d
 {

370 
£lf
.
Ã¬_£ek
(
key
, 
¡©i¡ics
)? && s–f.
™”
.key(è=ğ&**key.
’coded
() {

371  
Ok
(
Some
(
£lf
.
™”
.
v®ue
()));

373  
Ok
(
NÚe
);

375 
	g£lf
.
Ã¬_£ek_fÜ_´ev
(
key
, 
¡©i¡ics
)? && s–f.
	g™”
.key(è=ğ&**key.
’coded
() {

376  
Ok
(
Some
(
£lf
.
™”
.
v®ue
()));

378 
Ok
(
NÚe
)

381 
â
 
£ek_fÜ_´ev
(&
mut
 
£lf
, 
key
: &
Key
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
ResuÉ
<
boŞ
> {

382 
as£¹_Ã
!(
£lf
.
sÿn_mode
, 
	gSÿnMode
::
FÜw¬d
);

383 
	g£lf
.
	gmš_key
.
as_»f
().
m­_Ü
(
çl£
, |
k
| k >ğ
key
.
’coded
()) {

384 
£lf
.
™”
.
v®id©e_key
(
key
)?;

385  
Ok
(
çl£
);

388 
	g£lf
.
	gsÿn_mode
 =ğ
SÿnMode
::
Backw¬d
 && 
£lf
.
v®id
() &&

389 
£lf
.
™”
.
key
(è<ğkey.
’coded
().
as_¦iû
()

391  
Ok
(
Œue
);

394 
	g¡©i¡ics
.
	g£ek_fÜ_´ev
 += 1;

395 !
	g£lf
.
	g™”
.
£ek_fÜ_´ev
(
key
)? {

396 
	g£lf
.
	gmš_key
 = 
Some
(
key
.
’coded
().
to_owÃd
());

397  
Ok
(
çl£
);

399 
Ok
(
Œue
)

403 
pub
 
â
 
Ã¬_£ek_fÜ_´ev
(&
mut
 
£lf
, 
key
: &
Key
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
ResuÉ
<
boŞ
> {

404 
as£¹_Ã
!(
£lf
.
sÿn_mode
, 
	gSÿnMode
::
FÜw¬d
);

405 !
	g£lf
.
	g™”
.
v®id
() {

406  
	g£lf
.
£ek_fÜ_´ev
(
key
, 
¡©i¡ics
);

408 
Ët
 
	gÜd
 = 
£lf
.
™”
.
key
().
cmp
(key.
’coded
());

409 
	gÜd
 =ğ
Ord”šg
::
Equ®
 ||

410 (
£lf
.
sÿn_mode
 =ğ
SÿnMode
::
Backw¬d
 && 
Üd
 =ğ
Ord”šg
::
Less
)

412  
Ok
(
Œue
);

415 
	g£lf
.
	gmš_key
.
as_»f
().
m­_Ü
(
çl£
, |
k
| k >ğ
key
.
’coded
()) {

416 
£lf
.
™”
.
v®id©e_key
(
key
)?;

417  
Ok
(
çl£
);

420 
	gÜd
 =ğ
Ord”šg
::
Less
 {

421 
Ã¬_loİ
!(

422 
£lf
.
Ãxt
(
¡©i¡ics
è&& s–f.
™”
.
key
(è< key.
’coded
().
as_¦iû
(),

423 
£lf
.
£ek_fÜ_´ev
(
key
, 
¡©i¡ics
),

424 
¡©i¡ics


426 
	g£lf
.
	g™”
.
v®id
() {

427 
	g£lf
.
	g™”
.
key
(è> 
	gkey
.
’coded
().
as_¦iû
() {

428 
	g£lf
.
´ev
(
¡©i¡ics
);

431 
	gas£¹
!(
	g£lf
.
£ek_to_Ï¡
(
¡©i¡ics
));

432  
Ok
(
Œue
);

435 
	gÃ¬_loİ
!(

436 
	g£lf
.
´ev
(
¡©i¡ics
è&& s–f.
	g™”
.
key
(è> 
	gkey
.
’coded
().
as_¦iû
(),

437 
	g£lf
.
£ek_fÜ_´ev
(
key
, 
¡©i¡ics
),

438 
	g¡©i¡ics


442 !
	g£lf
.
	g™”
.
v®id
() {

443 
	g£lf
.
	gmš_key
 = 
Some
(
key
.
’coded
().
to_owÃd
());

444  
Ok
(
çl£
);

446 
Ok
(
Œue
)

449 
pub
 
â
 
»v”£_£ek
(&
mut
 
£lf
, 
key
: &
Key
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
ResuÉ
<
boŞ
> {

450 !
£lf
.
£ek_fÜ_´ev
(
key
, 
¡©i¡ics
)? {

451  
Ok
(
çl£
);

454 
	g£lf
.
	g™”
.
key
(è=ğ&**key.
’coded
() {

457  
Ok
(
£lf
.
´ev
(
¡©i¡ics
));

460 
Ok
(
Œue
)

467 
pub
 
â
 
Ã¬_»v”£_£ek
(&
mut
 
£lf
, 
key
: &
Key
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
ResuÉ
<
boŞ
> {

468 !
£lf
.
Ã¬_£ek_fÜ_´ev
(
key
, 
¡©i¡ics
)? {

469  
Ok
(
çl£
);

472 
	g£lf
.
	g™”
.
key
(è=ğ&**key.
’coded
() {

473  
Ok
(
£lf
.
´ev
(
¡©i¡ics
));

476 
Ok
(
Œue
)

479 #[
šlše
]

480 
pub
 
â
 
key
(&
£lf
è-> &[
u8
] {

481 
	g£lf
.
	g™”
.
key
()

484 #[
šlše
]

485 
pub
 
â
 
v®ue
(&
£lf
è-> &[
u8
] {

486 
	g£lf
.
	g™”
.
v®ue
()

489 #[
šlše
]

490 
pub
 
â
 
£ek_to_fœ¡
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
boŞ
 {

491 
¡©i¡ics
.
£ek
 += 1;

492 
	g£lf
.
	g™”
.
£ek_to_fœ¡
()

495 #[
šlše
]

496 
pub
 
â
 
£ek_to_Ï¡
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
boŞ
 {

497 
¡©i¡ics
.
£ek
 += 1;

498 
	g£lf
.
	g™”
.
£ek_to_Ï¡
()

501 #[
šlše
]

502 
pub
 
â
 
Ãxt
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
boŞ
 {

503 
¡©i¡ics
.
Ãxt
 += 1;

504 
	g£lf
.
	g™”
.
Ãxt
()

507 #[
šlše
]

508 
pub
 
â
 
´ev
(&
mut
 
£lf
, 
¡©i¡ics
: &muˆ
CFSti¡ics
è-> 
boŞ
 {

509 
¡©i¡ics
.
´ev
 += 1;

510 
	g£lf
.
	g™”
.
´ev
()

513 #[
šlše
]

514 
pub
 
â
 
v®id
(&
£lf
è-> 
	gboŞ
 {

515 
	g£lf
.
	g™”
.
v®id
()

520 
pub
 
â
 
Ãw_loÿl_’gše
(
·th
: &
¡r
, 
cfs
: &[
CfName
]è-> 
ResuÉ
<
Box
<
Engše
>> {

521 
EngšeRocksdb
::
Ãw
(
·th
, 
cfs
).
m­
(|
’gše
| -> 
Box
<
Engše
> { Box::new(engine) })

524 
quick_”rÜ
! {

525 #[
d”ive
(
Debug
)]

526 
pub
 
	eE¼Ü
 {

527 
Reque¡
(
”r
: 
E¼ÜH—d”
) {

528 
äom
()

529 
desütiÚ
("requesto underhookƒngine failed")

530 
di¥Ïy
("{:?}", 
”r
)

532 
RocksDb
(
msg
: 
SŒšg
) {

533 
äom
()

534 
desütiÚ
("RocksDbƒrror")

535 
di¥Ïy
("RocksDb {}", 
msg
)

537 
Timeout
(
d
: 
Du¿tiÚ
) {

538 
desütiÚ
("requestimeout")

539 
di¥Ïy
("timeouˆaá” {:?}", 
d
)

541 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
S’d
 + 
Sync
>) {

542 
äom
()

543 
ÿu£
(
”r
.
as_»f
())

544 
desütiÚ
(
”r
.description())

545 
di¥Ïy
("unknowÀ”rÜ {:?}", 
”r
)

550 
im¶
 
	gE¼Ü
 {

551 
pub
 
â
 
maybe_şÚe
(&
£lf
è-> 
	gO±iÚ
<
	gE¼Ü
> {

552 
m©ch
 *
	g£lf
 {

553 
	gE¼Ü
::
Reque¡
(
»f
 
e
è=> 
Some
(
E¼Ü
::Reque¡Ó.
şÚe
())),

554 
	gE¼Ü
::
RocksDb
(
»f
 
msg
è=> 
Some
(
E¼Ü
::RocksDb(msg.
şÚe
())),

555 
	gE¼Ü
::
Timeout
(
d
è=> 
Some
(
E¼Ü
::Timeout(d)),

556 
	gE¼Ü
::
Oth”
(
_
è=> 
NÚe
,

561 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

563 #[
cfg
(
‹¡
)]

564 
mod
 
	g‹¡s
 {

565 
u£
 
	gsu³r
::*;

566 
u£
 
	gsu³r
::
SEEK_BOUND
;

567 
u£
 
	g‹mpdœ
::
TempDœ
;

568 
u£
 
	g¡Üage
::{
make_key
, 
	gCfName
, 
	gCF_DEFAULT
};

569 
u£
 
	gut
::
codec
::
by‹s
;

570 
u£
 
	gut
::
esÿ³
;

571 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

572 
u£
 
	gsu³r
::
su³r
::su³r::
¿á¡Üe
::
¡Üe
::
’gše
::
I‹rO±iÚ
;

574 cÚ¡ 
	gTEST_ENGINE_CFS
: &'static [CfName] = &["cf"];

576 #[
‹¡
]

577 
â
 
rocksdb
() {

578 
Ët
 
dœ
 = 
TempDœ
::
Ãw
("rocksdb_‹¡").
unw¿p
();

579 
Ët
 
	ge
 = 
Ãw_loÿl_’gše
(
dœ
.
·th
().
to_¡r
().
unw¿p
(), 
TEST_ENGINE_CFS
).unwrap();

581 
‹¡_g‘_put
(
e
.
as_»f
());

582 
‹¡_b©ch
(
e
.
as_»f
());

583 
‹¡_em±y_£ek
(
e
.
as_»f
());

584 
‹¡_£ek
(
e
.
as_»f
());

585 
‹¡_Ã¬_£ek
(
e
.
as_»f
());

586 
‹¡_cf
(
e
.
as_»f
());

587 
‹¡_em±y_wr™e
(
e
.
as_»f
());

590 #[
‹¡
]

591 
â
 
rocksdb_»İ’
() {

592 
Ët
 
	gdœ
 = 
TempDœ
::
Ãw
("rocksdb_‹¡").
unw¿p
();

594 
Ët
 
	ge
 = 
Ãw_loÿl_’gše
(
dœ
.
·th
().
to_¡r
().
unw¿p
(), 
TEST_ENGINE_CFS
).unwrap();

595 
mu¡_put_cf
(
e
.
as_»f
(), "cf", 
b
"k", b"v1");

598 
Ët
 
	ge
 = 
Ãw_loÿl_’gše
(
dœ
.
·th
().
to_¡r
().
unw¿p
(), 
TEST_ENGINE_CFS
).unwrap();

599 
as£¹_has_cf
(
e
.
as_»f
(), "cf", 
b
"k", b"v1");

603 
â
 
mu¡_put
(
’gše
: &
Engše
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

604 
’gše


605 .
put
(&
CÚ‹xt
::
Ãw
(), 
make_key
(
key
), 
v®ue
.
to_vec
())

606 .
unw¿p
();

609 
â
 
mu¡_put_cf
(
’gše
: &
Engše
, 
cf
: 
CfName
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

610 
’gše


611 .
put_cf
(&
CÚ‹xt
::
Ãw
(), 
cf
, 
make_key
(
key
), 
v®ue
.
to_vec
())

612 .
unw¿p
();

615 
â
 
mu¡_d–‘e
(
’gše
: &
Engše
, 
key
: &[
u8
]) {

616 
’gše
.
d–‘e
(&
CÚ‹xt
::
Ãw
(), 
make_key
(
key
)).
unw¿p
();

619 
â
 
mue¡_d–‘e_cf
(
’gše
: &
Engše
, 
cf
: 
CfName
, 
key
: &[
u8
]) {

620 
’gše


621 .
d–‘e_cf
(&
CÚ‹xt
::
Ãw
(), 
cf
, 
make_key
(
key
))

622 .
unw¿p
();

625 
â
 
as£¹_has
(
’gše
: &
Engše
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

626 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

627 
	gas£¹_eq
!(
	g¢­shÙ
.
g‘
(&
make_key
(
key
)).
unw¿p
().unw¿p(), 
	gv®ue
);

630 
â
 
as£¹_has_cf
(
’gše
: &
Engše
, 
cf
: 
CfName
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

631 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

632 
	gas£¹_eq
!(
	g¢­shÙ
.
g‘_cf
(
cf
, &
make_key
(
key
)).
unw¿p
().unw¿p(), 
	gv®ue
);

635 
â
 
as£¹_nÚe
(
’gše
: &
Engše
, 
key
: &[
u8
]) {

636 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

637 
	gas£¹_eq
!(
	g¢­shÙ
.
g‘
(&
make_key
(
key
)).
unw¿p
(), 
	gNÚe
);

640 
â
 
as£¹_nÚe_cf
(
’gše
: &
Engše
, 
cf
: 
CfName
, 
key
: &[
u8
]) {

641 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

642 
	gas£¹_eq
!(
	g¢­shÙ
.
g‘_cf
(
cf
, &
make_key
(
key
)).
unw¿p
(), 
	gNÚe
);

645 
â
 
as£¹_£ek
(
’gše
: &
Engše
, 
key
: &[
u8
], 
·œ
: (&[u8], &[u8])) {

646 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

647 
Ët
 
mut
 
	g™”
 = 
¢­shÙ


648 .
™”
(
I‹rO±iÚ
::(), 
SÿnMode
::
Mixed
)

649 .
unw¿p
();

650 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

651 
	g™”
.
£ek
(&
make_key
(
key
), &
mut
 
¡©i¡ics
).
unw¿p
();

652 
	gas£¹_eq
!(

653 (
	g™”
.
key
(), i‹r.
v®ue
()),

654 (&*
	gby‹s
::
’code_by‹s
(
·œ
.0), 
	g·œ
.1)

658 
â
 
as£¹_»v”£_£ek
(
’gše
: &
Engše
, 
key
: &[
u8
], 
·œ
: (&[u8], &[u8])) {

659 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

660 
Ët
 
mut
 
	g™”
 = 
¢­shÙ


661 .
™”
(
I‹rO±iÚ
::(), 
SÿnMode
::
Mixed
)

662 .
unw¿p
();

663 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

664 
	g™”
.
»v”£_£ek
(&
make_key
(
key
), &
mut
 
¡©i¡ics
).
unw¿p
();

665 
	gas£¹_eq
!(

666 (
	g™”
.
key
(), i‹r.
v®ue
()),

667 (&*
	gby‹s
::
’code_by‹s
(
·œ
.0), 
	g·œ
.1)

671 
â
 
as£¹_Ã¬_£ek
(
cursÜ
: &
mut
 
CursÜ
, 
key
: &[
u8
], 
·œ
: (&[u8], &[u8])) {

672 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

673 
	gas£¹
!(

674 
	gcursÜ
.
Ã¬_£ek
(&
make_key
(
key
), &
mut
 
¡©i¡ics
).
unw¿p
(),

675 
esÿ³
(
key
)

677 
	gas£¹_eq
!(

678 (
	gcursÜ
.
key
(), cursÜ.
v®ue
()),

679 (&*
	gby‹s
::
’code_by‹s
(
·œ
.0), 
	g·œ
.1)

683 
â
 
as£¹_Ã¬_»v”£_£ek
(
cursÜ
: &
mut
 
CursÜ
, 
key
: &[
u8
], 
·œ
: (&[u8], &[u8])) {

684 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

685 
	gas£¹
!(

686 
	gcursÜ


687 .
Ã¬_»v”£_£ek
(&
make_key
(
key
), &
mut
 
¡©i¡ics
)

688 .
unw¿p
(),

689 
esÿ³
(
key
)

691 
	gas£¹_eq
!(

692 (
	gcursÜ
.
key
(), cursÜ.
v®ue
()),

693 (&*
	gby‹s
::
’code_by‹s
(
·œ
.0), 
	g·œ
.1)

697 
â
 
‹¡_g‘_put
(
’gše
: &
Engše
) {

698 
as£¹_nÚe
(
’gše
, 
b
"x");

699 
mu¡_put
(
’gše
, 
b
"x", b"1");

700 
as£¹_has
(
’gše
, 
b
"x", b"1");

701 
mu¡_put
(
’gše
, 
b
"x", b"2");

702 
as£¹_has
(
’gše
, 
b
"x", b"2");

705 
â
 
‹¡_b©ch
(
’gše
: &
Engše
) {

706 
’gše


707 .
wr™e
(

708 &
CÚ‹xt
::
Ãw
(),

709 
vec
![

710 
Modify
::
Put
(
CF_DEFAULT
, 
make_key
(
b
"x"), b"1".
to_vec
()),

711 
Modify
::
Put
(
CF_DEFAULT
, 
make_key
(
b
"y"), b"2".
to_vec
()),

714 .
unw¿p
();

715 
as£¹_has
(
’gše
, 
b
"x", b"1");

716 
as£¹_has
(
’gše
, 
b
"y", b"2");

718 
	g’gše


719 .
wr™e
(

720 &
CÚ‹xt
::
Ãw
(),

721 
vec
![

722 
Modify
::
D–‘e
(
CF_DEFAULT
, 
make_key
(
b
"x")),

723 
Modify
::
D–‘e
(
CF_DEFAULT
, 
make_key
(
b
"y")),

726 .
unw¿p
();

727 
as£¹_nÚe
(
’gše
, 
b
"y");

728 
as£¹_nÚe
(
’gše
, 
b
"y");

731 
â
 
‹¡_£ek
(
’gše
: &
Engše
) {

732 
mu¡_put
(
’gše
, 
b
"x", b"1");

733 
as£¹_£ek
(
’gše
, 
b
"x", (b"x", b"1"));

734 
as£¹_£ek
(
’gše
, 
b
"a", (b"x", b"1"));

735 
as£¹_»v”£_£ek
(
’gše
, 
b
"x1", (b"x", b"1"));

736 
mu¡_put
(
’gše
, 
b
"z", b"2");

737 
as£¹_£ek
(
’gše
, 
b
"y", (b"z", b"2"));

738 
as£¹_£ek
(
’gše
, 
b
"x\x00", (b"z", b"2"));

739 
as£¹_»v”£_£ek
(
’gše
, 
b
"y", (b"x", b"1"));

740 
as£¹_»v”£_£ek
(
’gše
, 
b
"z", (b"x", b"1"));

741 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

742 
Ët
 
mut
 
	g™”
 = 
¢­shÙ


743 .
™”
(
I‹rO±iÚ
::(), 
SÿnMode
::
Mixed
)

744 .
unw¿p
();

745 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

746 
	gas£¹
!(!
	g™”
.
£ek
(&
make_key
(
b
"z\x00"), &
mut
 
¡©i¡ics
).
unw¿p
());

747 
	gas£¹
!(!
	g™”
.
»v”£_£ek
(&
make_key
(
b
"x"), &
mut
 
¡©i¡ics
)

748 .
unw¿p
());

749 
mu¡_d–‘e
(
’gše
, 
b
"x");

750 
mu¡_d–‘e
(
’gše
, 
b
"z");

753 
â
 
‹¡_Ã¬_£ek
(
’gše
: &
Engše
) {

754 
mu¡_put
(
’gše
, 
b
"x", b"1");

755 
mu¡_put
(
’gše
, 
b
"z", b"2");

756 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

757 
Ët
 
mut
 
	gcursÜ
 = 
¢­shÙ


758 .
™”
(
I‹rO±iÚ
::(), 
SÿnMode
::
Mixed
)

759 .
unw¿p
();

760 
as£¹_Ã¬_£ek
(&
mut
 
cursÜ
, 
b
"x", (b"x", b"1"));

761 
as£¹_Ã¬_£ek
(&
mut
 
cursÜ
, 
b
"a", (b"x", b"1"));

762 
as£¹_Ã¬_»v”£_£ek
(&
mut
 
cursÜ
, 
b
"z1", (b"z", b"2"));

763 
as£¹_Ã¬_»v”£_£ek
(&
mut
 
cursÜ
, 
b
"x1", (b"x", b"1"));

764 
as£¹_Ã¬_£ek
(&
mut
 
cursÜ
, 
b
"y", (b"z", b"2"));

765 
as£¹_Ã¬_£ek
(&
mut
 
cursÜ
, 
b
"x\x00", (b"z", b"2"));

766 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

767 
	gas£¹
!(!
	gcursÜ


768 .
Ã¬_£ek
(&
make_key
(
b
"z\x00"), &
mut
 
¡©i¡ics
)

769 .
unw¿p
());

771 
i
 
	gš
 0..
	gsu³r
::
SEEK_BOUND
 {

772 
Ët
 
key
 = 
fÜm©
!("y{}", 
	gi
);

773 
mu¡_put
(
’gše
, 
key
.
as_by‹s
(), 
b
"3");

775 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

776 
Ët
 
mut
 
	gcursÜ
 = 
¢­shÙ


777 .
™”
(
I‹rO±iÚ
::(), 
SÿnMode
::
Mixed
)

778 .
unw¿p
();

779 
as£¹_Ã¬_£ek
(&
mut
 
cursÜ
, 
b
"x", (b"x", b"1"));

780 
as£¹_Ã¬_£ek
(&
mut
 
cursÜ
, 
b
"z", (b"z", b"2"));

782 
mu¡_d–‘e
(
’gše
, 
b
"x");

783 
mu¡_d–‘e
(
’gše
, 
b
"z");

784 
i
 
	gš
 0..
	gsu³r
::
SEEK_BOUND
 {

785 
Ët
 
key
 = 
fÜm©
!("y{}", 
	gi
);

786 
mu¡_d–‘e
(
’gše
, 
key
.
as_by‹s
());

790 
â
 
‹¡_em±y_£ek
(
’gše
: &
Engše
) {

791 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

792 
Ët
 
mut
 
	gcursÜ
 = 
¢­shÙ


793 .
™”
(
I‹rO±iÚ
::(), 
SÿnMode
::
Mixed
)

794 .
unw¿p
();

795 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

796 
	gas£¹
!(!
	gcursÜ


797 .
Ã¬_»v”£_£ek
(&
make_key
(
b
"x"), &
mut
 
¡©i¡ics
)

798 .
unw¿p
());

799 
	gas£¹
!(!
	gcursÜ


800 .
Ã¬_»v”£_£ek
(&
make_key
(
b
"z"), &
mut
 
¡©i¡ics
)

801 .
unw¿p
());

802 
	gas£¹
!(!
	gcursÜ


803 .
Ã¬_»v”£_£ek
(&
make_key
(
b
"w"), &
mut
 
¡©i¡ics
)

804 .
unw¿p
());

805 
	gas£¹
!(!
	gcursÜ
.
Ã¬_£ek
(&
make_key
(
b
"x"), &
mut
 
¡©i¡ics
).
unw¿p
());

806 
	gas£¹
!(!
	gcursÜ
.
Ã¬_£ek
(&
make_key
(
b
"z"), &
mut
 
¡©i¡ics
).
unw¿p
());

807 
	gas£¹
!(!
	gcursÜ
.
Ã¬_£ek
(&
make_key
(
b
"w"), &
mut
 
¡©i¡ics
).
unw¿p
());

810 
	gmaüo_ruËs
! 
	gas£¹_£ek
 {

811 (
	g$cursÜ
:
id’t
, 
	g$func
:id’t, 
	g$k
:
ex´
, 
	g$»s
:ident) => ({

812 
Ët
 
mut
 
¡©i¡ics
 = 
CFSti¡ics
::();

813 
	gas£¹_eq
!(
	g$cursÜ
.
$func
(&
$k
, &
mut
 
¡©i¡ics
).
unw¿p
(), 
	g$»s
.
is_some
(),

814 "as£¹_£ek {} faedƒx°{:?}", 
	g$k
, 
	g$»s
);

815 
Ët
 
Some
((
»f
 
k
,„eà
v
)èğ
$»s
 {

816 
as£¹_eq
!(
$cursÜ
.
key
(), 
by‹s
::
’code_by‹s
(
k
.
as_by‹s
()).
as_¦iû
());

817 
	gas£¹_eq
!(
	g$cursÜ
.
v®ue
(), 
	gv
.
as_by‹s
());

822 #[
d”ive
(
P¬tŸlEq
, 
Eq
, 
ClÚe
, 
Cİy
)]

823 
	eS“kMode
 {

824 
	gNÜm®
,

825 
	gRev”£
,

826 
	gFÜP»v
,

829 #[
®low
(
cyşom©ic_com¶ex™y
)]

831 
â
 
‹¡_lš—r_£ek
(

832 
¢­shÙ
: &
SÇpshÙ
,

833 
mode
: 
SÿnMode
,

834 
£ek_mode
: 
S“kMode
,

835 
¡¬t
: 
usize
,

836 
¡•
: 
usize
,

838 
Ët
 
mut
 
	gcursÜ
 = 
¢­shÙ
.
™”
(
I‹rO±iÚ
::(), 
mode
).
unw¿p
();

839 
Ët
 
mut
 
	gÃ¬_cursÜ
 = 
¢­shÙ
.
™”
(
I‹rO±iÚ
::(), 
mode
).
unw¿p
();

840 
Ët
 
	glim™
 = (
SEEK_BOUND
 * 10 + 50 - 1) * 2;

842 
	g_
, 
mut
 
	gi
è
š
 (
¡¬t
..
SEEK_BOUND
 * 30)

843 .
’um”©e
()

844 .
f‹r
(|&(
i
, 
_
)| i % 
¡•
 == 0)

846 
£ek_mode
 !ğ
S“kMode
::
NÜm®
 {

847 
i
 = 
SEEK_BOUND
 * 30 - 1 - i;

849 
Ët
 
	gkey
 = 
fÜm©
!("key_{:03}", 
	gi
);

850 
Ët
 
	g£ek_key
 = 
make_key
(
key
.
as_by‹s
());

851 
Ët
 
	gexp_kv
 = 
i
 <= 100 {

852 
m©ch
 
£ek_mode
 {

853 
S“kMode
::
Rev”£
 => 
NÚe
,

854 
	gS“kMode
::
FÜP»v
 
i
 < 100 => 
NÚe
,

855 
	gS“kMode
::
NÜm®
 | 
S“kMode
::
FÜP»v
 => {

856 
Some
(("key_100".
to_owÃd
(), "value_50".to_owned()))

859 } 
	gi
 <ğ
lim™
 {

860 
£ek_mode
 =ğ
S“kMode
::
Rev”£
 {

861 
Some
((

862 
fÜm©
!("key_{}", (
i
 - 1) / 2 * 2),

863 
fÜm©
!("v®ue_{}", (
i
 - 1) / 2),

865 } 
£ek_mode
 =ğ
S“kMode
::
FÜP»v
 {

866 
Some
((
fÜm©
!("key_{}", 
i
 / 2 * 2), format!("value_{}", i / 2)))

868 
Some
((

869 
fÜm©
!("key_{}", (
i
 + 1) / 2 * 2),

870 
fÜm©
!("v®ue_{}", (
i
 + 1) / 2),

873 } 
	g£ek_mode
 !ğ
S“kMode
::
NÜm®
 {

874 
Some
((

875 
fÜm©
!("key_{:03}", 
lim™
),

876 
fÜm©
!("v®ue_{:03}", 
lim™
 / 2),

879 
NÚe


882 
m©ch
 
	g£ek_mode
 {

883 
	gS“kMode
::
Rev”£
 => {

884 
as£¹_£ek
!(
cursÜ
, 
»v”£_£ek
, 
£ek_key
, 
exp_kv
);

885 
	gas£¹_£ek
!(
	gÃ¬_cursÜ
, 
	gÃ¬_»v”£_£ek
, 
	g£ek_key
, 
	gexp_kv
);

887 
	gS“kMode
::
NÜm®
 => {

888 
as£¹_£ek
!(
cursÜ
, 
£ek
, 
£ek_key
, 
exp_kv
);

889 
	gas£¹_£ek
!(
	gÃ¬_cursÜ
, 
	gÃ¬_£ek
, 
	g£ek_key
, 
	gexp_kv
);

891 
	gS“kMode
::
FÜP»v
 => {

892 
as£¹_£ek
!(
cursÜ
, 
£ek_fÜ_´ev
, 
£ek_key
, 
exp_kv
);

893 
	gas£¹_£ek
!(
	gÃ¬_cursÜ
, 
	gÃ¬_£ek_fÜ_´ev
, 
	g£ek_key
, 
	gexp_kv
);

900 #[
‹¡
]

901 
â
 
‹¡_lš—r
() {

902 
Ët
 
	gdœ
 = 
TempDœ
::
Ãw
("rocksdb_‹¡").
unw¿p
();

903 
Ët
 
	ge
 = 
Ãw_loÿl_’gše
(
dœ
.
·th
().
to_¡r
().
unw¿p
(), 
TEST_ENGINE_CFS
).unwrap();

904 
i
 
	gš
 50..50 + 
	gSEEK_BOUND
 * 10 {

905 
Ët
 
	gkey
 = 
fÜm©
!("key_{}", 
	gi
 * 2);

906 
Ët
 
	gv®ue
 = 
fÜm©
!("v®ue_{}", 
	gi
);

907 
mu¡_put
(
e
.
as_»f
(), 
key
.
as_by‹s
(), 
v®ue
.as_bytes());

909 
Ët
 
	g¢­shÙ
 = 
e
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

911 
¡•
 
	gš
 1..
	gSEEK_BOUND
 * 3 {

912 
¡¬t
 
	gš
 0..10 {

913 
‹¡_lš—r_£ek
(

914 
¢­shÙ
.
as_»f
(),

915 
SÿnMode
::
FÜw¬d
,

916 
S“kMode
::
NÜm®
,

917 
¡¬t
 * 
SEEK_BOUND
,

918 
¡•
,

920 
‹¡_lš—r_£ek
(

921 
¢­shÙ
.
as_»f
(),

922 
SÿnMode
::
Backw¬d
,

923 
S“kMode
::
Rev”£
,

924 
¡¬t
 * 
SEEK_BOUND
,

925 
¡•
,

927 
‹¡_lš—r_£ek
(

928 
¢­shÙ
.
as_»f
(),

929 
SÿnMode
::
Backw¬d
,

930 
S“kMode
::
FÜP»v
,

931 
¡¬t
 * 
SEEK_BOUND
,

932 
¡•
,

936 &
£ek_mode
 
	gš
 &[
S“kMode
::
Rev”£
, S“kMode::
NÜm®
, S“kMode::
FÜP»v
] {

937 
¡•
 
š
 1..
SEEK_BOUND
 * 3 {

938 
¡¬t
 
š
 0..10 {

939 
‹¡_lš—r_£ek
(

940 
¢­shÙ
.
as_»f
(),

941 
SÿnMode
::
Mixed
,

942 
£ek_mode
,

943 
¡¬t
 * 
SEEK_BOUND
,

944 
¡•
,

951 
â
 
‹¡_cf
(
’gše
: &
Engše
) {

952 
as£¹_nÚe_cf
(
’gše
, "cf", 
b
"key");

953 
mu¡_put_cf
(
’gše
, "cf", 
b
"key", b"value");

954 
as£¹_has_cf
(
’gše
, "cf", 
b
"key", b"value");

955 
mue¡_d–‘e_cf
(
’gše
, "cf", 
b
"key");

956 
as£¹_nÚe_cf
(
’gše
, "cf", 
b
"key");

959 
â
 
‹¡_em±y_wr™e
(
’gše
: &
Engše
) {

960 
’gše
.
wr™e
(&
CÚ‹xt
::
Ãw
(), 
vec
![]).
unw¿p
();

	@src/storage/engine/raftkv.rs

15 
u£
 
	g£rv”
::
Œª¥Üt
::
RaáStÜeRou‹r
;

16 
u£
 
	g¿á¡Üe
::
¡Üe
;

17 
u£
 
	g¿á¡Üe
::
”rÜs
::
E¼Ü
 
as
 
RaáS”v”E¼Ü
;

18 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::{
RegiÚI‹¿tÜ
, 
	gRegiÚSÇpshÙ
};

19 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::{
P“kabË
, 
SÇpshÙ
 
as
 
	gEngšeSÇpshÙ
};

20 
u£
 
	grocksdb
::
TabËPrİ”t›sCŞËùiÚ
;

21 
u£
 
	g¡Üage
;

22 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
CmdTy³
, 
	gD–‘eRªgeReque¡
, 
	gD–‘eReque¡
, 
	gPutReque¡
, 
	gRaáCmdReque¡
,

23 
	gRaáCmdRe¥Ú£
, 
	gRaáReque¡H—d”
, 
	gReque¡
, 
	gRe¥Ú£
};

24 
u£
 
	gkv´Ùo
::
”rÜpb
;

25 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

27 
u£
 
	g¡d
::
sync
::
Arc
;

28 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDebug
, 
	gFÜm©‹r
};

29 
u£
 
	g¡d
::
io
::
E¼Ü
 
as
 
IoE¼Ü
;

30 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

31 
u£
 
	g¡d
::
»suÉ
;

32 
u£
 
	grocksdb
::
DB
;

33 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

35 
u£
 
	g¡Üage
::
’gše
;

36 
u£
 
	gsu³r
::{
B©chC®lback
, 
	gC®lback
, 
	gCbCÚ‹xt
, 
	gCursÜ
, 
	gEngše
, 
I‹¿tÜ
 
as
 
	gEngšeI‹¿tÜ
,

37 
	gModify
, 
	gSÿnMode
, 
	gSÇpshÙ
};

38 
u£
 
	g¡Üage
::{
CfName
, 
	gKey
, 
	gV®ue
, 
	gCF_DEFAULT
};

39 
u£
 
	gsu³r
::
m‘rics
::*;

40 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::
I‹rO±iÚ
;

42 
	gquick_”rÜ
! {

43 #[
d”ive
(
Debug
)]

44 
pub
 
	eE¼Ü
 {

45 
Reque¡Faed
(
e
: 
”rÜpb
::
E¼Ü
) {

46 
äom
()

47 
desütiÚ
(
e
.
g‘_mes§ge
())

49 
Io
(
e
: 
IoE¼Ü
) {

50 
äom
()

51 
ÿu£
(
e
)

52 
desütiÚ
(
e
.description())

54 
RocksDb
(
»asÚ
: 
SŒšg
) {

55 
desütiÚ
(
»asÚ
)

57 
S”v”
(
e
: 
RaáS”v”E¼Ü
) {

58 
äom
()

59 
ÿu£
(
e
)

60 
desütiÚ
(
e
.description())

62 
Inv®idRe¥Ú£
(
»asÚ
: 
SŒšg
) {

63 
desütiÚ
(
»asÚ
)

65 
Inv®idReque¡
(
»asÚ
: 
SŒšg
) {

66 
desütiÚ
(
»asÚ
)

68 
Timeout
(
d
: 
Du¿tiÚ
) {

69 
desütiÚ
("requestimeout")

70 
di¥Ïy
("timeouˆaá” {:?}", 
d
)

75 
â
 
g‘_g_äom_”rÜ
(
e
: &
E¼Ü
) -> &'static str {

76 
m©ch
 *
e
 {

77 
E¼Ü
::
Reque¡Faed
(
»f
 
h—d”
è=> 
¡Üage
::
g‘_g_äom_h—d”
(header),

78 
	gE¼Ü
::
Io
(
_
) => "io",

79 
	gE¼Ü
::
RocksDb
(
_
) => "rocksdb",

80 
	gE¼Ü
::
S”v”
(
_
) => "server",

81 
	gE¼Ü
::
Inv®idRe¥Ú£
(
_
) => "invalid_resp",

82 
	gE¼Ü
::
Inv®idReque¡
(
_
) => "invalid_req",

83 
	gE¼Ü
::
Timeout
(
_
) => "timeout",

87 
â
 
g‘_g_äom_’gše_”rÜ
(
e
: &
’gše
::
E¼Ü
) -> &'static str {

88 
m©ch
 *
e
 {

89 
’gše
::
E¼Ü
::
Reque¡
(
»f
 
h—d”
è=> 
¡Üage
::
g‘_g_äom_h—d”
(header),

90 
	g’gše
::
E¼Ü
::
RocksDb
(
_
) => "rocksdb",

91 
	g’gše
::
E¼Ü
::
Timeout
(
_
) => "timeout",

92 
	g’gše
::
E¼Ü
::
Oth”
(
_
) => "other",

96 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

98 
im¶
 
	gFrom
<
	gE¼Ü
> 
	g’gše
::
E¼Ü
 {

99 
â
 
äom
(
e
: 
E¼Ü
è-> 
’gše
::Error {

100 
m©ch
 
e
 {

101 
E¼Ü
::
Reque¡Faed
(
e
è=> 
’gše
::E¼Ü::
Reque¡
(e),

102 
	gE¼Ü
::
S”v”
(
e
è=>ƒ.
što
(),

103 
	ge
 => 
box_”r
!(
e
),

108 
im¶
 
	gFrom
<
	gRaáS”v”E¼Ü
> 
	g’gše
::
E¼Ü
 {

109 
â
 
äom
(
e
: 
RaáS”v”E¼Ü
è-> 
’gše
::
E¼Ü
 {

110 
’gše
::
E¼Ü
::
Reque¡
(
e
.
što
())

115 #[
d”ive
(
ClÚe
)]

116 
pub
 
RaáKv
<
S
: 
RaáStÜeRou‹r
 + 'static> {

117 
db
: 
Arc
<
DB
>,

118 
	grou‹r
: 
S
,

121 
	eCmdRes
 {

122 
Re¥
(
Vec
<
Re¥Ú£
>),

123 
SÇp
(
RegiÚSÇpshÙ
),

126 
â
 
Ãw_ùx
(
»¥
: &
RaáCmdRe¥Ú£
è-> 
CbCÚ‹xt
 {

127 
Ët
 
mut
 
cb_ùx
 = 
CbCÚ‹xt
::
Ãw
();

128 
	gcb_ùx
.
	g‹rm
 = 
Some
(
»¥
.
g‘_h—d”
().
g‘_cu¼’t_‹rm
());

129 
	gcb_ùx


132 
â
 
check_¿á_cmd_»¥Ú£
(
»¥
: &
mut
 
RaáCmdRe¥Ú£
, 
»¥_út
: 
usize
è-> 
ResuÉ
<()> {

133 
»¥
.
g‘_h—d”
().
has_”rÜ
() {

134  
E¼
(
E¼Ü
::
Reque¡Faed
(
»¥
.
ke_h—d”
().
ke_”rÜ
()));

136 
	g»¥_út
 !ğ
»¥
.
g‘_»¥Ú£s
().
Ën
() {

137  
E¼
(
E¼Ü
::
Inv®idRe¥Ú£
(

140 .
to_owÃd
(),

144 
Ok
(())

147 
â
 
Ú_»suÉ
(

148 
mut
 
»¥
: 
RaáCmdRe¥Ú£
,

149 
»¥_út
: 
usize
,

150 
db
: 
Arc
<
DB
>,

151 è-> (
	gCbCÚ‹xt
, 
	gResuÉ
<
	gCmdRes
>) {

152 
Ët
 
	gcb_ùx
 = 
Ãw_ùx
(&
»¥
);

153 
Ët
 
E¼
(
e
èğ
check_¿á_cmd_»¥Ú£
(&
mut
 
»¥
, 
»¥_út
) {

154  (
	gcb_ùx
, 
E¼
(
e
));

156 
Ët
 
mut
 
	g»¥s
 = 
»¥
.
ke_»¥Ú£s
();

157 
	g»¥s
.
Ën
(è!ğ1 || 
»¥s
[0].
g‘_cmd_ty³
(è!ğ
CmdTy³
::
SÇp
 {

158  (
cb_ùx
, 
Ok
(
CmdRes
::
Re¥
(
»¥s
.
što_vec
())));

160 
Ët
 
	g¢­
 = 
RegiÚSÇpshÙ
::
äom_¿w
(
db
, 
»¥s
[0].
ke_¢­
().
ke_»giÚ
());

161 (
	gcb_ùx
, 
Ok
(
CmdRes
::
SÇp
(
¢­
)))

164 
im¶
<
S
: 
RaáStÜeRou‹r
> 
RaáKv
<S> {

166 
pub
 
â
 
Ãw
(
db
: 
Arc
<
DB
>, 
rou‹r
: 
S
è-> 
RaáKv
<S> {

167 
RaáKv
 {

168 
db
: db,

169 
	grou‹r
: 
rou‹r
,

173 
â
 
ÿÎ_commªd
(&
£lf
, 
»q
: 
RaáCmdReque¡
, 
cb
: 
C®lback
<
CmdRes
>è-> 
ResuÉ
<()> {

174 
Ët
 
l
 = 
»q
.
g‘_»que¡s
().
Ën
();

175 
Ët
 
	gdb
 = 
£lf
.
db
.
şÚe
();

176 
	g£lf
.
	grou‹r
.
£nd_commªd
(
»q
, 
box
 
move
 |
»¥
| {

177 
Ët
 (
cb_ùx
, 
»s
èğ
Ú_»suÉ
(
»¥
, 
l
, 
db
);

178 
cb
((
cb_ùx
, 
»s
.
m­_”r
(
E¼Ü
::
što
)));

180 
Ok
(())

183 
â
 
b©ch_ÿÎ_¢­_commªds
(

184 &
£lf
,

185 
b©ch
: 
Vec
<
RaáCmdReque¡
>,

186 
Ú_fšished
: 
B©chC®lback
<
CmdRes
>,

187 è-> 
	gResuÉ
<()> {

188 
Ët
 
	gb©ch_size
 = 
b©ch
.
Ën
();

189 
Ët
 
mut
 
	gls
 = 
Vec
::
w™h_ÿ·c™y
(
b©ch_size
);

190 
»q
 
	gš
 &
	gb©ch
 {

191 
Ët
 
	gl
 = 
»q
.
g‘_»que¡s
().
Ën
();

192 
	gls
.
push
(
l
);

194 
Ët
 
	gdb
 = 
£lf
.
db
.
şÚe
();

195 
Ët
 
	gÚ_fšished
: 
¡Üe
::
B©chC®lback
 = 
box
 
move
 |
»¥s
: 
Vec
<
O±iÚ
<
RaáCmdRe¥Ú£
>>| {

196 
as£¹_eq
!(
b©ch_size
, 
»¥s
.
Ën
());

197 
Ët
 
mut
 
	g¢­
 = 
NÚe
;

198 
Ët
 
mut
 
	gcmd_»¥s
 = 
Vec
::
w™h_ÿ·c™y
(
»¥s
.
Ën
());

199 
	gl
, 
	g»¥
è
š
 
	gls
.
što_™”
().
z
(
»¥s
) {

200 
m©ch
 
	g»¥
 {

201 
Some
(
mut
 
»¥
) => {

202 
Ët
 
cb_ùx
 = 
Ãw_ùx
(&
»¥
);

203 
Ët
 
E¼
(
e
èğ
check_¿á_cmd_»¥Ú£
(&
mut
 
»¥
, 
l
) {

204 
	gcmd_»¥s
.
push
(
Some
((
cb_ùx
, 
E¼
(
E¼Ü
::
što
(
e
)))));

208 
Ët
 
mut
 
	grs
 = 
»¥
.
ke_»¥Ú£s
();

209 
	gas£¹_eq
!(
	grs
[0].
g‘_cmd_ty³
(), 
	gCmdTy³
::
SÇp
);

210 
	g¢­
.
is_nÚe
() {

211 
	g¢­
 = 
Some
(
EngšeSÇpshÙ
::
Ãw
(
db
.
şÚe
()).
što_sync
());

214 
Ët
 
	g»s
 = 
RegiÚSÇpshÙ
::
äom_¢­shÙ
(

215 
¢­
.
şÚe
().
unw¿p
(),

216 
rs
[0].
ke_¢­
().
ke_»giÚ
(),

218 
	gcmd_»¥s
.
push
(
Some
((
cb_ùx
, 
Ok
(
CmdRes
::
SÇp
(
»s
)))));

220 
	gNÚe
 => 
cmd_»¥s
.
push
(
NÚe
),

223 
Ú_fšished
(
cmd_»¥s
);

226 
	g£lf
.
	grou‹r
.
£nd_b©ch_commªds
(
b©ch
, 
Ú_fšished
)?;

227 
Ok
(())

230 
â
 
Ãw_»que¡_h—d”
(&
£lf
, 
ùx
: &
CÚ‹xt
è-> 
RaáReque¡H—d”
 {

231 
Ët
 
mut
 
h—d”
 = 
RaáReque¡H—d”
::
Ãw
();

232 
	gh—d”
.
£t_»giÚ_id
(
ùx
.
g‘_»giÚ_id
());

233 
	gh—d”
.
£t_³”
(
ùx
.
g‘_³”
().
şÚe
());

234 
	gh—d”
.
£t_»giÚ_•och
(
ùx
.
g‘_»giÚ_•och
().
şÚe
());

235 
	gùx
.
g‘_‹rm
() != 0 {

236 
h—d”
.
£t_‹rm
(
ùx
.
g‘_‹rm
());

238 
	gh—d”
.
£t_sync_log
(
ùx
.
g‘_sync_log
());

239 
	gh—d”


242 
â
 
exec_»que¡s
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
»qs
: 
Vec
<
Reque¡
>, 
cb
: 
C®lback
<
CmdRes
>è-> 
ResuÉ
<()> {

243 
Ët
 
h—d”
 = 
£lf
.
Ãw_»que¡_h—d”
(
ùx
);

244 
Ët
 
mut
 
	gcmd
 = 
RaáCmdReque¡
::
Ãw
();

245 
	gcmd
.
£t_h—d”
(
h—d”
);

246 
	gcmd
.
£t_»que¡s
(
R•—‹dF›ld
::
äom_vec
(
»qs
));

247 
	g£lf
.
ÿÎ_commªd
(
cmd
, 
cb
)

250 
â
 
b©ch_exec_¢­_»que¡s
(

251 &
£lf
,

252 
b©ch
: 
Vec
<(
CÚ‹xt
, Vec<
Reque¡
>)>,

253 
Ú_fšished
: 
B©chC®lback
<
CmdRes
>,

254 è-> 
	gResuÉ
<()> {

255 
Ët
 
	gb©ch
 = 
b©ch
.
što_™”
().
m­
(|(
ùx
, 
»qs
)| {

256 
Ët
 
h—d”
 = 
£lf
.
Ãw_»que¡_h—d”
(&
ùx
);

257 
Ët
 
mut
 
cmd
 = 
RaáCmdReque¡
::
Ãw
();

258 
cmd
.
£t_h—d”
(
h—d”
);

259 
cmd
.
£t_»que¡s
(
R•—‹dF›ld
::
äom_vec
(
»qs
));

261 
cmd


264 
	g£lf
.
b©ch_ÿÎ_¢­_commªds
(
b©ch
.
cŞËù
(), 
Ú_fšished
)

268 
â
 
šv®id_»¥_ty³
(
exp
: 
CmdTy³
, 
aù
: CmdTy³è-> 
E¼Ü
 {

269 
E¼Ü
::
Inv®idRe¥Ú£
(
fÜm©
!(

271 
exp
,

272 
aù


276 
	gim¶
<
	gS
: 
RaáStÜeRou‹r
> 
Debug
 
RaáKv
<
S
> {

277 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

278 
wr™e
!(
f
, "RaftKv")

282 
	gim¶
<
	gS
: 
RaáStÜeRou‹r
> 
Engše
 
RaáKv
<
S
> {

283 
â
 
async_wr™e
(

284 &
£lf
,

285 
ùx
: &
CÚ‹xt
,

286 
mut
 
modif›s
: 
Vec
<
Modify
>,

287 
cb
: 
C®lback
<()>,

288 è-> 
	g’gše
::
ResuÉ
<()> {

289 
Ët
 
mut
 
»qs
 = 
Vec
::
w™h_ÿ·c™y
(
modif›s
.
Ën
());

290 !
	gmodif›s
.
is_em±y
() {

291 
Ët
 
	gm
 = 
modif›s
.
pİ
().
unw¿p
();

292 
Ët
 
mut
 
	g»q
 = 
Reque¡
::
Ãw
();

293 
m©ch
 
	gm
 {

294 
	gModify
::
D–‘e
(
cf
, 
k
) => {

295 
Ët
 
mut
 
d–‘e
 = 
D–‘eReque¡
::
Ãw
();

296 
	gd–‘e
.
£t_key
(
k
.
’coded
().
to_owÃd
());

297 
	gcf
 !ğ
CF_DEFAULT
 {

298 
d–‘e
.
£t_cf
(
cf
.
to_¡ršg
());

300 
	g»q
.
£t_cmd_ty³
(
CmdTy³
::
D–‘e
);

301 
	g»q
.
£t_d–‘e
(
d–‘e
);

303 
	gModify
::
Put
(
cf
, 
k
, 
v
) => {

304 
Ët
 
mut
 
put
 = 
PutReque¡
::
Ãw
();

305 
	gput
.
£t_key
(
k
.
’coded
().
to_owÃd
());

306 
	gput
.
£t_v®ue
(
v
);

307 
	gcf
 !ğ
CF_DEFAULT
 {

308 
put
.
£t_cf
(
cf
.
to_¡ršg
());

310 
	g»q
.
£t_cmd_ty³
(
CmdTy³
::
Put
);

311 
	g»q
.
£t_put
(
put
);

313 
	gModify
::
D–‘eRªge
(
cf
, 
¡¬t_key
, 
’d_key
) => {

314 
Ët
 
mut
 
d–‘e_¿nge
 = 
D–‘eRªgeReque¡
::
Ãw
();

315 
	gd–‘e_¿nge
.
£t_cf
(
cf
.
to_¡ršg
());

316 
	gd–‘e_¿nge
.
£t_¡¬t_key
(
¡¬t_key
.
’coded
().
to_owÃd
());

317 
	gd–‘e_¿nge
.
£t_’d_key
(
’d_key
.
’coded
().
to_owÃd
());

318 
	g»q
.
£t_cmd_ty³
(
CmdTy³
::
D–‘eRªge
);

319 
	g»q
.
£t_d–‘e_¿nge
(
d–‘e_¿nge
);

322 
	g»qs
.
push
(
»q
);

325 
	gASYNC_REQUESTS_COUNTER_VEC


326 .
w™h_Ïb–_v®ues
(&["write", "all"])

327 .
šc
();

328 
Ët
 
	g»q_tim”
 = 
ASYNC_REQUESTS_DURATIONS_VEC


329 .
w™h_Ïb–_v®ues
(&["write"])

330 .
¡¬t_cßr£_tim”
();

332 
	g£lf
.
exec_»que¡s
(
ùx
, 
»qs
, 
box
 
move
 |(
cb_ùx
, 
»s
)| 
m©ch
„es {

333 
Ok
(
CmdRes
::
Re¥
(
_
)) => {

334 
»q_tim”
.
ob£rve_du¿tiÚ
();

335 
ASYNC_REQUESTS_COUNTER_VEC


336 .
w™h_Ïb–_v®ues
(&["write", "success"])

337 .
šc
();

339 
cb
((
cb_ùx
, 
Ok
(())))

341 
Ok
(
CmdRes
::
SÇp
(
_
)è=> 
cb
((

342 
cb_ùx
,

343 
E¼
(
box_”r
!("unexpect snapshot, should mutate instead.")),

345 
E¼
(
e
) => {

346 
Ët
 
g
 = 
g‘_g_äom_’gše_”rÜ
(&
e
);

347 
ASYNC_REQUESTS_COUNTER_VEC


348 .
w™h_Ïb–_v®ues
(&["wr™e", 
g
])

349 .
šc
();

350 
cb
((
cb_ùx
, 
E¼
(
e
)))

352 }).
m­_”r
(|
e
| {

353 
Ët
 
g
 = 
g‘_g_äom_”rÜ
(&
e
);

354 
ASYNC_REQUESTS_COUNTER_VEC


355 .
w™h_Ïb–_v®ues
(&["wr™e", 
g
])

356 .
šc
();

357 
e
.
što
()

361 
â
 
async_¢­shÙ
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
cb
: 
C®lback
<
Box
<
SÇpshÙ
>>è-> 
’gše
::
ResuÉ
<()> {

362 
Ët
 
mut
 
»q
 = 
Reque¡
::
Ãw
();

363 
	g»q
.
£t_cmd_ty³
(
CmdTy³
::
SÇp
);

365 
	gASYNC_REQUESTS_COUNTER_VEC


366 .
w™h_Ïb–_v®ues
(&["snapshot", "all"])

367 .
šc
();

368 
Ët
 
	g»q_tim”
 = 
ASYNC_REQUESTS_DURATIONS_VEC


369 .
w™h_Ïb–_v®ues
(&["snapshot"])

370 .
¡¬t_cßr£_tim”
();

372 
	g£lf
.
exec_»que¡s
(
ùx
, 
vec
![
»q
], 
box
 
move
 |(
cb_ùx
, 
»s
)| 
m©ch
„es {

373 
Ok
(
CmdRes
::
Re¥
(
r
)è=> 
cb
((

374 
cb_ùx
,

375 
E¼
(
šv®id_»¥_ty³
(
CmdTy³
::
SÇp
, 
r
[0].
g‘_cmd_ty³
()).
što
()),

377 
Ok
(
CmdRes
::
SÇp
(
s
)) => {

378 
»q_tim”
.
ob£rve_du¿tiÚ
();

379 
ASYNC_REQUESTS_COUNTER_VEC


380 .
w™h_Ïb–_v®ues
(&["snapshot", "success"])

381 .
šc
();

382 
cb
((
cb_ùx
, 
Ok
(
box
 
s
)))

384 
E¼
(
e
) => {

385 
Ët
 
g
 = 
g‘_g_äom_’gše_”rÜ
(&
e
);

386 
ASYNC_REQUESTS_COUNTER_VEC


387 .
w™h_Ïb–_v®ues
(&["¢­shÙ", 
g
])

388 .
šc
();

389 
cb
((
cb_ùx
, 
E¼
(
e
)))

391 }).
m­_”r
(|
e
| {

392 
Ët
 
g
 = 
g‘_g_äom_”rÜ
(&
e
);

393 
ASYNC_REQUESTS_COUNTER_VEC


394 .
w™h_Ïb–_v®ues
(&["¢­shÙ", 
g
])

395 .
šc
();

396 
e
.
što
()

400 
â
 
async_b©ch_¢­shÙ
(

401 &
£lf
,

402 
b©ch
: 
Vec
<
CÚ‹xt
>,

403 
Ú_fšished
: 
B©chC®lback
<
Box
<
SÇpshÙ
>>,

404 è-> 
	g’gše
::
ResuÉ
<()> {

405 
Ët
 
b©ch_size
 = 
b©ch
.
Ën
();

406 
	gASYNC_REQUESTS_COUNTER_VEC


407 .
w™h_Ïb–_v®ues
(&["snapshot", "all"])

408 .
šc_by
(
b©ch_size
 
as
 
f64
)

409 .
unw¿p
();

410 
Ët
 
	g»q_tim”
 = 
ASYNC_REQUESTS_DURATIONS_VEC


411 .
w™h_Ïb–_v®ues
(&["snapshot"])

412 .
¡¬t_cßr£_tim”
();

414 
Ët
 
	gÚ_fšished
: 
B©chC®lback
<
CmdRes
> = 
box
 
move
 |
cmd_»¥s
: 
su³r
::
B©chResuÉs
<
_
>| {

415 
»q_tim”
.
ob£rve_du¿tiÚ
();

416 
	gas£¹_eq
!(
	gb©ch_size
, 
	gcmd_»¥s
.
Ën
());

417 
Ët
 
mut
 
	g¢­shÙs
 = 
Vec
::
w™h_ÿ·c™y
(
cmd_»¥s
.
Ën
());

418 
»¥
 
š
 
	gcmd_»¥s
 {

419 
m©ch
 
	g»¥
 {

420 
Some
((
cb_ùx
, 
Ok
(
CmdRes
::
Re¥
(
r
)))) => {

421 
¢­shÙs
.
push
(
Some
((

422 
cb_ùx
,

423 
E¼
(
šv®id_»¥_ty³
(
CmdTy³
::
SÇp
, 
r
[0].
g‘_cmd_ty³
()).
što
()),

426 
Some
((
cb_ùx
, 
Ok
(
CmdRes
::
SÇp
(
s
)))) => {

427 
ASYNC_REQUESTS_COUNTER_VEC


428 .
w™h_Ïb–_v®ues
(&["snapshot", "success"])

429 .
šc
();

430 
	g¢­shÙs
.
push
(
Some
((
cb_ùx
, 
Ok
(
box
 
s
 
as
 
Box
<
SÇpshÙ
>))));

432 
Some
((
cb_ùx
, 
E¼
(
e
))) => {

433 
Ët
 
g
 = 
g‘_g_äom_’gše_”rÜ
(&
e
);

434 
	gASYNC_REQUESTS_COUNTER_VEC


435 .
w™h_Ïb–_v®ues
(&["¢­shÙ", 
g
])

436 .
šc
();

437 
	g¢­shÙs
.
push
(
Some
((
cb_ùx
, 
E¼
(
e
))));

439 
	gNÚe
 => 
¢­shÙs
.
push
(
NÚe
),

442 
Ú_fšished
(
¢­shÙs
);

445 
Ët
 
	gb©ch
 = 
b©ch
.
što_™”
().
m­
(|
ùx
| {

446 
Ët
 
mut
 
»q
 = 
Reque¡
::
Ãw
();

447 
»q
.
£t_cmd_ty³
(
CmdTy³
::
SÇp
);

449 (
ùx
, 
vec
![
»q
])

452 
	g£lf
.
b©ch_exec_¢­_»que¡s
(
b©ch
.
cŞËù
(), 
Ú_fšished
)

453 .
m­_”r
(|
e
| {

454 
Ët
 
g
 = 
g‘_g_äom_”rÜ
(&
e
);

455 
ASYNC_REQUESTS_COUNTER_VEC


456 .
w™h_Ïb–_v®ues
(&["¢­shÙ", 
g
])

457 .
šc_by
(
b©ch_size
 
as
 
f64
)

458 .
unw¿p
();

459 
e
.
što
()

463 
â
 
şÚe
(&
£lf
è-> 
	gBox
<
	gEngše
> {

464 
box
 
	gRaáKv
::
Ãw
(
£lf
.
db
.
şÚe
(), s–f.
rou‹r
.clone())

468 
im¶
 
SÇpshÙ
 
	gRegiÚSÇpshÙ
 {

469 
â
 
g‘
(&
£lf
, 
key
: &
Key
è-> 
’gše
::
ResuÉ
<
O±iÚ
<
V®ue
>> {

470 
Ët
 
v
 = 
box_Œy
!(
£lf
.
g‘_v®ue
(
key
.
’coded
()));

471 
Ok
(
v
.
m­
(|v| v.
to_vec
()))

474 
â
 
g‘_cf
(&
£lf
, 
cf
: 
CfName
, 
key
: &
Key
è-> 
’gše
::
ResuÉ
<
O±iÚ
<
V®ue
>> {

475 
Ët
 
v
 = 
box_Œy
!(
£lf
.
g‘_v®ue_cf
(
cf
, 
key
.
’coded
()));

476 
Ok
(
v
.
m­
(|v| v.
to_vec
()))

479 
â
 
™”
(&
£lf
, 
™”_İt
: 
I‹rO±iÚ
, 
mode
: 
SÿnMode
è-> 
’gše
::
ResuÉ
<
CursÜ
> {

480 
Ok
(
CursÜ
::
Ãw
(

481 
Box
::
Ãw
(
RegiÚSÇpshÙ
::
™”
(
£lf
, 
™”_İt
)),

482 
mode
,

486 
â
 
™”_cf
(&
£lf
, 
cf
: 
CfName
, 
™”_İt
: 
I‹rO±iÚ
, 
mode
: 
SÿnMode
è-> 
’gše
::
ResuÉ
<
CursÜ
> {

487 
Ok
(
CursÜ
::
Ãw
(

488 
Box
::
Ãw
(
RegiÚSÇpshÙ
::
™”_cf
(
£lf
, 
cf
, 
™”_İt
)?),

489 
mode
,

493 
â
 
g‘_´İ”t›s_cf
(&
£lf
, 
cf
: 
CfName
è-> 
’gše
::
ResuÉ
<
TabËPrİ”t›sCŞËùiÚ
> {

494 
RegiÚSÇpshÙ
::
g‘_´İ”t›s_cf
(
£lf
, 
cf
).
m­_”r
(|
e
|ƒ.
što
())

497 
â
 
şÚe
(&
£lf
è-> 
	gBox
<
	gSÇpshÙ
> {

498 
	gBox
::
Ãw
(
RegiÚSÇpshÙ
::
şÚe
(
£lf
))

502 
im¶
 
EngšeI‹¿tÜ
 
RegiÚI‹¿tÜ
 {

503 
â
 
Ãxt
(&
mut
 
£lf
è-> 
boŞ
 {

504 
RegiÚI‹¿tÜ
::
Ãxt
(
£lf
)

507 
â
 
´ev
(&
mut
 
£lf
è-> 
boŞ
 {

508 
RegiÚI‹¿tÜ
::
´ev
(
£lf
)

511 
â
 
£ek
(&
mut
 
£lf
, 
key
: &
Key
è-> 
’gše
::
ResuÉ
<
boŞ
> {

512 
RegiÚI‹¿tÜ
::
£ek
(
£lf
, 
key
.
’coded
()).
m­_”r
(
From
::
äom
)

515 
â
 
£ek_fÜ_´ev
(&
mut
 
£lf
, 
key
: &
Key
è-> 
’gše
::
ResuÉ
<
boŞ
> {

516 
RegiÚI‹¿tÜ
::
£ek_fÜ_´ev
(
£lf
, 
key
.
’coded
()).
m­_”r
(
From
::
äom
)

519 
â
 
£ek_to_fœ¡
(&
mut
 
£lf
è-> 
boŞ
 {

520 
RegiÚI‹¿tÜ
::
£ek_to_fœ¡
(
£lf
)

523 
â
 
£ek_to_Ï¡
(&
mut
 
£lf
è-> 
boŞ
 {

524 
RegiÚI‹¿tÜ
::
£ek_to_Ï¡
(
£lf
)

527 
â
 
v®id
(&
£lf
è-> 
boŞ
 {

528 
RegiÚI‹¿tÜ
::
v®id
(
£lf
)

531 
â
 
key
(&
£lf
è-> &[
u8
] {

532 
RegiÚI‹¿tÜ
::
key
(
£lf
)

535 
â
 
v®ue
(&
£lf
è-> &[
u8
] {

536 
RegiÚI‹¿tÜ
::
v®ue
(
£lf
)

539 
â
 
v®id©e_key
(&
£lf
, 
key
: &
Key
è-> 
’gše
::
ResuÉ
<()> {

540 
£lf
.
should_£ekabË
(
key
.
’coded
()).
m­_”r
(
From
::
äom
)

	@src/storage/engine/rocksdb.rs

14 
u£
 
	g¡d
::
İs
::
D”ef
;

15 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDebug
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

16 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gMu‹x
};

17 
u£
 
	grocksdb
::{
DBI‹¿tÜ
, 
	gS“kKey
, 
	gWr™abË
, 
	gWr™eB©ch
, 
	gDB
};

18 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

19 
u£
 
	g¡Üage
::{
CfName
, 
	gKey
, 
	gV®ue
, 
	gCF_DEFAULT
};

20 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::{
I‹rO±iÚ
, 
	gP“kabË
, 
SyncSÇpshÙ
 
as
 
	gRocksSÇpshÙ
};

21 
u£
 
	gut
::
esÿ³
;

22 
u£
 
	gut
::
rocksdb
;

23 
u£
 
	gut
::
wÜk”
::{
RuÂabË
, 
	gScheduËr
, 
	gWÜk”
};

24 
u£
 
	gsu³r
::{
B©chC®lback
, 
	gC®lback
, 
	gCbCÚ‹xt
, 
	gCursÜ
, 
	gEngše
, 
	gE¼Ü
, 
I‹¿tÜ
 
as
 
	gEngšeI‹¿tÜ
,

25 
	gModify
, 
	gResuÉ
, 
	gSÿnMode
, 
	gSÇpshÙ
, 
	gTEMP_DIR
};

26 
u£
 
	g‹mpdœ
::
TempDœ
;

28 
	eTask
 {

29 
Wr™e
(
Vec
<
Modify
>, 
C®lback
<()>),

30 
SÇpshÙ
(
C®lback
<
Box
<Snapshot>>),

31 
SÇpshÙB©h
(
usize
, 
B©chC®lback
<
Box
<
SÇpshÙ
>>),

34 
im¶
 
Di¥Ïy
 
	gTask
 {

35 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

36 
m©ch
 *
£lf
 {

37 
Task
::
Wr™e
(..è=> 
wr™e
!(
f
, "writeask"),

38 
	gTask
::
SÇpshÙ
(
_
è=> 
wr™e
!(
f
, "snapshotask"),

39 
	gTask
::
SÇpshÙB©h
(..è=> 
wr™e
!(
f
, "snapshotask batch"),

44 
RuÂ”
(
Arc
<
DB
>);

46 
im¶
 
	gRuÂabË
<
	gTask
> 
	gRuÂ”
 {

47 
â
 
run
(&
mut
 
£lf
, 
t
: 
Task
) {

48 
m©ch
 
t
 {

49 
Task
::
Wr™e
(
modif›s
, 
cb
è=> cb((
CbCÚ‹xt
::
Ãw
(), 
wr™e_modif›s
(&
£lf
.0, modifies))),

50 
	gTask
::
SÇpshÙ
(
cb
) => cb((

51 
CbCÚ‹xt
::
Ãw
(),

52 
Ok
(
box
 
RocksSÇpshÙ
::
Ãw
(
£lf
.0.ş
Úe
())),

54 
	gTask
::
SÇpshÙB©h
(
size
, 
Ú_fšished
) => {

55 
Ët
 
mut
 
»suÉs
 = 
Vec
::
w™h_ÿ·c™y
(
size
);

56 
_
 
	gš
 0..
	gsize
 {

57 
Ët
 
	g»s
 = 
Some
((

58 
CbCÚ‹xt
::
Ãw
(),

59 
Ok
(
box
 
RocksSÇpshÙ
::
Ãw
(
£lf
.0.ş
Úe
()è
as
 
Box
<
SÇpshÙ
>),

61 
	g»suÉs
.
push
(
»s
);

63 
Ú_fšished
(
»suÉs
);

69 
	sEngšeRocksdbCÜe
 {

71 
	m‹mp_dœ
: 
O±iÚ
<
TempDœ
>,

72 
	mwÜk”
: 
WÜk”
<
Task
>,

75 
im¶
 
Drİ
 
	gEngšeRocksdbCÜe
 {

76 
â
 
drİ
(&
mut
 
£lf
) {

77 
Ët
 
Some
(
h
èğ
£lf
.
wÜk”
.
¡İ
() {

78 
h
.
još
().
unw¿p
();

83 
pub
 
	sEngšeRocksdb
 {

84 
	mcÜe
: 
Arc
<
Mu‹x
<
EngšeRocksdbCÜe
>>,

85 
	msched
: 
ScheduËr
<
Task
>,

88 
im¶
 
	gEngšeRocksdb
 {

89 
pub
 
â
 
Ãw
(
·th
: &
¡r
, 
cfs
: &[
CfName
]è-> 
ResuÉ
<
EngšeRocksdb
> {

90 
šfo
!("EngšeRocksdb: c»©šg fÜ…©h {}", 
	g·th
);

91 
Ët
 (
·th
, 
‹mp_dœ
èğ
m©ch
…ath {

92 
TEMP_DIR
 => {

93 
Ët
 
td
 = 
TempDœ
::
Ãw
("‹mp-rocksdb").
unw¿p
();

94 (
	gtd
.
·th
().
to_¡r
().
unw¿p
().
to_owÃd
(), 
Some
(
td
))

96 
	g_
 => (
·th
.
to_owÃd
(), 
	gNÚe
),

98 
Ët
 
mut
 
	gwÜk”
 = 
WÜk”
::
Ãw
("engine-rocksdb");

99 
Ët
 
	gdb
 = 
rocksdb
::
Ãw_’gše
(&
·th
, 
cfs
)?;

100 
	gbox_Œy
!(
	gwÜk”
.
¡¬t
(
RuÂ”
(
Arc
::
Ãw
(
db
))));

101 
Ok
(
EngšeRocksdb
 {

102 
sched
: 
wÜk”
.
scheduËr
(),

103 
cÜe
: 
Arc
::
Ãw
(
Mu‹x
::Ãw(
EngšeRocksdbCÜe
 {

104 
‹mp_dœ
:emp_dir,

105 
wÜk”
: worker,

110 
pub
 
â
 
¡İ
(&
£lf
) {

111 
Ët
 
mut
 
	gcÜe
 = 
£lf
.
cÜe
.
lock
().
unw¿p
();

112 
Ët
 
Some
(
h
èğ
cÜe
.
wÜk”
.
¡İ
() {

113 
h
.
još
().
unw¿p
();

118 
im¶
 
Debug
 
	gEngšeRocksdb
 {

119 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

120 
wr™e
!(

121 
f
,

123 
	g£lf
.
	gcÜe
.
lock
().
unw¿p
().
	g‹mp_dœ
.
is_some
()

128 
â
 
wr™e_modif›s
(
db
: &
DB
, 
modif›s
: 
Vec
<
Modify
>è-> 
ResuÉ
<()> {

129 
Ët
 
wb
 = 
Wr™eB©ch
::
Ãw
();

130 
»v
 
š
 
	gmodif›s
 {

131 
Ët
 
	g»s
 = 
m©ch
 
»v
 {

132 
Modify
::
D–‘e
(
cf
, 
k
è=> cà=ğ
CF_DEFAULT
 {

133 
Œaû
!("EngšeRocksdb: d–‘{}", 
k
);

134 
	gwb
.
d–‘e
(
k
.
’coded
())

136 
	gŒaû
!("EngšeRocksdb: d–‘e_cà{} {}", 
	gcf
, 
	gk
);

137 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(
db
, 
cf
)?;

138 
	gwb
.
d–‘e_cf
(
hªdË
, 
k
.
’coded
())

140 
	gModify
::
Put
(
cf
, 
k
, 
v
è=> cà=ğ
CF_DEFAULT
 {

141 
Œaû
!("EngšeRocksdb:…uˆ{},{}", 
k
, 
esÿ³
(&
v
));

142 
	gwb
.
put
(
k
.
’coded
(), &
v
)

144 
	gŒaû
!("EngšeRocksdb:…ut_cà{}, {}, {}", 
	gcf
, 
	gk
, 
esÿ³
(&
v
));

145 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(
db
, 
cf
)?;

146 
	gwb
.
put_cf
(
hªdË
, 
k
.
’coded
(), &
v
)

148 
	gModify
::
D–‘eRªge
(
cf
, 
¡¬t_key
, 
’d_key
) => {

149 
Œaû
!(

151 
cf
,

152 
esÿ³
(
¡¬t_key
.
’coded
()),

153 
esÿ³
(
’d_key
.
’coded
())

155 
Ët
 
	ghªdË
 = 
rocksdb
::
g‘_cf_hªdË
(
db
, 
cf
)?;

156 
	gwb
.
d–‘e_¿nge_cf
(
hªdË
, 
¡¬t_key
.
’coded
(), 
’d_key
.encoded())

159 
Ët
 
E¼
(
msg
èğ
»s
 {

160  
E¼
(
E¼Ü
::
RocksDb
(
msg
));

163 
Ët
 
E¼
(
msg
èğ
db
.
wr™e
(
wb
) {

164  
E¼
(
E¼Ü
::
RocksDb
(
msg
));

166 
Ok
(())

169 
im¶
 
Engše
 
	gEngšeRocksdb
 {

170 
â
 
async_wr™e
(&
£lf
, 
_
: &
CÚ‹xt
, 
modif›s
: 
Vec
<
Modify
>, 
cb
: 
C®lback
<()>è-> 
ResuÉ
<()> {

171 
box_Œy
!(
£lf
.
sched
.
scheduË
(
Task
::
Wr™e
(
modif›s
, 
cb
)));

172 
Ok
(())

175 
â
 
async_¢­shÙ
(&
£lf
, 
_
: &
CÚ‹xt
, 
cb
: 
C®lback
<
Box
<
SÇpshÙ
>>è-> 
ResuÉ
<()> {

176 
box_Œy
!(
£lf
.
sched
.
scheduË
(
Task
::
SÇpshÙ
(
cb
)));

177 
Ok
(())

180 
â
 
async_b©ch_¢­shÙ
(

181 &
£lf
,

182 
b©ch
: 
Vec
<
CÚ‹xt
>,

183 
Ú_fšished
: 
B©chC®lback
<
Box
<
SÇpshÙ
>>,

184 è-> 
	gResuÉ
<()> {

185 
	gbox_Œy
!(

186 
	g£lf
.
	gsched


187 .
scheduË
(
Task
::
SÇpshÙB©h
(
b©ch
.
Ën
(), 
Ú_fšished
))

189 
Ok
(())

192 
â
 
şÚe
(&
£lf
è-> 
	gBox
<
	gEngše
> {

193 
box
 
	gEngšeRocksdb
 {

194 
	gcÜe
: 
£lf
.
cÜe
.
şÚe
(),

195 
	gsched
: 
£lf
.
sched
.
şÚe
(),

200 
im¶
 
SÇpshÙ
 
	gRocksSÇpshÙ
 {

201 
â
 
g‘
(&
£lf
, 
key
: &
Key
è-> 
ResuÉ
<
O±iÚ
<
V®ue
>> {

202 
Œaû
!("RocksSÇpshÙ: g‘ {}", 
	gkey
);

203 
Ët
 
	gv
 = 
box_Œy
!(
£lf
.
g‘_v®ue
(
key
.
’coded
()));

204 
Ok
(
v
.
m­
(|v| v.
to_vec
()))

207 
â
 
g‘_cf
(&
£lf
, 
cf
: 
CfName
, 
key
: &
Key
è-> 
ResuÉ
<
O±iÚ
<
V®ue
>> {

208 
Œaû
!("RocksSÇpshÙ: g‘_cà{} {}", 
	gcf
, 
	gkey
);

209 
Ët
 
	gv
 = 
box_Œy
!(
£lf
.
g‘_v®ue_cf
(
cf
, 
key
.
’coded
()));

210 
Ok
(
v
.
m­
(|v| v.
to_vec
()))

213 
â
 
™”
(&
£lf
, 
™”_İt
: 
I‹rO±iÚ
, 
mode
: 
SÿnMode
è-> 
ResuÉ
<
CursÜ
> {

214 
Œaû
!("RocksSnapshot: create iterator");

215 
Ët
 
	g™”
 = 
£lf
.
db_™”©Ü
(
™”_İt
);

216 
Ok
(
CursÜ
::
Ãw
(
Box
::Ãw(
™”
), 
mode
))

219 #[
®low
(
ÃedËss_liãtimes
)]

220 
â
 
™”_cf
(&
£lf
, 
cf
: 
CfName
, 
™”_İt
: 
I‹rO±iÚ
, 
mode
: 
SÿnMode
è-> 
ResuÉ
<
CursÜ
> {

221 
Œaû
!("RocksSnapshot: create cf iterator");

222 
Ët
 
	g™”
 = 
£lf
.
db_™”©Ü_cf
(
cf
, 
™”_İt
)?;

223 
Ok
(
CursÜ
::
Ãw
(
Box
::Ãw(
™”
), 
mode
))

226 
â
 
şÚe
(&
£lf
è-> 
	gBox
<
	gSÇpshÙ
> {

227 
	gBox
::
Ãw
(
RocksSÇpshÙ
::
şÚe
(
£lf
))

231 
im¶
<
D
: 
D”ef
<
T¬g‘
 = 
DB
>> 
EngšeI‹¿tÜ
 
DBI‹¿tÜ
<D> {

232 
â
 
Ãxt
(&
mut
 
£lf
è-> 
boŞ
 {

233 
DBI‹¿tÜ
::
Ãxt
(
£lf
)

236 
â
 
´ev
(&
mut
 
£lf
è-> 
boŞ
 {

237 
DBI‹¿tÜ
::
´ev
(
£lf
)

240 
â
 
£ek
(&
mut
 
£lf
, 
key
: &
Key
è-> 
ResuÉ
<
boŞ
> {

241 
Ok
(
DBI‹¿tÜ
::
£ek
(
£lf
, 
key
.
’coded
().
as_¦iû
().
što
()))

244 
â
 
£ek_fÜ_´ev
(&
mut
 
£lf
, 
key
: &
Key
è-> 
ResuÉ
<
boŞ
> {

245 
Ok
(
DBI‹¿tÜ
::
£ek_fÜ_´ev
(

246 
£lf
,

247 
key
.
’coded
().
as_¦iû
().
što
(),

251 
â
 
£ek_to_fœ¡
(&
mut
 
£lf
è-> 
boŞ
 {

252 
DBI‹¿tÜ
::
£ek
(
£lf
, 
S“kKey
::
S¹
)

255 
â
 
£ek_to_Ï¡
(&
mut
 
£lf
è-> 
boŞ
 {

256 
DBI‹¿tÜ
::
£ek
(
£lf
, 
S“kKey
::
End
)

259 
â
 
v®id
(&
£lf
è-> 
boŞ
 {

260 
DBI‹¿tÜ
::
v®id
(
£lf
)

263 
â
 
key
(&
£lf
è-> &[
u8
] {

264 
DBI‹¿tÜ
::
key
(
£lf
)

267 
â
 
v®ue
(&
£lf
è-> &[
u8
] {

268 
DBI‹¿tÜ
::
v®ue
(
£lf
)

	@src/storage/metrics.rs

14 
u£
 
	g´om‘heus
::*;

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gKV_COMMAND_COUNTER_VEC
: 
CouÁ”Vec
 =

18 
»gi¡”_couÁ”_vec
!(

22 ).
unw¿p
();

24 
pub
 
»f
 
	gSCHED_STAGE_COUNTER_VEC
: 
CouÁ”Vec
 =

25 
»gi¡”_couÁ”_vec
!(

29 ).
unw¿p
();

31 
pub
 
»f
 
	gSCHED_WRITING_BYTES_GAUGE
: 
Gauge
 =

32 
»gi¡”_gauge
!(

35 ).
unw¿p
();

37 
pub
 
»f
 
	gSCHED_CONTEX_GAUGE
: 
Gauge
 =

38 
»gi¡”_gauge
!(

41 ).
unw¿p
();

43 
pub
 
»f
 
	gSCHED_WORKER_COUNTER_VEC
: 
CouÁ”Vec
 =

44 
»gi¡”_couÁ”_vec
!(

48 ).
unw¿p
();

50 
pub
 
»f
 
	gSCHED_HISTOGRAM_VEC
: 
Hi¡og¿mVec
 =

51 
»gi¡”_hi¡og¿m_vec
!(

55 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

56 ).
unw¿p
();

58 
pub
 
»f
 
	gSCHED_LATCH_HISTOGRAM_VEC
: 
Hi¡og¿mVec
 =

59 
»gi¡”_hi¡og¿m_vec
!(

63 
expÚ’tŸl_buck‘s
(0.0005, 2.0, 20).
unw¿p
()

64 ).
unw¿p
();

66 
pub
 
»f
 
	gSCHED_TOO_BUSY_COUNTER_VEC
: 
CouÁ”Vec
 =

67 
»gi¡”_couÁ”_vec
!(

71 ).
unw¿p
();

73 
pub
 
»f
 
	gSCHED_COMMANDS_PRI_COUNTER_VEC
: 
CouÁ”Vec
 =

74 
»gi¡”_couÁ”_vec
!(

78 ).
unw¿p
();

80 
pub
 
»f
 
	gKV_COMMAND_KEYREAD_HISTOGRAM_VEC
: 
Hi¡og¿mVec
 =

81 
»gi¡”_hi¡og¿m_vec
!(

85 
expÚ’tŸl_buck‘s
(1.0, 2.0, 21).
unw¿p
()

86 ).
unw¿p
();

88 
pub
 
»f
 
	gKV_COMMAND_SCAN_DETAILS
: 
CouÁ”Vec
 =

89 
»gi¡”_couÁ”_vec
!(

93 ).
unw¿p
();

95 
pub
 
»f
 
	gRAWKV_COMMAND_COUNTER_VEC
: 
CouÁ”Vec
 =

96 
»gi¡”_couÁ”_vec
!(

100 ).
unw¿p
();

102 
pub
 
»f
 
	gKV_COMMAND_GC_EMPTY_RANGE_COUNTER
: 
CouÁ”
 =

103 
»gi¡”_couÁ”
!(

106 ).
unw¿p
();

108 
pub
 
»f
 
	gKV_COMMAND_GC_SKIPPED_COUNTER
: 
CouÁ”
 =

109 
»gi¡”_couÁ”
!(

112 ).
unw¿p
();

114 
pub
 
»f
 
	gBATCH_COMMANDS
: 
Hi¡og¿mVec
 =

115 
»gi¡”_hi¡og¿m_vec
!(

119 
	gvec
![1.0, 2.0, 4.0, 6.0, 8.0, 10.0, 12.0, 14.0, 16.0, 18.0,

121 ).
unw¿p
();

123 
pub
 
»f
 
	gKV_COMMAND_KEYWRITE_HISTOGRAM_VEC
: 
Hi¡og¿mVec
 =

124 
»gi¡”_hi¡og¿m_vec
!(

128 
expÚ’tŸl_buck‘s
(1.0, 2.0, 21).
unw¿p
()

129 ).
unw¿p
();

	@src/storage/mod.rs

14 
u£
 
	g¡d
::
th»ad
;

15 
u£
 
	g¡d
::
boxed
::
FnBox
;

16 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDebug
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

17 
u£
 
	g¡d
::
sync
::
mpsc
::{
£lf
, 
	gReûiv”
};

18 
u£
 
	g¡d
::
”rÜ
;

19 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gMu‹x
};

20 
u£
 
	g¡d
::
io
::
E¼Ü
 
as
 
IoE¼Ü
;

21 
u£
 
	g¡d
::
u64
;

22 
u£
 
	gkv´Ùo
::
kv½ıb
::{
CommªdPri
, 
	gLockInfo
};

23 
u£
 
	gkv´Ùo
::
”rÜpb
;

24 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

25 
u£
 
	g£lf
::
m‘rics
::*;

27 
pub
 
mod
 
	g’gše
;

28 
pub
 
mod
 
	gmvcc
;

29 
pub
 
mod
 
	gtxn
;

30 
pub
 
mod
 
	gcÚfig
;

31 
pub
 
mod
 
	gty³s
;

32 
mod
 
	gm‘rics
;

34 
pub
 
u£
 
	g£lf
::
cÚfig
::{
CÚfig
, 
	gDEFAULT_DATA_DIR
, 
	gDEFAULT_ROCKSDB_SUB_DIR
};

35 
pub
 
u£
 
	g£lf
::
’gše
::{
Ãw_loÿl_’gše
, 
	gCFSti¡ics
, 
	gCursÜ
, 
	gEngše
, 
E¼Ü
 
as
 
	gEngšeE¼Ü
,

36 
	gFlowSti¡ics
, 
	gI‹¿tÜ
, 
	gModify
, 
	gSÿnMode
, 
	gSÇpshÙ
, 
	gSti¡ics
,

37 
	gSti¡icsSumm¬y
, 
	gTEMP_DIR
};

38 
pub
 
u£
 
	g£lf
::
’gše
::
¿ákv
::
RaáKv
;

39 
u£
 
	g£lf
::
mvcc
::
Lock
;

40 
pub
 
u£
 
	g£lf
::
txn
::{
Msg
, 
	gScheduËr
, 
	gSÇpshÙStÜe
, 
	gStÜeSÿÂ”
};

41 
pub
 
u£
 
	g£lf
::
ty³s
::{
make_key
, 
	gKey
, 
	gKvPaœ
, 
	gMvccInfo
, 
	gV®ue
};

42 
pub
 
ty³
 
	gC®lback
<
	gT
> = 
Box
<
FnBox
(
ResuÉ
<
T
>è+ 
S’d
>;

44 
pub
 
ty³
 
	gCfName
 = &'static str;

45 
pub
 cÚ¡ 
CF_DEFAULT
: 
CfName
 = "default";

46 
pub
 cÚ¡ 
	gCF_LOCK
: 
CfName
 = "lock";

47 
pub
 cÚ¡ 
	gCF_WRITE
: 
CfName
 = "write";

48 
pub
 cÚ¡ 
	gCF_RAFT
: 
CfName
 = "raft";

50 
pub
 cÚ¡ 
	gLARGE_CFS
: &'static [CfName] = &[CF_DEFAULT, CF_WRITE];

51 
pub
 cÚ¡ 
ALL_CFS
: &'static [CfName] = &[CF_DEFAULT, CF_LOCK, CF_WRITE, CF_RAFT];

52 
pub
 cÚ¡ 
DATA_CFS
: &'static [CfName] = &[CF_DEFAULT, CF_LOCK, CF_WRITE];

55 
pub
 cÚ¡ 
SHORT_VALUE_MAX_LEN
: 
usize
 = 64;

56 
pub
 cÚ¡ 
	gSHORT_VALUE_PREFIX
: 
u8
 = 
b
'v';

58 
pub
 
â
 
is_shÜt_v®ue
(
v®ue
: &[
u8
]è-> 
boŞ
 {

59 
v®ue
.
Ën
(è<ğ
SHORT_VALUE_MAX_LEN


62 #[
d”ive
(
Debug
, 
ClÚe
)]

63 
pub
 
	eMutiÚ
 {

64 
Put
((
Key
, 
V®ue
)),

65 
D–‘e
(
Key
),

66 
Lock
(
Key
),

69 #[
®low
(
m©ch_§me_¬ms
)]

70 
im¶
 
	gMutiÚ
 {

71 
pub
 
â
 
key
(&
£lf
è-> &
	gKey
 {

72 
m©ch
 *
	g£lf
 {

73 
	gMutiÚ
::
Put
((
»f
 
key
, 
_
)) => key,

74 
	gMutiÚ
::
D–‘e
(
»f
 
key
) => key,

75 
	gMutiÚ
::
Lock
(
»f
 
key
) => key,

80 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

82 
pub
 
	eStÜageCb
 {

83 
BoŞ—n
(
C®lback
<()>),

84 
BoŞ—ns
(
C®lback
<
Vec
<
ResuÉ
<()>>>),

85 
SšgËV®ue
(
C®lback
<
O±iÚ
<
V®ue
>>),

86 
KvPaœs
(
C®lback
<
Vec
<
ResuÉ
<
KvPaœ
>>>),

87 
MvccInfoByKey
(
C®lback
<
MvccInfo
>),

88 
MvccInfoByS¹Ts
(
C®lback
<
O±iÚ
<(
Key
, 
MvccInfo
)>>),

89 
Locks
(
C®lback
<
Vec
<
LockInfo
>>),

92 
pub
 
	eCommªd
 {

93 
	mG‘
 {

94 
	mùx
: 
CÚ‹xt
,

95 
	mkey
: 
Key
,

96 
	m¡¬t_ts
: 
u64
,

98 
	mB©chG‘
 {

99 
	mùx
: 
CÚ‹xt
,

100 
	mkeys
: 
Vec
<
Key
>,

101 
	m¡¬t_ts
: 
u64
,

103 
	mSÿn
 {

104 
	mùx
: 
CÚ‹xt
,

105 
	m¡¬t_key
: 
Key
,

106 
	mlim™
: 
usize
,

107 
	m¡¬t_ts
: 
u64
,

108 
	mİtiÚs
: 
O±iÚs
,

110 
	mP»wr™e
 {

111 
	mùx
: 
CÚ‹xt
,

112 
	mmutiÚs
: 
Vec
<
MutiÚ
>,

113 
	m´im¬y
: 
Vec
<
u8
>,

114 
	m¡¬t_ts
: 
u64
,

115 
	mİtiÚs
: 
O±iÚs
,

117 
	mComm™
 {

118 
	mùx
: 
CÚ‹xt
,

119 
	mkeys
: 
Vec
<
Key
>,

120 
	mlock_ts
: 
u64
,

121 
	mcomm™_ts
: 
u64
,

123 
	mCËªup
 {

124 
	mùx
: 
CÚ‹xt
,

125 
	mkey
: 
Key
,

126 
	m¡¬t_ts
: 
u64
,

128 
	mRŞlback
 {

129 
	mùx
: 
CÚ‹xt
,

130 
	mkeys
: 
Vec
<
Key
>,

131 
	m¡¬t_ts
: 
u64
,

133 
	mSÿnLock
 { 
	mùx
: 
CÚ‹xt
, 
	mmax_ts
: 
u64
 },

134 
	mResŞveLock
 {

135 
	mùx
: 
CÚ‹xt
,

136 
	mtxn_¡©us
: 
HashM­
<
u64
, 
	mu64
>,

137 
	msÿn_key
: 
O±iÚ
<
Key
>,

138 
	mkey_locks
: 
Vec
<(
Key
, 
	mLock
)>,

140 
	mGc
 {

141 
	mùx
: 
CÚ‹xt
,

142 
	m§ã_pošt
: 
u64
,

143 
	m¿tio_th»shŞd
: 
f64
,

144 
	msÿn_key
: 
O±iÚ
<
Key
>,

145 
	mkeys
: 
Vec
<
Key
>,

147 
	mRawG‘
 { 
	mùx
: 
CÚ‹xt
, 
	mkey
: 
Key
 },

148 
	mRawSÿn
 {

149 
	mùx
: 
CÚ‹xt
,

150 
	m¡¬t_key
: 
Key
,

151 
	mlim™
: 
usize
,

153 
	mD–‘eRªge
 {

154 
	mùx
: 
CÚ‹xt
,

155 
	m¡¬t_key
: 
Key
,

156 
	m’d_key
: 
Key
,

158 
	mPau£
 { 
	mùx
: 
CÚ‹xt
, 
	mdu¿tiÚ
: 
u64
 },

159 
	mMvccByKey
 { 
	mùx
: 
CÚ‹xt
, 
	mkey
: 
Key
 },

160 
	mMvccByS¹Ts
 { 
	mùx
: 
CÚ‹xt
, 
	m¡¬t_ts
: 
u64
 },

163 
im¶
 
Di¥Ïy
 
	gCommªd
 {

164 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

165 
m©ch
 *
£lf
 {

166 
Commªd
::
G‘
 {

167 
»f
 
ùx
,

168 
»f
 
	gkey
,

169 
	g¡¬t_ts
,

171 } => 
wr™e
!(
f
, "kv::commªd::g‘ {} @ {} | {:?}", 
	gkey
, 
	g¡¬t_ts
, 
	gùx
),

172 
	gCommªd
::
B©chG‘
 {

173 
»f
 
ùx
,

174 
»f
 
	gkeys
,

175 
	g¡¬t_ts
,

177 } => 
wr™e
!(

178 
f
,

180 
	gkeys
.
Ën
(),

181 
	g¡¬t_ts
,

182 
	gùx


184 
	gCommªd
::
Sÿn
 {

185 
»f
 
ùx
,

186 
»f
 
	g¡¬t_key
,

187 
	glim™
,

188 
	g¡¬t_ts
,

190 } => 
wr™e
!(

191 
f
,

193 
	g¡¬t_key
,

194 
	glim™
,

195 
	g¡¬t_ts
,

196 
	gùx


198 
	gCommªd
::
P»wr™e
 {

199 
»f
 
ùx
,

200 
»f
 
	gmutiÚs
,

201 
	g¡¬t_ts
,

203 } => 
wr™e
!(

204 
f
,

206 
	gmutiÚs
.
Ën
(),

207 
	g¡¬t_ts
,

208 
	gùx


210 
	gCommªd
::
Comm™
 {

211 
»f
 
ùx
,

212 
»f
 
	gkeys
,

213 
	glock_ts
,

214 
	gcomm™_ts
,

216 } => 
wr™e
!(

217 
f
,

219 
	gkeys
.
Ën
(),

220 
	glock_ts
,

221 
	gcomm™_ts
,

222 
	gùx


224 
	gCommªd
::
CËªup
 {

225 
»f
 
ùx
,

226 
»f
 
	gkey
,

227 
	g¡¬t_ts
,

229 } => 
wr™e
!(
f
, "kv::commªd::ş—nu°{} @ {} | {:?}", 
	gkey
, 
	g¡¬t_ts
, 
	gùx
),

230 
	gCommªd
::
RŞlback
 {

231 
»f
 
ùx
,

232 
»f
 
	gkeys
,

233 
	g¡¬t_ts
,

235 } => 
wr™e
!(

236 
f
,

238 
	gkeys
.
Ën
(),

239 
	g¡¬t_ts
,

240 
	gùx


242 
	gCommªd
::
SÿnLock
 {

243 
»f
 
ùx
, 
	gmax_ts
, ..

244 } => 
wr™e
!(
f
, "kv::sÿn_lock {} | {:?}", 
	gmax_ts
, 
	gùx
),

245 
	gCommªd
::
ResŞveLock
 { .. } => 
wr™e
!(
f
, "kv::resolve_lock"),

246 
	gCommªd
::
Gc
 {

247 
»f
 
ùx
,

248 
	g§ã_pošt
,

249 
»f
 
	gsÿn_key
,

251 } => 
wr™e
!(

252 
f
,

254 
	gsÿn_key
,

255 
	g§ã_pošt
,

256 
	gùx


258 
	gCommªd
::
RawG‘
 { 
»f
 
ùx
,„eà
	gkey
 } => {

259 
wr™e
!(
f
, "kv::commªd::¿wg‘ {:?} | {:?}", 
key
, 
ùx
)

261 
Commªd
::
RawSÿn
 {

262 
»f
 
ùx
,

263 
»f
 
¡¬t_key
,

264 
lim™
,

265 } => 
wr™e
!(

266 
f
,

268 
	g¡¬t_key
,

269 
	glim™
,

270 
	gùx


272 
	gCommªd
::
D–‘eRªge
 {

273 
»f
 
ùx
,

274 
»f
 
	g¡¬t_key
,

275 
»f
 
	g’d_key
,

276 } => 
wr™e
!(

277 
f
,

279 
	g¡¬t_key
,

280 
	g’d_key
,

281 
	gùx


283 
	gCommªd
::
Pau£
 { 
»f
 
ùx
, 
	gdu¿tiÚ
 } => {

284 
wr™e
!(
f
, "kv::commªd::·u£ {} m | {:?}", 
du¿tiÚ
, 
ùx
)

286 
Commªd
::
MvccByKey
 { 
»f
 
ùx
,„eà
key
 } => {

287 
wr™e
!(
f
, "kv::commªd::mvccbykey {:?} | {:?}", 
key
, 
ùx
)

289 
Commªd
::
MvccByS¹Ts
 {

290 
»f
 
ùx
,

291 
»f
 
¡¬t_ts
,

292 } => 
wr™e
!(
f
, "kv::commªd::mvccby¡¬‰ {:?} | {:?}", 
	g¡¬t_ts
, 
	gùx
),

297 
im¶
 
Debug
 
	gCommªd
 {

298 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

299 
wr™e
!(
f
, "{}", 
	g£lf
)

303 
pub
 cÚ¡ 
	gCMD_TAG_GC
: &'static str = "gc";

305 
im¶
 
Commªd
 {

306 
pub
 
â
 
»adÚly
(&
£lf
è-> 
boŞ
 {

307 
m©ch
 *
£lf
 {

308 
Commªd
::
G‘
 { .. } |

309 
Commªd
::
B©chG‘
 { .. } |

310 
Commªd
::
Sÿn
 { .. } |

311 
Commªd
::
SÿnLock
 { .. } |

312 
Commªd
::
RawG‘
 { .. } |

313 
Commªd
::
RawSÿn
 { .. } |

317 
Commªd
::
D–‘eRªge
 { .. } |

318 
Commªd
::
Pau£
 { .. } |

319 
Commªd
::
MvccByKey
 { .. } |

320 
Commªd
::
MvccByS¹Ts
 { .. } => 
Œue
,

321 
	gCommªd
::
ResŞveLock
 { 
»f
 
key_locks
, .. } => key_locks.
is_em±y
(),

322 
	gCommªd
::
Gc
 { 
»f
 
keys
, .. } => keys.
is_em±y
(),

323 
	g_
 => 
çl£
,

327 
pub
 
â
 
´iÜ™y
(&
£lf
è-> 
	gCommªdPri
 {

328 
	g£lf
.
g‘_cÚ‹xt
().
g‘_´iÜ™y
()

331 
pub
 
â
 
´iÜ™y_g
(&
£lf
) -> &'static str {

332 
m©ch
 
	g£lf
.
g‘_cÚ‹xt
().
g‘_´iÜ™y
() {

333 
	gCommªdPri
::
Low
 => "low",

334 
	gCommªdPri
::
NÜm®
 => "normal",

335 
	gCommªdPri
::
High
 => "high",

339 
pub
 
â
 
Ãed_æow_cÚŒŞ
(&
£lf
è-> 
	gboŞ
 {

340 !
	g£lf
.
»adÚly
(è&& s–f.
´iÜ™y
(è!ğ
CommªdPri
::
High


343 
pub
 
â
 
g
(&
£lf
) -> &'static str {

344 
m©ch
 *
£lf
 {

345 
Commªd
::
G‘
 { .. } => "get",

346 
	gCommªd
::
B©chG‘
 { .. } => "batch_get",

347 
	gCommªd
::
Sÿn
 { .. } => "scan",

348 
	gCommªd
::
P»wr™e
 { .. } => "prewrite",

349 
	gCommªd
::
Comm™
 { .. } => "commit",

350 
	gCommªd
::
CËªup
 { .. } => "cleanup",

351 
	gCommªd
::
RŞlback
 { .. } => "rollback",

352 
	gCommªd
::
SÿnLock
 { .. } => "scan_lock",

353 
	gCommªd
::
ResŞveLock
 { .. } => "resolve_lock",

354 
	gCommªd
::
Gc
 { .. } => 
CMD_TAG_GC
,

355 
	gCommªd
::
RawG‘
 { .. } => "raw_get",

356 
	gCommªd
::
RawSÿn
 { .. } => "raw_scan",

357 
	gCommªd
::
D–‘eRªge
 { .. } => "delete_range",

358 
	gCommªd
::
Pau£
 { .. } => "pause",

359 
	gCommªd
::
MvccByKey
 { .. } => "key_mvcc",

360 
	gCommªd
::
MvccByS¹Ts
 { .. } => "start_ts_mvcc",

364 
pub
 
â
 
ts
(&
£lf
è-> 
	gu64
 {

365 
m©ch
 *
	g£lf
 {

366 
	gCommªd
::
G‘
 { 
¡¬t_ts
, .. } |

367 
	gCommªd
::
B©chG‘
 { 
¡¬t_ts
, .. } |

368 
	gCommªd
::
Sÿn
 { 
¡¬t_ts
, .. } |

369 
	gCommªd
::
P»wr™e
 { 
¡¬t_ts
, .. } |

370 
	gCommªd
::
CËªup
 { 
¡¬t_ts
, .. } |

371 
	gCommªd
::
RŞlback
 { 
¡¬t_ts
, .. } |

372 
	gCommªd
::
MvccByS¹Ts
 { 
¡¬t_ts
, .. } => start_ts,

373 
	gCommªd
::
Comm™
 { 
lock_ts
, .. } =>†ock_ts,

374 
	gCommªd
::
SÿnLock
 { 
max_ts
, .. } => max_ts,

375 
	gCommªd
::
Gc
 { 
§ã_pošt
, .. } => safe_point,

376 
	gCommªd
::
ResŞveLock
 { .. } |

377 
Commªd
::
RawG‘
 { .. } |

378 
Commªd
::
RawSÿn
 { .. } |

379 
Commªd
::
D–‘eRªge
 { .. } |

380 
Commªd
::
Pau£
 { .. } |

381 
Commªd
::
MvccByKey
 { .. } => 0,

385 
pub
 
â
 
g‘_cÚ‹xt
(&
£lf
è-> &
	gCÚ‹xt
 {

386 
m©ch
 *
	g£lf
 {

387 
	gCommªd
::
G‘
 { 
»f
 
ùx
, .. } |

388 
	gCommªd
::
B©chG‘
 { 
»f
 
ùx
, .. } |

389 
	gCommªd
::
Sÿn
 { 
»f
 
ùx
, .. } |

390 
	gCommªd
::
P»wr™e
 { 
»f
 
ùx
, .. } |

391 
	gCommªd
::
Comm™
 { 
»f
 
ùx
, .. } |

392 
	gCommªd
::
CËªup
 { 
»f
 
ùx
, .. } |

393 
	gCommªd
::
RŞlback
 { 
»f
 
ùx
, .. } |

394 
	gCommªd
::
SÿnLock
 { 
»f
 
ùx
, .. } |

395 
	gCommªd
::
ResŞveLock
 { 
»f
 
ùx
, .. } |

396 
	gCommªd
::
Gc
 { 
»f
 
ùx
, .. } |

397 
	gCommªd
::
RawG‘
 { 
»f
 
ùx
, .. } |

398 
	gCommªd
::
RawSÿn
 { 
»f
 
ùx
, .. } |

399 
	gCommªd
::
D–‘eRªge
 { 
»f
 
ùx
, .. } |

400 
	gCommªd
::
Pau£
 { 
»f
 
ùx
, .. } |

401 
	gCommªd
::
MvccByKey
 { 
»f
 
ùx
, .. } |

402 
	gCommªd
::
MvccByS¹Ts
 { 
»f
 
ùx
, .. } => ctx,

406 
pub
 
â
 
mut_cÚ‹xt
(&
mut
 
£lf
è-> &muˆ
	gCÚ‹xt
 {

407 
m©ch
 *
	g£lf
 {

408 
	gCommªd
::
G‘
 { 
»f
 
mut
 
ùx
, .. } |

409 
	gCommªd
::
B©chG‘
 { 
»f
 
mut
 
ùx
, .. } |

410 
	gCommªd
::
Sÿn
 { 
»f
 
mut
 
ùx
, .. } |

411 
	gCommªd
::
P»wr™e
 { 
»f
 
mut
 
ùx
, .. } |

412 
	gCommªd
::
Comm™
 { 
»f
 
mut
 
ùx
, .. } |

413 
	gCommªd
::
CËªup
 { 
»f
 
mut
 
ùx
, .. } |

414 
	gCommªd
::
RŞlback
 { 
»f
 
mut
 
ùx
, .. } |

415 
	gCommªd
::
SÿnLock
 { 
»f
 
mut
 
ùx
, .. } |

416 
	gCommªd
::
ResŞveLock
 { 
»f
 
mut
 
ùx
, .. } |

417 
	gCommªd
::
Gc
 { 
»f
 
mut
 
ùx
, .. } |

418 
	gCommªd
::
RawG‘
 { 
»f
 
mut
 
ùx
, .. } |

419 
	gCommªd
::
RawSÿn
 { 
»f
 
mut
 
ùx
, .. } |

420 
	gCommªd
::
D–‘eRªge
 { 
»f
 
mut
 
ùx
, .. } |

421 
	gCommªd
::
Pau£
 { 
»f
 
mut
 
ùx
, .. } |

422 
	gCommªd
::
MvccByKey
 { 
»f
 
mut
 
ùx
, .. } |

423 
	gCommªd
::
MvccByS¹Ts
 { 
»f
 
mut
 
ùx
, .. } => ctx,

427 
pub
 
â
 
wr™e_by‹s
(&
£lf
è-> 
	gusize
 {

428 
Ët
 
mut
 
	gby‹s
 = 0;

429 
m©ch
 *
	g£lf
 {

430 
	gCommªd
::
P»wr™e
 { 
»f
 
mutiÚs
, .. } => 
m
 
š
 mutations {

431 
m©ch
 *
m
 {

432 
MutiÚ
::
Put
((
»f
 
key
,„eà
v®ue
)) => {

433 
by‹s
 +ğ
key
.
’coded
().
Ën
();

434 
	gby‹s
 +ğ
v®ue
.
Ën
();

436 
	gMutiÚ
::
D–‘e
(
»f
 
key
è| 
MutiÚ
::
Lock
(ref key) => {

437 
by‹s
 +ğ
key
.
’coded
().
Ën
();

441 
	gCommªd
::
Comm™
 { 
»f
 
keys
, .. } | Commªd::
RŞlback
 {„ef keys, .. } => {

442 
key
 
š
 
keys
 {

443 
by‹s
 +ğ
key
.
’coded
().
Ën
();

446 
	gCommªd
::
ResŞveLock
 { 
»f
 
key_locks
, .. } => 
lock
 
š
 key_locks {

447 
by‹s
 +ğ
lock
.0.e
ncoded
().
Ën
();

449 
	gCommªd
::
CËªup
 { 
»f
 
key
, .. } => {

450 
by‹s
 +ğ
key
.
’coded
().
Ën
();

452 
	g_
 => {}

454 
	gby‹s


458 
u£
 
	gut
::
Œª¥Üt
::
SyncS’dCh
;

460 #[
d”ive
(
ClÚe
, 
DeçuÉ
)]

461 
pub
 
	sO±iÚs
 {

462 
pub
 
	mlock_‰l
: 
u64
,

463 
pub
 
	msk_cÚ¡¿št_check
: 
boŞ
,

464 
pub
 
	mkey_Úly
: 
boŞ
,

467 
im¶
 
	gO±iÚs
 {

468 
pub
 
â
 
Ãw
(
lock_‰l
: 
u64
, 
sk_cÚ¡¿št_check
: 
boŞ
, 
key_Úly
: boŞè-> 
O±iÚs
 {

469 
O±iÚs
 {

470 
lock_‰l
:†ock_ttl,

471 
	gsk_cÚ¡¿št_check
: 
sk_cÚ¡¿št_check
,

472 
	gkey_Úly
: 
key_Úly
,

477 
	sStÜageHªdË
 {

478 
	mhªdË
: 
O±iÚ
<
th»ad
::
JošHªdË
<()>>,

479 
	m»ûiv”
: 
O±iÚ
<
Reûiv”
<
Msg
>>,

482 
pub
 
	sStÜage
 {

483 
	m’gše
: 
Box
<
Engše
>,

484 
	m£ndch
: 
SyncS’dCh
<
Msg
>,

485 
	mhªdË
: 
Arc
<
Mu‹x
<
StÜageHªdË
>>,

488 
	mgc_¿tio_th»shŞd
: 
f64
,

489 
	mmax_key_size
: 
usize
,

492 
im¶
 
	gStÜage
 {

493 
pub
 
â
 
äom_’gše
(
’gše
: 
Box
<
Engše
>, 
cÚfig
: &
CÚfig
è-> 
ResuÉ
<
StÜage
> {

494 
Ët
 (
tx
, 
rx
èğ
mpsc
::
sync_chªÃl
(
cÚfig
.
scheduËr_nÙify_ÿ·c™y
);

495 
Ët
 
	g£ndch
 = 
SyncS’dCh
::
Ãw
(
tx
, "kv-storage");

497 
	gšfo
!("¡Üag{:?} s¹ed.", 
	g’gše
);

498 
Ok
(
StÜage
 {

499 
’gše
:ƒngine,

500 
£ndch
: sendch,

501 
hªdË
: 
Arc
::
Ãw
(
Mu‹x
::Ãw(
StÜageHªdË
 {

502 
hªdË
: 
NÚe
,

503 
»ûiv”
: 
Some
(
rx
),

505 
gc_¿tio_th»shŞd
: 
cÚfig
.gc_ratio_threshold,

506 
max_key_size
: 
cÚfig
.max_key_size,

510 
pub
 
â
 
Ãw
(
cÚfig
: &
CÚfig
è-> 
ResuÉ
<
StÜage
> {

511 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(&
cÚfig
.
d©a_dœ
, 
ALL_CFS
)?;

512 
	gStÜage
::
äom_’gše
(
’gše
, 
cÚfig
)

515 
pub
 
â
 
¡¬t
(&
mut
 
£lf
, 
cÚfig
: &
CÚfig
è-> 
ResuÉ
<()> {

516 
Ët
 
mut
 
hªdË
 = 
£lf
.hªdË.
lock
().
unw¿p
();

517 
	ghªdË
.hªdË.
is_some
() {

518  
E¼
(
box_”r
!("scheduler is‡lready„unning"));

521 
Ët
 
	g’gše
 = 
£lf
.
’gše
.
şÚe
();

522 
Ët
 
	gbud”
 = 
th»ad
::
Bud”
::
Ãw
().
Çme
(
thd_Çme
!("storage-scheduler"));

523 
Ët
 
	grx
 = 
hªdË
.
»ûiv”
.
ke
().
unw¿p
();

524 
Ët
 
	gsched_cÚcu¼’cy
 = 
cÚfig
.
scheduËr_cÚcu¼’cy
;

525 
Ët
 
	gsched_wÜk”_poŞ_size
 = 
cÚfig
.
scheduËr_wÜk”_poŞ_size
;

526 
Ët
 
	gsched_³ndšg_wr™e_th»shŞd
 = 
cÚfig
.
scheduËr_³ndšg_wr™e_th»shŞd
.0 
as
 
usize
;

527 
Ët
 
	gch
 = 
£lf
.
£ndch
.
şÚe
();

528 
Ët
 
	gh
 = 
bud”
.
¥awn
(
move
 || {

529 
Ët
 
mut
 
sched
 = 
ScheduËr
::
Ãw
(

530 
’gše
,

531 
ch
,

532 
sched_cÚcu¼’cy
,

533 
sched_wÜk”_poŞ_size
,

534 
sched_³ndšg_wr™e_th»shŞd
,

536 
Ët
 
E¼
(
e
èğ
sched
.
run
(
rx
) {

537 
·nic
!("scheduË¸ruÀ”r:{:?}", 
e
);

539 
šfo
!("scheduler stopped");

541 
	ghªdË
.hªdË = 
Some
(
h
);

543 
Ok
(())

546 
pub
 
â
 
¡İ
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

547 
Ët
 
mut
 
	ghªdË
 = 
£lf
.
hªdË
.
lock
().
unw¿p
();

548 
	ghªdË
.hªdË.
is_nÚe
() {

549  
Ok
(());

552 
Ët
 
E¼
(
e
èğ
£lf
.
£ndch
.
£nd
(
Msg
::
Qu™
) {

553 
”rÜ
!("£nd qu™ cmdØscheduË¸çed,ƒ¼Ü:{:?}", 
e
);

554  
E¼
(
box_”r
!("çedØask schedØqu™: {:?}", 
e
));

557 
Ët
 
	gh
 = 
hªdË
.hªdË.
ke
().
unw¿p
();

558 
Ët
 
E¼
(
e
èğ
h
.
još
() {

559  
E¼
(
box_”r
!("çedØjoš sched_hªdË,ƒ¼:{:?}", 
e
));

562 
	gšfo
!("¡Üag{:?} clo£d.", 
	g£lf
.
	g’gše
);

563 
Ok
(())

566 
pub
 
â
 
g‘_’gše
(&
£lf
è-> 
	gBox
<
	gEngše
> {

567 
	g£lf
.
	g’gše
.
şÚe
()

570 
â
 
£nd
(&
£lf
, 
cmd
: 
Commªd
, 
cb
: 
StÜageCb
è-> 
ResuÉ
<()> {

571 
box_Œy
!(
£lf
.
£ndch
.
Œy_£nd
(
Msg
::
RawCmd
 { 
cmd
: cmd, 
cb
: cb }));

572 
Ok
(())

575 
pub
 
â
 
async_g‘
(

576 &
£lf
,

577 
ùx
: 
CÚ‹xt
,

578 
key
: 
Key
,

579 
¡¬t_ts
: 
u64
,

580 
ÿÎback
: 
C®lback
<
O±iÚ
<
V®ue
>>,

581 è-> 
	gResuÉ
<()> {

582 
Ët
 
	gcmd
 = 
Commªd
::
G‘
 {

583 
ùx
: ctx,

584 
key
: key,

585 
¡¬t_ts
: start_ts,

587 
Ët
 
	gg
 = 
cmd
.
g
();

588 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
SšgËV®ue
(
ÿÎback
))?;

589 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

590 
Ok
(())

593 
pub
 
â
 
async_b©ch_g‘
(

594 &
£lf
,

595 
ùx
: 
CÚ‹xt
,

596 
keys
: 
Vec
<
Key
>,

597 
¡¬t_ts
: 
u64
,

598 
ÿÎback
: 
C®lback
<
Vec
<
ResuÉ
<
KvPaœ
>>>,

599 è-> 
	gResuÉ
<()> {

600 
Ët
 
	gcmd
 = 
Commªd
::
B©chG‘
 {

601 
ùx
: ctx,

602 
keys
: keys,

603 
¡¬t_ts
: start_ts,

605 
Ët
 
	gg
 = 
cmd
.
g
();

606 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
KvPaœs
(
ÿÎback
))?;

607 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

608 
Ok
(())

611 
pub
 
â
 
async_sÿn
(

612 &
£lf
,

613 
ùx
: 
CÚ‹xt
,

614 
¡¬t_key
: 
Key
,

615 
lim™
: 
usize
,

616 
¡¬t_ts
: 
u64
,

617 
İtiÚs
: 
O±iÚs
,

618 
ÿÎback
: 
C®lback
<
Vec
<
ResuÉ
<
KvPaœ
>>>,

619 è-> 
	gResuÉ
<()> {

620 
Ët
 
	gcmd
 = 
Commªd
::
Sÿn
 {

621 
ùx
: ctx,

622 
¡¬t_key
: start_key,

623 
lim™
:†imit,

624 
¡¬t_ts
: start_ts,

625 
İtiÚs
: options,

627 
Ët
 
	gg
 = 
cmd
.
g
();

628 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
KvPaœs
(
ÿÎback
))?;

629 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

630 
Ok
(())

633 
pub
 
â
 
async_·u£
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
du¿tiÚ
: 
u64
, 
ÿÎback
: 
C®lback
<()>è-> 
ResuÉ
<()> {

634 
Ët
 
cmd
 = 
Commªd
::
Pau£
 {

635 
ùx
: ctx,

636 
du¿tiÚ
: duration,

638 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
BoŞ—n
(
ÿÎback
))?;

639 
Ok
(())

642 
pub
 
â
 
async_´ewr™e
(

643 &
£lf
,

644 
ùx
: 
CÚ‹xt
,

645 
mutiÚs
: 
Vec
<
MutiÚ
>,

646 
´im¬y
: 
Vec
<
u8
>,

647 
¡¬t_ts
: 
u64
,

648 
İtiÚs
: 
O±iÚs
,

649 
ÿÎback
: 
C®lback
<
Vec
<
ResuÉ
<()>>>,

650 è-> 
	gResuÉ
<()> {

651 
m
 
	gš
 &
	gmutiÚs
 {

652 
Ët
 
	gsize
 = 
m
.
key
().
’coded
().
Ën
();

653 
	gsize
 > 
	g£lf
.
	gmax_key_size
 {

654 
ÿÎback
(
E¼
(
E¼Ü
::
KeyTooL¬ge
(
size
, 
£lf
.
max_key_size
)));

655  
Ok
(());

658 
Ët
 
	gcmd
 = 
Commªd
::
P»wr™e
 {

659 
ùx
: ctx,

660 
mutiÚs
: mutations,

661 
´im¬y
:…rimary,

662 
¡¬t_ts
: start_ts,

663 
İtiÚs
: options,

665 
Ët
 
	gg
 = 
cmd
.
g
();

666 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
BoŞ—ns
(
ÿÎback
))?;

667 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

668 
Ok
(())

671 
pub
 
â
 
async_comm™
(

672 &
£lf
,

673 
ùx
: 
CÚ‹xt
,

674 
keys
: 
Vec
<
Key
>,

675 
lock_ts
: 
u64
,

676 
comm™_ts
: 
u64
,

677 
ÿÎback
: 
C®lback
<()>,

678 è-> 
	gResuÉ
<()> {

679 
Ët
 
	gcmd
 = 
Commªd
::
Comm™
 {

680 
ùx
: ctx,

681 
keys
: keys,

682 
lock_ts
:†ock_ts,

683 
comm™_ts
: commit_ts,

685 
Ët
 
	gg
 = 
cmd
.
g
();

686 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
BoŞ—n
(
ÿÎback
))?;

687 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

688 
Ok
(())

691 
pub
 
â
 
async_d–‘e_¿nge
(

692 &
£lf
,

693 
ùx
: 
CÚ‹xt
,

694 
¡¬t_key
: 
Key
,

695 
’d_key
: 
Key
,

696 
ÿÎback
: 
C®lback
<()>,

697 è-> 
	gResuÉ
<()> {

698 
Ët
 
mut
 
	gmodif›s
 = 
Vec
::
w™h_ÿ·c™y
(
DATA_CFS
.
Ën
());

699 
cf
 
š
 
	gDATA_CFS
 {

705 
Ët
 
	gs
 = *
cf
 =ğ
CF_WRITE
 {

706 
¡¬t_key
.
­³nd_ts
(
u64
::
MAX
)

708 
¡¬t_key
.
şÚe
()

710 
	gmodif›s
.
push
(
Modify
::
D–‘eRªge
(
cf
, 
s
, 
’d_key
.
şÚe
()));

713 
	g£lf
.
	g’gše
.
async_wr™e
(

714 &
ùx
,

715 
modif›s
,

716 
box
 |(
_
, 
»s
): (_, 
’gše
::
ResuÉ
<_>)| 
ÿÎback
Ôes.
m­_”r
(
E¼Ü
::
äom
)),

718 
	gKV_COMMAND_COUNTER_VEC


719 .
w™h_Ïb–_v®ues
(&["delete_range"])

720 .
šc
();

721 
Ok
(())

724 
pub
 
â
 
async_ş—nup
(

725 &
£lf
,

726 
ùx
: 
CÚ‹xt
,

727 
key
: 
Key
,

728 
¡¬t_ts
: 
u64
,

729 
ÿÎback
: 
C®lback
<()>,

730 è-> 
	gResuÉ
<()> {

731 
Ët
 
	gcmd
 = 
Commªd
::
CËªup
 {

732 
ùx
: ctx,

733 
key
: key,

734 
¡¬t_ts
: start_ts,

736 
Ët
 
	gg
 = 
cmd
.
g
();

737 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
BoŞ—n
(
ÿÎback
))?;

738 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

739 
Ok
(())

742 
pub
 
â
 
async_rŞlback
(

743 &
£lf
,

744 
ùx
: 
CÚ‹xt
,

745 
keys
: 
Vec
<
Key
>,

746 
¡¬t_ts
: 
u64
,

747 
ÿÎback
: 
C®lback
<()>,

748 è-> 
	gResuÉ
<()> {

749 
Ët
 
	gcmd
 = 
Commªd
::
RŞlback
 {

750 
ùx
: ctx,

751 
keys
: keys,

752 
¡¬t_ts
: start_ts,

754 
Ët
 
	gg
 = 
cmd
.
g
();

755 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
BoŞ—n
(
ÿÎback
))?;

756 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

757 
Ok
(())

760 
pub
 
â
 
async_sÿn_lock
(

761 &
£lf
,

762 
ùx
: 
CÚ‹xt
,

763 
max_ts
: 
u64
,

764 
ÿÎback
: 
C®lback
<
Vec
<
LockInfo
>>,

765 è-> 
	gResuÉ
<()> {

766 
Ët
 
	gcmd
 = 
Commªd
::
SÿnLock
 {

767 
ùx
: ctx,

768 
max_ts
: max_ts,

770 
Ët
 
	gg
 = 
cmd
.
g
();

771 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
Locks
(
ÿÎback
))?;

772 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

773 
Ok
(())

776 
pub
 
â
 
async_»sŞve_lock
(

777 &
£lf
,

778 
ùx
: 
CÚ‹xt
,

779 
txn_¡©us
: 
HashM­
<
u64
, u64>,

780 
ÿÎback
: 
C®lback
<()>,

781 è-> 
	gResuÉ
<()> {

782 
Ët
 
	gcmd
 = 
Commªd
::
ResŞveLock
 {

783 
ùx
: ctx,

784 
txn_¡©us
:xn_status,

785 
sÿn_key
: 
NÚe
,

786 
key_locks
: 
vec
![],

788 
Ët
 
	gg
 = 
cmd
.
g
();

789 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
BoŞ—n
(
ÿÎback
))?;

790 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

791 
Ok
(())

794 
pub
 
â
 
async_gc
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
§ã_pošt
: 
u64
, 
ÿÎback
: 
C®lback
<()>è-> 
ResuÉ
<()> {

795 
Ët
 
cmd
 = 
Commªd
::
Gc
 {

796 
ùx
: ctx,

797 
§ã_pošt
: safe_point,

798 
¿tio_th»shŞd
: 
£lf
.
gc_¿tio_th»shŞd
,

799 
sÿn_key
: 
NÚe
,

800 
keys
: 
vec
![],

802 
Ët
 
	gg
 = 
cmd
.
g
();

803 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
BoŞ—n
(
ÿÎback
))?;

804 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

805 
Ok
(())

808 
pub
 
â
 
async_¿w_g‘
(

809 &
£lf
,

810 
ùx
: 
CÚ‹xt
,

811 
key
: 
Vec
<
u8
>,

812 
ÿÎback
: 
C®lback
<
O±iÚ
<
Vec
<
u8
>>>,

813 è-> 
	gResuÉ
<()> {

814 
Ët
 
	gcmd
 = 
Commªd
::
RawG‘
 {

815 
ùx
: ctx,

816 
key
: 
Key
::
äom_’coded
(key),

818 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
SšgËV®ue
(
ÿÎback
))?;

819 
	gRAWKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["g‘"]).
šc
();

820 
Ok
(())

823 
pub
 
â
 
async_¿w_put
(

824 &
£lf
,

825 
ùx
: 
CÚ‹xt
,

826 
key
: 
Vec
<
u8
>,

827 
v®ue
: 
Vec
<
u8
>,

828 
ÿÎback
: 
C®lback
<()>,

829 è-> 
	gResuÉ
<()> {

830 
	gkey
.
Ën
(è> 
	g£lf
.
	gmax_key_size
 {

831 
ÿÎback
(
E¼
(
E¼Ü
::
KeyTooL¬ge
(
key
.
Ën
(), 
£lf
.
max_key_size
)));

832  
Ok
(());

834 
	gŒy
!(
	g£lf
.
	g’gše


835 .
async_wr™e
(&
ùx
,

836 
vec
![
Modify
::
Put
(
CF_DEFAULT
, 
Key
::
äom_’coded
(
key
), 
v®ue
)],

837 
box
 |(
_
, 
»s
): (_, 
’gše
::
ResuÉ
<_>)| {

838 
ÿÎback
(
»s
.
m­_”r
(
E¼Ü
::
äom
))

840 
	gRAWKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["put"]).
šc
();

841 
Ok
(())

844 
pub
 
â
 
async_¿w_d–‘e
(

845 &
£lf
,

846 
ùx
: 
CÚ‹xt
,

847 
key
: 
Vec
<
u8
>,

848 
ÿÎback
: 
C®lback
<()>,

849 è-> 
	gResuÉ
<()> {

850 
	gkey
.
Ën
(è> 
	g£lf
.
	gmax_key_size
 {

851 
ÿÎback
(
E¼
(
E¼Ü
::
KeyTooL¬ge
(
key
.
Ën
(), 
£lf
.
max_key_size
)));

852  
Ok
(());

854 
	g£lf
.
	g’gše
.
async_wr™e
(

855 &
ùx
,

856 
vec
![
Modify
::
D–‘e
(
CF_DEFAULT
, 
Key
::
äom_’coded
(
key
))],

857 
box
 |(
_
, 
»s
): (_, 
’gše
::
ResuÉ
<_>)| 
ÿÎback
Ôes.
m­_”r
(
E¼Ü
::
äom
)),

859 
	gRAWKV_COMMAND_COUNTER_VEC


860 .
w™h_Ïb–_v®ues
(&["delete"])

861 .
šc
();

862 
Ok
(())

865 
pub
 
â
 
async_¿w_sÿn
(

866 &
£lf
,

867 
ùx
: 
CÚ‹xt
,

868 
key
: 
Vec
<
u8
>,

869 
lim™
: 
usize
,

870 
ÿÎback
: 
C®lback
<
Vec
<
ResuÉ
<
KvPaœ
>>>,

871 è-> 
	gResuÉ
<()> {

872 
Ët
 
	gcmd
 = 
Commªd
::
RawSÿn
 {

873 
ùx
: ctx,

874 
¡¬t_key
: 
Key
::
äom_’coded
(
key
),

875 
lim™
:†imit,

877 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
KvPaœs
(
ÿÎback
))?;

878 
	gRAWKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&["sÿn"]).
šc
();

879 
Ok
(())

882 
pub
 
â
 
async_mvcc_by_key
(

883 &
£lf
,

884 
ùx
: 
CÚ‹xt
,

885 
key
: 
Key
,

886 
ÿÎback
: 
C®lback
<
MvccInfo
>,

887 è-> 
	gResuÉ
<()> {

888 
Ët
 
	gcmd
 = 
Commªd
::
MvccByKey
 { 
ùx
: ctx, 
key
: key };

889 
Ët
 
	gg
 = 
cmd
.
g
();

890 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
MvccInfoByKey
(
ÿÎback
))?;

891 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

892 
Ok
(())

895 
pub
 
â
 
async_mvcc_by_¡¬t_ts
(

896 &
£lf
,

897 
ùx
: 
CÚ‹xt
,

898 
¡¬t_ts
: 
u64
,

899 
ÿÎback
: 
C®lback
<
O±iÚ
<(
Key
, 
MvccInfo
)>>,

900 è-> 
	gResuÉ
<()> {

901 
Ët
 
	gcmd
 = 
Commªd
::
MvccByS¹Ts
 {

902 
ùx
: ctx,

903 
¡¬t_ts
: start_ts,

905 
Ët
 
	gg
 = 
cmd
.
g
();

906 
	g£lf
.
£nd
(
cmd
, 
StÜageCb
::
MvccInfoByS¹Ts
(
ÿÎback
))?;

907 
	gKV_COMMAND_COUNTER_VEC
.
w™h_Ïb–_v®ues
(&[
g
]).
šc
();

908 
Ok
(())

912 
im¶
 
ClÚe
 
	gStÜage
 {

913 
â
 
şÚe
(&
£lf
è-> 
	gStÜage
 {

914 
	gStÜage
 {

915 
	g’gše
: 
£lf
.
’gše
.
şÚe
(),

916 
	g£ndch
: 
£lf
.
£ndch
.
şÚe
(),

917 
	ghªdË
: 
£lf
.
hªdË
.
şÚe
(),

918 
	ggc_¿tio_th»shŞd
: 
£lf
.
gc_¿tio_th»shŞd
,

919 
	gmax_key_size
: 
£lf
.
max_key_size
,

924 
	gquick_”rÜ
! {

925 #[
d”ive
(
Debug
)]

926 
pub
 
	eE¼Ü
 {

927 
Engše
(
”r
: 
EngšeE¼Ü
) {

928 
äom
()

929 
ÿu£
(
”r
)

930 
desütiÚ
(
”r
.description())

932 
Txn
(
”r
: 
txn
::
E¼Ü
) {

933 
äom
()

934 
ÿu£
(
”r
)

935 
desütiÚ
(
”r
.description())

937 
Mvcc
(
”r
: 
mvcc
::
E¼Ü
) {

938 
äom
()

939 
ÿu£
(
”r
)

940 
desütiÚ
(
”r
.description())

942 
Clo£d
 {

943 
desütiÚ
("storage is closed.")

945 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
S’d
 + 
Sync
>) {

946 
äom
()

947 
ÿu£
(
”r
.
as_»f
())

948 
desütiÚ
(
”r
.description())

950 
Io
(
”r
: 
IoE¼Ü
) {

951 
äom
()

952 
ÿu£
(
”r
)

953 
desütiÚ
(
”r
.description())

955 
SchedTooBusy
 {

956 
desütiÚ
("scheduler isoo busy")

958 
KeyTooL¬ge
(
size
: 
usize
, 
lim™
: usize) {

959 
desütiÚ
("max key sizeƒxceeded")

960 
di¥Ïy
("max key sizexûeded, size: {},†im™: {}", 
size
, 
lim™
)

965 
pub
 
ty³
 
	gResuÉ
<
	gT
> = ::
¡d
::
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

967 
pub
 
â
 
g‘_g_äom_h—d”
(
h—d”
: &
”rÜpb
::
E¼Ü
) -> &'static str {

968 
h—d”
.
	$has_nÙ_Ëad”
() {

970 
	}
} 
h—d”
.
	$has_»giÚ_nÙ_found
() {

972 
	}
} 
h—d”
.
	$has_key_nÙ_š_»giÚ
() {

974 
	}
} 
h—d”
.
	$has_¡®e_•och
() {

976 
	}
} 
h—d”
.
	$has_£rv”_is_busy
() {

978 
	}
} {

983 #[
cfg
(
‹¡
)]

984 
mod
 
‹¡s
 {

985 
u£
 
su³r
::*;

986 
u£
 
	g¡d
::
sync
::
mpsc
::{
chªÃl
, 
	gS’d”
};

987 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

988 
u£
 
	gut
::
cÚfig
::
R—dabËSize
;

990 
â
 
ex³ù_g‘_nÚe
(
dÚe
: 
S’d”
<
i32
>, 
id
: i32è-> 
C®lback
<
O±iÚ
<
V®ue
>> {

991 
Box
::
Ãw
(
move
 |
x
: 
ResuÉ
<
O±iÚ
<
V®ue
>>| {

992 
as£¹_eq
!(
x
.
unw¿p
(), 
NÚe
);

993 
dÚe
.
£nd
(
id
).
unw¿p
();

997 
â
 
ex³ù_g‘_v®
(
dÚe
: 
S’d”
<
i32
>, 
v
: 
Vec
<
u8
>, 
id
: i32è-> 
C®lback
<
O±iÚ
<
V®ue
>> {

998 
Box
::
Ãw
(
move
 |
x
: 
ResuÉ
<
O±iÚ
<
V®ue
>>| {

999 
as£¹_eq
!(
x
.
unw¿p
().unw¿p(), 
v
);

1000 
dÚe
.
£nd
(
id
).
unw¿p
();

1004 
â
 
	gex³ù_ok
<
	gT
>(
	gdÚe
: 
S’d”
<
i32
>, 
	gid
: i32è-> 
C®lback
<
T
> {

1005 
Box
::
Ãw
(
move
 |
x
: 
ResuÉ
<
T
>| {

1006 
as£¹
!(
x
.
is_ok
());

1007 
dÚe
.
£nd
(
id
).
unw¿p
();

1011 
â
 
	gex³ù_ç
<
	gT
>(
	gdÚe
: 
S’d”
<
i32
>, 
	gid
: i32è-> 
C®lback
<
T
> {

1012 
Box
::
Ãw
(
move
 |
x
: 
ResuÉ
<
T
>| {

1013 
as£¹
!(
x
.
is_”r
());

1014 
dÚe
.
£nd
(
id
).
unw¿p
();

1018 
â
 
	gex³ù_too_busy
<
	gT
>(
	gdÚe
: 
S’d”
<
i32
>, 
	gid
: i32è-> 
C®lback
<
T
> {

1019 
Box
::
Ãw
(
move
 |
x
: 
ResuÉ
<
T
>| {

1020 
as£¹
!(
x
.
is_”r
());

1021 
m©ch
 
x
 {

1022 
E¼
(
E¼Ü
::
SchedTooBusy
) => {}

1023 
_
 => 
·nic
!("expectoo busy"),

1025 
dÚe
.
£nd
(
id
).
unw¿p
();

1029 
â
 
ex³ù_sÿn
(

1030 
dÚe
: 
S’d”
<
i32
>,

1031 
·œs
: 
Vec
<
O±iÚ
<
KvPaœ
>>,

1032 
id
: 
i32
,

1033 è-> 
	gC®lback
<
	gVec
<
	gResuÉ
<
	gKvPaœ
>>> {

1034 
	gBox
::
Ãw
(
move
 |
¾t
: 
ResuÉ
<
Vec
<ResuÉ<
KvPaœ
>>>| {

1035 
Ët
 
¾t
: 
Vec
<
O±iÚ
<
KvPaœ
>> =„É.
unw¿p
().
što_™”
().
m­
(
ResuÉ
::
ok
).
cŞËù
();

1036 
as£¹_eq
!(
¾t
, 
·œs
);

1037 
dÚe
.
£nd
(
id
).
unw¿p
()

1041 
â
 
ex³ù_b©ch_g‘_v®s
(

1042 
dÚe
: 
S’d”
<
i32
>,

1043 
·œs
: 
Vec
<
O±iÚ
<
KvPaœ
>>,

1044 
id
: 
i32
,

1045 è-> 
	gC®lback
<
	gVec
<
	gResuÉ
<
	gKvPaœ
>>> {

1046 
	gBox
::
Ãw
(
move
 |
¾t
: 
ResuÉ
<
Vec
<ResuÉ<
KvPaœ
>>>| {

1047 
Ët
 
¾t
: 
Vec
<
O±iÚ
<
KvPaœ
>> =„É.
unw¿p
().
što_™”
().
m­
(
ResuÉ
::
ok
).
cŞËù
();

1048 
as£¹_eq
!(
¾t
, 
·œs
);

1049 
dÚe
.
£nd
(
id
).
unw¿p
()

1053 #[
‹¡
]

1054 
â
 
‹¡_g‘_put
() {

1055 
Ët
 
	gcÚfig
 = 
CÚfig
::();

1056 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
Ãw
(&
cÚfig
).
unw¿p
();

1057 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

1058 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1059 
	g¡Üage


1060 .
async_g‘
(

1061 
CÚ‹xt
::
Ãw
(),

1062 
make_key
(
b
"x"),

1064 
ex³ù_g‘_nÚe
(
tx
.
şÚe
(), 0),

1066 .
unw¿p
();

1067 
	grx
.
»cv
().
unw¿p
();

1068 
	g¡Üage


1069 .
async_´ewr™e
(

1070 
CÚ‹xt
::
Ãw
(),

1071 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"x"), b"100".
to_vec
()))],

1072 
b
"x".
to_vec
(),

1074 
O±iÚs
::(),

1075 
ex³ù_ok
(
tx
.
şÚe
(), 1),

1077 .
unw¿p
();

1078 
	grx
.
»cv
().
unw¿p
();

1079 
	g¡Üage


1080 .
async_comm™
(

1081 
CÚ‹xt
::
Ãw
(),

1082 
vec
![
make_key
(
b
"x")],

1085 
ex³ù_ok
(
tx
.
şÚe
(), 2),

1087 .
unw¿p
();

1088 
	grx
.
»cv
().
unw¿p
();

1089 
	g¡Üage


1090 .
async_g‘
(

1091 
CÚ‹xt
::
Ãw
(),

1092 
make_key
(
b
"x"),

1094 
ex³ù_g‘_nÚe
(
tx
.
şÚe
(), 3),

1096 .
unw¿p
();

1097 
	grx
.
»cv
().
unw¿p
();

1098 
	g¡Üage


1099 .
async_g‘
(

1100 
CÚ‹xt
::
Ãw
(),

1101 
make_key
(
b
"x"),

1103 
ex³ù_g‘_v®
(
tx
.
şÚe
(), 
b
"100".
to_vec
(), 4),

1105 .
unw¿p
();

1106 
	grx
.
»cv
().
unw¿p
();

1107 
	g¡Üage
.
¡İ
().
unw¿p
();

1110 #[
‹¡
]

1111 
â
 
‹¡_put_w™h_”r
() {

1112 
Ët
 
	gcÚfig
 = 
CÚfig
::();

1114 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(&
cÚfig
.
d©a_dœ
, &["deçuÉ"]).
unw¿p
();

1115 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
äom_’gše
(
’gše
, &
cÚfig
).
unw¿p
();

1116 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

1117 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1118 
	g¡Üage


1119 .
async_´ewr™e
(

1120 
CÚ‹xt
::
Ãw
(),

1121 
vec
![

1122 
MutiÚ
::
Put
((
make_key
(
b
"a"), b"¯".
to_vec
())),

1123 
MutiÚ
::
Put
((
make_key
(
b
"b"), b"bb".
to_vec
())),

1124 
MutiÚ
::
Put
((
make_key
(
b
"c"), b"cc".
to_vec
())),

1126 
b
"a".
to_vec
(),

1128 
O±iÚs
::(),

1129 
ex³ù_ç
(
tx
.
şÚe
(), 0),

1131 .
unw¿p
();

1132 
	grx
.
»cv
().
unw¿p
();

1133 
	g¡Üage
.
¡İ
().
unw¿p
();

1136 #[
‹¡
]

1137 
â
 
‹¡_sÿn
() {

1138 
Ët
 
	gcÚfig
 = 
CÚfig
::();

1139 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
Ãw
(&
cÚfig
).
unw¿p
();

1140 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

1141 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1142 
	g¡Üage


1143 .
async_´ewr™e
(

1144 
CÚ‹xt
::
Ãw
(),

1145 
vec
![

1146 
MutiÚ
::
Put
((
make_key
(
b
"a"), b"¯".
to_vec
())),

1147 
MutiÚ
::
Put
((
make_key
(
b
"b"), b"bb".
to_vec
())),

1148 
MutiÚ
::
Put
((
make_key
(
b
"c"), b"cc".
to_vec
())),

1150 
b
"a".
to_vec
(),

1152 
O±iÚs
::(),

1153 
ex³ù_ok
(
tx
.
şÚe
(), 0),

1155 .
unw¿p
();

1156 
	grx
.
»cv
().
unw¿p
();

1157 
	g¡Üage


1158 .
async_comm™
(

1159 
CÚ‹xt
::
Ãw
(),

1160 
vec
![
make_key
(
b
"a"), make_key(b"b"), make_key(b"c")],

1163 
ex³ù_ok
(
tx
.
şÚe
(), 1),

1165 .
unw¿p
();

1166 
	grx
.
»cv
().
unw¿p
();

1167 
	g¡Üage


1168 .
async_sÿn
(

1169 
CÚ‹xt
::
Ãw
(),

1170 
make_key
(
b
"\x00"),

1173 
O±iÚs
::(),

1174 
ex³ù_sÿn
(

1175 
tx
.
şÚe
(),

1176 
vec
![

1177 
Some
((
b
"a".
to_vec
(), b"aa".to_vec())),

1178 
Some
((
b
"b".
to_vec
(), b"bb".to_vec())),

1179 
Some
((
b
"c".
to_vec
(), b"cc".to_vec())),

1184 .
unw¿p
();

1185 
	grx
.
»cv
().
unw¿p
();

1186 
	g¡Üage
.
¡İ
().
unw¿p
();

1189 #[
‹¡
]

1190 
â
 
‹¡_b©ch_g‘
() {

1191 
Ët
 
	gcÚfig
 = 
CÚfig
::();

1192 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
Ãw
(&
cÚfig
).
unw¿p
();

1193 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

1194 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1195 
	g¡Üage


1196 .
async_´ewr™e
(

1197 
CÚ‹xt
::
Ãw
(),

1198 
vec
![

1199 
MutiÚ
::
Put
((
make_key
(
b
"a"), b"¯".
to_vec
())),

1200 
MutiÚ
::
Put
((
make_key
(
b
"b"), b"bb".
to_vec
())),

1201 
MutiÚ
::
Put
((
make_key
(
b
"c"), b"cc".
to_vec
())),

1203 
b
"a".
to_vec
(),

1205 
O±iÚs
::(),

1206 
ex³ù_ok
(
tx
.
şÚe
(), 0),

1208 .
unw¿p
();

1209 
	grx
.
»cv
().
unw¿p
();

1210 
	g¡Üage


1211 .
async_comm™
(

1212 
CÚ‹xt
::
Ãw
(),

1213 
vec
![
make_key
(
b
"a"), make_key(b"b"), make_key(b"c")],

1216 
ex³ù_ok
(
tx
.
şÚe
(), 1),

1218 .
unw¿p
();

1219 
	grx
.
»cv
().
unw¿p
();

1220 
	g¡Üage


1221 .
async_b©ch_g‘
(

1222 
CÚ‹xt
::
Ãw
(),

1223 
vec
![
make_key
(
b
"a"), make_key(b"b"), make_key(b"c")],

1225 
ex³ù_b©ch_g‘_v®s
(

1226 
tx
.
şÚe
(),

1227 
vec
![

1228 
Some
((
b
"a".
to_vec
(), b"aa".to_vec())),

1229 
Some
((
b
"b".
to_vec
(), b"bb".to_vec())),

1230 
Some
((
b
"c".
to_vec
(), b"cc".to_vec())),

1235 .
unw¿p
();

1236 
	grx
.
»cv
().
unw¿p
();

1237 
	g¡Üage
.
¡İ
().
unw¿p
();

1240 #[
‹¡
]

1241 
â
 
‹¡_txn
() {

1242 
Ët
 
	gcÚfig
 = 
CÚfig
::();

1243 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
Ãw
(&
cÚfig
).
unw¿p
();

1244 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

1245 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1246 
	g¡Üage


1247 .
async_´ewr™e
(

1248 
CÚ‹xt
::
Ãw
(),

1249 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"x"), b"100".
to_vec
()))],

1250 
b
"x".
to_vec
(),

1252 
O±iÚs
::(),

1253 
ex³ù_ok
(
tx
.
şÚe
(), 0),

1255 .
unw¿p
();

1256 
	g¡Üage


1257 .
async_´ewr™e
(

1258 
CÚ‹xt
::
Ãw
(),

1259 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"y"), b"101".
to_vec
()))],

1260 
b
"y".
to_vec
(),

1262 
O±iÚs
::(),

1263 
ex³ù_ok
(
tx
.
şÚe
(), 1),

1265 .
unw¿p
();

1266 
	grx
.
»cv
().
unw¿p
();

1267 
	grx
.
»cv
().
unw¿p
();

1268 
	g¡Üage


1269 .
async_comm™
(

1270 
CÚ‹xt
::
Ãw
(),

1271 
vec
![
make_key
(
b
"x")],

1274 
ex³ù_ok
(
tx
.
şÚe
(), 2),

1276 .
unw¿p
();

1277 
	g¡Üage


1278 .
async_comm™
(

1279 
CÚ‹xt
::
Ãw
(),

1280 
vec
![
make_key
(
b
"y")],

1283 
ex³ù_ok
(
tx
.
şÚe
(), 3),

1285 .
unw¿p
();

1286 
	grx
.
»cv
().
unw¿p
();

1287 
	grx
.
»cv
().
unw¿p
();

1288 
	g¡Üage


1289 .
async_g‘
(

1290 
CÚ‹xt
::
Ãw
(),

1291 
make_key
(
b
"x"),

1293 
ex³ù_g‘_v®
(
tx
.
şÚe
(), 
b
"100".
to_vec
(), 4),

1295 .
unw¿p
();

1296 
	g¡Üage


1297 .
async_g‘
(

1298 
CÚ‹xt
::
Ãw
(),

1299 
make_key
(
b
"y"),

1301 
ex³ù_g‘_v®
(
tx
.
şÚe
(), 
b
"101".
to_vec
(), 5),

1303 .
unw¿p
();

1304 
	grx
.
»cv
().
unw¿p
();

1305 
	grx
.
»cv
().
unw¿p
();

1306 
	g¡Üage


1307 .
async_´ewr™e
(

1308 
CÚ‹xt
::
Ãw
(),

1309 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"x"), b"105".
to_vec
()))],

1310 
b
"x".
to_vec
(),

1312 
O±iÚs
::(),

1313 
ex³ù_ç
(
tx
.
şÚe
(), 6),

1315 .
unw¿p
();

1316 
	grx
.
»cv
().
unw¿p
();

1317 
	g¡Üage
.
¡İ
().
unw¿p
();

1320 #[
‹¡
]

1321 
â
 
‹¡_sched_too_busy
() {

1322 
Ët
 
mut
 
	gcÚfig
 = 
CÚfig
::();

1323 
	gcÚfig
.
	gscheduËr_³ndšg_wr™e_th»shŞd
 = 
R—dabËSize
(1);

1324 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
Ãw
(&
cÚfig
).
unw¿p
();

1325 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

1326 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1327 
	g¡Üage


1328 .
async_g‘
(

1329 
CÚ‹xt
::
Ãw
(),

1330 
make_key
(
b
"x"),

1332 
ex³ù_g‘_nÚe
(
tx
.
şÚe
(), 0),

1334 .
unw¿p
();

1335 
	g¡Üage


1336 .
async_´ewr™e
(

1337 
CÚ‹xt
::
Ãw
(),

1338 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"x"), b"100".
to_vec
()))],

1339 
b
"x".
to_vec
(),

1341 
O±iÚs
::(),

1342 
ex³ù_ok
(
tx
.
şÚe
(), 1),

1344 .
unw¿p
();

1345 
	g¡Üage


1346 .
async_´ewr™e
(

1347 
CÚ‹xt
::
Ãw
(),

1348 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"y"), b"101".
to_vec
()))],

1349 
b
"y".
to_vec
(),

1351 
O±iÚs
::(),

1352 
ex³ù_too_busy
(
tx
.
şÚe
(), 2),

1354 .
unw¿p
();

1355 
	grx
.
»cv
().
unw¿p
();

1356 
	grx
.
»cv
().
unw¿p
();

1357 
	grx
.
»cv
().
unw¿p
();

1358 
	g¡Üage


1359 .
async_´ewr™e
(

1360 
CÚ‹xt
::
Ãw
(),

1361 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"z"), b"102".
to_vec
()))],

1362 
b
"y".
to_vec
(),

1364 
O±iÚs
::(),

1365 
ex³ù_ok
(
tx
.
şÚe
(), 3),

1367 .
unw¿p
();

1368 
	grx
.
»cv
().
unw¿p
();

1369 
	g¡Üage
.
¡İ
().
unw¿p
();

1372 #[
‹¡
]

1373 
â
 
‹¡_ş—nup
() {

1374 
Ët
 
	gcÚfig
 = 
CÚfig
::();

1375 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
Ãw
(&
cÚfig
).
unw¿p
();

1376 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

1377 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1378 
	g¡Üage


1379 .
async_´ewr™e
(

1380 
CÚ‹xt
::
Ãw
(),

1381 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"x"), b"100".
to_vec
()))],

1382 
b
"x".
to_vec
(),

1384 
O±iÚs
::(),

1385 
ex³ù_ok
(
tx
.
şÚe
(), 0),

1387 .
unw¿p
();

1388 
	grx
.
»cv
().
unw¿p
();

1389 
	g¡Üage


1390 .
async_ş—nup
(

1391 
CÚ‹xt
::
Ãw
(),

1392 
make_key
(
b
"x"),

1394 
ex³ù_ok
(
tx
.
şÚe
(), 1),

1396 .
unw¿p
();

1397 
	grx
.
»cv
().
unw¿p
();

1398 
	g¡Üage


1399 .
async_g‘
(

1400 
CÚ‹xt
::
Ãw
(),

1401 
make_key
(
b
"x"),

1403 
ex³ù_g‘_nÚe
(
tx
.
şÚe
(), 2),

1405 .
unw¿p
();

1406 
	grx
.
»cv
().
unw¿p
();

1407 
	g¡Üage
.
¡İ
().
unw¿p
();

1410 #[
‹¡
]

1411 
â
 
‹¡_high_´iÜ™y_g‘_put
() {

1412 
Ët
 
	gcÚfig
 = 
CÚfig
::();

1413 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
Ãw
(&
cÚfig
).
unw¿p
();

1414 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

1415 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1416 
Ët
 
mut
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

1417 
	gùx
.
£t_´iÜ™y
(
CommªdPri
::
High
);

1418 
	g¡Üage


1419 .
async_g‘
(
ùx
, 
make_key
(
b
"x"), 100, 
ex³ù_g‘_nÚe
(
tx
.
şÚe
(), 0))

1420 .
unw¿p
();

1421 
	grx
.
»cv
().
unw¿p
();

1422 
Ët
 
mut
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

1423 
	gùx
.
£t_´iÜ™y
(
CommªdPri
::
High
);

1424 
	g¡Üage


1425 .
async_´ewr™e
(

1426 
ùx
,

1427 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"x"), b"100".
to_vec
()))],

1428 
b
"x".
to_vec
(),

1430 
O±iÚs
::(),

1431 
ex³ù_ok
(
tx
.
şÚe
(), 1),

1433 .
unw¿p
();

1434 
	grx
.
»cv
().
unw¿p
();

1435 
Ët
 
mut
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

1436 
	gùx
.
£t_´iÜ™y
(
CommªdPri
::
High
);

1437 
	g¡Üage


1438 .
async_comm™
(

1439 
ùx
,

1440 
vec
![
make_key
(
b
"x")],

1443 
ex³ù_ok
(
tx
.
şÚe
(), 2),

1445 .
unw¿p
();

1446 
	grx
.
»cv
().
unw¿p
();

1447 
Ët
 
mut
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

1448 
	gùx
.
£t_´iÜ™y
(
CommªdPri
::
High
);

1449 
	g¡Üage


1450 .
async_g‘
(
ùx
, 
make_key
(
b
"x"), 100, 
ex³ù_g‘_nÚe
(
tx
.
şÚe
(), 3))

1451 .
unw¿p
();

1452 
	grx
.
»cv
().
unw¿p
();

1453 
Ët
 
mut
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

1454 
	gùx
.
£t_´iÜ™y
(
CommªdPri
::
High
);

1455 
	g¡Üage


1456 .
async_g‘
(

1457 
ùx
,

1458 
make_key
(
b
"x"),

1460 
ex³ù_g‘_v®
(
tx
.
şÚe
(), 
b
"100".
to_vec
(), 4),

1462 .
unw¿p
();

1463 
	grx
.
»cv
().
unw¿p
();

1464 
	g¡Üage
.
¡İ
().
unw¿p
();

1467 #[
‹¡
]

1468 
â
 
‹¡_high_´iÜ™y_no_block
() {

1469 
Ët
 
mut
 
	gcÚfig
 = 
CÚfig
::();

1470 
	gcÚfig
.
	gscheduËr_wÜk”_poŞ_size
 = 1;

1471 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
Ãw
(&
cÚfig
).
unw¿p
();

1472 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

1473 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1474 
	g¡Üage


1475 .
async_g‘
(

1476 
CÚ‹xt
::
Ãw
(),

1477 
make_key
(
b
"x"),

1479 
ex³ù_g‘_nÚe
(
tx
.
şÚe
(), 0),

1481 .
unw¿p
();

1482 
	grx
.
»cv
().
unw¿p
();

1483 
	g¡Üage


1484 .
async_´ewr™e
(

1485 
CÚ‹xt
::
Ãw
(),

1486 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"x"), b"100".
to_vec
()))],

1487 
b
"x".
to_vec
(),

1489 
O±iÚs
::(),

1490 
ex³ù_ok
(
tx
.
şÚe
(), 1),

1492 .
unw¿p
();

1493 
	grx
.
»cv
().
unw¿p
();

1494 
	g¡Üage


1495 .
async_comm™
(

1496 
CÚ‹xt
::
Ãw
(),

1497 
vec
![
make_key
(
b
"x")],

1500 
ex³ù_ok
(
tx
.
şÚe
(), 2),

1502 .
unw¿p
();

1503 
	grx
.
»cv
().
unw¿p
();

1505 
	g¡Üage


1506 .
async_·u£
(
CÚ‹xt
::
Ãw
(), 1000, 
ex³ù_ok
(
tx
.
şÚe
(), 3))

1507 .
unw¿p
();

1508 
Ët
 
mut
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

1509 
	gùx
.
£t_´iÜ™y
(
CommªdPri
::
High
);

1510 
	g¡Üage


1511 .
async_g‘
(

1512 
ùx
,

1513 
make_key
(
b
"x"),

1515 
ex³ù_g‘_v®
(
tx
.
şÚe
(), 
b
"100".
to_vec
(), 4),

1517 .
unw¿p
();

1519 
	gas£¹_eq
!(
	grx
.
»cv
().
unw¿p
(), 4);

1520 
	gas£¹_eq
!(
	grx
.
»cv
().
unw¿p
(), 3);

1522 
	g¡Üage
.
¡İ
().
unw¿p
();

1525 #[
‹¡
]

1526 
â
 
‹¡_d–‘e_¿nge
() {

1527 
Ët
 
	gcÚfig
 = 
CÚfig
::();

1528 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
Ãw
(&
cÚfig
).
unw¿p
();

1529 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

1530 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

1532 
	g¡Üage


1533 .
async_´ewr™e
(

1534 
CÚ‹xt
::
Ãw
(),

1535 
vec
![

1536 
MutiÚ
::
Put
((
make_key
(
b
"x"), b"100".
to_vec
())),

1537 
MutiÚ
::
Put
((
make_key
(
b
"y"), b"100".
to_vec
())),

1538 
MutiÚ
::
Put
((
make_key
(
b
"z"), b"100".
to_vec
())),

1540 
b
"x".
to_vec
(),

1542 
O±iÚs
::(),

1543 
ex³ù_ok
(
tx
.
şÚe
(), 0),

1545 .
unw¿p
();

1546 
	grx
.
»cv
().
unw¿p
();

1547 
	g¡Üage


1548 .
async_comm™
(

1549 
CÚ‹xt
::
Ãw
(),

1550 
vec
![
make_key
(
b
"x"), make_key(b"y"), make_key(b"z")],

1553 
ex³ù_ok
(
tx
.
şÚe
(), 1),

1555 .
unw¿p
();

1556 
	grx
.
»cv
().
unw¿p
();

1557 
	g¡Üage


1558 .
async_g‘
(

1559 
CÚ‹xt
::
Ãw
(),

1560 
make_key
(
b
"x"),

1562 
ex³ù_g‘_v®
(
tx
.
şÚe
(), 
b
"100".
to_vec
(), 2),

1564 .
unw¿p
();

1565 
	grx
.
»cv
().
unw¿p
();

1566 
	g¡Üage


1567 .
async_g‘
(

1568 
CÚ‹xt
::
Ãw
(),

1569 
make_key
(
b
"y"),

1571 
ex³ù_g‘_v®
(
tx
.
şÚe
(), 
b
"100".
to_vec
(), 3),

1573 .
unw¿p
();

1574 
	grx
.
»cv
().
unw¿p
();

1575 
	g¡Üage


1576 .
async_g‘
(

1577 
CÚ‹xt
::
Ãw
(),

1578 
make_key
(
b
"z"),

1580 
ex³ù_g‘_v®
(
tx
.
şÚe
(), 
b
"100".
to_vec
(), 4),

1582 .
unw¿p
();

1583 
	grx
.
»cv
().
unw¿p
();

1586 
	g¡Üage


1587 .
async_d–‘e_¿nge
(

1588 
CÚ‹xt
::
Ãw
(),

1589 
make_key
(
b
"x"),

1590 
make_key
(
b
"z"),

1591 
ex³ù_ok
(
tx
.
şÚe
(), 5),

1593 .
unw¿p
();

1594 
	grx
.
»cv
().
unw¿p
();

1595 
	g¡Üage


1596 .
async_g‘
(

1597 
CÚ‹xt
::
Ãw
(),

1598 
make_key
(
b
"x"),

1600 
ex³ù_g‘_nÚe
(
tx
.
şÚe
(), 6),

1602 .
unw¿p
();

1603 
	grx
.
»cv
().
unw¿p
();

1604 
	g¡Üage


1605 .
async_g‘
(

1606 
CÚ‹xt
::
Ãw
(),

1607 
make_key
(
b
"y"),

1609 
ex³ù_g‘_nÚe
(
tx
.
şÚe
(), 7),

1611 .
unw¿p
();

1612 
	grx
.
»cv
().
unw¿p
();

1613 
	g¡Üage


1614 .
async_g‘
(

1615 
CÚ‹xt
::
Ãw
(),

1616 
make_key
(
b
"z"),

1618 
ex³ù_g‘_v®
(
tx
.
şÚe
(), 
b
"100".
to_vec
(), 8),

1620 .
unw¿p
();

1621 
	grx
.
»cv
().
unw¿p
();

1624 
	g¡Üage


1625 .
async_d–‘e_¿nge
(

1626 
CÚ‹xt
::
Ãw
(),

1627 
make_key
(
b
""),

1628 
make_key
(
b
""),

1629 
ex³ù_ok
(
tx
.
şÚe
(), 9),

1631 .
unw¿p
();

1632 
	grx
.
»cv
().
unw¿p
();

1633 
	g¡Üage


1634 .
async_g‘
(

1635 
CÚ‹xt
::
Ãw
(),

1636 
make_key
(
b
"z"),

1638 
ex³ù_g‘_nÚe
(
tx
.
şÚe
(), 10),

1640 .
unw¿p
();

1641 
	grx
.
»cv
().
unw¿p
();

1642 
	g¡Üage
.
¡İ
().
unw¿p
();

	@src/storage/mvcc/lock.rs

14 
u£
 
	gby‹Üd”
::
R—dBy‹sExt
;

15 
u£
 
	g¡Üage
::{
MutiÚ
, 
	gSHORT_VALUE_MAX_LEN
, 
	gSHORT_VALUE_PREFIX
};

16 
u£
 
	gut
::
codec
::
numb”
::{
MAX_VAR_U64_LEN
, 
	gNumb”Decod”
, 
	gNumb”Encod”
};

17 
u£
 
	gut
::
codec
::
by‹s
::{
By‹sEncod”
, 
	gCom·ùBy‹sDecod”
};

18 
u£
 
	gsu³r
::{
E¼Ü
, 
	gResuÉ
};

19 
u£
 
	gsu³r
::
su³r
::
ty³s
::
V®ue
;

21 #[
d”ive
(
Debug
, 
ClÚe
, 
Cİy
, 
P¬tŸlEq
)]

22 
pub
 
	eLockTy³
 {

23 
	mPut
,

24 
	mD–‘e
,

25 
	mLock
,

28 cÚ¡ 
	gFLAG_PUT
: 
u8
 = 
b
'P';

29 cÚ¡ 
	gFLAG_DELETE
: 
u8
 = 
b
'D';

30 cÚ¡ 
	gFLAG_LOCK
: 
u8
 = 
b
'L';

32 
im¶
 
	gLockTy³
 {

33 
pub
 
â
 
äom_mutiÚ
(
mutiÚ
: &
MutiÚ
è-> 
LockTy³
 {

34 
m©ch
 *
mutiÚ
 {

35 
MutiÚ
::
Put
(
_
è=> 
LockTy³
::Put,

36 
	gMutiÚ
::
D–‘e
(
_
è=> 
LockTy³
::Delete,

37 
	gMutiÚ
::
Lock
(
_
è=> 
LockTy³
::Lock,

41 
â
 
äom_u8
(
b
: 
u8
è-> 
O±iÚ
<
LockTy³
> {

42 
m©ch
 
b
 {

43 
FLAG_PUT
 => 
Some
(
LockTy³
::
Put
),

44 
	gFLAG_DELETE
 => 
Some
(
LockTy³
::
D–‘e
),

45 
	gFLAG_LOCK
 => 
Some
(
LockTy³
::
Lock
),

46 
	g_
 => 
NÚe
,

50 
â
 
to_u8
(&
£lf
è-> 
	gu8
 {

51 
m©ch
 *
	g£lf
 {

52 
	gLockTy³
::
Put
 => 
FLAG_PUT
,

53 
	gLockTy³
::
D–‘e
 => 
FLAG_DELETE
,

54 
	gLockTy³
::
Lock
 => 
FLAG_LOCK
,

59 #[
d”ive
(
P¬tŸlEq
, 
Debug
)]

60 
pub
 
	sLock
 {

61 
pub
 
	mlock_ty³
: 
LockTy³
,

62 
pub
 
	m´im¬y
: 
Vec
<
u8
>,

63 
pub
 
	mts
: 
u64
,

64 
pub
 
	m‰l
: 
u64
,

65 
pub
 
	mshÜt_v®ue
: 
O±iÚ
<
V®ue
>,

68 
im¶
 
	gLock
 {

69 
pub
 
â
 
Ãw
(

70 
lock_ty³
: 
LockTy³
,

71 
´im¬y
: 
Vec
<
u8
>,

72 
ts
: 
u64
,

73 
‰l
: 
u64
,

74 
shÜt_v®ue
: 
O±iÚ
<
V®ue
>,

75 è-> 
	gLock
 {

76 
	gLock
 {

77 
	glock_ty³
: 
lock_ty³
,

78 
	g´im¬y
: 
´im¬y
,

79 
	gts
: 
ts
,

80 
	g‰l
: 
‰l
,

81 
	gshÜt_v®ue
: 
shÜt_v®ue
,

85 
pub
 
â
 
to_by‹s
(&
£lf
è-> 
	gVec
<
	gu8
> {

86 
Ët
 
mut
 
	gb
 = 
Vec
::
w™h_ÿ·c™y
(

87 1 + 
MAX_VAR_U64_LEN
 + 
£lf
.
´im¬y
.
Ën
(è+ MAX_VAR_U64_LEN + 
SHORT_VALUE_MAX_LEN
 + 2,

89 
	gb
.
push
(
£lf
.
lock_ty³
.
to_u8
());

90 
	gb
.
’code_com·ù_by‹s
(&
£lf
.
´im¬y
).
unw¿p
();

91 
	gb
.
’code_v¬_u64
(
£lf
.
ts
).
unw¿p
();

92 
	gb
.
’code_v¬_u64
(
£lf
.
‰l
).
unw¿p
();

93 
Ët
 
Some
(
»f
 
v
èğ
£lf
.
shÜt_v®ue
 {

94 
b
.
push
(
SHORT_VALUE_PREFIX
);

95 
	gb
.
push
(
v
.
Ën
(è
as
 
u8
);

96 
	gb
.
ex‹nd_äom_¦iû
(
v
);

98 
	gb


101 
pub
 
â
 
·r£
(
mut
 
b
: &[
u8
]è-> 
ResuÉ
<
Lock
> {

102 
b
.
is_em±y
() {

103  
E¼
(
E¼Ü
::
BadFÜm©Lock
);

105 
Ët
 
	glock_ty³
 = 
LockTy³
::
äom_u8
(
b
.
»ad_u8
()?).
ok_Ü
(
E¼Ü
::
BadFÜm©Lock
)?;

106 
Ët
 
	g´im¬y
 = 
b
.
decode_com·ù_by‹s
()?;

107 
Ët
 
	gts
 = 
b
.
decode_v¬_u64
()?;

108 
Ët
 
	g‰l
 = 
b
.
is_em±y
(è{ 0 } { b.
decode_v¬_u64
()? };

110 
	gb
.
is_em±y
() {

111  
Ok
(
Lock
::
Ãw
(
lock_ty³
, 
´im¬y
, 
ts
, 
‰l
, 
NÚe
));

114 
Ët
 
	gæag
 = 
b
.
»ad_u8
()?;

115 
	gas£¹_eq
!(

116 
	gæag
,

117 
	gSHORT_VALUE_PREFIX
,

119 
	gæag


122 
Ët
 
	gËn
 = 
b
.
»ad_u8
()?;

123 
Ën
 
as
 
	gusize
 !ğ
b
.len() {

124 
·nic
!(

126 
Ën
,

127 
b
.
Ën
()

131 
Ok
(
Lock
::
Ãw
(
lock_ty³
, 
´im¬y
, 
ts
, 
‰l
, 
Some
(
b
.
to_vec
())))

135 #[
cfg
(
‹¡
)]

136 
mod
 
	g‹¡s
 {

137 
u£
 
	g¡Üage
::{
make_key
, 
	gMutiÚ
};

138 
u£
 
	gsu³r
::*;

140 #[
‹¡
]

141 
â
 
‹¡_lock_ty³
() {

142 
Ët
 (
key
, 
v®ue
èğ(
b
"key", 
	gb
"value");

143 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

145 
MutiÚ
::
Put
((
make_key
(
key
), 
v®ue
.
to_vec
())),

146 
LockTy³
::
Put
,

147 
FLAG_PUT
,

150 
MutiÚ
::
D–‘e
(
make_key
(
key
)),

151 
LockTy³
::
D–‘e
,

152 
FLAG_DELETE
,

154 (
MutiÚ
::
Lock
(
make_key
(
key
)), 
LockTy³
::Lock, 
FLAG_LOCK
),

156 
	gi
, (
	gmutiÚ
, 
	glock_ty³
, 
	gæag
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

157 
Ët
 
	gÉ
 = 
LockTy³
::
äom_mutiÚ
(&
mutiÚ
);

158 
	gas£¹_eq
!(

159 
	gÉ
,

160 
	glock_ty³
,

162 
	gi
,

163 
	gmutiÚ
,

164 
	glock_ty³
,

165 
	gÉ


167 
Ët
 
	gf
 = 
lock_ty³
.
to_u8
();

168 
	gas£¹_eq
!(

169 
	gf
,

170 
	gæag
,

172 
	gi
,

173 
	glock_ty³
,

174 
	gæag
,

175 
	gf


177 
Ët
 
	gÉ
 = 
LockTy³
::
äom_u8
(
æag
).
unw¿p
();

178 
	gas£¹_eq
!(

179 
	gÉ
,

180 
	glock_ty³
,

182 
	gi
,

183 
	gæag
,

184 
	glock_ty³
,

185 
	gÉ


190 #[
‹¡
]

191 
â
 
‹¡_lock
() {

193 
Ët
 
mut
 
	glocks
 = 
vec
![

194 
Lock
::
Ãw
(
LockTy³
::
Put
, 
b
"pk".
to_vec
(), 1, 10, 
NÚe
),

195 
Lock
::
Ãw
(

196 
LockTy³
::
D–‘e
,

197 
b
"pk".
to_vec
(),

200 
Some
(
b
"shÜt_v®ue".
to_vec
()),

203 
	gi
, 
	glock
è
š
 
	glocks
.
d¿š
(..).
’um”©e
() {

204 
Ët
 
	gv
 = 
lock
.
to_by‹s
();

205 
Ët
 
	gl
 = 
Lock
::
·r£
(&
v
[..]).
unw¿p_Ü_–£
(|
e
| 
·nic
!("#{}…¬£(è”r: {:?}", 
i
,ƒ));

206 
	gas£¹_eq
!(
	gl
, 
	glock
, "#{}ƒx³ù {:?}, buˆgÙ {:?}", 
	gi
,†ock,†);

210 
	gas£¹
!(
	gLock
::
·r£
(
b
"").
is_”r
());

212 
Ët
 
	glock
 = 
Lock
::
Ãw
(

213 
LockTy³
::
Lock
,

214 
b
"pk".
to_vec
(),

217 
Some
(
b
"shÜt_v®ue".
to_vec
()),

219 
Ët
 
	gv
 = 
lock
.
to_by‹s
();

220 
	gas£¹
!(
	gLock
::
·r£
(&
v
[..4]).
is_”r
());

	@src/storage/mvcc/metrics.rs

14 
u£
 
	g´om‘heus
::{
expÚ’tŸl_buck‘s
, 
	gCouÁ”Vec
, 
	gHi¡og¿m
};

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gMVCC_VERSIONS_HISTOGRAM
: 
Hi¡og¿m
 =

18 
»gi¡”_hi¡og¿m
!(

21 
	gvec
![1.0, 2.0, 3.0, 4.0, 5.0, 10.0, 50.0, 100.0,

23 ).
unw¿p
();

25 
pub
 
»f
 
	gGC_DELETE_VERSIONS_HISTOGRAM
: 
Hi¡og¿m
 =

26 
»gi¡”_hi¡og¿m
!(

29 
expÚ’tŸl_buck‘s
(1.0, 2.0, 10).
unw¿p
()

30 ).
unw¿p
();

32 
pub
 
»f
 
	gMVCC_CONFLICT_COUNTER
: 
CouÁ”Vec
 =

33 
»gi¡”_couÁ”_vec
!(

37 ).
unw¿p
();

	@src/storage/mvcc/mod.rs

14 
mod
 
	g»ad”
;

15 
mod
 
	gtxn
;

16 
mod
 
	glock
;

17 
mod
 
	gwr™e
;

18 
mod
 
	gm‘rics
;

20 
u£
 
	g¡d
::
io
;

21 
u£
 
	g¡d
::
”rÜ
;

22 
pub
 
u£
 
	g£lf
::
txn
::{
MvccTxn
, 
	gMAX_TXN_WRITE_SIZE
};

23 
pub
 
u£
 
	g£lf
::
»ad”
::
MvccR—d”
;

24 
pub
 
u£
 
	g£lf
::
lock
::{
Lock
, 
	gLockTy³
};

25 
pub
 
u£
 
	g£lf
::
wr™e
::{
Wr™e
, 
	gWr™eTy³
};

26 
u£
 
	gut
::
esÿ³
;

28 
	gquick_”rÜ
! {

29 #[
d”ive
(
Debug
)]

30 
pub
 
	eE¼Ü
 {

31 
Engše
(
”r
: ::
¡Üage
::
’gše
::
E¼Ü
) {

32 
äom
()

33 
ÿu£
(
”r
)

34 
desütiÚ
(
”r
.description())

36 
Io
(
”r
: 
io
::
E¼Ü
) {

37 
äom
()

38 
ÿu£
(
”r
)

39 
desütiÚ
(
”r
.description())

41 
Codec
(
”r
: ::
ut
::
codec
::
E¼Ü
) {

42 
äom
()

43 
ÿu£
(
”r
)

44 
desütiÚ
(
”r
.description())

46 
KeyIsLocked
 {
key
: 
Vec
<
u8
>, 
	g´im¬y
: Vec<u8>, 
	gts
: 
u64
, 
	g‰l
: u64} {

47 
desütiÚ
("key is†ocked (backoff or cleanup)")

48 
di¥Ïy
("key is†ocked (backoff or cleanup) {}-{}@{}tl {}",

49 
esÿ³
(
key
),

50 
esÿ³
(
´im¬y
),

51 
ts
,

52 
‰l
)

54 
	gBadFÜm©Lock
 {
desütiÚ
("bad format†ock data")}

55 
	gBadFÜm©Wr™e
 {
desütiÚ
("bad format write data")}

56 
	gComm™‹d
 {
	gcomm™_ts
: 
u64
} {

57 
desütiÚ
("txn‡lready committed")

58 
di¥Ïy
("txÀ®»ady comm™‹d @{}", 
comm™_ts
)

60 
	gTxnLockNÙFound
 {
	g¡¬t_ts
: 
u64
, 
	gcomm™_ts
: u64, 
	gkey
: 
Vec
<
u8
> } {

61 
desütiÚ
("txn†ock‚ot found")

62 
di¥Ïy
("txÀlock‚Ù found {}-{} key:{:?}", 
¡¬t_ts
, 
comm™_ts
, 
key
)

64 
	gWr™eCÚæiù
 { 
	g¡¬t_ts
: 
u64
, 
	gcÚæiù_ts
: u64, 
	gkey
: 
Vec
<
u8
>, 
	g´im¬y
: Vec<u8> } {

65 
desütiÚ
("write conflict")

66 
di¥Ïy
("write conflict {} with {}, key:{:?},…rimary:{:?}",

67 
¡¬t_ts
, 
cÚæiù_ts
, 
key
, 
´im¬y
)

69 
	gKeyV”siÚ
 {
desütiÚ
("bad format key(version)")}

70 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

71 
äom
()

72 
ÿu£
(
”r
.
as_»f
())

73 
desütiÚ
(
”r
.description())

74 
di¥Ïy
("{:?}", 
”r
)

79 
im¶
 
	gE¼Ü
 {

80 
pub
 
â
 
maybe_şÚe
(&
£lf
è-> 
	gO±iÚ
<
	gE¼Ü
> {

81 
m©ch
 *
	g£lf
 {

82 
	gE¼Ü
::
Engše
(
»f
 
e
è=>ƒ.
maybe_şÚe
().
m­
(
E¼Ü
::Engine),

83 
	gE¼Ü
::
Codec
(
»f
 
e
è=>ƒ.
maybe_şÚe
().
m­
(
E¼Ü
::Codec),

84 
	gE¼Ü
::
KeyIsLocked
 {

85 
»f
 
key
,

86 
»f
 
	g´im¬y
,

87 
	gts
,

88 
	g‰l
,

89 } => 
Some
(
E¼Ü
::
KeyIsLocked
 {

90 
key
: key.
şÚe
(),

91 
´im¬y
:…rim¬y.
şÚe
(),

92 
ts
:s,

93 
‰l
:tl,

95 
	gE¼Ü
::
BadFÜm©Lock
 => 
Some
(
E¼Ü
::BadFormatLock),

96 
	gE¼Ü
::
BadFÜm©Wr™e
 => 
Some
(
E¼Ü
::BadFormatWrite),

97 
	gE¼Ü
::
TxnLockNÙFound
 {

98 
¡¬t_ts
,

99 
	gcomm™_ts
,

100 
»f
 
	gkey
,

101 } => 
Some
(
E¼Ü
::
TxnLockNÙFound
 {

102 
¡¬t_ts
: start_ts,

103 
comm™_ts
: commit_ts,

104 
key
: key.
to_owÃd
(),

106 
	gE¼Ü
::
Wr™eCÚæiù
 {

107 
¡¬t_ts
,

108 
	gcÚæiù_ts
,

109 
»f
 
	gkey
,

110 
»f
 
	g´im¬y
,

111 } => 
Some
(
E¼Ü
::
Wr™eCÚæiù
 {

112 
¡¬t_ts
: start_ts,

113 
cÚæiù_ts
: conflict_ts,

114 
key
: key.
to_owÃd
(),

115 
´im¬y
:…rim¬y.
to_owÃd
(),

117 
	gE¼Ü
::
KeyV”siÚ
 => 
Some
(
E¼Ü
::KeyVersion),

118 
	gE¼Ü
::
Comm™‹d
 { 
comm™_ts
 } => 
Some
(
E¼Ü
::Committed {

119 
comm™_ts
: commit_ts,

121 
	gE¼Ü
::
Io
(
_
è| 
E¼Ü
::
Oth”
(_è=> 
NÚe
,

126 
pub
 
ty³
 
	gResuÉ
<
	gT
> = ::
¡d
::
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

	@src/storage/mvcc/reader.rs

14 
u£
 
	g¡Üage
::
’gše
::{
CursÜ
, 
	gSÿnMode
, 
	gSÇpshÙ
, 
	gSti¡ics
};

15 
u£
 
	g¡Üage
::{
Key
, 
	gV®ue
, 
	gCF_LOCK
, 
	gCF_WRITE
};

16 
u£
 
	gsu³r
::{
E¼Ü
, 
	gResuÉ
};

17 
u£
 
	gsu³r
::
lock
::
Lock
;

18 
u£
 
	gsu³r
::
wr™e
::{
Wr™e
, 
	gWr™eTy³
};

19 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::
I‹rO±iÚ
;

20 
u£
 
	g¡d
::
u64
;

21 
u£
 
	gkv´Ùo
::
kv½ıb
::
IsŞ©iÚLev–
;

22 
u£
 
	gut
::
´İ”t›s
::
MvccPrİ”t›s
;

24 cÚ¡ 
	gGC_MAX_ROW_VERSIONS_THRESHOLD
: 
u64
 = 100;

26 
pub
 
	sMvccR—d”
 {

27 
	m¢­shÙ
: 
Box
<
SÇpshÙ
>,

28 
	m¡©i¡ics
: 
Sti¡ics
,

30 
	md©a_cursÜ
: 
O±iÚ
<
CursÜ
>,

31 
	mlock_cursÜ
: 
O±iÚ
<
CursÜ
>,

32 
	mwr™e_cursÜ
: 
O±iÚ
<
CursÜ
>,

34 
	msÿn_mode
: 
O±iÚ
<
SÿnMode
>,

35 
	mkey_Úly
: 
boŞ
,

37 
	mfl_ÿche
: 
boŞ
,

38 
	muµ”_bound
: 
O±iÚ
<
Vec
<
u8
>>,

39 
	misŞ©iÚ_Ëv–
: 
IsŞ©iÚLev–
,

42 
im¶
 
	gMvccR—d”
 {

43 
pub
 
â
 
Ãw
(

44 
¢­shÙ
: 
Box
<
SÇpshÙ
>,

45 
sÿn_mode
: 
O±iÚ
<
SÿnMode
>,

46 
fl_ÿche
: 
boŞ
,

47 
uµ”_bound
: 
O±iÚ
<
Vec
<
u8
>>,

48 
isŞ©iÚ_Ëv–
: 
IsŞ©iÚLev–
,

49 è-> 
	gMvccR—d”
 {

50 
	gMvccR—d”
 {

51 
	g¢­shÙ
: 
¢­shÙ
,

52 
	g¡©i¡ics
: 
Sti¡ics
::(),

53 
	gd©a_cursÜ
: 
NÚe
,

54 
	glock_cursÜ
: 
NÚe
,

55 
	gwr™e_cursÜ
: 
NÚe
,

56 
	gsÿn_mode
: 
sÿn_mode
,

57 
	gisŞ©iÚ_Ëv–
: 
isŞ©iÚ_Ëv–
,

58 
	gkey_Úly
: 
çl£
,

59 
	gfl_ÿche
: 
fl_ÿche
,

60 
	guµ”_bound
: 
uµ”_bound
,

64 
pub
 
â
 
g‘_¡©i¡ics
(&
£lf
è-> &
	gSti¡ics
 {

65 &
	g£lf
.
	g¡©i¡ics


68 
pub
 
â
 
£t_key_Úly
(&
mut
 
£lf
, 
key_Úly
: 
boŞ
) {

69 
£lf
.
key_Úly
 = key_only;

72 
pub
 
â
 
lßd_d©a
(&
mut
 
£lf
, 
key
: &
Key
, 
ts
: 
u64
è-> 
ResuÉ
<
V®ue
> {

73 
£lf
.
key_Úly
 {

74  
Ok
(
vec
![]);

76 
	g£lf
.
	gsÿn_mode
.
is_some
(è&& s–f.
	gd©a_cursÜ
.
is_nÚe
() {

77 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
NÚe
, 
£lf
.
fl_ÿche
);

78 
	g£lf
.
	gd©a_cursÜ
 = 
Some
(
£lf
.
¢­shÙ
.
™”
(
™”_İt
, s–f.
g‘_sÿn_mode
(
Œue
))?);

81 
Ët
 
	gk
 = 
key
.
­³nd_ts
(
ts
);

82 
Ët
 
	g»s
 = Ëˆ
Some
(
»f
 
mut
 
cursÜ
èğ
£lf
.
d©a_cursÜ
 {

83 
m©ch
 
cursÜ
.
g‘
(&
k
, &
mut
 
£lf
.
¡©i¡ics
.
d©a
)? {

84 
NÚe
 => 
·nic
!("key {}‚Ù found, {}", 
	gkey
, 
	gts
),

85 
Some
(
v
è=> v.
to_vec
(),

88 
	g£lf
.
	g¡©i¡ics
.
	gd©a
.
	gg‘
 += 1;

89 
m©ch
 
	g£lf
.
	g¢­shÙ
.
g‘
(&
k
)? {

90 
	gNÚe
 => 
·nic
!("key {}‚Ù found,s: {}", 
	gkey
, 
	gts
),

91 
Some
(
v
) => v,

95 
	g£lf
.
	g¡©i¡ics
.
	gd©a
.
	g´oûs£d
 += 1;

96 
	g£lf
.
	g¡©i¡ics
.
	gd©a
.
	gæow_¡©s
.
	g»ad_by‹s
 +ğ
k
.
¿w
().
unw¿p_Ü_deçuÉ
().
Ën
(è+ 
»s
.len();

97 
	g£lf
.
	g¡©i¡ics
.
	gd©a
.
	gæow_¡©s
.
	g»ad_keys
 += 1;

98 
Ok
(
»s
)

101 
pub
 
â
 
lßd_lock
(&
mut
 
£lf
, 
key
: &
Key
è-> 
ResuÉ
<
O±iÚ
<
Lock
>> {

102 
£lf
.
sÿn_mode
.
is_some
(è&& s–f.
lock_cursÜ
.
is_nÚe
() {

103 
Ët
 
™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
NÚe
, 
Œue
);

104 
Ët
 
	g™”
 = 
£lf
.
¢­shÙ


105 .
™”_cf
(
CF_LOCK
, 
™”_İt
, 
£lf
.
g‘_sÿn_mode
(
Œue
))?;

106 
	g£lf
.
	glock_cursÜ
 = 
Some
(
™”
);

109 
Ët
 
	g»s
 = Ëˆ
Some
(
»f
 
mut
 
cursÜ
èğ
£lf
.
lock_cursÜ
 {

110 
m©ch
 
cursÜ
.
g‘
(
key
, &
mut
 
£lf
.
¡©i¡ics
.
lock
)? {

111 
Some
(
v
è=> Some(
Lock
::
·r£
(v)?),

112 
	gNÚe
 => 
NÚe
,

115 
	g£lf
.
	g¡©i¡ics
.
	glock
.
	gg‘
 += 1;

116 
m©ch
 
	g£lf
.
	g¢­shÙ
.
g‘_cf
(
CF_LOCK
, 
key
)? {

117 
Some
(
v
è=> Some(
Lock
::
·r£
(&v)?),

118 
	gNÚe
 => 
NÚe
,

122 
	g»s
.
is_some
() {

123 
	g£lf
.
	g¡©i¡ics
.
	glock
.
	g´oûs£d
 += 1;

126 
Ok
(
»s
)

129 
â
 
g‘_sÿn_mode
(&
£lf
, 
®low_backw¬d
: 
boŞ
è-> 
SÿnMode
 {

130 
m©ch
 
£lf
.
sÿn_mode
 {

131 
Some
(
SÿnMode
::
FÜw¬d
) => ScanMode::Forward,

132 
Some
(
SÿnMode
::
Backw¬d
è
®low_backw¬d
 => ScanMode::Backward,

133 
	g_
 => 
SÿnMode
::
Mixed
,

137 
pub
 
â
 
£ek_wr™e
(&
mut
 
£lf
, 
key
: &
Key
, 
ts
: 
u64
è-> 
ResuÉ
<
O±iÚ
<(u64, 
	gWr™e
)>> {

138 
	g£lf
.
£ek_wr™e_im¶
(
key
, 
ts
, 
çl£
)

141 
pub
 
â
 
»v”£_£ek_wr™e
(&
mut
 
£lf
, 
key
: &
Key
, 
ts
: 
u64
è-> 
ResuÉ
<
O±iÚ
<(u64, 
	gWr™e
)>> {

142 
	g£lf
.
£ek_wr™e_im¶
(
key
, 
ts
, 
Œue
)

145 
â
 
£ek_wr™e_im¶
(

146 &
mut
 
£lf
,

147 
key
: &
Key
,

148 
ts
: 
u64
,

149 
»v”£
: 
boŞ
,

150 è-> 
	gResuÉ
<
	gO±iÚ
<(
	gu64
, 
	gWr™e
)>> {

151 
	g£lf
.
	gsÿn_mode
.
is_some
() {

152 
	g£lf
.
	gwr™e_cursÜ
.
is_nÚe
() {

153 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
NÚe
, 
£lf
.
fl_ÿche
);

154 
Ët
 
	g™”
 = 
£lf
.
¢­shÙ


155 .
™”_cf
(
CF_WRITE
, 
™”_İt
, 
£lf
.
g‘_sÿn_mode
(
çl£
))?;

156 
	g£lf
.
	gwr™e_cursÜ
 = 
Some
(
™”
);

160 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::()

161 .
u£_´efix_£ek
()

162 .
£t_´efix_§me_as_¡¬t
(
Œue
);

163 
Ët
 
	g™”
 = 
£lf
.
¢­shÙ
.
™”_cf
(
CF_WRITE
, 
™”_İt
, 
SÿnMode
::
Mixed
)?;

164 
	g£lf
.
	gwr™e_cursÜ
 = 
Some
(
™”
);

167 
Ët
 
	gcursÜ
 = 
£lf
.
wr™e_cursÜ
.
as_mut
().
unw¿p
();

168 
Ët
 
	gok
 = 
»v”£
 {

169 
cursÜ


170 .
Ã¬_£ek_fÜ_´ev
(&
key
.
­³nd_ts
(
ts
), &
mut
 
£lf
.
¡©i¡ics
.
wr™e
)?

172 
cursÜ


173 .
Ã¬_£ek
(&
key
.
­³nd_ts
(
ts
), &
mut
 
£lf
.
¡©i¡ics
.
wr™e
)?

175 !
	gok
 {

176  
Ok
(
NÚe
);

178 
Ët
 
	gwr™e_key
 = 
Key
::
äom_’coded
(
cursÜ
.
key
().
to_vec
());

179 
Ët
 
	gcomm™_ts
 = 
wr™e_key
.
decode_ts
()?;

180 
Ët
 
	gk
 = 
wr™e_key
.
Œunÿ‹_ts
()?;

181 &
	gk
 !ğ
key
 {

182  
Ok
(
NÚe
);

184 
Ët
 
	gwr™e
 = 
Wr™e
::
·r£
(
cursÜ
.
v®ue
())?;

185 
	g£lf
.
	g¡©i¡ics
.
	gwr™e
.
	g´oûs£d
 += 1;

186 
	g£lf
.
	g¡©i¡ics
.
	gwr™e
.
	gæow_¡©s
.
	g»ad_by‹s
 +ğ
cursÜ
.
key
().
Ën
(è+ cursÜ.
v®ue
().len();

187 
	g£lf
.
	g¡©i¡ics
.
	gwr™e
.
	gæow_¡©s
.
	g»ad_keys
 += 1;

188 
Ok
(
Some
((
comm™_ts
, 
wr™e
)))

191 
â
 
check_lock
(&
mut
 
£lf
, 
key
: &
Key
, muˆ
ts
: 
u64
è-> 
ResuÉ
<
O±iÚ
<u64>> {

192 
Ët
 
Some
(
lock
èğ
£lf
.
lßd_lock
(
key
)? {

193 
lock
.
ts
 <=s {

194 
ts
 =ğ
u64
::
MAX
 && 
key
.
¿w
()? =ğ
lock
.
´im¬y
 {

198 
ts
 = 
lock
.ts - 1;

201  
E¼
(
E¼Ü
::
KeyIsLocked
 {

202 
key
: key.
¿w
()?,

203 
´im¬y
: 
lock
.primary,

204 
ts
: 
lock
.ts,

205 
‰l
: 
lock
.ttl,

210 
Ok
(
Some
(
ts
))

213 
pub
 
â
 
g‘
(&
mut
 
£lf
, 
key
: &
Key
, muˆ
ts
: 
u64
è-> 
ResuÉ
<
O±iÚ
<
V®ue
>> {

215 
m©ch
 
£lf
.
isŞ©iÚ_Ëv–
 {

216 
IsŞ©iÚLev–
::
SI
 => 
Ët
 
Some
(
Ãw_ts
èğ
£lf
.
check_lock
(
key
, 
ts
)? {

217 
	gts
 = 
Ãw_ts
;

219 
	gIsŞ©iÚLev–
::
RC
 => {}

221 
loİ
 {

222 
m©ch
 
£lf
.
£ek_wr™e
(
key
, 
ts
)? {

223 
Some
((
comm™_ts
, 
mut
 
wr™e
)è=> 
m©ch
 wr™e.
wr™e_ty³
 {

224 
Wr™eTy³
::
Put
 => {

225 
wr™e
.
shÜt_v®ue
.
is_some
() {

226 
£lf
.
key_Úly
 {

227  
Ok
(
Some
(
vec
![]));

229  
Ok
(
wr™e
.
shÜt_v®ue
.
ke
());

231  
	g£lf
.
lßd_d©a
(
key
, 
wr™e
.
¡¬t_ts
).
m­
(
Some
);

233 
	gWr™eTy³
::
D–‘e
 => {

234  
Ok
(
NÚe
);

236 
	gWr™eTy³
::
Lock
 | 
Wr™eTy³
::
RŞlback
 => 
ts
 = 
comm™_ts
 - 1,

238 
	gNÚe
 =>  
Ok
(
NÚe
),

243 
pub
 
â
 
g‘_txn_comm™_šfo
(

244 &
mut
 
£lf
,

245 
key
: &
Key
,

246 
¡¬t_ts
: 
u64
,

247 è-> 
	gResuÉ
<
	gO±iÚ
<(
	gu64
, 
	gWr™eTy³
)>> {

248 
Ët
 
mut
 
	g£ek_ts
 = 
¡¬t_ts
;

249 
Ët
 
Some
((
comm™_ts
, 
wr™e
)èğ
£lf
.
»v”£_£ek_wr™e
(
key
, 
£ek_ts
)? {

250 
	gwr™e
.
	g¡¬t_ts
 =ğ
¡¬t_ts
 {

251  
Ok
(
Some
((
comm™_ts
, 
wr™e
.
wr™e_ty³
)));

253 
	g£ek_ts
 = 
comm™_ts
 + 1;

255 
Ok
(
NÚe
)

258 
â
 
ü—‹_d©a_cursÜ
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

259 
	g£lf
.
	gsÿn_mode
 = 
Some
(
SÿnMode
::
FÜw¬d
);

260 
	g£lf
.
	gd©a_cursÜ
.
is_nÚe
() {

261 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
NÚe
, 
£lf
.
fl_ÿche
);

262 
Ët
 
	g™”
 = 
£lf
.
¢­shÙ
.
™”
(
™”_İt
, s–f.
g‘_sÿn_mode
(
Œue
))?;

263 
	g£lf
.
	gd©a_cursÜ
 = 
Some
(
™”
);

265 
Ok
(())

268 
â
 
ü—‹_wr™e_cursÜ
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

269 
	g£lf
.
	gwr™e_cursÜ
.
is_nÚe
() {

270 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
£lf
.
uµ”_bound
.
as_»f
().
şÚed
(), s–f.
fl_ÿche
);

271 
Ët
 
	g™”
 = 
£lf
.
¢­shÙ


272 .
™”_cf
(
CF_WRITE
, 
™”_İt
, 
£lf
.
g‘_sÿn_mode
(
çl£
))?;

273 
	g£lf
.
	gwr™e_cursÜ
 = 
Some
(
™”
);

275 
Ok
(())

278 
â
 
ü—‹_lock_cursÜ
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

279 
	g£lf
.
	glock_cursÜ
.
is_nÚe
() {

280 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
£lf
.
uµ”_bound
.
as_»f
().
şÚed
(), 
Œue
);

281 
Ët
 
	g™”
 = 
£lf
.
¢­shÙ


282 .
™”_cf
(
CF_LOCK
, 
™”_İt
, 
£lf
.
g‘_sÿn_mode
(
Œue
))?;

283 
	g£lf
.
	glock_cursÜ
 = 
Some
(
™”
);

285 
Ok
(())

289 
pub
 
â
 
£ek_ts
(&
mut
 
£lf
, 
ts
: 
u64
è-> 
ResuÉ
<
O±iÚ
<
Key
>> {

290 
as£¹
!(
£lf
.
sÿn_mode
.
is_some
());

291 
	g£lf
.
ü—‹_wr™e_cursÜ
()?;

293 
Ët
 
	gcursÜ
 = 
£lf
.
wr™e_cursÜ
.
as_mut
().
unw¿p
();

294 
Ët
 
mut
 
	gok
 = 
cursÜ
.
£ek_to_fœ¡
(&muˆ
£lf
.
¡©i¡ics
.
wr™e
);

296 
	gok
 {

297 
	gWr™e
::
·r£
(
cursÜ
.
v®ue
())?.
¡¬t_ts
 =ğ
ts
 {

298  
Ok
(
Some
(

299 
Key
::
äom_’coded
(
cursÜ
.
key
().
to_vec
()).
Œunÿ‹_ts
()?,

302 
	gok
 = 
cursÜ
.
Ãxt
(&
mut
 
£lf
.
¡©i¡ics
.
wr™e
);

304 
Ok
(
NÚe
)

307 
pub
 
â
 
£ek
(&
mut
 
£lf
, muˆ
key
: 
Key
, 
ts
: 
u64
è-> 
ResuÉ
<
O±iÚ
<(Key, 
	gV®ue
)>> {

308 
	gas£¹
!(
	g£lf
.
	gsÿn_mode
.
is_some
());

309 
	g£lf
.
ü—‹_wr™e_cursÜ
()?;

310 
	g£lf
.
ü—‹_lock_cursÜ
()?;

312 
Ët
 (
mut
 
wr™e_v®id
, muˆ
lock_v®id
èğ(
Œue
, 
	gŒue
);

314 
	gloİ
 {

315 
	gkey
 = {

316 
Ët
 
w_cur
 = 
£lf
.
wr™e_cursÜ
.
as_mut
().
unw¿p
();

317 
Ët
 
	gl_cur
 = 
£lf
.
lock_cursÜ
.
as_mut
().
unw¿p
();

318 
Ët
 (
mut
 
w_key
, muˆ
l_key
èğ(
NÚe
, 
	gNÚe
);

319 
	gwr™e_v®id
 {

320 
	gw_cur
.
Ã¬_£ek
(&
key
, &
mut
 
£lf
.
¡©i¡ics
.
wr™e
)? {

321 
	gw_key
 = 
Some
(
w_cur
.
key
());

323 
	gw_key
 = 
NÚe
;

324 
	gwr™e_v®id
 = 
çl£
;

327 
	glock_v®id
 {

328 
	gl_cur
.
Ã¬_£ek
(&
key
, &
mut
 
£lf
.
¡©i¡ics
.
lock
)? {

329 
	gl_key
 = 
Some
(
l_cur
.
key
());

331 
	gl_key
 = 
NÚe
;

332 
	glock_v®id
 = 
çl£
;

335 
m©ch
 (
w_key
, 
l_key
) {

336 (
	gNÚe
, NÚeè=>  
Ok
(
NÚe
),

337 (
	gNÚe
, 
Some
(
k
)è=> 
Key
::
äom_’coded
(k.
to_vec
()),

338 (
Some
(
k
), 
	gNÚe
è=> 
Key
::
äom_’coded
(k.
to_vec
()).
Œunÿ‹_ts
()?,

339 (
Some
(
wk
), Some(
lk
)) => wk <†k {

340 
Key
::
äom_’coded
(
wk
.
to_vec
()).
Œunÿ‹_ts
()?

342 
Key
::
äom_’coded
(
lk
.
to_vec
())

346 
Ët
 
Some
(
v
èğ
£lf
.
g‘
(&
key
, 
ts
)? {

347  
Ok
(
Some
((
key
, 
v
)));

349 
	gkey
 = 
key
.
­³nd_ts
(0);

353 
pub
 
â
 
»v”£_£ek
(&
mut
 
£lf
, muˆ
key
: 
Key
, 
ts
: 
u64
è-> 
ResuÉ
<
O±iÚ
<(Key, 
	gV®ue
)>> {

354 
	gas£¹
!(
	g£lf
.
	gsÿn_mode
.
is_some
());

355 
	g£lf
.
ü—‹_wr™e_cursÜ
()?;

356 
	g£lf
.
ü—‹_lock_cursÜ
()?;

358 
Ët
 (
mut
 
wr™e_v®id
, muˆ
lock_v®id
èğ(
Œue
, 
	gŒue
);

360 
	gloİ
 {

361 
	gkey
 = {

362 
Ët
 
w_cur
 = 
£lf
.
wr™e_cursÜ
.
as_mut
().
unw¿p
();

363 
Ët
 
	gl_cur
 = 
£lf
.
lock_cursÜ
.
as_mut
().
unw¿p
();

364 
Ët
 (
mut
 
w_key
, muˆ
l_key
èğ(
NÚe
, 
	gNÚe
);

365 
	gwr™e_v®id
 {

366 
	gw_cur
.
Ã¬_»v”£_£ek
(&
key
, &
mut
 
£lf
.
¡©i¡ics
.
wr™e
)? {

367 
	gw_key
 = 
Some
(
w_cur
.
key
());

369 
	gw_key
 = 
NÚe
;

370 
	gwr™e_v®id
 = 
çl£
;

373 
	glock_v®id
 {

374 
	gl_cur
.
Ã¬_»v”£_£ek
(&
key
, &
mut
 
£lf
.
¡©i¡ics
.
lock
)? {

375 
	gl_key
 = 
Some
(
l_cur
.
key
());

377 
	gl_key
 = 
NÚe
;

378 
	glock_v®id
 = 
çl£
;

381 
m©ch
 (
w_key
, 
l_key
) {

382 (
	gNÚe
, NÚeè=>  
Ok
(
NÚe
),

383 (
	gNÚe
, 
Some
(
k
)è=> 
Key
::
äom_’coded
(k.
to_vec
()),

384 (
Some
(
k
), 
	gNÚe
è=> 
Key
::
äom_’coded
(k.
to_vec
()).
Œunÿ‹_ts
()?,

385 (
Some
(
wk
), Some(
lk
)) => wk <†k {

386 
Key
::
äom_’coded
(
lk
.
to_vec
())

388 
Key
::
äom_’coded
(
wk
.
to_vec
()).
Œunÿ‹_ts
()?

392 
Ët
 
Some
(
v
èğ
£lf
.
g‘
(&
key
, 
ts
)? {

393  
Ok
(
Some
((
key
, 
v
)));

398 #[
®low
(
ty³_com¶ex™y
)]

399 
pub
 
â
 
	gsÿn_lock
<
	gF
>(

400 &
mut
 
	g£lf
,

401 
	g¡¬t
: 
O±iÚ
<
Key
>,

402 
	gf‹r
: 
F
,

403 
	glim™
: 
O±iÚ
<
usize
>,

404 è-> 
	gResuÉ
<(
	gVec
<(
	gKey
, 
	gLock
)>, 
	gO±iÚ
<Key>)>

405 
wh”e


406 
	gF
: 
Fn
(&
Lock
è-> 
boŞ
,

408 
	g£lf
.
ü—‹_lock_cursÜ
()?;

409 
Ët
 
	gcursÜ
 = 
£lf
.
lock_cursÜ
.
as_mut
().
unw¿p
();

410 
Ët
 
	gok
 = 
m©ch
 
¡¬t
 {

411 
Some
(
»f
 
x
è=> 
cursÜ
.
£ek
(x, &
mut
 
£lf
.
¡©i¡ics
.
lock
)?,

412 
	gNÚe
 => 
cursÜ
.
£ek_to_fœ¡
(&
mut
 
£lf
.
¡©i¡ics
.
lock
),

414 !
	gok
 {

415  
Ok
((
vec
![], 
NÚe
));

417 
Ët
 
mut
 
	glocks
 = 
vec
![];

418 
	gcursÜ
.
v®id
() {

419 
Ët
 
	gkey
 = 
Key
::
äom_’coded
(
cursÜ
.
key
().
to_vec
());

420 
Ët
 
	glock
 = 
Lock
::
·r£
(
cursÜ
.
v®ue
())?;

421 
f‹r
(&
lock
) {

422 
	glocks
.
push
((
key
.
şÚe
(), 
lock
));

423 
Ët
 
Some
(
lim™
) =†imit {

424 
locks
.
Ën
(è>ğ
lim™
 {

425  
Ok
((
locks
, 
Some
(
key
)));

429 
	gcursÜ
.
Ãxt
(&
mut
 
£lf
.
¡©i¡ics
.
lock
);

431 
	g£lf
.
	g¡©i¡ics
.
	glock
.
	g´oûs£d
 +ğ
locks
.
Ën
();

432 
Ok
((
locks
, 
NÚe
))

435 
pub
 
â
 
sÿn_keys
(

436 &
mut
 
£lf
,

437 
mut
 
¡¬t
: 
O±iÚ
<
Key
>,

438 
lim™
: 
usize
,

439 è-> 
	gResuÉ
<(
	gVec
<
	gKey
>, 
	gO±iÚ
<Key>)> {

440 
Ët
 
	g™”_İt
 = 
I‹rO±iÚ
::
Ãw
(
NÚe
, 
£lf
.
fl_ÿche
);

441 
Ët
 
	gsÿn_mode
 = 
£lf
.
g‘_sÿn_mode
(
çl£
);

442 
Ët
 
mut
 
	gcursÜ
 = 
£lf
.
¢­shÙ
.
™”_cf
(
CF_WRITE
, 
™”_İt
, 
sÿn_mode
)?;

443 
Ët
 
mut
 
	gkeys
 = 
vec
![];

444 
	gloİ
 {

445 
Ët
 
	gok
 = 
m©ch
 
¡¬t
 {

446 
Some
(
»f
 
x
è=> 
cursÜ
.
Ã¬_£ek
(x, &
mut
 
£lf
.
¡©i¡ics
.
wr™e
)?,

447 
	gNÚe
 => 
cursÜ
.
£ek_to_fœ¡
(&
mut
 
£lf
.
¡©i¡ics
.
wr™e
),

449 !
	gok
 {

450  
Ok
((
keys
, 
NÚe
));

452 
	gkeys
.
Ën
(è>ğ
lim™
 {

453 
£lf
.
¡©i¡ics
.
wr™e
.
´oûs£d
 +ğ
keys
.
Ën
();

454  
Ok
((
keys
, 
¡¬t
));

456 
Ët
 
	gkey
 = 
Key
::
äom_’coded
(
cursÜ
.
key
().
to_vec
()).
Œunÿ‹_ts
()?;

457 
	g¡¬t
 = 
Some
(
key
.
­³nd_ts
(0));

458 
	gkeys
.
push
(
key
);

463 
pub
 
â
 
sÿn_v®ues_š_deçuÉ
(&
mut
 
£lf
, 
key
: &
Key
è-> 
ResuÉ
<
Vec
<(
u64
, 
	gV®ue
)>> {

464 
	g£lf
.
ü—‹_d©a_cursÜ
()?;

465 
Ët
 
	gcursÜ
 = 
£lf
.
d©a_cursÜ
.
as_mut
().
unw¿p
();

466 
Ët
 
mut
 
	gok
 = 
cursÜ
.
£ek
(
key
, &muˆ
£lf
.
¡©i¡ics
.
d©a
)?;

467 !
	gok
 {

468  
Ok
(
vec
![]);

470 
Ët
 
mut
 
	gv
 = 
vec
![];

471 
	gok
 {

472 
Ët
 
	gcur_key
 = 
Key
::
äom_’coded
(
cursÜ
.
key
().
to_vec
());

473 
Ët
 
	gcur_key_w™hout_ts
 = 
cur_key
.
Œunÿ‹_ts
()?;

474 
	gcur_key_w™hout_ts
.
’coded
().
as_¦iû
(è=ğ
key
.encoded().as_slice() {

475 
v
.
push
((
cur_key
.
decode_ts
()?, 
cursÜ
.
v®ue
().
to_vec
()));

477 
	gcur_key_w™hout_ts
.
’coded
().
as_¦iû
(è!ğ
key
.encoded().as_slice() {

480 
	gok
 = 
cursÜ
.
Ãxt
(&
mut
 
£lf
.
¡©i¡ics
.
d©a
);

482 
Ok
(
v
)

487 
pub
 
â
 
Ãed_gc
(&
£lf
, 
§ã_pošt
: 
u64
, 
¿tio_th»shŞd
: 
f64
è-> 
boŞ
 {

489 
¿tio_th»shŞd
 < 1.0 {

490  
Œue
;

493 
Ët
 
	g´İs
 = 
m©ch
 
£lf
.
g‘_mvcc_´İ”t›s
(
§ã_pošt
) {

494 
Some
(
v
) => v,

495 
	gNÚe
 =>  
Œue
,

499 
	g´İs
.
	gmš_ts
 > 
	g§ã_pošt
 {

500  
	gçl£
;

507 
	g´İs
.
num_v”siÚs
 
as
 
	gf64
 >…rİs.
num_rows
‡ 
f64
 * 
	g¿tio_th»shŞd
 {

508  
	gŒue
;

511 
	g´İs
.
num_v”siÚs
 
as
 
	gf64
 >…rİs.
num_puts
‡ 
f64
 * 
	g¿tio_th»shŞd
 {

512  
	gŒue
;

516 
	g´İs
.
	gmax_row_v”siÚs
 > 
	gGC_MAX_ROW_VERSIONS_THRESHOLD


519 
â
 
g‘_mvcc_´İ”t›s
(&
£lf
, 
§ã_pošt
: 
u64
è-> 
O±iÚ
<
MvccPrİ”t›s
> {

520 
Ët
 
cŞËùiÚ
 = 
m©ch
 
£lf
.
¢­shÙ
.
g‘_´İ”t›s_cf
(
CF_WRITE
) {

521 
Ok
(
v
) => v,

522 
E¼
(
_
è=>  
NÚe
,

524 
	gcŞËùiÚ
.
is_em±y
() {

525  
	gNÚe
;

528 
Ët
 
mut
 
	g´İs
 = 
MvccPrİ”t›s
::
Ãw
();

529 
	g_
, 
	gv
è
	gš
 &*
	gcŞËùiÚ
 {

530 
Ët
 
	gmvcc
 = 
m©ch
 
MvccPrİ”t›s
::
decode
(
v
.
u£r_cŞËùed_´İ”t›s
()) {

531 
Ok
(
v
) => v,

532 
E¼
(
_
è=>  
NÚe
,

535 
	gmvcc
.
	gmš_ts
 > 
	g§ã_pošt
 {

538 
	g´İs
.
add
(&
mvcc
);

540 
Some
(
´İs
)

544 #[
cfg
(
‹¡
)]

545 
mod
 
	g‹¡s
 {

546 
u£
 
	g¡d
::
u64
;

547 
u£
 
	gkv´Ùo
::
m‘­b
::{
P“r
, 
	gRegiÚ
};

548 
u£
 
	gkv´Ùo
::
kv½ıb
::
IsŞ©iÚLev–
;

549 
u£
 
	grocksdb
::{
£lf
, 
	gWr™abË
, 
	gWr™eB©ch
, 
	gDB
};

550 
u£
 
	g¡d
::
sync
::
Arc
;

551 
u£
 
	g¡Üage
::{
make_key
, 
	gMutiÚ
, 
	gO±iÚs
, 
	gALL_CFS
, 
	gCF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_RAFT
, 
	gCF_WRITE
};

552 
u£
 
	g¡Üage
::
’gše
::
Modify
;

553 
u£
 
	g¡Üage
::
mvcc
::{
MvccR—d”
, 
	gMvccTxn
};

554 
u£
 
	g‹mpdœ
::
TempDœ
;

555 
u£
 
	g¿á¡Üe
::
cİroûssÜ
::
RegiÚSÇpshÙ
;

556 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
;

557 
u£
 
	gut
::
rocksdb
::{
£lf
 
as
 
rocksdb_ut
, 
	gCFO±iÚs
};

558 
u£
 
	gut
::
´İ”t›s
::{
MvccPrİ”t›s
, 
	gMvccPrİ”t›sCŞËùÜFaùÜy
};

560 
	sRegiÚEngše
 {

561 
	gdb
: 
Arc
<
DB
>,

562 
	g»giÚ
: 
RegiÚ
,

565 
im¶
 
	gRegiÚEngše
 {

566 
pub
 
â
 
Ãw
(
db
: 
Arc
<
DB
>, 
»giÚ
: 
RegiÚ
è-> 
RegiÚEngše
 {

567 
RegiÚEngše
 {

568 
db
: db.
şÚe
(),

569 
	g»giÚ
: 
»giÚ
,

573 
pub
 
â
 
put
(&
mut
 
£lf
, 
pk
: &[
u8
], 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

574 
Ët
 
m
 = 
MutiÚ
::
Put
((
make_key
(
pk
), 
vec
![]));

575 
	g£lf
.
´ewr™e
(
m
, 
pk
, 
¡¬t_ts
);

576 
	g£lf
.
comm™
(
pk
, 
¡¬t_ts
, 
comm™_ts
);

579 
pub
 
â
 
lock
(&
mut
 
£lf
, 
pk
: &[
u8
], 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

580 
Ët
 
m
 = 
MutiÚ
::
Lock
(
make_key
(
pk
));

581 
	g£lf
.
´ewr™e
(
m
, 
pk
, 
¡¬t_ts
);

582 
	g£lf
.
comm™
(
pk
, 
¡¬t_ts
, 
comm™_ts
);

585 
pub
 
â
 
d–‘e
(&
mut
 
£lf
, 
pk
: &[
u8
], 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

586 
Ët
 
m
 = 
MutiÚ
::
D–‘e
(
make_key
(
pk
));

587 
	g£lf
.
´ewr™e
(
m
, 
pk
, 
¡¬t_ts
);

588 
	g£lf
.
comm™
(
pk
, 
¡¬t_ts
, 
comm™_ts
);

591 
â
 
´ewr™e
(&
mut
 
£lf
, 
m
: 
MutiÚ
, 
pk
: &[
u8
], 
¡¬t_ts
: 
u64
) {

592 
Ët
 
¢­
 = 
RegiÚSÇpshÙ
::
äom_¿w
(
£lf
.
db
.
şÚe
(), s–f.
»giÚ
.clone());

593 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
Box
::Ãw(
¢­
), 
¡¬t_ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

594 
	gtxn
.
´ewr™e
(
m
, 
pk
, &
O±iÚs
::()).
unw¿p
();

596 
	g£lf
.
wr™e
(
txn
.
što_modif›s
());

599 
â
 
comm™
(&
mut
 
£lf
, 
pk
: &[
u8
], 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

600 
Ët
 
k
 = 
make_key
(
pk
);

601 
Ët
 
	g¢­
 = 
RegiÚSÇpshÙ
::
äom_¿w
(
£lf
.
db
.
şÚe
(), s–f.
»giÚ
.clone());

602 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
Box
::Ãw(
¢­
), 
¡¬t_ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

603 
	gtxn
.
comm™
(&
k
, 
comm™_ts
).
unw¿p
();

604 
	g£lf
.
wr™e
(
txn
.
što_modif›s
());

607 
â
 
gc
(&
mut
 
£lf
, 
pk
: &[
u8
], 
§ã_pošt
: 
u64
) {

608 
Ët
 
k
 = 
make_key
(
pk
);

609 
Ët
 
	g¢­
 = 
RegiÚSÇpshÙ
::
äom_¿w
(
£lf
.
db
.
şÚe
(), s–f.
»giÚ
.clone());

610 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
Box
::Ãw(
¢­
), 
§ã_pošt
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

611 
	gtxn
.
gc
(&
k
, 
§ã_pošt
).
unw¿p
();

612 
	g£lf
.
wr™e
(
txn
.
što_modif›s
());

615 
â
 
wr™e
(&
mut
 
£lf
, 
modif›s
: 
Vec
<
Modify
>) {

616 
Ët
 
db
 = &
£lf
.db;

617 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

618 
»v
 
š
 
	gmodif›s
 {

619 
m©ch
 
	g»v
 {

620 
	gModify
::
Put
(
cf
, 
k
, 
v
) => {

621 
Ët
 
k
 = 
keys
::
d©a_key
(k.
’coded
());

622 
Ët
 
	ghªdË
 = 
rocksdb_ut
::
g‘_cf_hªdË
(
db
, 
cf
).
unw¿p
();

623 
	gwb
.
put_cf
(
hªdË
, &
k
, &
v
).
unw¿p
();

625 
	gModify
::
D–‘e
(
cf
, 
k
) => {

626 
Ët
 
k
 = 
keys
::
d©a_key
(k.
’coded
());

627 
Ët
 
	ghªdË
 = 
rocksdb_ut
::
g‘_cf_hªdË
(
db
, 
cf
).
unw¿p
();

628 
	gwb
.
d–‘e_cf
(
hªdË
, &
k
).
unw¿p
();

630 
	gModify
::
D–‘eRªge
(
cf
, 
k1
, 
k2
) => {

631 
Ët
 
k1
 = 
keys
::
d©a_key
(k1.
’coded
());

632 
Ët
 
	gk2
 = 
keys
::
d©a_key
(
k2
.
’coded
());

633 
Ët
 
	ghªdË
 = 
rocksdb_ut
::
g‘_cf_hªdË
(
db
, 
cf
).
unw¿p
();

634 
	gwb
.
d–‘e_¿nge_cf
(
hªdË
, &
k1
, &
k2
).
unw¿p
();

638 
	gdb
.
wr™e
(
wb
).
unw¿p
();

641 
â
 
æush
(&
mut
 
£lf
) {

642 
cf
 
š
 
	gALL_CFS
 {

643 
Ët
 
	gcf
 = 
rocksdb_ut
::
g‘_cf_hªdË
(&
£lf
.
db
, 
cf
).
unw¿p
();

644 
	g£lf
.
	gdb
.
æush_cf
(
cf
, 
Œue
).
unw¿p
();

648 
â
 
com·ù
(&
mut
 
£lf
) {

649 
cf
 
š
 
	gALL_CFS
 {

650 
Ët
 
	gcf
 = 
rocksdb_ut
::
g‘_cf_hªdË
(&
£lf
.
db
, 
cf
).
unw¿p
();

651 
	g£lf
.
	gdb
.
com·ù_¿nge_cf
(
cf
, 
NÚe
, None);

656 
â
 
İ’_db
(
·th
: &
¡r
, 
w™h_´İ”t›s
: 
boŞ
è-> 
Arc
<
DB
> {

657 
Ët
 
db_İts
 = 
rocksdb
::
DBO±iÚs
::
Ãw
();

658 
Ët
 
mut
 
	gcf_İts
 = 
rocksdb
::
CŞumnFamyO±iÚs
::
Ãw
();

659 
	gw™h_´İ”t›s
 {

660 
Ët
 
	gf
 = 
Box
::
Ãw
(
MvccPrİ”t›sCŞËùÜFaùÜy
::());

661 
	gcf_İts
.
add_bË_´İ”t›s_cŞËùÜ_çùÜy
("tikv.‹¡-cŞËùÜ", 
f
);

663 
Ët
 
	gcfs_İts
 = 
vec
![

664 
CFO±iÚs
::
Ãw
(
CF_DEFAULT
, 
rocksdb
::
CŞumnFamyO±iÚs
::new()),

665 
CFO±iÚs
::
Ãw
(
CF_RAFT
, 
rocksdb
::
CŞumnFamyO±iÚs
::new()),

666 
CFO±iÚs
::
Ãw
(
CF_LOCK
, 
rocksdb
::
CŞumnFamyO±iÚs
::new()),

667 
CFO±iÚs
::
Ãw
(
CF_WRITE
, 
cf_İts
),

669 
	gArc
::
Ãw
(

670 
rocksdb_ut
::
Ãw_’gše_İt
(
·th
, 
db_İts
, 
cfs_İts
).
unw¿p
(),

674 
â
 
make_»giÚ
(
id
: 
u64
, 
¡¬t_key
: 
Vec
<
u8
>, 
’d_key
: Vec<u8>è-> 
RegiÚ
 {

675 
Ët
 
mut
 
³”
 = 
P“r
::
Ãw
();

676 
	g³”
.
£t_id
(
id
);

677 
	g³”
.
£t_¡Üe_id
(
id
);

678 
Ët
 
mut
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

679 
	g»giÚ
.
£t_id
(
id
);

680 
	g»giÚ
.
£t_¡¬t_key
(
¡¬t_key
);

681 
	g»giÚ
.
£t_’d_key
(
’d_key
);

682 
	g»giÚ
.
mut_³”s
().
push
(
³”
);

683 
	g»giÚ


686 
â
 
check_Ãed_gc
(

687 
db
: 
Arc
<
DB
>,

688 
»giÚ
: 
RegiÚ
,

689 
§ã_pošt
: 
u64
,

690 
Ãed_gc
: 
boŞ
,

691 è-> 
	gO±iÚ
<
	gMvccPrİ”t›s
> {

692 
Ët
 
	g¢­
 = 
RegiÚSÇpshÙ
::
äom_¿w
(
db
.
şÚe
(), 
»giÚ
.clone());

693 
Ët
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(
Box
::Ãw(
¢­
), 
NÚe
, 
çl£
, NÚe, 
IsŞ©iÚLev–
::
SI
);

694 
	gas£¹_eq
!(
	g»ad”
.
Ãed_gc
(
§ã_pošt
, 1.0), 
	gÃed_gc
);

695 
	g»ad”
.
g‘_mvcc_´İ”t›s
(
§ã_pošt
)

698 #[
‹¡
]

699 
â
 
‹¡_Ãed_gc
() {

700 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("_‹¡_¡Üage_mvcc_»ad”").
ex³ù
("");

701 
Ët
 
	g·th
 = 
·th
.·th().
to_¡r
().
unw¿p
();

702 
Ët
 
	g»giÚ
 = 
make_»giÚ
(1, 
vec
![0], vec![10]);

703 
‹¡_w™hout_´İ”t›s
(
·th
, &
»giÚ
);

704 
‹¡_w™h_´İ”t›s
(
·th
, &
»giÚ
);

707 
â
 
‹¡_w™hout_´İ”t›s
(
·th
: &
¡r
, 
»giÚ
: &
RegiÚ
) {

708 
Ët
 
db
 = 
İ’_db
(
·th
, 
çl£
);

709 
Ët
 
mut
 
	g’gše
 = 
RegiÚEngše
::
Ãw
(
db
.
şÚe
(), 
»giÚ
.clone());

712 
	g’gše
.
put
(&[1], 1, 1);

713 
	g’gše
.
put
(&[4], 2, 2);

714 
	gas£¹
!(
check_Ãed_gc
(
db
.
şÚe
(), 
»giÚ
.şÚe(), 10, 
Œue
).
is_nÚe
());

715 
	g’gše
.
æush
();

718 
	gas£¹
!(
check_Ãed_gc
(
db
.
şÚe
(), 
»giÚ
.şÚe(), 10, 
Œue
).
is_nÚe
());

721 #[
®low
(
cyşom©ic_com¶ex™y
)]

722 
â
 
‹¡_w™h_´İ”t›s
(
·th
: &
¡r
, 
»giÚ
: &
RegiÚ
) {

723 
Ët
 
db
 = 
İ’_db
(
·th
, 
Œue
);

724 
Ët
 
mut
 
	g’gše
 = 
RegiÚEngše
::
Ãw
(
db
.
şÚe
(), 
»giÚ
.clone());

727 
	g’gše
.
put
(&[2], 3, 3);

728 
	g’gše
.
put
(&[3], 4, 4);

729 
	g’gše
.
æush
();

733 
	gas£¹
!(
check_Ãed_gc
(
db
.
şÚe
(), 
»giÚ
.şÚe(), 10, 
Œue
).
is_nÚe
());

734 
	g’gše
.
com·ù
();

738 
Ët
 
	g´İs
 = 
check_Ãed_gc
(
db
.
şÚe
(), 
»giÚ
.şÚe(), 10, 
çl£
).
unw¿p
();

739 
	gas£¹_eq
!(
	g´İs
.
	gmš_ts
, 1);

740 
	gas£¹_eq
!(
	g´İs
.
	gmax_ts
, 4);

741 
	gas£¹_eq
!(
	g´İs
.
	gnum_rows
, 4);

742 
	gas£¹_eq
!(
	g´İs
.
	gnum_puts
, 4);

743 
	gas£¹_eq
!(
	g´İs
.
	gnum_v”siÚs
, 4);

744 
	gas£¹_eq
!(
	g´İs
.
	gmax_row_v”siÚs
, 1);

747 
	g’gše
.
put
(&[5], 5, 5);

748 
	g’gše
.
put
(&[6], 6, 6);

749 
	g’gše
.
d–‘e
(&[5], 7, 7);

750 
	g’gše
.
d–‘e
(&[6], 8, 8);

751 
	g’gše
.
æush
();

754 
Ët
 
	g´İs
 = 
check_Ãed_gc
(
db
.
şÚe
(), 
»giÚ
.şÚe(), 10, 
Œue
).
unw¿p
();

755 
	gas£¹_eq
!(
	g´İs
.
	gmš_ts
, 1);

756 
	gas£¹_eq
!(
	g´İs
.
	gmax_ts
, 8);

757 
	gas£¹_eq
!(
	g´İs
.
	gnum_rows
, 6);

758 
	gas£¹_eq
!(
	g´İs
.
	gnum_puts
, 6);

759 
	gas£¹_eq
!(
	g´İs
.
	gnum_v”siÚs
, 8);

760 
	gas£¹_eq
!(
	g´İs
.
	gmax_row_v”siÚs
, 2);

762 
Ët
 
	g´İs
 = 
check_Ãed_gc
(
db
.
şÚe
(), 
»giÚ
.şÚe(), 0, 
çl£
).
unw¿p
();

763 
	gas£¹_eq
!(
	g´İs
.
	gmš_ts
, 
	gu64
::
MAX
);

764 
	gas£¹_eq
!(
	g´İs
.
	gmax_ts
, 0);

765 
	gas£¹_eq
!(
	g´İs
.
	gnum_rows
, 0);

766 
	gas£¹_eq
!(
	g´İs
.
	gnum_puts
, 0);

767 
	gas£¹_eq
!(
	g´İs
.
	gnum_v”siÚs
, 0);

768 
	gas£¹_eq
!(
	g´İs
.
	gmax_row_v”siÚs
, 0);

771 
	g’gše
.
gc
(&[5], 10);

772 
	g’gše
.
gc
(&[6], 10);

773 
	g’gše
.
com·ù
();

776 
Ët
 
	g´İs
 = 
check_Ãed_gc
(
db
.
şÚe
(), 
»giÚ
.şÚe(), 10, 
çl£
).
unw¿p
();

777 
	gas£¹_eq
!(
	g´İs
.
	gmš_ts
, 1);

778 
	gas£¹_eq
!(
	g´İs
.
	gmax_ts
, 4);

779 
	gas£¹_eq
!(
	g´İs
.
	gnum_rows
, 4);

780 
	gas£¹_eq
!(
	g´İs
.
	gnum_puts
, 4);

781 
	gas£¹_eq
!(
	g´İs
.
	gnum_v”siÚs
, 4);

782 
	gas£¹_eq
!(
	g´İs
.
	gmax_row_v”siÚs
, 1);

785 
	g’gše
.
lock
(&[7], 9, 9);

786 
	g’gše
.
æush
();

787 
Ët
 
	g´İs
 = 
check_Ãed_gc
(
db
.
şÚe
(), 
»giÚ
.şÚe(), 10, 
Œue
).
unw¿p
();

788 
	gas£¹_eq
!(
	g´İs
.
	gmš_ts
, 1);

789 
	gas£¹_eq
!(
	g´İs
.
	gmax_ts
, 9);

790 
	gas£¹_eq
!(
	g´İs
.
	gnum_rows
, 5);

791 
	gas£¹_eq
!(
	g´İs
.
	gnum_puts
, 4);

792 
	gas£¹_eq
!(
	g´İs
.
	gnum_v”siÚs
, 5);

793 
	gas£¹_eq
!(
	g´İs
.
	gmax_row_v”siÚs
, 1);

	@src/storage/mvcc/txn.rs

14 
u£
 
	g¡d
::
fmt
;

15 
u£
 
	g¡Üage
::{
is_shÜt_v®ue
, 
	gKey
, 
	gMutiÚ
, 
	gO±iÚs
, 
	gSti¡ics
, 
	gV®ue
, 
	gCF_DEFAULT
, 
	gCF_LOCK
,

16 
	gCF_WRITE
};

17 
u£
 
	g¡Üage
::
’gše
::{
Modify
, 
	gSÿnMode
, 
	gSÇpshÙ
};

18 
u£
 
	gsu³r
::
»ad”
::
MvccR—d”
;

19 
u£
 
	gsu³r
::
lock
::{
Lock
, 
	gLockTy³
};

20 
u£
 
	gsu³r
::
wr™e
::{
Wr™e
, 
	gWr™eTy³
};

21 
u£
 
	gsu³r
::{
E¼Ü
, 
	gResuÉ
};

22 
u£
 
	gsu³r
::
m‘rics
::*;

23 
u£
 
	gkv´Ùo
::
kv½ıb
::
IsŞ©iÚLev–
;

25 
pub
 cÚ¡ 
	gMAX_TXN_WRITE_SIZE
: 
usize
 = 32 * 1024;

27 
pub
 
	sMvccTxn
 {

28 
	m»ad”
: 
MvccR—d”
,

29 
	m¡¬t_ts
: 
u64
,

30 
	mwr™es
: 
Vec
<
Modify
>,

31 
	mwr™e_size
: 
usize
,

34 
im¶
 
	gfmt
::
Debug
 
MvccTxn
 {

35 
â
 
fmt
(&
£lf
, 
f
: &
mut
 fmt::
FÜm©‹r
è-> fmt::
ResuÉ
 {

36 
wr™e
!(
f
, "txÀ@{}", 
	g£lf
.
	g¡¬t_ts
)

40 
im¶
 
	gMvccTxn
 {

41 
pub
 
â
 
Ãw
(

42 
¢­shÙ
: 
Box
<
SÇpshÙ
>,

43 
¡¬t_ts
: 
u64
,

44 
mode
: 
O±iÚ
<
SÿnMode
>,

45 
isŞ©iÚ_Ëv–
: 
IsŞ©iÚLev–
,

46 
fl_ÿche
: 
boŞ
,

47 è-> 
	gMvccTxn
 {

48 
	gMvccTxn
 {

50 
	g»ad”
: 
MvccR—d”
::
Ãw
(
¢­shÙ
, 
mode
, 
fl_ÿche
, 
NÚe
, 
isŞ©iÚ_Ëv–
),

51 
	g¡¬t_ts
: 
¡¬t_ts
,

52 
	gwr™es
: 
vec
![],

53 
	gwr™e_size
: 0,

57 
pub
 
â
 
što_modif›s
(
£lf
è-> 
	gVec
<
	gModify
> {

58 
	g£lf
.
	gwr™es


61 
pub
 
â
 
g‘_¡©i¡ics
(&
£lf
è-> &
	gSti¡ics
 {

62 
	g£lf
.
	g»ad”
.
g‘_¡©i¡ics
()

65 
pub
 
â
 
wr™e_size
(&
£lf
è-> 
	gusize
 {

66 
	g£lf
.
	gwr™e_size


69 
â
 
lock_key
(

70 &
mut
 
£lf
,

71 
key
: 
Key
,

72 
lock_ty³
: 
LockTy³
,

73 
´im¬y
: 
Vec
<
u8
>,

74 
‰l
: 
u64
,

75 
shÜt_v®ue
: 
O±iÚ
<
V®ue
>,

77 
Ët
 
	glock
 = 
Lock
::
Ãw
(
lock_ty³
, 
´im¬y
, 
£lf
.
¡¬t_ts
, 
‰l
, 
shÜt_v®ue
).
to_by‹s
();

78 
	g£lf
.
	gwr™e_size
 +ğ
CF_LOCK
.
Ën
(è+ 
key
.
’coded
().Ën(è+ 
lock
.len();

79 
	g£lf
.
	gwr™es
.
push
(
Modify
::
Put
(
CF_LOCK
, 
key
, 
lock
));

82 
â
 
uÆock_key
(&
mut
 
£lf
, 
key
: 
Key
) {

83 
£lf
.
wr™e_size
 +ğ
CF_LOCK
.
Ën
(è+ 
key
.
’coded
().len();

84 
	g£lf
.
	gwr™es
.
push
(
Modify
::
D–‘e
(
CF_LOCK
, 
key
));

87 
â
 
put_v®ue
(&
mut
 
£lf
, 
key
: &
Key
, 
ts
: 
u64
, 
v®ue
: 
V®ue
) {

88 
Ët
 
key
 = key.
­³nd_ts
(
ts
);

89 
	g£lf
.
	gwr™e_size
 +ğ
key
.
’coded
().
Ën
(è+ 
v®ue
.len();

90 
	g£lf
.
	gwr™es
.
push
(
Modify
::
Put
(
CF_DEFAULT
, 
key
, 
v®ue
));

93 
â
 
d–‘e_v®ue
(&
mut
 
£lf
, 
key
: &
Key
, 
ts
: 
u64
) {

94 
Ët
 
key
 = key.
­³nd_ts
(
ts
);

95 
	g£lf
.
	gwr™e_size
 +ğ
key
.
’coded
().
Ën
();

96 
	g£lf
.
	gwr™es
.
push
(
Modify
::
D–‘e
(
CF_DEFAULT
, 
key
));

99 
â
 
put_wr™e
(&
mut
 
£lf
, 
key
: &
Key
, 
ts
: 
u64
, 
v®ue
: 
V®ue
) {

100 
Ët
 
key
 = key.
­³nd_ts
(
ts
);

101 
	g£lf
.
	gwr™e_size
 +ğ
CF_WRITE
.
Ën
(è+ 
key
.
’coded
().Ën(è+ 
v®ue
.len();

102 
	g£lf
.
	gwr™es
.
push
(
Modify
::
Put
(
CF_WRITE
, 
key
, 
v®ue
));

105 
â
 
d–‘e_wr™e
(&
mut
 
£lf
, 
key
: &
Key
, 
ts
: 
u64
) {

106 
Ët
 
key
 = key.
­³nd_ts
(
ts
);

107 
	g£lf
.
	gwr™e_size
 +ğ
CF_WRITE
.
Ën
(è+ 
key
.
’coded
().len();

108 
	g£lf
.
	gwr™es
.
push
(
Modify
::
D–‘e
(
CF_WRITE
, 
key
));

111 
pub
 
â
 
g‘
(&
mut
 
£lf
, 
key
: &
Key
è-> 
ResuÉ
<
O±iÚ
<
V®ue
>> {

112 
£lf
.
»ad”
.
g‘
(
key
, s–f.
¡¬t_ts
)

115 
pub
 
â
 
´ewr™e
(

116 &
mut
 
£lf
,

117 
mutiÚ
: 
MutiÚ
,

118 
´im¬y
: &[
u8
],

119 
İtiÚs
: &
O±iÚs
,

120 è-> 
	gResuÉ
<()> {

121 
Ët
 
	gkey
 = 
mutiÚ
.
key
();

122 !
	gİtiÚs
.
	gsk_cÚ¡¿št_check
 {

123 
Ët
 
Some
((
comm™
, 
_
)èğ
£lf
.
»ad”
.
£ek_wr™e
(
key
, 
u64
::
max_v®ue
())? {

125 
comm™
 >ğ
£lf
.
¡¬t_ts
 {

126 
MVCC_CONFLICT_COUNTER


127 .
w™h_Ïb–_v®ues
(&["prewrite_write_conflict"])

128 .
šc
();

129  
E¼
(
E¼Ü
::
Wr™eCÚæiù
 {

130 
¡¬t_ts
: 
£lf
.start_ts,

131 
cÚæiù_ts
: 
comm™
,

132 
key
: key.
’coded
().
to_owÃd
(),

133 
´im¬y
:…rim¬y.
to_vec
(),

139 
Ët
 
Some
(
lock
èğ
£lf
.
»ad”
.
lßd_lock
(
key
)? {

140 
lock
.
ts
 !ğ
£lf
.
¡¬t_ts
 {

141  
E¼
(
E¼Ü
::
KeyIsLocked
 {

142 
key
: key.
¿w
()?,

143 
´im¬y
: 
lock
.primary,

144 
ts
: 
lock
.ts,

145 
‰l
: 
lock
.ttl,

150 
	gšfo
!(

152 
	g£lf
.
	g¡¬t_ts


154  
Ok
(());

157 
Ët
 
	gshÜt_v®ue
 = Ëˆ
MutiÚ
::
Put
((
_
, 
»f
 
v®ue
)èğ
mutiÚ
 {

158 
is_shÜt_v®ue
(
v®ue
) {

159 
Some
(
v®ue
.
şÚe
())

161 
NÚe


164 
NÚe


167 
	g£lf
.
lock_key
(

168 
key
.
şÚe
(),

169 
LockTy³
::
äom_mutiÚ
(&
mutiÚ
),

170 
´im¬y
.
to_vec
(),

171 
İtiÚs
.
lock_‰l
,

172 
shÜt_v®ue
,

175 
Ët
 
	gMutiÚ
::
Put
((
_
, 
»f
 
v®ue
)èğ
mutiÚ
 {

176 !
is_shÜt_v®ue
(
v®ue
) {

177 
Ët
 
ts
 = 
£lf
.
¡¬t_ts
;

178 
	g£lf
.
put_v®ue
(
key
, 
ts
, 
v®ue
.
şÚe
());

181 
Ok
(())

184 
pub
 
â
 
comm™
(&
mut
 
£lf
, 
key
: &
Key
, 
comm™_ts
: 
u64
è-> 
ResuÉ
<()> {

185 
Ët
 (
lock_ty³
, 
shÜt_v®ue
èğ
m©ch
 
£lf
.
»ad”
.
lßd_lock
(
key
)? {

186 
Some
(
»f
 
mut
 
lock
èlock.
ts
 =ğ
£lf
.
¡¬t_ts
 => {

187 (
lock
.
lock_ty³
,†ock.
shÜt_v®ue
.
ke
())

189 
_
 => {

190  
m©ch
 
£lf
.
»ad”
.
g‘_txn_comm™_šfo
(
key
, s–f.
¡¬t_ts
)? {

191 
Some
((
_
, 
Wr™eTy³
::
RŞlback
)è| 
NÚe
 => {

192 
MVCC_CONFLICT_COUNTER


193 .
w™h_Ïb–_v®ues
(&["commit_lock_not_found"])

194 .
šc
();

197 
	gšfo
!(

199 
	gkey
,

200 
	g£lf
.
	g¡¬t_ts
,

201 
	gcomm™_ts


203 
E¼
(
E¼Ü
::
TxnLockNÙFound
 {

204 
¡¬t_ts
: 
£lf
.start_ts,

205 
comm™_ts
: commit_ts,

206 
key
: key.
’coded
().
to_owÃd
(),

210 
Some
((
_
, 
Wr™eTy³
::
Put
)) |

211 
Some
((
_
, 
Wr™eTy³
::
D–‘e
)) |

212 
Some
((
_
, 
Wr™eTy³
::
Lock
)è=> 
Ok
(()),

216 
Ët
 
	gwr™e
 = 
Wr™e
::
Ãw
(

217 
Wr™eTy³
::
äom_lock_ty³
(
lock_ty³
),

218 
£lf
.
¡¬t_ts
,

219 
shÜt_v®ue
,

221 
	g£lf
.
put_wr™e
(
key
, 
comm™_ts
, 
wr™e
.
to_by‹s
());

222 
	g£lf
.
uÆock_key
(
key
.
şÚe
());

223 
Ok
(())

226 
pub
 
â
 
rŞlback
(&
mut
 
£lf
, 
key
: &
Key
è-> 
ResuÉ
<()> {

227 
m©ch
 
£lf
.
»ad”
.
lßd_lock
(
key
)? {

228 
Some
(
»f
 
lock
èlock.
ts
 =ğ
£lf
.
¡¬t_ts
 => {

230 
lock
.
shÜt_v®ue
.
is_nÚe
(è&&†ock.
lock_ty³
 =ğ
LockTy³
::
Put
 {

231 
£lf
.
d–‘e_v®ue
(
key
, 
lock
.
ts
);

234 
	g_
 => {

235  
m©ch
 
£lf
.
»ad”
.
g‘_txn_comm™_šfo
(
key
, s–f.
¡¬t_ts
)? {

236 
Some
((
ts
, 
wr™e_ty³
)) => {

237 
wr™e_ty³
 =ğ
Wr™eTy³
::
RŞlback
 {

239 
Ok
(())

241 
MVCC_CONFLICT_COUNTER


242 .
w™h_Ïb–_v®ues
(&["rollback_committed"])

243 .
šc
();

244 
	gšfo
!(

246 
	gkey
,

247 
	g£lf
.
	g¡¬t_ts
,

248 
	gts


250 
E¼
(
E¼Ü
::
Comm™‹d
 { 
comm™_ts
: 
ts
 })

253 
NÚe
 => {

254 
Ët
 
ts
 = 
£lf
.
¡¬t_ts
;

256 
Ët
 
	gwr™e
 = 
Wr™e
::
Ãw
(
Wr™eTy³
::
RŞlback
, 
ts
, 
NÚe
);

257 
	g£lf
.
put_wr™e
(
key
, 
ts
, 
wr™e
.
to_by‹s
());

258 
Ok
(())

263 
Ët
 
	gwr™e
 = 
Wr™e
::
Ãw
(
Wr™eTy³
::
RŞlback
, 
£lf
.
¡¬t_ts
, 
NÚe
);

264 
Ët
 
	gts
 = 
£lf
.
¡¬t_ts
;

265 
	g£lf
.
put_wr™e
(
key
, 
ts
, 
wr™e
.
to_by‹s
());

266 
	g£lf
.
uÆock_key
(
key
.
şÚe
());

267 
Ok
(())

270 
pub
 
â
 
gc
(&
mut
 
£lf
, 
key
: &
Key
, 
§ã_pošt
: 
u64
è-> 
ResuÉ
<()> {

271 
Ët
 
mut
 
»move_Şd”
 = 
çl£
;

272 
Ët
 
mut
 
	gts
: 
u64
 = u64::
max_v®ue
();

273 
Ët
 
mut
 
	gv”siÚs
 = 0;

274 
Ët
 
mut
 
	gd–‘e_v”siÚs
 = 0;

275 
Ët
 
mut
 
	gÏ‹¡_d–‘e
 = 
NÚe
;

276 
Ët
 
Some
((
comm™
, 
wr™e
)èğ
£lf
.
»ad”
.
£ek_wr™e
(
key
, 
ts
)? {

277 
	gts
 = 
comm™
 - 1;

278 
	gv”siÚs
 += 1;

280 
	g£lf
.
	gwr™e_size
 >ğ
MAX_TXN_WRITE_SIZE
 {

282 
Ï‹¡_d–‘e
 = 
NÚe
;

286 
	g»move_Şd”
 {

287 
	g£lf
.
d–‘e_wr™e
(
key
, 
comm™
);

288 
	gwr™e
.
	gwr™e_ty³
 =ğ
Wr™eTy³
::
Put
 && 
wr™e
.
shÜt_v®ue
.
is_nÚe
() {

289 
£lf
.
d–‘e_v®ue
(
key
, 
wr™e
.
¡¬t_ts
);

291 
	gd–‘e_v”siÚs
 += 1;

295 
	gcomm™
 > 
	g§ã_pošt
 {

300 
m©ch
 
	gwr™e
.
	gwr™e_ty³
 {

301 
	gWr™eTy³
::
Put
 | 
Wr™eTy³
::
D–‘e
 => {

302 
»move_Şd”
 = 
Œue
;

304 
	gWr™eTy³
::
RŞlback
 | 
Wr™eTy³
::
Lock
 => {}

309 
m©ch
 
wr™e
.
wr™e_ty³
 {

310 
Wr™eTy³
::
D–‘e
 => {

311 
Ï‹¡_d–‘e
 = 
Some
(
comm™
);

313 
	gWr™eTy³
::
RŞlback
 | 
Wr™eTy³
::
Lock
 => {

314 
£lf
.
d–‘e_wr™e
(
key
, 
comm™
);

315 
	gd–‘e_v”siÚs
 += 1;

317 
	gWr™eTy³
::
Put
 => {}

320 
Ët
 
Some
(
comm™
èğ
Ï‹¡_d–‘e
 {

321 
£lf
.
d–‘e_wr™e
(
key
, 
comm™
);

322 
	gd–‘e_v”siÚs
 += 1;

324 
	gMVCC_VERSIONS_HISTOGRAM
.
ob£rve
(
v”siÚs
 
as
 
f64
);

325 
	gd–‘e_v”siÚs
 > 0 {

326 
	gGC_DELETE_VERSIONS_HISTOGRAM
.
ob£rve
(
d–‘e_v”siÚs
 
as
 
f64
);

328 
Ok
(())

332 #[
cfg
(
‹¡
)]

333 
mod
 
	g‹¡s
 {

334 
u£
 
	g‹mpdœ
::
TempDœ
;

335 
u£
 
	gkv´Ùo
::
kv½ıb
::{
CÚ‹xt
, 
	gIsŞ©iÚLev–
};

336 
u£
 
	gsu³r
::
MvccTxn
;

337 
u£
 
	gsu³r
::
su³r
::
MvccR—d”
;

338 
u£
 
	gsu³r
::
su³r
::
wr™e
::{
Wr™e
, 
	gWr™eTy³
};

339 
u£
 
	g¡Üage
::{
make_key
, 
	gMutiÚ
, 
	gO±iÚs
, 
	gSÿnMode
, 
	gALL_CFS
, 
	gCF_WRITE
, 
	gSHORT_VALUE_MAX_LEN
};

340 
u£
 
	g¡Üage
::
’gše
::{
£lf
, 
	gEngše
, 
	gTEMP_DIR
};

342 
â
 
g’_v®ue
(
v
: 
u8
, 
Ën
: 
usize
è-> 
Vec
<u8> {

343 
Ët
 
mut
 
v®ue
 = 
Vec
::
w™h_ÿ·c™y
(
Ën
);

344 
_
 
	gš
 0..Ë
	gn
 {

345 
	gv®ue
.
push
(
v
);

348 
	gv®ue


351 
â
 
‹¡_mvcc_txn_»ad_imp
(
k
: &[
u8
], 
v
: &[u8]) {

352 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

354 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 1);

356 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v
, k, 5);

357 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 3);

358 
mu¡_g‘_”r
(
’gše
.
as_»f
(), 
k
, 7);

360 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 5, 10);

361 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 3);

362 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 7);

363 
mu¡_g‘
(
’gše
.
as_»f
(), 
k
, 13, 
v
);

364 
mu¡_´ewr™e_d–‘e
(
’gše
.
as_»f
(), 
k
, k, 15);

365 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 15, 20);

366 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 3);

367 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 7);

368 
mu¡_g‘
(
’gše
.
as_»f
(), 
k
, 13, 
v
);

369 
mu¡_g‘
(
’gše
.
as_»f
(), 
k
, 17, 
v
);

370 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 23);

373 #[
‹¡
]

374 
â
 
‹¡_mvcc_txn_»ad
() {

375 
‹¡_mvcc_txn_»ad_imp
(
b
"k1", b"v1");

377 
Ët
 
	glÚg_v®ue
 = 
g’_v®ue
(
b
'v', 
SHORT_VALUE_MAX_LEN
 + 1);

378 
‹¡_mvcc_txn_»ad_imp
(
b
"k2", &
lÚg_v®ue
);

381 
â
 
‹¡_mvcc_txn_´ewr™e_imp
(
k
: &[
u8
], 
v
: &[u8]) {

382 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

384 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v
, k, 5);

386 
mu¡_locked
(
’gše
.
as_»f
(), 
k
, 5);

388 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v
, k, 5);

390 
mu¡_´ewr™e_lock_”r
(
’gše
.
as_»f
(), 
k
, k, 6);

392 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 5, 10);

393 
mu¡_wr™‹n
(
’gše
.
as_»f
(), 
k
, 5, 10, 
Wr™eTy³
::
Put
);

395 
mu¡_´ewr™e_lock_”r
(
’gše
.
as_»f
(), 
k
, k, 6);

396 
mu¡_uÆocked
(
’gše
.
as_»f
(), 
k
);

398 
mu¡_´ewr™e_lock
(
’gše
.
as_»f
(), 
k
, k, 12);

399 
mu¡_locked
(
’gše
.
as_»f
(), 
k
, 12);

400 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 12);

401 
mu¡_uÆocked
(
’gše
.
as_»f
(), 
k
);

402 
mu¡_wr™‹n
(
’gše
.
as_»f
(), 
k
, 12, 12, 
Wr™eTy³
::
RŞlback
);

404 
mu¡_´ewr™e_lock_”r
(
’gše
.
as_»f
(), 
k
, k, 12);

406 
mu¡_´ewr™e_d–‘e
(
’gše
.
as_»f
(), 
k
, k, 13);

407 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 13);

408 
mu¡_uÆocked
(
’gše
.
as_»f
(), 
k
);

411 #[
‹¡
]

412 
â
 
‹¡_rŞlback_lock
() {

413 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

415 
Ët
 (
k
, 
v
èğ(
b
"k1", 
	gb
"v1");

416 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v
, k, 5);

417 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 5, 10);

420 
mu¡_´ewr™e_lock
(
’gše
.
as_»f
(), 
k
, k, 15);

421 
mu¡_locked
(
’gše
.
as_»f
(), 
k
, 15);

424 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 15);

427 #[
‹¡
]

428 
â
 
‹¡_rŞlback_d–
() {

429 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

431 
Ët
 (
k
, 
v
èğ(
b
"k1", 
	gb
"v1");

432 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v
, k, 5);

433 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 5, 10);

436 
mu¡_´ewr™e_d–‘e
(
’gše
.
as_»f
(), 
k
, k, 15);

437 
mu¡_locked
(
’gše
.
as_»f
(), 
k
, 15);

440 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 15);

443 #[
‹¡
]

444 
â
 
‹¡_mvcc_txn_´ewr™e
() {

445 
‹¡_mvcc_txn_´ewr™e_imp
(
b
"k1", b"v1");

447 
Ët
 
	glÚg_v®ue
 = 
g’_v®ue
(
b
'v', 
SHORT_VALUE_MAX_LEN
 + 1);

448 
‹¡_mvcc_txn_´ewr™e_imp
(
b
"k2", &
lÚg_v®ue
);

451 
â
 
‹¡_mvcc_txn_comm™_ok_imp
(
k1
: &[
u8
], 
v1
: &[u8], 
k2
: &[u8], 
k3
: &[u8]) {

452 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

453 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k1
, 
v1
, k1, 10);

454 
mu¡_´ewr™e_lock
(
’gše
.
as_»f
(), 
k2
, 
k1
, 10);

455 
mu¡_´ewr™e_d–‘e
(
’gše
.
as_»f
(), 
k3
, 
k1
, 10);

456 
mu¡_locked
(
’gše
.
as_»f
(), 
k1
, 10);

457 
mu¡_locked
(
’gše
.
as_»f
(), 
k2
, 10);

458 
mu¡_locked
(
’gše
.
as_»f
(), 
k3
, 10);

459 
mu¡_comm™
(
’gše
.
as_»f
(), 
k1
, 10, 15);

460 
mu¡_comm™
(
’gše
.
as_»f
(), 
k2
, 10, 15);

461 
mu¡_comm™
(
’gše
.
as_»f
(), 
k3
, 10, 15);

462 
mu¡_wr™‹n
(
’gše
.
as_»f
(), 
k1
, 10, 15, 
Wr™eTy³
::
Put
);

463 
mu¡_wr™‹n
(
’gše
.
as_»f
(), 
k2
, 10, 15, 
Wr™eTy³
::
Lock
);

464 
mu¡_wr™‹n
(
’gše
.
as_»f
(), 
k3
, 10, 15, 
Wr™eTy³
::
D–‘e
);

466 
mu¡_comm™
(
’gše
.
as_»f
(), 
k1
, 10, 15);

467 
mu¡_comm™
(
’gše
.
as_»f
(), 
k2
, 10, 15);

468 
mu¡_comm™
(
’gše
.
as_»f
(), 
k3
, 10, 15);

471 #[
‹¡
]

472 
â
 
‹¡_mvcc_txn_comm™_ok
() {

473 
‹¡_mvcc_txn_comm™_ok_imp
(
b
"x", b"v", b"y", b"z");

475 
Ët
 
	glÚg_v®ue
 = 
g’_v®ue
(
b
'v', 
SHORT_VALUE_MAX_LEN
 + 1);

476 
‹¡_mvcc_txn_comm™_ok_imp
(
b
"x", &
lÚg_v®ue
, b"y", b"z");

479 
â
 
‹¡_mvcc_txn_comm™_”r_imp
(
k
: &[
u8
], 
v
: &[u8]) {

480 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

483 
mu¡_comm™_”r
(
’gše
.
as_»f
(), 
k
, 1, 2);

484 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v
, k, 5);

486 
mu¡_comm™_”r
(
’gše
.
as_»f
(), 
k
, 4, 5);

487 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 5);

489 
mu¡_comm™_”r
(
’gše
.
as_»f
(), 
k
, 5, 6);

492 #[
‹¡
]

493 
â
 
‹¡_mvcc_txn_comm™_”r
() {

494 
‹¡_mvcc_txn_comm™_”r_imp
(
b
"k", b"v");

496 
Ët
 
	glÚg_v®ue
 = 
g’_v®ue
(
b
'v', 
SHORT_VALUE_MAX_LEN
 + 1);

497 
‹¡_mvcc_txn_comm™_”r_imp
(
b
"k2", &
lÚg_v®ue
);

500 
â
 
‹¡_mvcc_txn_rŞlback_imp
(
k
: &[
u8
], 
v
: &[u8]) {

501 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

503 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v
, k, 5);

504 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 5);

506 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 5);

508 
mu¡_uÆocked
(
’gše
.
as_»f
(), 
k
);

509 
mu¡_´ewr™e_lock
(
’gše
.
as_»f
(), 
k
, k, 10);

510 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 10);

512 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 20);

515 #[
‹¡
]

516 
â
 
‹¡_mvcc_txn_rŞlback_aá”_comm™
() {

517 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

519 
Ët
 
	gk
 = 
b
"k";

520 
Ët
 
	gv
 = 
b
"v";

521 
Ët
 
	gt1
 = 1;

522 
Ët
 
	gt2
 = 10;

523 
Ët
 
	gt3
 = 20;

524 
Ët
 
	gt4
 = 30;

526 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v
, k, 
t1
);

528 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 
t2
);

529 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 
t2
);

530 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 
t4
);

532 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 
t1
, 
t3
);

535 
mu¡_rŞlback_”r
(
’gše
.
as_»f
(), 
k
, 
t1
);

536 
mu¡_g‘
(
’gše
.
as_»f
(), 
k
, 
t4
, 
v
);

539 #[
‹¡
]

540 
â
 
‹¡_mvcc_txn_rŞlback
() {

541 
‹¡_mvcc_txn_rŞlback_imp
(
b
"k", b"v");

543 
Ët
 
	glÚg_v®ue
 = 
g’_v®ue
(
b
'v', 
SHORT_VALUE_MAX_LEN
 + 1);

544 
‹¡_mvcc_txn_rŞlback_imp
(
b
"k2", &
lÚg_v®ue
);

547 
â
 
‹¡_mvcc_txn_rŞlback_”r_imp
(
k
: &[
u8
], 
v
: &[u8]) {

548 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

550 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v
, k, 5);

551 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 5, 10);

552 
mu¡_rŞlback_”r
(
’gše
.
as_»f
(), 
k
, 5);

553 
mu¡_rŞlback_”r
(
’gše
.
as_»f
(), 
k
, 5);

556 #[
‹¡
]

557 
â
 
‹¡_mvcc_txn_rŞlback_”r
() {

558 
‹¡_mvcc_txn_rŞlback_”r_imp
(
b
"k", b"v");

560 
Ët
 
	glÚg_v®ue
 = 
g’_v®ue
(
b
'v', 
SHORT_VALUE_MAX_LEN
 + 1);

561 
‹¡_mvcc_txn_rŞlback_”r_imp
(
b
"k2", &
lÚg_v®ue
);

564 #[
‹¡
]

565 
â
 
‹¡_mvcc_txn_rŞlback_befÜe_´ewr™e
() {

566 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

567 
Ët
 
	gkey
 = 
b
"key";

568 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
key
, 5);

569 
mu¡_´ewr™e_lock_”r
(
’gše
.
as_»f
(), 
key
, key, 5);

572 
â
 
‹¡_gc_imp
(
k
: &[
u8
], 
v1
: &[u8], 
v2
: &[u8], 
v3
: &[u8], 
v4
: &[u8]) {

573 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

575 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v1
, k, 5);

576 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 5, 10);

577 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v2
, k, 15);

578 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 15, 20);

579 
mu¡_´ewr™e_d–‘e
(
’gše
.
as_»f
(), 
k
, k, 25);

580 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 25, 30);

581 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v3
, k, 35);

582 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 35, 40);

583 
mu¡_´ewr™e_lock
(
’gše
.
as_»f
(), 
k
, k, 45);

584 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 45, 50);

585 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v4
, k, 55);

586 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 55);

613 
mu¡_gc
(
’gše
.
as_»f
(), 
k
, 12);

614 
mu¡_g‘
(
’gše
.
as_»f
(), 
k
, 12, 
v1
);

616 
mu¡_gc
(
’gše
.
as_»f
(), 
k
, 22);

617 
mu¡_g‘
(
’gše
.
as_»f
(), 
k
, 22, 
v2
);

618 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 12);

620 
mu¡_gc
(
’gše
.
as_»f
(), 
k
, 32);

621 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 22);

622 
mu¡_g‘_nÚe
(
’gše
.
as_»f
(), 
k
, 35);

624 
mu¡_gc
(
’gše
.
as_»f
(), 
k
, 60);

625 
mu¡_g‘
(
’gše
.
as_»f
(), 
k
, 62, 
v3
);

628 #[
‹¡
]

629 
â
 
‹¡_gc
() {

630 
‹¡_gc_imp
(
b
"k1", b"v1", b"v2", b"v3", b"v4");

632 
Ët
 
	gv1
 = 
g’_v®ue
(
b
'x', 
SHORT_VALUE_MAX_LEN
 + 1);

633 
Ët
 
	gv2
 = 
g’_v®ue
(
b
'y', 
SHORT_VALUE_MAX_LEN
 + 1);

634 
Ët
 
	gv3
 = 
g’_v®ue
(
b
'z', 
SHORT_VALUE_MAX_LEN
 + 1);

635 
Ët
 
	gv4
 = 
g’_v®ue
(
b
'v', 
SHORT_VALUE_MAX_LEN
 + 1);

636 
‹¡_gc_imp
(
b
"k2", &
v1
, &
v2
, &
v3
, &
v4
);

639 
â
 
‹¡_wr™e_imp
(
k
: &[
u8
], 
v
: &[u8], 
k2
: &[u8], 
k3
: &[u8]) {

640 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

642 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
k
, 
v
, k, 5);

643 
mu¡_£ek_wr™e_nÚe
(
’gše
.
as_»f
(), 
k
, 5);

645 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 5, 10);

646 
mu¡_£ek_wr™e
(
’gše
.
as_»f
(), 
k
, 
u64
::
max_v®ue
(), 5, 10, 
Wr™eTy³
::
Put
);

647 
mu¡_»v”£_£ek_wr™e
(
’gše
.
as_»f
(), 
k
, 5, 5, 10, 
Wr™eTy³
::
Put
);

648 
mu¡_£ek_wr™e_nÚe
(
’gše
.
as_»f
(), 
k2
, 
u64
::
max_v®ue
());

649 
mu¡_»v”£_£ek_wr™e_nÚe
(
’gše
.
as_»f
(), 
k3
, 5);

650 
mu¡_g‘_comm™_ts
(
’gše
.
as_»f
(), 
k
, 5, 10);

652 
mu¡_´ewr™e_d–‘e
(
’gše
.
as_»f
(), 
k
, k, 15);

653 
mu¡_rŞlback
(
’gše
.
as_»f
(), 
k
, 15);

654 
mu¡_£ek_wr™e
(

655 
’gše
.
as_»f
(),

656 
k
,

657 
u64
::
max_v®ue
(),

660 
Wr™eTy³
::
RŞlback
,

662 
mu¡_»v”£_£ek_wr™e
(
’gše
.
as_»f
(), 
k
, 15, 15, 15, 
Wr™eTy³
::
RŞlback
);

663 
mu¡_g‘_comm™_ts
(
’gše
.
as_»f
(), 
k
, 5, 10);

664 
mu¡_g‘_comm™_ts_nÚe
(
’gše
.
as_»f
(), 
k
, 15);

666 
mu¡_´ewr™e_lock
(
’gše
.
as_»f
(), 
k
, k, 25);

667 
mu¡_comm™
(
’gše
.
as_»f
(), 
k
, 25, 30);

668 
mu¡_£ek_wr™e
(

669 
’gše
.
as_»f
(),

670 
k
,

671 
u64
::
max_v®ue
(),

674 
Wr™eTy³
::
Lock
,

676 
mu¡_»v”£_£ek_wr™e
(
’gše
.
as_»f
(), 
k
, 25, 25, 30, 
Wr™eTy³
::
Lock
);

677 
mu¡_g‘_comm™_ts
(
’gše
.
as_»f
(), 
k
, 25, 30);

680 #[
‹¡
]

681 
â
 
‹¡_wr™e
() {

682 
‹¡_wr™e_imp
(
b
"kk", b"v1", b"k", b"kkk");

684 
Ët
 
	gv2
 = 
g’_v®ue
(
b
'x', 
SHORT_VALUE_MAX_LEN
 + 1);

685 
‹¡_wr™e_imp
(
b
"kk", &
v2
, b"k", b"kkk");

688 
â
 
‹¡_sÿn_keys_imp
(
keys
: 
Vec
<&[
u8
]>, 
v®ues
: Vec<&[u8]>) {

689 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

690 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
keys
[0], 
v®ues
[0], keys[0], 1);

691 
mu¡_comm™
(
’gše
.
as_»f
(), 
keys
[0], 1, 10);

692 
mu¡_´ewr™e_lock
(
’gše
.
as_»f
(), 
keys
[1], keys[1], 1);

693 
mu¡_comm™
(
’gše
.
as_»f
(), 
keys
[1], 1, 5);

694 
mu¡_´ewr™e_d–‘e
(
’gše
.
as_»f
(), 
keys
[2], keys[2], 1);

695 
mu¡_comm™
(
’gše
.
as_»f
(), 
keys
[2], 1, 20);

696 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
keys
[3], 
v®ues
[1], keys[3], 1);

697 
mu¡_´ewr™e_lock
(
’gše
.
as_»f
(), 
keys
[4], keys[4], 10);

698 
mu¡_´ewr™e_d–‘e
(
’gše
.
as_»f
(), 
keys
[5], keys[5], 5);

700 
mu¡_sÿn_keys
(

701 
’gše
.
as_»f
(),

702 
NÚe
,

704 
vec
![
keys
[0], keys[1], keys[2]],

705 
NÚe
,

707 
mu¡_sÿn_keys
(

708 
’gše
.
as_»f
(),

709 
NÚe
,

711 
vec
![
keys
[0], keys[1], keys[2]],

712 
NÚe
,

714 
mu¡_sÿn_keys
(

715 
’gše
.
as_»f
(),

716 
NÚe
,

718 
vec
![
keys
[0], keys[1]],

719 
Some
(
keys
[1]),

721 
mu¡_sÿn_keys
(

722 
’gše
.
as_»f
(),

723 
Some
(
keys
[1]),

725 
vec
![
keys
[1]],

726 
Some
(
keys
[1]),

730 #[
‹¡
]

731 
â
 
‹¡_sÿn_keys
() {

732 
‹¡_sÿn_keys_imp
(
vec
![
b
"a", b"c", b"e", b"b", b"d", b"f"], vec![b"a", b"b"]);

734 
Ët
 
	gv1
 = 
g’_v®ue
(
b
'x', 
SHORT_VALUE_MAX_LEN
 + 1);

735 
Ët
 
	gv4
 = 
g’_v®ue
(
b
'v', 
SHORT_VALUE_MAX_LEN
 + 1);

736 
‹¡_sÿn_keys_imp
(
vec
![
b
"a", b"c", b"e", b"b", b"d", b"f"], vec![&
v1
, &
v4
]);

739 
â
 
‹¡_wr™e_size_imp
(
k
: &[
u8
], 
v
: &[u8], 
pk
: &[u8]) {

740 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

741 
Ët
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

742 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

743 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 10, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

744 
Ët
 
	gkey
 = 
make_key
(
k
);

745 
	gas£¹_eq
!(
	gtxn
.
	gwr™e_size
, 0);

747 
	gas£¹
!(
	gtxn
.
g‘
(&
key
).
unw¿p
().
is_nÚe
());

748 
	gas£¹_eq
!(
	gtxn
.
	gwr™e_size
, 0);

750 
	gtxn
.
´ewr™e
(

751 
MutiÚ
::
Put
((
key
.
şÚe
(), 
v
.
to_vec
())),

752 
pk
,

753 &
O±iÚs
::(),

754 ).
unw¿p
();

755 
	gas£¹
!(
	gtxn
.
wr™e_size
() > 0);

756 
	g’gše
.
wr™e
(&
ùx
, 
txn
.
što_modif›s
()).
unw¿p
();

758 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

759 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 10, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

760 
	gtxn
.
comm™
(&
key
, 15).
unw¿p
();

761 
	gas£¹
!(
	gtxn
.
wr™e_size
() > 0);

762 
	g’gše
.
wr™e
(&
ùx
, 
txn
.
što_modif›s
()).
unw¿p
();

765 #[
‹¡
]

766 
â
 
‹¡_wr™e_size
() {

767 
‹¡_wr™e_size_imp
(
b
"key", b"value", b"pk");

769 
Ët
 
	gv
 = 
g’_v®ue
(
b
'x', 
SHORT_VALUE_MAX_LEN
 + 1);

770 
‹¡_wr™e_size_imp
(
b
"key", &
v
, b"pk");

773 #[
‹¡
]

774 
â
 
‹¡_sk_cÚ¡¿št_check
() {

775 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

776 
Ët
 (
key
, 
v®ue
èğ(
b
"key", 
	gb
"value");

778 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
key
, 
v®ue
, key, 5);

779 
mu¡_comm™
(
’gše
.
as_»f
(), 
key
, 5, 10);

781 
Ët
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

782 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

783 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 5, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

784 
	gas£¹
!(

785 
	gtxn
.
´ewr™e
(

786 
MutiÚ
::
Put
((
make_key
(
key
), 
v®ue
.
to_vec
())),

787 
key
,

788 &
O±iÚs
::()

789 ).
is_”r
()

792 
Ët
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

793 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

794 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 5, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

795 
Ët
 
mut
 
	gİt
 = 
O±iÚs
::();

796 
	gİt
.
	gsk_cÚ¡¿št_check
 = 
Œue
;

797 
	gas£¹
!(

798 
	gtxn
.
´ewr™e
(
MutiÚ
::
Put
((
make_key
(
key
), 
v®ue
.
to_vec
())), key, &
İt
)

799 .
is_ok
()

803 #[
‹¡
]

804 
â
 
‹¡_»ad_comm™
() {

805 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

806 
Ët
 (
key
, 
v1
, 
v2
èğ(
b
"key", 
	gb
"v1", b"v2");

808 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
key
, 
v1
, key, 5);

809 
mu¡_comm™
(
’gše
.
as_»f
(), 
key
, 5, 10);

810 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), 
key
, 
v2
, key, 15);

811 
mu¡_g‘_”r
(
’gše
.
as_»f
(), 
key
, 20);

812 
mu¡_g‘_rc
(
’gše
.
as_»f
(), 
key
, 12, 
v1
);

813 
mu¡_g‘_rc
(
’gše
.
as_»f
(), 
key
, 20, 
v1
);

816 
â
 
mu¡_g‘
(
’gše
: &
Engše
, 
key
: &[
u8
], 
ts
: 
u64
, 
ex³ù
: &[u8]) {

817 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

818 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

819 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

820 
	gas£¹_eq
!(
	gtxn
.
g‘
(&
make_key
(
key
)).
unw¿p
().unw¿p(), 
	gex³ù
);

823 
â
 
mu¡_g‘_rc
(
’gše
: &
Engše
, 
key
: &[
u8
], 
ts
: 
u64
, 
ex³ù
: &[u8]) {

824 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

825 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

826 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
ts
, 
NÚe
, 
IsŞ©iÚLev–
::
RC
, 
Œue
);

827 
	gas£¹_eq
!(
	gtxn
.
g‘
(&
make_key
(
key
)).
unw¿p
().unw¿p(), 
	gex³ù
)

830 
â
 
mu¡_g‘_nÚe
(
’gše
: &
Engše
, 
key
: &[
u8
], 
ts
: 
u64
) {

831 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

832 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

833 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

834 
	gas£¹
!(
	gtxn
.
g‘
(&
make_key
(
key
)).
unw¿p
().
is_nÚe
());

837 
â
 
mu¡_g‘_”r
(
’gše
: &
Engše
, 
key
: &[
u8
], 
ts
: 
u64
) {

838 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

839 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

840 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

841 
	gas£¹
!(
	gtxn
.
g‘
(&
make_key
(
key
)).
is_”r
());

844 
â
 
mu¡_´ewr™e_put
(
’gše
: &
Engše
, 
key
: &[
u8
], 
v®ue
: &[u8], 
pk
: &[u8], 
ts
: 
u64
) {

845 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

846 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

847 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

848 
	gtxn
.
´ewr™e
(

849 
MutiÚ
::
Put
((
make_key
(
key
), 
v®ue
.
to_vec
())),

850 
pk
,

851 &
O±iÚs
::(),

852 ).
unw¿p
();

853 
	g’gše
.
wr™e
(&
ùx
, 
txn
.
što_modif›s
()).
unw¿p
();

856 
â
 
mu¡_´ewr™e_d–‘e
(
’gše
: &
Engše
, 
key
: &[
u8
], 
pk
: &[u8], 
ts
: 
u64
) {

857 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

858 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

859 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

860 
	gtxn
.
´ewr™e
(
MutiÚ
::
D–‘e
(
make_key
(
key
)), 
pk
, &
O±iÚs
::())

861 .
unw¿p
();

862 
	g’gše
.
wr™e
(&
ùx
, 
txn
.
što_modif›s
()).
unw¿p
();

865 
â
 
mu¡_´ewr™e_lock
(
’gše
: &
Engše
, 
key
: &[
u8
], 
pk
: &[u8], 
ts
: 
u64
) {

866 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

867 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

868 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

869 
	gtxn
.
´ewr™e
(
MutiÚ
::
Lock
(
make_key
(
key
)), 
pk
, &
O±iÚs
::())

870 .
unw¿p
();

871 
	g’gše
.
wr™e
(&
ùx
, 
txn
.
što_modif›s
()).
unw¿p
();

874 
â
 
mu¡_´ewr™e_lock_”r
(
’gše
: &
Engše
, 
key
: &[
u8
], 
pk
: &[u8], 
ts
: 
u64
) {

875 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

876 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

877 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

878 
	gas£¹
!(

879 
	gtxn
.
´ewr™e
(
MutiÚ
::
Lock
(
make_key
(
key
)), 
pk
, &
O±iÚs
::())

880 .
is_”r
()

884 
â
 
mu¡_comm™
(
’gše
: &
Engše
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

885 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

886 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

887 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

888 
	gtxn
.
comm™
(&
make_key
(
key
), 
comm™_ts
).
unw¿p
();

889 
	g’gše
.
wr™e
(&
ùx
, 
txn
.
što_modif›s
()).
unw¿p
();

892 
â
 
mu¡_comm™_”r
(
’gše
: &
Engše
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

893 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

894 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

895 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

896 
	gas£¹
!(
	gtxn
.
comm™
(&
make_key
(
key
), 
comm™_ts
).
is_”r
());

899 
â
 
mu¡_rŞlback
(
’gše
: &
Engše
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
) {

900 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

901 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

902 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

903 
	gtxn
.
rŞlback
(&
make_key
(
key
)).
unw¿p
();

904 
	g’gše
.
wr™e
(&
ùx
, 
txn
.
što_modif›s
()).
unw¿p
();

907 
â
 
mu¡_rŞlback_”r
(
’gše
: &
Engše
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
) {

908 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

909 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

910 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 
¡¬t_ts
, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

911 
	gas£¹
!(
	gtxn
.
rŞlback
(&
make_key
(
key
)).
is_”r
());

914 
â
 
mu¡_gc
(
’gše
: &
Engše
, 
key
: &[
u8
], 
§ã_pošt
: 
u64
) {

915 
Ët
 
ùx
 = 
CÚ‹xt
::
Ãw
();

916 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

917 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(
¢­shÙ
, 0, 
NÚe
, 
IsŞ©iÚLev–
::
SI
, 
Œue
);

918 
	gtxn
.
gc
(&
make_key
(
key
), 
§ã_pošt
).
unw¿p
();

919 
	g’gše
.
wr™e
(&
ùx
, 
txn
.
što_modif›s
()).
unw¿p
();

922 
â
 
mu¡_locked
(
’gše
: &
Engše
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
) {

923 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

924 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(
¢­shÙ
, 
NÚe
, 
Œue
, NÚe, 
IsŞ©iÚLev–
::
SI
);

925 
Ët
 
	glock
 = 
»ad”
.
lßd_lock
(&
make_key
(
key
)).
unw¿p
().unwrap();

926 
	gas£¹_eq
!(
	glock
.
	gts
, 
	g¡¬t_ts
);

929 
â
 
mu¡_uÆocked
(
’gše
: &
Engše
, 
key
: &[
u8
]) {

930 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

931 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(
¢­shÙ
, 
NÚe
, 
Œue
, NÚe, 
IsŞ©iÚLev–
::
SI
);

932 
	gas£¹
!(
	g»ad”
.
lßd_lock
(&
make_key
(
key
)).
unw¿p
().
is_nÚe
());

935 
â
 
mu¡_wr™‹n
(
’gše
: &
Engše
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64, 

: 
Wr™eTy³
) {

936 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

937 
Ët
 
	gk
 = 
make_key
(
key
).
­³nd_ts
(
comm™_ts
);

938 
Ët
 
	gv
 = 
¢­shÙ
.
g‘_cf
(
CF_WRITE
, &
k
).
unw¿p
().unwrap();

939 
Ët
 
	gwr™e
 = 
Wr™e
::
·r£
(&
v
).
unw¿p
();

940 
	gas£¹_eq
!(
	gwr™e
.
	g¡¬t_ts
, start_ts);

941 
	gas£¹_eq
!(
	gwr™e
.
	gwr™e_ty³
, 
	g
);

944 
â
 
mu¡_£ek_wr™e_nÚe
(
’gše
: &
Engše
, 
key
: &[
u8
], 
ts
: 
u64
) {

945 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

946 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(
¢­shÙ
, 
NÚe
, 
Œue
, NÚe, 
IsŞ©iÚLev–
::
SI
);

947 
	gas£¹
!(
	g»ad”
.
£ek_wr™e
(&
make_key
(
key
), 
ts
).
unw¿p
().
is_nÚe
());

950 
â
 
mu¡_£ek_wr™e
(

951 
’gše
: &
Engše
,

952 
key
: &[
u8
],

953 
ts
: 
u64
,

954 
¡¬t_ts
: 
u64
,

955 
comm™_ts
: 
u64
,

956 
wr™e_ty³
: 
Wr™eTy³
,

958 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

959 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(
¢­shÙ
, 
NÚe
, 
Œue
, NÚe, 
IsŞ©iÚLev–
::
SI
);

960 
Ët
 (
t
, 
wr™e
èğ
»ad”
.
£ek_wr™e
(&
make_key
(
key
), 
ts
).
unw¿p
().unwrap();

961 
	gas£¹_eq
!(
	gt
, 
	gcomm™_ts
);

962 
	gas£¹_eq
!(
	gwr™e
.
	g¡¬t_ts
, start_ts);

963 
	gas£¹_eq
!(
	gwr™e
.
	gwr™e_ty³
, write_type);

966 
â
 
mu¡_»v”£_£ek_wr™e_nÚe
(
’gše
: &
Engše
, 
key
: &[
u8
], 
ts
: 
u64
) {

967 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

968 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(
¢­shÙ
, 
NÚe
, 
Œue
, NÚe, 
IsŞ©iÚLev–
::
SI
);

969 
	gas£¹
!(

970 
	g»ad”


971 .
»v”£_£ek_wr™e
(&
make_key
(
key
), 
ts
)

972 .
unw¿p
()

973 .
is_nÚe
()

977 
â
 
mu¡_»v”£_£ek_wr™e
(

978 
’gše
: &
Engše
,

979 
key
: &[
u8
],

980 
ts
: 
u64
,

981 
¡¬t_ts
: 
u64
,

982 
comm™_ts
: 
u64
,

983 
wr™e_ty³
: 
Wr™eTy³
,

985 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

986 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(
¢­shÙ
, 
NÚe
, 
Œue
, NÚe, 
IsŞ©iÚLev–
::
SI
);

987 
Ët
 (
t
, 
wr™e
èğ
»ad”


988 .
»v”£_£ek_wr™e
(&
make_key
(
key
), 
ts
)

989 .
unw¿p
()

990 .
unw¿p
();

991 
	gas£¹_eq
!(
	gt
, 
	gcomm™_ts
);

992 
	gas£¹_eq
!(
	gwr™e
.
	g¡¬t_ts
, start_ts);

993 
	gas£¹_eq
!(
	gwr™e
.
	gwr™e_ty³
, write_type);

996 
â
 
mu¡_g‘_comm™_ts
(
’gše
: &
Engše
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

997 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

998 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(
¢­shÙ
, 
NÚe
, 
Œue
, NÚe, 
IsŞ©iÚLev–
::
SI
);

999 
Ët
 (
ts
, 
wr™e_ty³
èğ
»ad”


1000 .
g‘_txn_comm™_šfo
(&
make_key
(
key
), 
¡¬t_ts
)

1001 .
unw¿p
()

1002 .
unw¿p
();

1003 
	gas£¹_Ã
!(
	gwr™e_ty³
, 
	gWr™eTy³
::
RŞlback
);

1004 
	gas£¹_eq
!(
	gts
, 
	gcomm™_ts
);

1007 
â
 
mu¡_g‘_comm™_ts_nÚe
(
’gše
: &
Engše
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
) {

1008 
Ët
 
¢­shÙ
 = 
’gše
.¢­shÙ(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

1009 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(
¢­shÙ
, 
NÚe
, 
Œue
, NÚe, 
IsŞ©iÚLev–
::
SI
);

1011 
Ët
 
	g»t
 = 
»ad”
.
g‘_txn_comm™_šfo
(&
make_key
(
key
), 
¡¬t_ts
);

1012 
	gas£¹
!(
	g»t
.
is_ok
());

1013 
m©ch
 
	g»t
.
unw¿p
() {

1014 
	gNÚe
 => {}

1015 
Some
((
_
, 
wr™e_ty³
)) => {

1016 
as£¹_eq
!(
wr™e_ty³
, 
Wr™eTy³
::
RŞlback
);

1021 
â
 
mu¡_sÿn_keys
(

1022 
’gše
: &
Engše
,

1023 
¡¬t
: 
O±iÚ
<&[
u8
]>,

1024 
lim™
: 
usize
,

1025 
keys
: 
Vec
<&[
u8
]>,

1026 
Ãxt_¡¬t
: 
O±iÚ
<&[
u8
]>,

1028 
Ët
 
	gex³ù
 = (

1029 
keys
.
što_™”
().
m­
(
make_key
).
cŞËù
(),

1030 
	gÃxt_¡¬t
.
m­
(|
x
| 
make_key
(x).
­³nd_ts
(0)),

1032 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

1033 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(

1034 
¢­shÙ
,

1035 
Some
(
SÿnMode
::
Mixed
),

1036 
çl£
,

1037 
NÚe
,

1038 
IsŞ©iÚLev–
::
SI
,

1040 
	gas£¹_eq
!(

1041 
	g»ad”
.
sÿn_keys
(
¡¬t
.
m­
(
make_key
), 
lim™
).
unw¿p
(),

1042 
	gex³ù


1046 #[
‹¡
]

1047 
â
 
‹¡_sÿn_v®ues_š_deçuÉ
() {

1048 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("_‹¡_sÿn_v®ues_š_deçuÉ").
ex³ù
("");

1049 
Ët
 
	g·th
 = 
·th
.·th().
to_¡r
().
unw¿p
();

1050 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
·th
, 
ALL_CFS
).
unw¿p
();

1052 
mu¡_´ewr™e_put
(

1053 
’gše
.
as_»f
(),

1055 &
g’_v®ue
(
b
'v', 
SHORT_VALUE_MAX_LEN
 + 1),

1059 
mu¡_comm™
(
’gše
.
as_»f
(), &[2], 3, 3);

1061 
mu¡_´ewr™e_put
(

1062 
’gše
.
as_»f
(),

1064 &
g’_v®ue
(
b
'a', 
SHORT_VALUE_MAX_LEN
 + 1),

1068 
mu¡_comm™
(
’gše
.
as_»f
(), &[3], 3, 4);

1070 
mu¡_´ewr™e_put
(

1071 
’gše
.
as_»f
(),

1073 &
g’_v®ue
(
b
'b', 
SHORT_VALUE_MAX_LEN
 + 1),

1077 
mu¡_comm™
(
’gše
.
as_»f
(), &[3], 5, 5);

1079 
mu¡_´ewr™e_put
(

1080 
’gše
.
as_»f
(),

1082 &
g’_v®ue
(
b
'x', 
SHORT_VALUE_MAX_LEN
 + 1),

1086 
mu¡_comm™
(
’gše
.
as_»f
(), &[6], 3, 6);

1088 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

1089 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(

1090 
¢­shÙ
,

1091 
Some
(
SÿnMode
::
FÜw¬d
),

1092 
Œue
,

1093 
NÚe
,

1094 
IsŞ©iÚLev–
::
SI
,

1097 
Ët
 
	gv
 = 
»ad”
.
sÿn_v®ues_š_deçuÉ
(&
make_key
(&[3])).
unw¿p
();

1098 
	gas£¹_eq
!(
	gv
.
Ën
(), 2);

1099 
	gas£¹_eq
!(
	gv
[1], (3, 
g’_v®ue
(
b
'a', 
SHORT_VALUE_MAX_LEN
 + 1)));

1100 
	gas£¹_eq
!(
	gv
[0], (5, 
g’_v®ue
(
b
'b', 
SHORT_VALUE_MAX_LEN
 + 1)));

1103 #[
‹¡
]

1104 
â
 
‹¡_£ek_ts
() {

1105 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("_‹¡_£ek_ts").
ex³ù
("");

1106 
Ët
 
	g·th
 = 
·th
.·th().
to_¡r
().
unw¿p
();

1107 
Ët
 
	g’gše
 = 
’gše
::
Ãw_loÿl_’gše
(
·th
, 
ALL_CFS
).
unw¿p
();

1109 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), &[2], &
g’_v®ue
(
b
'v', 2), &[2], 3);

1110 
mu¡_comm™
(
’gše
.
as_»f
(), &[2], 3, 3);

1112 
mu¡_´ewr™e_put
(

1113 
’gše
.
as_»f
(),

1115 &
g’_v®ue
(
b
'a', 
SHORT_VALUE_MAX_LEN
 + 1),

1119 
mu¡_comm™
(
’gše
.
as_»f
(), &[3], 4, 4);

1121 
mu¡_´ewr™e_put
(

1122 
’gše
.
as_»f
(),

1124 &
g’_v®ue
(
b
'b', 
SHORT_VALUE_MAX_LEN
 + 1),

1128 
mu¡_comm™
(
’gše
.
as_»f
(), &[5], 2, 5);

1130 
mu¡_´ewr™e_put
(
’gše
.
as_»f
(), &[6], &
g’_v®ue
(
b
'x', 3), &[6], 3);

1131 
mu¡_comm™
(
’gše
.
as_»f
(), &[6], 3, 6);

1133 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
CÚ‹xt
::
Ãw
()).
unw¿p
();

1134 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(

1135 
¢­shÙ
,

1136 
Some
(
SÿnMode
::
FÜw¬d
),

1137 
Œue
,

1138 
NÚe
,

1139 
IsŞ©iÚLev–
::
SI
,

1142 
	gas£¹_eq
!(
	g»ad”
.
£ek_ts
(3).
unw¿p
().unw¿p(), 
make_key
(&[2]));

	@src/storage/mvcc/write.rs

14 
u£
 
	gby‹Üd”
::
R—dBy‹sExt
;

15 
u£
 
	gut
::
codec
::
numb”
::{
MAX_VAR_U64_LEN
, 
	gNumb”Decod”
, 
	gNumb”Encod”
};

16 
u£
 
	g¡Üage
::{
SHORT_VALUE_MAX_LEN
, 
	gSHORT_VALUE_PREFIX
};

17 
u£
 
	gsu³r
::
lock
::
LockTy³
;

18 
u£
 
	gsu³r
::{
E¼Ü
, 
	gResuÉ
};

19 
u£
 
	gsu³r
::
su³r
::
ty³s
::
V®ue
;

21 #[
d”ive
(
Debug
, 
ClÚe
, 
Cİy
, 
P¬tŸlEq
)]

22 
pub
 
	eWr™eTy³
 {

23 
	mPut
,

24 
	mD–‘e
,

25 
	mLock
,

26 
	mRŞlback
,

29 cÚ¡ 
	gFLAG_PUT
: 
u8
 = 
b
'P';

30 cÚ¡ 
	gFLAG_DELETE
: 
u8
 = 
b
'D';

31 cÚ¡ 
	gFLAG_LOCK
: 
u8
 = 
b
'L';

32 cÚ¡ 
	gFLAG_ROLLBACK
: 
u8
 = 
b
'R';

34 
im¶
 
	gWr™eTy³
 {

35 
pub
 
â
 
äom_lock_ty³
(

: 
LockTy³
è-> 
Wr™eTy³
 {

36 
m©ch
 

 {

37 
LockTy³
::
Put
 => 
Wr™eTy³
::Put,

38 
	gLockTy³
::
D–‘e
 => 
Wr™eTy³
::Delete,

39 
	gLockTy³
::
Lock
 => 
Wr™eTy³
::Lock,

43 
pub
 
â
 
äom_u8
(
b
: 
u8
è-> 
O±iÚ
<
Wr™eTy³
> {

44 
m©ch
 
b
 {

45 
FLAG_PUT
 => 
Some
(
Wr™eTy³
::
Put
),

46 
	gFLAG_DELETE
 => 
Some
(
Wr™eTy³
::
D–‘e
),

47 
	gFLAG_LOCK
 => 
Some
(
Wr™eTy³
::
Lock
),

48 
	gFLAG_ROLLBACK
 => 
Some
(
Wr™eTy³
::
RŞlback
),

49 
	g_
 => 
NÚe
,

53 
â
 
to_u8
(&
£lf
è-> 
	gu8
 {

54 
m©ch
 *
	g£lf
 {

55 
	gWr™eTy³
::
Put
 => 
FLAG_PUT
,

56 
	gWr™eTy³
::
D–‘e
 => 
FLAG_DELETE
,

57 
	gWr™eTy³
::
Lock
 => 
FLAG_LOCK
,

58 
	gWr™eTy³
::
RŞlback
 => 
FLAG_ROLLBACK
,

63 #[
d”ive
(
P¬tŸlEq
, 
Debug
, 
ClÚe
)]

64 
pub
 
	sWr™e
 {

65 
pub
 
	mwr™e_ty³
: 
Wr™eTy³
,

66 
pub
 
	m¡¬t_ts
: 
u64
,

67 
pub
 
	mshÜt_v®ue
: 
O±iÚ
<
V®ue
>,

70 
im¶
 
	gWr™e
 {

71 
pub
 
â
 
Ãw
(
wr™e_ty³
: 
Wr™eTy³
, 
¡¬t_ts
: 
u64
, 
shÜt_v®ue
: 
O±iÚ
<
V®ue
>è-> 
Wr™e
 {

72 
Wr™e
 {

73 
wr™e_ty³
: write_type,

74 
	g¡¬t_ts
: 
¡¬t_ts
,

75 
	gshÜt_v®ue
: 
shÜt_v®ue
,

79 
pub
 
â
 
to_by‹s
(&
£lf
è-> 
	gVec
<
	gu8
> {

80 
Ët
 
mut
 
	gb
 = 
Vec
::
w™h_ÿ·c™y
(1 + 
MAX_VAR_U64_LEN
 + 
SHORT_VALUE_MAX_LEN
 + 2);

81 
	gb
.
push
(
£lf
.
wr™e_ty³
.
to_u8
());

82 
	gb
.
’code_v¬_u64
(
£lf
.
¡¬t_ts
).
unw¿p
();

83 
Ët
 
Some
(
»f
 
v
èğ
£lf
.
shÜt_v®ue
 {

84 
b
.
push
(
SHORT_VALUE_PREFIX
);

85 
	gb
.
push
(
v
.
Ën
(è
as
 
u8
);

86 
	gb
.
ex‹nd_äom_¦iû
(
v
);

88 
	gb


91 
pub
 
â
 
·r£
(
mut
 
b
: &[
u8
]è-> 
ResuÉ
<
Wr™e
> {

92 
b
.
is_em±y
() {

93  
E¼
(
E¼Ü
::
BadFÜm©Wr™e
);

95 
Ët
 
	gwr™e_ty³
 = 
Wr™eTy³
::
äom_u8
(
b
.
»ad_u8
()?)

96 .
ok_Ü
(
E¼Ü
::
BadFÜm©Wr™e
)?;

97 
Ët
 
	g¡¬t_ts
 = 
b
.
decode_v¬_u64
()?;

98 
	gb
.
is_em±y
() {

99  
Ok
(
Wr™e
::
Ãw
(
wr™e_ty³
, 
¡¬t_ts
, 
NÚe
));

102 
Ët
 
	gæag
 = 
b
.
»ad_u8
()?;

103 
	gas£¹_eq
!(

104 
	gæag
,

105 
	gSHORT_VALUE_PREFIX
,

107 
	gæag


110 
Ët
 
	gËn
 = 
b
.
»ad_u8
()?;

111 
Ën
 
as
 
	gusize
 !ğ
b
.len() {

112 
·nic
!(

114 
Ën
,

115 
b
.
Ën
()

118 
Ok
(
Wr™e
::
Ãw
(
wr™e_ty³
, 
¡¬t_ts
, 
Some
(
b
.
to_vec
())))

122 #[
cfg
(
‹¡
)]

123 
mod
 
	g‹¡s
 {

124 
u£
 
	gsu³r
::
su³r
::
LockTy³
;

125 
u£
 
	gsu³r
::*;

127 #[
‹¡
]

128 
â
 
‹¡_wr™e_ty³
() {

129 
Ët
 
mut
 
	g‹¡s
 = 
vec
![

130 (
Some
(
LockTy³
::
Put
), 
Wr™eTy³
::Put, 
FLAG_PUT
),

131 (
Some
(
LockTy³
::
D–‘e
), 
Wr™eTy³
::D–‘e, 
FLAG_DELETE
),

132 (
Some
(
LockTy³
::
Lock
), 
Wr™eTy³
::Lock, 
FLAG_LOCK
),

133 (
NÚe
, 
Wr™eTy³
::
RŞlback
, 
FLAG_ROLLBACK
),

135 
	gi
, (
	glock_ty³
, 
	gwr™e_ty³
, 
	gæag
)è
š
 
	g‹¡s
.
d¿š
(..).
’um”©e
() {

136 
	glock_ty³
.
is_some
() {

137 
Ët
 
	gwt
 = 
Wr™eTy³
::
äom_lock_ty³
(
lock_ty³
.
unw¿p
());

138 
	gas£¹_eq
!(

139 
	gwt
,

140 
	gwr™e_ty³
,

142 
	gi
,

143 
	glock_ty³
,

144 
	gwr™e_ty³
,

145 
	gwt


148 
Ët
 
	gf
 = 
wr™e_ty³
.
to_u8
();

149 
	gas£¹_eq
!(

150 
	gf
,

151 
	gæag
,

153 
	gi
,

154 
	gwr™e_ty³
,

155 
	gæag
,

156 
	gf


158 
Ët
 
	gwt
 = 
Wr™eTy³
::
äom_u8
(
æag
).
unw¿p
();

159 
	gas£¹_eq
!(

160 
	gwt
,

161 
	gwr™e_ty³
,

163 
	gi
,

164 
	gæag
,

165 
	gwr™e_ty³
,

166 
	gwt


171 #[
‹¡
]

172 
â
 
‹¡_wr™e
() {

174 
Ët
 
mut
 
	gwr™es
 = 
vec
![

175 
Wr™e
::
Ãw
(
Wr™eTy³
::
Put
, 0, 
NÚe
),

176 
Wr™e
::
Ãw
(
Wr™eTy³
::
D–‘e
, 0, 
Some
(
b
"shÜt_v®ue".
to_vec
())),

178 
	gi
, 
	gwr™e
è
š
 
	gwr™es
.
d¿š
(..).
’um”©e
() {

179 
Ët
 
	gv
 = 
wr™e
.
to_by‹s
();

180 
Ët
 
	gw
 = 
Wr™e
::
·r£
(&
v
[..]).
unw¿p_Ü_–£
(|
e
| 
·nic
!("#{}…¬£(è”r: {:?}", 
i
,ƒ));

181 
	gas£¹_eq
!(
	gw
, 
	gwr™e
, "#{}ƒx³ù {:?}, buˆgÙ {:?}", 
	gi
, write, w);

185 
	gas£¹
!(
	gWr™e
::
·r£
(
b
"").
is_”r
());

187 
Ët
 
	glock
 = 
Wr™e
::
Ãw
(
Wr™eTy³
::
Lock
, 1, 
Some
(
b
"shÜt_v®ue".
to_vec
()));

188 
Ët
 
	gv
 = 
lock
.
to_by‹s
();

189 
	gas£¹
!(
	gWr™e
::
·r£
(&
v
[..1]).
is_”r
());

	@src/storage/txn/latch.rs

15 #![
®low
(
d•»ÿ‹d
)]

17 
u£
 
	g¡d
::
cŞËùiÚs
::
VecDeque
;

18 
u£
 
	g¡d
::
hash
::{
Hash
, 
	gHash”
, 
SHash”
 
as
 
	gDeçuÉHash”
};

19 
u£
 
	g¡d
::
usize
;

28 #[
d”ive
(
ClÚe
)]

29 
	sL©ch
 {

31 
pub
 
	mwa™šg
: 
VecDeque
<
u64
>,

34 
im¶
 
	gL©ch
 {

36 
pub
 
â
 
Ãw
(è-> 
	gL©ch
 {

37 
	gL©ch
 {

38 
	gwa™šg
: 
VecDeque
::
Ãw
(),

44 #[
d”ive
(
ClÚe
)]

45 
pub
 
	sLock
 {

47 
pub
 
	m»quœed_¦Ùs
: 
Vec
<
usize
>,

50 
pub
 
	mowÃd_couÁ
: 
usize
,

53 
im¶
 
	gLock
 {

55 
pub
 
â
 
Ãw
(
»quœed_¦Ùs
: 
Vec
<
usize
>è-> 
Lock
 {

56 
Lock
 {

57 
»quœed_¦Ùs
:„equired_slots,

58 
	gowÃd_couÁ
: 0,

63 
pub
 
â
 
acquœed
(&
£lf
è-> 
	gboŞ
 {

64 
	g£lf
.
	g»quœed_¦Ùs
.
Ën
(è=ğ
£lf
.
owÃd_couÁ


67 
pub
 
â
 
is_wr™e_lock
(&
£lf
è-> 
	gboŞ
 {

68 !
	g£lf
.
	g»quœed_¦Ùs
.
is_em±y
()

76 
pub
 
	sL©ches
 {

77 
	m¦Ùs
: 
Vec
<
L©ch
>,

78 
	msize
: 
usize
,

81 
im¶
 
	gL©ches
 {

85 
pub
 
â
 
Ãw
(
size
: 
usize
è-> 
L©ches
 {

86 
Ët
 
pow”_of_two_size
 = 
usize
::
Ãxt_pow”_of_two
(
size
);

87 
	gL©ches
 {

88 
	g¦Ùs
: 
vec
![
L©ch
::
Ãw
(); 
pow”_of_two_size
],

89 
	gsize
: 
pow”_of_two_size
,

94 
pub
 
â
 
	gg’_lock
<
	gH
>(&
	g£lf
, 
	gkeys
: &[
H
]è-> 
Lock


95 
wh”e


96 
H
: 
Hash
,

99 
Ët
 
mut
 
	g¦Ùs
: 
Vec
<
usize
> = 
keys
.
™”
().
m­
(|
x
| 
£lf
.
ÿlc_¦Ù
(x)).
cŞËù
();

100 
	g¦Ùs
.
sÜt
();

101 
	g¦Ùs
.
dedup
();

102 
	gLock
::
Ãw
(
¦Ùs
)

110 
pub
 
â
 
acquœe
(&
mut
 
£lf
, 
lock
: &muˆ
Lock
, 
who
: 
u64
è-> 
boŞ
 {

111 
Ët
 
mut
 
acquœed_couÁ
: 
usize
 = 0;

112 
i
 
	gš
 &
	glock
.
	g»quœed_¦Ùs
[
lock
.
owÃd_couÁ
..] {

113 
Ët
 
	gÏtch
 = &
mut
 
£lf
.
¦Ùs
[*
i
];

115 
Ët
 
	gäÚt
 = 
Ïtch
.
wa™šg
.
äÚt
().
şÚed
();

116 
m©ch
 
	gäÚt
 {

117 
Some
(
cid
è=> cid =ğ
who
 {

118 
acquœed_couÁ
 += 1;

120 
	gÏtch
.
	gwa™šg
.
push_back
(
who
);

123 
	gNÚe
 => {

124 
Ïtch
.
wa™šg
.
push_back
(
who
);

125 
	gacquœed_couÁ
 += 1;

130 
	glock
.
	gowÃd_couÁ
 +ğ
acquœed_couÁ
;

131 
	glock
.
acquœed
()

137 
pub
 
â
 
»Ëa£
(&
mut
 
£lf
, 
lock
: &
Lock
, 
who
: 
u64
è-> 
Vec
<u64> {

138 
Ët
 
mut
 
wakeup_li¡
: 
Vec
<
u64
> = 
vec
![];

139 
i
 
	gš
 &
	glock
.
	g»quœed_¦Ùs
[..
lock
.
owÃd_couÁ
] {

140 
Ët
 
	gÏtch
 = &
mut
 
£lf
.
¦Ùs
[*
i
];

141 
Ët
 
	gäÚt
 = 
Ïtch
.
wa™šg
.
pİ_äÚt
().
unw¿p
();

142 
	gas£¹_eq
!(
	gäÚt
, 
	gwho
);

144 
Ët
 
Some
(
wakeup
èğ
Ïtch
.
wa™šg
.
äÚt
() {

145 
wakeup_li¡
.
push
(*
wakeup
);

148 
	gwakeup_li¡


152 
â
 
	gÿlc_¦Ù
<
	gH
>(&
	g£lf
, 
	gkey
: &
H
è-> 
usize


153 
wh”e


154 
H
: 
Hash
,

156 
Ët
 
mut
 
	gs
 = 
DeçuÉHash”
::
Ãw
();

157 
	gkey
.
hash
(&
mut
 
s
);

158 (
	gs
.
fšish
(è
as
 
	gusize
è& (
	g£lf
.
	gsize
 - 1)

162 #[
cfg
(
‹¡
)]

163 
mod
 
	g‹¡s
 {

164 
u£
 
	gsu³r
::{
L©ches
, 
	gLock
};

166 #[
‹¡
]

167 
â
 
‹¡_wakeup
() {

168 
Ët
 
mut
 
	gÏtches
 = 
L©ches
::
Ãw
(256);

170 
Ët
 
	g¦Ùs_a
: 
Vec
<
usize
> = 
vec
![1, 3, 5];

171 
Ët
 
mut
 
	glock_a
 = 
Lock
::
Ãw
(
¦Ùs_a
);

172 
Ët
 
	g¦Ùs_b
: 
Vec
<
usize
> = 
vec
![4, 5, 6];

173 
Ët
 
mut
 
	glock_b
 = 
Lock
::
Ãw
(
¦Ùs_b
);

174 
Ët
 
	gcid_a
: 
u64
 = 1;

175 
Ët
 
	gcid_b
: 
u64
 = 2;

178 
Ët
 
	gacquœed_a
 = 
Ïtches
.
acquœe
(&
mut
 
lock_a
, 
cid_a
);

179 
	gas£¹_eq
!(
	gacquœed_a
, 
	gŒue
);

182 
Ët
 
mut
 
	gacquœed_b
 = 
Ïtches
.
acquœe
(&muˆ
lock_b
, 
cid_b
);

183 
	gas£¹_eq
!(
	gacquœed_b
, 
	gçl£
);

186 
Ët
 
	gwakeup
 = 
Ïtches
.
»Ëa£
(&
lock_a
, 
cid_a
);

187 
	gas£¹_eq
!(
	gwakeup
[0], 
	gcid_b
);

190 
	gacquœed_b
 = 
Ïtches
.
acquœe
(&
mut
 
lock_b
, 
cid_b
);

191 
	gas£¹_eq
!(
	gacquœed_b
, 
	gŒue
);

194 #[
‹¡
]

195 
â
 
‹¡_wakeup_by_muÉi_cmds
() {

196 
Ët
 
mut
 
	gÏtches
 = 
L©ches
::
Ãw
(256);

198 
Ët
 
	g¦Ùs_a
: 
Vec
<
usize
> = 
vec
![1, 2, 3];

199 
Ët
 
	g¦Ùs_b
: 
Vec
<
usize
> = 
vec
![4, 5, 6];

200 
Ët
 
	g¦Ùs_c
: 
Vec
<
usize
> = 
vec
![3, 4];

201 
Ët
 
mut
 
	glock_a
 = 
Lock
::
Ãw
(
¦Ùs_a
);

202 
Ët
 
mut
 
	glock_b
 = 
Lock
::
Ãw
(
¦Ùs_b
);

203 
Ët
 
mut
 
	glock_c
 = 
Lock
::
Ãw
(
¦Ùs_c
);

204 
Ët
 
	gcid_a
: 
u64
 = 1;

205 
Ët
 
	gcid_b
: 
u64
 = 2;

206 
Ët
 
	gcid_c
: 
u64
 = 3;

209 
Ët
 
	gacquœed_a
 = 
Ïtches
.
acquœe
(&
mut
 
lock_a
, 
cid_a
);

210 
	gas£¹_eq
!(
	gacquœed_a
, 
	gŒue
);

213 
Ët
 
	gacquœed_b
 = 
Ïtches
.
acquœe
(&
mut
 
lock_b
, 
cid_b
);

214 
	gas£¹_eq
!(
	gacquœed_b
, 
	gŒue
);

217 
Ët
 
mut
 
	gacquœed_c
 = 
Ïtches
.
acquœe
(&muˆ
lock_c
, 
cid_c
);

218 
	gas£¹_eq
!(
	gacquœed_c
, 
	gçl£
);

221 
Ët
 
	gwakeup
 = 
Ïtches
.
»Ëa£
(&
lock_a
, 
cid_a
);

222 
	gas£¹_eq
!(
	gwakeup
[0], 
	gcid_c
);

225 
	gacquœed_c
 = 
Ïtches
.
acquœe
(&
mut
 
lock_c
, 
cid_c
);

226 
	gas£¹_eq
!(
	gacquœed_c
, 
	gçl£
);

229 
Ët
 
	gwakeup
 = 
Ïtches
.
»Ëa£
(&
lock_b
, 
cid_b
);

230 
	gas£¹_eq
!(
	gwakeup
[0], 
	gcid_c
);

233 
	gacquœed_c
 = 
Ïtches
.
acquœe
(&
mut
 
lock_c
, 
cid_c
);

234 
	gas£¹_eq
!(
	gacquœed_c
, 
	gŒue
);

	@src/storage/txn/mod.rs

14 
mod
 
	g¡Üe
;

15 
mod
 
	gscheduËr
;

16 
mod
 
	gÏtch
;

18 
u£
 
	g¡d
::
”rÜ
;

19 
u£
 
	g¡d
::
io
::
E¼Ü
 
as
 
IoE¼Ü
;

21 
pub
 
u£
 
	g£lf
::
scheduËr
::{
Msg
, 
	gScheduËr
, 
	gGC_BATCH_SIZE
, 
	gRESOLVE_LOCK_BATCH_SIZE
};

22 
pub
 
u£
 
	g£lf
::
¡Üe
::{
SÇpshÙStÜe
, 
	gStÜeSÿÂ”
};

24 
	gquick_”rÜ
! {

25 #[
d”ive
(
Debug
)]

26 
pub
 
	eE¼Ü
 {

27 
Engše
(
”r
: ::
¡Üage
::
’gše
::
E¼Ü
) {

28 
äom
()

29 
ÿu£
(
”r
)

30 
desütiÚ
(
”r
.description())

32 
Codec
(
”r
: ::
ut
::
codec
::
E¼Ü
) {

33 
äom
()

34 
ÿu£
(
”r
)

35 
desütiÚ
(
”r
.description())

37 
PrÙoBuf
(
”r
: ::
´Ùobuf
::
”rÜ
::
PrÙobufE¼Ü
) {

38 
äom
()

39 
ÿu£
(
”r
)

40 
desütiÚ
(
”r
.description())

42 
Mvcc
(
”r
: ::
¡Üage
::
mvcc
::
E¼Ü
) {

43 
äom
()

44 
ÿu£
(
”r
)

45 
desütiÚ
(
”r
.description())

47 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

48 
äom
()

49 
ÿu£
(
”r
.
as_»f
())

50 
desütiÚ
(
”r
.description())

51 
di¥Ïy
("{:?}", 
”r
)

53 
Io
(
”r
: 
IoE¼Ü
) {

54 
äom
()

55 
ÿu£
(
”r
)

56 
desütiÚ
(
”r
.description())

58 
Inv®idTxnTso
 {
¡¬t_ts
: 
u64
, 
	gcomm™_ts
: u64} {

59 
desütiÚ
("Invalidransactionso")

60 
di¥Ïy
("Invalidransactionso with start_ts:{},commit_ts:{}",

61 
¡¬t_ts
,

62 
comm™_ts
)

67 
im¶
 
	gE¼Ü
 {

68 
pub
 
â
 
maybe_şÚe
(&
£lf
è-> 
	gO±iÚ
<
	gE¼Ü
> {

69 
m©ch
 *
	g£lf
 {

70 
	gE¼Ü
::
Engše
(
»f
 
e
è=>ƒ.
maybe_şÚe
().
m­
(
E¼Ü
::Engine),

71 
	gE¼Ü
::
Codec
(
»f
 
e
è=>ƒ.
maybe_şÚe
().
m­
(
E¼Ü
::Codec),

72 
	gE¼Ü
::
Mvcc
(
»f
 
e
è=>ƒ.
maybe_şÚe
().
m­
(
E¼Ü
::Mvcc),

73 
	gE¼Ü
::
Inv®idTxnTso
 {

74 
¡¬t_ts
,

75 
	gcomm™_ts
,

76 } => 
Some
(
E¼Ü
::
Inv®idTxnTso
 {

77 
¡¬t_ts
: start_ts,

78 
comm™_ts
: commit_ts,

80 
	gE¼Ü
::
Oth”
(
_
è| 
E¼Ü
::
PrÙoBuf
(_è| E¼Ü::
Io
(_è=> 
NÚe
,

85 
pub
 
ty³
 
	gResuÉ
<
	gT
> = ::
¡d
::
»suÉ
::
ResuÉ
<
T
, 
	gE¼Ü
>;

	@src/storage/txn/scheduler.rs

34 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDebug
, 
	gFÜm©‹r
};

35 
u£
 
	g¡d
::
sync
::
mpsc
::
Reûiv”
;

36 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

37 
u£
 
	g¡d
::
th»ad
;

38 
u£
 
	g¡d
::
hash
::{
Hash
, 
	gHash”
};

39 
u£
 
	g¡d
::
u64
;

40 
u£
 
	g¡d
::
mem
;

42 
u£
 
	g´om‘heus
::
Hi¡og¿mTim”
;

43 
u£
 
	gkv´Ùo
::
kv½ıb
::{
CommªdPri
, 
	gCÚ‹xt
, 
	gLockInfo
};

45 
u£
 
	g¡Üage
::{
Commªd
, 
	gEngše
, 
E¼Ü
 
as
 
	gStÜageE¼Ü
, 
ResuÉ
‡ 
	gStÜageResuÉ
, 
	gSÿnMode
, 
	gSÇpshÙ
,

46 
	gSti¡ics
, 
	gSti¡icsSumm¬y
, 
	gStÜageCb
};

47 
u£
 
	g¡Üage
::
mvcc
::{
E¼Ü
 
as
 
MvccE¼Ü
, 
Lock
‡ 
	gMvccLock
, 
	gMvccR—d”
, 
	gMvccTxn
, 
	gWr™e
, 
	gWr™eTy³
,

48 
	gMAX_TXN_WRITE_SIZE
};

49 
u£
 
	g¡Üage
::{
Key
, 
	gKvPaœ
, 
	gMvccInfo
, 
	gV®ue
, 
	gCMD_TAG_GC
};

50 
u£
 
	g¡Üage
::
’gše
::{
£lf
, 
C®lback
 
as
 
	gEngšeC®lback
, 
	gCbCÚ‹xt
, 
E¼Ü
‡ 
	gEngšeE¼Ü
, 
	gModify
,

51 
ResuÉ
 
as
 
	gEngšeResuÉ
};

52 
u£
 
	g¿á¡Üe
::
¡Üe
::
’gše
::
I‹rO±iÚ
;

53 
u£
 
	gut
::
Œª¥Üt
::{
E¼Ü
 
as
 
T¿n¥ÜtE¼Ü
, 
	gSyncS’dCh
};

54 
u£
 
	gut
::
th»adpoŞ
::{
CÚ‹xt
 
as
 
Th»adCÚ‹xt
, 
	gTh»adPoŞ
, 
	gTh»adPoŞBud”
};

55 
u£
 
	gut
::
time
::
SlowTim”
;

56 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

58 
u£
 
	gsu³r
::
ResuÉ
;

59 
u£
 
	gsu³r
::
E¼Ü
;

60 
u£
 
	gsu³r
::
¡Üe
::
SÇpshÙStÜe
;

61 
u£
 
	gsu³r
::
Ïtch
::{
L©ches
, 
	gLock
};

62 
u£
 
	gsu³r
::
su³r
::
m‘rics
::*;

65 
pub
 cÚ¡ 
	gGC_BATCH_SIZE
: 
usize
 = 512;

69 
pub
 cÚ¡ 
	gRESOLVE_LOCK_BATCH_SIZE
: 
usize
 = 256;

72 
pub
 
	eProûssResuÉ
 {

73 
	mRes
,

74 
	mMuÉiRes
 { 
	m»suÉs
: 
Vec
<
StÜageResuÉ
<()>> },

75 
	mMuÉiKv·œs
 { 
	m·œs
: 
Vec
<
StÜageResuÉ
<
KvPaœ
>> },

76 
	mMvccKey
 { 
	mmvcc
: 
MvccInfo
 },

77 
	mMvccS¹Ts
 { 
	mmvcc
: 
O±iÚ
<(
Key
, 
	mMvccInfo
)> },

78 
	mV®ue
 { 
	mv®ue
: 
O±iÚ
<
V®ue
> },

79 
	mLocks
 { 
	mlocks
: 
Vec
<
LockInfo
> },

80 
	mNextCommªd
 { 
	mcmd
: 
Commªd
 },

81 
	mFaed
 { 
	m”r
: 
StÜageE¼Ü
 },

84 
ty³
 
	gSÇpshÙResuÉ
 = (
Vec
<
u64
>, 
	gCbCÚ‹xt
, 
	gEngšeResuÉ
<
	gBox
<
	gSÇpshÙ
>>);

87 
pub
 
	eMsg
 {

88 
	mQu™
,

89 
	mRawCmd
 { 
	mcmd
: 
Commªd
, 
	mcb
: 
StÜageCb
 },

90 
R‘ryG‘SÇpshÙs
(
Vec
<(
CÚ‹xt
, Vec<
u64
>)>),

91 
	mSÇpshÙFšished
 {

92 
	mcids
: 
Vec
<
u64
>,

93 
	mcb_ùx
: 
CbCÚ‹xt
,

94 
	m¢­shÙ
: 
EngšeResuÉ
<
Box
<
SÇpshÙ
>>,

96 
	mB©chSÇpshÙFšished
 { 
	mb©ch
: 
Vec
<
SÇpshÙResuÉ
> },

97 
	mR—dFšished
 { 
	mcid
: 
u64
, 
	m´
: 
ProûssResuÉ
 },

98 
	mWr™eP»·»Fšished
 {

99 
	mcid
: 
u64
,

100 
	mcmd
: 
Commªd
,

101 
	m´
: 
ProûssResuÉ
,

102 
	mto_be_wr™e
: 
Vec
<
Modify
>,

103 
	mrows
: 
usize
,

105 
	mWr™eP»·»Faed
 { 
	mcid
: 
u64
, 
	m”r
: 
E¼Ü
 },

106 
	mWr™eFšished
 {

107 
	mcid
: 
u64
,

108 
	m´
: 
ProûssResuÉ
,

109 
	mcb_ùx
: 
CbCÚ‹xt
,

110 
	m»suÉ
: 
EngšeResuÉ
<()>,

115 
im¶
 
Debug
 
	gMsg
 {

116 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

117 
m©ch
 *
£lf
 {

118 
Msg
::
Qu™
 => 
wr™e
!(
f
, "Quit"),

119 
	gMsg
::
RawCmd
 { 
»f
 
cmd
, .. } => 
wr™e
!(
f
, "RawCmd {:?}", 
	gcmd
),

120 
	gMsg
::
R‘ryG‘SÇpshÙs
(
»f
 
sks
è=> 
wr™e
!(
f
, "R‘ryG‘SÇpshÙ {:?}", 
	gsks
),

121 
	gMsg
::
SÇpshÙFšished
 { 
»f
 
cids
, .. } => {

122 
wr™e
!(
f
, "SÇpshÙFšished [cids={:?}]", 
cids
)

124 
Msg
::
B©chSÇpshÙFšished
 { 
»f
 
b©ch
 } => {

125 
Ët
 
ids
: 
Vec
<&Vec<
_
>> = 
b©ch
.
™”
().
m­
(|&(
»f
 ids, _, _)| ids).
cŞËù
();

126 
	gwr™e
!(
	gf
, "B©chSÇpshÙFšished cids: {:?}", 
	gids
)

128 
	gMsg
::
R—dFšished
 { 
cid
, .. } => 
wr™e
!(
f
, "R—dFšished [cid={}]", 
	gcid
),

129 
	gMsg
::
Wr™eP»·»Fšished
 { 
cid
, 
»f
 
	gcmd
, .. } => {

130 
wr™e
!(
f
, "Wr™eP»·»Fšished [cid={}, cmd={:?}]", 
cid
, 
cmd
)

132 
Msg
::
Wr™eP»·»Faed
 { 
cid
, 
»f
 
”r
 } => {

133 
wr™e
!(
f
, "Wr™eP»·»Faed [cid={},ƒ¼={:?}]", 
cid
, 
”r
)

135 
Msg
::
Wr™eFšished
 { 
cid
, .. } => 
wr™e
!(
f
, "Wr™eFšished [cid={}]", 
	gcid
),

141 
â
 
	$execu‹_ÿÎback
(
ÿÎback
: 
StÜageCb
, 
´
: 
ProûssResuÉ
) {

142 
m©ch
 
ÿÎback
 {

143 
StÜageCb
::
	`BoŞ—n
(
cb
è=> 
m©ch
 
´
 {

144 
ProûssResuÉ
::
Res
 => 
	`cb
(
	`Ok
(())),

145 
ProûssResuÉ
::
Faed
 { 
”r
 } => 
	`cb
(
	`E¼
(err)),

146 
_
 => 
·nic
!("process„esult mismatch"),

148 
StÜageCb
::
	`BoŞ—ns
(
cb
è=> 
m©ch
 
´
 {

149 
ProûssResuÉ
::
MuÉiRes
 { 
»suÉs
 } => 
	`cb
(
	`Ok
(results)),

150 
ProûssResuÉ
::
Faed
 { 
”r
 } => 
	`cb
(
	`E¼
(err)),

151 
_
 => 
·nic
!("process„esult mismatch"),

153 
StÜageCb
::
	`SšgËV®ue
(
cb
è=> 
m©ch
 
´
 {

154 
ProûssResuÉ
::
V®ue
 { 
v®ue
 } => 
	`cb
(
	`Ok
(value)),

155 
ProûssResuÉ
::
Faed
 { 
”r
 } => 
	`cb
(
	`E¼
(err)),

156 
_
 => 
·nic
!("process„esult mismatch"),

158 
StÜageCb
::
	`KvPaœs
(
cb
è=> 
m©ch
 
´
 {

159 
ProûssResuÉ
::
MuÉiKv·œs
 { 
·œs
 } => 
	`cb
(
	`Ok
(pairs)),

160 
ProûssResuÉ
::
Faed
 { 
”r
 } => 
	`cb
(
	`E¼
(err)),

161 
_
 => 
·nic
!("process„esult mismatch"),

163 
StÜageCb
::
	`MvccInfoByKey
(
cb
è=> 
m©ch
 
´
 {

164 
ProûssResuÉ
::
MvccKey
 { 
mvcc
 } => 
	`cb
(
	`Ok
(mvcc)),

165 
ProûssResuÉ
::
Faed
 { 
”r
 } => 
	`cb
(
	`E¼
(err)),

166 
_
 => 
·nic
!("process„esult mismatch"),

168 
StÜageCb
::
	`MvccInfoByS¹Ts
(
cb
è=> 
m©ch
 
´
 {

169 
ProûssResuÉ
::
MvccS¹Ts
 { 
mvcc
 } => 
	`cb
(
	`Ok
(mvcc)),

170 
ProûssResuÉ
::
Faed
 { 
”r
 } => 
	`cb
(
	`E¼
(err)),

171 
_
 => 
·nic
!("process„esult mismatch"),

173 
StÜageCb
::
	`Locks
(
cb
è=> 
m©ch
 
´
 {

174 
ProûssResuÉ
::
Locks
 { 
locks
 } => 
	`cb
(
	`Ok
(locks)),

175 
ProûssResuÉ
::
Faed
 { 
”r
 } => 
	`cb
(
	`E¼
(err)),

176 
_
 => 
·nic
!("process„esult mismatch"),

179 
	}
}

182 
pub
 
	sRuÂšgCtx
 {

183 
	mcid
: 
u64
,

184 
	mcmd
: 
O±iÚ
<
Commªd
>,

185 
	mwr™e_by‹s
: 
usize
,

186 
	mlock
: 
Lock
,

187 
	mÿÎback
: 
O±iÚ
<
StÜageCb
>,

188 
	mg
: &'static str,

189 
ts
: 
u64
,

190 
	m»giÚ_id
: 
u64
,

191 
	mÏtch_tim”
: 
O±iÚ
<
Hi¡og¿mTim”
>,

192 
	m_tim”
: 
Hi¡og¿mTim”
,

193 
	m¦ow_tim”
: 
O±iÚ
<
SlowTim”
>,

196 
im¶
 
	gRuÂšgCtx
 {

198 
pub
 
â
 
Ãw
(
cid
: 
u64
, 
cmd
: 
Commªd
, 
lock
: 
Lock
, 
cb
: 
StÜageCb
è-> 
RuÂšgCtx
 {

199 
Ët
 
g
 = 
cmd
.tag();

200 
Ët
 
	gts
 = 
cmd
.
ts
();

201 
Ët
 
	g»giÚ_id
 = 
cmd
.
g‘_cÚ‹xt
().
g‘_»giÚ_id
();

202 
Ët
 
	gwr™e_by‹s
 = 
cmd
.
wr™e_by‹s
();

203 
	gRuÂšgCtx
 {

204 
	gcid
: 
cid
,

205 
	gcmd
: 
Some
(
cmd
),

206 
	gwr™e_by‹s
: 
wr™e_by‹s
,

207 
	glock
: 
lock
,

208 
	gÿÎback
: 
Some
(
cb
),

209 
	gg
: 
g
,

210 
	gts
: 
ts
,

211 
	g»giÚ_id
: 
»giÚ_id
,

212 
	gÏtch_tim”
: 
Some
(

213 
SCHED_LATCH_HISTOGRAM_VEC


214 .
w™h_Ïb–_v®ues
(&[
g
])

215 .
¡¬t_cßr£_tim”
(),

217 
	g_tim”
: 
SCHED_HISTOGRAM_VEC


218 .
w™h_Ïb–_v®ues
(&[
g
])

219 .
¡¬t_cßr£_tim”
(),

220 
	g¦ow_tim”
: 
NÚe
,

225 
im¶
 
Drİ
 
	gRuÂšgCtx
 {

226 
â
 
drİ
(&
mut
 
£lf
) {

227 
Ët
 
Some
(
»f
 
mut
 
tim”
èğ
£lf
.
¦ow_tim”
 {

228 
¦ow_log
!(

229 
tim”
,

231 
£lf
.
»giÚ_id
,

232 
£lf
.
g
,

233 
£lf
.
ts


240 
â
 
make_’gše_cb
(

241 
cmd
: &'static str,

242 
cid
: 
u64
,

243 
´
: 
ProûssResuÉ
,

244 
ch
: 
SyncS’dCh
<
Msg
>,

245 
rows
: 
usize
,

246 è-> 
	gEngšeC®lback
<()> {

247 
	gBox
::
Ãw
(
move
 |(
cb_ùx
, 
»suÉ
)| {

248 
m©ch
 
ch
.
£nd
(
Msg
::
Wr™eFšished
 {

249 
cid
: cid,

250 
´
:…r,

251 
cb_ùx
: cb_ctx,

252 
»suÉ
:„esult,

254 
Ok
(
_
) => {

255 
KV_COMMAND_KEYWRITE_HISTOGRAM_VEC


256 .
w™h_Ïb–_v®ues
(&[
cmd
])

257 .
ob£rve
(
rows
 
as
 
f64
);

259 
e
 @ 
E¼
(
T¿n¥ÜtE¼Ü
::
Clo£d
è=> 
šfo
!("channel closed,ƒrr {:?}",ƒ),

260 
E¼
(
e
) => {

261 
·nic
!(

263 
cid
,

264 
e


271 #[
d”ive
(
ClÚe
)]

272 
HashabËCÚ‹xt
(
CÚ‹xt
);

274 
im¶
 
P¬tŸlEq
 
	gHashabËCÚ‹xt
 {

275 
â
 
eq
(&
£lf
, 
Ùh”
: &
HashabËCÚ‹xt
è-> 
boŞ
 {

277 
£lf
.0.
g‘_»giÚ_id
(è=ğ
Ùh”
.0.get_region_id() &&

278 
£lf
.0.
g‘_»giÚ_•och
().
g‘_v”siÚ
(è=ğ
Ùh”
.0.get_region_epoch().get_version() &&

279 
£lf
.0.
g‘_³”
().
g‘_id
(è=ğ
Ùh”
.0.get_peer().get_id()

283 
im¶
 
Hash
 
HashabËCÚ‹xt
 {

284 
â
 
hash
<
H
: 
Hash”
>(&
£lf
, 
	g¡©e
: &
mut
 H) {

285 
Ët
 
key
 = {

286 
Ët
 
ùx
 = &
£lf
.0;

288 
	gùx
.
g‘_»giÚ_id
(),

289 
	gùx
.
g‘_»giÚ_•och
().
g‘_v”siÚ
(),

290 
	gùx
.
g‘_³”
().
g‘_id
(),

293 
	gHash
::
hash
(&
key
, 
¡©e
);

297 
im¶
 
Eq
 
	gHashabËCÚ‹xt
 {}

300 
pub
 
	sScheduËr
 {

301 
	m’gše
: 
Box
<
Engše
>,

304 
	mcmd_ùxs
: 
HashM­
<
u64
, 
	mRuÂšgCtx
>,

306 
	mgrou³d_cmds
: 
O±iÚ
<
HashM­
<
HashabËCÚ‹xt
, 
	mVec
<
	mu64
>>>,

308 
	mschedch
: 
SyncS’dCh
<
Msg
>,

311 
	mid_®loc
: 
u64
,

314 
	mÏtches
: 
L©ches
,

318 
	msched_³ndšg_wr™e_th»shŞd
: 
usize
,

321 
	mwÜk”_poŞ
: 
Th»adPoŞ
<
SchedCÚ‹xt
>,

324 
	mhigh_´iÜ™y_poŞ
: 
Th»adPoŞ
<
SchedCÚ‹xt
>,

326 
	mhas_gc_commªd
: 
boŞ
,

329 
	mruÂšg_wr™e_by‹s
: 
usize
,

333 
ty³
 
	gMuÉËR‘uºV®ue
 = (
O±iÚ
<
MvccLock
>, 
	gVec
<(
	gu64
, 
	gWr™e
)>, Vec<(u64, 
	gboŞ
, 
	gV®ue
)>);

335 
â
 
fšd_mvcc_šfos_by_key
(

336 
»ad”
: &
mut
 
MvccR—d”
,

337 
key
: &
Key
,

338 
mut
 
ts
: 
u64
,

339 è-> 
	gResuÉ
<
	gMuÉËR‘uºV®ue
> {

340 
Ët
 
mut
 
	gwr™es
 = 
vec
![];

341 
Ët
 
mut
 
	gv®ues
 = 
vec
![];

342 
Ët
 
	glock
 = 
»ad”
.
lßd_lock
(
key
)?;

343 
	gloİ
 {

344 
Ët
 
	gİt
 = 
»ad”
.
£ek_wr™e
(
key
, 
ts
)?;

345 
Ët
 
	gshÜt_v®ue
: 
O±iÚ
<
V®ue
>;

346 
m©ch
 
	gİt
 {

347 
Some
((
comm™_ts
, 
mut
 
wr™e
)) => {

348 
ts
 = 
comm™_ts
 - 1;

349 
Ët
 
	gwr™e_ty³
 = 
wr™e
.
wr™e_ty³
;

350 
	gshÜt_v®ue
 = 
wr™e
.
shÜt_v®ue
.
ke
();

351 
	gwr™es
.
push
((
comm™_ts
, 
wr™e
));

352 
	gwr™e_ty³
 !ğ
Wr™eTy³
::
Put
 {

356 
	gNÚe
 => ,

358 
Ët
 
	gwr™e
 = &
wr™es
[wr™es.
Ën
() - 1].1;

359 
Ët
 
Some
(
v
èğ
shÜt_v®ue
 {

360 
v®ues
.
push
((
wr™e
.
¡¬t_ts
, 
Œue
, 
v
));

363 
	gts
, 
	gv
è
š
 
	g»ad”
.
sÿn_v®ues_š_deçuÉ
(
key
)? {

364 
	gv®ues
.
push
((
ts
, 
çl£
, 
v
));

366 
Ok
((
lock
, 
wr™es
, 
v®ues
))

369 
im¶
 
	gScheduËr
 {

371 
pub
 
â
 
Ãw
(

372 
’gše
: 
Box
<
Engše
>,

373 
schedch
: 
SyncS’dCh
<
Msg
>,

374 
cÚcu¼’cy
: 
usize
,

375 
wÜk”_poŞ_size
: 
usize
,

376 
sched_³ndšg_wr™e_th»shŞd
: 
usize
,

377 è-> 
	gScheduËr
 {

378 
	gScheduËr
 {

379 
	g’gše
: 
’gše
,

380 
	gcmd_ùxs
: 
DeçuÉ
::(),

381 
	ggrou³d_cmds
: 
Some
(
HashM­
::
w™h_ÿ·c™y_ªd_hash”
(

382 
CMD_BATCH_SIZE
,

383 
DeçuÉ
::(),

385 
	gschedch
: 
schedch
,

386 
	gid_®loc
: 0,

387 
	gÏtches
: 
L©ches
::
Ãw
(
cÚcu¼’cy
),

388 
	gsched_³ndšg_wr™e_th»shŞd
: 
sched_³ndšg_wr™e_th»shŞd
,

389 
	gwÜk”_poŞ
: 
Th»adPoŞBud”
::
w™h_deçuÉ_çùÜy
(
thd_Çme
!("sched-worker-pool"))

390 .
th»ad_couÁ
(
wÜk”_poŞ_size
)

391 .
bud
(),

392 
	ghigh_´iÜ™y_poŞ
: 
Th»adPoŞBud”
::
w™h_deçuÉ_çùÜy
(

393 
thd_Çme
!("sched-high-pri-pool"),

394 ).
bud
(),

395 
	ghas_gc_commªd
: 
çl£
,

396 
	gruÂšg_wr™e_by‹s
: 0,

403 
â
 
´oûss_»ad
(

404 
cid
: 
u64
,

405 
mut
 
cmd
: 
Commªd
,

406 
ch
: 
SyncS’dCh
<
Msg
>,

407 
¢­shÙ
: 
Box
<
SÇpshÙ
>,

408 è-> 
	gSti¡ics
 {

409 
	gdebug
!("´oûs »ad cmd(cid={}èš wÜk”…oŞ.", 
	gcid
);

410 
	gSCHED_WORKER_COUNTER_VEC


411 .
w™h_Ïb–_v®ues
(&[
cmd
.
g
(), "read"])

412 .
šc
();

413 
Ët
 
	gg
 = 
cmd
.
g
();

415 
Ët
 
mut
 
	g¡©i¡ics
 = 
Sti¡ics
::();

417 
Ët
 
	g´
 = 
m©ch
 
cmd
 {

419 
Commªd
::
G‘
 {

420 
»f
 
ùx
,

421 
»f
 
key
,

422 
¡¬t_ts
,

425 
KV_COMMAND_KEYREAD_HISTOGRAM_VEC


426 .
w™h_Ïb–_v®ues
(&[
g
])

427 .
ob£rve
(1f64);

428 
Ët
 
	g¢­_¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(

429 
¢­shÙ
,

430 
¡¬t_ts
,

431 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

432 !
ùx
.
g‘_nÙ_fl_ÿche
(),

434 
Ët
 
	g»s
 = 
¢­_¡Üe
.
g‘
(
key
, &
mut
 
¡©i¡ics
);

435 
m©ch
 
	g»s
 {

436 
Ok
(
v®
è=> 
ProûssResuÉ
::
V®ue
 { 
v®ue
: val },

437 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 {

438 
”r
: 
StÜageE¼Ü
::
äom
(
e
),

443 
	gCommªd
::
B©chG‘
 {

444 
»f
 
ùx
,

445 
»f
 
	gkeys
,

446 
	g¡¬t_ts
,

449 
KV_COMMAND_KEYREAD_HISTOGRAM_VEC


450 .
w™h_Ïb–_v®ues
(&[
g
])

451 .
ob£rve
(
keys
.
Ën
(è
as
 
f64
);

452 
Ët
 
	g¢­_¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(

453 
¢­shÙ
,

454 
¡¬t_ts
,

455 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

456 !
ùx
.
g‘_nÙ_fl_ÿche
(),

458 
Ët
 
	g»s
 = 
¢­_¡Üe
.
b©ch_g‘
(
keys
, &
mut
 
¡©i¡ics
);

459 
m©ch
 
	g»s
 {

460 
Ok
(
»suÉs
) => {

461 
Ët
 
mut
 
»s
 = 
vec
![];

462 
	gk
, 
	gv
è
š
 
	gkeys
.
što_™”
().
z
(
»suÉs
) {

463 
m©ch
 
	gv
 {

464 
Ok
(
Some
(
x
)è=> 
»s
.
push
(Ok((
k
.
¿w
().
unw¿p
(), x))),

465 
Ok
(
NÚe
) => {}

466 
E¼
(
e
è=> 
»s
.
push
(E¼(
StÜageE¼Ü
::
äom
(e))),

469 
	gProûssResuÉ
::
MuÉiKv·œs
 { 
·œs
: 
»s
 }

471 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 {

472 
”r
: 
StÜageE¼Ü
::
äom
(
e
),

477 
	gCommªd
::
Sÿn
 {

478 
»f
 
ùx
,

479 
»f
 
	g¡¬t_key
,

480 
	glim™
,

481 
	g¡¬t_ts
,

482 
»f
 
	gİtiÚs
,

485 
Ët
 
¢­_¡Üe
 = 
SÇpshÙStÜe
::
Ãw
(

486 
¢­shÙ
,

487 
¡¬t_ts
,

488 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

489 !
ùx
.
g‘_nÙ_fl_ÿche
(),

491 
Ët
 
	g»s
 = 
¢­_¡Üe


492 .
sÿÂ”
(
SÿnMode
::
FÜw¬d
, 
İtiÚs
.
key_Úly
, 
NÚe
)

493 .
ªd_th’
(|
mut
 
sÿÂ”
| {

494 
Ët
 
»s
 = 
sÿÂ”
.
sÿn
(
¡¬t_key
.
şÚe
(), 
lim™
);

495 
¡©i¡ics
.
add
(
sÿÂ”
.
g‘_¡©i¡ics
());

496 
»s


498 .
ªd_th’
(|
mut
 
»suÉs
| {

499 
KV_COMMAND_KEYREAD_HISTOGRAM_VEC


500 .
w™h_Ïb–_v®ues
(&[
g
])

501 .
ob£rve
(
»suÉs
.
Ën
(è
as
 
f64
);

502 
Ok
(

503 
»suÉs


504 .
d¿š
(..)

505 .
m­
(|
x
| x.
m­_”r
(
StÜageE¼Ü
::
äom
))

506 .
cŞËù
(),

510 
m©ch
 
	g»s
 {

511 
Ok
(
·œs
è=> 
ProûssResuÉ
::
MuÉiKv·œs
 {…airs:…airs },

512 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 { 
”r
:ƒ.
što
() },

515 
	gCommªd
::
MvccByKey
 { 
»f
 
ùx
,„eà
	gkey
 } => {

516 
Ët
 
mut
 
»ad”
 = 
MvccR—d”
::
Ãw
(

517 
¢­shÙ
,

518 
Some
(
SÿnMode
::
FÜw¬d
),

519 !
ùx
.
g‘_nÙ_fl_ÿche
(),

520 
NÚe
,

521 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

523 
Ët
 
	g»s
 = 
m©ch
 
fšd_mvcc_šfos_by_key
(&
mut
 
»ad”
, 
key
, 
u64
::
MAX
) {

524 
Ok
((
lock
, 
wr™es
, 
v®ues
)è=> 
ProûssResuÉ
::
MvccKey
 {

525 
mvcc
: 
MvccInfo
 {

526 
lock
:†ock,

527 
wr™es
: writes,

528 
v®ues
: values,

531 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 { 
”r
:ƒ.
što
() },

533 
	g¡©i¡ics
.
add
(
»ad”
.
g‘_¡©i¡ics
());

534 
	g»s


536 
	gCommªd
::
MvccByS¹Ts
 { 
»f
 
ùx
, 
	g¡¬t_ts
 } => {

537 
Ët
 
mut
 
»ad”
 = 
MvccR—d”
::
Ãw
(

538 
¢­shÙ
,

539 
Some
(
SÿnMode
::
FÜw¬d
),

540 !
ùx
.
g‘_nÙ_fl_ÿche
(),

541 
NÚe
,

542 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

544 
Ët
 
	g»s
 = 
m©ch
 
»ad”
.
£ek_ts
(
¡¬t_ts
).
m­_”r
(
StÜageE¼Ü
::
äom
) {

545 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 { 
”r
:ƒ.
što
() },

546 
Ok
(
İt
è=> 
m©ch
 opt {

547 
Some
(
key
è=> 
m©ch
 
fšd_mvcc_šfos_by_key
(&
mut
 
»ad”
, &key, 
u64
::
MAX
) {

548 
Ok
((
lock
, 
wr™es
, 
v®ues
)è=> 
ProûssResuÉ
::
MvccS¹Ts
 {

549 
mvcc
: 
Some
((

550 
key
,

551 
MvccInfo
 {

552 
lock
:†ock,

553 
wr™es
: writes,

554 
v®ues
: values,

558 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 { 
”r
:ƒ.
što
() },

560 
	gNÚe
 => 
ProûssResuÉ
::
MvccS¹Ts
 { 
mvcc
: 
NÚe
 },

563 
	g¡©i¡ics
.
add
(
»ad”
.
g‘_¡©i¡ics
());

564 
	g»s


567 
	gCommªd
::
SÿnLock
 {

568 
»f
 
ùx
, 
	gmax_ts
, ..

570 
Ët
 
mut
 
»ad”
 = 
MvccR—d”
::
Ãw
(

571 
¢­shÙ
,

572 
Some
(
SÿnMode
::
FÜw¬d
),

573 !
ùx
.
g‘_nÙ_fl_ÿche
(),

574 
NÚe
,

575 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

577 
Ët
 
	g»s
 = 
»ad”


578 .
sÿn_lock
(
NÚe
, |
lock
|†ock.
ts
 <ğ
max_ts
, None)

579 .
m­_”r
(
E¼Ü
::
äom
)

580 .
ªd_th’
(|(
v
, 
_
)| {

581 
Ët
 
mut
 
locks
 = 
vec
![];

582 
key
, 
lock
è
š
 
v
 {

583 
Ët
 
mut
 
lock_šfo
 = 
LockInfo
::
Ãw
();

584 
lock_šfo
.
£t_´im¬y_lock
(
lock
.
´im¬y
);

585 
lock_šfo
.
£t_lock_v”siÚ
(
lock
.
ts
);

586 
lock_šfo
.
£t_key
(
key
.
¿w
()?);

587 
locks
.
push
(
lock_šfo
);

589 
KV_COMMAND_KEYREAD_HISTOGRAM_VEC


590 .
w™h_Ïb–_v®ues
(&[
g
])

591 .
ob£rve
(
locks
.
Ën
(è
as
 
f64
);

592 
Ok
(
locks
)

594 
	g¡©i¡ics
.
add
(
»ad”
.
g‘_¡©i¡ics
());

595 
m©ch
 
	g»s
 {

596 
Ok
(
locks
è=> 
ProûssResuÉ
::
Locks
 {†ocks:†ocks },

597 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 { 
”r
:ƒ.
što
() },

600 
	gCommªd
::
ResŞveLock
 {

601 
»f
 
ùx
,

602 
»f
 
mut
 
	gtxn_¡©us
,

603 
»f
 
mut
 
	gsÿn_key
,

606 
Ët
 
mut
 
»ad”
 = 
MvccR—d”
::
Ãw
(

607 
¢­shÙ
,

608 
Some
(
SÿnMode
::
FÜw¬d
),

609 !
ùx
.
g‘_nÙ_fl_ÿche
(),

610 
NÚe
,

611 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

613 
Ët
 
	g»s
 = 
»ad”


614 .
sÿn_lock
(

615 
sÿn_key
.
ke
(),

616 |
lock
| 
txn_¡©us
.
cÚšs_key
(&lock.
ts
),

617 
Some
(
RESOLVE_LOCK_BATCH_SIZE
),

619 .
m­_”r
(
E¼Ü
::
äom
)

620 .
ªd_th’
(|(
v
, 
Ãxt_sÿn_key
)| {

621 
Ët
 
key_locks
: 
Vec
<
_
> = 
v
.
što_™”
().
m­
(|
x
| x).
cŞËù
();

622 
KV_COMMAND_KEYREAD_HISTOGRAM_VEC


623 .
w™h_Ïb–_v®ues
(&[
g
])

624 .
ob£rve
(
key_locks
.
Ën
(è
as
 
f64
);

625 
key_locks
.
is_em±y
() {

626 
Ok
(
NÚe
)

628 
Ok
(
Some
(
Commªd
::
ResŞveLock
 {

629 
ùx
: ctx.
şÚe
(),

630 
txn_¡©us
: 
mem
::
»¶aû
Ñxn_¡©us, 
DeçuÉ
::()),

631 
sÿn_key
: 
Ãxt_sÿn_key
,

632 
key_locks
: key_locks,

636 
	g¡©i¡ics
.
add
(
»ad”
.
g‘_¡©i¡ics
());

637 
m©ch
 
	g»s
 {

638 
Ok
(
Some
(
cmd
)è=> 
ProûssResuÉ
::
NextCommªd
 { cmd: cmd },

639 
Ok
(
NÚe
è=> 
ProûssResuÉ
::
Res
,

640 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 { 
”r
:ƒ.
što
() },

644 
	gCommªd
::
Gc
 {

645 
»f
 
ùx
,

646 
	g§ã_pošt
,

647 
	g¿tio_th»shŞd
,

648 
»f
 
mut
 
	gsÿn_key
,

651 
Ët
 
mut
 
»ad”
 = 
MvccR—d”
::
Ãw
(

652 
¢­shÙ
,

653 
Some
(
SÿnMode
::
FÜw¬d
),

654 !
ùx
.
g‘_nÙ_fl_ÿche
(),

655 
NÚe
,

656 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

659 
Ët
 
	gis_¿nge_¡¬t_gc
 = 
sÿn_key
.
is_nÚe
();

661 
Ët
 
	gÃed_gc
 = 
is_¿nge_¡¬t_gc
 {

662 
»ad”
.
Ãed_gc
(
§ã_pošt
, 
¿tio_th»shŞd
)

664 
Œue


666 
Ët
 
	g»s
 = !
Ãed_gc
 {

667 
KV_COMMAND_GC_SKIPPED_COUNTER
.
šc
();

668 
Ok
(
NÚe
)

670 
	g»ad”


671 .
sÿn_keys
(
sÿn_key
.
ke
(), 
GC_BATCH_SIZE
)

672 .
m­_”r
(
E¼Ü
::
äom
)

673 .
ªd_th’
(|(
keys
, 
Ãxt_¡¬t
)| {

674 
KV_COMMAND_KEYREAD_HISTOGRAM_VEC


675 .
w™h_Ïb–_v®ues
(&[
g
])

676 .
ob£rve
(
keys
.
Ën
(è
as
 
f64
);

677 
keys
.
is_em±y
() {

679 
is_¿nge_¡¬t_gc
 {

680 
KV_COMMAND_GC_EMPTY_RANGE_COUNTER
.
šc
();

682 
Ok
(
NÚe
)

684 
Ok
(
Some
(
Commªd
::
Gc
 {

685 
ùx
: ctx.
şÚe
(),

686 
§ã_pošt
: safe_point,

687 
¿tio_th»shŞd
:„atio_threshold,

688 
sÿn_key
: 
Ãxt_¡¬t
,

689 
keys
: keys,

694 
	g¡©i¡ics
.
add
(
»ad”
.
g‘_¡©i¡ics
());

695 
m©ch
 
	g»s
 {

696 
Ok
(
Some
(
cmd
)è=> 
ProûssResuÉ
::
NextCommªd
 { cmd: cmd },

697 
Ok
(
NÚe
è=> 
ProûssResuÉ
::
Res
,

698 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 { 
”r
:ƒ.
što
() },

701 
	gCommªd
::
RawG‘
 { 
»f
 
key
, .. } => {

702 
KV_COMMAND_KEYREAD_HISTOGRAM_VEC


703 .
w™h_Ïb–_v®ues
(&[
g
])

704 .
ob£rve
(1f64);

705 
m©ch
 
	g¢­shÙ
.
g‘
(
key
) {

706 
Ok
(
v®
è=> 
ProûssResuÉ
::
V®ue
 { 
v®ue
: val },

707 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 {

708 
”r
: 
StÜageE¼Ü
::
äom
(
e
),

712 
	gCommªd
::
RawSÿn
 {

713 
»f
 
¡¬t_key
,

714 
	glim™
,

716 } => 
m©ch
 
´oûss_¿wsÿn
(
¢­shÙ
, 
¡¬t_key
, 
lim™
, &
mut
 
¡©i¡ics
) {

717 
Ok
(
v®
è=> 
ProûssResuÉ
::
MuÉiKv·œs
 { 
·œs
: val },

718 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 {

719 
”r
: 
StÜageE¼Ü
::
äom
(
e
),

722 
	gCommªd
::
Pau£
 { 
du¿tiÚ
, .. } => {

723 
th»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(
du¿tiÚ
));

724 
	gProûssResuÉ
::
Res


726 
_
 => 
·nic
!("unsupported„ead command"),

729 
Ët
 
E¼
(
e
èğ
ch
.
£nd
(
Msg
::
R—dFšished
 { 
cid
: cid, 
´
:…r }) {

731 
·nic
!("£nd„—d fšished faed, cid={},ƒ¼={:?}", 
cid
, 
e
);

733 
	g¡©i¡ics


736 
â
 
´oûss_¿wsÿn
(

737 
¢­shÙ
: 
Box
<
SÇpshÙ
>,

738 
¡¬t_key
: &
Key
,

739 
lim™
: 
usize
,

740 
¡©s
: &
mut
 
Sti¡ics
,

741 è-> 
	gResuÉ
<
	gVec
<
	gStÜageResuÉ
<
	gKvPaœ
>>> {

742 
Ët
 
mut
 
	gcursÜ
 = 
¢­shÙ
.
™”
(
I‹rO±iÚ
::(), 
SÿnMode
::
FÜw¬d
)?;

743 !
	gcursÜ
.
£ek
(
¡¬t_key
, &
mut
 
¡©s
.
d©a
)? {

744  
Ok
(
vec
![]);

746 
Ët
 
mut
 
	g·œs
 = 
vec
![];

747 
	gcursÜ
.
v®id
(è&& 
	g·œs
.
Ën
(è< 
	glim™
 {

748 
	g·œs
.
push
(
Ok
((
cursÜ
.
key
().
to_owÃd
(), cursÜ.
v®ue
().to_owned())));

749 
	gcursÜ
.
Ãxt
(&
mut
 
¡©s
.
d©a
);

751 
Ok
(
·œs
)

756 
â
 
´oûss_wr™e
(

757 
cid
: 
u64
,

758 
cmd
: 
Commªd
,

759 
ch
: 
SyncS’dCh
<
Msg
>,

760 
¢­shÙ
: 
Box
<
SÇpshÙ
>,

761 è-> 
	gSti¡ics
 {

762 
	gSCHED_WORKER_COUNTER_VEC


763 .
w™h_Ïb–_v®ues
(&[
cmd
.
g
(), "write"])

764 .
šc
();

766 
Ët
 
mut
 
	g¡©i¡ics
 = 
Sti¡ics
::();

767 
Ët
 
E¼
(
e
èğ
´oûss_wr™e_im¶
(
cid
, 
cmd
, 
ch
.
şÚe
(), 
¢­shÙ
, &
mut
 
¡©i¡ics
) {

768 
Ët
 
E¼
(
”r
èğ
ch
.
£nd
(
Msg
::
Wr™eP»·»Faed
 { 
cid
: cid,ƒ¼: 
e
 }) {

770 
·nic
!(

772 
cid
,

773 
”r


777 
	g¡©i¡ics


780 
â
 
´oûss_wr™e_im¶
(

781 
cid
: 
u64
,

782 
mut
 
cmd
: 
Commªd
,

783 
ch
: 
SyncS’dCh
<
Msg
>,

784 
¢­shÙ
: 
Box
<
SÇpshÙ
>,

785 
¡©i¡ics
: &
mut
 
Sti¡ics
,

786 è-> 
	gResuÉ
<()> {

787 
Ët
 (
´
, 
modif›s
, 
rows
èğ
m©ch
 
cmd
 {

788 
Commªd
::
P»wr™e
 {

789 
»f
 
ùx
,

790 
»f
 
mutiÚs
,

791 
»f
 
´im¬y
,

792 
¡¬t_ts
,

793 
»f
 
İtiÚs
,

796 
Ët
 
mut
 
txn
 = 
MvccTxn
::
Ãw
(

797 
¢­shÙ
,

798 
¡¬t_ts
,

799 
NÚe
,

800 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

801 !
ùx
.
g‘_nÙ_fl_ÿche
(),

803 
Ët
 
mut
 
	glocks
 = 
vec
![];

804 
Ët
 
	grows
 = 
mutiÚs
.
Ën
();

805 
m
 
š
 
	gmutiÚs
 {

806 
m©ch
 
	gtxn
.
´ewr™e
(
m
.
şÚe
(), 
´im¬y
, 
İtiÚs
) {

807 
Ok
(
_
) => {}

808 
e
 @ 
E¼
(
MvccE¼Ü
::
KeyIsLocked
 { .. }) => {

809 
locks
.
push
(
e
.
m­_”r
(
E¼Ü
::
äom
).m­_”r(
StÜageE¼Ü
::from));

811 
E¼
(
e
è=>  E¼(
E¼Ü
::
äom
(e)),

815 
	g¡©i¡ics
.
add
(
txn
.
g‘_¡©i¡ics
());

816 
	glocks
.
is_em±y
() {

817 
Ët
 
	g´
 = 
ProûssResuÉ
::
MuÉiRes
 { 
»suÉs
: 
vec
![] };

818 
Ët
 
	gmodif›s
 = 
txn
.
što_modif›s
();

819 (
	g´
, 
	gmodif›s
, 
	grows
)

822 
Ët
 
	g´
 = 
ProûssResuÉ
::
MuÉiRes
 { 
»suÉs
: 
locks
 };

823 (
	g´
, 
	gvec
![], 0)

826 
	gCommªd
::
Comm™
 {

827 
»f
 
ùx
,

828 
»f
 
	gkeys
,

829 
	glock_ts
,

830 
	gcomm™_ts
,

833 
comm™_ts
 <ğ
lock_ts
 {

834  
E¼
(
E¼Ü
::
Inv®idTxnTso
 {

835 
¡¬t_ts
: 
lock_ts
,

836 
comm™_ts
: commit_ts,

839 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(

840 
¢­shÙ
,

841 
lock_ts
,

842 
NÚe
,

843 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

844 !
ùx
.
g‘_nÙ_fl_ÿche
(),

846 
Ët
 
	grows
 = 
keys
.
Ën
();

847 
k
 
š
 
	gkeys
 {

848 
	gtxn
.
comm™
(
k
, 
comm™_ts
)?;

851 
	g¡©i¡ics
.
add
(
txn
.
g‘_¡©i¡ics
());

852 (
	gProûssResuÉ
::
Res
, 
	gtxn
.
što_modif›s
(), 
	grows
)

854 
	gCommªd
::
CËªup
 {

855 
»f
 
ùx
,

856 
»f
 
	gkey
,

857 
	g¡¬t_ts
,

860 
Ët
 
mut
 
txn
 = 
MvccTxn
::
Ãw
(

861 
¢­shÙ
,

862 
¡¬t_ts
,

863 
NÚe
,

864 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

865 !
ùx
.
g‘_nÙ_fl_ÿche
(),

867 
	gtxn
.
rŞlback
(
key
)?;

869 
	g¡©i¡ics
.
add
(
txn
.
g‘_¡©i¡ics
());

870 (
	gProûssResuÉ
::
Res
, 
	gtxn
.
što_modif›s
(), 1)

872 
	gCommªd
::
RŞlback
 {

873 
»f
 
ùx
,

874 
»f
 
	gkeys
,

875 
	g¡¬t_ts
,

878 
Ët
 
mut
 
txn
 = 
MvccTxn
::
Ãw
(

879 
¢­shÙ
,

880 
¡¬t_ts
,

881 
NÚe
,

882 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

883 !
ùx
.
g‘_nÙ_fl_ÿche
(),

885 
Ët
 
	grows
 = 
keys
.
Ën
();

886 
k
 
š
 
	gkeys
 {

887 
	gtxn
.
rŞlback
(
k
)?;

890 
	g¡©i¡ics
.
add
(
txn
.
g‘_¡©i¡ics
());

891 (
	gProûssResuÉ
::
Res
, 
	gtxn
.
što_modif›s
(), 
	grows
)

893 
	gCommªd
::
ResŞveLock
 {

894 
»f
 
ùx
,

895 
»f
 
mut
 
	gtxn_¡©us
,

896 
»f
 
mut
 
	gsÿn_key
,

897 
»f
 
	gkey_locks
,

899 
Ët
 
mut
 
sÿn_key
 = sÿn_key.
ke
();

900 
Ët
 
mut
 
	gmodif›s
: 
Vec
<
Modify
> = 
vec
![];

901 
Ët
 
mut
 
	gwr™e_size
 = 0;

902 
Ët
 
	grows
 = 
key_locks
.
Ën
();

903 &(
»f
 
	gcu¼’t_key
,„eà
	gcu¼’t_lock
è
š
 
	gkey_locks
 {

904 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(

905 
¢­shÙ
.
şÚe
(),

906 
cu¼’t_lock
.
ts
,

907 
NÚe
,

908 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

909 !
ùx
.
g‘_nÙ_fl_ÿche
(),

911 
Ët
 
	g¡©us
 = 
txn_¡©us
.
g‘
(&
cu¼’t_lock
.
ts
);

912 
Ët
 
	gcomm™_ts
 = 
m©ch
 
¡©us
 {

913 
Some
(
ts
) => *ts,

914 
	gNÚe
 => 
·nic
!("txn status‚ot found."),

916 
	gcomm™_ts
 > 0 {

917 
	gcu¼’t_lock
.
	gts
 >ğ
comm™_ts
 {

918  
E¼
(
E¼Ü
::
Inv®idTxnTso
 {

919 
¡¬t_ts
: 
cu¼’t_lock
.
ts
,

920 
comm™_ts
: commit_ts,

923 
	gtxn
.
comm™
(
cu¼’t_key
, 
comm™_ts
)?;

925 
	gtxn
.
rŞlback
(
cu¼’t_key
)?;

927 
	gwr™e_size
 +ğ
txn
.
wr™e_size
();

929 
	g¡©i¡ics
.
add
(
txn
.
g‘_¡©i¡ics
());

930 
	gmodif›s
.
­³nd
(&
mut
 
txn
.
što_modif›s
());

932 
	gwr™e_size
 >ğ
MAX_TXN_WRITE_SIZE
 {

933 
sÿn_key
 = 
Some
(
cu¼’t_key
.
to_owÃd
());

937 
Ët
 
	g´
 = 
sÿn_key
.
is_nÚe
() {

938 
ProûssResuÉ
::
Res


940 
ProûssResuÉ
::
NextCommªd
 {

941 
cmd
: 
Commªd
::
ResŞveLock
 {

942 
ùx
: ctx.
şÚe
(),

943 
txn_¡©us
: 
mem
::
»¶aû
Ñxn_¡©us, 
DeçuÉ
::()),

944 
sÿn_key
: sÿn_key.
ke
(),

945 
key_locks
: 
vec
![],

949 (
	g´
, 
	gmodif›s
, 
	grows
)

951 
	gCommªd
::
Gc
 {

952 
»f
 
ùx
,

953 
	g§ã_pošt
,

954 
	g¿tio_th»shŞd
,

955 
»f
 
mut
 
	gsÿn_key
,

956 
»f
 
	gkeys
,

958 
Ët
 
mut
 
sÿn_key
 = sÿn_key.
ke
();

959 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(

960 
¢­shÙ
,

962 
Some
(
SÿnMode
::
FÜw¬d
),

963 
ùx
.
g‘_isŞ©iÚ_Ëv–
(),

964 !
ùx
.
g‘_nÙ_fl_ÿche
(),

966 
Ët
 
	grows
 = 
keys
.
Ën
();

967 
k
 
š
 
	gkeys
 {

968 
	gtxn
.
gc
(
k
, 
§ã_pošt
)?;

969 
	gtxn
.
wr™e_size
(è>ğ
MAX_TXN_WRITE_SIZE
 {

970 
sÿn_key
 = 
Some
(
k
.
to_owÃd
());

975 
	g¡©i¡ics
.
add
(
txn
.
g‘_¡©i¡ics
());

976 
Ët
 
	g´
 = 
sÿn_key
.
is_nÚe
() {

977 
ProûssResuÉ
::
Res


979 
ProûssResuÉ
::
NextCommªd
 {

980 
cmd
: 
Commªd
::
Gc
 {

981 
ùx
: ctx.
şÚe
(),

982 
§ã_pošt
: safe_point,

983 
¿tio_th»shŞd
:„atio_threshold,

984 
sÿn_key
: sÿn_key.
ke
(),

985 
keys
: 
vec
![],

989 (
	g´
, 
	gtxn
.
što_modif›s
(), 
	grows
)

991 
	g_
 => 
·nic
!("unsupported write command"),

994 
	gbox_Œy
!(
	gch
.
£nd
(
Msg
::
Wr™eP»·»Fšished
 {

995 
cid
: cid,

996 
cmd
: cmd,

997 
´
:…r,

998 
to_be_wr™e
: 
modif›s
,

999 
rows
:„ows,

1002 
Ok
(())

1005 #[
d”ive
(
DeçuÉ
)]

1006 
	sSchedCÚ‹xt
 {

1007 
	m¡©s
: 
HashM­
<&'static str, StatisticsSummary>,

1010 
im¶
 
SchedCÚ‹xt
 {

1011 
â
 
add_¡©i¡ics
(&
mut
 
£lf
, 
cmd_g
: &'static str, stat: &Statistics) {

1012 
Ët
 
’Œy
 = 
£lf
.
¡©s
.’Œy(
cmd_g
).
Ü_š£¹_w™h
(
DeçuÉ
::);

1013 
’Œy
.
add_¡©i¡ics
(
¡©
);

1017 
im¶
 
Th»adCÚ‹xt
 
SchedCÚ‹xt
 {

1018 
â
 
Ú_tick
(&
mut
 
£lf
) {

1019 
cmd
, 
¡©
è
š
 
£lf
.
¡©s
.
d¿š
() {

1020 
cf
, 
d‘as
è
š
 
¡©
.stat.details() {

1021 
g
, 
couÁ
è
š
 
d‘as
 {

1022 
KV_COMMAND_SCAN_DETAILS


1023 .
w™h_Ïb–_v®ues
(&[
cmd
, 
cf
, 
g
])

1024 .
šc_by
(
couÁ
 
as
 
f64
)

1025 .
unw¿p
();

1032 
im¶
 
ScheduËr
 {

1034 
â
 
g’_id
(&
mut
 
£lf
è-> 
u64
 {

1035 
£lf
.
id_®loc
 += 1;

1036 
£lf
.
id_®loc


1039 
â
 
š£¹_ùx
(&
mut
 
£lf
, 
ùx
: 
RuÂšgCtx
) {

1040 
ùx
.
lock
.
is_wr™e_lock
() {

1041 
£lf
.
ruÂšg_wr™e_by‹s
 +ğ
ùx
.
wr™e_by‹s
;

1043 
ùx
.
g
 =ğ
CMD_TAG_GC
 {

1044 
£lf
.
has_gc_commªd
 = 
Œue
;

1046 
Ët
 
cid
 = 
ùx
.cid;

1047 
£lf
.
cmd_ùxs
.
š£¹
(
cid
, 
ùx
).
is_some
() {

1048 
·nic
!("commªd cid={} shouldn'ˆexi¡", 
cid
);

1050 
SCHED_WRITING_BYTES_GAUGE
.
£t
(
£lf
.
ruÂšg_wr™e_by‹s
 
as
 
f64
);

1051 
SCHED_CONTEX_GAUGE
.
£t
(
£lf
.
cmd_ùxs
.
Ën
(è
as
 
f64
);

1054 
â
 
»move_ùx
(&
mut
 
£lf
, 
cid
: 
u64
è-> 
RuÂšgCtx
 {

1055 
Ët
 
ùx
 = 
£lf
.
cmd_ùxs
.
»move
(&
cid
).
unw¿p
();

1056 
as£¹_eq
!(
ùx
.
cid
, cid);

1057 
ùx
.
lock
.
is_wr™e_lock
() {

1058 
£lf
.
ruÂšg_wr™e_by‹s
 -ğ
ùx
.
wr™e_by‹s
;

1060 
ùx
.
g
 =ğ
CMD_TAG_GC
 {

1061 
£lf
.
has_gc_commªd
 = 
çl£
;

1063 
SCHED_WRITING_BYTES_GAUGE
.
£t
(
£lf
.
ruÂšg_wr™e_by‹s
 
as
 
f64
);

1064 
SCHED_CONTEX_GAUGE
.
£t
(
£lf
.
cmd_ùxs
.
Ën
(è
as
 
f64
);

1065 
ùx


1068 
â
 
g‘_ùx_g
(&
£lf
, 
cid
: 
u64
) -> &'static str {

1069 
Ët
 
ùx
 = &
£lf
.
cmd_ùxs
[&
cid
];

1070 
ùx
.
g


1073 
â
 
ãtch_wÜk”_poŞ
(&
£lf
, 
´iÜ™y
: 
CommªdPri
è-> &
Th»adPoŞ
<
SchedCÚ‹xt
> {

1074 
m©ch
 
´iÜ™y
 {

1075 
CommªdPri
::
Low
 | CommªdPri::
NÜm®
 => &
£lf
.
wÜk”_poŞ
,

1076 
CommªdPri
::
High
 => &
£lf
.
high_´iÜ™y_poŞ
,

1081 
â
 
´oûss_by_wÜk”
(&
mut
 
£lf
, 
cid
: 
u64
, 
cb_ùx
: 
CbCÚ‹xt
, 
¢­shÙ
: 
Box
<
SÇpshÙ
>) {

1082 
SCHED_STAGE_COUNTER_VEC


1083 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(
cid
), "process"])

1084 .
šc
();

1085 
debug
!(

1087 
cid
,

1088 
cb_ùx


1090 
Ët
 
mut
 
cmd
 = {

1091 
Ët
 
ùx
 = &
mut
 
£lf
.
cmd_ùxs
.
g‘_mut
(&
cid
).
unw¿p
();

1092 
as£¹_eq
!(
ùx
.
cid
, cid);

1093 
ùx
.
cmd
.
ke
().
unw¿p
()

1095 
Ët
 
Some
(
‹rm
èğ
cb_ùx
.term {

1096 
cmd
.
mut_cÚ‹xt
().
£t_‹rm
(
‹rm
);

1098 
Ët
 
ch
 = 
£lf
.
schedch
.
şÚe
();

1099 
Ët
 
»adcmd
 = 
cmd
.
»adÚly
();

1100 
Ët
 
wÜk”_poŞ
 = 
£lf
.
ãtch_wÜk”_poŞ
(
cmd
.
´iÜ™y
());

1101 
Ët
 
g
 = 
cmd
.tag();

1102 
»adcmd
 {

1103 
wÜk”_poŞ
.
execu‹
(
move
 |
ùx
: &
mut
 
SchedCÚ‹xt
| {

1104 
Ët
 
s
 = 
´oûss_»ad
(
cid
, 
cmd
, 
ch
, 
¢­shÙ
);

1105 
ùx
.
add_¡©i¡ics
(
g
, &
s
);

1108 
wÜk”_poŞ
.
execu‹
(
move
 |
ùx
: &
mut
 
SchedCÚ‹xt
| {

1109 
Ët
 
s
 = 
´oûss_wr™e
(
cid
, 
cmd
, 
ch
, 
¢­shÙ
);

1110 
ùx
.
add_¡©i¡ics
(
g
, &
s
);

1116 
â
 
	$fšish_w™h_”r
(&
mut
 
£lf
, 
cid
: 
u64
, 
”r
: 
E¼Ü
) {

1117 
debug
!("commªd cid={}, fšished w™hƒ¼Ü", 
cid
);

1118 
SCHED_STAGE_COUNTER_VEC


1119 .
	`w™h_Ïb–_v®ues
(&[
£lf
.
	`g‘_ùx_g
(
cid
), "error"])

1120 .
	`šc
();

1122 
Ët
 
mut
 
ùx
 = 
£lf
.
	`»move_ùx
(
cid
);

1123 
Ët
 
cb
 = 
ùx
.
ÿÎback
.
	`ke
().
	`unw¿p
();

1124 
Ët
 
´
 = 
ProûssResuÉ
::
Faed
 {

1125 
”r
: 
StÜageE¼Ü
::
	`äom
(err),

1127 
	`execu‹_ÿÎback
(
cb
, 
´
);

1129 
£lf
.
	`»Ëa£_lock
(&
ùx
.
lock
, 
cid
);

1130 
	}
}

1133 
â
 
exŒaù_cÚ‹xt
(&
£lf
, 
cid
: 
u64
è-> &
CÚ‹xt
 {

1134 
Ët
 
ùx
 = &
£lf
.
cmd_ùxs
[&
cid
];

1135 
as£¹_eq
!(
ùx
.
cid
, cid);

1136 
ùx
.
cmd
.
as_»f
().
unw¿p
().
g‘_cÚ‹xt
()

1149 
â
 
	$scheduË_commªd
(&
mut
 
£lf
, 
cmd
: 
Commªd
, 
ÿÎback
: 
StÜageCb
) {

1150 
SCHED_STAGE_COUNTER_VEC


1151 .
	`w™h_Ïb–_v®ues
(&[
cmd
.
	`g
(), "new"])

1152 .
	`šc
();

1153 
SCHED_COMMANDS_PRI_COUNTER_VEC


1154 .
	`w™h_Ïb–_v®ues
(&[
cmd
.
	`´iÜ™y_g
()])

1155 .
	`šc
();

1156 
Ët
 
cid
 = 
£lf
.
	`g’_id
();

1157 
debug
!("»ûived‚ew commªd, cid={}, cmd={}", 
cid
, 
cmd
);

1158 
Ët
 
lock
 = 
	`g’_commªd_lock
(&
£lf
.
Ïtches
, &
cmd
);

1159 
Ët
 
ùx
 = 
RuÂšgCtx
::
	`Ãw
(
cid
, 
cmd
, 
lock
, 
ÿÎback
);

1160 
£lf
.
	`š£¹_ùx
(
ùx
);

1161 
£lf
.
	`lock_ªd_»gi¡”_g‘_¢­shÙ
(
cid
);

1162 
	}
}

1164 
â
 
too_busy
(&
£lf
è-> 
boŞ
 {

1165 
£lf
.
ruÂšg_wr™e_by‹s
 >ğ£lf.
sched_³ndšg_wr™e_th»shŞd


1168 
â
 
	$Ú_»ûive_Ãw_cmd
(&
mut
 
£lf
, 
cmd
: 
Commªd
, 
ÿÎback
: 
StÜageCb
) {

1170 
cmd
.
	`Ãed_æow_cÚŒŞ
(è&& 
£lf
.
	`too_busy
() {

1171 
SCHED_TOO_BUSY_COUNTER_VEC


1172 .
	`w™h_Ïb–_v®ues
(&[
cmd
.
	`g
()])

1173 .
	`šc
();

1174 
	`execu‹_ÿÎback
(

1175 
ÿÎback
,

1176 
ProûssResuÉ
::
Faed
 {

1177 
”r
: 
StÜageE¼Ü
::
SchedTooBusy
,

1183 
cmd
.
	`g
(è=ğ
CMD_TAG_GC
 && 
£lf
.
has_gc_commªd
 {

1184 
SCHED_TOO_BUSY_COUNTER_VEC


1185 .
	`w™h_Ïb–_v®ues
(&[
cmd
.
	`g
()])

1186 .
	`šc
();

1187 
	`execu‹_ÿÎback
(

1188 
ÿÎback
,

1189 
ProûssResuÉ
::
Faed
 {

1190 
”r
: 
StÜageE¼Ü
::
SchedTooBusy
,

1196 
£lf
.
	`scheduË_commªd
(
cmd
, 
ÿÎback
);

1197 
	}
}

1202 
â
 
acquœe_lock
(&
mut
 
£lf
, 
cid
: 
u64
è-> 
boŞ
 {

1203 
Ët
 
ùx
 = &
mut
 
£lf
.
cmd_ùxs
.
g‘_mut
(&
cid
).
unw¿p
();

1204 
as£¹_eq
!(
ùx
.
cid
, cid);

1205 
Ët
 
ok
 = 
£lf
.
Ïtches
.
acquœe
(&
mut
 
ùx
.
lock
, 
cid
);

1206 
ok
 {

1207 
ùx
.
Ïtch_tim”
.
ke
();

1208 
ùx
.
¦ow_tim”
 = 
Some
(
SlowTim”
::
Ãw
());

1210 
ok


1215 
â
 
g‘_¢­shÙ
(&
mut
 
£lf
, 
ùx
: &
CÚ‹xt
, 
cids
: 
Vec
<
u64
>) {

1216 
cid
 
š
 &
cids
 {

1217 
SCHED_STAGE_COUNTER_VEC


1218 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(*
cid
), "snapshot"])

1219 .
šc
();

1221 
Ët
 
cids1
 = 
cids
.
şÚe
();

1222 
Ët
 
ch
 = 
£lf
.
schedch
.
şÚe
();

1223 
Ët
 
cb
 = 
box
 
move
 |(
cb_ùx
, 
¢­shÙ
)| 
m©ch
 
ch
.
£nd
(
Msg
::
SÇpshÙFšished
 {

1224 
cids
: 
cids1
,

1225 
cb_ùx
: cb_ctx,

1226 
¢­shÙ
: snapshot,

1228 
Ok
(
_
) => {}

1229 
e
 @ 
E¼
(
T¿n¥ÜtE¼Ü
::
Clo£d
è=> 
šfo
!("channel closed,ƒrr {:?}",ƒ),

1230 
E¼
(
e
è=> 
·nic
!("send SnapshotFinish failed,ƒrr {:?}",ƒ),

1233 
Ët
 
E¼
(
e
èğ
£lf
.
’gše
.
async_¢­shÙ
(
ùx
, 
cb
) {

1234 
cid
 
š
 
cids
 {

1235 
SCHED_STAGE_COUNTER_VEC


1236 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(
cid
), "async_snap_err"])

1237 .
šc
();

1239 
Ët
 
e
 =ƒ.
maybe_şÚe
().
unw¿p_Ü_–£
(|| {

1240 
”rÜ
!("asynø¢­shÙ faed fÜ cid={},ƒ¼Ü {:?}", 
cid
, 
e
);

1241 
EngšeE¼Ü
::
Oth”
(
box_”r
!("{:?}", 
e
))

1243 
£lf
.
fšish_w™h_”r
(
cid
, 
E¼Ü
::
äom
(
e
));

1251 
â
 
b©ch_g‘_¢­shÙ
(&
mut
 
£lf
, 
b©ch
: 
Vec
<(
CÚ‹xt
, Vec<
u64
>)>) {

1252 
Ët
 
mut
 
®l_cids
 = 
Vec
::
w™h_ÿ·c™y
(
b©ch
.
™”
().
m­
(|&(
_
, 
»f
 
cids
)| cids.
Ën
()).
sum
());

1253 &(
_
, 
»f
 
cids
è
š
 &
b©ch
 {

1254 
cid
 
š
 
cids
 {

1255 
SCHED_STAGE_COUNTER_VEC


1256 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(*
cid
), "snapshot"])

1257 .
šc
();

1259 
®l_cids
.
ex‹nd
(
cids
);

1262 
Ët
 
b©ch1
 = 
b©ch
.
™”
().
m­
(|&(
»f
 
ùx
, 
_
)| ctx.
şÚe
()).
cŞËù
();

1263 
Ët
 
ch
 = 
£lf
.
schedch
.
şÚe
();

1264 
Ët
 
Ú_fšished
: 
’gše
::
B©chC®lback
<
Box
<
SÇpshÙ
>> = 
box
 
move
 |
»suÉs
: 
Vec
<
_
>| {

1265 
Ët
 
mut
 
»ady
 = 
Vec
::
w™h_ÿ·c™y
(
»suÉs
.
Ën
());

1266 
Ët
 
mut
 
»Œy
 = 
Vec
::
Ãw
();

1267 (
ùx
, 
cids
), 
¢­shÙ
è
š
 
b©ch
.
što_™”
().
z
(
»suÉs
) {

1268 
m©ch
 
¢­shÙ
 {

1269 
Some
((
cb_ùx
, 
¢­shÙ
)) => {

1270 
»ady
.
push
((
cids
, 
cb_ùx
, 
¢­shÙ
));

1272 
NÚe
 => {

1273 
»Œy
.
push
((
ùx
, 
cids
));

1277 !
»ady
.
is_em±y
() {

1278 
m©ch
 
ch
.
£nd
(
Msg
::
B©chSÇpshÙFšished
 { 
b©ch
: 
»ady
 }) {

1279 
Ok
(
_
) => {}

1280 
e
 @ 
E¼
(
T¿n¥ÜtE¼Ü
::
Clo£d
è=> 
šfo
!("channel closed,ƒrr {:?}",ƒ),

1281 
E¼
(
e
) => {

1282 
·nic
!("£nd B©chSÇpshÙFšish faedƒ¼ {:?}", 
e
);

1286 !
»Œy
.
is_em±y
() {

1287 
BATCH_COMMANDS


1288 .
w™h_Ïb–_v®ues
(&["retry"])

1289 .
ob£rve
(
»Œy
.
Ën
(è
as
 
f64
);

1290 
m©ch
 
ch
.
£nd
(
Msg
::
R‘ryG‘SÇpshÙs
(
»Œy
)) {

1291 
Ok
(
_
) => {}

1292 
e
 @ 
E¼
(
T¿n¥ÜtE¼Ü
::
Clo£d
è=> 
šfo
!("channel closed,ƒrr {:?}",ƒ),

1293 
E¼
(
e
) => {

1294 
·nic
!("£nd R‘ryG‘SÇpshÙ çedƒ¼ {:?}", 
e
);

1300 
Ët
 
E¼
(
e
èğ
£lf
.
’gše
.
async_b©ch_¢­shÙ
(
b©ch1
, 
Ú_fšished
) {

1301 
cid
 
š
 
®l_cids
 {

1302 
SCHED_STAGE_COUNTER_VEC


1303 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(
cid
), "async_snap_err"])

1304 .
šc
();

1305 
Ët
 
e
 =ƒ.
maybe_şÚe
().
unw¿p_Ü_–£
(|| {

1306 
”rÜ
!("asynø¢­shÙ faed fÜ cid={},ƒ¼Ü {:?}", 
cid
, 
e
);

1307 
EngšeE¼Ü
::
Oth”
(
box_”r
!("{:?}", 
e
))

1309 
£lf
.
fšish_w™h_”r
(
cid
, 
E¼Ü
::
äom
(
e
));

1314 
â
 
Ú_»Œy_g‘_¢­shÙs
(&
mut
 
£lf
, 
b©ch
: 
Vec
<(
CÚ‹xt
, Vec<
u64
>)>) {

1315 
ùx
, 
cids
è
š
 
b©ch
 {

1316 
cid
 
š
 &
cids
 {

1317 
SCHED_STAGE_COUNTER_VEC


1318 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(*
cid
), "snapshot_retry"])

1319 .
šc
();

1321 
£lf
.
g‘_¢­shÙ
(&
ùx
, 
cids
);

1328 
â
 
Ú_¢­shÙ_fšished
(

1329 &
mut
 
£lf
,

1330 
cids
: 
Vec
<
u64
>,

1331 
cb_ùx
: 
CbCÚ‹xt
,

1332 
¢­shÙ
: 
EngšeResuÉ
<
Box
<
SÇpshÙ
>>,

1334 
debug
!(

1336 
cids
,

1337 
cb_ùx


1339 
m©ch
 
¢­shÙ
 {

1340 
Ok
(
¢­shÙ
è=> 
cid
 
š
 
cids
 {

1341 
SCHED_STAGE_COUNTER_VEC


1342 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(
cid
), "snapshot_ok"])

1343 .
šc
();

1344 
£lf
.
´oûss_by_wÜk”
(
cid
, 
cb_ùx
.
şÚe
(), 
¢­shÙ
.clone());

1346 
E¼
(
»f
 
e
) => {

1347 
”rÜ
!("g‘ sÇpshÙ faed fÜ cids={:?},ƒ¼Ü {:?}", 
cids
, 
e
);

1348 
cid
 
š
 
cids
 {

1349 
SCHED_STAGE_COUNTER_VEC


1350 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(
cid
), "snapshot_err"])

1351 .
šc
();

1352 
Ët
 
e
 =ƒ.
maybe_şÚe
()

1353 .
unw¿p_Ü_–£
(|| 
EngšeE¼Ü
::
Oth”
(
box_”r
!("{:?}", 
e
)));

1354 
£lf
.
fšish_w™h_”r
(
cid
, 
E¼Ü
::
äom
(
e
));

1364 
â
 
	$Ú_»ad_fšished
(&
mut
 
£lf
, 
cid
: 
u64
, 
´
: 
ProûssResuÉ
) {

1365 
debug
!("»ad commªd(cid={}èfšished", 
cid
);

1366 
Ët
 
mut
 
ùx
 = 
£lf
.
	`»move_ùx
(
cid
);

1367 
SCHED_STAGE_COUNTER_VEC


1368 .
	`w™h_Ïb–_v®ues
(&[
ùx
.
g
, "read_finish"])

1369 .
	`šc
();

1370 
Ët
 
cb
 = 
ùx
.
ÿÎback
.
	`ke
().
	`unw¿p
();

1371 
Ët
 
ProûssResuÉ
::
NextCommªd
 { 
cmd
 } = 
´
 {

1372 
SCHED_STAGE_COUNTER_VEC


1373 .
	`w™h_Ïb–_v®ues
(&[
ùx
.
g
, "next_cmd"])

1374 .
	`šc
();

1375 
£lf
.
	`scheduË_commªd
(
cmd
, 
cb
);

1377 
	`execu‹_ÿÎback
(
cb
, 
´
);

1380 
£lf
.
	`»Ëa£_lock
(&
ùx
.
lock
, 
cid
);

1381 
	}
}

1387 
â
 
	$Ú_wr™e_´•¬e_çed
(&
mut
 
£lf
, 
cid
: 
u64
, 
e
: 
E¼Ü
) {

1388 
debug
!("wr™commªd(cid={}èçed‡ˆ´ewr™e.", 
cid
);

1389 
SCHED_STAGE_COUNTER_VEC


1390 .
	`w™h_Ïb–_v®ues
(&[
£lf
.
	`g‘_ùx_g
(
cid
), "prepare_write_err"])

1391 .
	`šc
();

1392 
£lf
.
	`fšish_w™h_”r
(
cid
, 
e
);

1393 
	}
}

1399 
â
 
Ú_wr™e_´•¬e_fšished
(

1400 &
mut
 
£lf
,

1401 
cid
: 
u64
,

1402 
cmd
: 
Commªd
,

1403 
´
: 
ProûssResuÉ
,

1404 
to_be_wr™e
: 
Vec
<
Modify
>,

1405 
rows
: 
usize
,

1407 
SCHED_STAGE_COUNTER_VEC


1408 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(
cid
), "write"])

1409 .
šc
();

1410 
to_be_wr™e
.
is_em±y
() {

1411  
£lf
.
Ú_wr™e_fšished
(
cid
, 
´
, 
Ok
(()));

1413 
Ët
 
’gše_cb
 = 
make_’gše_cb
(
cmd
.
g
(), 
cid
, 
´
, 
£lf
.
schedch
.
şÚe
(), 
rows
);

1414 
Ët
 
E¼
(
e
èğ
£lf
.
’gše


1415 .
async_wr™e
(
cmd
.
g‘_cÚ‹xt
(), 
to_be_wr™e
, 
’gše_cb
)

1417 
SCHED_STAGE_COUNTER_VEC


1418 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(
cid
), "async_write_err"])

1419 .
šc
();

1420 
£lf
.
fšish_w™h_”r
(
cid
, 
E¼Ü
::
äom
(
e
));

1425 
â
 
Ú_wr™e_fšished
(&
mut
 
£lf
, 
cid
: 
u64
, 
´
: 
ProûssResuÉ
, 
»suÉ
: 
EngšeResuÉ
<()>) {

1426 
SCHED_STAGE_COUNTER_VEC


1427 .
w™h_Ïb–_v®ues
(&[
£lf
.
g‘_ùx_g
(
cid
), "write_finish"])

1428 .
šc
();

1429 
debug
!("wr™fšished fÜ commªd, cid={}", 
cid
);

1430 
Ët
 
mut
 
ùx
 = 
£lf
.
»move_ùx
(
cid
);

1431 
Ët
 
cb
 = 
ùx
.
ÿÎback
.
ke
().
unw¿p
();

1432 
Ët
 
´
 = 
m©ch
 
»suÉ
 {

1433 
Ok
(()è=> 
´
,

1434 
E¼
(
e
è=> 
ProûssResuÉ
::
Faed
 {

1435 
”r
: ::
¡Üage
::
E¼Ü
::
äom
(
e
),

1438 
Ët
 
ProûssResuÉ
::
NextCommªd
 { 
cmd
 } = 
´
 {

1439 
SCHED_STAGE_COUNTER_VEC


1440 .
w™h_Ïb–_v®ues
(&[
ùx
.
g
, "next_cmd"])

1441 .
šc
();

1442 
£lf
.
scheduË_commªd
(
cmd
, 
cb
);

1444 
execu‹_ÿÎback
(
cb
, 
´
);

1447 
£lf
.
»Ëa£_lock
(&
ùx
.
lock
, 
cid
);

1451 
â
 
	$»Ëa£_lock
(&
mut
 
£lf
, 
lock
: &
Lock
, 
cid
: 
u64
) {

1452 
Ët
 
wakeup_li¡
 = 
£lf
.
Ïtches
.
	`»Ëa£
(
lock
, 
cid
);

1453 
wcid
 
š
 
wakeup_li¡
 {

1454 
£lf
.
	`lock_ªd_»gi¡”_g‘_¢­shÙ
(
wcid
);

1456 
	}
}

1460 
â
 
	$lock_ªd_»gi¡”_g‘_¢­shÙ
(&
mut
 
£lf
, 
cid
: 
u64
) {

1461 
£lf
.
	`acquœe_lock
(
cid
) {

1462 
Ët
 
ùx
 = 
£lf
.
	`exŒaù_cÚ‹xt
(
cid
).
	`şÚe
();

1463 
Ët
 
group
 = 
£lf
.
grou³d_cmds


1464 .
	`as_mut
()

1465 .
	`unw¿p
()

1466 .
	`’Œy
(
	`HashabËCÚ‹xt
(
ùx
))

1467 .
	`Ü_š£¹_w™h
(
Vec
::
Ãw
);

1468 
group
.
	`push
(
cid
);

1470 
	}
}

1472 
pub
 
â
 
run
(&
mut
 
£lf
, 
»ûiv”
: 
Reûiv”
<
Msg
>è-> 
ResuÉ
<()> {

1473 
Ët
 
mut
 
msgs
 = 
Vec
::
w™h_ÿ·c™y
(
CMD_BATCH_SIZE
);

1474 
loİ
 {

1475 
Ët
 
msg
 = 
box_Œy
!(
»ûiv”
.
»cv
());

1476 
msgs
.
push
(
msg
);

1477 
Ët
 
Ok
(
msg
èğ
»ûiv”
.
Œy_»cv
() {

1478 
msgs
.
push
(
msg
);

1479 
msgs
.
Ën
(è>ğ
CMD_BATCH_SIZE
 {

1484 
msg
 
š
 
msgs
.
d¿š
(..) {

1485 
m©ch
 
msg
 {

1486 
Msg
::
Qu™
 =>  
£lf
.
shutdown
(),

1487 
Msg
::
RawCmd
 { 
cmd
, 
cb
 } => 
£lf
.
Ú_»ûive_Ãw_cmd
(cmd, cb),

1488 
Msg
::
R‘ryG‘SÇpshÙs
(
b©ch
è=> 
£lf
.
Ú_»Œy_g‘_¢­shÙs
(batch),

1489 
Msg
::
SÇpshÙFšished
 {

1490 
cids
,

1491 
cb_ùx
,

1492 
¢­shÙ
,

1493 } => 
£lf
.
Ú_¢­shÙ_fšished
(
cids
, 
cb_ùx
, 
¢­shÙ
),

1494 
Msg
::
B©chSÇpshÙFšished
 { 
b©ch
 } => 
cids
, 
cb_ùx
, 
¢­shÙ
è
š
 batch {

1495 
£lf
.
Ú_¢­shÙ_fšished
(
cids
, 
cb_ùx
, 
¢­shÙ
)

1497 
Msg
::
R—dFšished
 { 
cid
, 
´
 } => 
£lf
.
Ú_»ad_fšished
(cid,…r),

1498 
Msg
::
Wr™eP»·»Fšished
 {

1499 
cid
,

1500 
cmd
,

1501 
´
,

1502 
to_be_wr™e
,

1503 
rows
,

1504 } => 
£lf
.
Ú_wr™e_´•¬e_fšished
(
cid
, 
cmd
, 
´
, 
to_be_wr™e
, 
rows
),

1505 
Msg
::
Wr™eP»·»Faed
 { 
cid
, 
”r
 } => 
£lf
.
Ú_wr™e_´•¬e_çed
(cid,ƒrr),

1506 
Msg
::
Wr™eFšished
 {

1507 
cid
, 
´
, 
»suÉ
, ..

1508 } => 
£lf
.
Ú_wr™e_fšished
(
cid
, 
´
, 
»suÉ
),

1512 
£lf
.
grou³d_cmds
.
as_»f
().
unw¿p
().
is_em±y
() {

1516 
Ët
 
Some
(
cmds
èğ
£lf
.
grou³d_cmds
.
ke
() {

1517 
£lf
.
grou³d_cmds
 = 
Some
(
HashM­
::
w™h_ÿ·c™y_ªd_hash”
(

1518 
CMD_BATCH_SIZE
,

1519 
DeçuÉ
::(),

1521 
Ët
 
b©ch
 = 
cmds
.
što_™”
().
m­
(|(
hash_ùx
, 
cids
)| {

1522 
BATCH_COMMANDS


1523 .
w™h_Ïb–_v®ues
(&["all"])

1524 .
ob£rve
(
cids
.
Ën
(è
as
 
f64
);

1525 (
hash_ùx
.0, 
cids
)

1527 
£lf
.
b©ch_g‘_¢­shÙ
(
b©ch
.
cŞËù
());

1532 
â
 
shutdown
(&
mut
 
£lf
è-> 
ResuÉ
<()> {

1533 
Ët
 
E¼
(
e
èğ
£lf
.
wÜk”_poŞ
.
¡İ
() {

1534  
E¼
(
E¼Ü
::
Oth”
(
box_”r
!("{:?}", 
e
)));

1536 
Ët
 
E¼
(
e
èğ
£lf
.
high_´iÜ™y_poŞ
.
¡İ
() {

1537  
E¼
(
E¼Ü
::
Oth”
(
box_”r
!("{:?}", 
e
)));

1539 
Ok
(())

1543 cÚ¡ 
CMD_BATCH_SIZE
: 
usize
 = 256;

1549 
pub
 
â
 
g’_commªd_lock
(
Ïtches
: &
L©ches
, 
cmd
: &
Commªd
è-> 
Lock
 {

1550 
m©ch
 *
cmd
 {

1551 
Commªd
::
P»wr™e
 { 
»f
 
mutiÚs
, .. } => {

1552 
Ët
 
keys
: 
Vec
<&
Key
> = 
mutiÚs
.
™”
().
m­
(|
x
| x.
key
()).
cŞËù
();

1553 
Ïtches
.
g’_lock
(&
keys
)

1555 
Commªd
::
ResŞveLock
 { 
»f
 
key_locks
, .. } => {

1556 
Ët
 
keys
: 
Vec
<&
Key
> = 
key_locks
.
™”
().
m­
(|
x
| &x.0).
cŞËù
();

1557 
Ïtches
.
g’_lock
(&
keys
)

1559 
Commªd
::
Comm™
 { 
»f
 
keys
, .. } | Commªd::
RŞlback
 {„ef keys, .. } => {

1560 
Ïtches
.
g’_lock
(
keys
)

1562 
Commªd
::
CËªup
 { 
»f
 
key
, .. } => 
Ïtches
.
g’_lock
(&[key]),

1563 
_
 => 
Lock
::
Ãw
(
vec
![]),

1567 #[
cfg
(
‹¡
)]

1568 
mod
 
‹¡s
 {

1569 
u£
 
su³r
::*;

1570 
u£
 
kv´Ùo
::
kv½ıb
::
CÚ‹xt
;

1571 
u£
 
ut
::
cŞËùiÚs
::
HashM­
;

1572 
u£
 
¡Üage
::
txn
::
Ïtch
::*;

1573 
u£
 
¡Üage
::{
make_key
, 
Commªd
, 
MutiÚ
, 
O±iÚs
};

1574 
u£
 
¡Üage
::
mvcc
;

1576 #[
‹¡
]

1577 
â
 
‹¡_commªd_Ïtches
() {

1578 
Ët
 
mut
 
‹mp_m­
 = 
HashM­
::();

1579 
‹mp_m­
.
š£¹
(10, 20);

1580 
Ët
 
»adÚly_cmds
 = 
vec
![

1581 
Commªd
::
G‘
 {

1582 
ùx
: 
CÚ‹xt
::
Ãw
(),

1583 
key
: 
make_key
(
b
"k"),

1584 
¡¬t_ts
: 25,

1586 
Commªd
::
B©chG‘
 {

1587 
ùx
: 
CÚ‹xt
::
Ãw
(),

1588 
keys
: 
vec
![
make_key
(
b
"k")],

1589 
¡¬t_ts
: 25,

1591 
Commªd
::
Sÿn
 {

1592 
ùx
: 
CÚ‹xt
::
Ãw
(),

1593 
¡¬t_key
: 
make_key
(
b
"k"),

1594 
lim™
: 100,

1595 
¡¬t_ts
: 25,

1596 
İtiÚs
: 
O±iÚs
::(),

1598 
Commªd
::
SÿnLock
 {

1599 
ùx
: 
CÚ‹xt
::
Ãw
(),

1600 
max_ts
: 5,

1602 
Commªd
::
ResŞveLock
 {

1603 
ùx
: 
CÚ‹xt
::
Ãw
(),

1604 
txn_¡©us
: 
‹mp_m­
.
şÚe
(),

1605 
sÿn_key
: 
NÚe
,

1606 
key_locks
: 
vec
![],

1608 
Commªd
::
Gc
 {

1609 
ùx
: 
CÚ‹xt
::
Ãw
(),

1610 
§ã_pošt
: 5,

1611 
¿tio_th»shŞd
: 0.0,

1612 
sÿn_key
: 
NÚe
,

1613 
keys
: 
vec
![
make_key
(
b
"k")],

1615 
Commªd
::
MvccByKey
 {

1616 
ùx
: 
CÚ‹xt
::
Ãw
(),

1617 
key
: 
make_key
(
b
"k"),

1619 
Commªd
::
MvccByS¹Ts
 {

1620 
ùx
: 
CÚ‹xt
::
Ãw
(),

1621 
¡¬t_ts
: 25,

1624 
Ët
 
wr™e_cmds
 = 
vec
![

1625 
Commªd
::
P»wr™e
 {

1626 
ùx
: 
CÚ‹xt
::
Ãw
(),

1627 
mutiÚs
: 
vec
![
MutiÚ
::
Put
((
make_key
(
b
"k"), b"v".
to_vec
()))],

1628 
´im¬y
: 
b
"k".
to_vec
(),

1629 
¡¬t_ts
: 10,

1630 
İtiÚs
: 
O±iÚs
::(),

1632 
Commªd
::
Comm™
 {

1633 
ùx
: 
CÚ‹xt
::
Ãw
(),

1634 
keys
: 
vec
![
make_key
(
b
"k")],

1635 
lock_ts
: 10,

1636 
comm™_ts
: 20,

1638 
Commªd
::
CËªup
 {

1639 
ùx
: 
CÚ‹xt
::
Ãw
(),

1640 
key
: 
make_key
(
b
"k"),

1641 
¡¬t_ts
: 10,

1643 
Commªd
::
RŞlback
 {

1644 
ùx
: 
CÚ‹xt
::
Ãw
(),

1645 
keys
: 
vec
![
make_key
(
b
"k")],

1646 
¡¬t_ts
: 10,

1648 
Commªd
::
ResŞveLock
 {

1649 
ùx
: 
CÚ‹xt
::
Ãw
(),

1650 
txn_¡©us
: 
‹mp_m­
.
şÚe
(),

1651 
sÿn_key
: 
NÚe
,

1652 
key_locks
: 
vec
![

1654 
make_key
(
b
"k"),

1655 
mvcc
::
Lock
::
Ãw
(mvcc::
LockTy³
::
Put
, 
b
"k".
to_vec
(), 10, 20, 
NÚe
),

1661 
Ët
 
mut
 
Ïtches
 = 
L©ches
::
Ãw
(1024);

1663 
Ët
 
wr™e_locks
: 
Vec
<
Lock
> = 
wr™e_cmds


1664 .
što_™”
()

1665 .
’um”©e
()

1666 .
m­
(|(
id
, 
cmd
)| {

1667 
Ët
 
mut
 
lock
 = 
g’_commªd_lock
(&
Ïtches
, &
cmd
);

1668 
as£¹_eq
!(
Ïtches
.
acquœe
(&
mut
 
lock
, 
id
 
as
 
u64
), id == 0);

1669 
lock


1671 .
cŞËù
();

1673 
id
, 
cmd
è
š
 
»adÚly_cmds
.
™”
().
’um”©e
() {

1674 
Ët
 
mut
 
lock
 = 
g’_commªd_lock
(&
Ïtches
, 
cmd
);

1675 
as£¹
!(
Ïtches
.
acquœe
(&
mut
 
lock
, 
id
 
as
 
u64
));

1679 
Ët
 
max_id
 = 
wr™e_locks
.
Ën
(è
as
 
u64
 - 1;

1680 
id
, 
mut
 
lock
è
š
 
wr™e_locks
.
što_™”
().
’um”©e
() {

1681 
Ët
 
id
 = id 
as
 
u64
;

1682 
id
 != 0 {

1683 
as£¹
!(
Ïtches
.
acquœe
(&
mut
 
lock
, 
id
));

1685 
Ët
 
uÆocked
 = 
Ïtches
.
»Ëa£
(&
lock
, 
id
);

1686 
id
 
as
 
u64
 =ğ
max_id
 {

1687 
as£¹
!(
uÆocked
.
is_em±y
());

1689 
as£¹_eq
!(
uÆocked
, 
vec
![
id
 + 1]);

	@src/storage/txn/store.rs

14 
u£
 
	g¡Üage
::{
Key
, 
	gKvPaœ
, 
	gSÿnMode
, 
	gSÇpshÙ
, 
	gSti¡ics
, 
	gV®ue
};

15 
u£
 
	g¡Üage
::
mvcc
::{
E¼Ü
 
as
 
MvccE¼Ü
, 
	gMvccR—d”
};

16 
u£
 
	gsu³r
::{
E¼Ü
, 
	gResuÉ
};

17 
u£
 
	gkv´Ùo
::
kv½ıb
::
IsŞ©iÚLev–
;

19 
pub
 
	sSÇpshÙStÜe
 {

20 
	m¢­shÙ
: 
Box
<
SÇpshÙ
>,

21 
	m¡¬t_ts
: 
u64
,

22 
	misŞ©iÚ_Ëv–
: 
IsŞ©iÚLev–
,

23 
	mfl_ÿche
: 
boŞ
,

26 
im¶
 
	gSÇpshÙStÜe
 {

27 
pub
 
â
 
Ãw
(

28 
¢­shÙ
: 
Box
<
SÇpshÙ
>,

29 
¡¬t_ts
: 
u64
,

30 
isŞ©iÚ_Ëv–
: 
IsŞ©iÚLev–
,

31 
fl_ÿche
: 
boŞ
,

32 è-> 
	gSÇpshÙStÜe
 {

33 
	gSÇpshÙStÜe
 {

34 
	g¢­shÙ
: 
¢­shÙ
,

35 
	g¡¬t_ts
: 
¡¬t_ts
,

36 
	gisŞ©iÚ_Ëv–
: 
isŞ©iÚ_Ëv–
,

37 
	gfl_ÿche
: 
fl_ÿche
,

41 
pub
 
â
 
g‘
(&
£lf
, 
key
: &
Key
, 
¡©i¡ics
: &
mut
 
Sti¡ics
è-> 
ResuÉ
<
O±iÚ
<
V®ue
>> {

42 
Ët
 
mut
 
»ad”
 = 
MvccR—d”
::
Ãw
(

43 
£lf
.
¢­shÙ
.
şÚe
(),

44 
NÚe
,

45 
£lf
.
fl_ÿche
,

46 
NÚe
,

47 
£lf
.
isŞ©iÚ_Ëv–
,

49 
Ët
 
	gv
 = 
»ad”
.
g‘
(
key
, 
£lf
.
¡¬t_ts
)?;

50 
	g¡©i¡ics
.
add
(
»ad”
.
g‘_¡©i¡ics
());

51 
Ok
(
v
)

54 
pub
 
â
 
b©ch_g‘
(

55 &
£lf
,

56 
keys
: &[
Key
],

57 
¡©i¡ics
: &
mut
 
Sti¡ics
,

58 è-> 
	gResuÉ
<
	gVec
<ResuÉ<
	gO±iÚ
<
	gV®ue
>>>> {

60 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(

61 
£lf
.
¢­shÙ
.
şÚe
(),

62 
NÚe
,

63 
£lf
.
fl_ÿche
,

64 
NÚe
,

65 
£lf
.
isŞ©iÚ_Ëv–
,

67 
Ët
 
mut
 
	g»suÉs
 = 
Vec
::
w™h_ÿ·c™y
(
keys
.
Ën
());

68 
k
 
š
 
	gkeys
 {

69 
	g»suÉs
.
push
(
»ad”
.
g‘
(
k
, 
£lf
.
¡¬t_ts
).
m­_”r
(
E¼Ü
::
äom
));

71 
	g¡©i¡ics
.
add
(
»ad”
.
g‘_¡©i¡ics
());

72 
Ok
(
»suÉs
)

77 
pub
 
â
 
sÿÂ”
(

78 &
£lf
,

79 
mode
: 
SÿnMode
,

80 
key_Úly
: 
boŞ
,

81 
uµ”_bound
: 
O±iÚ
<
Vec
<
u8
>>,

82 è-> 
	gResuÉ
<
	gStÜeSÿÂ”
> {

83 
Ët
 
mut
 
	g»ad”
 = 
MvccR—d”
::
Ãw
(

84 
£lf
.
¢­shÙ
.
şÚe
(),

85 
Some
(
mode
),

86 
£lf
.
fl_ÿche
,

87 
uµ”_bound
,

88 
£lf
.
isŞ©iÚ_Ëv–
,

90 
	g»ad”
.
£t_key_Úly
(
key_Úly
);

91 
Ok
(
StÜeSÿÂ”
 {

92 
»ad”
:„eader,

93 
¡¬t_ts
: 
£lf
.start_ts,

98 
pub
 
	sStÜeSÿÂ”
 {

99 
	m»ad”
: 
MvccR—d”
,

100 
	m¡¬t_ts
: 
u64
,

103 #[
šlše
]

104 
â
 
hªdË_mvcc_”r
(
e
: 
MvccE¼Ü
, 
»suÉ
: &
mut
 
Vec
<
ResuÉ
<
KvPaœ
>>è-> ResuÉ<
Key
> {

105 
Ët
 
key
 = Ëˆ
MvccE¼Ü
::
KeyIsLocked
 { key: 
»f
 
k
, .. } = 
e
 {

106 
Some
(
Key
::
äom_¿w
(
k
))

108 
NÚe


110 
m©ch
 
	gkey
 {

111 
Some
(
k
) => {

112 
»suÉ
.
push
(
E¼
(
e
.
što
()));

113 
Ok
(
k
)

115 
	gNÚe
 => 
E¼
(
e
.
što
()),

119 
im¶
 
	gStÜeSÿÂ”
 {

120 
pub
 
â
 
£ek
(&
mut
 
£lf
, 
key
: 
Key
è-> 
ResuÉ
<
O±iÚ
<(Key, 
	gV®ue
)>> {

121 
Ok
(
£lf
.
»ad”
.
£ek
(
key
, s–f.
¡¬t_ts
)?)

124 
pub
 
â
 
»v”£_£ek
(&
mut
 
£lf
, 
key
: 
Key
è-> 
ResuÉ
<
O±iÚ
<(Key, 
	gV®ue
)>> {

125 
Ok
(
£lf
.
»ad”
.
»v”£_£ek
(
key
, s–f.
¡¬t_ts
)?)

128 
pub
 
â
 
sÿn
(&
mut
 
£lf
, muˆ
key
: 
Key
, 
lim™
: 
usize
è-> 
ResuÉ
<
Vec
<ResuÉ<
KvPaœ
>>> {

129 
Ët
 
mut
 
»suÉs
 = 
vec
![];

130 
	g»suÉs
.
Ën
(è< 
	glim™
 {

131 
m©ch
 
	g£lf
.
£ek
(
key
) {

132 
Ok
(
Some
((
k
, 
v
))) => {

133 
»suÉs
.
push
(
Ok
((
k
.
¿w
()?, 
v
)));

134 
	gkey
 = 
k
;

136 
Ok
(
NÚe
) => ,

137 
E¼
(
E¼Ü
::
Mvcc
(
e
)è=> 
key
 = 
hªdË_mvcc_”r
Ó, &
mut
 
»suÉs
)?,

138 
E¼
(
e
) =>  Err(e),

140 
	gkey
 = 
key
.
­³nd_ts
(0);

142 
Ok
(
»suÉs
)

145 
pub
 
â
 
»v”£_sÿn
(&
mut
 
£lf
, muˆ
key
: 
Key
, 
lim™
: 
usize
è-> 
ResuÉ
<
Vec
<ResuÉ<
KvPaœ
>>> {

146 
Ët
 
mut
 
»suÉs
 = 
vec
![];

147 
	g»suÉs
.
Ën
(è< 
	glim™
 {

148 
m©ch
 
	g£lf
.
»v”£_£ek
(
key
) {

149 
Ok
(
Some
((
k
, 
v
))) => {

150 
»suÉs
.
push
(
Ok
((
k
.
¿w
()?, 
v
)));

151 
	gkey
 = 
k
;

153 
Ok
(
NÚe
) => ,

154 
E¼
(
E¼Ü
::
Mvcc
(
e
)è=> 
key
 = 
hªdË_mvcc_”r
Ó, &
mut
 
»suÉs
)?,

155 
E¼
(
e
) =>  Err(e),

158 
Ok
(
»suÉs
)

161 
pub
 
â
 
g‘_¡©i¡ics
(&
£lf
è-> &
	gSti¡ics
 {

162 
	g£lf
.
	g»ad”
.
g‘_¡©i¡ics
()

166 #[
cfg
(
‹¡
)]

167 
mod
 
	g‹¡
 {

168 
u£
 
	gkv´Ùo
::
kv½ıb
::{
CÚ‹xt
, 
	gIsŞ©iÚLev–
};

169 
u£
 
	gsu³r
::
SÇpshÙStÜe
;

170 
u£
 
	g¡Üage
::
mvcc
::
MvccTxn
;

171 
u£
 
	g¡Üage
::{
make_key
, 
	gKvPaœ
, 
	gMutiÚ
, 
	gO±iÚs
, 
	gSÿnMode
, 
	gSti¡ics
, 
	gV®ue
, 
	gALL_CFS
};

172 
u£
 
	g¡Üage
::
’gše
::{
£lf
, 
	gEngše
, 
	gSÇpshÙ
, 
	gTEMP_DIR
};

174 cÚ¡ 
	gKEY_PREFIX
: &
¡r
 = "key_prefix";

175 cÚ¡ 
	gSTART_TS
: 
u64
 = 10;

176 cÚ¡ 
	gCOMMIT_TS
: 
u64
 = 20;

177 cÚ¡ 
	gSTART_ID
: 
u64
 = 1000;

179 
	sTe¡StÜe
 {

180 
	gkeys
: 
Vec
<
SŒšg
>,

181 
	g¢­shÙ
: 
Box
<
SÇpshÙ
>,

182 
	gùx
: 
CÚ‹xt
,

183 
	g’gše
: 
Box
<
Engše
>,

186 
im¶
 
	gTe¡StÜe
 {

187 
â
 
Ãw
(
key_num
: 
u64
è-> 
Te¡StÜe
 {

188 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

189 
Ët
 
	gkeys
: 
Vec
<
SŒšg
> = (
START_ID
..START_ID + 
key_num
)

190 .
m­
(|
i
| 
fÜm©
!("{}{}", 
KEY_PREFIX
, i))

191 .
cŞËù
();

192 
Ët
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

193 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(&
ùx
).
unw¿p
();

194 
Ët
 
mut
 
	g¡Üe
 = 
Te¡StÜe
 {

195 
keys
: keys,

196 
¢­shÙ
: snapshot,

197 
ùx
: ctx,

198 
’gše
:ƒngine,

200 
	g¡Üe
.
š™_d©a
();

201 
	g¡Üe


204 #[
šlše
]

205 
â
 
š™_d©a
(&
mut
 
£lf
) {

206 
Ët
 
	g´im¬y_key
 = 
fÜm©
!("{}{}", 
	gKEY_PREFIX
, 
	gSTART_ID
);

207 
Ët
 
	gpk
 = 
´im¬y_key
.
as_by‹s
();

210 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(

211 
£lf
.
¢­shÙ
.
şÚe
(),

212 
START_TS
,

213 
NÚe
,

214 
IsŞ©iÚLev–
::
SI
,

215 
Œue
,

217 
key
 
	gš
 &
	g£lf
.
	gkeys
 {

218 
Ët
 
	gkey
 = 
key
.
as_by‹s
();

219 
	gtxn
.
´ewr™e
(

220 
MutiÚ
::
Put
((
make_key
(
key
), key.
to_vec
())),

221 
pk
,

222 &
O±iÚs
::(),

223 ).
unw¿p
();

225 
	g£lf
.
	g’gše
.
wr™e
(&
£lf
.
ùx
, 
txn
.
što_modif›s
()).
unw¿p
();

227 
	g£lf
.
»äesh_¢­shÙ
();

230 
Ët
 
mut
 
	gtxn
 = 
MvccTxn
::
Ãw
(

231 
£lf
.
¢­shÙ
.
şÚe
(),

232 
START_TS
,

233 
NÚe
,

234 
IsŞ©iÚLev–
::
SI
,

235 
Œue
,

237 
key
 
	gš
 &
	g£lf
.
	gkeys
 {

238 
Ët
 
	gkey
 = 
key
.
as_by‹s
();

239 
	gtxn
.
comm™
(&
make_key
(
key
), 
COMMIT_TS
).
unw¿p
();

241 
	g£lf
.
	g’gše
.
wr™e
(&
£lf
.
ùx
, 
txn
.
što_modif›s
()).
unw¿p
();

243 
	g£lf
.
»äesh_¢­shÙ
();

246 #[
šlše
]

247 
â
 
»äesh_¢­shÙ
(&
mut
 
£lf
) {

248 
	g£lf
.
	g¢­shÙ
 = 
£lf
.
’gše
.
¢­shÙ
(&£lf.
ùx
).
unw¿p
()

251 
â
 
¡Üe
(&
£lf
è-> 
	gSÇpshÙStÜe
 {

252 
	gSÇpshÙStÜe
::
Ãw
(

253 
£lf
.
¢­shÙ
.
şÚe
(),

254 
COMMIT_TS
 + 1,

255 
IsŞ©iÚLev–
::
SI
,

256 
Œue
,

262 #[
‹¡
]

263 
â
 
‹¡_¢­shÙ_¡Üe_g‘
() {

264 
Ët
 
	gkey_num
 = 100;

265 
Ët
 
	g¡Üe
 = 
Te¡StÜe
::
Ãw
(
key_num
);

266 
Ët
 
	g¢­shÙ_¡Üe
 = 
¡Üe
.store();

267 
Ët
 
mut
 
	g¡©i¡ics
 = 
Sti¡ics
::();

268 
key
 
	gš
 &
	g¡Üe
.
	gkeys
 {

269 
Ët
 
	gkey
 = 
key
.
as_by‹s
();

270 
Ët
 
	gd©a
 = 
¢­shÙ_¡Üe
.
g‘
(&
make_key
(
key
), &
mut
 
¡©i¡ics
).
unw¿p
();

271 
	gas£¹
!(
	gd©a
.
is_some
(), "{:?}ƒx³ù some, buˆgÙ‚Úe", 
	gkey
);

275 #[
‹¡
]

276 
â
 
‹¡_¢­shÙ_¡Üe_b©ch_g‘
() {

277 
Ët
 
	gkey_num
 = 100;

278 
Ët
 
	g¡Üe
 = 
Te¡StÜe
::
Ãw
(
key_num
);

279 
Ët
 
	g¢­shÙ_¡Üe
 = 
¡Üe
.store();

280 
Ët
 
mut
 
	g¡©i¡ics
 = 
Sti¡ics
::();

281 
Ët
 
mut
 
	gkeys_li¡
 = 
Vec
::
Ãw
();

282 
key
 
	gš
 &
	g¡Üe
.
	gkeys
 {

283 
	gkeys_li¡
.
push
(
make_key
(
key
.
as_by‹s
()));

285 
Ët
 
	gd©a
 = 
¢­shÙ_¡Üe
.
b©ch_g‘
(&
keys_li¡
, &
mut
 
¡©i¡ics
);

286 
	gas£¹
!(
	gd©a
.
is_ok
(), "ex³ù ok,whgÙ {:?}", d©a.
unw¿p_”r
());

287 
™em
 
š
 
	gd©a
.
unw¿p
() {

288 
Ët
 
	g™em
 = 
™em
.
unw¿p
();

289 
	gas£¹
!(
	g™em
.
is_some
(), "itemƒxpect some while get‚one");

293 #[
‹¡
]

294 
â
 
‹¡_¢­shÙ_¡Üe_sÿn
() {

295 
Ët
 
	gkey_num
 = 100;

296 
Ët
 
	g¡Üe
 = 
Te¡StÜe
::
Ãw
(
key_num
);

297 
Ët
 
	g¢­shÙ_¡Üe
 = 
¡Üe
.store();

298 
Ët
 
mut
 
	gsÿÂ”
 = 
¢­shÙ_¡Üe


299 .
sÿÂ”
(
SÿnMode
::
FÜw¬d
, 
çl£
, 
NÚe
)

300 .
unw¿p
();

302 
Ët
 
	gkey
 = 
fÜm©
!("{}{}", 
	gKEY_PREFIX
, 
	gSTART_ID
);

303 
Ët
 
	g¡¬t_key
 = 
make_key
(
key
.
as_by‹s
());

304 
Ët
 
	gh®f
 = (
key_num
 / 2è
as
 
usize
;

305 
Ët
 
	gex³ù
 = &
¡Üe
.
keys
[0..
h®f
];

306 
Ët
 
	g»suÉ
 = 
sÿÂ”
.
sÿn
(
¡¬t_key
, 
h®f
).
unw¿p
();

307 
Ët
 
	g»suÉ
: 
Vec
<
O±iÚ
<
KvPaœ
>> = 
»suÉ
.
što_™”
().
m­
(
ResuÉ
::
ok
).
cŞËù
();

308 
Ët
 
	gex³ù
: 
Vec
<
O±iÚ
<
KvPaœ
>> = 
ex³ù


309 .
što_™”
()

310 .
m­
(|
k
| 
Some
((k.
şÚe
().
što_by‹s
(), k.clone().into_bytes())))

311 .
cŞËù
();

312 
	gas£¹_eq
!(
	g»suÉ
, 
	gex³ù
, "expect {:?}, but got {:?}",ƒxpect,„esult);

316 #[
‹¡
]

317 
â
 
‹¡_¢­shÙ_¡Üe_»v”£_sÿn
() {

318 
Ët
 
	gkey_num
 = 100;

319 
Ët
 
	g¡Üe
 = 
Te¡StÜe
::
Ãw
(
key_num
);

320 
Ët
 
	g¢­shÙ_¡Üe
 = 
¡Üe
.store();

321 
Ët
 
mut
 
	gsÿÂ”
 = 
¢­shÙ_¡Üe


322 .
sÿÂ”
(
SÿnMode
::
Backw¬d
, 
çl£
, 
NÚe
)

323 .
unw¿p
();

325 
Ët
 
	gh®f
 = (
key_num
 / 2è
as
 
usize
;

326 
Ët
 
	gkey
 = 
fÜm©
!("{}{}", 
	gKEY_PREFIX
, 
	gSTART_ID
 + (
h®f
 
as
 
	gu64
) - 1);

327 
Ët
 
	g¡¬t_key
 = 
make_key
(
key
.
as_by‹s
());

328 
Ët
 
	gex³ù
 = &
¡Üe
.
keys
[0..
h®f
 - 1];

329 
Ët
 
	g»suÉ
 = 
sÿÂ”
.
»v”£_sÿn
(
¡¬t_key
, 
h®f
).
unw¿p
();

330 
Ët
 
	g»suÉ
: 
Vec
<
O±iÚ
<
KvPaœ
>> = 
»suÉ
.
što_™”
().
m­
(
ResuÉ
::
ok
).
cŞËù
();

332 
Ët
 
mut
 
	gex³ù
: 
Vec
<
O±iÚ
<
KvPaœ
>> = 
ex³ù


333 .
što_™”
()

334 .
m­
(|
k
| 
Some
((k.
şÚe
().
što_by‹s
(), k.clone().into_bytes())))

335 .
cŞËù
();

336 
	gex³ù
.
»v”£
();

338 
	gas£¹_eq
!(
	g»suÉ
, 
	gex³ù
, "expect {:?}, but got {:?}",ƒxpect,„esult);

341 #[
‹¡
]

342 
â
 
‹¡_¢­shÙ_¡Üe_£ek
() {

343 
Ët
 
	gkey_num
 = 100;

344 
Ët
 
	g¡Üe
 = 
Te¡StÜe
::
Ãw
(
key_num
);

345 
Ët
 
	g¢­shÙ_¡Üe
 = 
¡Üe
.store();

346 
Ët
 
mut
 
	gsÿÂ”
 = 
¢­shÙ_¡Üe


347 .
sÿÂ”
(
SÿnMode
::
FÜw¬d
, 
çl£
, 
NÚe
)

348 .
unw¿p
();

350 
Ët
 
	gkey
 = 
fÜm©
!("{}{}¯a", 
	gKEY_PREFIX
, 
	gSTART_ID
);

351 
Ët
 
	g¡¬t_key
 = 
make_key
(
key
.
as_by‹s
());

352 
Ët
 
	g»suÉ
 = 
sÿÂ”
.
£ek
(
¡¬t_key
).
unw¿p
();

353 
Ët
 
	gex³ù_key
 = 
fÜm©
!("{}{}", 
	gKEY_PREFIX
, 
	gSTART_ID
 + 1);

354 
Ët
 
	gex³ù_v®ue
 = 
ex³ù_key
.
şÚe
().
što_by‹s
();

355 
Ët
 
	gex³ù
 = 
Some
((
make_key
(
ex³ù_key
.
as_by‹s
()), 
ex³ù_v®ue
 
as
 
V®ue
));

356 
	gas£¹_eq
!(
	g»suÉ
, 
	gex³ù
, "expect {:?}, but got {:?}",ƒxpect,„esult);

359 #[
‹¡
]

360 
â
 
‹¡_¢­shÙ_¡Üe_»v”£_£ek
() {

361 
Ët
 
	gkey_num
 = 100;

362 
Ët
 
	g¡Üe
 = 
Te¡StÜe
::
Ãw
(
key_num
);

363 
Ët
 
	g¢­shÙ_¡Üe
 = 
¡Üe
.store();

365 
Ët
 
mut
 
	gsÿÂ”
 = 
¢­shÙ_¡Üe


366 .
sÿÂ”
(
SÿnMode
::
Backw¬d
, 
çl£
, 
NÚe
)

367 .
unw¿p
();

369 
Ët
 
	gkey
 = 
fÜm©
!("{}{}¯a", 
	gKEY_PREFIX
, 
	gSTART_ID
);

370 
Ët
 
	g¡¬t_key
 = 
make_key
(
key
.
as_by‹s
());

371 
Ët
 
	g»suÉ
 = 
sÿÂ”
.
»v”£_£ek
(
¡¬t_key
).
unw¿p
();

372 
Ët
 
	gex³ù_key
 = 
fÜm©
!("{}{}", 
	gKEY_PREFIX
, 
	gSTART_ID
);

373 
Ët
 
	gex³ù_v®ue
 = 
ex³ù_key
.
şÚe
().
što_by‹s
();

374 
Ët
 
	gex³ù
 = 
Some
((
make_key
(
ex³ù_key
.
as_by‹s
()), 
ex³ù_v®ue
 
as
 
V®ue
));

375 
	gas£¹_eq
!(
	g»suÉ
, 
	gex³ù
, "expect {:?}, but got {:?}",ƒxpect,„esult);

	@src/storage/types.rs

16 
u£
 
	g¡d
::
hash
::{
Hash
, 
	gHash”
};

17 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

18 
u£
 
	g¡d
::
u64
;

20 
u£
 
	gut
::{
codec
, 
	gesÿ³
};

21 
u£
 
	gut
::
codec
::
numb”
::{
£lf
, 
	gNumb”Decod”
, 
	gNumb”Encod”
};

22 
u£
 
	gut
::
codec
::
by‹s
::
By‹sDecod”
;

24 
u£
 
	g¡Üage
::
mvcc
::{
Lock
, 
	gWr™e
};

27 
pub
 
ty³
 
	gV®ue
 = 
Vec
<
u8
>;

33 
pub
 
ty³
 
	gKvPaœ
 = (
Vec
<
u8
>, 
	gV®ue
);

37 #[
d”ive
(
Debug
, 
DeçuÉ
)]

38 
pub
 
	sMvccInfo
 {

39 
pub
 
	mlock
: 
O±iÚ
<
Lock
>,

41 
pub
 
	mwr™es
: 
Vec
<(
u64
, 
	mWr™e
)>,

43 
pub
 
	mv®ues
: 
Vec
<(
u64
, 
	mboŞ
, 
	mV®ue
)>,

47 
pub
 
â
 
Œunÿ‹_ts
(
key
: &[
u8
]) -> &[u8] {

48 &
key
[..key.
Ën
(è- 
numb”
::
U64_SIZE
]

61 #[
d”ive
(
Debug
, 
ClÚe
)]

62 
pub
 
Key
(
Vec
<
u8
>);

65 
im¶
 
	gKey
 {

67 
pub
 
â
 
äom_¿w
(
key
: &[
u8
]è-> 
Key
 {

68 
Key
(
codec
::
by‹s
::
’code_by‹s
(
key
))

72 
pub
 
â
 
¿w
(&
£lf
è-> 
ResuÉ
<
Vec
<
u8
>, 
	gcodec
::
E¼Ü
> {

73 
£lf
.0.a
s_¦iû
().
decode_by‹s
(
çl£
)

77 
pub
 
â
 
äom_’coded
(
’coded_key
: 
Vec
<
u8
>è-> 
Key
 {

78 
Key
(
’coded_key
)

82 
pub
 
â
 
’coded
(&
£lf
è-> &
Vec
<
u8
> {

83 &
£lf
.0

87 
pub
 
â
 
­³nd_ts
(&
£lf
, 
ts
: 
u64
è-> 
Key
 {

88 
Ët
 
mut
 
’coded
 = 
£lf
.0.ş
Úe
();

89 
	g’coded
.
’code_u64_desc
(
ts
).
unw¿p
();

90 
Key
(
’coded
)

97 
pub
 
â
 
decode_ts
(&
£lf
è-> 
	gResuÉ
<
	gu64
, 
	gcodec
::
E¼Ü
> {

98 
Ët
 
Ën
 = 
£lf
.0.Ë
n
();

99 
	gËn
 < 
	gnumb”
::
U64_SIZE
 {

109 
E¼
(
codec
::
E¼Ü
::
KeyL’gth
)

111 
Ët
 
mut
 
ts
 = &
£lf
.0[
Ën
 - 
numb”
::
U64_SIZE
..];

112 
Ok
(
ts
.
decode_u64_desc
()?)

119 
pub
 
â
 
Œunÿ‹_ts
(&
£lf
è-> 
	gResuÉ
<
	gKey
, 
	gcodec
::
E¼Ü
> {

120 
Ët
 
Ën
 = 
£lf
.0.Ë
n
();

121 
	gËn
 < 
	gnumb”
::
U64_SIZE
 {

123  
E¼
(
codec
::
E¼Ü
::
KeyL’gth
);

125 
Ok
(
Key
::
äom_’coded
(
Œunÿ‹_ts
(&
£lf
.0).
to_vec
()))

130 
im¶
 
Hash
 
Key
 {

131 
â
 
hash
<
H
: 
Hash”
>(&
£lf
, 
	g¡©e
: &
mut
 H) {

132 
£lf
.
’coded
().
hash
(
¡©e
)

137 
im¶
 
Di¥Ïy
 
Key
 {

138 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

139 
wr™e
!(
f
, "{}", 
esÿ³
(&
£lf
.0))

144 
im¶
 
P¬tŸlEq
 
	gKey
 {

145 
â
 
eq
(&
£lf
, 
Ùh”
: &
Key
è-> 
boŞ
 {

146 
£lf
.0 =ğ
Ùh”
.0

151 
pub
 
â
 
make_key
(
k
: &[
u8
]è-> 
Key
 {

152 
Key
::
äom_¿w
(
k
)

157 
pub
 
â
 
¥l™_’coded_key_Ú_ts
(
key
: &[
u8
]è-> 
ResuÉ
<(&[u8], 
	gu64
), 
	gcodec
::
E¼Ü
> {

158 
key
.
Ën
(è< 
numb”
::
U64_SIZE
 {

159 
E¼
(
codec
::
E¼Ü
::
KeyL’gth
)

161 
Ët
 
pos
 = 
key
.
Ën
(è- 
numb”
::
U64_SIZE
;

162 
Ët
 
	gk
 = &
key
[..
pos
];

163 
Ët
 
mut
 
	gts
 = &
key
[
pos
..];

164 
Ok
((
k
, 
ts
.
decode_u64_desc
()?))

168 #[
cfg
(
‹¡
)]

169 
mod
 
	g‹¡s
 {

170 
u£
 
	gsu³r
::*;

172 #[
‹¡
]

173 
â
 
‹¡_¥l™_ts
() {

174 
Ët
 
	gk
 = 
b
"k";

175 
Ët
 
	gts
 = 123;

176 
	gas£¹
!(
¥l™_’coded_key_Ú_ts
(
k
).
is_”r
());

177 
Ët
 
	g’c
 = 
Key
::
äom_’coded
(
k
.
to_vec
()).
­³nd_ts
(
ts
);

178 
Ët
 
	g»s
 = 
¥l™_’coded_key_Ú_ts
(
’c
.
’coded
()).
unw¿p
();

179 
	gas£¹_eq
!(
	g»s
, (
	gk
.
as_»f
(), 
	gts
));

	@src/util/buf.rs

14 
u£
 
	g¡d
::
io
::{
BufR—d
, 
	gE¼ÜKšd
, 
	gR—d
, 
	gResuÉ
, 
	gWr™e
};

15 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDebug
, 
	gFÜm©‹r
};

16 
u£
 
	g®loc
::
¿w_vec
::
RawVec
;

17 
u£
 
	g¡d
::{
cmp
, 
	gmem
, 
	g±r
, 
	g¦iû
};

19 
u£
 
	gut
::
esÿ³
;

22 
pub
 
	sPeBufãr
 {

24 
	m¡¬t
: 
usize
,

26 
	m’d
: 
usize
,

27 
	mbuf
: 
RawVec
<
u8
>,

30 
im¶
 
	gPeBufãr
 {

31 
pub
 
â
 
Ãw
(
ÿ·c™y
: 
usize
è-> 
PeBufãr
 {

32 
PeBufãr
 {

33 
¡¬t
: 0,

34 
	g’d
: 0,

36 
	gbuf
: 
RawVec
::
w™h_ÿ·c™y
(
ÿ·c™y
 + 1),

40 #[
šlše
]

41 
pub
 
â
 
Ën
(&
£lf
è-> 
	gusize
 {

42 
	g£lf
.
	g’d
 >ğ
£lf
.
¡¬t
 {

43 
£lf
.
’d
 - s–f.
¡¬t


45 
£lf
.
buf
.
ÿp
(è- s–f.
¡¬t
 + s–f.
’d


49 #[
šlše
]

50 
un§ã
 
â
 
buf_as_¦iû
(&
£lf
è-> &[
u8
] {

51 
	g¦iû
::
äom_¿w_·¹s
(
£lf
.
buf
.
±r
(), s–f.buf.
ÿp
())

54 #[
šlše
]

55 
un§ã
 
â
 
buf_as_¦iû_mut
(&
mut
 
£lf
è-> &
	gmut
 [
u8
] {

56 
	g¦iû
::
äom_¿w_·¹s_mut
(
£lf
.
buf
.
±r
(), s–f.buf.
ÿp
())

59 #[
šlše
]

60 
pub
 
â
 
ÿ·c™y
(&
£lf
è-> 
	gusize
 {

61 
	g£lf
.
	gbuf
.
ÿp
() - 1

64 #[
šlše
]

65 
pub
 
â
 
is_fuÎ
(&
£lf
è-> 
	gboŞ
 {

66 
	g£lf
.
Ën
(è=ğ
£lf
.
ÿ·c™y
()

69 #[
šlše
]

70 #[
®low
(
Ën_z”o
)]

71 
pub
 
â
 
is_em±y
(&
£lf
è-> 
	gboŞ
 {

72 
	g£lf
.
Ën
() == 0

76 
â
 
¦iû
(&
£lf
è-> (&[
u8
], &[u8]) {

77 
	gun§ã
 {

78 
Ët
 
	gbuf
 = 
£lf
.
buf_as_¦iû
();

79 
	g£lf
.
	g’d
 >ğ
£lf
.
¡¬t
 {

80 (&
buf
[
£lf
.
¡¬t
..£lf.
’d
], &[])

82 (&
buf
[
£lf
.
¡¬t
..], &buf[..£lf.
’d
])

88 
â
 
¦iû_­³nd
(&
mut
 
£lf
è-> (&
	gmut
 [
u8
], &mut [u8]) {

89 
	g£lf
.
is_fuÎ
() {

90  (&
	gmut
 [], &mut []);

92 
	gun§ã
 {

93 
Ët
 
	g¡¬t
 = 
£lf
.
¡¬t
;

94 
Ët
 
	g’d
 = 
£lf
.
’d
;

95 
Ët
 
	gÿp
 = 
£lf
.
ÿ·c™y
();

96 
Ët
 
	gbuf
 = 
£lf
.
buf_as_¦iû_mut
();

98 
	g¡¬t
 == 0 {

99 (&
mut
 
buf
[
’d
..
ÿp
], &mut [])

100 } 
¡¬t
 <ğ
’d
 {

101 
Ët
 (
right
, 
Ëá
èğ
buf
.
¥l™_©_mut
(
’d
);

102 
Ët
 (
right
, 
_
èğright.
¥l™_©_mut
(
¡¬t
 - 1);

103 (
	gËá
, 
	gright
)

105 (&
mut
 
	gbuf
[
’d
..
¡¬t
 - 1], &
	gmut
 [])

114 
pub
 
â
 
’su»
(&
mut
 
£lf
, 
ÿ·c™y
: 
usize
) {

115 
ÿ·c™y
 <ğ
£lf
.capacity() {

119 
Ët
 
	gÿp
 = 
£lf
.
buf
.
ÿp
();

120 
	g£lf
.
	gbuf
.
»£rve
(
ÿp
, 
ÿ·c™y
 + 1 - cap);

121 
Ët
 
	gÃw_ÿp
 = 
£lf
.
buf
.
ÿp
();

124 
	gun§ã
 {

125 
	g£lf
.
	g¡¬t
 <ğ
£lf
.
’d
 {

128 } 
	gÃw_ÿp
 - 
	gÿp
 > 
	g£lf
.
	g’d
 && s–f.’d <ğ
ÿp
 - 
£lf
.
¡¬t
 {

131 
Ët
 
Ëá
 = 
£lf
.
buf
.
±r
();

132 
Ët
 
	gÃw_pos
 = 
£lf
.
buf
.
±r
().
off£t
(
ÿp
 
as
 
isize
);

133 
	g±r
::
cİy_nÚov”Ïµšg
(
Ëá
, 
Ãw_pos
, 
£lf
.
’d
);

134 
	g£lf
.
	g’d
 +ğ
ÿp
;

137 
Ët
 
	gright
 = 
£lf
.
buf
.
±r
().
off£t
(£lf.
¡¬t
 
as
 
isize
);

138 
	g£lf
.
	g¡¬t
 = 
Ãw_ÿp
 - (
ÿp
 - 
£lf
.
¡¬t
);

139 
Ët
 
	gÃw_pos
 = 
£lf
.
buf
.
±r
().
off£t
(£lf.
¡¬t
 
as
 
isize
);

140 
	g£lf
.
	g¡¬t
 >ğ
ÿp
 {

141 
±r
::
cİy_nÚov”Ïµšg
(
right
, 
Ãw_pos
, 
Ãw_ÿp
 - 
£lf
.
¡¬t
);

143 
	g±r
::
cİy
(
right
, 
Ãw_pos
, 
Ãw_ÿp
 - 
£lf
.
¡¬t
);

150 
pub
 
â
 
shršk_to
(&
mut
 
£lf
, 
Ën
: 
usize
) {

151 
as£¹
!(
Ën
 < 
£lf
.
ÿ·c™y
());

153 
Ët
 
	gÃw_ÿp
 = 
Ën
 + 1;

156 
Ët
 
	gto_k“p
 = 
cmp
::
mš
(
Ën
, 
£lf
.len());

157 
	gun§ã
 {

158 
	g£lf
.
	g¡¬t
 <ğ
£lf
.
’d
 {

159 
Ët
 
de¡
 = 
£lf
.
buf
.
±r
();

160 
	g£lf
.
	g¡¬t
 >ğ
Ën
 {

162 
Ët
 
sourû
 = 
£lf
.
buf
.
±r
().
off£t
(£lf.
¡¬t
 
as
 
isize
);

163 
	g£lf
.
	g¡¬t
 = 0;

164 
	g£lf
.
	g’d
 = 
to_k“p
;

165 
	g±r
::
cİy_nÚov”Ïµšg
(
sourû
, 
de¡
, 
to_k“p
);

168 
Ët
 
	gright_Ën
 = 
Ãw_ÿp
 - 
£lf
.
¡¬t
;

169 
	gright_Ën
 >ğ
to_k“p
 {

171 
£lf
.
’d
 = s–f.
¡¬t
 + 
to_k“p
;

172 
	g£lf
.
	g’d
 =ğ
Ãw_ÿp
 {

173 
£lf
.
’d
 = 0;

177 
	g£lf
.
	g’d
 = 
to_k“p
 - 
right_Ën
;

178 
Ët
 
	gsourû
 = 
£lf
.
buf
.
±r
().
off£t
(
Ãw_ÿp
 
as
 
isize
);

179 
	g±r
::
cİy_nÚov”Ïµšg
(
sourû
, 
de¡
, 
£lf
.
’d
);

183 
Ët
 
	gsourû
 = 
£lf
.
buf
.
±r
().
off£t
(£lf.
¡¬t
 
as
 
isize
);

184 
Ët
 
	gright_Ën
 = 
£lf
.
buf
.
ÿp
(è- s–f.
¡¬t
;

185 
	gright_Ën
 >ğ
to_k“p
 {

187 
£lf
.
¡¬t
 = 0;

188 
	g£lf
.
	g’d
 = 
to_k“p
;

189 
	g±r
::
cİy
(
sourû
, 
£lf
.
buf
.
±r
(), 
to_k“p
);

192 
	g£lf
.
	g¡¬t
 = 
Ãw_ÿp
 - 
right_Ën
;

193 
	g£lf
.
	g’d
 >ğ
£lf
.
¡¬t
 {

194 
£lf
.
’d
 = s–f.
¡¬t
 - 1;

196 
	g±r
::
cİy
(

197 
sourû
,

198 
£lf
.
buf
.
±r
().
off£t
(£lf.
¡¬t
 
as
 
isize
),

199 
right_Ën
,

204 
	g£lf
.
	gbuf
.
shršk_to_f™
(
Ãw_ÿp
);

211 
pub
 
â
 
	g»ad_äom
<
	gR
: 
R—d
>(&
mut
 
£lf
, 
	gr
: &muˆ
R
è-> 
ResuÉ
<
usize
> {

212 
Ët
 
mut
 
’d
 = 
£lf
.end;

213 
Ët
 
mut
 
	g»aded
;

215 
Ët
 (
Ëá
, 
right
èğ
£lf
.
¦iû_­³nd
();

216 
m©ch
 
	gr
.
»ad
(
Ëá
) {

217 
Ok
(
l
è=> 
»aded
 =†,

218 
E¼
(
e
) => {

219  
e
.
kšd
(è=ğ
E¼ÜKšd
::
WouldBlock
 {

220 
Ok
(0)

222 
E¼
(
e
)

226 
	g’d
 +ğ
»aded
;

227 
	g»aded
 =ğ
Ëá
.
Ën
(è&& !
right
.
is_em±y
() {

229 
Ët
 
Ok
(
l
èğ
r
.
»ad
(
right
) {

230 
’d
 = 
l
;

231 
	g»aded
 +ğ
l
;

235 
	g’d
 =ğ
£lf
.
buf
.
ÿp
() {

236 
£lf
.
’d
 = 0;

238 
	g£lf
.
	g’d
 = 
’d
;

240 
Ok
(
»aded
)

244 
pub
 
â
 
	gwr™e_to
<
	gW
: 
Wr™e
>(&
mut
 
£lf
, 
	gw
: &muˆ
W
è-> 
ResuÉ
<
usize
> {

245 
Ët
 
mut
 
¡¬t
 = 
£lf
.start;

246 
Ët
 
mut
 
	gwr™‹n
;

248 
Ët
 (
Ëá
, 
right
èğ
£lf
.
¦iû
();

249 
m©ch
 
	gw
.
wr™e
(
Ëá
) {

250 
Ok
(
l
è=> 
wr™‹n
 =†,

251 
E¼
(
e
) => {

252  
e
.
kšd
(è=ğ
E¼ÜKšd
::
WouldBlock
 {

253 
Ok
(0)

255 
E¼
(
e
)

259 
	g¡¬t
 +ğ
wr™‹n
;

260 
	gwr™‹n
 =ğ
Ëá
.
Ën
(è&& !
right
.
is_em±y
() {

262 
Ët
 
Ok
(
l
èğ
w
.
wr™e
(
right
) {

263 
¡¬t
 = 
l
;

264 
	gwr™‹n
 +ğ
l
;

268 
	g¡¬t
 =ğ
£lf
.
buf
.
ÿp
() {

269 
£lf
.
¡¬t
 = 0;

271 
	g£lf
.
	g¡¬t
 = 
¡¬t
;

273 
Ok
(
wr™‹n
)

276 
pub
 
â
 
	gwr™e_®l_to
<
	gW
: 
Wr™e
>(&
mut
 
£lf
, 
	gw
: &muˆ
W
è-> 
ResuÉ
<()> {

278 
Ët
 (
Ëá
, 
right
èğ
£lf
.
¦iû
();

279 
	gw
.
wr™e_®l
(
Ëá
)?;

280 
	gw
.
wr™e_®l
(
right
)?;

282 
	g£lf
.
	g’d
 = 
£lf
.
¡¬t
;

283 
Ok
(())

287 
im¶
 
R—d
 
	gPeBufãr
 {

288 
â
 
»ad
(&
mut
 
£lf
, muˆ
buf
: &muˆ[
u8
]è-> 
ResuÉ
<
usize
> {

289 
£lf
.
wr™e_to
(&
mut
 
buf
)

293 
im¶
 
BufR—d
 
PeBufãr
 {

294 
â
 
fl_buf
(&
mut
 
£lf
è-> 
ResuÉ
<&[
u8
]> {

295 
Ët
 (
Ëá
, 
_
èğ
£lf
.
¦iû
();

296 
Ok
(
Ëá
)

299 
â
 
cÚsume
(&
mut
 
£lf
, 
amt
: 
usize
) {

300 
as£¹
!(
amt
 <ğ
£lf
.
Ën
());

301 
	g£lf
.
	g¡¬t
 <ğ
£lf
.
’d
 {

302 
£lf
.
¡¬t
 +ğ
amt
;

304 
Ët
 
	gright_Ën
 = 
£lf
.
buf
.
ÿp
(è- s–f.
¡¬t
;

305 
	gright_Ën
 > 
	gamt
 {

306 
	g£lf
.
	g¡¬t
 +ğ
amt
;

308 
	g£lf
.
	g¡¬t
 = 
amt
 - 
right_Ën
;

314 
im¶
 
Wr™e
 
	gPeBufãr
 {

315 
â
 
wr™e
(&
mut
 
£lf
, muˆ
buf
: &[
u8
]è-> 
ResuÉ
<
usize
> {

316 
Ët
 
mš_ÿp
 = 
£lf
.
Ën
(è+ 
buf
.len();

317 
	g£lf
.
’su»
(
mš_ÿp
);

318 
	g£lf
.
»ad_äom
(&
mut
 
buf
)

321 
â
 
æush
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

322 
Ok
(())

326 
im¶
 
P¬tŸlEq
 
	gPeBufãr
 {

327 
â
 
eq
(&
£lf
, 
right
: &
PeBufãr
è-> 
boŞ
 {

328 
£lf
.
Ën
(è!ğ
right
.len() {

329  
çl£
;

332 
Ët
 (
mut
 
l1
, muˆ
r1
èğ
£lf
.
¦iû
();

333 
Ët
 (
mut
 
l2
, muˆ
r2
èğ
right
.
¦iû
();

334 
	gl1
.
Ën
(è> 
	gl2
.len() {

335 
	gmem
::
sw­
(&
mut
 
l1
, &muˆ
l2
);

336 
	gmem
::
sw­
(&
mut
 
r1
, &muˆ
r2
);

338 
	gl1
 =ğ&
l2
[..
l1
.
Ën
()] && 
r1
[..l2.len() -†1.len()] ==†2[l1.len()..] &&

339 &
r1
[
l2
.
Ën
(è- 
l1
.Ën()..] =ğ
r2


343 
	gim¶
<'a> P¬tŸlEq<&'
	ga
 [
u8
]> 
	gPeBufãr
 {

344 
â
 
eq
(&
£lf
, 
right
: &&'a [u8]) -> bool {

345 
£lf
.
Ën
(è!ğ
right
.len() {

346  
çl£
;

349 
Ët
 (
l
, 
r
èğ
£lf
.
¦iû
();

350 
l
 =ğ&
right
[..l.
Ën
()] && 
r
 == &right[l.len()..]

354 
im¶
 
Debug
 
PeBufãr
 {

355 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

356 
wr™e
!(

357 
f
,

359 
£lf
.
¡¬t
,

360 
£lf
.
’d
,

361 
esÿ³
(
un§ã
 { 
£lf
.
buf_as_¦iû
() })

366 #[
cfg
(
‹¡
)]

367 
mod
 
‹¡s
 {

368 
u£
 
¡d
::
io
::*;

370 
u£
 
¿nd
::{
£lf
, 
Rng
};

372 
u£
 
su³r
::*;

374 
â
 
Ãw_§m¶e
(
couÁ
: 
usize
è-> 
Vec
<
u8
> {

375 
Ët
 
mut
 
ºg
 = 
¿nd
::
th»ad_ºg
();

376 
as£¹
!(
couÁ
 <= 256);

377 
Ët
 
mut
 
§m¶es
 = 
¿nd
::
§m¶e
(&muˆ
ºg
, 0..255, 
couÁ
);

378 
ºg
.
shufæe
(&
mut
 
§m¶es
);

379 
§m¶es


382 
â
 
Ãw_pe_bufãr
(
ÿp
: 
usize
è-> 
PeBufãr
 {

383 
Ët
 
s
 = 
PeBufãr
::
Ãw
(
ÿp
);

384 
Ët
 
§m¶es
 = 
Ãw_§m¶e
(
ÿp
);

385 
un§ã
 { 
±r
::
cİy_nÚov”Ïµšg
(
§m¶es
.
as_±r
(), 
s
.
buf
.±r(), 
ÿp
) };

386 
s


389 #[
‹¡
]

390 
â
 
‹¡_»ad_äom
() {

391 
Ët
 
mut
 
s
 = 
Ãw_pe_bufãr
(25);

393 
Ët
 
ÿp
 = 
s
.
ÿ·c™y
();

394 
Ët
 
·ddšg
 = 
Ãw_§m¶e
(
ÿp
);

395 
Ën
 
š
 0..ÿ
p
 + 1 {

396 
Ët
 
ex³ùed
 = 
Ãw_§m¶e
(
Ën
);

398 
pos
 
š
 0..ÿ
p
 + 1 {

399 
l
 
š
 0..Ë
n
 + 1 {

400 
s
.
¡¬t
 = 
pos
;

401 
s
.
’d
 = 
pos
;

403 
Ët
 
mut
 
šput
 = &
ex³ùed
[0..l];

404 
as£¹_eq
!(
l
, 
s
.
»ad_äom
(&
mut
 
šput
).
unw¿p
());

405 
as£¹_eq
!(
s
, &
ex³ùed
[0..l]);

406 
šput
 = &
ex³ùed
[
l
..];

407 
as£¹_eq
!(
Ën
 - 
l
, 
s
.
»ad_äom
(&
mut
 
šput
).
unw¿p
());

408 
as£¹_Ã
!(
s
.
¡¬t
, s.
buf
.
ÿp
());

409 
as£¹_Ã
!(
s
.
’d
, s.
buf
.
ÿp
());

410 
as£¹_eq
!(
s
, 
ex³ùed
.
as_¦iû
());

412 
šput
 = 
·ddšg
.
as_¦iû
();

413 
as£¹_eq
!(
ÿp
 - 
Ën
, 
s
.
»ad_äom
(&
mut
 
šput
).
unw¿p
());

414 
as£¹_Ã
!(
s
.
¡¬t
, s.
buf
.
ÿp
());

415 
as£¹_Ã
!(
s
.
’d
, s.
buf
.
ÿp
());

416 
Ët
 
mut
 
exp
 = 
ex³ùed
.
şÚe
();

417 
exp
.
ex‹nd_äom_¦iû
(&
·ddšg
[..
ÿp
 - 
Ën
]);

418 
as£¹_eq
!(
s
, 
exp
.
as_¦iû
());

424 #[
‹¡
]

425 
â
 
‹¡_wr™e_to
() {

426 
Ët
 
mut
 
s
 = 
Ãw_pe_bufãr
(25);

428 
Ët
 
ÿp
 = 
s
.
ÿ·c™y
();

429 
Ën
 
š
 0..ÿ
p
 + 1 {

430 
Ët
 
ex³ùed
 = 
Ãw_§m¶e
(
Ën
);

432 
pos
 
š
 0..ÿ
p
 + 1 {

433 
l
 
š
 0..Ë
n
 + 1 {

434 
s
.
¡¬t
 = 
pos
;

435 
s
.
’d
 = 
pos
;

437 
Ët
 
mut
 
šput
 = 
ex³ùed
.
as_¦iû
();

438 
as£¹_eq
!(
Ën
, 
s
.
»ad_äom
(&
mut
 
šput
).
unw¿p
());

440 
Ët
 
mut
 
w
 = 
vec
![0; 
l
];

442 
Ët
 
mut
 
buf
 = 
w
.
as_mut_¦iû
();

443 
as£¹_eq
!(
l
, 
s
.
wr™e_to
(&
mut
 
buf
).
unw¿p
());

444 
as£¹_Ã
!(
s
.
¡¬t
, s.
buf
.
ÿp
());

445 
as£¹_Ã
!(
s
.
’d
, s.
buf
.
ÿp
());

447 
as£¹_eq
!(
w
, &
ex³ùed
[..
l
]);

448 
as£¹_eq
!(
s
, &
ex³ùed
[
l
..]);

450 
Ët
 
mut
 
w
 = 
Ãw_§m¶e
(
ÿp
);

451 
as£¹_eq
!(
Ën
 - 
l
, 
s
.
»ad
(&
mut
 
w
).
unw¿p
());

452 
as£¹_Ã
!(
s
.
¡¬t
, s.
buf
.
ÿp
());

453 
as£¹_Ã
!(
s
.
’d
, s.
buf
.
ÿp
());

454 
as£¹_eq
!(&
w
[..
Ën
 - 
l
], &
ex³ùed
[l..]);

460 #[
‹¡
]

461 
â
 
‹¡_buf_»ad
() {

462 
Ët
 
mut
 
s
 = 
Ãw_pe_bufãr
(25);

464 
Ët
 
ÿp
 = 
s
.
ÿ·c™y
();

465 
Ën
 
š
 0..ÿ
p
 + 1 {

466 
Ët
 
ex³ùed
 = 
Ãw_§m¶e
(
Ën
);

468 
pos
 
š
 0..ÿ
p
 + 1 {

469 
l
 
š
 0..Ë
n
 + 1 {

470 
s
.
¡¬t
 = 
pos
;

471 
s
.
’d
 = 
pos
;

473 
Ët
 
mut
 
šput
 = 
ex³ùed
.
as_¦iû
();

474 
as£¹_eq
!(
Ën
, 
s
.
»ad_äom
(&
mut
 
šput
).
unw¿p
());

476 
as£¹_eq
!(
s
.
Ën
(),†en);

477 
Ën
 == 0 {

478 
as£¹
!(
s
.
fl_buf
().
unw¿p
().
is_em±y
());

480 
as£¹
!(!
s
.
fl_buf
().
unw¿p
().
is_em±y
());

482 
s
.
cÚsume
(
l
);

483 
as£¹_eq
!(
s
.
Ën
(),†’ - 
l
);

484 
l
 =ğ
Ën
 {

485 
as£¹
!(
s
.
fl_buf
().
unw¿p
().
is_em±y
());

487 
as£¹
!(!
s
.
fl_buf
().
unw¿p
().
is_em±y
());

494 #[
‹¡
]

495 
â
 
‹¡_shršk_to
() {

496 
Ët
 
ÿp
 = 25;

497 
l
 
š
 0..ÿ
p
 + 1 {

498 
Ët
 
ex³ù
 = 
Ãw_§m¶e
(
l
);

500 
pos
 
š
 0..ÿ
p
 + 1 {

501 
shršk
 
š
 0..ÿ
p
 {

502 
Ët
 
mut
 
s
 = 
Ãw_pe_bufãr
(
ÿp
);

503 
s
.
¡¬t
 = 
pos
;

504 
s
.
’d
 = 
pos
;

506 
Ët
 
mut
 
šput
 = 
ex³ù
.
as_¦iû
();

507 
as£¹_eq
!(
l
, 
s
.
»ad_äom
(&
mut
 
šput
).
unw¿p
());

508 
s
.
shršk_to
(
shršk
);

509 
as£¹_Ã
!(
s
.
¡¬t
, s.
buf
.
ÿp
());

510 
as£¹_Ã
!(
s
.
’d
, s.
buf
.
ÿp
());

512 
as£¹_eq
!(
shršk
, 
s
.
ÿ·c™y
());

513 
shršk
 > 
l
 {

514 
as£¹_eq
!(
s
, 
ex³ù
.
as_¦iû
());

516 
as£¹_eq
!(

517 
s
,

518 &
ex³ù
[..
shršk
],

520 
l
,

521 
pos
,

522 
shršk


530 #[
‹¡
]

531 
â
 
‹¡_’su»
() {

532 
Ët
 
ÿp
 = 25;

533 
l
 
š
 0..ÿ
p
 + 1 {

534 
Ët
 
ex³ù
 = 
Ãw_§m¶e
(
l
);

536 
pos
 
š
 0..ÿ
p
 + 1 {

537 
š™
 
š
 0..ÿ
p
 + 1 {

538 
Ët
 
mut
 
s
 = 
Ãw_pe_bufãr
(
ÿp
);

539 
s
.
¡¬t
 = 
pos
;

540 
s
.
’d
 = 
pos
;

542 
Ët
 
exam¶e
 = 
Ãw_§m¶e
(
š™
);

543 
Ët
 
mut
 
šput
 = 
exam¶e
.
as_¦iû
();

544 
as£¹_eq
!(
š™
, 
s
.
»ad_äom
(&
mut
 
šput
).
unw¿p
());

545 
as£¹_eq
!(
s
, 
exam¶e
.
as_¦iû
());

546 
s
.
’su»
(
š™
 + 
l
);

547 
as£¹_Ã
!(
s
.
¡¬t
, s.
buf
.
ÿp
());

548 
as£¹_Ã
!(
s
.
’d
, s.
buf
.
ÿp
());

549 
as£¹_eq
!(
s
, 
exam¶e
.
as_¦iû
());

550 
šput
 = 
ex³ù
.
as_¦iû
();

552 
as£¹_eq
!(
l
, 
s
.
»ad_äom
(&
mut
 
šput
).
unw¿p
());

553 
Ët
 
mut
 
exp
 = 
exam¶e
.
şÚe
();

554 
exp
.
ex‹nd_äom_¦iû
(&
ex³ù
);

555 
as£¹_eq
!(
s
, 
exp
.
as_¦iû
());

561 #[
‹¡
]

562 
â
 
‹¡_wr™e_®l
() {

563 
Ët
 
mut
 
s
 = 
Ãw_pe_bufãr
(25);

564 
Ët
 
exam¶e
 = 
Ãw_§m¶e
(25);

565 
s
.
wr™e_®l
(&
exam¶e
).
unw¿p
();

566 
Ët
 
mut
 
buf
: 
Vec
<
u8
> = 
Ãw_§m¶e
(20);

568 
Ët
 
mut
 
buf_w
 = 
buf
.
as_mut_¦iû
();

569 
as£¹
!(
s
.
wr™e_®l_to
(&
mut
 
buf_w
).
is_”r
());

573 
Ët
 
mut
 
buf_w
 = 
buf
.
as_mut_¦iû
();

574 
as£¹
!(
s
.
wr™e_®l_to
(&
mut
 
buf_w
).
is_”r
());

576 
buf
 = 
Ãw_§m¶e
(25);

577 
Ët
 
mut
 
buf_w
 = 
buf
.
as_mut_¦iû
();

578 
as£¹
!(
s
.
wr™e_®l_to
(&
mut
 
buf_w
).
is_ok
());

579 
as£¹
!(
s
.
is_em±y
());

	@src/util/codec/bytes.rs

14 
u£
 
	g¡d
::
io
::{
R—d
, 
	gWr™e
};

16 
u£
 
	gsu³r
::{
E¼Ü
, 
	gResuÉ
};

17 
u£
 
	gut
::
codec
::
numb”
::{
Numb”Decod”
, 
	gNumb”Encod”
};

19 cÚ¡ 
	gENC_GROUP_SIZE
: 
usize
 = 8;

20 cÚ¡ 
	gENC_MARKER
: 
u8
 = 
b
'\xff';

21 cÚ¡ 
	gENC_PADDING
: [
u8
; 
ENC_GROUP_SIZE
] = [0; ENC_GROUP_SIZE];

24 
pub
 
â
 
max_’coded_by‹s_size
(
n
: 
usize
) -> usize {

25 (
n
 / 
ENC_GROUP_SIZE
 + 1) * (ENC_GROUP_SIZE + 1)

28 
pub
 
Œa™
 
By‹sEncod”
: 
Numb”Encod”
 {

30 
â
 
’code_by‹s
(&
mut
 
£lf
, 
key
: &[
u8
], 
desc
: 
boŞ
è-> 
ResuÉ
<()> {

31 
Ët
 
Ën
 = 
key
.len();

32 
Ët
 
mut
 
	gšdex
 = 0;

33 
Ët
 
mut
 
	gbuf
 = [0; 
ENC_GROUP_SIZE
];

34 
	gšdex
 <ğ
Ën
 {

35 
Ët
 
»maš
 = 
Ën
 - 
šdex
;

36 
Ët
 
mut
 
	g·d
: 
usize
 = 0;

37 
	g»maš
 > 
	gENC_GROUP_SIZE
 {

38 
	g£lf
.
wr™e_®l
(
adju¡_by‹s_Üd”
(

39 &
key
[
šdex
..šdex + 
ENC_GROUP_SIZE
],

40 
desc
,

41 &
mut
 
buf
,

44 
	g·d
 = 
ENC_GROUP_SIZE
 - 
»maš
;

45 
	g£lf
.
wr™e_®l
(
adju¡_by‹s_Üd”
(&
key
[
šdex
..], 
desc
, &
mut
 
buf
))?;

46 
	g£lf
.
wr™e_®l
(
adju¡_by‹s_Üd”
(&
ENC_PADDING
[..
·d
], 
desc
, &
mut
 
buf
))?;

48 
	g£lf
.
wr™e_®l
(
adju¡_by‹s_Üd”
(

49 &[
ENC_MARKER
 - (
·d
 
as
 
u8
)],

50 
desc
,

51 &
mut
 
buf
,

53 
	gšdex
 +ğ
ENC_GROUP_SIZE
;

55 
Ok
(())

61 
â
 
’code_com·ù_by‹s
(&
mut
 
£lf
, 
d©a
: &[
u8
]è-> 
ResuÉ
<()> {

62 
£lf
.
’code_v¬_i64
(
d©a
.
Ën
(è
as
 
i64
)?;

63 
	g£lf
.
wr™e_®l
(
d©a
).
m­_”r
(
From
::
äom
)

67 
â
 
adju¡_by‹s_Üd”
<'a>(bs: &'
a
 [
u8
], 
	gdesc
: 
boŞ
, 
	gbuf
: &'a mut [u8]) -> &'a [u8] {

68 
desc
 {

69 
Ët
 
mut
 
buf_idx
 = 0;

70 &
b
 
š
 
	gbs
 {

71 
	gbuf
[
buf_idx
] = !
b
;

72 
	gbuf_idx
 += 1;

74 &
	gbuf
[..
buf_idx
]

76 
	gbs


80 
	gim¶
<
	gT
: 
Wr™e
> 
By‹sEncod”
 
T
 {}

82 
pub
 
â
 
’code_by‹s
(
bs
: &[
u8
]è-> 
Vec
<u8> {

83 
’code_Üd”_by‹s
(
bs
, 
çl£
)

86 
pub
 
â
 
’code_by‹s_desc
(
bs
: &[
u8
]è-> 
Vec
<u8> {

87 
’code_Üd”_by‹s
(
bs
, 
Œue
)

90 
â
 
’code_Üd”_by‹s
(
bs
: &[
u8
], 
desc
: 
boŞ
è-> 
Vec
<u8> {

91 
Ët
 
ÿp
 = 
max_’coded_by‹s_size
(
bs
.
Ën
());

92 
Ët
 
mut
 
	g’coded
 = 
Vec
::
w™h_ÿ·c™y
(
ÿp
);

93 
	g’coded
.
’code_by‹s
(
bs
, 
desc
).
unw¿p
();

94 
	g’coded
.
shršk_to_f™
();

95 
	g’coded


102 
pub
 
â
 
’coded_com·ù_Ën
(
mut
 
’coded
: &[
u8
]è-> 
usize
 {

103 
Ët
 
Ï¡_’coded
 = 
’coded
.
as_±r
(è
as
 
usize
;

104 
Ët
 
	gtÙ®_Ën
 = 
’coded
.
Ën
();

105 
Ët
 
	gvn
 = 
m©ch
 
’coded
.
decode_v¬_i64
() {

106 
Ok
(
vn
è=> vÀ
as
 
usize
,

107 
E¼
(
e
) => {

108 
debug
!("çedØdecodby‹s'†’gth: {:?}", 
e
);

109  
	gtÙ®_Ën
;

112 
	gvn
 + (
	g’coded
.
as_±r
(è
as
 
	gusize
 - 
	gÏ¡_’coded
)

115 
pub
 
Œa™
 
	gCom·ùBy‹sDecod”
: 
Numb”Decod”
 {

117 
â
 
decode_com·ù_by‹s
(&
mut
 
£lf
è-> 
ResuÉ
<
Vec
<
u8
>> {

118 
Ët
 
vn
 = 
£lf
.
decode_v¬_i64
()? 
as
 
usize
;

119 
Ët
 
mut
 
	gd©a
 = 
vec
![0; 
vn
];

120 
	g£lf
.
»ad_exaù
(&
mut
 
d©a
)?;

121 
Ok
(
d©a
)

125 
	gim¶
<
	gT
: 
R—d
> 
Com·ùBy‹sDecod”
 
T
 {}

131 
pub
 
â
 
’coded_by‹s_Ën
(
’coded
: &[
u8
], 
desc
: 
boŞ
è-> 
usize
 {

132 
Ët
 
mut
 
idx
 = 
ENC_GROUP_SIZE
;

133 
	gloİ
 {

134 
	g’coded
.
Ën
(è< 
	gidx
 + 1 {

135  
	g’coded
.
Ën
();

137 
Ët
 
	gm¬k”
 = 
’coded
[
idx
];

138 
	gdesc
 && 
	gm¬k”
 !ğ0 || !
desc
 && 
m¬k”
 !ğ
ENC_MARKER
 {

139  
idx
 + 1;

141 
	gidx
 +ğ
ENC_GROUP_SIZE
 + 1;

145 
pub
 
Œa™
 
	gBy‹sDecod”
: 
Numb”Decod”
 + 
Com·ùBy‹sDecod”
 {

147 
â
 
»maššg
(&
£lf
è-> 
usize
;

149 
â
 
³ak_u8
(&
£lf
è-> 
	gO±iÚ
<
	gu8
>;

151 
â
 
decode_by‹s
(&
mut
 
£lf
, 
desc
: 
boŞ
è-> 
ResuÉ
<
Vec
<
u8
>> {

152 
Ët
 
mut
 
key
 = 
Vec
::
w™h_ÿ·c™y
(
£lf
.
»maššg
());

153 
Ët
 
mut
 
	gchunk
 = [0; 
ENC_GROUP_SIZE
 + 1];

154 
	gloİ
 {

155 
	g£lf
.
»ad_exaù
(&
mut
 
chunk
)?;

156 
Ët
 (&
m¬k”
, 
by‹s
èğ
chunk
.
¥l™_Ï¡
().
unw¿p
();

157 
Ët
 
	g·d_size
 = 
desc
 {

158 
m¬k”
 
as
 
usize


160 (
ENC_MARKER
 - 
m¬k”
è
as
 
usize


162 
	g·d_size
 == 0 {

163 
key
.
wr™e_®l
(
by‹s
).
unw¿p
();

166 
	g·d_size
 > 
	gENC_GROUP_SIZE
 {

167  
E¼
(
E¼Ü
::
KeyPaddšg
);

169 
Ët
 (
by‹s
, 
·ddšg
èğby‹s.
¥l™_©
(
ENC_GROUP_SIZE
 - 
·d_size
);

170 
	gkey
.
wr™e_®l
(
by‹s
).
unw¿p
();

171 
Ët
 
	g·d_by‹
 = 
desc
 { !0 } { 0 };

172 
	g·ddšg
.
™”
().
ªy
(|
x
| *x !ğ
·d_by‹
) {

173  
E¼
(
E¼Ü
::
KeyPaddšg
);

175 
	gkey
.
shršk_to_f™
();

176 
	gdesc
 {

177 
k
 
	gš
 &
mut
 
	gkey
 {

178 *
	gk
 = !*
k
;

181  
Ok
(
key
);

186 
	gim¶
<'a> By‹sDecod” fÜ &'
	ga
 [
u8
] {

187 
â
 
»maššg
(&
£lf
è-> 
	gusize
 {

188 
	g£lf
.
Ën
()

191 
â
 
³ak_u8
(&
£lf
è-> 
	gO±iÚ
<
	gu8
> {

192 
	g£lf
.
is_em±y
() {

193 
	gNÚe


195 
Some
(
£lf
[0])

200 #[
cfg
(
‹¡
)]

201 
mod
 
	g‹¡s
 {

202 
u£
 
	gsu³r
::*;

203 
u£
 
	gut
::
codec
::{
by‹s
, 
	gnumb”
};

204 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

206 #[
‹¡
]

207 
â
 
‹¡_’c_dec_by‹s
() {

208 
Ët
 
	g·œs
 = 
vec
![

210 
vec
![],

211 
	gvec
![0, 0, 0, 0, 0, 0, 0, 0, 247],

212 
	gvec
![255, 255, 255, 255, 255, 255, 255, 255, 8],

215 
	gvec
![0],

216 
	gvec
![0, 0, 0, 0, 0, 0, 0, 0, 248],

217 
	gvec
![255, 255, 255, 255, 255, 255, 255, 255, 7],

220 
	gvec
![1, 2, 3],

221 
	gvec
![1, 2, 3, 0, 0, 0, 0, 0, 250],

222 
	gvec
![254, 253, 252, 255, 255, 255, 255, 255, 5],

225 
	gvec
![1, 2, 3, 0],

226 
	gvec
![1, 2, 3, 0, 0, 0, 0, 0, 251],

227 
	gvec
![254, 253, 252, 255, 255, 255, 255, 255, 4],

230 
	gvec
![1, 2, 3, 4, 5, 6, 7],

231 
	gvec
![1, 2, 3, 4, 5, 6, 7, 0, 254],

232 
	gvec
![254, 253, 252, 251, 250, 249, 248, 255, 1],

235 
	gvec
![0, 0, 0, 0, 0, 0, 0, 0],

236 
	gvec
![0, 0, 0, 0, 0, 0, 0, 0, 255, 0, 0, 0, 0, 0, 0, 0, 0, 247],

237 
	gvec
![

259 
	gvec
![1, 2, 3, 4, 5, 6, 7, 8],

260 
	gvec
![1, 2, 3, 4, 5, 6, 7, 8, 255, 0, 0, 0, 0, 0, 0, 0, 0, 247],

261 
	gvec
![

283 
	gvec
![1, 2, 3, 4, 5, 6, 7, 8, 9],

284 
	gvec
![1, 2, 3, 4, 5, 6, 7, 8, 255, 9, 0, 0, 0, 0, 0, 0, 0, 248],

285 
	gvec
![

308 
	gsourû
, 
	gasc
, 
	gdesc
è
š
 
	g·œs
 {

309 
	gas£¹_eq
!(
’code_by‹s
(&
sourû
), 
	gasc
);

310 
	gas£¹_eq
!(
’code_by‹s_desc
(&
sourû
), 
	gdesc
);

312 
Ët
 
	gasc_off£t
 = 
asc
.
as_±r
(è
as
 
usize
;

313 
Ët
 
mut
 
	gasc_šput
 = 
asc
.
as_¦iû
();

314 
	gas£¹_eq
!(
	gsourû
, 
	gasc_šput
.
decode_by‹s
(
çl£
).
unw¿p
());

315 
	gas£¹_eq
!(
	gasc_šput
.
as_±r
(è
as
 
	gusize
 - 
	gasc_off£t
, 
	gasc
.
Ën
());

317 
Ët
 
	gdesc_off£t
 = 
desc
.
as_±r
(è
as
 
usize
;

318 
Ët
 
mut
 
	gdesc_šput
 = 
desc
.
as_¦iû
();

319 
	gas£¹_eq
!(
	gsourû
, 
	gdesc_šput
.
decode_by‹s
(
Œue
).
unw¿p
());

320 
	gas£¹_eq
!(
	gdesc_šput
.
as_±r
(è
as
 
	gusize
 - 
	gdesc_off£t
, 
	gdesc
.
Ën
());

324 #[
‹¡
]

325 
â
 
‹¡_dec_by‹s_ç
() {

326 
Ët
 
	gšv®id_by‹s
 = 
vec
![

327 
vec
![1, 2, 3, 4],

328 
	gvec
![0, 0, 0, 0, 0, 0, 0, 247],

329 
	gvec
![0, 0, 0, 0, 0, 0, 0, 0, 246],

330 
	gvec
![0, 0, 0, 0, 0, 0, 0, 1, 247],

331 
	gvec
![1, 2, 3, 4, 5, 6, 7, 8, 0],

332 
	gvec
![1, 2, 3, 4, 5, 6, 7, 8, 255, 1],

333 
	gvec
![1, 2, 3, 4, 5, 6, 7, 8, 255, 1, 2, 3, 4, 5, 6, 7, 8],

334 
	gvec
![1, 2, 3, 4, 5, 6, 7, 8, 255, 1, 2, 3, 4, 5, 6, 7, 8, 255],

335 
	gvec
![1, 2, 3, 4, 5, 6, 7, 8, 255, 1, 2, 3, 4, 5, 6, 7, 8, 0],

338 
x
 
š
 
	gšv®id_by‹s
 {

339 
	gas£¹
!(
	gx
.
as_¦iû
().
decode_by‹s
(
çl£
).
is_”r
());

343 #[
‹¡
]

344 
â
 
‹¡_’code_by‹s_com·»
() {

345 
Ët
 
	g·œs
: 
Vec
<(&[
u8
], &[u8], 
	g_
)> = 
vec
![

346 (
b
"", b"\x00", 
Ord”šg
::
Less
),

347 (
b
"\x00", b"\x00", 
Ord”šg
::
Equ®
),

348 (
b
"\xFF", b"\x00", 
Ord”šg
::
G»©”
),

349 (
b
"\xFF", b"\xFF\x00", 
Ord”šg
::
Less
),

350 (
b
"a", b"b", 
Ord”šg
::
Less
),

351 (
b
"a", b"\x00", 
Ord”šg
::
G»©”
),

352 (
b
"\x00", b"\x01", 
Ord”šg
::
Less
),

353 (
b
"\x00\x01", b"\x00\x00", 
Ord”šg
::
G»©”
),

354 (
b
"\x00\x00\x00", b"\x00\x00", 
Ord”šg
::
G»©”
),

355 (
b
"\x00\x00\x00", b"\x00\x00", 
Ord”šg
::
G»©”
),

358 
b
"\x00\x00\x00\x00\x00\x00\x00\x00",

359 
b
"\x00\x00\x00\x00\x00\x00\x00\x00\x00",

360 
Ord”šg
::
Less
,

363 (
b
"\x01\x02\x03\x00", b"\x01\x02\x03", 
Ord”šg
::
G»©”
),

364 (
b
"\x01\x03\x03\x04", b"\x01\x03\x03\x05", 
Ord”šg
::
Less
),

367 
b
"\x01\x02\x03\x04\x05\x06\x07",

368 
b
"\x01\x02\x03\x04\x05\x06\x07\x08",

369 
Ord”šg
::
Less
,

373 
b
"\x01\x02\x03\x04\x05\x06\x07\x08\x09",

374 
b
"\x01\x02\x03\x04\x05\x06\x07\x08",

375 
Ord”šg
::
G»©”
,

379 
b
"\x01\x02\x03\x04\x05\x06\x07\x08\x00",

380 
b
"\x01\x02\x03\x04\x05\x06\x07\x08",

381 
Ord”šg
::
G»©”
,

385 
	gx
, 
	gy
, 
	gÜd
è
š
 
	g·œs
 {

386 
	gas£¹_eq
!(
’code_by‹s
(
x
).
cmp
(&’code_by‹s(
y
)), 
	gÜd
);

387 
	gas£¹_eq
!(

388 
’code_by‹s_desc
(
x
).
cmp
(&’code_by‹s_desc(
y
)),

389 
	gÜd
.
»v”£
()

394 #[
‹¡
]

395 
â
 
‹¡_max_’coded_by‹s_size
() {

396 
Ët
 
	gn
 = 
by‹s
::
ENC_GROUP_SIZE
;

397 
Ët
 
	gtbl
: 
Vec
<(
usize
, 
	gusize
)> = 
vec
![(0, 
n
 + 1), (n / 2,‚ + 1), (n, 2 * (n + 1))];

398 
	gx
, 
	gy
è
š
 
	gtbl
 {

399 
	gas£¹_eq
!(
max_’coded_by‹s_size
(
x
), 
	gy
);

403 #[
‹¡
]

404 
â
 
‹¡_com·ù_codec
() {

405 
Ët
 
	g‹¡s
 = 
vec
!["", "hello", "ä¸–ç•Œ"];

406 &
s
 
	gš
 &
	g‹¡s
 {

407 
Ët
 
	gmax_size
 = 
s
.
Ën
(è+ 
numb”
::
MAX_VAR_I64_LEN
;

408 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(
max_size
);

409 
	gbuf
.
’code_com·ù_by‹s
(
s
.
as_by‹s
()).
unw¿p
();

410 
	gas£¹
!(
	gbuf
.
Ën
(è<ğ
max_size
);

411 
Ët
 
mut
 
	gšput
 = 
buf
.
as_¦iû
();

412 
Ët
 
	gdecoded
 = 
šput
.
decode_com·ù_by‹s
().
unw¿p
();

413 
	gas£¹
!(
	gšput
.
is_em±y
());

414 
	gas£¹_eq
!(
	gdecoded
, 
	gs
.
as_by‹s
());

418 
u£
 
	g‹¡
::
B’ch”
;

420 #[
b’ch
]

421 
â
 
b’ch_’code
(
b
: &
mut
 
B’ch”
) {

422 
Ët
 
key
 = [
b
'x'; 20];

423 
	gb
.
™”
(|| 
’code_by‹s
(&
key
));

426 #[
b’ch
]

427 
â
 
b’ch_decode
(
b
: &
mut
 
B’ch”
) {

428 
Ët
 
key
 = [
b
'x'; 2000000];

429 
Ët
 
	g’coded
 = 
’code_by‹s
(&
key
);

430 
	gb
.
™”
(|| 
’coded
.
as_¦iû
().
decode_by‹s
(
çl£
));

	@src/util/codec/mod.rs

15 
pub
 
mod
 
	gby‹s
;

16 
pub
 
mod
 
	gnumb”
;

18 
u£
 
	g¡d
::
io
;

19 
u£
 
	g¡d
::
¡r
::
Utf8E¼Ü
;

20 
u£
 
	g¡d
::
¡ršg
::
FromUtf8E¼Ü
;

21 
u£
 
	g¡d
::
”rÜ
;

22 
u£
 
	g´Ùobuf
;

24 
	gquick_”rÜ
! {

25 #[
d”ive
(
Debug
)]

26 
pub
 
	eE¼Ü
 {

27 
Io
(
”r
: 
io
::
E¼Ü
) {

28 
äom
()

29 
ÿu£
(
”r
)

30 
desütiÚ
(
”r
.description())

32 
PrÙobuf
(
”r
: 
´Ùobuf
::
PrÙobufE¼Ü
) {

33 
äom
()

34 
ÿu£
(
”r
)

35 
desütiÚ
(
”r
.description())

36 
di¥Ïy
("´Ùobuà”rÜ {:?}", 
”r
)

38 
	gKeyL’gth
 {
desütiÚ
("bad format key(length)")}

39 
	gKeyPaddšg
 {
desütiÚ
("bad format key(padding)")}

40 
	gKeyNÙFound
 {
desütiÚ
("key‚ot found")}

41 
Inv®idD©aTy³
(
»asÚ
: 
SŒšg
) {

42 
desütiÚ
("invalid dataype")

43 
di¥Ïy
("{}", 
»asÚ
)

45 
Encodšg
(
”r
: 
Utf8E¼Ü
) {

46 
äom
()

47 
ÿu£
(
”r
)

48 
desütiÚ
("enconding failed")

50 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
Sync
 + 
S’d
>) {

51 
äom
()

52 
ÿu£
(
”r
.
as_»f
())

53 
desütiÚ
(
”r
.description())

54 
di¥Ïy
("unknowÀ”rÜ {:?}", 
”r
)

59 
im¶
 
	gE¼Ü
 {

60 
pub
 
â
 
maybe_şÚe
(&
£lf
è-> 
	gO±iÚ
<
	gE¼Ü
> {

61 
m©ch
 *
	g£lf
 {

62 
	gE¼Ü
::
KeyL’gth
 => 
Some
(
E¼Ü
::KeyLength),

63 
	gE¼Ü
::
KeyPaddšg
 => 
Some
(
E¼Ü
::KeyPadding),

64 
	gE¼Ü
::
KeyNÙFound
 => 
Some
(
E¼Ü
::KeyNotFound),

65 
	gE¼Ü
::
Inv®idD©aTy³
(
»f
 
r
è=> 
Some
(
E¼Ü
::Inv®idD©aTy³Ô.
şÚe
())),

66 
	gE¼Ü
::
Encodšg
(
e
è=> 
Some
(
E¼Ü
::Encoding(e)),

67 
	gE¼Ü
::
PrÙobuf
(
_
è| 
E¼Ü
::
Io
(_è| E¼Ü::
Oth”
(_è=> 
NÚe
,

72 
im¶
 
	gFrom
<
	gFromUtf8E¼Ü
> 
	gE¼Ü
 {

73 
â
 
äom
(
”r
: 
FromUtf8E¼Ü
è-> 
E¼Ü
 {

74 
”r
.
utf8_”rÜ
().
što
()

78 
pub
 
ty³
 
ResuÉ
<
T
> = ::
¡d
::
»suÉ
::ResuÉ<T, 
	gE¼Ü
>;

	@src/util/codec/number.rs

14 
u£
 
	gby‹Üd”
::{
BigEndŸn
, 
	gL™eEndŸn
, 
	gR—dBy‹sExt
, 
	gWr™eBy‹sExt
};

15 
u£
 
	g¡d
::
io
::{
£lf
, 
	gE¼ÜKšd
, 
	gR—d
, 
	gWr™e
};

16 
u£
 
	g¡d
::
mem
;

18 
u£
 
	gsu³r
::{
E¼Ü
, 
	gResuÉ
};

20 cÚ¡ 
	gSIGN_MARK
: 
u64
 = 0x8000000000000000;

21 
pub
 cÚ¡ 
	gMAX_VAR_I64_LEN
: 
usize
 = 10;

22 
pub
 cÚ¡ 
	gMAX_VAR_U64_LEN
: 
usize
 = 10;

23 
pub
 cÚ¡ 
	gU64_SIZE
: 
usize
 = 8;

24 
pub
 cÚ¡ 
	gI64_SIZE
: 
usize
 = 8;

25 
pub
 cÚ¡ 
	gF64_SIZE
: 
usize
 = 8;

27 
â
 
Üd”_’code_i64
(
v
: 
i64
è-> 
u64
 {

28 
v
 
as
 
u64
 ^ 
SIGN_MARK


31 
â
 
Üd”_decode_i64
(
u
: 
u64
è-> 
i64
 {

32 (
u
 ^ 
SIGN_MARK
è
as
 
i64


35 
â
 
Üd”_’code_f64
(
v
: 
f64
è-> 
u64
 {

36 
Ët
 
u
: 
u64
 = 
un§ã
 { 
mem
::
Œªsmu‹
(
v
) };

37 
	gv
.
is_sign_pos™ive
() {

38 
	gu
 | 
	gSIGN_MARK


40 !
	gu


44 
â
 
Üd”_decode_f64
(
u
: 
u64
è-> 
f64
 {

45 
Ët
 
u
 = u & 
SIGN_MARK
 > 0 {

46 
u
 & (!
SIGN_MARK
)

48 !
u


50 
	gun§ã
 { 
	gmem
::
Œªsmu‹
(
u
) }

53 
pub
 
Œa™
 
Numb”Encod”
: 
Wr™e
 {

56 
â
 
’code_i64
(&
mut
 
£lf
, 
v
: 
i64
è-> 
ResuÉ
<()> {

57 
Ët
 
u
 = 
Üd”_’code_i64
(
v
);

58 
	g£lf
.
’code_u64
(
u
)

63 
â
 
’code_i64_desc
(&
mut
 
£lf
, 
v
: 
i64
è-> 
ResuÉ
<()> {

64 
Ët
 
u
 = 
Üd”_’code_i64
(
v
);

65 
	g£lf
.
’code_u64_desc
(
u
)

70 
â
 
’code_u64
(&
mut
 
£lf
, 
v
: 
u64
è-> 
ResuÉ
<()> {

71 
£lf
.
wr™e_u64
::<
BigEndŸn
>(
v
).
m­_”r
(
From
::
äom
)

76 
â
 
’code_u64_desc
(&
mut
 
£lf
, 
v
: 
u64
è-> 
ResuÉ
<()> {

77 
£lf
.
wr™e_u64
::<
BigEndŸn
>(!
v
).
m­_”r
(
From
::
äom
)

82 
â
 
’code_v¬_i64
(&
mut
 
£lf
, 
v
: 
i64
è-> 
ResuÉ
<()> {

83 
Ët
 
mut
 
vx
 = (
v
 
as
 
u64
) << 1;

84 
	gv
 < 0 {

85 
	gvx
 = !
vx
;

87 
	g£lf
.
’code_v¬_u64
(
vx
)

92 
â
 
’code_v¬_u64
(&
mut
 
£lf
, muˆ
v
: 
u64
è-> 
ResuÉ
<()> {

93 
v
 >= 0x80 {

94 
£lf
.
wr™e_u8
(
v
 
as
 
u8
 | 0x80)?;

95 
	gv
 >>= 7;

97 
	g£lf
.
wr™e_u8
(
v
 
as
 
u8
).
m­_”r
(
From
::
äom
)

102 
â
 
’code_f64
(&
mut
 
£lf
, 
f
: 
f64
è-> 
ResuÉ
<()> {

103 
Ët
 
u
 = 
Üd”_’code_f64
(
f
);

104 
	g£lf
.
’code_u64
(
u
)

109 
â
 
’code_f64_desc
(&
mut
 
£lf
, 
f
: 
f64
è-> 
ResuÉ
<()> {

110 
Ët
 
u
 = 
Üd”_’code_f64
(
f
);

111 
	g£lf
.
’code_u64_desc
(
u
)

114 
â
 
’code_u16_Ë
(&
mut
 
£lf
, 
v
: 
u16
è-> 
ResuÉ
<()> {

115 
£lf
.
wr™e_u16
::<
L™eEndŸn
>(
v
).
m­_”r
(
From
::
äom
)

118 
â
 
’code_u32_Ë
(&
mut
 
£lf
, 
v
: 
u32
è-> 
ResuÉ
<()> {

119 
£lf
.
wr™e_u32
::<
L™eEndŸn
>(
v
).
m­_”r
(
From
::
äom
)

122 
â
 
’code_f64_Ë
(&
mut
 
£lf
, 
v
: 
f64
è-> 
ResuÉ
<()> {

123 
£lf
.
wr™e_f64
::<
L™eEndŸn
>(
v
).
m­_”r
(
From
::
äom
)

126 
â
 
’code_i64_Ë
(&
mut
 
£lf
, 
v
: 
i64
è-> 
ResuÉ
<()> {

127 
£lf
.
wr™e_i64
::<
L™eEndŸn
>(
v
).
m­_”r
(
From
::
äom
)

130 
â
 
’code_u64_Ë
(&
mut
 
£lf
, 
v
: 
u64
è-> 
ResuÉ
<()> {

131 
£lf
.
wr™e_u64
::<
L™eEndŸn
>(
v
).
m­_”r
(
From
::
äom
)

135 
im¶
<
T
: 
Wr™e
> 
Numb”Encod”
 T {}

137 
pub
 
Œa™
 
Numb”Decod”
: 
R—d
 {

139 
â
 
decode_i64
(&
mut
 
£lf
è-> 
ResuÉ
<
i64
> {

140 
£lf
.
decode_u64
().
m­
(
Üd”_decode_i64
)

144 
â
 
decode_i64_desc
(&
mut
 
£lf
è-> 
ResuÉ
<
i64
> {

145 
£lf
.
decode_u64_desc
().
m­
(
Üd”_decode_i64
)

149 
â
 
decode_u64
(&
mut
 
£lf
è-> 
ResuÉ
<
u64
> {

150 
£lf
.
»ad_u64
::<
BigEndŸn
>().
m­_”r
(
From
::
äom
)

154 
â
 
decode_u64_desc
(&
mut
 
£lf
è-> 
ResuÉ
<
u64
> {

155 
Ët
 
v
 = 
£lf
.
»ad_u64
::<
BigEndŸn
>()?;

156 
Ok
(!
v
)

160 
â
 
decode_v¬_i64
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gi64
> {

161 
Ët
 
	gv
 = 
£lf
.
decode_v¬_u64
()?;

162 
Ët
 
mut
 
	gvx
 = 
v
 >> 1;

163 
	gv
 & 1 != 0 {

164 
vx
 = !vx;

166 
Ok
(
vx
 
as
 
i64
)

170 
â
 
decode_v¬_u64
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gu64
> {

171 
Ët
 (
mut
 
x
, muˆ
s
, muˆ
i
) = (0, 0, 0);

172 
	gloİ
 {

173 
Ët
 
	gb
 = 
£lf
.
»ad_u8
()?;

174 
	gb
 < 0x80 {

175 
	gi
 > 9 || i =ğ9 && 
b
 > 1 {

176  
E¼
(
E¼Ü
::
Io
(

177 
io
::
E¼Ü
::
Ãw
(
E¼ÜKšd
::
Inv®idD©a
, "overflow"),

180  
Ok
(
x
 | ((
b
 
as
 
u64
è<< 
s
));

182 
	gx
 |ğ((
b
 & 0x7fè
as
 
u64
è<< 
s
;

183 
	gs
 += 7;

184 
	gi
 += 1;

189 
â
 
decode_f64
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gf64
> {

190 
	g£lf
.
decode_u64
().
m­
(
Üd”_decode_f64
)

194 
â
 
decode_f64_desc
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gf64
> {

195 
	g£lf
.
decode_u64_desc
().
m­
(
Üd”_decode_f64
)

198 
â
 
decode_u16_Ë
(&
mut
 
£lf
è-> 
	gResuÉ
<
	gu16
> {

199 
	g£lf
.
	g»ad_u16
::<
L™eEndŸn
>().
m­_”r
(
From
::
äom
)

202 
â
 
decode_u32_Ë
(&
mut
 
£lf
è-> 
ResuÉ
<
u32
> {

203 
£lf
.
»ad_u32
::<
L™eEndŸn
>().
m­_”r
(
From
::
äom
)

206 
â
 
decode_f64_Ë
(&
mut
 
£lf
è-> 
ResuÉ
<
f64
> {

207 
£lf
.
»ad_f64
::<
L™eEndŸn
>().
m­_”r
(
From
::
äom
)

210 
â
 
decode_i64_Ë
(&
mut
 
£lf
è-> 
ResuÉ
<
i64
> {

211 
£lf
.
»ad_i64
::<
L™eEndŸn
>().
m­_”r
(
From
::
äom
)

214 
â
 
decode_u64_Ë
(&
mut
 
£lf
è-> 
ResuÉ
<
u64
> {

215 
£lf
.
»ad_u64
::<
L™eEndŸn
>().
m­_”r
(
From
::
äom
)

219 
im¶
<
T
: 
R—d
> 
Numb”Decod”
 T {}

221 #[
cfg
(
‹¡
)]

222 
mod
 
‹¡
 {

223 
u£
 
su³r
::*;

224 
u£
 
	gut
::
codec
::
E¼Ü
;

226 
u£
 
	g¡d
::{
f32
, 
	gf64
, 
	gi16
, 
	gi32
, 
	gi64
, 
	gu16
, 
	gu32
, 
	gu64
};

227 
u£
 
	g´Ùobuf
::
CodedOuutSŒ—m
;

228 
u£
 
	g¡d
::
io
::
E¼ÜKšd
;

230 cÚ¡ 
	gU16_TESTS
: &'static [u16] = &[

231 
i16
::
MIN
 
as
 
u16
,

232 
	gi16
::
MAX
 
as
 
u16
,

233 
	gu16
::
MIN
,

234 
	gu16
::
MAX
,

252 cÚ¡ 
	gU32_TESTS
: &'static [u32] = &[

253 
i32
::
MIN
 
as
 
u32
,

254 
	gi32
::
MAX
 
as
 
u32
,

255 
	gu32
::
MIN
,

256 
	gu32
::
MAX
,

274 cÚ¡ 
	gU64_TESTS
: &'static [u64] = &[

275 
i64
::
MIN
 
as
 
u64
,

276 
	gi64
::
MAX
 
as
 
u64
,

277 
	gu64
::
MIN
,

278 
	gu64
::
MAX
,

295 cÚ¡ 
	gI64_TESTS
: &'static [i64] = &[

296 
i64
::
MIN
,

297 
	gi64
::
MAX
,

298 
	gu64
::
MIN
 
as
 
i64
,

299 
	gu64
::
MAX
 
as
 
i64
,

319 cÚ¡ 
	gF64_TESTS
: &'static [f64] = &[

323 
	gf64
::
MAX
,

324 
	gf64
::
MIN
,

325 
	gf32
::
MAX
 
as
 
f64
,

326 
	gf32
::
MIN
 
as
 
f64
,

327 
	gf64
::
MIN_POSITIVE
,

328 
	gf32
::
MIN_POSITIVE
 
as
 
f64
,

329 
	gf64
::
INFINITY
,

330 
	gf64
::
NEG_INFINITY
,

334 
	gmaüo_ruËs
! 
	g‹¡_Üd”
 {

335 (
	g$¬r
:
ex´
, 
	g$sÜ‹d
:ex´, 
	g$’c
:
id’t
, 
	g$dec
:ident) => {

336 
Ët
 
mut
 
’coded
: 
Vec
<
_
> = 
$¬r
.
™”
().
m­
(|
e
| {

337 
Ët
 
mut
 
buf
 = 
vec
![];

338 
buf
.
$’c
(*
e
).
unw¿p
();

339 
buf


340 }).
cŞËù
();

341 
	g’coded
.
sÜt
();

342 
Ët
 
	gdecoded
: 
Vec
<
_
> = 
’coded
.
™”
().
m­
(|
b
| b.
as_¦iû
().
$dec
().
unw¿p
()).
cŞËù
();

343 
	gas£¹_eq
!(
	gdecoded
, 
	g$sÜ‹d
);

348 
	gmaüo_ruËs
! 
	g‹¡_£rŸlize
 {

349 (
	g$g
:
id’t
, 
	g$’c
:id’t, 
	g$dec
:id’t, 
	g$ÿ£s
:
ex´
) => {

350 #[
‹¡
]

351 
â
 
$g
() {

352 &
v
 
š
 
$ÿ£s
 {

353 
Ët
 
mut
 
buf
 = 
vec
![];

354 
	gbuf
.
$’c
(
v
).
unw¿p
();

355 
	gas£¹
!(
	gbuf
.
Ën
(è<ğ
MAX_VAR_I64_LEN
);

356 
	gas£¹_eq
!(
	gv
, 
	gbuf
.
as_¦iû
().
$dec
().
unw¿p
());

363 
	gmaüo_ruËs
! 
	g‹¡_codec
 {

364 (
	g$’c
:
id’t
, 
	g$dec
:id’t, 
	g$com·»
:
ex´
, 
	g$ÿ£s
:expr) => {

365 #[
®low
(
unu£d_impÜts
)]

366 #[
®low
(
æßt_cmp
)]

367 
mod
 
$’c
 {

368 
u£
 
su³r
::{
I64_TESTS
, 
U64_TESTS
, 
U32_TESTS
, 
U16_TESTS
, 
F64_TESTS
};

369 
u£
 
	gut
::
codec
::
numb”
::*;

371 
	g‹¡_£rŸlize
!(
	g£rŸlize
, 
	g$’c
, 
	g$dec
, 
	g$ÿ£s
);

373 #[
‹¡
]

374 
â
 
‹¡_Üd”
() {

375 
Ët
 
mut
 
	gÜd”ed_ÿ£
 = 
$ÿ£s
.
to_vec
();

376 
	gÜd”ed_ÿ£
.
sÜt_by
(
$com·»
);

377 
	g‹¡_Üd”
!(
	g$ÿ£s
, 
	gÜd”ed_ÿ£
, 
	g$’c
, 
	g$dec
);

383 
	g‹¡_codec
!(
	g’code_i64
, 
	gdecode_i64
, |
	ga
, 
	gb
|‡.
cmp
(
b
), 
	gI64_TESTS
);

384 
	g‹¡_codec
!(
	g’code_i64_desc
, 
	gdecode_i64_desc
, |
	ga
, 
	gb
| b.
cmp
(
a
), 
	gI64_TESTS
);

385 
	g‹¡_codec
!(
	g’code_u64
, 
	gdecode_u64
, |
	ga
, 
	gb
|‡.
cmp
(
b
), 
	gU64_TESTS
);

386 
	g‹¡_codec
!(
	g’code_u64_desc
, 
	gdecode_u64_desc
, |
	ga
, 
	gb
| b.
cmp
(
a
), 
	gU64_TESTS
);

387 
	g‹¡_codec
!(

388 
	g’code_f64
,

389 
	gdecode_f64
,

390 |
	ga
, 
	gb
|‡.
·¹Ÿl_cmp
(
b
).
unw¿p
(),

391 
	gF64_TESTS


393 
	g‹¡_codec
!(

394 
	g’code_f64_desc
,

395 
	gdecode_f64_desc
,

396 |
	ga
, 
	gb
| b.
·¹Ÿl_cmp
(
a
).
unw¿p
(),

397 
	gF64_TESTS


400 
	g‹¡_£rŸlize
!(

401 
	gv¬_i64_l™e_’dŸn_codec
,

402 
	g’code_i64_Ë
,

403 
	gdecode_i64_Ë
,

404 
	gI64_TESTS


407 
	g‹¡_£rŸlize
!(

408 
	gv¬_u64_l™e_’dŸn_codec
,

409 
	g’code_u64_Ë
,

410 
	gdecode_u64_Ë
,

411 
	gU64_TESTS


414 
	g‹¡_£rŸlize
!(
	gv¬_u16_codec
, 
	g’code_u16_Ë
, 
	gdecode_u16_Ë
, 
	gU16_TESTS
);

415 
	g‹¡_£rŸlize
!(
	gv¬_u32_codec
, 
	g’code_u32_Ë
, 
	gdecode_u32_Ë
, 
	gU32_TESTS
);

417 
	g‹¡_£rŸlize
!(
	gv¬_i64_codec
, 
	g’code_v¬_i64
, 
	gdecode_v¬_i64
, 
	gI64_TESTS
);

419 #[
‹¡
]

420 #[
®low
(
æßt_cmp
)]

421 
â
 
‹¡_v¬_f64_Ë
() {

422 &
v
 
š
 
	gF64_TESTS
 {

423 
Ët
 
mut
 
	gbuf
 = 
vec
![];

424 
	gbuf
.
’code_f64_Ë
(
v
).
unw¿p
();

425 
Ët
 
	gv®ue
 = 
buf
.
as_¦iû
().
decode_f64_Ë
().
unw¿p
();

426 
	gas£¹_eq
!(
	gv
, 
	gv®ue
);

430 #[
‹¡
]

431 
â
 
‹¡_v¬_u64_codec
() {

432 &
v
 
š
 
	gU64_TESTS
 {

433 
Ët
 
mut
 
	gbuf
 = 
vec
![];

434 
Ët
 
mut
 
	gp_buf
 = 
vec
![];

436 
Ët
 
mut
 
	gwr™”
 = 
CodedOuutSŒ—m
::
Ãw
(&muˆ
p_buf
);

437 
	gwr™”
.
wr™e_ušt64_no_g
(
v
).
unw¿p
();

438 
	gwr™”
.
æush
().
unw¿p
();

440 
	gbuf
.
’code_v¬_u64
(
v
).
unw¿p
();

441 
	gas£¹
!(
	gbuf
.
Ën
(è<ğ
MAX_VAR_I64_LEN
);

442 
	gas£¹_eq
!(
	gbuf
, 
	gp_buf
);

443 
Ët
 
	gdecoded
 = 
buf
.
as_¦iû
().
decode_v¬_u64
().
unw¿p
();

444 
	gas£¹_eq
!(
	gv
, 
	gdecoded
);

449 
	gmaüo_ruËs
! 
	gcheck_”rÜ
 {

450 (
	g$e
:
ex´
, 
	g$k
:expr) => {

451 
m©ch
 
$e
 {

452 
E¼
(
E¼Ü
::
Io
(
e
)è=> 
as£¹_eq
!Ó.
kšd
(), 
	g$k
),

453 
	go
 => 
·nic
!("ex³ù {:?}, gÙ {:?}", 
	g$k
, o),

459 
	gmaüo_ruËs
! 
	g‹¡_eof
 {

460 (
	g$g
:
id’t
, 
	g$’c
:id’t, 
	g$dec
:id’t, 
	g$ÿ£
:
ex´
) => {

461 #[
‹¡
]

462 
â
 
$g
() {

463 
Ët
 
mut
 
buf
 = 
vec
![0; 7];

464 
	gcheck_”rÜ
!(
	gbuf
.
as_mut_¦iû
().
$’c
(
$ÿ£
), 
	gE¼ÜKšd
::
Wr™eZ”o
);

465 
	gcheck_”rÜ
!(
	gbuf
.
as_¦iû
().
$dec
(), 
	gE¼ÜKšd
::
UÃx³ùedEof
);

470 
	g‹¡_eof
!(
	gi64_eof
, 
	g’code_i64
, 
	gdecode_i64
, 1);

471 
	g‹¡_eof
!(
	gu64_eof
, 
	g’code_u64
, 
	gdecode_u64
, 1);

472 
	g‹¡_eof
!(
	gf64_eof
, 
	g’code_f64
, 
	gdecode_f64
, 1.0);

473 
	g‹¡_eof
!(
	gi64_desc_eof
, 
	g’code_i64_desc
, 
	gdecode_i64_desc
, 1);

474 
	g‹¡_eof
!(
	gu64_desc_eof
, 
	g’code_u64_desc
, 
	gdecode_u64_desc
, 1);

475 
	g‹¡_eof
!(
	gf64_desc_eof
, 
	g’code_f64_desc
, 
	gdecode_f64_desc
, 1.0);

477 #[
‹¡
]

478 
â
 
‹¡_v¬_eof
() {

479 
Ët
 
mut
 
	gbuf
 = 
vec
![0x80; 9];

480 
	gbuf
.
push
(0x2);

481 
	gcheck_”rÜ
!(
	gbuf
.
as_¦iû
().
decode_v¬_u64
(), 
	gE¼ÜKšd
::
Inv®idD©a
);

482 
	gcheck_”rÜ
!(
	gbuf
.
as_¦iû
().
decode_v¬_i64
(), 
	gE¼ÜKšd
::
Inv®idD©a
);

484 
	gbuf
 = 
vec
![0x80; 3];

485 
	gcheck_”rÜ
!(
	gbuf
.
as_¦iû
().
decode_v¬_u64
(), 
	gE¼ÜKšd
::
UÃx³ùedEof
);

487 
	gbuf
.
push
(0);

488 
	gas£¹_eq
!(0, 
	gbuf
.
as_¦iû
().
decode_v¬_u64
().
unw¿p
());

	@src/util/collections.rs

14 
pub
 
u£
 
	gâv
::
FnvHashS‘
 
as
 
HashS‘
;

15 
pub
 
u£
 
	gâv
::
FnvBudHash”
 
as
 
BudHash”DeçuÉ
;

16 
pub
 
u£
 
	gâv
::
FnvHashM­
 
as
 
HashM­
;

17 
pub
 
u£
 
	g¡d
::
cŞËùiÚs
::
hash_m­
::
EÁry
 
as
 
HashM­EÁry
;

18 
pub
 
u£
 
	gæ©_m­
::
FÏtM­
;

19 
pub
 
u£
 
	gæ©_m­
::
æ©_m­
::
V®ues
 
as
 
FÏtM­V®ues
;

20 
pub
 
u£
 
	gÜd”m­
::{
EÁry
 
as
 
Ord”M­EÁry
, 
	gOrd”M­
};

	@src/util/config.rs

14 
u£
 
	g¡d
::
”rÜ
::
E¼Ü
;

15 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gWr™e
};

16 
u£
 
	g¡d
::
fs
;

17 
u£
 
	g¡d
::
·th
::
P©h
;

18 
u£
 
	g¡d
::
¡r
::{
£lf
, 
	gFromSŒ
};

19 
u£
 
	g¡d
::
ascii
::
AsciiExt
;

20 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

21 
u£
 
	g¡d
::
Ãt
::{
Sock‘AddrV4
, 
	gSock‘AddrV6
};

22 
u£
 
	g¡d
::
İs
::{
Div
, 
	gMul
};

24 
u£
 
	gu¾
;

25 
u£
 
	g£rde
::{
De£rŸlize
, 
	gDe£rŸliz”
, 
	gS”Ÿlize
, 
	gS”Ÿliz”
};

26 
u£
 
	g£rde
::
de
::{
£lf
, 
	gUÃx³ùed
, 
	gVis™Ü
};

28 
u£
 
	gut
;

30 
	gquick_”rÜ
! {

31 #[
d”ive
(
Debug
)]

32 
pub
 
	eCÚfigE¼Ü
 {

33 
Lim™
(
msg
: 
SŒšg
) {

34 
desütiÚ
(
msg
)

35 
di¥Ïy
("{}", 
msg
)

37 
Add»ss
(
msg
: 
SŒšg
) {

38 
desütiÚ
(
msg
)

39 
di¥Ïy
("cÚfig‡dd»s ”rÜ: {}", 
msg
)

41 
StÜeLab–s
(
msg
: 
SŒšg
) {

42 
desütiÚ
(
msg
)

43 
di¥Ïy
("¡ÜÏb–ƒ¼Ü: {}", 
msg
)

45 
V®ue
(
msg
: 
SŒšg
) {

46 
desütiÚ
(
msg
)

47 
di¥Ïy
("cÚfig v®u”rÜ: {}", 
msg
)

52 
pub
 
mod
 
	gcom´essiÚ_ty³_Ëv–_£rde
 {

53 
u£
 
	g¡d
::
fmt
;

55 
u£
 
	g£rde
::{
De£rŸliz”
, 
	gS”Ÿliz”
};

56 
u£
 
	g£rde
::
de
::{
E¼Ü
, 
	gSeqAcûss
, 
	gUÃx³ùed
, 
	gVis™Ü
};

57 
u£
 
	g£rde
::
£r
::
S”ŸlizeSeq
;

59 
u£
 
	grocksdb
::
DBCom´essiÚTy³
;

61 
pub
 
â
 
	g£rŸlize
<
	gS
>(
	gts
: &[
DBCom´essiÚTy³
; 7], 
	g£rŸliz”
: 
S
è-> 
ResuÉ
<S::
Ok
, S::
E¼Ü
>

62 
wh”e


63 
S
: 
S”Ÿliz”
,

65 
Ët
 
mut
 
	gs
 = 
£rŸliz”
.
£rŸlize_£q
(
Some
(
ts
.
Ën
()))?;

66 
t
 
š
 
	gts
 {

67 
Ët
 
	gÇme
 = 
m©ch
 *
t
 {

68 
DBCom´essiÚTy³
::
No
 => "no",

69 
	gDBCom´essiÚTy³
::
SÇµy
 => "snappy",

70 
	gDBCom´essiÚTy³
::
Zlib
 => "zlib",

71 
	gDBCom´essiÚTy³
::
Bz2
 => "bzip2",

72 
	gDBCom´essiÚTy³
::
Lz4
 => "lz4",

73 
	gDBCom´essiÚTy³
::
Lz4hc
 => "lz4hc",

74 
	gDBCom´essiÚTy³
::
Z¡d
 => "zstd",

75 
	gDBCom´essiÚTy³
::
Z¡dNÙFš®
 => "zstd-not-final",

76 
	gDBCom´essiÚTy³
::
Di§bË
 => "disable",

78 
	gs
.
£rŸlize_–em’t
(
Çme
)?;

80 
	gs
.
’d
()

83 
pub
 
â
 
	gde£rŸlize
<'de, D>(deserializer: D) -> Result<[DBCompressionType; 7], D::Error>

84 
wh”e


85 
	gD
: 
De£rŸliz”
<'de>,

87 
SeqVis™Ü
;

88 
	gim¶
<'de> Vis™Ü<'
	gde
> 
	gSeqVis™Ü
 {

89 
ty³
 
	gV®ue
 = [
DBCom´essiÚTy³
; 7];

91 
â
 
ex³ùšg
(&
£lf
, 
fÜm©‹r
: &
mut
 
fmt
::
FÜm©‹r
è-> fmt::
ResuÉ
 {

92 
wr™e
!(
fÜm©‹r
, "a compressionype vector")

95 
â
 
	gvis™_£q
<
	gS
>(
	g£lf
, 
mut
 
	g£q
: 
S
è-> 
ResuÉ
<[
DBCom´essiÚTy³
; 7], S::
E¼Ü
>

96 
wh”e


97 
S
: 
SeqAcûss
<'de>,

99 
Ët
 
mut
 
£qs
 = [
DBCom´essiÚTy³
::
No
; 7];

100 
Ët
 
mut
 
	gi
 = 0;

101 
Ët
 
Some
(
v®ue
èğ
£q
.
Ãxt_–em’t
::<
SŒšg
>()? {

102 
i
 == 7 {

103  
E¼
(
S
::
E¼Ü
::
šv®id_v®ue
(

104 
UÃx³ùed
::
SŒ
(&
v®ue
),

108 
	g£qs
[
i
] = 
m©ch
 &*
v®ue
.
Œim
().
to_low”ÿ£
() {

109 "no" => 
DBCom´essiÚTy³
::
No
,

110 "¢­py" => 
DBCom´essiÚTy³
::
SÇµy
,

111 "zlib" => 
DBCom´essiÚTy³
::
Zlib
,

112 "bz2" => 
DBCom´essiÚTy³
::
Bz2
,

113 "lz4" => 
DBCom´essiÚTy³
::
Lz4
,

114 "lz4hc" => 
DBCom´essiÚTy³
::
Lz4hc
,

115 "z¡d" => 
DBCom´essiÚTy³
::
Z¡d
,

116 "z¡d-nÙ-fš®" => 
DBCom´essiÚTy³
::
Z¡dNÙFš®
,

117 "di§bË" => 
DBCom´essiÚTy³
::
Di§bË
,

118 
	g_
 => {

119  
E¼
(
S
::
E¼Ü
::
šv®id_v®ue
(

120 
UÃx³ùed
::
SŒ
(&
v®ue
),

125 
	gi
 += 1;

127 
	gi
 < 7 {

128  
E¼
(
S
::
E¼Ü
::
šv®id_Ëngth
(
i
, &"7 compressionypes"));

130 
Ok
(
£qs
)

134 
	gde£rŸliz”
.
de£rŸlize_£q
(
SeqVis™Ü
)

138 
pub
 
mod
 
	gÜd”_m­_£rde
 {

139 
u£
 
	g¡d
::
fmt
;

140 
u£
 
	g¡d
::
hash
::
Hash
;

141 
u£
 
	g¡d
::
m¬k”
::
PhªtomD©a
;

143 
u£
 
	g£rde
::{
De£rŸlize
, 
	gDe£rŸliz”
, 
	gS”Ÿlize
, 
	gS”Ÿliz”
};

144 
u£
 
	g£rde
::
de
::{
M­Acûss
, 
	gVis™Ü
};

145 
u£
 
	g£rde
::
£r
::
S”ŸlizeM­
;

147 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

149 
pub
 
â
 
	g£rŸlize
<
	gS
, 
	gK
, 
	gV
>(
	gm
: &
HashM­
<
K
, V>, 
	g£rŸliz”
: 
S
è-> 
ResuÉ
<S::
Ok
, S::
E¼Ü
>

150 
wh”e


151 
S
: 
S”Ÿliz”
,

152 
	gK
: 
S”Ÿlize
 + 
Hash
 + 
Eq
,

153 
	gV
: 
S”Ÿlize
,

155 
Ët
 
mut
 
	gs
 = 
£rŸliz”
.
£rŸlize_m­
(
Some
(
m
.
Ën
()))?;

156 
	gk
, 
	gv
è
š
 
	gm
 {

157 
	gs
.
£rŸlize_’Œy
(
k
, 
v
)?;

159 
	gs
.
’d
()

162 
pub
 
â
 
	gde£rŸlize
<'de, D, K, V>(deserializer: D) -> Result<HashMap<K, V>, D::Error>

163 
wh”e


164 
	gD
: 
De£rŸliz”
<'de>,

165 
K
: 
De£rŸlize
<'de> + Eq + Hash,

166 
V
: 
De£rŸlize
<'de>,

168 
M­Vis™Ü
<
K
, 
	gV
> {

169 
	gphªtom
: 
PhªtomD©a
<
HashM­
<
K
, 
	gV
>>,

172 
	gim¶
<'de, K, V> Vis™Ü<'
	gde
> 
	gM­Vis™Ü
<
	gK
, 
	gV
>

173 
wh”e


174 
	gK
: 
De£rŸlize
<'de> + Eq + Hash,

175 
V
: 
De£rŸlize
<'de>,

177 
ty³
 
V®ue
 = 
HashM­
<
K
, 
	gV
>;

179 
â
 
ex³ùšg
(&
£lf
, 
fÜm©‹r
: &
mut
 
fmt
::
FÜm©‹r
è-> fmt::
ResuÉ
 {

180 
fÜm©‹r
.
wr™e_¡r
("a map")

183 
â
 
vis™_m­
<
M
>(
£lf
, 
mut
 
	gacûss
: Mè-> 
ResuÉ
<
S–f
::
V®ue
, 
	gM
::
E¼Ü
>

184 
wh”e


185 
M
: 
M­Acûss
<'de>,

187 
Ët
 
mut
 
m­
 = 
HashM­
::
w™h_ÿ·c™y_ªd_hash”
(

188 
acûss
.
size_hšt
().
unw¿p_Ü
(0),

189 
DeçuÉ
::(),

191 
Ët
 
Some
((
key
, 
v®ue
)èğ
acûss
.
Ãxt_’Œy
()? {

192 
m­
.
š£¹
(
key
, 
v®ue
);

194 
Ok
(
m­
)

198 
	gde£rŸliz”
.
de£rŸlize_m­
(
M­Vis™Ü
 {

199 
phªtom
: 
PhªtomD©a
,

204 
	gmaüo_ruËs
! 
	gnum”ic_’um_mod
 {

205 (
	g$Çme
:
id’t
 
$’um
:id’ˆ{ 
$
(
$v¬ŸÁ
:id’ˆğ
$v®ue
:
ex´
, )* }) => {

206 
pub
 
mod
 
$Çme
 {

207 
u£
 
¡d
::
fmt
;

209 
u£
 
	g£rde
::{
S”Ÿliz”
, 
	gDe£rŸliz”
};

210 
u£
 
	g£rde
::
de
::{
£lf
, 
	gUÃx³ùed
, 
	gVis™Ü
};

211 
u£
 
	grocksdb
::
$’um
;

213 
pub
 
â
 
	g£rŸlize
<
	gS
>(
	gmode
: &
$’um
, 
	g£rŸliz”
: 
S
è-> 
ResuÉ
<S::
Ok
, S::
E¼Ü
>

214 
wh”e
 
S
: 
S”Ÿliz”


216 
£rŸliz”
.
£rŸlize_i64
(*
mode
 
as
 
i64
)

219 
pub
 
â
 
de£rŸlize
<'de, D>(deserializer: D) -> Result<$enum, D::Error>

220 
wh”e
 
D
: 
De£rŸliz”
<'de>

222 
EnumVis™Ü
;

224 
	gim¶
<'de> Vis™Ü<'
	gde
> 
	gEnumVis™Ü
 {

225 
ty³
 
	gV®ue
 = 
$’um
;

227 
â
 
ex³ùšg
(&
£lf
, 
fÜm©‹r
: &
mut
 
fmt
::
FÜm©‹r
è-> fmt::
ResuÉ
 {

228 
wr™e
!(
fÜm©‹r
, 
	gcÚÿt
!("v®id ", 
	g¡ršgify
!(
	g$’um
)))

231 
â
 
	gvis™_i64
<
	gE
>(
	g£lf
, 
	gv®ue
: 
i64
è-> 
ResuÉ
<
$’um
, E>

232 
wh”e
 
	gE
: 
de
::
E¼Ü


234 
m©ch
 
v®ue
 {

235 
$
Ğ
$v®ue
 => 
Ok
(
$’um
::
$v¬ŸÁ
), )*

236 
	g_
 => 
E¼
(
E
::
šv®id_v®ue
(
UÃx³ùed
::
SigÃd
(
v®ue
), &
£lf
))

241 
	gde£rŸliz”
.
de£rŸlize_i64
(
EnumVis™Ü
)

244 #[
cfg
(
‹¡
)]

245 
mod
 
	g‹¡s
 {

246 
u£
 
	gtoml
;

247 
u£
 
	grocksdb
::
$’um
;

249 #[
‹¡
]

250 
â
 
‹¡_£rde
() {

251 #[
d”ive
(
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
)]

252 
	sEnumHŞd”
 {

253 #[
£rde
(
w™h
 = "super")]

254 
	ge
: 
$’um
,

257 
Ët
 
	gÿ£s
 = 
vec
![

258 
$
((
$’um
::
$v¬ŸÁ
, 
$v®ue
), )*

260 
	ge
, 
	gv
è
š
 
	gÿ£s
 {

261 
Ët
 
	ghŞd”
 = 
EnumHŞd”
 { 
e
 };

262 
Ët
 
	g»s
 = 
toml
::
to_¡ršg
(&
hŞd”
).
unw¿p
();

263 
Ët
 
	gexp
 = 
fÜm©
!("ğ{}\n", 
	gv
);

264 
	gas£¹_eq
!(
	g»s
, 
	gexp
);

265 
Ët
 
	gh
: 
EnumHŞd”
 = 
toml
::
äom_¡r
(&
exp
).
unw¿p
();

266 
	gas£¹
!(
	gh
 =ğ
hŞd”
);

274 
	gnum”ic_’um_mod
!{
com·ùiÚ_´i_£rde
 
	gCom·ùiÚPriÜ™y
 {

275 
	gByCom³n§‹dSize
 = 0,

276 
	gOlde¡L¬ge¡SeqFœ¡
 = 1,

277 
	gOlde¡Sm®Ë¡SeqFœ¡
 = 2,

278 
	gMšOv”ÏµšgR©io
 = 3,

281 
	gnum”ic_’um_mod
!{
»cov”y_mode_£rde
 
	gDBRecov”yMode
 {

282 
	gTŞ”©eCÜru±edTaRecÜds
 = 0,

283 
	gAbsŞu‹CÚsi¡’cy
 = 1,

284 
	gPoštInTime
 = 2,

285 
	gSkAnyCÜru±edRecÜds
 = 3,

288 cÚ¡ 
	gUNIT
: 
u64
 = 1;

289 cÚ¡ 
	gDATA_MAGNITUDE
: 
u64
 = 1024;

290 
pub
 cÚ¡ 
	gKB
: 
u64
 = 
UNIT
 * 
DATA_MAGNITUDE
;

291 
pub
 cÚ¡ 
	gMB
: 
u64
 = 
KB
 * 
DATA_MAGNITUDE
;

292 
pub
 cÚ¡ 
	gGB
: 
u64
 = 
MB
 * 
DATA_MAGNITUDE
;

295 cÚ¡ 
	gTB
: 
u64
 = (
GB
 
as
 u64è* (
DATA_MAGNITUDE
‡s u64);

296 cÚ¡ 
	gPB
: 
u64
 = (
TB
 
as
 u64è* (
DATA_MAGNITUDE
‡s u64);

298 cÚ¡ 
	gTIME_MAGNITUDE_1
: 
u64
 = 1000;

299 cÚ¡ 
	gTIME_MAGNITUDE_2
: 
u64
 = 60;

300 cÚ¡ 
	gMS
: 
u64
 = 
UNIT
;

301 cÚ¡ 
	gSECOND
: 
u64
 = 
MS
 * 
TIME_MAGNITUDE_1
;

302 cÚ¡ 
	gMINUTE
: 
u64
 = 
SECOND
 * 
TIME_MAGNITUDE_2
;

303 cÚ¡ 
	gHOUR
: 
u64
 = 
MINUTE
 * 
TIME_MAGNITUDE_2
;

305 #[
d”ive
(
ClÚe
, 
Debug
, 
Cİy
, 
P¬tŸlEq
)]

306 
pub
 
R—dabËSize
Õub 
u64
);

308 
im¶
 
	gR—dabËSize
 {

309 
pub
 
â
 
kb
(
couÁ
: 
u64
è-> 
R—dabËSize
 {

310 
R—dabËSize
(
couÁ
 * 
KB
)

313 
pub
 
â
 
mb
(
couÁ
: 
u64
è-> 
R—dabËSize
 {

314 
R—dabËSize
(
couÁ
 * 
MB
)

317 
pub
 
â
 
gb
(
couÁ
: 
u64
è-> 
R—dabËSize
 {

318 
R—dabËSize
(
couÁ
 * 
GB
)

321 
pub
 
â
 
as_mb
(&
£lf
è-> 
u64
 {

322 
£lf
.0 / 
MB


326 
im¶
 
Div
<
u64
> 
R—dabËSize
 {

327 
ty³
 
Ouut
 = 
R—dabËSize
;

329 
â
 
div
(
£lf
, 
rhs
: 
u64
è-> 
R—dabËSize
 {

330 
R—dabËSize
(
£lf
.0 / 
rhs
)

334 
im¶
 
Div
<
R—dabËSize
> ReadableSize {

335 
ty³
 
Ouut
 = 
u64
;

337 
â
 
div
(
£lf
, 
rhs
: 
R—dabËSize
è-> 
u64
 {

338 
£lf
.0 / 
rhs
.0

342 
im¶
 
Mul
<
u64
> 
R—dabËSize
 {

343 
ty³
 
Ouut
 = 
R—dabËSize
;

345 
â
 
mul
(
£lf
, 
rhs
: 
u64
è-> 
R—dabËSize
 {

346 
R—dabËSize
(
£lf
.0 * 
rhs
)

350 
im¶
 
S”Ÿlize
 
R—dabËSize
 {

351 
â
 
£rŸlize
<
S
>(&
£lf
, 
	g£rŸliz”
: Sè-> 
ResuÉ
<S::
Ok
, 
	gS
::
E¼Ü
>

352 
wh”e


353 
S
: 
S”Ÿliz”
,

355 
Ët
 
	gsize
 = 
£lf
.0;

356 
Ët
 
mut
 
	gbufãr
 = 
SŒšg
::
Ãw
();

357 
	gsize
 == 0 {

358 
wr™e
!(
bufãr
, "{}KB", 
size
).
unw¿p
();

359 } 
	gsize
 % 
	gPB
 == 0 {

360 
wr™e
!(
bufãr
, "{}PB", 
size
 / 
PB
).
unw¿p
();

361 } 
	gsize
 % 
	gTB
 == 0 {

362 
wr™e
!(
bufãr
, "{}TB", 
size
 / 
TB
).
unw¿p
();

363 } 
	gsize
 % 
GB
 
as
 
	gu64
 == 0 {

364 
wr™e
!(
bufãr
, "{}GB", 
size
 / 
GB
).
unw¿p
();

365 } 
	gsize
 % 
MB
 
as
 
	gu64
 == 0 {

366 
wr™e
!(
bufãr
, "{}MB", 
size
 / 
MB
).
unw¿p
();

367 } 
	gsize
 % 
KB
 
as
 
	gu64
 == 0 {

368 
wr™e
!(
bufãr
, "{}KB", 
size
 / 
KB
).
unw¿p
();

370  
	g£rŸliz”
.
£rŸlize_u64
(
size
);

372 
	g£rŸliz”
.
£rŸlize_¡r
(&
bufãr
)

376 
im¶
 
FromSŒ
 
	gR—dabËSize
 {

377 
ty³
 
	gE¼
 = 
SŒšg
;

379 
â
 
äom_¡r
(
s
: &
¡r
è-> 
ResuÉ
<
R—dabËSize
, 
	gSŒšg
> {

380 
Ët
 
	gsize_¡r
 = 
s
.
Œim
();

381 
	gsize_¡r
.
is_em±y
() {

382  
E¼
(
fÜm©
!("{:?} i nÙ‡ v®id size.", 
s
));

385 !
	gsize_¡r
.
is_ascii
() {

386  
E¼
(
fÜm©
!("ASCII sŒšg i ex³ùed, buˆgÙ {:?}", 
s
));

389 
Ët
 
mut
 
	gchrs
 = 
size_¡r
.
ch¬s
();

390 
Ët
 
mut
 
	gnumb”_¡r
 = 
size_¡r
;

391 
Ët
 
mut
 
	gun™_ch¬
 = 
chrs
.
Ãxt_back
().
unw¿p
();

392 
	gun™_ch¬
 < '0' || unit_char > '9' {

393 
	gnumb”_¡r
 = 
chrs
.
as_¡r
();

394 
	gun™_ch¬
 == 'B' {

395 
Ët
 
b
 = 
m©ch
 
chrs
.
Ãxt_back
() {

396 
Some
(
b
) => b,

397 
	gNÚe
 =>  
E¼
(
fÜm©
!("num”iøv®ui ex³ùed: {:?}", 
s
)),

399 
	gb
 < '0' || b > '9' {

400 
	gnumb”_¡r
 = 
chrs
.
as_¡r
();

401 
	gun™_ch¬
 = 
b
;

405 
	gun™_ch¬
 = 'B';

408 
Ët
 
	gun™
 = 
m©ch
 
un™_ch¬
 {

409 'K' => 
KB
,

410 'M' => 
MB
,

411 'G' => 
GB
,

412 'T' => 
TB
,

413 'P' => 
PB
,

414 'B' => 
UNIT
,

415 
	g_
 =>  
E¼
(
fÜm©
!("Úly B, KB, MB, GB, TB, PB‡» suµÜ‹d: {:?}", 
s
)),

417 
m©ch
 
	gnumb”_¡r
.
Œim
().
	g·r£
::<
f64
>() {

418 
Ok
(
n
è=> Ok(
R—dabËSize
(Ò * 
un™
 
as
 
f64
èa 
u64
)),

419 
E¼
(
_
è=> E¼(
fÜm©
!("šv®id siz¡ršg: {:?}", 
s
)),

424 
	gim¶
<'de> De£rŸlize<'
	gde
> 
	gR—dabËSize
 {

425 
â
 
	gde£rŸlize
<
	gD
>(
	gde£rŸliz”
: 
D
è-> 
ResuÉ
<
S–f
, D::
E¼Ü
>

426 
wh”e


427 
D
: 
De£rŸliz”
<'de>,

429 
SizeVis™Ü
;

431 
	gim¶
<'de> Vis™Ü<'
	gde
> 
	gSizeVis™Ü
 {

432 
ty³
 
	gV®ue
 = 
R—dabËSize
;

434 
â
 
ex³ùšg
(&
£lf
, 
fÜm©‹r
: &
mut
 
fmt
::
FÜm©‹r
è-> fmt::
ResuÉ
 {

435 
fÜm©‹r
.
wr™e_¡r
("valid size")

438 
â
 
vis™_i64
<
E
>(
£lf
, 
	gsize
: 
i64
è-> 
ResuÉ
<
R—dabËSize
, 
	gE
>

439 
wh”e


440 
	gE
: 
de
::
E¼Ü
,

442 
	gsize
 >= 0 {

443 
£lf
.
vis™_u64
(
size
 
as
 
u64
)

445 
E¼
(
E
::
šv®id_v®ue
(
UÃx³ùed
::
SigÃd
(
size
), &
£lf
))

449 
â
 
	gvis™_u64
<
	gE
>(
	g£lf
, 
	gsize
: 
u64
è-> 
ResuÉ
<
R—dabËSize
, E>

450 
wh”e


451 
	gE
: 
de
::
E¼Ü
,

453 
Ok
(
R—dabËSize
(
size
))

456 
â
 
	gvis™_¡r
<
	gE
>(
	g£lf
, 
	gsize_¡r
: &
¡r
è-> 
ResuÉ
<
R—dabËSize
, E>

457 
wh”e


458 
	gE
: 
de
::
E¼Ü
,

460 
	gsize_¡r
.
·r£
().
m­_”r
(
E
::
cu¡om
)

464 
de£rŸliz”
.
de£rŸlize_ªy
(
SizeVis™Ü
)

468 #[
d”ive
(
ClÚe
, 
Debug
, 
P¬tŸlEq
)]

469 
pub
 
R—dabËDu¿tiÚ
Õub 
Du¿tiÚ
);

471 
im¶
 
	gR—dabËDu¿tiÚ
 {

472 
pub
 
â
 
£cs
(£cs: 
u64
è-> 
R—dabËDu¿tiÚ
 {

473 
R—dabËDu¿tiÚ
(
Du¿tiÚ
::
Ãw
(
£cs
, 0))

476 
pub
 
â
 
mlis
(mlis: 
u64
è-> 
R—dabËDu¿tiÚ
 {

477 
R—dabËDu¿tiÚ
(
Du¿tiÚ
::
Ãw
(

478 
mlis
 / 1000,

479 (
mlis
 % 1000è
as
 
u32
 * 1
_000_000
,

483 
pub
 
â
 
mšu‹s
(mšu‹s: 
u64
è-> 
R—dabËDu¿tiÚ
 {

484 
R—dabËDu¿tiÚ
::
£cs
(
mšu‹s
 * 60)

487 
pub
 
â
 
hours
(hours: 
u64
è-> 
R—dabËDu¿tiÚ
 {

488 
R—dabËDu¿tiÚ
::
mšu‹s
(
hours
 * 60)

491 
pub
 
â
 
as_£cs
(&
£lf
è-> 
u64
 {

492 
£lf
.0.a
s_£cs
()

495 
pub
 
â
 
as_mlis
(&
£lf
è-> 
u64
 {

496 
ut
::
time
::
du¿tiÚ_to_ms
(
£lf
.0)

500 
im¶
 
S”Ÿlize
 
R—dabËDu¿tiÚ
 {

501 
â
 
£rŸlize
<
S
>(&
£lf
, 
	g£rŸliz”
: Sè-> 
ResuÉ
<S::
Ok
, 
	gS
::
E¼Ü
>

502 
wh”e


503 
S
: 
S”Ÿliz”
,

505 
Ët
 
mut
 
	gdur
 = 
ut
::
time
::
du¿tiÚ_to_ms
(
£lf
.0);

506 
Ët
 
mut
 
	gbufãr
 = 
SŒšg
::
Ãw
();

507 
	gdur
 >ğ
HOUR
 {

508 
wr™e
!(
bufãr
, "{}h", 
dur
 / 
HOUR
).
unw¿p
();

509 
	gdur
 %ğ
HOUR
;

511 
	gdur
 >ğ
MINUTE
 {

512 
wr™e
!(
bufãr
, "{}m", 
dur
 / 
MINUTE
).
unw¿p
();

513 
	gdur
 %ğ
MINUTE
;

515 
	gdur
 >ğ
SECOND
 {

516 
wr™e
!(
bufãr
, "{}s", 
dur
 / 
SECOND
).
unw¿p
();

517 
	gdur
 %ğ
SECOND
;

519 
	gdur
 > 0 {

520 
	gwr™e
!(
	gbufãr
, "{}ms", 
	gdur
).
unw¿p
();

522 
	gbufãr
.
is_em±y
(è&& 
	gdur
 == 0 {

523 
wr™e
!(
bufãr
, "0s").
unw¿p
();

525 
	g£rŸliz”
.
£rŸlize_¡r
(&
bufãr
)

529 
	gim¶
<'de> De£rŸlize<'
	gde
> 
	gR—dabËDu¿tiÚ
 {

530 
â
 
	gde£rŸlize
<
	gD
>(
	gde£rŸliz”
: 
D
è-> 
ResuÉ
<
S–f
, D::
E¼Ü
>

531 
wh”e


532 
D
: 
De£rŸliz”
<'de>,

534 
DurVis™Ü
;

536 
	gim¶
<'de> Vis™Ü<'
	gde
> 
	gDurVis™Ü
 {

537 
ty³
 
	gV®ue
 = 
R—dabËDu¿tiÚ
;

539 
â
 
ex³ùšg
(&
£lf
, 
fÜm©‹r
: &
mut
 
fmt
::
FÜm©‹r
è-> fmt::
ResuÉ
 {

540 
fÜm©‹r
.
wr™e_¡r
("valid duration")

543 
â
 
vis™_¡r
<
E
>(
£lf
, 
	gdur_¡r
: &
¡r
è-> 
ResuÉ
<
R—dabËDu¿tiÚ
, 
	gE
>

544 
wh”e


545 
	gE
: 
de
::
E¼Ü
,

547 
Ët
 
	gdur_¡r
 = 
dur_¡r
.
Œim
();

548 !
	gdur_¡r
.
is_ascii
() {

549  
E¼
(
E
::
šv®id_v®ue
(
UÃx³ùed
::
SŒ
(
dur_¡r
), &"ascii string"));

551 
Ët
 
	g”r_msg
 = "valid duration, only h, m, s, ms‡re supported.";

552 
Ët
 
mut
 
	gËá
 = 
dur_¡r
.
as_by‹s
();

553 
Ët
 
mut
 
	gÏ¡_un™
 = 
HOUR
 + 1;

554 
Ët
 
mut
 
	gdur
 = 0f64;

555 
Ët
 
Some
(
idx
èğ
Ëá
.
™”
().
pos™iÚ
(|
c
| 
b
"hms".
cÚšs
(c)) {

556 
Ët
 (
fœ¡
, 
£cÚd
èğ
Ëá
.
¥l™_©
(
idx
);

557 
Ët
 
	gun™
 = 
£cÚd
.
¡¬ts_w™h
(
b
"ms") {

558 
Ëá
 = &Ëá[
idx
 + 2..];

559 
	gMS


561 
Ët
 
	gu
 = 
m©ch
 
£cÚd
[0] {

562 
b
'h' => 
HOUR
,

563 
	gb
'm' => 
MINUTE
,

564 
	gb
's' => 
SECOND
,

565 
	g_
 =>  
E¼
(
E
::
šv®id_v®ue
(
UÃx³ùed
::
SŒ
(
dur_¡r
), &
”r_msg
)),

567 
	gËá
 = &
Ëá
[
idx
 + 1..];

568 
	gu


570 
	gun™
 >ğ
Ï¡_un™
 {

571  
E¼
(
E
::
šv®id_v®ue
(

572 
UÃx³ùed
::
SŒ
(
dur_¡r
),

577 
Ët
 
	gnumb”_¡r
 = 
un§ã
 { 
¡r
::
äom_utf8_unchecked
(
fœ¡
) };

578 
	gdur
 +ğ
m©ch
 
numb”_¡r
.
Œim
().
·r£
::<
f64
>() {

579 
Ok
(
n
è=>‚ * 
un™
 
as
 
f64
,

580 
E¼
(
_
è=>  E¼(
E
::
šv®id_v®ue
(
UÃx³ùed
::
SŒ
(
dur_¡r
), &
”r_msg
)),

582 
	gÏ¡_un™
 = 
un™
;

584 !
	gËá
.
is_em±y
() {

585  
E¼
(
E
::
šv®id_v®ue
(
UÃx³ùed
::
SŒ
(
dur_¡r
), &
”r_msg
));

587 
	gdur
.
is_sign_Ãg©ive
() {

588  
E¼
(
E
::
šv®id_v®ue
(

589 
UÃx³ùed
::
SŒ
(
dur_¡r
),

593 
Ët
 
	g£cs
 = 
dur
 
as
 
u64
 / 
SECOND
‡s u64;

594 
Ët
 
	gmlis
 = (
dur
 
as
 
u64
 % 
SECOND
‡ u64èa 
u32
 * 1
_000_000
;

595 
Ok
(
R—dabËDu¿tiÚ
(
Du¿tiÚ
::
Ãw
(
£cs
, 
mlis
)))

599 
	gde£rŸliz”
.
de£rŸlize_¡r
(
DurVis™Ü
)

603 
pub
 
â
 
ÿnÚiÿlize_·th
(
·th
: &
¡r
è-> 
ResuÉ
<
SŒšg
, 
	gBox
<
	gE¼Ü
>> {

604 
ÿnÚiÿlize_sub_·th
(
·th
, "")

607 
pub
 
â
 
ÿnÚiÿlize_sub_·th
(
·th
: &
¡r
, 
sub_·th
: &¡rè-> 
ResuÉ
<
SŒšg
, 
	gBox
<
	gE¼Ü
>> {

608 
Ët
 
	g·»Á
 = 
P©h
::
Ãw
(
·th
);

609 
Ët
 
	gp
 = 
·»Á
.
još
(
P©h
::
Ãw
(
sub_·th
));

610 
	gp
.
exi¡s
(è&&….
is_fe
() {

611  
E¼
(
fÜm©
!("{}/{} i nÙ‡ dœeùÜy!", 
·th
, 
sub_·th
).
što
());

613 !
	gp
.
exi¡s
() {

614 
	gfs
::
ü—‹_dœ_®l
(
p
.
as_·th
())?;

616 
Ok
(
fÜm©
!("{}", 
p
.
ÿnÚiÿlize
()?.
di¥Ïy
()))

619 #[
cfg
(
unix
)]

620 
pub
 
â
 
check_max_İ’_fds
(
ex³ù
: 
u64
è-> 
ResuÉ
<(), 
	gCÚfigE¼Ü
> {

621 
u£
 
	g¡d
::
mem
;

622 
u£
 
	glibc
;

624 
	gun§ã
 {

625 
Ët
 
mut
 
	gfd_lim™
 = 
mem
::
z”Ûd
();

626 
Ët
 
mut
 
	g”r
 = 
libc
::
g‘¾im™
Öibc::
RLIMIT_NOFILE
, &muˆ
fd_lim™
);

627 
	g”r
 != 0 {

628  
E¼
(
CÚfigE¼Ü
::
Lim™
("check_max_İ’_fd çed".
to_owÃd
()));

630 
	gfd_lim™
.
	g¾im_cur
 >ğ
ex³ù
 {

631  
Ok
(());

634 
Ët
 
	g´ev_lim™
 = 
fd_lim™
.
¾im_cur
;

635 
	gfd_lim™
.
	g¾im_cur
 = 
ex³ù
;

636 
	gfd_lim™
.
	g¾im_max
 < 
	gex³ù
 {

638 
	gfd_lim™
.
	g¾im_max
 = 
ex³ù
;

640 
	g”r
 = 
libc
::
£Œlim™
Öibc::
RLIMIT_NOFILE
, &
fd_lim™
);

641 
	g”r
 == 0 {

642  
Ok
(());

644 
E¼
(
CÚfigE¼Ü
::
Lim™
(
fÜm©
!(

647 
´ev_lim™
,

648 
ex³ù


653 #[
cfg
(
nÙ
(
unix
))]

654 
pub
 
â
 
check_max_İ’_fds
(
_
: 
u64
è-> 
ResuÉ
<(), 
	gCÚfigE¼Ü
> {

655 
Ok
(())

658 #[
cfg
(
rg‘_os
 = "linux")]

659 
mod
 
	gcheck_k”Ãl
 {

660 
u£
 
	g¡d
::
fs
;

661 
u£
 
	g¡d
::
io
::
R—d
;

663 
u£
 
	gsu³r
::
CÚfigE¼Ü
;

666 
pub
 
ty³
 
	gCheck”
 = 
Fn
(
i64
, i64è-> 
	gboŞ
;

669 
pub
 
â
 
check_k”Ãl_·¿ms
(

670 
·¿m_·th
: &
¡r
,

671 
ex³ù
: 
i64
,

672 
check”
: 
Box
<
Check”
>,

673 è-> 
	gResuÉ
<(), 
	gCÚfigE¼Ü
> {

674 
Ët
 
mut
 
	gbufãr
 = 
SŒšg
::
Ãw
();

675 
	gfs
::
Fe
::
İ’
(
·¿m_·th
)

676 .
ªd_th’
(|
mut
 
f
| f.
»ad_to_¡ršg
(&muˆ
bufãr
))

677 .
m­_”r
(|
e
| {

678 
CÚfigE¼Ü
::
Lim™
(
fÜm©
!("check_k”Ãl_·¿m çed {}", 
e
))

681 
Ët
 
	ggÙ
 = 
bufãr


682 .
Œim_m©ches
('\n')

683 .
·r£
::<
i64
>()

684 .
m­_”r
(|
e
| {

685 
CÚfigE¼Ü
::
Lim™
(
fÜm©
!("check_k”Ãl_·¿m çed {}", 
e
))

688 
Ët
 
mut
 
	g·¿m
 = 
SŒšg
::
Ãw
();

690 
·th
 
š
 
	g·¿m_·th
.
¥l™
('/').
sk
(3) {

691 
	g·¿m
.
push_¡r
(
·th
);

692 
	g·¿m
.
push
('.');

694 
	g·¿m
.
pİ
();

696 !
check”
(
gÙ
, 
ex³ù
) {

697  
E¼
(
CÚfigE¼Ü
::
Lim™
(
fÜm©
!(

699 
·¿m
,

700 
gÙ
,

701 
ex³ù


705 
	gšfo
!("k”ÃÈ·¿m‘” {}: {}", 
	g·¿m
, 
	ggÙ
);

706 
Ok
(())

715 
pub
 
â
 
check_k”Ãl
(è-> 
	gVec
<
	gCÚfigE¼Ü
> {

716 
Ët
 
	g·¿ms
: 
Vec
<(&
¡r
, 
	gi64
, 
	gBox
<
	gCheck”
>)> = 
vec
![

718 ("/´oc/sys/Ãt/cÜe/somaxcÚn", 32768, 
box
 |
gÙ
, 
ex³ù
| {

719 
gÙ
 >ğ
ex³ù


722 ("/´oc/sys/Ãt/v4/tı_syncook›s", 0, 
box
 |
gÙ
, 
ex³ù
| {

723 
gÙ
 =ğ
ex³ù


729 
box
 |
gÙ
, 
ex³ù
| got ==ƒxpect,

733 
Ët
 
mut
 
	g”rÜs
 = 
Vec
::
w™h_ÿ·c™y
(
·¿ms
.
Ën
());

734 
	g·¿m_·th
, 
	gex³ù
, 
	gcheck”
è
š
 
	g·¿ms
 {

735 
Ët
 
E¼
(
e
èğ
check_k”Ãl_·¿ms
(
·¿m_·th
, 
ex³ù
, 
check”
) {

736 
	g”rÜs
.
push
(
e
);

740 
	g”rÜs


744 #[
cfg
(
rg‘_os
 = "linux")]

745 
pub
 
u£
 
	g£lf
::
check_k”Ãl
::check_kernel;

747 #[
cfg
(
nÙ
(
rg‘_os
 = "linux"))]

748 
pub
 
â
 
check_k”Ãl
(è-> 
	gVec
<
	gCÚfigE¼Ü
> {

749 
	gVec
::
Ãw
()

754 
pub
 
â
 
check_addr
(
addr
: &
¡r
è-> 
ResuÉ
<(), 
	gCÚfigE¼Ü
> {

756 
	gSock‘AddrV4
::
äom_¡r
(
addr
).
is_ok
() {

757  
Ok
(());

759 
	gSock‘AddrV6
::
äom_¡r
(
addr
).
is_ok
() {

760  
Ok
(());

763 
Ët
 
	g·¹s
: 
Vec
<&
¡r
> = 
addr
.
¥l™
(':')

764 .
f‹r
(|
s
| !s.
is_em±y
())

765 .
cŞËù
();

768 
	g·¹s
.
Ën
() != 2 {

769  
E¼
(
CÚfigE¼Ü
::
Add»ss
(
fÜm©
!("šv®id‡ddr: {:?}", 
addr
)));

773 
Ët
 
	gpÜt
: 
u16
 = 
·¹s
[1]

774 .
·r£
()

775 .
m­_”r
(|
_
| {

776 
CÚfigE¼Ü
::
Add»ss
(
fÜm©
!("šv®id‡ddr,…¬£…Üˆçed: {:?}", 
addr
))

779 
	gpÜt
 == 0 {

780  
E¼
(
CÚfigE¼Ü
::
Add»ss
(

781 
fÜm©
!("šv®id‡ddr,…ÜˆÿÀnÙ b0: {:?}", 
addr
),

786 
Ët
 
E¼
(
e
èğ
u¾
::
Ho¡
::
·r£
(
·¹s
[0]) {

787  
E¼
(
CÚfigE¼Ü
::
Add»ss
(
fÜm©
!("šv®id‡ddr: {:?}", 
e
)));

790 
Ok
(())

793 #[
cfg
(
‹¡
)]

794 
mod
 
	g‹¡
 {

795 
u£
 
	g¡d
::
fs
::
Fe
;

796 
u£
 
	g¡d
::
·th
::
P©h
;

798 
u£
 
	gsu³r
::*;

800 
u£
 
	grocksdb
::
DBCom´essiÚTy³
;

801 
u£
 
	g‹mpdœ
::
TempDœ
;

802 
u£
 
	gtoml
;

804 
u£
 
	gut
::
cŞËùiÚs
::
HashM­
;

806 #[
‹¡
]

807 
â
 
‹¡_»adabË_size
() {

808 
Ët
 
	gs
 = 
R—dabËSize
::
kb
(2);

809 
	gas£¹_eq
!(
	gs
.0, 2048);

810 
	gas£¹_eq
!(
	gs
.
as_mb
(), 0);

811 
Ët
 
	gs
 = 
R—dabËSize
::
mb
(2);

812 
	gas£¹_eq
!(
	gs
.0, 2 * 1024 * 1024);

813 
	gas£¹_eq
!(
	gs
.
as_mb
(), 2);

814 
Ët
 
	gs
 = 
R—dabËSize
::
gb
(2);

815 
	gas£¹_eq
!(
	gs
.0, 2 * 1024 * 1024 * 1024);

816 
	gas£¹_eq
!(
	gs
.
as_mb
(), 2048);

818 
	gas£¹_eq
!((
	gR—dabËSize
::
mb
(2è/ 2).0, 
	gMB
);

819 
	gas£¹_eq
!((
	gR—dabËSize
::
mb
(1è/ 2).0, 512 * 
	gKB
);

820 
	gas£¹_eq
!(
	gR—dabËSize
::
mb
(2è/ 
R—dabËSize
::
kb
(1), 2048);

823 #[
‹¡
]

824 
â
 
‹¡_·r£_»adabË_size
() {

825 #[
d”ive
(
S”Ÿlize
, 
De£rŸlize
)]

826 
	sSizeHŞd”
 {

827 
	gs
: 
R—dabËSize
,

830 
Ët
 
	gËg®_ÿ£s
 = 
vec
![

832 (2 * 
KB
, "2KB"),

833 (4 * 
MB
, "4MB"),

834 (5 * 
GB
, "5GB"),

835 (7 * 
TB
, "7TB"),

836 (11 * 
PB
, "11PB"),

838 
	gsize
, 
	gexp
è
š
 
	gËg®_ÿ£s
 {

839 
Ët
 
	gc
 = 
SizeHŞd”
 {

840 
s
: 
R—dabËSize
(
size
),

842 
Ët
 
	g»s_¡r
 = 
toml
::
to_¡ršg
(&
c
).
unw¿p
();

843 
Ët
 
	gexp_¡r
 = 
fÜm©
!(" ğ{:?}\n", 
	gexp
);

844 
	gas£¹_eq
!(
	g»s_¡r
, 
	gexp_¡r
);

845 
Ët
 
	g»s_size
: 
SizeHŞd”
 = 
toml
::
äom_¡r
(&
exp_¡r
).
unw¿p
();

846 
	gas£¹_eq
!(
	g»s_size
.
	gs
.0, 
	gsize
);

849 
Ët
 
	gc
 = 
SizeHŞd”
 {

850 
s
: 
R—dabËSize
(512),

852 
Ët
 
	g»s_¡r
 = 
toml
::
to_¡ršg
(&
c
).
unw¿p
();

853 
	gas£¹_eq
!(
	g»s_¡r
, "s = 512\n");

854 
Ët
 
	g»s_size
: 
SizeHŞd”
 = 
toml
::
äom_¡r
(&
»s_¡r
).
unw¿p
();

855 
	gas£¹_eq
!(
	g»s_size
.
	gs
.0, 
	gc
.s.0);

857 
Ët
 
	gdecode_ÿ£s
 = 
vec
![

858 (" 0.5 PB", 
PB
 / 2),

859 ("0.5 TB", 
TB
 / 2),

860 ("0.5GB ", 
GB
 / 2),

861 ("0.5MB", 
MB
 / 2),

862 ("0.5KB", 
KB
 / 2),

863 ("0.5P", 
PB
 / 2),

864 ("0.5T", 
TB
 / 2),

865 ("0.5G", 
GB
 / 2),

866 ("0.5M", 
MB
 / 2),

867 ("0.5K", 
KB
 / 2),

870 ("1024B", 
KB
),

872 
	g¤c
, 
	gexp
è
š
 
	gdecode_ÿ£s
 {

873 
Ët
 
	g¤c
 = 
fÜm©
!("s = {:?}", src);

874 
Ët
 
	g»s
: 
SizeHŞd”
 = 
toml
::
äom_¡r
(&
¤c
).
unw¿p
();

875 
	gas£¹_eq
!(
	g»s
.
	gs
.0, 
	gexp
);

878 
Ët
 
	gËg®_ÿ£s
 = 
vec
![

889 
¤c
 
š
 
	gËg®_ÿ£s
 {

890 
Ët
 
	g¤c_¡r
 = 
fÜm©
!(" ğ{:?}", 
	g¤c
);

891 
	gas£¹
!(
	gtoml
::
äom_¡r
::<
SizeHŞd”
>(&
¤c_¡r
).
is_”r
(), "{}", 
	g¤c
);

895 #[
‹¡
]

896 
â
 
‹¡_·r£_hash_m­
() {

897 #[
d”ive
(
S”Ÿlize
, 
De£rŸlize
)]

898 
	sM­HŞd”
 {

899 #[
£rde
(
w™h
 = "super::order_map_serde")]

900 
	gm
: 
HashM­
<
SŒšg
, 
	gSŒšg
>,

903 
Ët
 
	gËg®_ÿ£s
 = 
vec
![

904 (
m­
![], ""),

905 (
	gm­
!["k1".
to_owÃd
() => "v1".to_owned()], "k1 = \"v1\"\n"),

908 
	g¤c
, 
	gexp
è
š
 
	gËg®_ÿ£s
 {

909 
Ët
 
	gm
 = 
M­HŞd”
 { 
m
: 
¤c
 };

910 
Ët
 
	g»s_¡r
 = 
toml
::
to_¡ršg
(&
m
).
unw¿p
();

911 
Ët
 
	gexp_¡r
 = 
fÜm©
!("[m]\n{}", 
	gexp
);

912 
	gas£¹_eq
!(
	g»s_¡r
, 
	gexp_¡r
);

913 
Ët
 
	gexp_m
: 
M­HŞd”
 = 
toml
::
äom_¡r
(&
exp_¡r
).
unw¿p
();

914 
	gas£¹_eq
!(
	gm
.m, 
	gexp_m
.m);

917 
Ët
 
	gm
: 
M­HŞd”
 = 
toml
::
äom_¡r
(
r
#"
m
 = {"k1" = "v1"}"#).unwrap();

918 
as£¹_eq
!(&
m
.m["k1"], "v1");

921 #[
‹¡
]

922 
â
 
‹¡_du¿tiÚ_cÚ¡ruùiÚ
() {

923 
Ët
 
mut
 
dur
 = 
R—dabËDu¿tiÚ
::
£cs
(1);

924 
as£¹_eq
!(
dur
.0, 
Du¿tiÚ
::
Ãw
(1, 0));

925 
as£¹_eq
!(
dur
.
as_£cs
(), 1);

926 
as£¹_eq
!(
dur
.
as_mlis
(), 1000);

927 
dur
 = 
R—dabËDu¿tiÚ
::
mlis
(1001);

928 
as£¹_eq
!(
dur
.0, 
Du¿tiÚ
::
Ãw
(1, 1
_000_000
));

929 
as£¹_eq
!(
dur
.
as_£cs
(), 1);

930 
as£¹_eq
!(
dur
.
as_mlis
(), 1001);

931 
dur
 = 
R—dabËDu¿tiÚ
::
mšu‹s
(2);

932 
as£¹_eq
!(
dur
.0, 
Du¿tiÚ
::
Ãw
(2 * 60, 0));

933 
as£¹_eq
!(
dur
.
as_£cs
(), 120);

934 
as£¹_eq
!(
dur
.
as_mlis
(), 120000);

935 
dur
 = 
R—dabËDu¿tiÚ
::
hours
(2);

936 
as£¹_eq
!(
dur
.0, 
Du¿tiÚ
::
Ãw
(2 * 3600, 0));

937 
as£¹_eq
!(
dur
.
as_£cs
(), 7200);

938 
as£¹_eq
!(
dur
.
as_mlis
(), 7200000);

941 #[
‹¡
]

942 
â
 
‹¡_·r£_»adabË_du¿tiÚ
() {

943 #[
d”ive
(
S”Ÿlize
, 
De£rŸlize
)]

944 
	sDurHŞd”
 {

945 
d
: 
R—dabËDu¿tiÚ
,

948 
Ët
 
Ëg®_ÿ£s
 = 
vec
![

957 
£cs
, 
ms
, 
exp
è
š
 
Ëg®_ÿ£s
 {

958 
Ët
 
d
 = 
DurHŞd”
 {

959 
d
: 
R—dabËDu¿tiÚ
(
Du¿tiÚ
::
Ãw
(
£cs
, 
ms
 * 1
_000_000
)),

961 
Ët
 
»s_¡r
 = 
toml
::
to_¡ršg
(&
d
).
unw¿p
();

962 
Ët
 
exp_¡r
 = 
fÜm©
!("d = {:?}\n", 
exp
);

963 
as£¹_eq
!(
»s_¡r
, 
exp_¡r
);

964 
Ët
 
»s_dur
: 
DurHŞd”
 = 
toml
::
äom_¡r
(&
exp_¡r
).
unw¿p
();

965 
as£¹_eq
!(
»s_dur
.
d
.0, d.d.0);

968 
Ët
 
decode_ÿ£s
 = 
vec
![(" 0.5 h2m ", 3600 / 2 + 2 * 60, 0)];

969 
¤c
, 
£cs
, 
ms
è
š
 
decode_ÿ£s
 {

970 
Ët
 
¤c
 = 
fÜm©
!("d = {:?}", src);

971 
Ët
 
»s
: 
DurHŞd”
 = 
toml
::
äom_¡r
(&
¤c
).
unw¿p
();

972 
as£¹_eq
!(
»s
.
d
.0, 
Du¿tiÚ
::
Ãw
(
£cs
, 
ms
 * 1
_000_000
));

975 
Ët
 
Ëg®_ÿ£s
 = 
vec
!["1H", "1M", "1S", "1MS", "1h1h", "h"];

976 
¤c
 
š
 
Ëg®_ÿ£s
 {

977 
Ët
 
¤c_¡r
 = 
fÜm©
!("d = {:?}", 
¤c
);

978 
as£¹
!(
toml
::
äom_¡r
::<
DurHŞd”
>(&
¤c_¡r
).
is_”r
(), "{}", 
¤c
);

980 
as£¹
!(
toml
::
äom_¡r
::<
DurHŞd”
>("d = 23").
is_”r
());

983 #[
‹¡
]

984 
â
 
‹¡_·r£_com´essiÚ_ty³
() {

985 #[
d”ive
(
S”Ÿlize
, 
De£rŸlize
)]

986 
	sCom´essiÚTy³HŞd”
 {

987 #[
£rde
(
w™h
 = "compression_type_level_serde")]

988 

: [
DBCom´essiÚTy³
; 7],

991 
Ët
 
®l_
 = 
vec
![

992 (
DBCom´essiÚTy³
::
No
, "no"),

993 (
DBCom´essiÚTy³
::
SÇµy
, "snappy"),

994 (
DBCom´essiÚTy³
::
Zlib
, "zlib"),

995 (
DBCom´essiÚTy³
::
Bz2
, "bzip2"),

996 (
DBCom´essiÚTy³
::
Lz4
, "lz4"),

997 (
DBCom´essiÚTy³
::
Lz4hc
, "lz4hc"),

998 (
DBCom´essiÚTy³
::
Z¡d
, "zstd"),

999 (
DBCom´essiÚTy³
::
Z¡dNÙFš®
, "zstd-not-final"),

1000 (
DBCom´essiÚTy³
::
Di§bË
, "disable"),

1002 
i
 
š
 0..®l
_
.
Ën
() - 7 {

1003 
Ët
 
mut
 
¤c
 = [
DBCom´essiÚTy³
::
No
; 7];

1004 
Ët
 
mut
 
exp
 = ["no"; 7];

1005 
i
, &
t
è
š
 
®l_
[i..˜+ 7].
™”
().
’um”©e
() {

1006 
¤c
[
i
] = 
t
.0;

1007 
exp
[
i
] = 
t
.1;

1009 
Ët
 
hŞd”
 = 
Com´essiÚTy³HŞd”
 { 

: 
¤c
 };

1010 
Ët
 
»s_¡r
 = 
toml
::
to_¡ršg
(&
hŞd”
).
unw¿p
();

1011 
Ët
 
exp_¡r
 = 
fÜm©
!(" = [\"{}\"]\n", 
exp
.
još
("\", \""));

1012 
as£¹_eq
!(
»s_¡r
, 
exp_¡r
);

1013 
Ët
 
h
: 
Com´essiÚTy³HŞd”
 = 
toml
::
äom_¡r
(&
exp_¡r
).
unw¿p
();

1014 
as£¹_eq
!(
h
.

, 
hŞd”
.tp);

1018 
as£¹
!(
toml
::
äom_¡r
::<
Com´essiÚTy³HŞd”
>(" = [\"no\"]").
is_”r
());

1019 
as£¹
!(

1020 
toml
::
äom_¡r
::<
Com´essiÚTy³HŞd”
>(

1021 
r
#"

 = [

1024 ).
is_”r
()

1027 
as£¹
!(

1028 
toml
::
äom_¡r
::<
Com´essiÚTy³HŞd”
>(

1029 
r
#"

 = [

1032 ).
is_”r
()

1036 #[
‹¡
]

1037 
â
 
‹¡_ÿnÚiÿlize_·th
() {

1038 
Ët
 
tmp_dœ
 = 
TempDœ
::
Ãw
("‹¡-ÿnÚiÿlize").
unw¿p
();

1039 
Ët
 
·th1
 = 
fÜm©
!(

1041 
tmp_dœ
.
·th
().
to_·th_buf
().
još
("‹¡1.dump").
di¥Ïy
()

1043 
Ët
 
»s_·th1
 = 
ÿnÚiÿlize_·th
(&
·th1
).
unw¿p
();

1044 
as£¹
!(
P©h
::
Ãw
(&
·th1
).
exi¡s
());

1045 
as£¹_eq
!(

1046 
P©h
::
Ãw
(&
»s_·th1
),

1047 
P©h
::
Ãw
(&
·th1
).
ÿnÚiÿlize
().
unw¿p
()

1050 
Ët
 
·th2
 = 
fÜm©
!(

1052 
tmp_dœ
.
·th
().
to_·th_buf
().
još
("‹¡2.dump").
di¥Ïy
()

1055 
Fe
::
ü—‹
(&
·th2
).
unw¿p
();

1057 
as£¹
!(
ÿnÚiÿlize_·th
(&
·th2
).
is_”r
());

1058 
as£¹
!(
P©h
::
Ãw
(&
·th2
).
exi¡s
());

1061 #[
cfg
(
rg‘_os
 = "linux")]

1062 #[
‹¡
]

1063 
â
 
‹¡_check_k”Ãl
() {

1064 
u£
 
¡d
::
i64
;

1065 
u£
 
su³r
::
check_k”Ãl
::{
check_k”Ãl_·¿ms
, 
Check”
};

1068 
Ët
 
bË
: 
Vec
<(&
¡r
, 
i64
, 
Box
<
Check”
>, 
boŞ
)> = 
vec
![

1071 
i64
::
MAX
,

1072 
Box
::
Ãw
(|
gÙ
, 
ex³ù
| got ==ƒxpect),

1073 
çl£
,

1078 
i64
::
MAX
,

1079 
Box
::
Ãw
(|
gÙ
, 
ex³ù
| got <ƒxpect),

1080 
Œue
,

1084 
·th
, 
ex³ù
, 
check”
, 
is_ok
è
š
 
bË
 {

1085 
as£¹_eq
!(
check_k”Ãl_·¿ms
(
·th
, 
ex³ù
, 
check”
).
is_ok
(), is_ok);

1089 #[
‹¡
]

1090 
â
 
‹¡_check_addrs
() {

1091 
Ët
 
bË
 = 
vec
![

1092 ("127.0.0.1:8080", 
Œue
),

1093 ("[::1]:8080", 
Œue
),

1094 ("loÿlho¡:8080", 
Œue
),

1095 ("pšgÿp.com:8080", 
Œue
),

1096 ("fuÂydomaš:8080", 
Œue
),

1098 ("127.0.0.1", 
çl£
),

1099 ("[::1]", 
çl£
),

1100 ("loÿlho¡", 
çl£
),

1101 ("pšgÿp.com", 
çl£
),

1102 ("fuÂydomaš", 
çl£
),

1103 ("fuÂydomaš:", 
çl£
),

1105 ("roÙ@googË.com:8080", 
çl£
),

1106 ("h‰p://googË.com:8080", 
çl£
),

1107 ("googË.com:8080/·th", 
çl£
),

1108 ("h‰p://googË.com:8080/·th", 
çl£
),

1109 ("h‰p://googË.com:8080/·th?Ïngón", 
çl£
),

1110 ("h‰p://googË.com:8080/·th?Ïngón#tİ", 
çl£
),

1112 ("áp://áp.is.co.za/rfc/rfc1808.txt", 
çl£
),

1113 ("h‰p://www.›tf.Üg/rfc/rfc2396.txt", 
çl£
),

1114 ("ld­://[2001:db8::7]/c=GB?objeùCÏss?Úe", 
çl£
),

1115 ("mato:John.DÛ@exam¶e.com", 
çl£
),

1116 ("Ãws:comp.šfosy¡ems.www.£rv”s.unix", 
çl£
),

1117 ("‹l:+1-816-555-1212", 
çl£
),

1118 ("‹Ê‘://192.0.2.16:80/", 
çl£
),

1119 ("uº:ßsis:Çmes:¥ecifiÿtiÚ:docbook:dtd:xml:4.1.2", 
çl£
),

1121 (":8080", 
çl£
),

1122 ("8080", 
çl£
),

1123 ("8080:", 
çl£
),

1126 
addr
, 
is_ok
è
š
 
bË
 {

1127 
as£¹_eq
!(
check_addr
(
addr
).
is_ok
(), is_ok);

	@src/util/file.rs

14 
u£
 
	g¡d
::
io
::{
£lf
, 
	gE¼ÜKšd
};

15 
u£
 
	g¡d
::
fs
;

16 
u£
 
	g¡d
::
·th
::{
P©h
, 
	gP©hBuf
};

18 
pub
 
â
 
g‘_fe_size
(
·th
: &
P©hBuf
è-> 
io
::
ResuÉ
<
u64
> {

19 
Ët
 
m‘a
 = 
fs
::
m‘ad©a
(
·th
)?;

20 
Ok
(
m‘a
.
Ën
())

23 
pub
 
â
 
fe_exi¡s
(
fe
: &
P©hBuf
è-> 
boŞ
 {

24 
Ët
 
·th
 = 
P©h
::
Ãw
(
fe
);

25 
	g·th
.
exi¡s
(è&&…©h.
is_fe
()

28 
pub
 
â
 
	$d–‘e_fe_if_exi¡
(
fe
: &
P©hBuf
) {

29 
m©ch
 
fs
::
	`»move_fe
(
fe
) {

30 
	`Ok
(
_
) => {}

31 
	`E¼
(
»f
 
e
èe.
	`kšd
(è=ğ
E¼ÜKšd
::
NÙFound
 => {}

32 
	`E¼
(
e
) => {

33 
w¬n
!("çedØd–‘f{}: {:?}", 
fe
.
	`di¥Ïy
(), 
e
);

36 
	}
}

38 #[
cfg
(
‹¡
)]

39 
mod
 
	g‹¡
 {

40 
u£
 
	g¡d
::
io
::
Wr™e
;

41 
u£
 
	g¡d
::
fs
::
O³nO±iÚs
;

42 
u£
 
	g‹mpdœ
::
TempDœ
;

44 
u£
 
	gsu³r
::*;

46 #[
‹¡
]

47 
â
 
‹¡_g‘_fe_size
() {

48 
Ët
 
	gtmp_dœ
 = 
TempDœ
::
Ãw
("").
unw¿p
();

49 
Ët
 
	gdœ_·th
 = 
tmp_dœ
.
·th
().
to_·th_buf
();

52 
Ët
 
	gem±y_fe
 = 
dœ_·th
.
još
("empty_file");

54 
Ët
 
	g_
 = 
O³nO±iÚs
::
Ãw
()

55 .
wr™e
(
Œue
)

56 .
ü—‹_Ãw
(
Œue
)

57 .
İ’
(&
em±y_fe
)

58 .
unw¿p
();

60 
	gas£¹_eq
!(
g‘_fe_size
(&
em±y_fe
).
unw¿p
(), 0);

63 
Ët
 
	gnÚ_em±y_fe
 = 
dœ_·th
.
još
("non_empty_file");

64 
Ët
 
	gsize
 = 5;

65 
Ët
 
	gv
 = 
vec
![0; 
size
];

67 
Ët
 
mut
 
	gf
 = 
O³nO±iÚs
::
Ãw
()

68 .
wr™e
(
Œue
)

69 .
ü—‹_Ãw
(
Œue
)

70 .
İ’
(&
nÚ_em±y_fe
)

71 .
unw¿p
();

72 
	gf
.
wr™e_®l
(&
v
[..]).
unw¿p
();

74 
	gas£¹_eq
!(
g‘_fe_size
(&
nÚ_em±y_fe
).
unw¿p
(), 
size
 
as
 
	gu64
);

77 
Ët
 
	gnÚ_exi¡’t_fe
 = 
dœ_·th
.
još
("non_existent_file");

78 
	gas£¹
!(
g‘_fe_size
(&
nÚ_exi¡’t_fe
).
is_”r
());

81 #[
‹¡
]

82 
â
 
‹¡_fe_exi¡s
() {

83 
Ët
 
	gtmp_dœ
 = 
TempDœ
::
Ãw
("").
unw¿p
();

84 
Ët
 
	gdœ_·th
 = 
tmp_dœ
.
·th
().
to_·th_buf
();

86 
	gas£¹_eq
!(
fe_exi¡s
(&
dœ_·th
), 
	gçl£
);

88 
Ët
 
	gexi¡’t_fe
 = 
dœ_·th
.
još
("empty_file");

90 
Ët
 
	g_
 = 
O³nO±iÚs
::
Ãw
()

91 .
wr™e
(
Œue
)

92 .
ü—‹_Ãw
(
Œue
)

93 .
İ’
(&
exi¡’t_fe
)

94 .
unw¿p
();

96 
	gas£¹_eq
!(
fe_exi¡s
(&
exi¡’t_fe
), 
	gŒue
);

98 
Ët
 
	gnÚ_exi¡’t_fe
 = 
dœ_·th
.
još
("non_existent_file");

99 
	gas£¹_eq
!(
fe_exi¡s
(&
nÚ_exi¡’t_fe
), 
	gçl£
);

102 #[
‹¡
]

103 
â
 
‹¡_d–‘e_fe_if_exi¡
() {

104 
Ët
 
	gtmp_dœ
 = 
TempDœ
::
Ãw
("").
unw¿p
();

105 
Ët
 
	gdœ_·th
 = 
tmp_dœ
.
·th
().
to_·th_buf
();

107 
Ët
 
	gexi¡’t_fe
 = 
dœ_·th
.
još
("empty_file");

109 
Ët
 
	g_
 = 
O³nO±iÚs
::
Ãw
()

110 .
wr™e
(
Œue
)

111 .
ü—‹_Ãw
(
Œue
)

112 .
İ’
(&
exi¡’t_fe
)

113 .
unw¿p
();

115 
	gas£¹_eq
!(
fe_exi¡s
(&
exi¡’t_fe
), 
	gŒue
);

116 
d–‘e_fe_if_exi¡
(&
exi¡’t_fe
);

117 
	gas£¹_eq
!(
fe_exi¡s
(&
exi¡’t_fe
), 
	gçl£
);

119 
Ët
 
	gnÚ_exi¡’t_fe
 = 
dœ_·th
.
još
("non_existent_file");

120 
d–‘e_fe_if_exi¡
(&
nÚ_exi¡’t_fe
);

	@src/util/file_log.rs

14 
u£
 
	g¡d
::
time
::{
Du¿tiÚ
, 
	gSy¡emTime
, 
	gUNIX_EPOCH
};

15 
u£
 
	gtime
::{
£lf
, 
	gTime¥ec
, 
	gTm
};

16 
u£
 
	g¡d
::
fs
::{
£lf
, 
	gFe
, 
	gO³nO±iÚs
};

17 
u£
 
	g¡d
::
io
::{
£lf
, 
	gWr™e
};

18 
u£
 
	g¡d
::
fmt
::
Argum’ts
;

19 
u£
 
	g¡d
::
·th
::
P©h
;

20 
u£
 
	g¡d
::
sync
::
Mu‹x
;

22 
u£
 
	gsu³r
::
logg”
::
LogWr™”
;

24 cÚ¡ 
	gONE_DAY_SECONDS
: 
u64
 = 60 * 60 * 24;

26 
â
 
sy¡emtime_to_tm
(
t
: 
Sy¡emTime
è-> 
Tm
 {

27 
Ët
 
du¿tiÚ
 = 
t
.
du¿tiÚ_sšû
(
UNIX_EPOCH
).
unw¿p
();

28 
Ët
 
	g¥ec
 = 
Time¥ec
::
Ãw
(
du¿tiÚ
.
as_£cs
(è
as
 
i64
, du¿tiÚ.
sub£c_Çnos
(èa 
i32
);

29 
	gtime
::
©
(
¥ec
)

32 
â
 
compu‹_rŞlov”_time
(
tm
: 
Tm
) -> Tm {

33 
Ët
 
day_¡¬t_tm
 = 
Tm
 {

34 
tm_hour
: 0,

35 
tm_mš
: 0,

36 
tm_£c
: 0,

37 
tm_n£c
: 0,

38 ..
tm


40 
Ët
 
	gdu¿tiÚ
 = 
time
::
Du¿tiÚ
::
äom_¡d
(Du¿tiÚ::
Ãw
(
ONE_DAY_SECONDS
, 0)).
unw¿p
();

41 (
	gday_¡¬t_tm
.
to_utc
(è+ 
	gdu¿tiÚ
).
to_loÿl
()

46 
â
 
Úe_day_befÜe
(
tm
: 
Tm
) -> Tm {

47 
Ët
 
du¿tiÚ
 = 
time
::
Du¿tiÚ
::
äom_¡d
(Du¿tiÚ::
Ãw
(
ONE_DAY_SECONDS
, 0)).
unw¿p
();

48 (
	gtm
.
to_utc
(è- 
	gdu¿tiÚ
).
to_loÿl
()

51 
â
 
İ’_log_fe
(
·th
: &
¡r
è-> 
io
::
ResuÉ
<
Fe
> {

52 
Ët
 
p
 = 
P©h
::
Ãw
(
·th
);

53 
Ët
 
	g·»Á
 = 
p
.
·»Á
().
unw¿p
();

54 !
	g·»Á
.
is_dœ
() {

55 
	gfs
::
ü—‹_dœ_®l
(
·»Á
)?

57 
O³nO±iÚs
::
Ãw
().
­³nd
(
Œue
).
ü—‹
Ñrue).
İ’
(
·th
)

60 
	sRÙ©šgFeLogg”CÜe
 {

61 
rŞlov”_time
: 
Tm
,

62 
	mfe_·th
: 
SŒšg
,

63 
	mfe
: 
Fe
,

66 
im¶
 
	gRÙ©šgFeLogg”CÜe
 {

67 
â
 
Ãw
(
·th
: &
¡r
è-> 
io
::
ResuÉ
<
RÙ©šgFeLogg”CÜe
> {

68 
Ët
 
fe
 = 
İ’_log_fe
(
·th
)?;

69 
Ët
 
	gfe_©Œ
 = 
fs
::
m‘ad©a
(
·th
).
unw¿p
();

70 
Ët
 
	gfe_modif›d_time
 = 
fe_©Œ
.
modif›d
().
unw¿p
();

71 
Ët
 
	grŞlov”_time
 = 
compu‹_rŞlov”_time
(
sy¡emtime_to_tm
(
fe_modif›d_time
));

72 
Ët
 
	g»t
 = 
RÙ©šgFeLogg”CÜe
 {

73 
rŞlov”_time
:„ollover_time,

74 
fe_·th
: 
·th
.
to_¡ršg
(),

75 
fe
: file,

77 
Ok
(
»t
)

80 
â
 
İ’
(&
mut
 
£lf
) {

81 
	g£lf
.
	gfe
 = 
İ’_log_fe
(&
£lf
.
fe_·th
).
unw¿p
()

84 
â
 
should_rŞlov”
(&
mut
 
£lf
è-> 
	gboŞ
 {

85 
	gtime
::
now
(è> 
£lf
.
rŞlov”_time


88 
â
 
do_rŞlov”
(&
mut
 
£lf
) {

89 
£lf
.
şo£
();

90 
Ët
 
mut
 
	gs
 = 
£lf
.
fe_·th
.
şÚe
();

91 
	gs
.
push_¡r
(".");

92 
	gs
.
push_¡r
(&
time
::
¡ráime
(

94 &
Úe_day_befÜe
(
£lf
.
rŞlov”_time
),

95 ).
unw¿p
());

96 
	gfs
::
»Çme
(&
£lf
.
fe_·th
, &
s
).
unw¿p
();

97 
	g£lf
.
upd©e_rŞlov”_time
();

98 
	g£lf
.
İ’
()

101 
â
 
upd©e_rŞlov”_time
(&
mut
 
£lf
) {

102 
Ët
 
	gnow
 = 
time
::
now
();

103 
	g£lf
.
	grŞlov”_time
 = 
compu‹_rŞlov”_time
(
now
);

106 
â
 
şo£
(&
mut
 
£lf
) {

107 
	g£lf
.
	gfe
.
æush
().
unw¿p
()

112 
pub
 
	sRÙ©šgFeLogg”
 {

113 
	mcÜe
: 
Mu‹x
<
RÙ©šgFeLogg”CÜe
>,

116 
im¶
 
	gRÙ©šgFeLogg”
 {

117 
pub
 
â
 
Ãw
(
fe_·th
: &
¡r
è-> 
io
::
ResuÉ
<
RÙ©šgFeLogg”
> {

118 
Ët
 
cÜe
 = 
RÙ©šgFeLogg”CÜe
::
Ãw
(
fe_·th
)?;

119 
Ët
 
	g»t
 = 
RÙ©šgFeLogg”
 {

120 
cÜe
: 
Mu‹x
::
Ãw
(core),

122 
Ok
(
»t
)

126 
im¶
 
LogWr™”
 
	gRÙ©šgFeLogg”
 {

127 
â
 
wr™e
(&
£lf
, 
¬gs
: 
Argum’ts
) {

128 
Ët
 
mut
 
cÜe
 = 
£lf
.cÜe.
lock
().
unw¿p
();

129 
	gcÜe
.
should_rŞlov”
() {

130 
	gcÜe
.
do_rŞlov”
()

132 
Ët
 
	g_
 = 
cÜe
.
fe
.
wr™e_fmt
(
¬gs
);

136 
im¶
 
Drİ
 
	gRÙ©šgFeLogg”
 {

137 
â
 
drİ
(&
mut
 
£lf
) {

138 
Ët
 
mut
 
	gcÜe
 = 
£lf
.
cÜe
.
lock
().
unw¿p
();

139 
	gcÜe
.
şo£
()

144 #[
cfg
(
‹¡
)]

145 
mod
 
	g‹¡s
 {

146 
u£
 
	gtime
::{
£lf
, 
	gTime¥ec
};

147 
u£
 
	g¡d
::
io
::
´–ude
::*;

148 
u£
 
	g¡d
::
fs
::
O³nO±iÚs
;

149 
u£
 
	g¡d
::
·th
::
P©h
;

151 
u£
 
	g‹mpdœ
::
TempDœ
;

152 
u£
 
	gutime
;

154 
u£
 
	gsu³r
::{
RÙ©šgFeLogg”CÜe
, 
	gONE_DAY_SECONDS
};

156 #[
‹¡
]

157 
â
 
‹¡_Úe_day_befÜe
() {

158 
Ët
 
	gtm
 = 
time
::
¡½time
("2016-08-30", "%Y-%m-%d").
unw¿p
().
to_loÿl
();

159 
Ët
 
	gÚe_day_ago
 = 
time
::
¡½time
("2016-08-29", "%Y-%m-%d").
unw¿p
().
to_loÿl
();

160 
	gas£¹_eq
!(
	gÚe_day_ago
, 
	gsu³r
::
Úe_day_befÜe
(
tm
));

163 
â
 
fe_exi¡s
(
fe
: &
¡r
è-> 
boŞ
 {

164 
Ët
 
·th
 = 
P©h
::
Ãw
(
fe
);

165 
	g·th
.
exi¡s
(è&&…©h.
is_fe
()

168 #[
‹¡
]

169 
â
 
‹¡_rÙ©šg_fe_logg”
() {

170 
Ët
 
	gtmp_dœ
 = 
TempDœ
::
Ãw
("").
unw¿p
();

171 
Ët
 
	glog_fe
 = 
tmp_dœ


172 .
·th
()

173 .
još
("test_rotating_file_logger.log")

174 .
to_¡r
()

175 .
unw¿p
()

176 .
to_¡ršg
();

179 
Ët
 
mut
 
	gfe
 = 
O³nO±iÚs
::
Ãw
()

180 .
­³nd
(
Œue
)

181 .
ü—‹
(
Œue
)

182 .
İ’
(&
log_fe
)

183 .
unw¿p
();

184 
	gfe
.
wr™e_®l
(
b
"h–lØwÜld!").
unw¿p
();

186 
Ët
 
	gts
 = 
time
::
now
().
to_time¥ec
();

187 
Ët
 
	gÚe_day_ago
 = 
Time¥ec
::
Ãw
(
ts
.
£c
 - 
ONE_DAY_SECONDS
 
as
 
i64
,s.
n£c
);

188 
Ët
 
	gtime_š_£c
 = 
Úe_day_ago
.
£c
 
as
 
u64
;

189 
	gutime
::
£t_fe_times
(&
log_fe
, 
time_š_£c
,ime_š_£c).
unw¿p
();

191 
Ët
 
mut
 
	gcÜe
 = 
RÙ©šgFeLogg”CÜe
::
Ãw
(&
log_fe
).
unw¿p
();

192 
	gas£¹
!(
	gcÜe
.
should_rŞlov”
());

193 
	gcÜe
.
do_rŞlov”
();

195 
Ët
 
mut
 
	grÙ©ed_fe
 = 
log_fe
.
şÚe
();

196 
	grÙ©ed_fe
.
push_¡r
(".");

197 
Ët
 
	gfe_suffix_time
 =

198 
su³r
::
Úe_day_befÜe
(su³r::
compu‹_rŞlov”_time
(
time
::
©
(
Úe_day_ago
)));

199 
	grÙ©ed_fe
.
push_¡r
(&
time
::
¡ráime
("%Y%m%d", &
fe_suffix_time
).
unw¿p
());

200 
	gas£¹
!(
fe_exi¡s
(&
rÙ©ed_fe
));

201 
	gas£¹
!(!
	gcÜe
.
should_rŞlov”
());

	@src/util/io_limiter.rs

14 
u£
 
	g¡d
::
io
::{
ResuÉ
, 
	gWr™e
};

15 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	g¡d
::
İtiÚ
::
O±iÚ
;

18 
u£
 
	grocksdb
::
R©eLim™”
;

20 cÚ¡ 
	gPRIORITY_HIGH
: 
u8
 = 1;

21 cÚ¡ 
	gREFILL_PERIOD
: 
i64
 = 100 * 1000;

22 cÚ¡ 
	gFARENESS
: 
i32
 = 10;

23 cÚ¡ 
	gSNAP_MAX_BYTES_PER_TIME
: 
i64
 = 4 * 1024 * 1024;

24 
pub
 cÚ¡ 
	gDEFAULT_SNAP_MAX_BYTES_PER_SEC
: 
u64
 = 30 * 1024 * 1024;

26 
pub
 
	sIOLim™”
 {

27 
	mšÃr
: 
R©eLim™”
,

30 
im¶
 
	gIOLim™”
 {

31 
pub
 
â
 
Ãw
(
by‹s_³r_£c
: 
u64
è-> 
IOLim™”
 {

32 
IOLim™”
 {

33 
šÃr
: 
R©eLim™”
::
Ãw
(
by‹s_³r_£c
 
as
 
i64
, 
REFILL_PERIOD
, 
FARENESS
),

37 
pub
 
â
 
£t_by‹s_³r_£cÚd
(&
£lf
, 
by‹s_³r_£c
: 
i64
) {

38 
£lf
.
šÃr
.
£t_by‹s_³r_£cÚd
(
by‹s_³r_£c
)

41 
pub
 
â
 
»que¡
(&
£lf
, 
by‹s
: 
i64
) {

42 
£lf
.
šÃr
.
»que¡
(
by‹s
, 
PRIORITY_HIGH
)

45 
pub
 
â
 
g‘_max_by‹s_³r_time
(&
£lf
è-> 
	gi64
 {

46 
	g£lf
.
	gšÃr
.
g‘_sšgËbur¡_by‹s
(è> 
	gSNAP_MAX_BYTES_PER_TIME
 {

47 
	gSNAP_MAX_BYTES_PER_TIME


49 
	g£lf
.
	gšÃr
.
g‘_sšgËbur¡_by‹s
()

53 
pub
 
â
 
g‘_tÙ®_by‹s_through
(&
£lf
è-> 
	gi64
 {

54 
	g£lf
.
	gšÃr
.
g‘_tÙ®_by‹s_through
(
PRIORITY_HIGH
)

57 
pub
 
â
 
g‘_by‹s_³r_£cÚd
(&
£lf
è-> 
	gi64
 {

58 
	g£lf
.
	gšÃr
.
g‘_by‹s_³r_£cÚd
()

61 
pub
 
â
 
g‘_tÙ®_»que¡s
(&
£lf
è-> 
	gi64
 {

62 
	g£lf
.
	gšÃr
.
g‘_tÙ®_»que¡s
(
PRIORITY_HIGH
)

66 
pub
 
	gLim™Wr™”
<'a, T: Wr™+ '
	ga
> {

67 
	glim™”
: 
O±iÚ
<
Arc
<
IOLim™”
>>,

68 
	gwr™”
: &'a mut T,

71 
im¶
<'a, T: Wr™+ '
a
> 
Lim™Wr™”
<'a, T> {

72 
pub
 
â
 
Ãw
(
lim™”
: 
O±iÚ
<
Arc
<
IOLim™”
>>, 
wr™”
: &'¨muˆTè-> Lim™Wr™”<'
a
, 
T
> {

73 
Lim™Wr™”
 {

74 
lim™”
:†imiter,

75 
wr™”
: writer,

80 
im¶
<'a, T: Wr™+ '
a
> 
Wr™e
 
Lim™Wr™”
<'a, T> {

81 
â
 
wr™e
(&
mut
 
£lf
, 
buf
: &[
u8
]è-> 
ResuÉ
<
usize
> {

82 
Ët
 
tÙ®
 = 
buf
.
Ën
();

83 
Ët
 
Some
(
»f
 
lim™”
èğ
£lf
.limiter {

84 
Ët
 
sšgË
 = 
lim™”
.
g‘_max_by‹s_³r_time
(è
as
 
usize
;

85 
Ët
 
mut
 
cu¼
 = 0;

86 
Ët
 
mut
 
’d
;

87 
cu¼
 < 
tÙ®
 {

88 
cu¼
 + 
sšgË
 >ğ
tÙ®
 {

89 
’d
 = 
tÙ®
;

91 
’d
 = 
cu¼
 + 
sšgË
;

93 
lim™”
.
»que¡
((
’d
 - 
cu¼
è
as
 
i64
);

94 
£lf
.
wr™”
.
wr™e_®l
(&
buf
[
cu¼
..
’d
])?;

95 
cu¼
 = 
’d
;

98 
£lf
.
wr™”
.
wr™e_®l
(
buf
)?;

100 
Ok
(
tÙ®
)

103 
â
 
æush
(&
mut
 
£lf
è-> 
ResuÉ
<()> {

104 
£lf
.
wr™”
.
æush
()?;

105 
Ok
(())

109 #[
cfg
(
‹¡
)]

110 
mod
 
‹¡
 {

111 
u£
 
¡d
::
fs
::
Fe
;

112 
u£
 
¡d
::
io
::{
R—d
, 
Wr™e
};

113 
u£
 
¡d
::
sync
::
Arc
;

115 
u£
 
su³r
::{
IOLim™”
, 
Lim™Wr™”
, 
SNAP_MAX_BYTES_PER_TIME
};

117 #[
‹¡
]

118 
â
 
‹¡_io_lim™”
() {

119 
Ët
 
lim™”
 = 
IOLim™”
::
Ãw
(10 * 1024 * 1024);

120 
as£¹
!(
lim™”
.
g‘_max_by‹s_³r_time
(è<ğ
SNAP_MAX_BYTES_PER_TIME
);

122 
lim™”
.
£t_by‹s_³r_£cÚd
(20 * 1024 * 1024);

123 
as£¹_eq
!(
lim™”
.
g‘_by‹s_³r_£cÚd
(), 20 * 1024 * 1024);

125 
as£¹_eq
!(
lim™”
.
g‘_tÙ®_by‹s_through
(), 0);

127 
lim™”
.
»que¡
(1024 * 1024);

128 
as£¹_eq
!(
lim™”
.
g‘_tÙ®_by‹s_through
(), 1024 * 1024);

130 
as£¹_eq
!(
lim™”
.
g‘_tÙ®_»que¡s
(), 1);

133 #[
‹¡
]

134 
â
 
‹¡_lim™_wr™”
() {

135 
Ët
 
mut
 
fe
 = 
Fe
::
ü—‹
("/tmp/‹¡_lim™_wr™”.txt").
unw¿p
();

136 
Ët
 
mut
 
lim™_wr™”
 = 
Lim™Wr™”
::
Ãw
(
Some
(
Arc
::Ãw(
IOLim™”
::Ãw(1024))), &muˆ
fe
);

138 
Ët
 
mut
 
s
 = 
SŒšg
::
Ãw
();

139 
_
 
š
 0..100 {

140 
s
.
push_¡r
("Hello, World!");

142 
lim™_wr™”
.
wr™e_®l
(
s
.
as_by‹s
()).
unw¿p
();

143 
lim™_wr™”
.
æush
().
unw¿p
();

145 
Ët
 
mut
 
fe
 = 
Fe
::
İ’
("/tmp/‹¡_lim™_wr™”.txt").
unw¿p
();

146 
Ët
 
mut
 
cÚ‹Ás
 = 
SŒšg
::
Ãw
();

147 
fe
.
»ad_to_¡ršg
(&
mut
 
cÚ‹Ás
).
unw¿p
();

148 
as£¹_eq
!(
cÚ‹Ás
, 
s
);

	@src/util/logger.rs

14 
u£
 
	g¡d
::
io
::{
£lf
, 
	gWr™e
};

15 
u£
 
	g¡d
::
fmt
::
Argum’ts
;

17 
u£
 
	gtime
;

18 
u£
 
	glog
::{
£lf
, 
	gLog
, 
	gLogM‘ad©a
, 
	gLogRecÜd
, 
	gS‘Logg”E¼Ü
};

20 
pub
 
u£
 
	glog
::
LogLev–F‹r
;

22 cÚ¡ 
	gENABLED_TARGETS
: &[&'static str] = &["tikv::", "tests::", "benches::"];

24 
pub
 
â
 
š™_log
<
W
: 
LogWr™”
 + 
Sync
 + 
S’d
 + 'static>(

25 
wr™”
: 
W
,

26 
Ëv–
: 
LogLev–F‹r
,

27 è-> 
ResuÉ
<(), 
S‘Logg”E¼Ü
> {

28 
log
::
£t_logg”
(|
f‹r
| {

29 
f‹r
.
£t
(
Ëv–
);

30 
Box
::
Ãw
(
Logg”
 {

31 
Ëv–
:†evel,

32 
wr™”
: writer,

33 
tikv_Úly
: 
çl£
,

38 
pub
 
â
 
š™_log_fÜ_tikv_Úly
<
W
: 
LogWr™”
 + 
Sync
 + 
S’d
 + 'static>(

39 
wr™”
: 
W
,

40 
Ëv–
: 
LogLev–F‹r
,

41 è-> 
ResuÉ
<(), 
S‘Logg”E¼Ü
> {

42 
log
::
£t_logg”
(|
f‹r
| {

43 
f‹r
.
£t
(
Ëv–
);

44 
Box
::
Ãw
(
Logg”
 {

45 
Ëv–
:†evel,

46 
wr™”
: writer,

47 
tikv_Úly
: 
Œue
,

52 
pub
 
Œa™
 
LogWr™”
 {

53 
â
 
wr™e
(&
£lf
, 
¬gs
: 
Argum’ts
);

56 
Logg”
<
W
: 
LogWr™”
> {

57 
Ëv–
: 
LogLev–F‹r
,

58 
wr™”
: 
W
,

59 
tikv_Úly
: 
boŞ
,

62 
im¶
<
W
: 
LogWr™”
 + 
Sync
 + 
S’d
> 
Log
 
Logg”
<W> {

63 
â
 
’abËd
(&
£lf
, 
m‘a
: &
LogM‘ad©a
è-> 
boŞ
 {

64 
m‘a
.
Ëv–
(è<ğ
£lf
.level

67 
â
 
log
(&
£lf
, 
»cÜd
: &
LogRecÜd
) {

68 
£lf
.
tikv_Úly
 &&

69 
ENABLED_TARGETS


70 .
™”
()

71 .
®l
(|
rg‘
| !
»cÜd
.rg‘().
¡¬ts_w™h
(target))

75 
£lf
.
’abËd
(
»cÜd
.
m‘ad©a
()) {

76 
Ët
 
t
 = 
time
::
now
();

77 
Ët
 
time_¡r
 = 
time
::
¡ráime
("%Y/%m/%d %H:%M:%S.%f", &
t
).
unw¿p
();

79 
£lf
.
wr™”
.
wr™e
(
fÜm©_¬gs
!(

81 &
time_¡r
[..time_¡r.
Ën
() - 6],

82 
»cÜd
.
loÿtiÚ
().
fe
().
r¥l™
('/').
Áh
(0).
unw¿p
(),

83 
»cÜd
.
loÿtiÚ
().
lše
(),

84 
»cÜd
.
Ëv–
(),

85 
»cÜd
.
¬gs
()

91 
pub
 
	gStd”rLogg”
;

93 
im¶
 
LogWr™”
 
	gStd”rLogg”
 {

94 #[
šlše
]

95 
â
 
wr™e
(&
£lf
, 
¬gs
: 
Argum’ts
) {

96 
Ët
 
_
 = 
io
::
¡d”r
().
wr™e_fmt
(
¬gs
);

100 
pub
 
â
 
g‘_Ëv–_by_¡ršg
(
lv
: &
¡r
è-> 
LogLev–F‹r
 {

101 #![
®low
(
m©ch_§me_¬ms
)]

102 
m©ch
 &*
lv
.
to_owÃd
().
to_low”ÿ£
() {

103 "Œaû" => 
LogLev–F‹r
::
T¿û
,

104 "debug" => 
LogLev–F‹r
::
Debug
,

105 "šfo" => 
LogLev–F‹r
::
Info
,

106 "w¬n" => 
LogLev–F‹r
::
W¬n
,

107 "”rÜ" => 
LogLev–F‹r
::
E¼Ü
,

108 "off" => 
LogLev–F‹r
::
Off
,

109 
	g_
 => 
LogLev–F‹r
::
Info
,

	@src/util/macros.rs

29 #[
maüo_expÜt
]

30 
	gmaüo_ruËs
! 
	gcouÁ_¬gs
 {

32 (
	g$h—d
:
ex´
 
$
(, 
$
:ex´)*è=> { 1 + 
couÁ_¬gs
!($($tail),*) };

58 #[
maüo_expÜt
]

59 
	gmaüo_ruËs
! 
	gm­
 {

62 
$ü©e
::
ut
::
cŞËùiÚs
::
HashM­
::()

65 Ğ
$
Ğ
$k
:
ex´
 => 
$v
:expr ),+ ) => {

67 
Ët
 
mut
 
‹mp_m­
 =

68 
$ü©e
::
ut
::
cŞËùiÚs
::
HashM­
::
w™h_ÿ·c™y_ªd_hash”
(

69 
couÁ_¬gs
!(
$
((
$k
, 
$v
)),+),

70 
DeçuÉ
::()

72 
$
(

73 
‹mp_m­
.
š£¹
(
$k
, 
$v
);

75 
	g‹mp_m­


81 #[
maüo_expÜt
]

82 
	gmaüo_ruËs
! 
	gbox_Œy
 {

83 (
	g$ex´
:
ex´
) => ({

84 
m©ch
 
$ex´
 {

85 
Ok
(
r
) =>„,

86 
E¼
(
e
è=>  E¼(
box_”r
!(e)),

92 #[
maüo_expÜt
]

93 
	gmaüo_ruËs
! 
	gbox_”r
 {

94 (
	g$e
:
ex´
) => ({

95 
u£
 
¡d
::
”rÜ
::
E¼Ü
;

96 
Ët
 
	ge
: 
Box
<
E¼Ü
 + 
Sync
 + 
S’d
> = (
$e
).
što
();

97 
	ge
.
što
()

99 (
	g$f
:
‰
, 
$
(
$¬g
:
ex´
),+) => ({

100 
box_”r
!(
fÜm©
!(
$f
, 
$
(
$¬g
),+))

104 #[
®low
(
doc_m¬kdown
)]

110 #[
maüo_expÜt
]

111 
	gmaüo_ruËs
! 
	g»cov”_§ã
 {

112 (
	g$e
:
ex´
) => ({

113 
u£
 
¡d
::
·nic
::{
As£¹UnwšdSaã
, 
ÿtch_unwšd
};

114 
u£
 
	g$ü©e
::
ut
::
·nic_hook
;

115 
	g·nic_hook
::
mu‹
();

116 
Ët
 
	g»s
 = 
ÿtch_unwšd
(
As£¹UnwšdSaã
(
$e
));

117 
	g·nic_hook
::
unmu‹
();

118 
	g»s


123 
	gmaüo_ruËs
! 
	g¦ow_log
 {

124 (
	g$t
:
ex´
, 
$
(
$¬g
:
‰
)*) => {{

125 
$t
.
is_¦ow
() {

126 
w¬n
!("{} [ke {:?}]", 
fÜm©_¬gs
!(
$
(
$¬g
)*), 
$t
.
–­£d
());

132 #[
maüo_expÜt
]

133 
	gmaüo_ruËs
! 
	gthd_Çme
 {

134 (
	g$Çme
:
ex´
) => ({

135 
$ü©e
::
ut
::
g‘_g_äom_th»ad_Çme
().
m­
(|
g
| {

136 
fÜm©
!("{}::{}", 
$Çme
, 
g
)

137 }).
unw¿p_Ü_–£
(|| 
$Çme
.
to_owÃd
())

145 #[
maüo_expÜt
]

146 
	gmaüo_ruËs
! 
	gdeãr
 {

147 (
	g$t
:
ex´
) => (

148 
Ët
 
__ùx
 = 
$ü©e
::
ut
::
DeãrCÚ‹xt
::
Ãw
(|| 
$t
);

154 #[
maüo_expÜt
]

155 
	gmaüo_ruËs
! 
	gwa™_İ
 {

156 (
	g$ex´
:
ex´
) => {

157 
wa™_İ
!(
IMPL
 
$ex´
, 
NÚe
)

159 (
	g$ex´
:
ex´
, 
	g$timeout
:expr) => {

160 
wa™_İ
!(
IMPL
 
$ex´
, 
Some
(
$timeout
))

162 (
IMPL
 
	g$ex´
:
ex´
, 
	g$timeout
:expr) => {

164 
u£
 
¡d
::
sync
::
mpsc
;

165 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

166 
Ët
 
	gcb
 = 
box
 
move
 |
»s
| {

168 
Ët
 
_
 = 
tx
.
£nd
(
»s
);

170 
$ex´
(
cb
);

171 
m©ch
 
	g$timeout
 {

172 
	gNÚe
 => 
rx
.
»cv
().
ok
(),

173 
Some
(
timeout
è=> 
rx
.
»cv_timeout
Ñimeout).
ok
()

180 #[
maüo_expÜt
]

181 
	gmaüo_ruËs
! 
	gŒy_İt
 {

182 (
	g$ex´
:
ex´
) => ({

183 
m©ch
 
$ex´
 {

184 
E¼
(
e
è=>  E¼Ó.
što
()),

185 
Ok
(
NÚe
) =>  Ok(None),

186 
Ok
(
Some
(
»s
)) =>„es,

	@src/util/metrics.rs

14 
u£
 
	g´om‘heus
::
CouÁ”Vec
;

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gCHANNEL_FULL_COUNTER_VEC
: 
CouÁ”Vec
 =

18 
»gi¡”_couÁ”_vec
!(

22 ).
unw¿p
();

	@src/util/mod.rs

14 
u£
 
	g¡d
::
İs
::
D”ef
;

15 
u£
 
	g¡d
::
İs
::
D”efMut
;

16 
u£
 
	g¡d
::
io
;

17 
u£
 
	g¡d
::{
¦iû
, 
	gth»ad
};

18 
u£
 
	g¡d
::
Ãt
::{
Sock‘Addr
, 
	gToSock‘Addrs
};

19 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

20 
u£
 
	g¡d
::
cŞËùiÚs
::
hash_m­
::
EÁry
;

21 
u£
 
	g¡d
::
sync
::{
RwLock
, 
	gRwLockR—dGu¬d
, 
	gRwLockWr™eGu¬d
};

22 
u£
 
	g¡d
::
cŞËùiÚs
::
vec_deque
::{
I‹r
, 
	gVecDeque
};

23 
u£
 
	g¡d
::
u64
;

25 
u£
 
	g´om‘heus
;

26 
u£
 
	g¿nd
::{
£lf
, 
	gTh»adRng
};

27 
u£
 
	g´Ùobuf
::
Mes§ge
;

29 #[
maüo_u£
]

30 
pub
 
mod
 
	gmaüos
;

31 
pub
 
mod
 
	glogg”
;

32 
pub
 
mod
 
	g·nic_hook
;

33 
pub
 
mod
 
	gwÜk”
;

34 
pub
 
mod
 
	gcodec
;

35 
pub
 
mod
 
	grocksdb
;

36 
pub
 
mod
 
	gcÚfig
;

37 
pub
 
mod
 
	gbuf
;

38 
pub
 
mod
 
	gŒª¥Üt
;

39 
pub
 
mod
 
	gfe
;

40 
pub
 
mod
 
	gfe_log
;

41 
pub
 
mod
 
	gm‘rics
;

42 
pub
 
mod
 
	gth»adpoŞ
;

43 
pub
 
mod
 
	gcŞËùiÚs
;

44 
pub
 
mod
 
	gtime
;

45 
pub
 
mod
 
	gio_lim™”
;

46 
pub
 
mod
 
	g£cur™y
;

48 
pub
 
u£
 
	g£lf
::
rocksdb
::
´İ”t›s
;

50 #[
cfg
(
rg‘_os
 = "linux")]

51 
mod
 
	gth»ad_m‘rics
;

53 
pub
 cÚ¡ 
	gNO_LIMIT
: 
u64
 = u64::
MAX
;

55 
pub
 
â
 
	glim™_size
<
	gT
: 
Mes§ge
 + 
ClÚe
>(
’Œ›s
: &
mut
 
Vec
<
T
>, 
	gmax
: 
u64
) {

56 
max
 =ğ
NO_LIMIT
 || 
’Œ›s
.
Ën
() <= 1 {

60 
Ët
 
mut
 
	gsize
 = 0;

61 
Ët
 
	glim™
 = 
’Œ›s


62 .
™”
()

63 .
ke_whe
(|&
e
| 
size
 == 0 {

64 
size
 +ğ
Mes§ge
::
compu‹_size
(
e
è
as
 
u64
;

65 
Œue


67 
size
 +ğ
Mes§ge
::
compu‹_size
(
e
è
as
 
u64
;

68 
size
 <ğ
max


70 .
couÁ
();

72 
	g’Œ›s
.
Œunÿ‹
(
lim™
);

80 
pub
 
â
 
	g¦iûs_š_¿nge
<
	gT
>(
	g’Œy
: &
VecDeque
<
T
>, 
	glow
: 
usize
, 
	ghigh
: usize) -> (&[T], &[T]) {

81 
Ët
 (
fœ¡
, 
£cÚd
èğ
’Œy
.
as_¦iûs
();

82 
	glow
 >ğ
fœ¡
.
Ën
() {

83 (&
£cÚd
[
low
 - 
fœ¡
.
Ën
()..
high
 - first.len()], &[])

84 } 
high
 <ğ
fœ¡
.
Ën
() {

85 (&
fœ¡
[
low
..
high
], &[])

87 (&
fœ¡
[
low
..], &
£cÚd
[..
high
 - fœ¡.
Ën
()])

91 
pub
 
	sDeçuÉRng
 {

92 
	mºg
: 
Th»adRng
,

95 
im¶
 
	gDeçuÉRng
 {

96 
â
 
Ãw
(è-> 
	gDeçuÉRng
 {

97 
	gDeçuÉRng
 {

98 
	gºg
: 
¿nd
::
th»ad_ºg
(),

103 
im¶
 
DeçuÉ
 
	gDeçuÉRng
 {

104 
â
 (è-> 
	gDeçuÉRng
 {

105 
	gDeçuÉRng
::
Ãw
()

109 
im¶
 
D”ef
 
DeçuÉRng
 {

110 
ty³
 
T¬g‘
 = 
Th»adRng
;

112 
â
 
d”ef
(&
£lf
è-> &
	gTh»adRng
 {

113 &
	g£lf
.
	gºg


117 
im¶
 
D”efMut
 
	gDeçuÉRng
 {

118 
â
 
d”ef_mut
(&
mut
 
£lf
è-> &muˆ
	gTh»adRng
 {

119 &
mut
 
	g£lf
.
	gºg


125 
pub
 
Œa™
 
	gHªdyRwLock
<
	gT
> {

126 
â
 
wl
(&
£lf
è-> 
	gRwLockWr™eGu¬d
<
	gT
>;

127 
â
 
¾
(&
£lf
è-> 
	gRwLockR—dGu¬d
<
	gT
>;

130 
	gim¶
<
	gT
> 
	gHªdyRwLock
<T> 
	gRwLock
<T> {

131 
â
 
wl
(&
£lf
è-> 
	gRwLockWr™eGu¬d
<
	gT
> {

132 
	g£lf
.
wr™e
().
unw¿p
()

135 
â
 
¾
(&
£lf
è-> 
	gRwLockR—dGu¬d
<
	gT
> {

136 
	g£lf
.
»ad
().
unw¿p
()

143 
pub
 
â
 
	gto_sock‘_addr
<
	gA
: 
ToSock‘Addrs
>(
addr
: 
A
è-> 
io
::
ResuÉ
<
Sock‘Addr
> {

144 
Ët
 
addrs
 = 
addr
.
to_sock‘_addrs
()?;

145 
Ok
(
addrs
.
cŞËù
::<
Vec
<
Sock‘Addr
>>()[0])

163 
pub
 
â
 
esÿ³
(
d©a
: &[
u8
]è-> 
SŒšg
 {

164 
Ët
 
mut
 
esÿ³d
 = 
Vec
::
w™h_ÿ·c™y
(
d©a
.
Ën
() * 4);

165 &
c
 
š
 
	gd©a
 {

166 
m©ch
 
	gc
 {

167 
	gb
'\n' => 
esÿ³d
.
ex‹nd_äom_¦iû
(
br
"\n"),

168 
	gb
'\r' => 
esÿ³d
.
ex‹nd_äom_¦iû
(
br
"\r"),

169 
	gb
'\t' => 
esÿ³d
.
ex‹nd_äom_¦iû
(
br
"\t"),

170 
	gb
'"' => 
esÿ³d
.
ex‹nd_äom_¦iû
(
b
"\\\""),

171 
	gb
'\\' => 
esÿ³d
.
ex‹nd_äom_¦iû
(
br
"\\"),

172 
	g_
 => {

173 
c
 >= 0x20 && c < 0x7f {

175 
esÿ³d
.
push
(
c
);

177 
	gesÿ³d
.
push
(
b
'\\');

178 
	gesÿ³d
.
push
(
b
'0' + (
c
 >> 6));

179 
	gesÿ³d
.
push
(
b
'0' + ((
c
 >> 3) & 7));

180 
	gesÿ³d
.
push
(
b
'0' + (
c
 & 7));

185 
	gesÿ³d
.
shršk_to_f™
();

186 
	gun§ã
 { 
	gSŒšg
::
äom_utf8_unchecked
(
esÿ³d
) }

207 
pub
 
â
 
uÃsÿ³
(
s
: &
¡r
è-> 
Vec
<
u8
> {

208 
Ët
 
mut
 
buf
 = 
Vec
::
w™h_ÿ·c™y
(
s
.
Ën
());

209 
Ët
 
mut
 
	gby‹s
 = 
s
.
by‹s
();

210 
	gloİ
 {

211 
Ët
 
	gb
 = 
m©ch
 
by‹s
.
Ãxt
() {

212 
NÚe
 => ,

213 
Some
(
t
) =>,

215 
	gb
 !ğ
b
'\\' {

216 
buf
.
push
(
b
);

219 
m©ch
 
	gby‹s
.
Ãxt
().
unw¿p
() {

220 
	gb
'"' => 
buf
.
push
(
b
'"'),

221 
	gb
'\'' => 
buf
.
push
(
b
'\''),

222 
	gb
'\\' => 
buf
.
push
(
b
'\\'),

223 
	gb
'n' => 
buf
.
push
(
b
'\n'),

224 
	gb
't' => 
buf
.
push
(
b
'\t'),

225 
	gb
'r' => 
buf
.
push
(
b
'\r'),

226 
	gb
 => {

227 
Ët
 
b1
 = 
b
 - b'0';

228 
Ët
 
	gb2
 = 
by‹s
.
Ãxt
().
unw¿p
(è- 
b
'0';

229 
Ët
 
	gb3
 = 
by‹s
.
Ãxt
().
unw¿p
(è- 
b
'0';

230 
	gbuf
.
push
((
b1
 << 6è+ (
b2
 << 3è+ 
b3
);

234 
	gbuf
.
shršk_to_f™
();

235 
	gbuf


239 
pub
 
â
 
	gas_¦iû
<
	gT
>(
	gt
: &
T
) -> &[T] {

240 
un§ã
 {

241 
Ët
 
±r
 = 
t
 
as
 *cÚ¡ 
T
;

242 
	g¦iû
::
äom_¿w_·¹s
(
±r
, 1)

247 
pub
 
Œa™
 
	gTryIn£¹W™h
<'a, V, E> {

248 
â
 
	gÜ_Œy_š£¹_w™h
<
	gF
: 
FnOnû
(è-> 
ResuÉ
<
V
, 
	gE
>>(
	g£lf
, : 
F
) -> Result<&'a mut V, E>;

251 
im¶
<'a, T: '
a
, 
	gV
: 'a, E> TryIn£¹W™h<'a, V, 
	gE
> 
	gEÁry
<'a, T, V> {

252 
â
 
	gÜ_Œy_š£¹_w™h
<
	gF
: 
FnOnû
(è-> 
ResuÉ
<
V
, 
	gE
>>(
	g£lf
, : 
F
) -> Result<&'a mut V, E> {

253 
m©ch
 
£lf
 {

254 
EÁry
::
Occup›d
(
e
è=> 
Ok
Ó.
što_mut
()),

255 
	gEÁry
::
VaÿÁ
(
e
) => {

256 
Ët
 
v
 = ()?;

257 
Ok
(
e
.
š£¹
(
v
))

263 
pub
 
â
 
g‘_g_äom_th»ad_Çme
(è-> 
	gO±iÚ
<
	gSŒšg
> {

264 
	gth»ad
::
cu¼’t
()

265 .
Çme
()

266 .
ªd_th’
(|
Çme
|‚ame.
¥l™
("::").
sk
(1).
Ï¡
())

267 .
m­
(
From
::
äom
)

271 
pub
 
DeãrCÚ‹xt
<
T
: 
FnOnû
()> {

272 
t
: 
O±iÚ
<
T
>,

275 
	gim¶
<
	gT
: 
FnOnû
()> 
DeãrCÚ‹xt
<
T
> {

276 
pub
 
â
 
Ãw
(
t
: 
T
è-> 
DeãrCÚ‹xt
<T> {

277 
DeãrCÚ‹xt
 { 
t
: 
Some
(t) }

281 
im¶
<
T
: 
FnOnû
()> 
Drİ
 
DeãrCÚ‹xt
<T> {

282 
â
 
drİ
(&
mut
 
£lf
) {

283 
£lf
.
t
.
ke
().
unw¿p
()()

288 #[
d”ive
(
Debug
, 
ClÚe
)]

289 
pub
 
	gE™h”
<
	gL
, 
	gR
> {

290 
Leá
(
L
),

291 
Right
(
R
),

294 
	gim¶
<
	gL
, 
	gR
> 
	gE™h”
<L, R> {

295 #[
šlše
]

296 
pub
 
â
 
as_»f
(&
£lf
è-> 
	gE™h”
<&
	gL
, &
	gR
> {

297 
m©ch
 *
	g£lf
 {

298 
	gE™h”
::
Leá
(
»f
 
l
è=> 
E™h”
::Left(l),

299 
	gE™h”
::
Right
(
»f
 
r
è=> 
E™h”
::Right(r),

303 #[
šlše
]

304 
pub
 
â
 
Ëá
(
£lf
è-> 
	gO±iÚ
<
	gL
> {

305 
m©ch
 
	g£lf
 {

306 
	gE™h”
::
Leá
(
l
è=> 
Some
(l),

307 
	g_
 => 
NÚe
,

311 #[
šlše
]

312 
pub
 
â
 
right
(
£lf
è-> 
	gO±iÚ
<
	gR
> {

313 
m©ch
 
	g£lf
 {

314 
	gE™h”
::
Right
(
r
è=> 
Some
(r),

315 
	g_
 => 
NÚe
,

321 
pub
 
â
 
bud_šfo
(è-> (
	gSŒšg
, String, String, String) {

322 
Ët
 
	g¿w
 = 
šşude_¡r
!(
cÚÿt
!(
’v
!("OUT_DIR"), "/build-info.txt"));

323 
Ët
 
mut
 
	g·¹s
 = 
¿w
.
¥l™
('\n');

326 
	g·¹s
.
Ãxt
().
unw¿p_Ü
("NÚe").
to_owÃd
(),

327 
	g·¹s
.
Ãxt
().
unw¿p_Ü
("NÚe").
to_owÃd
(),

328 
	g·¹s
.
Ãxt
().
unw¿p_Ü
("NÚe").
to_owÃd
(),

329 
	g·¹s
.
Ãxt
().
unw¿p_Ü
("NÚe").
to_owÃd
(),

334 
pub
 
â
 
	$´št_tikv_šfo
() {

335 
	`Ët
 (
hash
, 
b¿nch
, 
d©e
, 
ru¡c
èğ
	`bud_šfo
();

336 
šfo
!("Welcomeo TiKV.");

337 
šfo
!("R–—£ V”siÚ: {}", 
’v
!("CARGO_PKG_VERSION"));

338 
šfo
!("G™ Comm™ Hash: {}", 
hash
);

339 
šfo
!("G™ Comm™ B¿nch: {}", 
b¿nch
);

340 
šfo
!("UTC Bud Time: {}", 
d©e
);

341 
šfo
!("Ru¡øV”siÚ: {}", 
ru¡c
);

342 
	}
}

345 
pub
 
â
 
run_´om‘heus
(

346 
š‹rv®
: 
Du¿tiÚ
,

347 
add»ss
: &
¡r
,

348 
job
: &
¡r
,

349 è-> 
	gO±iÚ
<
	gth»ad
::
JošHªdË
<()>> {

350 
š‹rv®
 =ğ
Du¿tiÚ
::
äom_£cs
(0) {

351  
NÚe
;

354 
Ët
 
	gjob
 = 
job
.
to_owÃd
();

355 
Ët
 
	gadd»ss
 = 
add»ss
.
to_owÃd
();

356 
Ët
 
	ghªdËr
 = 
th»ad
::
Bud”
::
Ãw
()

357 .
Çme
("´om•ush”".
to_owÃd
())

358 .
¥awn
(
move
 || 
loİ
 {

359 
Ët
 
m‘ric_çmys
 = 
´om‘heus
::
g©h”
();

361 
Ët
 
»s
 = 
´om‘heus
::
push_m‘rics
(

362 &
job
,

363 
´om‘heus
::
ho¡Çme_groupšg_key
(),

364 &
add»ss
,

365 
m‘ric_çmys
,

367 
Ët
 
E¼
(
e
èğ
»s
 {

368 
”rÜ
!("çØpush m‘rics: {}", 
e
);

371 
th»ad
::
¦“p
(
š‹rv®
);

373 .
unw¿p
();

375 
Some
(
hªdËr
)

378 #[
cfg
(
rg‘_os
 = "linux")]

379 
pub
 
u£
 
	g£lf
::
th»ad_m‘rics
::
mÚ™Ü_th»ads
;

381 #[
cfg
(
nÙ
(
rg‘_os
 = "linux"))]

382 
pub
 
â
 
	gmÚ™Ü_th»ads
<
	gS
: 
IÁo
<
SŒšg
>>(
_
: 
S
è-> 
io
::
ResuÉ
<()> {

383 
Ok
(())

387 
pub
 
RšgQueue
<
T
> {

388 
buf
: 
VecDeque
<
T
>,

389 
	gÿp
: 
usize
,

392 
	gim¶
<
	gT
> 
	gRšgQueue
<T> {

393 #[
šlše
]

394 
â
 
Ën
(&
£lf
è-> 
	gusize
 {

395 
	g£lf
.
	gbuf
.
Ën
()

398 
pub
 
â
 
w™h_ÿ·c™y
(
ÿp
: 
usize
è-> 
RšgQueue
<
T
> {

399 
RšgQueue
 {

400 
buf
: 
VecDeque
::
w™h_ÿ·c™y
(
ÿp
),

401 
	gÿp
: 
ÿp
,

405 
pub
 
â
 
push
(&
mut
 
£lf
, 
t
: 
T
) {

406 
£lf
.
Ën
(è=ğ£lf.
ÿp
 {

407 
£lf
.
buf
.
pİ_äÚt
();

409 
	g£lf
.
	gbuf
.
push_back
(
t
);

412 
pub
 
â
 
™”
(&
£lf
è-> 
	gI‹r
<
	gT
> {

413 
	g£lf
.
	gbuf
.
™”
()

416 
pub
 
â
 
	gsw­_»move_äÚt
<
	gF
>(&
mut
 
	g£lf
, 
	gf
: 
F
è-> 
O±iÚ
<
T
>

417 
wh”e


418 
F
: 
FnMut
(&
T
è-> 
boŞ
,

420 
Ët
 
Some
(
pos
èğ
£lf
.
buf
.
™”
().
pos™iÚ
(
f
) {

421 
£lf
.
buf
.
sw­_»move_äÚt
(
pos
)

423 
NÚe


429 
pub
 
â
 
	gcfs_diff
<'a>×: &[&'
a
 
	g¡r
], 
	gb
: &[&
¡r
]è-> 
Vec
<&'a str> {

430 
a
.
™”
()

431 .
f‹r
(|
x
| 
b
.
™”
().
fšd
(|
y
| y =ğx).
is_nÚe
())

432 .
m­
(|
x
| *x)

433 .
cŞËù
()

436 #[
šlše
]

437 
pub
 
â
 
is_ev’
(
n
: 
usize
è-> 
boŞ
 {

438 
n
 & 1 == 0

441 
pub
 
Mu¡CÚsumeVec
<
T
> {

442 
g
: &'static str,

443 
v
: 
Vec
<
T
>,

446 
	gim¶
<
	gT
> 
	gMu¡CÚsumeVec
<T> {

447 #[
šlše
]

448 
pub
 
â
 
Ãw
(
g
: &'static str) -> MustConsumeVec<T> {

449 
Mu¡CÚsumeVec
::
w™h_ÿ·c™y
(
g
, 0)

452 #[
šlše
]

453 
pub
 
â
 
w™h_ÿ·c™y
(
g
: &'static str, cap: usize) -> MustConsumeVec<T> {

454 
Mu¡CÚsumeVec
 {

455 
g
:ag,

456 
v
: 
Vec
::
w™h_ÿ·c™y
(
ÿp
),

461 
im¶
<
T
> 
D”ef
 
Mu¡CÚsumeVec
<T> {

462 
ty³
 
T¬g‘
 = 
Vec
<
T
>;

464 
â
 
d”ef
(&
£lf
è-> &
Vec
<
T
> {

465 &
£lf
.
v


469 
im¶
<
T
> 
D”efMut
 
Mu¡CÚsumeVec
<T> {

470 
â
 
d”ef_mut
(&
mut
 
£lf
è-> &muˆ
Vec
<
T
> {

471 &
mut
 
£lf
.
v


475 
im¶
<
T
> 
Drİ
 
Mu¡CÚsumeVec
<T> {

476 
â
 
drİ
(&
mut
 
£lf
) {

477 !
£lf
.
is_em±y
() {

478 
·nic
!("»sourû†—k d‘eùed: {}.", 
£lf
.
g
);

483 #[
cfg
(
‹¡
)]

484 
mod
 
‹¡s
 {

485 
u£
 
¡d
::
cŞËùiÚs
::*;

486 
u£
 
¡d
::
Ãt
::{
AddrP¬£E¼Ü
, 
Sock‘Addr
};

487 
u£
 
¡d
::
rc
::
Rc
;

488 
u£
 
¡d
::*;

489 
u£
 
¡d
::
sync
::
©omic
::{
AtomicBoŞ
, 
Ord”šg
};

490 
u£
 
kv´Ùo
::
”aápb
::
EÁry
;

491 
u£
 
´Ùobuf
::
Mes§ge
;

492 
u£
 
su³r
::*;

494 #[
‹¡
]

495 
â
 
‹¡_to_sock‘_addr
() {

496 
Ët
 
tbls
 = 
vec
![

497 ("", 
çl£
),

498 ("127.0.0.1", 
çl£
),

499 ("loÿlho¡", 
çl£
),

500 ("127.0.0.1:80", 
Œue
),

501 ("loÿlho¡:80", 
Œue
),

504 
addr
, 
ok
è
š
 
tbls
 {

505 
as£¹_eq
!(
to_sock‘_addr
(
addr
).
is_ok
(), 
ok
);

508 
Ët
 
tbls
 = 
vec
![("loÿlho¡:80", 
çl£
), ("127.0.0.1:80", 
Œue
)];

510 
addr
, 
ok
è
š
 
tbls
 {

511 
Ët
 
»t
: 
ResuÉ
<
Sock‘Addr
, 
AddrP¬£E¼Ü
> = 
addr
.
·r£
();

512 
as£¹_eq
!(
»t
.
is_ok
(), 
ok
);

516 #[
‹¡
]

517 
â
 
‹¡_fixed_ršg_queue
() {

518 
Ët
 
mut
 
queue
 = 
RšgQueue
::
w™h_ÿ·c™y
(10);

519 
num
 
š
 0..20 {

520 
queue
.
push
(
num
);

521 
as£¹_eq
!(
queue
.
Ën
(), 
cmp
::
mš
(
num
 + 1, 10));

523 
as£¹_eq
!(
NÚe
, 
queue
.
sw­_»move_äÚt
(|
i
| *i == 20));

524 
i
 
š
 0..6 {

525 
as£¹_eq
!(
Some
(12 + 
i
), 
queue
.
sw­_»move_äÚt
(|
e
| *e == 12 + i));

526 
as£¹_eq
!(
queue
.
Ën
(), 9 - 
i
);

529 
Ët
 
Ëá
: 
Vec
<
_
> = 
queue
.
™”
().
şÚed
().
cŞËù
();

530 
as£¹_eq
!(
vec
![10, 11, 18, 19], 
Ëá
);

531 
_
 
š
 0..4 {

532 
queue
.
sw­_»move_äÚt
(|
_
| 
Œue
).
unw¿p
();

534 
as£¹_eq
!(
NÚe
, 
queue
.
sw­_»move_äÚt
(|
_
| 
Œue
));

537 #[
‹¡
]

538 
â
 
‹¡_deãr
() {

539 
Ët
 
should_·nic
 = 
Rc
::
Ãw
(
AtomicBoŞ
::Ãw(
Œue
));

540 
Ët
 
¥
 = 
should_·nic
.
şÚe
();

541 
deãr
!(
as£¹
!(!
¥
.
lßd
(
Ord”šg
::
SeqC¡
)));

542 
should_·nic
.
¡Üe
(
çl£
, 
Ord”šg
::
SeqC¡
);

545 #[
‹¡
]

546 
â
 
‹¡_rwlock_d—dlock
() {

548 
Ët
 
mu
 = 
RwLock
::
Ãw
(
Some
(1));

550 
Ët
 
_şÚe
 = 
foo
(&
mu
.
¾
());

551 
Ët
 
mut
 
d©a
 = 
mu
.
wl
();

552 
as£¹
!(
d©a
.
is_some
());

553 *
d©a
 = 
NÚe
;

557 
m©ch
 
foo
(&
mu
.
¾
()) {

558 
Some
(
_
è| 
NÚe
 => {

559 
Ët
 
»s
 = 
mu
.
Œy_wr™e
();

560 
as£¹
!(
»s
.
is_”r
());

565 #[
®low
(
şÚe_Ú_cİy
)]

566 
â
 
foo
(
a
: &
O±iÚ
<
usize
>) -> Option<usize> {

567 
a
.
şÚe
()

571 #[
‹¡
]

572 
â
 
‹¡_lim™_size
() {

573 
Ët
 
mut
 
e
 = 
EÁry
::
Ãw
();

574 
e
.
£t_d©a
(
b
"0123456789".
to_vec
());

575 
Ët
 
size
 = 
e
.
compu‹_size
(è
as
 
u64
;

577 
Ët
 
tbls
 = 
vec
![

578 (
vec
![], 
NO_LIMIT
, 0),

579 (
vec
![], 
size
, 0),

580 (
vec
![
e
.
şÚe
(); 10], 0, 1),

581 (
vec
![
e
.
şÚe
(); 10], 
NO_LIMIT
, 10),

582 (
vec
![
e
.
şÚe
(); 10], 
size
, 1),

583 (
vec
![
e
.
şÚe
(); 10], 
size
 + 1, 1),

584 (
vec
![
e
.
şÚe
(); 10], 2 * 
size
, 2),

585 (
vec
![
e
.
şÚe
(); 10], 10 * 
size
 - 1, 9),

586 (
vec
![
e
.
şÚe
(); 10], 10 * 
size
, 10),

587 (
vec
![
e
.
şÚe
(); 10], 10 * 
size
 + 1, 10),

590 
mut
 
’Œ›s
, 
max
, 
Ën
è
š
 
tbls
 {

591 
lim™_size
(&
mut
 
’Œ›s
, 
max
);

592 
as£¹_eq
!(
’Œ›s
.
Ën
(),†en);

596 #[
‹¡
]

597 
â
 
‹¡_¦iûs_vec_deque
() {

598 
fœ¡
 
š
 0..10 {

599 
Ët
 
mut
 
v
 = 
VecDeque
::
w™h_ÿ·c™y
(10);

600 
i
 
š
 0..f
œ¡
 {

601 
v
.
push_back
(
i
);

603 
i
 
š
 
fœ¡
..10 {

604 
v
.
push_back
(
i
 - 
fœ¡
);

606 
v
.
d¿š
(..
fœ¡
);

607 
i
 
š
 0..f
œ¡
 {

608 
v
.
push_back
(10 + 
i
 - 
fœ¡
);

610 
Ën
 
š
 0..10 {

611 
low
 
š
 0..Ë
n
 + 1 {

612 
high
 
š
 
low
..
Ën
 + 1 {

613 
Ët
 (
p1
, 
p2
èğ
su³r
::
¦iûs_š_¿nge
(&
v
, 
low
, 
high
);

614 
Ët
 
mut
 
»s
 = 
vec
![];

615 
»s
.
ex‹nd_äom_¦iû
(
p1
);

616 
»s
.
ex‹nd_äom_¦iû
(
p2
);

617 
Ët
 
exp
: 
Vec
<
_
> = (
low
..
high
).
cŞËù
();

618 
as£¹_eq
!(

619 
»s
,

620 
exp
,

622 
low
,

623 
high
,

624 
v
,

625 
fœ¡


633 #[
‹¡
]

634 
â
 
‹¡_cfs_diff
() {

635 
Ët
 
a
 = 
vec
!["1", "2", "3"];

636 
Ët
 
a_diff_a
 = 
cfs_diff
(&
a
, &a);

637 
as£¹
!(
a_diff_a
.
is_em±y
());

638 
Ët
 
b
 = 
vec
!["4"];

639 
as£¹_eq
!(
a
, 
cfs_diff
(&a, &
b
));

640 
Ët
 
c
 = 
vec
!["4", "5", "3", "6"];

641 
as£¹_eq
!(
vec
!["1", "2"], 
cfs_diff
(&
a
, &
c
));

642 
as£¹_eq
!(
vec
!["4", "5", "6"], 
cfs_diff
(&
c
, &
a
));

643 
Ët
 
d
 = 
vec
!["1", "2", "3", "4"];

644 
Ët
 
a_diff_d
 = 
cfs_diff
(&
a
, &
d
);

645 
as£¹
!(
a_diff_d
.
is_em±y
());

646 
as£¹_eq
!(
vec
!["4"], 
cfs_diff
(&
d
, &
a
));

649 #[
‹¡
]

650 
â
 
‹¡_mu¡_cÚsume_vec
() {

651 
Ët
 
mut
 
v
 = 
Mu¡CÚsumeVec
::
Ãw
("test");

652 
v
.
push
(2);

653 
v
.
push
(3);

654 
as£¹_eq
!(
v
.
Ën
(), 2);

655 
v
.
d¿š
(..);

658 #[
‹¡
]

659 
â
 
‹¡_»sourû_Ëak
() {

660 
Ët
 
»s
 = 
»cov”_§ã
!(|| {

661 
Ët
 
mut
 
v
 = 
Mu¡CÚsumeVec
::
Ãw
("test");

662 
v
.
push
(2);

664 
»s
.
unw¿p_”r
();

	@src/util/panic_hook.rs

15 
u£
 
	g¡d
::
·nic
::{
£lf
, 
	gPªicInfo
};

16 
u£
 
	g¡d
::
ûÎ
::
RefC–l
;

17 
u£
 
	g¡d
::
sync
::{
Onû
, 
	gONCE_INIT
};

18 
u£
 
	g¡d
::{
´oûss
, 
	gth»ad
};

20 
u£
 
	gbackŒaû
::
BackŒaû
;

21 
u£
 
	glog
::
LogLev–
;

26 
	gINIT
: 
Onû
 = 
ONCE_INIT
;

28 
mut
 
	gDEFAULT_HOOK
: 
O±iÚ
<*muˆ(
Fn
(&
PªicInfo
) + 'static + Sync + Send)> = None;

30 
th»ad_loÿl
! {

31 
MUTED
: 
RefC–l
<
boŞ
> = RefC–l::
Ãw
(
çl£
)

35 
â
 
	$š™Ÿlize
() {

36 
un§ã
 {

37 
DEFAULT_HOOK
 = 
	`Some
(
Box
::
	`što_¿w
(
·nic
::
	`ke_hook
()));

38 
·nic
::
	`£t_hook
(
box
 
Œack_hook
);

40 
	}
}

43 
pub
 
â
 
	$mu‹
() {

44 
INIT
.
	`ÿÎ_Úû
(
š™Ÿlize
);

45 
MUTED
.
	`w™h
(|
m
| *m.
	`bÜrow_mut
(èğ
Œue
);

46 
	}
}

49 
pub
 
â
 
	$unmu‹
() {

50 
MUTED
.
	`w™h
(|
m
| *m.
	`bÜrow_mut
(èğ
çl£
);

51 
	}
}

54 
â
 
	$Œack_hook
(
p
: &
PªicInfo
) {

55 
MUTED
.
	`w™h
(|
m
| {

56 *
m
.
	`bÜrow
() {

59 
un§ã
 {

60 
Ët
 
	`Some
(
hook
èğ
DEFAULT_HOOK
 {

61 (*
hook
)(
p
);

65 
	}
}

68 
pub
 
â
 
	$£t_ex™_hook
() {

79 
th»ad
::
Bud”
::
	`Ãw
()

80 .
	`Çme
(
thd_Çme
!("backtrace-loader"))

81 .
	`¥awn
(
BackŒaû
::
Ãw
)

82 .
	`unw¿p
();

84 
Ët
 
Üig_hook
 = 
·nic
::
	`ke_hook
();

85 
·nic
::
	`£t_hook
(
box
 
move
 |
šfo
: &
PªicInfo
| {

86 
log_’abËd
!(
LogLev–
::
E¼Ü
) {

87 
Ët
 
msg
 = 
m©ch
 
šfo
.
	`·ylßd
().
downÿ¡_»f
::<&'static str>() {

88 
	`Some
(
s
) => *s,

89 
NÚe
 => 
m©ch
 
šfo
.
	`·ylßd
().
downÿ¡_»f
::<
SŒšg
>() {

90 
	`Some
(
s
) => &s[..],

91 
NÚe
 => "Box<Any>",

94 
Ët
 
th»ad
 =h»ad::
	`cu¼’t
();

95 
Ët
 
Çme
 = 
th»ad
.
	`Çme
().
	`unw¿p_Ü
("<unnamed>");

96 
Ët
 
loc
 = 
šfo
.
	`loÿtiÚ
()

97 .
	`m­
(|
l
| 
fÜm©
!("{}:{}",†.
	`fe
(),†.
	`lše
()));

98 
Ët
 
bt
 = 
BackŒaû
::
	`Ãw
();

99 
”rÜ
!(

101 
Çme
,

102 
msg
,

103 
loc
.
	`unw¿p_Ü_–£
(|| "<unknown>".
	`to_owÃd
()),

104 
bt


107 
	`Üig_hook
(
šfo
);

109 
´oûss
::
	`ex™
(1);

110 
	}
})

	@src/util/rocksdb/engine_metrics.rs

14 
u£
 
	g´om‘heus
::{
expÚ’tŸl_buck‘s
, 
	gCouÁ”Vec
, 
	gGaugeVec
, 
	gHi¡og¿mVec
};

15 
u£
 
	grocksdb
::{
DBSti¡icsHi¡og¿mTy³
 
as
 
Hi¡Ty³
, 
DBSti¡icsTick”Ty³
‡ 
	gTick”Ty³
,

16 
	gHi¡og¿mD©a
, 
	gDB
};

17 
u£
 
	gut
::
rocksdb
;

18 
u£
 
	gtime
;

20 
pub
 cÚ¡ 
	gROCKSDB_TOTAL_SST_FILES_SIZE
: &'static str = "rocksdb.total-sst-files-size";

21 
pub
 cÚ¡ 
ROCKSDB_TABLE_READERS_MEM
: &'static str = "rocksdb.estimate-table-readers-mem";

22 
pub
 cÚ¡ 
ROCKSDB_CUR_SIZE_ALL_MEM_TABLES
: &'static str = "rocksdb.cur-size-all-mem-tables";

23 
pub
 cÚ¡ 
ROCKSDB_ESTIMATE_NUM_KEYS
: &'static str = "rocksdb.estimate-num-keys";

24 
pub
 cÚ¡ 
ROCKSDB_PENDING_COMPACTION_BYTES
: &'static str = "rocksdb.\
-pending-compaction-bytes";

26 
pub
 cÚ¡ 
ROCKSDB_COMPRESSION_RATIO_AT_LEVEL
: &'static str = "rocksdb.compression-ratio-at-level";

27 
pub
 cÚ¡ 
ROCKSDB_NUM_SNAPSHOTS
: &'static str = "rocksdb.num-snapshots";

28 
pub
 cÚ¡ 
ROCKSDB_OLDEST_SNAPSHOT_TIME
: &'static str = "rocksdb.oldest-snapshot-time";

30 
pub
 cÚ¡ 
ENGINE_TICKER_TYPES
: &'static [TickerType] = &[

31 
Tick”Ty³
::
BlockCacheMiss
,

32 
	gTick”Ty³
::
BlockCacheH™
,

33 
	gTick”Ty³
::
BlockCacheAdd
,

34 
	gTick”Ty³
::
BlockCacheAddFau»s
,

35 
	gTick”Ty³
::
BlockCacheIndexMiss
,

36 
	gTick”Ty³
::
BlockCacheIndexH™
,

37 
	gTick”Ty³
::
BlockCacheIndexAdd
,

38 
	gTick”Ty³
::
BlockCacheIndexBy‹sIn£¹
,

39 
	gTick”Ty³
::
BlockCacheIndexBy‹sEviù
,

40 
	gTick”Ty³
::
BlockCacheF‹rMiss
,

41 
	gTick”Ty³
::
BlockCacheF‹rH™
,

42 
	gTick”Ty³
::
BlockCacheF‹rAdd
,

43 
	gTick”Ty³
::
BlockCacheF‹rBy‹sIn£¹
,

44 
	gTick”Ty³
::
BlockCacheF‹rBy‹sEviù
,

45 
	gTick”Ty³
::
BlockCacheD©aMiss
,

46 
	gTick”Ty³
::
BlockCacheD©aH™
,

47 
	gTick”Ty³
::
BlockCacheD©aAdd
,

48 
	gTick”Ty³
::
BlockCacheD©aBy‹sIn£¹
,

49 
	gTick”Ty³
::
BlockCacheBy‹R—d
,

50 
	gTick”Ty³
::
BlockCacheBy‹Wr™e
,

51 
	gTick”Ty³
::
BloomF‹rU£ful
,

52 
	gTick”Ty³
::
MembËH™
,

53 
	gTick”Ty³
::
MembËMiss
,

54 
	gTick”Ty³
::
G‘H™L0
,

55 
	gTick”Ty³
::
G‘H™L1
,

56 
	gTick”Ty³
::
G‘H™L2AndUp
,

57 
	gTick”Ty³
::
Com·ùiÚKeyDrİNew”EÁry
,

58 
	gTick”Ty³
::
Com·ùiÚKeyDrİObsŞ‘e
,

59 
	gTick”Ty³
::
Com·ùiÚKeyDrİRªgeD–
,

60 
	gTick”Ty³
::
Com·ùiÚRªgeD–DrİObsŞ‘e
,

61 
	gTick”Ty³
::
Numb”KeysWr™‹n
,

62 
	gTick”Ty³
::
Numb”KeysR—d
,

63 
	gTick”Ty³
::
By‹sWr™‹n
,

64 
	gTick”Ty³
::
By‹sR—d
,

65 
	gTick”Ty³
::
Numb”DbS“k
,

66 
	gTick”Ty³
::
Numb”DbNext
,

67 
	gTick”Ty³
::
Numb”DbP»v
,

68 
	gTick”Ty³
::
Numb”DbS“kFound
,

69 
	gTick”Ty³
::
Numb”DbNextFound
,

70 
	gTick”Ty³
::
Numb”DbP»vFound
,

71 
	gTick”Ty³
::
I‹rBy‹sR—d
,

72 
	gTick”Ty³
::
NoFeClo£s
,

73 
	gTick”Ty³
::
NoFeO³ns
,

74 
	gTick”Ty³
::
NoFeE¼Üs
,

75 
	gTick”Ty³
::
SÎMiüos
,

76 
	gTick”Ty³
::
NoI‹¿tÜs
,

77 
	gTick”Ty³
::
BloomF‹rP»fixChecked
,

78 
	gTick”Ty³
::
BloomF‹rP»fixU£ful
,

79 
	gTick”Ty³
::
W®FeSynûd
,

80 
	gTick”Ty³
::
W®FeBy‹s
,

81 
	gTick”Ty³
::
Wr™eDÚeByS–f
,

82 
	gTick”Ty³
::
Wr™eDÚeByOth”
,

83 
	gTick”Ty³
::
Wr™eTimeout
,

84 
	gTick”Ty³
::
Wr™eW™hWAL
,

85 
	gTick”Ty³
::
Com·ùR—dBy‹s
,

86 
	gTick”Ty³
::
Com·ùWr™eBy‹s
,

87 
	gTick”Ty³
::
FlushWr™eBy‹s
,

88 
	gTick”Ty³
::
R—dAmpE¡im©eU£fulBy‹s
,

89 
	gTick”Ty³
::
R—dAmpTÙ®R—dBy‹s
,

91 
pub
 cÚ¡ 
	gENGINE_HIST_TYPES
: &'static [HistType] = &[

92 
Hi¡Ty³
::
G‘Miüos
,

93 
	gHi¡Ty³
::
Wr™eMiüos
,

94 
	gHi¡Ty³
::
Com·ùiÚTime
,

95 
	gHi¡Ty³
::
TabËSyncMiüos
,

96 
	gHi¡Ty³
::
Com·ùiÚOutfeSyncMiüos
,

97 
	gHi¡Ty³
::
W®FeSyncMiüos
,

98 
	gHi¡Ty³
::
Mªiã¡FeSyncMiüos
,

99 
	gHi¡Ty³
::
SÎL0SlowdownCouÁ
,

100 
	gHi¡Ty³
::
SÎMembËCom·ùiÚCouÁ
,

101 
	gHi¡Ty³
::
SÎL0NumFesCouÁ
,

102 
	gHi¡Ty³
::
H¬dR©eLim™D–ayCouÁ
,

103 
	gHi¡Ty³
::
SoáR©eLim™D–ayCouÁ
,

104 
	gHi¡Ty³
::
NumFesInSšgËCom·ùiÚ
,

105 
	gHi¡Ty³
::
S“kMiüos
,

106 
	gHi¡Ty³
::
Wr™eSÎ
,

107 
	gHi¡Ty³
::
SSTR—dMiüos
,

108 
	gHi¡Ty³
::
NumSubcom·ùiÚsScheduËd
,

109 
	gHi¡Ty³
::
By‹sP”R—d
,

110 
	gHi¡Ty³
::
By‹sP”Wr™e
,

111 
	gHi¡Ty³
::
By‹sCom´es£d
,

112 
	gHi¡Ty³
::
By‹sDecom´es£d
,

113 
	gHi¡Ty³
::
Com´essiÚTimesNªos
,

114 
	gHi¡Ty³
::
Decom´essiÚTimesNªos
,

117 
pub
 
â
 
	$æush_’gše_tick”_m‘rics
(
t
: 
Tick”Ty³
, 
v®ue
: 
u64
, 
Çme
: &
¡r
) {

118 
m©ch
 
t
 {

119 
Tick”Ty³
::
BlockCacheMiss
 => {

120 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


121 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_miss"])

122 .
	`šc_by
(
v®ue
 
as
 
f64
)

123 .
	`unw¿p
();

125 
Tick”Ty³
::
BlockCacheH™
 => {

126 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


127 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_hit"])

128 .
	`šc_by
(
v®ue
 
as
 
f64
)

129 .
	`unw¿p
();

131 
Tick”Ty³
::
BlockCacheAdd
 => {

132 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


133 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_add"])

134 .
	`šc_by
(
v®ue
 
as
 
f64
)

135 .
	`unw¿p
();

137 
Tick”Ty³
::
BlockCacheAddFau»s
 => {

138 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


139 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_add_failures"])

140 .
	`šc_by
(
v®ue
 
as
 
f64
)

141 .
	`unw¿p
();

143 
Tick”Ty³
::
BlockCacheIndexMiss
 => {

144 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


145 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_index_miss"])

146 .
	`šc_by
(
v®ue
 
as
 
f64
)

147 .
	`unw¿p
();

149 
Tick”Ty³
::
BlockCacheIndexH™
 => {

150 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


151 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_index_hit"])

152 .
	`šc_by
(
v®ue
 
as
 
f64
)

153 .
	`unw¿p
();

155 
Tick”Ty³
::
BlockCacheIndexAdd
 => {

156 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


157 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_index_add"])

158 .
	`šc_by
(
v®ue
 
as
 
f64
)

159 .
	`unw¿p
();

161 
Tick”Ty³
::
BlockCacheIndexBy‹sIn£¹
 => {

162 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


163 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_index_bytes_insert"])

164 .
	`šc_by
(
v®ue
 
as
 
f64
)

165 .
	`unw¿p
();

167 
Tick”Ty³
::
BlockCacheIndexBy‹sEviù
 => {

168 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


169 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_index_bytes_evict"])

170 .
	`šc_by
(
v®ue
 
as
 
f64
)

171 .
	`unw¿p
();

173 
Tick”Ty³
::
BlockCacheF‹rMiss
 => {

174 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


175 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_filter_miss"])

176 .
	`šc_by
(
v®ue
 
as
 
f64
)

177 .
	`unw¿p
();

179 
Tick”Ty³
::
BlockCacheF‹rH™
 => {

180 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


181 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_filter_hit"])

182 .
	`šc_by
(
v®ue
 
as
 
f64
)

183 .
	`unw¿p
();

185 
Tick”Ty³
::
BlockCacheF‹rAdd
 => {

186 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


187 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_filter_add"])

188 .
	`šc_by
(
v®ue
 
as
 
f64
)

189 .
	`unw¿p
();

191 
Tick”Ty³
::
BlockCacheF‹rBy‹sIn£¹
 => {

192 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


193 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_filter_bytes_insert"])

194 .
	`šc_by
(
v®ue
 
as
 
f64
)

195 .
	`unw¿p
();

197 
Tick”Ty³
::
BlockCacheF‹rBy‹sEviù
 => {

198 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


199 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_filter_bytes_evict"])

200 .
	`šc_by
(
v®ue
 
as
 
f64
)

201 .
	`unw¿p
();

203 
Tick”Ty³
::
BlockCacheD©aMiss
 => {

204 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


205 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_data_miss"])

206 .
	`šc_by
(
v®ue
 
as
 
f64
)

207 .
	`unw¿p
();

209 
Tick”Ty³
::
BlockCacheD©aH™
 => {

210 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


211 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_data_hit"])

212 .
	`šc_by
(
v®ue
 
as
 
f64
)

213 .
	`unw¿p
();

215 
Tick”Ty³
::
BlockCacheD©aAdd
 => {

216 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


217 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_data_add"])

218 .
	`šc_by
(
v®ue
 
as
 
f64
)

219 .
	`unw¿p
();

221 
Tick”Ty³
::
BlockCacheD©aBy‹sIn£¹
 => {

222 
STORE_ENGINE_CACHE_EFFICIENCY_VEC


223 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_data_bytes_insert"])

224 .
	`šc_by
(
v®ue
 
as
 
f64
)

225 .
	`unw¿p
();

227 
Tick”Ty³
::
BlockCacheBy‹R—d
 => {

228 
STORE_ENGINE_FLOW_VEC


229 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_byte_read"])

230 .
	`šc_by
(
v®ue
 
as
 
f64
)

231 .
	`unw¿p
();

233 
Tick”Ty³
::
BlockCacheBy‹Wr™e
 => {

234 
STORE_ENGINE_FLOW_VEC


235 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "block_cache_byte_write"])

236 .
	`šc_by
(
v®ue
 
as
 
f64
)

237 .
	`unw¿p
();

239 
Tick”Ty³
::
BloomF‹rU£ful
 => {

240 
STORE_ENGINE_BLOOM_EFFICIENCY_VEC


241 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bloom_useful"])

242 .
	`šc_by
(
v®ue
 
as
 
f64
)

243 .
	`unw¿p
();

245 
Tick”Ty³
::
MembËH™
 => {

246 
STORE_ENGINE_MEMTABLE_EFFICIENCY_VEC


247 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "memtable_hit"])

248 .
	`šc_by
(
v®ue
 
as
 
f64
)

249 .
	`unw¿p
();

251 
Tick”Ty³
::
MembËMiss
 => {

252 
STORE_ENGINE_MEMTABLE_EFFICIENCY_VEC


253 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "memtable_miss"])

254 .
	`šc_by
(
v®ue
 
as
 
f64
)

255 .
	`unw¿p
();

257 
Tick”Ty³
::
G‘H™L0
 => {

258 
STORE_ENGINE_GET_SERVED_VEC


259 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "get_hit_l0"])

260 .
	`šc_by
(
v®ue
 
as
 
f64
)

261 .
	`unw¿p
();

263 
Tick”Ty³
::
G‘H™L1
 => {

264 
STORE_ENGINE_GET_SERVED_VEC


265 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "get_hit_l1"])

266 .
	`šc_by
(
v®ue
 
as
 
f64
)

267 .
	`unw¿p
();

269 
Tick”Ty³
::
G‘H™L2AndUp
 => {

270 
STORE_ENGINE_GET_SERVED_VEC


271 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "get_hit_l2_and_up"])

272 .
	`šc_by
(
v®ue
 
as
 
f64
)

273 .
	`unw¿p
();

275 
Tick”Ty³
::
Com·ùiÚKeyDrİNew”EÁry
 => {

276 
STORE_ENGINE_COMPACTION_DROP_VEC


277 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_key_drop_newer_entry"])

278 .
	`šc_by
(
v®ue
 
as
 
f64
)

279 .
	`unw¿p
();

281 
Tick”Ty³
::
Com·ùiÚKeyDrİObsŞ‘e
 => {

282 
STORE_ENGINE_COMPACTION_DROP_VEC


283 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_key_drop_obsolete"])

284 .
	`šc_by
(
v®ue
 
as
 
f64
)

285 .
	`unw¿p
();

287 
Tick”Ty³
::
Com·ùiÚKeyDrİRªgeD–
 => {

288 
STORE_ENGINE_COMPACTION_DROP_VEC


289 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_key_drop_range_del"])

290 .
	`šc_by
(
v®ue
 
as
 
f64
)

291 .
	`unw¿p
();

293 
Tick”Ty³
::
Com·ùiÚRªgeD–DrİObsŞ‘e
 => {

294 
STORE_ENGINE_COMPACTION_DROP_VEC


295 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "range_del_drop_obsolete"])

296 .
	`šc_by
(
v®ue
 
as
 
f64
)

297 .
	`unw¿p
();

299 
Tick”Ty³
::
Com·ùiÚO±imizedD–DrİObsŞ‘e
 => {

300 
STORE_ENGINE_COMPACTION_DROP_VEC


301 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "optimized_del_drop_obsolete"])

302 .
	`šc_by
(
v®ue
 
as
 
f64
)

303 .
	`unw¿p
();

305 
Tick”Ty³
::
Numb”KeysWr™‹n
 => {

306 
STORE_ENGINE_FLOW_VEC


307 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "keys_written"])

308 .
	`šc_by
(
v®ue
 
as
 
f64
)

309 .
	`unw¿p
();

311 
Tick”Ty³
::
Numb”KeysR—d
 => {

312 
STORE_ENGINE_FLOW_VEC


313 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "keys_read"])

314 .
	`šc_by
(
v®ue
 
as
 
f64
)

315 .
	`unw¿p
();

317 
Tick”Ty³
::
Numb”KeysUpd©ed
 => {

318 
STORE_ENGINE_FLOW_VEC


319 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "keys_updated"])

320 .
	`šc_by
(
v®ue
 
as
 
f64
)

321 .
	`unw¿p
();

323 
Tick”Ty³
::
By‹sWr™‹n
 => {

324 
STORE_ENGINE_FLOW_VEC


325 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_written"])

326 .
	`šc_by
(
v®ue
 
as
 
f64
)

327 .
	`unw¿p
();

329 
Tick”Ty³
::
By‹sR—d
 => {

330 
STORE_ENGINE_FLOW_VEC


331 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_read"])

332 .
	`šc_by
(
v®ue
 
as
 
f64
)

333 .
	`unw¿p
();

335 
Tick”Ty³
::
Numb”DbS“k
 => {

336 
STORE_ENGINE_LOCATE_VEC


337 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "number_db_seek"])

338 .
	`šc_by
(
v®ue
 
as
 
f64
)

339 .
	`unw¿p
();

341 
Tick”Ty³
::
Numb”DbNext
 => {

342 
STORE_ENGINE_LOCATE_VEC


343 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "number_db_next"])

344 .
	`šc_by
(
v®ue
 
as
 
f64
)

345 .
	`unw¿p
();

347 
Tick”Ty³
::
Numb”DbP»v
 => {

348 
STORE_ENGINE_LOCATE_VEC


349 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "number_db_prev"])

350 .
	`šc_by
(
v®ue
 
as
 
f64
)

351 .
	`unw¿p
();

353 
Tick”Ty³
::
Numb”DbS“kFound
 => {

354 
STORE_ENGINE_LOCATE_VEC


355 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "number_db_seek_found"])

356 .
	`šc_by
(
v®ue
 
as
 
f64
)

357 .
	`unw¿p
();

359 
Tick”Ty³
::
Numb”DbNextFound
 => {

360 
STORE_ENGINE_LOCATE_VEC


361 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "number_db_next_found"])

362 .
	`šc_by
(
v®ue
 
as
 
f64
)

363 .
	`unw¿p
();

365 
Tick”Ty³
::
Numb”DbP»vFound
 => {

366 
STORE_ENGINE_LOCATE_VEC


367 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "number_db_prev_found"])

368 .
	`šc_by
(
v®ue
 
as
 
f64
)

369 .
	`unw¿p
();

371 
Tick”Ty³
::
I‹rBy‹sR—d
 => {

372 
STORE_ENGINE_FLOW_VEC


373 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "iter_bytes_read"])

374 .
	`šc_by
(
v®ue
 
as
 
f64
)

375 .
	`unw¿p
();

377 
Tick”Ty³
::
NoFeClo£s
 => {

378 
STORE_ENGINE_FILE_STATUS_VEC


379 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "no_file_closes"])

380 .
	`šc_by
(
v®ue
 
as
 
f64
)

381 .
	`unw¿p
();

383 
Tick”Ty³
::
NoFeO³ns
 => {

384 
STORE_ENGINE_FILE_STATUS_VEC


385 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "no_file_opens"])

386 .
	`šc_by
(
v®ue
 
as
 
f64
)

387 .
	`unw¿p
();

389 
Tick”Ty³
::
NoFeE¼Üs
 => {

390 
STORE_ENGINE_FILE_STATUS_VEC


391 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "no_file_errors"])

392 .
	`šc_by
(
v®ue
 
as
 
f64
)

393 .
	`unw¿p
();

395 
Tick”Ty³
::
SÎMiüos
 => {

396 
STORE_ENGINE_STALL_MICROS


397 .
	`w™h_Ïb–_v®ues
(&[
Çme
])

398 .
	`šc_by
(
v®ue
 
as
 
f64
)

399 .
	`unw¿p
();

401 
Tick”Ty³
::
NoI‹¿tÜs
 => {

402 
STORE_ENGINE_NO_ITERATORS


403 .
	`w™h_Ïb–_v®ues
(&[
Çme
])

404 .
	`šc_by
(
v®ue
 
as
 
f64
)

405 .
	`unw¿p
();

407 
Tick”Ty³
::
BloomF‹rP»fixChecked
 => {

408 
STORE_ENGINE_BLOOM_EFFICIENCY_VEC


409 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bloom_prefix_checked"])

410 .
	`šc_by
(
v®ue
 
as
 
f64
)

411 .
	`unw¿p
();

413 
Tick”Ty³
::
BloomF‹rP»fixU£ful
 => {

414 
STORE_ENGINE_BLOOM_EFFICIENCY_VEC


415 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bloom_prefix_useful"])

416 .
	`šc_by
(
v®ue
 
as
 
f64
)

417 .
	`unw¿p
();

419 
Tick”Ty³
::
W®FeSynûd
 => {

420 
STORE_ENGINE_WAL_FILE_SYNCED


421 .
	`w™h_Ïb–_v®ues
(&[
Çme
])

422 .
	`šc_by
(
v®ue
 
as
 
f64
)

423 .
	`unw¿p
();

425 
Tick”Ty³
::
W®FeBy‹s
 => {

426 
STORE_ENGINE_FLOW_VEC


427 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "wal_file_bytes"])

428 .
	`šc_by
(
v®ue
 
as
 
f64
)

429 .
	`unw¿p
();

431 
Tick”Ty³
::
Wr™eDÚeByS–f
 => {

432 
STORE_ENGINE_WRITE_SERVED_VEC


433 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_done_by_self"])

434 .
	`šc_by
(
v®ue
 
as
 
f64
)

435 .
	`unw¿p
();

437 
Tick”Ty³
::
Wr™eDÚeByOth”
 => {

438 
STORE_ENGINE_WRITE_SERVED_VEC


439 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_done_by_other"])

440 .
	`šc_by
(
v®ue
 
as
 
f64
)

441 .
	`unw¿p
();

443 
Tick”Ty³
::
Wr™eTimeout
 => {

444 
STORE_ENGINE_WRITE_SERVED_VEC


445 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_timeout"])

446 .
	`šc_by
(
v®ue
 
as
 
f64
)

447 .
	`unw¿p
();

449 
Tick”Ty³
::
Wr™eW™hWAL
 => {

450 
STORE_ENGINE_WRITE_SERVED_VEC


451 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_with_wal"])

452 .
	`šc_by
(
v®ue
 
as
 
f64
)

453 .
	`unw¿p
();

455 
Tick”Ty³
::
Com·ùR—dBy‹s
 => {

456 
STORE_ENGINE_COMPACTION_FLOW_VEC


457 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_read"])

458 .
	`šc_by
(
v®ue
 
as
 
f64
)

459 .
	`unw¿p
();

461 
Tick”Ty³
::
Com·ùWr™eBy‹s
 => {

462 
STORE_ENGINE_COMPACTION_FLOW_VEC


463 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_written"])

464 .
	`šc_by
(
v®ue
 
as
 
f64
)

465 .
	`unw¿p
();

467 
Tick”Ty³
::
FlushWr™eBy‹s
 => {

468 
STORE_ENGINE_FLOW_VEC


469 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "flush_write_bytes"])

470 .
	`šc_by
(
v®ue
 
as
 
f64
)

471 .
	`unw¿p
();

473 
Tick”Ty³
::
R—dAmpE¡im©eU£fulBy‹s
 => {

474 
STORE_ENGINE_READ_AMP_FLOW_VEC


475 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "read_amp_estimate_useful_bytes"])

476 .
	`šc_by
(
v®ue
 
as
 
f64
)

477 .
	`unw¿p
();

479 
Tick”Ty³
::
R—dAmpTÙ®R—dBy‹s
 => {

480 
STORE_ENGINE_READ_AMP_FLOW_VEC


481 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "read_amp_total_read_bytes"])

482 .
	`šc_by
(
v®ue
 
as
 
f64
)

483 .
	`unw¿p
();

486 
	}
}

488 
pub
 
â
 
	$æush_’gše_hi¡og¿m_m‘rics
(
t
: 
Hi¡Ty³
, 
v®ue
: 
Hi¡og¿mD©a
, 
Çme
: &
¡r
) {

489 
m©ch
 
t
 {

490 
Hi¡Ty³
::
G‘Miüos
 => {

491 
STORE_ENGINE_GET_MICROS_VEC


492 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "get_median"])

493 .
	`£t
(
v®ue
.
medŸn
);

494 
STORE_ENGINE_GET_MICROS_VEC


495 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "get_percentile95"])

496 .
	`£t
(
v®ue
.
³rûÁe95
);

497 
STORE_ENGINE_GET_MICROS_VEC


498 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "get_percentile99"])

499 .
	`£t
(
v®ue
.
³rûÁe99
);

500 
STORE_ENGINE_GET_MICROS_VEC


501 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "get_average"])

502 .
	`£t
(
v®ue
.
av”age
);

503 
STORE_ENGINE_GET_MICROS_VEC


504 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "get_standard_deviation"])

505 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

506 
STORE_ENGINE_GET_MICROS_VEC


507 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "get_max"])

508 .
	`£t
(
v®ue
.
max
);

510 
Hi¡Ty³
::
Wr™eMiüos
 => {

511 
STORE_ENGINE_WRITE_MICROS_VEC


512 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_median"])

513 .
	`£t
(
v®ue
.
medŸn
);

514 
STORE_ENGINE_WRITE_MICROS_VEC


515 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_percentile95"])

516 .
	`£t
(
v®ue
.
³rûÁe95
);

517 
STORE_ENGINE_WRITE_MICROS_VEC


518 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_percentile99"])

519 .
	`£t
(
v®ue
.
³rûÁe99
);

520 
STORE_ENGINE_WRITE_MICROS_VEC


521 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_average"])

522 .
	`£t
(
v®ue
.
av”age
);

523 
STORE_ENGINE_WRITE_MICROS_VEC


524 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_standard_deviation"])

525 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

526 
STORE_ENGINE_WRITE_MICROS_VEC


527 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_max"])

528 .
	`£t
(
v®ue
.
max
);

530 
Hi¡Ty³
::
Com·ùiÚTime
 => {

531 
STORE_ENGINE_COMPACTION_TIME_VEC


532 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_time_median"])

533 .
	`£t
(
v®ue
.
medŸn
);

534 
STORE_ENGINE_COMPACTION_TIME_VEC


535 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_time_percentile95"])

536 .
	`£t
(
v®ue
.
³rûÁe95
);

537 
STORE_ENGINE_COMPACTION_TIME_VEC


538 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_time_percentile99"])

539 .
	`£t
(
v®ue
.
³rûÁe99
);

540 
STORE_ENGINE_COMPACTION_TIME_VEC


541 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_time_average"])

542 .
	`£t
(
v®ue
.
av”age
);

543 
STORE_ENGINE_COMPACTION_TIME_VEC


544 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_time_standard_deviation"])

545 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

546 
STORE_ENGINE_COMPACTION_TIME_VEC


547 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_time_max"])

548 .
	`£t
(
v®ue
.
max
);

550 
Hi¡Ty³
::
TabËSyncMiüos
 => {

551 
STORE_ENGINE_TABLE_SYNC_MICROS_VEC


552 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "table_sync_median"])

553 .
	`£t
(
v®ue
.
medŸn
);

554 
STORE_ENGINE_TABLE_SYNC_MICROS_VEC


555 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "table_sync_percentile95"])

556 .
	`£t
(
v®ue
.
³rûÁe95
);

557 
STORE_ENGINE_TABLE_SYNC_MICROS_VEC


558 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "table_sync_percentile99"])

559 .
	`£t
(
v®ue
.
³rûÁe99
);

560 
STORE_ENGINE_TABLE_SYNC_MICROS_VEC


561 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "table_sync_average"])

562 .
	`£t
(
v®ue
.
av”age
);

563 
STORE_ENGINE_TABLE_SYNC_MICROS_VEC


564 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "table_sync_standard_deviation"])

565 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

566 
STORE_ENGINE_TABLE_SYNC_MICROS_VEC


567 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "table_sync_max"])

568 .
	`£t
(
v®ue
.
max
);

570 
Hi¡Ty³
::
Com·ùiÚOutfeSyncMiüos
 => {

571 
STORE_ENGINE_COMPACTION_OUTFILE_SYNC_MICROS_VEC


572 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_outfile_sync_median"])

573 .
	`£t
(
v®ue
.
medŸn
);

574 
STORE_ENGINE_COMPACTION_OUTFILE_SYNC_MICROS_VEC


575 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_outfile_sync_percentile95"])

576 .
	`£t
(
v®ue
.
³rûÁe95
);

577 
STORE_ENGINE_COMPACTION_OUTFILE_SYNC_MICROS_VEC


578 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_outfile_sync_percentile99"])

579 .
	`£t
(
v®ue
.
³rûÁe99
);

580 
STORE_ENGINE_COMPACTION_OUTFILE_SYNC_MICROS_VEC


581 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_outfile_sync_average"])

582 .
	`£t
(
v®ue
.
av”age
);

583 
STORE_ENGINE_COMPACTION_OUTFILE_SYNC_MICROS_VEC


584 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_outfile_sync_standard_deviation"])

585 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

586 
STORE_ENGINE_COMPACTION_OUTFILE_SYNC_MICROS_VEC


587 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compaction_outfile_sync_max"])

588 .
	`£t
(
v®ue
.
max
);

590 
Hi¡Ty³
::
W®FeSyncMiüos
 => {

591 
STORE_ENGINE_WAL_FILE_SYNC_MICROS_VEC


592 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "wal_file_sync_median"])

593 .
	`£t
(
v®ue
.
medŸn
);

594 
STORE_ENGINE_WAL_FILE_SYNC_MICROS_VEC


595 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "wal_file_sync_percentile95"])

596 .
	`£t
(
v®ue
.
³rûÁe95
);

597 
STORE_ENGINE_WAL_FILE_SYNC_MICROS_VEC


598 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "wal_file_sync_percentile99"])

599 .
	`£t
(
v®ue
.
³rûÁe99
);

600 
STORE_ENGINE_WAL_FILE_SYNC_MICROS_VEC


601 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "wal_file_sync_average"])

602 .
	`£t
(
v®ue
.
av”age
);

603 
STORE_ENGINE_WAL_FILE_SYNC_MICROS_VEC


604 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "wal_file_sync_standard_deviation"])

605 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

606 
STORE_ENGINE_WAL_FILE_SYNC_MICROS_VEC


607 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "wal_file_sync_max"])

608 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

610 
Hi¡Ty³
::
Mªiã¡FeSyncMiüos
 => {

611 
STORE_ENGINE_MANIFEST_FILE_SYNC_MICROS_VEC


612 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "manifest_file_sync_median"])

613 .
	`£t
(
v®ue
.
medŸn
);

614 
STORE_ENGINE_MANIFEST_FILE_SYNC_MICROS_VEC


615 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "manifest_file_sync_percentile95"])

616 .
	`£t
(
v®ue
.
³rûÁe95
);

617 
STORE_ENGINE_MANIFEST_FILE_SYNC_MICROS_VEC


618 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "manifest_file_sync_percentile99"])

619 .
	`£t
(
v®ue
.
³rûÁe99
);

620 
STORE_ENGINE_MANIFEST_FILE_SYNC_MICROS_VEC


621 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "manifest_file_sync_average"])

622 .
	`£t
(
v®ue
.
av”age
);

623 
STORE_ENGINE_MANIFEST_FILE_SYNC_MICROS_VEC


624 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "manifest_file_sync_standard_deviation"])

625 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

626 
STORE_ENGINE_MANIFEST_FILE_SYNC_MICROS_VEC


627 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "manifest_file_sync_max"])

628 .
	`£t
(
v®ue
.
max
);

630 
Hi¡Ty³
::
SÎL0SlowdownCouÁ
 => {

631 
STORE_ENGINE_STALL_L0_SLOWDOWN_COUNT_VEC


632 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_slowdown_count_median"])

633 .
	`£t
(
v®ue
.
medŸn
);

634 
STORE_ENGINE_STALL_L0_SLOWDOWN_COUNT_VEC


635 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_slowdown_count_percentile95"])

636 .
	`£t
(
v®ue
.
³rûÁe95
);

637 
STORE_ENGINE_STALL_L0_SLOWDOWN_COUNT_VEC


638 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_slowdown_count_percentile99"])

639 .
	`£t
(
v®ue
.
³rûÁe99
);

640 
STORE_ENGINE_STALL_L0_SLOWDOWN_COUNT_VEC


641 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_slowdown_count_average"])

642 .
	`£t
(
v®ue
.
av”age
);

643 
STORE_ENGINE_STALL_L0_SLOWDOWN_COUNT_VEC


644 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_slowdown_count_standard_deviation"])

645 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

646 
STORE_ENGINE_STALL_L0_SLOWDOWN_COUNT_VEC


647 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_slowdown_count_max"])

648 .
	`£t
(
v®ue
.
max
);

650 
Hi¡Ty³
::
SÎMembËCom·ùiÚCouÁ
 => {

651 
STORE_ENGINE_STALL_MEMTABLE_COMPACTION_COUNT_VEC


652 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_memtable_compaction_count_median"])

653 .
	`£t
(
v®ue
.
medŸn
);

654 
STORE_ENGINE_STALL_MEMTABLE_COMPACTION_COUNT_VEC


655 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_memtable_compaction_count_percentile95"])

656 .
	`£t
(
v®ue
.
³rûÁe95
);

657 
STORE_ENGINE_STALL_MEMTABLE_COMPACTION_COUNT_VEC


658 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_memtable_compaction_count_percentile99"])

659 .
	`£t
(
v®ue
.
³rûÁe99
);

660 
STORE_ENGINE_STALL_MEMTABLE_COMPACTION_COUNT_VEC


661 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_memtable_compaction_count_average"])

662 .
	`£t
(
v®ue
.
av”age
);

663 
STORE_ENGINE_STALL_MEMTABLE_COMPACTION_COUNT_VEC


664 .
	`w™h_Ïb–_v®ues
(&[

665 
Çme
,

668 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

669 
STORE_ENGINE_STALL_MEMTABLE_COMPACTION_COUNT_VEC


670 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_memtable_compaction_count_max"])

671 .
	`£t
(
v®ue
.
max
);

673 
Hi¡Ty³
::
SÎL0NumFesCouÁ
 => {

674 
STORE_ENGINE_STALL_LO_NUM_FILES_COUNT_VEC


675 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_num_files_count_median"])

676 .
	`£t
(
v®ue
.
medŸn
);

677 
STORE_ENGINE_STALL_LO_NUM_FILES_COUNT_VEC


678 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_num_files_count_percentile95"])

679 .
	`£t
(
v®ue
.
³rûÁe95
);

680 
STORE_ENGINE_STALL_LO_NUM_FILES_COUNT_VEC


681 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_num_files_count_percentile99"])

682 .
	`£t
(
v®ue
.
³rûÁe99
);

683 
STORE_ENGINE_STALL_LO_NUM_FILES_COUNT_VEC


684 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_num_files_count_average"])

685 .
	`£t
(
v®ue
.
av”age
);

686 
STORE_ENGINE_STALL_LO_NUM_FILES_COUNT_VEC


687 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_num_files_count_standard_deviation"])

688 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

689 
STORE_ENGINE_STALL_LO_NUM_FILES_COUNT_VEC


690 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "stall_l0_num_files_count_max"])

691 .
	`£t
(
v®ue
.
max
);

693 
Hi¡Ty³
::
H¬dR©eLim™D–ayCouÁ
 => {

694 
STORE_ENGINE_HARD_RATE_LIMIT_DELAY_COUNT_VEC


695 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "hard_rate_limit_delay_median"])

696 .
	`£t
(
v®ue
.
medŸn
);

697 
STORE_ENGINE_HARD_RATE_LIMIT_DELAY_COUNT_VEC


698 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "hard_rate_limit_delay_percentile95"])

699 .
	`£t
(
v®ue
.
³rûÁe95
);

700 
STORE_ENGINE_HARD_RATE_LIMIT_DELAY_COUNT_VEC


701 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "hard_rate_limit_delay_percentile99"])

702 .
	`£t
(
v®ue
.
³rûÁe99
);

703 
STORE_ENGINE_HARD_RATE_LIMIT_DELAY_COUNT_VEC


704 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "hard_rate_limit_delay_average"])

705 .
	`£t
(
v®ue
.
av”age
);

706 
STORE_ENGINE_HARD_RATE_LIMIT_DELAY_COUNT_VEC


707 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "hard_rate_limit_delay_standard_deviation"])

708 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

709 
STORE_ENGINE_HARD_RATE_LIMIT_DELAY_COUNT_VEC


710 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "hard_rate_limit_delay_max"])

711 .
	`£t
(
v®ue
.
max
);

713 
Hi¡Ty³
::
SoáR©eLim™D–ayCouÁ
 => {

714 
STORE_ENGINE_SOFT_RATE_LIMIT_DELAY_COUNT_VEC


715 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "soft_rate_limit_delay_median"])

716 .
	`£t
(
v®ue
.
medŸn
);

717 
STORE_ENGINE_SOFT_RATE_LIMIT_DELAY_COUNT_VEC


718 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "soft_rate_limit_delay_percentile95"])

719 .
	`£t
(
v®ue
.
³rûÁe95
);

720 
STORE_ENGINE_SOFT_RATE_LIMIT_DELAY_COUNT_VEC


721 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "soft_rate_limit_delay_percentile99"])

722 .
	`£t
(
v®ue
.
³rûÁe99
);

723 
STORE_ENGINE_SOFT_RATE_LIMIT_DELAY_COUNT_VEC


724 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "soft_rate_limit_delay_average"])

725 .
	`£t
(
v®ue
.
av”age
);

726 
STORE_ENGINE_SOFT_RATE_LIMIT_DELAY_COUNT_VEC


727 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "soft_rate_limit_delay_standard_deviation"])

728 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

729 
STORE_ENGINE_SOFT_RATE_LIMIT_DELAY_COUNT_VEC


730 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "soft_rate_limit_delay_max"])

731 .
	`£t
(
v®ue
.
max
);

733 
Hi¡Ty³
::
NumFesInSšgËCom·ùiÚ
 => {

734 
STORE_ENGINE_NUM_FILES_IN_SINGLE_COMPACTION_VEC


735 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_files_in_single_compaction_median"])

736 .
	`£t
(
v®ue
.
medŸn
);

737 
STORE_ENGINE_NUM_FILES_IN_SINGLE_COMPACTION_VEC


738 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_files_in_single_compaction_percentile95"])

739 .
	`£t
(
v®ue
.
³rûÁe95
);

740 
STORE_ENGINE_NUM_FILES_IN_SINGLE_COMPACTION_VEC


741 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_files_in_single_compaction_percentile99"])

742 .
	`£t
(
v®ue
.
³rûÁe99
);

743 
STORE_ENGINE_NUM_FILES_IN_SINGLE_COMPACTION_VEC


744 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_files_in_single_compaction_average"])

745 .
	`£t
(
v®ue
.
av”age
);

746 
STORE_ENGINE_NUM_FILES_IN_SINGLE_COMPACTION_VEC


747 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_files_in_single_compaction_standard_deviation"])

748 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

749 
STORE_ENGINE_NUM_FILES_IN_SINGLE_COMPACTION_VEC


750 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_files_in_single_compaction_max"])

751 .
	`£t
(
v®ue
.
max
);

753 
Hi¡Ty³
::
S“kMiüos
 => {

754 
STORE_ENGINE_SEEK_MICROS_VEC


755 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "seek_median"])

756 .
	`£t
(
v®ue
.
medŸn
);

757 
STORE_ENGINE_SEEK_MICROS_VEC


758 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "seek_percentile95"])

759 .
	`£t
(
v®ue
.
³rûÁe95
);

760 
STORE_ENGINE_SEEK_MICROS_VEC


761 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "seek_percentile99"])

762 .
	`£t
(
v®ue
.
³rûÁe99
);

763 
STORE_ENGINE_SEEK_MICROS_VEC


764 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "seek_average"])

765 .
	`£t
(
v®ue
.
av”age
);

766 
STORE_ENGINE_SEEK_MICROS_VEC


767 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "seek_standard_deviation"])

768 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

769 
STORE_ENGINE_SEEK_MICROS_VEC


770 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "seek_max"])

771 .
	`£t
(
v®ue
.
max
);

773 
Hi¡Ty³
::
Wr™eSÎ
 => {

774 
STORE_ENGINE_WRITE_STALL_VEC


775 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_stall_median"])

776 .
	`£t
(
v®ue
.
medŸn
);

777 
STORE_ENGINE_WRITE_STALL_VEC


778 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_stall_percentile95"])

779 .
	`£t
(
v®ue
.
³rûÁe95
);

780 
STORE_ENGINE_WRITE_STALL_VEC


781 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_stall_percentile99"])

782 .
	`£t
(
v®ue
.
³rûÁe99
);

783 
STORE_ENGINE_WRITE_STALL_VEC


784 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_stall_average"])

785 .
	`£t
(
v®ue
.
av”age
);

786 
STORE_ENGINE_WRITE_STALL_VEC


787 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_stall_standard_deviation"])

788 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

789 
STORE_ENGINE_WRITE_STALL_VEC


790 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "write_stall_max"])

791 .
	`£t
(
v®ue
.
max
);

793 
Hi¡Ty³
::
SSTR—dMiüos
 => {

794 
STORE_ENGINE_SST_READ_MICROS_VEC


795 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "sst_read_micros_median"])

796 .
	`£t
(
v®ue
.
medŸn
);

797 
STORE_ENGINE_SST_READ_MICROS_VEC


798 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "sst_read_micros_percentile95"])

799 .
	`£t
(
v®ue
.
³rûÁe95
);

800 
STORE_ENGINE_SST_READ_MICROS_VEC


801 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "sst_read_micros_percentile99"])

802 .
	`£t
(
v®ue
.
³rûÁe99
);

803 
STORE_ENGINE_SST_READ_MICROS_VEC


804 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "sst_read_micros_average"])

805 .
	`£t
(
v®ue
.
av”age
);

806 
STORE_ENGINE_SST_READ_MICROS_VEC


807 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "sst_read_micros_standard_deviation"])

808 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

809 
STORE_ENGINE_SST_READ_MICROS_VEC


810 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "sst_read_micros_max"])

811 .
	`£t
(
v®ue
.
max
);

813 
Hi¡Ty³
::
NumSubcom·ùiÚsScheduËd
 => {

814 
STORE_ENGINE_NUM_SUBCOMPACTION_SCHEDULED_VEC


815 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_subcompaction_scheduled_median"])

816 .
	`£t
(
v®ue
.
medŸn
);

817 
STORE_ENGINE_NUM_SUBCOMPACTION_SCHEDULED_VEC


818 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_subcompaction_scheduled_percentile95"])

819 .
	`£t
(
v®ue
.
³rûÁe95
);

820 
STORE_ENGINE_NUM_SUBCOMPACTION_SCHEDULED_VEC


821 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_subcompaction_scheduled_percentile99"])

822 .
	`£t
(
v®ue
.
³rûÁe99
);

823 
STORE_ENGINE_NUM_SUBCOMPACTION_SCHEDULED_VEC


824 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_subcompaction_scheduled_average"])

825 .
	`£t
(
v®ue
.
av”age
);

826 
STORE_ENGINE_NUM_SUBCOMPACTION_SCHEDULED_VEC


827 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_subcompaction_scheduled_standard_deviation"])

828 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

829 
STORE_ENGINE_NUM_SUBCOMPACTION_SCHEDULED_VEC


830 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "num_subcompaction_scheduled_max"])

831 .
	`£t
(
v®ue
.
max
);

833 
Hi¡Ty³
::
By‹sP”R—d
 => {

834 
STORE_ENGINE_BYTES_PER_READ_VEC


835 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_read_median"])

836 .
	`£t
(
v®ue
.
medŸn
);

837 
STORE_ENGINE_BYTES_PER_READ_VEC


838 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_read_percentile95"])

839 .
	`£t
(
v®ue
.
³rûÁe95
);

840 
STORE_ENGINE_BYTES_PER_READ_VEC


841 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_read_percentile99"])

842 .
	`£t
(
v®ue
.
³rûÁe99
);

843 
STORE_ENGINE_BYTES_PER_READ_VEC


844 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_read_average"])

845 .
	`£t
(
v®ue
.
av”age
);

846 
STORE_ENGINE_BYTES_PER_READ_VEC


847 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_read_standard_deviation"])

848 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

849 
STORE_ENGINE_BYTES_PER_READ_VEC


850 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_read_max"])

851 .
	`£t
(
v®ue
.
max
);

853 
Hi¡Ty³
::
By‹sP”Wr™e
 => {

854 
STORE_ENGINE_BYTES_PER_WRITE_VEC


855 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_write_median"])

856 .
	`£t
(
v®ue
.
medŸn
);

857 
STORE_ENGINE_BYTES_PER_WRITE_VEC


858 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_write_percentile95"])

859 .
	`£t
(
v®ue
.
³rûÁe95
);

860 
STORE_ENGINE_BYTES_PER_WRITE_VEC


861 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_write_percentile99"])

862 .
	`£t
(
v®ue
.
³rûÁe99
);

863 
STORE_ENGINE_BYTES_PER_WRITE_VEC


864 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_write_average"])

865 .
	`£t
(
v®ue
.
av”age
);

866 
STORE_ENGINE_BYTES_PER_WRITE_VEC


867 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_write_standard_deviation"])

868 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

869 
STORE_ENGINE_BYTES_PER_WRITE_VEC


870 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_per_write_max"])

871 .
	`£t
(
v®ue
.
max
);

873 
Hi¡Ty³
::
By‹sCom´es£d
 => {

874 
STORE_ENGINE_BYTES_COMPRESSED_VEC


875 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_compressed_median"])

876 .
	`£t
(
v®ue
.
medŸn
);

877 
STORE_ENGINE_BYTES_COMPRESSED_VEC


878 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_compressed_percentile95"])

879 .
	`£t
(
v®ue
.
³rûÁe95
);

880 
STORE_ENGINE_BYTES_COMPRESSED_VEC


881 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_compressed_percentile99"])

882 .
	`£t
(
v®ue
.
³rûÁe99
);

883 
STORE_ENGINE_BYTES_COMPRESSED_VEC


884 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_compressed_average"])

885 .
	`£t
(
v®ue
.
av”age
);

886 
STORE_ENGINE_BYTES_COMPRESSED_VEC


887 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_compressed_standard_deviation"])

888 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

889 
STORE_ENGINE_BYTES_COMPRESSED_VEC


890 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_compressed_max"])

891 .
	`£t
(
v®ue
.
max
);

893 
Hi¡Ty³
::
By‹sDecom´es£d
 => {

894 
STORE_ENGINE_BYTES_DECOMPRESSED_VEC


895 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_decompressed_median"])

896 .
	`£t
(
v®ue
.
medŸn
);

897 
STORE_ENGINE_BYTES_DECOMPRESSED_VEC


898 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_decompressed_percentile95"])

899 .
	`£t
(
v®ue
.
³rûÁe95
);

900 
STORE_ENGINE_BYTES_DECOMPRESSED_VEC


901 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_decompressed_percentile99"])

902 .
	`£t
(
v®ue
.
³rûÁe99
);

903 
STORE_ENGINE_BYTES_DECOMPRESSED_VEC


904 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_decompressed_average"])

905 .
	`£t
(
v®ue
.
av”age
);

906 
STORE_ENGINE_BYTES_DECOMPRESSED_VEC


907 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_decompressed_standard_deviation"])

908 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

909 
STORE_ENGINE_BYTES_DECOMPRESSED_VEC


910 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "bytes_decompressed_max"])

911 .
	`£t
(
v®ue
.
max
);

913 
Hi¡Ty³
::
Com´essiÚTimesNªos
 => {

914 
STORE_ENGINE_COMPRESSION_TIMES_NANOS_VEC


915 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compression_time_nanos_median"])

916 .
	`£t
(
v®ue
.
medŸn
);

917 
STORE_ENGINE_COMPRESSION_TIMES_NANOS_VEC


918 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compression_time_nanos_percentile95"])

919 .
	`£t
(
v®ue
.
³rûÁe95
);

920 
STORE_ENGINE_COMPRESSION_TIMES_NANOS_VEC


921 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compression_time_nanos_percentile99"])

922 .
	`£t
(
v®ue
.
³rûÁe99
);

923 
STORE_ENGINE_COMPRESSION_TIMES_NANOS_VEC


924 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compression_time_nanos_average"])

925 .
	`£t
(
v®ue
.
av”age
);

926 
STORE_ENGINE_COMPRESSION_TIMES_NANOS_VEC


927 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compression_time_nanos_standard_deviation"])

928 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

929 
STORE_ENGINE_COMPRESSION_TIMES_NANOS_VEC


930 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "compression_time_nanos_max"])

931 .
	`£t
(
v®ue
.
max
);

933 
Hi¡Ty³
::
Decom´essiÚTimesNªos
 => {

934 
STORE_ENGINE_DECOMPRESSION_TIMES_NANOS_VEC


935 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "decompression_time_nanos_median"])

936 .
	`£t
(
v®ue
.
medŸn
);

937 
STORE_ENGINE_DECOMPRESSION_TIMES_NANOS_VEC


938 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "decompression_time_nanos_percentile95"])

939 .
	`£t
(
v®ue
.
³rûÁe95
);

940 
STORE_ENGINE_DECOMPRESSION_TIMES_NANOS_VEC


941 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "decompression_time_nanos_percentile99"])

942 .
	`£t
(
v®ue
.
³rûÁe99
);

943 
STORE_ENGINE_DECOMPRESSION_TIMES_NANOS_VEC


944 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "decompression_time_nanos_average"])

945 .
	`£t
(
v®ue
.
av”age
);

946 
STORE_ENGINE_DECOMPRESSION_TIMES_NANOS_VEC


947 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "decompression_time_nanos_standard_deviation"])

948 .
	`£t
(
v®ue
.
¡ªd¬d_devŸtiÚ
);

949 
STORE_ENGINE_DECOMPRESSION_TIMES_NANOS_VEC


950 .
	`w™h_Ïb–_v®ues
(&[
Çme
, "decompression_time_nanos_max"])

951 .
	`£t
(
v®ue
.
max
);

953 
_
 => {}

955 
	}
}

957 
pub
 
â
 
	$æush_’gše_´İ”t›s
(
’gše
: &
DB
, 
Çme
: &
¡r
) {

958 
cf
 
š
 
’gše
.
	`cf_Çmes
() {

959 
Ët
 
hªdË
 = 
rocksdb
::
	`g‘_cf_hªdË
(
’gše
, 
cf
).
	`unw¿p
();

962 
Ët
 
cf_u£d_size
 = 
’gše


963 .
	`g‘_´İ”ty_št_cf
(
hªdË
, 
ROCKSDB_TOTAL_SST_FILES_SIZE
)

964 .
	`ex³ù
("rocksdb isoo old, missingotal-sst-files-size…roperty");

965 
STORE_ENGINE_SIZE_GAUGE_VEC


966 .
	`w™h_Ïb–_v®ues
(&[
Çme
, 
cf
])

967 .
	`£t
(
cf_u£d_size
 
as
 
f64
);

970 
Ët
 
block_ÿche_u§ge
 = 
’gše
.
	`g‘_block_ÿche_u§ge_cf
(
hªdË
);

971 
STORE_ENGINE_BLOCK_CACHE_USAGE_GAUGE_VEC


972 .
	`w™h_Ïb–_v®ues
(&[
Çme
, 
cf
])

973 .
	`£t
(
block_ÿche_u§ge
 
as
 
f64
);

978 
Ët
 
	`Some
(
»ad”s_mem
èğ
’gše
.
	`g‘_´İ”ty_št_cf
(
hªdË
, 
ROCKSDB_TABLE_READERS_MEM
) {

979 
STORE_ENGINE_MEMORY_GAUGE_VEC


980 .
	`w™h_Ïb–_v®ues
(&[
Çme
, 
cf
, "readers-mem"])

981 .
	`£t
(
»ad”s_mem
 
as
 
f64
);

985 
Ët
 
	`Some
(
mem_bË
) =

986 
’gše
.
	`g‘_´İ”ty_št_cf
(
hªdË
, 
ROCKSDB_CUR_SIZE_ALL_MEM_TABLES
)

988 
STORE_ENGINE_MEMORY_GAUGE_VEC


989 .
	`w™h_Ïb–_v®ues
(&[
Çme
, 
cf
, "mem-tables"])

990 .
	`£t
(
mem_bË
 
as
 
f64
);

995 
Ët
 
	`Some
(
num_keys
èğ
’gše
.
	`g‘_´İ”ty_št_cf
(
hªdË
, 
ROCKSDB_ESTIMATE_NUM_KEYS
) {

996 
STORE_ENGINE_ESTIMATE_NUM_KEYS_VEC


997 .
	`w™h_Ïb–_v®ues
(&[
Çme
, 
cf
])

998 .
	`£t
(
num_keys
 
as
 
f64
);

1002 
Ët
 
	`Some
(
³ndšg_com·ùiÚ_by‹s
) =

1003 
’gše
.
	`g‘_´İ”ty_št_cf
(
hªdË
, 
ROCKSDB_PENDING_COMPACTION_BYTES
)

1005 
STORE_ENGINE_PENDING_COMACTION_BYTES_VEC


1006 .
	`w™h_Ïb–_v®ues
(&[
Çme
, 
cf
])

1007 .
	`£t
(
³ndšg_com·ùiÚ_by‹s
 
as
 
f64
);

1011 
Ët
 
İts
 = 
’gše
.
	`g‘_İtiÚs_cf
(
hªdË
);

1012 
Ëv–
 
š
 0..
İts
.
	`g‘_num_Ëv–s
() {

1013 
Ët
 
	`Some
(
v
èğ
rocksdb
::
	`g‘_’gše_com´essiÚ_¿tio_©_Ëv–
(
’gše
, 
hªdË
, 
Ëv–
) {

1014 
Ët
 
Ëv–_¡r
 = 
Ëv–
.
	`to_¡ršg
();

1015 
STORE_ENGINE_COMPRESSION_RATIO_VEC


1016 .
	`w™h_Ïb–_v®ues
(&[
Çme
, 
cf
, &
Ëv–_¡r
])

1017 .
	`£t
(
v
);

1023 
Ët
 
	`Some
(
n
èğ
’gše
.
	`g‘_´İ”ty_št
(
ROCKSDB_NUM_SNAPSHOTS
) {

1024 
STORE_ENGINE_NUM_SNAPSHOTS_GAUGE_VEC


1025 .
	`w™h_Ïb–_v®ues
(&[
Çme
])

1026 .
	`£t
(
n
 
as
 
f64
);

1028 
Ët
 
	`Some
(
t
èğ
’gše
.
	`g‘_´İ”ty_št
(
ROCKSDB_OLDEST_SNAPSHOT_TIME
) {

1030 
Ët
 
now
 = 
time
::
	`g‘_time
().
£c
 
as
 
u64
;

1031 
Ët
 
d
 = 
t
 > 0 && 
now
 > {‚ow - } { 0 };

1032 
STORE_ENGINE_OLDEST_SNAPSHOT_DURATION_GAUGE_VEC


1033 .
	`w™h_Ïb–_v®ues
(&[
Çme
])

1034 .
	`£t
(
d
 
as
 
f64
);

1036 
	}
}

1038 
	gÏzy_¡©ic
!{

1039 
pub
 
»f
 
	gSTORE_ENGINE_SIZE_GAUGE_VEC
: 
GaugeVec
 =

1040 
»gi¡”_gauge_vec
!(

1044 ).
unw¿p
();

1046 
pub
 
»f
 
	gSTORE_ENGINE_BLOCK_CACHE_USAGE_GAUGE_VEC
: 
GaugeVec
 =

1047 
»gi¡”_gauge_vec
!(

1051 ).
unw¿p
();

1053 
pub
 
»f
 
	gSTORE_ENGINE_MEMORY_GAUGE_VEC
: 
GaugeVec
 =

1054 
»gi¡”_gauge_vec
!(

1058 ).
unw¿p
();

1060 
pub
 
»f
 
	gSTORE_ENGINE_ESTIMATE_NUM_KEYS_VEC
: 
GaugeVec
 =

1061 
»gi¡”_gauge_vec
!(

1065 ).
unw¿p
();

1067 
pub
 
»f
 
	gSTORE_ENGINE_CACHE_EFFICIENCY_VEC
: 
CouÁ”Vec
 =

1068 
»gi¡”_couÁ”_vec
!(

1072 ).
unw¿p
();

1074 
pub
 
»f
 
	gSTORE_ENGINE_MEMTABLE_EFFICIENCY_VEC
: 
CouÁ”Vec
 =

1075 
»gi¡”_couÁ”_vec
!(

1079 ).
unw¿p
();

1081 
pub
 
»f
 
	gSTORE_ENGINE_GET_SERVED_VEC
: 
CouÁ”Vec
 =

1082 
»gi¡”_couÁ”_vec
!(

1086 ).
unw¿p
();

1088 
pub
 
»f
 
	gSTORE_ENGINE_WRITE_SERVED_VEC
: 
CouÁ”Vec
 =

1089 
»gi¡”_couÁ”_vec
!(

1093 ).
unw¿p
();

1095 
pub
 
»f
 
	gSTORE_ENGINE_BLOOM_EFFICIENCY_VEC
: 
CouÁ”Vec
 =

1096 
»gi¡”_couÁ”_vec
!(

1100 ).
unw¿p
();

1102 
pub
 
»f
 
	gSTORE_ENGINE_FLOW_VEC
: 
CouÁ”Vec
 =

1103 
»gi¡”_couÁ”_vec
!(

1107 ).
unw¿p
();

1109 
pub
 
»f
 
	gSTORE_ENGINE_STALL_MICROS
: 
CouÁ”Vec
 =

1110 
»gi¡”_couÁ”_vec
!(

1114 ).
unw¿p
();

1116 
pub
 
»f
 
	gSTORE_ENGINE_GET_MICROS_VEC
: 
GaugeVec
 =

1117 
»gi¡”_gauge_vec
!(

1121 ).
unw¿p
();

1123 
pub
 
»f
 
	gSTORE_ENGINE_WRITE_MICROS_VEC
: 
GaugeVec
 =

1124 
»gi¡”_gauge_vec
!(

1128 ).
unw¿p
();

1130 
pub
 
»f
 
	gSTORE_ENGINE_COMPACTION_TIME_VEC
: 
GaugeVec
 =

1131 
»gi¡”_gauge_vec
!(

1135 ).
unw¿p
();

1137 
pub
 
»f
 
	gSTORE_ENGINE_TABLE_SYNC_MICROS_VEC
: 
GaugeVec
 =

1138 
»gi¡”_gauge_vec
!(

1142 ).
unw¿p
();

1144 
pub
 
»f
 
	gSTORE_ENGINE_COMPACTION_OUTFILE_SYNC_MICROS_VEC
: 
GaugeVec
 =

1145 
»gi¡”_gauge_vec
!(

1149 ).
unw¿p
();

1151 
pub
 
»f
 
	gSTORE_ENGINE_MANIFEST_FILE_SYNC_MICROS_VEC
: 
GaugeVec
 =

1152 
»gi¡”_gauge_vec
!(

1156 ).
unw¿p
();

1158 
pub
 
»f
 
	gSTORE_ENGINE_WAL_FILE_SYNC_MICROS_VEC
: 
GaugeVec
 =

1159 
»gi¡”_gauge_vec
!(

1163 ).
unw¿p
();

1165 
pub
 
»f
 
	gSTORE_ENGINE_STALL_L0_SLOWDOWN_COUNT_VEC
: 
GaugeVec
 =

1166 
»gi¡”_gauge_vec
!(

1170 ).
unw¿p
();

1172 
pub
 
»f
 
	gSTORE_ENGINE_STALL_MEMTABLE_COMPACTION_COUNT_VEC
: 
GaugeVec
 =

1173 
»gi¡”_gauge_vec
!(

1177 ).
unw¿p
();

1179 
pub
 
»f
 
	gSTORE_ENGINE_STALL_LO_NUM_FILES_COUNT_VEC
: 
GaugeVec
 =

1180 
»gi¡”_gauge_vec
!(

1184 ).
unw¿p
();

1186 
pub
 
»f
 
	gSTORE_ENGINE_HARD_RATE_LIMIT_DELAY_COUNT_VEC
: 
GaugeVec
 =

1187 
»gi¡”_gauge_vec
!(

1191 ).
unw¿p
();

1193 
pub
 
»f
 
	gSTORE_ENGINE_SOFT_RATE_LIMIT_DELAY_COUNT_VEC
: 
GaugeVec
 =

1194 
»gi¡”_gauge_vec
!(

1198 ).
unw¿p
();

1200 
pub
 
»f
 
	gSTORE_ENGINE_NUM_FILES_IN_SINGLE_COMPACTION_VEC
: 
GaugeVec
 =

1201 
»gi¡”_gauge_vec
!(

1205 ).
unw¿p
();

1207 
pub
 
»f
 
	gSTORE_ENGINE_SEEK_MICROS_VEC
: 
GaugeVec
 =

1208 
»gi¡”_gauge_vec
!(

1212 ).
unw¿p
();

1214 
pub
 
»f
 
	gSTORE_ENGINE_WRITE_STALL_VEC
: 
GaugeVec
 =

1215 
»gi¡”_gauge_vec
!(

1219 ).
unw¿p
();

1221 
pub
 
»f
 
	gSTORE_ENGINE_SST_READ_MICROS_VEC
: 
GaugeVec
 =

1222 
»gi¡”_gauge_vec
!(

1226 ).
unw¿p
();

1228 
pub
 
»f
 
	gSTORE_ENGINE_NUM_SUBCOMPACTION_SCHEDULED_VEC
: 
GaugeVec
 =

1229 
»gi¡”_gauge_vec
!(

1233 ).
unw¿p
();

1235 
pub
 
»f
 
	gSTORE_ENGINE_BYTES_PER_READ_VEC
: 
GaugeVec
 =

1236 
»gi¡”_gauge_vec
!(

1240 ).
unw¿p
();

1242 
pub
 
»f
 
	gSTORE_ENGINE_BYTES_PER_WRITE_VEC
: 
GaugeVec
 =

1243 
»gi¡”_gauge_vec
!(

1247 ).
unw¿p
();

1249 
pub
 
»f
 
	gSTORE_ENGINE_BYTES_COMPRESSED_VEC
: 
GaugeVec
 =

1250 
»gi¡”_gauge_vec
!(

1254 ).
unw¿p
();

1256 
pub
 
»f
 
	gSTORE_ENGINE_BYTES_DECOMPRESSED_VEC
: 
GaugeVec
 =

1257 
»gi¡”_gauge_vec
!(

1261 ).
unw¿p
();

1263 
pub
 
»f
 
	gSTORE_ENGINE_COMPRESSION_TIMES_NANOS_VEC
: 
GaugeVec
 =

1264 
»gi¡”_gauge_vec
!(

1268 ).
unw¿p
();

1270 
pub
 
»f
 
	gSTORE_ENGINE_DECOMPRESSION_TIMES_NANOS_VEC
: 
GaugeVec
 =

1271 
»gi¡”_gauge_vec
!(

1275 ).
unw¿p
();

1277 
pub
 
»f
 
	gSTORE_ENGINE_PENDING_COMACTION_BYTES_VEC
: 
GaugeVec
 =

1278 
»gi¡”_gauge_vec
!(

1282 ).
unw¿p
();

1284 
pub
 
»f
 
	gSTORE_ENGINE_COMPACTION_FLOW_VEC
: 
CouÁ”Vec
 =

1285 
»gi¡”_couÁ”_vec
!(

1289 ).
unw¿p
();

1291 
pub
 
»f
 
	gSTORE_ENGINE_COMPACTION_DROP_VEC
: 
CouÁ”Vec
 =

1292 
»gi¡”_couÁ”_vec
!(

1296 ).
unw¿p
();

1298 
pub
 
»f
 
	gSTORE_ENGINE_COMPACTION_DURATIONS_VEC
: 
Hi¡og¿mVec
 =

1299 
»gi¡”_hi¡og¿m_vec
!(

1303 
expÚ’tŸl_buck‘s
(0.005, 2.0, 20).
unw¿p
()

1304 ).
unw¿p
();

1306 
pub
 
»f
 
	gSTORE_ENGINE_COMPACTION_NUM_CORRUPT_KEYS_VEC
: 
CouÁ”Vec
 =

1307 
»gi¡”_couÁ”_vec
!(

1311 ).
unw¿p
();

1313 
pub
 
»f
 
	gSTORE_ENGINE_LOCATE_VEC
: 
CouÁ”Vec
 =

1314 
»gi¡”_couÁ”_vec
!(

1318 ).
unw¿p
();

1320 
pub
 
»f
 
	gSTORE_ENGINE_FILE_STATUS_VEC
: 
CouÁ”Vec
 =

1321 
»gi¡”_couÁ”_vec
!(

1325 ).
unw¿p
();

1327 
pub
 
»f
 
	gSTORE_ENGINE_READ_AMP_FLOW_VEC
: 
CouÁ”Vec
 =

1328 
»gi¡”_couÁ”_vec
!(

1332 ).
unw¿p
();

1334 
pub
 
»f
 
	gSTORE_ENGINE_NO_ITERATORS
: 
CouÁ”Vec
 =

1335 
»gi¡”_couÁ”_vec
!(

1339 ).
unw¿p
();

1341 
pub
 
»f
 
	gSTORE_ENGINE_WAL_FILE_SYNCED
: 
CouÁ”Vec
 =

1342 
»gi¡”_couÁ”_vec
!(

1346 ).
unw¿p
();

1348 
pub
 
»f
 
	gSTORE_ENGINE_EVENT_COUNTER_VEC
: 
CouÁ”Vec
 =

1349 
»gi¡”_couÁ”_vec
!(

1353 ).
unw¿p
();

1355 
pub
 
»f
 
	gSTORE_ENGINE_COMPRESSION_RATIO_VEC
: 
GaugeVec
 =

1356 
»gi¡”_gauge_vec
!(

1360 ).
unw¿p
();

1362 
pub
 
»f
 
	gSTORE_ENGINE_NUM_SNAPSHOTS_GAUGE_VEC
: 
GaugeVec
 =

1363 
»gi¡”_gauge_vec
!(

1367 ).
unw¿p
();

1369 
pub
 
»f
 
	gSTORE_ENGINE_OLDEST_SNAPSHOT_DURATION_GAUGE_VEC
: 
GaugeVec
 =

1370 
»gi¡”_gauge_vec
!(

1374 ).
unw¿p
();

1377 #[
cfg
(
‹¡
)]

1378 
mod
 
	g‹¡s
 {

1379 
u£
 
	gsu³r
::*;

1381 
u£
 
	g‹mpdœ
::
TempDœ
;

1383 
u£
 
	g¡Üage
::
ALL_CFS
;

1384 
u£
 
	gut
::
rocksdb
;

1386 #[
‹¡
]

1387 
â
 
‹¡_æush
() {

1388 
Ët
 
	gdœ
 = 
TempDœ
::
Ãw
("‹¡-æush").
unw¿p
();

1389 
Ët
 
	gdb
 = 
rocksdb
::
Ãw_’gše
(
dœ
.
·th
().
to_¡r
().
unw¿p
(), 
ALL_CFS
).unwrap();

1390 

 
š
 
	gENGINE_TICKER_TYPES
 {

1391 
æush_’gše_tick”_m‘rics
(*

, 2, "test-name");

1394 

 
š
 
	gENGINE_HIST_TYPES
 {

1395 
æush_’gše_hi¡og¿m_m‘rics
(*

, 
Hi¡og¿mD©a
::(), "test-name");

1398 
æush_’gše_´İ”t›s
(&
db
, "test-name");

	@src/util/rocksdb/event_listener.rs

14 
u£
 
	grocksdb
::{
£lf
, 
	gCom·ùiÚJobInfo
, 
	gFlushJobInfo
, 
	gInge¡iÚInfo
};

15 
u£
 
	gut
::
rocksdb
::
’gše_m‘rics
::*;

17 
pub
 
	sEv’tLi¡’”
 {

18 
	mdb_Çme
: 
SŒšg
,

21 
im¶
 
	gEv’tLi¡’”
 {

22 
pub
 
â
 
Ãw
(
db_Çme
: &
¡r
è-> 
Ev’tLi¡’”
 {

23 
Ev’tLi¡’”
 {

24 
db_Çme
: db_Çme.
to_owÃd
(),

29 
im¶
 
	grocksdb
::
Ev’tLi¡’”
 EventListener {

30 
â
 
Ú_æush_com¶‘ed
(&
£lf
, 
šfo
: &
FlushJobInfo
) {

31 
STORE_ENGINE_EVENT_COUNTER_VEC


32 .
w™h_Ïb–_v®ues
(&[&
£lf
.
db_Çme
, 
šfo
.
cf_Çme
(), "flush"])

33 .
šc
();

36 
â
 
Ú_com·ùiÚ_com¶‘ed
(&
£lf
, 
šfo
: &
Com·ùiÚJobInfo
) {

37 
STORE_ENGINE_EVENT_COUNTER_VEC


38 .
w™h_Ïb–_v®ues
(&[&
£lf
.
db_Çme
, 
šfo
.
cf_Çme
(), "compaction"])

39 .
šc
();

40 
	gSTORE_ENGINE_COMPACTION_DURATIONS_VEC


41 .
w™h_Ïb–_v®ues
(&[&
£lf
.
db_Çme
, 
šfo
.
cf_Çme
()])

42 .
ob£rve
(
šfo
.
–­£d_miüos
(è
as
 
f64
 / 1
_000_000
.0);

43 
	gSTORE_ENGINE_COMPACTION_NUM_CORRUPT_KEYS_VEC


44 .
w™h_Ïb–_v®ues
(&[&
£lf
.
db_Çme
, 
šfo
.
cf_Çme
()])

45 .
šc_by
(
šfo
.
num_cÜru±_keys
(è
as
 
f64
)

46 .
unw¿p
();

49 
â
 
Ú_ex‹º®_fe_šge¡ed
(&
£lf
, 
šfo
: &
Inge¡iÚInfo
) {

50 
STORE_ENGINE_EVENT_COUNTER_VEC


51 .
w™h_Ïb–_v®ues
(&[&
£lf
.
db_Çme
, 
šfo
.
cf_Çme
(), "ingestion"])

52 .
šc
();

	@src/util/rocksdb/metrics_flusher.rs

14 
u£
 
	grocksdb
::
DB
;

15 
u£
 
	g¿á¡Üe
::
¡Üe
::
Engšes
;

16 
u£
 
	gut
::
rocksdb
::
’gše_m‘rics
::*;

17 
u£
 
	g¡d
::
th»ad
::{
Bud”
, 
	gJošHªdË
};

18 
u£
 
	g¡d
::
io
;

19 
u£
 
	g¡d
::
sync
::
mpsc
::{
£lf
, 
	gS’d”
};

20 
u£
 
	g¡d
::
time
::{
Du¿tiÚ
, 
	gIn¡ªt
};

22 
pub
 cÚ¡ 
	gDEFAULT_FLUSHER_INTERVAL
: 
u64
 = 10000;

23 
pub
 cÚ¡ 
	gDEFAULT_FLUSHER_RESET_INTERVAL
: 
u64
 = 60000;

25 
pub
 
	sM‘ricsFlush”
 {

26 
	m’gšes
: 
Engšes
,

27 
	mhªdË
: 
O±iÚ
<
JošHªdË
<()>>,

28 
	m£nd”
: 
O±iÚ
<
S’d”
<
boŞ
>>,

29 
	mš‹rv®
: 
Du¿tiÚ
,

32 
im¶
 
	gM‘ricsFlush”
 {

33 
pub
 
â
 
Ãw
(
’gšes
: 
Engšes
, 
š‹rv®
: 
Du¿tiÚ
è-> 
M‘ricsFlush”
 {

34 
M‘ricsFlush”
 {

35 
’gšes
:ƒngines,

36 
	ghªdË
: 
NÚe
,

37 
	g£nd”
: 
NÚe
,

38 
	gš‹rv®
: 
š‹rv®
,

42 
pub
 
â
 
¡¬t
(&
mut
 
£lf
è-> 
	gResuÉ
<(), 
	gio
::
E¼Ü
> {

43 
Ët
 
db
 = 
£lf
.
’gšes
.
kv_’gše
.
şÚe
();

44 
Ët
 
	g¿á_db
 = 
£lf
.
’gšes
.
¿á_’gše
.
şÚe
();

45 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

46 
Ët
 
	gš‹rv®
 = 
£lf
.
š‹rv®
;

47 
	g£lf
.
	g£nd”
 = 
Some
(
tx
);

48 
Ët
 
	gh
 = 
Bud”
::
Ãw
()

49 .
Çme
(
thd_Çme
!("rocksb-metrics-flusher"))

50 .
¥awn
(
move
 || {

51 
Ët
 
mut
 
Ï¡_»£t
 = 
In¡ªt
::
now
();

52 
Ët
 
»£t_š‹rv®
 = 
Du¿tiÚ
::
äom_mlis
(
DEFAULT_FLUSHER_RESET_INTERVAL
);

53 
Ët
 
E¼
(
mpsc
::
RecvTimeoutE¼Ü
::
Timeout
èğ
rx
.
»cv_timeout
(
š‹rv®
) {

54 
æush_m‘rics
(&
db
, "kv");

55 
æush_m‘rics
(&
¿á_db
, "raft");

56 
Ï¡_»£t
.
–­£d
(è>ğ
»£t_š‹rv®
 {

57 
db
.
»£t_¡©i¡ics
();

58 
¿á_db
.
»£t_¡©i¡ics
();

59 
Ï¡_»£t
 = 
In¡ªt
::
now
();

64 
	g£lf
.
	ghªdË
 = 
Some
(
h
);

65 
Ok
(())

68 
pub
 
â
 
¡İ
(&
mut
 
£lf
) {

69 
Ët
 
	gh
 = 
£lf
.
hªdË
.
ke
();

70 
	gh
.
is_nÚe
() {

73 
drİ
(
£lf
.
£nd”
.
ke
().
unw¿p
());

74 
Ët
 
E¼
(
e
èğ
h
.
unw¿p
().
još
() {

75 
”rÜ
!("još m‘ric æush” faed {:?}", 
e
);

81 
â
 
	$æush_m‘rics
(
db
: &
DB
, 
Çme
: &
¡r
) {

82 
t
 
š
 
ENGINE_TICKER_TYPES
 {

83 
Ët
 
v
 = 
db
.
	`g‘_ªd_»£t_¡©i¡ics_tick”_couÁ
(*
t
);

84 
	`æush_’gše_tick”_m‘rics
(*
t
, 
v
, 
Çme
);

86 
t
 
š
 
ENGINE_HIST_TYPES
 {

87 
Ët
 
	`Some
(
v
èğ
db
.
	`g‘_¡©i¡ics_hi¡og¿m
(*
t
) {

88 
	`æush_’gše_hi¡og¿m_m‘rics
(*
t
, 
v
, 
Çme
);

91 
	`æush_’gše_´İ”t›s
(
db
, 
Çme
);

92 
	}
}

94 #[
cfg
(
‹¡
)]

95 
mod
 
	g‹¡s
 {

96 
u£
 
	g‹mpdœ
::
TempDœ
;

97 
u£
 
	g¡d
::
·th
::
P©h
;

98 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

99 
u£
 
	g¡d
::
sync
::
Arc
;

100 
u£
 
	gsu³r
::*;

101 
u£
 
	grocksdb
::{
CŞumnFamyO±iÚs
, 
	gDBO±iÚs
};

102 
u£
 
	gut
::
rocksdb
::{
£lf
, 
	gCFO±iÚs
};

103 
u£
 
	g¡Üage
::{
CF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_WRITE
};

104 
u£
 
	g¡d
::
th»ad
::
¦“p
;

106 #[
‹¡
]

107 
â
 
‹¡_m‘rics_æush”
() {

108 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("_‹¡_m‘rics_æush”").
unw¿p
();

109 
Ët
 
	g¿á_·th
 = 
·th
.·th().
još
(
P©h
::
Ãw
("raft"));

110 
Ët
 
	gdb_İt
 = 
DBO±iÚs
::
Ãw
();

111 
Ët
 
	gcf_İts
 = 
CŞumnFamyO±iÚs
::
Ãw
();

112 
Ët
 
	gcfs_İts
 = 
vec
![

113 
CFO±iÚs
::
Ãw
(
CF_DEFAULT
, 
rocksdb
::
CŞumnFamyO±iÚs
::new()),

114 
CFO±iÚs
::
Ãw
(
CF_LOCK
, 
rocksdb
::
CŞumnFamyO±iÚs
::new()),

115 
CFO±iÚs
::
Ãw
(
CF_WRITE
, 
cf_İts
),

117 
Ët
 
	g’gše
 = 
Arc
::
Ãw
(

118 
rocksdb
::
Ãw_’gše_İt
(
·th
.·th().
to_¡r
().
unw¿p
(), 
db_İt
, 
cfs_İts
).unwrap(),

121 
Ët
 
	gcfs_İts
 = 
vec
![
CFO±iÚs
::
Ãw
(
CF_DEFAULT
, 
CŞumnFamyO±iÚs
::new())];

122 
Ët
 
	g¿á_’gše
 = 
Arc
::
Ãw
(

123 
rocksdb
::
Ãw_’gše_İt
(
¿á_·th
.
to_¡r
().
unw¿p
(), 
DBO±iÚs
::
Ãw
(), 
cfs_İts
)

124 .
unw¿p
(),

126 
Ët
 
	g’gšes
 = 
Engšes
::
Ãw
(
’gše
, 
¿á_’gše
);

127 
Ët
 
mut
 
	gm‘rics_æush”
 = 
M‘ricsFlush”
::
Ãw
(
’gšes
, 
Du¿tiÚ
::
äom_mlis
(100));

129 
Ët
 
E¼
(
e
èğ
m‘rics_æush”
.
¡¬t
() {

130 
”rÜ
!("çedØ¡¬ˆm‘ric æush”,ƒ¼Ü = {:?}", 
e
);

133 
Ët
 
	g¹ime
 = 
Du¿tiÚ
::
äom_mlis
(300);

134 
¦“p
(
¹ime
);

136 
	gm‘rics_æush”
.
¡İ
();

	@src/util/rocksdb/mod.rs

14 
pub
 
mod
 
	g´İ”t›s
;

15 
pub
 
mod
 
	gev’t_li¡’”
;

16 
pub
 
mod
 
	g’gše_m‘rics
;

17 
pub
 
mod
 
	gm‘rics_æush”
;

19 
pub
 
u£
 
	g£lf
::
ev’t_li¡’”
::
Ev’tLi¡’”
;

20 
pub
 
u£
 
	g£lf
::
m‘rics_æush”
::
M‘ricsFlush”
;

22 
u£
 
	g¡d
::
fs
;

23 
u£
 
	g¡d
::
·th
::
P©h
;

24 
u£
 
	g¡d
::
sync
::
Arc
;

25 
u£
 
	g¡d
::
¡r
::
FromSŒ
;

27 
u£
 
	g¡Üage
::{
ALL_CFS
, 
	gCF_DEFAULT
, 
	gCF_LOCK
};

28 
u£
 
	grocksdb
::{
CŞumnFamyO±iÚs
, 
	gCom·ùO±iÚs
, 
	gDBCom´essiÚTy³
, 
	gDBO±iÚs
, 
	gR—dO±iÚs
,

29 
	gSliûT¿nsfÜm
, 
	gWr™abË
, 
	gWr™eB©ch
, 
	gDB
};

30 
u£
 
	grocksdb
::
rocksdb
::
suµÜ‹d_com´essiÚ
;

31 
u£
 
	gut
::
rocksdb
::
’gše_m‘rics
::{
ROCKSDB_COMPRESSION_RATIO_AT_LEVEL
,

32 
	gROCKSDB_CUR_SIZE_ALL_MEM_TABLES
, 
	gROCKSDB_TOTAL_SST_FILES_SIZE
};

33 
u£
 
	gut
::
rocksdb
;

35 
pub
 
u£
 
	grocksdb
::
CFHªdË
;

37 
u£
 
	gsu³r
::
cfs_diff
;

40 cÚ¡ 
	gCOMPRESSION_PRIORITY
: [
DBCom´essiÚTy³
; 3] = [

41 
DBCom´essiÚTy³
::
Lz4
,

42 
DBCom´essiÚTy³
::
SÇµy
,

43 
DBCom´essiÚTy³
::
Z¡d
,

46 
pub
 
â
 
g‘_ç¡e¡_suµÜ‹d_com´essiÚ_ty³
(è-> 
	gDBCom´essiÚTy³
 {

47 
Ët
 
	g®l_suµÜ‹d_com´essiÚ
 = 
suµÜ‹d_com´essiÚ
();

48 *
	gCOMPRESSION_PRIORITY


49 .
što_™”
()

50 .
fšd
(|
c
| 
®l_suµÜ‹d_com´essiÚ
.
cÚšs
(c))

51 .
unw¿p_Ü
(&
DBCom´essiÚTy³
::
No
)

54 
pub
 
â
 
g‘_cf_hªdË
<'a>(db: &'
a
 
DB
, 
	gcf
: &
¡r
è-> 
ResuÉ
<&'a CFHandle, String> {

55 
db
.
cf_hªdË
(
cf
)

56 .
ok_Ü_–£
(|| 
fÜm©
!("cà{}‚Ù found.", 
cf
))

59 
pub
 
â
 
İ’
(
·th
: &
¡r
, 
cfs
: &[&¡r]è-> 
ResuÉ
<
DB
, 
	gSŒšg
> {

60 
Ët
 
mut
 
	gİts
 = 
DBO±iÚs
::
Ãw
();

61 
	gİts
.
ü—‹_if_missšg
(
çl£
);

62 
Ët
 
mut
 
	gcfs_İts
 = 
vec
![];

63 
_
 
	gš
 0..cf
	gs
.
Ën
() {

64 
	gcfs_İts
.
push
(
CŞumnFamyO±iÚs
::
Ãw
());

66 
İ’_İt
(
İts
, 
·th
, 
cfs
.
to_vec
(), 
cfs_İts
)

69 
pub
 
â
 
İ’_İt
(

70 
İts
: 
DBO±iÚs
,

71 
·th
: &
¡r
,

72 
cfs
: 
Vec
<&
¡r
>,

73 
cfs_İts
: 
Vec
<
CŞumnFamyO±iÚs
>,

74 è-> 
	gResuÉ
<
	gDB
, 
	gSŒšg
> {

75 
Ët
 
	gcfds
 = 
cfs
.
što_™”
().
z
(
cfs_İts
).
cŞËù
();

76 
	gDB
::
İ’_cf
(
İts
, 
·th
, 
cfds
)

79 
pub
 
	gCFO±iÚs
<'a> {

80 
	gcf
: &'a str,

81 
İtiÚs
: 
CŞumnFamyO±iÚs
,

84 
	gim¶
<'a> CFO±iÚs<'
	ga
> {

85 
pub
 
â
 
Ãw
(
cf
: &'¨¡r, o±iÚs: CŞumnFamyO±iÚsè-> CFO±iÚs<'
a
> {

86 
CFO±iÚs
 {

87 
cf
: cf,

88 
İtiÚs
: options,

93 
pub
 
â
 
Ãw_’gše
(
·th
: &
¡r
, 
cfs
: &[&¡r]è-> 
ResuÉ
<
DB
, 
SŒšg
> {

94 
Ët
 
mut
 
db_İts
 = 
DBO±iÚs
::
Ãw
();

95 
db_İts
.
’abË_¡©i¡ics
();

96 
Ët
 
mut
 
cfs_İts
 = 
Vec
::
w™h_ÿ·c™y
(
cfs
.
Ën
());

97 
cf
 
š
 
cfs
 {

98 
cfs_İts
.
push
(
CFO±iÚs
::
Ãw
(*
cf
, 
CŞumnFamyO±iÚs
::new()));

100 
Ãw_’gše_İt
(
·th
, 
db_İts
, 
cfs_İts
)

103 
â
 
check_ªd_İ’
(

104 
·th
: &
¡r
,

105 
mut
 
db_İt
: 
DBO±iÚs
,

106 
cfs_İts
: 
Vec
<
CFO±iÚs
>,

107 è-> 
ResuÉ
<
DB
, 
SŒšg
> {

109 !
db_exi¡
(
·th
) {

110 
db_İt
.
ü—‹_if_missšg
(
Œue
);

112 
Ët
 
mut
 
cfs_v
 = 
vec
![];

113 
Ët
 
mut
 
cf_İts_v
 = 
vec
![];

114 
Ët
 
Some
(
x
èğ
cfs_İts
.
™”
().
fšd
(|x| x.
cf
 =ğ
CF_DEFAULT
) {

115 
cfs_v
.
push
(
x
.
cf
);

116 
cf_İts_v
.
push
(
x
.
İtiÚs
.
şÚe
());

118 
Ët
 
cfds
 = 
cfs_v
.
što_™”
().
z
(
cf_İts_v
).
cŞËù
();

119 
Ët
 
mut
 
db
 = 
DB
::
İ’_cf
(
db_İt
, 
·th
, 
cfds
)?;

120 
x
 
š
 
cfs_İts
 {

121 
x
.
cf
 =ğ
CF_DEFAULT
 {

124 
db
.
ü—‹_cf
((
x
.
cf
, x.
İtiÚs
))?;

127  
Ok
(
db
);

130 
db_İt
.
ü—‹_if_missšg
(
çl£
);

133 
Ët
 
cfs_li¡
 = 
DB
::
li¡_cŞumn_çm›s
(&
db_İt
, 
·th
)?;

134 
Ët
 
exi¡ed
: 
Vec
<&
¡r
> = 
cfs_li¡
.
™”
().
m­
(|
v
| v.
as_¡r
()).
cŞËù
();

135 
Ët
 
Ãeded
: 
Vec
<&
¡r
> = 
cfs_İts
.
™”
().
m­
(|
x
| x.
cf
).
cŞËù
();

138 
exi¡ed
 =ğ
Ãeded
 {

139 
Ët
 
mut
 
cfs_v
 = 
vec
![];

140 
Ët
 
mut
 
cfs_İts_v
 = 
vec
![];

141 
x
 
š
 
cfs_İts
 {

142 
cfs_v
.
push
(
x
.
cf
);

143 
cfs_İts_v
.
push
(
x
.
İtiÚs
);

146 
Ët
 
cfds
 = 
cfs_v
.
što_™”
().
z
(
cfs_İts_v
).
cŞËù
();

147  
DB
::
İ’_cf
(
db_İt
, 
·th
, 
cfds
);

151 
Ët
 
mut
 
cfs_v
: 
Vec
<&
¡r
> = Vec::
Ãw
();

152 
Ët
 
mut
 
cfs_İts_v
: 
Vec
<
CŞumnFamyO±iÚs
> = Vec::
Ãw
();

153 
cf
 
š
 &
exi¡ed
 {

154 
cfs_v
.
push
(
cf
);

155 
m©ch
 
cfs_İts
.
™”
().
fšd
(|
x
| x.
cf
 == *cf) {

156 
Some
(
x
) => {

157 
cfs_İts_v
.
push
(
x
.
İtiÚs
.
şÚe
());

159 
NÚe
 => {

160 
cfs_İts_v
.
push
(
CŞumnFamyO±iÚs
::
Ãw
());

164 
Ët
 
cfds
 = 
cfs_v
.
što_™”
().
z
(
cfs_İts_v
).
cŞËù
();

165 
Ët
 
mut
 
db
 = 
DB
::
İ’_cf
(
db_İt
, 
·th
, 
cfds
).
unw¿p
();

169 
cf
 
š
 
cfs_diff
(&
exi¡ed
, &
Ãeded
) {

171 
cf
 !ğ
CF_DEFAULT
 {

172 
db
.
drİ_cf
(
cf
)?;

177 
cf
 
š
 
cfs_diff
(&
Ãeded
, &
exi¡ed
) {

178 
db
.
ü—‹_cf
((

179 
cf
,

180 
cfs_İts


181 .
™”
()

182 .
fšd
(|
x
| x.
cf
 == cf)

183 .
unw¿p
()

184 .
İtiÚs


185 .
şÚe
(),

188 
Ok
(
db
)

191 
pub
 
â
 
Ãw_’gše_İt
(
·th
: &
¡r
, 
İts
: 
DBO±iÚs
, 
cfs_İts
: 
Vec
<
CFO±iÚs
>è-> 
ResuÉ
<
DB
, 
SŒšg
> {

192 
check_ªd_İ’
(
·th
, 
İts
, 
cfs_İts
)

195 
pub
 
â
 
db_exi¡
(
·th
: &
¡r
è-> 
boŞ
 {

196 
Ët
 
·th
 = 
P©h
::
Ãw
(path);

197 !
·th
.
exi¡s
(è|| !·th.
is_dœ
() {

198  
çl£
;

204 
fs
::
»ad_dœ
(&
·th
).
unw¿p
().
Ãxt
().
is_some
()

207 
pub
 
â
 
g‘_’gše_u£d_size
(
’gše
: 
Arc
<
DB
>è-> 
u64
 {

208 
Ët
 
mut
 
u£d_size
: 
u64
 = 0;

209 
cf
 
š
 
ALL_CFS
 {

210 
Ët
 
hªdË
 = 
rocksdb
::
g‘_cf_hªdË
(&
’gše
, 
cf
).
unw¿p
();

211 
Ët
 
cf_u£d_size
 = 
’gše


212 .
g‘_´İ”ty_št_cf
(
hªdË
, 
ROCKSDB_TOTAL_SST_FILES_SIZE
)

213 .
ex³ù
("rocksdb isoo old, missingotal-sst-files-size…roperty");

215 
u£d_size
 +ğ
cf_u£d_size
;

218 
Ët
 
Some
(
mem_bË
) =

219 
’gše
.
g‘_´İ”ty_št_cf
(
hªdË
, 
ROCKSDB_CUR_SIZE_ALL_MEM_TABLES
)

221 
u£d_size
 +ğ
mem_bË
;

224 
u£d_size


227 
pub
 
â
 
g‘_’gše_com´essiÚ_¿tio_©_Ëv–
(

228 
’gše
: &
DB
,

229 
hªdË
: &
CFHªdË
,

230 
Ëv–
: 
usize
,

231 è-> 
O±iÚ
<
f64
> {

232 
Ët
 
´İ
 = 
fÜm©
!("{}{}", 
ROCKSDB_COMPRESSION_RATIO_AT_LEVEL
, 
Ëv–
);

233 
Ët
 
Some
(
v
èğ
’gše
.
g‘_´İ”ty_v®ue_cf
(
hªdË
, &
´İ
) {

234 
Ët
 
Ok
(
f
èğ
f64
::
äom_¡r
(&
v
) {

236 
f
 >= 0.0 {

237  
Some
(
f
);

241 
NÚe


244 
pub
 
	sFixedSuffixSliûT¿nsfÜm
 {

245 
pub
 
suffix_Ën
: 
usize
,

248 
im¶
 
FixedSuffixSliûT¿nsfÜm
 {

249 
pub
 
â
 
Ãw
(
suffix_Ën
: 
usize
è-> 
FixedSuffixSliûT¿nsfÜm
 {

250 
FixedSuffixSliûT¿nsfÜm
 {

251 
suffix_Ën
: suffix_len,

256 
im¶
 
SliûT¿nsfÜm
 
FixedSuffixSliûT¿nsfÜm
 {

257 
â
 
ŒªsfÜm
<'a>(&muˆ£lf, key: &'
a
 [
u8
]) -> &'a [u8] {

258 
Ët
 
	gmid
 = 
key
.
Ën
(è- 
£lf
.
suffix_Ën
;

259 
Ët
 (
Ëá
, 
_
èğ
key
.
¥l™_©
(
mid
);

260 
	gËá


263 
â
 
š_domaš
(&
mut
 
£lf
, 
key
: &[
u8
]è-> 
boŞ
 {

264 
key
.
Ën
(è>ğ
£lf
.
suffix_Ën


267 
â
 
š_¿nge
(&
mut
 
£lf
, 
_
: &[
u8
]è-> 
boŞ
 {

268 
Œue


272 
pub
 
	sFixedP»fixSliûT¿nsfÜm
 {

273 
pub
 
´efix_Ën
: 
usize
,

276 
im¶
 
	gFixedP»fixSliûT¿nsfÜm
 {

277 
pub
 
â
 
Ãw
(
´efix_Ën
: 
usize
è-> 
FixedP»fixSliûT¿nsfÜm
 {

278 
FixedP»fixSliûT¿nsfÜm
 {

279 
´efix_Ën
:…refix_len,

284 
im¶
 
SliûT¿nsfÜm
 
	gFixedP»fixSliûT¿nsfÜm
 {

285 
â
 
	gŒªsfÜm
<'a>(&muˆ£lf, key: &'
	ga
 [
u8
]) -> &'a [u8] {

286 &
	gkey
[..
£lf
.
´efix_Ën
]

289 
â
 
š_domaš
(&
mut
 
£lf
, 
key
: &[
u8
]è-> 
boŞ
 {

290 
key
.
Ën
(è>ğ
£lf
.
´efix_Ën


293 
â
 
š_¿nge
(&
mut
 
£lf
, 
_
: &[
u8
]è-> 
boŞ
 {

294 
Œue


298 
pub
 
NoİSliûT¿nsfÜm
;

300 
im¶
 
SliûT¿nsfÜm
 
	gNoİSliûT¿nsfÜm
 {

301 
â
 
	gŒªsfÜm
<'a>(&muˆ£lf, key: &'
	ga
 [
u8
]) -> &'a [u8] {

302 
	gkey


305 
â
 
š_domaš
(&
mut
 
£lf
, 
_
: &[
u8
]è-> 
boŞ
 {

306 
Œue


309 
â
 
š_¿nge
(&
mut
 
£lf
, 
_
: &[
u8
]è-> 
boŞ
 {

310 
Œue


314 
pub
 
â
 
roughly_ş—nup_¿nge
(
db
: &
DB
, 
¡¬t_key
: &[
u8
], 
’d_key
: &[u8]è-> 
ResuÉ
<(), 
	gSŒšg
> {

315 
	g¡¬t_key
 > 
	g’d_key
 {

316  
E¼
(
fÜm©
!(

318 
¡¬t_key
,

319 
’d_key


323 
	g¡¬t_key
 =ğ
’d_key
 {

324  
Ok
(());

327 
cf
 
š
 
	gdb
.
cf_Çmes
() {

328 
Ët
 
	ghªdË
 = 
g‘_cf_hªdË
(
db
, 
cf
)?;

329 
	gcf
 =ğ
CF_LOCK
 {

331 
Ët
 
mut
 
™”_İt
 = 
R—dO±iÚs
::
Ãw
();

332 
	g™”_İt
.
fl_ÿche
(
çl£
);

333 
	g™”_İt
.
£t_™”©e_uµ”_bound
(
’d_key
);

334 
Ët
 
mut
 
	g™”
 = 
db
.
™”_cf_İt
(
hªdË
, 
™”_İt
);

335 
	g™”
.
£ek
(
¡¬t_key
.
što
());

336 
Ët
 
	gwb
 = 
Wr™eB©ch
::
Ãw
();

337 
	g™”
.
v®id
() {

338 
	gwb
.
d–‘e_cf
(
hªdË
, 
™”
.
key
())?;

339 
	g™”
.
Ãxt
();

341 
	gwb
.
couÁ
() > 0 {

342 
	gdb
.
wr™e
(
wb
)?;

345 
	gdb
.
d–‘e_fe_š_¿nge_cf
(
hªdË
, 
¡¬t_key
, 
’d_key
)?;

349 
Ok
(())

353 
pub
 
â
 
com·ù_¿nge
(

354 
db
: &
DB
,

355 
hªdË
: &
CFHªdË
,

356 
¡¬t_key
: 
O±iÚ
<&[
u8
]>,

357 
’d_key
: 
O±iÚ
<&[
u8
]>,

358 
exşusive_mªu®
: 
boŞ
,

360 
Ët
 
mut
 
	gcom·ù_İts
 = 
Com·ùO±iÚs
::
Ãw
();

363 
	gcom·ù_İts
.
£t_exşusive_mªu®_com·ùiÚ
(
exşusive_mªu®
);

364 
	gdb
.
com·ù_¿nge_cf_İt
(
hªdË
, &
com·ù_İts
, 
¡¬t_key
, 
’d_key
);

367 #[
cfg
(
‹¡
)]

368 
mod
 
	g‹¡s
 {

369 
u£
 
	gsu³r
::*;

370 
u£
 
	grocksdb
::{
CŞumnFamyO±iÚs
, 
	gDBO±iÚs
, 
	gWr™abË
, 
	gDB
};

371 
u£
 
	g‹mpdœ
::
TempDœ
;

372 
u£
 
	g¡Üage
::
CF_DEFAULT
;

374 #[
‹¡
]

375 
â
 
‹¡_check_ªd_İ’
() {

376 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("_ut_rocksdb_‹¡_check_cŞumn_çm›s").
ex³ù
("");

377 
Ët
 
	g·th_¡r
 = 
·th
.·th().
to_¡r
().
unw¿p
();

380 
Ët
 
	gcfs_İts
 = 
vec
![
CFO±iÚs
::
Ãw
(
CF_DEFAULT
, 
CŞumnFamyO±iÚs
::new())];

381 
check_ªd_İ’
(
·th_¡r
, 
DBO±iÚs
::
Ãw
(), 
cfs_İts
).
unw¿p
();

382 
cŞumn_çm›s_mu¡_eq
(
·th_¡r
, 
vec
![
CF_DEFAULT
]);

385 
Ët
 
	gcfs_İts
 = 
vec
![

386 
CFO±iÚs
::
Ãw
(
CF_DEFAULT
, 
CŞumnFamyO±iÚs
::new()),

387 
CFO±iÚs
::
Ãw
("cf1", 
CŞumnFamyO±iÚs
::new()),

389 
check_ªd_İ’
(
·th_¡r
, 
DBO±iÚs
::
Ãw
(), 
cfs_İts
).
unw¿p
();

390 
cŞumn_çm›s_mu¡_eq
(
·th_¡r
, 
vec
![
CF_DEFAULT
, "cf1"]);

393 
Ët
 
	gcfs_İts
 = 
vec
![
CFO±iÚs
::
Ãw
(
CF_DEFAULT
, 
CŞumnFamyO±iÚs
::new())];

394 
check_ªd_İ’
(
·th_¡r
, 
DBO±iÚs
::
Ãw
(), 
cfs_İts
).
unw¿p
();

395 
cŞumn_çm›s_mu¡_eq
(
·th_¡r
, 
vec
![
CF_DEFAULT
]);

398 
Ët
 
	gcfs_İts
 = 
vec
![];

399 
check_ªd_İ’
(
·th_¡r
, 
DBO±iÚs
::
Ãw
(), 
cfs_İts
).
unw¿p
();

400 
cŞumn_çm›s_mu¡_eq
(
·th_¡r
, 
vec
![
CF_DEFAULT
]);

403 
â
 
cŞumn_çm›s_mu¡_eq
(
·th
: &
¡r
, 
exû±ed
: 
Vec
<&str>) {

404 
Ët
 
İts
 = 
DBO±iÚs
::
Ãw
();

405 
Ët
 
	gcfs_li¡
 = 
DB
::
li¡_cŞumn_çm›s
(&
İts
, 
·th
).
unw¿p
();

407 
Ët
 
mut
 
	gcfs_exi¡ed
: 
Vec
<&
¡r
> = 
cfs_li¡
.
™”
().
m­
(|
v
| v.
as_¡r
()).
cŞËù
();

408 
Ët
 
mut
 
	gcfs_exû±ed
: 
Vec
<&
¡r
> = 
exû±ed
.
™”
().
m­
(|
v
| *v).
cŞËù
();

409 
	gcfs_exi¡ed
.
sÜt
();

410 
	gcfs_exû±ed
.
sÜt
();

411 
	gas£¹_eq
!(
	gcfs_exi¡ed
, 
	gcfs_exû±ed
);

414 #[
‹¡
]

415 
â
 
‹¡_com´essiÚ_¿tio
() {

416 
Ët
 
	g·th
 = 
TempDœ
::
Ãw
("_ut_rocksdb_‹¡_com´essiÚ_¿tio").
ex³ù
("");

417 
Ët
 
	g·th_¡r
 = 
·th
.·th().
to_¡r
().
unw¿p
();

419 
Ët
 
	gİts
 = 
DBO±iÚs
::
Ãw
();

420 
Ët
 
	gcf_İts
 = 
CFO±iÚs
::
Ãw
(
CF_DEFAULT
, 
CŞumnFamyO±iÚs
::new());

421 
Ët
 
	gdb
 = 
check_ªd_İ’
(
·th_¡r
, 
İts
, 
vec
![
cf_İts
]).
unw¿p
();

422 
Ët
 
	gcf
 = 
db
.
cf_hªdË
(
CF_DEFAULT
).
unw¿p
();

424 
	gas£¹
!(
g‘_’gše_com´essiÚ_¿tio_©_Ëv–
(&
db
, 
cf
, 0).
is_nÚe
());

425 
	gdb
.
put_cf
(
cf
, 
b
"a", b"a").
unw¿p
();

426 
	gdb
.
æush_cf
(
cf
, 
Œue
).
unw¿p
();

427 
	gas£¹
!(
g‘_’gše_com´essiÚ_¿tio_©_Ëv–
(&
db
, 
cf
, 0).
is_some
());

	@src/util/rocksdb/properties.rs

14 
u£
 
	g¡d
::
cmp
;

15 
u£
 
	g¡d
::
cŞËùiÚs
::{
BT»eM­
, 
	gHashM­
};

16 
u£
 
	g¡d
::
cŞËùiÚs
::
Bound
::{
Inşuded
, 
	gUnbounded
};

17 
u£
 
	g¡d
::
İs
::{
D”ef
, 
	gD”efMut
};

18 
u£
 
	g¡d
::
u64
;

19 
u£
 
	g¡d
::
io
::
R—d
;

21 
u£
 
	g¡Üage
::
mvcc
::{
Wr™e
, 
	gWr™eTy³
};

22 
u£
 
	g¡Üage
::
ty³s
;

23 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
;

24 
u£
 
	grocksdb
::{
DBEÁryTy³
, 
	gTabËPrİ”t›sCŞËùÜ
, 
	gTabËPrİ”t›sCŞËùÜFaùÜy
,

25 
	gU£rCŞËùedPrİ”t›s
};

26 
u£
 
	gut
::
codec
::{
E¼Ü
, 
	gResuÉ
};

27 
u£
 
	gut
::
codec
::
numb”
::{
Numb”Decod”
, 
	gNumb”Encod”
};

29 cÚ¡ 
	gPROP_NUM_ERRORS
: &'static str = "tikv.num_errors";

30 cÚ¡ 
PROP_MIN_TS
: &'static str = "tikv.min_ts";

31 cÚ¡ 
PROP_MAX_TS
: &'static str = "tikv.max_ts";

32 cÚ¡ 
PROP_NUM_ROWS
: &'static str = "tikv.num_rows";

33 cÚ¡ 
PROP_NUM_PUTS
: &'static str = "tikv.num_puts";

34 cÚ¡ 
PROP_NUM_VERSIONS
: &'static str = "tikv.num_versions";

35 cÚ¡ 
PROP_MAX_ROW_VERSIONS
: &'static str = "tikv.max_row_versions";

36 cÚ¡ 
PROP_ROWS_INDEX
: &'static str = "tikv.rows_index";

37 cÚ¡ 
PROP_ROWS_INDEX_DISTANCE
: 
u64
 = 10000;

38 cÚ¡ 
	gPROP_TOTAL_SIZE
: &'static str = "tikv.total_size";

39 cÚ¡ 
PROP_SIZE_INDEX
: &'static str = "tikv.size_index";

40 cÚ¡ 
PROP_SIZE_INDEX_DISTANCE
: 
u64
 = 4 * 1024 * 1024;

42 #[
d”ive
(
ClÚe
, 
Debug
, 
DeçuÉ
)]

43 
pub
 
	sMvccPrİ”t›s
 {

44 
pub
 
	mmš_ts
: 
u64
,

45 
pub
 
	mmax_ts
: 
u64
,

46 
pub
 
	mnum_rows
: 
u64
,

47 
pub
 
	mnum_puts
: 
u64
,

48 
pub
 
	mnum_v”siÚs
: 
u64
,

49 
pub
 
	mmax_row_v”siÚs
: 
u64
,

52 
im¶
 
	gMvccPrİ”t›s
 {

53 
pub
 
â
 
Ãw
(è-> 
	gMvccPrİ”t›s
 {

54 
	gMvccPrİ”t›s
 {

55 
	gmš_ts
: 
u64
::
MAX
,

56 
	gmax_ts
: 
u64
::
MIN
,

57 
	gnum_rows
: 0,

58 
	gnum_puts
: 0,

59 
	gnum_v”siÚs
: 0,

60 
	gmax_row_v”siÚs
: 0,

64 
pub
 
â
 
add
(&
mut
 
£lf
, 
Ùh”
: &
MvccPrİ”t›s
) {

65 
£lf
.
mš_ts
 = 
cmp
::
mš
(£lf.mš_ts, 
Ùh”
.min_ts);

66 
	g£lf
.
	gmax_ts
 = 
cmp
::
max
(
£lf
.
max_ts
, 
Ùh”
.max_ts);

67 
	g£lf
.
	gnum_rows
 +ğ
Ùh”
.
num_rows
;

68 
	g£lf
.
	gnum_puts
 +ğ
Ùh”
.
num_puts
;

69 
	g£lf
.
	gnum_v”siÚs
 +ğ
Ùh”
.
num_v”siÚs
;

70 
	g£lf
.
	gmax_row_v”siÚs
 = 
cmp
::
max
(
£lf
.
max_row_v”siÚs
, 
Ùh”
.max_row_versions);

73 
pub
 
â
 
’code
(&
£lf
è-> 
	gU£rPrİ”t›s
 {

74 
Ët
 
mut
 
	g´İs
 = 
U£rPrİ”t›s
::
Ãw
();

75 
	g´İs
.
’code_u64
(
PROP_MIN_TS
, 
£lf
.
mš_ts
);

76 
	g´İs
.
’code_u64
(
PROP_MAX_TS
, 
£lf
.
max_ts
);

77 
	g´İs
.
’code_u64
(
PROP_NUM_ROWS
, 
£lf
.
num_rows
);

78 
	g´İs
.
’code_u64
(
PROP_NUM_PUTS
, 
£lf
.
num_puts
);

79 
	g´İs
.
’code_u64
(
PROP_NUM_VERSIONS
, 
£lf
.
num_v”siÚs
);

80 
	g´İs
.
’code_u64
(
PROP_MAX_ROW_VERSIONS
, 
£lf
.
max_row_v”siÚs
);

81 
	g´İs


84 
pub
 
â
 
	gdecode
<
	gT
: 
DecodePrİ”t›s
>(
´İs
: &
T
è-> 
ResuÉ
<
MvccPrİ”t›s
> {

85 
Ët
 
mut
 
»s
 = 
MvccPrİ”t›s
::
Ãw
();

86 
	g»s
.
	gmš_ts
 = 
´İs
.
decode_u64
(
PROP_MIN_TS
)?;

87 
	g»s
.
	gmax_ts
 = 
´İs
.
decode_u64
(
PROP_MAX_TS
)?;

88 
	g»s
.
	gnum_rows
 = 
´İs
.
decode_u64
(
PROP_NUM_ROWS
)?;

89 
	g»s
.
	gnum_puts
 = 
´İs
.
decode_u64
(
PROP_NUM_PUTS
)?;

90 
	g»s
.
	gnum_v”siÚs
 = 
´İs
.
decode_u64
(
PROP_NUM_VERSIONS
)?;

91 
	g»s
.
	gmax_row_v”siÚs
 = 
´İs
.
decode_u64
(
PROP_MAX_ROW_VERSIONS
)?;

92 
Ok
(
»s
)

96 
pub
 
	sMvccPrİ”t›sCŞËùÜ
 {

97 
	m´İs
: 
MvccPrİ”t›s
,

98 
	mÏ¡_row
: 
Vec
<
u8
>,

99 
	mnum_”rÜs
: 
u64
,

100 
	mrow_v”siÚs
: 
u64
,

101 
	mcur_šdex_hªdË
: 
IndexHªdË
,

102 
	mrow_šdex_hªdËs
: 
IndexHªdËs
,

105 
im¶
 
	gMvccPrİ”t›sCŞËùÜ
 {

106 
â
 
Ãw
(è-> 
	gMvccPrİ”t›sCŞËùÜ
 {

107 
	gMvccPrİ”t›sCŞËùÜ
 {

108 
	g´İs
: 
MvccPrİ”t›s
::
Ãw
(),

109 
	gÏ¡_row
: 
Vec
::
Ãw
(),

110 
	gnum_”rÜs
: 0,

111 
	grow_v”siÚs
: 0,

112 
	gcur_šdex_hªdË
: 
IndexHªdË
::(),

113 
	grow_šdex_hªdËs
: 
IndexHªdËs
::
Ãw
(),

118 
im¶
 
TabËPrİ”t›sCŞËùÜ
 
	gMvccPrİ”t›sCŞËùÜ
 {

119 
â
 
add
(&
mut
 
£lf
, 
key
: &[
u8
], 
v®ue
: &[u8], 
’Œy_ty³
: 
DBEÁryTy³
, 
_
: 
u64
, _: u64) {

120 
’Œy_ty³
 !ğ
DBEÁryTy³
::
Put
 {

124 !
	gkeys
::
v®id©e_d©a_key
(
key
) {

125 
£lf
.
num_”rÜs
 += 1;

129 
Ët
 (
k
, 
ts
èğ
m©ch
 
ty³s
::
¥l™_’coded_key_Ú_ts
(
key
) {

130 
Ok
((
k
, 
ts
)è=> (k, 
	gts
),

131 
E¼
(
_
) => {

132 
£lf
.
num_”rÜs
 += 1;

137 
	g£lf
.
	g´İs
.
	gmš_ts
 = 
cmp
::
mš
(
£lf
.
´İs
.
mš_ts
, 
ts
);

138 
	g£lf
.
	g´İs
.
	gmax_ts
 = 
cmp
::
max
(
£lf
.
´İs
.
max_ts
, 
ts
);

139 
	g£lf
.
	g´İs
.
	gnum_v”siÚs
 += 1;

141 
	gk
 !ğ
£lf
.
Ï¡_row
.
as_¦iû
() {

142 
£lf
.
´İs
.
num_rows
 += 1;

143 
	g£lf
.
	grow_v”siÚs
 = 1;

144 
	g£lf
.
	gÏ¡_row
.
ş—r
();

145 
	g£lf
.
	gÏ¡_row
.
ex‹nd
(
k
);

147 
	g£lf
.
	grow_v”siÚs
 += 1;

149 
	g£lf
.
	grow_v”siÚs
 > s–f.
	g´İs
.
	gmax_row_v”siÚs
 {

150 
	g£lf
.
	g´İs
.
	gmax_row_v”siÚs
 = 
£lf
.
row_v”siÚs
;

153 
Ët
 
	gv
 = 
m©ch
 
Wr™e
::
·r£
(
v®ue
) {

154 
Ok
(
v
) => v,

155 
E¼
(
_
) => {

156 
£lf
.
num_”rÜs
 += 1;

161 
	gv
.
	gwr™e_ty³
 =ğ
Wr™eTy³
::
Put
 {

162 
£lf
.
´İs
.
num_puts
 += 1;

166 
	g£lf
.
	grow_v”siÚs
 == 1 {

167 
£lf
.
cur_šdex_hªdË
.
size
 += 1;

168 
	g£lf
.
	gcur_šdex_hªdË
.
	goff£t
 += 1;

169 
	g£lf
.
	gcur_šdex_hªdË
.
	goff£t
 == 1 ||

170 
£lf
.
cur_šdex_hªdË
.
size
 >ğ
PROP_ROWS_INDEX_DISTANCE


172 
£lf
.
row_šdex_hªdËs


173 .
š£¹
(
£lf
.
Ï¡_row
.
şÚe
(), s–f.
cur_šdex_hªdË
.clone());

174 
	g£lf
.
	gcur_šdex_hªdË
.
	gsize
 = 0;

179 
â
 
fšish
(&
mut
 
£lf
è-> 
	gHashM­
<
	gVec
<
	gu8
>, Vec<u8>> {

181 
	g£lf
.
	gcur_šdex_hªdË
.
	gsize
 > 0 {

182 
	g£lf
.
	grow_šdex_hªdËs


183 .
š£¹
(
£lf
.
Ï¡_row
.
şÚe
(), s–f.
cur_šdex_hªdË
.clone());

185 
Ët
 
mut
 
	g»s
 = 
£lf
.
´İs
.
’code
();

186 
	g»s
.
’code_u64
(
PROP_NUM_ERRORS
, 
£lf
.
num_”rÜs
);

187 
	g»s
.
’code_hªdËs
(
PROP_ROWS_INDEX
, &
£lf
.
row_šdex_hªdËs
);

188 
	g»s
.0

192 #[
d”ive
(
DeçuÉ
)]

193 
pub
 
	sMvccPrİ”t›sCŞËùÜFaùÜy
 {}

195 
im¶
 
TabËPrİ”t›sCŞËùÜFaùÜy
 
	gMvccPrİ”t›sCŞËùÜFaùÜy
 {

196 
â
 
ü—‹_bË_´İ”t›s_cŞËùÜ
(&
mut
 
£lf
, 
_
: 
u32
è-> 
Box
<
TabËPrİ”t›sCŞËùÜ
> {

197 
Box
::
Ãw
(
MvccPrİ”t›sCŞËùÜ
::new())

201 #[
d”ive
(
ClÚe
, 
Debug
, 
DeçuÉ
)]

202 
pub
 
	sIndexHªdË
 {

203 
pub
 
	msize
: 
u64
,

204 
pub
 
	moff£t
: 
u64
,

207 #[
d”ive
(
DeçuÉ
)]

208 
pub
 
IndexHªdËs
(
BT»eM­
<
Vec
<
u8
>, 
IndexHªdË
>);

210 
im¶
 
D”ef
 
	gIndexHªdËs
 {

211 
ty³
 
	gT¬g‘
 = 
BT»eM­
<
Vec
<
u8
>, 
	gIndexHªdË
>;

212 
â
 
d”ef
(&
£lf
è-> &
	gBT»eM­
<
	gVec
<
	gu8
>, 
	gIndexHªdË
> {

213 &
	g£lf
.0

217 
im¶
 
D”efMut
 
	gIndexHªdËs
 {

218 
â
 
d”ef_mut
(&
mut
 
£lf
è-> &muˆ
	gBT»eM­
<
	gVec
<
	gu8
>, 
	gIndexHªdË
> {

219 &
mut
 
	g£lf
.0

223 
im¶
 
	gIndexHªdËs
 {

224 
â
 
Ãw
(è-> 
	gIndexHªdËs
 {

225 
IndexHªdËs
(
BT»eM­
::
Ãw
())

229 
â
 
’code
(&
£lf
è-> 
Vec
<
u8
> {

230 
Ët
 
mut
 
buf
 = 
Vec
::
w™h_ÿ·c™y
(1024);

231 
	gk
, 
	gv
è
	gš
 &
	g£lf
.0 {

232 
	gbuf
.
’code_u64
(
k
.
Ën
(è
as
 
u64
).
unw¿p
();

233 
	gbuf
.
ex‹nd
(
k
);

234 
	gbuf
.
’code_u64
(
v
.
size
).
unw¿p
();

235 
	gbuf
.
’code_u64
(
v
.
off£t
).
unw¿p
();

237 
	gbuf


240 
â
 
decode
(
mut
 
buf
: &[
u8
]è-> 
ResuÉ
<
IndexHªdËs
> {

241 
Ët
 
mut
 
»s
 = 
BT»eM­
::
Ãw
();

242 !
	gbuf
.
is_em±y
() {

243 
Ët
 
	gkËn
 = 
buf
.
decode_u64
()?;

244 
Ët
 
mut
 
	gk
 = 
vec
![0; 
kËn
 
as
 
usize
];

245 
	gbuf
.
»ad_exaù
(&
mut
 
k
)?;

246 
Ët
 
mut
 
	gv
 = 
IndexHªdË
::();

247 
	gv
.
	gsize
 = 
buf
.
decode_u64
()?;

248 
	gv
.
	goff£t
 = 
buf
.
decode_u64
()?;

249 
	g»s
.
š£¹
(
k
, 
v
);

251 
Ok
(
IndexHªdËs
(
»s
))

254 
â
 
g‘_­´oxim©e_di¡ªû_š_¿nge
(&
£lf
, 
¡¬t
: &[
u8
], 
’d
: &[u8]è-> 
u64
 {

255 
as£¹
!(
’d
 >ğ
¡¬t
);

256 
Ët
 
mut
 
	g¿nge
 = 
£lf
.
¿nge
::<[
u8
], 
	g_
>((
Inşuded
(
¡¬t
), 
	gUnbounded
));

257 
Ët
 
	g¡¬t_off£t
 = 
m©ch
 
¿nge
.
Ãxt
() {

258 
Some
((
_
, 
v
)è=> v.
off£t
,

259 
	gNÚe
 =>  0,

261 
Ët
 
mut
 
	g¿nge
 = 
£lf
.
¿nge
::<[
u8
], 
	g_
>((
Inşuded
(
’d
), 
	gUnbounded
));

262 
Ët
 
	g’d_off£t
 = 
m©ch
 
¿nge
.
Ãxt
() {

263 
Some
((
_
, 
v
)è=> v.
off£t
,

264 
	gNÚe
 => {

266 
Ët
 (
_
, 
v
èğ
£lf
.
™”
().
Ï¡
().
unw¿p
();

267 
	gv
.
	goff£t


270 
	g’d_off£t
 < 
	g¡¬t_off£t
 {

271 
	g·nic
!(

273 
	g¡¬t
,

274 
	g’d
,

275 
	g¡¬t_off£t
,

276 
	g’d_off£t


279 
	g’d_off£t
 - 
	g¡¬t_off£t


283 #[
d”ive
(
DeçuÉ
)]

284 
pub
 
	sRowsPrİ”t›s
 {

285 
pub
 
	mtÙ®_rows
: 
u64
,

286 
pub
 
	mšdex_hªdËs
: 
IndexHªdËs
,

289 
im¶
 
	gRowsPrİ”t›s
 {

290 
pub
 
â
 
	gdecode
<
	gT
: 
DecodePrİ”t›s
>(
´İs
: &
T
è-> 
ResuÉ
<
RowsPrİ”t›s
> {

291 
Ët
 
mut
 
»s
 = 
RowsPrİ”t›s
::();

292 
	g»s
.
	gtÙ®_rows
 = 
´İs
.
decode_u64
(
PROP_NUM_ROWS
)?;

293 
	g»s
.
	gšdex_hªdËs
 = 
´İs
.
decode_hªdËs
(
PROP_ROWS_INDEX
)?;

294 
Ok
(
»s
)

297 
pub
 
â
 
g‘_­´oxim©e_rows_š_¿nge
(&
£lf
, 
¡¬t
: &[
u8
], 
’d
: &[u8]è-> 
u64
 {

298 
£lf
.
šdex_hªdËs


299 .
g‘_­´oxim©e_di¡ªû_š_¿nge
(
¡¬t
, 
’d
)

303 #[
d”ive
(
DeçuÉ
)]

304 
pub
 
	sSizePrİ”t›s
 {

305 
pub
 
	mtÙ®_size
: 
u64
,

306 
pub
 
	mšdex_hªdËs
: 
IndexHªdËs
,

309 
im¶
 
	gSizePrİ”t›s
 {

310 
pub
 
â
 
’code
(&
£lf
è-> 
	gU£rPrİ”t›s
 {

311 
Ët
 
mut
 
	g´İs
 = 
U£rPrİ”t›s
::
Ãw
();

312 
	g´İs
.
’code_u64
(
PROP_TOTAL_SIZE
, 
£lf
.
tÙ®_size
);

313 
	g´İs
.
’code_hªdËs
(
PROP_SIZE_INDEX
, &
£lf
.
šdex_hªdËs
);

314 
	g´İs


317 
pub
 
â
 
	gdecode
<
	gT
: 
DecodePrİ”t›s
>(
´İs
: &
T
è-> 
ResuÉ
<
SizePrİ”t›s
> {

318 
Ët
 
mut
 
»s
 = 
SizePrİ”t›s
::();

319 
	g»s
.
	gtÙ®_size
 = 
´İs
.
decode_u64
(
PROP_TOTAL_SIZE
)?;

320 
	g»s
.
	gšdex_hªdËs
 = 
´İs
.
decode_hªdËs
(
PROP_SIZE_INDEX
)?;

321 
Ok
(
»s
)

324 
pub
 
â
 
g‘_­´oxim©e_size_š_¿nge
(&
£lf
, 
¡¬t
: &[
u8
], 
’d
: &[u8]è-> 
u64
 {

325 
£lf
.
šdex_hªdËs


326 .
g‘_­´oxim©e_di¡ªû_š_¿nge
(
¡¬t
, 
’d
)

330 
pub
 
	sSizePrİ”t›sCŞËùÜ
 {

331 
	m´İs
: 
SizePrİ”t›s
,

332 
	mÏ¡_key
: 
Vec
<
u8
>,

333 
	mšdex_hªdË
: 
IndexHªdË
,

336 
im¶
 
	gSizePrİ”t›sCŞËùÜ
 {

337 
â
 
Ãw
(è-> 
	gSizePrİ”t›sCŞËùÜ
 {

338 
	gSizePrİ”t›sCŞËùÜ
 {

339 
	g´İs
: 
SizePrİ”t›s
::(),

340 
	gÏ¡_key
: 
Vec
::
Ãw
(),

341 
	gšdex_hªdË
: 
IndexHªdË
::(),

346 
im¶
 
TabËPrİ”t›sCŞËùÜ
 
	gSizePrİ”t›sCŞËùÜ
 {

347 
â
 
add
(&
mut
 
£lf
, 
key
: &[
u8
], 
v®ue
: &[u8], 
’Œy_ty³
: 
DBEÁryTy³
, 
_
: 
u64
, _: u64) {

348 
’Œy_ty³
 !ğ
DBEÁryTy³
::
Put
 {

351 
Ët
 
	gsize
 = 
key
.
Ën
(è+ 
v®ue
.len();

352 
	g£lf
.
	gšdex_hªdË
.
	gsize
 +ğ
size
 
as
 
u64
;

353 
	g£lf
.
	gšdex_hªdË
.
	goff£t
 +ğ
size
 
as
 
u64
;

355 
	g£lf
.
	gÏ¡_key
.
is_em±y
(è|| s–f.
	gšdex_hªdË
.
	gsize
 >ğ
PROP_SIZE_INDEX_DISTANCE
 {

356 
£lf
.
´İs


357 .
šdex_hªdËs


358 .
š£¹
(
key
.
to_owÃd
(), 
£lf
.
šdex_hªdË
.
şÚe
());

359 
	g£lf
.
	gšdex_hªdË
.
	gsize
 = 0;

361 
	g£lf
.
	gÏ¡_key
.
ş—r
();

362 
	g£lf
.
	gÏ¡_key
.
ex‹nd_äom_¦iû
(
key
);

365 
â
 
fšish
(&
mut
 
£lf
è-> 
	gHashM­
<
	gVec
<
	gu8
>, Vec<u8>> {

366 
	g£lf
.
	g´İs
.
	gtÙ®_size
 = 
£lf
.
šdex_hªdË
.
off£t
;

367 
	g£lf
.
	gšdex_hªdË
.
	gsize
 > 0 {

368 
	g£lf
.
	g´İs


369 .
	gšdex_hªdËs


370 .
š£¹
(
£lf
.
Ï¡_key
.
şÚe
(), s–f.
šdex_hªdË
.clone());

372 
	g£lf
.
	g´İs
.
’code
().0

376 #[
d”ive
(
DeçuÉ
)]

377 
pub
 
	sSizePrİ”t›sCŞËùÜFaùÜy
 {}

379 
im¶
 
TabËPrİ”t›sCŞËùÜFaùÜy
 
	gSizePrİ”t›sCŞËùÜFaùÜy
 {

380 
â
 
ü—‹_bË_´İ”t›s_cŞËùÜ
(&
mut
 
£lf
, 
_
: 
u32
è-> 
Box
<
TabËPrİ”t›sCŞËùÜ
> {

381 
Box
::
Ãw
(
SizePrİ”t›sCŞËùÜ
::new())

385 
pub
 
U£rPrİ”t›s
(
HashM­
<
Vec
<
u8
>, Vec<u8>>);

387 
im¶
 
D”ef
 
	gU£rPrİ”t›s
 {

388 
ty³
 
	gT¬g‘
 = 
HashM­
<
Vec
<
u8
>, 
	gVec
<
	gu8
>>;

389 
â
 
d”ef
(&
£lf
è-> &
	gHashM­
<
	gVec
<
	gu8
>, Vec<u8>> {

390 &
	g£lf
.0

394 
im¶
 
D”efMut
 
	gU£rPrİ”t›s
 {

395 
â
 
d”ef_mut
(&
mut
 
£lf
è-> &muˆ
	gHashM­
<
	gVec
<
	gu8
>, Vec<u8>> {

396 &
mut
 
	g£lf
.0

400 
im¶
 
	gU£rPrİ”t›s
 {

401 
â
 
Ãw
(è-> 
	gU£rPrİ”t›s
 {

402 
U£rPrİ”t›s
(
HashM­
::
Ãw
())

405 
â
 
’code
(&
mut
 
£lf
, 
Çme
: &
¡r
, 
v®ue
: 
Vec
<
u8
>) {

406 
£lf
.
š£¹
(
Çme
.
as_by‹s
().
to_owÃd
(), 
v®ue
);

409 
pub
 
â
 
’code_u64
(&
mut
 
£lf
, 
Çme
: &
¡r
, 
v®ue
: 
u64
) {

410 
Ët
 
mut
 
buf
 = 
Vec
::
w™h_ÿ·c™y
(8);

411 
	gbuf
.
’code_u64
(
v®ue
).
unw¿p
();

412 
	g£lf
.
’code
(
Çme
, 
buf
);

415 
pub
 
â
 
’code_hªdËs
(&
mut
 
£lf
, 
Çme
: &
¡r
, 
hªdËs
: &
IndexHªdËs
) {

416 
£lf
.
’code
(
Çme
, 
hªdËs
.encode())

420 
pub
 
Œa™
 
	gDecodePrİ”t›s
 {

421 
â
 
decode
(&
£lf
, 
k
: &
¡r
è-> 
ResuÉ
<&[
u8
]>;

423 
â
 
decode_u64
(&
£lf
, 
k
: &
¡r
è-> 
ResuÉ
<
u64
> {

424 
Ët
 
mut
 
buf
 = 
£lf
.
decode
(
k
)?;

425 
	gbuf
.
decode_u64
()

428 
â
 
decode_hªdËs
(&
£lf
, 
k
: &
¡r
è-> 
ResuÉ
<
IndexHªdËs
> {

429 
Ët
 
buf
 = 
£lf
.
decode
(
k
)?;

430 
	gIndexHªdËs
::
decode
(
buf
)

434 
im¶
 
DecodePrİ”t›s
 
U£rPrİ”t›s
 {

435 
â
 
decode
(&
£lf
, 
k
: &
¡r
è-> 
ResuÉ
<&[
u8
]> {

436 
m©ch
 
£lf
.0.
g‘
(
k
.
as_by‹s
()) {

437 
Some
(
v
è=> 
Ok
(v.
as_¦iû
()),

438 
	gNÚe
 => 
E¼
(
E¼Ü
::
KeyNÙFound
),

443 
im¶
 
DecodePrİ”t›s
 
	gU£rCŞËùedPrİ”t›s
 {

444 
â
 
decode
(&
£lf
, 
k
: &
¡r
è-> 
ResuÉ
<&[
u8
]> {

445 
m©ch
 
£lf
.
g‘
(
k
.
as_by‹s
()) {

446 
Some
(
v
è=> 
Ok
(v),

447 
	gNÚe
 => 
E¼
(
E¼Ü
::
KeyNÙFound
),

452 #[
cfg
(
‹¡
)]

453 
mod
 
	g‹¡s
 {

454 
u£
 
	gsu³r
::*;

455 
u£
 
	grocksdb
::{
DBEÁryTy³
, 
	gTabËPrİ”t›sCŞËùÜ
};

456 
u£
 
	g¡Üage
::
Key
;

457 
u£
 
	g¡Üage
::
mvcc
::{
Wr™e
, 
	gWr™eTy³
};

458 
u£
 
	g¿á¡Üe
::
¡Üe
::
keys
;

460 #[
‹¡
]

461 
â
 
‹¡_mvcc_´İ”t›s
() {

462 
Ët
 
	gÿ£s
 = [

463 ("ab", 2, 
Wr™eTy³
::
Put
, 
DBEÁryTy³
::Put),

464 ("ab", 1, 
Wr™eTy³
::
D–‘e
, 
DBEÁryTy³
::
Put
),

465 ("ab", 1, 
Wr™eTy³
::
D–‘e
, 
DBEÁryTy³
::Delete),

466 ("cd", 5, 
Wr™eTy³
::
D–‘e
, 
DBEÁryTy³
::
Put
),

467 ("cd", 4, 
Wr™eTy³
::
Put
, 
DBEÁryTy³
::Put),

468 ("cd", 3, 
Wr™eTy³
::
Put
, 
DBEÁryTy³
::Put),

469 ("ef", 6, 
Wr™eTy³
::
Put
, 
DBEÁryTy³
::Put),

470 ("ef", 6, 
Wr™eTy³
::
Put
, 
DBEÁryTy³
::
D–‘e
),

471 ("gh", 7, 
Wr™eTy³
::
D–‘e
, 
DBEÁryTy³
::
Put
),

473 
Ët
 
mut
 
	gcŞËùÜ
 = 
MvccPrİ”t›sCŞËùÜ
::
Ãw
();

474 &(
	gkey
, 
	gts
, 
	gwr™e_ty³
, 
	g’Œy_ty³
è
	gš
 &
	gÿ£s
 {

475 
Ët
 
	gk
 = 
Key
::
äom_¿w
(
key
.
as_by‹s
()).
­³nd_ts
(
ts
);

476 
Ët
 
	gk
 = 
keys
::
d©a_key
(
k
.
’coded
());

477 
Ët
 
	gv
 = 
Wr™e
::
Ãw
(
wr™e_ty³
, 
ts
, 
NÚe
).
to_by‹s
();

478 
	gcŞËùÜ
.
add
(&
k
, &
v
, 
’Œy_ty³
, 0, 0);

480 
Ët
 
	g»suÉ
 = 
U£rPrİ”t›s
(
cŞËùÜ
.
fšish
());

482 
Ët
 
	g´İs
 = 
MvccPrİ”t›s
::
decode
(&
»suÉ
).
unw¿p
();

483 
	gas£¹_eq
!(
	g´İs
.
	gmš_ts
, 1);

484 
	gas£¹_eq
!(
	g´İs
.
	gmax_ts
, 7);

485 
	gas£¹_eq
!(
	g´İs
.
	gnum_rows
, 4);

486 
	gas£¹_eq
!(
	g´İs
.
	gnum_puts
, 4);

487 
	gas£¹_eq
!(
	g´İs
.
	gnum_v”siÚs
, 7);

488 
	gas£¹_eq
!(
	g´İs
.
	gmax_row_v”siÚs
, 3);

491 #[
‹¡
]

492 
â
 
‹¡_rows_´İ”t›s
() {

493 
Ët
 
mut
 
	gcŞËùÜ
 = 
MvccPrİ”t›sCŞËùÜ
::
Ãw
();

494 
Ët
 
	gnum_rows
 = 
PROP_ROWS_INDEX_DISTANCE
 * 3 + 2;

495 
i
 
	gš
 0..
	gnum_rows
 {

496 
Ët
 
	gkey
 = 
fÜm©
!("k-{}", 
	gi
);

497 
Ët
 
	gk1
 = 
Key
::
äom_¿w
(
key
.
as_by‹s
()).
­³nd_ts
(2);

498 
Ët
 
	gk1
 = 
keys
::
d©a_key
(
k1
.
’coded
());

499 
Ët
 
	gk2
 = 
Key
::
äom_¿w
(
key
.
as_by‹s
()).
­³nd_ts
(1);

500 
Ët
 
	gk2
 = 
keys
::
d©a_key
(
k2
.
’coded
());

501 
Ët
 
	gv
 = 
Wr™e
::
Ãw
(
Wr™eTy³
::
Put
, 0, 
NÚe
).
to_by‹s
();

502 
	gcŞËùÜ
.
add
(&
k1
, &
v
, 
DBEÁryTy³
::
Put
, 0, 0);

503 
	gcŞËùÜ
.
add
(&
k2
, &
v
, 
DBEÁryTy³
::
Put
, 0, 0);

505 
Ët
 
	g»suÉ
 = 
U£rPrİ”t›s
(
cŞËùÜ
.
fšish
());

507 
Ët
 
	g´İs
 = 
RowsPrİ”t›s
::
decode
(&
»suÉ
).
unw¿p
();

508 
	gas£¹_eq
!(
	g´İs
.
	gtÙ®_rows
, 
	gnum_rows
);

509 
	gas£¹_eq
!(
	g´İs
.
	gšdex_hªdËs
.
Ën
(), 5);

510 
Ët
 
	gÿ£s
 = [

514 
PROP_ROWS_INDEX_DISTANCE
,

515 
PROP_ROWS_INDEX_DISTANCE
 + 1,

519 
PROP_ROWS_INDEX_DISTANCE
,

520 
PROP_ROWS_INDEX_DISTANCE
 * 2 + 1,

524 
PROP_ROWS_INDEX_DISTANCE
,

525 
PROP_ROWS_INDEX_DISTANCE
 * 3 + 1,

527 ("k-30001", 1, 
PROP_ROWS_INDEX_DISTANCE
 * 3 + 2),

529 &(
	gkey
, 
	gsize
, 
	goff£t
è
	gš
 &
	gÿ£s
 {

530 
Ët
 
	gk
 = 
Key
::
äom_¿w
(
key
.
as_by‹s
());

531 
Ët
 
	gk
 = 
keys
::
d©a_key
(
k
.
’coded
());

532 
Ët
 
	gh
 = &
´İs
.
šdex_hªdËs
[&
k
];

533 
	gas£¹_eq
!(
	gh
.
	gsize
, size);

534 
	gas£¹_eq
!(
	gh
.
	goff£t
, offset);

537 
Ët
 
	gh
: 
Vec
<
_
> = 
´İs
.
šdex_hªdËs
.
v®ues
().
cŞËù
();

538 
Ët
 
	gÿ£s
 = [

539 ("a", "z", 
h
[4].
	goff£t
 - 
	gh
[0].offset),

542 ("k-0", "k-10000", 
	gh
[1].
	goff£t
 - h[0].offset),

543 ("k-0", "k-20000", 
	gh
[2].
	goff£t
 - h[0].offset),

544 ("k-10000", "k-18888", 
	gh
[2].
	goff£t
 - h[1].offset),

546 ("k-16666", "k-26666", 
	gh
[3].
	goff£t
 - h[2].offset),

549 &(
	g¡¬t
, 
	g’d
, 
	grows
è
	gš
 &
	gÿ£s
 {

550 
Ët
 
	g¡¬t
 = 
keys
::
d©a_key
(
¡¬t
.
as_by‹s
());

551 
Ët
 
	g’d
 = 
keys
::
d©a_key
(
’d
.
as_by‹s
());

552 
	gas£¹_eq
!(
	g´İs
.
g‘_­´oxim©e_rows_š_¿nge
(&
¡¬t
, &
’d
), 
	grows
);

556 #[
‹¡
]

557 
â
 
‹¡_size_´İ”t›s
() {

558 
Ët
 
	gÿ£s
 = [

561 ("b", 
PROP_SIZE_INDEX_DISTANCE
 / 8),

562 ("c", 
PROP_SIZE_INDEX_DISTANCE
 / 4),

563 ("d", 
PROP_SIZE_INDEX_DISTANCE
 / 2),

564 ("e", 
PROP_SIZE_INDEX_DISTANCE
 / 8),

566 ("f", 
PROP_SIZE_INDEX_DISTANCE
 / 4),

567 ("g", 
PROP_SIZE_INDEX_DISTANCE
 / 2),

568 ("h", 
PROP_SIZE_INDEX_DISTANCE
 / 8),

569 ("i", 
PROP_SIZE_INDEX_DISTANCE
 / 4),

571 ("j", 
PROP_SIZE_INDEX_DISTANCE
 / 2),

572 ("k", 
PROP_SIZE_INDEX_DISTANCE
),

576 
Ët
 
mut
 
	gcŞËùÜ
 = 
SizePrİ”t›sCŞËùÜ
::
Ãw
();

577 &(
	gk
, 
	gvËn
è
	gš
 &
	gÿ£s
 {

578 
Ët
 
	gv
 = 
vec
![0; 
vËn
 
as
 
usize
];

579 
	gcŞËùÜ
.
add
(
k
.
as_by‹s
(), &
v
, 
DBEÁryTy³
::
Put
, 0, 0);

581 &(
	gk
, 
	gvËn
è
	gš
 &
	gÿ£s
 {

582 
Ët
 
	gv
 = 
vec
![0; 
vËn
 
as
 
usize
];

583 
	gcŞËùÜ
.
add
(
k
.
as_by‹s
(), &
v
, 
DBEÁryTy³
::
Oth”
, 0, 0);

585 
Ët
 
	g»suÉ
 = 
U£rPrİ”t›s
(
cŞËùÜ
.
fšish
());

587 
Ët
 
	g´İs
 = 
SizePrİ”t›s
::
decode
(&
»suÉ
).
unw¿p
();

588 
	gas£¹_eq
!(
	g´İs
.
	gtÙ®_size
, 
	gPROP_SIZE_INDEX_DISTANCE
 / 8 * 29 + 11);

589 
Ët
 
	ghªdËs
 = &
´İs
.
šdex_hªdËs
;

590 
	gas£¹_eq
!(
	ghªdËs
.
Ën
(), 4);

591 
Ët
 
	ga
 = &
hªdËs
[
b
"a".
as_»f
()];

592 
	gas£¹_eq
!(
	ga
.
	gsize
, 1);

593 
	gas£¹_eq
!(
	ga
.
	goff£t
, 1);

594 
Ët
 
	ge
 = &
hªdËs
[
b
"e".
as_»f
()];

595 
	gas£¹_eq
!(
	ge
.
	gsize
, 
	gPROP_SIZE_INDEX_DISTANCE
 + 4);

596 
	gas£¹_eq
!(
	ge
.
	goff£t
, 
	gPROP_SIZE_INDEX_DISTANCE
 + 5);

597 
Ët
 
	gi
 = &
hªdËs
[
b
"i".
as_»f
()];

598 
	gas£¹_eq
!(
	gi
.
	gsize
, 
	gPROP_SIZE_INDEX_DISTANCE
 / 8 * 9 + 4);

599 
	gas£¹_eq
!(
	gi
.
	goff£t
, 
	gPROP_SIZE_INDEX_DISTANCE
 / 8 * 17 + 9);

600 
Ët
 
	gk
 = &
hªdËs
[
b
"k".
as_»f
()];

601 
	gas£¹_eq
!(
	gk
.
	gsize
, 
	gPROP_SIZE_INDEX_DISTANCE
 / 8 * 12 + 2);

602 
	gas£¹_eq
!(
	gk
.
	goff£t
, 
	gPROP_SIZE_INDEX_DISTANCE
 / 8 * 29 + 11);

604 
Ët
 
	gÿ£s
 = [

605 (" ", "z", 
k
.
off£t
 - 
a
.offset),

608 ("a", "k", 
k
.
off£t
 - 
a
.offset),

609 ("a", "i", 
i
.
off£t
 - 
a
.offset),

610 ("e", "h", 
i
.
off£t
 - 
e
.offset),

614 &(
	g¡¬t
, 
	g’d
, 
	gsize
è
	gš
 &
	gÿ£s
 {

615 
	gas£¹_eq
!(

616 
	g´İs
.
g‘_­´oxim©e_size_š_¿nge
(
¡¬t
.
as_by‹s
(), 
’d
.as_bytes()),

617 
	gsize


	@src/util/security.rs

15 
u£
 
	g¡d
::
fs
::
Fe
;

16 
u£
 
	g¡d
::
”rÜ
::
E¼Ü
;

17 
u£
 
	g¡d
::
io
::
R—d
;

18 
u£
 
	g¡d
::
±r
;

20 
u£
 
	gg½c
::{
ChªÃl
, 
	gChªÃlBud”
, 
	gChªÃlC»d’tŸlsBud”
, 
	gS”v”Bud”
,

21 
	gS”v”C»d’tŸlsBud”
};

23 #[
d”ive
(
ClÚe
, 
Debug
, 
S”Ÿlize
, 
De£rŸlize
, 
P¬tŸlEq
)]

24 #[
£rde
()]

25 #[
£rde
(
»Çme_®l
 = "kebab-case")]

26 
pub
 
	sSecur™yCÚfig
 {

27 
pub
 
	mÿ_·th
: 
SŒšg
,

28 
pub
 
	mû¹_·th
: 
SŒšg
,

29 
pub
 
	mkey_·th
: 
SŒšg
,

31 #[
£rde
(
sk
)]

32 
pub
 
	mov”ride_s¦_rg‘
: 
SŒšg
,

35 
im¶
 
DeçuÉ
 
	gSecur™yCÚfig
 {

36 
â
 (è-> 
	gSecur™yCÚfig
 {

37 
	gSecur™yCÚfig
 {

38 
	gÿ_·th
: 
SŒšg
::
Ãw
(),

39 
	gû¹_·th
: 
SŒšg
::
Ãw
(),

40 
	gkey_·th
: 
SŒšg
::
Ãw
(),

41 
	gov”ride_s¦_rg‘
: 
SŒšg
::
Ãw
(),

46 
â
 
check_key_fe
(
g
: &
¡r
, 
·th
: &¡rè-> 
ResuÉ
<
O±iÚ
<
Fe
>, 
	gBox
<
	gE¼Ü
>> {

47 
	g·th
.
is_em±y
() {

48  
Ok
(
NÚe
);

50 
m©ch
 
	gFe
::
İ’
(
·th
) {

51 
E¼
(
e
) => Err(

52 
fÜm©
!("çedØİ’ {}Ølßd {}: {:?}", 
·th
, 
g
, 
e
).
što
(),

54 
Ok
(
f
è=> Ok(
Some
(f)),

58 
â
 
lßd_key
(
g
: &
¡r
, 
·th
: &¡rè-> 
ResuÉ
<
Vec
<
u8
>, 
	gBox
<
	gE¼Ü
>> {

59 
Ët
 
mut
 
	gkey
 = 
vec
![];

60 
Ët
 
	gf
 = 
check_key_fe
(
g
, 
·th
)?;

61 
m©ch
 
	gf
 {

62 
	gNÚe
 =>  
Ok
(
vec
![]),

63 
Some
(
mut
 
f
è=> 
Ët
 
E¼
(
e
èğf.
»ad_to_’d
(&muˆ
key
) {

64  
E¼
(

65 
fÜm©
!("çedØlßd {} from…©h {}: {:?}", 
g
, 
·th
, 
e
).
što
(),

69 
Ok
(
key
)

72 
im¶
 
	gSecur™yCÚfig
 {

73 
pub
 
â
 
v®id©e
(&
mut
 
£lf
è-> 
	gResuÉ
<(), 
	gBox
<
	gE¼Ü
>> {

74 
check_key_fe
("ÿ key", &
£lf
.
ÿ_·th
)?;

75 
check_key_fe
("û¹ key", &
£lf
.
û¹_·th
)?;

76 
check_key_fe
("´iv©key", &
£lf
.
key_·th
)?;

78 ià(!
	g£lf
.
	gÿ_·th
.
is_em±y
(è|| !£lf.
	gû¹_·th
.is_em±y(è|| !£lf.
	gkey_·th
.is_empty()) &&

79 (
	g£lf
.
	gÿ_·th
.
is_em±y
(è|| s–f.
	gû¹_·th
.is_em±y(è|| s–f.
	gkey_·th
.is_empty())

81  
E¼
("ÿ, c”ˆªd…riv©key should b®ÈcÚfigu»d.".
što
());

84 
Ok
(())

88 
pub
 
	sSecur™yMªag”
 {

89 
	mÿ
: 
Vec
<
u8
>,

90 
	mû¹
: 
Vec
<
u8
>,

91 
	mkey
: 
Vec
<
u8
>,

92 
	mov”ride_s¦_rg‘
: 
SŒšg
,

95 
im¶
 
Drİ
 
	gSecur™yMªag”
 {

96 
â
 
drİ
(&
mut
 
£lf
) {

97 
	gun§ã
 {

98 
b
 
	gš
 &
mut
 
	g£lf
.
	gkey
 {

99 
	g±r
::
wr™e_vŞ©e
(
b
, 0);

105 
im¶
 
	gSecur™yMªag”
 {

106 
pub
 
â
 
Ãw
(
cfg
: &
Secur™yCÚfig
è-> 
ResuÉ
<
Secur™yMªag”
, 
	gBox
<
	gE¼Ü
>> {

107 
Ok
(
Secur™yMªag”
 {

108 
ÿ
: 
lßd_key
("CA", &
cfg
.
ÿ_·th
)?,

109 
û¹
: 
lßd_key
("û¹ifiÿ‹", &
cfg
.
û¹_·th
)?,

110 
key
: 
lßd_key
("´iv©key", &
cfg
.
key_·th
)?,

111 
ov”ride_s¦_rg‘
: 
cfg
.ov”ride_s¦_rg‘.
şÚe
(),

115 
pub
 
â
 
cÚÃù
(&
£lf
, 
mut
 
cb
: 
ChªÃlBud”
, 
addr
: &
¡r
è-> 
ChªÃl
 {

116 
£lf
.
ÿ
.
is_em±y
() {

117 
cb
.
cÚÃù
(
addr
)

119 !
£lf
.
ov”ride_s¦_rg‘
.
is_em±y
() {

120 
cb
 = cb.
ov”ride_s¦_rg‘
(
£lf
.ov”ride_s¦_rg‘.
şÚe
());

122 
Ët
 
	güed
 = 
ChªÃlC»d’tŸlsBud”
::
Ãw
()

123 .
roÙ_û¹
(
£lf
.
ÿ
.
şÚe
())

124 .
û¹
(
£lf
.û¹.
şÚe
(), s–f.
key
.clone())

125 .
bud
();

126 
	gcb
.
£cu»_cÚÃù
(
addr
, 
üed
)

130 
pub
 
â
 
bšd
(&
£lf
, 
sb
: 
S”v”Bud”
, 
addr
: &
¡r
, 
pÜt
: 
u16
) -> ServerBuilder {

131 
£lf
.
ÿ
.
is_em±y
() {

132 
sb
.
bšd
(
addr
, 
pÜt
)

134 
Ët
 
	güed
 = 
S”v”C»d’tŸlsBud”
::
Ãw
()

135 .
roÙ_û¹
(
£lf
.
ÿ
.
şÚe
(), 
Œue
)

136 .
add_û¹
(
£lf
.
û¹
.
şÚe
(), s–f.
key
.clone())

137 .
bud
();

138 
	gsb
.
bšd_£cu»
(
addr
, 
pÜt
, 
üed
)

143 #[
cfg
(
‹¡
)]

144 
mod
 
	g‹¡s
 {

145 
u£
 
	gsu³r
::*;

147 
u£
 
	g¡d
::
fs
::
Fe
;

148 
u£
 
	g¡d
::
io
::
Wr™e
;

150 
u£
 
	g‹mpdœ
::
TempDœ
;

152 #[
‹¡
]

153 
â
 
‹¡_£cur™y
() {

154 
Ët
 
mut
 
	gcfg
 = 
Secur™yCÚfig
::();

156 
	gcfg
.
v®id©e
().
unw¿p
();

157 
Ët
 
mut
 
	gmgr
 = 
Secur™yMªag”
::
Ãw
(&
cfg
).
unw¿p
();

158 
	gas£¹
!(
	gmgr
.
	gÿ
.
is_em±y
());

159 
	gas£¹
!(
	gmgr
.
	gû¹
.
is_em±y
());

160 
	gas£¹
!(
	gmgr
.
	gkey
.
is_em±y
());

162 
Ët
 
	gas£¹_cfg
 = |
c
: 
â
(&
mut
 
Secur™yCÚfig
), 
	gv®id
: 
boŞ
| {

163 
Ët
 
mut
 
šv®id_cfg
 = 
cfg
.
şÚe
();

164 
c
(&
mut
 
šv®id_cfg
);

165 
	gas£¹_eq
!(
	gšv®id_cfg
.
v®id©e
().
is_ok
(), 
	gv®id
);

169 
as£¹_cfg
(

170 |
c
| {

171 
c
.
ÿ_·th
 = "šv®id c¨·th".
to_owÃd
();

172 
c
.
û¹_·th
 = "šv®id c”ˆ·th".
to_owÃd
();

173 
c
.
key_·th
 = "šv®id key…©h".
to_owÃd
();

175 
çl£
,

178 
Ët
 
	g‹mp
 = 
TempDœ
::
Ãw
("‹¡_üed").
unw¿p
();

179 
Ët
 
	gexam¶e_ÿ
 = 
‹mp
.
·th
().
još
("ca");

180 
Ët
 
	gexam¶e_û¹
 = 
‹mp
.
·th
().
još
("cert");

181 
Ët
 
	gexam¶e_key
 = 
‹mp
.
·th
().
još
("key");

182 
	gid
, 
	gf
è
š
 (&[&
exam¶e_ÿ
, &
exam¶e_û¹
, &
exam¶e_key
])

183 .
što_™”
()

184 .
’um”©e
()

186 
	gFe
::
ü—‹
(
f
).
unw¿p
().
wr™e_®l
(&[
id
 
as
 
u8
]).unwrap();

188 
Ët
 
mut
 
	gc
 = 
cfg
.
şÚe
();

189 
	gc
.
	gû¹_·th
 = 
fÜm©
!("{}", 
	gexam¶e_û¹
.
di¥Ïy
());

190 
	gc
.
	gkey_·th
 = 
fÜm©
!("{}", 
	gexam¶e_key
.
di¥Ïy
());

192 
	gc
.
v®id©e
().
unw¿p_”r
();

195 
	gc
.
	gÿ_·th
 = 
fÜm©
!("{}", 
	gexam¶e_ÿ
.
di¥Ïy
());

196 
	gc
.
v®id©e
().
unw¿p
();

197 
	gmgr
 = 
Secur™yMªag”
::
Ãw
(&
c
).
unw¿p
();

198 
	gas£¹_eq
!(
	gmgr
.
	gÿ
, 
	gvec
![0]);

199 
	gas£¹_eq
!(
	gmgr
.
	gû¹
, 
	gvec
![1]);

200 
	gas£¹_eq
!(
	gmgr
.
	gkey
, 
	gvec
![2]);

	@src/util/thread_metrics.rs

14 
u£
 
	g¡d
::
fs
;

15 
u£
 
	g¡d
::
io
::{
E¼Ü
, 
	gE¼ÜKšd
, 
	gR—d
, 
	gResuÉ
};

16 
u£
 
	g¡d
::
sync
::
Mu‹x
;

18 
u£
 
	g´om‘heus
::{
£lf
, 
	g´Ùo
, 
	gCŞËùÜ
, 
	gCouÁ”Vec
, 
	gDesc
, 
	gO±s
};

20 
u£
 
	glibc
::{
£lf
, 
	gpid_t
};

23 
pub
 
â
 
	gmÚ™Ü_th»ads
<
	gS
: 
IÁo
<
SŒšg
>>(
Çme¥aû
: 
S
è-> 
ResuÉ
<()> {

24 
Ët
 
pid
 = 
un§ã
 { 
libc
::
g‘pid
() };

25 
Ët
 
	gtc
 = 
Th»adsCŞËtcÜ
::
Ãw
(
pid
, 
Çme¥aû
);

26 
	g´om‘heus
::(
Box
::
Ãw
(
tc
))

27 .
m­_”r
(|
e
| 
to_”r
(
fÜm©
!("{:?}",ƒ)))?;

29 
Ok
(())

32 
	sTh»adsCŞËtcÜ
 {

33 
	mpid
: 
pid_t
,

34 
	mdescs
: 
Vec
<
Desc
>,

35 
	mıu_tÙ®s
: 
Mu‹x
<
CouÁ”Vec
>,

38 
im¶
 
	gTh»adsCŞËtcÜ
 {

39 
â
 
	gÃw
<
	gS
: 
IÁo
<
SŒšg
>>(
pid
: 
pid_t
, 
	gÇme¥aû
: 
S
è-> 
Th»adsCŞËtcÜ
 {

40 
Ët
 
ıu_tÙ®s
 = 
CouÁ”Vec
::
Ãw
(

41 
O±s
::
Ãw
(

45 ).
Çme¥aû
(namespace),

47 ).
unw¿p
();

48 
Ët
 
	gdescs
 = 
ıu_tÙ®s
.
desc
().
što_™”
().
şÚed
().
cŞËù
();

50 
	gTh»adsCŞËtcÜ
 {

51 
	gpid
: 
pid
,

52 
	gdescs
: 
descs
,

53 
	gıu_tÙ®s
: 
Mu‹x
::
Ãw
(
ıu_tÙ®s
),

58 
im¶
 
CŞËùÜ
 
	gTh»adsCŞËtcÜ
 {

59 
â
 
desc
(&
£lf
è-> 
	gVec
<&
	gDesc
> {

60 
	g£lf
.
	gdescs
.
™”
().
cŞËù
()

63 
â
 
cŞËù
(&
£lf
è-> 
	gVec
<
	g´Ùo
::
M‘ricFamy
> {

64 
Ët
 
ıu_tÙ®s
 = 
£lf
.ıu_tÙ®s.
lock
().
unw¿p
();

65 
Ët
 
	gtids
 = 
g‘_th»ad_ids
(
£lf
.
pid
).
unw¿p
();

66 
tid
 
š
 
	gtids
 {

67 
Ët
 
Ok
((
Šame
, 
utime
, 
¡ime
)èğ
g‘_th»ad_¡©
(
£lf
.
pid
, 
tid
) {

68 
Ët
 
	gtÙ®
 = (
utime
 + 
¡ime
è/ *
CLK_TCK
;

69 
Ët
 
	gıu_tÙ®
 = 
ıu_tÙ®s


70 .
g‘_m‘ric_w™h_Ïb–_v®ues
(&[&
Šame
, &
fÜm©
!("{}", 
tid
)])

71 .
unw¿p
();

72 
Ët
 
	g·¡
 = 
ıu_tÙ®
.
g‘
();

73 
Ët
 
	gd–
 = 
tÙ®
 - 
·¡
;

74 
	gd–
 > 0.0 {

75 
	gıu_tÙ®
.
šc_by
(
d–
).
unw¿p
();

80 
	gıu_tÙ®s
.
cŞËù
()

84 
â
 
g‘_th»ad_ids
(
pid
: 
pid_t
è-> 
ResuÉ
<
Vec
<pid_t>> {

85 
Ët
 
mut
 
tids
 = 
Vec
::
Ãw
();

86 
Ët
 
	gdœs
 = 
fs
::
»ad_dœ
(
fÜm©
!("/´oc/{}/sk", 
pid
))?;

87 
sk
 
š
 
	gdœs
 {

88 
Ët
 
	gfe_Çme
 = 
m©ch
 
sk
 {

89 
Ok
(
t
è=>.
fe_Çme
(),

90 
E¼
(
e
) => {

91 
”rÜ
!("çØ»adask oà{},ƒ¼Ü {:?}", 
pid
, 
e
);

96 
Ët
 
	gtid
 = 
m©ch
 
fe_Çme
.
to_¡r
() {

97 
Some
(
tid
è=> 
m©ch
id.
·r£
() {

98 
Ok
(
tid
) =>id,

99 
E¼
(
e
) => {

100 
”rÜ
!("çØ»adask oà{},ƒ¼Ü {:?}", 
pid
, 
e
);

104 
	gNÚe
 => {

105 
”rÜ
!("çØ»adask oà{}", 
pid
);

109 
	gtids
.
push
(
tid
);

112 
Ok
(
tids
)

116 
â
 
g‘_th»ad_Çme
(
tid
: 
pid_t
, 
¡©
: &
¡r
è-> 
ResuÉ
<(
SŒšg
, 
	gusize
)> {

117 
Ët
 
	g¡¬t
 = 
¡©
.
fšd
('(');

118 
Ët
 
	g’d
 = 
¡©
.
rfšd
(')');

120 
Ët
 (
Some
(
¡¬t
), Some(
’d
)èğ(¡¬t, 
	g’d
) {

121 
Ët
 
	g¿w
 = &
¡©
[
¡¬t
 + 1..e
nd
];

122 
Ët
 
mut
 
	gÇme
 = 
SŒšg
::
w™h_ÿ·c™y
(
¿w
.
Ën
());

125 
c
 
š
 
	g¿w
.
ch¬s
() {

126 
m©ch
 
	gc
 {

129 
Çme
.
push
(
c
);

132 
Çme
.
push
('_');

134 
	g_
 => (),

138 
	gÇme
.
is_em±y
() {

139 
	gÇme
 = 
fÜm©
!("{}", 
	gtid
)

142  
Ok
((
Çme
, 
’d
));

145 
E¼
(
to_”r
(
fÜm©
!("ÿÀnÙ fšdh»ad‚ame, st: {}", 
¡©
)))

148 
â
 
to_”r
(
s
: 
SŒšg
è-> 
E¼Ü
 {

149 
E¼Ü
::
Ãw
(
E¼ÜKšd
::
Oth”
, 
s
)

154 cÚ¡ 
	gCPU_INDEX
: [
usize
; 2] = [14 - 1, 15 - 1];

156 
â
 
g‘_th»ad_¡©
(
pid
: 
pid_t
, 
tid
:…id_tè-> 
ResuÉ
<(
SŒšg
, 
	gf64
, f64)> {

157 
Ët
 
mut
 
	g¡©
 = 
SŒšg
::
Ãw
();

158 
	gfs
::
Fe
::
İ’
(
fÜm©
!("/´oc/{}/sk/{}/¡©", 
pid
, 
tid
))

159 .
ªd_th’
(|
mut
 
f
| f.
»ad_to_¡ršg
(&muˆ
¡©
))?;

160 
g‘_th»ad_¡©_š‹º®
(
tid
, &
¡©
)

164 
â
 
g‘_th»ad_¡©_š‹º®
(
tid
: 
pid_t
, 
¡©
: &
¡r
è-> 
ResuÉ
<(
SŒšg
, 
	gf64
, f64)> {

165 
Ët
 (
Çme
, 
’d
èğ
g‘_th»ad_Çme
(
tid
, 
¡©
)?;

166 
Ët
 
	g¡©s
: 
Vec
<
_
> = (&
¡©
[
’d
 + 2..]).
¥l™_wh™e¥aû
().
cŞËù
();

167 
Ët
 
	gutime
 = 
¡©s
[
CPU_INDEX
[0] - 2];

168 
Ët
 
	g¡ime
 = 
¡©s
[
CPU_INDEX
[1] - 2];

169 
Ok
((
Çme
, 
utime
.
·r£
().
unw¿p
(), 
¡ime
.parse().unwrap()))

172 
	gÏzy_¡©ic
! {

174 
»f
 
	gCLK_TCK
: 
f64
 = {

175 
un§ã
 {

176 
libc
::
syscÚf
Öibc::
_SC_CLK_TCK
è
as
 
f64


181 #[
cfg
(
‹¡
)]

182 
mod
 
	g‹¡s
 {

183 
u£
 
	g¡d
::
th»ad
;

184 
u£
 
	g¡d
::
sync
;

186 
u£
 
	glibc
;

188 #[
‹¡
]

189 
â
 
‹¡_th»ad_¡©
() {

190 
Ët
 
	gÇme
 = "theadnametest66";

191 
Ët
 (
tx
, 
rx
èğ
sync
::
mpsc
::
chªÃl
();

192 
Ët
 (
tx1
, 
rx1
èğ
sync
::
mpsc
::
chªÃl
();

193 
Ët
 
	gh
 = 
th»ad
::
Bud”
::
Ãw
()

194 .
Çme
Òame.
to_owÃd
())

195 .
¥awn
(
move
 || {

196 
tx1
.
£nd
(()).
unw¿p
();

197 
rx
.
»cv
().
unw¿p
();

199 .
unw¿p
();

200 
	grx1
.
»cv
().
unw¿p
();

202 
Ët
 
	gpid
 = 
un§ã
 { 
libc
::
g‘pid
() };

203 
Ët
 
	gtids
 = 
su³r
::
g‘_th»ad_ids
(
pid
).
unw¿p
();

204 
	gas£¹
!(
	gtids
.
Ën
() >= 2);

206 
	gtids
.
™”
()

207 .
fšd
(|
t
| {

208 
su³r
::
g‘_th»ad_¡©
(
pid
, **
t
)

209 .
m­
(|
¡©
| st.0 =ğ
Çme
)

210 .
unw¿p_Ü
(
çl£
)

212 .
unw¿p
();

214 
	gtx
.
£nd
(()).
unw¿p
();

215 
	gh
.
još
().
unw¿p
();

218 #[
‹¡
]

219 
â
 
‹¡_g‘_th»ad_Çme
() {

220 
Ët
 
	gÿ£s
 = [

229 &(
	gi
, 
	go
, 
	gidx
è
	gš
 &
	gÿ£s
 {

230 
Ët
 (
Çme
, 
’d
èğ
su³r
::
g‘_th»ad_Çme
(1, 
i
).
unw¿p
();

231 
	gas£¹_eq
!(
	gÇme
, 
	go
);

232 
	gas£¹_eq
!(
	g’d
, 
	gidx
);

235 
	gas£¹_eq
!(
	gsu³r
::
g‘_th»ad_Çme
(1, "(@#)").
unw¿p
().0, "1");

236 
	gas£¹
!(
	gsu³r
::
g‘_th»ad_Çme
(1, "šv®id_¡©").
is_”r
());

239 #[
‹¡
]

240 
â
 
‹¡_g‘_th»ad_¡©
() {

241 
Ët
 
	g§m¶e
 = "2810 (testhd) S 2550 2621 2621 0 -1 4210688 2632 0 52 0 839 138 0 \
0 20 0 4 0 13862 709652480 3647 18446744073709551615 4194304 4319028 \
140732554845776 140732554845392 140439688777693 0 0 4096 16384 0 0 0 17 3 \
0 0 245 0 0 6417696 6421000 8478720 140732554851684 140732554851747 \
140732554851747 140732554854339 0";

247 
Ët
 (
Çme
, 
utime
, 
¡ime
èğ
su³r
::
g‘_th»ad_¡©_š‹º®
(2810, 
§m¶e
).
unw¿p
();

248 
	gas£¹_eq
!(
	gÇme
, "test_thd");

249 
	gas£¹_eq
!(
utime
 
as
 
	gi64
, 839);

250 
	gas£¹_eq
!(
¡ime
 
as
 
	gi64
, 138);

	@src/util/threadpool.rs

14 
u£
 
	g¡d
::
usize
;

15 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

16 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gCÚdv¬
, 
	gMu‹x
};

17 
u£
 
	g¡d
::
th»ad
::{
Bud”
, 
	gJošHªdË
};

18 
u£
 
	g¡d
::
m¬k”
::
PhªtomD©a
;

19 
u£
 
	g¡d
::
boxed
::
FnBox
;

20 
u£
 
	g¡d
::
cŞËùiÚs
::
VecDeque
;

21 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
Ord”šg
 
as
 
	gAtomicOrd”šg
};

22 
u£
 
	g¡d
::
fmt
::
Wr™e
;

24 
pub
 cÚ¡ 
	gDEFAULT_TASKS_PER_TICK
: 
usize
 = 10000;

25 cÚ¡ 
	gDEFAULT_QUEUE_CAPACITY
: 
usize
 = 1000;

26 cÚ¡ 
	gDEFAULT_THREAD_COUNT
: 
usize
 = 1;

27 cÚ¡ 
	gNAP_SECS
: 
u64
 = 1;

28 cÚ¡ 
	gQUEUE_MAX_CAPACITY
: 
usize
 = 8 * 
DEFAULT_QUEUE_CAPACITY
;

30 
pub
 
Œa™
 
	gCÚ‹xt
: 
S’d
 {

31 
â
 
Ú_sk_¡¬‹d
(&
mut
 
£lf
) {}

32 
â
 
Ú_sk_fšished
(&
mut
 
£lf
) {}

33 
â
 
Ú_tick
(&
mut
 
£lf
) {}

36 #[
d”ive
(
DeçuÉ
)]

37 
pub
 
DeçuÉCÚ‹xt
;

39 
im¶
 
CÚ‹xt
 
	gDeçuÉCÚ‹xt
 {}

41 
pub
 
Œa™
 
	gCÚ‹xtFaùÜy
<
	gCtx
: 
CÚ‹xt
> {

42 
â
 
ü—‹
(&
£lf
è-> 
Ctx
;

45 
pub
 
	gDeçuÉCÚ‹xtFaùÜy
;

47 
	gim¶
<
	gC
: 
CÚ‹xt
 + 
DeçuÉ
> 
CÚ‹xtFaùÜy
<
C
> 
DeçuÉCÚ‹xtFaùÜy
 {

48 
â
 
ü—‹
(&
£lf
è-> 
C
 {

49 
C
::()

53 
pub
 
Task
<
C
> {

54 
sk
: 
Box
<
FnBox
(&
mut
 
C
è+ 
S’d
>,

57 
	gim¶
<
	gC
: 
CÚ‹xt
> 
Task
<
C
> {

58 
â
 
Ãw
<
F
>(
job
: Fè-> 
Task
<
C
>

59 
wh”e


60 <'r> F: FnOnû(&'
r
 
mut
 
C
è+ 
S’d
 + 'static,

62 
Task
 {

63 
sk
: 
Box
::
Ãw
(
job
),

69 
pub
 
	gFifoQueue
<
	gC
> {

70 
	gqueue
: 
VecDeque
<
Task
<
C
>>,

73 
	gim¶
<
	gC
: 
CÚ‹xt
> 
FifoQueue
<
C
> {

74 
â
 
Ãw
(è-> 
FifoQueue
<
C
> {

75 
FifoQueue
 {

76 
queue
: 
VecDeque
::
w™h_ÿ·c™y
(
DEFAULT_QUEUE_CAPACITY
),

80 
â
 
push
(&
mut
 
£lf
, 
sk
: 
Task
<
C
>) {

81 
£lf
.
queue
.
push_back
(
sk
);

84 
â
 
pİ
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gTask
<
	gC
>> {

85 
Ët
 
	gsk
 = 
£lf
.
queue
.
pİ_äÚt
();

87 
	g£lf
.
	gqueue
.
is_em±y
(è&& s–f.queue.
ÿ·c™y
(è> 
	gQUEUE_MAX_CAPACITY
 {

88 
	g£lf
.
	gqueue
 = 
VecDeque
::
w™h_ÿ·c™y
(
DEFAULT_QUEUE_CAPACITY
);

91 
	gsk


95 
pub
 
	gTh»adPoŞBud”
<
	gC
, 
	gF
> {

96 
	gÇme
: 
SŒšg
,

97 
	gth»ad_couÁ
: 
usize
,

98 
	gsks_³r_tick
: 
usize
,

99 
	g¡ack_size
: 
O±iÚ
<
usize
>,

100 
	gçùÜy
: 
F
,

101 
	g_ùx
: 
PhªtomD©a
<
C
>,

104 
	gim¶
<
	gC
: 
CÚ‹xt
 + 
DeçuÉ
 + 'static> ThreadPoolBuilder<C, DefaultContextFactory> {

105 
pub
 
â
 
w™h_deçuÉ_çùÜy
(
Çme
: 
SŒšg
è-> 
Th»adPoŞBud”
<
C
, 
	gDeçuÉCÚ‹xtFaùÜy
> {

106 
	gTh»adPoŞBud”
::
Ãw
(
Çme
, 
DeçuÉCÚ‹xtFaùÜy
)

110 
	gim¶
<
	gC
: 
CÚ‹xt
 + 'static, F: ContextFactory<C>> ThreadPoolBuilder<C, F> {

111 
pub
 
â
 
Ãw
(
Çme
: 
SŒšg
, 
çùÜy
: 
F
è-> 
Th»adPoŞBud”
<
C
, 
	gF
> {

112 
	gTh»adPoŞBud”
 {

113 
	gÇme
: 
Çme
,

114 
	gth»ad_couÁ
: 
DEFAULT_THREAD_COUNT
,

115 
	gsks_³r_tick
: 
DEFAULT_TASKS_PER_TICK
,

116 
	g¡ack_size
: 
NÚe
,

117 
	gçùÜy
: 
çùÜy
,

118 
	g_ùx
: 
PhªtomD©a
,

122 
pub
 
â
 
th»ad_couÁ
(
mut
 
£lf
, 
couÁ
: 
usize
è-> 
Th»adPoŞBud”
<
C
, 
	gF
> {

123 
	g£lf
.
	gth»ad_couÁ
 = 
couÁ
;

124 
	g£lf


127 
pub
 
â
 
sks_³r_tick
(
mut
 
£lf
, 
couÁ
: 
usize
è-> 
Th»adPoŞBud”
<
C
, 
	gF
> {

128 
	g£lf
.
	gsks_³r_tick
 = 
couÁ
;

129 
	g£lf


132 
pub
 
â
 
¡ack_size
(
mut
 
£lf
, 
size
: 
usize
è-> 
Th»adPoŞBud”
<
C
, 
	gF
> {

133 
	g£lf
.
	g¡ack_size
 = 
Some
(
size
);

134 
	g£lf


137 
pub
 
â
 
bud
(
£lf
è-> 
	gTh»adPoŞ
<
	gC
> {

138 
	gTh»adPoŞ
::
Ãw
(

139 
£lf
.
Çme
,

140 
£lf
.
th»ad_couÁ
,

141 
£lf
.
sks_³r_tick
,

142 
£lf
.
¡ack_size
,

143 
£lf
.
çùÜy
,

148 
	gScheduËS‹
<
	gCtx
> {

149 
	gqueue
: 
FifoQueue
<
Ctx
>,

150 
	g¡İ³d
: 
boŞ
,

157 
pub
 
	gTh»adPoŞ
<
	gCtx
> {

158 
	g¡©e
: 
Arc
<(
Mu‹x
<
ScheduËS‹
<
Ctx
>>, 
	gCÚdv¬
)>,

159 
	gth»ads
: 
Vec
<
JošHªdË
<()>>,

160 
	gsk_couÁ
: 
Arc
<
AtomicUsize
>,

163 
	gim¶
<
	gCtx
> 
	gTh»adPoŞ
<Ctx>

164 
wh”e


165 
	gCtx
: 
CÚ‹xt
 + 'static,

167 
â
 
Ãw
<
C
: 
CÚ‹xtFaùÜy
<
Ctx
>>(

168 
Çme
: 
SŒšg
,

169 
	gnum_th»ads
: 
usize
,

170 
	gsks_³r_tick
: 
usize
,

171 
	g¡ack_size
: 
O±iÚ
<
usize
>,

172 
	gf
: 
C
,

173 è-> 
	gTh»adPoŞ
<
	gCtx
> {

174 
	gas£¹
!(
	gnum_th»ads
 >= 1);

175 
Ët
 
	g¡©e
 = 
ScheduËS‹
 {

176 
queue
: 
FifoQueue
::
Ãw
(),

177 
¡İ³d
: 
çl£
,

179 
Ët
 
	g¡©e
 = 
Arc
::
Ãw
((
Mu‹x
::Ãw(
¡©e
), 
CÚdv¬
::new()));

180 
Ët
 
mut
 
	gth»ads
 = 
Vec
::
w™h_ÿ·c™y
(
num_th»ads
);

181 
Ët
 
	gsk_couÁ
 = 
Arc
::
Ãw
(
AtomicUsize
::new(0));

183 
_
 
	gš
 0..
	gnum_th»ads
 {

184 
Ët
 
	g¡©e
 = 
¡©e
.
şÚe
();

185 
Ët
 
	gsk_num
 = 
sk_couÁ
.
şÚe
();

186 
Ët
 
	gùx
 = 
f
.
ü—‹
();

187 
Ët
 
mut
 
	gtb
 = 
Bud”
::
Ãw
().
Çme
Òame.
şÚe
());

188 
Ët
 
Some
(
¡ack_size
) = stack_size {

189 
tb
 =b.
¡ack_size
(stack_size);

191 
Ët
 
	gth»ad
 = 
tb
.
¥awn
(
move
 || {

192 
Ët
 
mut
 
wÜk”
 = 
WÜk”
::
Ãw
(
¡©e
, 
sk_num
, 
sks_³r_tick
, 
ùx
);

193 
wÜk”
.
run
();

194 }).
unw¿p
();

195 
	gth»ads
.
push
(
th»ad
);

198 
	gTh»adPoŞ
 {

199 
	g¡©e
: 
¡©e
,

200 
	gth»ads
: 
th»ads
,

201 
	gsk_couÁ
: 
sk_couÁ
,

205 
pub
 
â
 
	gexecu‹
<
	gF
>(&
	g£lf
, 
	gjob
: 
F
)

206 
wh”e


207 
F
: 
FnOnû
(&
mut
 
Ctx
è+ 
S’d
 + 'static,

208 
Ctx
: 
CÚ‹xt
,

210 
Ët
 
	gsk
 = 
Task
::
Ãw
(
job
);

211 
	gËt
 &(
»f
 
	glock
,„eà
	gcv¬
èğ&*
£lf
.
¡©e
;

213 
Ët
 
mut
 
	g¡©e
 = 
lock
.lock().
unw¿p
();

214 
	g¡©e
.
	g¡İ³d
 {

217 
	g¡©e
.
	gqueue
.
push
(
sk
);

218 
	gcv¬
.
nÙify_Úe
();

220 
	g£lf
.
	gsk_couÁ
.
ãtch_add
(1, 
AtomicOrd”šg
::
SeqC¡
);

223 #[
šlše
]

224 
pub
 
â
 
g‘_sk_couÁ
(&
£lf
è-> 
	gusize
 {

225 
	g£lf
.
	gsk_couÁ
.
lßd
(
AtomicOrd”šg
::
SeqC¡
)

228 
pub
 
â
 
¡İ
(&
mut
 
£lf
è-> 
ResuÉ
<(), 
	gSŒšg
> {

229 
	gËt
 &(
»f
 
	glock
,„eà
	gcv¬
èğ&*
£lf
.
¡©e
;

231 
Ët
 
mut
 
	g¡©e
 = 
lock
.lock().
unw¿p
();

232 
	g¡©e
.
	g¡İ³d
 = 
Œue
;

233 
	gcv¬
.
nÙify_®l
();

235 
Ët
 
mut
 
	g”r_msg
 = 
SŒšg
::
Ãw
();

236 
t
 
š
 
	g£lf
.
	gth»ads
.
d¿š
(..) {

237 
Ët
 
E¼
(
e
èğ
t
.
još
() {

238 
wr™e
!(&
mut
 
”r_msg
, "FaedØjošh»ad w™hƒ¼: {:?};", 
e
).
unw¿p
();

241 !
	g”r_msg
.
is_em±y
() {

242  
E¼
(
”r_msg
);

244 
Ok
(())

249 
	gWÜk”
<
	gC
> {

250 
	g¡©e
: 
Arc
<(
Mu‹x
<
ScheduËS‹
<
C
>>, 
	gCÚdv¬
)>,

251 
	gsk_couÁ
: 
Arc
<
AtomicUsize
>,

252 
	gsks_³r_tick
: 
usize
,

253 
	gsk_couÁ”
: 
usize
,

254 
	gùx
: 
C
,

257 
	gim¶
<
	gC
> 
	gWÜk”
<C>

258 
wh”e


259 
	gC
: 
CÚ‹xt
,

261 
â
 
Ãw
(

262 
¡©e
: 
Arc
<(
Mu‹x
<
ScheduËS‹
<
C
>>, 
CÚdv¬
)>,

263 
sk_couÁ
: 
Arc
<
AtomicUsize
>,

264 
sks_³r_tick
: 
usize
,

265 
ùx
: 
C
,

266 è-> 
	gWÜk”
<
	gC
> {

267 
	gWÜk”
 {

268 
	g¡©e
: 
¡©e
,

269 
	gsk_couÁ
: 
sk_couÁ
,

270 
	gsks_³r_tick
: 
sks_³r_tick
,

271 
	gsk_couÁ”
: 0,

272 
	gùx
: 
ùx
,

276 
â
 
Ãxt_sk
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gTask
<
	gC
>> {

277 
	gËt
 &(
»f
 
	glock
,„eà
	gcv¬
èğ&*
£lf
.
¡©e
;

278 
Ët
 
mut
 
	g¡©e
 = 
lock
.lock().
unw¿p
();

279 
Ët
 
mut
 
	gtimeout
 = 
Some
(
Du¿tiÚ
::
äom_£cs
(
NAP_SECS
));

280 
	gloİ
 {

281 
	g¡©e
.
	g¡İ³d
 {

282  
	gNÚe
;

284 
m©ch
 
	g¡©e
.
	gqueue
.
pİ
() {

285 
Some
(
t
) => {

286 
£lf
.
sk_couÁ”
 += 1;

287  
Some
(
t
);

289 
	gNÚe
 => {

290 
¡©e
 = 
m©ch
 
timeout
 {

291 
Some
(
t
è=> 
cv¬
.
wa™_timeout
(
¡©e
,).
unw¿p
().0,

292 
	gNÚe
 => {

293 
£lf
.
sk_couÁ”
 = 0;

294 
	g£lf
.
	gùx
.
Ú_tick
();

295 
	gcv¬
.
wa™
(
¡©e
).
unw¿p
()

298 
	gtimeout
 = 
NÚe
;

304 
â
 
run
(&
mut
 
£lf
) {

305 
	gloİ
 {

306 
Ët
 
	gsk
 = 
m©ch
 
£lf
.
Ãxt_sk
() {

307 
NÚe
 => ,

308 
Some
(
t
) =>,

311 
	g£lf
.
	gùx
.
Ú_sk_¡¬‹d
();

312 (
	gsk
.sk).
ÿÎ_box
((&
mut
 
£lf
.
ùx
,));

313 
	g£lf
.
	gùx
.
Ú_sk_fšished
();

314 
	g£lf
.
	gsk_couÁ
.
ãtch_sub
(1, 
AtomicOrd”šg
::
SeqC¡
);

315 
	g£lf
.
	gsk_couÁ”
 =ğ
£lf
.
sks_³r_tick
 {

316 
£lf
.
sk_couÁ”
 = 0;

317 
	g£lf
.
	gùx
.
Ú_tick
();

323 #[
cfg
(
‹¡
)]

324 
mod
 
	g‹¡
 {

325 
u£
 
	gsu³r
::*;

327 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

328 
u£
 
	g¡d
::
sync
::
mpsc
::{
chªÃl
, 
	gS’d”
};

329 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gMu‹x
};

330 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicIsize
, 
	gOrd”šg
};

332 #[
‹¡
]

333 
â
 
‹¡_g‘_sk_couÁ
() {

334 
Ët
 
	gÇme
 = 
thd_Çme
!("test_get_task_count");

335 
Ët
 
mut
 
	gsk_poŞ
 = 
Th»adPoŞBud”
::
w™h_deçuÉ_çùÜy
(
Çme
).
bud
();

336 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

337 
Ët
 (
áx
, 
äx
èğ
chªÃl
();

338 
Ët
 
	g»ûiv”
 = 
Arc
::
Ãw
(
Mu‹x
::Ãw(
rx
));

339 
Ët
 
	gtimeout
 = 
Du¿tiÚ
::
äom_£cs
(2);

340 
Ët
 
	ggroup_num
 = 4;

341 
Ët
 
mut
 
	gsk_num
 = 0;

342 
gid
 
	gš
 0..
	ggroup_num
 {

343 
Ët
 
	grx”
 = 
»ûiv”
.
şÚe
();

344 
Ët
 
	gáx
 = 
áx
.
şÚe
();

345 
	gsk_poŞ
.
execu‹
(
move
 |
_
: &
mut
 
DeçuÉCÚ‹xt
| {

346 
Ët
 
rx
 = 
rx”
.
lock
().
unw¿p
();

347 
Ët
 
id
 = 
rx
.
»cv_timeout
(
timeout
).
unw¿p
();

348 
as£¹_eq
!(
id
, 
gid
);

349 
áx
.
£nd
(
Œue
).
unw¿p
();

351 
	gsk_num
 += 1;

352 
	gas£¹_eq
!(
	gsk_poŞ
.
g‘_sk_couÁ
(), 
	gsk_num
);

355 
gid
 
	gš
 0..
	ggroup_num
 {

356 
	gtx
.
£nd
(
gid
).
unw¿p
();

357 
	gäx
.
»cv_timeout
(
timeout
).
unw¿p
();

358 
Ët
 
	gËá_num
 = 
sk_poŞ
.
g‘_sk_couÁ
();

360 
	gas£¹
!(

361 
	gËá_num
 =ğ
sk_num
 || 
Ëá_num
 ==ask_num - 1,

362 
	gfÜm©
!("Ëá_num {},sk_num {}", 
	gËá_num
, 
	gsk_num
)

364 
	gsk_num
 -= 1;

366 
	gsk_poŞ
.
¡İ
().
unw¿p
();

369 #[
‹¡
]

370 
â
 
‹¡_sk_cÚ‹xt
() {

371 
	sTe¡CÚ‹xt
 {

372 
	gcouÁ”
: 
Arc
<
AtomicIsize
>,

373 
	gtx
: 
S’d”
<()>,

376 
un§ã
 
im¶
 
S’d
 
	gTe¡CÚ‹xt
 {}

378 
im¶
 
CÚ‹xt
 
	gTe¡CÚ‹xt
 {

379 
â
 
Ú_sk_¡¬‹d
(&
mut
 
£lf
) {

380 
	g£lf
.
	gcouÁ”
.
ãtch_add
(1, 
Ord”šg
::
SeqC¡
);

382 
â
 
Ú_sk_fšished
(&
mut
 
£lf
) {

383 
	g£lf
.
	gcouÁ”
.
ãtch_add
(1, 
Ord”šg
::
SeqC¡
);

384 
	g£lf
.
	gtx
.
£nd
(()).
unw¿p
();

386 
â
 
Ú_tick
(&
mut
 
£lf
) {}

389 
	sTe¡CÚ‹xtFaùÜy
 {

390 
	gcouÁ”
: 
Arc
<
AtomicIsize
>,

391 
	gtx
: 
S’d”
<()>,

394 
im¶
 
	gCÚ‹xtFaùÜy
<
	gTe¡CÚ‹xt
> 
	gTe¡CÚ‹xtFaùÜy
 {

395 
â
 
ü—‹
(&
£lf
è-> 
	gTe¡CÚ‹xt
 {

396 
	gTe¡CÚ‹xt
 {

397 
	gcouÁ”
: 
£lf
.
couÁ”
.
şÚe
(),

398 
	gtx
: 
£lf
.
tx
.
şÚe
(),

403 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

405 
Ët
 
	gf
 = 
Te¡CÚ‹xtFaùÜy
 {

406 
couÁ”
: 
Arc
::
Ãw
(
AtomicIsize
::new(0)),

407 
tx
:x,

409 
Ët
 
	gùx
 = 
f
.
ü—‹
();

410 
Ët
 
	gÇme
 = 
thd_Çme
!("test_tasks_with_contexts");

411 
Ët
 
mut
 
	gsk_poŞ
 = 
Th»adPoŞBud”
::
Ãw
(
Çme
, 
f
).
th»ad_couÁ
(5).
bud
();

413 
_
 
	gš
 0..10 {

414 
	gsk_poŞ
.
execu‹
(
move
 |
_
: &
mut
 
Te¡CÚ‹xt
| {});

416 
_
 
	gš
 0..10 {

417 
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_mlis
(20)).
unw¿p
();

419 
	gsk_poŞ
.
¡İ
().
unw¿p
();

420 
	gas£¹_eq
!(
	gùx
.
	gcouÁ”
.
lßd
(
Ord”šg
::
SeqC¡
), 20);

423 #[
‹¡
]

424 
â
 
‹¡_sk_tick
() {

425 
	sTe¡CÚ‹xt
 {

426 
	gcouÁ”
: 
Arc
<
AtomicIsize
>,

427 
	gtx
: 
S’d”
<()>,

430 
un§ã
 
im¶
 
S’d
 
	gTe¡CÚ‹xt
 {}

432 
im¶
 
CÚ‹xt
 
	gTe¡CÚ‹xt
 {

433 
â
 
Ú_sk_¡¬‹d
(&
mut
 
£lf
) {}

434 
â
 
Ú_sk_fšished
(&
mut
 
£lf
) {}

435 
â
 
Ú_tick
(&
mut
 
£lf
) {

436 
	g£lf
.
	gcouÁ”
.
ãtch_add
(1, 
Ord”šg
::
SeqC¡
);

437 
Ët
 
	g_
 = 
£lf
.
tx
.
£nd
(());

441 
	sTe¡CÚ‹xtFaùÜy
 {

442 
	gcouÁ”
: 
Arc
<
AtomicIsize
>,

443 
	gtx
: 
S’d”
<()>,

446 
im¶
 
	gCÚ‹xtFaùÜy
<
	gTe¡CÚ‹xt
> 
	gTe¡CÚ‹xtFaùÜy
 {

447 
â
 
ü—‹
(&
£lf
è-> 
	gTe¡CÚ‹xt
 {

448 
	gTe¡CÚ‹xt
 {

449 
	gcouÁ”
: 
£lf
.
couÁ”
.
şÚe
(),

450 
	gtx
: 
£lf
.
tx
.
şÚe
(),

455 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

457 
Ët
 
	gf
 = 
Te¡CÚ‹xtFaùÜy
 {

458 
couÁ”
: 
Arc
::
Ãw
(
AtomicIsize
::new(0)),

459 
tx
:x,

461 
Ët
 
	gùx
 = 
f
.
ü—‹
();

462 
Ët
 
	gÇme
 = 
thd_Çme
!("test_tasks_tick");

463 
Ët
 
mut
 
	gsk_poŞ
 = 
Th»adPoŞBud”
::
Ãw
(
Çme
, 
f
)

464 .
th»ad_couÁ
(5)

465 .
sks_³r_tick
(1)

466 .
bud
();

468 
_
 
	gš
 0..10 {

469 
	gsk_poŞ
.
execu‹
(
move
 |
_
: &
mut
 
Te¡CÚ‹xt
| {});

471 
_
 
	gš
 0..10 {

472 
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_mlis
(100)).
unw¿p
();

474 
	gsk_poŞ
.
¡İ
().
unw¿p
();

476 
	gas£¹
!(
	gùx
.
	gcouÁ”
.
lßd
(
Ord”šg
::
SeqC¡
) >= 10);

	@src/util/time.rs

14 
u£
 
	g¡d
::
time
::{
Du¿tiÚ
, 
	gSy¡emTime
};

15 
u£
 
	g¡d
::
th»ad
::{
£lf
, 
	gBud”
, 
	gJošHªdË
};

16 
u£
 
	g¡d
::
sync
::
mpsc
::{
£lf
, 
	gS’d”
};

17 
u£
 
	g¡d
::
İs
::{
Add
, 
	gAddAssign
, 
	gSub
, 
	gSubAssign
};

18 
u£
 
	g¡d
::
cmp
::
Ord”šg
;

20 
u£
 
	gtime
::{
Du¿tiÚ
 
as
 
TimeDu¿tiÚ
, 
	gTime¥ec
};

23 #[
šlše
]

24 
pub
 
â
 
du¿tiÚ_to_ms
(
d
: 
Du¿tiÚ
è-> 
u64
 {

25 
Ët
 
Çnos
 = 
d
.
sub£c_Çnos
(è
as
 
u64
;

27 
	gd
.
as_£cs
(è* 1
	g_000
 + (
	gÇnos
 / 1
	g_000_000
)

31 #[
šlše
]

32 
pub
 
â
 
du¿tiÚ_to_£c
(
d
: 
Du¿tiÚ
è-> 
f64
 {

33 
Ët
 
Çnos
 = 
d
.
sub£c_Çnos
(è
as
 
f64
;

35 
	gd
.
as_£cs
(è
as
 
	gf64
 + (
	gÇnos
 / 1
	g_000_000_000
.0)

39 #[
šlše
]

40 
pub
 
â
 
du¿tiÚ_to_Çnos
(
d
: 
Du¿tiÚ
è-> 
u64
 {

41 
Ët
 
Çnos
 = 
d
.
sub£c_Çnos
(è
as
 
u64
;

43 
	gd
.
as_£cs
(è* 1
	g_000_000_000
 + 
	gÇnos


46 
pub
 
	sSlowTim”
 {

47 
	m¦ow_time
: 
Du¿tiÚ
,

48 
	mt
: 
In¡ªt
,

51 
im¶
 
	gSlowTim”
 {

52 
pub
 
â
 
Ãw
(è-> 
	gSlowTim”
 {

53 
	gSlowTim”
::()

56 
pub
 
â
 
äom
(
¦ow_time
: 
Du¿tiÚ
è-> 
SlowTim”
 {

57 
SlowTim”
 {

58 
¦ow_time
: slow_time,

59 
	gt
: 
In¡ªt
::
now_cßr£
(),

63 
pub
 
â
 
äom_£cs
(
£cs
: 
u64
è-> 
SlowTim”
 {

64 
SlowTim”
::
äom
(
Du¿tiÚ
::
äom_£cs
(
£cs
))

67 
pub
 
â
 
äom_mlis
(
mlis
: 
u64
è-> 
SlowTim”
 {

68 
SlowTim”
::
äom
(
Du¿tiÚ
::
äom_mlis
(
mlis
))

71 
pub
 
â
 
–­£d
(&
£lf
è-> 
Du¿tiÚ
 {

72 
£lf
.
t
.
–­£d
()

75 
pub
 
â
 
is_¦ow
(&
£lf
è-> 
boŞ
 {

76 
£lf
.
–­£d
(è>ğ£lf.
¦ow_time


80 cÚ¡ 
DEFAULT_SLOW_SECS
: 
u64
 = 1;

82 
im¶
 
DeçuÉ
 
	gSlowTim”
 {

83 
â
 (è-> 
	gSlowTim”
 {

84 
	gSlowTim”
::
äom_£cs
(
DEFAULT_SLOW_SECS
)

88 cÚ¡ 
DEFAULT_WAIT_MS
: 
u64
 = 100;

90 
pub
 
	sMÚ™Ü
 {

91 
	mtx
: 
S’d”
<
boŞ
>,

92 
	mhªdË
: 
O±iÚ
<
JošHªdË
<()>>,

95 
im¶
 
	gMÚ™Ü
 {

96 
pub
 
â
 
	gÃw
<
	gD
, 
	gN
>(
	gÚ_jum³d
: 
D
, 
	gnow
: 
N
è-> 
MÚ™Ü


97 
wh”e


98 
D
: 
Fn
(è+ 
S’d
 + 'static,

99 
N
: 
Fn
(è-> 
Sy¡emTime
 + 
S’d
 + 'static,

101 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

102 
Ët
 
	gh
 = 
Bud”
::
Ãw
()

103 .
Çme
(
thd_Çme
!("time-monitor-worker"))

104 .
¥awn
(
move
 || 
Ët
 
E¼
(
_
èğ
rx
.
Œy_»cv
() {

105 
Ët
 
befÜe
 = 
now
();

106 
th»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(
DEFAULT_WAIT_MS
));

108 
Ët
 
aá”
 = 
now
();

109 
Ët
 
E¼
(
e
èğ
aá”
.
du¿tiÚ_sšû
(
befÜe
) {

110 
”rÜ
!(

112 
befÜe
,

113 
aá”
,

114 
e


116 
Ú_jum³d
()

119 .
unw¿p
();

121 
	gMÚ™Ü
 {

122 
	gtx
: 
tx
,

123 
	ghªdË
: 
Some
(
h
),

128 
im¶
 
DeçuÉ
 
	gMÚ™Ü
 {

129 
â
 (è-> 
	gMÚ™Ü
 {

130 
	gMÚ™Ü
::
Ãw
(|| {}, 
Sy¡emTime
::
now
)

134 
im¶
 
Drİ
 
MÚ™Ü
 {

135 
â
 
drİ
(&
mut
 
£lf
) {

136 
Ët
 
h
 = 
£lf
.
hªdË
.
ke
();

137 
	gh
.
is_nÚe
() {

141 
Ët
 
E¼
(
e
èğ
£lf
.
tx
.
£nd
(
Œue
) {

142 
”rÜ
!("£nd qu™ mes§gfÜimmÚ™Ü wÜk” faed {:?}", 
e
);

146 
Ët
 
E¼
(
e
èğ
h
.
unw¿p
().
još
() {

147 
”rÜ
!("jošimmÚ™Ü wÜk” faed {:?}", 
e
);

154 
pub
 
u£
 
	g£lf
::
šÃr
::
mÚÙÚic_¿w_now
;

155 
u£
 
	g£lf
::
šÃr
::
mÚÙÚic_now
;

156 
u£
 
	g£lf
::
šÃr
::
mÚÙÚic_cßr£_now
;

158 cÚ¡ 
	gNANOSECONDS_PER_SECOND
: 
u64
 = 1
_000_000_000
;

159 cÚ¡ 
	gMILLISECOND_PER_SECOND
: 
i64
 = 1
_000
;

160 cÚ¡ 
	gNANOSECONDS_PER_MILLISECOND
: 
i64
 = 1
_000_000
;

162 #[
cfg
(
nÙ
(
rg‘_os
 = "linux"))]

163 
mod
 
	gšÃr
 {

164 
u£
 
	gtime
::{
£lf
, 
	gTime¥ec
};

165 
u£
 
	gsu³r
::
NANOSECONDS_PER_SECOND
;

167 
pub
 
â
 
mÚÙÚic_¿w_now
(è-> 
	gTime¥ec
 {

170 
Ët
 
	gns
 = 
time
::
´eci£_time_ns
();

171 
Ët
 
	gs
 = 
ns
 / 
NANOSECONDS_PER_SECOND
;

172 
Ët
 
	gns
 = 
ns
 % 
NANOSECONDS_PER_SECOND
;

173 
	gTime¥ec
::
Ãw
(
s
 
as
 
i64
, 
ns
‡ 
i32
)

176 
pub
 
â
 
mÚÙÚic_now
(è-> 
	gTime¥ec
 {

178 
mÚÙÚic_¿w_now
()

181 
pub
 
â
 
mÚÙÚic_cßr£_now
(è-> 
	gTime¥ec
 {

183 
mÚÙÚic_¿w_now
()

187 #[
cfg
(
rg‘_os
 = "linux")]

188 
mod
 
	gšÃr
 {

189 
u£
 
	g¡d
::
io
;

190 
u£
 
	gtime
::
Time¥ec
;

191 
u£
 
	glibc
;

193 
pub
 
â
 
mÚÙÚic_¿w_now
(è-> 
	gTime¥ec
 {

194 
g‘_time
(
libc
::
CLOCK_MONOTONIC_RAW
)

197 
pub
 
â
 
mÚÙÚic_now
(è-> 
Time¥ec
 {

198 
g‘_time
(
libc
::
CLOCK_MONOTONIC
)

201 
pub
 
â
 
mÚÙÚic_cßr£_now
(è-> 
Time¥ec
 {

202 
g‘_time
(
libc
::
CLOCK_MONOTONIC_COARSE
)

205 
â
 
g‘_time
(
şock
: 
libc
::
şockid_t
è-> 
Time¥ec
 {

206 
Ët
 
mut
 
t
 = 
libc
::
time¥ec
 {

207 
tv_£c
: 0,

208 
tv_n£c
: 0,

210 
Ët
 
	g”ºo
 = 
un§ã
 { 
libc
::
şock_g‘time
(
şock
, &
mut
 
t
) };

211 
	g”ºo
 != 0 {

212 
·nic
!(

214 
io
::
E¼Ü
::
Ï¡_os_”rÜ
()

217 
	gTime¥ec
::
Ãw
(
t
.
tv_£c
,.
tv_n£c
 
as
 
_
)

224 #[
d”ive
(
Cİy
, 
ClÚe
, 
Debug
)]

225 
pub
 
	eIn¡ªt
 {

226 
MÚÙÚic
(
Time¥ec
),

227 
MÚÙÚicCßr£
(
Time¥ec
),

230 
im¶
 
	gIn¡ªt
 {

231 
pub
 
â
 
now
(è-> 
	gIn¡ªt
 {

232 
	gIn¡ªt
::
MÚÙÚic
(
mÚÙÚic_now
())

235 
pub
 
â
 
now_cßr£
(è-> 
In¡ªt
 {

236 
In¡ªt
::
MÚÙÚicCßr£
(
mÚÙÚic_cßr£_now
())

239 
pub
 
â
 
–­£d
(&
£lf
è-> 
Du¿tiÚ
 {

240 
m©ch
 *
£lf
 {

241 
In¡ªt
::
MÚÙÚic
(
t
) => {

242 
Ët
 
now
 = 
mÚÙÚic_now
();

243 
	gIn¡ªt
::
–­£d_du¿tiÚ
(
now
, 
t
)

245 
	gIn¡ªt
::
MÚÙÚicCßr£
(
t
) => {

246 
Ët
 
now
 = 
mÚÙÚic_cßr£_now
();

247 
	gIn¡ªt
::
–­£d_du¿tiÚ_cßr£
(
now
, 
t
)

252 
pub
 
â
 
du¿tiÚ_sšû
(&
£lf
, 
—¾›r
: 
In¡ªt
è-> 
Du¿tiÚ
 {

253 
m©ch
 (*
£lf
, 
—¾›r
) {

254 (
	gIn¡ªt
::
MÚÙÚic
(
Ï‹r
), In¡ªt::MÚÙÚic(
—¾›r
)) => {

255 
In¡ªt
::
–­£d_du¿tiÚ
(
Ï‹r
, 
—¾›r
)

257 (
In¡ªt
::
MÚÙÚicCßr£
(
Ï‹r
), 
	gIn¡ªt
::MÚÙÚicCßr£(
—¾›r
)) => {

258 
In¡ªt
::
–­£d_du¿tiÚ_cßr£
(
Ï‹r
, 
—¾›r
)

260 
_
 => {

261 
·nic
!("duration between differentypes of Instants");

266 
â
 
–­£d_du¿tiÚ
(
Ï‹r
: 
Time¥ec
, 
—¾›r
: Time¥ecè-> 
Du¿tiÚ
 {

267 
Ï‹r
 >ğ
—¾›r
 {

268 (
Ï‹r
 - 
—¾›r
).
to_¡d
().
unw¿p
()

270 
·nic
!(

272 
—¾›r
.
£c
 
as
 
f64
 +ƒ¬l›r.
n£c
‡ f64 / 
NANOSECONDS_PER_SECOND
‡s f64,

273 
Ï‹r
.
£c
 
as
 
f64
 +†©”.
n£c
‡ f64 / 
NANOSECONDS_PER_SECOND
‡s f64

283 
â
 
–­£d_du¿tiÚ_cßr£
(
Ï‹r
: 
Time¥ec
, 
—¾›r
: Time¥ecè-> 
Du¿tiÚ
 {

284 
Ët
 
Ï‹r_ms
 =

285 
Ï‹r
.
£c
 * 
MILLISECOND_PER_SECOND
 +†©”.
n£c
 
as
 
i64
 / 
NANOSECONDS_PER_MILLISECOND
;

286 
Ët
 
	g—¾›r_ms
 = 
—¾›r
.
£c
 * 
MILLISECOND_PER_SECOND
 +

287 
—¾›r
.
n£c
 
as
 
i64
 / 
NANOSECONDS_PER_MILLISECOND
;

288 
Ët
 
	gdur
 = 
Ï‹r_ms
 - 
—¾›r_ms
;

289 
	gdur
 >= 0 {

290 
Du¿tiÚ
::
äom_mlis
(
dur
 
as
 
u64
)

292 
debug
!(

294 
—¾›r
.
£c
 
as
 
f64
 +ƒ¬l›r.
n£c
‡ f64 / 
NANOSECONDS_PER_SECOND
‡s f64,

295 
Ï‹r
.
£c
 
as
 
f64
 +†©”.
n£c
‡ f64 / 
NANOSECONDS_PER_SECOND
‡s f64

297 
	gDu¿tiÚ
::
äom_mlis
(0)

302 
im¶
 
P¬tŸlEq
 
In¡ªt
 {

303 
â
 
eq
(&
£lf
, 
Ùh”
: &
In¡ªt
è-> 
boŞ
 {

304 
m©ch
 (*
£lf
, *
Ùh”
) {

305 (
	gIn¡ªt
::
MÚÙÚic
(
this
), In¡ªt::MÚÙÚic(
Ùh”
)) |

306 (
In¡ªt
::
MÚÙÚicCßr£
(
this
), 
	gIn¡ªt
::MÚÙÚicCßr£(
Ùh”
)è=>his.
eq
(&other),

307 
	g_
 => 
çl£
,

312 
im¶
 
P¬tŸlOrd
 
	gIn¡ªt
 {

313 
â
 
·¹Ÿl_cmp
(&
£lf
, 
Ùh”
: &
In¡ªt
è-> 
O±iÚ
<
Ord”šg
> {

314 
m©ch
 (*
£lf
, *
Ùh”
) {

315 (
	gIn¡ªt
::
MÚÙÚic
(
this
), In¡ªt::MÚÙÚic(
Ùh”
)) |

316 (
In¡ªt
::
MÚÙÚicCßr£
(
this
), 
	gIn¡ªt
::MÚÙÚicCßr£(
Ùh”
)) => {

317 
this
.
·¹Ÿl_cmp
(&
Ùh”
)

320 
_
 => 
NÚe
,

325 
im¶
 
	gAdd
<
	gDu¿tiÚ
> 
	gIn¡ªt
 {

326 
ty³
 
	gOuut
 = 
In¡ªt
;

328 
â
 
add
(
£lf
, 
Ùh”
: 
Du¿tiÚ
è-> 
In¡ªt
 {

329 
m©ch
 
£lf
 {

330 
In¡ªt
::
MÚÙÚic
(
t
è=> In¡ªt::MÚÙÚicÑ + 
TimeDu¿tiÚ
::
äom_¡d
(
Ùh”
).
unw¿p
()),

331 
	gIn¡ªt
::
MÚÙÚicCßr£
(
t
) => {

332 
In¡ªt
::
MÚÙÚicCßr£
(
t
 + 
TimeDu¿tiÚ
::
äom_¡d
(
Ùh”
).
unw¿p
())

338 
im¶
 
AddAssign
<
Du¿tiÚ
> 
In¡ªt
 {

339 
â
 
add_assign
(&
mut
 
£lf
, 
rhs
: 
Du¿tiÚ
) {

340 *
£lf
 = s–f.
add
(
rhs
)

344 
im¶
 
Sub
<
Du¿tiÚ
> 
In¡ªt
 {

345 
ty³
 
Ouut
 = 
In¡ªt
;

347 
â
 
sub
(
£lf
, 
Ùh”
: 
Du¿tiÚ
è-> 
In¡ªt
 {

348 
m©ch
 
£lf
 {

349 
In¡ªt
::
MÚÙÚic
(
t
è=> In¡ªt::MÚÙÚicÑ - 
TimeDu¿tiÚ
::
äom_¡d
(
Ùh”
).
unw¿p
()),

350 
	gIn¡ªt
::
MÚÙÚicCßr£
(
t
) => {

351 
In¡ªt
::
MÚÙÚicCßr£
(
t
 - 
TimeDu¿tiÚ
::
äom_¡d
(
Ùh”
).
unw¿p
())

357 
im¶
 
SubAssign
<
Du¿tiÚ
> 
In¡ªt
 {

358 
â
 
sub_assign
(&
mut
 
£lf
, 
rhs
: 
Du¿tiÚ
) {

359 *
£lf
 = s–f.
sub
(
rhs
)

363 
im¶
 
Sub
<
In¡ªt
> Instant {

364 
ty³
 
Ouut
 = 
Du¿tiÚ
;

366 
â
 
sub
(
£lf
, 
Ùh”
: 
In¡ªt
è-> 
Du¿tiÚ
 {

367 
£lf
.
du¿tiÚ_sšû
(
Ùh”
)

371 #[
cfg
(
‹¡
)]

372 
mod
 
‹¡s
 {

373 
u£
 
¡d
::
time
::{
Du¿tiÚ
, 
	gSy¡emTime
};

374 
u£
 
	g¡d
::
th»ad
;

375 
u£
 
	g¡d
::
İs
::
Sub
;

376 
u£
 
	g¡d
::
f64
;

377 
u£
 
	gsu³r
::*;

379 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicBoŞ
, 
	gOrd”šg
};

380 
u£
 
	g¡d
::
sync
::
Arc
;

382 #[
‹¡
]

383 
â
 
‹¡_time_mÚ™Ü
() {

384 
Ët
 
	gjum³d
 = 
Arc
::
Ãw
(
AtomicBoŞ
::Ãw(
çl£
));

385 
Ët
 
	gŒigg”ed
 = 
AtomicBoŞ
::
Ãw
(
çl£
);

386 
Ët
 
	gnow
 = 
move
 || !
Œigg”ed
.
lßd
(
Ord”šg
::
SeqC¡
) {

387 
Œigg”ed
.
¡Üe
(
Œue
, 
Ord”šg
::
SeqC¡
);

388 
	gSy¡emTime
::
now
()

390 
Sy¡emTime
::
now
().
sub
(
Du¿tiÚ
::
äom_£cs
(2))

393 
Ët
 
	gjum³d2
 = 
jum³d
.
şÚe
();

394 
Ët
 
	gÚ_jum³d
 = 
move
 || { 
jum³d2
.
¡Üe
(
Œue
, 
Ord”šg
::
SeqC¡
); };

396 
Ët
 
	g_m
 = 
MÚ™Ü
::
Ãw
(
Ú_jum³d
, 
now
);

397 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_£cs
(1));

399 
	gas£¹_eq
!(
	gjum³d
.
lßd
(
Ord”šg
::
SeqC¡
), 
	gŒue
);

402 #[
‹¡
]

403 
â
 
‹¡_du¿tiÚ_to
() {

404 
Ët
 
	gtbl
 = 
vec
![0, 100, 1
_000
, 5_000, 9999, 1
_000_000
, 1
_000_000_000
];

405 
ms
 
š
 
	gtbl
 {

406 
Ët
 
	gd
 = 
Du¿tiÚ
::
äom_mlis
(
ms
);

407 
	gas£¹_eq
!(
	gms
, 
du¿tiÚ_to_ms
(
d
));

408 
Ët
 
	gexp_£c
 = 
ms
 
as
 
f64
 / 1000.0;

409 
Ët
 
	gaù_£c
 = 
du¿tiÚ_to_£c
(
d
);

410 
	gas£¹
!((
	gaù_£c
 - 
	gexp_£c
).
abs
(è< 
	gf64
::
EPSILON
);

411 
	gas£¹_eq
!(
	gms
 * 1
	g_000_000
, 
du¿tiÚ_to_Çnos
(
d
));

415 #[
‹¡
]

416 
â
 
‹¡_now
() {

417 
Ët
 
	g·œs
 = 
vec
![

418 (
mÚÙÚic_¿w_now
(), monotonic_raw_now()),

419 (
mÚÙÚic_now
(), monotonic_now()),

420 (
mÚÙÚic_cßr£_now
(), monotonic_coarse_now()),

422 
	g—¾y_time
, 
	gÏ‹_time
è
š
 
	g·œs
 {

424 
	gas£¹
!(

425 
	gÏ‹_time
 >ğ
—¾y_time
,

427 
	gÏ‹_time
,

428 
	g—¾y_time


433 #[
‹¡
]

434 #[
®low
(
eq_İ
)]

435 
â
 
‹¡_š¡ªt
() {

436 
	gIn¡ªt
::
now
().
–­£d
();

437 
	gIn¡ªt
::
now_cßr£
().
–­£d
();

440 
Ët
 
	g—¾y_¿w
 = 
In¡ªt
::
now
();

441 
Ët
 
	gÏ‹_¿w
 = 
In¡ªt
::
now
();

442 
	gas£¹
!(
	g—¾y_¿w
 <ğ
Ï‹_¿w
);

443 
	gas£¹
!(
	gÏ‹_¿w
 >ğ
—¾y_¿w
);

445 
	gas£¹_eq
!(
	g—¾y_¿w
,ƒarly_raw);

446 
	gas£¹
!(
	g—¾y_¿w
 >ğ
—¾y_¿w
);

447 
	gas£¹
!(
	g—¾y_¿w
 <ğ
—¾y_¿w
);

449 
Ët
 
	g—¾y_cßr£
 = 
In¡ªt
::
now_cßr£
();

450 
Ët
 
	gÏ‹_cßr£
 = 
In¡ªt
::
now_cßr£
();

451 
	gas£¹
!(
	gÏ‹_cßr£
 >ğ
—¾y_cßr£
);

452 
	gas£¹
!(
	g—¾y_cßr£
 <ğ
Ï‹_cßr£
);

454 
	gas£¹_eq
!(
	g—¾y_cßr£
,ƒarly_coarse);

455 
	gas£¹
!(
	g—¾y_cßr£
 >ğ
—¾y_cßr£
);

456 
	gas£¹
!(
	g—¾y_cßr£
 <ğ
—¾y_cßr£
);

458 
Ët
 
	gz”o
 = 
Du¿tiÚ
::
Ãw
(0, 0);

460 
	gas£¹
!(
	gÏ‹_¿w
 - 
	g—¾y_¿w
 >ğ
z”o
);

461 
	gas£¹
!(
	gÏ‹_cßr£
 - 
	g—¾y_cßr£
 >ğ
z”o
);

464 
	gas£¹_eq
!(
	gÏ‹_¿w
 - 
	gz”o
,†ate_raw);

465 
	gas£¹_eq
!(
	gÏ‹_cßr£
 - 
	gz”o
,†ate_coarse);

468 
Ët
 
mut
 
	gtmp_Ï‹_row
 = 
Ï‹_¿w
;

469 
	gtmp_Ï‹_row
 -ğ
z”o
;

470 
	gas£¹_eq
!(
	gtmp_Ï‹_row
, 
	gÏ‹_¿w
);

472 
Ët
 
mut
 
	gtmp_Ï‹_cßr£
 = 
Ï‹_cßr£
;

473 
	gtmp_Ï‹_cßr£
 -ğ
z”o
;

474 
	gas£¹_eq
!(
	gtmp_Ï‹_cßr£
, 
	gÏ‹_cßr£
);

477 
	gas£¹_eq
!(
	gÏ‹_¿w
 + 
	gz”o
,†ate_raw);

478 
	gas£¹_eq
!(
	gÏ‹_cßr£
 + 
	gz”o
,†ate_coarse);

481 
Ët
 
mut
 
	gtmp_Ï‹_row
 = 
Ï‹_¿w
;

482 
	gtmp_Ï‹_row
 +ğ
z”o
;

483 
	gas£¹_eq
!(
	gtmp_Ï‹_row
, 
	gÏ‹_¿w
);

485 
Ët
 
mut
 
	gtmp_cßr£
 = 
Ï‹_cßr£
;

486 
	gtmp_cßr£
 +ğ
z”o
;

487 
	gas£¹_eq
!(
	gtmp_cßr£
, 
	gÏ‹_cßr£
);

490 
Ët
 
	gts
 = 
Time¥ec
::
Ãw
(1, 1);

491 
Ët
 
	gnow1
 = 
In¡ªt
::
MÚÙÚic
(
ts
);

492 
Ët
 
	gnow2
 = 
In¡ªt
::
MÚÙÚicCßr£
(
ts
);

493 
	gas£¹_Ã
!(
	gnow1
, 
	gnow2
);

494 
	gas£¹_eq
!(
	gnow1
.
·¹Ÿl_cmp
(&
now2
), 
	gNÚe
);

497 #[
‹¡
]

498 
â
 
‹¡_cßr£_š¡ªt_Ú_smp
() {

499 
Ët
 
	gz”o
 = 
Du¿tiÚ
::
äom_mlis
(0);

500 
i
 
	gš
 0..1
	g_000_000
 {

501 
Ët
 
	gnow
 = 
In¡ªt
::
now
();

502 
Ët
 
	gnow_cßr£
 = 
In¡ªt
::
now_cßr£
();

503 
	gi
 % 100 == 0 {

504 
th»ad
::
y›ld_now
();

506 
	gas£¹
!(
	gnow
.
–­£d
(è>ğ
z”o
);

507 
	gas£¹
!(
	gnow_cßr£
.
–­£d
(è>ğ
z”o
);

	@src/util/transport.rs

15 
u£
 
	g¡d
::{
”rÜ
, 
	gio
, 
	gth»ad
};

16 
u£
 
	g¡d
::
fmt
::
Debug
;

17 
u£
 
	g¡d
::
m¬k”
::
PhªtomD©a
;

18 
u£
 
	g¡d
::
sync
::
mpsc
;

19 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

20 
u£
 
	gsu³r
::
m‘rics
::*;

22 
u£
 
	gmio
;

24 cÚ¡ 
	gMAX_SEND_RETRY_CNT
: 
usize
 = 5;

26 
	gquick_”rÜ
! {

27 #[
d”ive
(
Debug
)]

28 
pub
 
	eE¼Ü
 {

29 
Disÿrd
(
»asÚ
: 
SŒšg
) {

30 
desütiÚ
("message is discarded")

31 
di¥Ïy
("{}", 
»asÚ
)

33 
	gClo£d
 {

34 
desütiÚ
("channel is closed")

35 
di¥Ïy
("channel is closed")

37 
Oth”
(
”r
: 
Box
<
”rÜ
::
E¼Ü
 + 
S’d
 + 
Sync
>) {

38 
äom
()

39 
ÿu£
(
”r
.
as_»f
())

40 
desütiÚ
(
”r
.description())

41 
di¥Ïy
("unknowÀ”rÜ {:?}", 
”r
)

46 
	gim¶
<
	gT
: 
Debug
> 
From
<
NÙifyE¼Ü
<
T
>> 
E¼Ü
 {

47 
â
 
äom
(
e
: 
NÙifyE¼Ü
<
T
>è-> 
E¼Ü
 {

48 
m©ch
 
e
 {

50 
NÙifyE¼Ü
::
FuÎ
(
m
è=> 
E¼Ü
::
Disÿrd
(
fÜm©
!("Failedo send {:?} dueo full", m)),

51 
	gNÙifyE¼Ü
::
Clo£d
(..è=> 
E¼Ü
::Closed,

52 
	g_
 => 
box_”r
!("{:?}", 
	ge
),

57 #[
d”ive
(
Debug
)]

58 
pub
 
	gNÙifyE¼Ü
<
	gT
> {

59 
FuÎ
(
T
),

60 
Clo£d
(
O±iÚ
<
T
>),

61 
Io
(
io
::
E¼Ü
),

64 
pub
 
Œa™
 
	gS’d”
<
	gT
>: 
ClÚe
 {

65 
â
 
£nd
(&
£lf
, 
t
: 
T
è-> 
ResuÉ
<(), 
	gNÙifyE¼Ü
<
	gT
>>;

68 
	gim¶
<
	gT
: 
S’d
> 
S’d”
<
T
> 
mio
::Sender<T> {

69 
â
 
£nd
(&
£lf
, 
t
: 
T
è-> 
ResuÉ
<(), 
	gNÙifyE¼Ü
<
	gT
>> {

70 
m©ch
 
	gmio
::
S’d”
::
£nd
(
£lf
, 
t
) {

71 
Ok
(()) => Ok(()),

72 
E¼
(
mio
::
NÙifyE¼Ü
::
Clo£d
(
t
)) => Err(NotifyError::Closed(t)),

73 
E¼
(
mio
::
NÙifyE¼Ü
::
FuÎ
(
t
)) => Err(NotifyError::Full(t)),

74 
E¼
(
mio
::
NÙifyE¼Ü
::
Io
(
e
)) => Err(NotifyError::Io(e)),

79 
	gim¶
<
	gT
> 
	gS’d”
<T> 
	gmpsc
::
SyncS’d”
<
T
> {

80 
â
 
£nd
(&
£lf
, 
t
: 
T
è-> 
ResuÉ
<(), 
	gNÙifyE¼Ü
<
	gT
>> {

81 
m©ch
 
	gmpsc
::
SyncS’d”
::
Œy_£nd
(
£lf
, 
t
) {

82 
Ok
(()) => Ok(()),

83 
E¼
(
mpsc
::
TryS’dE¼Ü
::
DiscÚÃùed
(
t
)è=> E¼(
NÙifyE¼Ü
::
Clo£d
(
Some
(t))),

84 
E¼
(
mpsc
::
TryS’dE¼Ü
::
FuÎ
(
t
)è=> E¼(
NÙifyE¼Ü
::Full(t)),

90 
pub
 
	gR‘ryabËS’dCh
<
	gT
, 
	gC
> {

91 
	gch
: 
C
,

92 
	gÇme
: &'static str,

94 
m¬k”
: 
PhªtomD©a
<
T
>,

99 
un§ã
 
	gim¶
<
	gT
, 
	gC
: 
S’d”
<
T
> + 
S’d
> S’d 
R‘ryabËS’dCh
<T, C> {}

100 
un§ã
 
	gim¶
<
	gT
, 
	gC
: 
S’d”
<
T
> + 
Sync
> Synø
R‘ryabËS’dCh
<T, C> {}

102 
	gim¶
<
	gT
: 
Debug
, 
	gC
: 
S’d”
<
T
>> 
R‘ryabËS’dCh
<T, C> {

103 
pub
 
â
 
Ãw
(
ch
: 
C
, 
Çme
: &'static str) -> RetryableSendCh<T, C> {

104 
R‘ryabËS’dCh
 {

105 
ch
: ch,

106 
Çme
:‚ame,

107 
m¬k”
: 
DeçuÉ
::(),

112 
pub
 
â
 
£nd
(&
£lf
, 
t
: 
T
è-> 
ResuÉ
<(), 
E¼Ü
> {

113 
£lf
.
£nd_w™h_Œy_times
(
t
, 
MAX_SEND_RETRY_CNT
)

116 
pub
 
â
 
Œy_£nd
(&
£lf
, 
t
: 
T
è-> 
ResuÉ
<(), 
E¼Ü
> {

117 
£lf
.
£nd_w™h_Œy_times
(
t
, 1)

120 
â
 
£nd_w™h_Œy_times
(&
£lf
, 
mut
 
t
: 
T
, muˆ
Œy_times
: 
usize
è-> 
ResuÉ
<(), 
E¼Ü
> {

121 
loİ
 {

122 
t
 = 
m©ch
 
£lf
.
ch
.
£nd
(t) {

123 
Ok
(
_
) =>  Ok(()),

124 
E¼
(
NÙifyE¼Ü
::
FuÎ
(
m
)) => {

125 
Œy_times
 <= 1 {

126 
CHANNEL_FULL_COUNTER_VEC


127 .
w™h_Ïb–_v®ues
(&[
£lf
.
Çme
])

128 .
šc
();

129  
E¼
(
NÙifyE¼Ü
::
FuÎ
(
m
).
što
());

131 
Œy_times
 -= 1;

132 
m


134 
E¼
(
e
è=>  E¼Ó.
što
()),

138 
w¬n
!("nÙify queui fuÎ, sË•‡nd„‘ry s’dšg {:?}", 
t
);

139 
th»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(100));

144 
im¶
<
T
, 
C
: 
S’d”
<T>> 
ClÚe
 
R‘ryabËS’dCh
<T, C> {

145 
â
 
şÚe
(&
£lf
è-> 
R‘ryabËS’dCh
<
T
, 
C
> {

146 
R‘ryabËS’dCh
 {

147 
ch
: 
£lf
.ch.
şÚe
(),

148 
Çme
: 
£lf
.name,

149 
m¬k”
: 
DeçuÉ
::(),

154 
pub
 
ty³
 
S’dCh
<
T
> = 
R‘ryabËS’dCh
<T, 
mio
::
S’d”
<T>>;

155 
pub
 
ty³
 
SyncS’dCh
<
T
> = 
R‘ryabËS’dCh
<T, 
mpsc
::
SyncS’d”
<T>>;

157 #[
cfg
(
‹¡
)]

158 
mod
 
‹¡s
 {

159 
u£
 
¡d
::
th»ad
;

160 
u£
 
¡d
::
sync
::
mpsc
::
Reûiv”
;

161 
u£
 
¡d
::
time
::
Du¿tiÚ
;

163 
u£
 
mio
::{
Ev’tLoİ
, 
Ev’tLoİCÚfig
, 
HªdËr
};

165 
u£
 
su³r
::*;

167 #[
d”ive
(
Debug
)]

168 
	eMsg
 {

169 
Qu™
,

170 
Stİ
,

171 
SË•
(
u64
),

174 
S’d”HªdËr
<
S
: 
S’d”
<
Msg
>> {

175 
ch
: 
R‘ryabËS’dCh
<
Msg
, 
S
>,

178 
im¶
<
S
: 
S’d”
<
Msg
>> 
S’d”HªdËr
<S> {

179 
â
 
run
(&
mut
 
£lf
, 
»cv
: 
Reûiv”
<
Msg
>) {

180 
Ët
 
Ok
(
msg
èğ
»cv
.recv() {

181 !
£lf
.
Ú_msg
(
msg
) {

187 
â
 
Ú_msg
(&
mut
 
£lf
, 
msg
: 
Msg
è-> 
boŞ
 {

188 
m©ch
 
msg
 {

189 
Msg
::
Qu™
 =>  
çl£
,

190 
Msg
::
Stİ
 => 
£lf
.
ch
.
Œy_£nd
(Msg::
Qu™
).
unw¿p
(),

191 
Msg
::
SË•
(
mlis
è=> 
th»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(millis)),

193 
Œue


197 
im¶
<
S
: 
S’d”
<
Msg
>> 
HªdËr
 
S’d”HªdËr
<S> {

198 
ty³
 
Timeout
 = ();

199 
ty³
 
Mes§ge
 = 
Msg
;

201 
â
 
nÙify
(&
mut
 
£lf
, 
ev’t_loİ
: &muˆ
Ev’tLoİ
<
S’d”HªdËr
<
S
>>, 
msg
: 
Msg
) {

202 !
£lf
.
Ú_msg
(
msg
) {

203 
ev’t_loİ
.
shutdown
();

208 #[
‹¡
]

209 
â
 
‹¡_£ndch
() {

210 
Ët
 
mut
 
ev’t_loİ
 = 
Ev’tLoİ
::
Ãw
().
unw¿p
();

211 
Ët
 
ch
 = 
S’dCh
::
Ãw
(
ev’t_loİ
.
chªÃl
(), "test");

212 
Ët
 
_ch
 = 
ch
.
şÚe
();

213 
Ët
 
h
 = 
th»ad
::
¥awn
(
move
 || {

214 
Ët
 
mut
 
£nd”
 = 
S’d”HªdËr
 { 
ch
: 
_ch
 };

215 
ev’t_loİ
.
run
(&
mut
 
£nd”
).
unw¿p
();

218 
ch
.
Œy_£nd
(
Msg
::
Stİ
).
unw¿p
();

220 
h
.
još
().
unw¿p
();

223 #[
‹¡
]

224 
â
 
‹¡_£ndch_fuÎ
() {

225 
Ët
 
mut
 
cÚfig
 = 
Ev’tLoİCÚfig
::
Ãw
();

226 
cÚfig
.
nÙify_ÿ·c™y
(2);

227 
Ët
 
mut
 
ev’t_loİ
 = 
Ev’tLoİ
::
cÚfigu»d
(
cÚfig
).
unw¿p
();

228 
Ët
 
ch
 = 
S’dCh
::
Ãw
(
ev’t_loİ
.
chªÃl
(), "test");

229 
Ët
 
_ch
 = 
ch
.
şÚe
();

230 
Ët
 
h
 = 
th»ad
::
¥awn
(
move
 || {

231 
Ët
 
mut
 
£nd”
 = 
S’d”HªdËr
 { 
ch
: 
_ch
 };

232 
ev’t_loİ
.
run
(&
mut
 
£nd”
).
unw¿p
();

235 
ch
.
£nd
(
Msg
::
SË•
(1000)).
unw¿p
();

236 
ch
.
£nd
(
Msg
::
Stİ
).
unw¿p
();

237 
ch
.
£nd
(
Msg
::
Stİ
).
unw¿p
();

238 
m©ch
 
ch
.
£nd
(
Msg
::
Stİ
) {

239 
E¼
(
E¼Ü
::
Disÿrd
(
_
)) => {}

240 
»s
 => 
·nic
!("expect discardƒrror, but found: {:?}",„es),

243 
h
.
još
().
unw¿p
();

246 #[
‹¡
]

247 
â
 
‹¡_sync_£ndch
() {

248 
Ët
 (
tx
, 
rx
èğ
mpsc
::
sync_chªÃl
(10);

249 
Ët
 
ch
 = 
SyncS’dCh
::
Ãw
(
tx
, "test");

250 
Ët
 
_ch
 = 
ch
.
şÚe
();

251 
Ët
 
h
 = 
th»ad
::
¥awn
(
move
 || {

252 
Ët
 
mut
 
hªdËr
 = 
S’d”HªdËr
 { 
ch
: 
_ch
 };

253 
hªdËr
.
run
(
rx
);

256 
ch
.
Œy_£nd
(
Msg
::
Stİ
).
unw¿p
();

258 
h
.
još
().
unw¿p
();

261 #[
‹¡
]

262 
â
 
‹¡_sync_£ndch_fuÎ
() {

263 
Ët
 (
tx
, 
rx
èğ
mpsc
::
sync_chªÃl
(2);

264 
Ët
 
ch
 = 
SyncS’dCh
::
Ãw
(
tx
, "test");

265 
Ët
 
_ch
 = 
ch
.
şÚe
();

266 
Ët
 
h
 = 
th»ad
::
¥awn
(
move
 || {

267 
Ët
 
mut
 
hªdËr
 = 
S’d”HªdËr
 { 
ch
: 
_ch
 };

268 
hªdËr
.
run
(
rx
);

271 
ch
.
£nd
(
Msg
::
SË•
(1000)).
unw¿p
();

272 
ch
.
£nd
(
Msg
::
Stİ
).
unw¿p
();

273 
ch
.
£nd
(
Msg
::
Stİ
).
unw¿p
();

274 
m©ch
 
ch
.
£nd
(
Msg
::
Stİ
) {

275 
E¼
(
E¼Ü
::
Disÿrd
(
_
)) => {}

276 
»s
 => 
·nic
!("expect discardƒrror, but found: {:?}",„es),

279 
h
.
još
().
unw¿p
();

	@src/util/worker/future.rs

14 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gMu‹x
};

15 
u£
 
	g¡d
::
th»ad
::{
£lf
, 
	gBud”
, 
	gJošHªdË
};

16 
u£
 
	g¡d
::
io
;

17 
u£
 
	g¡d
::
fmt
::
Di¥Ïy
;

19 
u£
 
	gfutu»s
::
SŒ—m
;

20 
u£
 
	gfutu»s
::
sync
::
mpsc
::{
unbounded
, 
	gUnboundedReûiv”
, 
	gUnboundedS’d”
};

21 
u£
 
	gtokio_cÜe
::
»aùÜ
::{
CÜe
, 
	gHªdË
};

23 
u£
 
	gsu³r
::
Stİ³d
;

24 
u£
 
	gsu³r
::
m‘rics
::*;

26 
pub
 
Œa™
 
	gRuÂabË
<
	gT
: 
Di¥Ïy
> {

27 
â
 
run
(&
mut
 
£lf
, 
t
: 
T
, 
hªdË
: &
HªdË
);

28 
â
 
shutdown
(&
mut
 
£lf
) {}

32 
pub
 
	gScheduËr
<
	gT
> {

33 
	gÇme
: 
Arc
<
SŒšg
>,

34 
	g£nd”
: 
UnboundedS’d”
<
O±iÚ
<
T
>>,

37 
	gim¶
<
	gT
: 
Di¥Ïy
> 
ScheduËr
<
T
> {

38 
â
 
Ãw
<
S
: 
IÁo
<
SŒšg
>>(
Çme
: S, 
	g£nd”
: 
UnboundedS’d”
<
O±iÚ
<
T
>>è-> 
ScheduËr
<T> {

39 
ScheduËr
 {

40 
Çme
: 
Arc
::
Ãw
Òame.
što
()),

41 
	g£nd”
: 
£nd”
,

48 
pub
 
â
 
scheduË
(&
£lf
, 
sk
: 
T
è-> 
ResuÉ
<(), 
	gStİ³d
<
	gT
>> {

49 
	gdebug
!("schedulšgask {}", 
	gsk
);

50 
Ët
 
E¼
(
”r
èğ
£lf
.
£nd”
.
unbounded_£nd
(
Some
(
sk
)) {

51  
E¼
(
Stİ³d
(
”r
.
što_šÃr
().
unw¿p
()));

53 
	gWORKER_PENDING_TASK_VEC


54 .
w™h_Ïb–_v®ues
(&[&
£lf
.
Çme
])

55 .
šc
();

56 
Ok
(())

60 
	gim¶
<
	gT
: 
Di¥Ïy
> 
ClÚe
 
ScheduËr
<
T
> {

61 
â
 
şÚe
(&
£lf
è-> 
ScheduËr
<
T
> {

62 
ScheduËr
 {

63 
Çme
: 
£lf
.Çme.
şÚe
(),

64 
	g£nd”
: 
£lf
.
£nd”
.
şÚe
(),

70 
pub
 
	gWÜk”
<
	gT
: 
Di¥Ïy
> {

71 
scheduËr
: 
ScheduËr
<
T
>,

72 
	g»ûiv”
: 
Mu‹x
<
O±iÚ
<
UnboundedReûiv”
<O±iÚ<
T
>>>>,

73 
	ghªdË
: 
O±iÚ
<
JošHªdË
<()>>,

77 
â
 
	gpŞl
<
	gR
, 
	gT
>(
mut
 
	gruÂ”
: 
R
, 
	grx
: 
UnboundedReûiv”
<
O±iÚ
<
T
>>)

78 
wh”e


79 
R
: 
RuÂabË
<
T
> + 
S’d
 + 'static,

80 
T
: 
Di¥Ïy
 + 
S’d
 + 'static,

82 
Ët
 
Çme
 = 
th»ad
::
cu¼’t
().Çme().
unw¿p
().
to_owÃd
();

83 
Ët
 
mut
 
	gcÜe
 = 
CÜe
::
Ãw
().
unw¿p
();

84 
Ët
 
	ghªdË
 = 
cÜe
.
hªdË
();

86 
Ët
 
	gf
 = 
rx
.
ke_whe
(|
t
| 
Ok
Ñ.
is_some
())).
fÜ_—ch
(|t| {

87 
ruÂ”
.
run
(
t
.
unw¿p
(), &
hªdË
);

88 
WORKER_PENDING_TASK_VEC
.
w™h_Ïb–_v®ues
(&[&
Çme
]).
sub
(1.0);

89 
WORKER_HANDLED_TASK_VEC
.
w™h_Ïb–_v®ues
(&[&
Çme
]).
šc
();

90 
Ok
(())

93 
	gcÜe
.
run
(
f
).
unw¿p
();

95 
	gruÂ”
.
shutdown
();

98 
	gim¶
<
	gT
: 
Di¥Ïy
 + 
S’d
 + 'static> Worker<T> {

100 
pub
 
â
 
Ãw
<
S
: 
IÁo
<
SŒšg
>>(
Çme
: Sè-> 
WÜk”
<
T
> {

101 
Ët
 (
tx
, 
rx
èğ
unbounded
();

102 
	gWÜk”
 {

103 
	gscheduËr
: 
ScheduËr
::
Ãw
(
Çme
, 
tx
),

104 
	g»ûiv”
: 
Mu‹x
::
Ãw
(
Some
(
rx
)),

105 
	ghªdË
: 
NÚe
,

110 
pub
 
â
 
	g¡¬t
<
	gR
>(&
mut
 
	g£lf
, 
	gruÂ”
: 
R
è-> 
ResuÉ
<(), 
	gio
::
E¼Ü
>

111 
wh”e


112 
R
: 
RuÂabË
<
T
> + 
S’d
 + 'static,

114 
Ët
 
mut
 
»ûiv”
 = 
£lf
.»ûiv”.
lock
().
unw¿p
();

115 
	gšfo
!("¡¬tšg wÜkšgh»ad: {}", 
	g£lf
.
	gscheduËr
.
	gÇme
);

116 
	g»ûiv”
.
is_nÚe
() {

117 
	gw¬n
!("wÜk” {} ha b“À¡¬‹d.", 
	g£lf
.
	gscheduËr
.
	gÇme
);

118  
Ok
(());

121 
Ët
 
	grx
 = 
»ûiv”
.
ke
().
unw¿p
();

122 
Ët
 
	gh
 = 
Bud”
::
Ãw
()

123 .
Çme
(
thd_Çme
!(
£lf
.
scheduËr
.Çme.
as_»f
()))

124 .
¥awn
(
move
 || 
pŞl
(
ruÂ”
, 
rx
))?;

126 
	g£lf
.
	ghªdË
 = 
Some
(
h
);

127 
Ok
(())

131 
pub
 
â
 
scheduËr
(&
£lf
è-> 
	gScheduËr
<
	gT
> {

132 
	g£lf
.
	gscheduËr
.
şÚe
()

138 
pub
 
â
 
scheduË
(&
£lf
, 
sk
: 
T
è-> 
ResuÉ
<(), 
	gStİ³d
<
	gT
>> {

139 
	g£lf
.
	gscheduËr
.
scheduË
(
sk
)

143 
pub
 
â
 
is_busy
(&
£lf
è-> 
	gboŞ
 {

144 
	g£lf
.
	ghªdË
.
is_nÚe
()

147 
pub
 
â
 
Çme
(&
£lf
è-> &
	g¡r
 {

148 
	g£lf
.
	gscheduËr
.
	gÇme
.
as_¡r
()

152 
pub
 
â
 
¡İ
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gth»ad
::
JošHªdË
<()>> {

154 
šfo
!("¡İšg {}", 
	g£lf
.
	gscheduËr
.
	gÇme
);

155 
	g£lf
.
	ghªdË
.
is_nÚe
() {

156  
	gNÚe
;

158 
Ët
 
E¼
(
e
èğ
£lf
.
scheduËr
.
£nd”
.
unbounded_£nd
(
NÚe
) {

159 
w¬n
!("çedØ¡İ wÜk”h»ad: {:?}", 
e
);

161 
	g£lf
.
	ghªdË
.
ke
()

165 #[
cfg
(
‹¡
)]

166 
mod
 
	g‹¡
 {

167 
u£
 
	g¡d
::
sync
::
mpsc
;

168 
u£
 
	g¡d
::
sync
::
mpsc
::*;

169 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

170 
u£
 
	g¡d
::
time
::
In¡ªt
;

172 
u£
 
	gfutu»s
::
Futu»
;

173 
u£
 
	gtokio_tim”
::
Tim”
;

174 
u£
 
	gtokio_cÜe
::
»aùÜ
::
HªdË
;

176 
u£
 
	gsu³r
::*;

178 
	sS‹pRuÂ”
 {

179 
	gtim”
: 
Tim”
,

180 
	gch
: 
S’d”
<
u64
>,

183 
im¶
 
	gRuÂabË
<
	gu64
> 
	gS‹pRuÂ”
 {

184 
â
 
run
(&
mut
 
£lf
, 
¡•
: 
u64
, 
hªdË
: &
HªdË
) {

185 
£lf
.
ch
.
£nd
(
¡•
).
unw¿p
();

186 
Ët
 
	gf
 = 
£lf
.
tim”


187 .
¦“p
(
Du¿tiÚ
::
äom_mlis
(
¡•
))

188 .
m­_”r
(|
_
| ());

189 
	ghªdË
.
¥awn
(
f
);

192 
â
 
shutdown
(&
mut
 
£lf
) {

193 
	g£lf
.
	gch
.
£nd
(0).
unw¿p
();

197 #[
‹¡
]

198 
â
 
‹¡_futu»_wÜk”
() {

199 
Ët
 
mut
 
	gwÜk”
 = 
WÜk”
::
Ãw
("test-async-worker");

200 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

201 
	gwÜk”


202 .
¡¬t
(
S‹pRuÂ”
 {

203 
tim”
: 
Tim”
::(),

204 
ch
: 
tx
,

206 .
unw¿p
();

207 
	gas£¹
!(!
	gwÜk”
.
is_busy
());

209 
Ët
 
	g¡¬t
 = 
In¡ªt
::
now
();

210 
	gwÜk”
.
scheduË
(500).
unw¿p
();

211 
	gwÜk”
.
scheduË
(1000).
unw¿p
();

212 
	gwÜk”
.
scheduË
(1500).
unw¿p
();

213 
	gas£¹_eq
!(
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
(), 500);

214 
	gas£¹_eq
!(
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
(), 1000);

215 
	gas£¹_eq
!(
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
(), 1500);

217 
	gas£¹
!(
	g¡¬t
.
–­£d
(è< 
	gDu¿tiÚ
::
äom_£cs
(2));

218 
	gwÜk”
.
¡İ
().
unw¿p
().
još
().unwrap();

220 
	gas£¹
!(
	gwÜk”
.
is_busy
());

222 
	gas£¹_eq
!(0, 
	grx
.
»cv
().
unw¿p
());

	@src/util/worker/metrics.rs

14 
u£
 
	g´om‘heus
::*;

16 
	gÏzy_¡©ic
! {

17 
pub
 
»f
 
	gWORKER_PENDING_TASK_VEC
: 
GaugeVec
 =

18 
»gi¡”_gauge_vec
!(

22 ).
unw¿p
();

24 
pub
 
»f
 
	gWORKER_HANDLED_TASK_VEC
: 
CouÁ”Vec
 =

25 
»gi¡”_couÁ”_vec
!(

29 ).
unw¿p
();

	@src/util/worker/mod.rs

17 
mod
 
	gm‘rics
;

18 
mod
 
	gfutu»
;

20 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gMu‹x
};

21 
u£
 
	g¡d
::
th»ad
::{
£lf
, 
	gBud”
, 
	gJošHªdË
};

22 
u£
 
	g¡d
::
io
;

23 
u£
 
	g¡d
::
fmt
::{
£lf
, 
	gDebug
, 
	gDi¥Ïy
, 
	gFÜm©‹r
};

24 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

25 
u£
 
	g¡d
::
sync
::
mpsc
::{
£lf
, 
	gReûiv”
, 
	gS’dE¼Ü
, 
	gS’d”
};

26 
u£
 
	g¡d
::
”rÜ
::
E¼Ü
;

28 
u£
 
	gut
::
time
::
SlowTim”
;

29 
u£
 
	g£lf
::
m‘rics
::*;

31 
pub
 
u£
 
	g£lf
::
futu»
::
RuÂabË
 
as
 
Futu»RuÂabË
;

32 
pub
 
u£
 
	g£lf
::
futu»
::
ScheduËr
 
as
 
Futu»ScheduËr
;

33 
pub
 
u£
 
	g£lf
::
futu»
::
WÜk”
 
as
 
Futu»WÜk”
;

35 
pub
 
	gStİ³d
<
	gT
>(pub T);

37 
	gim¶
<
	gT
> 
Di¥Ïy
 
	gStİ³d
<T> {

38 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

39 
wr™e
!(
f
, "channel has been closed")

43 
	gim¶
<
	gT
> 
Debug
 
	gStİ³d
<T> {

44 
â
 
fmt
(&
£lf
, 
f
: &
mut
 
FÜm©‹r
è-> fmt::
ResuÉ
 {

45 
wr™e
!(
f
, "channel has been closed")

49 
	gim¶
<
	gT
> 
	gFrom
<
	gStİ³d
<T>> 
	gBox
<
	gE¼Ü
 + 
	gSync
 + 
	gS’d
 + 'static> {

50 
â
 
äom
(
_
: 
Stİ³d
<
T
>è-> 
Box
<
E¼Ü
 + 
Sync
 + 
S’d
 + 'static> {

51 
box_”r
!("channel has been closed")

55 
pub
 
Œa™
 
RuÂabË
<
T
: 
Di¥Ïy
> {

56 
â
 
run
(&
mut
 
£lf
, 
t
: 
T
);

57 
â
 
shutdown
(&
mut
 
£lf
) {}

60 
pub
 
Œa™
 
	gB©chRuÂabË
<
	gT
: 
Di¥Ïy
> {

64 
â
 
run_b©ch
(&
mut
 
£lf
, 
ts
: &muˆ
Vec
<
T
>);

65 
â
 
shutdown
(&
mut
 
£lf
) {}

68 
	gim¶
<
	gT
: 
Di¥Ïy
, 
	gR
: 
RuÂabË
<
T
>> 
B©chRuÂabË
<T> 
R
 {

69 
â
 
run_b©ch
(&
mut
 
£lf
, 
ts
: &muˆ
Vec
<
T
>) {

70 
t
 
š
 
ts
.
d¿š
(..) {

71 
Ët
 
sk_¡r
 = 
fÜm©
!("{}", 
	gt
);

72 
Ët
 
	gtim”
 = 
SlowTim”
::
Ãw
();

73 
	g£lf
.
run
(
t
);

74 
	g¦ow_log
!(
	gtim”
, "hªdËask {}", 
	gsk_¡r
);

78 
â
 
shutdown
(&
mut
 
£lf
) {

79 
	gRuÂabË
::
shutdown
(
£lf
)

84 
pub
 
ScheduËr
<
T
> {

85 
Çme
: 
Arc
<
SŒšg
>,

86 
	gcouÁ”
: 
Arc
<
AtomicUsize
>,

87 
	g£nd”
: 
S’d”
<
O±iÚ
<
T
>>,

90 
	gim¶
<
	gT
: 
Di¥Ïy
> 
ScheduËr
<
T
> {

91 
â
 
Ãw
<
S
: 
IÁo
<
SŒšg
>>(

92 
Çme
: 
S
,

93 
	gcouÁ”
: 
AtomicUsize
,

94 
	g£nd”
: 
S’d”
<
O±iÚ
<
T
>>,

95 è-> 
	gScheduËr
<
	gT
> {

96 
	gScheduËr
 {

97 
	gÇme
: 
Arc
::
Ãw
(
Çme
.
što
()),

98 
	gcouÁ”
: 
Arc
::
Ãw
(
couÁ”
),

99 
	g£nd”
: 
£nd”
,

106 
pub
 
â
 
scheduË
(&
£lf
, 
sk
: 
T
è-> 
ResuÉ
<(), 
	gStİ³d
<
	gT
>> {

107 
	gdebug
!("schedulšgask {}", 
	gsk
);

108 
Ët
 
E¼
(
S’dE¼Ü
(
Some
(
t
))èğ
£lf
.
£nd”
.
£nd
(Some(
sk
)) {

109  
E¼
(
Stİ³d
(
t
));

111 
	g£lf
.
	gcouÁ”
.
ãtch_add
(1, 
Ord”šg
::
SeqC¡
);

112 
	gWORKER_PENDING_TASK_VEC


113 .
w™h_Ïb–_v®ues
(&[&
£lf
.
Çme
])

114 .
šc
();

115 
Ok
(())

119 
pub
 
â
 
is_busy
(&
£lf
è-> 
	gboŞ
 {

120 
	g£lf
.
	gcouÁ”
.
lßd
(
Ord”šg
::
SeqC¡
) > 0

124 
im¶
<
T
: 
Di¥Ïy
> 
ClÚe
 
ScheduËr
<T> {

125 
â
 
şÚe
(&
£lf
è-> 
ScheduËr
<
T
> {

126 
ScheduËr
 {

127 
Çme
: 
£lf
.Çme.
şÚe
(),

128 
	gcouÁ”
: 
£lf
.
couÁ”
.
şÚe
(),

129 
	g£nd”
: 
£lf
.
£nd”
.
şÚe
(),

137 #[
cfg
(
‹¡
)]

138 
pub
 
â
 
	gdummy_scheduËr
<
	gT
: 
Di¥Ïy
>(è-> 
ScheduËr
<
T
> {

139 
Ët
 (
tx
, 
_
èğ
mpsc
::
chªÃl
();

140 
	gScheduËr
::
Ãw
("dummy scheduËr", 
AtomicUsize
::Ãw(0), 
tx
)

144 
pub
 
	gWÜk”
<
	gT
: 
Di¥Ïy
> {

145 
scheduËr
: 
ScheduËr
<
T
>,

146 
	g»ûiv”
: 
Mu‹x
<
O±iÚ
<
Reûiv”
<O±iÚ<
T
>>>>,

147 
	ghªdË
: 
O±iÚ
<
JošHªdË
<()>>,

150 
â
 
	gpŞl
<
	gR
, 
	gT
>(
mut
 
	gruÂ”
: 
R
, 
	grx
: 
Reûiv”
<
O±iÚ
<
T
>>, 
	gcouÁ”
: 
Arc
<
AtomicUsize
>, 
	gb©ch_size
: 
usize
)

151 
wh”e


152 
R
: 
B©chRuÂabË
<
T
> + 
S’d
 + 'static,

153 
T
: 
Di¥Ïy
 + 
S’d
 + 'static,

155 
Ët
 
Çme
 = 
th»ad
::
cu¼’t
().Çme().
unw¿p
().
to_owÃd
();

156 
Ët
 
mut
 
	gk“p_gošg
 = 
Œue
;

157 
Ët
 
mut
 
	gbufãr
 = 
Vec
::
w™h_ÿ·c™y
(
b©ch_size
);

158 
	gk“p_gošg
 {

159 
Ët
 
	gt
 = 
rx
.
»cv
();

160 
m©ch
 
	gt
 {

161 
Ok
(
Some
(
t
)è=> 
bufãr
.
push
(t),

162 
	g_
 => ,

164 
	gbufãr
.
Ën
(è< 
	gb©ch_size
 {

165 
m©ch
 
	grx
.
Œy_»cv
() {

166 
Ok
(
NÚe
) => {

167 
k“p_gošg
 = 
çl£
;

170 
Ok
(
Some
(
t
)è=> 
bufãr
.
push
(t),

171 
	g_
 => ,

174 
	gcouÁ”
.
ãtch_sub
(
bufãr
.
Ën
(), 
Ord”šg
::
SeqC¡
);

175 
	gWORKER_PENDING_TASK_VEC


176 .
w™h_Ïb–_v®ues
(&[&
Çme
])

177 .
sub
(
bufãr
.
Ën
(è
as
 
f64
);

178 
	gWORKER_HANDLED_TASK_VEC


179 .
w™h_Ïb–_v®ues
(&[&
Çme
])

180 .
šc_by
(
bufãr
.
Ën
(è
as
 
f64
)

181 .
unw¿p
();

182 
	gruÂ”
.
run_b©ch
(&
mut
 
bufãr
);

183 
	gbufãr
.
ş—r
();

185 
	gruÂ”
.
shutdown
();

188 
	gim¶
<
	gT
: 
Di¥Ïy
 + 
S’d
 + 'static> Worker<T> {

190 
pub
 
â
 
Ãw
<
S
: 
IÁo
<
SŒšg
>>(
Çme
: Sè-> 
WÜk”
<
T
> {

191 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

192 
	gWÜk”
 {

193 
	gscheduËr
: 
ScheduËr
::
Ãw
(
Çme
, 
AtomicUsize
::Ãw(0), 
tx
),

194 
	g»ûiv”
: 
Mu‹x
::
Ãw
(
Some
(
rx
)),

195 
	ghªdË
: 
NÚe
,

200 
pub
 
â
 
	g¡¬t
<
	gR
: 
RuÂabË
<
T
> + 
S’d
 + 'static>(&mut self,„unner: R) -> Result<(), io::Error> {

201 
£lf
.
¡¬t_b©ch
(
ruÂ”
, 1)

204 
pub
 
â
 
	g¡¬t_b©ch
<
	gR
>(&
mut
 
	g£lf
, 
	gruÂ”
: 
R
, 
	gb©ch_size
: 
usize
è-> 
ResuÉ
<(), 
	gio
::
E¼Ü
>

205 
wh”e


206 
R
: 
B©chRuÂabË
<
T
> + 
S’d
 + 'static,

208 
Ët
 
mut
 
»ûiv”
 = 
£lf
.»ûiv”.
lock
().
unw¿p
();

209 
	gšfo
!("¡¬tšg wÜkšgh»ad: {}", 
	g£lf
.
	gscheduËr
.
	gÇme
);

210 
	g»ûiv”
.
is_nÚe
() {

211 
	gw¬n
!("wÜk” {} ha b“À¡¬‹d.", 
	g£lf
.
	gscheduËr
.
	gÇme
);

212  
Ok
(());

215 
Ët
 
	grx
 = 
»ûiv”
.
ke
().
unw¿p
();

216 
Ët
 
	gcouÁ”
 = 
£lf
.
scheduËr
.
couÁ”
.
şÚe
();

217 
Ët
 
	gh
 = 
Bud”
::
Ãw
()

218 .
Çme
(
thd_Çme
!(
£lf
.
scheduËr
.Çme.
as_»f
()))

219 .
¥awn
(
move
 || 
pŞl
(
ruÂ”
, 
rx
, 
couÁ”
, 
b©ch_size
))?;

220 
	g£lf
.
	ghªdË
 = 
Some
(
h
);

221 
Ok
(())

225 
pub
 
â
 
scheduËr
(&
£lf
è-> 
	gScheduËr
<
	gT
> {

226 
	g£lf
.
	gscheduËr
.
şÚe
()

232 
pub
 
â
 
scheduË
(&
£lf
, 
sk
: 
T
è-> 
ResuÉ
<(), 
	gStİ³d
<
	gT
>> {

233 
	g£lf
.
	gscheduËr
.
scheduË
(
sk
)

237 
pub
 
â
 
is_busy
(&
£lf
è-> 
	gboŞ
 {

238 
	g£lf
.
	ghªdË
.
is_nÚe
(è|| s–f.
	gscheduËr
.
is_busy
()

241 
pub
 
â
 
Çme
(&
£lf
è-> &
	g¡r
 {

242 
	g£lf
.
	gscheduËr
.
	gÇme
.
as_¡r
()

246 
pub
 
â
 
¡İ
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gth»ad
::
JošHªdË
<()>> {

248 
šfo
!("¡İšg {}", 
	g£lf
.
	gscheduËr
.
	gÇme
);

249 
	g£lf
.
	ghªdË
.
is_nÚe
() {

250  
	gNÚe
;

252 
Ët
 
E¼
(
e
èğ
£lf
.
scheduËr
.
£nd”
.
£nd
(
NÚe
) {

253 
w¬n
!("çedØ¡İ wÜk”h»ad: {:?}", 
e
);

255 
	g£lf
.
	ghªdË
.
ke
()

259 #[
cfg
(
‹¡
)]

260 
mod
 
	g‹¡
 {

261 
u£
 
	g¡d
::
th»ad
;

262 
u£
 
	g¡d
::
sync
::*;

263 
u£
 
	g¡d
::
sync
::
mpsc
::*;

264 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

266 
u£
 
	gsu³r
::*;

268 
	sS‹pRuÂ”
 {

269 
	gch
: 
S’d”
<
u64
>,

272 
im¶
 
	gRuÂabË
<
	gu64
> 
	gS‹pRuÂ”
 {

273 
â
 
run
(&
mut
 
£lf
, 
¡•
: 
u64
) {

274 
£lf
.
ch
.
£nd
(
¡•
).
unw¿p
();

275 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(
¡•
));

278 
â
 
shutdown
(&
mut
 
£lf
) {

279 
	g£lf
.
	gch
.
£nd
(0).
unw¿p
();

283 
	sB©chRuÂ”
 {

284 
	gch
: 
S’d”
<
Vec
<
u64
>>,

287 
im¶
 
	gB©chRuÂabË
<
	gu64
> 
	gB©chRuÂ”
 {

288 
â
 
run_b©ch
(&
mut
 
£lf
, 
ms
: &muˆ
Vec
<
u64
>) {

289 
£lf
.
ch
.
£nd
(
ms
.
to_vec
()).
unw¿p
();

292 
â
 
shutdown
(&
mut
 
£lf
) {

293 
	g£lf
.
	gch
.
£nd
(
vec
![]).
unw¿p
();

297 #[
‹¡
]

298 
â
 
‹¡_wÜk”
() {

299 
Ët
 
mut
 
	gwÜk”
 = 
WÜk”
::
Ãw
("test-worker");

300 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

301 
	gwÜk”
.
¡¬t
(
S‹pRuÂ”
 { 
ch
: 
tx
 }).
unw¿p
();

302 
	gas£¹
!(!
	gwÜk”
.
is_busy
());

303 
	gwÜk”
.
scheduË
(60).
unw¿p
();

304 
	gwÜk”
.
scheduË
(40).
unw¿p
();

305 
	gwÜk”
.
scheduË
(50).
unw¿p
();

306 
	gas£¹
!(
	gwÜk”
.
is_busy
());

307 
	gas£¹_eq
!(
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
(), 60);

308 
	gas£¹_eq
!(
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
(), 40);

309 
	gas£¹_eq
!(
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
(), 50);

310 
	gas£¹
!(!
	gwÜk”
.
is_busy
());

311 
	gwÜk”
.
¡İ
().
unw¿p
().
još
().unwrap();

313 
	gas£¹
!(
	gwÜk”
.
is_busy
());

315 
	gas£¹_eq
!(0, 
	grx
.
»cv
().
unw¿p
());

318 #[
‹¡
]

319 
â
 
‹¡_th»aded
() {

320 
Ët
 
mut
 
	gwÜk”
 = 
WÜk”
::
Ãw
("test-worker-threaded");

321 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

322 
	gwÜk”
.
¡¬t
(
S‹pRuÂ”
 { 
ch
: 
tx
 }).
unw¿p
();

323 
Ët
 
	gscheduËr
 = 
wÜk”
.
scheduËr
();

324 
	gth»ad
::
¥awn
(
move
 || {

325 
scheduËr
.
scheduË
(90).
unw¿p
();

326 
scheduËr
.
scheduË
(110).
unw¿p
();

328 
	gas£¹_eq
!(
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
(), 90);

329 
	gas£¹_eq
!(
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
(), 110);

330 
	gwÜk”
.
¡İ
().
unw¿p
().
još
().unwrap();

331 
	gas£¹_eq
!(0, 
	grx
.
»cv
().
unw¿p
());

334 #[
‹¡
]

335 
â
 
‹¡_b©ch
() {

336 
Ët
 
mut
 
	gwÜk”
 = 
WÜk”
::
Ãw
("test-worker-batch");

337 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

338 
	gwÜk”
.
¡¬t_b©ch
(
B©chRuÂ”
 { 
ch
: 
tx
 }, 10).
unw¿p
();

339 
_
 
	gš
 0..20 {

340 
	gwÜk”
.
scheduË
(50).
unw¿p
();

342 
	gwÜk”
.
¡İ
().
unw¿p
().
još
().unwrap();

343 
Ët
 
mut
 
	gsum
 = 0;

344 
	gloİ
 {

345 
Ët
 
	gv
 = 
rx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

347 
	gv
.
is_em±y
() {

350 
	gsum
 +ğ
v
.
što_™”
().
fŞd
(0, |
a
, 
b
|‡ + b);

352 
	gas£¹_eq
!(
	gsum
, 50 * 20);

353 
	gas£¹
!(
	grx
.
»cv
().
is_”r
());

356 #[
‹¡
]

357 
â
 
‹¡_autowœed_b©ch
() {

358 
Ët
 
mut
 
	gwÜk”
 = 
WÜk”
::
Ãw
("test-worker-batch");

359 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

360 
	gwÜk”
.
¡¬t_b©ch
(
S‹pRuÂ”
 { 
ch
: 
tx
 }, 10).
unw¿p
();

361 
_
 
	gš
 0..20 {

362 
	gwÜk”
.
scheduË
(50).
unw¿p
();

364 
	gwÜk”
.
¡İ
().
unw¿p
().
još
().unwrap();

365 
_
 
	gš
 0..20 {

366 
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

368 
	gas£¹_eq
!(
	grx
.
»cv
().
unw¿p
(), 0);

	@tests/config/mod.rs

14 
u£
 
	g¡d
::
·th
::
P©hBuf
;

15 
u£
 
	g¡d
::
io
::
R—d
;

16 
u£
 
	g¡d
::
fs
::
Fe
;

18 
u£
 
	glog
::
LogLev–F‹r
;

19 
u£
 
	grocksdb
::{
Com·ùiÚPriÜ™y
, 
	gDBCom´essiÚTy³
, 
	gDBRecov”yMode
};

20 
u£
 
	gtikv
::
pd
::
CÚfig
 
as
 
PdCÚfig
;

21 
u£
 
	gtikv
::
£rv”
::
CÚfig
 
as
 
S”v”CÚfig
;

22 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
CÚfig
 
as
 
Raá¡ÜeCÚfig
;

23 
u£
 
	gtikv
::
¿á¡Üe
::
cİroûssÜ
::
CÚfig
 
as
 
CİCÚfig
;

24 
u£
 
	gtikv
::
cÚfig
::*;

25 
u£
 
	gtikv
::
¡Üage
::
CÚfig
 
as
 
StÜageCÚfig
;

26 
u£
 
	gtikv
::
ut
::
cÚfig
::{
R—dabËDu¿tiÚ
, 
	gR—dabËSize
};

27 
u£
 
	gtikv
::
ut
::
£cur™y
::
Secur™yCÚfig
;

29 
u£
 
	gtoml
;

31 #[
‹¡
]

32 
â
 
	$‹¡_toml_£rde
() {

33 
Ët
 
v®ue
 = 
TiKvCÚfig
::();

34 
Ët
 
dump
 = 
toml
::
	`to_¡ršg_´‘ty
(&
v®ue
).
	`unw¿p
();

35 
Ët
 
lßd
 = 
toml
::
	`äom_¡r
(&
dump
).
	`unw¿p
();

36 
as£¹_eq
!(
v®ue
, 
lßd
);

37 
	}
}

42 
â
 
»ad_fe_š_´ojeù_dœ
(
·th
: &
¡r
è-> 
SŒšg
 {

43 
Ët
 
mut
 
p
 = 
P©hBuf
::
äom
(
’v
!("CARGO_MANIFEST_DIR"));

44 
	gp
.
push
(
·th
);

45 
Ët
 
mut
 
	gf
 = 
Fe
::
İ’
(
p
).
unw¿p
();

46 
Ët
 
mut
 
	gbufãr
 = 
SŒšg
::
Ãw
();

47 
	gf
.
»ad_to_¡ršg
(&
mut
 
bufãr
).
unw¿p
();

48 
	gbufãr


51 #[
‹¡
]

52 
â
 
	$‹¡_£rde_cu¡om_tikv_cÚfig
() {

53 
Ët
 
mut
 
v®ue
 = 
TiKvCÚfig
::();

54 
v®ue
.
log_Ëv–
 = 
LogLev–F‹r
::
Debug
;

55 
v®ue
.
log_fe
 = "foo".
	`to_owÃd
();

56 
v®ue
.
£rv”
 = 
S”v”CÚfig
 {

57 
şu¡”_id
: 0,

58 
addr
: "exam¶e.com:443".
	`to_owÃd
(),

59 
Ïb–s
: 
m­
!{ "a".
	`to_owÃd
() => "b".to_owned() },

60 
adv”ti£_addr
: "exam¶e.com:443".
	`to_owÃd
(),

61 
nÙify_ÿ·c™y
: 12
_345
,

62 
mes§ges_³r_tick
: 123,

63 
g½c_cÚcu¼’cy
: 123,

64 
g½c_cÚcu¼’t_¡»am
: 1
_234
,

65 
g½c_¿á_cÚn_num
: 123,

66 
g½c_¡»am_š™Ÿl_wšdow_size
: 
	`R—dabËSize
(12
_345
),

67 
’d_pošt_cÚcu¼’cy
: 12,

68 
’d_pošt_max_sks
: 12,

69 
’d_pošt_¡ack_size
: 
R—dabËSize
::
	`mb
(12),

70 
’d_pošt_»cursiÚ_lim™
: 100,

71 
’d_pošt_b©ch_row_lim™
: 64,

72 
¢­_max_wr™e_by‹s_³r_£c
: 
R—dabËSize
::
	`mb
(10),

74 
v®ue
.
m‘ric
 = 
M‘ricCÚfig
 {

75 
š‹rv®
: 
R—dabËDu¿tiÚ
::
	`£cs
(12),

76 
add»ss
: "exam¶e.com:443".
	`to_owÃd
(),

77 
job
: "tikv_1".
	`to_owÃd
(),

79 
v®ue
.
¿á_¡Üe
 = 
Raá¡ÜeCÚfig
 {

80 
sync_log
: 
çl£
,

81 
¿ádb_·th
: "/v¬".
	`to_owÃd
(),

82 
ÿ·c™y
: 
	`R—dabËSize
(123),

83 
¿á_ba£_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
	`£cs
(12),

84 
¿á_h—¹b—t_ticks
: 1,

85 
¿á_–eùiÚ_timeout_ticks
: 12,

86 
¿á_max_size_³r_msg
: 
R—dabËSize
::
	`mb
(12),

87 
¿á_max_šæight_msgs
: 123,

88 
¿á_’Œy_max_size
: 
R—dabËSize
::
	`mb
(12),

89 
¿á_log_gc_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
	`£cs
(12),

90 
¿á_log_gc_th»shŞd
: 12,

91 
¿á_log_gc_couÁ_lim™
: 12,

92 
¿á_log_gc_size_lim™
: 
R—dabËSize
::
	`kb
(1),

93 
¥l™_»giÚ_check_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
	`£cs
(12),

94 
»giÚ_¥l™_check_diff
: 
R—dabËSize
::
	`mb
(6),

95 
»giÚ_com·ù_check_š‹rv®
: 
R—dabËDu¿tiÚ
::
	`£cs
(12),

96 
»giÚ_com·ù_d–‘e_keys_couÁ
: 1
_234
,

97 
pd_h—¹b—t_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
	`mšu‹s
(12),

98 
pd_¡Üe_h—¹b—t_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
	`£cs
(12),

99 
nÙify_ÿ·c™y
: 12
_345
,

100 
¢­_mgr_gc_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
	`mšu‹s
(12),

101 
¢­_gc_timeout
: 
R—dabËDu¿tiÚ
::
	`hours
(12),

102 
mes§ges_³r_tick
: 12
_345
,

103 
max_³”_down_du¿tiÚ
: 
R—dabËDu¿tiÚ
::
	`mšu‹s
(12),

104 
max_Ëad”_missšg_du¿tiÚ
: 
R—dabËDu¿tiÚ
::
	`hours
(12),

105 
¢­_­¶y_b©ch_size
: 
R—dabËSize
::
	`mb
(12),

106 
lock_cf_com·ù_š‹rv®
: 
R—dabËDu¿tiÚ
::
	`mšu‹s
(12),

107 
lock_cf_com·ù_by‹s_th»shŞd
: 
R—dabËSize
::
	`mb
(123),

108 
cÚsi¡’cy_check_š‹rv®
: 
R—dabËDu¿tiÚ
::
	`£cs
(12),

109 
»pÜt_»giÚ_æow_š‹rv®
: 
R—dabËDu¿tiÚ
::
	`mšu‹s
(12),

110 
¿á_¡Üe_max_Ëad”_Ëa£
: 
R—dabËDu¿tiÚ
::
	`£cs
(12),

111 
right_d”ive_wh’_¥l™
: 
çl£
,

112 
®low_»move_Ëad”
: 
Œue
,

113 
»giÚ_max_size
: 
	`R—dabËSize
(0),

114 
»giÚ_¥l™_size
: 
	`R—dabËSize
(0),

116 
v®ue
.
pd
 = 
PdCÚfig
 {

117 
’dpošts
: 
vec
!["exam¶e.com:443".
	`to_owÃd
()],

119 
v®ue
.
rocksdb
 = 
DbCÚfig
 {

120 
w®_»cov”y_mode
: 
DBRecov”yMode
::
AbsŞu‹CÚsi¡’cy
,

121 
w®_dœ
: "/v¬".
	`to_owÃd
(),

122 
w®_‰l_£cÚds
: 1,

123 
w®_size_lim™
: 
R—dabËSize
::
	`kb
(1),

124 
max_tÙ®_w®_size
: 
R—dabËSize
::
	`gb
(1),

125 
max_background_jobs
: 12,

126 
max_mªiã¡_fe_size
: 
R—dabËSize
::
	`mb
(12),

127 
ü—‹_if_missšg
: 
çl£
,

128 
max_İ’_fes
: 12
_345
,

129 
’abË_¡©i¡ics
: 
çl£
,

130 
¡©s_dump_³riod
: 
R—dabËDu¿tiÚ
::
	`mšu‹s
(12),

131 
com·ùiÚ_»adah—d_size
: 
R—dabËSize
::
	`kb
(1),

132 
šfo_log_max_size
: 
R—dabËSize
::
	`kb
(1),

133 
šfo_log_rŞl_time
: 
R—dabËDu¿tiÚ
::
	`£cs
(12),

134 
šfo_log_dœ
: "/v¬".
	`to_owÃd
(),

135 
¿‹_by‹s_³r_£c
: 
R—dabËSize
::
	`kb
(1),

136 
w®_by‹s_³r_sync
: 
R—dabËSize
::
	`mb
(1),

137 
max_sub_com·ùiÚs
: 12,

138 
wr™abË_fe_max_bufãr_size
: 
R—dabËSize
::
	`mb
(12),

139 
u£_dœeù_io_fÜ_æush_ªd_com·ùiÚ
: 
Œue
,

140 
’abË_p–šed_wr™e
: 
çl£
,

141 
backup_dœ
: "/v¬".
	`to_owÃd
(),

142 
deçuÉcf
: 
DeçuÉCfCÚfig
 {

143 
block_size
: 
R—dabËSize
::
	`kb
(12),

144 
block_ÿche_size
: 
R—dabËSize
::
	`gb
(12),

145 
ÿche_šdex_ªd_f‹r_blocks
: 
çl£
,

146 
pš_l0_f‹r_ªd_šdex_blocks
: 
çl£
,

147 
u£_bloom_f‹r
: 
çl£
,

148 
whŞe_key_f‹ršg
: 
Œue
,

149 
bloom_f‹r_b™s_³r_key
: 123,

150 
block_ba£d_bloom_f‹r
: 
Œue
,

151 
»ad_amp_by‹s_³r_b™
: 0,

152 
com´essiÚ_³r_Ëv–
: [

153 
DBCom´essiÚTy³
::
No
,

154 
DBCom´essiÚTy³
::
No
,

155 
DBCom´essiÚTy³
::
Z¡d
,

156 
DBCom´essiÚTy³
::
Z¡d
,

157 
DBCom´essiÚTy³
::
No
,

158 
DBCom´essiÚTy³
::
Z¡d
,

159 
DBCom´essiÚTy³
::
Lz4
,

161 
wr™e_bufãr_size
: 
R—dabËSize
::
	`mb
(1),

162 
max_wr™e_bufãr_numb”
: 12,

163 
mš_wr™e_bufãr_numb”_to_m”ge
: 12,

164 
max_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
::
	`kb
(12),

165 
rg‘_fe_size_ba£
: 
R—dabËSize
::
	`kb
(123),

166 
Ëv–0_fe_num_com·ùiÚ_Œigg”
: 123,

167 
Ëv–0_¦owdown_wr™es_Œigg”
: 123,

168 
Ëv–0_¡İ_wr™es_Œigg”
: 123,

169 
max_com·ùiÚ_by‹s
: 
R—dabËSize
::
	`gb
(1),

170 
com·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
::
MšOv”ÏµšgR©io
,

172 
wr™ecf
: 
Wr™eCfCÚfig
 {

173 
block_size
: 
R—dabËSize
::
	`kb
(12),

174 
block_ÿche_size
: 
R—dabËSize
::
	`gb
(12),

175 
ÿche_šdex_ªd_f‹r_blocks
: 
çl£
,

176 
pš_l0_f‹r_ªd_šdex_blocks
: 
çl£
,

177 
u£_bloom_f‹r
: 
çl£
,

178 
whŞe_key_f‹ršg
: 
Œue
,

179 
bloom_f‹r_b™s_³r_key
: 123,

180 
block_ba£d_bloom_f‹r
: 
Œue
,

181 
»ad_amp_by‹s_³r_b™
: 0,

182 
com´essiÚ_³r_Ëv–
: [

183 
DBCom´essiÚTy³
::
No
,

184 
DBCom´essiÚTy³
::
No
,

185 
DBCom´essiÚTy³
::
Z¡d
,

186 
DBCom´essiÚTy³
::
Z¡d
,

187 
DBCom´essiÚTy³
::
No
,

188 
DBCom´essiÚTy³
::
Z¡d
,

189 
DBCom´essiÚTy³
::
Lz4
,

191 
wr™e_bufãr_size
: 
R—dabËSize
::
	`mb
(1),

192 
max_wr™e_bufãr_numb”
: 12,

193 
mš_wr™e_bufãr_numb”_to_m”ge
: 12,

194 
max_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
::
	`kb
(12),

195 
rg‘_fe_size_ba£
: 
R—dabËSize
::
	`kb
(123),

196 
Ëv–0_fe_num_com·ùiÚ_Œigg”
: 123,

197 
Ëv–0_¦owdown_wr™es_Œigg”
: 123,

198 
Ëv–0_¡İ_wr™es_Œigg”
: 123,

199 
max_com·ùiÚ_by‹s
: 
R—dabËSize
::
	`gb
(1),

200 
com·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
::
MšOv”ÏµšgR©io
,

202 
lockcf
: 
LockCfCÚfig
 {

203 
block_size
: 
R—dabËSize
::
	`kb
(12),

204 
block_ÿche_size
: 
R—dabËSize
::
	`gb
(12),

205 
ÿche_šdex_ªd_f‹r_blocks
: 
çl£
,

206 
pš_l0_f‹r_ªd_šdex_blocks
: 
çl£
,

207 
u£_bloom_f‹r
: 
çl£
,

208 
whŞe_key_f‹ršg
: 
Œue
,

209 
bloom_f‹r_b™s_³r_key
: 123,

210 
block_ba£d_bloom_f‹r
: 
Œue
,

211 
»ad_amp_by‹s_³r_b™
: 0,

212 
com´essiÚ_³r_Ëv–
: [

213 
DBCom´essiÚTy³
::
No
,

214 
DBCom´essiÚTy³
::
No
,

215 
DBCom´essiÚTy³
::
Z¡d
,

216 
DBCom´essiÚTy³
::
Z¡d
,

217 
DBCom´essiÚTy³
::
No
,

218 
DBCom´essiÚTy³
::
Z¡d
,

219 
DBCom´essiÚTy³
::
Lz4
,

221 
wr™e_bufãr_size
: 
R—dabËSize
::
	`mb
(1),

222 
max_wr™e_bufãr_numb”
: 12,

223 
mš_wr™e_bufãr_numb”_to_m”ge
: 12,

224 
max_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
::
	`kb
(12),

225 
rg‘_fe_size_ba£
: 
R—dabËSize
::
	`kb
(123),

226 
Ëv–0_fe_num_com·ùiÚ_Œigg”
: 123,

227 
Ëv–0_¦owdown_wr™es_Œigg”
: 123,

228 
Ëv–0_¡İ_wr™es_Œigg”
: 123,

229 
max_com·ùiÚ_by‹s
: 
R—dabËSize
::
	`gb
(1),

230 
com·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
::
MšOv”ÏµšgR©io
,

232 
¿ácf
: 
RaáCfCÚfig
 {

233 
block_size
: 
R—dabËSize
::
	`kb
(12),

234 
block_ÿche_size
: 
R—dabËSize
::
	`gb
(12),

235 
ÿche_šdex_ªd_f‹r_blocks
: 
çl£
,

236 
pš_l0_f‹r_ªd_šdex_blocks
: 
çl£
,

237 
u£_bloom_f‹r
: 
çl£
,

238 
whŞe_key_f‹ršg
: 
Œue
,

239 
bloom_f‹r_b™s_³r_key
: 123,

240 
block_ba£d_bloom_f‹r
: 
Œue
,

241 
»ad_amp_by‹s_³r_b™
: 0,

242 
com´essiÚ_³r_Ëv–
: [

243 
DBCom´essiÚTy³
::
No
,

244 
DBCom´essiÚTy³
::
No
,

245 
DBCom´essiÚTy³
::
Z¡d
,

246 
DBCom´essiÚTy³
::
Z¡d
,

247 
DBCom´essiÚTy³
::
No
,

248 
DBCom´essiÚTy³
::
Z¡d
,

249 
DBCom´essiÚTy³
::
Lz4
,

251 
wr™e_bufãr_size
: 
R—dabËSize
::
	`mb
(1),

252 
max_wr™e_bufãr_numb”
: 12,

253 
mš_wr™e_bufãr_numb”_to_m”ge
: 12,

254 
max_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
::
	`kb
(12),

255 
rg‘_fe_size_ba£
: 
R—dabËSize
::
	`kb
(123),

256 
Ëv–0_fe_num_com·ùiÚ_Œigg”
: 123,

257 
Ëv–0_¦owdown_wr™es_Œigg”
: 123,

258 
Ëv–0_¡İ_wr™es_Œigg”
: 123,

259 
max_com·ùiÚ_by‹s
: 
R—dabËSize
::
	`gb
(1),

260 
com·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
::
MšOv”ÏµšgR©io
,

263 
v®ue
.
¿ádb
 = 
RaáDbCÚfig
 {

264 
w®_»cov”y_mode
: 
DBRecov”yMode
::
SkAnyCÜru±edRecÜds
,

265 
w®_dœ
: "/v¬".
	`to_owÃd
(),

266 
w®_‰l_£cÚds
: 1,

267 
w®_size_lim™
: 
R—dabËSize
::
	`kb
(12),

268 
max_tÙ®_w®_size
: 
R—dabËSize
::
	`gb
(1),

269 
max_mªiã¡_fe_size
: 
R—dabËSize
::
	`mb
(12),

270 
ü—‹_if_missšg
: 
çl£
,

271 
max_İ’_fes
: 12
_345
,

272 
’abË_¡©i¡ics
: 
çl£
,

273 
¡©s_dump_³riod
: 
R—dabËDu¿tiÚ
::
	`mšu‹s
(12),

274 
com·ùiÚ_»adah—d_size
: 
R—dabËSize
::
	`kb
(1),

275 
šfo_log_max_size
: 
R—dabËSize
::
	`kb
(1),

276 
šfo_log_rŞl_time
: 
R—dabËDu¿tiÚ
::
	`£cs
(1),

277 
šfo_log_dœ
: "/v¬".
	`to_owÃd
(),

278 
max_sub_com·ùiÚs
: 12,

279 
wr™abË_fe_max_bufãr_size
: 
R—dabËSize
::
	`mb
(12),

280 
u£_dœeù_io_fÜ_æush_ªd_com·ùiÚ
: 
Œue
,

281 
’abË_p–šed_wr™e
: 
çl£
,

282 
®low_cÚcu¼’t_membË_wr™e
: 
Œue
,

283 
w®_by‹s_³r_sync
: 
R—dabËSize
::
	`mb
(1),

284 
deçuÉcf
: 
RaáDeçuÉCfCÚfig
 {

285 
block_size
: 
R—dabËSize
::
	`kb
(12),

286 
block_ÿche_size
: 
R—dabËSize
::
	`gb
(12),

287 
ÿche_šdex_ªd_f‹r_blocks
: 
çl£
,

288 
pš_l0_f‹r_ªd_šdex_blocks
: 
çl£
,

289 
u£_bloom_f‹r
: 
çl£
,

290 
whŞe_key_f‹ršg
: 
Œue
,

291 
bloom_f‹r_b™s_³r_key
: 123,

292 
block_ba£d_bloom_f‹r
: 
Œue
,

293 
»ad_amp_by‹s_³r_b™
: 0,

294 
com´essiÚ_³r_Ëv–
: [

295 
DBCom´essiÚTy³
::
No
,

296 
DBCom´essiÚTy³
::
No
,

297 
DBCom´essiÚTy³
::
Z¡d
,

298 
DBCom´essiÚTy³
::
Z¡d
,

299 
DBCom´essiÚTy³
::
No
,

300 
DBCom´essiÚTy³
::
Z¡d
,

301 
DBCom´essiÚTy³
::
Lz4
,

303 
wr™e_bufãr_size
: 
R—dabËSize
::
	`mb
(1),

304 
max_wr™e_bufãr_numb”
: 12,

305 
mš_wr™e_bufãr_numb”_to_m”ge
: 12,

306 
max_by‹s_fÜ_Ëv–_ba£
: 
R—dabËSize
::
	`kb
(12),

307 
rg‘_fe_size_ba£
: 
R—dabËSize
::
	`kb
(123),

308 
Ëv–0_fe_num_com·ùiÚ_Œigg”
: 123,

309 
Ëv–0_¦owdown_wr™es_Œigg”
: 123,

310 
Ëv–0_¡İ_wr™es_Œigg”
: 123,

311 
max_com·ùiÚ_by‹s
: 
R—dabËSize
::
	`gb
(1),

312 
com·ùiÚ_´i
: 
Com·ùiÚPriÜ™y
::
MšOv”ÏµšgR©io
,

315 
v®ue
.
¡Üage
 = 
StÜageCÚfig
 {

316 
d©a_dœ
: "/v¬".
	`to_owÃd
(),

317 
gc_¿tio_th»shŞd
: 1.2,

318 
max_key_size
: 8192,

319 
scheduËr_nÙify_ÿ·c™y
: 123,

321 
scheduËr_mes§ges_³r_tick
: 123,

322 
scheduËr_cÚcu¼’cy
: 123,

323 
scheduËr_wÜk”_poŞ_size
: 1,

324 
scheduËr_³ndšg_wr™e_th»shŞd
: 
R—dabËSize
::
	`kb
(123),

326 
v®ue
.
cİroûssÜ
 = 
CİCÚfig
 {

327 
¥l™_»giÚ_Ú_bË
: 
Œue
,

328 
»giÚ_max_size
: 
R—dabËSize
::
	`mb
(12),

329 
»giÚ_¥l™_size
: 
R—dabËSize
::
	`mb
(12),

331 
v®ue
.
£cur™y
 = 
Secur™yCÚfig
 {

332 
ÿ_·th
: "šv®id…©h".
	`to_owÃd
(),

333 
û¹_·th
: "šv®id…©h".
	`to_owÃd
(),

334 
key_·th
: "šv®id…©h".
	`to_owÃd
(),

335 
ov”ride_s¦_rg‘
: "".
	`to_owÃd
(),

338 
Ët
 
cu¡om
 = 
	`»ad_fe_š_´ojeù_dœ
("tests/config/test-custom.toml");

339 
Ët
 
lßd
 = 
toml
::
	`äom_¡r
(&
cu¡om
).
	`unw¿p
();

340 
as£¹_eq
!(
v®ue
, 
lßd
);

341 
Ët
 
dump
 = 
toml
::
	`to_¡ršg_´‘ty
(&
lßd
).
	`unw¿p
();

342 
as£¹_eq
!(
dump
, 
cu¡om
);

343 
	}
}

	@tests/coprocessor/mod.rs

14 
mod
 
	g‹¡_£Ëù
;

15 
mod
 
	g‹¡_ª®yze
;

	@tests/coprocessor/test_analyze.rs

14 
u£
 
	gkv´Ùo
::
cİroûssÜ
::{
KeyRªge
, 
	gReque¡
};

15 
u£
 
	gkv´Ùo
::
kv½ıb
::{
CÚ‹xt
, 
	gIsŞ©iÚLev–
};

16 
u£
 
	g´Ùobuf
::{
Mes§ge
, 
	gR•—‹dF›ld
};

17 
u£
 
	gtb
::
ª®yze
::{
AÇlyzeCŞumnsReq
, 
	gAÇlyzeCŞumnsRe¥
, 
	gAÇlyzeIndexReq
, 
	gAÇlyzeIndexRe¥
,

18 
	gAÇlyzeReq
, 
	gAÇlyzeTy³
};

19 
u£
 
	gsu³r
::
‹¡_£Ëù
::*;

21 
pub
 cÚ¡ 
	gREQ_TYPE_ANALYZE
: 
i64
 = 104;

23 
â
 
Ãw_ª®yze_»q
(
d©a
: 
Vec
<
u8
>, 
¿nge
: 
KeyRªge
è-> 
Reque¡
 {

24 
Ët
 
mut
 
»q
 = 
Reque¡
::
Ãw
();

25 
	g»q
.
£t_d©a
(
d©a
);

26 
	g»q
.
£t_¿nges
(
R•—‹dF›ld
::
äom_vec
(
vec
![
¿nge
]));

27 
	g»q
.
£t_
(
REQ_TYPE_ANALYZE
);

28 
	g»q


31 
â
 
Ãw_ª®yze_cŞumn_»q
(

32 
bË
: &
TabË
,

33 
buck‘_size
: 
i64
,

34 
fm_sk‘ch_size
: 
i64
,

35 
§m¶e_size
: 
i64
,

36 
cm_sk‘ch_d•th
: 
i32
,

37 
cm_sk‘ch_width
: 
i32
,

38 è-> 
	gReque¡
 {

39 
Ët
 
mut
 
	gcŞ_»q
 = 
AÇlyzeCŞumnsReq
::
Ãw
();

40 
	gcŞ_»q
.
£t_cŞumns_šfo
(
R•—‹dF›ld
::
äom_vec
(
bË
.
g‘_bË_cŞumns
()));

41 
	gcŞ_»q
.
£t_buck‘_size
(
buck‘_size
);

42 
	gcŞ_»q
.
£t_sk‘ch_size
(
fm_sk‘ch_size
);

43 
	gcŞ_»q
.
£t_§m¶e_size
(
§m¶e_size
);

44 
	gcŞ_»q
.
£t_cmsk‘ch_d•th
(
cm_sk‘ch_d•th
);

45 
	gcŞ_»q
.
£t_cmsk‘ch_width
(
cm_sk‘ch_width
);

46 
Ët
 
mut
 
	gª®y_»q
 = 
AÇlyzeReq
::
Ãw
();

47 
	gª®y_»q
.
£t_
(
AÇlyzeTy³
::
Ty³CŞumn
);

48 
	gª®y_»q
.
£t_¡¬t_ts
(
Ãxt_id
(è
as
 
u64
);

49 
	gª®y_»q
.
£t_cŞ_»q
(
cŞ_»q
);

50 
Ãw_ª®yze_»q
(

51 
ª®y_»q
.
wr™e_to_by‹s
().
unw¿p
(),

52 
bË
.
g‘_£Ëù_¿nge
(),

56 
â
 
Ãw_ª®yze_šdex_»q
(

57 
bË
: &
TabË
,

58 
buck‘_size
: 
i64
,

59 
idx
: 
i64
,

60 
cm_sk‘ch_d•th
: 
i32
,

61 
cm_sk‘ch_width
: 
i32
,

62 è-> 
	gReque¡
 {

63 
Ët
 
mut
 
	gidx_»q
 = 
AÇlyzeIndexReq
::
Ãw
();

64 
	gidx_»q
.
£t_num_cŞumns
(2);

65 
	gidx_»q
.
£t_buck‘_size
(
buck‘_size
);

66 
	gidx_»q
.
£t_cmsk‘ch_d•th
(
cm_sk‘ch_d•th
);

67 
	gidx_»q
.
£t_cmsk‘ch_width
(
cm_sk‘ch_width
);

68 
Ët
 
mut
 
	gª®y_»q
 = 
AÇlyzeReq
::
Ãw
();

69 
	gª®y_»q
.
£t_
(
AÇlyzeTy³
::
Ty³Index
);

70 
	gª®y_»q
.
£t_¡¬t_ts
(
Ãxt_id
(è
as
 
u64
);

71 
	gª®y_»q
.
£t_idx_»q
(
idx_»q
);

72 
Ãw_ª®yze_»q
(

73 
ª®y_»q
.
wr™e_to_by‹s
().
unw¿p
(),

74 
bË
.
g‘_šdex_¿nge
(
idx
),

78 #[
‹¡
]

79 
â
 
	$‹¡_ª®yze_cŞumn_w™h_lock
() {

80 
Ët
 
d©a
 = 
vec
![

81 (1, 
	`Some
("name:0"), 2),

82 (2, 
	`Some
("name:4"), 3),

83 (4, 
	`Some
("name:3"), 1),

84 (5, 
	`Some
("name:1"), 4),

87 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

88 &
iso_Ëv–
 
š
 &[
IsŞ©iÚLev–
::
SI
, IsŞ©iÚLev–::
RC
] {

89 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_d©a_w™h_comm™
(&
´oduù
, &
d©a
, 
çl£
);

91 
Ët
 
mut
 
»q
 = 
	`Ãw_ª®yze_cŞumn_»q
(&
´oduù
.
bË
, 3, 3, 3, 4, 32);

92 
Ët
 
mut
 
ùx
 = 
CÚ‹xt
::
	`Ãw
();

93 
ùx
.
	`£t_isŞ©iÚ_Ëv–
(
iso_Ëv–
);

94 
»q
.
	`£t_cÚ‹xt
(
ùx
);

96 
Ët
 
»¥
 = 
	`hªdË_»que¡
(&
’d_pošt
, 
»q
);

97 
m©ch
 
iso_Ëv–
 {

98 
IsŞ©iÚLev–
::
SI
 => {

99 
as£¹
!(
»¥
.
	`g‘_d©a
().
	`is_em±y
(), "{:?}",„esp);

100 
as£¹
!(
»¥
.
	`has_locked
(), "{:?}",„esp);

102 
IsŞ©iÚLev–
::
RC
 => {

103 
Ët
 
mut
 
ª®yze_»¥
 = 
AÇlyzeCŞumnsRe¥
::
	`Ãw
();

104 
ª®yze_»¥
.
	`m”ge_äom_by‹s
(
»¥
.
	`g‘_d©a
()).
	`unw¿p
();

105 
Ët
 
hi¡
 = 
ª®yze_»¥
.
	`g‘_pk_hi¡
();

106 
as£¹
!(
hi¡
.
	`g‘_buck‘s
().
	`is_em±y
());

107 
as£¹_eq
!(
hi¡
.
	`g‘_ndv
(), 0);

108 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

112 
	}
}

114 #[
‹¡
]

115 
â
 
	$‹¡_ª®yze_cŞumn
() {

116 
Ët
 
d©a
 = 
vec
![

117 (1, 
	`Some
("name:0"), 2),

118 (2, 
	`Some
("name:4"), 3),

119 (4, 
	`Some
("name:3"), 1),

120 (5, 
NÚe
, 4),

123 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

124 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_d©a_w™h_comm™
(&
´oduù
, &
d©a
, 
Œue
);

126 
Ët
 
»q
 = 
	`Ãw_ª®yze_cŞumn_»q
(&
´oduù
.
bË
, 3, 3, 3, 4, 32);

127 
Ët
 
»¥
 = 
	`hªdË_»que¡
(&
’d_pošt
, 
»q
);

128 
as£¹
!(!
»¥
.
	`g‘_d©a
().
	`is_em±y
());

129 
Ët
 
mut
 
ª®yze_»¥
 = 
AÇlyzeCŞumnsRe¥
::
	`Ãw
();

130 
ª®yze_»¥
.
	`m”ge_äom_by‹s
(
»¥
.
	`g‘_d©a
()).
	`unw¿p
();

131 
Ët
 
hi¡
 = 
ª®yze_»¥
.
	`g‘_pk_hi¡
();

132 
as£¹_eq
!(
hi¡
.
	`g‘_buck‘s
().
	`Ën
(), 2);

133 
as£¹_eq
!(
hi¡
.
	`g‘_ndv
(), 4);

134 
Ët
 
cŞËùÜs
 = 
ª®yze_»¥
.
	`g‘_cŞËùÜs
().
	`to_vec
();

135 
as£¹_eq
!(

136 
cŞËùÜs
.
	`Ën
(),

137 
´oduù
.
bË
.
	`g‘_bË_cŞumns
().
	`Ën
() - 1

139 
as£¹_eq
!(
cŞËùÜs
[0].
	`g‘_nuÎ_couÁ
(), 1);

140 
as£¹_eq
!(
cŞËùÜs
[0].
	`g‘_couÁ
(), 3);

141 
Ët
 
rows
 = 
cŞËùÜs
[0].
	`g‘_cm_sk‘ch
().
	`g‘_rows
();

142 
as£¹_eq
!(
rows
.
	`Ën
(), 4);

143 
Ët
 
sum
: 
u32
 = 
rows
.
	`fœ¡
().
	`unw¿p
().
	`g‘_couÁ”s
().
	`™”
().
	`sum
();

144 
as£¹_eq
!(
sum
, 3);

145 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

146 
	}
}

149 #[
‹¡
]

150 
â
 
	$‹¡_ª®yze_šdex_w™h_lock
() {

151 
Ët
 
d©a
 = 
vec
![

152 (1, 
	`Some
("name:0"), 2),

153 (2, 
	`Some
("name:4"), 3),

154 (4, 
	`Some
("name:3"), 1),

155 (5, 
	`Some
("name:1"), 4),

158 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

159 &
iso_Ëv–
 
š
 &[
IsŞ©iÚLev–
::
SI
, IsŞ©iÚLev–::
RC
] {

160 
	`Ët
 (
_
, 
’d_pošt
èğ
	`š™_d©a_w™h_comm™
(&
´oduù
, &
d©a
, 
çl£
);

162 
Ët
 
mut
 
»q
 = 
	`Ãw_ª®yze_šdex_»q
(&
´oduù
.
bË
, 3,…roduù.
Çme
.
šdex
, 4, 32);

163 
Ët
 
mut
 
ùx
 = 
CÚ‹xt
::
	`Ãw
();

164 
ùx
.
	`£t_isŞ©iÚ_Ëv–
(
iso_Ëv–
);

165 
»q
.
	`£t_cÚ‹xt
(
ùx
);

167 
Ët
 
»¥
 = 
	`hªdË_»que¡
(&
’d_pošt
, 
»q
);

168 
m©ch
 
iso_Ëv–
 {

169 
IsŞ©iÚLev–
::
SI
 => {

170 
as£¹
!(
»¥
.
	`g‘_d©a
().
	`is_em±y
(), "{:?}",„esp);

171 
as£¹
!(
»¥
.
	`has_locked
(), "{:?}",„esp);

173 
IsŞ©iÚLev–
::
RC
 => {

174 
Ët
 
mut
 
ª®yze_»¥
 = 
AÇlyzeIndexRe¥
::
	`Ãw
();

175 
ª®yze_»¥
.
	`m”ge_äom_by‹s
(
»¥
.
	`g‘_d©a
()).
	`unw¿p
();

176 
Ët
 
hi¡
 = 
ª®yze_»¥
.
	`g‘_hi¡
();

177 
as£¹
!(
hi¡
.
	`g‘_buck‘s
().
	`is_em±y
());

178 
as£¹_eq
!(
hi¡
.
	`g‘_ndv
(), 0);

182 
	}
}

184 #[
‹¡
]

185 
â
 
	$‹¡_ª®yze_šdex
() {

186 
Ët
 
d©a
 = 
vec
![

187 (1, 
	`Some
("name:0"), 2),

188 (2, 
	`Some
("name:4"), 3),

189 (4, 
	`Some
("name:3"), 1),

190 (5, 
NÚe
, 4),

193 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

194 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_d©a_w™h_comm™
(&
´oduù
, &
d©a
, 
Œue
);

196 
Ët
 
»q
 = 
	`Ãw_ª®yze_šdex_»q
(&
´oduù
.
bË
, 3,…roduù.
Çme
.
šdex
, 4, 32);

197 
Ët
 
»¥
 = 
	`hªdË_»que¡
(&
’d_pošt
, 
»q
);

198 
as£¹
!(!
»¥
.
	`g‘_d©a
().
	`is_em±y
());

199 
Ët
 
mut
 
ª®yze_»¥
 = 
AÇlyzeIndexRe¥
::
	`Ãw
();

200 
ª®yze_»¥
.
	`m”ge_äom_by‹s
(
»¥
.
	`g‘_d©a
()).
	`unw¿p
();

201 
Ët
 
hi¡
 = 
ª®yze_»¥
.
	`g‘_hi¡
();

202 
as£¹_eq
!(
hi¡
.
	`g‘_ndv
(), 4);

203 
as£¹_eq
!(
hi¡
.
	`g‘_buck‘s
().
	`Ën
(), 2);

204 
Ët
 
rows
 = 
ª®yze_»¥
.
	`g‘_cms
().
	`g‘_rows
();

205 
as£¹_eq
!(
rows
.
	`Ën
(), 4);

206 
Ët
 
sum
: 
u32
 = 
rows
.
	`fœ¡
().
	`unw¿p
().
	`g‘_couÁ”s
().
	`™”
().
	`sum
();

207 
as£¹_eq
!(
sum
, 4);

208 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

209 
	}
}

	@tests/coprocessor/test_select.rs

14 
u£
 
	g¡d
::
cŞËùiÚs
::{
BT»eM­
, 
	gHashM­
};

15 
u£
 
	g¡d
::
mem
;

16 
u£
 
	g¡d
::
sync
::
mpsc
;

17 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

18 
u£
 
	g¡d
::
i64
;

19 
u£
 
	g¡d
::
th»ad
;

20 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

22 
u£
 
	gtikv
::
cİroûssÜ
::*;

23 
u£
 
	gtikv
::
cİroûssÜ
;

24 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

25 
u£
 
	gtikv
::
cİroûssÜ
::
codec
::{
d©um
, 
	gbË
, 
	gD©um
};

26 
u£
 
	gtikv
::
cİroûssÜ
::
codec
::
d©um
::
D©umDecod”
;

27 
u£
 
	gtikv
::
ut
::
codec
::
numb”
::*;

28 
u£
 
	gtikv
::
¡Üage
::{
Key
, 
	gMutiÚ
, 
	gALL_CFS
};

29 
u£
 
	gtikv
::
£rv”
::
CÚfig
;

30 
u£
 
	gtikv
::
¡Üage
::
’gše
::{
£lf
, 
	gEngše
, 
	gTEMP_DIR
};

31 
u£
 
	gtikv
::
ut
::
wÜk”
::{
Futu»WÜk”
, 
	gWÜk”
};

32 
u£
 
	gkv´Ùo
::
cİroûssÜ
::{
KeyRªge
, 
	gReque¡
, 
	gRe¥Ú£
};

33 
u£
 
	gtb
::
£Ëù
::{
Chunk
, 
	gDAGReque¡
, 
	gS–eùReque¡
, 
	gS–eùRe¥Ú£
};

34 
u£
 
	gtb
::
executÜ
::{
Agg»g©iÚ
, 
	gExecTy³
, 
	gExecutÜ
, 
	gIndexSÿn
, 
	gLim™
, 
	gS–eùiÚ
, 
	gTabËSÿn
, 
	gTİN
};

35 
u£
 
	gtb
::
schema
::{
£lf
, 
	gCŞumnInfo
};

36 
u£
 
	gtb
::
ex´essiÚ
::{
ByI‹m
, 
	gEx´
, 
	gEx´Ty³
, 
	gSÿÏrFuncSig
};

37 
u£
 
	g´Ùobuf
::{
Mes§ge
, 
	gR•—‹dF›ld
};

39 
u£
 
	g¿á¡Üe
::
ut
::
MAX_LEADER_LEASE
;

40 
u£
 
	g¡Üage
::
sync_¡Üage
::
SyncStÜage
;

41 
u£
 
	g¡Üage
::
ut
::
Ãw_¿á_’gše
;

42 
u£
 
	gtikv
::
cİroûssÜ
::
£Ëù
::
xev®
::
ev®u©Ü
::
FLAG_IGNORE_TRUNCATE
;

44 
	gID_GENERATOR
: 
AtomicUsize
 = AtomicUsize::
Ãw
(1);

46 cÚ¡ 
	gTYPE_VAR_CHAR
: 
i32
 = 1;

47 cÚ¡ 
	gTYPE_LONG
: 
i32
 = 2;

49 
pub
 
â
 
Ãxt_id
(è-> 
	gi64
 {

50 
	gID_GENERATOR
.
ãtch_add
(1, 
Ord”šg
::
R–axed
è
as
 
i64


53 
â
 
row_út
(
chunks
: &[
Chunk
]è-> 
usize
 {

54 
chunks
.
™”
().
fŞd
(0, |
l
, 
r
|† +„.
g‘_rows_m‘a
().
Ën
())

57 
â
 
	$check_chunk_d©um_couÁ
(
chunks
: &[
Chunk
], 
d©um_lim™
: 
usize
) {

58 
Ët
 
mut
 
™”
 = 
chunks
.
	`™”
();

59 
Ët
 
»s
 = 
™”
.
	`ªy
(|
x
| x.
	`g‘_rows_d©a
().
	`decode
().
	`unw¿p
().
	`Ën
(è!ğ
d©um_lim™
);

60 
»s
 {

61 
as£¹
!(
™”
.
	`Ãxt
().
	`is_nÚe
());

63 
	}
}

65 
	sRow
 {

66 
	mhªdË
: 
i64
,

67 
	md©a
: 
Vec
<
u8
>,

70 #[
d”ive
(
Debug
)]

71 
	sChunkS¶™”
 {

72 
	mchunk
: 
Vec
<
Chunk
>,

73 
	m»aded
: 
usize
,

74 
	midx
: 
usize
,

77 
im¶
 
	gChunkS¶™”
 {

78 
â
 
Ãw
(
chunk
: 
Vec
<
Chunk
>è-> 
ChunkS¶™”
 {

79 
ChunkS¶™”
 {

80 
chunk
: chunk,

81 
	g»aded
: 0,

82 
	gidx
: 0,

87 
im¶
 
I‹¿tÜ
 
	gChunkS¶™”
 {

88 
ty³
 
	gI‹m
 = 
Row
;

90 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gRow
> {

91 
	gloİ
 {

92 
	g£lf
.
	gchunk
.
is_em±y
() {

93  
	gNÚe
;

95 
	g£lf
.
	gidx
 =ğ
£lf
.
chunk
[0].
g‘_rows_m‘a
().
Ën
() {

96 
as£¹_eq
!(
£lf
.
»aded
, s–f.
chunk
[0].
g‘_rows_d©a
().
Ën
());

97 
	g£lf
.
	gidx
 = 0;

98 
	g£lf
.
	g»aded
 = 0;

99 
	g£lf
.
	gchunk
.
»move
(0);

102 
Ët
 
	gm‘as
 = 
£lf
.
chunk
[0].
g‘_rows_m‘a
();

103 
Ët
 
	gd©a
 = 
£lf
.
chunk
[0].
g‘_rows_d©a
();

104 
Ët
 
	gd©a_Ën
 = 
m‘as
[
£lf
.
idx
].
g‘_Ëngth
();

105 
Ët
 
	grow
 = 
Row
 {

106 
hªdË
: 
m‘as
[
£lf
.
idx
].
g‘_hªdË
(),

107 
d©a
: d©a[
£lf
.
»aded
..£lf.»aded + 
d©a_Ën
 
as
 
usize
].
to_vec
(),

109 
	g£lf
.
	g»aded
 +ğ
d©a_Ën
 
as
 
usize
;

110 
	g£lf
.
	gidx
 += 1;

111  
Some
(
row
);

116 
	sDAGChunkS¶™”
 {

117 
	mchunks
: 
Vec
<
Chunk
>,

118 
	md©ums
: 
Vec
<
D©um
>,

119 
	mcŞ_út
: 
usize
,

122 
im¶
 
	gDAGChunkS¶™”
 {

123 
â
 
Ãw
(
chunks
: 
Vec
<
Chunk
>, 
cŞ_út
: 
usize
è-> 
DAGChunkS¶™”
 {

124 
DAGChunkS¶™”
 {

125 
chunks
: chunks,

126 
	gcŞ_út
: 
cŞ_út
,

127 
	gd©ums
: 
Vec
::
w™h_ÿ·c™y
(0),

132 
im¶
 
I‹¿tÜ
 
	gDAGChunkS¶™”
 {

133 
ty³
 
	gI‹m
 = 
Vec
<
D©um
>;

135 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gO±iÚ
<
	gVec
<
	gD©um
>> {

136 
	gloİ
 {

137 
	g£lf
.
	gchunks
.
is_em±y
(è&& s–f.
	gd©ums
.is_empty() {

138  
	gNÚe
;

139 } 
	g£lf
.
	gd©ums
.
is_em±y
() {

140 
Ët
 
	gchunk
 = 
£lf
.
chunks
.
»move
(0);

141 
Ët
 
mut
 
	gd©a
 = 
chunk
.
g‘_rows_d©a
();

142 
	g£lf
.
	gd©ums
 = 
d©a
.
decode
().
unw¿p
();

145 
	gas£¹_eq
!(
	g£lf
.
	gd©ums
.
Ën
(è>ğ
£lf
.
cŞ_út
, 
	gŒue
);

146 
Ët
 
mut
 
	gcŞs
 = 
£lf
.
d©ums
.
¥l™_off
(£lf.
cŞ_út
);

147 
	gmem
::
sw­
(&
mut
 
£lf
.
d©ums
, &muˆ
cŞs
);

148  
Some
(
cŞs
);

153 #[
d”ive
(
ClÚe
, 
Cİy
)]

154 
pub
 
	sCŞumn
 {

155 
	mid
: 
i64
,

156 
	mcŞ_ty³
: 
i32
,

158 
pub
 
	mšdex
: 
i64
,

159 
	mdeçuÉ_v®
: 
O±iÚ
<
i64
>,

162 
	sCŞumnBud”
 {

163 
	mcŞ_ty³
: 
i32
,

164 
	mšdex
: 
i64
,

165 
	mdeçuÉ_v®
: 
O±iÚ
<
i64
>,

168 
im¶
 
	gCŞumnBud”
 {

169 
â
 
Ãw
(è-> 
	gCŞumnBud”
 {

170 
	gCŞumnBud”
 {

171 
	gcŞ_ty³
: 
TYPE_LONG
,

172 
	gšdex
: -1,

173 
	gdeçuÉ_v®
: 
NÚe
,

177 
â
 
cŞ_ty³
(
mut
 
£lf
, 
t
: 
i32
è-> 
CŞumnBud”
 {

178 
£lf
.
cŞ_ty³
 = 
t
;

179 
	g£lf


182 
â
 
´im¬y_key
(
mut
 
£lf
, 
b
: 
boŞ
è-> 
CŞumnBud”
 {

183 
b
 {

184 
£lf
.
šdex
 = 0;

186 
	g£lf
.
	gšdex
 = -1;

188 
	g£lf


191 
â
 
šdex_key
(
mut
 
£lf
, 
idx_id
: 
i64
è-> 
CŞumnBud”
 {

192 
£lf
.
šdex
 = 
idx_id
;

193 
	g£lf


196 
â
 (
mut
 
	g£lf
, 
	gv®
: 
i64
è-> 
CŞumnBud”
 {

197 
£lf
.
deçuÉ_v®
 = 
Some
(
v®
);

198 
	g£lf


201 
â
 
bud
(
£lf
è-> 
	gCŞumn
 {

202 
	gCŞumn
 {

203 
	gid
: 
Ãxt_id
(),

204 
	gcŞ_ty³
: 
£lf
.
cŞ_ty³
,

205 
	gšdex
: 
£lf
.
šdex
,

206 
	gdeçuÉ_v®
: 
£lf
.
deçuÉ_v®
,

211 
pub
 
	sTabË
 {

212 
	mid
: 
i64
,

213 
	mhªdË_id
: 
i64
,

214 
	mcŞs
: 
BT»eM­
<
i64
, 
	mCŞumn
>,

215 
	midxs
: 
BT»eM­
<
i64
, 
	mVec
<
	mi64
>>,

218 
im¶
 
	gTabË
 {

219 
â
 
g‘_bË_šfo
(&
£lf
è-> 
	gschema
::
TabËInfo
 {

220 
Ët
 
mut
 
tb_šfo
 = 
schema
::
TabËInfo
::
Ãw
();

221 
	gtb_šfo
.
£t_bË_id
(
£lf
.
id
);

222 
	gtb_šfo
.
£t_cŞumns
(
R•—‹dF›ld
::
äom_vec
(
£lf
.
g‘_bË_cŞumns
()));

223 
	gtb_šfo


226 
pub
 
â
 
g‘_bË_cŞumns
(&
£lf
è-> 
	gVec
<
	gCŞumnInfo
> {

227 
Ët
 
mut
 
	gtb_šfo
 = 
Vec
::
Ãw
();

228 
cŞ
 
š
 
	g£lf
.
	gcŞs
.
v®ues
() {

229 
Ët
 
mut
 
	gc_šfo
 = 
CŞumnInfo
::
Ãw
();

230 
	gc_šfo
.
£t_cŞumn_id
(
cŞ
.
id
);

231 
	gc_šfo
.
£t_
(
cŞ
.
cŞ_ty³
);

232 
	gc_šfo
.
£t_pk_hªdË
(
cŞ
.
šdex
 == 0);

233 
Ët
 
Some
(
dv
èğ
cŞ
.
deçuÉ_v®
 {

234 
c_šfo
.
£t_deçuÉ_v®
(
d©um
::
’code_v®ue
(&[
D©um
::
I64
(
dv
)]).
unw¿p
())

236 
tb_šfo
.
push
(
c_šfo
);

238 
	gtb_šfo


241 
â
 
g‘_šdex_šfo
(&
£lf
, 
šdex
: 
i64
, 
¡Üe_hªdË
: 
boŞ
è-> 
schema
::
IndexInfo
 {

242 
Ët
 
mut
 
idx_šfo
 = 
schema
::
IndexInfo
::
Ãw
();

243 
	gidx_šfo
.
£t_bË_id
(
£lf
.
id
);

244 
	gidx_šfo
.
£t_šdex_id
(
šdex
);

245 
Ët
 
mut
 
	ghas_pk
 = 
çl£
;

246 
cŞ_id
 
	gš
 &
	g£lf
.
	gidxs
[&
šdex
] {

247 
Ët
 
	gcŞ
 = 
£lf
.
cŞs
[
cŞ_id
];

248 
Ët
 
mut
 
	gc_šfo
 = 
CŞumnInfo
::
Ãw
();

249 
	gc_šfo
.
£t_
(
cŞ
.
cŞ_ty³
);

250 
	gc_šfo
.
£t_cŞumn_id
(
cŞ
.
id
);

251 
	gcŞ
.
	gid
 =ğ
£lf
.
hªdË_id
 {

252 
c_šfo
.
£t_pk_hªdË
(
Œue
);

253 
	ghas_pk
 = 
Œue


255 
	gidx_šfo
.
mut_cŞumns
().
push
(
c_šfo
);

257 !
	ghas_pk
 && 
	g¡Üe_hªdË
 {

258 
Ët
 
mut
 
	ghªdË_šfo
 = 
CŞumnInfo
::
Ãw
();

259 
	ghªdË_šfo
.
£t_
(
TYPE_LONG
);

260 
	ghªdË_šfo
.
£t_cŞumn_id
(-1);

261 
	ghªdË_šfo
.
£t_pk_hªdË
(
Œue
);

262 
	gidx_šfo
.
mut_cŞumns
().
push
(
hªdË_šfo
);

264 
	gidx_šfo


267 
pub
 
â
 
g‘_£Ëù_¿nge
(&
£lf
è-> 
	gKeyRªge
 {

268 
Ët
 
mut
 
	g¿nge
 = 
KeyRªge
::
Ãw
();

269 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(8);

270 
	gbuf
.
’code_i64
(
i64
::
MIN
).
unw¿p
();

271 
	g¿nge
.
£t_¡¬t
(
bË
::
’code_row_key
(
£lf
.
id
, &
buf
));

272 
	gbuf
.
ş—r
();

273 
	gbuf
.
’code_i64
(
i64
::
MAX
).
unw¿p
();

274 
	g¿nge
.
£t_’d
(
bË
::
’code_row_key
(
£lf
.
id
, &
buf
));

275 
	g¿nge


278 
pub
 
â
 
g‘_šdex_¿nge
(&
£lf
, 
idx
: 
i64
è-> 
KeyRªge
 {

279 
Ët
 
mut
 
¿nge
 = 
KeyRªge
::
Ãw
();

280 
Ët
 
mut
 
	gbuf
 = 
Vec
::
w™h_ÿ·c™y
(8);

281 
	gbuf
.
’code_i64
(
i64
::
MIN
).
unw¿p
();

282 
	g¿nge
.
£t_¡¬t
(
bË
::
’code_šdex_£ek_key
(
£lf
.
id
, 
idx
, &
buf
));

283 
	gbuf
.
ş—r
();

284 
	gbuf
.
’code_i64
(
i64
::
MAX
).
unw¿p
();

285 
	g¿nge
.
£t_’d
(
bË
::
’code_šdex_£ek_key
(
£lf
.
id
, 
idx
, &
buf
));

286 
	g¿nge


290 
	sTabËBud”
 {

291 
	mhªdË_id
: 
i64
,

292 
	mcŞs
: 
BT»eM­
<
i64
, 
	mCŞumn
>,

295 
im¶
 
	gTabËBud”
 {

296 
â
 
Ãw
(è-> 
	gTabËBud”
 {

297 
	gTabËBud”
 {

298 
	ghªdË_id
: -1,

299 
	gcŞs
: 
BT»eM­
::
Ãw
(),

303 
â
 
add_cŞ
(
mut
 
£lf
, 
cŞ
: 
CŞumn
è-> 
TabËBud”
 {

304 
cŞ
.
šdex
 == 0 {

305 
£lf
.
hªdË_id
 > 0 {

306 
£lf
.
hªdË_id
 = 0;

307 } 
	g£lf
.
	ghªdË_id
 < 0 {

309 
	g£lf
.
	ghªdË_id
 = 
cŞ
.
id
;

312 
	g£lf
.
	gcŞs
.
š£¹
(
cŞ
.
id
, col);

313 
	g£lf


316 
â
 
bud
(
mut
 
£lf
è-> 
	gTabË
 {

317 
	g£lf
.
	ghªdË_id
 <= 0 {

318 
£lf
.
hªdË_id
 = 
Ãxt_id
();

320 
Ët
 
mut
 
	gidx
 = 
BT»eM­
::
Ãw
();

321 &
	gid
, 
	gcŞ
è
	gš
 &
	g£lf
.
	gcŞs
 {

322 
	gcŞ
.
	gšdex
 < 0 {

325 
Ët
 
	ge
 = 
idx
.
’Œy
(
cŞ
.
šdex
).
Ü_š£¹_w™h
(
Vec
::
Ãw
);

326 
	ge
.
push
(
id
);

328 
	gid
, 
	gv®
è
	gš
 &
mut
 
	gidx
 {

329 *
	gid
 == 0 {

333 
	gv®
.
push
(
£lf
.
hªdË_id
);

335 
	gTabË
 {

336 
	gid
: 
Ãxt_id
(),

337 
	ghªdË_id
: 
£lf
.
hªdË_id
,

338 
	gcŞs
: 
£lf
.
cŞs
,

339 
	gidxs
: 
idx
,

344 
	gIn£¹
<'a> {

345 
	g¡Üe
: &'a mut Store,

346 
bË
: &'a Table,

347 
v®ues
: 
BT»eM­
<
i64
, 
	gD©um
>,

350 
	gim¶
<'a> In£¹<'
	ga
> {

351 
â
 
Ãw
(
¡Üe
: &'¨muˆStÜe,abË: &'
a
 
TabË
è-> 
In£¹
<'a> {

352 
In£¹
 {

353 
¡Üe
: store,

354 
	gbË
: 
bË
,

355 
	gv®ues
: 
BT»eM­
::
Ãw
(),

359 
â
 
£t
(
mut
 
£lf
, 
cŞ
: 
CŞumn
, 
v®ue
: 
D©um
è-> 
In£¹
<'a> {

360 
as£¹
!(
£lf
.
bË
.
cŞs
.
cÚšs_key
(&
cŞ
.
id
));

361 
	g£lf
.
	gv®ues
.
š£¹
(
cŞ
.
id
, 
v®ue
);

362 
	g£lf


365 
â
 
execu‹
(
£lf
è-> 
	gi64
 {

366 
	g£lf
.
execu‹_w™h_ùx
(
CÚ‹xt
::
Ãw
())

369 
â
 
execu‹_w™h_ùx
(
£lf
, 
ùx
: 
CÚ‹xt
è-> 
i64
 {

370 
Ët
 
hªdË
 = 
£lf
.
v®ues


371 .
g‘
(&
£lf
.
bË
.
hªdË_id
)

372 .
şÚed
()

373 .
unw¿p_Ü_–£
(|| 
D©um
::
I64
(
Ãxt_id
()));

374 
Ët
 
	gkey
 = 
bud_row_key
(
£lf
.
bË
.
id
, 
hªdË
.
i64
());

375 
Ët
 
	gids
: 
Vec
<
_
> = 
£lf
.
v®ues
.
keys
().
şÚed
().
cŞËù
();

376 
Ët
 
	gv®ues
: 
Vec
<
_
> = 
£lf
.
v®ues
.v®ues().
şÚed
().
cŞËù
();

377 
Ët
 
	gv®ue
 = 
bË
::
’code_row
(
v®ues
, &
ids
).
unw¿p
();

378 
Ët
 
mut
 
	gkvs
 = 
vec
![];

379 
	gkvs
.
push
((
key
, 
v®ue
));

380 &
	gid
, 
	gidxs
è
	gš
 &
	g£lf
.
	gbË
.idxs {

381 
Ët
 
mut
 
	gv
: 
Vec
<
_
> = 
idxs
.
™”
().
m­
(|
id
| 
£lf
.
v®ues
[id].
şÚe
()).
cŞËù
();

382 
	gv
.
push
(
hªdË
.
şÚe
());

383 
Ët
 
	g’coded
 = 
d©um
::
’code_key
(&
v
).
unw¿p
();

384 
Ët
 
	gidx_key
 = 
bË
::
’code_šdex_£ek_key
(
£lf
.bË.
id
, id, &
’coded
);

385 
	gkvs
.
push
((
idx_key
, 
vec
![0]));

387 
	g£lf
.
	g¡Üe
.
put
(
ùx
, 
kvs
);

388 
	ghªdË
.
i64
()

392 
	gS–eù
<'a> {

393 
	gbË
: &'a Table,

394 
£l
: 
S–eùReque¡
,

395 
	gidx
: 
i64
,

398 
	gim¶
<'a> S–eù<'
	ga
> {

399 
â
 
äom
(
bË
: &'¨TabËè-> S–eù<'
a
> {

400 
S–eù
::
Ãw
(
bË
, 
NÚe
)

403 
â
 
äom_šdex
(
bË
: &'¨TabË, index: CŞumnè-> S–eù<'
a
> {

404 
S–eù
::
Ãw
(
bË
, 
Some
(
šdex
))

407 
â
 
Ãw
(
bË
: &'¨TabË, idx: O±iÚ<CŞumn>è-> S–eù<'
a
> {

408 
Ët
 
mut
 
£l
 = 
S–eùReque¡
::
Ãw
();

409 
£l
.
£t_¡¬t_ts
(
Ãxt_id
(è
as
 
u64
);

411 
S–eù
 {

412 
bË
:able,

413 
£l
: sel,

414 
idx
: idx.
m­_Ü
(-1, |
c
| c.
šdex
),

418 
â
 
lim™
(
mut
 
£lf
, 
n
: 
i64
è-> 
S–eù
<'a> {

419 
£lf
.
£l
.
£t_lim™
(
n
);

420 
£lf


423 
â
 
Üd”_by_pk
(
mut
 
£lf
, 
desc
: 
boŞ
è-> 
S–eù
<'a> {

424 
Ët
 
mut
 
™em
 = 
ByI‹m
::
Ãw
();

425 
™em
.
£t_desc
(
desc
);

426 
£lf
.
£l
.
mut_Üd”_by
().
push
(
™em
);

427 
£lf


430 
â
 
Üd”_by
(
mut
 
£lf
, 
cŞ
: 
CŞumn
, 
desc
: 
boŞ
è-> 
S–eù
<'a> {

431 
Ët
 
mut
 
™em
 = 
ByI‹m
::
Ãw
();

432 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

433 
ex´
.
£t_
(
Ex´Ty³
::
CŞumnRef
);

434 
ex´
.
mut_v®
().
’code_i64
(
cŞ
.
id
).
unw¿p
();

435 
™em
.
£t_ex´
(
ex´
);

436 
™em
.
£t_desc
(
desc
);

437 
£lf
.
£l
.
mut_Üd”_by
().
push
(
™em
);

438 
£lf


441 
â
 
couÁ
(
mut
 
£lf
è-> 
S–eù
<'a> {

442 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

443 
ex´
.
£t_
(
Ex´Ty³
::
CouÁ
);

444 
£lf
.
£l
.
mut_agg»g©es
().
push
(
ex´
);

445 
£lf


448 
â
 
aggr_cŞ
(
mut
 
£lf
, 
cŞ
: 
CŞumn
, 
aggr_t
: 
Ex´Ty³
è-> 
S–eù
<'a> {

449 
Ët
 
mut
 
cŞ_ex´
 = 
Ex´
::
Ãw
();

450 
cŞ_ex´
.
£t_
(
Ex´Ty³
::
CŞumnRef
);

451 
cŞ_ex´
.
mut_v®
().
’code_i64
(
cŞ
.
id
).
unw¿p
();

452 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

453 
ex´
.
£t_
(
aggr_t
);

454 
ex´
.
mut_chd»n
().
push
(
cŞ_ex´
);

455 
£lf
.
£l
.
mut_agg»g©es
().
push
(
ex´
);

456 
£lf


459 
â
 
fœ¡
(
£lf
, 
cŞ
: 
CŞumn
è-> 
S–eù
<'a> {

460 
£lf
.
aggr_cŞ
(
cŞ
, 
Ex´Ty³
::
Fœ¡
)

463 
â
 
sum
(
£lf
, 
cŞ
: 
CŞumn
è-> 
S–eù
<'a> {

464 
£lf
.
aggr_cŞ
(
cŞ
, 
Ex´Ty³
::
Sum
)

467 
â
 
avg
(
£lf
, 
cŞ
: 
CŞumn
è-> 
S–eù
<'a> {

468 
£lf
.
aggr_cŞ
(
cŞ
, 
Ex´Ty³
::
Avg
)

471 
â
 
max
(
£lf
, 
cŞ
: 
CŞumn
è-> 
S–eù
<'a> {

472 
£lf
.
aggr_cŞ
(
cŞ
, 
Ex´Ty³
::
Max
)

475 
â
 
mš
(
£lf
, 
cŞ
: 
CŞumn
è-> 
S–eù
<'a> {

476 
£lf
.
aggr_cŞ
(
cŞ
, 
Ex´Ty³
::
Mš
)

479 
â
 
group_by
(
mut
 
£lf
, 
cŞs
: &[
CŞumn
]è-> 
S–eù
<'a> {

480 
cŞ
 
š
 
cŞs
 {

481 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

482 
ex´
.
£t_
(
Ex´Ty³
::
CŞumnRef
);

483 
ex´
.
mut_v®
().
’code_i64
(
cŞ
.
id
).
unw¿p
();

484 
Ët
 
mut
 
™em
 = 
ByI‹m
::
Ãw
();

485 
™em
.
£t_ex´
(
ex´
);

486 
£lf
.
£l
.
mut_group_by
().
push
(
™em
);

488 
£lf


491 
â
 
wh”e_ex´
(
mut
 
£lf
, 
ex´
: 
Ex´
è-> 
S–eù
<'a> {

492 
£lf
.
£l
.
£t_f›ld_wh”e
(
ex´
);

493 
£lf


496 
â
 
bud
(
£lf
è-> 
Reque¡
 {

497 
£lf
.
bud_w™h
(&[0])

500 
â
 
bud_w™h
(
£lf
, 
æags
: &[
u64
]è-> 
Reque¡
 {

501 
£lf
.
bud_w™h_ùx_ªd_æags
(
CÚ‹xt
::
Ãw
(), 
æags
)

504 
â
 
bud_w™h_ùx_ªd_æags
(
mut
 
£lf
, 
ùx
: 
CÚ‹xt
, 
æags
: &[
u64
]è-> 
Reque¡
 {

505 
Ët
 
mut
 
»q
 = 
Reque¡
::
Ãw
();

507 
»q
.
£t_cÚ‹xt
(
ùx
);

508 
£lf
.
idx
 < 0 {

509 
£lf
.
£l
.
£t_bË_šfo
(£lf.
bË
.
g‘_bË_šfo
());

510 
»q
.
£t_
(
REQ_TYPE_SELECT
);

512 
£lf
.
£l


513 .
£t_šdex_šfo
(
£lf
.
bË
.
g‘_šdex_šfo
(£lf.
idx
, 
çl£
));

514 
»q
.
£t_
(
REQ_TYPE_INDEX
);

516 
£lf
.
£l
.
£t_æags
(
æags
.
™”
().
fŞd
(0, |
acc
, 
f
|‡cc | *f));

517 
»q
.
£t_d©a
(
£lf
.
£l
.
wr™e_to_by‹s
().
unw¿p
());

518 
Ët
 
¿nge
 = 
£lf
.
idx
 < 0 {

519 
£lf
.
bË
.
g‘_£Ëù_¿nge
()

521 
£lf
.
bË
.
g‘_šdex_¿nge
(£lf.
idx
)

523 
»q
.
£t_¿nges
(
R•—‹dF›ld
::
äom_vec
(
vec
![
¿nge
]));

524 
»q


528 
D–‘e
<'a> {

529 
¡Üe
: &'a mut Store,

530 
bË
: &'a Table,

533 
im¶
<'a> D–‘e<'
a
> {

534 
â
 
Ãw
(
¡Üe
: &'¨muˆStÜe,abË: &'
a
 
TabË
è-> 
D–‘e
<'a> {

535 
D–‘e
 {

536 
¡Üe
: store,

537 
bË
:able,

541 
â
 
execu‹
(
£lf
, 
id
: 
i64
, 
row
: 
Vec
<
D©um
>) {

542 
Ët
 
mut
 
v®ues
 = 
HashM­
::
Ãw
();

543 &
id
, 
v
è
š
 
£lf
.
bË
.
cŞs
.
keys
().
z
(
row
) {

544 
v®ues
.
š£¹
(
id
, 
v
);

546 
Ët
 
key
 = 
bud_row_key
(
£lf
.
bË
.
id
, id);

547 
Ët
 
mut
 
keys
 = 
vec
![];

548 
keys
.
push
(
key
);

549 &
idx_id
, 
idx_cŞs
è
š
 &
£lf
.
bË
.
idxs
 {

550 
Ët
 
mut
 
v
: 
Vec
<
_
> = 
idx_cŞs
.
™”
().
m­
(|
id
| 
v®ues
[id].
şÚe
()).
cŞËù
();

551 
v
.
push
(
D©um
::
I64
(
id
));

552 
Ët
 
’coded
 = 
d©um
::
’code_key
(&
v
).
unw¿p
();

553 
Ët
 
idx_key
 = 
bË
::
’code_šdex_£ek_key
(
£lf
.bË.
id
, 
idx_id
, &
’coded
);

554 
keys
.
push
(
idx_key
);

556 
£lf
.
¡Üe
.
d–‘e
(
keys
);

560 
pub
 
	sStÜe
 {

561 
¡Üe
: 
SyncStÜage
,

562 
cu¼’t_ts
: 
u64
,

563 
hªdËs
: 
Vec
<Vec<
u8
>>,

566 
im¶
 
StÜe
 {

567 
â
 
Ãw
(
’gše
: 
Box
<
Engše
>è-> 
StÜe
 {

568 
StÜe
 {

569 
¡Üe
: 
SyncStÜage
::
äom_’gše
(
’gše
, &
DeçuÉ
::()),

570 
cu¼’t_ts
: 1,

571 
hªdËs
: 
vec
![],

575 
â
 
g‘_’gše
(&
£lf
è-> 
Box
<
Engše
> {

576 
£lf
.
¡Üe
.
g‘_’gše
()

579 
â
 
begš
(&
mut
 
£lf
) {

580 
£lf
.
cu¼’t_ts
 = 
Ãxt_id
(è
as
 
u64
;

581 
£lf
.
hªdËs
.
ş—r
();

584 
â
 
š£¹_što
<'a>(&'
a
 
mut
 
£lf
, 
bË
: &'a Table) -> Insert<'a> {

585 
In£¹
::
Ãw
(
£lf
, 
bË
)

588 
â
 
put
(&
mut
 
£lf
, 
ùx
: 
CÚ‹xt
, muˆ
kv
: 
Vec
<(Vec<
u8
>, Vec<u8>)>) {

589 
£lf
.
hªdËs
.
ex‹nd
(
kv
.
™”
().
m­
(|&(
»f
 
k
, 
_
)| k.
şÚe
()));

590 
Ët
 
pk
 = 
kv
[0].0.ş
Úe
();

591 
Ët
 
kv
 = kv.
d¿š
(..)

592 .
m­
(|(
k
, 
v
)| 
MutiÚ
::
Put
((
Key
::
äom_¿w
(&k), v)))

593 .
cŞËù
();

594 
£lf
.
¡Üe
.
´ewr™e
(
ùx
, 
kv
, 
pk
, s–f.
cu¼’t_ts
).
unw¿p
();

597 
â
 
d–‘e_äom
<'a>(&'
a
 
mut
 
£lf
, 
bË
: &'a Table) -> Delete<'a> {

598 
D–‘e
::
Ãw
(
£lf
, 
bË
)

601 
â
 
d–‘e
(&
mut
 
£lf
, muˆ
keys
: 
Vec
<Vec<
u8
>>) {

602 
£lf
.
hªdËs
.
ex‹nd
(
keys
.
şÚe
());

603 
Ët
 
pk
 = 
keys
[0].
şÚe
();

604 
Ët
 
mutiÚs
 = 
keys
.
d¿š
(..)

605 .
m­
(|
k
| 
MutiÚ
::
D–‘e
(
Key
::
äom_¿w
(&k)))

606 .
cŞËù
();

607 
£lf
.
¡Üe


608 .
´ewr™e
(
CÚ‹xt
::
Ãw
(), 
mutiÚs
, 
pk
, 
£lf
.
cu¼’t_ts
)

609 .
unw¿p
();

612 
â
 
comm™
(&
mut
 
£lf
) {

613 
£lf
.
comm™_w™h_ùx
(
CÚ‹xt
::
Ãw
());

616 
â
 
comm™_w™h_ùx
(&
mut
 
£lf
, 
ùx
: 
CÚ‹xt
) {

617 
Ët
 
hªdËs
 = 
£lf
.hªdËs.
d¿š
(..).
m­
(|
x
| 
Key
::
äom_¿w
(&x)).
cŞËù
();

618 
£lf
.
¡Üe


619 .
comm™
(
ùx
, 
hªdËs
, 
£lf
.
cu¼’t_ts
, 
Ãxt_id
(è
as
 
u64
)

620 .
unw¿p
();

625 
â
 
bud_row_key
(
bË_id
: 
i64
, 
id
: i64è-> 
Vec
<
u8
> {

626 
Ët
 
mut
 
buf
 = [0; 8];

627 (&
mut
 
buf
 
as
 &muˆ[
u8
]).
’code_i64
(
id
).
unw¿p
();

628 
bË
::
’code_row_key
(
bË_id
, &
buf
)

632 
pub
 
	sProduùTabË
 {

633 
id
: 
CŞumn
,

634 
pub
 
Çme
: 
CŞumn
,

635 
pub
 
couÁ
: 
CŞumn
,

636 
pub
 
bË
: 
TabË
,

639 
im¶
 
ProduùTabË
 {

640 
pub
 
â
 
Ãw
(è-> 
ProduùTabË
 {

641 
Ët
 
id
 = 
CŞumnBud”
::
Ãw
()

642 .
cŞ_ty³
(
TYPE_LONG
)

643 .
´im¬y_key
(
Œue
)

644 .
bud
();

645 
Ët
 
idx_id
 = 
Ãxt_id
();

646 
Ët
 
Çme
 = 
CŞumnBud”
::
Ãw
()

647 .
cŞ_ty³
(
TYPE_VAR_CHAR
)

648 .
šdex_key
(
idx_id
)

649 .
bud
();

650 
Ët
 
couÁ
 = 
CŞumnBud”
::
Ãw
()

651 .
cŞ_ty³
(
TYPE_LONG
)

652 .
šdex_key
(
idx_id
)

653 .
bud
();

654 
Ët
 
bË
 = 
TabËBud”
::
Ãw
()

655 .
add_cŞ
(
id
)

656 .
add_cŞ
(
Çme
)

657 .
add_cŞ
(
couÁ
)

658 .
bud
();

660 
ProduùTabË
 {

661 
id
: id,

662 
Çme
:‚ame,

663 
couÁ
: count,

664 
bË
:able,

669 
â
 
š™_d©a_w™h_’gše_ªd_comm™
(

670 
ùx
: 
CÚ‹xt
,

671 
’gše
: 
Box
<
Engše
>,

672 
tbl
: &
ProduùTabË
,

673 
v®s
: &[(
i64
, 
O±iÚ
<&
¡r
>, i64)],

674 
comm™
: 
boŞ
,

675 è-> (
StÜe
, 
WÜk”
<
EndPoštTask
>) {

676 
š™_d©a_w™h_d‘as
(
ùx
, 
’gše
, 
tbl
, 
v®s
, 
comm™
, 
CÚfig
::())

679 
â
 
š™_d©a_w™h_d‘as
(

680 
ùx
: 
CÚ‹xt
,

681 
’gše
: 
Box
<
Engše
>,

682 
tbl
: &
ProduùTabË
,

683 
v®s
: &[(
i64
, 
O±iÚ
<&
¡r
>, i64)],

684 
comm™
: 
boŞ
,

685 
cfg
: 
CÚfig
,

686 è-> (
StÜe
, 
WÜk”
<
EndPoštTask
>) {

687 
Ët
 
mut
 
¡Üe
 = 
StÜe
::
Ãw
(
’gše
);

689 
¡Üe
.
begš
();

690 &(
id
, 
Çme
, 
couÁ
è
š
 
v®s
 {

691 
¡Üe


692 .
š£¹_što
(&
tbl
.
bË
)

693 .
£t
(
tbl
.
id
, 
D©um
::
I64
(id))

694 .
£t
(
tbl
.
Çme
,‚ame.
m­
(|
s
| s.
as_by‹s
()).
što
())

695 .
£t
(
tbl
.
couÁ
, 
D©um
::
I64
(count))

696 .
execu‹_w™h_ùx
(
ùx
.
şÚe
());

698 
comm™
 {

699 
¡Üe
.
comm™_w™h_ùx
(
ùx
);

701 
Ët
 
mut
 
’d_pošt
 = 
WÜk”
::
Ãw
("test select worker");

702 
Ët
 
pd_wÜk”
 = 
Futu»WÜk”
::
Ãw
("test…d worker");

703 
Ët
 
ruÂ”
 = 
EndPoštHo¡
::
Ãw
(

704 
¡Üe
.
g‘_’gše
(),

705 
’d_pošt
.
scheduËr
(),

706 &
cfg
,

707 
pd_wÜk”
.
scheduËr
(),

709 
’d_pošt
.
¡¬t_b©ch
(
ruÂ”
, 5).
unw¿p
();

711 (
¡Üe
, 
’d_pošt
)

714 
pub
 
â
 
š™_d©a_w™h_comm™
(

715 
tbl
: &
ProduùTabË
,

716 
v®s
: &[(
i64
, 
O±iÚ
<&
¡r
>, i64)],

717 
comm™
: 
boŞ
,

718 è-> (
StÜe
, 
WÜk”
<
EndPoštTask
>) {

719 
Ët
 
’gše
 =ƒngše::
Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
unw¿p
();

720 
š™_d©a_w™h_’gše_ªd_comm™
(
CÚ‹xt
::
Ãw
(), 
’gše
, 
tbl
, 
v®s
, 
comm™
)

724 
â
 
š™_w™h_d©a
(

725 
tbl
: &
ProduùTabË
,

726 
v®s
: &[(
i64
, 
O±iÚ
<&
¡r
>, i64)],

727 è-> (
StÜe
, 
WÜk”
<
EndPoštTask
>) {

728 
š™_d©a_w™h_comm™
(
tbl
, 
v®s
, 
Œue
)

731 
â
 
off£t_fÜ_cŞumn
(
cŞs
: &[
CŞumnInfo
], 
cŞ_id
: 
i64
) -> i64 {

732 
off£t
, 
cŞumn
è
š
 
cŞs
.
™”
().
’um”©e
() {

733 
cŞumn
.
g‘_cŞumn_id
(è=ğ
cŞ_id
 {

734  
off£t
 
as
 
i64
;

737 0 
as
 
i64


740 
	sDAGS–eù
 {

741 
execs
: 
Vec
<
ExecutÜ
>,

742 
cŞs
: 
Vec
<
CŞumnInfo
>,

743 
Üd”_by
: 
Vec
<
ByI‹m
>,

744 
lim™
: 
O±iÚ
<
u64
>,

745 
agg»g©e
: 
Vec
<
Ex´
>,

746 
group_by
: 
Vec
<
Ex´
>,

747 
key_¿nge
: 
KeyRªge
,

748 
ouut_off£ts
: 
O±iÚ
<
Vec
<
u32
>>,

751 
im¶
 
DAGS–eù
 {

752 
â
 
äom
(
bË
: &
TabË
è-> 
DAGS–eù
 {

753 
Ët
 
mut
 
exec
 = 
ExecutÜ
::
Ãw
();

754 
exec
.
£t_
(
ExecTy³
::
Ty³TabËSÿn
);

755 
Ët
 
mut
 
tbl_sÿn
 = 
TabËSÿn
::
Ãw
();

756 
Ët
 
mut
 
bË_šfo
 = 
bË
.
g‘_bË_šfo
();

757 
tbl_sÿn
.
£t_bË_id
(
bË_šfo
.
g‘_bË_id
());

758 
Ët
 
cŞumns_šfo
 = 
bË_šfo
.
ke_cŞumns
();

759 
tbl_sÿn
.
£t_cŞumns
(
cŞumns_šfo
);

760 
exec
.
£t_tbl_sÿn
(
tbl_sÿn
);

762 
Ët
 
mut
 
¿nge
 = 
KeyRªge
::
Ãw
();

763 
Ët
 
mut
 
buf
 = 
Vec
::
w™h_ÿ·c™y
(8);

764 
buf
.
’code_i64
(
i64
::
MIN
).
unw¿p
();

765 
¿nge
.
£t_¡¬t
(
bË
::
’code_row_key
ÑabË.
id
, &
buf
));

766 
buf
.
ş—r
();

767 
buf
.
’code_i64
(
i64
::
MAX
).
unw¿p
();

768 
¿nge
.
£t_’d
(
bË
::
’code_row_key
ÑabË.
id
, &
buf
));

770 
DAGS–eù
 {

771 
execs
: 
vec
![
exec
],

772 
cŞs
: 
bË
.
g‘_bË_cŞumns
(),

773 
Üd”_by
: 
vec
![],

774 
lim™
: 
NÚe
,

775 
agg»g©e
: 
vec
![],

776 
group_by
: 
vec
![],

777 
key_¿nge
: 
¿nge
,

778 
ouut_off£ts
: 
NÚe
,

782 
â
 
äom_šdex
(
bË
: &
TabË
, 
šdex
: 
CŞumn
è-> 
DAGS–eù
 {

783 
Ët
 
idx
 = 
šdex
.index;

784 
Ët
 
mut
 
exec
 = 
ExecutÜ
::
Ãw
();

785 
exec
.
£t_
(
ExecTy³
::
Ty³IndexSÿn
);

786 
Ët
 
mut
 
sÿn
 = 
IndexSÿn
::
Ãw
();

787 
Ët
 
mut
 
šdex_šfo
 = 
bË
.
g‘_šdex_šfo
(
idx
, 
Œue
);

788 
sÿn
.
£t_bË_id
(
šdex_šfo
.
g‘_bË_id
());

789 
sÿn
.
£t_šdex_id
(
idx
);

791 
Ët
 
cŞumns_šfo
 = 
šdex_šfo
.
ke_cŞumns
();

792 
sÿn
.
£t_cŞumns
(
cŞumns_šfo
.
şÚe
());

793 
exec
.
£t_idx_sÿn
(
sÿn
);

795 
Ët
 
¿nge
 = 
bË
.
g‘_šdex_¿nge
(
idx
);

796 
DAGS–eù
 {

797 
execs
: 
vec
![
exec
],

798 
cŞs
: 
cŞumns_šfo
.
to_vec
(),

799 
Üd”_by
: 
vec
![],

800 
lim™
: 
NÚe
,

801 
agg»g©e
: 
vec
![],

802 
group_by
: 
vec
![],

803 
key_¿nge
: 
¿nge
,

804 
ouut_off£ts
: 
NÚe
,

808 
â
 
lim™
(
mut
 
£lf
, 
n
: 
u64
è-> 
DAGS–eù
 {

809 
£lf
.
lim™
 = 
Some
(
n
);

810 
£lf


813 
â
 
Üd”_by
(
mut
 
£lf
, 
cŞ
: 
CŞumn
, 
desc
: 
boŞ
è-> 
DAGS–eù
 {

814 
Ët
 
cŞ_off£t
 = 
off£t_fÜ_cŞumn
(&
£lf
.
cŞs
, 
cŞ
.
id
);

815 
Ët
 
mut
 
™em
 = 
ByI‹m
::
Ãw
();

816 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

817 
ex´
.
£t_
(
Ex´Ty³
::
CŞumnRef
);

818 
ex´
.
mut_v®
().
’code_i64
(
cŞ_off£t
).
unw¿p
();

819 
™em
.
£t_ex´
(
ex´
);

820 
™em
.
£t_desc
(
desc
);

821 
£lf
.
Üd”_by
.
push
(
™em
);

822 
£lf


825 
â
 
couÁ
(
mut
 
£lf
è-> 
DAGS–eù
 {

826 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

827 
ex´
.
£t_
(
Ex´Ty³
::
CouÁ
);

828 
£lf
.
agg»g©e
.
push
(
ex´
);

829 
£lf


832 
â
 
aggr_cŞ
(
mut
 
£lf
, 
cŞ
: 
CŞumn
, 
aggr_t
: 
Ex´Ty³
è-> 
DAGS–eù
 {

833 
Ët
 
cŞ_off£t
 = 
off£t_fÜ_cŞumn
(&
£lf
.
cŞs
, 
cŞ
.
id
);

834 
Ët
 
mut
 
cŞ_ex´
 = 
Ex´
::
Ãw
();

835 
cŞ_ex´
.
£t_
(
Ex´Ty³
::
CŞumnRef
);

836 
cŞ_ex´
.
mut_v®
().
’code_i64
(
cŞ_off£t
).
unw¿p
();

837 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

838 
ex´
.
£t_
(
aggr_t
);

839 
ex´
.
mut_chd»n
().
push
(
cŞ_ex´
);

840 
£lf
.
agg»g©e
.
push
(
ex´
);

841 
£lf


844 
â
 
fœ¡
(
£lf
, 
cŞ
: 
CŞumn
è-> 
DAGS–eù
 {

845 
£lf
.
aggr_cŞ
(
cŞ
, 
Ex´Ty³
::
Fœ¡
)

848 
â
 
sum
(
£lf
, 
cŞ
: 
CŞumn
è-> 
DAGS–eù
 {

849 
£lf
.
aggr_cŞ
(
cŞ
, 
Ex´Ty³
::
Sum
)

852 
â
 
avg
(
£lf
, 
cŞ
: 
CŞumn
è-> 
DAGS–eù
 {

853 
£lf
.
aggr_cŞ
(
cŞ
, 
Ex´Ty³
::
Avg
)

856 
â
 
max
(
£lf
, 
cŞ
: 
CŞumn
è-> 
DAGS–eù
 {

857 
£lf
.
aggr_cŞ
(
cŞ
, 
Ex´Ty³
::
Max
)

860 
â
 
mš
(
£lf
, 
cŞ
: 
CŞumn
è-> 
DAGS–eù
 {

861 
£lf
.
aggr_cŞ
(
cŞ
, 
Ex´Ty³
::
Mš
)

864 
â
 
group_by
(
mut
 
£lf
, 
cŞs
: &[
CŞumn
]è-> 
DAGS–eù
 {

865 
cŞ
 
š
 
cŞs
 {

866 
Ët
 
off£t
 = 
off£t_fÜ_cŞumn
(&
£lf
.
cŞs
, 
cŞ
.
id
);

867 
Ët
 
mut
 
ex´
 = 
Ex´
::
Ãw
();

868 
ex´
.
£t_
(
Ex´Ty³
::
CŞumnRef
);

869 
ex´
.
mut_v®
().
’code_i64
(
off£t
).
unw¿p
();

870 
£lf
.
group_by
.
push
(
ex´
);

872 
£lf


875 
â
 
ouut_off£ts
(
mut
 
£lf
, ouut_off£ts: 
O±iÚ
<
Vec
<
u32
>>è-> 
DAGS–eù
 {

876 
£lf
.
ouut_off£ts
 = output_offsets;

877 
£lf


880 
â
 
wh”e_ex´
(
mut
 
£lf
, 
ex´
: 
Ex´
è-> 
DAGS–eù
 {

881 
Ët
 
mut
 
exec
 = 
ExecutÜ
::
Ãw
();

882 
exec
.
£t_
(
ExecTy³
::
Ty³S–eùiÚ
);

883 
Ët
 
mut
 
£ËùiÚ
 = 
S–eùiÚ
::
Ãw
();

884 
£ËùiÚ
.
mut_cÚd™iÚs
().
push
(
ex´
);

885 
exec
.
£t_£ËùiÚ
(
£ËùiÚ
);

886 
£lf
.
execs
.
push
(
exec
);

887 
£lf


890 
â
 
bud
(
£lf
è-> 
Reque¡
 {

891 
£lf
.
bud_w™h
(&[0])

894 
â
 
bud_w™h
(
mut
 
£lf
, 
æags
: &[
u64
]è-> 
Reque¡
 {

895 !
£lf
.
agg»g©e
.
is_em±y
(è|| !£lf.
group_by
.is_empty() {

896 
Ët
 
mut
 
exec
 = 
ExecutÜ
::
Ãw
();

897 
exec
.
£t_
(
ExecTy³
::
Ty³Agg»g©iÚ
);

898 
Ët
 
mut
 
aggr
 = 
Agg»g©iÚ
::
Ãw
();

899 !
£lf
.
agg»g©e
.
is_em±y
() {

900 
aggr
.
£t_agg_func
(
R•—‹dF›ld
::
äom_vec
(
£lf
.
agg»g©e
));

903 !
£lf
.
group_by
.
is_em±y
() {

904 
aggr
.
£t_group_by
(
R•—‹dF›ld
::
äom_vec
(
£lf
.
group_by
));

906 
exec
.
£t_agg»g©iÚ
(
aggr
);

907 
£lf
.
execs
.
push
(
exec
);

910 !
£lf
.
Üd”_by
.
is_em±y
() {

911 
Ët
 
mut
 
exec
 = 
ExecutÜ
::
Ãw
();

912 
exec
.
£t_
(
ExecTy³
::
Ty³TİN
);

913 
Ët
 
mut
 
tİn
 = 
TİN
::
Ãw
();

914 
tİn
.
£t_Üd”_by
(
R•—‹dF›ld
::
äom_vec
(
£lf
.
Üd”_by
));

915 
Ët
 
Some
(
lim™
èğ
£lf
.lim™.
ke
() {

916 
tİn
.
£t_lim™
(
lim™
);

918 
exec
.
£t_tİN
(
tİn
);

919 
£lf
.
execs
.
push
(
exec
);

922 
Ët
 
Some
(
l
èğ
£lf
.
lim™
.
ke
() {

923 
Ët
 
mut
 
exec
 = 
ExecutÜ
::
Ãw
();

924 
exec
.
£t_
(
ExecTy³
::
Ty³Lim™
);

925 
Ët
 
mut
 
lim™
 = 
Lim™
::
Ãw
();

926 
lim™
.
£t_lim™
(
l
);

927 
exec
.
£t_lim™
(
lim™
);

928 
£lf
.
execs
.
push
(
exec
);

931 
Ët
 
mut
 
dag
 = 
DAGReque¡
::
Ãw
();

932 
dag
.
£t_executÜs
(
R•—‹dF›ld
::
äom_vec
(
£lf
.
execs
));

933 
dag
.
£t_¡¬t_ts
(
Ãxt_id
(è
as
 
u64
);

934 
dag
.
£t_æags
(
æags
.
™”
().
fŞd
(0, |
acc
, 
f
|‡cc | *f));

936 
Ët
 
ouut_off£ts
 = 
£lf
.ouut_off£ts.
is_some
() {

937 
£lf
.
ouut_off£ts
.
ke
().
unw¿p
()

939 (0..
£lf
.
cŞs
.
Ën
(è
as
 
u32
).
cŞËù
()

941 
dag
.
£t_ouut_off£ts
(
ouut_off£ts
);

943 
Ët
 
mut
 
»q
 = 
Reque¡
::
Ãw
();

944 
»q
.
£t_
(
REQ_TYPE_DAG
);

945 
»q
.
£t_d©a
(
dag
.
wr™e_to_by‹s
().
unw¿p
());

946 
»q
.
£t_¿nges
(
R•—‹dF›ld
::
äom_vec
(
vec
![
£lf
.
key_¿nge
]));

947 
»q


951 #[
‹¡
]

952 
â
 
	$‹¡_£Ëù
() {

953 
Ët
 
d©a
 = 
vec
![

954 (1, 
	`Some
("name:0"), 2),

955 (2, 
	`Some
("name:4"), 3),

956 (4, 
	`Some
("name:3"), 1),

957 (5, 
	`Some
("name:1"), 4),

960 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

961 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

964 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
).
	`bud
();

965 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

966 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
d©a
.
	`Ën
());

967 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

968 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
d©a
.
	`şÚe
()) {

969 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

970 
Ët
 
ex³ùed_’coded
 =

971 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
id
), 
Çme_d©um
, 
út
.
	`što
()]).
	`unw¿p
();

972 
as£¹_eq
!(
id
, 
row
.
hªdË
);

973 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

976 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
).
	`bud
();

977 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

978 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

979 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
d©a
) {

980 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

981 
Ët
 
ex³ùed_’coded
 =

982 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
id
), 
Çme_d©um
, 
út
.
	`što
()]).
	`unw¿p
();

983 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

984 
as£¹_eq
!(
»suÉ_’coded
, &*
ex³ùed_’coded
);

987 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

988 
	}
}

991 #[
‹¡
]

992 
â
 
	$‹¡_b©ch_row_lim™
() {

993 
Ët
 
d©a
 = 
vec
![

994 (1, 
	`Some
("name:0"), 2),

995 (2, 
	`Some
("name:4"), 3),

996 (4, 
	`Some
("name:3"), 1),

997 (5, 
	`Some
("name:1"), 4),

999 
Ët
 
b©ch_row_lim™
 = 3;

1000 
Ët
 
chunk_d©um_lim™
 = 
b©ch_row_lim™
 * 3;

1001 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1002 
	`Ët
 (
_
, 
mut
 
’d_pošt
) = {

1003 
Ët
 
’gše
 =ƒngše::
	`Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
	`unw¿p
();

1004 
Ët
 
mut
 
cfg
 = 
CÚfig
::();

1005 
cfg
.
’d_pošt_b©ch_row_lim™
 = 
b©ch_row_lim™
;

1006 
	`š™_d©a_w™h_d‘as
(
CÚ‹xt
::
	`Ãw
(), 
’gše
, &
´oduù
, &
d©a
, 
Œue
, 
cfg
)

1010 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
).
	`bud
();

1011 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1012 
	`check_chunk_d©um_couÁ
(
»¥
.
	`g‘_chunks
(), 
chunk_d©um_lim™
);

1013 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
d©a
.
	`Ën
());

1014 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1015 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
d©a
.
	`şÚe
()) {

1016 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1017 
Ët
 
ex³ùed_’coded
 =

1018 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
id
), 
Çme_d©um
, 
út
.
	`što
()]).
	`unw¿p
();

1019 
as£¹_eq
!(
id
, 
row
.
hªdË
);

1020 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1024 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
).
	`bud
();

1025 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1026 
	`check_chunk_d©um_couÁ
(
»¥
.
	`g‘_chunks
(), 
chunk_d©um_lim™
);

1027 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

1028 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
d©a
) {

1029 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1030 
Ët
 
ex³ùed_’coded
 =

1031 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
id
), 
Çme_d©um
, 
út
.
	`što
()]).
	`unw¿p
();

1032 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1033 
as£¹_eq
!(
»suÉ_’coded
, &*
ex³ùed_’coded
);

1036 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1037 
	}
}

1039 #[
‹¡
]

1040 
â
 
	$‹¡_£Ëù_aá”_Ëa£
() {

1041 
Ët
 
d©a
 = 
vec
![

1042 (1, 
	`Some
("name:0"), 2),

1043 (2, 
	`Some
("name:4"), 3),

1044 (4, 
	`Some
("name:3"), 1),

1045 (5, 
	`Some
("name:1"), 4),

1048 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1049 
	`Ët
 (
_şu¡”
, 
¿á_’gše
, 
ùx
èğ
	`Ãw_¿á_’gše
(1, "");

1050 
	`Ët
 (
_
, 
mut
 
’d_pošt
) =

1051 
	`š™_d©a_w™h_’gše_ªd_comm™
(
ùx
.
	`şÚe
(), 
¿á_’gše
, &
´oduù
, &
d©a
, 
Œue
);

1053 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
).
	`bud_w™h_ùx_ªd_æags
(
ùx
.
	`şÚe
(), &[0]);

1054 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1055 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
d©a
.
	`Ën
());

1056 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1057 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
d©a
.
	`şÚe
()) {

1058 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1059 
Ët
 
ex³ùed_’coded
 =

1060 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
id
), 
Çme_d©um
, 
út
.
	`što
()]).
	`unw¿p
();

1061 
as£¹_eq
!(
id
, 
row
.
hªdË
);

1062 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1066 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_mlis
(
MAX_LEADER_LEASE
));

1067 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
).
	`bud_w™h_ùx_ªd_æags
(
ùx
.
	`şÚe
(), &[0]);

1068 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1069 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
d©a
.
	`Ën
());

1070 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1071 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
d©a
.
	`şÚe
()) {

1072 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1073 
Ët
 
ex³ùed_’coded
 =

1074 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
id
), 
Çme_d©um
, 
út
.
	`što
()]).
	`unw¿p
();

1075 
as£¹_eq
!(
id
, 
row
.
hªdË
);

1076 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1079 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1080 
	}
}

1082 #[
‹¡
]

1083 
â
 
	$‹¡_group_by
() {

1084 
Ët
 
d©a
 = 
vec
![

1085 (1, 
	`Some
("name:0"), 2),

1086 (2, 
	`Some
("name:2"), 3),

1087 (4, 
	`Some
("name:0"), 1),

1088 (5, 
	`Some
("name:1"), 4),

1091 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1092 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1094 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

1095 .
	`group_by
(&[
´oduù
.
Çme
])

1096 .
	`bud
();

1097 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1099 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 3);

1100 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1101 
row
, 
Çme
è
š
 
¥l™”
.
	`z
(&[
b
"name:0", b"name:2", b"name:1"]) {

1102 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`By‹s
(
Çme
.
	`to_vec
())]).
	`unw¿p
();

1103 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`By‹s
(
gk
)]).
	`unw¿p
();

1104 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1108 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

1109 .
	`group_by
(&[
´oduù
.
Çme
])

1110 .
	`bud
();

1111 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1113 
Ët
 
mut
 
row_couÁ
 = 0;

1114 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 1);

1115 
row
, 
Çme
è
š
 
¥l™”
.
	`z
(&[
b
"name:0", b"name:2", b"name:1"]) {

1116 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`By‹s
(
Çme
.
	`to_vec
())]).
	`unw¿p
();

1117 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1118 
as£¹_eq
!(
»suÉ_’coded
, &*
ex³ùed_’coded
);

1119 
row_couÁ
 += 1;

1121 
as£¹_eq
!(
row_couÁ
, 3);

1123 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1124 
	}
}

1126 #[
‹¡
]

1127 
â
 
	$‹¡_aggr_couÁ
() {

1128 
Ët
 
d©a
 = 
vec
![

1129 (1, 
	`Some
("name:0"), 2),

1130 (2, 
	`Some
("name:3"), 3),

1131 (4, 
	`Some
("name:0"), 1),

1132 (5, 
	`Some
("name:5"), 4),

1133 (6, 
	`Some
("name:5"), 4),

1134 (7, 
NÚe
, 4),

1137 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1138 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1140 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
).
	`couÁ
().
	`bud
();

1141 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1142 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 1);

1143 
Ët
 
mut
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1144 
Ët
 
gk
 = 
D©um
::
	`By‹s
(
cİroûssÜ
::
SINGLE_GROUP
.
	`to_vec
());

1145 
Ët
 
mut
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
gk
, 
D©um
::
	`U64
(
d©a
.
	`Ën
(è
as
 
u64
)]).
	`unw¿p
();

1146 
as£¹_eq
!(
¥l™”
.
	`Ãxt
().
	`unw¿p
().
d©a
, &*
ex³ùed_’coded
);

1148 
Ët
 
exp
 = 
vec
![

1149 (
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), 2),

1150 (
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()), 1),

1151 (
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()), 2),

1152 (
D©um
::
NuÎ
, 1),

1155 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

1156 .
	`couÁ
()

1157 .
	`group_by
(&[
´oduù
.
Çme
])

1158 .
	`bud
();

1159 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1160 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

1161 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1162 
row
, (
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

1163 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
Çme
]);

1164 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
.
	`unw¿p
()), D©um::
	`U64
(
út
)];

1165 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1166 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1169 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

1170 .
	`couÁ
()

1171 .
	`group_by
(&[
´oduù
.
Çme
])

1172 .
	`bud
();

1173 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1174 
Ët
 
mut
 
row_couÁ
 = 0;

1175 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

1176 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 2);

1177 
row
, (
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
) {

1178 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`U64
(
út
), 
Çme
];

1179 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1180 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1181 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1182 
row_couÁ
 += 1;

1184 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

1186 
Ët
 
exp
 = 
vec
![

1187 (
vec
![
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), D©um::
	`I64
(2)], 1),

1188 (
vec
![
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()), D©um::
	`I64
(3)], 1),

1189 (
vec
![
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), D©um::
	`I64
(1)], 1),

1190 (
vec
![
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()), D©um::
	`I64
(4)], 2),

1191 (
vec
![
D©um
::
NuÎ
, D©um::
	`I64
(4)], 1),

1195 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

1196 .
	`couÁ
()

1197 .
	`group_by
(&[
´oduù
.
Çme
,…roduù.
couÁ
])

1198 .
	`bud
();

1199 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1200 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

1201 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1202 
row
, (
gk_d©a
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

1203 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&
gk_d©a
);

1204 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
.
	`unw¿p
()), D©um::
	`U64
(
út
)];

1205 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1206 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1210 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

1211 .
	`couÁ
()

1212 .
	`group_by
(&[
´oduù
.
Çme
,…roduù.
couÁ
])

1213 .
	`bud
();

1214 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1215 
Ët
 
mut
 
row_couÁ
 = 0;

1216 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

1217 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

1218 
row
, (
gk_d©a
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
) {

1219 
Ët
 
mut
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`U64
(
út
)];

1220 
ex³ùed_d©um
.
	`ex‹nd_äom_¦iû
(
gk_d©a
.
	`as_¦iû
());

1221 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1222 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1223 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1224 
row_couÁ
 += 1;

1226 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

1228 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1229 
	}
}

1231 #[
‹¡
]

1232 
â
 
	$‹¡_aggr_fœ¡
() {

1233 
Ët
 
d©a
 = 
vec
![

1234 (1, 
	`Some
("name:0"), 2),

1235 (2, 
	`Some
("name:3"), 3),

1236 (3, 
	`Some
("name:5"), 3),

1237 (4, 
	`Some
("name:0"), 1),

1238 (5, 
	`Some
("name:5"), 4),

1239 (6, 
	`Some
("name:5"), 4),

1240 (7, 
NÚe
, 4),

1241 (8, 
NÚe
, 5),

1242 (9, 
	`Some
("name:5"), 5),

1243 (10, 
NÚe
, 6),

1246 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1247 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1249 
Ët
 
exp
 = 
vec
![

1250 (
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), 1),

1251 (
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()), 2),

1252 (
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()), 3),

1253 (
D©um
::
NuÎ
, 7),

1256 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

1257 .
	`fœ¡
(
´oduù
.
id
)

1258 .
	`group_by
(&[
´oduù
.
Çme
])

1259 .
	`bud
();

1260 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1261 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

1262 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1263 
row
, (
Çme
, 
id
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

1264 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
Çme
]).
	`unw¿p
();

1265 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
), D©um::
	`I64
(
id
)];

1266 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1267 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1271 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

1272 .
	`fœ¡
(
´oduù
.
id
)

1273 .
	`group_by
(&[
´oduù
.
Çme
])

1274 .
	`bud
();

1275 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1276 
Ët
 
mut
 
row_couÁ
 = 0;

1277 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

1278 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 2);

1279 
row
, (
Çme
, 
id
)è
š
 
¥l™”
.
	`z
(
exp
) {

1280 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`I64
(
id
), 
Çme
];

1281 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1282 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1283 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1284 
row_couÁ
 += 1;

1286 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

1288 
Ët
 
exp
 = 
vec
![

1289 (2, 
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
())),

1290 (3, 
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
())),

1291 (1, 
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
())),

1292 (4, 
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
())),

1293 (5, 
D©um
::
NuÎ
),

1294 (6, 
D©um
::
NuÎ
),

1297 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

1298 .
	`fœ¡
(
´oduù
.
Çme
)

1299 .
	`group_by
(&[
´oduù
.
couÁ
])

1300 .
	`bud
();

1301 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1302 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

1303 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1304 
row
, (
couÁ
, 
Çme
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

1305 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
couÁ
)]).
	`unw¿p
();

1306 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
), 
Çme
];

1307 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1308 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1311 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

1312 .
	`fœ¡
(
´oduù
.
Çme
)

1313 .
	`group_by
(&[
´oduù
.
couÁ
])

1314 .
	`bud
();

1315 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1316 
Ët
 
mut
 
row_couÁ
 = 0;

1317 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

1318 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 2);

1319 
row
, (
couÁ
, 
Çme
)è
š
 
¥l™”
.
	`z
(
exp
) {

1320 
Ët
 
ex³ùed_d©um
 = 
vec
![
Çme
, 
D©um
::
	`I64
(
couÁ
)];

1321 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1322 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1323 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1324 
row_couÁ
 += 1;

1326 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

1328 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1329 
	}
}

1331 #[
‹¡
]

1332 
â
 
	$‹¡_aggr_avg
() {

1333 
Ët
 
d©a
 = 
vec
![

1334 (1, 
	`Some
("name:0"), 2),

1335 (2, 
	`Some
("name:3"), 3),

1336 (4, 
	`Some
("name:0"), 1),

1337 (5, 
	`Some
("name:5"), 4),

1338 (6, 
	`Some
("name:5"), 4),

1339 (7, 
NÚe
, 4),

1342 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1343 
	`Ët
 (
mut
 
¡Üe
, muˆ
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1345 
¡Üe
.
	`begš
();

1346 
¡Üe


1347 .
	`š£¹_što
(&
´oduù
.
bË
)

1348 .
	`£t
(
´oduù
.
id
, 
D©um
::
	`I64
(8))

1349 .
	`£t
(
´oduù
.
Çme
, 
D©um
::
	`By‹s
(
b
"Çme:4".
	`to_vec
()))

1350 .
	`£t
(
´oduù
.
couÁ
, 
D©um
::
NuÎ
)

1351 .
	`execu‹
();

1352 
¡Üe
.
	`comm™
();

1354 
Ët
 
exp
 = 
vec
![

1355 (
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), (D©um::
	`Dec
(3.
	`što
()), 2)),

1356 (
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()), (D©um::
	`Dec
(3.
	`što
()), 1)),

1357 (
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()), (D©um::
	`Dec
(8.
	`što
()), 2)),

1358 (
D©um
::
NuÎ
, (D©um::
	`Dec
(4.
	`što
()), 1)),

1359 (
D©um
::
	`By‹s
(
b
"Çme:4".
	`to_vec
()), (D©um::
NuÎ
, 0)),

1362 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

1363 .
	`avg
(
´oduù
.
couÁ
)

1364 .
	`group_by
(&[
´oduù
.
Çme
])

1365 .
	`bud
();

1366 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1367 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

1368 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1369 
row
, (
Çme
, (
sum
, 
út
))è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

1370 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
Çme
]).
	`unw¿p
();

1371 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
), D©um::
	`U64
(
út
), 
sum
];

1372 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1373 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1376 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

1377 .
	`avg
(
´oduù
.
couÁ
)

1378 .
	`group_by
(&[
´oduù
.
Çme
])

1379 .
	`bud
();

1380 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1381 
Ët
 
mut
 
row_couÁ
 = 0;

1382 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

1383 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

1384 
row
, (
Çme
, (
sum
, 
út
))è
š
 
¥l™”
.
	`z
(
exp
) {

1385 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`U64
(
út
), 
sum
, 
Çme
];

1386 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1387 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1388 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1389 
row_couÁ
 += 1;

1391 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

1393 
’d_pošt
.
	`¡İ
().
	`unw¿p
();

1394 
	}
}

1396 #[
‹¡
]

1397 
â
 
	$‹¡_aggr_sum
() {

1398 
Ët
 
d©a
 = 
vec
![

1399 (1, 
	`Some
("name:0"), 2),

1400 (2, 
	`Some
("name:3"), 3),

1401 (4, 
	`Some
("name:0"), 1),

1402 (5, 
	`Some
("name:5"), 4),

1403 (6, 
	`Some
("name:5"), 4),

1404 (7, 
NÚe
, 4),

1407 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1408 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1410 
Ët
 
exp
 = 
vec
![

1411 (
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), 3),

1412 (
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()), 3),

1413 (
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()), 8),

1414 (
D©um
::
NuÎ
, 4),

1417 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

1418 .
	`sum
(
´oduù
.
couÁ
)

1419 .
	`group_by
(&[
´oduù
.
Çme
])

1420 .
	`bud
();

1421 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1422 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

1423 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1424 
row
, (
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

1425 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
Çme
]).
	`unw¿p
();

1426 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
), D©um::
	`Dec
(
út
.
	`što
())];

1427 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1428 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1431 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

1432 .
	`sum
(
´oduù
.
couÁ
)

1433 .
	`group_by
(&[
´oduù
.
Çme
])

1434 .
	`bud
();

1435 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1436 
Ët
 
mut
 
row_couÁ
 = 0;

1437 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

1438 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 2);

1439 
row
, (
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
) {

1440 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`Dec
(
út
.
	`što
()), 
Çme
];

1441 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1442 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1443 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1444 
row_couÁ
 += 1;

1446 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

1447 
’d_pošt
.
	`¡İ
().
	`unw¿p
();

1448 
	}
}

1450 #[
‹¡
]

1451 
â
 
	$‹¡_aggr_exŒe
() {

1452 
Ët
 
d©a
 = 
vec
![

1453 (1, 
	`Some
("name:0"), 2),

1454 (2, 
	`Some
("name:3"), 3),

1455 (4, 
	`Some
("name:0"), 1),

1456 (5, 
	`Some
("name:5"), 4),

1457 (6, 
	`Some
("name:5"), 5),

1458 (7, 
NÚe
, 4),

1461 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1462 
	`Ët
 (
mut
 
¡Üe
, muˆ
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1464 
¡Üe
.
	`begš
();

1465 &(
id
, 
Çme
è
š
 &[(8, 
b
"name:5"), (9, b"name:6")] {

1466 
¡Üe


1467 .
	`š£¹_što
(&
´oduù
.
bË
)

1468 .
	`£t
(
´oduù
.
id
, 
D©um
::
	`I64
(id))

1469 .
	`£t
(
´oduù
.
Çme
, 
D©um
::
	`By‹s
Òame.
	`to_vec
()))

1470 .
	`£t
(
´oduù
.
couÁ
, 
D©um
::
NuÎ
)

1471 .
	`execu‹
();

1473 
¡Üe
.
	`comm™
();

1475 
Ët
 
exp
 = 
vec
![

1477 
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()),

1478 
D©um
::
	`I64
(2),

1479 
D©um
::
	`I64
(1),

1482 
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()),

1483 
D©um
::
	`I64
(3),

1484 
D©um
::
	`I64
(3),

1487 
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()),

1488 
D©um
::
	`I64
(5),

1489 
D©um
::
	`I64
(4),

1491 (
D©um
::
NuÎ
, D©um::
	`I64
(4), Datum::I64(4)),

1492 (
D©um
::
	`By‹s
(
b
"Çme:6".
	`to_vec
()), D©um::
NuÎ
, Datum::Null),

1495 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

1496 .
	`max
(
´oduù
.
couÁ
)

1497 .
	`mš
(
´oduù
.
couÁ
)

1498 .
	`group_by
(&[
´oduù
.
Çme
])

1499 .
	`bud
();

1500 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1501 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

1502 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1503 
row
, (
Çme
, 
max
, 
mš
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

1504 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
Çme
]).
	`unw¿p
();

1505 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
), 
max
, 
mš
];

1506 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1507 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1510 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

1511 .
	`max
(
´oduù
.
couÁ
)

1512 .
	`mš
(
´oduù
.
couÁ
)

1513 .
	`group_by
(&[
´oduù
.
Çme
])

1514 .
	`bud
();

1515 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1516 
Ët
 
mut
 
row_couÁ
 = 0;

1517 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

1518 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

1519 
row
, (
Çme
, 
max
, 
mš
)è
š
 
¥l™”
.
	`z
(
exp
) {

1520 
Ët
 
ex³ùed_d©um
 = 
vec
![
max
, 
mš
, 
Çme
];

1521 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

1522 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1523 
as£¹_eq
!(
»suÉ_’coded
, &*
ex³ùed_’coded
);

1524 
row_couÁ
 += 1;

1526 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

1528 
’d_pošt
.
	`¡İ
().
	`unw¿p
();

1529 
	}
}

1531 #[
‹¡
]

1532 
â
 
	$‹¡_Üd”_by_cŞumn
() {

1533 
Ët
 
d©a
 = 
vec
![

1534 (1, 
	`Some
("name:0"), 2),

1535 (2, 
	`Some
("name:3"), 3),

1536 (4, 
	`Some
("name:0"), 1),

1537 (5, 
	`Some
("name:6"), 4),

1538 (6, 
	`Some
("name:5"), 4),

1539 (7, 
	`Some
("name:4"), 4),

1540 (8, 
NÚe
, 4),

1543 
Ët
 
exp
 = 
vec
![

1544 (8, 
NÚe
, 4),

1545 (7, 
	`Some
("name:4"), 4),

1546 (6, 
	`Some
("name:5"), 4),

1547 (5, 
	`Some
("name:6"), 4),

1548 (2, 
	`Some
("name:3"), 3),

1551 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1552 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1554 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

1555 .
	`Üd”_by
(
´oduù
.
couÁ
, 
Œue
)

1556 .
	`Üd”_by
(
´oduù
.
Çme
, 
çl£
)

1557 .
	`lim™
(5)

1558 .
	`bud
();

1559 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1560 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 5);

1561 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1562 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

1563 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1564 
Ët
 
ex³ùed_’coded
 =

1565 
d©um
::
	`’code_v®ue
(&[(
id
 
as
 
i64
).
	`što
(), 
Çme_d©um
, (
út
‡ i64).što()]).
	`unw¿p
();

1566 
as£¹_eq
!(
id
 
as
 
i64
, 
row
.
hªdË
);

1567 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1570 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

1571 .
	`Üd”_by
(
´oduù
.
couÁ
, 
Œue
)

1572 .
	`Üd”_by
(
´oduù
.
Çme
, 
çl£
)

1573 .
	`lim™
(5)

1574 .
	`bud
();

1575 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1576 
Ët
 
mut
 
row_couÁ
 = 0;

1577 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

1578 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
) {

1579 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1580 
Ët
 
ex³ùed_’coded
 =

1581 
d©um
::
	`’code_v®ue
(&[(
id
 
as
 
i64
).
	`što
(), 
Çme_d©um
, (
út
‡ i64).što()]).
	`unw¿p
();

1582 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1583 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1584 
row_couÁ
 += 1;

1586 
as£¹_eq
!(
row_couÁ
, 5);

1587 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1588 
	}
}

1590 #[
‹¡
]

1591 
â
 
	$‹¡_Üd”_by_pk_w™h_£Ëù_äom_šdex
() {

1592 
Ët
 
mut
 
d©a
 = 
vec
![

1593 (8, 
	`Some
("name:0"), 2),

1594 (7, 
	`Some
("name:3"), 3),

1595 (6, 
	`Some
("name:0"), 1),

1596 (5, 
	`Some
("name:6"), 4),

1597 (4, 
	`Some
("name:5"), 4),

1598 (3, 
	`Some
("name:4"), 4),

1599 (2, 
NÚe
, 4),

1602 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1603 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1604 
Ët
 
ex³ù
: 
Vec
<
_
> = 
d©a
.
	`d¿š
(..5).
	`cŞËù
();

1606 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

1607 .
	`Üd”_by
(
´oduù
.
id
, 
Œue
)

1608 .
	`lim™
(5)

1609 .
	`bud
();

1610 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1611 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 5);

1612 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1613 
row
, (
id
, 
_
, _)è
š
 
¥l™”
.
	`z
(
ex³ù
.
	`şÚe
()) {

1614 
as£¹_eq
!(
id
, 
row
.
hªdË
);

1617 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

1618 .
	`Üd”_by
(
´oduù
.
id
, 
Œue
)

1619 .
	`lim™
(5)

1620 .
	`bud
();

1621 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1622 
Ët
 
mut
 
row_couÁ
 = 0;

1623 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

1624 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
ex³ù
) {

1625 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1626 
Ët
 
ex³ùed_’coded
 =

1627 
d©um
::
	`’code_v®ue
(&[
Çme_d©um
, (
út
 
as
 
i64
).
	`što
(), (
id
‡ i64).što()]).
	`unw¿p
();

1628 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1629 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1630 
row_couÁ
 += 1;

1632 
as£¹_eq
!(
row_couÁ
, 5);

1633 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1634 
	}
}

1636 #[
‹¡
]

1637 
â
 
	$‹¡_lim™
() {

1638 
Ët
 
mut
 
d©a
 = 
vec
![

1639 (1, 
	`Some
("name:0"), 2),

1640 (2, 
	`Some
("name:3"), 3),

1641 (4, 
	`Some
("name:0"), 1),

1642 (5, 
	`Some
("name:5"), 4),

1643 (6, 
	`Some
("name:5"), 4),

1644 (7, 
NÚe
, 4),

1647 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1648 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1649 
Ët
 
ex³ù
: 
Vec
<
_
> = 
d©a
.
	`d¿š
(..5).
	`cŞËù
();

1651 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
).
	`lim™
(5).
	`bud
();

1652 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1653 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 5);

1654 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1655 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
ex³ù
.
	`şÚe
()) {

1656 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1657 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
id
.
	`što
(), 
Çme_d©um
, 
út
.što()]).
	`unw¿p
();

1658 
as£¹_eq
!(
id
, 
row
.
hªdË
);

1659 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1662 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
).
	`lim™
(5).
	`bud
();

1663 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1664 
Ët
 
mut
 
row_couÁ
 = 0;

1665 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

1666 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
ex³ù
) {

1667 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1668 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
id
.
	`što
(), 
Çme_d©um
, 
út
.što()]).
	`unw¿p
();

1669 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1670 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1671 
row_couÁ
 += 1;

1673 
as£¹_eq
!(
row_couÁ
, 5);

1675 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1676 
	}
}

1678 #[
‹¡
]

1679 
â
 
	$‹¡_»v”£
() {

1680 
Ët
 
mut
 
d©a
 = 
vec
![

1681 (1, 
	`Some
("name:0"), 2),

1682 (2, 
	`Some
("name:3"), 3),

1683 (4, 
	`Some
("name:0"), 1),

1684 (5, 
	`Some
("name:5"), 4),

1685 (6, 
	`Some
("name:5"), 4),

1686 (7, 
NÚe
, 4),

1689 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1690 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1691 
d©a
.
	`»v”£
();

1692 
Ët
 
ex³ù
: 
Vec
<
_
> = 
d©a
.
	`d¿š
(..5).
	`cŞËù
();

1694 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

1695 .
	`lim™
(5)

1696 .
	`Üd”_by_pk
(
Œue
)

1697 .
	`bud
();

1698 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1699 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 5);

1700 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1702 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
ex³ù
.
	`şÚe
()) {

1703 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1704 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
id
.
	`što
(), 
Çme_d©um
, 
út
.što()]).
	`unw¿p
();

1705 
as£¹_eq
!(
id
, 
row
.
hªdË
);

1706 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1709 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

1710 .
	`lim™
(5)

1711 .
	`Üd”_by
(
´oduù
.
id
, 
Œue
)

1712 .
	`bud
();

1713 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1714 
Ët
 
mut
 
row_couÁ
 = 0;

1715 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

1716 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
ex³ù
) {

1717 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1718 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
id
.
	`što
(), 
Çme_d©um
, 
út
.što()]).
	`unw¿p
();

1719 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1720 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1721 
row_couÁ
 += 1;

1723 
as£¹_eq
!(
row_couÁ
, 5);

1725 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1726 
	}
}

1728 
pub
 
â
 
hªdË_»que¡
(
’d_pošt
: &
WÜk”
<
EndPoštTask
>, 
»q
: 
Reque¡
è-> 
Re¥Ú£
 {

1729 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

1730 
Ët
 
»q
 = 
Reque¡Task
::
Ãw
Ôeq, 
box
 
move
 |
r
| 
tx
.
£nd
Ô).
unw¿p
(), 100);

1731 
’d_pošt
.
scheduË
(
EndPoštTask
::
Reque¡
(
»q
)).
unw¿p
();

1732 
rx
.
»cv
().
unw¿p
()

1735 
â
 
hªdË_£Ëù
(
’d_pošt
: &
WÜk”
<
EndPoštTask
>, 
»q
: 
Reque¡
è-> 
S–eùRe¥Ú£
 {

1736 
Ët
 
»¥
 = 
hªdË_»que¡
(
’d_pošt
, 
»q
);

1737 
as£¹
!(!
»¥
.
g‘_d©a
().
is_em±y
(), "{:?}",„esp);

1738 
Ët
 
mut
 
£l_»¥
 = 
S–eùRe¥Ú£
::
Ãw
();

1739 
£l_»¥
.
m”ge_äom_by‹s
(
»¥
.
g‘_d©a
()).
unw¿p
();

1740 
£l_»¥


1743 #[
‹¡
]

1744 
â
 
	$‹¡_šdex
() {

1745 
Ët
 
d©a
 = 
vec
![

1746 (1, 
	`Some
("name:0"), 2),

1747 (2, 
	`Some
("name:3"), 3),

1748 (4, 
	`Some
("name:0"), 1),

1749 (5, 
	`Some
("name:5"), 4),

1750 (6, 
	`Some
("name:5"), 4),

1751 (7, 
NÚe
, 4),

1754 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1755 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1757 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
id
).
	`bud
();

1758 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1759 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
d©a
.
	`Ën
());

1760 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1761 
Ët
 
mut
 
hªdËs
: 
Vec
<
_
> = 
¥l™”
.
	`m­
(|
row
|„ow.
hªdË
).
	`cŞËù
();

1762 
hªdËs
.
	`sÜt
();

1763 &
h
, (
id
, 
_
, _)è
š
 
hªdËs
.
	`™”
().
	`z
(
d©a
.
	`şÚe
()) {

1764 
as£¹_eq
!(
id
, 
h
);

1767 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
id
).
	`bud
();

1768 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1769 
Ët
 
mut
 
row_couÁ
 = 0;

1770 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 1);

1771 
row
, (
id
, 
_
, _)è
š
 
¥l™”
.
	`z
(
d©a
) {

1772 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
id
.
	`što
()]).
	`unw¿p
();

1773 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1774 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1775 
row_couÁ
 += 1;

1777 
as£¹_eq
!(
row_couÁ
, 6);

1779 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1780 
	}
}

1782 #[
‹¡
]

1783 
â
 
	$‹¡_šdex_»v”£_lim™
() {

1784 
Ët
 
mut
 
d©a
 = 
vec
![

1785 (1, 
	`Some
("name:0"), 2),

1786 (2, 
	`Some
("name:3"), 3),

1787 (4, 
	`Some
("name:0"), 1),

1788 (5, 
	`Some
("name:5"), 4),

1789 (6, 
	`Some
("name:5"), 4),

1790 (7, 
NÚe
, 4),

1793 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1794 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1795 
d©a
.
	`»v”£
();

1796 
Ët
 
ex³ù
: 
Vec
<
_
> = 
d©a
.
	`d¿š
(..5).
	`cŞËù
();

1798 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
id
)

1799 .
	`lim™
(5)

1800 .
	`Üd”_by_pk
(
Œue
)

1801 .
	`bud
();

1802 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1803 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 5);

1804 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1805 
Ët
 
hªdËs
 = 
¥l™”
.
	`m­
(|
row
|„ow.
hªdË
);

1806 
h
, (
id
, 
_
, _)è
š
 
hªdËs
.
	`z
(
ex³ù
.
	`şÚe
()) {

1807 
as£¹_eq
!(
id
, 
h
);

1810 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
id
)

1811 .
	`lim™
(5)

1812 .
	`Üd”_by
(
´oduù
.
id
, 
Œue
)

1813 .
	`bud
();

1815 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1816 
Ët
 
mut
 
row_couÁ
 = 0;

1817 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 1);

1818 
row
, (
id
, 
_
, _)è
š
 
¥l™”
.
	`z
(
ex³ù
) {

1819 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
id
.
	`što
()]).
	`unw¿p
();

1820 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1821 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1822 
row_couÁ
 += 1;

1824 
as£¹_eq
!(
row_couÁ
, 5);

1826 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1827 
	}
}

1829 #[
‹¡
]

1830 
â
 
	$‹¡_lim™_oom
() {

1831 
Ët
 
d©a
 = 
vec
![

1832 (1, 
	`Some
("name:0"), 2),

1833 (2, 
	`Some
("name:3"), 3),

1834 (4, 
	`Some
("name:0"), 1),

1835 (5, 
	`Some
("name:5"), 4),

1836 (6, 
	`Some
("name:5"), 4),

1837 (7, 
NÚe
, 4),

1840 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1841 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1843 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
id
)

1844 .
	`lim™
(100000000)

1845 .
	`bud
();

1846 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1847 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
d©a
.
	`Ën
());

1848 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1849 
Ët
 
mut
 
hªdËs
: 
Vec
<
_
> = 
¥l™”
.
	`m­
(|
row
|„ow.
hªdË
).
	`cŞËù
();

1850 
hªdËs
.
	`sÜt
();

1851 &
h
, (
id
, 
_
, _)è
š
 
hªdËs
.
	`™”
().
	`z
(
d©a
.
	`şÚe
()) {

1852 
as£¹_eq
!(
id
, 
h
);

1855 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
id
)

1856 .
	`lim™
(100000000)

1857 .
	`bud
();

1858 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1859 
Ët
 
mut
 
row_couÁ
 = 0;

1860 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 1);

1861 
row
, (
id
, 
_
, _)è
š
 
¥l™”
.
	`z
(
d©a
) {

1862 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
id
.
	`što
()]).
	`unw¿p
();

1863 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1864 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1865 
row_couÁ
 += 1;

1867 
as£¹_eq
!(
row_couÁ
, 6);

1868 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1869 
	}
}

1871 #[
‹¡
]

1872 
â
 
	$‹¡_d–_£Ëù
() {

1873 
Ët
 
mut
 
d©a
 = 
vec
![

1874 (1, 
	`Some
("name:0"), 2),

1875 (2, 
	`Some
("name:3"), 3),

1876 (4, 
	`Some
("name:0"), 1),

1877 (5, 
	`Some
("name:5"), 4),

1878 (6, 
	`Some
("name:5"), 4),

1879 (7, 
NÚe
, 4),

1882 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1883 
	`Ët
 (
mut
 
¡Üe
, muˆ
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1885 
¡Üe
.
	`begš
();

1886 
	`Ët
 (
id
, 
Çme
, 
út
èğ
d©a
.
	`»move
(3);

1887 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

1888 
¡Üe


1889 .
	`d–‘e_äom
(&
´oduù
.
bË
)

1890 .
	`execu‹
(
id
, 
vec
![id.
	`što
(), 
Çme_d©um
, 
út
.into()]);

1891 
¡Üe
.
	`comm™
();

1893 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
id
).
	`bud
();

1894 
Ët
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1895 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
d©a
.
	`Ën
());

1898 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
id
).
	`bud
();

1899 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1900 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 1);

1901 
Ët
 
mut
 
row_couÁ
 = 0;

1902 
_
 
š
 
¥l™”
 {

1903 
row_couÁ
 += 1;

1905 
as£¹_eq
!(
row_couÁ
, 5);

1907 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1908 
	}
}

1910 #[
‹¡
]

1911 
â
 
	$‹¡_šdex_group_by
() {

1912 
Ët
 
d©a
 = 
vec
![

1913 (1, 
	`Some
("name:0"), 2),

1914 (2, 
	`Some
("name:2"), 3),

1915 (4, 
	`Some
("name:0"), 1),

1916 (5, 
	`Some
("name:1"), 4),

1919 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1920 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1922 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

1923 .
	`group_by
(&[
´oduù
.
Çme
])

1924 .
	`bud
();

1925 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1927 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 3);

1928 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1929 
row
, 
Çme
è
š
 
¥l™”
.
	`z
(&[
b
"name:0", b"name:1", b"name:2"]) {

1930 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`By‹s
(
Çme
.
	`to_vec
())]).
	`unw¿p
();

1931 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`By‹s
(
gk
)]).
	`unw¿p
();

1932 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

1935 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

1936 .
	`group_by
(&[
´oduù
.
Çme
])

1937 .
	`bud
();

1938 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1940 
Ët
 
mut
 
row_couÁ
 = 0;

1941 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 1);

1942 
row
, 
Çme
è
š
 
¥l™”
.
	`z
(&[
b
"name:0", b"name:1", b"name:2"]) {

1943 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`By‹s
(
Çme
.
	`to_vec
())]).
	`unw¿p
();

1944 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

1945 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1946 
row_couÁ
 += 1;

1948 
as£¹_eq
!(
row_couÁ
, 3);

1950 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

1951 
	}
}

1953 #[
‹¡
]

1954 
â
 
	$‹¡_šdex_aggr_couÁ
() {

1955 
Ët
 
d©a
 = 
vec
![

1956 (1, 
	`Some
("name:0"), 2),

1957 (2, 
	`Some
("name:3"), 3),

1958 (4, 
	`Some
("name:0"), 1),

1959 (5, 
	`Some
("name:5"), 4),

1960 (6, 
	`Some
("name:5"), 4),

1961 (7, 
NÚe
, 4),

1964 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

1965 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

1967 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

1968 .
	`couÁ
()

1969 .
	`bud
();

1970 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1971 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 1);

1972 
Ët
 
mut
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

1973 
Ët
 
gk
 = 
D©um
::
	`By‹s
(
cİroûssÜ
::
SINGLE_GROUP
.
	`to_vec
());

1974 
Ët
 
mut
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
gk
, 
D©um
::
	`U64
(
d©a
.
	`Ën
(è
as
 
u64
)]).
	`unw¿p
();

1975 
as£¹_eq
!(
¥l™”
.
	`Ãxt
().
	`unw¿p
().
d©a
, &*
ex³ùed_’coded
);

1978 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

1979 .
	`couÁ
()

1980 .
	`bud
();

1981 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

1982 
Ët
 
mut
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 1);

1983 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`U64
(
d©a
.
	`Ën
(è
as
 
u64
)]).
	`unw¿p
();

1984 
Ët
 
»t_d©a
 = 
¥l™”
.
	`Ãxt
();

1985 
as£¹_eq
!(
»t_d©a
.
	`is_some
(), 
Œue
);

1986 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
»t_d©a
.
	`unw¿p
()).unwrap();

1987 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

1988 
as£¹_eq
!(
¥l™”
.
	`Ãxt
().
	`is_nÚe
(), 
Œue
);

1990 
Ët
 
exp
 = 
vec
![

1991 (
D©um
::
NuÎ
, 1),

1992 (
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), 2),

1993 (
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()), 1),

1994 (
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()), 2),

1997 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

1998 .
	`couÁ
()

1999 .
	`group_by
(&[
´oduù
.
Çme
])

2000 .
	`bud
();

2001 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2002 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

2003 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

2004 
row
, (
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

2005 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
Çme
]);

2006 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
.
	`unw¿p
()), D©um::
	`U64
(
út
)];

2007 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2008 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

2011 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2012 .
	`couÁ
()

2013 .
	`group_by
(&[
´oduù
.
Çme
])

2014 .
	`bud
();

2015 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2016 
Ët
 
mut
 
row_couÁ
 = 0;

2017 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

2018 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 2);

2019 
row
, (
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
) {

2020 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`U64
(
út
), 
Çme
];

2021 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2022 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

2023 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

2024 
row_couÁ
 += 1;

2026 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

2028 
Ët
 
exp
 = 
vec
![

2029 (
vec
![
D©um
::
NuÎ
, D©um::
	`I64
(4)], 1),

2030 (
vec
![
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), D©um::
	`I64
(1)], 1),

2031 (
vec
![
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), D©um::
	`I64
(2)], 1),

2032 (
vec
![
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()), D©um::
	`I64
(3)], 1),

2033 (
vec
![
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()), D©um::
	`I64
(4)], 2),

2036 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2037 .
	`couÁ
()

2038 .
	`group_by
(&[
´oduù
.
Çme
,…roduù.
couÁ
])

2039 .
	`bud
();

2040 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2041 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

2042 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

2043 
row
, (
gk_d©a
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

2044 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&
gk_d©a
);

2045 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
.
	`unw¿p
()), D©um::
	`U64
(
út
)];

2046 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2047 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

2050 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2051 .
	`couÁ
()

2052 .
	`group_by
(&[
´oduù
.
Çme
,…roduù.
couÁ
])

2053 .
	`bud
();

2054 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2055 
Ët
 
mut
 
row_couÁ
 = 0;

2056 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

2057 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

2058 
row
, (
gk_d©a
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
) {

2059 
Ët
 
mut
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`U64
(
út
)];

2060 
ex³ùed_d©um
.
	`ex‹nd_äom_¦iû
(
gk_d©a
.
	`as_¦iû
());

2061 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2062 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

2063 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

2064 
row_couÁ
 += 1;

2066 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

2068 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

2069 
	}
}

2071 #[
‹¡
]

2072 
â
 
	$‹¡_šdex_aggr_fœ¡
() {

2073 
Ët
 
d©a
 = 
vec
![

2074 (1, 
	`Some
("name:0"), 2),

2075 (2, 
	`Some
("name:3"), 3),

2076 (4, 
	`Some
("name:0"), 1),

2077 (5, 
	`Some
("name:5"), 4),

2078 (6, 
	`Some
("name:5"), 4),

2079 (7, 
NÚe
, 4),

2082 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2083 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

2085 
Ët
 
exp
 = 
vec
![

2086 (
D©um
::
NuÎ
, 7),

2087 (
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), 4),

2088 (
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()), 2),

2089 (
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()), 5),

2092 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2093 .
	`fœ¡
(
´oduù
.
id
)

2094 .
	`group_by
(&[
´oduù
.
Çme
])

2095 .
	`bud
();

2096 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2097 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

2098 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

2099 
row
, (
Çme
, 
id
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

2100 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
Çme
]).
	`unw¿p
();

2101 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
), D©um::
	`I64
(
id
)];

2102 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2103 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

2106 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2107 .
	`fœ¡
(
´oduù
.
id
)

2108 .
	`group_by
(&[
´oduù
.
Çme
])

2109 .
	`bud
();

2110 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2111 
Ët
 
mut
 
row_couÁ
 = 0;

2112 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

2113 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 2);

2114 
row
, (
Çme
, 
id
)è
š
 
¥l™”
.
	`z
(
exp
) {

2115 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`I64
(
id
), 
Çme
];

2116 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2117 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

2118 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

2119 
row_couÁ
 += 1;

2121 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

2123 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

2124 
	}
}

2126 #[
‹¡
]

2127 
â
 
	$‹¡_šdex_aggr_avg
() {

2128 
Ët
 
d©a
 = 
vec
![

2129 (1, 
	`Some
("name:0"), 2),

2130 (2, 
	`Some
("name:3"), 3),

2131 (4, 
	`Some
("name:0"), 1),

2132 (5, 
	`Some
("name:5"), 4),

2133 (6, 
	`Some
("name:5"), 4),

2134 (7, 
NÚe
, 4),

2137 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2138 
	`Ët
 (
mut
 
¡Üe
, muˆ
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

2140 
¡Üe
.
	`begš
();

2141 
¡Üe


2142 .
	`š£¹_što
(&
´oduù
.
bË
)

2143 .
	`£t
(
´oduù
.
id
, 
D©um
::
	`I64
(8))

2144 .
	`£t
(
´oduù
.
Çme
, 
D©um
::
	`By‹s
(
b
"Çme:4".
	`to_vec
()))

2145 .
	`£t
(
´oduù
.
couÁ
, 
D©um
::
NuÎ
)

2146 .
	`execu‹
();

2147 
¡Üe
.
	`comm™
();

2149 
Ët
 
exp
 = 
vec
![

2150 (
D©um
::
NuÎ
, (D©um::
	`Dec
(4.
	`što
()), 1)),

2151 (
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), (D©um::
	`Dec
(3.
	`što
()), 2)),

2152 (
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()), (D©um::
	`Dec
(3.
	`što
()), 1)),

2153 (
D©um
::
	`By‹s
(
b
"Çme:4".
	`to_vec
()), (D©um::
NuÎ
, 0)),

2154 (
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()), (D©um::
	`Dec
(8.
	`što
()), 2)),

2157 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2158 .
	`avg
(
´oduù
.
couÁ
)

2159 .
	`group_by
(&[
´oduù
.
Çme
])

2160 .
	`bud
();

2161 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2162 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

2163 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

2164 
row
, (
Çme
, (
sum
, 
út
))è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

2165 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
Çme
]).
	`unw¿p
();

2166 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
), D©um::
	`U64
(
út
), 
sum
];

2167 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2168 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

2171 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2172 .
	`avg
(
´oduù
.
couÁ
)

2173 .
	`group_by
(&[
´oduù
.
Çme
])

2174 .
	`bud
();

2175 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2176 
Ët
 
mut
 
row_couÁ
 = 0;

2177 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

2178 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

2179 
row
, (
Çme
, (
sum
, 
út
))è
š
 
¥l™”
.
	`z
(
exp
) {

2180 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`U64
(
út
), 
sum
, 
Çme
];

2181 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2182 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

2183 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

2184 
row_couÁ
 += 1;

2186 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

2187 
’d_pošt
.
	`¡İ
().
	`unw¿p
();

2188 
	}
}

2190 #[
‹¡
]

2191 
â
 
	$‹¡_šdex_aggr_sum
() {

2192 
Ët
 
d©a
 = 
vec
![

2193 (1, 
	`Some
("name:0"), 2),

2194 (2, 
	`Some
("name:3"), 3),

2195 (4, 
	`Some
("name:0"), 1),

2196 (5, 
	`Some
("name:5"), 4),

2197 (6, 
	`Some
("name:5"), 4),

2198 (7, 
NÚe
, 4),

2201 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2202 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

2204 
Ët
 
exp
 = 
vec
![

2205 (
D©um
::
NuÎ
, 4),

2206 (
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()), 3),

2207 (
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()), 3),

2208 (
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()), 8),

2211 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2212 .
	`sum
(
´oduù
.
couÁ
)

2213 .
	`group_by
(&[
´oduù
.
Çme
])

2214 .
	`bud
();

2215 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2216 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

2217 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

2218 
row
, (
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

2219 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
Çme
]).
	`unw¿p
();

2220 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
), D©um::
	`Dec
(
út
.
	`što
())];

2221 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2222 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

2225 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2226 .
	`sum
(
´oduù
.
couÁ
)

2227 .
	`group_by
(&[
´oduù
.
Çme
])

2228 .
	`bud
();

2229 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2230 
Ët
 
mut
 
row_couÁ
 = 0;

2231 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

2232 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 2);

2233 
row
, (
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
exp
) {

2234 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`Dec
(
út
.
	`što
()), 
Çme
];

2235 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2236 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

2237 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

2238 
row_couÁ
 += 1;

2240 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

2241 
’d_pošt
.
	`¡İ
().
	`unw¿p
();

2242 
	}
}

2244 #[
‹¡
]

2245 
â
 
	$‹¡_šdex_aggr_exŒe
() {

2246 
Ët
 
d©a
 = 
vec
![

2247 (1, 
	`Some
("name:0"), 2),

2248 (2, 
	`Some
("name:3"), 3),

2249 (4, 
	`Some
("name:0"), 1),

2250 (5, 
	`Some
("name:5"), 4),

2251 (6, 
	`Some
("name:5"), 5),

2252 (7, 
NÚe
, 4),

2255 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2256 
	`Ët
 (
mut
 
¡Üe
, muˆ
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

2258 
¡Üe
.
	`begš
();

2259 &(
id
, 
Çme
è
š
 &[(8, 
b
"name:5"), (9, b"name:6")] {

2260 
¡Üe


2261 .
	`š£¹_što
(&
´oduù
.
bË
)

2262 .
	`£t
(
´oduù
.
id
, 
D©um
::
	`I64
(id))

2263 .
	`£t
(
´oduù
.
Çme
, 
D©um
::
	`By‹s
Òame.
	`to_vec
()))

2264 .
	`£t
(
´oduù
.
couÁ
, 
D©um
::
NuÎ
)

2265 .
	`execu‹
();

2267 
¡Üe
.
	`comm™
();

2269 
Ët
 
exp
 = 
vec
![

2270 (
D©um
::
NuÎ
, D©um::
	`I64
(4), Datum::I64(4)),

2272 
D©um
::
	`By‹s
(
b
"Çme:0".
	`to_vec
()),

2273 
D©um
::
	`I64
(2),

2274 
D©um
::
	`I64
(1),

2277 
D©um
::
	`By‹s
(
b
"Çme:3".
	`to_vec
()),

2278 
D©um
::
	`I64
(3),

2279 
D©um
::
	`I64
(3),

2282 
D©um
::
	`By‹s
(
b
"Çme:5".
	`to_vec
()),

2283 
D©um
::
	`I64
(5),

2284 
D©um
::
	`I64
(4),

2286 (
D©um
::
	`By‹s
(
b
"Çme:6".
	`to_vec
()), D©um::
NuÎ
, Datum::Null),

2289 
Ët
 
»q
 = 
S–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2290 .
	`max
(
´oduù
.
couÁ
)

2291 .
	`mš
(
´oduù
.
couÁ
)

2292 .
	`group_by
(&[
´oduù
.
Çme
])

2293 .
	`bud
();

2294 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2295 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 
exp
.
	`Ën
());

2296 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

2297 
row
, (
Çme
, 
max
, 
mš
)è
š
 
¥l™”
.
	`z
(
exp
.
	`şÚe
()) {

2298 
Ët
 
gk
 = 
d©um
::
	`’code_v®ue
(&[
Çme
]).
	`unw¿p
();

2299 
Ët
 
ex³ùed_d©um
 = 
vec
![
D©um
::
	`By‹s
(
gk
), 
max
, 
mš
];

2300 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2301 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

2304 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
)

2305 .
	`max
(
´oduù
.
couÁ
)

2306 .
	`mš
(
´oduù
.
couÁ
)

2307 .
	`group_by
(&[
´oduù
.
Çme
])

2308 .
	`bud
();

2309 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2310 
Ët
 
mut
 
row_couÁ
 = 0;

2311 
Ët
 
exp_Ën
 = 
exp
.
	`Ën
();

2312 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

2313 
row
, (
Çme
, 
max
, 
mš
)è
š
 
¥l™”
.
	`z
(
exp
) {

2314 
Ët
 
ex³ùed_d©um
 = 
vec
![
max
, 
mš
, 
Çme
];

2315 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&
ex³ùed_d©um
).
	`unw¿p
();

2316 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

2317 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

2318 
row_couÁ
 += 1;

2320 
as£¹_eq
!(
row_couÁ
, 
exp_Ën
);

2321 
’d_pošt
.
	`¡İ
().
	`unw¿p
();

2322 
	}
}

2324 #[
‹¡
]

2325 
â
 
	$‹¡_wh”e
() {

2326 
Ët
 
d©a
 = 
vec
![

2327 (1, 
	`Some
("name:0"), 2),

2328 (2, 
	`Some
("name:4"), 3),

2329 (4, 
	`Some
("name:3"), 1),

2330 (5, 
	`Some
("name:1"), 4),

2333 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2334 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

2336 
Ët
 
cÚd
 = {

2337 
Ët
 
mut
 
cŞ
 = 
Ex´
::
	`Ãw
();

2338 
cŞ
.
	`£t_
(
Ex´Ty³
::
CŞumnRef
);

2339 
cŞ
.
	`mut_v®
().
	`’code_i64
(
´oduù
.
couÁ
.
id
).
	`unw¿p
();

2341 
Ët
 
mut
 
v®ue
 = 
Ex´
::
	`Ãw
();

2342 
v®ue
.
	`£t_
(
Ex´Ty³
::
SŒšg
);

2343 
v®ue
.
	`£t_v®
(
SŒšg
::
	`äom
("2").
	`što_by‹s
());

2345 
Ët
 
mut
 
cÚd
 = 
Ex´
::
	`Ãw
();

2346 
cÚd
.
	`£t_
(
Ex´Ty³
::
LT
);

2347 
cÚd
.
	`mut_chd»n
().
	`push
(
cŞ
);

2348 
cÚd
.
	`mut_chd»n
().
	`push
(
v®ue
);

2349 
cÚd


2352 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
).
	`wh”e_ex´
(
cÚd
).
	`bud
();

2353 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2354 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 1);

2355 
Ët
 
mut
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

2356 
Ët
 
row
 = 
¥l™”
.
	`Ãxt
().
	`unw¿p
();

2357 
	`Ët
 (
id
, 
Çme
, 
út
èğ
d©a
[2];

2358 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

2359 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
id
), 
Çme_d©um
, 
út
.
	`što
()]).
	`unw¿p
();

2360 
as£¹_eq
!(
id
, 
row
.
hªdË
);

2361 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

2363 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

2364 
	}
}

2367 #[
‹¡
]

2368 
â
 
	$‹¡_wh”e_fÜ_dag
() {

2369 
Ët
 
d©a
 = 
vec
![

2370 (1, 
	`Some
("name:0"), 2),

2371 (2, 
	`Some
("name:4"), 3),

2372 (4, 
	`Some
("name:3"), 1),

2373 (5, 
	`Some
("name:1"), 4),

2376 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2377 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

2378 
Ët
 
cŞs
 = 
´oduù
.
bË
.
	`g‘_bË_cŞumns
();

2379 
Ët
 
cÚd
 = {

2380 
Ët
 
mut
 
cŞ
 = 
Ex´
::
	`Ãw
();

2381 
cŞ
.
	`£t_
(
Ex´Ty³
::
CŞumnRef
);

2382 
Ët
 
couÁ_off£t
 = 
	`off£t_fÜ_cŞumn
(&
cŞs
, 
´oduù
.
couÁ
.
id
);

2383 
cŞ
.
	`mut_v®
().
	`’code_i64
(
couÁ_off£t
).
	`unw¿p
();

2385 
Ët
 
mut
 
v®ue
 = 
Ex´
::
	`Ãw
();

2386 
v®ue
.
	`£t_
(
Ex´Ty³
::
SŒšg
);

2387 
v®ue
.
	`£t_v®
(
SŒšg
::
	`äom
("2").
	`što_by‹s
());

2388 
Ët
 
mut
 
right
 = 
Ex´
::
	`Ãw
();

2389 
right
.
	`£t_
(
Ex´Ty³
::
SÿÏrFunc
);

2390 
right
.
	`£t_sig
(
SÿÏrFuncSig
::
Ca¡SŒšgAsIÁ
);

2391 
right
.
	`mut_chd»n
().
	`push
(
v®ue
);

2393 
Ët
 
mut
 
cÚd
 = 
Ex´
::
	`Ãw
();

2394 
cÚd
.
	`£t_
(
Ex´Ty³
::
SÿÏrFunc
);

2395 
cÚd
.
	`£t_sig
(
SÿÏrFuncSig
::
LTIÁ
);

2396 
cÚd
.
	`mut_chd»n
().
	`push
(
cŞ
);

2397 
cÚd
.
	`mut_chd»n
().
	`push
(
right
);

2398 
cÚd


2401 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
).
	`wh”e_ex´
(
cÚd
).
	`bud
();

2402 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2403 
Ët
 
mut
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

2404 
Ët
 
row
 = 
¥l™”
.
	`Ãxt
().
	`unw¿p
();

2405 
	`Ët
 (
id
, 
Çme
, 
út
èğ
d©a
[2];

2406 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

2407 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
id
), 
Çme_d©um
, 
út
.
	`što
()]).
	`unw¿p
();

2408 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

2409 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

2410 
as£¹_eq
!(
¥l™”
.
	`Ãxt
().
	`is_nÚe
(), 
Œue
);

2412 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

2413 
	}
}

2415 #[
‹¡
]

2416 
â
 
	$‹¡_hªdË_Œunÿ‹
() {

2417 
Ët
 
d©a
 = 
vec
![

2418 (1, 
	`Some
("name:0"), 2),

2419 (2, 
	`Some
("name:4"), 3),

2420 (4, 
	`Some
("name:3"), 1),

2421 (5, 
	`Some
("name:1"), 4),

2424 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2425 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

2427 
Ët
 
ÿ£s
 = 
vec
![

2430 
Ët
 
mut
 
cŞ
 = 
Ex´
::
	`Ãw
();

2431 
cŞ
.
	`£t_
(
Ex´Ty³
::
CŞumnRef
);

2432 
cŞ
.
	`mut_v®
().
	`’code_i64
(
´oduù
.
couÁ
.
id
).
	`unw¿p
();

2435 
Ët
 
mut
 
v®ue
 = 
Ex´
::
	`Ãw
();

2436 
v®ue
.
	`£t_
(
Ex´Ty³
::
SŒšg
);

2437 
v®ue
.
	`£t_v®
(
SŒšg
::
	`äom
("2x").
	`što_by‹s
());

2438 
Ët
 
mut
 
cÚd
 = 
Ex´
::
	`Ãw
();

2439 
cÚd
.
	`£t_
(
Ex´Ty³
::
LT
);

2440 
cÚd
.
	`mut_chd»n
().
	`push
(
cŞ
);

2441 
cÚd
.
	`mut_chd»n
().
	`push
(
v®ue
);

2442 
cÚd


2446 
Ët
 
mut
 
cŞ_id
 = 
Ex´
::
	`Ãw
();

2447 
cŞ_id
.
	`£t_
(
Ex´Ty³
::
CŞumnRef
);

2448 
cŞ_id
.
	`mut_v®
().
	`’code_i64
(
´oduù
.
id
.id).
	`unw¿p
();

2451 
Ët
 
mut
 
v®ue
 = 
Ex´
::
	`Ãw
();

2452 
v®ue
.
	`£t_
(
Ex´Ty³
::
SŒšg
);

2453 
v®ue
.
	`£t_v®
(
SŒšg
::
	`äom
("3x").
	`što_by‹s
());

2456 
Ët
 
mut
 
cŞ_couÁ
 = 
Ex´
::
	`Ãw
();

2457 
cŞ_couÁ
.
	`£t_
(
Ex´Ty³
::
CŞumnRef
);

2458 
cŞ_couÁ
.
	`mut_v®
().
	`’code_i64
(
´oduù
.
couÁ
.
id
).
	`unw¿p
();

2461 
Ët
 
mut
 
¶us
 = 
Ex´
::
	`Ãw
();

2462 
¶us
.
	`£t_
(
Ex´Ty³
::
Plus
);

2463 
¶us
.
	`mut_chd»n
().
	`push
(
v®ue
);

2464 
¶us
.
	`mut_chd»n
().
	`push
(
cŞ_couÁ
);

2467 
Ët
 
mut
 
cÚd
 = 
Ex´
::
	`Ãw
();

2468 
cÚd
.
	`£t_
(
Ex´Ty³
::
EQ
);

2469 
cÚd
.
	`mut_chd»n
().
	`push
(
cŞ_id
);

2470 
cÚd
.
	`mut_chd»n
().
	`push
(
¶us
);

2471 
cÚd


2475 
cÚd
 
š
 
ÿ£s
 {

2477 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

2478 .
	`wh”e_ex´
(
cÚd
.
	`şÚe
())

2479 .
	`bud_w™h
(&[
FLAG_IGNORE_TRUNCATE
]);

2480 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2481 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 1);

2482 
Ët
 
mut
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

2483 
Ët
 
row
 = 
¥l™”
.
	`Ãxt
().
	`unw¿p
();

2484 
	`Ët
 (
id
, 
Çme
, 
út
èğ
d©a
[2];

2485 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

2486 
Ët
 
ex³ùed_’coded
 =

2487 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
id
), 
Çme_d©um
, 
út
.
	`što
()]).
	`unw¿p
();

2488 
as£¹_eq
!(
id
, 
row
.
hªdË
);

2489 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

2492 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
´oduù
.
bË
)

2493 .
	`wh”e_ex´
(
cÚd
.
	`şÚe
())

2494 .
	`bud
();

2495 
	`Ët
 (
tx
, 
rx
èğ
mpsc
::
	`chªÃl
();

2496 
Ët
 
»q
 = 
Reque¡Task
::
	`Ãw
Ôeq, 
box
 
move
 |
r
| 
tx
.
	`£nd
Ô).
	`unw¿p
(), 100);

2497 
’d_pošt
.
	`scheduË
(
EndPoštTask
::
	`Reque¡
(
»q
)).
	`unw¿p
();

2498 
Ët
 
»¥
 = 
rx
.
	`»cv
().
	`unw¿p
();

2499 
as£¹
!(!
»¥
.
	`g‘_Ùh”_”rÜ
().
	`is_em±y
());

2502 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

2503 
	}
}

2505 #[
‹¡
]

2506 
â
 
	$‹¡_hªdË_Œunÿ‹_fÜ_dag
() {

2507 
Ët
 
d©a
 = 
vec
![

2508 (1, 
	`Some
("name:0"), 2),

2509 (2, 
	`Some
("name:4"), 3),

2510 (4, 
	`Some
("name:3"), 1),

2511 (5, 
	`Some
("name:1"), 4),

2514 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2515 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

2516 
Ët
 
cŞs
 = 
´oduù
.
bË
.
	`g‘_bË_cŞumns
();

2517 
Ët
 
ÿ£s
 = 
vec
![

2520 
Ët
 
mut
 
cŞ
 = 
Ex´
::
	`Ãw
();

2521 
cŞ
.
	`£t_
(
Ex´Ty³
::
CŞumnRef
);

2522 
Ët
 
couÁ_off£t
 = 
	`off£t_fÜ_cŞumn
(&
cŞs
, 
´oduù
.
couÁ
.
id
);

2523 
cŞ
.
	`mut_v®
().
	`’code_i64
(
couÁ_off£t
).
	`unw¿p
();

2526 
Ët
 
mut
 
v®ue
 = 
Ex´
::
	`Ãw
();

2527 
v®ue
.
	`£t_
(
Ex´Ty³
::
SŒšg
);

2528 
v®ue
.
	`£t_v®
(
SŒšg
::
	`äom
("2x").
	`što_by‹s
());

2530 
Ët
 
mut
 
right
 = 
Ex´
::
	`Ãw
();

2531 
right
.
	`£t_
(
Ex´Ty³
::
SÿÏrFunc
);

2532 
right
.
	`£t_sig
(
SÿÏrFuncSig
::
Ca¡SŒšgAsIÁ
);

2533 
right
.
	`mut_chd»n
().
	`push
(
v®ue
);

2536 
Ët
 
mut
 
cÚd
 = 
Ex´
::
	`Ãw
();

2537 
cÚd
.
	`£t_
(
Ex´Ty³
::
SÿÏrFunc
);

2538 
cÚd
.
	`£t_sig
(
SÿÏrFuncSig
::
LTIÁ
);

2539 
cÚd
.
	`mut_chd»n
().
	`push
(
cŞ
);

2540 
cÚd
.
	`mut_chd»n
().
	`push
(
right
);

2541 
cÚd


2545 
Ët
 
mut
 
cŞ_id
 = 
Ex´
::
	`Ãw
();

2546 
cŞ_id
.
	`£t_
(
Ex´Ty³
::
CŞumnRef
);

2547 
Ët
 
id_off£t
 = 
	`off£t_fÜ_cŞumn
(&
cŞs
, 
´oduù
.
id
.id);

2548 
cŞ_id
.
	`mut_v®
().
	`’code_i64
(
id_off£t
).
	`unw¿p
();

2551 
Ët
 
mut
 
v®ue
 = 
Ex´
::
	`Ãw
();

2552 
v®ue
.
	`£t_
(
Ex´Ty³
::
SŒšg
);

2553 
v®ue
.
	`£t_v®
(
SŒšg
::
	`äom
("3x").
	`što_by‹s
());

2555 
Ët
 
mut
 
št_3
 = 
Ex´
::
	`Ãw
();

2556 
št_3
.
	`£t_
(
Ex´Ty³
::
SÿÏrFunc
);

2557 
št_3
.
	`£t_sig
(
SÿÏrFuncSig
::
Ca¡SŒšgAsIÁ
);

2558 
št_3
.
	`mut_chd»n
().
	`push
(
v®ue
);

2561 
Ët
 
mut
 
cŞ_couÁ
 = 
Ex´
::
	`Ãw
();

2562 
cŞ_couÁ
.
	`£t_
(
Ex´Ty³
::
CŞumnRef
);

2563 
Ët
 
couÁ_off£t
 = 
	`off£t_fÜ_cŞumn
(&
cŞs
, 
´oduù
.
couÁ
.
id
);

2564 
cŞ_couÁ
.
	`mut_v®
().
	`’code_i64
(
couÁ_off£t
).
	`unw¿p
();

2567 
Ët
 
mut
 
¶us
 = 
Ex´
::
	`Ãw
();

2568 
¶us
.
	`£t_
(
Ex´Ty³
::
SÿÏrFunc
);

2569 
¶us
.
	`£t_sig
(
SÿÏrFuncSig
::
PlusIÁ
);

2570 
¶us
.
	`mut_chd»n
().
	`push
(
št_3
);

2571 
¶us
.
	`mut_chd»n
().
	`push
(
cŞ_couÁ
);

2574 
Ët
 
mut
 
cÚd
 = 
Ex´
::
	`Ãw
();

2575 
cÚd
.
	`£t_
(
Ex´Ty³
::
SÿÏrFunc
);

2576 
cÚd
.
	`£t_sig
(
SÿÏrFuncSig
::
EQIÁ
);

2577 
cÚd
.
	`mut_chd»n
().
	`push
(
cŞ_id
);

2578 
cÚd
.
	`mut_chd»n
().
	`push
(
¶us
);

2579 
cÚd


2583 
cÚd
 
š
 
ÿ£s
 {

2585 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

2586 .
	`wh”e_ex´
(
cÚd
.
	`şÚe
())

2587 .
	`bud_w™h
(&[
FLAG_IGNORE_TRUNCATE
]);

2588 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2589 
Ët
 
mut
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 3);

2590 
Ët
 
row
 = 
¥l™”
.
	`Ãxt
().
	`unw¿p
();

2591 
	`Ët
 (
id
, 
Çme
, 
út
èğ
d©a
[2];

2592 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

2593 
Ët
 
ex³ùed_’coded
 =

2594 
d©um
::
	`’code_v®ue
(&[
D©um
::
	`I64
(
id
), 
Çme_d©um
, 
út
.
	`što
()]).
	`unw¿p
();

2595 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

2596 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

2597 
as£¹_eq
!(
¥l™”
.
	`Ãxt
().
	`is_nÚe
(), 
Œue
);

2600 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

2601 .
	`wh”e_ex´
(
cÚd
.
	`şÚe
())

2602 .
	`bud
();

2603 
	`Ët
 (
tx
, 
rx
èğ
mpsc
::
	`chªÃl
();

2604 
Ët
 
»q
 = 
Reque¡Task
::
	`Ãw
Ôeq, 
box
 
move
 |
r
| 
tx
.
	`£nd
Ô).
	`unw¿p
(), 100);

2605 
’d_pošt
.
	`scheduË
(
EndPoštTask
::
	`Reque¡
(
»q
)).
	`unw¿p
();

2606 
Ët
 
»¥
 = 
rx
.
	`»cv
().
	`unw¿p
();

2607 
as£¹
!(!
»¥
.
	`g‘_Ùh”_”rÜ
().
	`is_em±y
());

2610 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

2611 
	}
}

2613 #[
‹¡
]

2614 
â
 
	$‹¡_deçuÉ_v®
() {

2615 
Ët
 
mut
 
d©a
 = 
vec
![

2616 (1, 
	`Some
("name:0"), 2),

2617 (2, 
	`Some
("name:3"), 3),

2618 (4, 
	`Some
("name:0"), 1),

2619 (5, 
	`Some
("name:5"), 4),

2620 (6, 
	`Some
("name:5"), 4),

2621 (7, 
NÚe
, 4),

2624 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2625 
Ët
 
added
 = 
CŞumnBud”
::
	`Ãw
().
	`cŞ_ty³
(
TYPE_LONG
).(3).
	`bud
();

2626 
Ët
 
mut
 
tbl
 = 
TabËBud”
::
	`Ãw
()

2627 .
	`add_cŞ
(
´oduù
.
id
)

2628 .
	`add_cŞ
(
´oduù
.
Çme
)

2629 .
	`add_cŞ
(
´oduù
.
couÁ
)

2630 .
	`add_cŞ
(
added
)

2631 .
	`bud
();

2632 
tbl
.
id
 = 
´oduù
.
bË
.id;

2634 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

2635 
Ët
 
ex³ù
: 
Vec
<
_
> = 
d©a
.
	`d¿š
(..5).
	`cŞËù
();

2637 
Ët
 
»q
 = 
S–eù
::
	`äom
(&
tbl
).
	`lim™
(5).
	`bud
();

2638 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2639 
as£¹_eq
!(
	`row_út
(
»¥
.
	`g‘_chunks
()), 5);

2640 
Ët
 
¥l™”
 = 
ChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
());

2641 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
ex³ù
.
	`şÚe
()) {

2642 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

2643 
Ët
 
ex³ùed_’coded
 =

2644 
d©um
::
	`’code_v®ue
(&[
id
.
	`što
(), 
Çme_d©um
, 
út
.što(), 
D©um
::
	`I64
(3)]).
	`unw¿p
();

2645 
as£¹_eq
!(
id
, 
row
.
hªdË
);

2646 
as£¹_eq
!(
row
.
d©a
, &*
ex³ùed_’coded
);

2649 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
tbl
).
	`lim™
(5).
	`bud
();

2650 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2651 
Ët
 
mut
 
row_couÁ
 = 0;

2652 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 4);

2653 
row
, (
id
, 
Çme
, 
út
)è
š
 
¥l™”
.
	`z
(
ex³ù
) {

2654 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

2655 
Ët
 
ex³ùed_’coded
 =

2656 
d©um
::
	`’code_v®ue
(&[
id
.
	`što
(), 
Çme_d©um
, 
út
.što(), 
D©um
::
	`I64
(3)]).
	`unw¿p
();

2657 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

2658 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

2659 
row_couÁ
 += 1;

2661 
as£¹_eq
!(
row_couÁ
, 5);

2663 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

2664 
	}
}

2667 #[
‹¡
]

2668 
â
 
	$‹¡_ouut_off£ts
() {

2669 
Ët
 
d©a
 = 
vec
![

2670 (1, 
	`Some
("name:0"), 2),

2671 (2, 
	`Some
("name:4"), 3),

2672 (4, 
	`Some
("name:3"), 1),

2673 (5, 
	`Some
("name:1"), 4),

2676 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2677 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_w™h_d©a
(&
´oduù
, &
d©a
);

2679 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
)

2680 .
	`ouut_off£ts
(
	`Some
(
vec
![1]))

2681 .
	`bud
();

2682 
Ët
 
mut
 
»¥
 = 
	`hªdË_£Ëù
(&
’d_pošt
, 
»q
);

2683 
Ët
 
¥l™”
 = 
DAGChunkS¶™”
::
	`Ãw
(
»¥
.
	`ke_chunks
().
	`što_vec
(), 1);

2684 
row
, (
_
, 
Çme
, _)è
š
 
¥l™”
.
	`z
(
d©a
) {

2685 
Ët
 
Çme_d©um
 = 
Çme
.
	`m­
(|
s
| s.
	`as_by‹s
()).
	`što
();

2686 
Ët
 
ex³ùed_’coded
 = 
d©um
::
	`’code_v®ue
(&[
Çme_d©um
]).
	`unw¿p
();

2687 
Ët
 
»suÉ_’coded
 = 
d©um
::
	`’code_v®ue
(&
row
).
	`unw¿p
();

2688 
as£¹_eq
!(&*
»suÉ_’coded
, &*
ex³ùed_’coded
);

2691 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

2692 
	}
}

2694 #[
‹¡
]

2695 
â
 
	$‹¡_key_is_locked_fÜ_´im¬y
() {

2696 
Ët
 
d©a
 = 
vec
![

2697 (1, 
	`Some
("name:0"), 2),

2698 (2, 
	`Some
("name:4"), 3),

2699 (4, 
	`Some
("name:3"), 1),

2700 (5, 
	`Some
("name:1"), 4),

2703 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2704 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_d©a_w™h_comm™
(&
´oduù
, &
d©a
, 
çl£
);

2706 
Ët
 
»q
 = 
DAGS–eù
::
	`äom
(&
´oduù
.
bË
).
	`bud
();

2707 
Ët
 
»¥
 = 
	`hªdË_»que¡
(&
’d_pošt
, 
»q
);

2708 
as£¹
!(
»¥
.
	`g‘_d©a
().
	`is_em±y
(), "{:?}",„esp);

2709 
as£¹
!(
»¥
.
	`has_locked
(), "{:?}",„esp);

2710 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

2711 
	}
}

2713 #[
‹¡
]

2714 
â
 
	$‹¡_key_is_locked_fÜ_šdex
() {

2715 
Ët
 
d©a
 = 
vec
![

2716 (1, 
	`Some
("name:0"), 2),

2717 (2, 
	`Some
("name:4"), 3),

2718 (4, 
	`Some
("name:3"), 1),

2719 (5, 
	`Some
("name:1"), 4),

2722 
Ët
 
´oduù
 = 
ProduùTabË
::
	`Ãw
();

2723 
	`Ët
 (
_
, 
mut
 
’d_pošt
èğ
	`š™_d©a_w™h_comm™
(&
´oduù
, &
d©a
, 
çl£
);

2725 
Ët
 
»q
 = 
DAGS–eù
::
	`äom_šdex
(&
´oduù
.
bË
,…roduù.
Çme
).
	`bud
();

2726 
Ët
 
»¥
 = 
	`hªdË_»que¡
(&
’d_pošt
, 
»q
);

2727 
as£¹
!(
»¥
.
	`g‘_d©a
().
	`is_em±y
(), "{:?}",„esp);

2728 
as£¹
!(
»¥
.
	`has_locked
(), "{:?}",„esp);

2729 
’d_pošt
.
	`¡İ
().
	`unw¿p
().
	`još
().unwrap();

2730 
	}
}

	@tests/failpoints.rs

15 #![
ã©u»
(
âbox
)]

16 #![
ã©u»
(
¦iû_·‰”ns
)]

17 #![
ã©u»
(
box_syÁax
)]

18 #![
cfg_©Œ
(
ã©u»
 = "dev", f—tu»(
¶ugš
))]

19 #![
cfg_©Œ
(
ã©u»
 = "dev", 
¶ugš
(
şpy
))]

20 #![
cfg_©Œ
(
nÙ
(
ã©u»
 = "dev"), 
®low
(
unknown_lšts
))]

21 #![
cfg_©Œ
(
ã©u»
 = "no-ç", 
®low
(
d—d_code
))]

22 #![
»cursiÚ_lim™
 = "100"]

23 #![
®low
(
moduË_šû±iÚ
)]

24 #![
®low
(
should_im¶em’t_Œa™
)]

25 #![
®low
(
Ïrge_’um_v¬ŸÁ
)]

26 #![
®low
(
ÃedËss_·ss_by_v®ue
)]

27 #![
®low
(
uÄ—dabË_l™”®
)]

28 #![
®low
(
Ãw_w™hout_deçuÉ_d”ive
)]

29 #![
®low
(
v”bo£_b™_mask
)]

31 #[
maüo_u£
]

32 
ü©e
 
log
;

33 
ü©e
 
´Ùobuf
;

34 #[
maüo_u£
]

35 
ü©e
 
tikv
;

36 
ü©e
 
¿nd
;

37 
ü©e
 
rocksdb
;

38 
ü©e
 
‹mpdœ
;

39 
ü©e
 
kv´Ùo
;

40 
ü©e
 
tb
;

41 
ü©e
 
g½cio
 
as
 
g½c
;

42 
ü©e
 
futu»s
;

43 
ü©e
 
futu»s_ıupoŞ
;

44 
ü©e
 
toml
;

45 
ü©e
 
ç
;

46 #[
maüo_u£
]

47 
ü©e
 
Ïzy_¡©ic
;

49 #[
®low
(
d—d_code
)]

50 
mod
 
	g¿á¡Üe
;

51 #[
cfg
(
nÙ
(
ã©u»
 = "no-fail"))]

52 
mod
 
	gçpošts_ÿ£s
;

54 
u£
 
	g¡d
::
sync
::*;

56 
	gÏzy_¡©ic
! {

59 
»f
 
	gLOCK
: 
Mu‹x
<()> = Mu‹x::
Ãw
(());

62 
â
 
	g£tup
<'a>(è-> Mu‹xGu¬d<'
	ga
, ()> {

63 
Ët
 
	ggu¬d
 = 
LOCK
.
lock
().
unw¿p
();

64 
	gç
::
‹¬down
();

65 
	gç
::
£tup
();

66 
	ggu¬d


	@tests/failpoints_cases/mod.rs

14 
mod
 
	g‹¡_³ndšg_³”s
;

15 
mod
 
	g‹¡_¢­
;

	@tests/failpoints_cases/test_pending_peers.rs

15 
u£
 
	g¡d
::
th»ad
::*;

16 
u£
 
	g¡d
::
time
::*;

18 
u£
 
	gç
;

19 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

21 
u£
 
	g¿á¡Üe
::
node
::
Ãw_node_şu¡”
;

22 
u£
 
	g¿á¡Üe
::
ut
::*;

25 #[
‹¡
]

26 
â
 
	$‹¡_³ndšg_³”s
() {

27 
Ët
 
_gu¬d
 = ::
	`£tup
();

28 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

29 
şu¡”
.
cfg
.
¿á_¡Üe
.
pd_h—¹b—t_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
	`mlis
(100);

31 
Ët
 
»giÚ_wÜk”_å
 = "tikv::raftstore::store::worker::region::apply_snap";

33 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
	`şÚe
();

35 
pd_ş›Á
.
	`di§bË_deçuÉ_ruË
();

37 
Ët
 
»giÚ_id
 = 
şu¡”
.
	`run_cÚf_chªge
();

38 
pd_ş›Á
.
	`mu¡_add_³”
(
»giÚ_id
, 
	`Ãw_³”
(2, 2));

40 
şu¡”
.
	`mu¡_put
(
b
"k1", b"v1");

42 
ç
::
	`cfg
(
»giÚ_wÜk”_å
, "¦“p(2000)").
	`unw¿p
();

43 
pd_ş›Á
.
	`mu¡_add_³”
(
»giÚ_id
, 
	`Ãw_³”
(3, 3));

44 
	`¦“p
(
Du¿tiÚ
::
	`äom_£cs
(1));

45 
Ët
 
³ndšg_³”s
 = 
pd_ş›Á
.
	`g‘_³ndšg_³”s
();

47 
as£¹_eq
!(
³ndšg_³”s
[&3], 
	`Ãw_³”
(3, 3));

49 
	`mu¡_g‘_equ®
(&
şu¡”
.
	`g‘_’gše
(3), 
b
"k1", b"v1");

50 
	`¦“p
(
Du¿tiÚ
::
	`äom_mlis
(100));

51 
Ët
 
³ndšg_³”s
 = 
pd_ş›Á
.
	`g‘_³ndšg_³”s
();

52 
as£¹
!(
³ndšg_³”s
.
	`is_em±y
());

53 
	}
}

	@tests/failpoints_cases/test_snap.rs

15 
u£
 
	g¡d
::*;

16 
u£
 
	g¡d
::
time
::*;

18 
u£
 
	gç
;

19 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

21 
u£
 
	g¿á¡Üe
::
node
::
Ãw_node_şu¡”
;

22 
u£
 
	g¿á¡Üe
::
ut
::*;

25 #[
‹¡
]

26 
â
 
	$‹¡_ov”Ïp_ş—nup
() {

27 
Ët
 
_gu¬d
 = ::
	`£tup
();

28 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

30 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
	`£cs
(60);

32 
Ët
 
g’_¢­shÙ_å
 = "tikv::raftstore::store::worker::region::handle_gen";

34 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
	`şÚe
();

36 
pd_ş›Á
.
	`di§bË_deçuÉ_ruË
();

38 
Ët
 
»giÚ_id
 = 
şu¡”
.
	`run_cÚf_chªge
();

39 
pd_ş›Á
.
	`mu¡_add_³”
(
»giÚ_id
, 
	`Ãw_³”
(2, 2));

41 
şu¡”
.
	`mu¡_put
(
b
"k1", b"v1");

42 
	`mu¡_g‘_equ®
(&
şu¡”
.
	`g‘_’gše
(2), 
b
"k1", b"v1");

46 
ç
::
	`cfg
(
g’_¢­shÙ_å
, "·u£").
	`unw¿p
();

47 
pd_ş›Á
.
	`mu¡_add_³”
(
»giÚ_id
, 
	`Ãw_³”
(3, 3));

48 
şu¡”
.
	`mu¡_put
(
b
"k3", b"v3");

49 
Ët
 
»giÚ1
 = 
şu¡”
.
	`g‘_»giÚ
(
b
"k1");

50 
şu¡”
.
	`mu¡_¥l™
(&
»giÚ1
, 
b
"k2");

52 
	`mu¡_g‘_equ®
(&
şu¡”
.
	`g‘_’gše
(3), 
b
"k1", b"v1");

55 
ç
::
	`cfg
(
g’_¢­shÙ_å
, "·u£").
	`unw¿p
();

57 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_£cs
(1));

59 
Ët
 
¢­_dœ
 = 
şu¡”
.
	`g‘_¢­_dœ
(3);

60 
p
 
š
 
fs
::
	`»ad_dœ
(&
¢­_dœ
).
	`unw¿p
() {

61 
Ët
 
Çme
 = 
p
.
	`unw¿p
().
	`fe_Çme
().
	`što_¡ršg
().unwrap();

62 
Ët
 
mut
 
·¹s
 = 
Çme
.
	`¥l™
('_');

63 
·¹s
.
	`Ãxt
();

64 
·¹s
.
	`Ãxt
().
	`unw¿p
() == "1" {

65 
·nic
!("snapshot of„egion 1 should be deleted.");

68 
ç
::
	`»move
(
g’_¢­shÙ_å
);

69 
	}
}

	@tests/integrations.rs

14 #![
®low
(
¡abË_ã©u»s
)]

15 #![
ã©u»
(
mpsc_»cv_timeout
)]

16 #![
ã©u»
(
¶ugš
)]

17 #![
ã©u»
(
‹¡
)]

18 #![
cfg_©Œ
(
ã©u»
 = "dev", 
¶ugš
(
şpy
))]

19 #![
cfg_©Œ
(
nÙ
(
ã©u»
 = "dev"), 
®low
(
unknown_lšts
))]

20 #![
ã©u»
(
bŒ“_¿nge
, 
cŞËùiÚs_bound
)]

21 #![
ã©u»
(
box_syÁax
)]

22 #![
ã©u»
(
âbox
)]

23 #![
®low
(
Ãw_w™hout_deçuÉ
)]

24 #![
ã©u»
(
cÚ¡_â
)]

25 #![
®low
(
ÃedËss_·ss_by_v®ue
)]

26 #![
®low
(
uÄ—dabË_l™”®
)]

28 #[
cfg
(
ã©u»
 = "mem-profiling")]

29 
ü©e
 
jem®loÿtÜ
;

30 #[
maüo_u£
]

31 
ü©e
 
log
;

32 
ü©e
 
´Ùobuf
;

33 #[
maüo_u£
]

34 
ü©e
 
tikv
;

35 
ü©e
 
¿nd
;

36 
ü©e
 
rocksdb
;

37 
ü©e
 
‹mpdœ
;

38 
ü©e
 
kv´Ùo
;

39 
ü©e
 
tb
;

40 
ü©e
 
‹¡
;

41 
ü©e
 
g½cio
 
as
 
g½c
;

42 
ü©e
 
futu»s
;

43 
ü©e
 
futu»s_ıupoŞ
;

44 
ü©e
 
toml
;

46 
mod
 
	g¿á
;

47 
mod
 
	g¿á¡Üe
;

48 
mod
 
	g¿á¡Üe_ÿ£s
;

49 
mod
 
	gcİroûssÜ
;

50 
mod
 
	g¡Üage
;

51 
mod
 
	gut
;

52 
mod
 
	gpd
;

53 
mod
 
	gcÚfig
;

55 
u£
 
	g¡d
::
’v
;

57 #[
‹¡
]

58 
â
 
	$_0_ci_£tup
() {

61 
’v
::
	`v¬
("CI").
	`is_ok
() &&ƒnv::var("LOG_FILE").is_ok() {

62 
£lf
::
ut
::
	`š™_log
();

64 
	}
}

66 #[
‹¡
]

67 
â
 
	$_1_check_sy¡em_»quœem’t
() {

68 
Ët
 
	`E¼
(
e
èğ
tikv
::
ut
::
cÚfig
::
	`check_max_İ’_fds
(4096) {

69 
·nic
!(

72 
e


75 
	}
}

	@tests/pd/mock/mocker/bootstrap.rs

14 
u£
 
	gkv´Ùo
::
pdpb
::*;

16 
u£
 
	gsu³r
::*;

18 #[
d”ive
(
Debug
)]

19 
pub
 
	gAÌ—dyBoÙ¡¿µed
;

21 
im¶
 
PdMock”
 
	gAÌ—dyBoÙ¡¿µed
 {

22 
â
 
boÙ¡¿p
(&
£lf
, 
_
: &
BoÙ¡¿pReque¡
è-> 
O±iÚ
<
ResuÉ
<
BoÙ¡¿pRe¥Ú£
>> {

23 
Ët
 
mut
 
”r
 = 
E¼Ü
::
Ãw
();

24 
	g”r
.
£t_f›ld_ty³
(
E¼ÜTy³
::
ALREADY_BOOTSTRAPPED
);

25 
	g”r
.
£t_mes§ge
("şu¡” i ®»ady boÙ¡¿µed".
to_owÃd
());

27 
Ët
 
mut
 
	gh—d”
 = 
Re¥Ú£H—d”
::
Ãw
();

28 
	gh—d”
.
£t_”rÜ
(
”r
);

29 
	gh—d”
.
£t_şu¡”_id
(
DEFAULT_CLUSTER_ID
);

31 
Ët
 
mut
 
	g»¥
 = 
BoÙ¡¿pRe¥Ú£
::
Ãw
();

32 
	g»¥
.
£t_h—d”
(
h—d”
);

34 
Some
(
Ok
(
»¥
))

37 
â
 
is_boÙ¡¿µed
(&
£lf
, 
_
: &
IsBoÙ¡¿µedReque¡
è-> 
O±iÚ
<
ResuÉ
<
IsBoÙ¡¿µedRe¥Ú£
>> {

38 
Ët
 
mut
 
h—d”
 = 
Re¥Ú£H—d”
::
Ãw
();

39 
	gh—d”
.
£t_şu¡”_id
(
DEFAULT_CLUSTER_ID
);

41 
Ët
 
mut
 
	g»¥
 = 
IsBoÙ¡¿µedRe¥Ú£
::
Ãw
();

42 
	g»¥
.
£t_boÙ¡¿µed
(
çl£
);

44 
Some
(
Ok
(
»¥
))

	@tests/pd/mock/mocker/leader_change.rs

14 
u£
 
	g¡d
::
sync
::
Mu‹x
;

15 
u£
 
	g¡d
::
time
::{
Du¿tiÚ
, 
	gIn¡ªt
};

17 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

18 
u£
 
	gkv´Ùo
::
pdpb
::*;

20 
u£
 
	gsu³r
::*;

22 
pub
 cÚ¡ 
	gLEADER_INTERVAL_SEC
: 
u64
 = 2;

24 #[
d”ive
(
Debug
)]

25 
	sRouË‰e
 {

26 
	mts
: 
In¡ªt
,

27 
	midx
: 
usize
,

30 #[
d”ive
(
Debug
)]

31 
	sIÂ”
 {

32 
	m»¥s
: 
Vec
<
G‘Memb”sRe¥Ú£
>,

33 
	mr
: 
RouË‰e
,

36 #[
d”ive
(
Debug
)]

37 
pub
 
	sL—d”Chªge
 {

38 
	mšÃr
: 
Mu‹x
<
IÂ”
>,

41 
im¶
 
	gL—d”Chªge
 {

42 
pub
 
â
 
Ãw
(è-> 
	gL—d”Chªge
 {

43 
	gL—d”Chªge
 {

44 
	gšÃr
: 
Mu‹x
::
Ãw
(
IÂ”
 {

45 
»¥s
: 
vec
![],

46 
r
: 
RouË‰e
 {

47 
ts
: 
In¡ªt
::
now
(),

48 
idx
: 0,

54 
pub
 
â
 
g‘_Ëad”_š‹rv®
(è-> 
	gDu¿tiÚ
 {

55 
	gDu¿tiÚ
::
äom_£cs
(
LEADER_INTERVAL_SEC
)

59 cÚ¡ 
DEAD_ID
: 
u64
 = 1000;

60 cÚ¡ 
	gDEAD_NAME
: &'static str = "walking_dead";

61 cÚ¡ 
DEAD_URL
: &'static str = "127.0.0.1:65534";

63 
im¶
 
PdMock”
 
L—d”Chªge
 {

64 
â
 
g‘_memb”s
(&
£lf
, 
_
: &
G‘Memb”sReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘Memb”sRe¥Ú£
>> {

65 
Ët
 
mut
 
šÃr
 = 
£lf
.šÃr.
lock
().
unw¿p
();

66 
Ët
 
	gnow
 = 
In¡ªt
::
now
();

67 
	gnow
 - 
	gšÃr
.
	gr
.
	gts
 > 
	gL—d”Chªge
::
g‘_Ëad”_š‹rv®
() {

68 
šÃr
.
r
.
idx
 += 1;

69 
	gšÃr
.
	gr
.
	gts
 = 
now
;

70  
Some
(
E¼
("nÙ†—d”".
to_owÃd
()));

73 
	gšfo
!(

75 
	gšÃr
.
	g»¥s
[
šÃr
.
r
.
idx
 % iÂ”.
»¥s
.
Ën
()]

77 
Some
(
Ok
(
šÃr
.
»¥s
[šÃr.
r
.
idx
 % iÂ”.»¥s.
Ën
()].
şÚe
()))

80 
â
 
g‘_»giÚ_by_id
(&
£lf
, 
_
: &
G‘RegiÚByIDReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘RegiÚRe¥Ú£
>> {

81 
Ët
 
mut
 
šÃr
 = 
£lf
.šÃr.
lock
().
unw¿p
();

82 
Ët
 
	gnow
 = 
In¡ªt
::
now
();

83 
	gnow
.
du¿tiÚ_sšû
(
šÃr
.
r
.
ts
è> 
	gL—d”Chªge
::
g‘_Ëad”_š‹rv®
() {

84 
šÃr
.
r
.
idx
 += 1;

85 
	gšÃr
.
	gr
.
	gts
 = 
now
;

86 
	gdebug
!(

88 
	gšÃr
.
	g»¥s
[
šÃr
.
r
.
idx
 % iÂ”.
»¥s
.
Ën
()].
g‘_Ëad”
()

92 
Some
(
E¼
("nÙ†—d”".
to_owÃd
()))

95 
â
 
£t_’dpošts
(&
£lf
, 
•s
: 
Vec
<
SŒšg
>) {

96 
Ët
 
mut
 
memb”s
 = 
Vec
::
w™h_ÿ·c™y
(
•s
.
Ën
());

97 
	gi
, 
	g•
è
š
 (&
•s
).
što_™”
().
’um”©e
() {

98 
Ët
 
mut
 
	gm
 = 
Memb”
::
Ãw
();

99 
	gm
.
£t_Çme
(
fÜm©
!("pd{}", 
i
));

100 
	gm
.
£t_memb”_id
(100 + 
i
 
as
 
u64
);

101 
	gm
.
£t_ş›Á_u¾s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
•
.
to_owÃd
()]));

102 
	gm
.
£t_³”_u¾s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
•
.
to_owÃd
()]));

103 
	gmemb”s
.
push
(
m
);

107 
Ët
 
mut
 
	gm
 = 
Memb”
::
Ãw
();

108 
	gm
.
£t_memb”_id
(
DEAD_ID
);

109 
	gm
.
£t_Çme
(
DEAD_NAME
.
to_owÃd
());

110 
	gm
.
£t_ş›Á_u¾s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
DEAD_URL
.
to_owÃd
()]));

111 
	gm
.
£t_³”_u¾s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
DEAD_URL
.
to_owÃd
()]));

112 
	gmemb”s
.
push
(
m
);

114 
Ët
 
mut
 
	gh—d”
 = 
Re¥Ú£H—d”
::
Ãw
();

115 
	gh—d”
.
£t_şu¡”_id
(1);

117 
Ët
 
mut
 
	g»¥s
 = 
Vec
::
w™h_ÿ·c™y
(
•s
.
Ën
());

118 
	gi
, 
	g_
è
š
 (&
•s
).
što_™”
().
’um”©e
() {

119 
Ët
 
mut
 
	g»¥
 = 
G‘Memb”sRe¥Ú£
::
Ãw
();

120 
	g»¥
.
£t_h—d”
(
h—d”
.
şÚe
());

121 
	g»¥
.
£t_memb”s
(
R•—‹dF›ld
::
äom_vec
(
memb”s
.
şÚe
()));

122 
	g»¥
.
£t_Ëad”
(
memb”s
[
i
].
şÚe
());

123 
	g»¥s
.
push
(
»¥
);

126 
	gšfo
!("[L—”Chªge] s‘_’dpošt {:?}", 
	g»¥s
);

127 
Ët
 
mut
 
	gšÃr
 = 
£lf
.
šÃr
.
lock
().
unw¿p
();

128 
	gšÃr
.
	g»¥s
 = 
»¥s
;

	@tests/pd/mock/mocker/mod.rs

14 
u£
 
	g¡d
::
»suÉ
;

16 
u£
 
	gkv´Ùo
::
pdpb
::*;

18 
mod
 
	g£rviû
;

19 
mod
 
	g¥l™
;

20 
mod
 
	gboÙ¡¿p
;

21 
mod
 
	gËad”_chªge
;

22 
mod
 
	g»Œy
;

24 
pub
 
u£
 
	g£lf
::
£rviû
::
S”viû
;

25 
pub
 
u£
 
	g£lf
::
¥l™
::
S¶™
;

26 
pub
 
u£
 
	g£lf
::
boÙ¡¿p
::
AÌ—dyBoÙ¡¿µed
;

27 
pub
 
u£
 
	g£lf
::
Ëad”_chªge
::
L—d”Chªge
;

28 
pub
 
u£
 
	g£lf
::
»Œy
::
R‘ry
;

30 
pub
 cÚ¡ 
	gDEFAULT_CLUSTER_ID
: 
u64
 = 42;

32 
pub
 
ty³
 
	gResuÉ
<
	gT
> = 
»suÉ
::
ResuÉ
<
T
, 
	gSŒšg
>;

34 
pub
 
Œa™
 
	gPdMock”
 {

35 
â
 
g‘_memb”s
(&
£lf
, 
_
: &
G‘Memb”sReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘Memb”sRe¥Ú£
>> {

36 
NÚe


39 
â
 
tso
(&
£lf
, 
_
: &
TsoReque¡
è-> 
O±iÚ
<
ResuÉ
<
TsoRe¥Ú£
>> {

40 
NÚe


43 
â
 
boÙ¡¿p
(&
£lf
, 
_
: &
BoÙ¡¿pReque¡
è-> 
O±iÚ
<
ResuÉ
<
BoÙ¡¿pRe¥Ú£
>> {

44 
NÚe


47 
â
 
is_boÙ¡¿µed
(&
£lf
, 
_
: &
IsBoÙ¡¿µedReque¡
è-> 
O±iÚ
<
ResuÉ
<
IsBoÙ¡¿µedRe¥Ú£
>> {

48 
NÚe


51 
â
 
®loc_id
(&
£lf
, 
_
: &
AÎocIDReque¡
è-> 
O±iÚ
<
ResuÉ
<
AÎocIDRe¥Ú£
>> {

52 
NÚe


55 
â
 
g‘_¡Üe
(&
£lf
, 
_
: &
G‘StÜeReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘StÜeRe¥Ú£
>> {

56 
NÚe


59 
â
 
put_¡Üe
(&
£lf
, 
_
: &
PutStÜeReque¡
è-> 
O±iÚ
<
ResuÉ
<
PutStÜeRe¥Ú£
>> {

60 
NÚe


63 
â
 
¡Üe_h—¹b—t
(&
£lf
, 
_
: &
StÜeH—¹b—tReque¡
è-> 
O±iÚ
<
ResuÉ
<
StÜeH—¹b—tRe¥Ú£
>> {

64 
NÚe


67 
â
 
»giÚ_h—¹b—t
(

68 &
£lf
,

69 
_
: &
RegiÚH—¹b—tReque¡
,

70 è-> 
	gO±iÚ
<
	gResuÉ
<
	gRegiÚH—¹b—tRe¥Ú£
>> {

71 
	gNÚe


74 
â
 
g‘_»giÚ
(&
£lf
, 
_
: &
G‘RegiÚReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘RegiÚRe¥Ú£
>> {

75 
NÚe


78 
â
 
g‘_»giÚ_by_id
(&
£lf
, 
_
: &
G‘RegiÚByIDReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘RegiÚRe¥Ú£
>> {

79 
NÚe


82 
â
 
ask_¥l™
(&
£lf
, 
_
: &
AskS¶™Reque¡
è-> 
O±iÚ
<
ResuÉ
<
AskS¶™Re¥Ú£
>> {

83 
NÚe


86 
â
 
»pÜt_¥l™
(&
£lf
, 
_
: &
R•ÜtS¶™Reque¡
è-> 
O±iÚ
<
ResuÉ
<
R•ÜtS¶™Re¥Ú£
>> {

87 
NÚe


90 
â
 
g‘_şu¡”_cÚfig
(

91 &
£lf
,

92 
_
: &
G‘Clu¡”CÚfigReque¡
,

93 è-> 
	gO±iÚ
<
	gResuÉ
<
	gG‘Clu¡”CÚfigRe¥Ú£
>> {

94 
	gNÚe


97 
â
 
put_şu¡”_cÚfig
(

98 &
£lf
,

99 
_
: &
PutClu¡”CÚfigReque¡
,

100 è-> 
	gO±iÚ
<
	gResuÉ
<
	gPutClu¡”CÚfigRe¥Ú£
>> {

101 
	gNÚe


104 
â
 
£t_’dpošts
(&
£lf
, 
_
: 
Vec
<
SŒšg
>) {}

	@tests/pd/mock/mocker/retry.rs

14 
u£
 
	g¡d
::
th»ad
;

15 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

16 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

18 
u£
 
	gkv´Ùo
::
pdpb
::*;

19 
u£
 
	gtikv
::
pd
::
RECONNECT_INTERVAL_SEC
;

21 
u£
 
	gsu³r
::*;

23 #[
d”ive
(
Debug
)]

24 
pub
 
	sR‘ry
 {

25 
	m»Œy
: 
usize
,

26 
	mcouÁ
: 
AtomicUsize
,

29 
im¶
 
	gR‘ry
 {

30 
pub
 
â
 
Ãw
(
»Œy
: 
usize
è-> 
R‘ry
 {

31 
šfo
!("[R‘ry]„‘uº Ok(_èev”y {:?}imes", 
	g»Œy
);

33 
	gR‘ry
 {

34 
	g»Œy
: 
»Œy
,

35 
	gcouÁ
: 
AtomicUsize
::
Ãw
(0),

39 
â
 
is_ok
(&
£lf
è-> 
	gboŞ
 {

40 
Ët
 
	gcouÁ
 = 
£lf
.
couÁ
.
ãtch_add
(1, 
Ord”šg
::
SeqC¡
);

41 
	gcouÁ
 !ğ0 && 
couÁ
 % 
£lf
.
»Œy
 == 0 {

43  
Œue
;

46 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_£cs
(
RECONNECT_INTERVAL_SEC
));

47 
	gçl£


51 
im¶
 
PdMock”
 
	gR‘ry
 {

52 
â
 
g‘_»giÚ_by_id
(&
£lf
, 
_
: &
G‘RegiÚByIDReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘RegiÚRe¥Ú£
>> {

53 
£lf
.
is_ok
() {

54 
šfo
!("[Retry] get_region_by_id„eturns Ok(_)");

55 
Some
(
Ok
(
G‘RegiÚRe¥Ú£
::
Ãw
()))

57 
šfo
!("[Retry] get_region_by_id„eturns Err(_)");

58 
Some
(
E¼
("¶—£„‘ry".
to_owÃd
()))

62 
â
 
g‘_¡Üe
(&
£lf
, 
_
: &
G‘StÜeReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘StÜeRe¥Ú£
>> {

63 
£lf
.
is_ok
() {

64 
šfo
!("[Retry] get_store„eturns Ok(_)");

65 
Some
(
Ok
(
G‘StÜeRe¥Ú£
::
Ãw
()))

67 
šfo
!("[Retry] get_store„eturns Err(_)");

68 
Some
(
E¼
("¶—£„‘ry".
to_owÃd
()))

	@tests/pd/mock/mocker/service.rs

14 
u£
 
	g¡d
::
cŞËùiÚs
::
HashM­
;

15 
u£
 
	g¡d
::
sync
::
Mu‹x
;

16 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

18 
u£
 
	gkv´Ùo
::
m‘­b
::{
RegiÚ
, 
	gStÜe
};

19 
u£
 
	gkv´Ùo
::
pdpb
::*;

21 
u£
 
	g´Ùobuf
::{
Mes§ge
, 
	gR•—‹dF›ld
};

23 
u£
 
	gsu³r
::*;

25 #[
d”ive
(
Debug
)]

26 
pub
 
	sS”viû
 {

27 
	mid_®loÿtÜ
: 
AtomicUsize
,

28 
	mmemb”s_»¥
: 
Mu‹x
<
O±iÚ
<
G‘Memb”sRe¥Ú£
>>,

29 
	m¡Üage
: 
Mu‹x
<
HashM­
<
SŒšg
, 
	mVec
<
	mu8
>>>,

32 
im¶
 
	gS”viû
 {

33 
pub
 
â
 
Ãw
(è-> 
	gS”viû
 {

34 
	gS”viû
 {

35 
	gmemb”s_»¥
: 
Mu‹x
::
Ãw
(
NÚe
),

36 
	gid_®loÿtÜ
: 
AtomicUsize
::
Ãw
(1),

37 
	g¡Üage
: 
Mu‹x
::
Ãw
(
HashM­
::new()),

41 
â
 
h—d”
(è-> 
	gRe¥Ú£H—d”
 {

42 
Ët
 
mut
 
	gh—d”
 = 
Re¥Ú£H—d”
::
Ãw
();

43 
	gh—d”
.
£t_şu¡”_id
(
DEFAULT_CLUSTER_ID
);

44 
	gh—d”


48 
â
 
make_memb”s_»¥Ú£
(
•s
: 
Vec
<
SŒšg
>è-> 
G‘Memb”sRe¥Ú£
 {

49 
Ët
 
mut
 
memb”s
 = 
Vec
::
w™h_ÿ·c™y
(
•s
.
Ën
());

50 
	gi
, 
	g•
è
š
 (&
•s
).
što_™”
().
’um”©e
() {

51 
Ët
 
mut
 
	gm
 = 
Memb”
::
Ãw
();

52 
	gm
.
£t_Çme
(
fÜm©
!("pd{}", 
i
));

53 
	gm
.
£t_memb”_id
(100 + 
i
 
as
 
u64
);

54 
	gm
.
£t_ş›Á_u¾s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
•
.
to_owÃd
()]));

55 
	gm
.
£t_³”_u¾s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
•
.
to_owÃd
()]));

56 
	gmemb”s
.
push
(
m
);

59 
Ët
 
mut
 
	gmemb”s_»¥
 = 
G‘Memb”sRe¥Ú£
::
Ãw
();

60 
	gmemb”s_»¥
.
£t_memb”s
(
R•—‹dF›ld
::
äom_vec
(
memb”s
.
şÚe
()));

61 
	gmemb”s_»¥
.
£t_Ëad”
(
memb”s
.
pİ
().
unw¿p
());

62 
	gmemb”s_»¥
.
£t_h—d”
(
S”viû
::
h—d”
());

64 
	gmemb”s_»¥


69 
im¶
 
PdMock”
 
	gS”viû
 {

70 
â
 
g‘_memb”s
(&
£lf
, 
_
: &
G‘Memb”sReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘Memb”sRe¥Ú£
>> {

71 
Some
(
Ok
(
£lf
.
memb”s_»¥
.
lock
().
unw¿p
().
şÚe
().unwrap()))

74 
â
 
boÙ¡¿p
(&
£lf
, 
»q
: &
BoÙ¡¿pReque¡
è-> 
O±iÚ
<
ResuÉ
<
BoÙ¡¿pRe¥Ú£
>> {

75 
Ët
 
¡Üe
 = 
»q
.
g‘_¡Üe
();

76 
Ët
 
	g¡Üe_·th
 = 
make_»giÚ_key
(
¡Üe
.
g‘_id
());

77 
Ët
 
	g¡Üe_v®ue
 = 
¡Üe
.
wr™e_to_by‹s
().
unw¿p
();

79 
Ët
 
	g»giÚ
 = 
»q
.
g‘_»giÚ
();

80 
Ët
 
	g»giÚ_·th
 = 
make_»giÚ_key
(
»giÚ
.
g‘_id
());

81 
Ët
 
	g»giÚ_v®ue
 = 
»giÚ
.
wr™e_to_by‹s
().
unw¿p
();

83 
Ët
 
mut
 
	g»¥
 = 
BoÙ¡¿pRe¥Ú£
::
Ãw
();

84 
Ët
 
mut
 
	gh—d”
 = 
S”viû
::
h—d”
();

86 
Ët
 
mut
 
	g¡Üage
 = 
£lf
.
¡Üage
.
lock
().
unw¿p
();

88 
Ët
 
	gboÙ_key
 = 
CLUSTER_ROOT_PATH
.
to_owÃd
();

89 
	g¡Üage
.
cÚšs_key
(&
boÙ_key
) {

90 
Ët
 
mut
 
	g”r
 = 
E¼Ü
::
Ãw
();

91 
	g”r
.
	gf›ld_ty³
 = 
E¼ÜTy³
::
UNKNOWN
;

92 
	g”r
.
£t_mes§ge
("şu¡” i ®»ady boÙ¡¿µed".
to_owÃd
());

93 
	gh—d”
.
£t_”rÜ
(
”r
);

94 
	g»¥
.
£t_h—d”
(
h—d”
);

95  
Some
(
Ok
(
»¥
));

98 
	g¡Üage
.
š£¹
(
boÙ_key
, 
vec
![1]);

99 
	g¡Üage
.
š£¹
(
»giÚ_·th
, 
»giÚ_v®ue
);

100 
	g¡Üage
.
š£¹
(
¡Üe_·th
, 
¡Üe_v®ue
);

101 
Some
(
Ok
(
»¥
))

104 
â
 
is_boÙ¡¿µed
(&
£lf
, 
_
: &
IsBoÙ¡¿µedReque¡
è-> 
O±iÚ
<
ResuÉ
<
IsBoÙ¡¿µedRe¥Ú£
>> {

105 
Ët
 
mut
 
»¥
 = 
IsBoÙ¡¿µedRe¥Ú£
::
Ãw
();

106 
Ët
 
	gh—d”
 = 
S”viû
::
h—d”
();

107 
	g»¥
.
£t_h—d”
(
h—d”
);

109 
Ët
 
	g¡Üage
 = 
£lf
.
¡Üage
.
lock
().
unw¿p
();

110 
	g»¥
.
£t_boÙ¡¿µed
(
¡Üage
.
Ën
() != 0);

111 
Some
(
Ok
(
»¥
))

114 
â
 
®loc_id
(&
£lf
, 
_
: &
AÎocIDReque¡
è-> 
O±iÚ
<
ResuÉ
<
AÎocIDRe¥Ú£
>> {

115 
Ët
 
mut
 
»¥
 = 
AÎocIDRe¥Ú£
::
Ãw
();

116 
	g»¥
.
£t_h—d”
(
S”viû
::
h—d”
());

118 
Ët
 
	gid
 = 
£lf
.
id_®loÿtÜ
.
ãtch_add
(1, 
Ord”šg
::
SeqC¡
);

119 
	g»¥
.
£t_id
(
id
 
as
 
u64
);

120 
Some
(
Ok
(
»¥
))

124 
â
 
g‘_¡Üe
(&
£lf
, 
»q
: &
G‘StÜeReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘StÜeRe¥Ú£
>> {

125 
Ët
 
mut
 
»¥
 = 
G‘StÜeRe¥Ú£
::
Ãw
();

126 
Ët
 
mut
 
	g¡Üe
 = 
StÜe
::
Ãw
();

127 
Ët
 
	g¡Üe_·th
 = 
make_»giÚ_key
(
»q
.
g‘_¡Üe_id
());

129 
Ët
 
	g¡Üage
 = 
£lf
.
¡Üage
.
lock
().
unw¿p
();

130 
m©ch
 
	g¡Üage
.
g‘
(&
¡Üe_·th
) {

131 
Some
(
v®ue
) => {

132 
¡Üe
.
m”ge_äom_by‹s
(
v®ue
).
unw¿p
();

133 
	g»¥
.
£t_h—d”
(
S”viû
::
h—d”
());

134 
	g»¥
.
£t_¡Üe
(
¡Üe
);

135 
Some
(
Ok
(
»¥
))

137 
	gNÚe
 => {

138 
Ët
 
mut
 
h—d”
 = 
S”viû
::header();

139 
Ët
 
mut
 
	g”r
 = 
E¼Ü
::
Ãw
();

140 
	g”r
.
	gf›ld_ty³
 = 
E¼ÜTy³
::
UNKNOWN
;

141 
	g”r
.
£t_mes§ge
(
fÜm©
!("¡ÜnÙ found {}", 
»q
.
g‘_¡Üe_id
()));

142 
	gh—d”
.
£t_”rÜ
(
”r
);

143 
	g»¥
.
£t_h—d”
(
h—d”
);

144 
Some
(
Ok
(
»¥
))

149 
â
 
g‘_»giÚ_by_id
(&
£lf
, 
»q
: &
G‘RegiÚByIDReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘RegiÚRe¥Ú£
>> {

150 
Ët
 
mut
 
»¥
 = 
G‘RegiÚRe¥Ú£
::
Ãw
();

151 
Ët
 
mut
 
	g»giÚ
 = 
RegiÚ
::
Ãw
();

152 
Ët
 
	g»giÚ_·th
 = 
make_»giÚ_key
(
»q
.
»giÚ_id
);

154 
Ët
 
	g¡Üage
 = 
£lf
.
¡Üage
.
lock
().
unw¿p
();

155 
m©ch
 
	g¡Üage
.
g‘
(&
»giÚ_·th
) {

156 
Some
(
v®ue
) => {

157 
»giÚ
.
m”ge_äom_by‹s
(
v®ue
).
unw¿p
();

158 
	g»¥
.
£t_h—d”
(
S”viû
::
h—d”
());

159 
	g»¥
.
£t_»giÚ
(
»giÚ
);

160 
Some
(
Ok
(
»¥
))

162 
	gNÚe
 => {

163 
Ët
 
mut
 
h—d”
 = 
S”viû
::header();

164 
Ët
 
mut
 
	g”r
 = 
E¼Ü
::
Ãw
();

165 
	g”r
.
	gf›ld_ty³
 = 
E¼ÜTy³
::
UNKNOWN
;

166 
	g”r
.
£t_mes§ge
(
fÜm©
!("»giÚ‚Ù found {}", 
»q
.
»giÚ_id
));

167 
	gh—d”
.
£t_”rÜ
(
”r
);

168 
	g»¥
.
£t_h—d”
(
h—d”
);

169 
Some
(
Ok
(
»¥
))

174 
â
 
»giÚ_h—¹b—t
(

175 &
£lf
,

176 
_
: &
RegiÚH—¹b—tReque¡
,

177 è-> 
	gO±iÚ
<
	gResuÉ
<
	gRegiÚH—¹b—tRe¥Ú£
>> {

178 
Ët
 
mut
 
	g»¥
 = 
RegiÚH—¹b—tRe¥Ú£
::
Ãw
();

179 
Ët
 
	gh—d”
 = 
S”viû
::
h—d”
();

180 
	g»¥
.
£t_h—d”
(
h—d”
);

181 
Some
(
Ok
(
»¥
))

184 
â
 
¡Üe_h—¹b—t
(&
£lf
, 
_
: &
StÜeH—¹b—tReque¡
è-> 
O±iÚ
<
ResuÉ
<
StÜeH—¹b—tRe¥Ú£
>> {

185 
Ët
 
mut
 
»¥
 = 
StÜeH—¹b—tRe¥Ú£
::
Ãw
();

186 
Ët
 
	gh—d”
 = 
S”viû
::
h—d”
();

187 
	g»¥
.
£t_h—d”
(
h—d”
);

188 
Some
(
Ok
(
»¥
))

191 
â
 
ask_¥l™
(&
£lf
, 
_
: &
AskS¶™Reque¡
è-> 
O±iÚ
<
ResuÉ
<
AskS¶™Re¥Ú£
>> {

192 
Ët
 
mut
 
»¥
 = 
AskS¶™Re¥Ú£
::
Ãw
();

193 
Ët
 
	gh—d”
 = 
S”viû
::
h—d”
();

194 
	g»¥
.
£t_h—d”
(
h—d”
);

195 
Some
(
Ok
(
»¥
))

198 
â
 
»pÜt_¥l™
(&
£lf
, 
_
: &
R•ÜtS¶™Reque¡
è-> 
O±iÚ
<
ResuÉ
<
R•ÜtS¶™Re¥Ú£
>> {

199 
Ët
 
mut
 
»¥
 = 
R•ÜtS¶™Re¥Ú£
::
Ãw
();

200 
Ët
 
	gh—d”
 = 
S”viû
::
h—d”
();

201 
	g»¥
.
£t_h—d”
(
h—d”
);

202 
Some
(
Ok
(
»¥
))

205 
â
 
£t_’dpošts
(&
£lf
, 
•s
: 
Vec
<
SŒšg
>) {

206 
Ët
 
memb”s_»¥
 = 
make_memb”s_»¥Ú£
(
•s
);

207 
	gšfo
!("[S”viû] memb”s_»¥ {:?}", 
	gmemb”s_»¥
);

208 
Ët
 
mut
 
	g»¥
 = 
£lf
.
memb”s_»¥
.
lock
().
unw¿p
();

209 *
	g»¥
 = 
Some
(
memb”s_»¥
);

213 cÚ¡ 
	gCLUSTER_ROOT_PATH
: &'static str = "raft";

215 
â
 
make_»giÚ_key
(
»giÚ_id
: 
u64
è-> 
SŒšg
 {

216  
fÜm©
!("{}/r/{}", 
	gCLUSTER_ROOT_PATH
, 
	g»giÚ_id
);

	@tests/pd/mock/mocker/split.rs

14 
u£
 
	g¡d
::
sync
::
Mu‹x
;

16 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

18 
u£
 
	gkv´Ùo
::
pdpb
::{
G‘Memb”sReque¡
, 
	gG‘Memb”sRe¥Ú£
, 
	gMemb”
, 
	gRe¥Ú£H—d”
};

20 
u£
 
	gsu³r
::*;

22 #[
d”ive
(
Debug
)]

23 
	sIÂ”
 {

24 
	m»¥s
: 
Vec
<
G‘Memb”sRe¥Ú£
>,

25 
	midx
: 
usize
,

28 #[
d”ive
(
Debug
)]

29 
pub
 
	sS¶™
 {

30 
	mšÃr
: 
Mu‹x
<
O±iÚ
<
IÂ”
>>,

33 
im¶
 
	gS¶™
 {

34 
pub
 
â
 
Ãw
(è-> 
	gS¶™
 {

35 
	gS¶™
 {

36 
	gšÃr
: 
Mu‹x
::
Ãw
(
NÚe
),

41 
im¶
 
PdMock”
 
	gS¶™
 {

42 
â
 
g‘_memb”s
(&
£lf
, 
_
: &
G‘Memb”sReque¡
è-> 
O±iÚ
<
ResuÉ
<
G‘Memb”sRe¥Ú£
>> {

43 
Ët
 
mut
 
hŞd”
 = 
£lf
.
šÃr
.
lock
().
unw¿p
();

44 
Ët
 
	gšÃr
 = 
hŞd”
.
as_mut
().
unw¿p
();

45 
	gšÃr
.
	gidx
 += 1;

46 
	gšfo
!(

48 
	gšÃr
.
	g»¥s
[
šÃr
.
idx
 % iÂ”.
»¥s
.
Ën
()]

50 
Some
(
Ok
(
šÃr
.
»¥s
[šÃr.
idx
 % iÂ”.»¥s.
Ën
()].
şÚe
()))

53 
â
 
£t_’dpošts
(&
£lf
, 
•s
: 
Vec
<
SŒšg
>) {

54 
Ët
 
mut
 
memb”s
 = 
Vec
::
w™h_ÿ·c™y
(
•s
.
Ën
());

55 
	gi
, 
	g•
è
š
 (&
•s
).
što_™”
().
’um”©e
() {

56 
Ët
 
mut
 
	gm
 = 
Memb”
::
Ãw
();

57 
	gm
.
£t_Çme
(
fÜm©
!("pd{}", 
i
));

58 
	gm
.
£t_memb”_id
(100 + 
i
 
as
 
u64
);

59 
	gm
.
£t_ş›Á_u¾s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
•
.
to_owÃd
()]));

60 
	gm
.
£t_³”_u¾s
(
R•—‹dF›ld
::
äom_vec
(
vec
![
•
.
to_owÃd
()]));

61 
	gmemb”s
.
push
(
m
);

64 
Ët
 
mut
 
	g»¥s
 = 
Vec
::
w™h_ÿ·c™y
(
•s
.
Ën
());

65 
i
 
	gš
 0..e
	gps
.
Ën
() {

66 
Ët
 
mut
 
	g»¥
 = 
G‘Memb”sRe¥Ú£
::
Ãw
();

67 
Ët
 
mut
 
	gh—d”
 = 
Re¥Ú£H—d”
::
Ãw
();

68 
	gh—d”
.
£t_şu¡”_id
(
i
 
as
 
u64
 + 1);

69 
	g»¥
.
£t_h—d”
(
h—d”
.
şÚe
());

70 
	g»¥
.
£t_memb”s
(
R•—‹dF›ld
::
äom_vec
(
memb”s
.
şÚe
()));

71 
	g»¥
.
£t_Ëad”
(
memb”s
[0].
şÚe
());

72 
	g»¥s
.
push
(
»¥
);

75 
	gšfo
!("[S¶™]„e¥ {:?}", 
	g»¥s
);

77 
Ët
 
mut
 
	gšÃr
 = 
£lf
.
šÃr
.
lock
().
unw¿p
();

78 *
	gšÃr
 = 
Some
(
IÂ”
 {

79 
»¥s
:„esps,

80 
idx
: 0,

	@tests/pd/mock/mod.rs

14 
mod
 
	g£rv”
;

15 
pub
 
mod
 
	gmock”
;

17 
pub
 
u£
 
	g£lf
::
£rv”
::
S”v”
;

18 
pub
 
u£
 
	g£lf
::
mock”
::
PdMock”
;

	@tests/pd/mock/server.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	gfutu»s
::{
Futu»
, 
	gSšk
, 
	gSŒ—m
};

17 
u£
 
	gg½c
::{
Du¶exSšk
, 
	gEnvBud”
, 
	gReque¡SŒ—m
, 
	gRpcCÚ‹xt
, 
	gRpcStus
, 
	gRpcStusCode
,

18 
S”v”
 
as
 
	gG½cS”v”
, 
	gS”v”Bud”
, 
	gUÇrySšk
, 
	gWr™eFÏgs
};

19 
u£
 
	gtikv
::
pd
::
E¼Ü
 
as
 
PdE¼Ü
;

20 
u£
 
	gtikv
::
ut
::
£cur™y
::*;

22 
u£
 
	gkv´Ùo
::
pdpb
::*;

23 
u£
 
	gkv´Ùo
::
pdpb_g½c
::{
£lf
, 
	gPd
};

25 
u£
 
	gsu³r
::
mock”
::*;

27 
pub
 
	sS”v”
 {

28 
	m£rv”
: 
G½cS”v”
,

31 
im¶
 
	gS”v”
 {

32 
pub
 
â
 
	grun
<
	gC
>(
	g•s_couÁ
: 
usize
, 
	ghªdËr
: 
Arc
<
S”viû
>, : 
O±iÚ
<Arc<
C
>>è-> 
S”v”


33 
wh”e


34 
C
: 
PdMock”
 + 
S’d
 + 
Sync
 + 'static,

36 
Ët
 
•s
 = 
vec
![("127.0.0.1".
to_owÃd
(), 0); 
•s_couÁ
];

37 
Ët
 
	gmgr
 = 
Secur™yMªag”
::
Ãw
(&
Secur™yCÚfig
::()).
unw¿p
();

38 
	gS”v”
::
run_w™h_•s
(&
mgr
, 
•s
, 
hªdËr
, )

41 
pub
 
â
 
	grun_w™h_•s
<
	gC
>(

42 
	gmgr
: &
Secur™yMªag”
,

43 
	g•s
: 
Vec
<(
SŒšg
, 
	gu16
)>,

44 
	ghªdËr
: 
Arc
<
S”viû
>,

45 : 
O±iÚ
<
Arc
<
C
>>,

46 è-> 
S”v”


47 
wh”e


48 
	gC
: 
PdMock”
 + 
S’d
 + 
Sync
 + 'static,

50 
Ët
 
m
 = 
PdMock
 {

51 
deçuÉ_hªdËr
: 
hªdËr
.
şÚe
(),

52 : .
şÚe
(),

54 
Ët
 
	g£rviû
 = 
pdpb_g½c
::
ü—‹_pd
(
m
);

55 
Ët
 
	g’v
 = 
Arc
::
Ãw
(

56 
EnvBud”
::
Ãw
()

57 .
cq_couÁ
(1)

58 .
Çme_´efix
(
thd_Çme
!("mock-server"))

59 .
bud
(),

61 
Ët
 
mut
 
	gsb
 = 
S”v”Bud”
::
Ãw
(
’v
).
»gi¡”_£rviû
(
£rviû
);

62 
	gho¡
, 
	gpÜt
è
š
 
	g•s
 {

63 
	gsb
 = 
mgr
.
bšd
(
sb
, &
ho¡
, 
pÜt
);

66 
Ët
 
mut
 
	g£rv”
 = 
sb
.
bud
().
unw¿p
();

68 
Ët
 
	gaddrs
 = 
£rv”
.
bšd_addrs
();

69 
	ghªdËr
.
£t_’dpošts
(

70 
addrs


71 .
™”
()

72 .
m­
(|
addr
| 
fÜm©
!("{}:{}",‡ddr.0,‡ddr.1))

73 .
cŞËù
(),

75 
Ët
 
Some
(èğ.
as_»f
() {

76 .
£t_’dpošts
(

77 
addrs


78 .
™”
()

79 .
m­
(|
addr
| 
fÜm©
!("{}:{}",‡ddr.0,‡ddr.1))

80 .
cŞËù
(),

85 
	g£rv”
.
¡¬t
();

86 
	gS”v”
 { 
	g£rv”
: 
£rv”
 }

89 
pub
 
â
 
bšd_addrs
(&
£lf
è-> 
Vec
<(
SŒšg
, 
	gu16
)> {

90 
	g£lf
.
	g£rv”
.
bšd_addrs
().
to_vec
()

94 
â
 
	ghijack_uÇry
<
	gF
, 
	gR
, 
	gC
: 
PdMock”
>(
mock
: &
PdMock
<
C
>, 
	gùx
: 
RpcCÚ‹xt
, 
	gsšk
: 
UÇrySšk
<
R
>, 
	gf
: 
F
)

95 
wh”e


96 
R
: 
S’d
 + 'static,

97 
F
: 
Fn
(&
PdMock”
è-> 
O±iÚ
<
ResuÉ
<
R
>>,

99 
Ët
 
	g»¥
 = 
mock
.

100 .
as_»f
()

101 .
ªd_th’
(|| 
f
(.
as_»f
()))

102 .
Ü_–£
(|| 
f
(
mock
.
deçuÉ_hªdËr
.
as_»f
()));

104 
m©ch
 
	g»¥
 {

105 
Some
(
Ok
(
»¥
)è=> 
ùx
.
¥awn
(

106 
sšk
.
sucûss
(
»¥
)

107 .
m­_”r
(
move
 |
”r
| 
·nic
!("failedo„eply: {:?}",ƒrr)),

109 
Some
(
E¼
(
”r
)) => {

110 
Ët
 
¡©us
 = 
RpcStus
::
Ãw
(
RpcStusCode
::
Unknown
, 
Some
(
fÜm©
!("{:?}", 
”r
)));

111 
	gùx
.
¥awn
(

112 
sšk
.
ç
(
¡©us
)

113 .
m­_”r
(
move
 |
”r
| 
·nic
!("failedo„eply: {:?}",ƒrr)),

116 
	g_
 => {

117 
Ët
 
¡©us
 = 
RpcStus
::
Ãw
(

118 
RpcStusCode
::
Unim¶em’‹d
,

119 
Some
("Unim¶em’‹d".
to_owÃd
()),

121 
	gùx
.
¥awn
(

122 
sšk
.
ç
(
¡©us
)

123 .
m­_”r
(
move
 |
”r
| 
·nic
!("failedo„eply: {:?}",ƒrr)),

129 #[
d”ive
(
Debug
)]

130 
	gPdMock
<
	gC
: 
PdMock”
> {

131 
deçuÉ_hªdËr
: 
Arc
<
S”viû
>,

132 : 
O±iÚ
<
Arc
<
C
>>,

135 
	gim¶
<
	gC
: 
PdMock”
> 
ClÚe
 
PdMock
<
C
> {

136 
â
 
şÚe
(&
£lf
è-> 
S–f
 {

137 
PdMock
 {

138 
deçuÉ_hªdËr
: 
£lf
.deçuÉ_hªdËr.
şÚe
(),

139 : 
£lf
..
şÚe
(),

144 
	gim¶
<
	gC
: 
PdMock”
 + 
S’d
 + 
Sync
 + 'static> Pd for PdMock<C> {

145 
â
 
g‘_memb”s
(

146 &
£lf
,

147 
ùx
: 
RpcCÚ‹xt
,

148 
»q
: 
G‘Memb”sReque¡
,

149 
sšk
: 
UÇrySšk
<
G‘Memb”sRe¥Ú£
>,

151 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
g‘_memb”s
(&
»q
))

154 
â
 
tso
(&
£lf
, 
_
: 
RpcCÚ‹xt
, _: 
Reque¡SŒ—m
<
TsoReque¡
>, _: 
Du¶exSšk
<
TsoRe¥Ú£
>) {

155 
unim¶em’‹d
!()

158 
â
 
boÙ¡¿p
(

159 &
£lf
,

160 
ùx
: 
RpcCÚ‹xt
,

161 
»q
: 
BoÙ¡¿pReque¡
,

162 
sšk
: 
UÇrySšk
<
BoÙ¡¿pRe¥Ú£
>,

164 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
boÙ¡¿p
(&
»q
))

167 
â
 
is_boÙ¡¿µed
(

168 &
£lf
,

169 
ùx
: 
RpcCÚ‹xt
,

170 
»q
: 
IsBoÙ¡¿µedReque¡
,

171 
sšk
: 
UÇrySšk
<
IsBoÙ¡¿µedRe¥Ú£
>,

173 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
is_boÙ¡¿µed
(&
»q
))

176 
â
 
®loc_id
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
»q
: 
AÎocIDReque¡
, 
sšk
: 
UÇrySšk
<
AÎocIDRe¥Ú£
>) {

177 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
®loc_id
(&
»q
))

180 
â
 
g‘_¡Üe
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
»q
: 
G‘StÜeReque¡
, 
sšk
: 
UÇrySšk
<
G‘StÜeRe¥Ú£
>) {

181 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
g‘_¡Üe
(&
»q
))

184 
â
 
put_¡Üe
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
»q
: 
PutStÜeReque¡
, 
sšk
: 
UÇrySšk
<
PutStÜeRe¥Ú£
>) {

185 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
put_¡Üe
(&
»q
))

188 
â
 
¡Üe_h—¹b—t
(

189 &
£lf
,

190 
ùx
: 
RpcCÚ‹xt
,

191 
»q
: 
StÜeH—¹b—tReque¡
,

192 
sšk
: 
UÇrySšk
<
StÜeH—¹b—tRe¥Ú£
>,

194 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
¡Üe_h—¹b—t
(&
»q
))

197 
â
 
»giÚ_h—¹b—t
(

198 &
£lf
,

199 
ùx
: 
RpcCÚ‹xt
,

200 
¡»am
: 
Reque¡SŒ—m
<
RegiÚH—¹b—tReque¡
>,

201 
sšk
: 
Du¶exSšk
<
RegiÚH—¹b—tRe¥Ú£
>,

203 
Ët
 
	gmock
 = 
£lf
.
şÚe
();

204 
Ët
 
	gf
 = 
sšk
.
sšk_m­_”r
(
PdE¼Ü
::
äom
)

205 .
£nd_®l
(

206 
¡»am


207 .
m­_”r
(
PdE¼Ü
::
äom
)

208 .
ªd_th’
(
move
 |
»q
| {

209 
m©ch
 
mock
..
as_»f
().
m­_Ü_–£
(

210 || 
mock
.
deçuÉ_hªdËr
.
»giÚ_h—¹b—t
(&
»q
),

211 |
s
| s.
»giÚ_h—¹b—t
(&
»q
),

213 
NÚe
 => 
Ok
(None),

214 
Some
(
Ok
(
»¥
)è=> Ok(Some(Ôe¥, 
Wr™eFÏgs
::()))),

215 
Some
(
E¼
(
e
)è=> E¼(
box_”r
!("{:?}",ƒ)),

218 .
f‹r_m­
(|
o
| o),

220 .
m­
(|
_
| ())

221 .
m­_”r
(|
e
| 
”rÜ
!("failedo handle heartbeat: {:?}",ƒ));

222 
	gùx
.
¥awn
(
f
)

225 
â
 
g‘_»giÚ
(

226 &
£lf
,

227 
ùx
: 
RpcCÚ‹xt
,

228 
»q
: 
G‘RegiÚReque¡
,

229 
sšk
: 
UÇrySšk
<
G‘RegiÚRe¥Ú£
>,

231 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
g‘_»giÚ
(&
»q
))

234 
â
 
g‘_»giÚ_by_id
(

235 &
£lf
,

236 
ùx
: 
RpcCÚ‹xt
,

237 
»q
: 
G‘RegiÚByIDReque¡
,

238 
sšk
: 
UÇrySšk
<
G‘RegiÚRe¥Ú£
>,

240 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
g‘_»giÚ_by_id
(&
»q
))

243 
â
 
ask_¥l™
(&
£lf
, 
ùx
: 
RpcCÚ‹xt
, 
»q
: 
AskS¶™Reque¡
, 
sšk
: 
UÇrySšk
<
AskS¶™Re¥Ú£
>) {

244 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
ask_¥l™
(&
»q
))

247 
â
 
»pÜt_¥l™
(

248 &
£lf
,

249 
ùx
: 
RpcCÚ‹xt
,

250 
»q
: 
R•ÜtS¶™Reque¡
,

251 
sšk
: 
UÇrySšk
<
R•ÜtS¶™Re¥Ú£
>,

253 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
»pÜt_¥l™
(&
»q
))

256 
â
 
g‘_şu¡”_cÚfig
(

257 &
£lf
,

258 
ùx
: 
RpcCÚ‹xt
,

259 
»q
: 
G‘Clu¡”CÚfigReque¡
,

260 
sšk
: 
UÇrySšk
<
G‘Clu¡”CÚfigRe¥Ú£
>,

262 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
g‘_şu¡”_cÚfig
(&
»q
))

265 
â
 
put_şu¡”_cÚfig
(

266 &
£lf
,

267 
ùx
: 
RpcCÚ‹xt
,

268 
»q
: 
PutClu¡”CÚfigReque¡
,

269 
sšk
: 
UÇrySšk
<
PutClu¡”CÚfigRe¥Ú£
>,

271 
hijack_uÇry
(
£lf
, 
ùx
, 
sšk
, |
c
| c.
put_şu¡”_cÚfig
(&
»q
))

	@tests/pd/mod.rs

14 
mod
 
	g‹¡_½c_ş›Á
;

15 
mod
 
	gmock
;

	@tests/pd/test_rpc_client.rs

14 
u£
 
	g¡d
::
th»ad
;

15 
u£
 
	g¡d
::
sync
::{
mpsc
, 
	gArc
};

16 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

18 
u£
 
	gg½c
::
EnvBud”
;

19 
u£
 
	gfutu»s
::
Futu»
;

20 
u£
 
	gfutu»s_ıupoŞ
::
Bud”
;

21 
u£
 
	gkv´Ùo
::
m‘­b
;

22 
u£
 
	gkv´Ùo
::
pdpb
;

24 
u£
 
	gtikv
::
pd
::{
v®id©e_’dpošts
, 
	gCÚfig
, 
E¼Ü
 
as
 
	gPdE¼Ü
, 
	gPdCl›Á
, 
	gRegiÚSt
, 
	gRpcCl›Á
};

25 
u£
 
	gtikv
::
ut
::
£cur™y
::{
Secur™yCÚfig
, 
	gSecur™yMªag”
};

27 
u£
 
	gsu³r
::
mock
::
mock”
::*;

28 
u£
 
	gsu³r
::
mock
::
S”v”
 
as
 
MockS”v”
;

29 
u£
 
	gut
;

31 
â
 
Ãw_cÚfig
(
•s
: 
Vec
<
SŒšg
>è-> 
CÚfig
 {

32 
Ët
 
mut
 
cfg
 = 
CÚfig
::();

33 
	gcfg
.
	g’dpošts
 = 
•s
;

34 
	gcfg


37 
â
 
Ãw_ş›Á
(
•s
: 
Vec
<
SŒšg
>è-> 
RpcCl›Á
 {

38 
Ët
 
cfg
 = 
Ãw_cÚfig
(
•s
);

39 
Ët
 
	gmgr
 = 
Arc
::
Ãw
(
Secur™yMªag”
::Ãw(&
Secur™yCÚfig
::()).
unw¿p
());

40 
	gRpcCl›Á
::
Ãw
(&
cfg
, 
mgr
).
unw¿p
()

43 #[
‹¡
]

44 
â
 
	$‹¡_½c_ş›Á
() {

45 
Ët
 
•s_couÁ
 = 1;

46 
Ët
 
£
 = 
Arc
::
	`Ãw
(
S”viû
::new());

47 
Ët
 
£rv”
 = 
MockS”v”
::
run
::<
S”viû
>(
•s_couÁ
, 
£
.
	`şÚe
(), 
NÚe
);

48 
Ët
 
•s
: 
Vec
<
SŒšg
> = 
£rv”


49 .
	`bšd_addrs
()

50 .
	`što_™”
()

51 .
	`m­
(|
addr
| 
fÜm©
!("{}:{}",‡ddr.0,‡ddr.1))

52 .
	`cŞËù
();

54 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_£cs
(1));

56 
Ët
 
ş›Á
 = 
	`Ãw_ş›Á
(
•s
.
	`şÚe
());

57 
as£¹_Ã
!(
ş›Á
.
	`g‘_şu¡”_id
().
	`unw¿p
(), 0);

59 
Ët
 
¡Üe_id
 = 
ş›Á
.
	`®loc_id
().
	`unw¿p
();

60 
Ët
 
mut
 
¡Üe
 = 
m‘­b
::
StÜe
::
	`Ãw
();

61 
¡Üe
.
	`£t_id
(
¡Üe_id
);

62 
debug
!("boÙ¡¿°¡Ü{:?}", 
¡Üe
);

64 
Ët
 
³”_id
 = 
ş›Á
.
	`®loc_id
().
	`unw¿p
();

65 
Ët
 
mut
 
³”
 = 
m‘­b
::
P“r
::
	`Ãw
();

66 
³”
.
	`£t_id
(
³”_id
);

67 
³”
.
	`£t_¡Üe_id
(
¡Üe_id
);

69 
Ët
 
»giÚ_id
 = 
ş›Á
.
	`®loc_id
().
	`unw¿p
();

70 
Ët
 
mut
 
»giÚ
 = 
m‘­b
::
RegiÚ
::
	`Ãw
();

71 
»giÚ
.
	`£t_id
(
»giÚ_id
);

72 
»giÚ
.
	`mut_³”s
().
	`push
(
³”
.
	`şÚe
());

73 
debug
!("boÙ¡¿°»giÚ {:?}", 
»giÚ
);

75 
ş›Á


76 .
	`boÙ¡¿p_şu¡”
(
¡Üe
.
	`şÚe
(), 
»giÚ
.clone())

77 .
	`unw¿p
();

78 
as£¹_eq
!(
ş›Á
.
	`is_şu¡”_boÙ¡¿µed
().
	`unw¿p
(), 
Œue
);

80 
Ët
 
tmp_¡Üe
 = 
ş›Á
.
	`g‘_¡Üe
(
¡Üe_id
).
	`unw¿p
();

81 
as£¹_eq
!(
tmp_¡Üe
.
	`g‘_id
(), 
¡Üe
.get_id());

83 
Ët
 
tmp_»giÚ
 = 
ş›Á
.
	`g‘_»giÚ_by_id
(
»giÚ_id
).
	`wa™
().
	`unw¿p
().unwrap();

84 
as£¹_eq
!(
tmp_»giÚ
.
	`g‘_id
(), 
»giÚ
.get_id());

86 
Ët
 
mut
 
´ev_id
 = 0;

87 
_
 
š
 0..100 {

88 
Ët
 
ş›Á
 = 
	`Ãw_ş›Á
(
•s
.
	`şÚe
());

89 
Ët
 
®loc_id
 = 
ş›Á
.
	`®loc_id
().
	`unw¿p
();

90 
as£¹
!(
®loc_id
 > 
´ev_id
);

91 
´ev_id
 = 
®loc_id
;

94 
Ët
 
pŞËr
 = 
Bud”
::
	`Ãw
()

95 .
	`poŞ_size
(1)

96 .
	`Çme_´efix
(
thd_Çme
!("poller"))

97 .
	`ü—‹
();

98 
	`Ët
 (
tx
, 
rx
èğ
mpsc
::
	`chªÃl
();

99 
Ët
 
f
 = 
ş›Á
.
	`hªdË_»giÚ_h—¹b—t_»¥Ú£
(1, 
move
 |
»¥
| {†‘ 
_
 = 
tx
.
	`£nd
(resp); });

100 
pŞËr
.
	`¥awn
(
f
).
	`fÜg‘
();

102 
pŞËr


103 .
	`¥awn
(
ş›Á
.
	`»giÚ_h—¹b—t
(

104 
m‘­b
::
RegiÚ
::
	`Ãw
(),

105 
m‘­b
::
P“r
::
	`Ãw
(),

106 
RegiÚSt
::(),

108 .
	`fÜg‘
();

109 
rx
.
	`»cv_timeout
(
Du¿tiÚ
::
	`äom_£cs
(3)).
	`unw¿p
();

110 
ş›Á


111 .
	`¡Üe_h—¹b—t
(
pdpb
::
StÜeSts
::
	`Ãw
())

112 .
	`wa™
()

113 .
	`unw¿p
();

114 
ş›Á
.
	`ask_¥l™
(
m‘­b
::
RegiÚ
::
	`Ãw
()).
	`wa™
().
	`unw¿p
();

115 
ş›Á


116 .
	`»pÜt_¥l™
(
m‘­b
::
RegiÚ
::
	`Ãw
(), metapb::Region::new())

117 .
	`wa™
()

118 .
	`unw¿p
();

119 
	}
}

121 #[
‹¡
]

122 
â
 
	$‹¡_»boÙ
() {

123 
Ët
 
•s_couÁ
 = 1;

124 
Ët
 
£
 = 
Arc
::
	`Ãw
(
S”viû
::new());

125 
Ët
 
®
 = 
Arc
::
	`Ãw
(
AÌ—dyBoÙ¡¿µed
);

126 
Ët
 
£rv”
 = 
MockS”v”
::
	`run
(
•s_couÁ
, 
£
.
	`şÚe
(), 
	`Some
(
®
));

127 
Ët
 
•s
: 
Vec
<
SŒšg
> = 
£rv”


128 .
	`bšd_addrs
()

129 .
	`što_™”
()

130 .
	`m­
(|
addr
| 
fÜm©
!("{}:{}",‡ddr.0,‡ddr.1))

131 .
	`cŞËù
();

133 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_£cs
(1));

135 
Ët
 
ş›Á
 = 
	`Ãw_ş›Á
(
•s
);

137 
as£¹
!(!
ş›Á
.
	`is_şu¡”_boÙ¡¿µed
().
	`unw¿p
());

139 
m©ch
 
ş›Á
.
	`boÙ¡¿p_şu¡”
(
m‘­b
::
StÜe
::
	`Ãw
(), m‘­b::
RegiÚ
::new()) {

140 
	`E¼
(
PdE¼Ü
::
	`Clu¡”BoÙ¡¿µed
(
_
)) => (),

141 
_
 => {

142 
·nic
!("failed, should„eturn ClusterBootstrapped");

145 
	}
}

147 #[
‹¡
]

148 
â
 
	$‹¡_v®id©e_’dpošts
() {

149 
Ët
 
•s_couÁ
 = 3;

150 
Ët
 
£
 = 
Arc
::
	`Ãw
(
S”viû
::new());

151 
Ët
 
¥
 = 
Arc
::
	`Ãw
(
S¶™
::new());

152 
Ët
 
£rv”
 = 
MockS”v”
::
	`run
(
•s_couÁ
, 
£
, 
	`Some
(
¥
));

153 
Ët
 
’v
 = 
Arc
::
	`Ãw
(

154 
EnvBud”
::
	`Ãw
()

155 .
	`cq_couÁ
(1)

156 .
	`Çme_´efix
(
thd_Çme
!("test_pd"))

157 .
	`bud
(),

159 
Ët
 
•s
: 
Vec
<
SŒšg
> = 
£rv”


160 .
	`bšd_addrs
()

161 .
	`što_™”
()

162 .
	`m­
(|
addr
| 
fÜm©
!("{}:{}",‡ddr.0,‡ddr.1))

163 .
	`cŞËù
();

165 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_£cs
(1));

167 
Ët
 
mgr
 = 
Arc
::
	`Ãw
(
Secur™yMªag”
::Ãw(&
Secur™yCÚfig
::()).
	`unw¿p
());

168 
as£¹
!(
	`v®id©e_’dpošts
(
’v
, &
	`Ãw_cÚfig
(
•s
), &
mgr
).
	`is_”r
());

169 
	}
}

171 
â
 
	g‹¡_»Œy
<
	gF
: 
Fn
(&
RpcCl›Á
)>(
func
: 
F
) {

172 
Ët
 
•s_couÁ
 = 1;

173 
Ët
 
	g£
 = 
Arc
::
Ãw
(
S”viû
::new());

175 
Ët
 
	g»Œy
 = 
Arc
::
Ãw
(
R‘ry
::new(3));

176 
Ët
 
	g£rv”
 = 
MockS”v”
::
run
(
•s_couÁ
, 
£
.
şÚe
(), 
Some
(
»Œy
));

177 
Ët
 
	g•s
: 
Vec
<
SŒšg
> = 
£rv”


178 .
bšd_addrs
()

179 .
što_™”
()

180 .
m­
(|
addr
| 
fÜm©
!("{}:{}",‡ddr.0,‡ddr.1))

181 .
cŞËù
();

183 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_£cs
(1));

185 
Ët
 
	gş›Á
 = 
Ãw_ş›Á
(
•s
);

187 
_
 
	gš
 0..3 {

188 
func
(&
ş›Á
);

192 #[
‹¡
]

193 
â
 
	$‹¡_»Œy_async
() {

194 
Ët
 
async
 = |
ş›Á
: &
RpcCl›Á
| {

195 
Ët
 
»giÚ
 = 
ş›Á
.
	`g‘_»giÚ_by_id
(1);

196 
»giÚ
.
	`wa™
().
	`unw¿p
();

198 
	`‹¡_»Œy
(
async
);

199 
	}
}

201 #[
‹¡
]

202 
â
 
	$‹¡_»Œy_sync
() {

203 
Ët
 
sync
 = |
ş›Á
: &
RpcCl›Á
| { cl›Á.
	`g‘_¡Üe
(1).
	`unw¿p
(); };

204 
	`‹¡_»Œy
(
sync
)

205 
	}
}

207 #[
‹¡
]

208 
â
 
	$‹¡_»¡¬t_Ëad”
() {

209 
Ët
 
•s_couÁ
 = 3;

211 
Ët
 
£
 = 
Arc
::
	`Ãw
(
S”viû
::new());

213 
Ët
 
£rv”
 = 
MockS”v”
::
run
::<
S”viû
>(
•s_couÁ
, 
£
.
	`şÚe
(), 
NÚe
);

214 
Ët
 
•s
: 
Vec
<
SŒšg
> = 
£rv”


215 .
	`bšd_addrs
()

216 .
	`što_™”
()

217 .
	`m­
(|
addr
| 
fÜm©
!("{}:{}",‡ddr.0,‡ddr.1))

218 .
	`cŞËù
();

220 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_£cs
(2));

222 
Ët
 
ş›Á
 = 
	`Ãw_ş›Á
(
•s
);

224 
Ët
 
¡Üe_id
 = 
ş›Á
.
	`®loc_id
().
	`unw¿p
();

225 
Ët
 
mut
 
¡Üe
 = 
m‘­b
::
StÜe
::
	`Ãw
();

226 
¡Üe
.
	`£t_id
(
¡Üe_id
);

228 
Ët
 
³”_id
 = 
ş›Á
.
	`®loc_id
().
	`unw¿p
();

229 
Ët
 
mut
 
³”
 = 
m‘­b
::
P“r
::
	`Ãw
();

230 
³”
.
	`£t_id
(
³”_id
);

231 
³”
.
	`£t_¡Üe_id
(
¡Üe_id
);

233 
Ët
 
»giÚ_id
 = 
ş›Á
.
	`®loc_id
().
	`unw¿p
();

234 
Ët
 
mut
 
»giÚ
 = 
m‘­b
::
RegiÚ
::
	`Ãw
();

235 
»giÚ
.
	`£t_id
(
»giÚ_id
);

236 
»giÚ
.
	`mut_³”s
().
	`push
(
³”
);

237 
ş›Á


238 .
	`boÙ¡¿p_şu¡”
(
¡Üe
.
	`şÚe
(), 
»giÚ
.clone())

239 .
	`unw¿p
();

241 
Ët
 
»giÚ
 = 
ş›Á
.
	`g‘_»giÚ_by_id
(1);

242 
»giÚ
.
	`wa™
().
	`unw¿p
();

245 
Ët
 
•s
 = 
£rv”
.
	`bšd_addrs
();

248 
	`drİ
(
£rv”
);

250 
Ët
 
mgr
 = 
Arc
::
	`Ãw
(
Secur™yMªag”
::Ãw(&
Secur™yCÚfig
::()).
	`unw¿p
());

251 
Ët
 
_£rv”
 = 
MockS”v”
::
run_w™h_•s
::<
S”viû
>(&
mgr
, 
•s
, 
£
.
	`şÚe
(), 
NÚe
);

254 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_£cs
(1));

256 
Ët
 
»giÚ
 = 
ş›Á
.
	`g‘_»giÚ_by_id
(1);

257 
»giÚ
.
	`wa™
().
	`unw¿p
();

258 
	}
}

261 #[
‹¡
]

262 
â
 
	$‹¡_£cu»_»¡¬t_Ëad”
() {

264 
Ët
 
£
 = 
Arc
::
	`Ãw
(
S”viû
::new());

265 
Ët
 
£cur™y_cfg
 = 
ut
::
	`Ãw_£cur™y_cfg
();

266 
Ët
 
mgr
 = 
Arc
::
	`Ãw
(
Secur™yMªag”
::Ãw(&
£cur™y_cfg
).
	`unw¿p
());

268 
Ët
 
•s
: 
Vec
<(
SŒšg
, 
u16
)> = (0..3).
	`m­
(|
_
| ("127.0.0.1".
	`to_owÃd
(), 0)).
	`cŞËù
();

269 
Ët
 
£rv”
 = 
MockS”v”
::
run_w™h_•s
::<
S”viû
>(&
mgr
, 
•s
, 
£
.
	`şÚe
(), 
NÚe
);

270 
Ët
 
•s
: 
Vec
<
SŒšg
> = 
£rv”


271 .
	`bšd_addrs
()

272 .
	`što_™”
()

273 .
	`m­
(|
addr
| 
fÜm©
!("{}:{}",‡ddr.0,‡ddr.1))

274 .
	`cŞËù
();

276 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_£cs
(2));

278 
Ët
 
cfg
 = 
	`Ãw_cÚfig
(
•s
);

279 
Ët
 
ş›Á
 = 
RpcCl›Á
::
	`Ãw
(&
cfg
, 
mgr
.
	`şÚe
()).
	`unw¿p
();

281 
Ët
 
¡Üe_id
 = 
ş›Á
.
	`®loc_id
().
	`unw¿p
();

282 
Ët
 
mut
 
¡Üe
 = 
m‘­b
::
StÜe
::
	`Ãw
();

283 
¡Üe
.
	`£t_id
(
¡Üe_id
);

285 
Ët
 
³”_id
 = 
ş›Á
.
	`®loc_id
().
	`unw¿p
();

286 
Ët
 
mut
 
³”
 = 
m‘­b
::
P“r
::
	`Ãw
();

287 
³”
.
	`£t_id
(
³”_id
);

288 
³”
.
	`£t_¡Üe_id
(
¡Üe_id
);

290 
Ët
 
»giÚ_id
 = 
ş›Á
.
	`®loc_id
().
	`unw¿p
();

291 
Ët
 
mut
 
»giÚ
 = 
m‘­b
::
RegiÚ
::
	`Ãw
();

292 
»giÚ
.
	`£t_id
(
»giÚ_id
);

293 
»giÚ
.
	`mut_³”s
().
	`push
(
³”
);

294 
ş›Á


295 .
	`boÙ¡¿p_şu¡”
(
¡Üe
.
	`şÚe
(), 
»giÚ
.clone())

296 .
	`unw¿p
();

298 
Ët
 
»giÚ
 = 
ş›Á
.
	`g‘_»giÚ_by_id
(1);

299 
»giÚ
.
	`wa™
().
	`unw¿p
();

302 
Ët
 
•s
 = 
£rv”
.
	`bšd_addrs
().
	`što_™”
().
	`cŞËù
();

305 
	`drİ
(
£rv”
);

307 
Ët
 
_£rv”
 = 
MockS”v”
::
run_w™h_•s
::<
S”viû
>(&
mgr
, 
•s
, 
£
.
	`şÚe
(), 
NÚe
);

310 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_£cs
(1));

312 
Ët
 
»giÚ
 = 
ş›Á
.
	`g‘_»giÚ_by_id
(1);

313 
»giÚ
.
	`wa™
().
	`unw¿p
();

314 
	}
}

316 #[
‹¡
]

317 
â
 
	$‹¡_chªge_Ëad”_async
() {

318 
Ët
 
•s_couÁ
 = 3;

319 
Ët
 
£
 = 
Arc
::
	`Ãw
(
S”viû
::new());

320 
Ët
 
lc
 = 
Arc
::
	`Ãw
(
L—d”Chªge
::new());

321 
Ët
 
£rv”
 = 
MockS”v”
::
	`run
(
•s_couÁ
, 
£
.
	`şÚe
(), 
	`Some
(
lc
.clone()));

322 
Ët
 
•s
: 
Vec
<
SŒšg
> = 
£rv”


323 .
	`bšd_addrs
()

324 .
	`što_™”
()

325 .
	`m­
(|
addr
| 
fÜm©
!("{}:{}",‡ddr.0,‡ddr.1))

326 .
	`cŞËù
();

328 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_£cs
(1));

330 
Ët
 
ş›Á
 = 
	`Ãw_ş›Á
(
•s
);

331 
Ët
 
Ëad”
 = 
ş›Á
.
	`g‘_Ëad”
();

333 
_
 
š
 0..5 {

334 
Ët
 
»giÚ
 = 
ş›Á
.
	`g‘_»giÚ_by_id
(1);

335 
»giÚ
.
	`wa™
().
	`ok
();

337 
Ët
 
Ãw
 = 
ş›Á
.
	`g‘_Ëad”
();

338 
Ãw
 !ğ
Ëad”
 {

341 
th»ad
::
	`¦“p
(
L—d”Chªge
::
	`g‘_Ëad”_š‹rv®
());

344 
·nic
!("failed,†eader should changed");

345 
	}
}

	@tests/raft/mod.rs

15 
mod
 
	g‹¡_¿á
;

16 
mod
 
	g‹¡_¿á_¢­
;

17 
mod
 
	g‹¡_¿á_·³r
;

18 
mod
 
	g‹¡_¿á_æow_cÚŒŞ
;

19 
mod
 
	g‹¡_¿w_node
;

	@tests/raft/test_raft.rs

28 
u£
 
	g¡d
::
cŞËùiÚs
::
HashM­
;

29 
u£
 
	g¡d
::
İs
::
D”ef
;

30 
u£
 
	g¡d
::
İs
::
D”efMut
;

31 
u£
 
	g¡d
::
cmp
;

33 
u£
 
	g´Ùobuf
::{
£lf
, 
	gR•—‹dF›ld
};

34 
u£
 
	gkv´Ùo
::
”aápb
::{
CÚfChªge
, 
	gCÚfChªgeTy³
, 
	gCÚfS‹
, 
	gEÁry
, 
	gEÁryTy³
, 
	gH¬dS‹
,

35 
	gMes§ge
, 
	gMes§geTy³
, 
	gSÇpshÙ
};

36 
u£
 
	g¿nd
;

38 
u£
 
	gtikv
::
¿á
::*;

39 
u£
 
	gtikv
::
¿á
::
¡Üage
::
MemStÜage
;

40 
u£
 
	gtikv
::
ut
::
cŞËùiÚs
::
FÏtM­
 
as
 
RaáFÏtM­
;

42 
pub
 
â
 
Éß
(
¿á_log
: &
RaáLog
<
MemStÜage
>è-> 
SŒšg
 {

43 
Ët
 
mut
 
s
 = 
fÜm©
!("comm™‹d: {}\n", 
	g¿á_log
.
	gcomm™‹d
);

44 
	gs
 = 
s
 + &
fÜm©
!("­¶›d: {}\n", 
	g¿á_log
.
	g­¶›d
);

45 
	gi
, 
	ge
è
š
 
	g¿á_log
.
®l_’Œ›s
().
™”
().
’um”©e
() {

46 
	gs
 = 
s
 + &
fÜm©
!("#{}: {:?}\n", 
	gi
, 
	ge
);

48 
	gs


51 
pub
 
â
 
Ãw_¡Üage
(è-> 
	gMemStÜage
 {

52 
	gMemStÜage
::
Ãw
()

55 
â
 
Ãw_´og»ss
(

56 
¡©e
: 
Prog»ssS‹
,

57 
m©ched
: 
u64
,

58 
Ãxt_idx
: 
u64
,

59 
³ndšg_¢­shÙ
: 
u64
,

60 
šs_size
: 
usize
,

61 è-> 
	gProg»ss
 {

62 
	gProg»ss
 {

63 
	g¡©e
: 
¡©e
,

64 
	gm©ched
: 
m©ched
,

65 
	gÃxt_idx
: 
Ãxt_idx
,

66 
	g³ndšg_¢­shÙ
: 
³ndšg_¢­shÙ
,

67 
	gšs
: 
Inæights
::
Ãw
(
šs_size
),

68 ..
	gDeçuÉ
::()

72 
pub
 
â
 
Ãw_‹¡_cÚfig
(
id
: 
u64
, 
³”s
: 
Vec
<u64>, 
–eùiÚ
: 
usize
, 
h—¹b—t
: usizeè-> 
CÚfig
 {

73 
CÚfig
 {

74 
id
: id,

75 
	g³”s
: 
³”s
,

76 
	g–eùiÚ_tick
: 
–eùiÚ
,

77 
	gh—¹b—t_tick
: 
h—¹b—t
,

78 
	gmax_size_³r_msg
: 
NO_LIMIT
,

79 
	gmax_šæight_msgs
: 256,

80 ..
	gDeçuÉ
::()

84 
pub
 
â
 
Ãw_‹¡_¿á
(

85 
id
: 
u64
,

86 
³”s
: 
Vec
<
u64
>,

87 
–eùiÚ
: 
usize
,

88 
h—¹b—t
: 
usize
,

89 
¡Üage
: 
MemStÜage
,

90 è-> 
	gIÁ”çû
 {

91 
	gIÁ”çû
::
Ãw
(
Raá
::new(

92 &
Ãw_‹¡_cÚfig
(
id
, 
³”s
, 
–eùiÚ
, 
h—¹b—t
),

93 
¡Üage
,

97 
pub
 
â
 
Ãw_‹¡_¿á_w™h_´evÙe
(

98 
id
: 
u64
,

99 
³”s
: 
Vec
<
u64
>,

100 
–eùiÚ
: 
usize
,

101 
h—¹b—t
: 
usize
,

102 
¡Üage
: 
MemStÜage
,

103 
´e_vÙe
: 
boŞ
,

104 è-> 
	gIÁ”çû
 {

105 
Ët
 
mut
 
	gcÚfig
 = 
Ãw_‹¡_cÚfig
(
id
, 
³”s
, 
–eùiÚ
, 
h—¹b—t
);

106 
	gcÚfig
.
	g´e_vÙe
 = 
´e_vÙe
;

107 
Ãw_‹¡_¿á_w™h_cÚfig
(&
cÚfig
, 
¡Üage
)

110 
pub
 
â
 
Ãw_‹¡_¿á_w™h_cÚfig
(
cÚfig
: &
CÚfig
, 
¡Üage
: 
MemStÜage
è-> 
IÁ”çû
 {

111 
IÁ”çû
::
Ãw
(
Raá
::Ãw(
cÚfig
, 
¡Üage
))

115 
â
 
	g»ad_mes§ges
<
	gT
: 
StÜage
>(
¿á
: &
mut
 
Raá
<
T
>è-> 
Vec
<
Mes§ge
> {

116 
¿á
.
msgs
.
d¿š
(..).
cŞËù
()

119 
â
 
’ts_w™h_cÚfig
(
‹rms
: 
Vec
<
u64
>, 
´e_vÙe
: 
boŞ
è-> 
IÁ”çû
 {

120 
Ët
 
¡Üe
 = 
MemStÜage
::
Ãw
();

121 
	gi
, 
	g‹rm
è
š
 
	g‹rms
.
™”
().
’um”©e
() {

122 
Ët
 
mut
 
	ge
 = 
EÁry
::
Ãw
();

123 
	ge
.
£t_šdex
(
i
 
as
 
u64
 + 1);

124 
	ge
.
£t_‹rm
(*
‹rm
);

125 
	g¡Üe
.
wl
().
­³nd
(&[
e
]).
ex³ù
("");

127 
Ët
 
mut
 
	g¿á
 = 
Ãw_‹¡_¿á_w™h_´evÙe
(1, 
vec
![], 5, 1, 
¡Üe
, 
´e_vÙe
);

128 
	g¿á
.
»£t
(
‹rms
[‹rms.
Ën
() - 1]);

129 
	g¿á


135 
â
 
vÙed_w™h_cÚfig
(
vÙe
: 
u64
, 
‹rm
: u64, 
´e_vÙe
: 
boŞ
è-> 
IÁ”çû
 {

136 
Ët
 
mut
 
h¬d_¡©e
 = 
H¬dS‹
::
Ãw
();

137 
	gh¬d_¡©e
.
£t_vÙe
(
vÙe
);

138 
	gh¬d_¡©e
.
£t_‹rm
(
‹rm
);

139 
Ët
 
	g¡Üe
 = 
MemStÜage
::
Ãw
();

140 
	g¡Üe
.
wl
().
£t_h¬d¡©e
(
h¬d_¡©e
);

141 
Ët
 
mut
 
	g¿á
 = 
Ãw_‹¡_¿á_w™h_´evÙe
(1, 
vec
![], 5, 1, 
¡Üe
, 
´e_vÙe
);

142 
	g¿á
.
»£t
(
‹rm
);

143 
	g¿á


147 
â
 
Ãxt_’ts
(
r
: &
mut
 
Raá
<
MemStÜage
>, 
s
: &MemStÜageè-> 
Vec
<
EÁry
> {

148 
s
.
wl
()

149 .
­³nd
(
r
.
¿á_log
.
un¡abË_’Œ›s
().
unw¿p_Ü
(&[]))

150 .
ex³ù
("");

151 
Ët
 (
Ï¡_idx
, 
Ï¡_‹rm
èğ(
r
.
¿á_log
.
Ï¡_šdex
(), 
	gr
.
	g¿á_log
.last_term());

152 
	gr
.
	g¿á_log
.
¡abË_to
(
Ï¡_idx
, 
Ï¡_‹rm
);

153 
Ët
 
	g’ts
 = 
r
.
¿á_log
.
Ãxt_’Œ›s
();

154 
Ët
 
	gcomm™‹d
 = 
r
.
¿á_log
.
comm™‹d
;

155 
	gr
.
	g¿á_log
.
­¶›d_to
(
comm™‹d
);

156 
	g’ts
.
unw¿p_Ü_–£
(
Vec
::
Ãw
)

159 #[
d”ive
(
DeçuÉ
, 
Debug
, 
P¬tŸlEq
, 
Eq
, 
Hash
)]

160 
	sCÚÃm
 {

161 
	mäom
: 
u64
,

162 
	mto
: 
u64
,

169 
pub
 
	sIÁ”çû
 {

170 
	m¿á
: 
O±iÚ
<
Raá
<
MemStÜage
>>,

173 
im¶
 
	gIÁ”çû
 {

174 
â
 
Ãw
(
r
: 
Raá
<
MemStÜage
>è-> 
IÁ”çû
 {

175 
IÁ”çû
 { 
¿á
: 
Some
(
r
) }

178 
pub
 
â
 
¡•
(&
mut
 
£lf
, 
m
: 
Mes§ge
è-> 
ResuÉ
<()> {

179 
m©ch
 
£lf
.
¿á
 {

180 
Some
(
_
è=> 
Raá
::
¡•
(
£lf
, 
m
),

181 
	gNÚe
 => 
Ok
(()),

185 
pub
 
â
 
»ad_mes§ges
(&
mut
 
£lf
è-> 
	gVec
<
	gMes§ge
> {

186 
m©ch
 
	g£lf
.
	g¿á
 {

187 
Some
(
_
è=> 
£lf
.
msgs
.
d¿š
(..).
cŞËù
(),

188 
	gNÚe
 => 
vec
![],

192 
â
 
š™Ÿl
(&
mut
 
£lf
, 
id
: 
u64
, 
ids
: &[u64]) {

193 
£lf
.
¿á
.
is_some
() {

194 
£lf
.
id
 = id;

195 
	g£lf
.
	g´s
 = 
RaáFÏtM­
::
w™h_ÿ·c™y
(
ids
.
Ën
());

196 
id
 
š
 
	gids
 {

197 
	g£lf
.
	g´s
.
š£¹
(

198 *
id
,

199 
Prog»ss
 {

200 ..
DeçuÉ
::()

204 
Ët
 
	g‹rm
 = 
£lf
.
‹rm
;

205 
	g£lf
.
»£t
(
‹rm
);

210 
im¶
 
D”ef
 
	gIÁ”çû
 {

211 
ty³
 
	gT¬g‘
 = 
Raá
<
MemStÜage
>;

212 
â
 
d”ef
(&
£lf
è-> &
	gRaá
<
	gMemStÜage
> {

213 
	g£lf
.
	g¿á
.
as_»f
().
unw¿p
()

217 
im¶
 
D”efMut
 
	gIÁ”çû
 {

218 
â
 
d”ef_mut
(&
mut
 
£lf
è-> &muˆ
	gRaá
<
	gMemStÜage
> {

219 
	g£lf
.
	g¿á
.
as_mut
().
unw¿p
()

223 
pub
 cÚ¡ 
	gNOP_STEPPER
: 
O±iÚ
<
IÁ”çû
> = 
Some
(IÁ”çû { 
¿á
: 
NÚe
 });

225 
pub
 cÚ¡ 
	gSOME_DATA
: 
O±iÚ
<&'static str> = Some("somedata");

227 
pub
 
â
 
Ãw_mes§ge_w™h_’Œ›s
(
äom
: 
u64
, 
to
: u64, 
t
: 
Mes§geTy³
, 
’ts
: 
Vec
<
EÁry
>è-> 
Mes§ge
 {

228 
Ët
 
mut
 
m
 = 
Mes§ge
::
Ãw
();

229 
	gm
.
£t_äom
(
äom
);

230 
	gm
.
£t_to
(
to
);

231 
	gm
.
£t_msg_ty³
(
t
);

232 !
	g’ts
.
is_em±y
() {

233 
	gm
.
£t_’Œ›s
(
R•—‹dF›ld
::
äom_vec
(
’ts
));

235 
	gm


238 
pub
 
â
 
Ãw_mes§ge
(
äom
: 
u64
, 
to
: u64, 
t
: 
Mes§geTy³
, 
n
: 
usize
è-> 
Mes§ge
 {

239 
Ët
 
mut
 
m
 = 
Ãw_mes§ge_w™h_’Œ›s
(
äom
, 
to
, 
t
, 
vec
![]);

240 
	gn
 > 0 {

241 
Ët
 
mut
 
	g’ts
 = 
Vec
::
w™h_ÿ·c™y
(
n
);

242 
_
 
	gš
 0..
	gn
 {

243 
	g’ts
.
push
(
Ãw_’Œy
(0, 0, 
SOME_DATA
));

245 
	gm
.
£t_’Œ›s
(
R•—‹dF›ld
::
äom_vec
(
’ts
));

247 
	gm


250 
pub
 
â
 
em±y_’Œy
(
‹rm
: 
u64
, 
šdex
: u64è-> 
EÁry
 {

251 
Ãw_’Œy
(
‹rm
, 
šdex
, 
NÚe
)

254 
pub
 
â
 
Ãw_’Œy
(
‹rm
: 
u64
, 
šdex
: u64, 
d©a
: 
O±iÚ
<&
¡r
>è-> 
EÁry
 {

255 
Ët
 
mut
 
e
 = 
EÁry
::
Ãw
();

256 
	ge
.
£t_šdex
(
šdex
);

257 
	ge
.
£t_‹rm
(
‹rm
);

258 
Ët
 
Some
(
d
èğ
d©a
 {

259 
e
.
£t_d©a
(
d
.
as_by‹s
().
to_vec
());

261 
	ge


264 
â
 
Ãw_¿á_log
(
’ts
: 
Vec
<
EÁry
>, 
off£t
: 
u64
, 
comm™‹d
: u64è-> 
RaáLog
<
MemStÜage
> {

265 
Ët
 
¡Üe
 = 
MemStÜage
::
Ãw
();

266 
	g¡Üe
.
wl
().
­³nd
(&
’ts
).
ex³ù
("");

267 
	gRaáLog
 {

268 
	g¡Üe
: 
¡Üe
,

269 
	gun¡abË
: 
Un¡abË
 {

270 
off£t
: offset,

271 ..
	gDeçuÉ
::()

273 
	gcomm™‹d
: 
comm™‹d
,

274 ..
	gDeçuÉ
::()

278 
â
 
Ãw_¿á_log_w™h_¡Üage
(
s
: 
MemStÜage
è-> 
RaáLog
<MemStorage> {

279 
RaáLog
::
Ãw
(
s
, 
SŒšg
::
äom
(""))

282 
pub
 
â
 
Ãw_¢­shÙ
(
šdex
: 
u64
, 
‹rm
: u64, 
nodes
: 
Vec
<u64>è-> 
SÇpshÙ
 {

283 
Ët
 
mut
 
s
 = 
SÇpshÙ
::
Ãw
();

284 
	gs
.
mut_m‘ad©a
().
£t_šdex
(
šdex
);

285 
	gs
.
mut_m‘ad©a
().
£t_‹rm
(
‹rm
);

286 
	gs
.
mut_m‘ad©a
().
mut_cÚf_¡©e
().
£t_nodes
(
nodes
);

287 
	gs


290 #[
d”ive
(
DeçuÉ
)]

291 
pub
 
	sN‘wÜk
 {

292 
pub
 
	m³”s
: 
HashM­
<
u64
, 
	mIÁ”çû
>,

293 
	m¡Üage
: 
HashM­
<
u64
, 
	mMemStÜage
>,

294 
	mdrİm
: 
HashM­
<
CÚÃm
, 
	mf64
>,

295 
	mignÜem
: 
HashM­
<
Mes§geTy³
, 
	mboŞ
>,

298 
im¶
 
	gN‘wÜk
 {

303 
pub
 
â
 
Ãw
(
³”s
: 
Vec
<
O±iÚ
<
IÁ”çû
>>è-> 
N‘wÜk
 {

304 
N‘wÜk
::
Ãw_w™h_cÚfig
(
³”s
, 
çl£
)

309 
pub
 
â
 
Ãw_w™h_cÚfig
(
mut
 
³”s
: 
Vec
<
O±iÚ
<
IÁ”çû
>>, 
´e_vÙe
: 
boŞ
è-> 
N‘wÜk
 {

310 
Ët
 
size
 = 
³”s
.
Ën
();

311 
Ët
 
	g³”_addrs
: 
Vec
<
u64
> = (1..
size
 
as
 u64 + 1).
cŞËù
();

312 
Ët
 
mut
 
	gn¡Üage
 = 
HashM­
::
Ãw
();

313 
Ët
 
mut
 
	gÅ“rs
 = 
HashM­
::
Ãw
();

314 
	gp
, 
	gid
è
š
 
	g³”s
.
d¿š
(..).
z
(
³”_addrs
.
şÚe
()) {

315 
m©ch
 
	gp
 {

316 
	gNÚe
 => {

317 
n¡Üage
.
š£¹
(
id
, 
Ãw_¡Üage
());

318 
Ët
 
	gr
 = 
Ãw_‹¡_¿á_w™h_´evÙe
(

319 
id
,

320 
³”_addrs
.
şÚe
(),

323 
n¡Üage
[&
id
].
şÚe
(),

324 
´e_vÙe
,

326 
	gÅ“rs
.
š£¹
(
id
, 
r
);

328 
Some
(
mut
 
p
) => {

329 
p
.
š™Ÿl
(
id
, &
³”_addrs
);

330 
	gÅ“rs
.
š£¹
(
id
, 
p
);

334 
	gN‘wÜk
 {

335 
	g³”s
: 
Å“rs
,

336 
	g¡Üage
: 
n¡Üage
,

337 ..
	gDeçuÉ
::()

341 
â
 
ignÜe
(&
mut
 
£lf
, 
t
: 
Mes§geTy³
) {

342 
£lf
.
ignÜem
.
š£¹
(
t
, 
Œue
);

345 
â
 
f‹r
(&
£lf
, 
mut
 
msgs
: 
Vec
<
Mes§ge
>) -> Vec<Message> {

346 
msgs
.
d¿š
(..)

347 .
f‹r
(|
m
| {

348 
£lf
.
ignÜem


349 .
g‘
(&
m
.
g‘_msg_ty³
())

350 .
şÚed
()

351 .
unw¿p_Ü
(
çl£
)

353  
çl£
;

356 
as£¹_Ã
!(
m
.
g‘_msg_ty³
(), 
Mes§geTy³
::
MsgHup
, "unexpected msgHup");

357 
Ët
 
³rc
 = 
£lf
.
drİm


358 .
g‘
(&
CÚÃm
 {

359 
äom
: 
m
.
g‘_äom
(),

360 
to
: 
m
.
g‘_to
(),

362 .
şÚed
()

363 .
unw¿p_Ü
(0f64);

364 
¿nd
::
¿ndom
::<
f64
>(è>ğ
³rc


366 .
cŞËù
()

369 
pub
 
â
 
£nd
(&
mut
 
£lf
, 
msgs
: 
Vec
<
Mes§ge
>) {

370 
Ët
 
mut
 
msgs
 = msgs;

371 !
	gmsgs
.
is_em±y
() {

372 
Ët
 
mut
 
	gÃw_msgs
 = 
vec
![];

373 
m
 
š
 
	gmsgs
.
d¿š
(..) {

374 
Ët
 
	g»¥
 = {

375 
Ët
 
p
 = 
£lf
.
³”s
.
g‘_mut
(&
m
.
g‘_to
()).
unw¿p
();

376 
	gp
.
¡•
(
m
).
ex³ù
("");

377 
	gp
.
»ad_mes§ges
()

379 
	gÃw_msgs
.
­³nd
(&
mut
 
£lf
.
f‹r
(
»¥
));

381 
	gmsgs
.
­³nd
(&
mut
 
Ãw_msgs
);

385 
â
 
drİ
(&
mut
 
£lf
, 
äom
: 
u64
, 
to
: u64, 
³rc
: 
f64
) {

386 
£lf
.
drİm
.
š£¹
(
CÚÃm
 { 
äom
: from, 
to
:Ø}, 
³rc
);

389 
â
 
cut
(&
mut
 
£lf
, 
Úe
: 
u64
, 
Ùh”
: u64) {

390 
£lf
.
drİ
(
Úe
, 
Ùh”
, 1f64);

391 
	g£lf
.
drİ
(
Ùh”
, 
Úe
, 1f64);

394 
â
 
isŞ©e
(&
mut
 
£lf
, 
id
: 
u64
) {

395 
i
 
š
 0..
£lf
.
³”s
.
Ën
(è
as
 
u64
 {

396 
Ët
 
nid
 = 
i
 + 1;

397 
	gnid
 !ğ
id
 {

398 
£lf
.
drİ
(
id
, 
nid
, 1.0);

399 
	g£lf
.
drİ
(
nid
, 
id
, 1.0);

404 
â
 
»cov”
(&
mut
 
£lf
) {

405 
	g£lf
.
	gdrİm
 = 
HashM­
::
Ãw
();

406 
	g£lf
.
	gignÜem
 = 
HashM­
::
Ãw
();

410 #[
‹¡
]

411 
â
 
	$‹¡_´og»ss_become_´obe
() {

412 
Ët
 
m©ched
 = 1u64;

413 
Ët
 
mut
 
‹¡s
 = 
vec
![

415 
	`Ãw_´og»ss
(
Prog»ssS‹
::
R•liÿ‹
, 
m©ched
, 5, 0, 256),

420 
	`Ãw_´og»ss
(
Prog»ssS‹
::
SÇpshÙ
, 
m©ched
, 5, 10, 256),

424 (
	`Ãw_´og»ss
(
Prog»ssS‹
::
SÇpshÙ
, 
m©ched
, 5, 0, 256), 2),

426 
i
, &
	`mut
 (
»f
 
mut
 
p
, 
wÃxt
)è
š
 
‹¡s
.
	`™”_mut
().
	`’um”©e
() {

427 
p
.
	`become_´obe
();

428 
p
.
¡©e
 !ğ
Prog»ssS‹
::
Probe
 {

429 
·nic
!(

431 
i
,

432 
p
.
¡©e
,

433 
Prog»ssS‹
::
Probe


436 
p
.
m©ched
 != matched {

437 
·nic
!("#{}: m©ch = {:?}, wªˆ{:?}", 
i
, 
p
.
m©ched
, matched);

439 
p
.
Ãxt_idx
 !ğ
wÃxt
 {

440 
·nic
!("#{}:‚exˆğ{}, wªˆ{}", 
i
, 
p
.
Ãxt_idx
, 
wÃxt
);

443 
	}
}

445 #[
‹¡
]

446 
â
 
	$‹¡_´og»ss_become_»¶iÿ‹
() {

447 
Ët
 
mut
 
p
 = 
	`Ãw_´og»ss
(
Prog»ssS‹
::
Probe
, 1, 5, 0, 256);

448 
p
.
	`become_»¶iÿ‹
();

450 
as£¹_eq
!(
p
.
¡©e
, 
Prog»ssS‹
::
R•liÿ‹
);

451 
as£¹_eq
!(
p
.
m©ched
, 1);

452 
as£¹_eq
!(
p
.
m©ched
 + 1,….
Ãxt_idx
);

453 
	}
}

455 #[
‹¡
]

456 
â
 
	$‹¡_´og»ss_become_¢­shÙ
() {

457 
Ët
 
mut
 
p
 = 
	`Ãw_´og»ss
(
Prog»ssS‹
::
Probe
, 1, 5, 0, 256);

458 
p
.
	`become_¢­shÙ
(10);

459 
as£¹_eq
!(
p
.
¡©e
, 
Prog»ssS‹
::
SÇpshÙ
);

460 
as£¹_eq
!(
p
.
m©ched
, 1);

461 
as£¹_eq
!(
p
.
³ndšg_¢­shÙ
, 10);

462 
	}
}

464 #[
‹¡
]

465 
â
 
	$‹¡_´og»ss_upd©e
() {

466 
	`Ët
 (
´ev_m
, 
´ev_n
) = (3u64, 5u64);

467 
Ët
 
‹¡s
 = 
vec
![

468 (
´ev_m
 - 1,…»v_m, 
´ev_n
, 
çl£
),

469 (
´ev_m
,…»v_m, 
´ev_n
, 
çl£
),

470 (
´ev_m
 + 1,…»v_m + 1, 
´ev_n
, 
Œue
),

471 (
´ev_m
 + 2,…»v_m + 2, 
´ev_n
 + 1, 
Œue
),

473 
i
, &(
upd©e
, 
wm
, 
wn
, 
wok
)è
š
 
‹¡s
.
	`™”
().
	`’um”©e
() {

474 
Ët
 
mut
 
p
 = 
Prog»ss
 {

475 
m©ched
: 
´ev_m
,

476 
Ãxt_idx
: 
´ev_n
,

477 ..
DeçuÉ
::()

479 
Ët
 
ok
 = 
p
.
	`maybe_upd©e
(
upd©e
);

480 
ok
 !ğ
wok
 {

481 
·nic
!("#{}: okğ{}, wªˆ{}", 
i
, 
ok
, 
wok
);

483 
p
.
m©ched
 !ğ
wm
 {

484 
·nic
!("#{}: m©chğ{}, wªˆ{}", 
i
, 
p
.
m©ched
, 
wm
);

486 
p
.
Ãxt_idx
 !ğ
wn
 {

487 
·nic
!("#{}:‚extğ{}, wªˆ{}", 
i
, 
p
.
Ãxt_idx
, 
wn
);

490 
	}
}

492 #[
‹¡
]

493 
â
 
	$‹¡_´og»ss_maybe_deü
() {

494 
Ët
 
‹¡s
 = 
vec
![

496 (
Prog»ssS‹
::
R•liÿ‹
, 5, 10, 5, 5, 
çl£
, 10),

498 (
Prog»ssS‹
::
R•liÿ‹
, 5, 10, 4, 4, 
çl£
, 10),

501 (
Prog»ssS‹
::
R•liÿ‹
, 5, 10, 9, 9, 
Œue
, 6),

503 (
Prog»ssS‹
::
Probe
, 0, 0, 0, 0, 
çl£
, 0),

505 (
Prog»ssS‹
::
Probe
, 0, 10, 5, 5, 
çl£
, 10),

507 (
Prog»ssS‹
::
Probe
, 0, 10, 9, 9, 
Œue
, 9),

509 (
Prog»ssS‹
::
Probe
, 0, 2, 1, 1, 
Œue
, 1),

511 (
Prog»ssS‹
::
Probe
, 0, 1, 0, 0, 
Œue
, 1),

513 (
Prog»ssS‹
::
Probe
, 0, 10, 9, 2, 
Œue
, 3),

515 (
Prog»ssS‹
::
Probe
, 0, 10, 9, 0, 
Œue
, 1),

517 
i
, &(
¡©e
, 
m
, 
n
, 
»jeùed
, 
Ï¡
, 
w
, 
wn
)è
š
 
‹¡s
.
	`™”
().
	`’um”©e
() {

518 
Ët
 
mut
 
p
 = 
	`Ãw_´og»ss
(
¡©e
, 
m
, 
n
, 0, 0);

519 
p
.
	`maybe_deü_to
(
»jeùed
, 
Ï¡
è!ğ
w
 {

520 
·nic
!("#{}: maybeDeüToğ{}, wªˆ{}", 
i
, !
w
, w);

522 
p
.
m©ched
 !ğ
m
 {

523 
·nic
!("#{}: m©chğ{}, wªˆ{}", 
i
, 
p
.
m©ched
, 
m
);

525 
p
.
Ãxt_idx
 !ğ
wn
 {

526 
·nic
!("#{}:‚extğ{}, wªˆ{}", 
i
, 
p
.
Ãxt_idx
, 
wn
);

529 
	}
}

531 #[
‹¡
]

532 
â
 
	$‹¡_´og»ss_is_·u£d
() {

533 
Ët
 
‹¡s
 = 
vec
![

534 (
Prog»ssS‹
::
Probe
, 
çl£
, false),

535 (
Prog»ssS‹
::
Probe
, 
Œue
,rue),

536 (
Prog»ssS‹
::
R•liÿ‹
, 
çl£
, false),

537 (
Prog»ssS‹
::
R•liÿ‹
, 
Œue
, 
çl£
),

538 (
Prog»ssS‹
::
SÇpshÙ
, 
çl£
, 
Œue
),

539 (
Prog»ssS‹
::
SÇpshÙ
, 
Œue
,rue),

541 
i
, &(
¡©e
, 
·u£d
, 
w
)è
š
 
‹¡s
.
	`™”
().
	`’um”©e
() {

542 
Ët
 
p
 = 
Prog»ss
 {

543 
¡©e
: state,

544 
·u£d
:…aused,

545 
šs
: 
Inæights
::
	`Ãw
(256),

546 ..
DeçuÉ
::()

548 
p
.
	`is_·u£d
(è!ğ
w
 {

549 
·nic
!("#{}: shouldwa™ = {}, wªˆ{}", 
i
, 
p
.
	`is_·u£d
(), 
w
)

552 
	}
}

556 #[
‹¡
]

557 
â
 
	$‹¡_´og»ss_»sume
() {

558 
Ët
 
mut
 
p
 = 
Prog»ss
 {

559 
Ãxt_idx
: 2,

560 
·u£d
: 
Œue
,

561 ..
DeçuÉ
::()

563 
p
.
	`maybe_deü_to
(1, 1);

564 
as£¹
!(!
p
.
·u£d
, "paused=rue, want false");

565 
p
.
·u£d
 = 
Œue
;

566 
p
.
	`maybe_upd©e
(2);

567 
as£¹
!(!
p
.
·u£d
, "paused=rue, want false");

568 
	}
}

572 #[
‹¡
]

573 
â
 
	$‹¡_´og»ss_»sume_by_h—¹b—t_»¥
() {

574 
Ët
 
mut
 
¿á
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 5, 1, 
	`Ãw_¡Üage
());

575 
¿á
.
	`become_ÿndid©e
();

576 
¿á
.
	`become_Ëad”
();

577 
¿á
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
·u£d
 = 
Œue
;

579 
¿á
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgB—t
, 0))

580 .
	`ex³ù
("");

581 
as£¹
!(
¿á
.
´s
[&2].
·u£d
);

583 
¿á
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_»¶iÿ‹
();

584 
¿á
.
	`¡•
(
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 0))

585 .
	`ex³ù
("");

586 
as£¹
!(!
¿á
.
´s
[&2].
·u£d
);

587 
	}
}

589 #[
‹¡
]

590 
â
 
	$‹¡_´og»ss_·u£d
() {

591 
Ët
 
mut
 
¿á
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 5, 1, 
	`Ãw_¡Üage
());

592 
¿á
.
	`become_ÿndid©e
();

593 
¿á
.
	`become_Ëad”
();

594 
Ët
 
mut
 
m
 = 
Mes§ge
::
	`Ãw
();

595 
m
.
	`£t_äom
(1);

596 
m
.
	`£t_to
(1);

597 
m
.
	`£t_msg_ty³
(
Mes§geTy³
::
MsgPrİo£
);

598 
Ët
 
mut
 
e
 = 
EÁry
::
	`Ãw
();

599 
e
.
	`£t_d©a
(
b
"some_d©a".
	`to_vec
());

600 
m
.
	`£t_’Œ›s
(
R•—‹dF›ld
::
	`äom_vec
(
vec
![
e
]));

601 
¿á
.
	`¡•
(
m
.
	`şÚe
()).
	`ex³ù
("");

602 
¿á
.
	`¡•
(
m
.
	`şÚe
()).
	`ex³ù
("");

603 
¿á
.
	`¡•
(
m
.
	`şÚe
()).
	`ex³ù
("");

604 
Ët
 
ms
 = 
	`»ad_mes§ges
(&
mut
 
¿á
);

605 
as£¹_eq
!(
ms
.
	`Ën
(), 1);

606 
	}
}

608 #[
‹¡
]

609 
â
 
	$‹¡_Ëad”_–eùiÚ
() {

610 
	`‹¡_Ëad”_–eùiÚ_w™h_cÚfig
(
çl£
);

611 
	}
}

613 #[
‹¡
]

614 
â
 
	$‹¡_Ëad”_–eùiÚ_´e_vÙe
() {

615 
	`‹¡_Ëad”_–eùiÚ_w™h_cÚfig
(
Œue
);

616 
	}
}

618 
â
 
	$‹¡_Ëad”_–eùiÚ_w™h_cÚfig
(
´e_vÙe
: 
boŞ
) {

619 
Ët
 
mut
 
‹¡s
 = 
vec
![

621 
N‘wÜk
::
	`Ãw_w™h_cÚfig
(
vec
![
NÚe
, NÚe, NÚe], 
´e_vÙe
),

622 
S‹RŞe
::
L—d”
,

626 
N‘wÜk
::
	`Ãw_w™h_cÚfig
(
vec
![
NÚe
, NÚe, 
NOP_STEPPER
], 
´e_vÙe
),

627 
S‹RŞe
::
L—d”
,

631 
N‘wÜk
::
	`Ãw_w™h_cÚfig
(
vec
![
NÚe
, 
NOP_STEPPER
, NOP_STEPPER], 
´e_vÙe
),

632 
S‹RŞe
::
Cªdid©e
,

636 
N‘wÜk
::
	`Ãw_w™h_cÚfig
(
vec
![
NÚe
, 
NOP_STEPPER
, NOP_STEPPER, NÚe], 
´e_vÙe
),

637 
S‹RŞe
::
Cªdid©e
,

641 
N‘wÜk
::
	`Ãw_w™h_cÚfig
(
vec
![
NÚe
, 
NOP_STEPPER
, NOP_STEPPER, NÚe, NÚe], 
´e_vÙe
),

642 
S‹RŞe
::
L—d”
,

649 
N‘wÜk
::
	`Ãw_w™h_cÚfig
(

650 
vec
![

651 
NÚe
,

652 
	`Some
(
	`’ts_w™h_cÚfig
(
vec
![1], 
´e_vÙe
)),

653 
	`Some
(
	`’ts_w™h_cÚfig
(
vec
![1], 
´e_vÙe
)),

654 
	`Some
(
	`’ts_w™h_cÚfig
(
vec
![1, 1], 
´e_vÙe
)),

655 
NÚe
,

657 
´e_vÙe
,

659 
S‹RŞe
::
FŞlow”
,

664 
i
, &
	`mut
 (
»f
 
mut
 
ÃtwÜk
, 
¡©e
, 
‹rm
)è
š
 
‹¡s
.
	`™”_mut
().
	`’um”©e
() {

665 
Ët
 
mut
 
m
 = 
Mes§ge
::
	`Ãw
();

666 
m
.
	`£t_äom
(1);

667 
m
.
	`£t_to
(1);

668 
m
.
	`£t_msg_ty³
(
Mes§geTy³
::
MsgHup
);

669 
ÃtwÜk
.
	`£nd
(
vec
![
m
]);

670 
Ët
 
¿á
 = &
ÃtwÜk
.
³”s
[&1];

671 
	`Ët
 (
exp_¡©e
, 
exp_‹rm
èğ
¡©e
 =ğ
S‹RŞe
::
Cªdid©e
 && 
´e_vÙe
 {

675 (
S‹RŞe
::
P»Cªdid©e
, 0)

677 (
¡©e
, 
‹rm
)

679 
¿á
.
¡©e
 !ğ
exp_¡©e
 {

680 
·nic
!("#{}: s‹ = {:?}, wªˆ{:?}", 
i
, 
¿á
.
¡©e
, 
exp_¡©e
);

682 
¿á
.
‹rm
 !ğ
exp_‹rm
 {

683 
·nic
!("#{}:”m = {}, wªˆ{}", 
i
, 
¿á
.
‹rm
, 
exp_‹rm
)

686 
	}
}

688 #[
‹¡
]

689 
â
 
	$‹¡_Ëad”_cyşe
() {

690 
	`‹¡_Ëad”_cyşe_w™h_cÚfig
(
çl£
)

691 
	}
}

693 #[
‹¡
]

694 
â
 
	$‹¡_Ëad”_cyşe_´e_vÙe
() {

695 
	`‹¡_Ëad”_cyşe_w™h_cÚfig
(
Œue
)

696 
	}
}

702 
â
 
	$‹¡_Ëad”_cyşe_w™h_cÚfig
(
´e_vÙe
: 
boŞ
) {

703 
Ët
 
mut
 
ÃtwÜk
 = 
N‘wÜk
::
	`Ãw_w™h_cÚfig
(
vec
![
NÚe
, NÚe, NÚe], 
´e_vÙe
);

704 
ÿm·igÃr_id
 
š
 1..4 {

705 
ÃtwÜk
.
	`£nd
(
vec
![

706 
	`Ãw_mes§ge
(
ÿm·igÃr_id
, cam·igÃr_id, 
Mes§geTy³
::
MsgHup
, 0),

709 
sm
 
š
 
ÃtwÜk
.
³”s
.
	`v®ues
() {

710 
sm
.
id
 =ğ
ÿm·igÃr_id
 && sm.
¡©e
 !ğ
S‹RŞe
::
L—d”
 {

711 
·nic
!(

713 
´e_vÙe
,

714 
sm
.
id
,

715 
sm
.
¡©e


717 } 
sm
.
id
 !ğ
ÿm·igÃr_id
 && sm.
¡©e
 !ğ
S‹RŞe
::
FŞlow”
 {

718 
·nic
!(

721 
´e_vÙe
,

722 
ÿm·igÃr_id
,

723 
sm
.
id
,

724 
sm
.
¡©e


729 
	}
}

732 #[
‹¡
]

733 
â
 
	$‹¡_Ëad”_–eùiÚ_ov”wr™e_Ãw”_logs
() {

734 
	`‹¡_Ëad”_–eùiÚ_ov”wr™e_Ãw”_logs_w™h_cÚfig
(
çl£
);

735 
	}
}

737 #[
‹¡
]

738 
â
 
	$‹¡_Ëad”_–eùiÚ_ov”wr™e_Ãw”_logs_´e_vÙe
() {

739 
	`‹¡_Ëad”_–eùiÚ_ov”wr™e_Ãw”_logs_w™h_cÚfig
(
Œue
);

740 
	}
}

746 
â
 
	$‹¡_Ëad”_–eùiÚ_ov”wr™e_Ãw”_logs_w™h_cÚfig
(
´e_vÙe
: 
boŞ
) {

761 
Ët
 
mut
 
ÃtwÜk
 = 
N‘wÜk
::
	`Ãw_w™h_cÚfig
(

762 
vec
![

763 
	`Some
(
	`’ts_w™h_cÚfig
(
vec
![1], 
´e_vÙe
)),

764 
	`Some
(
	`’ts_w™h_cÚfig
(
vec
![1], 
´e_vÙe
)),

765 
	`Some
(
	`’ts_w™h_cÚfig
(
vec
![2], 
´e_vÙe
)),

766 
	`Some
(
	`vÙed_w™h_cÚfig
(3, 2, 
´e_vÙe
)),

767 
	`Some
(
	`vÙed_w™h_cÚfig
(3, 2, 
´e_vÙe
)),

769 
´e_vÙe
,

775 
ÃtwÜk
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

776 
as£¹_eq
!(
ÃtwÜk
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
FŞlow”
);

777 
as£¹_eq
!(
ÃtwÜk
.
³”s
[&1].
‹rm
, 2);

780 
ÃtwÜk
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

781 
as£¹_eq
!(
ÃtwÜk
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

782 
as£¹_eq
!(
ÃtwÜk
.
³”s
[&1].
‹rm
, 3);

786 
id
, 
sm
è
š
 &
ÃtwÜk
.
³”s
 {

787 
Ët
 
’Œ›s
 = 
sm
.
¿á_log
.
	`®l_’Œ›s
();

788 
as£¹_eq
!(

789 
’Œ›s
.
	`Ën
(),

792 
id
,

793 
’Œ›s
.
	`Ën
()

795 
as£¹_eq
!(

796 
’Œ›s
[0].
	`g‘_‹rm
(),

799 
id
,

800 
’Œ›s
[0].
	`g‘_‹rm
()

802 
as£¹_eq
!(

803 
’Œ›s
[1].
	`g‘_‹rm
(),

806 
id
,

807 
’Œ›s
[1].
	`g‘_‹rm
()

810 
	}
}

813 #[
‹¡
]

814 
â
 
	$‹¡_vÙe_äom_ªy_¡©e
() {

815 
	`‹¡_vÙe_äom_ªy_¡©e_fÜ_ty³
(
Mes§geTy³
::
MsgReque¡VÙe
);

816 
	}
}

818 #[
‹¡
]

819 
â
 
	$‹¡_´evÙe_äom_ªy_¡©e
() {

820 
	`‹¡_vÙe_äom_ªy_¡©e_fÜ_ty³
(
Mes§geTy³
::
MsgReque¡P»VÙe
);

821 
	}
}

823 
â
 
	$‹¡_vÙe_äom_ªy_¡©e_fÜ_ty³
(
vt
: 
Mes§geTy³
) {

824 
Ët
 
®l_¡©es
 = 
vec
![

825 
S‹RŞe
::
FŞlow”
,

826 
S‹RŞe
::
Cªdid©e
,

827 
S‹RŞe
::
P»Cªdid©e
,

828 
S‹RŞe
::
L—d”
,

830 
¡©e
 
š
 
®l_¡©es
 {

831 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

832 
r
.
‹rm
 = 1;

833 
m©ch
 
¡©e
 {

834 
S‹RŞe
::
FŞlow”
 => {

835 
Ët
 
‹rm
 = 
r
.term;

836 
r
.
	`become_fŞlow”
(
‹rm
, 3);

838 
S‹RŞe
::
P»Cªdid©e
 => 
r
.
	`become_´e_ÿndid©e
(),

839 
S‹RŞe
::
Cªdid©e
 => 
r
.
	`become_ÿndid©e
(),

840 
S‹RŞe
::
L—d”
 => {

841 
r
.
	`become_ÿndid©e
();

842 
r
.
	`become_Ëad”
();

847 
Ët
 
Üig_‹rm
 = 
r
.
‹rm
;

848 
Ët
 
Ãw_‹rm
 = 
r
.
‹rm
 + 1;

850 
Ët
 
mut
 
msg
 = 
	`Ãw_mes§ge
(2, 1, 
vt
, 0);

851 
msg
.
	`£t_‹rm
(
Ãw_‹rm
);

852 
msg
.
	`£t_log_‹rm
(
Ãw_‹rm
);

853 
msg
.
	`£t_šdex
(42);

854 
r
.
	`¡•
(
msg
)

855 .
	`ex³ù
(&
fÜm©
!("{:?},{:?}: s‹°çed", 
vt
, 
¡©e
));

856 
as£¹_eq
!(

857 
r
.
msgs
.
	`Ën
(),

860 
vt
,

861 
¡©e
,

862 
r
.
msgs
.
	`Ën
(),

863 
r
.
msgs


865 
Ët
 
»¥
 = &
r
.
msgs
[0];

866 
as£¹_eq
!(

867 
»¥
.
	`g‘_msg_ty³
(),

868 
	`vÙe_»¥_msg_ty³
(
vt
),

870 
vt
,

871 
¡©e
,

872 
»¥
.
	`g‘_msg_ty³
(),

873 
	`vÙe_»¥_msg_ty³
(
vt
)

875 
as£¹
!(

876 !
»¥
.
	`g‘_»jeù
(),

878 
vt
,

879 
¡©e


883 
vt
 =ğ
Mes§geTy³
::
MsgReque¡VÙe
 {

884 
as£¹_eq
!(

885 
r
.
¡©e
,

886 
S‹RŞe
::
FŞlow”
,

888 
vt
,

889 
¡©e
,

890 
r
.
¡©e
,

891 
S‹RŞe
::
FŞlow”


893 
as£¹_eq
!(

894 
r
.
‹rm
,

895 
Ãw_‹rm
,

897 
vt
,

898 
¡©e
,

899 
r
.
‹rm
,

900 
Ãw_‹rm


902 
as£¹_eq
!(
r
.
vÙe
, 2, "{:?},{:?}, vÙ{}, wªˆ2", 
vt
, 
¡©e
,„.vote);

905 
as£¹_eq
!(

906 
r
.
¡©e
,

907 
¡©e
,

909 
vt
,

910 
¡©e
,

911 
r
.
¡©e
,

912 
¡©e


914 
as£¹_eq
!(

915 
r
.
‹rm
,

916 
Üig_‹rm
,

918 
vt
,

919 
¡©e
,

920 
r
.
‹rm
,

921 
Üig_‹rm


925 
as£¹
!(

926 
r
.
vÙe
 =ğ
INVALID_ID
 ||„.vote == 1,

928 
vt
,

929 
¡©e
,

930 
r
.
vÙe
,

931 
INVALID_ID


935 
	}
}

937 #[
‹¡
]

938 
â
 
	$‹¡_log_»¶iÿtioš
() {

939 
Ët
 
mut
 
‹¡s
 = 
vec
![

941 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]),

942 
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)],

947 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]),

948 
vec
![

949 
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1),

950 
	`Ãw_mes§ge
(1, 2, 
Mes§geTy³
::
MsgHup
, 0),

951 
	`Ãw_mes§ge
(1, 2, 
Mes§geTy³
::
MsgPrİo£
, 1),

957 
i
, &
	`mut
 (
»f
 
mut
 
ÃtwÜk
,„eà
msgs
, 
wcomm™‹d
)è
š
 
‹¡s
.
	`™”_mut
().
	`’um”©e
() {

958 
ÃtwÜk
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

959 
m
 
š
 
msgs
 {

960 
ÃtwÜk
.
	`£nd
(
vec
![
m
.
	`şÚe
()]);

963 
j
, 
x
è
š
 &
mut
 
ÃtwÜk
.
³”s
 {

964 
x
.
¿á_log
.
comm™‹d
 !ğ
wcomm™‹d
 {

965 
·nic
!(

967 
i
,

968 
j
,

969 
x
.
¿á_log
.
comm™‹d
,

970 
wcomm™‹d


974 
Ët
 
mut
 
’ts
 = 
	`Ãxt_’ts
(
x
, &
ÃtwÜk
.
¡Üage
[
j
]);

975 
Ët
 
’ts
: 
Vec
<
EÁry
> =ƒÁs.
	`d¿š
(..)

976 .
	`f‹r
(|
e
| !e.
	`g‘_d©a
().
	`is_em±y
())

977 .
	`cŞËù
();

978 
k
, 
m
è
š
 
msgs
.
	`™”
()

979 .
	`f‹r
(|
m
| m.
	`g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgPrİo£
)

980 .
	`’um”©e
()

982 
’ts
[
k
].
	`g‘_d©a
(è!ğ
m
.
	`g‘_’Œ›s
()[0].get_data() {

983 
·nic
!(

985 
i
,

986 
j
,

987 
’ts
[
k
].
	`g‘_d©a
(),

988 
m
.
	`g‘_’Œ›s
()[0].
	`g‘_d©a
()

994 
	}
}

996 #[
‹¡
]

997 
â
 
	$‹¡_sšgË_node_comm™
() {

998 
Ët
 
mut
 
‰
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
]);

999 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1000 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

1001 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

1003 
as£¹_eq
!(
‰
.
³”s
[&1].
¿á_log
.
comm™‹d
, 3);

1004 
	}
}

1009 #[
‹¡
]

1010 
â
 
	$‹¡_ÿÂÙ_comm™_w™hout_Ãw_‹rm_’Œy
() {

1011 
Ët
 
mut
 
‰
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None, None, None]);

1012 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1015 
‰
.
	`cut
(1, 3);

1016 
‰
.
	`cut
(1, 4);

1017 
‰
.
	`cut
(1, 5);

1019 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

1020 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

1022 
as£¹_eq
!(
‰
.
³”s
[&1].
¿á_log
.
comm™‹d
, 1);

1025 
‰
.
	`»cov”
();

1027 
‰
.
	`ignÜe
(
Mes§geTy³
::
MsgAµ’d
);

1030 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(2, 2, 
Mes§geTy³
::
MsgHup
, 0)]);

1033 
as£¹_eq
!(
‰
.
³”s
[&2].
¿á_log
.
comm™‹d
, 1);

1035 
‰
.
	`»cov”
();

1037 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(2, 2, 
Mes§geTy³
::
MsgB—t
, 0)]);

1039 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(2, 2, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

1041 
as£¹_eq
!(
‰
.
³”s
[&2].
¿á_log
.
comm™‹d
, 5);

1042 
	}
}

1046 #[
‹¡
]

1047 
â
 
	$‹¡_comm™_w™hout_Ãw_‹rm_’Œy
() {

1048 
Ët
 
mut
 
‰
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None, None, None]);

1049 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1052 
‰
.
	`cut
(1, 3);

1053 
‰
.
	`cut
(1, 4);

1054 
‰
.
	`cut
(1, 5);

1056 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

1057 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

1059 
as£¹_eq
!(
‰
.
³”s
[&1].
¿á_log
.
comm™‹d
, 1);

1062 
‰
.
	`»cov”
();

1067 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(2, 2, 
Mes§geTy³
::
MsgHup
, 0)]);

1069 
as£¹_eq
!(
‰
.
³”s
[&1].
¿á_log
.
comm™‹d
, 4);

1070 
	}
}

1072 #[
‹¡
]

1073 
â
 
	$‹¡_du–šg_ÿndid©es
() {

1074 
Ët
 
a
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

1075 
Ët
 
b
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

1076 
Ët
 
c
 = 
	`Ãw_‹¡_¿á
(3, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

1078 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
a
), Some(
b
), Some(
c
)]);

1079 
Á
.
	`cut
(1, 3);

1081 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1082 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

1085 
as£¹_eq
!(
Á
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

1088 
as£¹_eq
!(
Á
.
³”s
[&3].
¡©e
, 
S‹RŞe
::
Cªdid©e
);

1090 
Á
.
	`»cov”
();

1096 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

1098 
Ët
 
wlog
 = 
	`Ãw_¿á_log
(
vec
![
	`em±y_’Œy
(1, 1)], 2, 1);

1099 
Ët
 
wlog2
 = 
	`Ãw_¿á_log_w™h_¡Üage
(
	`Ãw_¡Üage
());

1100 
Ët
 
‹¡s
 = 
vec
![

1101 (
S‹RŞe
::
FŞlow”
, 2, &
wlog
),

1102 (
S‹RŞe
::
FŞlow”
, 2, &
wlog
),

1103 (
S‹RŞe
::
FŞlow”
, 2, &
wlog2
),

1106 
i
, &(
¡©e
, 
‹rm
, 
¿á_log
)è
š
 
‹¡s
.
	`™”
().
	`’um”©e
() {

1107 
Ët
 
id
 = 
i
 
as
 
u64
 + 1;

1108 
Á
.
³”s
[&
id
].
¡©e
 != state {

1109 
·nic
!(

1111 
i
,

1112 
Á
.
³”s
[&
id
].
¡©e
,

1113 
¡©e


1116 
Á
.
³”s
[&
id
].
‹rm
 !=erm {

1117 
·nic
!("#{}:”m = {}, wªˆ{}", 
i
, 
Á
.
³”s
[&
id
].
‹rm
,erm);

1119 
Ët
 
ba£
 = 
	`Éß
(
¿á_log
);

1120 
Ët
 
l
 = 
	`Éß
(&
Á
.
³”s
[&(1 + 
i
 
as
 
u64
)].
¿á_log
);

1121 
ba£
 !ğ
l
 {

1122 
·nic
!("#{}:„aá_log:\À{}, wªt:\À{}", 
i
, 
l
, 
ba£
);

1125 
	}
}

1127 #[
‹¡
]

1128 
â
 
	$‹¡_du–šg_´e_ÿndid©es
() {

1129 
Ët
 
a
 = 
	`Ãw_‹¡_¿á_w™h_´evÙe
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
(), 
Œue
);

1130 
Ët
 
b
 = 
	`Ãw_‹¡_¿á_w™h_´evÙe
(2, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
(), 
Œue
);

1131 
Ët
 
c
 = 
	`Ãw_‹¡_¿á_w™h_´evÙe
(3, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
(), 
Œue
);

1133 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw_w™h_cÚfig
(
vec
![
	`Some
(
a
), Some(
b
), Some(
c
)], 
Œue
);

1134 
Á
.
	`cut
(1, 3);

1136 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1137 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

1140 
as£¹_eq
!(
Á
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

1143 
as£¹_eq
!(
Á
.
³”s
[&3].
¡©e
, 
S‹RŞe
::
FŞlow”
);

1145 
Á
.
	`»cov”
();

1149 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

1151 
Ët
 
wlog
 = 
	`Ãw_¿á_log
(
vec
![
	`em±y_’Œy
(0, 0),ƒmpty_entry(1, 1)], 2, 1);

1152 
Ët
 
wlog2
 = 
	`Ãw_¿á_log_w™h_¡Üage
(
	`Ãw_¡Üage
());

1153 
Ët
 
‹¡s
 = 
vec
![

1154 (1, 
S‹RŞe
::
L—d”
, 1, &
wlog
),

1155 (2, 
S‹RŞe
::
FŞlow”
, 1, &
wlog
),

1156 (3, 
S‹RŞe
::
FŞlow”
, 1, &
wlog2
),

1158 
i
, &(
id
, 
¡©e
, 
‹rm
, 
¿á_log
)è
š
 
‹¡s
.
	`™”
().
	`’um”©e
() {

1159 
Á
.
³”s
[&
id
].
¡©e
 != state {

1160 
·nic
!(

1162 
i
,

1163 
Á
.
³”s
[&
id
].
¡©e
,

1164 
¡©e


1167 
Á
.
³”s
[&
id
].
‹rm
 !=erm {

1168 
·nic
!("#{}:”m = {}, wªˆ{}", 
i
, 
Á
.
³”s
[&
id
].
‹rm
,erm);

1170 
Ët
 
ba£
 = 
	`Éß
(
¿á_log
);

1171 
Ët
 
l
 = 
	`Éß
(&
Á
.
³”s
[&(1 + 
i
 
as
 
u64
)].
¿á_log
);

1172 
ba£
 !ğ
l
 {

1173 
·nic
!("#{}:„aá_log:\À{}, wªt:\À{}", 
i
, 
l
, 
ba£
);

1176 
	}
}

1178 #[
‹¡
]

1179 
â
 
	$‹¡_ÿndid©e_cÚûde
() {

1180 
Ët
 
mut
 
‰
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

1181 
‰
.
	`isŞ©e
(1);

1183 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1184 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

1187 
‰
.
	`»cov”
();

1189 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgB—t
, 0)]);

1192 
Ët
 
d©a
 = "force follower";

1193 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgPrİo£
, 0);

1194 
m
.
	`£t_’Œ›s
(
R•—‹dF›ld
::
	`äom_vec
(
vec
![
	`Ãw_’Œy
(0, 0, 
	`Some
(
d©a
))]));

1195 
‰
.
	`£nd
(
vec
![
m
]);

1197 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgB—t
, 0)]);

1199 
as£¹_eq
!(
‰
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
FŞlow”
);

1200 
as£¹_eq
!(
‰
.
³”s
[&1].
‹rm
, 1);

1202 
Ët
 
’ts
 = 
vec
![
	`em±y_’Œy
(1, 1), 
	`Ãw_’Œy
(1, 2, 
	`Some
(
d©a
))];

1203 
Ët
 
wªt_log
 = 
	`Éß
(&
	`Ãw_¿á_log
(
’ts
, 3, 2));

1204 
id
, 
p
è
š
 &
‰
.
³”s
 {

1205 
Ët
 
l
 = 
	`Éß
(&
p
.
¿á_log
);

1206 
l
 !ğ
wªt_log
 {

1207 
·nic
!("#{}:„aá_log: {}, wªt: {}", 
id
, 
l
, 
wªt_log
);

1210 
	}
}

1212 #[
‹¡
]

1213 
â
 
	$‹¡_sšgË_node_ÿndid©e
() {

1214 
Ët
 
mut
 
‰
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
]);

1215 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1217 
as£¹_eq
!(
‰
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

1218 
	}
}

1220 #[
‹¡
]

1221 
â
 
	$‹¡_sšË_node_´e_ÿndid©e
() {

1222 
Ët
 
mut
 
‰
 = 
N‘wÜk
::
	`Ãw_w™h_cÚfig
(
vec
![
NÚe
], 
Œue
);

1223 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1225 
as£¹_eq
!(
‰
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

1226 
	}
}

1228 #[
‹¡
]

1229 
â
 
	$‹¡_Şd_mes§ges
() {

1230 
Ët
 
mut
 
‰
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

1232 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1233 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(2, 2, 
Mes§geTy³
::
MsgHup
, 0)]);

1234 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1236 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’d
, 0);

1237 
m
.
	`£t_‹rm
(2);

1238 
m
.
	`£t_’Œ›s
(
R•—‹dF›ld
::
	`äom_vec
(
vec
![
	`em±y_’Œy
(2, 3)]));

1239 
‰
.
	`£nd
(
vec
![
m
]);

1241 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

1243 
Ët
 
’ts
 = 
vec
![

1244 
	`em±y_’Œy
(1, 1),

1245 
	`em±y_’Œy
(2, 2),

1246 
	`em±y_’Œy
(3, 3),

1247 
	`Ãw_’Œy
(3, 4, 
SOME_DATA
),

1249 
Ët
 
og
 = 
	`Ãw_¿á_log
(
’ts
, 5, 4);

1250 
Ët
 
ba£
 = 
	`Éß
(&
og
);

1251 
id
, 
p
è
š
 &
‰
.
³”s
 {

1252 
Ët
 
l
 = 
	`Éß
(&
p
.
¿á_log
);

1253 
l
 !ğ
ba£
 {

1254 
·nic
!("#{}:„aá_log: {}, wªt: {}", 
id
, 
l
, 
ba£
);

1257 
	}
}

1261 #[
‹¡
]

1262 
â
 
	$‹¡_´İo§l
() {

1263 
Ët
 
mut
 
‹¡s
 = 
vec
![

1264 (
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, NÚe, NÚe]), 
Œue
),

1265 (
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, NÚe, 
NOP_STEPPER
]), 
Œue
),

1266 (
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, 
NOP_STEPPER
, NOP_STEPPER]), 
çl£
),

1268 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, 
NOP_STEPPER
, NOP_STEPPER, None]),

1269 
çl£
,

1272 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, 
NOP_STEPPER
, NOP_STEPPER, None, None]),

1273 
Œue
,

1277 
j
, (
mut
 
nw
, 
sucûss
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

1278 
Ët
 
£nd
 = |
nw
: &
mut
 
N‘wÜk
, 
m
| {

1279 
Ët
 
»s
 = 
»cov”_§ã
!(|| 
nw
.
	`£nd
(
vec
![
m
]));

1280 
as£¹
!(
»s
.
	`is_ok
(è|| !
sucûss
);

1284 
	`£nd
(&
mut
 
nw
, 
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0));

1285 
	`£nd
(&
mut
 
nw
, 
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1));

1287 
Ët
 
wªt_log
 = 
sucûss
 {

1288 
	`Ãw_¿á_log
(
vec
![
	`em±y_’Œy
(1, 1), 
	`Ãw_’Œy
(1, 2, 
SOME_DATA
)], 3, 2)

1290 
	`Ãw_¿á_log_w™h_¡Üage
(
	`Ãw_¡Üage
())

1292 
Ët
 
ba£
 = 
	`Éß
(&
wªt_log
);

1293 
id
, 
p
è
š
 &
nw
.
³”s
 {

1294 
p
.
¿á
.
	`is_some
() {

1295 
Ët
 
l
 = 
	`Éß
(&
p
.
¿á_log
);

1296 
l
 !ğ
ba£
 {

1297 
·nic
!("#{}:„aá_log: {}, wªˆ{}", 
id
, 
l
, 
ba£
);

1301 
nw
.
³”s
[&1].
‹rm
 != 1 {

1302 
·nic
!("#{}:”m = {}, wªt: {}", 
j
, 
nw
.
³”s
[&1].
‹rm
, 1);

1305 
	}
}

1307 #[
‹¡
]

1308 
â
 
	$‹¡_´İo§l_by_´oxy
() {

1309 
Ët
 
mut
 
‹¡s
 = 
vec
![

1310 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]),

1311 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, NÚe, 
NOP_STEPPER
]),

1313 
j
, 
‰
è
š
 
‹¡s
.
	`™”_mut
().
	`’um”©e
() {

1315 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

1318 
‰
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(2, 2, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

1320 
Ët
 
wªt_log
 = 
	`Ãw_¿á_log
(
vec
![
	`em±y_’Œy
(1, 1), 
	`Ãw_’Œy
(1, 2, 
SOME_DATA
)], 3, 2);

1321 
Ët
 
ba£
 = 
	`Éß
(&
wªt_log
);

1322 
id
, 
p
è
š
 &
‰
.
³”s
 {

1323 
p
.
¿á
.
	`is_nÚe
() {

1326 
Ët
 
l
 = 
	`Éß
(&
p
.
¿á_log
);

1327 
l
 !ğ
ba£
 {

1328 
·nic
!("#{}:„aá_log: {}, wªt: {}", 
id
, 
l
, 
ba£
);

1331 
‰
.
³”s
[&1].
‹rm
 != 1 {

1332 
·nic
!("#{}:”m = {}, wªˆ{}", 
j
, 
‰
.
³”s
[&1].
‹rm
, 1);

1335 
	}
}

1337 #[
‹¡
]

1338 
â
 
	$‹¡_comm™
() {

1339 
Ët
 
mut
 
‹¡s
 = 
vec
![

1341 (
vec
![1u64], vec![
	`em±y_’Œy
(1, 1)], 1u64, 1u64),

1342 (
vec
![1], vec![
	`em±y_’Œy
(1, 1)], 2, 0),

1343 (
vec
![2], vec![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)], 2, 2),

1344 (
vec
![1], vec![
	`em±y_’Œy
(2, 1)], 2, 1),

1348 
vec
![2, 1, 1],

1349 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)],

1354 
vec
![2, 1, 1],

1355 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(1, 2)],

1360 
vec
![2, 1, 2],

1361 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)],

1366 
vec
![2, 1, 2],

1367 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(1, 2)],

1374 
vec
![2, 1, 1, 1],

1375 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)],

1380 
vec
![2, 1, 1, 1],

1381 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(1, 2)],

1386 
vec
![2, 1, 1, 2],

1387 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)],

1392 
vec
![2, 1, 1, 2],

1393 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(1, 2)],

1398 
vec
![2, 1, 2, 2],

1399 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)],

1404 
vec
![2, 1, 2, 2],

1405 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(1, 2)],

1411 
i
, (
m©ches
, 
logs
, 
sm_‹rm
, 
w
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

1412 
Ët
 
¡Üe
 = 
MemStÜage
::
	`Ãw
();

1413 
¡Üe
.
	`wl
().
	`­³nd
(&
logs
).
	`ex³ù
("");

1414 
Ët
 
mut
 
hs
 = 
H¬dS‹
::
	`Ãw
();

1415 
hs
.
	`£t_‹rm
(
sm_‹rm
);

1416 
¡Üe
.
	`wl
().
	`£t_h¬d¡©e
(
hs
);

1418 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1], 5, 1, 
¡Üe
);

1419 
j
, &
v
è
š
 
m©ches
.
	`™”
().
	`’um”©e
() {

1420 
sm
.
	`£t_´og»ss
(
j
 
as
 
u64
 + 1, 
v
, v + 1);

1422 
sm
.
	`maybe_comm™
();

1423 
sm
.
¿á_log
.
comm™‹d
 !ğ
w
 {

1424 
·nic
!("#{}: comm™‹d = {}, wªˆ{}", 
i
, 
sm
.
¿á_log
.
comm™‹d
, 
w
);

1427 
	}
}

1429 #[
‹¡
]

1430 
â
 
	$‹¡_·ss_–eùiÚ_timeout
() {

1431 
Ët
 
‹¡s
 = 
vec
![

1432 (5, 0f64, 
çl£
),

1433 (10, 0.1, 
Œue
),

1434 (13, 0.4, 
Œue
),

1435 (15, 0.6, 
Œue
),

1436 (18, 0.9, 
Œue
),

1437 (20, 1.0, 
çl£
),

1440 
i
, &(
–­£
, 
w´obab™y
, 
round
)è
š
 
‹¡s
.
	`™”
().
	`’um”©e
() {

1441 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1], 10, 1, 
	`Ãw_¡Üage
());

1442 
sm
.
–eùiÚ_–­£d
 = 
–­£
;

1443 
Ët
 
mut
 
c
 = 0;

1444 
_
 
š
 0..10000 {

1445 
sm
.
	`»£t_¿ndomized_–eùiÚ_timeout
();

1446 
sm
.
	`·ss_–eùiÚ_timeout
() {

1447 
c
 += 1;

1450 
Ët
 
mut
 
gÙ
 = 
c
 
as
 
f64
 / 10000.0;

1451 
round
 {

1452 
gÙ
 = (gÙ * 10.0 + 0.5).
	`æoÜ
() / 10.0;

1454 ià(
gÙ
 - 
w´obab™y
).
	`abs
() > 0.000001 {

1455 
·nic
!("#{}:…robab™y = {}, wªˆ{}", 
i
, 
gÙ
, 
w´obab™y
);

1458 
	}
}

1462 #[
‹¡
]

1463 
â
 
	$‹¡_¡•_ignÜe_Şd_‹rm_msg
() {

1464 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1], 10, 1, 
	`Ãw_¡Üage
());

1465 
Ët
 
·nic_befÜe_¡•_¡©e
 = 
Box
::
	`Ãw
(|
_
: &
Mes§ge
| {

1466 
·nic
!("before step state function hook called unexpectedly")

1468 
sm
.
befÜe_¡•_¡©e
 = 
	`Some
(
·nic_befÜe_¡•_¡©e
);

1469 
sm
.
‹rm
 = 2;

1470 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(0, 0, 
Mes§geTy³
::
MsgAµ’d
, 0);

1471 
m
.
	`£t_‹rm
(1);

1472 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

1473 
	}
}

1481 #[
‹¡
]

1482 
â
 
	$‹¡_hªdË_msg_­³nd
() {

1483 
Ët
 
nm
 = |
‹rm
, 
log_‹rm
, 
šdex
, 
comm™
, 
’ts
: 
O±iÚ
<
Vec
<(
u64
, u64)>>| {

1484 
Ët
 
mut
 
m
 = 
Mes§ge
::
	`Ãw
();

1485 
m
.
	`£t_msg_ty³
(
Mes§geTy³
::
MsgAµ’d
);

1486 
m
.
	`£t_‹rm
(
‹rm
);

1487 
m
.
	`£t_log_‹rm
(
log_‹rm
);

1488 
m
.
	`£t_šdex
(
šdex
);

1489 
m
.
	`£t_comm™
(
comm™
);

1490 
Ët
 
	`Some
(
‘s
èğ
’ts
 {

1491 
m
.
	`£t_’Œ›s
(
R•—‹dF›ld
::
	`äom_vec
(

1492 
‘s
.
	`™”
().
	`m­
(|&(
i
, 
t
)| 
	`em±y_’Œy
Ñ, i)).
	`cŞËù
(),

1495 
m


1497 
Ët
 
mut
 
‹¡s
 = 
vec
![

1499 (
	`nm
(2, 3, 2, 3, 
NÚe
), 2, 0, 
Œue
),

1500 (
	`nm
(2, 3, 3, 3, 
NÚe
), 2, 0, 
Œue
),

1503 (
	`nm
(2, 1, 1, 1, 
NÚe
), 2, 1, 
çl£
),

1504 (
	`nm
(2, 0, 0, 1, 
	`Some
(
vec
![(1, 2)])), 1, 1, 
çl£
),

1505 (
	`nm
(2, 2, 2, 3, 
	`Some
(
vec
![(3, 2), (4, 2)])), 4, 3, 
çl£
),

1506 (
	`nm
(2, 2, 2, 4, 
	`Some
(
vec
![(3, 2)])), 3, 3, 
çl£
),

1507 (
	`nm
(2, 1, 1, 4, 
	`Some
(
vec
![(2, 2)])), 2, 2, 
çl£
),

1510 (
	`nm
(1, 1, 1, 3, 
NÚe
), 2, 1, 
çl£
),

1511 (
	`nm
(1, 1, 1, 3, 
	`Some
(
vec
![(2, 2)])), 2, 2, 
çl£
),

1513 (
	`nm
(2, 2, 2, 3, 
NÚe
), 2, 2, 
çl£
),

1514 (
	`nm
(2, 2, 2, 4, 
NÚe
), 2, 2, 
çl£
),

1517 
j
, (
m
, 
w_šdex
, 
w_comm™
, 
w_»jeù
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

1518 
Ët
 
¡Üe
 = 
	`Ãw_¡Üage
();

1519 
¡Üe


1520 .
	`wl
()

1521 .
	`­³nd
(&[
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)])

1522 .
	`ex³ù
("");

1523 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1], 10, 1, 
¡Üe
);

1524 
sm
.
	`become_fŞlow”
(2, 
INVALID_ID
);

1526 
sm
.
	`hªdË_­³nd_’Œ›s
(
m
);

1527 
sm
.
¿á_log
.
	`Ï¡_šdex
(è!ğ
w_šdex
 {

1528 
·nic
!(

1530 
j
,

1531 
sm
.
¿á_log
.
	`Ï¡_šdex
(),

1532 
w_šdex


1535 
sm
.
¿á_log
.
comm™‹d
 !ğ
w_comm™
 {

1536 
·nic
!(

1538 
j
,

1539 
sm
.
¿á_log
.
comm™‹d
,

1540 
w_comm™


1543 
Ët
 
m
 = 
sm
.
	`»ad_mes§ges
();

1544 
m
.
	`Ën
() != 1 {

1545 
·nic
!("#{}: msg couÁ = {}, wªˆ1", 
j
, 
m
.
	`Ën
());

1547 
m
[0].
	`g‘_»jeù
(è!ğ
w_»jeù
 {

1548 
·nic
!("#{}:„ejeù = {}, wªˆ{}", 
j
, 
m
[0].
	`g‘_»jeù
(), 
w_»jeù
);

1551 
	}
}

1554 #[
‹¡
]

1555 
â
 
	$‹¡_hªdË_h—¹b—t
() {

1556 
Ët
 
comm™
 = 2u64;

1557 
Ët
 
nw
 = |
f
, 
to
, 
‹rm
, 
comm™
| {

1558 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(
f
, 
to
, 
Mes§geTy³
::
MsgH—¹b—t
, 0);

1559 
m
.
	`£t_‹rm
(
‹rm
);

1560 
m
.
	`£t_comm™
(
comm™
);

1561 
m


1563 
Ët
 
mut
 
‹¡s
 = 
vec
![

1564 (
	`nw
(2, 1, 2, 
comm™
 + 1), commit + 1),

1565 (
	`nw
(2, 1, 2, 
comm™
 - 1), commit),

1567 
i
, (
m
, 
w_comm™
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

1568 
Ët
 
¡Üe
 = 
	`Ãw_¡Üage
();

1569 
¡Üe


1570 .
	`wl
()

1571 .
	`­³nd
(&[
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2),ƒmpty_entry(3, 3)])

1572 .
	`ex³ù
("");

1573 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 5, 1, 
¡Üe
);

1574 
sm
.
	`become_fŞlow”
(2, 2);

1575 
sm
.
¿á_log
.
	`comm™_to
(
comm™
);

1576 
sm
.
	`hªdË_h—¹b—t
(
m
);

1577 
sm
.
¿á_log
.
comm™‹d
 !ğ
w_comm™
 {

1578 
·nic
!(

1580 
i
,

1581 
sm
.
¿á_log
.
comm™‹d
,

1582 
w_comm™


1585 
Ët
 
m
 = 
sm
.
	`»ad_mes§ges
();

1586 
m
.
	`Ën
() != 1 {

1587 
·nic
!("#{}: msg couÁ = {}, wªˆ1", 
i
, 
m
.
	`Ën
());

1589 
m
[0].
	`g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
 {

1590 
·nic
!(

1592 
i
,

1593 
m
[0].
	`g‘_msg_ty³
()

1597 
	}
}

1600 #[
‹¡
]

1601 
â
 
	$‹¡_hªdË_h—¹b—t_»¥
() {

1602 
Ët
 
¡Üe
 = 
	`Ãw_¡Üage
();

1603 
¡Üe


1604 .
	`wl
()

1605 .
	`­³nd
(&[
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2),ƒmpty_entry(3, 3)])

1606 .
	`ex³ù
("");

1607 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 5, 1, 
¡Üe
);

1608 
sm
.
	`become_ÿndid©e
();

1609 
sm
.
	`become_Ëad”
();

1610 
Ët
 
Ï¡_šdex
 = 
sm
.
¿á_log
.
	`Ï¡_šdex
();

1611 
sm
.
¿á_log
.
	`comm™_to
(
Ï¡_šdex
);

1614 
sm
.
	`¡•
(
	`Ãw_mes§ge
(2, 0, 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 0))

1615 .
	`ex³ù
("");

1616 
Ët
 
mut
 
msgs
 = 
sm
.
	`»ad_mes§ges
();

1617 
as£¹_eq
!(
msgs
.
	`Ën
(), 1);

1618 
as£¹_eq
!(
msgs
[0].
	`g‘_msg_ty³
(), 
Mes§geTy³
::
MsgAµ’d
);

1621 
sm
.
	`¡•
(
	`Ãw_mes§ge
(2, 0, 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 0))

1622 .
	`ex³ù
("");

1623 
msgs
 = 
sm
.
	`»ad_mes§ges
();

1624 
as£¹_eq
!(
msgs
.
	`Ën
(), 1);

1625 
as£¹_eq
!(
msgs
[0].
	`g‘_msg_ty³
(), 
Mes§geTy³
::
MsgAµ’d
);

1628 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 0, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

1629 
m
.
	`£t_šdex
(
msgs
[0].
	`g‘_šdex
(è+ msgs[0].
	`g‘_’Œ›s
().
	`Ën
(è
as
 
u64
);

1630 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

1632 
sm
.
	`»ad_mes§ges
();

1634 
sm
.
	`¡•
(
	`Ãw_mes§ge
(2, 0, 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 0))

1635 .
	`ex³ù
("");

1636 
msgs
 = 
sm
.
	`»ad_mes§ges
();

1637 
as£¹
!(
msgs
.
	`is_em±y
());

1638 
	}
}

1643 #[
‹¡
]

1644 
â
 
	$‹¡_¿á_ä“s_»ad_Úly_mem
() {

1645 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 5, 1, 
	`Ãw_¡Üage
());

1646 
sm
.
	`become_ÿndid©e
();

1647 
sm
.
	`become_Ëad”
();

1648 
Ët
 
Ï¡_šdex
 = 
sm
.
¿á_log
.
	`Ï¡_šdex
();

1649 
sm
.
¿á_log
.
	`comm™_to
(
Ï¡_šdex
);

1651 
Ët
 
ùx
 = "ctx";

1652 
Ët
 
vec_ùx
 = 
ùx
.
	`as_by‹s
().
	`to_vec
();

1656 
Ët
 
m
 = 
	`Ãw_mes§ge_w™h_’Œ›s
(

1659 
Mes§geTy³
::
MsgR—dIndex
,

1660 
vec
![
	`Ãw_’Œy
(0, 0, 
	`Some
(
ùx
))],

1662 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

1663 
Ët
 
msgs
 = 
sm
.
	`»ad_mes§ges
();

1664 
as£¹_eq
!(
msgs
.
	`Ën
(), 1);

1665 
as£¹_eq
!(
msgs
[0].
	`g‘_msg_ty³
(), 
Mes§geTy³
::
MsgH—¹b—t
);

1666 
as£¹_eq
!(
msgs
[0].
	`g‘_cÚ‹xt
(), &
vec_ùx
[..]);

1667 
as£¹_eq
!(
sm
.
»ad_Úly
.
»ad_šdex_queue
.
	`Ën
(), 1);

1668 
as£¹_eq
!(
sm
.
»ad_Úly
.
³ndšg_»ad_šdex
.
	`Ën
(), 1);

1669 
as£¹
!(
sm
.
»ad_Úly
.
³ndšg_»ad_šdex
.
	`cÚšs_key
(&
vec_ùx
));

1674 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 0);

1675 
m
.
	`£t_cÚ‹xt
(
vec_ùx
.
	`şÚe
());

1676 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

1677 
as£¹_eq
!(
sm
.
»ad_Úly
.
»ad_šdex_queue
.
	`Ën
(), 0);

1678 
as£¹_eq
!(
sm
.
»ad_Úly
.
³ndšg_»ad_šdex
.
	`Ën
(), 0);

1679 
as£¹
!(!
sm
.
»ad_Úly
.
³ndšg_»ad_šdex
.
	`cÚšs_key
(&
vec_ùx
));

1680 
	}
}

1684 #[
‹¡
]

1685 
â
 
	$‹¡_msg_­³nd_»¥Ú£_wa™_»£t
() {

1686 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 5, 1, 
	`Ãw_¡Üage
());

1687 
sm
.
	`become_ÿndid©e
();

1688 
sm
.
	`become_Ëad”
();

1692 
sm
.
	`bÿ¡_­³nd
();

1693 
sm
.
	`»ad_mes§ges
();

1696 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 0, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

1697 
m
.
	`£t_šdex
(1);

1698 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

1699 
as£¹_eq
!(
sm
.
¿á_log
.
comm™‹d
, 1);

1701 
sm
.
	`»ad_mes§ges
();

1704 
m
 = 
	`Ãw_mes§ge
(1, 0, 
Mes§geTy³
::
MsgPrİo£
, 0);

1705 
m
.
	`£t_’Œ›s
(
R•—‹dF›ld
::
	`äom_vec
(
vec
![
	`em±y_’Œy
(0, 0)]));

1706 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

1710 
Ët
 
mut
 
msgs
 = 
sm
.
	`»ad_mes§ges
();

1711 
as£¹_eq
!(
msgs
.
	`Ën
(), 1);

1712 
as£¹_eq
!(
msgs
[0].
	`g‘_msg_ty³
(), 
Mes§geTy³
::
MsgAµ’d
);

1713 
as£¹_eq
!(
msgs
[0].
	`g‘_to
(), 2);

1714 
as£¹_eq
!(
msgs
[0].
	`g‘_’Œ›s
().
	`Ën
(), 1);

1715 
as£¹_eq
!(
msgs
[0].
	`g‘_’Œ›s
()[0].
	`g‘_šdex
(), 2);

1718 
m
 = 
	`Ãw_mes§ge
(3, 0, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

1719 
m
.
	`£t_šdex
(1);

1720 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

1721 
msgs
 = 
sm
.
	`»ad_mes§ges
();

1722 
as£¹_eq
!(
msgs
.
	`Ën
(), 1);

1723 
as£¹_eq
!(
msgs
[0].
	`g‘_msg_ty³
(), 
Mes§geTy³
::
MsgAµ’d
);

1724 
as£¹_eq
!(
msgs
[0].
	`g‘_to
(), 3);

1725 
as£¹_eq
!(
msgs
[0].
	`g‘_’Œ›s
().
	`Ën
(), 1);

1726 
as£¹_eq
!(
msgs
[0].
	`g‘_’Œ›s
()[0].
	`g‘_šdex
(), 2);

1727 
	}
}

1729 #[
‹¡
]

1730 
â
 
	$‹¡_»cv_msg_»que¡_vÙe
() {

1731 
	`‹¡_»cv_msg_»que¡_vÙe_fÜ_ty³
(
Mes§geTy³
::
MsgReque¡VÙe
);

1732 
	}
}

1734 
â
 
	$‹¡_»cv_msg_»que¡_vÙe_fÜ_ty³
(
msg_ty³
: 
Mes§geTy³
) {

1735 
Ët
 
mut
 
‹¡s
 = 
vec
![

1736 (
S‹RŞe
::
FŞlow”
, 0, 0, 
INVALID_ID
, 
Œue
),

1737 (
S‹RŞe
::
FŞlow”
, 0, 1, 
INVALID_ID
, 
Œue
),

1738 (
S‹RŞe
::
FŞlow”
, 0, 2, 
INVALID_ID
, 
Œue
),

1739 (
S‹RŞe
::
FŞlow”
, 0, 3, 
INVALID_ID
, 
çl£
),

1741 (
S‹RŞe
::
FŞlow”
, 1, 0, 
INVALID_ID
, 
Œue
),

1742 (
S‹RŞe
::
FŞlow”
, 1, 1, 
INVALID_ID
, 
Œue
),

1743 (
S‹RŞe
::
FŞlow”
, 1, 2, 
INVALID_ID
, 
Œue
),

1744 (
S‹RŞe
::
FŞlow”
, 1, 3, 
INVALID_ID
, 
çl£
),

1746 (
S‹RŞe
::
FŞlow”
, 2, 0, 
INVALID_ID
, 
Œue
),

1747 (
S‹RŞe
::
FŞlow”
, 2, 1, 
INVALID_ID
, 
Œue
),

1748 (
S‹RŞe
::
FŞlow”
, 2, 2, 
INVALID_ID
, 
çl£
),

1749 (
S‹RŞe
::
FŞlow”
, 2, 3, 
INVALID_ID
, 
çl£
),

1751 (
S‹RŞe
::
FŞlow”
, 3, 0, 
INVALID_ID
, 
Œue
),

1752 (
S‹RŞe
::
FŞlow”
, 3, 1, 
INVALID_ID
, 
Œue
),

1753 (
S‹RŞe
::
FŞlow”
, 3, 2, 
INVALID_ID
, 
çl£
),

1754 (
S‹RŞe
::
FŞlow”
, 3, 3, 
INVALID_ID
, 
çl£
),

1756 (
S‹RŞe
::
FŞlow”
, 3, 2, 2, 
çl£
),

1757 (
S‹RŞe
::
FŞlow”
, 3, 2, 1, 
Œue
),

1759 (
S‹RŞe
::
L—d”
, 3, 3, 1, 
Œue
),

1760 (
S‹RŞe
::
P»Cªdid©e
, 3, 3, 1, 
Œue
),

1761 (
S‹RŞe
::
Cªdid©e
, 3, 3, 1, 
Œue
),

1764 
j
, (
¡©e
, 
i
, 
‹rm
, 
vÙe_fÜ
, 
w_»jeù
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

1765 
Ët
 
¿á_log
 = 
	`Ãw_¿á_log
(

1766 
vec
![
	`em±y_’Œy
(0, 0),ƒmpty_entry(2, 1),ƒmpty_entry(2, 2)],

1770 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1], 10, 1, 
	`Ãw_¡Üage
());

1771 
sm
.
¡©e
 = state;

1772 
sm
.
vÙe
 = 
vÙe_fÜ
;

1773 
sm
.
¿á_log
 =„aft_log;

1774 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 0, 
msg_ty³
, 0);

1775 
m
.
	`£t_šdex
(
i
);

1776 
m
.
	`£t_log_‹rm
(
‹rm
);

1777 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

1779 
Ët
 
msgs
 = 
sm
.
	`»ad_mes§ges
();

1780 
msgs
.
	`Ën
() != 1 {

1781 
·nic
!("#{}: msg couÁ = {}, wªˆ1", 
j
, 
msgs
.
	`Ën
());

1783 
msgs
[0].
	`g‘_msg_ty³
(è!ğ
	`vÙe_»¥_msg_ty³
(
msg_ty³
) {

1784 
·nic
!(

1786 
i
,

1787 
msgs
[0].
	`g‘_msg_ty³
(),

1788 
	`vÙe_»¥_msg_ty³
(
msg_ty³
)

1791 
msgs
[0].
	`g‘_»jeù
(è!ğ
w_»jeù
 {

1792 
·nic
!(

1794 
j
,

1795 
msgs
[0].
	`g‘_»jeù
(),

1796 
w_»jeù


1800 
	}
}

1802 #[
‹¡
]

1803 
â
 
	$‹¡_¡©e_Œªs™iÚ
() {

1804 
Ët
 
mut
 
‹¡s
 = 
vec
![

1806 
S‹RŞe
::
FŞlow”
,

1807 
S‹RŞe
::
FŞlow”
,

1808 
Œue
,

1810 
INVALID_ID
,

1813 
S‹RŞe
::
FŞlow”
,

1814 
S‹RŞe
::
P»Cªdid©e
,

1815 
Œue
,

1817 
INVALID_ID
,

1820 
S‹RŞe
::
FŞlow”
,

1821 
S‹RŞe
::
Cªdid©e
,

1822 
Œue
,

1824 
INVALID_ID
,

1826 (
S‹RŞe
::
FŞlow”
, S‹RŞe::
L—d”
, 
çl£
, 0, 
INVALID_ID
),

1829 
S‹RŞe
::
P»Cªdid©e
,

1830 
S‹RŞe
::
FŞlow”
,

1831 
Œue
,

1833 
INVALID_ID
,

1836 
S‹RŞe
::
P»Cªdid©e
,

1837 
S‹RŞe
::
P»Cªdid©e
,

1838 
Œue
,

1840 
INVALID_ID
,

1843 
S‹RŞe
::
P»Cªdid©e
,

1844 
S‹RŞe
::
Cªdid©e
,

1845 
Œue
,

1847 
INVALID_ID
,

1849 (
S‹RŞe
::
P»Cªdid©e
, S‹RŞe::
L—d”
, 
Œue
, 0, 1),

1852 
S‹RŞe
::
Cªdid©e
,

1853 
S‹RŞe
::
FŞlow”
,

1854 
Œue
,

1856 
INVALID_ID
,

1859 
S‹RŞe
::
Cªdid©e
,

1860 
S‹RŞe
::
P»Cªdid©e
,

1861 
Œue
,

1863 
INVALID_ID
,

1866 
S‹RŞe
::
Cªdid©e
,

1867 
S‹RŞe
::
Cªdid©e
,

1868 
Œue
,

1870 
INVALID_ID
,

1872 (
S‹RŞe
::
Cªdid©e
, S‹RŞe::
L—d”
, 
Œue
, 0, 1),

1874 (
S‹RŞe
::
L—d”
, S‹RŞe::
FŞlow”
, 
Œue
, 1, 
INVALID_ID
),

1876 
S‹RŞe
::
L—d”
,

1877 
S‹RŞe
::
P»Cªdid©e
,

1878 
çl£
,

1880 
INVALID_ID
,

1883 
S‹RŞe
::
L—d”
,

1884 
S‹RŞe
::
Cªdid©e
,

1885 
çl£
,

1887 
INVALID_ID
,

1889 (
S‹RŞe
::
L—d”
, S‹RŞe::L—d”, 
Œue
, 0, 1),

1891 
i
, (
äom
, 
to
, 
w®low
, 
w‹rm
, 
wËad
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

1892 
Ët
 
sm
: &
mut
 
Raá
<
MemStÜage
> = &muˆ
	`Ãw_‹¡_¿á
(1, 
vec
![1], 10, 1, 
	`Ãw_¡Üage
());

1893 
sm
.
¡©e
 = 
äom
;

1895 
Ët
 
»s
 = 
»cov”_§ã
!(|| {

1896 
m©ch
 
to
 {

1897 
S‹RŞe
::
FŞlow”
 => 
sm
.
	`become_fŞlow”
(
w‹rm
, 
wËad
),

1898 
S‹RŞe
::
P»Cªdid©e
 => 
sm
.
	`become_´e_ÿndid©e
(),

1899 
S‹RŞe
::
Cªdid©e
 => 
sm
.
	`become_ÿndid©e
(),

1900 
S‹RŞe
::
L—d”
 => 
sm
.
	`become_Ëad”
(),

1903 
»s
.
	`is_ok
(è^ 
w®low
 {

1904 
·nic
!("#{}:‡Îow = {}, wªˆ{}", 
i
, 
»s
.
	`is_ok
(), 
w®low
);

1906 
»s
.
	`is_”r
() {

1910 
sm
.
‹rm
 !ğ
w‹rm
 {

1911 
·nic
!("#{}:”m = {}, wªˆ{}", 
i
, 
sm
.
‹rm
, 
w‹rm
);

1913 
sm
.
Ëad”_id
 !ğ
wËad
 {

1914 
·nic
!("#{}:†—d = {}, wªˆ{}", 
i
, 
sm
.
Ëad”_id
, 
wËad
);

1917 
	}
}

1919 #[
‹¡
]

1920 
â
 
	$‹¡_®l_£rv”_¡•down
() {

1921 
Ët
 
mut
 
‹¡s
 = 
vec
![

1922 (
S‹RŞe
::
FŞlow”
, StateRole::Follower, 3, 0),

1923 (
S‹RŞe
::
P»Cªdid©e
, S‹RŞe::
FŞlow”
, 3, 0),

1924 (
S‹RŞe
::
Cªdid©e
, S‹RŞe::
FŞlow”
, 3, 0),

1925 (
S‹RŞe
::
L—d”
, S‹RŞe::
FŞlow”
, 3, 1),

1928 
Ët
 
tmsg_ty³s
 = 
vec
![
Mes§geTy³
::
MsgReque¡VÙe
, Mes§geTy³::
MsgAµ’d
];

1929 
Ët
 
‰”m
 = 3u64;

1931 
i
, (
¡©e
, 
w¡©e
, 
w‹rm
, 
wšdex
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

1932 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

1933 
m©ch
 
¡©e
 {

1934 
S‹RŞe
::
FŞlow”
 => 
sm
.
	`become_fŞlow”
(1, 
INVALID_ID
),

1935 
S‹RŞe
::
P»Cªdid©e
 => 
sm
.
	`become_´e_ÿndid©e
(),

1936 
S‹RŞe
::
Cªdid©e
 => 
sm
.
	`become_ÿndid©e
(),

1937 
S‹RŞe
::
L—d”
 => {

1938 
sm
.
	`become_ÿndid©e
();

1939 
sm
.
	`become_Ëad”
();

1943 
j
, &
msg_ty³
è
š
 
tmsg_ty³s
.
	`™”
().
	`’um”©e
() {

1944 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 0, 
msg_ty³
, 0);

1945 
m
.
	`£t_‹rm
(
‰”m
);

1946 
m
.
	`£t_log_‹rm
(
‰”m
);

1947 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

1949 
sm
.
¡©e
 !ğ
w¡©e
 {

1950 
·nic
!("{}.{} s‹ = {:?}, wªˆ{:?}", 
i
, 
j
, 
sm
.
¡©e
, 
w¡©e
);

1952 
sm
.
‹rm
 !ğ
w‹rm
 {

1953 
·nic
!("{}.{}”m = {}, wªˆ{}", 
i
, 
j
, 
sm
.
‹rm
, 
w‹rm
);

1955 
sm
.
¿á_log
.
	`Ï¡_šdex
(è!ğ
wšdex
 {

1956 
·nic
!(

1958 
i
,

1959 
j
,

1960 
sm
.
¿á_log
.
	`Ï¡_šdex
(),

1961 
wšdex


1964 
Ët
 
’Œy_couÁ
 = 
sm
.
¿á_log
.
	`®l_’Œ›s
().
	`Ën
(è
as
 
u64
;

1965 
’Œy_couÁ
 !ğ
wšdex
 {

1966 
·nic
!("{}.{}ƒÁ couÁ = {}, wªˆ{}", 
i
, 
j
, 
’Œy_couÁ
, 
wšdex
);

1968 
Ët
 
wËad
 = 
msg_ty³
 =ğ
Mes§geTy³
::
MsgReque¡VÙe
 {

1969 
INVALID_ID


1973 
sm
.
Ëad”_id
 !ğ
wËad
 {

1974 
·nic
!("{}, sm.Ëad = {}, wªˆ{}", 
i
, 
sm
.
Ëad”_id
, 
INVALID_ID
);

1978 
	}
}

1980 #[
‹¡
]

1981 
â
 
	$‹¡_Ëad”_¡•down_wh’_quÜum_aùive
() {

1982 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 5, 1, 
	`Ãw_¡Üage
());

1983 
sm
.
check_quÜum
 = 
Œue
;

1984 
sm
.
	`become_ÿndid©e
();

1985 
sm
.
	`become_Ëad”
();

1987 
_
 
š
 0..(
sm
.
	`g‘_–eùiÚ_timeout
() + 1) {

1988 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 0, 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 0);

1989 
m
.
	`£t_‹rm
(
sm
.
‹rm
);

1990 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

1991 
sm
.
	`tick
();

1994 
as£¹_eq
!(
sm
.
¡©e
, 
S‹RŞe
::
L—d”
);

1995 
	}
}

1997 #[
‹¡
]

1998 
â
 
	$‹¡_Ëad”_¡•down_wh’_quÜum_lo¡
() {

1999 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 5, 1, 
	`Ãw_¡Üage
());

2001 
sm
.
check_quÜum
 = 
Œue
;

2003 
sm
.
	`become_ÿndid©e
();

2004 
sm
.
	`become_Ëad”
();

2006 
_
 
š
 0..(
sm
.
	`g‘_–eùiÚ_timeout
() + 1) {

2007 
sm
.
	`tick
();

2010 
as£¹_eq
!(
sm
.
¡©e
, 
S‹RŞe
::
FŞlow”
);

2011 
	}
}

2013 #[
‹¡
]

2014 
â
 
	$‹¡_Ëad”_su³r£dšg_w™h_check_quÜum
() {

2015 
Ët
 
mut
 
a
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2016 
Ët
 
mut
 
b
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2017 
Ët
 
mut
 
c
 = 
	`Ãw_‹¡_¿á
(3, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2019 
a
.
check_quÜum
 = 
Œue
;

2020 
b
.
check_quÜum
 = 
Œue
;

2021 
c
.
check_quÜum
 = 
Œue
;

2023 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
a
), Some(
b
), Some(
c
)]);

2025 
Ët
 
b_–eùiÚ_timeout
 = 
Á
.
³”s
[&2].
	`g‘_–eùiÚ_timeout
();

2028 
Á
.
³”s


2029 .
	`g‘_mut
(&2)

2030 .
	`unw¿p
()

2031 .
	`£t_¿ndomized_–eùiÚ_timeout
(
b_–eùiÚ_timeout
 + 1);

2032 
_
 
š
 0..b
_–eùiÚ_timeout
 {

2033 
Á
.
³”s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`tick
();

2035 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

2037 
as£¹_eq
!(
Á
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

2038 
as£¹_eq
!(
Á
.
³”s
[&3].
¡©e
, 
S‹RŞe
::
FŞlow”
);

2040 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

2043 
as£¹_eq
!(
Á
.
³”s
[&3].
¡©e
, 
S‹RŞe
::
Cªdid©e
);

2046 
_
 
š
 0..b
_–eùiÚ_timeout
 {

2047 
Á
.
³”s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`tick
();

2049 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

2050 
as£¹_eq
!(
Á
.
³”s
[&3].
¡©e
, 
S‹RŞe
::
L—d”
);

2051 
	}
}

2053 #[
‹¡
]

2054 
â
 
	$‹¡_Ëad”_–eùiÚ_w™h_check_quÜum
() {

2055 
Ët
 
mut
 
a
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2056 
Ët
 
mut
 
b
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2057 
Ët
 
mut
 
c
 = 
	`Ãw_‹¡_¿á
(3, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2059 
a
.
check_quÜum
 = 
Œue
;

2060 
b
.
check_quÜum
 = 
Œue
;

2061 
c
.
check_quÜum
 = 
Œue
;

2063 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
a
), Some(
b
), Some(
c
)]);

2068 
Ët
 
a_–eùiÚ_timeout
 = 
Á
.
³”s
[&1].
	`g‘_–eùiÚ_timeout
();

2069 
Ët
 
b_–eùiÚ_timeout
 = 
Á
.
³”s
[&2].
	`g‘_–eùiÚ_timeout
();

2070 
Á
.
³”s


2071 .
	`g‘_mut
(&1)

2072 .
	`unw¿p
()

2073 .
	`£t_¿ndomized_–eùiÚ_timeout
(
a_–eùiÚ_timeout
 + 1);

2074 
Á
.
³”s


2075 .
	`g‘_mut
(&2)

2076 .
	`unw¿p
()

2077 .
	`£t_¿ndomized_–eùiÚ_timeout
(
b_–eùiÚ_timeout
 + 2);

2081 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

2083 
as£¹_eq
!(
Á
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

2084 
as£¹_eq
!(
Á
.
³”s
[&3].
¡©e
, 
S‹RŞe
::
FŞlow”
);

2088 
Ët
 
a_–eùiÚ_timeout
 = 
Á
.
³”s
[&1].
	`g‘_–eùiÚ_timeout
();

2089 
Ët
 
b_–eùiÚ_timeout
 = 
Á
.
³”s
[&2].
	`g‘_–eùiÚ_timeout
();

2090 
Á
.
³”s


2091 .
	`g‘_mut
(&1)

2092 .
	`unw¿p
()

2093 .
	`£t_¿ndomized_–eùiÚ_timeout
(
a_–eùiÚ_timeout
 + 1);

2094 
Á
.
³”s


2095 .
	`g‘_mut
(&2)

2096 .
	`unw¿p
()

2097 .
	`£t_¿ndomized_–eùiÚ_timeout
(
b_–eùiÚ_timeout
 + 2);

2099 
_
 
š
 0..a
_–eùiÚ_timeout
 {

2100 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
().
	`tick
();

2102 
_
 
š
 0..b
_–eùiÚ_timeout
 {

2103 
Á
.
³”s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`tick
();

2105 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

2107 
as£¹_eq
!(
Á
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
FŞlow”
);

2108 
as£¹_eq
!(
Á
.
³”s
[&3].
¡©e
, 
S‹RŞe
::
L—d”
);

2109 
	}
}

2114 #[
‹¡
]

2115 
â
 
	$‹¡_ä“_¡uck_ÿndid©e_w™h_check_quÜum
() {

2116 
Ët
 
mut
 
a
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2117 
Ët
 
mut
 
b
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2118 
Ët
 
mut
 
c
 = 
	`Ãw_‹¡_¿á
(3, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2120 
a
.
check_quÜum
 = 
Œue
;

2121 
b
.
check_quÜum
 = 
Œue
;

2122 
c
.
check_quÜum
 = 
Œue
;

2124 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
a
), Some(
b
), Some(
c
)]);

2129 
Ët
 
b_–eùiÚ_timeout
 = 
Á
.
³”s
[&2].
	`g‘_–eùiÚ_timeout
();

2130 
Á
.
³”s


2131 .
	`g‘_mut
(&2)

2132 .
	`unw¿p
()

2133 .
	`£t_¿ndomized_–eùiÚ_timeout
(
b_–eùiÚ_timeout
 + 1);

2135 
_
 
š
 0..b
_–eùiÚ_timeout
 {

2136 
Á
.
³”s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`tick
();

2138 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

2139 
Á
.
	`isŞ©e
(1);

2140 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

2142 
as£¹_eq
!(
Á
.
³”s
[&2].
¡©e
, 
S‹RŞe
::
FŞlow”
);

2143 
as£¹_eq
!(
Á
.
³”s
[&3].
¡©e
, 
S‹RŞe
::
Cªdid©e
);

2144 
as£¹_eq
!(
Á
.
³”s
[&3].
‹rm
, &nt.peers[&2].term + 1);

2147 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

2149 
as£¹_eq
!(
Á
.
³”s
[&2].
¡©e
, 
S‹RŞe
::
FŞlow”
);

2150 
as£¹_eq
!(
Á
.
³”s
[&3].
¡©e
, 
S‹RŞe
::
Cªdid©e
);

2151 
as£¹_eq
!(
Á
.
³”s
[&3].
‹rm
, &nt.peers[&2].term + 2);

2153 
Á
.
	`»cov”
();

2154 
Ët
 
mut
 
msg
 = 
	`Ãw_mes§ge
(1, 3, 
Mes§geTy³
::
MsgH—¹b—t
, 0);

2155 
msg
.
	`£t_‹rm
(
Á
.
³”s
[&1].
‹rm
);

2156 
Á
.
	`£nd
(
vec
![
msg
]);

2159 
as£¹_eq
!(
Á
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
FŞlow”
);

2160 
as£¹_eq
!(
Á
.
³”s
[&3].
‹rm
,‚t.peers[&1].term);

2163 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

2164 
as£¹_eq
!(
Á
.
³”s
[&3].
¡©e
, 
S‹RŞe
::
L—d”
);

2165 
	}
}

2167 #[
‹¡
]

2168 
â
 
	$‹¡_nÚ_´omÙabË_vÙ”_which_check_quÜum
() {

2169 
Ët
 
mut
 
a
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2170 
Ët
 
mut
 
b
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1], 10, 1, 
	`Ãw_¡Üage
());

2172 
a
.
check_quÜum
 = 
Œue
;

2173 
b
.
check_quÜum
 = 
Œue
;

2175 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
a
), Some(
b
)]);

2180 
Ët
 
b_–eùiÚ_timeout
 = 
Á
.
³”s
[&2].
	`g‘_–eùiÚ_timeout
();

2181 
Á
.
³”s


2182 .
	`g‘_mut
(&2)

2183 .
	`unw¿p
()

2184 .
	`£t_¿ndomized_–eùiÚ_timeout
(
b_–eùiÚ_timeout
 + 1);

2188 
Á
.
³”s
.
	`g‘_mut
(&2).
	`unw¿p
().
´s
.
	`»move
(&2).unwrap();

2190 
as£¹_eq
!(
Á
.
³”s
[&2].
	`´omÙabË
(), 
çl£
);

2192 
_
 
š
 0..b
_–eùiÚ_timeout
 {

2193 
Á
.
³”s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`tick
();

2195 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

2197 
as£¹_eq
!(
Á
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

2198 
as£¹_eq
!(
Á
.
³”s
[&2].
¡©e
, 
S‹RŞe
::
FŞlow”
);

2199 
as£¹_eq
!(
Á
.
³”s
[&2].
Ëad”_id
, 1);

2200 
	}
}

2202 #[
‹¡
]

2203 
â
 
	$‹¡_»ad_Úly_İtiÚ_§ã
() {

2204 
Ët
 
a
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2205 
Ët
 
b
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2206 
Ët
 
c
 = 
	`Ãw_‹¡_¿á
(3, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2208 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
a
), Some(
b
), Some(
c
)]);

2213 
Ët
 
b_–eùiÚ_timeout
 = 
Á
.
³”s
[&2].
	`g‘_–eùiÚ_timeout
();

2214 
Á
.
³”s


2215 .
	`g‘_mut
(&2)

2216 .
	`unw¿p
()

2217 .
	`£t_¿ndomized_–eùiÚ_timeout
(
b_–eùiÚ_timeout
 + 1);

2219 
_
 
š
 0..b
_–eùiÚ_timeout
 {

2220 
Á
.
³”s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`tick
();

2222 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

2224 
as£¹_eq
!(
Á
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

2226 
Ët
 
mut
 
‹¡s
 = 
vec
![

2235 
i
, (
id
, 
´İo§ls
, 
wri
, 
wùx
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

2236 
_
 
š
 0..
´İo§ls
 {

2237 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

2240 
Ët
 
e
 = 
	`Ãw_’Œy
(0, 0, 
	`Some
(
wùx
));

2241 
Á
.
	`£nd
(
vec
![

2242 
	`Ãw_mes§ge_w™h_’Œ›s
(
id
, id, 
Mes§geTy³
::
MsgR—dIndex
, 
vec
![
e
]),

2245 
Ët
 
»ad_¡©es
: 
Vec
<
R—dS‹
> = 
Á
.
³”s


2246 .
	`g‘_mut
(&
id
)

2247 .
	`unw¿p
()

2248 .
»ad_¡©es


2249 .
	`d¿š
(..)

2250 .
	`cŞËù
();

2251 
»ad_¡©es
.
	`is_em±y
() {

2252 
·nic
!("#{}:„—d_¡©e i em±y, wªˆnÚ-em±y", 
i
);

2254 
Ët
 
rs
 = &
»ad_¡©es
[0];

2255 
rs
.
šdex
 !ğ
wri
 {

2256 
·nic
!("#{}:„—d_šdex = {}, wªˆ{}", 
i
, 
rs
.
šdex
, 
wri
)

2258 
Ët
 
vec_wùx
 = 
wùx
.
	`as_by‹s
().
	`to_vec
();

2259 
rs
.
»que¡_ùx
 !ğ
vec_wùx
 {

2260 
·nic
!(

2262 
i
,

2263 
rs
.
»que¡_ùx
,

2264 
vec_wùx


2268 
	}
}

2270 #[
‹¡
]

2271 
â
 
	$‹¡_»ad_Úly_İtiÚ_Ëa£
() {

2272 
Ët
 
mut
 
a
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2273 
Ët
 
mut
 
b
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2274 
Ët
 
mut
 
c
 = 
	`Ãw_‹¡_¿á
(3, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2275 
a
.
»ad_Úly
.
İtiÚ
 = 
R—dOÆyO±iÚ
::
L—£Ba£d
;

2276 
b
.
»ad_Úly
.
İtiÚ
 = 
R—dOÆyO±iÚ
::
L—£Ba£d
;

2277 
c
.
»ad_Úly
.
İtiÚ
 = 
R—dOÆyO±iÚ
::
L—£Ba£d
;

2278 
a
.
check_quÜum
 = 
Œue
;

2279 
b
.
check_quÜum
 = 
Œue
;

2280 
c
.
check_quÜum
 = 
Œue
;

2282 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
a
), Some(
b
), Some(
c
)]);

2287 
Ët
 
b_–eùiÚ_timeout
 = 
Á
.
³”s
[&2].
	`g‘_–eùiÚ_timeout
();

2288 
Á
.
³”s


2289 .
	`g‘_mut
(&2)

2290 .
	`unw¿p
()

2291 .
	`£t_¿ndomized_–eùiÚ_timeout
(
b_–eùiÚ_timeout
 + 1);

2293 
_
 
š
 0..b
_–eùiÚ_timeout
 {

2294 
Á
.
³”s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`tick
();

2296 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

2298 
as£¹_eq
!(
Á
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

2300 
Ët
 
mut
 
‹¡s
 = 
vec
![

2309 
i
, (
id
, 
´İo§ls
, 
wri
, 
wùx
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

2310 
_
 
š
 0..
´İo§ls
 {

2311 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

2314 
Ët
 
e
 = 
	`Ãw_’Œy
(0, 0, 
	`Some
(
wùx
));

2315 
Á
.
	`£nd
(
vec
![

2316 
	`Ãw_mes§ge_w™h_’Œ›s
(
id
, id, 
Mes§geTy³
::
MsgR—dIndex
, 
vec
![
e
]),

2319 
Ët
 
»ad_¡©es
: 
Vec
<
R—dS‹
> = 
Á
.
³”s


2320 .
	`g‘_mut
(&
id
)

2321 .
	`unw¿p
()

2322 .
»ad_¡©es


2323 .
	`d¿š
(..)

2324 .
	`cŞËù
();

2325 
»ad_¡©es
.
	`is_em±y
() {

2326 
·nic
!("#{}:„—d_¡©e i em±y, wªˆnÚ-em±y", 
i
);

2328 
Ët
 
rs
 = &
»ad_¡©es
[0];

2329 
rs
.
šdex
 !ğ
wri
 {

2330 
·nic
!("#{}:„—d_šdex = {}, wªˆ{}", 
i
, 
rs
.
šdex
, 
wri
);

2332 
Ët
 
vec_wùx
 = 
wùx
.
	`as_by‹s
().
	`to_vec
();

2333 
rs
.
»que¡_ùx
 !ğ
vec_wùx
 {

2334 
·nic
!(

2336 
i
,

2337 
rs
.
»que¡_ùx
,

2338 
vec_wùx


2342 
	}
}

2344 #[
‹¡
]

2345 
â
 
	$‹¡_»ad_Úly_İtiÚ_Ëa£_w™hout_check_quÜum
() {

2346 
Ët
 
mut
 
a
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2347 
Ët
 
mut
 
b
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2348 
Ët
 
mut
 
c
 = 
	`Ãw_‹¡_¿á
(3, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2349 
a
.
»ad_Úly
.
İtiÚ
 = 
R—dOÆyO±iÚ
::
L—£Ba£d
;

2350 
b
.
»ad_Úly
.
İtiÚ
 = 
R—dOÆyO±iÚ
::
L—£Ba£d
;

2351 
c
.
»ad_Úly
.
İtiÚ
 = 
R—dOÆyO±iÚ
::
L—£Ba£d
;

2353 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
a
), Some(
b
), Some(
c
)]);

2354 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

2356 
Ët
 
ùx
 = "ctx1";

2357 
Ët
 
e
 = 
	`Ãw_’Œy
(0, 0, 
	`Some
(
ùx
));

2358 
Á
.
	`£nd
(
vec
![

2359 
	`Ãw_mes§ge_w™h_’Œ›s
(2, 2, 
Mes§geTy³
::
MsgR—dIndex
, 
vec
![
e
]),

2362 
Ët
 
»ad_¡©es
 = &
Á
.
³”s
[&2].read_states;

2363 
as£¹
!(!
»ad_¡©es
.
	`is_em±y
());

2364 
Ët
 
rs
 = &
»ad_¡©es
[0];

2365 
as£¹_eq
!(
rs
.
šdex
, 
INVALID_ID
);

2366 
Ët
 
vec_ùx
 = 
ùx
.
	`as_by‹s
().
	`to_vec
();

2367 
as£¹_eq
!(
rs
.
»que¡_ùx
, 
vec_ùx
);

2368 
	}
}

2372 #[
‹¡
]

2373 
â
 
	$‹¡_»ad_Úly_fÜ_Ãw_Ëad”
() {

2374 
Ët
 
h—¹b—t_ticks
 = 1;

2375 
Ët
 
node_cÚfigs
 = 
vec
![(1, 1, 1, 0), (2, 2, 2, 2), (3, 2, 2, 2)];

2376 
Ët
 
mut
 
³”s
 = 
vec
![];

2377 
id
, 
comm™‹d
, 
­¶›d
, 
com·ù_šdex
è
š
 
node_cÚfigs
 {

2378 
Ët
 
mut
 
cfg
 = 
	`Ãw_‹¡_cÚfig
(
id
, 
vec
![1, 2, 3], 10, 
h—¹b—t_ticks
);

2379 
cfg
.
­¶›d
 =‡pplied;

2380 
Ët
 
¡Üage
 = 
	`Ãw_¡Üage
();

2381 
Ët
 
’Œ›s
 = 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(1, 2)];

2382 
¡Üage
.
	`wl
().
	`­³nd
(&
’Œ›s
).
	`unw¿p
();

2383 
Ët
 
mut
 
hs
 = 
H¬dS‹
::
	`Ãw
();

2384 
hs
.
	`£t_‹rm
(1);

2385 
hs
.
	`£t_comm™
(
comm™‹d
);

2386 
¡Üage
.
	`wl
().
	`£t_h¬d¡©e
(
hs
);

2387 
com·ù_šdex
 != 0 {

2388 
¡Üage
.
	`wl
().
	`com·ù
(
com·ù_šdex
).
	`unw¿p
();

2390 
Ët
 
i
 = 
IÁ”çû
::
	`Ãw
(
Raá
::Ãw(&
cfg
, 
¡Üage
));

2391 
³”s
.
	`push
(
	`Some
(
i
));

2393 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
³”s
);

2397 
Á
.
	`ignÜe
(
Mes§geTy³
::
MsgAµ’d
);

2399 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

2400 
as£¹_eq
!(
Á
.
³”s
[&1].
¡©e
, 
S‹RŞe
::
L—d”
);

2403 
Ët
 
wšdex
 = 4;

2404 
Ët
 
wùx
 = "ctx";

2405 
Á
.
	`£nd
(
vec
![

2406 
	`Ãw_mes§ge_w™h_’Œ›s
(

2409 
Mes§geTy³
::
MsgR—dIndex
,

2410 
vec
![
	`Ãw_’Œy
(0, 0, 
	`Some
(
wùx
))],

2413 
as£¹_eq
!(
Á
.
³”s
[&1].
»ad_¡©es
.
	`Ën
(), 0);

2415 
Á
.
	`»cov”
();

2418 
_
 
š
 0..
h—¹b—t_ticks
 {

2419 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
().
	`tick
();

2421 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

2422 
as£¹_eq
!(
Á
.
³”s
[&1].
¿á_log
.
comm™‹d
, 4);

2423 
as£¹_eq
!(

2424 
Á
.
³”s
[&1]

2425 .
¿á_log


2426 .
	`‹rm
(
Á
.
³”s
[&1].
¿á_log
.
comm™‹d
)

2427 .
	`unw¿p_Ü
(0),

2428 
Á
.
³”s
[&1].
‹rm


2432 
Á
.
	`£nd
(
vec
![

2433 
	`Ãw_mes§ge_w™h_’Œ›s
(

2436 
Mes§geTy³
::
MsgR—dIndex
,

2437 
vec
![
	`Ãw_’Œy
(0, 0, 
	`Some
(
wùx
))],

2440 
Ët
 
»ad_¡©es
: 
Vec
<
R—dS‹
> = 
Á
.
³”s


2441 .
	`g‘_mut
(&1)

2442 .
	`unw¿p
()

2443 .
»ad_¡©es


2444 .
	`d¿š
(..)

2445 .
	`cŞËù
();

2446 
as£¹_eq
!(
»ad_¡©es
.
	`Ën
(), 1);

2447 
Ët
 
rs
 = &
»ad_¡©es
[0];

2448 
as£¹_eq
!(
rs
.
šdex
, 
wšdex
);

2449 
as£¹_eq
!(
rs
.
»que¡_ùx
, 
wùx
.
	`as_by‹s
().
	`to_vec
());

2450 
	}
}

2452 #[
‹¡
]

2453 
â
 
	$‹¡_Ëad”_­³nd_»¥Ú£
() {

2455 
Ët
 
mut
 
‹¡s
 = 
vec
![

2456 (3, 
Œue
, 0, 3, 0, 0, 0),

2457 (2, 
Œue
, 0, 2, 1, 1, 0),

2459 (2, 
çl£
, 2, 4, 2, 2, 2),

2460 (0, 
çl£
, 0, 3, 0, 0, 0),

2463 
i
, (
šdex
, 
»jeù
, 
wm©ch
, 
wÃxt
, 
wmsg_num
, 
wšdex
, 
wcomm™‹d
)è
š


2464 
‹¡s
.
	`d¿š
(..).
	`’um”©e
()

2468 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2469 
sm
.
¿á_log
 = 
	`Ãw_¿á_log
(
vec
![
	`em±y_’Œy
(0, 1),ƒmpty_entry(1, 2)], 3, 0);

2470 
sm
.
	`become_ÿndid©e
();

2471 
sm
.
	`become_Ëad”
();

2472 
sm
.
	`»ad_mes§ges
();

2473 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 0, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

2474 
m
.
	`£t_šdex
(
šdex
);

2475 
m
.
	`£t_‹rm
(
sm
.
‹rm
);

2476 
m
.
	`£t_»jeù
(
»jeù
);

2477 
m
.
	`£t_»jeù_hšt
(
šdex
);

2478 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

2480 
sm
.
´s
[&2].
m©ched
 !ğ
wm©ch
 {

2481 
·nic
!("#{}: m©ch = {}, wªˆ{}", 
i
, 
sm
.
´s
[&2].
m©ched
, 
wm©ch
);

2483 
sm
.
´s
[&2].
Ãxt_idx
 !ğ
wÃxt
 {

2484 
·nic
!("#{}:‚exˆğ{}, wªˆ{}", 
i
, 
sm
.
´s
[&2].
Ãxt_idx
, 
wÃxt
);

2487 
Ët
 
mut
 
msgs
 = 
sm
.
	`»ad_mes§ges
();

2488 
msgs
.
	`Ën
(è!ğ
wmsg_num
 {

2489 
·nic
!("#{} msg_num = {}, wªˆ{}", 
i
, 
msgs
.
	`Ën
(), 
wmsg_num
);

2491 
j
, 
msg
è
š
 
msgs
.
	`d¿š
(..).
	`’um”©e
() {

2492 
msg
.
	`g‘_šdex
(è!ğ
wšdex
 {

2493 
·nic
!("#{}.{} index = {}, wªˆ{}", 
i
, 
j
, 
msg
.
	`g‘_šdex
(), 
wšdex
);

2495 
msg
.
	`g‘_comm™
(è!ğ
wcomm™‹d
 {

2496 
·nic
!(

2498 
i
,

2499 
j
,

2500 
msg
.
	`g‘_comm™
(),

2501 
wcomm™‹d


2506 
	}
}

2510 #[
‹¡
]

2511 
â
 
	$‹¡_bÿ¡_b—t
() {

2512 
Ët
 
off£t
 = 1000u64;

2514 
Ët
 
s
 = 
	`Ãw_¢­shÙ
(
off£t
, 1, 
vec
![1, 2, 3]);

2515 
Ët
 
¡Üe
 = 
	`Ãw_¡Üage
();

2516 
¡Üe
.
	`wl
().
	`­¶y_¢­shÙ
(
s
).
	`ex³ù
("");

2517 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![], 10, 1, 
¡Üe
);

2518 
sm
.
‹rm
 = 1;

2520 
sm
.
	`become_ÿndid©e
();

2521 
sm
.
	`become_Ëad”
();

2522 
i
 
š
 0..10 {

2523 
sm
.
	`­³nd_’Œy
(&
mut
 [
	`em±y_’Œy
(0, 
i
 
as
 
u64
 + 1)]);

2526 
Ët
 
mut_´
 = |
sm
: &
mut
 
IÁ”çû
, 
n
, 
m©ched
, 
Ãxt_idx
| {

2527 
Ët
 
m
 = 
sm
.
´s
.
	`g‘_mut
(&
n
).
	`unw¿p
();

2528 
m
.
m©ched
 = matched;

2529 
m
.
Ãxt_idx
 =‚ext_idx;

2532 
	`mut_´
(&
mut
 
sm
, 2, 5, 6);

2534 
Ët
 
Ï¡_šdex
 = 
sm
.
¿á_log
.
	`Ï¡_šdex
();

2535 
	`mut_´
(&
mut
 
sm
, 3, 
Ï¡_šdex
,†ast_index + 1);

2537 
sm
.
	`¡•
(
	`Ãw_mes§ge
(0, 0, 
Mes§geTy³
::
MsgB—t
, 0))

2538 .
	`ex³ù
("");

2539 
Ët
 
mut
 
msgs
 = 
sm
.
	`»ad_mes§ges
();

2540 
as£¹_eq
!(
msgs
.
	`Ën
(), 2);

2541 
Ët
 
mut
 
wªt_comm™_m­
 = 
HashM­
::
	`Ãw
();

2542 
wªt_comm™_m­
.
	`š£¹
(2, 
cmp
::
	`mš
(
sm
.
¿á_log
.
comm™‹d
, sm.
´s
[&2].
m©ched
));

2543 
wªt_comm™_m­
.
	`š£¹
(3, 
cmp
::
	`mš
(
sm
.
¿á_log
.
comm™‹d
, sm.
´s
[&3].
m©ched
));

2544 
i
, 
m
è
š
 
msgs
.
	`d¿š
(..).
	`’um”©e
() {

2545 
m
.
	`g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgH—¹b—t
 {

2546 
·nic
!(

2548 
i
,

2549 
m
.
	`g‘_msg_ty³
(),

2550 
Mes§geTy³
::
MsgH—¹b—t


2553 
m
.
	`g‘_šdex
() != 0 {

2554 
·nic
!("#{}:…»v_šdex = {}, wªˆ{}", 
i
, 
m
.
	`g‘_šdex
(), 0);

2556 
m
.
	`g‘_log_‹rm
() != 0 {

2557 
·nic
!("#{}:…»v_‹rm = {}, wªˆ{}", 
i
, 
m
.
	`g‘_log_‹rm
(), 0);

2559 
wªt_comm™_m­
[&
m
.
	`g‘_to
()] == 0 {

2560 
·nic
!("#{}: uÃx³ùedØ{}", 
i
, 
m
.
	`g‘_to
())

2562 
m
.
	`g‘_comm™
(è!ğ
wªt_comm™_m­
[&m.
	`g‘_to
()] {

2563 
·nic
!(

2565 
i
,

2566 
m
.
	`g‘_comm™
(),

2567 
wªt_comm™_m­
[&
m
.
	`g‘_to
()]

2570 
wªt_comm™_m­
.
	`»move
(&
m
.
	`g‘_to
());

2572 !
m
.
	`g‘_’Œ›s
().
	`is_em±y
() {

2573 
·nic
!("#{}:ƒÁr› couÁ = {}, wªˆ0", 
i
, 
m
.
	`g‘_’Œ›s
().
	`Ën
());

2576 
	}
}

2579 #[
‹¡
]

2580 
â
 
	$‹¡_»cv_msg_b—t
() {

2581 
Ët
 
mut
 
‹¡s
 = 
vec
![

2582 (
S‹RŞe
::
L—d”
, 2),

2584 (
S‹RŞe
::
Cªdid©e
, 0),

2585 (
S‹RŞe
::
FŞlow”
, 0),

2588 
i
, (
¡©e
, 
w_msg
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

2589 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

2590 
sm
.
¿á_log
 = 
	`Ãw_¿á_log
(
vec
![
	`em±y_’Œy
(0, 1),ƒmpty_entry(1, 2)], 0, 0);

2591 
sm
.
‹rm
 = 1;

2592 
sm
.
¡©e
 = state;

2593 
sm
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgB—t
, 0))

2594 .
	`ex³ù
("");

2596 
Ët
 
msgs
 = 
sm
.
	`»ad_mes§ges
();

2597 
msgs
.
	`Ën
(è!ğ
w_msg
 {

2598 
·nic
!("#{}: msg couÁ = {}, wªˆ{}", 
i
, 
msgs
.
	`Ën
(), 
w_msg
);

2600 
m
 
š
 
msgs
 {

2601 
m
.
	`g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgH—¹b—t
 {

2602 
·nic
!(

2604 
i
,

2605 
m
.
	`g‘_msg_ty³
(),

2606 
Mes§geTy³
::
MsgH—¹b—t


2611 
	}
}

2613 #[
‹¡
]

2614 
â
 
	$‹¡_Ëad”_šü—£_Ãxt
() {

2615 
Ët
 
´evious_’ts
 = 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(1, 2),ƒmpty_entry(1, 3)];

2616 
Ët
 
mut
 
‹¡s
 = 
vec
![

2620 
Prog»ssS‹
::
R•liÿ‹
,

2622 
´evious_’ts
.
	`Ën
(è
as
 
u64
 + 1 + 1 + 1,

2625 (
Prog»ssS‹
::
Probe
, 2, 2),

2627 
i
, (
¡©e
, 
Ãxt_idx
, 
wÃxt
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

2628 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2629 
sm
.
¿á_log
.
	`­³nd
(&
´evious_’ts
);

2630 
sm
.
	`become_ÿndid©e
();

2631 
sm
.
	`become_Ëad”
();

2632 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
¡©e
 = state;

2633 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
Ãxt_idx
 =‚ext_idx;

2634 
sm
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

2635 .
	`ex³ù
("");

2637 
sm
.
´s
[&2].
Ãxt_idx
 !ğ
wÃxt
 {

2638 
·nic
!("#{}:‚exˆğ{}, wªˆ{}", 
i
, 
sm
.
´s
[&2].
Ãxt_idx
, 
wÃxt
);

2641 
	}
}

2643 #[
‹¡
]

2644 
â
 
	$‹¡_£nd_­³nd_fÜ_´og»ss_´obe
() {

2645 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2646 
r
.
	`become_ÿndid©e
();

2647 
r
.
	`become_Ëad”
();

2648 
r
.
	`»ad_mes§ges
();

2649 
r
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_´obe
();

2652 
i
 
š
 0..3 {

2653 
i
 == 0 {

2657 
r
.
	`­³nd_’Œy
(&
mut
 [
	`Ãw_’Œy
(0, 0, 
SOME_DATA
)]);

2658 
r
.
	`£nd_­³nd
(2);

2659 
Ët
 
msg
 = 
r
.
	`»ad_mes§ges
();

2660 
as£¹_eq
!(
msg
.
	`Ën
(), 1);

2661 
as£¹_eq
!(
msg
[0].
	`g‘_šdex
(), 0);

2664 
as£¹
!(
r
.
´s
[&2].
·u£d
);

2665 
_
 
š
 0..10 {

2666 
r
.
	`­³nd_’Œy
(&
mut
 [
	`Ãw_’Œy
(0, 0, 
SOME_DATA
)]);

2667 
r
.
	`£nd_­³nd
(2);

2668 
as£¹_eq
!(
r
.
	`»ad_mes§ges
().
	`Ën
(), 0);

2672 
_
 
š
 0..
r
.
	`g‘_h—¹b—t_timeout
() {

2673 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgB—t
, 0))

2674 .
	`ex³ù
("");

2676 
as£¹
!(
r
.
´s
[&2].
·u£d
);

2679 
Ët
 
msg
 = 
r
.
	`»ad_mes§ges
();

2680 
as£¹_eq
!(
msg
.
	`Ën
(), 1);

2681 
as£¹_eq
!(
msg
[0].
	`g‘_msg_ty³
(), 
Mes§geTy³
::
MsgH—¹b—t
);

2685 
r
.
	`¡•
(
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 0))

2686 .
	`ex³ù
("");

2687 
Ët
 
msg
 = 
r
.
	`»ad_mes§ges
();

2688 
as£¹_eq
!(
msg
.
	`Ën
(), 1);

2689 
as£¹_eq
!(
msg
[0].
	`g‘_šdex
(), 0);

2690 
as£¹
!(
r
.
´s
[&2].
·u£d
);

2691 
	}
}

2693 #[
‹¡
]

2694 
â
 
	$‹¡_£nd_­³nd_fÜ_´og»ss_»¶iÿ‹
() {

2695 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2696 
r
.
	`become_ÿndid©e
();

2697 
r
.
	`become_Ëad”
();

2698 
r
.
	`»ad_mes§ges
();

2699 
r
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_»¶iÿ‹
();

2701 
_
 
š
 0..10 {

2702 
r
.
	`­³nd_’Œy
(&
mut
 [
	`Ãw_’Œy
(0, 0, 
SOME_DATA
)]);

2703 
r
.
	`£nd_­³nd
(2);

2704 
as£¹_eq
!(
r
.
	`»ad_mes§ges
().
	`Ën
(), 1);

2706 
	}
}

2708 #[
‹¡
]

2709 
â
 
	$‹¡_£nd_­³nd_fÜ_´og»ss_¢­shÙ
() {

2710 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2711 
r
.
	`become_ÿndid©e
();

2712 
r
.
	`become_Ëad”
();

2713 
r
.
	`»ad_mes§ges
();

2714 
r
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_¢­shÙ
(10);

2716 
_
 
š
 0..10 {

2717 
r
.
	`­³nd_’Œy
(&
mut
 [
	`Ãw_’Œy
(0, 0, 
SOME_DATA
)]);

2718 
r
.
	`£nd_­³nd
(2);

2719 
as£¹_eq
!(
r
.
	`»ad_mes§ges
().
	`Ën
(), 0);

2721 
	}
}

2723 #[
‹¡
]

2724 
â
 
	$‹¡_»cv_msg_uÄ—chabË
() {

2725 
Ët
 
´evious_’ts
 = 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(1, 2),ƒmpty_entry(1, 3)];

2726 
Ët
 
s
 = 
	`Ãw_¡Üage
();

2727 
s
.
	`wl
().
	`­³nd
(&
´evious_’ts
).
	`ex³ù
("");

2728 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
s
);

2729 
r
.
	`become_ÿndid©e
();

2730 
r
.
	`become_Ëad”
();

2731 
r
.
	`»ad_mes§ges
();

2733 
r
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
m©ched
 = 3;

2734 
r
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_»¶iÿ‹
();

2735 
r
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`İtimi¡ic_upd©e
(5);

2737 
r
.
	`¡•
(
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgUÄ—chabË
, 0))

2738 .
	`ex³ù
("");

2740 
as£¹_eq
!(
r
.
´s
[&2].
¡©e
, 
Prog»ssS‹
::
Probe
);

2741 
as£¹_eq
!(
r
.
´s
[&2].
m©ched
 + 1,„.´s[&2].
Ãxt_idx
);

2742 
	}
}

2744 #[
‹¡
]

2745 
â
 
	$‹¡_»¡Üe
() {

2747 
Ët
 
s
 = 
	`Ãw_¢­shÙ
(11, 11, 
vec
![1, 2, 3]);

2749 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2750 
as£¹
!(
sm
.
	`»¡Üe
(
s
.
	`şÚe
()));

2751 
as£¹_eq
!(
sm
.
¿á_log
.
	`Ï¡_šdex
(), 
s
.
	`g‘_m‘ad©a
().
	`g‘_šdex
());

2752 
as£¹_eq
!(

2753 
sm
.
¿á_log
.
	`‹rm
(
s
.
	`g‘_m‘ad©a
().
	`g‘_šdex
()).
	`unw¿p
(),

2754 
s
.
	`g‘_m‘ad©a
().
	`g‘_‹rm
()

2756 
as£¹_eq
!(
sm
.
	`nodes
(), 
s
.
	`g‘_m‘ad©a
().
	`g‘_cÚf_¡©e
().
	`g‘_nodes
());

2757 
as£¹
!(!
sm
.
	`»¡Üe
(
s
));

2758 
	}
}

2760 #[
‹¡
]

2761 
â
 
	$‹¡_»¡Üe_ignÜe_¢­shÙ
() {

2762 
Ët
 
´evious_’ts
 = 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(1, 2),ƒmpty_entry(1, 3)];

2763 
Ët
 
comm™
 = 1u64;

2764 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2765 
sm
.
¿á_log
.
	`­³nd
(&
´evious_’ts
);

2766 
sm
.
¿á_log
.
	`comm™_to
(
comm™
);

2768 
Ët
 
mut
 
s
 = 
	`Ãw_¢­shÙ
(
comm™
, 1, 
vec
![1, 2]);

2771 
as£¹
!(!
sm
.
	`»¡Üe
(
s
.
	`şÚe
()));

2772 
as£¹_eq
!(
sm
.
¿á_log
.
comm™‹d
, 
comm™
);

2775 
s
.
	`mut_m‘ad©a
().
	`£t_šdex
(
comm™
 + 1);

2776 
as£¹
!(!
sm
.
	`»¡Üe
(
s
));

2777 
as£¹_eq
!(
sm
.
¿á_log
.
comm™‹d
, 
comm™
 + 1);

2778 
	}
}

2780 #[
‹¡
]

2781 
â
 
	$‹¡_´ovide_¢­
() {

2783 
Ët
 
s
 = 
	`Ãw_¢­shÙ
(11, 11, 
vec
![1, 2]);

2785 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1], 10, 1, 
	`Ãw_¡Üage
());

2786 
sm
.
	`»¡Üe
(
s
);

2788 
sm
.
	`become_ÿndid©e
();

2789 
sm
.
	`become_Ëad”
();

2792 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
Ãxt_idx
 = sm.
¿á_log
.
	`fœ¡_šdex
();

2793 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

2794 
m
.
	`£t_šdex
(
sm
.
´s
[&2].
Ãxt_idx
 - 1);

2795 
m
.
	`£t_»jeù
(
Œue
);

2796 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

2798 
Ët
 
msgs
 = 
sm
.
	`»ad_mes§ges
();

2799 
as£¹_eq
!(
msgs
.
	`Ën
(), 1);

2800 
as£¹_eq
!(
msgs
[0].
	`g‘_msg_ty³
(), 
Mes§geTy³
::
MsgSÇpshÙ
);

2801 
	}
}

2803 #[
‹¡
]

2804 
â
 
	$‹¡_ignÜe_´ovidšg_¢­shÙ
() {

2806 
Ët
 
s
 = 
	`Ãw_¢­shÙ
(11, 11, 
vec
![1, 2]);

2807 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1], 10, 1, 
	`Ãw_¡Üage
());

2808 
sm
.
	`»¡Üe
(
s
);

2810 
sm
.
	`become_ÿndid©e
();

2811 
sm
.
	`become_Ëad”
();

2815 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
Ãxt_idx
 = sm.
¿á_log
.
	`fœ¡_šdex
() - 1;

2816 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
»ûÁ_aùive
 = 
çl£
;

2818 
sm
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

2819 .
	`ex³ù
("");

2821 
as£¹_eq
!(
sm
.
	`»ad_mes§ges
().
	`Ën
(), 0);

2822 
	}
}

2824 #[
‹¡
]

2825 
â
 
	$‹¡_»¡Üe_äom_¢­_msg
() {

2826 
Ët
 
s
 = 
	`Ãw_¢­shÙ
(11, 11, 
vec
![1, 2]);

2827 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2828 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(1, 0, 
Mes§geTy³
::
MsgSÇpshÙ
, 0);

2829 
m
.
	`£t_‹rm
(2);

2830 
m
.
	`£t_¢­shÙ
(
s
);

2832 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

2834 
as£¹_eq
!(
sm
.
Ëad”_id
, 1);

2837 
	}
}

2839 #[
‹¡
]

2840 
â
 
	$‹¡_¦ow_node_»¡Üe
() {

2841 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

2842 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

2844 
Á
.
	`isŞ©e
(3);

2845 
_
 
š
 0..100 {

2846 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

2848 
	`Ãxt_’ts
(&
mut
 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
(), &Á.
¡Üage
[&1]);

2849 
Ët
 
mut
 
cs
 = 
CÚfS‹
::
	`Ãw
();

2850 
cs
.
	`£t_nodes
(
Á
.
³”s
[&1].
	`nodes
());

2851 
Á
.
¡Üage
[&1]

2852 .
	`wl
()

2853 .
	`ü—‹_¢­shÙ
(
Á
.
³”s
[&1].
¿á_log
.
­¶›d
, 
	`Some
(
cs
), 
vec
![])

2854 .
	`ex³ù
("");

2855 
Á
.
¡Üage
[&1]

2856 .
	`wl
()

2857 .
	`com·ù
(
Á
.
³”s
[&1].
¿á_log
.
­¶›d
)

2858 .
	`ex³ù
("");

2860 
Á
.
	`»cov”
();

2863 
loİ
 {

2864 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgB—t
, 0)]);

2865 
Á
.
³”s
[&1].
´s
[&3].
»ûÁ_aùive
 {

2871 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

2874 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

2875 
as£¹_eq
!(

2876 
Á
.
³”s
[&3].
¿á_log
.
comm™‹d
,

2877 
Á
.
³”s
[&1].
¿á_log
.
comm™‹d


2879 
	}
}

2883 #[
‹¡
]

2884 
â
 
	$‹¡_¡•_cÚfig
() {

2886 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2887 
r
.
	`become_ÿndid©e
();

2888 
r
.
	`become_Ëad”
();

2889 
Ët
 
šdex
 = 
r
.
¿á_log
.
	`Ï¡_šdex
();

2890 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 0);

2891 
Ët
 
mut
 
e
 = 
EÁry
::
	`Ãw
();

2892 
e
.
	`£t_’Œy_ty³
(
EÁryTy³
::
EÁryCÚfChªge
);

2893 
m
.
	`mut_’Œ›s
().
	`push
(
e
);

2894 
r
.
	`¡•
(
m
).
	`ex³ù
("");

2895 
as£¹_eq
!(
r
.
¿á_log
.
	`Ï¡_šdex
(), 
šdex
 + 1);

2896 
as£¹
!(
r
.
³ndšg_cÚf
);

2897 
	}
}

2902 #[
‹¡
]

2903 
â
 
	$‹¡_¡•_ignÜe_cÚfig
() {

2905 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2906 
r
.
	`become_ÿndid©e
();

2907 
r
.
	`become_Ëad”
();

2908 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 0);

2909 
Ët
 
mut
 
e
 = 
EÁry
::
	`Ãw
();

2910 
e
.
	`£t_’Œy_ty³
(
EÁryTy³
::
EÁryCÚfChªge
);

2911 
m
.
	`mut_’Œ›s
().
	`push
(
e
);

2912 
r
.
	`¡•
(
m
.
	`şÚe
()).
	`ex³ù
("");

2913 
Ët
 
šdex
 = 
r
.
¿á_log
.
	`Ï¡_šdex
();

2914 
Ët
 
³ndšg_cÚf
 = 
r
.pending_conf;

2915 
r
.
	`¡•
(
m
.
	`şÚe
()).
	`ex³ù
("");

2916 
Ët
 
mut
 
we
 = 
	`em±y_’Œy
(1, 3);

2917 
we
.
	`£t_’Œy_ty³
(
EÁryTy³
::
EÁryNÜm®
);

2918 
Ët
 
w’ts
 = 
vec
![
we
];

2919 
Ët
 
’Œ›s
 = 
r
.
¿á_log
.
	`’Œ›s
(
šdex
 + 1, 
NO_LIMIT
).
	`ex³ù
("");

2920 
as£¹_eq
!(
’Œ›s
, 
w’ts
);

2921 
as£¹_eq
!(
r
.
³ndšg_cÚf
,…ending_conf);

2922 
	}
}

2926 #[
‹¡
]

2927 
â
 
	$‹¡_»cov”_³ndšg_cÚfig
() {

2928 
Ët
 
mut
 
‹¡s
 = 
vec
![

2929 (
EÁryTy³
::
EÁryNÜm®
, 
çl£
),

2930 (
EÁryTy³
::
EÁryCÚfChªge
, 
Œue
),

2932 
i
, (
’t_ty³
, 
w³ndšg
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

2933 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2934 
Ët
 
mut
 
e
 = 
EÁry
::
	`Ãw
();

2935 
e
.
	`£t_’Œy_ty³
(
’t_ty³
);

2936 
r
.
	`­³nd_’Œy
(&
mut
 [
e
]);

2937 
r
.
	`become_ÿndid©e
();

2938 
r
.
	`become_Ëad”
();

2939 
r
.
³ndšg_cÚf
 !ğ
w³ndšg
 {

2940 
·nic
!(

2942 
i
,

2943 
r
.
³ndšg_cÚf
,

2944 
w³ndšg


2948 
	}
}

2952 #[
‹¡
]

2953 
â
 
	$‹¡_»cov”_doubË_³ndšg_cÚfig
() {

2954 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2955 
Ët
 
mut
 
e
 = 
EÁry
::
	`Ãw
();

2956 
e
.
	`£t_’Œy_ty³
(
EÁryTy³
::
EÁryCÚfChªge
);

2957 
r
.
	`­³nd_’Œy
(&
mut
 [
e
.
	`şÚe
()]);

2958 
r
.
	`­³nd_’Œy
(&
mut
 [
e
]);

2959 
r
.
	`become_ÿndid©e
();

2960 
as£¹
!(
»cov”_§ã
!(|| 
r
.
	`become_Ëad”
()).
	`is_”r
());

2961 
	}
}

2964 #[
‹¡
]

2965 
â
 
	$‹¡_add_node
() {

2966 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1], 10, 1, 
	`Ãw_¡Üage
());

2967 
r
.
³ndšg_cÚf
 = 
Œue
;

2968 
r
.
	`add_node
(2);

2969 
as£¹
!(!
r
.
³ndšg_cÚf
);

2970 
as£¹_eq
!(
r
.
	`nodes
(), 
vec
![1, 2]);

2971 
	}
}

2975 #[
‹¡
]

2976 
â
 
	$‹¡_»move_node
() {

2977 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

2978 
r
.
³ndšg_cÚf
 = 
Œue
;

2979 
r
.
	`»move_node
(2);

2980 
as£¹
!(!
r
.
³ndšg_cÚf
);

2981 
as£¹_eq
!(
r
.
	`nodes
(), 
vec
![1]);

2984 
r
.
	`»move_node
(1);

2985 
as£¹
!(
r
.
	`nodes
().
	`is_em±y
());

2986 
	}
}

2988 #[
‹¡
]

2989 
â
 
	$‹¡_´omÙabË
() {

2990 
Ët
 
id
 = 1u64;

2991 
Ët
 
mut
 
‹¡s
 = 
vec
![

2992 (
vec
![1], 
Œue
),

2993 (
vec
![1, 2, 3], 
Œue
),

2994 (
vec
![], 
çl£
),

2995 (
vec
![2, 3], 
çl£
),

2997 
i
, (
³”s
, 
wp
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

2998 
Ët
 
r
 = 
	`Ãw_‹¡_¿á
(
id
, 
³”s
, 5, 1, 
	`Ãw_¡Üage
());

2999 
r
.
	`´omÙabË
(è!ğ
wp
 {

3000 
·nic
!("#{}:…romÙabË = {}, wªˆ{}", 
i
, 
r
.
	`´omÙabË
(), 
wp
);

3003 
	}
}

3005 #[
‹¡
]

3006 
â
 
	$‹¡_¿á_nodes
() {

3007 
Ët
 
mut
 
‹¡s
 = 
vec
![

3008 (
vec
![1, 2, 3], vec![1, 2, 3]),

3009 (
vec
![3, 2, 1], vec![1, 2, 3]),

3011 
i
, (
ids
, 
wids
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

3012 
Ët
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
ids
, 10, 1, 
	`Ãw_¡Üage
());

3013 
r
.
	`nodes
(è!ğ
wids
 {

3014 
·nic
!("#{}:‚ode ğ{:?}, wªˆ{:?}", 
i
, 
r
.
	`nodes
(), 
wids
);

3017 
	}
}

3019 #[
‹¡
]

3020 
â
 
	$‹¡_ÿm·ign_whe_Ëad”
() {

3021 
	`‹¡_ÿm·ign_whe_Ëad”_w™h_´e_vÙe
(
çl£
);

3022 
	}
}

3024 #[
‹¡
]

3025 
â
 
	$‹¡_´e_ÿm·ign_whe_Ëad”
() {

3026 
	`‹¡_ÿm·ign_whe_Ëad”_w™h_´e_vÙe
(
Œue
);

3027 
	}
}

3030 
â
 
	$‹¡_ÿm·ign_whe_Ëad”_w™h_´e_vÙe
(
´e_vÙe
: 
boŞ
) {

3031 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á_w™h_´evÙe
(1, 
vec
![1], 5, 1, 
	`Ãw_¡Üage
(), 
´e_vÙe
);

3032 
as£¹_eq
!(
r
.
¡©e
, 
S‹RŞe
::
FŞlow”
);

3035 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)).
	`ex³ù
("");

3036 
as£¹_eq
!(
r
.
¡©e
, 
S‹RŞe
::
L—d”
);

3037 
Ët
 
‹rm
 = 
r
.term;

3038 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)).
	`ex³ù
("");

3039 
as£¹_eq
!(
r
.
¡©e
, 
S‹RŞe
::
L—d”
);

3040 
as£¹_eq
!(
r
.
‹rm
,erm);

3041 
	}
}

3045 #[
‹¡
]

3046 
â
 
	$‹¡_comm™_aá”_»move_node
() {

3048 
Ët
 
s
 = 
	`Ãw_¡Üage
();

3049 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 5, 1, 
s
.
	`şÚe
());

3050 
r
.
	`become_ÿndid©e
();

3051 
r
.
	`become_Ëad”
();

3054 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(0, 0, 
Mes§geTy³
::
MsgPrİo£
, 0);

3055 
Ët
 
mut
 
e
 = 
EÁry
::
	`Ãw
();

3056 
e
.
	`£t_’Œy_ty³
(
EÁryTy³
::
EÁryCÚfChªge
);

3057 
Ët
 
mut
 
cc
 = 
CÚfChªge
::
	`Ãw
();

3058 
cc
.
	`£t_chªge_ty³
(
CÚfChªgeTy³
::
RemoveNode
);

3059 
cc
.
	`£t_node_id
(2);

3060 
e
.
	`£t_d©a
(
´Ùobuf
::
Mes§ge
::
	`wr™e_to_by‹s
(&
cc
).
	`unw¿p
());

3061 
m
.
	`mut_’Œ›s
().
	`push
(
e
);

3062 
r
.
	`¡•
(
m
).
	`ex³ù
("");

3064 
as£¹_eq
!(
	`Ãxt_’ts
(&
mut
 
r
, &
s
).
	`Ën
(), 0);

3065 
Ët
 
cc_šdex
 = 
r
.
¿á_log
.
	`Ï¡_šdex
();

3068 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(0, 0, 
Mes§geTy³
::
MsgPrİo£
, 0);

3069 
Ët
 
mut
 
e
 = 
	`Ãw_’Œy
(0, 0, 
	`Some
("hello"));

3070 
e
.
	`£t_’Œy_ty³
(
EÁryTy³
::
EÁryNÜm®
);

3071 
m
.
	`mut_’Œ›s
().
	`push
(
e
);

3072 
r
.
	`¡•
(
m
).
	`ex³ù
("");

3075 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 0, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

3076 
m
.
	`£t_šdex
(
cc_šdex
);

3077 
r
.
	`¡•
(
m
).
	`ex³ù
("");

3078 
Ët
 
’ts
 = 
	`Ãxt_’ts
(&
mut
 
r
, &
s
);

3079 
as£¹_eq
!(
’ts
.
	`Ën
(), 2);

3080 
as£¹_eq
!(
’ts
[0].
	`g‘_’Œy_ty³
(), 
EÁryTy³
::
EÁryNÜm®
);

3081 
as£¹
!(
’ts
[0].
	`g‘_d©a
().
	`is_em±y
());

3082 
as£¹_eq
!(
’ts
[1].
	`g‘_’Œy_ty³
(), 
EÁryTy³
::
EÁryCÚfChªge
);

3086 
r
.
	`»move_node
(2);

3087 
Ët
 
’ts
 = 
	`Ãxt_’ts
(&
mut
 
r
, &
s
);

3088 
as£¹_eq
!(
’ts
.
	`Ën
(), 1);

3089 
as£¹_eq
!(
’ts
[0].
	`g‘_’Œy_ty³
(), 
EÁryTy³
::
EÁryNÜm®
);

3090 
as£¹_eq
!(
’ts
[0].
	`g‘_d©a
(), 
b
"hello");

3091 
	}
}

3095 #[
‹¡
]

3096 
â
 
	$‹¡_Ëad”_Œªsãr_to_u±od©e_node
() {

3097 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3098 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3100 
Ët
 
Ëad_id
 = 
Á
.
³”s
[&1].
Ëad”_id
;

3101 
as£¹_eq
!(
Ëad_id
, 1);

3104 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3105 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
FŞlow”
, 2);

3108 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

3109 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 2, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3110 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
L—d”
, 1);

3111 
	}
}

3118 #[
‹¡
]

3119 
â
 
	$‹¡_Ëad”_Œªsãr_to_u±od©e_node_äom_fŞlow”
() {

3120 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3121 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3123 
Ët
 
Ëad_id
 = 
Á
.
³”s
[&1].
Ëad”_id
;

3124 
as£¹_eq
!(
Ëad_id
, 1);

3127 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(2, 2, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3128 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
FŞlow”
, 2);

3131 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

3132 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3133 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
L—d”
, 1);

3134 
	}
}

3138 #[
‹¡
]

3139 
â
 
	$‹¡_Ëad”_Œªsãr_w™h_check_quÜum
() {

3140 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3141 
i
 
š
 1..4 {

3142 
Ët
 
r
 = &
mut
 
Á
.
³”s
.
	`g‘_mut
(&
i
).
	`unw¿p
();

3143 
r
.
check_quÜum
 = 
Œue
;

3144 
Ët
 
–eùiÚ_timeout
 = 
r
.
	`g‘_–eùiÚ_timeout
();

3145 
r
.
	`£t_¿ndomized_–eùiÚ_timeout
(
–eùiÚ_timeout
 + 
i
 
as
 
usize
);

3148 
Ët
 
b_–eùiÚ_timeout
 = 
Á
.
³”s
[&2].
	`g‘_–eùiÚ_timeout
();

3149 
Á
.
³”s


3150 .
	`g‘_mut
(&2)

3151 .
	`unw¿p
()

3152 .
	`£t_¿ndomized_–eùiÚ_timeout
(
b_–eùiÚ_timeout
 + 1);

3155 
_
 
š
 0..b
_–eùiÚ_timeout
 {

3156 
Á
.
³”s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`tick
();

3158 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3160 
as£¹_eq
!(
Á
.
³”s
[&1].
Ëad”_id
, 1);

3163 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3164 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
FŞlow”
, 2);

3167 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

3168 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 2, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3169 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
L—d”
, 1);

3170 
	}
}

3172 #[
‹¡
]

3173 
â
 
	$‹¡_Ëad”_Œªsãr_to_¦ow_fŞlow”
() {

3174 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3175 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3177 
Á
.
	`isŞ©e
(3);

3178 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

3180 
Á
.
	`»cov”
();

3181 
as£¹_eq
!(
Á
.
³”s
[&1].
´s
[&3].
m©ched
, 1);

3184 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3186 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
FŞlow”
, 3);

3187 
	}
}

3189 #[
‹¡
]

3190 
â
 
	$‹¡_Ëad”_Œªsãr_aá”_¢­shÙ
() {

3191 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3192 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3194 
Á
.
	`isŞ©e
(3);

3196 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

3197 
	`Ãxt_’ts
(&
mut
 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
(), &Á.
¡Üage
[&1]);

3198 
Ët
 
mut
 
cs
 = 
CÚfS‹
::
	`Ãw
();

3199 
cs
.
	`£t_nodes
(
Á
.
³”s
[&1].
	`nodes
());

3200 
Á
.
¡Üage
[&1]

3201 .
	`wl
()

3202 .
	`ü—‹_¢­shÙ
(
Á
.
³”s
[&1].
¿á_log
.
­¶›d
, 
	`Some
(
cs
), 
vec
![])

3203 .
	`ex³ù
("");

3204 
Á
.
¡Üage
[&1]

3205 .
	`wl
()

3206 .
	`com·ù
(
Á
.
³”s
[&1].
¿á_log
.
­¶›d
)

3207 .
	`ex³ù
("");

3209 
Á
.
	`»cov”
();

3210 
as£¹_eq
!(
Á
.
³”s
[&1].
´s
[&3].
m©ched
, 1);

3213 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3215 
Á
.
	`£nd
(
vec
![

3216 
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 0),

3219 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
FŞlow”
, 3);

3220 
	}
}

3222 #[
‹¡
]

3223 
â
 
	$‹¡_Ëad”_Œªsãr_to_£lf
() {

3224 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3225 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3228 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3229 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
L—d”
, 1);

3230 
	}
}

3232 #[
‹¡
]

3233 
â
 
	$‹¡_Ëad”_Œªsãr_to_nÚ_exi¡šg_node
() {

3234 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3235 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3238 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(4, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3239 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
L—d”
, 1);

3240 
	}
}

3242 #[
‹¡
]

3243 
â
 
	$‹¡_Ëad”_Œªsãr_timeout
() {

3244 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3245 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3247 
Á
.
	`isŞ©e
(3);

3250 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3251 
as£¹_eq
!(
Á
.
³”s
[&1].
Ëad_Œªsã»e
.
	`unw¿p
(), 3);

3252 
Ët
 
h—¹b—t_timeout
 = 
Á
.
³”s
[&1].
	`g‘_h—¹b—t_timeout
();

3253 
Ët
 
–eùiÚ_timeout
 = 
Á
.
³”s
[&1].
	`g‘_–eùiÚ_timeout
();

3254 
_
 
š
 0..
h—¹b—t_timeout
 {

3255 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
().
	`tick
();

3257 
as£¹_eq
!(
Á
.
³”s
[&1].
Ëad_Œªsã»e
.
	`unw¿p
(), 3);

3258 
_
 
š
 0..–ec
tiÚ_timeout
 - 
h—¹b—t_timeout
 {

3259 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
().
	`tick
();

3262 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
L—d”
, 1);

3263 
	}
}

3265 #[
‹¡
]

3266 
â
 
	$‹¡_Ëad”_Œªsãr_ignÜe_´İo§l
() {

3267 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3268 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3270 
Á
.
	`isŞ©e
(3);

3273 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3274 
as£¹_eq
!(
Á
.
³”s
[&1].
Ëad_Œªsã»e
.
	`unw¿p
(), 3);

3276 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1)]);

3277 
as£¹_eq
!(
Á
.
³”s
[&1].
´s
[&1].
m©ched
, 1);

3278 
	}
}

3280 #[
‹¡
]

3281 
â
 
	$‹¡_Ëad”_Œªsãr_»ûive_high”_‹rm_vÙe
() {

3282 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3283 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3285 
Á
.
	`isŞ©e
(3);

3288 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3289 
as£¹_eq
!(
Á
.
³”s
[&1].
Ëad_Œªsã»e
.
	`unw¿p
(), 3);

3291 
Á
.
	`£nd
(
vec
![

3292 
	`Ãw_mes§ge_w™h_’Œ›s
(2, 2, 
Mes§geTy³
::
MsgHup
, 
vec
![
	`Ãw_’Œy
(1, 2, 
NÚe
)]),

3295 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
FŞlow”
, 2);

3296 
	}
}

3298 #[
‹¡
]

3299 
â
 
	$‹¡_Ëad”_Œªsãr_»move_node
() {

3300 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3301 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3303 
Á
.
	`ignÜe
(
Mes§geTy³
::
MsgTimeoutNow
);

3306 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3307 
as£¹_eq
!(
Á
.
³”s
[&1].
Ëad_Œªsã»e
.
	`unw¿p
(), 3);

3309 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
().
	`»move_node
(3);

3311 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
L—d”
, 1);

3312 
	}
}

3316 #[
‹¡
]

3317 
â
 
	$‹¡_Ëad”_Œªsãr_back
() {

3318 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3319 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3321 
Á
.
	`isŞ©e
(3);

3323 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3324 
as£¹_eq
!(
Á
.
³”s
[&1].
Ëad_Œªsã»e
.
	`unw¿p
(), 3);

3327 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3329 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
L—d”
, 1);

3330 
	}
}

3334 #[
‹¡
]

3335 
â
 
	$‹¡_Ëad”_Œªsãr_£cÚd_Œªsãr_to_ªÙh”_node
() {

3336 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3337 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3339 
Á
.
	`isŞ©e
(3);

3341 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3342 
as£¹_eq
!(
Á
.
³”s
[&1].
Ëad_Œªsã»e
.
	`unw¿p
(), 3);

3345 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3347 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
FŞlow”
, 2);

3348 
	}
}

3352 #[
‹¡
]

3353 
â
 
	$‹¡_Ëad”_Œªsãr_£cÚd_Œªsãr_to_§me_node
() {

3354 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
NÚe
, None, None]);

3355 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

3357 
Á
.
	`isŞ©e
(3);

3359 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3360 
as£¹_eq
!(
Á
.
³”s
[&1].
Ëad_Œªsã»e
.
	`unw¿p
(), 3);

3362 
Ët
 
h—¹b—t_timeout
 = 
Á
.
³”s
[&1].
	`g‘_h—¹b—t_timeout
();

3363 
_
 
š
 0..
h—¹b—t_timeout
 {

3364 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
().
	`tick
();

3368 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgT¿nsãrL—d”
, 0)]);

3370 
Ët
 
–eùiÚ_timeout
 = 
Á
.
³”s
[&1].
	`g‘_–eùiÚ_timeout
();

3371 
_
 
š
 0..–ec
tiÚ_timeout
 - 
h—¹b—t_timeout
 {

3372 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
().
	`tick
();

3375 
	`check_Ëad”_Œªsãr_¡©e
(&
Á
.
³”s
[&1], 
S‹RŞe
::
L—d”
, 1);

3376 
	}
}

3378 
â
 
check_Ëad”_Œªsãr_¡©e
(
r
: &
Raá
<
MemStÜage
>, 
¡©e
: 
S‹RŞe
, 
Ëad
: 
u64
) {

3379 
r
.
¡©e
 !ğ¡©||„.
Ëad”_id
 !ğ
Ëad
 {

3380 
·nic
!(

3382 
r
.
¡©e
,

3383 
r
.
Ëad”_id
,

3384 
¡©e
,

3385 
Ëad


3388 
	gas£¹_eq
!(
	gr
.
	gËad_Œªsã»e
, 
	gNÚe
);

3395 #[
‹¡
]

3396 
â
 
	$‹¡_Œªsãr_nÚ_memb”
() {

3397 
Ët
 
mut
 
¿á
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![2, 3, 4], 5, 1, 
	`Ãw_¡Üage
());

3398 
¿á
.
	`¡•
(
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgTimeoutNow
, 0))

3399 .
	`ex³ù
("");;

3401 
¿á
.
	`¡•
(
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£
, 0))

3402 .
	`ex³ù
("");;

3403 
¿á
.
	`¡•
(
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£
, 0))

3404 .
	`ex³ù
("");;

3405 
as£¹_eq
!(
¿á
.
¡©e
, 
S‹RŞe
::
FŞlow”
);

3406 
	}
}

	@tests/raft/test_raft_flow_control.rs

28 
u£
 
	gsu³r
::
‹¡_¿á
::*;

29 
u£
 
	gkv´Ùo
::
”aápb
::*;

34 #[
‹¡
]

35 
â
 
	$‹¡_msg_­p_æow_cÚŒŞ_fuÎ
() {

36 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 5, 1, 
	`Ãw_¡Üage
());

37 
r
.
	`become_ÿndid©e
();

38 
r
.
	`become_Ëad”
();

41 
r
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_»¶iÿ‹
();

43 
i
 
š
 0..
r
.
max_šæight
 {

44 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

45 .
	`ex³ù
("");

46 
Ët
 
ms
 = 
r
.
	`»ad_mes§ges
();

47 
ms
.
	`Ën
() != 1 {

48 
·nic
!("#{}: m couÁ = {}, wªˆ1", 
i
, 
ms
.
	`Ën
());

53 
as£¹
!(
r
.
´s
[&2].
šs
.
	`fuÎ
());

56 
i
 
š
 0..10 {

57 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

58 .
	`ex³ù
("");

59 
Ët
 
ms
 = 
r
.
	`»ad_mes§ges
();

60 !
ms
.
	`is_em±y
() {

61 
·nic
!("#{}: m couÁ = {}, wªˆ0", 
i
, 
ms
.
	`Ën
());

64 
	}
}

70 #[
‹¡
]

71 
â
 
	$‹¡_msg_­p_æow_cÚŒŞ_move_fÜw¬d
() {

72 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 5, 1, 
	`Ãw_¡Üage
());

73 
r
.
	`become_ÿndid©e
();

74 
r
.
	`become_Ëad”
();

77 
r
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_»¶iÿ‹
();

79 
_
 
š
 0..
r
.
max_šæight
 {

80 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

81 .
	`ex³ù
("");

82 
r
.
	`»ad_mes§ges
();

87 
‰
 
š
 2..
r
.
max_šæight
 {

89 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

90 
m
.
	`£t_šdex
(
‰
 
as
 
u64
);

91 
r
.
	`¡•
(
m
).
	`ex³ù
("");

92 
r
.
	`»ad_mes§ges
();

95 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

96 .
	`ex³ù
("");

97 
Ët
 
ms
 = 
r
.
	`»ad_mes§ges
();

98 
ms
.
	`Ën
() != 1 {

99 
·nic
!("#{}: m couÁ = {}, wªˆ1", 
‰
, 
ms
.
	`Ën
());

103 
as£¹
!(
r
.
´s
[&2].
šs
.
	`fuÎ
());

106 
i
 
š
 0..
‰
 {

107 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

108 
m
.
	`£t_šdex
(
i
 
as
 
u64
);

109 
r
.
	`¡•
(
m
).
	`ex³ù
("");

110 !
r
.
´s
[&2].
šs
.
	`fuÎ
() {

111 
·nic
!(

113 
‰
,

114 
r
.
´s
[&2].
šs
.
	`fuÎ
()

119 
	}
}

123 #[
‹¡
]

124 
â
 
	$‹¡_msg_­p_æow_cÚŒŞ_»cv_h—¹b—t
() {

125 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 5, 1, 
	`Ãw_¡Üage
());

126 
r
.
	`become_ÿndid©e
();

127 
r
.
	`become_Ëad”
();

130 
r
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_»¶iÿ‹
();

132 
_
 
š
 0..
r
.
max_šæight
 {

133 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

134 .
	`ex³ù
("");

135 
r
.
	`»ad_mes§ges
();

138 
‰
 
š
 1..5 {

139 !
r
.
´s
[&2].
šs
.
	`fuÎ
() {

140 
·nic
!(

142 
‰
,

143 
r
.
´s
[&2].
šs
.
	`fuÎ
()

148 
i
 
š
 0..
‰
 {

149 
r
.
	`¡•
(
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 0))

150 .
	`ex³ù
("");

151 
r
.
	`»ad_mes§ges
();

152 
r
.
´s
[&2].
šs
.
	`fuÎ
() {

153 
·nic
!(

155 
‰
,

156 
i
,

157 
r
.
´s
[&2].
šs
.
	`fuÎ
()

163 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

164 .
	`ex³ù
("");

165 
Ët
 
ms
 = 
r
.
	`»ad_mes§ges
();

166 
ms
.
	`Ën
() != 1 {

167 
·nic
!("#{}: f»¦Ù = 0, wªˆ1", 
‰
);

171 
i
 
š
 0..10 {

172 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

173 .
	`ex³ù
("");

174 
Ët
 
ms1
 = 
r
.
	`»ad_mes§ges
();

175 !
ms1
.
	`is_em±y
() {

176 
·nic
!("#{}.{}, ms1 should bem±y.", 
‰
, 
i
);

181 
r
.
	`¡•
(
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
, 0))

182 .
	`ex³ù
("");

183 
r
.
	`»ad_mes§ges
();

185 
	}
}

	@tests/raft/test_raft_paper.rs

28 
u£
 
	gsu³r
::
‹¡_¿á
::*;

29 
u£
 
	gkv´Ùo
::
”aápb
::*;

30 
u£
 
	gtikv
::
¿á
::*;

31 
u£
 
	gtikv
::
¿á
::
¡Üage
::
MemStÜage
;

32 
u£
 
	g´Ùobuf
::
R•—‹dF›ld
;

34 
pub
 
â
 
h¬d_¡©e
(
t
: 
u64
, 
c
: u64, 
v
: u64è-> 
H¬dS‹
 {

35 
Ët
 
mut
 
hs
 = 
H¬dS‹
::
Ãw
();

36 
	ghs
.
£t_‹rm
(
t
);

37 
	ghs
.
£t_comm™
(
c
);

38 
	ghs
.
£t_vÙe
(
v
);

39 
	ghs


42 
â
 
	$comm™_noİ_’Œy
(
r
: &
mut
 
IÁ”çû
, 
s
: &
MemStÜage
) {

43 
as£¹_eq
!(
r
.
¡©e
, 
S‹RŞe
::
L—d”
);

44 
r
.
	`bÿ¡_­³nd
();

46 
Ët
 
msgs
 = 
r
.
	`»ad_mes§ges
();

47 
m
 
š
 
msgs
 {

48 
as£¹_eq
!(
m
.
	`g‘_msg_ty³
(), 
Mes§geTy³
::
MsgAµ’d
);

49 
as£¹_eq
!(
m
.
	`g‘_’Œ›s
().
	`Ën
(), 1);

50 
as£¹
!(
m
.
	`g‘_’Œ›s
()[0].
	`g‘_d©a
().
	`is_em±y
());

51 
r
.
	`¡•
(
	`acû±_ªd_»¶y
(
m
)).
	`ex³ù
("");

54 
r
.
	`»ad_mes§ges
();

55 
s
.
	`wl
()

56 .
	`­³nd
(
r
.
¿á_log
.
	`un¡abË_’Œ›s
().
	`unw¿p_Ü
(&[]))

57 .
	`ex³ù
("");

58 
Ët
 
comm™‹d
 = 
r
.
¿á_log
.committed;

59 
r
.
¿á_log
.
	`­¶›d_to
(
comm™‹d
);

60 
	`Ët
 (
Ï¡_šdex
, 
Ï¡_‹rm
èğ(
r
.
¿á_log
.
	`Ï¡_šdex
(),„.¿á_log.
	`Ï¡_‹rm
());

61 
r
.
¿á_log
.
	`¡abË_to
(
Ï¡_šdex
, 
Ï¡_‹rm
);

62 
	}
}

64 
â
 
acû±_ªd_»¶y
(
m
: 
Mes§ge
) -> Message {

65 
as£¹_eq
!(
m
.
g‘_msg_ty³
(), 
	gMes§geTy³
::
MsgAµ’d
);

66 
Ët
 
mut
 
	g»¶y
 = 
Ãw_mes§ge
(
m
.
g‘_to
(), m.
g‘_äom
(), 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

67 
	g»¶y
.
£t_‹rm
(
m
.
g‘_‹rm
());

68 
	g»¶y
.
£t_šdex
(
m
.
g‘_šdex
(è+ m.
g‘_’Œ›s
().
Ën
(è
as
 
u64
);

69 
	g»¶y


72 #[
‹¡
]

73 
â
 
	$‹¡_fŞlow”_upd©e_‹rm_äom_mes§ge
() {

74 
	`‹¡_upd©e_‹rm_äom_mes§ge
(
S‹RŞe
::
FŞlow”
);

75 
	}
}

77 #[
‹¡
]

78 
â
 
	$‹¡_ÿndid©e_upd©e_‹rm_äom_mes§ge
() {

79 
	`‹¡_upd©e_‹rm_äom_mes§ge
(
S‹RŞe
::
Cªdid©e
);

80 
	}
}

82 #[
‹¡
]

83 
â
 
	$‹¡_Ëad”_upd©e_‹rm_äom_mes§ge
() {

84 
	`‹¡_upd©e_‹rm_äom_mes§ge
(
S‹RŞe
::
L—d”
);

85 
	}
}

92 
â
 
	$‹¡_upd©e_‹rm_äom_mes§ge
(
¡©e
: 
S‹RŞe
) {

93 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

94 
m©ch
 
¡©e
 {

95 
S‹RŞe
::
FŞlow”
 => 
r
.
	`become_fŞlow”
(1, 2),

96 
S‹RŞe
::
P»Cªdid©e
 => 
r
.
	`become_´e_ÿndid©e
(),

97 
S‹RŞe
::
Cªdid©e
 => 
r
.
	`become_ÿndid©e
(),

98 
S‹RŞe
::
L—d”
 => {

99 
r
.
	`become_ÿndid©e
();

100 
r
.
	`become_Ëad”
();

104 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(0, 0, 
Mes§geTy³
::
MsgAµ’d
, 0);

105 
m
.
	`£t_‹rm
(2);

106 
r
.
	`¡•
(
m
).
	`ex³ù
("");

108 
as£¹_eq
!(
r
.
‹rm
, 2);

109 
as£¹_eq
!(
r
.
¡©e
, 
S‹RŞe
::
FŞlow”
);

110 
	}
}

116 #[
‹¡
]

117 
â
 
	$‹¡_»jeù_¡®e_‹rm_mes§ge
() {

118 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

119 
Ët
 
·nic_befÜe_¡•_¡©e
 = 
Box
::
	`Ãw
(|
_
: &
Mes§ge
| {

120 
·nic
!("before step state function hook called unexpectedly")

122 
r
.
befÜe_¡•_¡©e
 = 
	`Some
(
·nic_befÜe_¡•_¡©e
);

123 
r
.
	`lßd_¡©e
(
	`h¬d_¡©e
(2, 0, 0));

125 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(0, 0, 
Mes§geTy³
::
MsgAµ’d
, 0);

126 
m
.
	`£t_‹rm
(
r
.
‹rm
 - 1);

127 
r
.
	`¡•
(
m
).
	`ex³ù
("");

128 
	}
}

132 #[
‹¡
]

133 
â
 
	$‹¡_¡¬t_as_fŞlow”
() {

134 
Ët
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

135 
as£¹_eq
!(
r
.
¡©e
, 
S‹RŞe
::
FŞlow”
);

136 
	}
}

142 #[
‹¡
]

143 
â
 
	$‹¡_Ëad”_bÿ¡_b—t
() {

145 
Ët
 
hi
 = 1;

146 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 
hi
, 
	`Ãw_¡Üage
());

147 
r
.
	`become_ÿndid©e
();

148 
r
.
	`become_Ëad”
();

149 
i
 
š
 0..10 {

150 
r
.
	`­³nd_’Œy
(&
mut
 [
	`em±y_’Œy
(0, 
i
 
as
 
u64
 + 1)]);

153 
_
 
š
 0..
hi
 {

154 
r
.
	`tick
();

157 
Ët
 
mut
 
msgs
 = 
r
.
	`»ad_mes§ges
();

158 
msgs
.
	`sÜt_by_key
(|
m
| 
fÜm©
!("{:?}", m));

160 
Ët
 
Ãw_mes§ge_ext
 = |
f
, 
to
| {

161 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(
f
, 
to
, 
Mes§geTy³
::
MsgH—¹b—t
, 0);

162 
m
.
	`£t_‹rm
(1);

163 
m
.
	`£t_comm™
(0);

164 
m


167 
Ët
 
ex³ù_msgs
 = 
vec
![
	`Ãw_mes§ge_ext
(1, 2),‚ew_message_ext(1, 3)];

168 
as£¹_eq
!(
msgs
, 
ex³ù_msgs
);

169 
	}
}

171 #[
‹¡
]

172 
â
 
	$‹¡_fŞlow”_¡¬t_–eùiÚ
() {

173 
	`‹¡_nÚËad”_¡¬t_–eùiÚ
(
S‹RŞe
::
FŞlow”
);

174 
	}
}

176 #[
‹¡
]

177 
â
 
	$‹¡_ÿndid©e_¡¬t_Ãw_–eùiÚ
() {

178 
	`‹¡_nÚËad”_¡¬t_–eùiÚ
(
S‹RŞe
::
Cªdid©e
);

179 
	}
}

191 
â
 
	$‹¡_nÚËad”_¡¬t_–eùiÚ
(
¡©e
: 
S‹RŞe
) {

193 
Ët
 
‘
 = 10;

194 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 
‘
, 1, 
	`Ãw_¡Üage
());

195 
m©ch
 
¡©e
 {

196 
S‹RŞe
::
FŞlow”
 => 
r
.
	`become_fŞlow”
(1, 2),

197 
S‹RŞe
::
Cªdid©e
 => 
r
.
	`become_ÿndid©e
(),

198 
_
 => 
·nic
!("Only‚on-leader„ole is‡ccepted."),

201 
_
 
š
 1..2 * 
‘
 {

202 
r
.
	`tick
();

205 
as£¹_eq
!(
r
.
‹rm
, 2);

206 
as£¹_eq
!(
r
.
¡©e
, 
S‹RŞe
::
Cªdid©e
);

207 
as£¹
!(
r
.
vÙes
[&r.
id
]);

208 
Ët
 
mut
 
msgs
 = 
r
.
	`»ad_mes§ges
();

209 
msgs
.
	`sÜt_by_key
(|
m
| 
fÜm©
!("{:?}", m));

210 
Ët
 
Ãw_mes§ge_ext
 = |
f
, 
to
| {

211 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(
f
, 
to
, 
Mes§geTy³
::
MsgReque¡VÙe
, 0);

212 
m
.
	`£t_‹rm
(2);

213 
m
.
	`£t_log_‹rm
(0);

214 
m
.
	`£t_šdex
(0);

215 
m


217 
Ët
 
ex³ù_msgs
 = 
vec
![
	`Ãw_mes§ge_ext
(1, 2),‚ew_message_ext(1, 3)];

218 
as£¹_eq
!(
msgs
, 
ex³ù_msgs
);

219 
	}
}

227 #[
‹¡
]

228 
â
 
	$‹¡_Ëad”_–eùiÚ_š_Úe_round_½c
() {

229 
Ët
 
mut
 
‹¡s
 = 
vec
![

231 (1, 
m­
!(), 
S‹RŞe
::
L—d”
),

232 (3, 
m­
!(2 => 
Œue
, 3 =>rue), 
S‹RŞe
::
L—d”
),

233 (3, 
m­
!(2 => 
Œue
), 
S‹RŞe
::
L—d”
),

236 
m­
!(2 => 
Œue
, 3 =>rue, 4 =>rue, 5 =>rue),

237 
S‹RŞe
::
L—d”
,

239 (5, 
m­
!(2 => 
Œue
, 3 =>rue, 4 =>rue), 
S‹RŞe
::
L—d”
),

240 (5, 
m­
!(2 => 
Œue
, 3 =>rue), 
S‹RŞe
::
L—d”
),

243 (3, 
m­
!(2 => 
çl£
, 3 => f®£), 
S‹RŞe
::
FŞlow”
),

246 
m­
!(2 => 
çl£
, 3 => false, 4 => false, 5 => false),

247 
S‹RŞe
::
FŞlow”
,

251 
m­
!(2 => 
Œue
, 3 => 
çl£
, 4 => false, 5 => false),

252 
S‹RŞe
::
FŞlow”
,

256 (3, 
m­
!(), 
S‹RŞe
::
Cªdid©e
),

257 (5, 
m­
!(2 => 
Œue
), 
S‹RŞe
::
Cªdid©e
),

258 (5, 
m­
!(2 => 
çl£
, 3 => f®£), 
S‹RŞe
::
Cªdid©e
),

259 (5, 
m­
!(), 
S‹RŞe
::
Cªdid©e
),

262 
i
, (
size
, 
vÙes
, 
¡©e
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

263 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, (1..
size
 
as
 
u64
 + 1).
	`cŞËù
(), 10, 1, 
	`Ãw_¡Üage
());

265 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)).
	`ex³ù
("");

266 
id
, 
vÙe
è
š
 
vÙes
 {

267 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(
id
, 1, 
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£
, 0);

268 
m
.
	`£t_»jeù
(!
vÙe
);

269 
r
.
	`¡•
(
m
).
	`ex³ù
("");

272 
r
.
¡©e
 != state {

273 
·nic
!("#{}: s‹ = {:?}, wªˆ{:?}", 
i
, 
r
.
¡©e
, state);

275 
r
.
‹rm
 != 1 {

276 
·nic
!("#{}:”m = {}, wªˆ{}", 
i
, 
r
.
‹rm
, 1);

279 
	}
}

284 #[
‹¡
]

285 
â
 
	$‹¡_fŞlow”_vÙe
() {

286 
Ët
 
mut
 
‹¡s
 = 
vec
![

287 (
INVALID_ID
, 1, 
çl£
),

288 (
INVALID_ID
, 2, 
çl£
),

289 (1, 1, 
çl£
),

290 (2, 2, 
çl£
),

291 (1, 2, 
Œue
),

292 (2, 1, 
Œue
),

295 
i
, (
vÙe
, 
nvÙe
, 
w»jeù
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

296 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

297 
r
.
	`lßd_¡©e
(
	`h¬d_¡©e
(1, 0, 
vÙe
));

299 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(
nvÙe
, 1, 
Mes§geTy³
::
MsgReque¡VÙe
, 0);

300 
m
.
	`£t_‹rm
(1);

301 
r
.
	`¡•
(
m
).
	`ex³ù
("");

303 
Ët
 
msgs
 = 
r
.
	`»ad_mes§ges
();

304 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(1, 
nvÙe
, 
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£
, 0);

305 
m
.
	`£t_‹rm
(1);

306 
m
.
	`£t_»jeù
(
w»jeù
);

307 
Ët
 
ex³ù_msgs
 = 
vec
![
m
];

308 
msgs
 !ğ
ex³ù_msgs
 {

309 
·nic
!("#{}: msg ğ{:?}, wªˆ{:?}", 
i
, 
msgs
, 
ex³ù_msgs
);

312 
	}
}

319 #[
‹¡
]

320 
â
 
	$‹¡_ÿndid©e_çÎback
() {

321 
Ët
 
Ãw_mes§ge_ext
 = |
f
, 
to
, 
‹rm
| {

322 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(
f
, 
to
, 
Mes§geTy³
::
MsgAµ’d
, 0);

323 
m
.
	`£t_‹rm
(
‹rm
);

324 
m


326 
Ët
 
mut
 
‹¡s
 = 
vec
![
	`Ãw_mes§ge_ext
(2, 1, 1),‚ew_message_ext(2, 1, 2)];

327 
i
, 
m
è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

328 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

329 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)).
	`ex³ù
("");

330 
as£¹_eq
!(
r
.
¡©e
, 
S‹RŞe
::
Cªdid©e
);

332 
Ët
 
‹rm
 = 
m
.
	`g‘_‹rm
();

333 
r
.
	`¡•
(
m
).
	`ex³ù
("");

335 
r
.
¡©e
 !ğ
S‹RŞe
::
FŞlow”
 {

336 
·nic
!(

338 
i
,

339 
r
.
¡©e
,

340 
S‹RŞe
::
FŞlow”


343 
r
.
‹rm
 !=erm {

344 
·nic
!("#{}:”m = {}, wªˆ{}", 
i
, 
r
.
‹rm
,erm);

347 
	}
}

349 #[
‹¡
]

350 
â
 
	$‹¡_fŞlow”_–eùiÚ_timeout_¿ndomized
() {

351 
	`‹¡_nÚ_Ëad”_–eùiÚ_timeout_¿ndomized
(
S‹RŞe
::
FŞlow”
);

352 
	}
}

354 #[
‹¡
]

355 
â
 
	$‹¡_ÿndid©e_–eùiÚ_timeout_¿ndomized
() {

356 
	`‹¡_nÚ_Ëad”_–eùiÚ_timeout_¿ndomized
(
S‹RŞe
::
Cªdid©e
);

357 
	}
}

362 
â
 
	$‹¡_nÚ_Ëad”_–eùiÚ_timeout_¿ndomized
(
¡©e
: 
S‹RŞe
) {

363 
Ët
 
‘
 = 10;

364 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 
‘
, 1, 
	`Ãw_¡Üage
());

365 
Ët
 
mut
 
timeouts
 = 
m­
!();

366 
_
 
š
 0..1000 * 
‘
 {

367 
Ët
 
‹rm
 = 
r
.term;

368 
m©ch
 
¡©e
 {

369 
S‹RŞe
::
FŞlow”
 => 
r
.
	`become_fŞlow”
(
‹rm
 + 1, 2),

370 
S‹RŞe
::
Cªdid©e
 => 
r
.
	`become_ÿndid©e
(),

371 
_
 => 
·nic
!("only‚on†eader state is‡ccepted!"),

374 
Ët
 
mut
 
time
 = 0;

375 
r
.
	`»ad_mes§ges
().
	`is_em±y
() {

376 
r
.
	`tick
();

377 
time
 += 1;

379 
timeouts
.
	`š£¹
(
time
, 
Œue
);

382 
as£¹
!(
timeouts
.
	`Ën
(è<ğ
‘
 &&imeouts.len() >=ƒt - 1);

383 
d
 
š
 
‘
 + 1..2 *ƒt {

384 
as£¹
!(
timeouts
[&
d
]);

386 
	}
}

388 #[
‹¡
]

389 
â
 
	$‹¡_fŞlow”_–eùiÚ_timeout_nÚcÚæiù
() {

390 
	`‹¡_nÚËad”s_–eùiÚ_timeout_nÚcÚfiù
(
S‹RŞe
::
FŞlow”
);

391 
	}
}

393 #[
‹¡
]

394 
â
 
	$‹¡_aÿndid©es_–eùiÚ_timeout_nÚcÚf
() {

395 
	`‹¡_nÚËad”s_–eùiÚ_timeout_nÚcÚfiù
(
S‹RŞe
::
Cªdid©e
);

396 
	}
}

402 
â
 
	$‹¡_nÚËad”s_–eùiÚ_timeout_nÚcÚfiù
(
¡©e
: 
S‹RŞe
) {

403 
Ët
 
‘
 = 10;

404 
Ët
 
size
 = 5;

405 
Ët
 
mut
 
rs
 = 
Vec
::
	`w™h_ÿ·c™y
(
size
);

406 
Ët
 
ids
: 
Vec
<
u64
> = (1..
size
 
as
 u64 + 1).
	`cŞËù
();

407 
id
 
š
 
ids
.
	`™”
().
	`ke
(
size
) {

408 
rs
.
	`push
(
	`Ãw_‹¡_¿á
(*
id
, 
ids
.
	`şÚe
(), 
‘
, 1, 
	`Ãw_¡Üage
()));

410 
Ët
 
mut
 
cÚæiùs
 = 0;

411 
_
 
š
 0..1000 {

412 
r
 
š
 &
mut
 
rs
 {

413 
Ët
 
‹rm
 = 
r
.term;

414 
m©ch
 
¡©e
 {

415 
S‹RŞe
::
FŞlow”
 => 
r
.
	`become_fŞlow”
(
‹rm
 + 1, 
INVALID_ID
),

416 
S‹RŞe
::
Cªdid©e
 => 
r
.
	`become_ÿndid©e
(),

417 
_
 => 
·nic
!("non†eader state isƒxpect!"),

421 
Ët
 
mut
 
timeout_num
 = 0;

422 
timeout_num
 == 0 {

423 
r
 
š
 &
mut
 
rs
 {

424 
r
.
	`tick
();

425 !
r
.
	`»ad_mes§ges
().
	`is_em±y
() {

426 
timeout_num
 += 1;

431 
timeout_num
 > 1 {

432 
cÚæiùs
 += 1;

436 
as£¹
!(
cÚæiùs
 
as
 
f64
 / 1000.0 <= 0.3);

437 
	}
}

447 #[
‹¡
]

448 
â
 
	$‹¡_Ëad”_¡¬t_»¶iÿtiÚ
() {

449 
Ët
 
s
 = 
	`Ãw_¡Üage
();

450 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
s
.
	`şÚe
());

451 
r
.
	`become_ÿndid©e
();

452 
r
.
	`become_Ëad”
();

453 
	`comm™_noİ_’Œy
(&
mut
 
r
, &
s
);

454 
Ët
 
li
 = 
r
.
¿á_log
.
	`Ï¡_šdex
();

456 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

457 .
	`ex³ù
("");

459 
as£¹_eq
!(
r
.
¿á_log
.
	`Ï¡_šdex
(), 
li
 + 1);

460 
as£¹_eq
!(
r
.
¿á_log
.
comm™‹d
, 
li
);

461 
Ët
 
mut
 
msgs
 = 
r
.
	`»ad_mes§ges
();

462 
msgs
.
	`sÜt_by_key
(|
m
| 
fÜm©
!("{:?}", m));

463 
Ët
 
w’ts
 = 
vec
![
	`Ãw_’Œy
(1, 
li
 + 1, 
SOME_DATA
)];

464 
Ët
 
Ãw_mes§ge_ext
 = |
f
, 
to
, 
’ts
| {

465 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(
f
, 
to
, 
Mes§geTy³
::
MsgAµ’d
, 0);

466 
m
.
	`£t_‹rm
(1);

467 
m
.
	`£t_šdex
(
li
);

468 
m
.
	`£t_log_‹rm
(1);

469 
m
.
	`£t_comm™
(
li
);

470 
m
.
	`£t_’Œ›s
(
R•—‹dF›ld
::
	`äom_vec
(
’ts
));

471 
m


473 
Ët
 
ex³ù_msgs
 = 
vec
![

474 
	`Ãw_mes§ge_ext
(1, 2, 
w’ts
.
	`şÚe
()),

475 
	`Ãw_mes§ge_ext
(1, 3, 
w’ts
.
	`şÚe
()),

477 
as£¹_eq
!(
msgs
, 
ex³ù_msgs
);

478 
as£¹_eq
!(
r
.
¿á_log
.
	`un¡abË_’Œ›s
(), 
	`Some
(&*
w’ts
));

479 
	}
}

488 #[
‹¡
]

489 
â
 
	$‹¡_Ëad”_comm™_’Œy
() {

490 
Ët
 
s
 = 
	`Ãw_¡Üage
();

491 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
s
.
	`şÚe
());

492 
r
.
	`become_ÿndid©e
();

493 
r
.
	`become_Ëad”
();

494 
	`comm™_noİ_’Œy
(&
mut
 
r
, &
s
);

495 
Ët
 
li
 = 
r
.
¿á_log
.
	`Ï¡_šdex
();

496 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

497 .
	`ex³ù
("");

499 
m
 
š
 
r
.
	`»ad_mes§ges
() {

500 
r
.
	`¡•
(
	`acû±_ªd_»¶y
(
m
)).
	`ex³ù
("");

503 
as£¹_eq
!(
r
.
¿á_log
.
comm™‹d
, 
li
 + 1);

504 
Ët
 
w’ts
 = 
vec
![
	`Ãw_’Œy
(1, 
li
 + 1, 
SOME_DATA
)];

505 
as£¹_eq
!(
r
.
¿á_log
.
	`Ãxt_’Œ›s
(), 
	`Some
(
w’ts
));

506 
Ët
 
mut
 
msgs
 = 
r
.
	`»ad_mes§ges
();

507 
msgs
.
	`sÜt_by_key
(|
m
| 
fÜm©
!("{:?}", m));

508 
i
, 
m
è
š
 
msgs
.
	`d¿š
(..).
	`’um”©e
() {

509 
as£¹_eq
!(
i
 
as
 
u64
 + 2, 
m
.
	`g‘_to
());

510 
as£¹_eq
!(
m
.
	`g‘_msg_ty³
(), 
Mes§geTy³
::
MsgAµ’d
);

511 
as£¹_eq
!(
m
.
	`g‘_comm™
(), 
li
 + 1);

513 
	}
}

518 #[
‹¡
]

519 
â
 
	$‹¡_Ëad”_acknowËdge_comm™
() {

520 
Ët
 
mut
 
‹¡s
 = 
vec
![

521 (1, 
m­
!(), 
Œue
),

522 (3, 
m­
!(), 
çl£
),

523 (3, 
m­
!(2 => 
Œue
),rue),

524 (3, 
m­
!(2 => 
Œue
, 3 =>rue),rue),

525 (5, 
m­
!(), 
çl£
),

526 (5, 
m­
!(2 => 
Œue
), 
çl£
),

527 (5, 
m­
!(2 => 
Œue
, 3 =>rue),rue),

528 (5, 
m­
!(2 => 
Œue
, 3 =>rue, 4 =>rue),rue),

529 (5, 
m­
!(2 => 
Œue
, 3 =>rue, 4 =>rue, 5 =>rue),rue),

531 
i
, (
size
, 
acû±Üs
, 
wack
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

532 
Ët
 
s
 = 
	`Ãw_¡Üage
();

533 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, (1..
size
 + 1).
	`cŞËù
(), 10, 1, 
s
.
	`şÚe
());

534 
r
.
	`become_ÿndid©e
();

535 
r
.
	`become_Ëad”
();

536 
	`comm™_noİ_’Œy
(&
mut
 
r
, &
s
);

537 
Ët
 
li
 = 
r
.
¿á_log
.
	`Ï¡_šdex
();

538 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

539 .
	`ex³ù
("");

541 
m
 
š
 
r
.
	`»ad_mes§ges
() {

542 
acû±Üs
.
	`cÚšs_key
(&
m
.
	`g‘_to
()) &&‡cceptors[&m.get_to()] {

543 
r
.
	`¡•
(
	`acû±_ªd_»¶y
(
m
)).
	`ex³ù
("");

547 
Ët
 
g
 = 
r
.
¿á_log
.
comm™‹d
 > 
li
;

548 
g
 ^ 
wack
 {

549 
·nic
!("#{}:‡ck comm™ = {}, wªˆ{}", 
i
, 
g
, 
wack
);

552 
	}
}

559 #[
‹¡
]

560 
â
 
	$‹¡_Ëad”_comm™_´eûdšg_’Œ›s
() {

561 
Ët
 
mut
 
‹¡s
 = 
vec
![

562 
vec
![],

563 
vec
![
	`em±y_’Œy
(2, 1)],

564 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)],

565 
vec
![
	`em±y_’Œy
(1, 1)],

568 
i
, 
mut
 
‰
è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

569 
Ët
 
s
 = 
	`Ãw_¡Üage
();

570 
s
.
	`wl
().
	`­³nd
(&
‰
).
	`ex³ù
("");

571 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
s
);

572 
r
.
	`lßd_¡©e
(
	`h¬d_¡©e
(2, 0, 0));

573 
r
.
	`become_ÿndid©e
();

574 
r
.
	`become_Ëad”
();

575 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

576 .
	`ex³ù
("");

578 
m
 
š
 
r
.
	`»ad_mes§ges
() {

579 
r
.
	`¡•
(
	`acû±_ªd_»¶y
(
m
)).
	`ex³ù
("");

582 
Ët
 
li
 = 
‰
.
	`Ën
(è
as
 
u64
;

583 
‰
.
	`­³nd
(&
mut
 
vec
![

584 
	`em±y_’Œy
(3, 
li
 + 1),

585 
	`Ãw_’Œy
(3, 
li
 + 2, 
SOME_DATA
),

587 
Ët
 
g
 = 
r
.
¿á_log
.
	`Ãxt_’Œ›s
();

588 
Ët
 
wg
 = 
	`Some
(
‰
);

589 
g
 !ğ
wg
 {

590 
·nic
!("#{}:ƒÁ ğ{:?}, wªˆ{:?}", 
i
, 
g
, 
wg
);

593 
	}
}

598 #[
‹¡
]

599 
â
 
	$‹¡_fŞlow”_comm™_’Œy
() {

600 
Ët
 
mut
 
‹¡s
 = 
vec
![

601 (
vec
![
	`Ãw_’Œy
(1, 1, 
SOME_DATA
)], 1),

603 
vec
![

604 
	`Ãw_’Œy
(1, 1, 
SOME_DATA
),

605 
	`Ãw_’Œy
(1, 2, 
	`Some
("somedata2")),

610 
vec
![

611 
	`Ãw_’Œy
(1, 1, 
	`Some
("somedata2")),

612 
	`Ãw_’Œy
(1, 2, 
SOME_DATA
),

617 
vec
![

618 
	`Ãw_’Œy
(1, 1, 
SOME_DATA
),

619 
	`Ãw_’Œy
(1, 2, 
	`Some
("somedata2")),

625 
i
, (
’ts
, 
comm™
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

626 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

627 
r
.
	`become_fŞlow”
(1, 2);

629 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’d
, 0);

630 
m
.
	`£t_‹rm
(1);

631 
m
.
	`£t_comm™
(
comm™
);

632 
m
.
	`£t_’Œ›s
(
R•—‹dF›ld
::
	`äom_vec
(
’ts
.
	`şÚe
()));

633 
r
.
	`¡•
(
m
).
	`ex³ù
("");

635 
r
.
¿á_log
.
comm™‹d
 !ğ
comm™
 {

636 
·nic
!(

638 
i
,

639 
r
.
¿á_log
.
comm™‹d
,

640 
comm™


643 
Ët
 
w’ts
 = 
	`Some
(
’ts
[..
comm™
 
as
 
usize
].
	`to_vec
());

644 
Ët
 
g
 = 
r
.
¿á_log
.
	`Ãxt_’Œ›s
();

645 
g
 !ğ
w’ts
 {

646 
·nic
!("#{}:‚ext_’t ğ{:?}, wªˆ{:?}", 
i
, 
g
, 
w’ts
);

649 
	}
}

656 #[
‹¡
]

657 
â
 
	$‹¡_fŞlow”_check_msg_­³nd
() {

658 
Ët
 
’ts
 = 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)];

659 
Ët
 
mut
 
‹¡s
 = 
vec
![

661 (0, 0, 1, 
çl£
, 0),

662 (
’ts
[0].
	`g‘_‹rm
(),ƒÁs[0].
	`g‘_šdex
(), 1, 
çl£
, 0),

664 (
’ts
[1].
	`g‘_‹rm
(),ƒÁs[1].
	`g‘_šdex
(), 2, 
çl£
, 0),

668 
’ts
[0].
	`g‘_‹rm
(),

669 
’ts
[1].
	`g‘_šdex
(),

670 
’ts
[1].
	`g‘_šdex
(),

671 
Œue
,

676 
’ts
[1].
	`g‘_‹rm
() + 1,

677 
’ts
[1].
	`g‘_šdex
() + 1,

678 
’ts
[1].
	`g‘_šdex
() + 1,

679 
Œue
,

683 
i
, (
‹rm
, 
šdex
, 
wšdex
, 
w»jeù
, 
w»jeù_hšt
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

684 
Ët
 
s
 = 
	`Ãw_¡Üage
();

685 
s
.
	`wl
().
	`­³nd
(&
’ts
).
	`ex³ù
("");

686 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
s
);

687 
r
.
	`lßd_¡©e
(
	`h¬d_¡©e
(0, 1, 0));

688 
r
.
	`become_fŞlow”
(2, 2);

690 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’d
, 0);

691 
m
.
	`£t_‹rm
(2);

692 
m
.
	`£t_log_‹rm
(
‹rm
);

693 
m
.
	`£t_šdex
(
šdex
);

694 
r
.
	`¡•
(
m
).
	`ex³ù
("");

696 
Ët
 
msgs
 = 
r
.
	`»ad_mes§ges
();

697 
Ët
 
mut
 
wm
 = 
	`Ãw_mes§ge
(1, 2, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

698 
wm
.
	`£t_‹rm
(2);

699 
wm
.
	`£t_šdex
(
wšdex
);

700 
w»jeù
 {

701 
wm
.
	`£t_»jeù
(
w»jeù
);

702 
wm
.
	`£t_»jeù_hšt
(
w»jeù_hšt
);

704 
Ët
 
ex³ù_msgs
 = 
vec
![
wm
];

705 
msgs
 !ğ
ex³ù_msgs
 {

706 
·nic
!("#{}: msg ğ{:?}, wªˆ{:?}", 
i
, 
msgs
, 
ex³ù_msgs
);

709 
	}
}

716 #[
‹¡
]

717 
â
 
	$‹¡_fŞlow”_­³nd_’Œ›s
() {

718 
Ët
 
mut
 
‹¡s
 = 
vec
![

722 
vec
![
	`em±y_’Œy
(3, 3)],

723 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2),ƒmpty_entry(3, 3)],

724 
vec
![
	`em±y_’Œy
(3, 3)],

730 
vec
![
	`em±y_’Œy
(3, 2),ƒmpty_entry(4, 3)],

731 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(3, 2),ƒmpty_entry(4, 3)],

732 
vec
![
	`em±y_’Œy
(3, 2),ƒmpty_entry(4, 3)],

738 
vec
![
	`em±y_’Œy
(1, 1)],

739 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)],

740 
vec
![],

745 
vec
![
	`em±y_’Œy
(3, 1)],

746 
vec
![
	`em±y_’Œy
(3, 1)],

747 
vec
![
	`em±y_’Œy
(3, 1)],

750 
i
, (
šdex
, 
‹rm
, 
’ts
, 
w’ts
, 
wun¡abË
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

751 
Ët
 
s
 = 
	`Ãw_¡Üage
();

752 
s
.
	`wl
()

753 .
	`­³nd
(&[
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)])

754 .
	`ex³ù
("");

755 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
s
);

756 
r
.
	`become_fŞlow”
(2, 2);

758 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’d
, 0);

759 
m
.
	`£t_‹rm
(2);

760 
m
.
	`£t_log_‹rm
(
‹rm
);

761 
m
.
	`£t_šdex
(
šdex
);

762 
m
.
	`£t_’Œ›s
(
R•—‹dF›ld
::
	`äom_vec
(
’ts
));

763 
r
.
	`¡•
(
m
).
	`ex³ù
("");

765 
Ët
 
g
 = 
r
.
¿á_log
.
	`®l_’Œ›s
();

766 
g
 !ğ
w’ts
 {

767 
·nic
!("#{}:ƒÁ ğ{:?}, wªˆ{:?}", 
i
, 
g
, 
w’ts
);

769 
Ët
 
g
 = 
r
.
¿á_log
.
	`un¡abË_’Œ›s
();

770 
Ët
 
wun¡abË
 = wun¡abË.
	`is_em±y
() {

771 
NÚe


773 
	`Some
(&*
wun¡abË
)

775 
g
 !ğ
wun¡abË
 {

776 
·nic
!("#{}: un¡abË_’Œ› ğ{:?}, wªˆ{:?}", 
i
, 
g
, 
wun¡abË
);

779 
	}
}

784 #[
‹¡
]

785 
â
 
	$‹¡_Ëad”_sync_fŞlow”_log
() {

786 
Ët
 
’ts
 = 
vec
![

787 
	`em±y_’Œy
(0, 0),

788 
	`em±y_’Œy
(1, 1),

789 
	`em±y_’Œy
(1, 2),

790 
	`em±y_’Œy
(1, 3),

791 
	`em±y_’Œy
(4, 4),

792 
	`em±y_’Œy
(4, 5),

793 
	`em±y_’Œy
(5, 6),

794 
	`em±y_’Œy
(5, 7),

795 
	`em±y_’Œy
(6, 8),

796 
	`em±y_’Œy
(6, 9),

797 
	`em±y_’Œy
(6, 10),

799 
Ët
 
‹rm
 = 8u64;

800 
Ët
 
mut
 
‹¡s
 = 
vec
![

801 
vec
![

802 
	`em±y_’Œy
(0, 0),

803 
	`em±y_’Œy
(1, 1),

804 
	`em±y_’Œy
(1, 2),

805 
	`em±y_’Œy
(1, 3),

806 
	`em±y_’Œy
(4, 4),

807 
	`em±y_’Œy
(4, 5),

808 
	`em±y_’Œy
(5, 6),

809 
	`em±y_’Œy
(5, 7),

810 
	`em±y_’Œy
(6, 8),

811 
	`em±y_’Œy
(6, 9),

813 
vec
![

814 
	`em±y_’Œy
(0, 0),

815 
	`em±y_’Œy
(1, 1),

816 
	`em±y_’Œy
(1, 2),

817 
	`em±y_’Œy
(1, 3),

818 
	`em±y_’Œy
(4, 4),

820 
vec
![

821 
	`em±y_’Œy
(0, 0),

822 
	`em±y_’Œy
(1, 1),

823 
	`em±y_’Œy
(1, 2),

824 
	`em±y_’Œy
(1, 3),

825 
	`em±y_’Œy
(4, 4),

826 
	`em±y_’Œy
(4, 5),

827 
	`em±y_’Œy
(5, 6),

828 
	`em±y_’Œy
(5, 7),

829 
	`em±y_’Œy
(6, 8),

830 
	`em±y_’Œy
(6, 9),

831 
	`em±y_’Œy
(6, 10),

832 
	`em±y_’Œy
(6, 11),

834 
vec
![

835 
	`em±y_’Œy
(0, 0),

836 
	`em±y_’Œy
(1, 1),

837 
	`em±y_’Œy
(1, 2),

838 
	`em±y_’Œy
(1, 3),

839 
	`em±y_’Œy
(4, 4),

840 
	`em±y_’Œy
(4, 5),

841 
	`em±y_’Œy
(5, 6),

842 
	`em±y_’Œy
(5, 7),

843 
	`em±y_’Œy
(6, 8),

844 
	`em±y_’Œy
(6, 9),

845 
	`em±y_’Œy
(6, 10),

846 
	`em±y_’Œy
(7, 11),

847 
	`em±y_’Œy
(7, 12),

849 
vec
![

850 
	`em±y_’Œy
(0, 0),

851 
	`em±y_’Œy
(1, 1),

852 
	`em±y_’Œy
(1, 2),

853 
	`em±y_’Œy
(1, 3),

854 
	`em±y_’Œy
(4, 4),

855 
	`em±y_’Œy
(4, 5),

856 
	`em±y_’Œy
(4, 6),

857 
	`em±y_’Œy
(4, 7),

859 
vec
![

860 
	`em±y_’Œy
(0, 0),

861 
	`em±y_’Œy
(1, 1),

862 
	`em±y_’Œy
(1, 2),

863 
	`em±y_’Œy
(1, 3),

864 
	`em±y_’Œy
(2, 4),

865 
	`em±y_’Œy
(2, 5),

866 
	`em±y_’Œy
(2, 6),

867 
	`em±y_’Œy
(3, 7),

868 
	`em±y_’Œy
(3, 8),

869 
	`em±y_’Œy
(3, 9),

870 
	`em±y_’Œy
(3, 10),

871 
	`em±y_’Œy
(3, 11),

874 
i
, 
‰
è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

875 
Ët
 
Ëad_¡Üe
 = 
	`Ãw_¡Üage
();

876 
Ëad_¡Üe
.
	`wl
().
	`­³nd
(&
’ts
).
	`ex³ù
("");

877 
Ët
 
mut
 
Ëad
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
Ëad_¡Üe
);

878 
Ët
 
Ï¡_šdex
 = 
Ëad
.
¿á_log
.
	`Ï¡_šdex
();

879 
Ëad
.
	`lßd_¡©e
(
	`h¬d_¡©e
(
‹rm
, 
Ï¡_šdex
, 0));

880 
Ët
 
fŞlow”_¡Üe
 = 
	`Ãw_¡Üage
();

881 
fŞlow”_¡Üe
.
	`wl
().
	`­³nd
(&
‰
).
	`ex³ù
("");

882 
Ët
 
mut
 
fŞlow”
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2, 3], 10, 1, 
fŞlow”_¡Üe
);

883 
fŞlow”
.
	`lßd_¡©e
(
	`h¬d_¡©e
(
‹rm
 - 1, 0, 0));

887 
Ët
 
mut
 
n
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
Ëad
), Some(
fŞlow”
), 
NOP_STEPPER
]);

888 
n
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

891 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(3, 1, 
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£
, 0);

892 
m
.
	`£t_‹rm
(
‹rm
 + 1);

893 
n
.
	`£nd
(
vec
![
m
]);

895 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 0);

896 
m
.
	`£t_’Œ›s
(
R•—‹dF›ld
::
	`äom_vec
(
vec
![
EÁry
::
	`Ãw
()]));

897 
n
.
	`£nd
(
vec
![
m
]);

898 
Ët
 
Ëad_¡r
 = 
	`Éß
(&
n
.
³”s
[&1].
¿á_log
);

899 
Ët
 
fŞlow”_¡r
 = 
	`Éß
(&
n
.
³”s
[&2].
¿á_log
);

900 
Ëad_¡r
 !ğ
fŞlow”_¡r
 {

901 
·nic
!(

903 
i
,

904 
Ëad_¡r
,

905 
fŞlow”_¡r


909 
	}
}

914 #[
‹¡
]

915 
â
 
	$‹¡_vÙe_»que¡
() {

916 
Ët
 
mut
 
‹¡s
 = 
vec
![

917 (
vec
![
	`em±y_’Œy
(1, 1)], 2),

918 (
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)], 3),

920 
j
, (
’ts
, 
w‹rm
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

921 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

922 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’d
, 0);

923 
m
.
	`£t_‹rm
(
w‹rm
 - 1);

924 
m
.
	`£t_log_‹rm
(0);

925 
m
.
	`£t_šdex
(0);

926 
m
.
	`£t_’Œ›s
(
R•—‹dF›ld
::
	`äom_vec
(
’ts
.
	`şÚe
()));

927 
r
.
	`¡•
(
m
).
	`ex³ù
("");

928 
r
.
	`»ad_mes§ges
();

930 
_
 
š
 1..
r
.
	`g‘_–eùiÚ_timeout
() * 2 {

931 
r
.
	`tick_–eùiÚ
();

934 
Ët
 
mut
 
msgs
 = 
r
.
	`»ad_mes§ges
();

935 
msgs
.
	`sÜt_by_key
(|
m
| 
fÜm©
!("{:?}", m));

936 
msgs
.
	`Ën
() != 2 {

937 
·nic
!("#{}: msg couÁ = {}, wªˆ2", 
j
, 
msgs
.
	`Ën
());

939 
i
, 
m
è
š
 
msgs
.
	`™”
().
	`’um”©e
() {

940 
m
.
	`g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgReque¡VÙe
 {

941 
·nic
!(

943 
j
,

944 
i
,

945 
m
.
	`g‘_msg_ty³
(),

946 
Mes§geTy³
::
MsgReque¡VÙe


949 
m
.
	`g‘_to
(è!ğ
i
 
as
 
u64
 + 2 {

950 
·nic
!("#{}.{}:Øğ{}, wªˆ{}", 
j
, 
i
, 
m
.
	`g‘_to
(), i + 2);

952 
m
.
	`g‘_‹rm
(è!ğ
w‹rm
 {

953 
·nic
!("#{}.{}:”m = {}, wªˆ{}", 
j
, 
i
, 
m
.
	`g‘_‹rm
(), 
w‹rm
);

955 
Ët
 
wšdex
 = 
’ts
.
	`Ï¡
().
	`unw¿p
().
	`g‘_šdex
();

956 
Ët
 
wlog‹rm
 = 
’ts
.
	`Ï¡
().
	`unw¿p
().
	`g‘_‹rm
();

957 
m
.
	`g‘_šdex
(è!ğ
wšdex
 {

958 
·nic
!("#{}.{}: index = {}, wªˆ{}", 
j
, 
i
, 
m
.
	`g‘_šdex
(), 
wšdex
);

960 
m
.
	`g‘_log_‹rm
(è!ğ
wlog‹rm
 {

961 
·nic
!(

963 
j
,

964 
i
,

965 
m
.
	`g‘_log_‹rm
(),

966 
wlog‹rm


971 
	}
}

976 #[
‹¡
]

977 
â
 
	$‹¡_vÙ”
() {

978 
Ët
 
mut
 
‹¡s
 = 
vec
![

980 (
vec
![
	`em±y_’Œy
(1, 1)], 1, 1, 
çl£
),

981 (
vec
![
	`em±y_’Œy
(1, 1)], 1, 2, 
çl£
),

982 (
vec
![
	`em±y_’Œy
(1, 1),ƒm±y_’Œy(1, 2)], 1, 1, 
Œue
),

984 (
vec
![
	`em±y_’Œy
(1, 1)], 2, 1, 
çl£
),

985 (
vec
![
	`em±y_’Œy
(1, 1)], 2, 2, 
çl£
),

986 (
vec
![
	`em±y_’Œy
(1, 1),ƒm±y_’Œy(1, 2)], 2, 1, 
çl£
),

988 (
vec
![
	`em±y_’Œy
(2, 1)], 1, 1, 
Œue
),

989 (
vec
![
	`em±y_’Œy
(2, 1)], 1, 2, 
Œue
),

990 (
vec
![
	`em±y_’Œy
(2, 1),ƒm±y_’Œy(1, 2)], 1, 1, 
Œue
),

992 
i
, (
’ts
, 
log_‹rm
, 
šdex
, 
w»jeù
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

993 
Ët
 
s
 = 
	`Ãw_¡Üage
();

994 
s
.
	`wl
().
	`­³nd
(&
’ts
).
	`ex³ù
("");

995 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
s
);

997 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgReque¡VÙe
, 0);

998 
m
.
	`£t_‹rm
(3);

999 
m
.
	`£t_log_‹rm
(
log_‹rm
);

1000 
m
.
	`£t_šdex
(
šdex
);

1001 
r
.
	`¡•
(
m
).
	`ex³ù
("");

1003 
Ët
 
msgs
 = 
r
.
	`»ad_mes§ges
();

1004 
msgs
.
	`Ën
() != 1 {

1005 
·nic
!("#{}: msg couÁ = {}, wªˆ{}", 
i
, 
msgs
.
	`Ën
(), 1);

1007 
msgs
[0].
	`g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£
 {

1008 
·nic
!(

1010 
i
,

1011 
msgs
[0].
	`g‘_msg_ty³
(),

1012 
Mes§geTy³
::
MsgReque¡VÙeRe¥Ú£


1015 
msgs
[0].
	`g‘_»jeù
(è!ğ
w»jeù
 {

1016 
·nic
!(

1018 
i
,

1019 
msgs
[0].
	`g‘_»jeù
(),

1020 
w»jeù


1024 
	}
}

1029 #[
‹¡
]

1030 
â
 
	$‹¡_Ëad”_Úly_comm™s_log_äom_cu¼’t_‹rm
() {

1031 
Ët
 
’ts
 = 
vec
![
	`em±y_’Œy
(1, 1),ƒmpty_entry(2, 2)];

1032 
Ët
 
mut
 
‹¡s
 = 
vec
![

1039 
i
, (
šdex
, 
wcomm™
)è
š
 
‹¡s
.
	`d¿š
(..).
	`’um”©e
() {

1040 
Ët
 
¡Üe
 = 
	`Ãw_¡Üage
();

1041 
¡Üe
.
	`wl
().
	`­³nd
(&
’ts
).
	`ex³ù
("");

1042 
Ët
 
mut
 
r
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
¡Üe
);

1043 
r
.
	`lßd_¡©e
(
	`h¬d_¡©e
(2, 0, 0));

1045 
r
.
	`become_ÿndid©e
();

1046 
r
.
	`become_Ëad”
();

1047 
r
.
	`»ad_mes§ges
();

1049 
r
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

1050 .
	`ex³ù
("");

1052 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

1053 
m
.
	`£t_‹rm
(
r
.
‹rm
);

1054 
m
.
	`£t_šdex
(
šdex
);

1055 
r
.
	`¡•
(
m
).
	`ex³ù
("");

1056 
r
.
¿á_log
.
comm™‹d
 !ğ
wcomm™
 {

1057 
·nic
!(

1059 
i
,

1060 
r
.
¿á_log
.
comm™‹d
,

1061 
wcomm™


1065 
	}
}

	@tests/raft/test_raft_snap.rs

28 
u£
 
	gsu³r
::
‹¡_¿á
::*;

29 
u£
 
	gkv´Ùo
::
”aápb
::*;

31 
â
 
‹¡šg_¢­
(è-> 
	gSÇpshÙ
 {

32 
Ãw_¢­shÙ
(11, 11, 
vec
![1, 2])

36 #[
‹¡
]

37 
â
 
	$‹¡_£ndšg_¢­shÙ_£t_³ndšg_¢­shÙ
() {

38 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1], 10, 1, 
	`Ãw_¡Üage
());

39 
sm
.
	`»¡Üe
(
	`‹¡šg_¢­
());

41 
sm
.
	`become_ÿndid©e
();

42 
sm
.
	`become_Ëad”
();

46 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
Ãxt_idx
 = sm.
¿á_log
.
	`fœ¡_šdex
();

48 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

49 
m
.
	`£t_šdex
(
sm
.
´s
[&2].
Ãxt_idx
 - 1);

50 
m
.
	`£t_»jeù
(
Œue
);

51 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

52 
as£¹_eq
!(
sm
.
´s
[&2].
³ndšg_¢­shÙ
, 11);

53 
	}
}

55 #[
‹¡
]

56 
â
 
	$‹¡_³ndšg_¢­shÙ_·u£_»¶iÿtiÚ
() {

57 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

58 
sm
.
	`»¡Üe
(
	`‹¡šg_¢­
());

60 
sm
.
	`become_ÿndid©e
();

61 
sm
.
	`become_Ëad”
();

63 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_¢­shÙ
(11);

65 
sm
.
	`¡•
(
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 1))

66 .
	`ex³ù
("");

67 
Ët
 
msgs
 = 
sm
.
	`»ad_mes§ges
();

68 
as£¹
!(
msgs
.
	`is_em±y
());

69 
	}
}

71 #[
‹¡
]

72 
â
 
	$‹¡_¢­shÙ_çu»
() {

73 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

74 
sm
.
	`»¡Üe
(
	`‹¡šg_¢­
());

76 
sm
.
	`become_ÿndid©e
();

77 
sm
.
	`become_Ëad”
();

79 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
Ãxt_idx
 = 1;

80 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_¢­shÙ
(11);

82 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgSÇpStus
, 0);

83 
m
.
	`£t_»jeù
(
Œue
);

84 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

85 
as£¹_eq
!(
sm
.
´s
[&2].
³ndšg_¢­shÙ
, 0);

86 
as£¹_eq
!(
sm
.
´s
[&2].
Ãxt_idx
, 1);

87 
as£¹
!(
sm
.
´s
[&2].
·u£d
);

88 
	}
}

90 #[
‹¡
]

91 
â
 
	$‹¡_¢­shÙ_sucûed
() {

92 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

93 
sm
.
	`»¡Üe
(
	`‹¡šg_¢­
());

95 
sm
.
	`become_ÿndid©e
();

96 
sm
.
	`become_Ëad”
();

98 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
Ãxt_idx
 = 1;

99 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_¢­shÙ
(11);

101 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgSÇpStus
, 0);

102 
m
.
	`£t_»jeù
(
çl£
);

103 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

104 
as£¹_eq
!(
sm
.
´s
[&2].
³ndšg_¢­shÙ
, 0);

105 
as£¹_eq
!(
sm
.
´s
[&2].
Ãxt_idx
, 12);

106 
as£¹
!(
sm
.
´s
[&2].
·u£d
);

107 
	}
}

109 #[
‹¡
]

110 
â
 
	$‹¡_¢­shÙ_abÜt
() {

111 
Ët
 
mut
 
sm
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2], 10, 1, 
	`Ãw_¡Üage
());

112 
sm
.
	`»¡Üe
(
	`‹¡šg_¢­
());

114 
sm
.
	`become_ÿndid©e
();

115 
sm
.
	`become_Ëad”
();

117 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
Ãxt_idx
 = 1;

118 
sm
.
´s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`become_¢­shÙ
(11);

120 
Ët
 
mut
 
m
 = 
	`Ãw_mes§ge
(2, 1, 
Mes§geTy³
::
MsgAµ’dRe¥Ú£
, 0);

121 
m
.
	`£t_šdex
(11);

124 
sm
.
	`¡•
(
m
).
	`ex³ù
("");

125 
as£¹_eq
!(
sm
.
´s
[&2].
³ndšg_¢­shÙ
, 0);

126 
as£¹_eq
!(
sm
.
´s
[&2].
Ãxt_idx
, 12);

127 
	}
}

	@tests/raft/test_raw_node.rs

28 
u£
 
	g¡d
::
ûÎ
::
RefC–l
;

29 
u£
 
	g¡d
::
rc
::
Rc
;

30 
u£
 
	gkv´Ùo
::
”aápb
::*;

31 
u£
 
	g´Ùobuf
::{
£lf
, 
	gPrÙobufEnum
};

32 
u£
 
	gtikv
::
¿á
::*;

33 
u£
 
	gtikv
::
¿á
::
¡Üage
::
MemStÜage
;

34 
u£
 
	gsu³r
::
‹¡_¿á
::*;

35 
u£
 
	gsu³r
::
‹¡_¿á_·³r
::*;

37 
â
 
Ãw_³”
(
id
: 
u64
è-> 
P“r
 {

38 
P“r
 {

39 
id
: id,

40 ..
	gDeçuÉ
::()

44 
â
 
’Œy
(
t
: 
EÁryTy³
, 
‹rm
: 
u64
, 
i
: u64, 
d©a
: 
O±iÚ
<
Vec
<
u8
>>è-> 
EÁry
 {

45 
Ët
 
mut
 
e
 = 
EÁry
::
Ãw
();

46 
	ge
.
£t_šdex
(
i
);

47 
	ge
.
£t_‹rm
(
‹rm
);

48 
Ët
 
Some
(
d
èğ
d©a
 {

49 
e
.
£t_d©a
(
d
);

51 
	ge
.
£t_’Œy_ty³
(
t
);

52 
	ge


55 
â
 
cÚf_chªge
(
t
: 
CÚfChªgeTy³
, 
node_id
: 
u64
è-> 
CÚfChªge
 {

56 
Ët
 
mut
 
cc
 = 
CÚfChªge
::
Ãw
();

57 
	gcc
.
£t_chªge_ty³
(
t
);

58 
	gcc
.
£t_node_id
(
node_id
);

59 
	gcc


62 
â
 
Ãw_»ady
(

63 
ss
: 
O±iÚ
<
SoáS‹
>,

64 
hs
: 
O±iÚ
<
H¬dS‹
>,

65 
’Œ›s
: 
Vec
<
EÁry
>,

66 
comm™‹d_’Œ›s
: 
Vec
<
EÁry
>,

67 
mu¡_sync
: 
boŞ
,

68 è-> 
	gR—dy
 {

69 
	gR—dy
 {

70 
	gss
: 
ss
,

71 
	ghs
: 
hs
,

72 
	g’Œ›s
: 
’Œ›s
,

73 
	gcomm™‹d_’Œ›s
: 
Some
(
comm™‹d_’Œ›s
),

74 
	gmu¡_sync
: 
mu¡_sync
,

75 ..
	gDeçuÉ
::()

79 
â
 
Ãw_¿w_node
(

80 
id
: 
u64
,

81 
³”s
: 
Vec
<
u64
>,

82 
–eùiÚ
: 
usize
,

83 
h—¹b—t
: 
usize
,

84 
¡Üage
: 
MemStÜage
,

85 
³”_nodes
: 
Vec
<
P“r
>,

86 è-> 
	gRawNode
<
	gMemStÜage
> {

87 
	gRawNode
::
Ãw
(

88 &
Ãw_‹¡_cÚfig
(
id
, 
³”s
, 
–eùiÚ
, 
h—¹b—t
),

89 
¡Üage
,

90 &
³”_nodes
,

91 ).
unw¿p
()

95 #[
‹¡
]

96 
â
 
	$‹¡_¿w_node_¡•
() {

97 
msg_t
 
š
 
Mes§geTy³
::
	`v®ues
() {

98 
Ët
 
mut
 
¿w_node
 = 
	`Ãw_¿w_node
(1, 
vec
![], 10, 1, 
	`Ãw_¡Üage
(), vec![
	`Ãw_³”
(1)]);

99 
Ët
 
»s
 = 
¿w_node
.
	`¡•
(
	`Ãw_mes§ge
(0, 0, *
msg_t
, 0));

101 
vec
![

102 
Mes§geTy³
::
MsgB—t
,

103 
Mes§geTy³
::
MsgHup
,

104 
Mes§geTy³
::
MsgUÄ—chabË
,

105 
Mes§geTy³
::
MsgSÇpStus
,

106 ].
	`cÚšs
(
msg_t
)

108 
as£¹_eq
!(
»s
, 
	`E¼
(
E¼Ü
::
S‹pLoÿlMsg
));

111 
	}
}

116 #[
‹¡
]

117 
â
 
	$‹¡_¿w_node_»ad_šdex_to_Şd_Ëad”
() {

118 
Ët
 
r1
 = 
	`Ãw_‹¡_¿á
(1, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

119 
Ët
 
r2
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

120 
Ët
 
r3
 = 
	`Ãw_‹¡_¿á
(3, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

122 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
r1
), Some(
r2
), Some(
r3
)]);

125 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

126 
Ët
 
mut
 
‹¡_’Œ›s
 = 
EÁry
::
	`Ãw
();

127 
‹¡_’Œ›s
.
	`£t_d©a
(
b
"‹¡d©a".
	`to_vec
());

130 
Ët
 
_
 = 
Á
.
³”s
.
	`g‘_mut
(&2).
	`unw¿p
().
	`¡•
(
	`Ãw_mes§ge_w™h_’Œ›s
(

133 
Mes§geTy³
::
MsgR—dIndex
,

134 
vec
![
‹¡_’Œ›s
.
	`şÚe
()],

138 
as£¹_eq
!(
Á
.
³”s
[&2].
msgs
.
	`Ën
(), 1);

139 
Ët
 
»ad_šdex_msg1
 =

140 
	`Ãw_mes§ge_w™h_’Œ›s
(2, 1, 
Mes§geTy³
::
MsgR—dIndex
, 
vec
![
‹¡_’Œ›s
.
	`şÚe
()]);

141 
as£¹_eq
!(
»ad_šdex_msg1
, 
Á
.
³”s
[&2].
msgs
[0]);

144 
Ët
 
_
 = 
Á
.
³”s
.
	`g‘_mut
(&3).
	`unw¿p
().
	`¡•
(
	`Ãw_mes§ge_w™h_’Œ›s
(

147 
Mes§geTy³
::
MsgR—dIndex
,

148 
vec
![
‹¡_’Œ›s
.
	`şÚe
()],

152 
as£¹_eq
!(
Á
.
³”s
[&3].
msgs
.
	`Ën
(), 1);

154 
Ët
 
»ad_šdex_msg2
 =

155 
	`Ãw_mes§ge_w™h_’Œ›s
(3, 1, 
Mes§geTy³
::
MsgR—dIndex
, 
vec
![
‹¡_’Œ›s
.
	`şÚe
()]);

156 
as£¹_eq
!(
Á
.
³”s
[&3].
msgs
[0], 
»ad_šdex_msg2
);

159 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(3, 3, 
Mes§geTy³
::
MsgHup
, 0)]);

162 
Ët
 
_
 = 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
().
	`¡•
(
»ad_šdex_msg1
);

163 
Ët
 
_
 = 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
().
	`¡•
(
»ad_šdex_msg2
);

166 
as£¹_eq
!(
Á
.
³”s
[&1].
msgs
.
	`Ën
(), 2);

168 
Ët
 
»ad_šdex_msg3
 =

169 
	`Ãw_mes§ge_w™h_’Œ›s
(1, 3, 
Mes§geTy³
::
MsgR—dIndex
, 
vec
![
‹¡_’Œ›s
.
	`şÚe
()]);

171 
as£¹_eq
!(
Á
.
³”s
[&1].
msgs
[0], 
»ad_šdex_msg3
);

172 
as£¹_eq
!(
Á
.
³”s
[&1].
msgs
[1], 
»ad_šdex_msg3
);

173 
	}
}

177 #[
‹¡
]

178 
â
 
	$‹¡_¿w_node_´İo£_ªd_cÚf_chªge
() {

179 
Ët
 
s
 = 
	`Ãw_¡Üage
();

180 
Ët
 
mut
 
¿w_node
 = 
	`Ãw_¿w_node
(1, 
vec
![], 10, 1, 
s
.
	`şÚe
(), vec![
	`Ãw_³”
(1)]);

181 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

182 
s
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

183 
¿w_node
.
	`advªû
(
rd
);

184 
¿w_node
.
	`ÿm·ign
().
	`ex³ù
("");

185 
Ët
 
mut
 
´İo£d
 = 
çl£
;

186 
Ët
 
mut
 
Ï¡_šdex
;

187 
Ët
 
mut
 
ccd©a
 = 
vec
![];

188 
loİ
 {

189 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

190 
s
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

192 !
´İo£d
 && 
rd
.
ss
.
	`is_some
(è&&„d.ss.
	`as_»f
().
	`unw¿p
().
Ëad”_id
 =ğ
¿w_node
.
¿á
.
id
 {

193 
¿w_node
.
	`´İo£
(
b
"somed©a".
	`to_vec
(), 
çl£
).
	`ex³ù
("");

195 
Ët
 
cc
 = 
	`cÚf_chªge
(
CÚfChªgeTy³
::
AddNode
, 1);

196 
ccd©a
 = 
´Ùobuf
::
Mes§ge
::
	`wr™e_to_by‹s
(&
cc
).
	`unw¿p
();

197 
¿w_node
.
	`´İo£_cÚf_chªge
(
cc
).
	`ex³ù
("");

199 
´İo£d
 = 
Œue
;

201 
¿w_node
.
	`advªû
(
rd
);

205 
Ï¡_šdex
 = 
s
.
	`Ï¡_šdex
().
	`unw¿p
();

206 
Ï¡_šdex
 >= 4 {

211 
Ët
 
’Œ›s
 = 
s
.
	`’Œ›s
(
Ï¡_šdex
 - 1,†a¡_šdex + 1, 
NO_LIMIT
).
	`unw¿p
();

212 
as£¹_eq
!(
’Œ›s
.
	`Ën
(), 2);

213 
as£¹_eq
!(
’Œ›s
[0].
	`g‘_d©a
(), 
b
"somedata");

214 
as£¹_eq
!(
’Œ›s
[1].
	`g‘_’Œy_ty³
(), 
EÁryTy³
::
EÁryCÚfChªge
);

215 
as£¹_eq
!(
’Œ›s
[1].
	`g‘_d©a
(), &*
ccd©a
);

216 
	}
}

220 #[
‹¡
]

221 
â
 
	$‹¡_¿w_node_´İo£_add_du¶iÿ‹_node
() {

222 
Ët
 
s
 = 
	`Ãw_¡Üage
();

223 
Ët
 
mut
 
¿w_node
 = 
	`Ãw_¿w_node
(1, 
vec
![], 10, 1, 
s
.
	`şÚe
(), vec![
	`Ãw_³”
(1)]);

224 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

225 
s
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

226 
¿w_node
.
	`advªû
(
rd
);

228 
¿w_node
.
	`ÿm·ign
().
	`ex³ù
("");

229 
loİ
 {

230 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

231 
s
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

232 
rd
.
ss
.
	`is_some
(è&&„d.ss.
	`as_»f
().
	`unw¿p
().
Ëad”_id
 =ğ
¿w_node
.
¿á
.
id
 {

233 
¿w_node
.
	`advªû
(
rd
);

236 
¿w_node
.
	`advªû
(
rd
);

239 
Ët
 
mut
 
´İo£_cÚf_chªge_ªd_­¶y
 = |
cc
| {

240 
¿w_node
.
	`´İo£_cÚf_chªge
(
cc
).
	`ex³ù
("");

241 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

242 
s
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

243 
e
 
š
 
rd
.
comm™‹d_’Œ›s
.
	`as_»f
().
	`unw¿p
() {

244 
e
.
	`g‘_’Œy_ty³
(è=ğ
EÁryTy³
::
EÁryCÚfChªge
 {

245 
Ët
 
cÚf_chªge
 = 
´Ùobuf
::
	`·r£_äom_by‹s
(
e
.
	`g‘_d©a
()).
	`unw¿p
();

246 
¿w_node
.
	`­¶y_cÚf_chªge
(&
cÚf_chªge
);

249 
¿w_node
.
	`advªû
(
rd
);

252 
Ët
 
cc1
 = 
	`cÚf_chªge
(
CÚfChªgeTy³
::
AddNode
, 1);

253 
Ët
 
ccd©a1
 = 
´Ùobuf
::
Mes§ge
::
	`wr™e_to_by‹s
(&
cc1
).
	`unw¿p
();

254 
	`´İo£_cÚf_chªge_ªd_­¶y
(
cc1
.
	`şÚe
());

257 
	`´İo£_cÚf_chªge_ªd_­¶y
(
cc1
);

260 
Ët
 
cc2
 = 
	`cÚf_chªge
(
CÚfChªgeTy³
::
AddNode
, 2);

261 
Ët
 
ccd©a2
 = 
´Ùobuf
::
Mes§ge
::
	`wr™e_to_by‹s
(&
cc2
).
	`unw¿p
();

262 
	`´İo£_cÚf_chªge_ªd_­¶y
(
cc2
);

264 
Ët
 
Ï¡_šdex
 = 
s
.
	`Ï¡_šdex
().
	`unw¿p
();

267 
Ët
 
mut
 
’Œ›s
 = 
s
.
	`’Œ›s
(
Ï¡_šdex
 - 2,†a¡_šdex + 1, 
NO_LIMIT
).
	`unw¿p
();

268 
as£¹_eq
!(
’Œ›s
.
	`Ën
(), 3);

269 
as£¹_eq
!(
’Œ›s
[0].
	`ke_d©a
(), 
ccd©a1
);

270 
as£¹_eq
!(
’Œ›s
[2].
	`ke_d©a
(), 
ccd©a2
);

271 
	}
}

275 #[
‹¡
]

276 
â
 
	$‹¡_¿w_node_»ad_šdex
() {

277 
Ët
 
a
 = 
Rc
::
	`Ãw
(
RefC–l
::Ãw(
Vec
::new()));

278 
Ët
 
b
 = 
a
.
	`şÚe
();

279 
Ët
 
befÜe_¡•_¡©e
 = 
Box
::
	`Ãw
(
move
 |
m
: &
Mes§ge
| {

280 
b
.
	`bÜrow_mut
().
	`push
(
m
.
	`şÚe
());

281 
Œue


283 
Ët
 
w»que¡_ùx
 = 
b
"somed©a".
	`to_vec
();

284 
Ët
 
wrs
 = 
vec
![

285 
R—dS‹
 {

286 
šdex
: 1u64,

287 
»que¡_ùx
: 
w»que¡_ùx
.
	`şÚe
(),

291 
Ët
 
s
 = 
	`Ãw_¡Üage
();

292 
Ët
 
mut
 
¿w_node
 = 
	`Ãw_¿w_node
(1, 
vec
![], 10, 1, 
s
.
	`şÚe
(), vec![
	`Ãw_³”
(1)]);

293 
¿w_node
.
¿á
.
»ad_¡©es
 = 
wrs
.
	`şÚe
();

295 
as£¹
!(
¿w_node
.
	`has_»ady
());

296 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

297 
as£¹_eq
!(
rd
.
»ad_¡©es
, 
wrs
);

298 
s
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

299 
¿w_node
.
	`advªû
(
rd
);

301 
as£¹
!(
¿w_node
.
¿á
.
»ad_¡©es
.
	`is_em±y
());

303 
Ët
 
w»que¡_ùx
 = 
b
"somed©a2".
	`to_vec
();

304 
¿w_node
.
	`ÿm·ign
().
	`ex³ù
("");

305 
loİ
 {

306 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

307 
s
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

308 
rd
.
ss


309 .
	`as_»f
()

310 .
	`m­_Ü
(
çl£
, |
ss
| ss.
Ëad”_id
 =ğ
¿w_node
.
¿á
.
id
)

312 
¿w_node
.
	`advªû
(
rd
);

315 
¿w_node
.
¿á
.
befÜe_¡•_¡©e
 = 
	`Some
(before_step_state);

316 
¿w_node
.
	`»ad_šdex
(
w»que¡_ùx
.
	`şÚe
());

319 
¿w_node
.
	`advªû
(
rd
);

322 
Ët
 
msgs
 = 
a
.
	`bÜrow
();

323 
as£¹_eq
!(
msgs
.
	`Ën
(), 1);

324 
as£¹_eq
!(
msgs
[0].
	`g‘_msg_ty³
(), 
Mes§geTy³
::
MsgR—dIndex
);

325 
as£¹_eq
!(
w»que¡_ùx
, 
msgs
[0].
	`g‘_’Œ›s
()[0].
	`g‘_d©a
());

326 
	}
}

332 #[
‹¡
]

333 
â
 
	$‹¡_¿w_node_¡¬t
() {

334 
Ët
 
cc
 = 
	`cÚf_chªge
(
CÚfChªgeTy³
::
AddNode
, 1);

335 
Ët
 
ccd©a
 = 
´Ùobuf
::
Mes§ge
::
	`wr™e_to_by‹s
(&
cc
).
	`unw¿p
();

336 
Ët
 
wªts
 = 
vec
![

337 
	`Ãw_»ady
(

338 
NÚe
,

339 
	`Some
(
	`h¬d_¡©e
(1, 1, 0)),

340 
vec
![

341 
	`’Œy
(
EÁryTy³
::
EÁryCÚfChªge
, 1, 1, 
	`Some
(
ccd©a
.
	`şÚe
())),

343 
vec
![

344 
	`’Œy
(
EÁryTy³
::
EÁryCÚfChªge
, 1, 1, 
	`Some
(
ccd©a
.
	`şÚe
())),

346 
Œue
,

348 
	`Ãw_»ady
(

349 
NÚe
,

350 
	`Some
(
	`h¬d_¡©e
(2, 3, 1)),

351 
vec
![
	`Ãw_’Œy
(2, 3, 
	`Some
("foo"))],

352 
vec
![
	`Ãw_’Œy
(2, 3, 
	`Some
("foo"))],

353 
çl£
,

357 
Ët
 
¡Üe
 = 
	`Ãw_¡Üage
();

358 
Ët
 
mut
 
¿w_node
 = 
	`Ãw_¿w_node
(1, 
vec
![], 10, 1, 
¡Üe
.
	`şÚe
(), vec![
	`Ãw_³”
(1)]);

359 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

360 
šfo
!("rd {:?}", &
rd
);

361 
as£¹_eq
!(
rd
, 
wªts
[0]);

362 
¡Üe
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

363 
¿w_node
.
	`advªû
(
rd
);

365 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

366 
¡Üe
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

367 
¿w_node
.
	`advªû
(
rd
);

369 
¿w_node
.
	`ÿm·ign
().
	`ex³ù
("");

370 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

371 
¡Üe
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

372 
¿w_node
.
	`advªû
(
rd
);

374 
¿w_node
.
	`´İo£
(
b
"foo".
	`to_vec
(), 
çl£
).
	`ex³ù
("");

375 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

376 
as£¹_eq
!(
rd
, 
wªts
[1]);

377 
¡Üe
.
	`wl
().
	`­³nd
(&
rd
.
’Œ›s
).
	`ex³ù
("");

378 
¿w_node
.
	`advªû
(
rd
);

379 
as£¹
!(!
¿w_node
.
	`has_»ady
());

380 
	}
}

382 #[
‹¡
]

383 
â
 
	$‹¡_¿w_node_»¡¬t
() {

384 
Ët
 
’Œ›s
 = 
vec
![
	`em±y_’Œy
(1, 1), 
	`Ãw_’Œy
(1, 2, 
	`Some
("foo"))];

385 
Ët
 
¡
 = 
	`h¬d_¡©e
(1, 1, 0);

387 
Ët
 
wªt
 = 
	`Ãw_»ady
(
NÚe
, NÚe, 
vec
![], 
’Œ›s
[..1].
	`to_vec
(), 
çl£
);

389 
Ët
 
¡Üe
 = 
	`Ãw_¡Üage
();

390 
¡Üe
.
	`wl
().
	`£t_h¬d¡©e
(
¡
);

391 
¡Üe
.
	`wl
().
	`­³nd
(&
’Œ›s
).
	`ex³ù
("");

392 
Ët
 
mut
 
¿w_node
 = 
	`Ãw_¿w_node
(1, 
vec
![], 10, 1, 
¡Üe
, vec![]);

393 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

394 
as£¹_eq
!(
rd
, 
wªt
);

395 
¿w_node
.
	`advªû
(
rd
);

396 
as£¹
!(!
¿w_node
.
	`has_»ady
());

397 
	}
}

399 #[
‹¡
]

400 
â
 
	$‹¡_¿w_node_»¡¬t_äom_¢­shÙ
() {

401 
Ët
 
¢­
 = 
	`Ãw_¢­shÙ
(2, 1, 
vec
![1, 2]);

402 
Ët
 
’Œ›s
 = 
vec
![
	`Ãw_’Œy
(1, 3, 
	`Some
("foo"))];

403 
Ët
 
¡
 = 
	`h¬d_¡©e
(1, 3, 0);

405 
Ët
 
wªt
 = 
	`Ãw_»ady
(
NÚe
, NÚe, 
vec
![], 
’Œ›s
.
	`şÚe
(), 
çl£
);

407 
Ët
 
s
 = 
	`Ãw_¡Üage
();

408 
s
.
	`wl
().
	`£t_h¬d¡©e
(
¡
);

409 
s
.
	`wl
().
	`­¶y_¢­shÙ
(
¢­
).
	`ex³ù
("");

410 
s
.
	`wl
().
	`­³nd
(&
’Œ›s
).
	`ex³ù
("");

411 
Ët
 
mut
 
¿w_node
 = 
	`Ãw_¿w_node
(1, 
vec
![], 10, 1, 
s
, vec![]);

412 
Ët
 
rd
 = 
¿w_node
.
	`»ady
();

413 
as£¹_eq
!(
rd
, 
wªt
);

414 
¿w_node
.
	`advªû
(
rd
);

415 
as£¹
!(!
¿w_node
.
	`has_»ady
());

416 
	}
}

420 #[
‹¡
]

421 
â
 
	$‹¡_sk_bÿ¡_comm™
() {

422 
Ët
 
mut
 
cÚfig
 = 
	`Ãw_‹¡_cÚfig
(1, 
vec
![1, 2, 3], 10, 1);

423 
cÚfig
.
sk_bÿ¡_comm™
 = 
Œue
;

424 
Ët
 
r1
 = 
	`Ãw_‹¡_¿á_w™h_cÚfig
(&
cÚfig
, 
	`Ãw_¡Üage
());

425 
Ët
 
r2
 = 
	`Ãw_‹¡_¿á
(2, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

426 
Ët
 
r3
 = 
	`Ãw_‹¡_¿á
(3, 
vec
![1, 2, 3], 10, 1, 
	`Ãw_¡Üage
());

427 
Ët
 
mut
 
Á
 = 
N‘wÜk
::
	`Ãw
(
vec
![
	`Some
(
r1
), Some(
r2
), Some(
r3
)]);

430 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

433 
Ët
 
mut
 
‹¡_’Œ›s
 = 
EÁry
::
	`Ãw
();

434 
‹¡_’Œ›s
.
	`£t_d©a
(
b
"‹¡d©a".
	`to_vec
());

435 
Ët
 
msg
 = 
	`Ãw_mes§ge_w™h_’Œ›s
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 
vec
![
‹¡_’Œ›s
.
	`şÚe
()]);

436 
Á
.
	`£nd
(
vec
![
msg
.
	`şÚe
()]);

437 
as£¹_eq
!(
Á
.
³”s
[&1].
¿á_log
.
comm™‹d
, 2);

438 
as£¹_eq
!(
Á
.
³”s
[&2].
¿á_log
.
comm™‹d
, 1);

439 
as£¹_eq
!(
Á
.
³”s
[&3].
¿á_log
.
comm™‹d
, 1);

442 
_
 
š
 0..
Á
.
³”s
[&1].
	`g‘_¿ndomized_–eùiÚ_timeout
() {

443 
Á
.
³”s
.
	`g‘_mut
(&1).
	`unw¿p
().
	`tick
();

445 
Á
.
	`£nd
(
vec
![
	`Ãw_mes§ge
(1, 1, 
Mes§geTy³
::
MsgHup
, 0)]);

446 
as£¹_eq
!(
Á
.
³”s
[&2].
¿á_log
.
comm™‹d
, 2);

447 
as£¹_eq
!(
Á
.
³”s
[&3].
¿á_log
.
comm™‹d
, 2);

450 
Á
.
	`£nd
(
vec
![
msg
.
	`şÚe
()]);

451 
Á
.
	`£nd
(
vec
![
msg
]);

452 
as£¹_eq
!(
Á
.
³”s
[&1].
¿á_log
.
comm™‹d
, 4);

453 
as£¹_eq
!(
Á
.
³”s
[&2].
¿á_log
.
comm™‹d
, 3);

454 
as£¹_eq
!(
Á
.
³”s
[&3].
¿á_log
.
comm™‹d
, 3);

457 
Ët
 
mut
 
cc_’Œy
 = 
EÁry
::
	`Ãw
();

458 
cc_’Œy
.
	`£t_’Œy_ty³
(
EÁryTy³
::
EÁryCÚfChªge
);

459 
Á
.
	`£nd
(
vec
![

460 
	`Ãw_mes§ge_w™h_’Œ›s
(1, 1, 
Mes§geTy³
::
MsgPrİo£
, 
vec
![
cc_’Œy
]),

462 
as£¹_eq
!(
Á
.
³”s
[&1].
¿á_log
.
comm™‹d
, 5);

463 
as£¹_eq
!(
Á
.
³”s
[&2].
¿á_log
.
comm™‹d
, 5);

464 
as£¹_eq
!(
Á
.
³”s
[&3].
¿á_log
.
comm™‹d
, 5);

465 
	}
}

	@tests/raftstore/cluster.rs

15 
u£
 
	g¡d
::
cŞËùiÚs
::{
HashM­
, 
	gHashS‘
};

16 
u£
 
	g¡d
::
sync
::{
£lf
, 
	gArc
, 
	gRwLock
};

17 
u£
 
	g¡d
::
time
::*;

18 
u£
 
	g¡d
::{
»suÉ
, 
	gth»ad
};

19 
u£
 
	g¡d
::
·th
::
P©h
;

21 
u£
 
	grocksdb
::
DB
;

22 
u£
 
	g‹mpdœ
::
TempDœ
;

23 
u£
 
	gfutu»s
::
Futu»
;

25 
u£
 
	gtikv
::
¿á¡Üe
::{
E¼Ü
, 
	gResuÉ
};

26 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::*;

27 
u£
 
	gtikv
::
cÚfig
::
TiKvCÚfig
;

28 
u£
 
	gtikv
::
¡Üage
::{
ALL_CFS
, 
	gCF_DEFAULT
};

29 
u£
 
	gsu³r
::
ut
::*;

30 
u£
 
	gkv´Ùo
::
pdpb
;

31 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::*;

32 
u£
 
	gkv´Ùo
::
m‘­b
::{
£lf
, 
	gRegiÚEpoch
};

33 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

34 
u£
 
	gkv´Ùo
::
”rÜpb
::
E¼Ü
 
as
 
PbE¼Ü
;

35 
u£
 
	gtikv
::
pd
::
PdCl›Á
;

36 
u£
 
	gtikv
::
ut
::{
esÿ³
, 
	grocksdb
, 
	gHªdyRwLock
};

37 
u£
 
	gtikv
::
ut
::
Œª¥Üt
::
S’dCh
;

38 
u£
 
	gsu³r
::
pd
::
Te¡PdCl›Á
;

39 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

46 
pub
 
Œa™
 
	gSimuÏtÜ
 {

52 
â
 
run_node
(&
mut
 
£lf
, 
node_id
: 
u64
, 
cfg
: 
TiKvCÚfig
, 
’gšes
: 
Engšes
) -> u64;

53 
â
 
¡İ_node
(&
mut
 
£lf
, 
node_id
: 
u64
);

54 
â
 
g‘_node_ids
(&
£lf
è-> 
	gHashS‘
<
	gu64
>;

55 
â
 
ÿÎ_commªd_Ú_node
(

56 &
£lf
,

57 
node_id
: 
u64
,

58 
»que¡
: 
RaáCmdReque¡
,

59 
timeout
: 
Du¿tiÚ
,

60 è-> 
	gResuÉ
<
	gRaáCmdRe¥Ú£
>;

61 
â
 
£nd_¿á_msg
(&
mut
 
£lf
, 
msg
: 
RaáMes§ge
è-> 
ResuÉ
<()>;

62 
â
 
g‘_¢­_dœ
(&
£lf
, 
node_id
: 
u64
è-> 
SŒšg
;

63 
â
 
g‘_¡Üe_£ndch
(&
£lf
, 
node_id
: 
u64
è-> 
O±iÚ
<
S’dCh
<
Msg
>>;

64 
â
 
add_£nd_f‹r
(&
mut
 
£lf
, 
node_id
: 
u64
, 
f‹r
: 
S’dF‹r
);

65 
â
 
ş—r_£nd_f‹rs
(&
mut
 
£lf
, 
node_id
: 
u64
);

66 
â
 
add_»cv_f‹r
(&
mut
 
£lf
, 
node_id
: 
u64
, 
f‹r
: 
RecvF‹r
);

67 
â
 
ş—r_»cv_f‹rs
(&
mut
 
£lf
, 
node_id
: 
u64
);

69 
â
 
ÿÎ_commªd
(&
£lf
, 
»que¡
: 
RaáCmdReque¡
, 
timeout
: 
Du¿tiÚ
è-> 
ResuÉ
<
RaáCmdRe¥Ú£
> {

70 
Ët
 
node_id
 = 
»que¡
.
g‘_h—d”
().
g‘_³”
().
g‘_¡Üe_id
();

71 
	g£lf
.
ÿÎ_commªd_Ú_node
(
node_id
, 
»que¡
, 
timeout
)

75 
pub
 
	gClu¡”
<
	gT
: 
SimuÏtÜ
> {

76 
pub
 
cfg
: 
TiKvCÚfig
,

77 
	gËad”s
: 
HashM­
<
u64
, 
	gm‘­b
::
P“r
>,

78 
	g·ths
: 
Vec
<
TempDœ
>,

79 
	gdbs
: 
Vec
<
Engšes
>,

82 
pub
 
	g’gšes
: 
HashM­
<
u64
, 
	gEngšes
>,

84 
pub
 
	gsim
: 
Arc
<
RwLock
<
T
>>,

85 
pub
 
	gpd_ş›Á
: 
Arc
<
Te¡PdCl›Á
>,

88 
	gim¶
<
	gT
: 
SimuÏtÜ
> 
Clu¡”
<
T
> {

90 
pub
 
â
 
Ãw
(

91 
id
: 
u64
,

92 
couÁ
: 
usize
,

93 
cfs
: &[&
¡r
],

94 
sim
: 
Arc
<
RwLock
<
T
>>,

95 
pd_ş›Á
: 
Arc
<
Te¡PdCl›Á
>,

96 è-> 
	gClu¡”
<
	gT
> {

97 
Ët
 
mut
 
	gc
 = 
Clu¡”
 {

98 
cfg
: 
Ãw_tikv_cÚfig
(
id
),

99 
Ëad”s
: 
HashM­
::
Ãw
(),

100 
·ths
: 
vec
![],

101 
dbs
: 
vec
![],

102 
’gšes
: 
HashM­
::
Ãw
(),

103 
sim
: sim,

104 
pd_ş›Á
:…d_client,

107 
	gc
.
ü—‹_’gšes
(
couÁ
, 
cfs
);

109 
	gc


112 
pub
 
â
 
id
(&
£lf
è-> 
	gu64
 {

113 
	g£lf
.
	gcfg
.
	g£rv”
.
	gşu¡”_id


116 
â
 
ü—‹_’gšes
(&
mut
 
£lf
, 
couÁ
: 
usize
, 
cfs
: &[&
¡r
]) {

117 
_
 
š
 0..c
ouÁ
 {

118 
£lf
.
·ths
.
push
(
TempDœ
::
Ãw
("‹¡_şu¡”").
unw¿p
());

121 
Ët
 
mut
 
	gkv_cfs
 = 
vec
![];

122 
	gkv_cfs
.
ex‹nd_äom_¦iû
(
ALL_CFS
);

123 
	gkv_cfs
.
ex‹nd_äom_¦iû
(
cfs
);

124 
™em
 
	gš
 &
	g£lf
.
	g·ths
 {

125 
Ët
 
	g’gše
 = 
Arc
::
Ãw
(

126 
rocksdb
::
Ãw_’gše
(
™em
.
·th
().
to_¡r
().
unw¿p
(), &
kv_cfs
).unwrap(),

128 
Ët
 
	g¿á_·th
 = 
™em
.
·th
().
još
(
P©h
::
Ãw
("raft"));

129 
Ët
 
	g¿á_’gše
 = 
Arc
::
Ãw
(

130 
rocksdb
::
Ãw_’gše
(
¿á_·th
.
to_¡r
().
unw¿p
(), &[
CF_DEFAULT
]).unwrap(),

132 
	g£lf
.
	gdbs
.
push
(
Engšes
::
Ãw
(
’gše
, 
¿á_’gše
));

136 
pub
 
â
 
¡¬t
(&
mut
 
£lf
) {

137 
	g£lf
.
	g’gšes
.
is_em±y
() {

138 
Ët
 
mut
 
	gsim
 = 
£lf
.
sim
.
wl
();

139 
’gšes
 
	gš
 &
	g£lf
.
	gdbs
 {

140 
Ët
 
	gnode_id
 = 
sim
.
run_node
(0, 
£lf
.
cfg
.
şÚe
(), 
’gšes
.clone());

141 
	g£lf
.
	g’gšes
.
š£¹
(
node_id
, 
’gšes
.
şÚe
());

145 
Ët
 
	gnode_ids
 = 
£lf
.
’gšes
.
keys
().
şÚed
().
cŞËù
::<
Vec
<
_
>>();

146 
node_id
 
š
 
	gnode_ids
 {

147 
	g£lf
.
run_node
(
node_id
);

154 
pub
 
â
 
run
(&
mut
 
£lf
) {

155 
	g£lf
.
boÙ¡¿p_»giÚ
().
unw¿p
();

156 
	g£lf
.
¡¬t
();

161 
pub
 
â
 
run_cÚf_chªge
(&
mut
 
£lf
è-> 
	gu64
 {

162 
Ët
 
	g»giÚ_id
 = 
£lf
.
boÙ¡¿p_cÚf_chªge
();

163 
	g£lf
.
¡¬t
();

164 
	g»giÚ_id


167 
pub
 
â
 
run_node
(&
mut
 
£lf
, 
node_id
: 
u64
) {

168 
debug
!("¡¬tšg‚od{}", 
	gnode_id
);

169 
	g£lf
.
	gsim


170 .
wl
()

171 .
run_node
(
node_id
, 
£lf
.
cfg
.
şÚe
(), s–f.
’gšes
[&node_id].clone());

172 
	gdebug
!("nod{} s¹ed", 
	gnode_id
);

175 
pub
 
â
 
¡İ_node
(&
mut
 
£lf
, 
node_id
: 
u64
) {

176 
debug
!("¡İpšg‚od{}", 
	gnode_id
);

177 
	g£lf
.
	gsim
.
wl
().
¡İ_node
(
node_id
);

178 
	gdebug
!("nod{} stİ³d", 
	gnode_id
);

181 
pub
 
â
 
g‘_’gše
(&
£lf
, 
node_id
: 
u64
è-> 
Arc
<
DB
> {

182 
£lf
.
’gšes
[&
node_id
].
kv_’gše
.
şÚe
()

185 
pub
 
â
 
g‘_¿á_’gše
(&
£lf
, 
node_id
: 
u64
è-> 
Arc
<
DB
> {

186 
£lf
.
’gšes
[&
node_id
].
¿á_’gše
.
şÚe
()

189 
pub
 
â
 
£nd_¿á_msg
(&
mut
 
£lf
, 
msg
: 
RaáMes§ge
è-> 
ResuÉ
<()> {

190 
£lf
.
sim
.
wl
().
£nd_¿á_msg
(
msg
)

193 
pub
 
â
 
ÿÎ_commªd_Ú_node
(

194 &
£lf
,

195 
node_id
: 
u64
,

196 
»que¡
: 
RaáCmdReque¡
,

197 
timeout
: 
Du¿tiÚ
,

198 è-> 
	gResuÉ
<
	gRaáCmdRe¥Ú£
> {

199 
m©ch
 
	g£lf
.
	gsim


200 .
¾
()

201 .
ÿÎ_commªd_Ú_node
(
node_id
, 
»que¡
.
şÚe
(), 
timeout
)

203 
E¼
(
e
) => {

204 
w¬n
!("çedØÿÎ commªd {:?}: {:?}", 
»que¡
, 
e
);

205 
E¼
(
e
)

207 
	ga
 => 
a
,

211 
pub
 
â
 
ÿÎ_commªd
(

212 &
£lf
,

213 
»que¡
: 
RaáCmdReque¡
,

214 
timeout
: 
Du¿tiÚ
,

215 è-> 
	gResuÉ
<
	gRaáCmdRe¥Ú£
> {

216 
m©ch
 
	g£lf
.
	gsim
.
¾
().
ÿÎ_commªd
(
»que¡
.
şÚe
(), 
timeout
) {

217 
E¼
(
e
) => {

218 
w¬n
!("çedØÿÎ commªd {:?}: {:?}", 
»que¡
, 
e
);

219 
E¼
(
e
)

221 
	ga
 => 
a
,

225 
pub
 
â
 
ÿÎ_commªd_Ú_Ëad”
(

226 &
mut
 
£lf
,

227 
mut
 
»que¡
: 
RaáCmdReque¡
,

228 
timeout
: 
Du¿tiÚ
,

229 è-> 
	gResuÉ
<
	gRaáCmdRe¥Ú£
> {

230 
Ët
 
mut
 
	g»Œy_út
 = 0;

231 
Ët
 
	g»giÚ_id
 = 
»que¡
.
g‘_h—d”
().
g‘_»giÚ_id
();

232 
	gloİ
 {

233 
Ët
 
	gËad”
 = 
m©ch
 
£lf
.
Ëad”_of_»giÚ
(
»giÚ_id
) {

234 
NÚe
 =>  
E¼
(
box_”r
!("ÿn'ˆg‘†—d” oà»giÚ {}", 
»giÚ_id
)),

235 
Some
(
l
) =>†,

237 
	g»que¡
.
mut_h—d”
().
£t_³”
(
Ëad”
);

238 
Ët
 
	g»¥
 = 
m©ch
 
£lf
.
ÿÎ_commªd
(
»que¡
.
şÚe
(), 
timeout
) {

239 
	ge
 @ 
E¼
(
_
è=>  
e
,

240 
Ok
(
»¥
) =>„esp,

242 
	g£lf
.
»äesh_Ëad”_if_Ãeded
(&
»¥
, 
»giÚ_id
è&& 
	g»Œy_út
 < 10 {

243 
	g»Œy_út
 += 1;

244 
	gw¬n
!(

246 
	g»que¡
.
g‘_h—d”
().
g‘_³”
()

250  
Ok
(
»¥
);

254 
â
 
v®id_Ëad”_id
(&
£lf
, 
»giÚ_id
: 
u64
, 
Ëad”_id
: u64è-> 
boŞ
 {

255 
Ët
 
¡Üe_ids
 = 
m©ch
 
£lf
.
¡Üe_ids_of_»giÚ
(
»giÚ_id
) {

256 
NÚe
 =>  
çl£
,

257 
Some
(
ids
) => ids,

259 
Ët
 
	gnode_ids
 = 
£lf
.
sim
.
¾
().
g‘_node_ids
();

260 
	g¡Üe_ids
.
cÚšs
(&
Ëad”_id
è&& 
	gnode_ids
.contains(&leader_id)

263 
â
 
¡Üe_ids_of_»giÚ
(&
£lf
, 
»giÚ_id
: 
u64
è-> 
O±iÚ
<
Vec
<u64>> {

264 
£lf
.
pd_ş›Á


265 .
g‘_»giÚ_by_id
(
»giÚ_id
)

266 .
wa™
()

267 .
unw¿p
()

268 .
m­
(|
»giÚ
| {

269 
»giÚ


270 .
g‘_³”s
()

271 .
što_™”
()

272 .
m­
(|
p
|….
g‘_¡Üe_id
())

273 .
cŞËù
()

277 
pub
 
â
 
qu”y_Ëad”
(&
£lf
, 
¡Üe_id
: 
u64
, 
»giÚ_id
: u64è-> 
O±iÚ
<
m‘­b
::
P“r
> {

279 
Ët
 
³”
 = 
Ãw_³”
(
¡Üe_id
, 0);

280 
Ët
 
	gfšd_Ëad”
 = 
Ãw_¡©us_»que¡
(
»giÚ_id
, 
³”
, 
Ãw_»giÚ_Ëad”_cmd
());

281 
Ët
 
mut
 
	g»¥
 = 
£lf
.
ÿÎ_commªd
(
fšd_Ëad”
, 
Du¿tiÚ
::
äom_£cs
(5))

282 .
unw¿p
();

283 
Ët
 
mut
 
	g»giÚ_Ëad”
 = 
»¥
.
ke_¡©us_»¥Ú£
().
ke_»giÚ_Ëad”
();

285 
	g£lf
.
v®id_Ëad”_id
(
»giÚ_id
, 
»giÚ_Ëad”
.
g‘_Ëad”
().
g‘_¡Üe_id
()) {

286 
Some
(
»giÚ_Ëad”
.
ke_Ëad”
())

288 
	gNÚe


292 
pub
 
â
 
Ëad”_of_»giÚ
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
è-> 
O±iÚ
<
m‘­b
::
P“r
> {

293 
Ët
 
¡Üe_ids
 = 
m©ch
 
£lf
.
¡Üe_ids_of_»giÚ
(
»giÚ_id
) {

294 
NÚe
 =>  None,

295 
Some
(
ids
) => ids,

297 
Ët
 
Some
(
l
èğ
£lf
.
Ëad”s
.
g‘
(&
»giÚ_id
) {

299 
£lf
.
v®id_Ëad”_id
(
»giÚ_id
, 
l
.
g‘_¡Üe_id
()) {

300  
Some
(
l
.
şÚe
());

303 
	g£lf
.
»£t_Ëad”_of_»giÚ
(
»giÚ_id
);

304 
Ët
 
mut
 
	gËad”
 = 
NÚe
;

305 
Ët
 
mut
 
	g»Œy_út
 = 500;

307 
Ët
 
	gnode_ids
 = 
£lf
.
sim
.
¾
().
g‘_node_ids
();

308 
Ët
 
mut
 
	gcouÁ
 = 0;

309 
	gËad”
.
is_nÚe
(è|| 
	gcouÁ
 < 
	g¡Üe_ids
.
Ën
()è&& 
	g»Œy_út
 > 0 {

310 
	gcouÁ
 = 0;

311 
	gËad”
 = 
NÚe
;

312 
¡Üe_id
 
	gš
 &
	g¡Üe_ids
 {

315 !
	gnode_ids
.
cÚšs
(
¡Üe_id
) {

316 
	gcouÁ
 += 1;

319 
Ët
 
	gl
 = 
£lf
.
qu”y_Ëad”
(*
¡Üe_id
, 
»giÚ_id
);

320 
	gl
.
is_nÚe
() {

323 
	gËad”
.
is_nÚe
() {

324 
	gËad”
 = 
l
;

325 
	gcouÁ
 += 1;

326 } 
	gl
 =ğ
Ëad”
 {

327 
couÁ
 += 1;

330 
¦“p_ms
(10);

331 
	g»Œy_út
 -= 1;

334 
Ët
 
Some
(
l
èğ
Ëad”
 {

335 
£lf
.
Ëad”s
.
š£¹
(
»giÚ_id
, 
l
);

338 
	g£lf
.
	gËad”s
.
g‘
(&
»giÚ_id
).
şÚed
()

341 
pub
 
â
 
check_»giÚs_numb”
(&
£lf
, 
Ën
: 
u32
) {

342 
as£¹_eq
!(
£lf
.
pd_ş›Á
.
g‘_»giÚs_numb”
(è
as
 
u32
, 
	gËn
)

348 
pub
 
â
 
add_fœ¡_»giÚ
(&
£lf
è-> 
	gResuÉ
<()> {

349 
Ët
 
mut
 
	g»giÚ
 = 
m‘­b
::
RegiÚ
::
Ãw
();

350 
Ët
 
	g»giÚ_id
 = 
£lf
.
pd_ş›Á
.
®loc_id
().
unw¿p
();

351 
Ët
 
	g³”_id
 = 
£lf
.
pd_ş›Á
.
®loc_id
().
unw¿p
();

352 
	g»giÚ
.
£t_id
(
»giÚ_id
);

353 
	g»giÚ
.
£t_¡¬t_key
(
keys
::
EMPTY_KEY
.
to_vec
());

354 
	g»giÚ
.
£t_’d_key
(
keys
::
EMPTY_KEY
.
to_vec
());

355 
	g»giÚ
.
mut_»giÚ_•och
().
£t_v”siÚ
(1);

356 
	g»giÚ
.
mut_»giÚ_•och
().
£t_cÚf_v”
(1);

357 
Ët
 
	g³”
 = 
Ãw_³”
(
³”_id
,…eer_id);

358 
	g»giÚ
.
mut_³”s
().
push
(
³”
.
şÚe
());

359 
	g£lf
.
	gpd_ş›Á
.
add_»giÚ
(&
»giÚ
);

360 
Ok
(())

366 
â
 
boÙ¡¿p_»giÚ
(&
mut
 
£lf
è-> 
	gResuÉ
<()> {

367 
	gid
, 
	g’gšes
è
š
 
	g£lf
.
	gdbs
.
™”
().
’um”©e
() {

368 
Ët
 
	gid
 = 
id
 
as
 
u64
 + 1;

369 
	g£lf
.
	g’gšes
.
š£¹
(
id
, 
’gšes
.
şÚe
());

372 
Ët
 
mut
 
	g»giÚ
 = 
m‘­b
::
RegiÚ
::
Ãw
();

373 
	g»giÚ
.
£t_id
(1);

374 
	g»giÚ
.
£t_¡¬t_key
(
keys
::
EMPTY_KEY
.
to_vec
());

375 
	g»giÚ
.
£t_’d_key
(
keys
::
EMPTY_KEY
.
to_vec
());

376 
	g»giÚ
.
mut_»giÚ_•och
().
£t_v”siÚ
(1);

377 
	g»giÚ
.
mut_»giÚ_•och
().
£t_cÚf_v”
(1);

379 &
	gid
, 
	g’gšes
è
	gš
 &
	g£lf
.engines {

380 
Ët
 
	g³”
 = 
Ãw_³”
(
id
, id);

381 
	g»giÚ
.
mut_³”s
().
push
(
³”
.
şÚe
());

382 
boÙ¡¿p_¡Üe
(
’gšes
, 
£lf
.
id
(), id).
unw¿p
();

385 
’gšes
 
š
 
	g£lf
.
	g’gšes
.
v®ues
() {

386 
wr™e_´•¬e_boÙ¡¿p
(
’gšes
, &
»giÚ
)?;

389 
	g£lf
.
boÙ¡¿p_şu¡”
(
»giÚ
);

391 
Ok
(())

395 
â
 
boÙ¡¿p_cÚf_chªge
(&
mut
 
£lf
è-> 
	gu64
 {

396 
	gid
, 
	g’gšes
è
š
 
	g£lf
.
	gdbs
.
™”
().
’um”©e
() {

397 
Ët
 
	gid
 = 
id
 
as
 
u64
 + 1;

398 
	g£lf
.
	g’gšes
.
š£¹
(
id
, 
’gšes
.
şÚe
());

401 &
	gid
, 
	g’gšes
è
	gš
 &
	g£lf
.engines {

402 
boÙ¡¿p_¡Üe
(
’gšes
, 
£lf
.
id
(), id).
unw¿p
();

405 
Ët
 
	gnode_id
 = 1;

406 
Ët
 
	g»giÚ
 = 
´•¬e_boÙ¡¿p
(&
£lf
.
’gšes
[&
node_id
], 1, 1, 1).
unw¿p
();

407 
Ët
 
	grid
 = 
»giÚ
.
g‘_id
();

408 
	g£lf
.
boÙ¡¿p_şu¡”
(
»giÚ
);

409 
	grid


414 
â
 
boÙ¡¿p_şu¡”
(&
mut
 
£lf
, 
»giÚ
: 
m‘­b
::
RegiÚ
) {

415 
£lf
.
pd_ş›Á


416 .
boÙ¡¿p_şu¡”
(
Ãw_¡Üe
(1, "".
to_owÃd
()), 
»giÚ
)

417 .
unw¿p
();

419 &
id
 
š
 
	g£lf
.
	g’gšes
.
keys
() {

420 
	g£lf
.
	gpd_ş›Á


421 .
put_¡Üe
(
Ãw_¡Üe
(
id
, "".
to_owÃd
()))

422 .
unw¿p
();

426 
pub
 
â
 
»£t_Ëad”_of_»giÚ
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
) {

427 
£lf
.
Ëad”s
.
»move
(&
»giÚ_id
);

430 
pub
 
â
 
	gas£¹_quÜum
<
	gF
: 
FnMut
(&
DB
è-> 
boŞ
>(&
£lf
, 
mut
 
	gcÚd™iÚ
: 
F
) {

431 
£lf
.
’gšes
.
is_em±y
() {

434 
Ët
 
	gh®f
 = 
£lf
.
’gšes
.
Ën
() / 2;

435 
Ët
 
mut
 
	gqu®if›d_út
 = 0;

436 
	gid
, 
	g’gšes
è
	gš
 &
	g£lf
.engines {

437 !
cÚd™iÚ
(&
’gšes
.
kv_’gše
) {

438 
	gdebug
!("¡Ü{} i nÙ qu®if›d y‘.", 
	gid
);

441 
	gdebug
!("¡Ü{} i qu®if›d", 
	gid
);

442 
	gqu®if›d_út
 += 1;

443 
	gh®f
 < 
	gqu®if›d_út
 {

448 
	g·nic
!(

450 
	gh®f
 + 1,

451 
	gqu®if›d_út


455 
pub
 
â
 
shutdown
(&
mut
 
£lf
) {

456 
	gdebug
!("abouto shutdown cluster");

457 
Ët
 
	gkeys
;

458 
m©ch
 
	g£lf
.
	gsim
.
Œy_»ad
() {

459 
Ok
(
s
è=> 
keys
 = s.
g‘_node_ids
(),

460 
E¼
(
sync
::
TryLockE¼Ü
::
PoisÚed
(
e
)) => {

461 
Ët
 
s
 = 
e
.
što_šÃr
();

462 
	gkeys
 = 
s
.
g‘_node_ids
();

464 
E¼
(
sync
::
TryLockE¼Ü
::
WouldBlock
è=> 
uÄ—chabË
!(),

466 
id
 
š
 
	gkeys
 {

467 
	g£lf
.
¡İ_node
(
id
);

469 
	g£lf
.
	gËad”s
.
ş—r
();

470 
	gdebug
!("all‚odes‡re shut down.");

476 
pub
 
â
 
»äesh_Ëad”_if_Ãeded
(&
mut
 
£lf
, 
»¥
: &
RaáCmdRe¥Ú£
, 
»giÚ_id
: 
u64
è-> 
boŞ
 {

477 !
is_”rÜ_»¥Ú£
(
»¥
) {

478  
çl£
;

481 
Ët
 
	g”r
 = 
»¥
.
g‘_h—d”
().
g‘_”rÜ
();

482 
	g”r
.
has_¡®e_commªd
() {

484 
	g£lf
.
»£t_Ëad”_of_»giÚ
(
»giÚ_id
);

485  
	gŒue
;

487 !
	g”r
.
has_nÙ_Ëad”
() {

488  
	gçl£
;

491 
Ët
 
	g”r
 = 
”r
.
g‘_nÙ_Ëad”
();

492 !
	g”r
.
has_Ëad”
() {

493 
	g£lf
.
»£t_Ëad”_of_»giÚ
(
»giÚ_id
);

494  
	gŒue
;

496 
	g£lf
.
	gËad”s
.
š£¹
(
»giÚ_id
, 
”r
.
g‘_Ëad”
().
şÚe
());

497 
	gŒue


500 
pub
 
â
 
»que¡
(

501 &
mut
 
£lf
,

502 
key
: &[
u8
],

503 
»qs
: 
Vec
<
Reque¡
>,

504 
»ad_quÜum
: 
boŞ
,

505 
timeout
: 
Du¿tiÚ
,

506 è-> 
	gRaáCmdRe¥Ú£
 {

507 
_
 
	gš
 0..20 {

508 
Ët
 
mut
 
	g»giÚ
 = 
£lf
.
g‘_»giÚ
(
key
);

509 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

510 
Ët
 
	g»q
 = 
Ãw_»que¡
(

511 
»giÚ_id
,

512 
»giÚ
.
ke_»giÚ_•och
(),

513 
»qs
.
şÚe
(),

514 
»ad_quÜum
,

516 
Ët
 
	g»suÉ
 = 
£lf
.
ÿÎ_commªd_Ú_Ëad”
(
»q
, 
timeout
);

518 
Ët
 
E¼
(
E¼Ü
::
Timeout
(
_
)èğ
»suÉ
 {

519 
w¬n
!("call commandimeout,†et's„etry");

520 
¦“p_ms
(100);

524 
Ët
 
	g»¥
 = 
»suÉ
.
unw¿p
();

525 
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_¡®e_•och
() {

526 
	gw¬n
!("seems split,†et's„etry");

527 
¦“p_ms
(100);

530  
	g»¥
;

532 
	g·nic
!("request failed‡fter„etry for 20imes");

535 
pub
 
â
 
g‘_»giÚ
(&
£lf
, 
key
: &[
u8
]è-> 
m‘­b
::
RegiÚ
 {

536 
_
 
š
 0..100 {

537 
m©ch
 
£lf
.
pd_ş›Á
.
g‘_»giÚ
(
key
) {

538 
Ok
(
»giÚ
) => „egion,

539 
E¼
(
_
) => {

542 
¦“p_ms
(20);

548 
	g·nic
!("fšd‚Ø»giÚ fÜ {:?}", 
esÿ³
(
key
));

551 
pub
 
â
 
g‘_»giÚ_id
(&
£lf
, 
key
: &[
u8
]è-> 
u64
 {

552 
£lf
.
g‘_»giÚ
(
key
).
g‘_id
()

555 
pub
 
â
 
g‘_down_³”s
(&
£lf
è-> 
HashM­
<
u64
, 
	gpdpb
::
P“rSts
> {

556 
£lf
.
pd_ş›Á
.
g‘_down_³”s
()

559 
pub
 
â
 
g‘
(&
mut
 
£lf
, 
key
: &[
u8
]è-> 
O±iÚ
<
Vec
<u8>> {

560 
£lf
.
g‘_im¶
(
key
, 
çl£
)

563 
pub
 
â
 
mu¡_g‘
(&
mut
 
£lf
, 
key
: &[
u8
]è-> 
O±iÚ
<
Vec
<u8>> {

564 
£lf
.
g‘_im¶
(
key
, 
Œue
)

567 
â
 
g‘_im¶
(&
mut
 
£lf
, 
key
: &[
u8
], 
»ad_quÜum
: 
boŞ
è-> 
O±iÚ
<
Vec
<u8>> {

568 
Ët
 
mut
 
»¥
 = 
£lf
.
»que¡
(

569 
key
,

570 
vec
![
Ãw_g‘_cmd
(
key
)],

571 
»ad_quÜum
,

572 
Du¿tiÚ
::
äom_£cs
(5),

574 
	g»¥
.
g‘_h—d”
().
has_”rÜ
() {

575 
	g·nic
!("»¥Ú£ {:?} ha ”rÜ", 
	g»¥
);

577 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
().
Ën
(), 1);

578 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
()[0].
g‘_cmd_ty³
(), 
	gCmdTy³
::
G‘
);

579 
	g»¥
.
g‘_»¥Ú£s
()[0].
has_g‘
() {

580 
Some
(
»¥
.
mut_»¥Ú£s
()[0].
mut_g‘
().
ke_v®ue
())

582 
	gNÚe


586 
pub
 
â
 
mu¡_put
(&
mut
 
£lf
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

587 
£lf
.
mu¡_put_cf
("deçuÉ", 
key
, 
v®ue
);

590 
pub
 
â
 
mu¡_put_cf
(&
mut
 
£lf
, 
cf
: &
¡r
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

591 
Ët
 
»¥
 = 
£lf
.
»que¡
(

592 
key
,

593 
vec
![
Ãw_put_cf_cmd
(
cf
, 
key
, 
v®ue
)],

594 
çl£
,

595 
Du¿tiÚ
::
äom_£cs
(5),

597 
	g»¥
.
g‘_h—d”
().
has_”rÜ
() {

598 
	g·nic
!("»¥Ú£ {:?} ha ”rÜ", 
	g»¥
);

600 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
().
Ën
(), 1);

601 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
()[0].
g‘_cmd_ty³
(), 
	gCmdTy³
::
Put
);

604 
pub
 
â
 
put
(&
mut
 
£lf
, 
key
: &[
u8
], 
v®ue
: &[u8]è-> 
»suÉ
::
ResuÉ
<(), 
	gPbE¼Ü
> {

605 
Ët
 
	g»¥
 = 
£lf
.
»que¡
(

606 
key
,

607 
vec
![
Ãw_put_cf_cmd
("deçuÉ", 
key
, 
v®ue
)],

608 
çl£
,

609 
Du¿tiÚ
::
äom_£cs
(5),

611 
	g»¥
.
g‘_h—d”
().
has_”rÜ
() {

612 
E¼
(
»¥
.
g‘_h—d”
().
g‘_”rÜ
().
şÚe
())

614 
Ok
(())

618 
pub
 
â
 
mu¡_d–‘e
(&
mut
 
£lf
, 
key
: &[
u8
]) {

619 
£lf
.
mu¡_d–‘e_cf
("deçuÉ", 
key
)

622 
pub
 
â
 
mu¡_d–‘e_cf
(&
mut
 
£lf
, 
cf
: &
¡r
, 
key
: &[
u8
]) {

623 
Ët
 
»¥
 = 
£lf
.
»que¡
(

624 
key
,

625 
vec
![
Ãw_d–‘e_cmd
(
cf
, 
key
)],

626 
çl£
,

627 
Du¿tiÚ
::
äom_£cs
(5),

629 
	g»¥
.
g‘_h—d”
().
has_”rÜ
() {

630 
	g·nic
!("»¥Ú£ {:?} ha ”rÜ", 
	g»¥
);

632 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
().
Ën
(), 1);

633 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
()[0].
g‘_cmd_ty³
(), 
	gCmdTy³
::
D–‘e
);

636 
pub
 
â
 
mu¡_d–‘e_¿nge
(&
mut
 
£lf
, 
¡¬t
: &[
u8
], 
’d
: &[u8]) {

637 
£lf
.
mu¡_d–‘e_¿nge_cf
("deçuÉ", 
¡¬t
, 
’d
)

640 
pub
 
â
 
mu¡_d–‘e_¿nge_cf
(&
mut
 
£lf
, 
cf
: &
¡r
, 
¡¬t
: &[
u8
], 
’d
: &[u8]) {

641 
Ët
 
»¥
 = 
£lf
.
»que¡
(

642 
¡¬t
,

643 
vec
![
Ãw_d–‘e_¿nge_cmd
(
cf
, 
¡¬t
, 
’d
)],

644 
çl£
,

645 
Du¿tiÚ
::
äom_£cs
(5),

647 
	g»¥
.
g‘_h—d”
().
has_”rÜ
() {

648 
	g·nic
!("»¥Ú£ {:?} ha ”rÜ", 
	g»¥
);

650 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
().
Ën
(), 1);

651 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
()[0].
g‘_cmd_ty³
(), 
	gCmdTy³
::
D–‘eRªge
);

654 
pub
 
â
 
mu¡_æush
(&
mut
 
£lf
, 
sync
: 
boŞ
) {

655 
’gšes
 
š
 &
£lf
.
dbs
 {

656 
’gšes
.
kv_’gše
.
æush
(
sync
).
unw¿p
();

657 
	g’gšes
.
	g¿á_’gše
.
æush
(
sync
).
unw¿p
();

661 
pub
 
â
 
g‘_»giÚ_•och
(&
£lf
, 
»giÚ_id
: 
u64
è-> 
RegiÚEpoch
 {

662 
£lf
.
pd_ş›Á


663 .
g‘_»giÚ_by_id
(
»giÚ_id
)

664 .
wa™
()

665 .
unw¿p
()

666 .
unw¿p
()

667 .
ke_»giÚ_•och
()

670 
pub
 
â
 
»giÚ_d‘a
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
³”_id
: u64è-> 
RegiÚD‘aRe¥Ú£
 {

671 
Ët
 
¡©us_cmd
 = 
Ãw_»giÚ_d‘a_cmd
();

672 
Ët
 
	g³”
 = 
Ãw_³”
(
³”_id
,…eer_id);

673 
Ët
 
	g»q
 = 
Ãw_¡©us_»que¡
(
»giÚ_id
, 
³”
, 
¡©us_cmd
);

674 
Ët
 
	g»¥
 = 
£lf
.
ÿÎ_commªd
(
»q
, 
Du¿tiÚ
::
äom_£cs
(5));

675 
	gas£¹
!(
	g»¥
.
is_ok
(), "{:?}",„esp);

677 
Ët
 
mut
 
	g»¥
 = 
»¥
.
unw¿p
();

678 
	gas£¹
!(
	g»¥
.
has_¡©us_»¥Ú£
());

679 
Ët
 
mut
 
	g¡©us_»¥
 = 
»¥
.
ke_¡©us_»¥Ú£
();

680 
	gas£¹_eq
!(
	g¡©us_»¥
.
g‘_cmd_ty³
(), 
	gStusCmdTy³
::
RegiÚD‘a
);

681 
	gas£¹
!(
	g¡©us_»¥
.
has_»giÚ_d‘a
());

682 
	g¡©us_»¥
.
ke_»giÚ_d‘a
()

685 
pub
 
â
 
	gadd_£nd_f‹r
<
	gF
: 
F‹rFaùÜy
>(&
£lf
, 
	gçùÜy
: 
F
) {

686 
Ët
 
mut
 
sim
 = 
£lf
.sim.
wl
();

687 
node_id
 
š
 
	gsim
.
g‘_node_ids
() {

688 
f‹r
 
š
 
	gçùÜy
.
g’”©e
(
node_id
) {

689 
	gsim
.
add_£nd_f‹r
(
node_id
, 
f‹r
);

694 
pub
 
â
 
Œªsãr_Ëad”
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
Ëad”
: 
m‘­b
::
P“r
) {

695 
Ët
 
•och
 = 
£lf
.
g‘_»giÚ_•och
(
»giÚ_id
);

696 
Ët
 
	gŒªsãr_Ëad”
 = 
Ãw_admš_»que¡
(
»giÚ_id
, &
•och
, 
Ãw_Œªsãr_Ëad”_cmd
(
Ëad”
));

697 
Ët
 
	g»¥
 = 
£lf
.
ÿÎ_commªd_Ú_Ëad”
(
Œªsãr_Ëad”
, 
Du¿tiÚ
::
äom_£cs
(5))

698 .
unw¿p
();

699 
	gas£¹_eq
!(

700 
	g»¥
.
g‘_admš_»¥Ú£
().
g‘_cmd_ty³
(),

701 
	gAdmšCmdTy³
::
T¿nsãrL—d”
,

703 
	g»¥


707 
pub
 
â
 
mu¡_Œªsãr_Ëad”
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
Ëad”
: 
m‘­b
::
P“r
) {

708 
Ët
 
mut
 
Œy_út
 = 0;

709 
	gloİ
 {

710 
	g£lf
.
»£t_Ëad”_of_»giÚ
(
»giÚ_id
);

711 
	g£lf
.
Ëad”_of_»giÚ
(
»giÚ_id
è=ğ
Some
(
Ëad”
.
şÚe
()) {

714 
	gŒy_út
 > 250 {

715 
	g·nic
!("çedØŒªsã¸Ëad”Ø[{}] {:?}", 
	g»giÚ_id
, 
	gËad”
);

717 
	gŒy_út
 % 50 == 0 {

718 
£lf
.
Œªsãr_Ëad”
(
»giÚ_id
, 
Ëad”
.
şÚe
());

720 
	gŒy_út
 += 1;

724 
pub
 
â
 
g‘_¢­_dœ
(&
£lf
, 
node_id
: 
u64
è-> 
SŒšg
 {

725 
£lf
.
sim
.
¾
().
g‘_¢­_dœ
(
node_id
)

728 
pub
 
â
 
ş—r_£nd_f‹rs
(&
mut
 
£lf
) {

729 
Ët
 
mut
 
sim
 = 
£lf
.sim.
wl
();

730 
node_id
 
š
 
	gsim
.
g‘_node_ids
() {

731 
	gsim
.
ş—r_£nd_f‹rs
(
node_id
);

738 
pub
 
â
 
¥l™_»giÚ
(&
mut
 
£lf
, 
»giÚ
: &
m‘­b
::
RegiÚ
, 
¥l™_key
: &[
u8
], 
cb
: 
C®lback
) {

739 
Ët
 
Ëad”
 = 
£lf
.
Ëad”_of_»giÚ
(
»giÚ
.
g‘_id
()).
unw¿p
();

740 
Ët
 
	gch
 = 
£lf
.
sim


741 .
¾
()

742 .
g‘_¡Üe_£ndch
(
Ëad”
.
g‘_¡Üe_id
())

743 .
unw¿p
();

744 
Ët
 
	g¥l™_key
 = 
¥l™_key
.
to_vec
();

745 
	gch
.
Œy_£nd
(
Msg
::
S¶™RegiÚ
 {

746 
»giÚ_id
: 
»giÚ
.
g‘_id
(),

747 
»giÚ_•och
: 
»giÚ
.
g‘_»giÚ_•och
().
şÚe
(),

748 
¥l™_key
: s¶™_key.
şÚe
(),

749 
ÿÎback
: 
Some
(
cb
),

750 }).
unw¿p
();

753 
pub
 
â
 
mu¡_¥l™
(&
mut
 
£lf
, 
»giÚ
: &
m‘­b
::
RegiÚ
, 
¥l™_key
: &[
u8
]) {

754 
Ët
 
mut
 
Œy_út
 = 0;

755 
Ët
 
	g¥l™_couÁ
 = 
£lf
.
pd_ş›Á
.
g‘_¥l™_couÁ
();

756 
	gloİ
 {

758 
	gŒy_út
 % 50 == 0 {

759 
£lf
.
»£t_Ëad”_of_»giÚ
(
»giÚ
.
g‘_id
());

760 
Ët
 
	gkey
 = 
¥l™_key
.
to_vec
();

761 
Ët
 
	gcheck
 = 
Box
::
Ãw
(
move
 |
mut
 
»¥
: 
RaáCmdRe¥Ú£
| {

762 
»¥
.
g‘_h—d”
().
has_”rÜ
() {

763 
Ët
 
”rÜ
 = 
»¥
.
g‘_h—d”
().
g‘_”rÜ
();

764 
”rÜ
.
has_¡®e_•och
(è||ƒ¼Ü.
has_nÙ_Ëad”
() {

765 
w¬n
!("çØ¥l™: {:?}, ignÜe.", 
”rÜ
);

768 
·nic
!("çedØ¥l™: {:?}", 
”rÜ
);

770 
Ët
 
admš_»¥
 = 
»¥
.
mut_admš_»¥Ú£
();

771 
Ët
 
¥l™_»¥
 = 
admš_»¥
.
mut_¥l™
();

772 
Ët
 
mut
 
Ëá
 = 
¥l™_»¥
.
ke_Ëá
();

773 
Ët
 
mut
 
right
 = 
¥l™_»¥
.
ke_right
();

774 
as£¹_eq
!(
Ëá
.
g‘_’d_key
(), 
key
.
as_¦iû
());

775 
as£¹_eq
!(
Ëá
.
ke_’d_key
(), 
right
.
ke_¡¬t_key
());

777 
	g£lf
.
¥l™_»giÚ
(
»giÚ
, 
¥l™_key
, 
check
);

780 
	g£lf
.
	gpd_ş›Á
.
check_¥l™
(
»giÚ
, 
¥l™_key
) &&

781 
	g£lf
.
	gpd_ş›Á
.
g‘_¥l™_couÁ
(è> 
	g¥l™_couÁ


786 
	gŒy_út
 > 250 {

787 
	g·nic
!(

789 
	g»giÚ
,

790 
esÿ³
(
¥l™_key
)

793 
	gŒy_út
 += 1;

794 
¦“p_ms
(20);

799 
pub
 
â
 
mu¡_»giÚ_exi¡
(&
mut
 
£lf
, 
»giÚ_id
: 
u64
, 
¡Üe_id
: u64) {

800 
Ët
 
mut
 
Œy_út
 = 0;

801 
	gloİ
 {

802 
Ët
 
	gfšd_Ëad”
 =

803 
Ãw_¡©us_»que¡
(
»giÚ_id
, 
Ãw_³”
(
¡Üe_id
, 0), 
Ãw_»giÚ_Ëad”_cmd
());

804 
Ët
 
	g»¥
 = 
£lf
.
ÿÎ_commªd
(
fšd_Ëad”
, 
Du¿tiÚ
::
äom_£cs
(5))

805 .
unw¿p
();

807 !
is_”rÜ_»¥Ú£
(&
»¥
) {

811 
	gŒy_út
 > 250 {

812 
	g·nic
!(

814 
	g»giÚ_id
,

815 
	g¡Üe_id
,

816 
	gŒy_út


819 
	gŒy_út
 += 1;

820 
¦“p_ms
(20);

825 
pub
 
â
 
mu¡_»move_»giÚ
(&
mut
 
£lf
, 
¡Üe_id
: 
u64
, 
»giÚ_id
: u64) {

826 
Ët
 
tim”
 = 
In¡ªt
::
now
();

827 
	gloİ
 {

828 
Ët
 
	g³”
 = 
Ãw_³”
(
¡Üe_id
, 0);

829 
Ët
 
	gfšd_Ëad”
 = 
Ãw_¡©us_»que¡
(
»giÚ_id
, 
³”
, 
Ãw_»giÚ_Ëad”_cmd
());

830 
Ët
 
	g»¥
 = 
£lf
.
ÿÎ_commªd
(
fšd_Ëad”
, 
Du¿tiÚ
::
äom_£cs
(5))

831 .
unw¿p
();

833 
is_”rÜ_»¥Ú£
(&
»¥
) {

834 
	gas£¹
!(

835 
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_»giÚ_nÙ_found
(),

837 
	g»¥


841 
	gtim”
.
–­£d
(è> 
	gDu¿tiÚ
::
äom_£cs
(60) {

842 
·nic
!("»giÚ {} i nÙ„emoved‡á” 60s.", 
	g»giÚ_id
);

844 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(100));

849 
pub
 
â
 
·¹™iÚ
(&
£lf
, 
s1
: 
Vec
<
u64
>, 
s2
: Vec<u64>) {

850 
£lf
.
add_£nd_f‹r
(
P¬t™iÚF‹rFaùÜy
::
Ãw
(
s1
, 
s2
));

854 
	gim¶
<
	gT
: 
SimuÏtÜ
> 
Drİ
 
Clu¡”
<
T
> {

855 
â
 
drİ
(&
mut
 
£lf
) {

856 
£lf
.
shutdown
();

	@tests/raftstore/mod.rs

14 
pub
 
mod
 
	gut
;

15 
pub
 
mod
 
	gşu¡”
;

16 
pub
 
mod
 
	gnode
;

17 
pub
 
mod
 
	g£rv”
;

18 
pub
 
mod
 
	gpd
;

19 
pub
 
mod
 
	gŒª¥Üt_simuÏ‹
;

	@tests/raftstore/node.rs

15 
u£
 
	g¡d
::
cŞËùiÚs
::{
HashM­
, 
	gHashS‘
};

16 
u£
 
	g¡d
::
sync
::{
mpsc
, 
	gArc
, 
	gRwLock
};

17 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

18 
u£
 
	g¡d
::
boxed
::
FnBox
;

19 
u£
 
	g¡d
::
İs
::
D”ef
;

21 
u£
 
	g‹mpdœ
::
TempDœ
;

23 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

24 
u£
 
	gtikv
::
£rv”
::
Node
;

25 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::*;

26 
u£
 
	gkv´Ùo
::
m‘­b
;

27 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::*;

28 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
£lf
, 
	gRaáMes§ge
};

29 
u£
 
	gkv´Ùo
::
”aápb
::
Mes§geTy³
;

30 
u£
 
	gtikv
::
cÚfig
::
TiKvCÚfig
;

31 
u£
 
	gtikv
::
¿á¡Üe
::{
E¼Ü
, 
	gResuÉ
};

32 
u£
 
	gtikv
::
¿á¡Üe
::
cİroûssÜ
::
CİroûssÜHo¡
;

33 
u£
 
	gtikv
::
ut
::
HªdyRwLock
;

34 
u£
 
	gtikv
::
ut
::
wÜk”
::
Futu»WÜk”
;

35 
u£
 
	gtikv
::
ut
::
Œª¥Üt
::
S’dCh
;

36 
u£
 
	gtikv
::
£rv”
::
Œª¥Üt
::{
RaáStÜeRou‹r
, 
	gS”v”RaáStÜeRou‹r
};

37 
u£
 
	gtikv
::
¿á
::
SÇpshÙStus
;

38 
u£
 
	gsu³r
::
pd
::
Te¡PdCl›Á
;

39 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

41 
pub
 
	sChªÃlT¿n¥ÜtCÜe
 {

42 
	m¢­_·ths
: 
HashM­
<
u64
, (
	mSÇpMªag”
, 
	mTempDœ
)>,

43 
	mrou‹rs
: 
HashM­
<
u64
, 
	mSimuÏ‹T¿n¥Üt
<
	mMsg
, 
	mS”v”RaáStÜeRou‹r
>>,

46 #[
d”ive
(
ClÚe
)]

47 
pub
 
	sChªÃlT¿n¥Üt
 {

48 
	mcÜe
: 
Arc
<
RwLock
<
ChªÃlT¿n¥ÜtCÜe
>>,

51 
im¶
 
	gChªÃlT¿n¥Üt
 {

52 
pub
 
â
 
Ãw
(è-> 
	gChªÃlT¿n¥Üt
 {

53 
	gChªÃlT¿n¥Üt
 {

54 
	gcÜe
: 
Arc
::
Ãw
(
RwLock
::Ãw(
ChªÃlT¿n¥ÜtCÜe
 {

55 
¢­_·ths
: 
HashM­
::
Ãw
(),

56 
rou‹rs
: 
HashM­
::
Ãw
(),

62 
im¶
 
D”ef
 
	gChªÃlT¿n¥Üt
 {

63 
ty³
 
	gT¬g‘
 = 
Arc
<
RwLock
<
ChªÃlT¿n¥ÜtCÜe
>>;

65 
â
 
d”ef
(&
£lf
è-> &
	gS–f
::
T¬g‘
 {

66 &
£lf
.
cÜe


70 
im¶
 
ChªÃl
<
RaáMes§ge
> 
ChªÃlT¿n¥Üt
 {

71 
â
 
£nd
(&
£lf
, 
msg
: 
RaáMes§ge
è-> 
ResuÉ
<()> {

72 
Ët
 
äom_¡Üe
 = 
msg
.
g‘_äom_³”
().
g‘_¡Üe_id
();

73 
Ët
 
	gto_¡Üe
 = 
msg
.
g‘_to_³”
().
g‘_¡Üe_id
();

74 
Ët
 
	gto_³”_id
 = 
msg
.
g‘_to_³”
().
g‘_id
();

75 
Ët
 
	g»giÚ_id
 = 
msg
.
g‘_»giÚ_id
();

76 
Ët
 
	gis_¢­shÙ
 = 
msg
.
g‘_mes§ge
().
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgSÇpshÙ
;

78 
	gmsg
.
g‘_mes§ge
().
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgSÇpshÙ
 {

79 
Ët
 
¢­
 = 
msg
.
g‘_mes§ge
().
g‘_¢­shÙ
();

80 
Ët
 
	gkey
 = 
SÇpKey
::
äom_¢­
(
¢­
).
unw¿p
();

81 
Ët
 
	gäom
 = 
m©ch
 
£lf
.
¾
().
¢­_·ths
.
g‘
(&
äom_¡Üe
) {

82 
Some
(
p
) => {

83 
p
.0.(
key
.
şÚe
(), 
SÇpEÁry
::
S’dšg
);

84 
	gp
.0.
g‘_¢­shÙ_fÜ_£ndšg
(&
key
).
unw¿p
()

86 
	gNÚe
 =>  
E¼
(
box_”r
!("missšgem°dœ fÜ stÜ{}", 
äom_¡Üe
)),

88 
Ët
 
	gto
 = 
m©ch
 
£lf
.
¾
().
¢­_·ths
.
g‘
(&
to_¡Üe
) {

89 
Some
(
p
) => {

90 
p
.0.(
key
.
şÚe
(), 
SÇpEÁry
::
Reûivšg
);

91 
Ët
 
	gd©a
 = 
msg
.
g‘_mes§ge
().
g‘_¢­shÙ
().
g‘_d©a
();

92 
	gp
.0.
g‘_¢­shÙ_fÜ_»ûivšg
(&
key
, 
d©a
).
unw¿p
()

94 
	gNÚe
 =>  
E¼
(
box_”r
!("missšgem°dœ fÜ stÜ{}", 
to_¡Üe
)),

97 
	gdeãr
!({

98 
Ët
 
	gcÜe
 = 
£lf
.
¾
();

99 
	gcÜe
.
	g¢­_·ths
[&
äom_¡Üe
]

101 .
d”egi¡”
(&
key
, &
SÇpEÁry
::
S’dšg
);

102 
	gcÜe
.
	g¢­_·ths
[&
to_¡Üe
]

104 .
d”egi¡”
(&
key
, &
SÇpEÁry
::
Reûivšg
);

107 
cİy_¢­shÙ
(
äom
, 
to
)?;

110 
m©ch
 
	g£lf
.
	gcÜe
.
¾
().
	grou‹rs
.
g‘
(&
to_¡Üe
) {

111 
Some
(
h
) => {

112 
h
.
£nd_¿á_msg
(
msg
)?;

113 
	gis_¢­shÙ
 {

115 
Ët
 
	gcÜe
 = 
£lf
.
¾
();

116 
	gcÜe
.
	grou‹rs
[&
äom_¡Üe
]

117 .
»pÜt_¢­shÙ_¡©us
(
»giÚ_id
, 
to_³”_id
, 
SÇpshÙStus
::
Fšish
)

118 .
unw¿p
();

120 
Ok
(())

122 
	g_
 => 
E¼
(
box_”r
!("missšg s’d” fÜ stÜ{}", 
to_¡Üe
)),

127 
ty³
 
	gSimuÏ‹ChªÃlT¿n¥Üt
 = 
SimuÏ‹T¿n¥Üt
<
RaáMes§ge
, 
	gChªÃlT¿n¥Üt
>;

129 
pub
 
	sNodeClu¡”
 {

130 
	mŒªs
: 
ChªÃlT¿n¥Üt
,

131 
	mpd_ş›Á
: 
Arc
<
Te¡PdCl›Á
>,

132 
	mnodes
: 
HashM­
<
u64
, 
	mNode
<
	mTe¡PdCl›Á
>>,

133 
	msimuÏ‹_Œªs
: 
HashM­
<
u64
, 
	mSimuÏ‹ChªÃlT¿n¥Üt
>,

136 
im¶
 
	gNodeClu¡”
 {

137 
pub
 
â
 
Ãw
(
pd_ş›Á
: 
Arc
<
Te¡PdCl›Á
>è-> 
NodeClu¡”
 {

138 
NodeClu¡”
 {

139 
Œªs
: 
ChªÃlT¿n¥Üt
::
Ãw
(),

140 
	gpd_ş›Á
: 
pd_ş›Á
,

141 
	gnodes
: 
HashM­
::
Ãw
(),

142 
	gsimuÏ‹_Œªs
: 
HashM­
::
Ãw
(),

147 
im¶
 
	gNodeClu¡”
 {

148 #[
®low
(
d—d_code
)]

149 
pub
 
â
 
g‘_node_rou‹r
(&
£lf
, 
node_id
: 
u64
è-> 
SimuÏ‹T¿n¥Üt
<
Msg
, 
	gS”v”RaáStÜeRou‹r
> {

150 
	g£lf
.
	gŒªs
.
¾
().
	grou‹rs
.
g‘
(&
node_id
).
şÚed
().
unw¿p
()

154 
im¶
 
SimuÏtÜ
 
	gNodeClu¡”
 {

155 
â
 
run_node
(&
mut
 
£lf
, 
node_id
: 
u64
, 
cfg
: 
TiKvCÚfig
, 
’gšes
: 
Engšes
) -> u64 {

156 
as£¹
!(
node_id
 =ğ0 || !
£lf
.
nodes
.
cÚšs_key
(&node_id));

158 
Ët
 
mut
 
	gev’t_loİ
 = 
ü—‹_ev’t_loİ
(&
cfg
.
¿á_¡Üe
).
unw¿p
();

159 
Ët
 (
¢­_¡©us_£nd”
, 
¢­_¡©us_»ûiv”
èğ
mpsc
::
chªÃl
();

160 
Ët
 
	gpd_wÜk”
 = 
Futu»WÜk”
::
Ãw
("test-pd-worker");

162 
Ët
 
	gsimuÏ‹_Œªs
 = 
SimuÏ‹T¿n¥Üt
::
Ãw
(
£lf
.
Œªs
.
şÚe
());

163 
Ët
 
mut
 
	gnode
 = 
Node
::
Ãw
(

164 &
mut
 
ev’t_loİ
,

165 &
cfg
.
£rv”
,

166 &
cfg
.
¿á_¡Üe
,

167 
£lf
.
pd_ş›Á
.
şÚe
(),

170 
Ët
 (
¢­_mgr
, 
tmp
) =

171 
node_id
 =ğ0 || !
£lf
.
Œªs
.
¾
().
¢­_·ths
.
cÚšs_key
(&node_id) {

172 
Ët
 
tmp
 = 
TempDœ
::
Ãw
("‹¡_şu¡”").
unw¿p
();

173 
Ët
 
	g¢­_mgr
 =

174 
SÇpMªag”
::
Ãw
(
tmp
.
·th
().
to_¡r
().
unw¿p
(), 
Some
(
node
.
g‘_£ndch
()), 
NÚe
);

175 (
	g¢­_mgr
, 
Some
(
tmp
))

177 
Ët
 
	gŒªs
 = 
£lf
.
Œªs
.
¾
();

178 
	gËt
 &(
»f
 
	g¢­_mgr
, 
	g_
èğ&
Œªs
.
¢­_·ths
[&
node_id
];

179 (
	g¢­_mgr
.
şÚe
(), 
	gNÚe
)

183 
Ët
 
	gcİroûssÜ_ho¡
 = 
CİroûssÜHo¡
::
Ãw
(
cfg
.
cİroûssÜ
, 
node
.
g‘_£ndch
());

185 
	gnode
.
¡¬t
(

186 
ev’t_loİ
,

187 
’gšes
.
şÚe
(),

188 
simuÏ‹_Œªs
.
şÚe
(),

189 
¢­_mgr
.
şÚe
(),

190 
¢­_¡©us_»ûiv”
,

191 
pd_wÜk”
,

192 
cİroûssÜ_ho¡
,

193 ).
unw¿p
();

194 
	gas£¹
!(

195 
	g’gšes


196 .
	gkv_’gše


197 .
şÚe
()

198 .
	gg‘_msg
::<
m‘­b
::
RegiÚ
>(&
keys
::
´•¬e_boÙ¡¿p_key
())

199 .
unw¿p
()

200 .
is_nÚe
()

202 
	gas£¹
!(
	gnode_id
 =ğ0 || 
node_id
 =ğ
node
.
id
());

203 
	gdebug
!(

205 
	gnode_id
,

206 
	gtmp
.
as_»f
().
m­
(|
p
|….
·th
().
to_¡r
().
unw¿p
().
to_owÃd
())

208 
Ët
 
Some
(
tmp
) =mp {

209 
£lf
.
Œªs


210 .
wl
()

211 .
¢­_·ths


212 .
š£¹
(
node
.
id
(), (
¢­_mgr
, 
tmp
));

215 
Ët
 
	gnode_id
 = 
node
.
id
();

216 
Ët
 
	grou‹r
 = 
S”v”RaáStÜeRou‹r
::
Ãw
(
node
.
g‘_£ndch
(), 
¢­_¡©us_£nd”
.
şÚe
());

217 
	g£lf
.
	gŒªs


218 .
wl
()

219 .
	grou‹rs


220 .
š£¹
(
node_id
, 
SimuÏ‹T¿n¥Üt
::
Ãw
(
rou‹r
));

221 
	g£lf
.
	gnodes
.
š£¹
(
node_id
, 
node
);

222 
	g£lf
.
	gsimuÏ‹_Œªs
.
š£¹
(
node_id
, 
simuÏ‹_Œªs
);

224 
	gnode_id


227 
â
 
g‘_¢­_dœ
(&
£lf
, 
node_id
: 
u64
è-> 
SŒšg
 {

228 
£lf
.
Œªs
.
wl
().
¢­_·ths
[&
node_id
]

230 .
·th
()

231 .
to_¡r
()

232 .
unw¿p
()

233 .
to_owÃd
()

236 
â
 
¡İ_node
(&
mut
 
£lf
, 
node_id
: 
u64
) {

237 
Ët
 
Some
(
mut
 
node
èğ
£lf
.
nodes
.
»move
(&
node_id
) {

238 
node
.
¡İ
().
unw¿p
();

240 
	g£lf
.
	gŒªs
.
wl
().
	grou‹rs
.
»move
(&
node_id
).
unw¿p
();

243 
â
 
g‘_node_ids
(&
£lf
è-> 
	gHashS‘
<
	gu64
> {

244 
	g£lf
.
	gnodes
.
keys
().
şÚed
().
cŞËù
()

247 
â
 
ÿÎ_commªd_Ú_node
(

248 &
£lf
,

249 
node_id
: 
u64
,

250 
»que¡
: 
RaáCmdReque¡
,

251 
timeout
: 
Du¿tiÚ
,

252 è-> 
	gResuÉ
<
	gRaáCmdRe¥Ú£
> {

253 !
	g£lf
.
	gŒªs
.
¾
().
	grou‹rs
.
cÚšs_key
(&
node_id
) {

254  
E¼
(
box_”r
!("missšg s’d” fÜ stÜ{}", 
node_id
));

257 
Ët
 
	grou‹r
 = 
£lf
.
Œªs
.
¾
().
rou‹rs
.
g‘
(&
node_id
).
şÚed
().
unw¿p
();

258 
	gwa™_İ
!(

259 |
	gcb
: 
Box
<
FnBox
(
RaáCmdRe¥Ú£
) + 'static + Send>| {

260 
rou‹r
.
£nd_commªd
(
»que¡
, 
cb
).
unw¿p
()

262 
	gtimeout


263 ).
ok_Ü_–£
(|| {

264 
E¼Ü
::
Timeout
(
fÜm©
!("»que¡imeouˆfÜ {:?}", 
timeout
))

268 
â
 
£nd_¿á_msg
(&
mut
 
£lf
, 
msg
: 
¿á_£rv”pb
::
RaáMes§ge
è-> 
ResuÉ
<()> {

269 
£lf
.
Œªs
.
£nd
(
msg
)

272 
â
 
	$add_£nd_f‹r
(&
mut
 
£lf
, 
node_id
: 
u64
, 
f‹r
: 
S’dF‹r
) {

273 
£lf
.
simuÏ‹_Œªs


274 .
	`g‘_mut
(&
node_id
)

275 .
	`unw¿p
()

276 .
	`add_f‹r
(
f‹r
);

277 
	}
}

279 
â
 
	$ş—r_£nd_f‹rs
(&
mut
 
£lf
, 
node_id
: 
u64
) {

280 
£lf
.
simuÏ‹_Œªs


281 .
	`g‘_mut
(&
node_id
)

282 .
	`unw¿p
()

283 .
	`ş—r_f‹rs
();

284 
	}
}

286 
â
 
	$add_»cv_f‹r
(&
mut
 
£lf
, 
node_id
: 
u64
, 
f‹r
: 
RecvF‹r
) {

287 
Ët
 
mut
 
Œªs
 = 
£lf
.Œªs.
	`wl
();

288 
Œªs
.
rou‹rs
.
	`g‘_mut
(&
node_id
).
	`unw¿p
().
	`add_f‹r
(
f‹r
);

289 
	}
}

291 
â
 
	$ş—r_»cv_f‹rs
(&
mut
 
£lf
, 
node_id
: 
u64
) {

292 
Ët
 
mut
 
Œªs
 = 
£lf
.Œªs.
	`wl
();

293 
Œªs
.
rou‹rs
.
	`g‘_mut
(&
node_id
).
	`unw¿p
().
	`ş—r_f‹rs
();

294 
	}
}

296 
â
 
g‘_¡Üe_£ndch
(&
£lf
, 
node_id
: 
u64
è-> 
O±iÚ
<
S’dCh
<
Msg
>> {

297 
£lf
.
nodes
.
g‘
(&
node_id
).
m­
(|
node
|‚ode.
g‘_£ndch
())

301 
pub
 
â
 
Ãw_node_şu¡”
(
id
: 
u64
, 
couÁ
: 
usize
è-> 
Clu¡”
<
NodeClu¡”
> {

302 
Ët
 
pd_ş›Á
 = 
Arc
::
Ãw
(
Te¡PdCl›Á
::Ãw(
id
));

303 
Ët
 
	gsim
 = 
Arc
::
Ãw
(
RwLock
::Ãw(
NodeClu¡”
::Ãw(
pd_ş›Á
.
şÚe
())));

304 
	gClu¡”
::
Ãw
(
id
, 
couÁ
, &[], 
sim
, 
pd_ş›Á
)

	@tests/raftstore/pd.rs

15 
u£
 
	g¡d
::
cŞËùiÚs
::{
BT»eM­
, 
	gHashM­
, 
	gHashS‘
};

16 
u£
 
	g¡d
::
cŞËùiÚs
::
Bound
::{
Exşuded
, 
	gUnbounded
};

17 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gRwLock
};

18 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

20 
u£
 
	gfutu»s
::{
Futu»
, 
	gSŒ—m
};

21 
u£
 
	gfutu»s
::
futu»
::{
”r
, 
	gok
};

22 
u£
 
	gfutu»s
::
sync
::
mpsc
::{
£lf
, 
	gUnboundedReûiv”
, 
	gUnboundedS’d”
};

24 
u£
 
	gkv´Ùo
::
m‘­b
;

25 
u£
 
	gkv´Ùo
::
pdpb
;

26 
u£
 
	gkv´Ùo
::
”aápb
;

27 
u£
 
	gtikv
::
pd
::{
E¼Ü
, 
	gKey
, 
	gPdCl›Á
, 
	gPdFutu»
, 
	gRegiÚSt
, 
	gResuÉ
};

28 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
keys
::{
£lf
, 
	gd©a_key
, 
	g’c_’d_key
, 
	g’c_¡¬t_key
};

29 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
ut
::
check_key_š_»giÚ
;

30 
u£
 
	gtikv
::
ut
::{
esÿ³
, 
	gHªdyRwLock
};

31 
u£
 
	gsu³r
::
ut
::*;

38 
pub
 
ty³
 
	gRuË
 = 
Box
<

39 
Fn
(&
m‘­b
::
RegiÚ
, &m‘­b::
P“r
)

40 -> 
O±iÚ
<
pdpb
::
RegiÚH—¹b—tRe¥Ú£
>

41 + 
S’d


42 + 
Sync
,

45 
	sStÜe
 {

46 
	m¡Üe
: 
m‘­b
::
StÜe
,

47 
	m»giÚ_ids
: 
HashS‘
<
u64
>,

48 
	m£nd”
: 
UnboundedS’d”
<
pdpb
::
RegiÚH—¹b—tRe¥Ú£
>,

49 
	m»ûiv”
: 
O±iÚ
<
UnboundedReûiv”
<
pdpb
::
RegiÚH—¹b—tRe¥Ú£
>>,

52 
im¶
 
DeçuÉ
 
	gStÜe
 {

53 
â
 (è-> 
	gStÜe
 {

54 
Ët
 (
tx
, 
rx
èğ
mpsc
::
unbounded
();

55 
	gStÜe
 {

56 
	g¡Üe
: 
DeçuÉ
::(),

57 
	g»giÚ_ids
: 
DeçuÉ
::(),

58 
	g£nd”
: 
tx
,

59 
	g»ûiv”
: 
Some
(
rx
),

64 
	sClu¡”
 {

65 
	mm‘a
: 
m‘­b
::
Clu¡”
,

66 
	m¡Ües
: 
HashM­
<
u64
, 
	mStÜe
>,

67 
	m»giÚs
: 
BT»eM­
<
Key
, 
	mm‘­b
::
RegiÚ
>,

68 
	m»giÚ_id_keys
: 
HashM­
<
u64
, 
	mKey
>,

69 
	mba£_id
: 
AtomicUsize
,

70 
	mruË
: 
O±iÚ
<
RuË
>,

72 
	m¡Üe_¡©s
: 
HashM­
<
u64
, 
	mpdpb
::
StÜeSts
>,

73 
	m¥l™_couÁ
: 
usize
,

75 
	mdown_³”s
: 
HashM­
<
u64
, 
	mpdpb
::
P“rSts
>,

76 
	m³ndšg_³”s
: 
HashM­
<
u64
, 
	mm‘­b
::
P“r
>,

77 
	mis_boÙ¡¿³d
: 
boŞ
,

80 
im¶
 
	gClu¡”
 {

81 
â
 
Ãw
(
şu¡”_id
: 
u64
è-> 
Clu¡”
 {

82 
Ët
 
mut
 
m‘a
 = 
m‘­b
::
Clu¡”
::
Ãw
();

83 
	gm‘a
.
£t_id
(
şu¡”_id
);

84 
	gm‘a
.
£t_max_³”_couÁ
(5);

86 
	gClu¡”
 {

87 
	gm‘a
: 
m‘a
,

88 
	g¡Ües
: 
HashM­
::
Ãw
(),

89 
	g»giÚs
: 
BT»eM­
::
Ãw
(),

90 
	g»giÚ_id_keys
: 
HashM­
::
Ãw
(),

91 
	gba£_id
: 
AtomicUsize
::
Ãw
(1000),

92 
	gruË
: 
NÚe
,

93 
	g¡Üe_¡©s
: 
HashM­
::
Ãw
(),

94 
	g¥l™_couÁ
: 0,

95 
	gdown_³”s
: 
HashM­
::
Ãw
(),

96 
	g³ndšg_³”s
: 
HashM­
::
Ãw
(),

97 
	gis_boÙ¡¿³d
: 
çl£
,

101 
â
 
boÙ¡¿p
(&
mut
 
£lf
, 
¡Üe
: 
m‘­b
::
StÜe
, 
»giÚ
: m‘­b::
RegiÚ
) {

106 
Ët
 
¡Üe_id
 = 
¡Üe
.
g‘_id
();

107 
Ët
 
mut
 
	gs
 = 
StÜe
::();

108 
	gs
.
	g¡Üe
 = 
¡Üe
;;

111 
	gs
.
	g»giÚ_ids
.
š£¹
(
»giÚ
.
g‘_id
());

113 
	g£lf
.
	g¡Ües
.
š£¹
(
¡Üe_id
, 
s
);

115 
	g£lf
.
add_»giÚ
(&
»giÚ
);

116 
	g£lf
.
	gis_boÙ¡¿³d
 = 
Œue
;

119 
â
 
£t_boÙ¡¿p
(&
mut
 
£lf
, 
is_boÙ¡¿³d
: 
boŞ
) {

120 
£lf
.
is_boÙ¡¿³d
 = is_bootstraped

124 
â
 
®loc_id
(&
£lf
è-> 
ResuÉ
<
u64
> {

125 
Ok
(
£lf
.
ba£_id
.
ãtch_add
(1, 
Ord”šg
::
R–axed
è
as
 
u64
)

128 
â
 
put_¡Üe
(&
mut
 
£lf
, 
¡Üe
: 
m‘­b
::
StÜe
è-> 
ResuÉ
<()> {

129 
Ët
 
mut
 
s
 = 
StÜe
::();

130 
Ët
 
	g¡Üe_id
 = 
¡Üe
.
g‘_id
();

131 
	gs
.
	g¡Üe
 = 
¡Üe
;

132 
	g£lf
.
	g¡Ües
.
š£¹
(
¡Üe_id
, 
s
);

133 
Ok
(())

136 
â
 
g‘_¡Üe
(&
£lf
, 
¡Üe_id
: 
u64
è-> 
ResuÉ
<
m‘­b
::
StÜe
> {

137 
m©ch
 
£lf
.
¡Ües
.
g‘
(&
¡Üe_id
) {

138 
NÚe
 => 
E¼
(
box_”r
!("¡Ü{}‚Ù found", 
¡Üe_id
)),

139 
Some
(
s
è=> 
Ok
(s.
¡Üe
.
şÚe
()),

143 
â
 
g‘_»giÚ
(&
£lf
, 
key
: 
Vec
<
u8
>è-> 
O±iÚ
<
m‘­b
::
RegiÚ
> {

144 
£lf
.
»giÚs


145 .
¿nge
((
Exşuded
(
key
), 
Unbounded
))

146 .
Ãxt
()

147 .
m­
(|(
_
, 
»giÚ
)|„egiÚ.
şÚe
())

150 
â
 
g‘_»giÚ_by_id
(&
£lf
, 
»giÚ_id
: 
u64
è-> 
ResuÉ
<
O±iÚ
<
m‘­b
::
RegiÚ
>> {

151 
Ok
(

152 
£lf
.
»giÚ_id_keys


153 .
g‘
(&
»giÚ_id
)

154 .
ªd_th’
(|
k
| 
£lf
.
»giÚs
.
g‘
(k).
şÚed
()),

158 
â
 
g‘_¡Ües
(&
£lf
è-> 
	gVec
<
	gm‘­b
::
StÜe
> {

159 
£lf
.
¡Ües
.
v®ues
().
m­
(|
s
| s.
¡Üe
.
şÚe
()).
cŞËù
()

162 
â
 
g‘_»giÚs_numb”
(&
£lf
è-> 
usize
 {

163 
£lf
.
»giÚs
.
Ën
()

166 
â
 
add_»giÚ
(&
mut
 
£lf
, 
»giÚ
: &
m‘­b
::
RegiÚ
) {

167 
Ët
 
’d_key
 = 
’c_’d_key
(
»giÚ
);

168 
	gas£¹
!(

169 
	g£lf
.
	g»giÚs


170 .
š£¹
(
’d_key
.
şÚe
(), 
»giÚ
.clone())

171 .
is_nÚe
()

173 
	gas£¹
!(

174 
	g£lf
.
	g»giÚ_id_keys


175 .
š£¹
(
»giÚ
.
g‘_id
(), 
’d_key
.
şÚe
())

176 .
is_nÚe
()

180 
â
 
»move_»giÚ
(&
mut
 
£lf
, 
»giÚ
: &
m‘­b
::
RegiÚ
) {

181 
Ët
 
’d_key
 = 
’c_’d_key
(
»giÚ
);

182 
	gas£¹
!(
	g£lf
.
	g»giÚs
.
»move
(&
’d_key
).
is_some
());

183 
	gas£¹
!(
	g£lf
.
	g»giÚ_id_keys
.
»move
(&
»giÚ
.
g‘_id
()).
is_some
());

186 
â
 
hªdË_h—¹b—t_v”siÚ
(&
mut
 
£lf
, 
»giÚ
: 
m‘­b
::
RegiÚ
è-> 
ResuÉ
<()> {

190 
Ët
 
¡¬t_key
 = 
’c_¡¬t_key
(&
»giÚ
);

191 
Ët
 
	g’d_key
 = 
’c_’d_key
(&
»giÚ
);

192 
	gas£¹
!(
	g’d_key
 > 
	g¡¬t_key
);

194 
Ët
 
	gv”siÚ
 = 
»giÚ
.
g‘_»giÚ_•och
().
g‘_v”siÚ
();

195 
Ët
 
	gcÚf_v”
 = 
»giÚ
.
g‘_»giÚ_•och
().
g‘_cÚf_v”
();

197 
Ët
 
	g£¬ch_key
 = 
d©a_key
(
»giÚ
.
g‘_¡¬t_key
());

198 
Ët
 
	g£¬ch_»giÚ
 = 
m©ch
 
£lf
.
g‘_»giÚ
(
£¬ch_key
) {

199 
NÚe
 => {

201 
£lf
.
add_»giÚ
(&
»giÚ
);

202  
Ok
(());

204 
Some
(
£¬ch_»giÚ
) => search_region,

207 
Ët
 
	g£¬ch_¡¬t_key
 = 
’c_¡¬t_key
(&
£¬ch_»giÚ
);

208 
Ët
 
	g£¬ch_’d_key
 = 
’c_’d_key
(&
£¬ch_»giÚ
);

210 
Ët
 
	g£¬ch_v”siÚ
 = 
£¬ch_»giÚ
.
g‘_»giÚ_•och
().
g‘_v”siÚ
();

211 
Ët
 
	g£¬ch_cÚf_v”
 = 
£¬ch_»giÚ
.
g‘_»giÚ_•och
().
g‘_cÚf_v”
();

213 
	g¡¬t_key
 =ğ
£¬ch_¡¬t_key
 && 
’d_key
 =ğ
£¬ch_’d_key
 {

215  
check_¡®e_»giÚ
(&
£¬ch_»giÚ
, &
»giÚ
);

218 
	g£¬ch_¡¬t_key
 >ğ
’d_key
 {

220 
£lf
.
add_»giÚ
(&
»giÚ
);

225 
	gv”siÚ
 <ğ
£¬ch_v”siÚ
 || 
cÚf_v”
 < 
£¬ch_cÚf_v”
 {

226  
E¼
(
box_”r
!("•och {:?} i ¡®e.", 
»giÚ
.
g‘_»giÚ_•och
()));

229 
	g£lf
.
»move_»giÚ
(&
£¬ch_»giÚ
);

230 
	g£lf
.
add_»giÚ
(&
»giÚ
);

233 
Ok
(())

236 
â
 
hªdË_h—¹b—t_cÚf_v”
(

237 &
mut
 
£lf
,

238 
»giÚ
: 
m‘­b
::
RegiÚ
,

239 
Ëad”
: 
m‘­b
::
P“r
,

240 è-> 
	gResuÉ
<
	gpdpb
::
RegiÚH—¹b—tRe¥Ú£
> {

241 
Ët
 
cÚf_v”
 = 
»giÚ
.
g‘_»giÚ_•och
().
g‘_cÚf_v”
();

242 
Ët
 
	g’d_key
 = 
’c_’d_key
(&
»giÚ
);

245 
Ët
 
	gcur_»giÚ
 = 
£lf
.
g‘_»giÚ_by_id
(
»giÚ
.
g‘_id
()).
unw¿p
().unwrap();

247 
Ët
 
	gcur_cÚf_v”
 = 
cur_»giÚ
.
g‘_»giÚ_•och
().
g‘_cÚf_v”
();

248 
check_¡®e_»giÚ
(&
cur_»giÚ
, &
»giÚ
)?;

250 
Ët
 
	g»giÚ_³”_Ën
 = 
»giÚ
.
g‘_³”s
().
Ën
();

251 
Ët
 
	gcur_»giÚ_³”_Ën
 = 
cur_»giÚ
.
g‘_³”s
().
Ën
();

253 
	gcÚf_v”
 > 
	gcur_cÚf_v”
 {

263 
	gas£¹_Ã
!(
	g»giÚ_³”_Ën
, 
	gcur_»giÚ_³”_Ën
);

265 
	gcur_»giÚ_³”_Ën
 > 
	g»giÚ_³”_Ën
 {

267 
	gas£¹_eq
!(
	gcur_»giÚ_³”_Ën
 - 
	g»giÚ_³”_Ën
, 1);

268 
Ët
 
	g³”s
 = 
£tdiff_³”s
(&
cur_»giÚ
, &
»giÚ
);

269 
	gas£¹_eq
!(
	g³”s
.
Ën
(), 1);

270 
	gas£¹
!(
£tdiff_³”s
(&
»giÚ
, &
cur_»giÚ
).
is_em±y
());

273 
	gas£¹_eq
!(
	g»giÚ_³”_Ën
 - 
	gcur_»giÚ_³”_Ën
, 1);

274 
Ët
 
	g³”s
 = 
£tdiff_³”s
(&
»giÚ
, &
cur_»giÚ
);

275 
	gas£¹_eq
!(
	g³”s
.
Ën
(), 1);

276 
	gas£¹
!(
£tdiff_³”s
(&
cur_»giÚ
, &
»giÚ
).
is_em±y
());

280 
	gas£¹
!(
	g£lf
.
	g»giÚs
.
š£¹
(
’d_key
, 
»giÚ
.
şÚe
()).
is_some
());

282 
mu¡_§me_³”s
(&
cur_»giÚ
, &
»giÚ
);

285 
Ët
 
mut
 
	g»¥
 = 
pdpb
::
RegiÚH—¹b—tRe¥Ú£
::
Ãw
();

286 
	g»¥
.
£t_»giÚ_id
(
»giÚ
.
g‘_id
());

287 
	g»¥
.
£t_»giÚ_•och
(
»giÚ
.
g‘_»giÚ_•och
().
şÚe
());

288 
	g»¥
.
£t_rg‘_³”
(
Ëad”
.
şÚe
());

290 
Ët
 
Some
(
»f
 
ruË
èğ
£lf
.rule {

291  
Ok
(

292 
ruË
(&
»giÚ
, &
Ëad”
)

293 .
m­
(|
mut
 
»¥
| {

294 
»¥
.
£t_»giÚ_id
(
»giÚ
.
g‘_id
());

295 
»¥
.
£t_»giÚ_•och
(
»giÚ
.
g‘_»giÚ_•och
().
şÚe
());

296 
»¥
.
£t_rg‘_³”
(
Ëad”
.
şÚe
());

297 
»¥


299 .
unw¿p_Ü
(
»¥
),

304 
Ët
 
mut
 
	gchªge_³”
 = 
pdpb
::
ChªgeP“r
::
Ãw
();

306 
Ët
 
	gmax_³”_couÁ
 = 
£lf
.
m‘a
.
g‘_max_³”_couÁ
(è
as
 
usize
;

307 
Ët
 
	g³”_couÁ
 = 
»giÚ
.
g‘_³”s
().
Ën
();

309 
	g³”_couÁ
 < 
	gmax_³”_couÁ
 {

311 
¡Üe_id
 
š
 
	g£lf
.
	g¡Ües
.
keys
() {

312 
	g»giÚ


313 .
g‘_³”s
()

314 .
™”
()

315 .
®l
(|
x
| x.
g‘_¡Üe_id
(è!ğ*
¡Üe_id
)

317 
Ët
 
³”
 = 
Ãw_³”
(*
¡Üe_id
, 
£lf
.
®loc_id
().
unw¿p
());

318 
	gchªge_³”
.
£t_chªge_ty³
(
”aápb
::
CÚfChªgeTy³
::
AddNode
.
što
());

319 
	gchªge_³”
.
£t_³”
(
³”
.
şÚe
());

320 
	g»¥
.
£t_chªge_³”
(
chªge_³”
);

324 } 
	g³”_couÁ
 > 
	gmax_³”_couÁ
 {

326 
Ët
 
	gpos
 = 
»giÚ


327 .
g‘_³”s
()

328 .
™”
()

329 .
pos™iÚ
(|
x
| x.
g‘_¡Üe_id
(è!ğ
Ëad”
.get_store_id())

330 .
unw¿p
();

332 
	gchªge_³”
.
£t_chªge_ty³
(
”aápb
::
CÚfChªgeTy³
::
RemoveNode
.
što
());

333 
	gchªge_³”
.
£t_³”
(
»giÚ
.
g‘_³”s
()[
pos
].
şÚe
());

334 
	g»¥
.
£t_chªge_³”
(
chªge_³”
);

338 
Ok
(
»¥
)

341 
â
 
»giÚ_h—¹b—t
(

342 &
mut
 
£lf
,

343 
»giÚ
: 
m‘­b
::
RegiÚ
,

344 
Ëad”
: 
m‘­b
::
P“r
,

345 
»giÚ_¡©
: 
RegiÚSt
,

346 è-> 
	gResuÉ
<
	gpdpb
::
RegiÚH—¹b—tRe¥Ú£
> {

347 
³”
 
š
 
»giÚ
.
g‘_³”s
() {

348 
£lf
.
down_³”s
.
»move
(&
³”
.
g‘_id
());

349 
	g£lf
.
	g³ndšg_³”s
.
»move
(&
³”
.
g‘_id
());

351 
³”
 
š
 
	g»giÚ_¡©
.
	gdown_³”s
 {

352 
	g£lf
.
	gdown_³”s
.
š£¹
(
³”
.
g‘_³”
().
g‘_id
(),…eer);

354 
p
 
š
 
	g»giÚ_¡©
.
	g³ndšg_³”s
 {

355 
	g£lf
.
	g³ndšg_³”s
.
š£¹
(
p
.
g‘_id
(),…);

358 
	g£lf
.
hªdË_h—¹b—t_v”siÚ
(
»giÚ
.
şÚe
())?;

359 
	g£lf
.
hªdË_h—¹b—t_cÚf_v”
(
»giÚ
, 
Ëad”
)

363 
â
 
check_¡®e_»giÚ
(
»giÚ
: &
m‘­b
::
RegiÚ
, 
check_»giÚ
: &m‘­b::RegiÚè-> 
ResuÉ
<()> {

364 
Ët
 
•och
 = 
»giÚ
.
g‘_»giÚ_•och
();

365 
Ët
 
	gcheck_•och
 = 
check_»giÚ
.
g‘_»giÚ_•och
();

366 
	gcheck_•och
.
g‘_cÚf_v”
(è>ğ
•och
.get_conf_ver() &&

367 
check_•och
.
g‘_v”siÚ
(è>ğ
•och
.get_version()

369  
Ok
(());

372 
E¼
(
box_”r
!(

374 
check_•och
,

375 
•och


379 
â
 
	$mu¡_§me_³”s
(
Ëá
: &
m‘­b
::
RegiÚ
, 
right
: &metapb::Region) {

380 
as£¹_eq
!(
Ëá
.
	`g‘_³”s
().
	`Ën
(), 
right
.get_peers().len());

381 
³”
 
š
 
Ëá
.
	`g‘_³”s
() {

382 
Ët
 
p
 = 
	`fšd_³”
(
right
, 
³”
.
	`g‘_¡Üe_id
()).
	`unw¿p
();

383 
as£¹_eq
!(
p
.
	`g‘_id
(), 
³”
.get_id());

385 
	}
}

388 
â
 
£tdiff_³”s
(
Ëá
: &
m‘­b
::
RegiÚ
, 
right
: &m‘­b::RegiÚè-> 
Vec
<m‘­b::
P“r
> {

389 
Ët
 
mut
 
³”s
 = 
vec
![];

390 
³”
 
š
 
	gËá
.
g‘_³”s
() {

391 
Ët
 
Some
(
p
èğ
fšd_³”
(
right
, 
³”
.
g‘_¡Üe_id
()) {

392 
	gas£¹_eq
!(
	gp
.
g‘_id
(), 
	g³”
.get_id());

396 
	g³”s
.
push
(
³”
.
şÚe
())

399 
	g³”s


403 
pub
 
â
 
boÙ¡¿p_w™h_fœ¡_»giÚ
(
pd_ş›Á
: 
Arc
<
Te¡PdCl›Á
>è-> 
ResuÉ
<()> {

404 
Ët
 
mut
 
»giÚ
 = 
m‘­b
::
RegiÚ
::
Ãw
();

405 
	g»giÚ
.
£t_id
(1);

406 
	g»giÚ
.
£t_¡¬t_key
(
keys
::
EMPTY_KEY
.
to_vec
());

407 
	g»giÚ
.
£t_’d_key
(
keys
::
EMPTY_KEY
.
to_vec
());

408 
	g»giÚ
.
mut_»giÚ_•och
().
£t_v”siÚ
(1);

409 
	g»giÚ
.
mut_»giÚ_•och
().
£t_cÚf_v”
(1);

410 
Ët
 
	g³”
 = 
Ãw_³”
(1, 1);

411 
	g»giÚ
.
mut_³”s
().
push
(
³”
.
şÚe
());

412 
	gpd_ş›Á
.
add_»giÚ
(&
»giÚ
);

413 
	gpd_ş›Á
.
£t_boÙ¡¿p
(
Œue
);

414 
Ok
(())

417 
pub
 
	sTe¡PdCl›Á
 {

418 
	mşu¡”_id
: 
u64
,

419 
	mşu¡”
: 
RwLock
<
Clu¡”
>,

422 
im¶
 
	gTe¡PdCl›Á
 {

423 
pub
 
â
 
Ãw
(
şu¡”_id
: 
u64
è-> 
Te¡PdCl›Á
 {

424 
Te¡PdCl›Á
 {

425 
şu¡”_id
: cluster_id,

426 
	gşu¡”
: 
RwLock
::
Ãw
(
Clu¡”
::Ãw(
şu¡”_id
)),

430 
pub
 
â
 
g‘_¡Ües
(&
£lf
è-> 
	gResuÉ
<
	gVec
<
	gm‘­b
::
StÜe
>> {

431 
Ok
(
£lf
.
şu¡”
.
¾
().
g‘_¡Ües
())

434 
â
 
check_boÙ¡¿p
(&
£lf
è-> 
ResuÉ
<()> {

435 !
£lf
.
is_şu¡”_boÙ¡¿µed
().
unw¿p
() {

436  
E¼
(
E¼Ü
::
Clu¡”NÙBoÙ¡¿µed
(
£lf
.
şu¡”_id
));

439 
Ok
(())

442 
â
 
is_»giÚs_em±y
(&
£lf
è-> 
	gboŞ
 {

443 
	g£lf
.
	gşu¡”
.
¾
().
	g»giÚs
.
is_em±y
()

447 
pub
 
â
 
£t_ruË
(&
£lf
, 
ruË
: 
RuË
) {

448 
£lf
.
şu¡”
.
wl
().
ruË
 = 
Some
(rule);

452 
pub
 
â
 
»£t_ruË
(&
£lf
) {

453 
	g£lf
.
	gşu¡”
.
wl
().
	gruË
 = 
NÚe
;

456 
pub
 
â
 
g‘_»giÚ_•och
(&
£lf
, 
»giÚ_id
: 
u64
è-> 
m‘­b
::
RegiÚEpoch
 {

457 
£lf
.
g‘_»giÚ_by_id
(
»giÚ_id
)

458 .
wa™
()

459 .
unw¿p
()

460 .
unw¿p
()

461 .
ke_»giÚ_•och
()

463 
pub
 
â
 
g‘_»giÚs_numb”
(&
£lf
è-> 
usize
 {

464 
£lf
.
şu¡”
.
¾
().
g‘_»giÚs_numb”
()

468 
pub
 
â
 
di§bË_deçuÉ_ruË
(&
£lf
) {

469 
£lf
.
£t_ruË
(
box
 
move
 |
_
, _| 
NÚe
);

472 
pub
 
â
 
mu¡_have_³”
(&
£lf
, 
»giÚ_id
: 
u64
, 
³”
: 
m‘­b
::
P“r
) {

473 
_
 
š
 1..500 {

474 
¦“p_ms
(10);

476 
Ët
 
	g»giÚ
 = 
m©ch
 
£lf
.
g‘_»giÚ_by_id
(
»giÚ_id
).
wa™
().
unw¿p
() {

477 
Some
(
»giÚ
) =>„egion,

478 
	gNÚe
 => ,

481 
Ët
 
Some
(
p
èğ
fšd_³”
(&
»giÚ
, 
³”
.
g‘_¡Üe_id
()) {

482 
	gp
.
g‘_id
(è=ğ
³”
.get_id() {

488 
Ët
 
	g»giÚ
 = 
£lf
.
g‘_»giÚ_by_id
(
»giÚ_id
).
wa™
().
unw¿p
();

489 
	g·nic
!("»giÚ {:?} ha nØ³” {:?}", 
	g»giÚ
, 
	g³”
);

492 
pub
 
â
 
mu¡_nÚe_³”
(&
£lf
, 
»giÚ_id
: 
u64
, 
³”
: 
m‘­b
::
P“r
) {

493 
_
 
š
 1..500 {

494 
¦“p_ms
(10);

496 
Ët
 
	g»giÚ
 = 
m©ch
 
£lf
.
g‘_»giÚ_by_id
(
»giÚ_id
).
wa™
().
unw¿p
() {

497 
Some
(
»giÚ
) =>„egion,

498 
	gNÚe
 => ,

501 
fšd_³”
(&
»giÚ
, 
³”
.
g‘_¡Üe_id
()).
is_nÚe
() {

506 
Ët
 
	g»giÚ
 = 
£lf
.
g‘_»giÚ_by_id
(
»giÚ_id
).
wa™
().
unw¿p
();

507 
	g·nic
!("»giÚ {:?} ha ³” {:?}", 
	g»giÚ
, 
	g³”
);

509 
pub
 
â
 
add_»giÚ
(&
£lf
, 
»giÚ
: &
m‘­b
::
RegiÚ
) {

510 
£lf
.
şu¡”
.
wl
().
add_»giÚ
(
»giÚ
)

513 
pub
 
â
 
add_³”
(&
£lf
, 
»giÚ_id
: 
u64
, 
³”
: 
m‘­b
::
P“r
) {

514 
£lf
.
£t_ruË
(
box
 
move
 |
»giÚ
: &
m‘­b
::
RegiÚ
, 
_
: &m‘­b::
P“r
| {

515 
debug
!(

517 
»giÚ_id
,

518 
³”
,

519 
»giÚ


521 
»giÚ
.
g‘_id
(è!ğ
»giÚ_id
 {

522  
NÚe
;

524 
Ãw_pd_add_chªge_³”
(
»giÚ
, 
³”
.
şÚe
())

528 
pub
 
â
 
mu¡_add_³”
(&
£lf
, 
»giÚ_id
: 
u64
, 
³”
: 
m‘­b
::
P“r
) {

529 
£lf
.
add_³”
(
»giÚ_id
, 
³”
.
şÚe
());

530 
	g£lf
.
mu¡_have_³”
(
»giÚ_id
, 
³”
);

533 
pub
 
â
 
»move_³”
(&
£lf
, 
»giÚ_id
: 
u64
, 
³”
: 
m‘­b
::
P“r
) {

534 
£lf
.
£t_ruË
(
box
 
move
 |
»giÚ
: &
m‘­b
::
RegiÚ
, 
_
: &m‘­b::
P“r
| {

535 
»giÚ
.
g‘_id
(è!ğ
»giÚ_id
 {

536  
NÚe
;

538 
Ãw_pd_»move_chªge_³”
(
»giÚ
, 
³”
.
şÚe
())

542 
pub
 
â
 
mu¡_»move_³”
(&
£lf
, 
»giÚ_id
: 
u64
, 
³”
: 
m‘­b
::
P“r
) {

543 
£lf
.
»move_³”
(
»giÚ_id
, 
³”
.
şÚe
());

544 
	g£lf
.
mu¡_nÚe_³”
(
»giÚ_id
, 
³”
);

548 
pub
 
â
 
check_¥l™
(&
£lf
, 
»giÚ
: &
m‘­b
::
RegiÚ
, 
¥l™_key
: &[
u8
]è-> 
boŞ
 {

552 
Ët
 
Ëá
 = 
m©ch
 
£lf
.
g‘_»giÚ
(
»giÚ
.
g‘_¡¬t_key
()) {

553 
E¼
(
_
è=>  
çl£
,

554 
Ok
(
Ëá
) =>†eft,

557 
	gËá
.
g‘_’d_key
(è!ğ
¥l™_key
 {

558  
çl£
;

561 
Ët
 
	gright
 = 
m©ch
 
£lf
.
g‘_»giÚ
(
¥l™_key
) {

562 
E¼
(
_
è=>  
çl£
,

563 
Ok
(
right
) =>„ight,

566 
	gright
.
g‘_¡¬t_key
(è!ğ
¥l™_key
 {

567  
çl£
;

570 
	gas£¹
!(
	gËá
.
g‘_»giÚ_•och
().
g‘_v”siÚ
(è> 
	g»giÚ
.get_region_epoch().get_version());

571 
	gas£¹
!(
	gright
.
g‘_»giÚ_•och
().
g‘_v”siÚ
(è> 
	g»giÚ
.get_region_epoch().get_version());

572 
	gŒue


575 
pub
 
â
 
g‘_¡Üe_¡©s
(&
£lf
, 
¡Üe_id
: 
u64
è-> 
O±iÚ
<
pdpb
::
StÜeSts
> {

576 
£lf
.
şu¡”
.
¾
().
¡Üe_¡©s
.
g‘
(&
¡Üe_id
).
şÚed
()

579 
pub
 
â
 
g‘_¥l™_couÁ
(&
£lf
è-> 
usize
 {

580 
£lf
.
şu¡”
.
¾
().
¥l™_couÁ


583 
pub
 
â
 
g‘_down_³”s
(&
£lf
è-> 
HashM­
<
u64
, 
	gpdpb
::
P“rSts
> {

584 
£lf
.
şu¡”
.
¾
().
down_³”s
.
şÚe
()

587 
pub
 
â
 
g‘_³ndšg_³”s
(&
£lf
è-> 
HashM­
<
u64
, 
	gm‘­b
::
P“r
> {

588 
£lf
.
şu¡”
.
¾
().
³ndšg_³”s
.
şÚe
()

591 
pub
 
â
 
£t_boÙ¡¿p
(&
£lf
, 
is_boÙ¡¿³d
: 
boŞ
) {

592 
£lf
.
şu¡”
.
wl
().
£t_boÙ¡¿p
(
is_boÙ¡¿³d
);

596 
im¶
 
PdCl›Á
 
	gTe¡PdCl›Á
 {

597 
â
 
g‘_şu¡”_id
(&
£lf
è-> 
	gResuÉ
<
	gu64
> {

598 
Ok
(
£lf
.
şu¡”_id
)

601 
â
 
boÙ¡¿p_şu¡”
(&
£lf
, 
¡Üe
: 
m‘­b
::
StÜe
, 
»giÚ
: m‘­b::
RegiÚ
è-> 
ResuÉ
<()> {

602 
£lf
.
is_şu¡”_boÙ¡¿µed
().
unw¿p
(è|| !£lf.
is_»giÚs_em±y
() {

603 
£lf
.
şu¡”
.
wl
().
£t_boÙ¡¿p
(
Œue
);

604  
E¼
(
E¼Ü
::
Clu¡”BoÙ¡¿µed
(
£lf
.
şu¡”_id
));

607 
	g£lf
.
	gşu¡”
.
wl
().
boÙ¡¿p
(
¡Üe
, 
»giÚ
);

609 
Ok
(())

612 
â
 
is_şu¡”_boÙ¡¿µed
(&
£lf
è-> 
	gResuÉ
<
	gboŞ
> {

613 
Ok
(
£lf
.
şu¡”
.
¾
().
is_boÙ¡¿³d
)

616 
â
 
®loc_id
(&
£lf
è-> 
	gResuÉ
<
	gu64
> {

617 
	g£lf
.
	gşu¡”
.
¾
().
®loc_id
()

620 
â
 
put_¡Üe
(&
£lf
, 
¡Üe
: 
m‘­b
::
StÜe
è-> 
ResuÉ
<()> {

621 
£lf
.
check_boÙ¡¿p
()?;

622 
	g£lf
.
	gşu¡”
.
wl
().
put_¡Üe
(
¡Üe
)

625 
â
 
g‘_¡Üe
(&
£lf
, 
¡Üe_id
: 
u64
è-> 
ResuÉ
<
m‘­b
::
StÜe
> {

626 
£lf
.
check_boÙ¡¿p
()?;

627 
	g£lf
.
	gşu¡”
.
¾
().
g‘_¡Üe
(
¡Üe_id
)

631 
â
 
g‘_»giÚ
(&
£lf
, 
key
: &[
u8
]è-> 
ResuÉ
<
m‘­b
::
RegiÚ
> {

632 
£lf
.
check_boÙ¡¿p
()?;

633 
Ët
 
Some
(
»giÚ
èğ
£lf
.
şu¡”
.
¾
().
g‘_»giÚ
(
d©a_key
(
key
)) {

634 
check_key_š_»giÚ
(
key
, &
»giÚ
).
is_ok
() {

635  
Ok
(
»giÚ
);

639 
E¼
(
box_”r
!("nØ»giÚ cÚš key {:?}", 
esÿ³
(
key
)))

642 
â
 
g‘_»giÚ_by_id
(&
£lf
, 
»giÚ_id
: 
u64
è-> 
PdFutu»
<
O±iÚ
<
m‘­b
::
RegiÚ
>> {

643 
Ët
 
E¼
(
e
èğ
£lf
.
check_boÙ¡¿p
() {

644  
Box
::
Ãw
(
”r
(
e
));

646 
m©ch
 
	g£lf
.
	gşu¡”
.
¾
().
g‘_»giÚ_by_id
(
»giÚ_id
) {

647 
Ok
(
»¥
è=> 
Box
::
Ãw
(
ok
(resp)),

648 
E¼
(
e
è=> 
Box
::
Ãw
(
”r
(e)),

652 
â
 
g‘_şu¡”_cÚfig
(&
£lf
è-> 
	gResuÉ
<
	gm‘­b
::
Clu¡”
> {

653 
£lf
.
check_boÙ¡¿p
()?;

654 
Ok
(
£lf
.
şu¡”
.
¾
().
m‘a
.
şÚe
())

658 
â
 
»giÚ_h—¹b—t
(

659 &
£lf
,

660 
»giÚ
: 
m‘­b
::
RegiÚ
,

661 
Ëad”
: 
m‘­b
::
P“r
,

662 
»giÚ_¡©
: 
RegiÚSt
,

663 è-> 
	gPdFutu»
<()> {

664 
Ët
 
E¼
(
e
èğ
£lf
.
check_boÙ¡¿p
() {

665  
Box
::
Ãw
(
”r
(
e
));

667 
Ët
 
	g»¥
 = 
£lf
.
şu¡”


668 .
wl
()

669 .
»giÚ_h—¹b—t
(
»giÚ
, 
Ëad”
.
şÚe
(), 
»giÚ_¡©
);

670 
m©ch
 
	g»¥
 {

671 
Ok
(
»¥
) => {

672 
Ët
 
¡Üe_id
 = 
Ëad”
.
g‘_¡Üe_id
();

673 
Ët
 
Some
(
¡Üe
èğ
£lf
.
şu¡”
.
wl
().
¡Ües
.
g‘
(&
¡Üe_id
) {

674 
¡Üe
.
£nd”
.
unbounded_£nd
(
»¥
).
unw¿p
();

676 
	gBox
::
Ãw
(
ok
(()))

678 
E¼
(
e
è=> 
Box
::
Ãw
(
”r
(e)),

682 
â
 
	ghªdË_»giÚ_h—¹b—t_»¥Ú£
<
	gF
>(&
	g£lf
, 
	g¡Üe_id
: 
u64
, 
	gf
: 
F
è-> 
PdFutu»
<()>

683 
wh”e


684 
F
: 
Fn
(
pdpb
::
RegiÚH—¹b—tRe¥Ú£
è+ 
S’d
 + 'static,

686 
Ët
 
mut
 
şu¡”
 = 
£lf
.şu¡”.
wl
();

687 
Ët
 
	g¡Üe
 = 
şu¡”
.
¡Ües
.
g‘_mut
(&
¡Üe_id
).
unw¿p
();

688 
Ët
 
	grx
 = 
¡Üe
.
»ûiv”
.
ke
().
unw¿p
();

689 
	gBox
::
Ãw
(

690 
rx
.
fÜ_—ch
(
move
 |
»¥
| {

691 
f
(
»¥
);

692 
Ok
(())

693 }).
m­_”r
(|
e
| {

694 
box_”r
!("çedØ»ûivÃxˆh—¹b—ˆ»¥Ú£: {:?}", 
e
)

699 
â
 
ask_¥l™
(&
£lf
, 
»giÚ
: 
m‘­b
::
RegiÚ
è-> 
PdFutu»
<
pdpb
::
AskS¶™Re¥Ú£
> {

700 
Ët
 
E¼
(
e
èğ
£lf
.
check_boÙ¡¿p
() {

701  
Box
::
Ãw
(
”r
(
e
));

705 
Ët
 
	gcur_»giÚ
 = 
£lf
.
şu¡”


706 .
¾
()

707 .
g‘_»giÚ_by_id
(
»giÚ
.
g‘_id
())

708 .
unw¿p
()

709 .
unw¿p
();

710 
Ët
 
E¼
(
e
èğ
check_¡®e_»giÚ
(&
cur_»giÚ
, &
»giÚ
) {

711  
	gBox
::
Ãw
(
”r
(
e
));

714 
Ët
 
mut
 
	g»¥
 = 
pdpb
::
AskS¶™Re¥Ú£
::
Ãw
();

715 
	g»¥
.
£t_Ãw_»giÚ_id
(
£lf
.
®loc_id
().
unw¿p
());

716 
Ët
 
mut
 
	g³”_ids
 = 
vec
![];

717 
_
 
š
 
	g»giÚ
.
g‘_³”s
() {

718 
	g³”_ids
.
push
(
£lf
.
®loc_id
().
unw¿p
());

720 
	g»¥
.
£t_Ãw_³”_ids
(
³”_ids
);

722 
	gBox
::
Ãw
(
ok
(
»¥
))

725 
â
 
¡Üe_h—¹b—t
(&
£lf
, 
¡©s
: 
pdpb
::
StÜeSts
è-> 
PdFutu»
<()> {

726 
Ët
 
E¼
(
e
èğ
£lf
.
check_boÙ¡¿p
() {

727  
Box
::
Ãw
(
”r
(
e
));

731 
Ët
 
	g¡Üe_id
 = 
¡©s
.
g‘_¡Üe_id
();

732 
	g£lf
.
	gşu¡”
.
wl
().
	g¡Üe_¡©s
.
š£¹
(
¡Üe_id
, 
¡©s
);

734 
	gBox
::
Ãw
(
ok
(()))

737 
â
 
»pÜt_¥l™
(&
£lf
, 
_
: 
m‘­b
::
RegiÚ
, _: m‘­b::RegiÚè-> 
PdFutu»
<()> {

739 
Ët
 
E¼
(
e
èğ
£lf
.
check_boÙ¡¿p
() {

740  
Box
::
Ãw
(
”r
(
e
));

742 
	g£lf
.
	gşu¡”
.
wl
().
	g¥l™_couÁ
 += 1;

743 
	gBox
::
Ãw
(
ok
(()))

	@tests/raftstore/server.rs

14 
u£
 
	g¡d
::
cŞËùiÚs
::{
HashM­
, 
	gHashS‘
};

15 
u£
 
	g¡d
::
sync
::{
mpsc
, 
	gArc
, 
	gRwLock
};

16 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

17 
u£
 
	g¡d
::
boxed
::
FnBox
;

19 
u£
 
	gg½c
::
EnvBud”
;

20 
u£
 
	g‹mpdœ
::
TempDœ
;

22 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

23 
u£
 
	gtikv
::
cÚfig
::
TiKvCÚfig
;

24 
u£
 
	gtikv
::
£rv”
::{
S”v”
, 
	gS”v”T¿n¥Üt
};

25 
u£
 
	gtikv
::
£rv”
::{
ü—‹_¿á_¡Üage
, 
	gCÚfig
, 
	gNode
, 
	gPdStÜeAddrResŞv”
, 
	gRaáCl›Á
};

26 
u£
 
	gtikv
::
£rv”
::
»sŞve
::{
£lf
, 
Task
 
as
 
	gResŞveTask
};

27 
u£
 
	gtikv
::
£rv”
::
Œª¥Üt
::
S”v”RaáStÜeRou‹r
;

28 
u£
 
	gtikv
::
£rv”
::
Œª¥Üt
::
RaáStÜeRou‹r
;

29 
u£
 
	gtikv
::
¿á¡Üe
::{
¡Üe
, 
	gE¼Ü
, 
	gResuÉ
};

30 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::{
Engšes
, 
Msg
 
as
 
	gStÜeMsg
, 
	gSÇpMªag”
};

31 
u£
 
	gtikv
::
¿á¡Üe
::
cİroûssÜ
::
CİroûssÜHo¡
;

32 
u£
 
	gtikv
::
ut
::
Œª¥Üt
::
S’dCh
;

33 
u£
 
	gtikv
::
ut
::
£cur™y
::
Secur™yMªag”
;

34 
u£
 
	gtikv
::
ut
::
wÜk”
::{
Futu»WÜk”
, 
	gWÜk”
};

35 
u£
 
	gtikv
::
¡Üage
::{
CfName
, 
	gEngše
};

36 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
£lf
, 
	gRaáMes§ge
};

37 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::*;

39 
u£
 
	gsu³r
::
pd
::
Te¡PdCl›Á
;

40 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

42 
ty³
 
	gSimuÏ‹StÜeT¿n¥Üt
 = 
SimuÏ‹T¿n¥Üt
<
StÜeMsg
, 
	gS”v”RaáStÜeRou‹r
>;

43 
ty³
 
	gSimuÏ‹S”v”T¿n¥Üt
 = 
SimuÏ‹T¿n¥Üt
<

44 
RaáMes§ge
,

45 
	gS”v”T¿n¥Üt
<
	gSimuÏ‹StÜeT¿n¥Üt
, 
	gPdStÜeAddrResŞv”
>,

48 
	sS”v”M‘a
 {

49 
	mnode
: 
Node
<
Te¡PdCl›Á
>,

50 
	m£rv”
: 
S”v”
<
SimuÏ‹StÜeT¿n¥Üt
, 
	mPdStÜeAddrResŞv”
>,

51 
	mrou‹r
: 
SimuÏ‹StÜeT¿n¥Üt
,

52 
	msim_Œªs
: 
SimuÏ‹S”v”T¿n¥Üt
,

53 
	m¡Üe_ch
: 
S’dCh
<
StÜeMsg
>,

54 
	mwÜk”
: 
WÜk”
<
ResŞveTask
>,

57 
pub
 
	sS”v”Clu¡”
 {

58 
	mm‘as
: 
HashM­
<
u64
, 
	mS”v”M‘a
>,

59 
	maddrs
: 
HashM­
<
u64
, 
	mSŒšg
>,

60 
pub
 
	m¡Üages
: 
HashM­
<
u64
, 
	mBox
<
	mEngše
>>,

61 
	m¢­_·ths
: 
HashM­
<
u64
, 
	mTempDœ
>,

62 
	mpd_ş›Á
: 
Arc
<
Te¡PdCl›Á
>,

63 
	m¿á_ş›Á
: 
RaáCl›Á
,

66 
im¶
 
	gS”v”Clu¡”
 {

67 
pub
 
â
 
Ãw
(
pd_ş›Á
: 
Arc
<
Te¡PdCl›Á
>è-> 
S”v”Clu¡”
 {

68 
Ët
 
’v
 = 
Arc
::
Ãw
(

69 
EnvBud”
::
Ãw
()

70 .
cq_couÁ
(1)

71 .
Çme_´efix
(
thd_Çme
!("server-cluster"))

72 .
bud
(),

74 
Ët
 
	g£cur™y_mgr
 = 
Arc
::
Ãw
(
Secur™yMªag”
::Ãw(&
DeçuÉ
::()).
unw¿p
());

75 
	gS”v”Clu¡”
 {

76 
	gm‘as
: 
HashM­
::
Ãw
(),

77 
	gaddrs
: 
HashM­
::
Ãw
(),

78 
	gpd_ş›Á
: 
pd_ş›Á
,

79 
	g¡Üages
: 
HashM­
::
Ãw
(),

80 
	g¢­_·ths
: 
HashM­
::
Ãw
(),

81 
	g¿á_ş›Á
: 
RaáCl›Á
::
Ãw
(
’v
, 
Arc
::Ãw(
CÚfig
::()), 
£cur™y_mgr
),

85 
pub
 
â
 
g‘_addr
(&
£lf
, 
node_id
: 
u64
è-> &
¡r
 {

86 &
£lf
.
addrs
[&
node_id
]

90 
im¶
 
SimuÏtÜ
 
S”v”Clu¡”
 {

91 #[
®low
(
u£Ëss_fÜm©
)]

92 
â
 
run_node
(&
mut
 
£lf
, 
node_id
: 
u64
, muˆ
cfg
: 
TiKvCÚfig
, 
’gšes
: 
Engšes
) -> u64 {

93 
as£¹
!(
node_id
 =ğ0 || !
£lf
.
m‘as
.
cÚšs_key
(&node_id));

95 
Ët
 (
tmp_¡r
, 
tmp
èğ
node_id
 =ğ0 || !
£lf
.
¢­_·ths
.
cÚšs_key
(&node_id) {

96 
Ët
 
p
 = 
TempDœ
::
Ãw
("‹¡_şu¡”").
unw¿p
();

97 (
	gp
.
·th
().
to_¡r
().
unw¿p
().
to_owÃd
(), 
Some
(
p
))

99 
Ët
 
	gp
 = 
£lf
.
¢­_·ths
[&
node_id
].
·th
().
to_¡r
().
unw¿p
();

100 (
	gp
.
to_owÃd
(), 
	gNÚe
)

105 
Ët
 
Some
(
addr
èğ
£lf
.
addrs
.
g‘
(&
node_id
) {

106 
cfg
.
£rv”
.
addr
 =‡ddr.
şÚe
();

110 
Ët
 
mut
 
	gev’t_loİ
 = 
¡Üe
::
ü—‹_ev’t_loİ
(&
cfg
.
¿á_¡Üe
).
unw¿p
();

111 
Ët
 
	g¡Üe_£ndch
 = 
S’dCh
::
Ãw
(
ev’t_loİ
.
chªÃl
(), "raftstore");

112 
Ët
 (
¢­_¡©us_£nd”
, 
¢­_¡©us_»ûiv”
èğ
mpsc
::
chªÃl
();

113 
Ët
 
	g¿á_rou‹r
 = 
S”v”RaáStÜeRou‹r
::
Ãw
(
¡Üe_£ndch
.
şÚe
(), 
¢­_¡©us_£nd”
);

114 
Ët
 
	gsim_rou‹r
 = 
SimuÏ‹T¿n¥Üt
::
Ãw
(
¿á_rou‹r
);

117 
Ët
 
mut
 
	g¡Üe
 =

118 
ü—‹_¿á_¡Üage
(
sim_rou‹r
.
şÚe
(), 
’gšes
.
kv_’gše
.şÚe(), &
cfg
.
¡Üage
)

119 .
unw¿p
();

120 
	g¡Üe
.
¡¬t
(&
cfg
.
¡Üage
).
unw¿p
();

121 
	g£lf
.
	g¡Üages
.
š£¹
(
node_id
, 
¡Üe
.
g‘_’gše
());

124 
Ët
 (
wÜk”
, 
»sŞv”
èğ
»sŞve
::
Ãw_»sŞv”
(
£lf
.
pd_ş›Á
.
şÚe
()).
unw¿p
();

125 
Ët
 
	g¢­_mgr
 = 
SÇpMªag”
::
Ãw
(
tmp_¡r
, 
Some
(
¡Üe_£ndch
), 
NÚe
);

126 
Ët
 
	gpd_wÜk”
 = 
Futu»WÜk”
::
Ãw
("test-pd-worker");

127 
Ët
 
	g£rv”_cfg
 = 
Arc
::
Ãw
(
cfg
.
£rv”
.
şÚe
());

128 
Ët
 
	g£cur™y_mgr
 = 
Arc
::
Ãw
(
Secur™yMªag”
::Ãw(&
cfg
.
£cur™y
).
unw¿p
());

129 
Ët
 
mut
 
	g£rv”
 = 
S”v”
::
Ãw
(

130 &
£rv”_cfg
,

131 &
£cur™y_mgr
,

132 
cfg
.
cİroûssÜ
.
»giÚ_¥l™_size
.0 
as
 
usize
,

133 
¡Üe
.
şÚe
(),

134 
sim_rou‹r
.
şÚe
(),

135 
»sŞv”
,

136 
¢­_mgr
.
şÚe
(),

137 
pd_wÜk”
.
scheduËr
(),

138 
Some
(
’gšes
.
şÚe
()),

139 ).
unw¿p
();

140 
Ët
 
	gaddr
 = 
£rv”
.
li¡’šg_addr
();

141 
	gcfg
.
	g£rv”
.
	gaddr
 = 
fÜm©
!("{}",‡ddr);

142 
Ët
 
	gŒªs
 = 
£rv”
.
Œª¥Üt
();

143 
Ët
 
	gsimuÏ‹_Œªs
 = 
SimuÏ‹T¿n¥Üt
::
Ãw
(
Œªs
.
şÚe
());

144 
Ët
 
	g£rv”_cfg
 = 
Arc
::
Ãw
(
cfg
.
£rv”
.
şÚe
());

147 
Ët
 
mut
 
	gnode
 = 
Node
::
Ãw
(

148 &
mut
 
ev’t_loİ
,

149 &
cfg
.
£rv”
,

150 &
cfg
.
¿á_¡Üe
,

151 
£lf
.
pd_ş›Á
.
şÚe
(),

155 
Ët
 
	gcİroûssÜ_ho¡
 = 
CİroûssÜHo¡
::
Ãw
(
cfg
.
cİroûssÜ
, 
node
.
g‘_£ndch
());

157 
	gnode
.
¡¬t
(

158 
ev’t_loİ
,

159 
’gšes
,

160 
simuÏ‹_Œªs
.
şÚe
(),

161 
¢­_mgr
.
şÚe
(),

162 
¢­_¡©us_»ûiv”
,

163 
pd_wÜk”
,

164 
cİroûssÜ_ho¡
,

165 ).
unw¿p
();

166 
	gas£¹
!(
	gnode_id
 =ğ0 || 
node_id
 =ğ
node
.
id
());

167 
Ët
 
	gnode_id
 = 
node
.
id
();

168 
Ët
 
Some
(
tmp
) =mp {

169 
£lf
.
¢­_·ths
.
š£¹
(
node_id
, 
tmp
);

172 
	g£rv”
.
¡¬t
(
£rv”_cfg
, 
£cur™y_mgr
).
unw¿p
();

174 
	g£lf
.
	gm‘as
.
š£¹
(

175 
node_id
,

176 
S”v”M‘a
 {

177 
¡Üe_ch
: 
node
.
g‘_£ndch
(),

178 
node
:‚ode,

179 
£rv”
: server,

180 
rou‹r
: 
sim_rou‹r
,

181 
sim_Œªs
: 
simuÏ‹_Œªs
,

182 
wÜk”
: worker,

185 
	g£lf
.
	gaddrs
.
š£¹
(
node_id
, 
fÜm©
!("{}", 
addr
));

187 
	gnode_id


190 
â
 
g‘_¢­_dœ
(&
£lf
, 
node_id
: 
u64
è-> 
SŒšg
 {

191 
£lf
.
¢­_·ths
[&
node_id
]

192 .
·th
()

193 .
to_¡r
()

194 .
unw¿p
()

195 .
to_owÃd
()

198 
â
 
¡İ_node
(&
mut
 
£lf
, 
node_id
: 
u64
) {

199 
Ët
 
Some
(
mut
 
m‘a
èğ
£lf
.
m‘as
.
»move
(&
node_id
) {

200 
m‘a
.
£rv”
.
¡İ
().
unw¿p
();

201 
	gm‘a
.
	gnode
.
¡İ
().
unw¿p
();

202 
	gm‘a
.
	gwÜk”
.
¡İ
().
unw¿p
().
još
().unwrap();

206 
â
 
g‘_node_ids
(&
£lf
è-> 
	gHashS‘
<
	gu64
> {

207 
	g£lf
.
	gm‘as
.
keys
().
şÚed
().
cŞËù
()

210 
â
 
ÿÎ_commªd_Ú_node
(

211 &
£lf
,

212 
node_id
: 
u64
,

213 
»que¡
: 
RaáCmdReque¡
,

214 
timeout
: 
Du¿tiÚ
,

215 è-> 
	gResuÉ
<
	gRaáCmdRe¥Ú£
> {

216 
Ët
 
	grou‹r
 = 
m©ch
 
£lf
.
m‘as
.
g‘
(&
node_id
) {

217 
NÚe
 =>  
E¼
(
box_”r
!("missšg s’d” fÜ stÜ{}", 
node_id
)),

218 
Some
(
m‘a
è=> m‘a.
rou‹r
.
şÚe
(),

220 
	gwa™_İ
!(

221 |
	gcb
: 
Box
<
FnBox
(
RaáCmdRe¥Ú£
) + 'static + Send>| {

222 
rou‹r
.
£nd_commªd
(
»que¡
, 
cb
).
unw¿p
()

224 
	gtimeout


225 ).
ok_Ü_–£
(|| {

226 
E¼Ü
::
Timeout
(
fÜm©
!("»que¡imeouˆfÜ {:?}", 
timeout
))

230 
â
 
£nd_¿á_msg
(&
mut
 
£lf
, 
¿á_msg
: 
¿á_£rv”pb
::
RaáMes§ge
è-> 
ResuÉ
<()> {

231 
Ët
 
¡Üe_id
 = 
¿á_msg
.
g‘_to_³”
().
g‘_¡Üe_id
();

232 
Ët
 
	gaddr
 = 
£lf
.
g‘_addr
(
¡Üe_id
).
to_owÃd
();

233 
	g£lf
.
	g¿á_ş›Á
.
£nd
(
¡Üe_id
, &
addr
, 
¿á_msg
).
unw¿p
();

234 
	g£lf
.
	g¿á_ş›Á
.
æush
();

235 
Ok
(())

238 
â
 
	$add_£nd_f‹r
(&
mut
 
£lf
, 
node_id
: 
u64
, 
f‹r
: 
S’dF‹r
) {

239 
£lf
.
m‘as


240 .
	`g‘_mut
(&
node_id
)

241 .
	`unw¿p
()

242 .
sim_Œªs


243 .
	`add_f‹r
(
f‹r
);

244 
	}
}

246 
â
 
	$ş—r_£nd_f‹rs
(&
mut
 
£lf
, 
node_id
: 
u64
) {

247 
£lf
.
m‘as


248 .
	`g‘_mut
(&
node_id
)

249 .
	`unw¿p
()

250 .
sim_Œªs


251 .
	`ş—r_f‹rs
();

252 
	}
}

254 
â
 
	$add_»cv_f‹r
(&
mut
 
£lf
, 
node_id
: 
u64
, 
f‹r
: 
RecvF‹r
) {

255 
£lf
.
m‘as


256 .
	`g‘_mut
(&
node_id
)

257 .
	`unw¿p
()

258 .
rou‹r


259 .
	`add_f‹r
(
f‹r
);

260 
	}
}

262 
â
 
	$ş—r_»cv_f‹rs
(&
mut
 
£lf
, 
node_id
: 
u64
) {

263 
£lf
.
m‘as
.
	`g‘_mut
(&
node_id
).
	`unw¿p
().
rou‹r
.
	`ş—r_f‹rs
();

264 
	}
}

266 
â
 
g‘_¡Üe_£ndch
(&
£lf
, 
node_id
: 
u64
è-> 
O±iÚ
<
S’dCh
<
StÜeMsg
>> {

267 
£lf
.
m‘as
.
g‘
(&
node_id
).
m­
(|
m
| m.
¡Üe_ch
.
şÚe
())

271 
pub
 
â
 
Ãw_£rv”_şu¡”
(
id
: 
u64
, 
couÁ
: 
usize
è-> 
Clu¡”
<
S”v”Clu¡”
> {

272 
Ãw_£rv”_şu¡”_w™h_cfs
(
id
, 
couÁ
, &[])

275 
pub
 
â
 
Ãw_£rv”_şu¡”_w™h_cfs
(

276 
id
: 
u64
,

277 
couÁ
: 
usize
,

278 
cfs
: &[
CfName
],

279 è-> 
	gClu¡”
<
	gS”v”Clu¡”
> {

280 
Ët
 
	gpd_ş›Á
 = 
Arc
::
Ãw
(
Te¡PdCl›Á
::Ãw(
id
));

281 
Ët
 
	gsim
 = 
Arc
::
Ãw
(
RwLock
::Ãw(
S”v”Clu¡”
::Ãw(
pd_ş›Á
.
şÚe
())));

282 
	gClu¡”
::
Ãw
(
id
, 
couÁ
, 
cfs
, 
sim
, 
pd_ş›Á
)

	@tests/raftstore/transport_simulate.rs

14 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

15 
u£
 
	gkv´Ùo
::
”aápb
::
Mes§geTy³
;

16 
u£
 
	gtikv
::
¿á¡Üe
::{
E¼Ü
, 
	gResuÉ
};

17 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::{
Msg
 
as
 
StÜeMsg
, 
	gSignifiÿÁMsg
, 
	gT¿n¥Üt
};

18 
u£
 
	gtikv
::
£rv”
::
Œª¥Üt
::*;

19 
u£
 
	gtikv
::
£rv”
::
StÜeAddrResŞv”
;

20 
u£
 
	gtikv
::
ut
::{
Œª¥Üt
, 
	gE™h”
, 
	gHªdyRwLock
};

22 
u£
 
	g¿nd
;

23 
u£
 
	g¡d
::
cŞËùiÚs
::
HashM­
;

24 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gMu‹x
, 
	gRwLock
};

25 
u£
 
	g¡d
::
sync
::
mpsc
::
S’d”
;

26 
u£
 
	g¡d
::
m¬k”
::
PhªtomD©a
;

27 
u£
 
	g¡d
::{
th»ad
, 
	gtime
, 
	gusize
};

28 
u£
 
	g¡d
::
sync
::
©omic
::*;

30 
pub
 
Œa™
 
	gChªÃl
<
	gM
>: 
S’d
 + 
ClÚe
 {

31 
â
 
£nd
(&
£lf
, 
m
: 
M
è-> 
ResuÉ
<()>;

32 
â
 
signifiÿÁ_£nd
(&
£lf
, 
_
: 
SignifiÿÁMsg
è-> 
ResuÉ
<()> {

33 
unim¶em’‹d
!()

35 
â
 
æush
(&
mut
 
£lf
) {}

38 
im¶
<
T
, 
	gS
> 
	gChªÃl
<
	gRaáMes§ge
> 
	gS”v”T¿n¥Üt
<
	gT
, S>

39 
wh”e


40 
	gT
: 
RaáStÜeRou‹r
,

41 
	gS
: 
StÜeAddrResŞv”
,

43 
â
 
£nd
(&
£lf
, 
m
: 
RaáMes§ge
è-> 
ResuÉ
<()> {

44 
T¿n¥Üt
::
£nd
(
£lf
, 
m
)

47 
â
 
æush
(&
mut
 
£lf
) {

48 
	g£lf
.
æush_¿á_ş›Á
();

52 
im¶
 
	gChªÃl
<
	gStÜeMsg
> 
	gS”v”RaáStÜeRou‹r
 {

53 
â
 
£nd
(&
£lf
, 
m
: 
StÜeMsg
è-> 
ResuÉ
<()> {

54 
RaáStÜeRou‹r
::
Œy_£nd
(
£lf
, 
m
)

57 
â
 
signifiÿÁ_£nd
(&
£lf
, 
msg
: 
SignifiÿÁMsg
è-> 
ResuÉ
<()> {

58 
RaáStÜeRou‹r
::
signifiÿÁ_£nd
(
£lf
, 
msg
)

62 
pub
 
â
 
	gcheck_mes§ges
<
	gM
>(
	gmsgs
: &[
M
]è-> 
ResuÉ
<()> {

63 
msgs
.
is_em±y
() {

64 
E¼
(
E¼Ü
::
T¿n¥Üt
(
Œª¥Üt
::E¼Ü::
Disÿrd
(
SŒšg
::
äom
(

69 
Ok
(())

73 
pub
 
Œa™
 
	gF‹r
<
	gM
>: 
S’d
 + 
Sync
 {

75 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
M
>è-> 
ResuÉ
<()>;

78 
â
 
aá”
(&
£lf
, 
»s
: 
ResuÉ
<()>) -> Result<()> {

79 
»s


83 
pub
 
ty³
 
S’dF‹r
 = 
Box
<
F‹r
<
RaáMes§ge
>>;

84 
pub
 
ty³
 
	gRecvF‹r
 = 
Box
<
F‹r
<
StÜeMsg
>>;

86 #[
d”ive
(
ClÚe
)]

87 
pub
 
	sDrİPack‘F‹r
 {

88 
	m¿‹
: 
u32
,

91 
im¶
 
	gDrİPack‘F‹r
 {

92 
pub
 
â
 
Ãw
(
¿‹
: 
u32
è-> 
DrİPack‘F‹r
 {

93 
DrİPack‘F‹r
 { 
¿‹
:„ate }

97 
im¶
<
M
> 
F‹r
<M> 
DrİPack‘F‹r
 {

98 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
M
>è-> 
ResuÉ
<()> {

99 
msgs
.
»š
(|
_
| 
¿nd
::
¿ndom
::<
u32
>(è% 100u32 >ğ
£lf
.
¿‹
);

100 
check_mes§ges
(
msgs
)

104 #[
d”ive
(
ClÚe
)]

105 
pub
 
	sD–ayF‹r
 {

106 
	mdu¿tiÚ
: 
time
::
Du¿tiÚ
,

109 
im¶
 
	gD–ayF‹r
 {

110 
pub
 
â
 
Ãw
(
du¿tiÚ
: 
time
::
Du¿tiÚ
è-> 
D–ayF‹r
 {

111 
D–ayF‹r
 { 
du¿tiÚ
: duration }

115 
im¶
<
M
> 
F‹r
<M> 
D–ayF‹r
 {

116 
â
 
befÜe
(&
£lf
, 
_
: &
mut
 
Vec
<
M
>è-> 
ResuÉ
<()> {

117 
th»ad
::
¦“p
(
£lf
.
du¿tiÚ
);

118 
Ok
(())

122 
pub
 
	gSimuÏ‹T¿n¥Üt
<
	gM
, 
	gC
: 
ChªÃl
<
M
>> {

123 
f‹rs
: 
Arc
<
RwLock
<
Vec
<
Box
<
F‹r
<
M
>>>>>,

124 
	gch
: 
Arc
<
Mu‹x
<
C
>>,

127 
	gim¶
<
	gM
, 
	gC
: 
ChªÃl
<
M
>> 
SimuÏ‹T¿n¥Üt
<M, C> {

128 
pub
 
â
 
Ãw
(
ch
: 
C
è-> 
SimuÏ‹T¿n¥Üt
<
M
, 
	gC
> {

129 
	gSimuÏ‹T¿n¥Üt
 {

130 
	gf‹rs
: 
Arc
::
Ãw
(
RwLock
::Ãw(
vec
![])),

131 
	gch
: 
Arc
::
Ãw
(
Mu‹x
::Ãw(
ch
)),

135 
pub
 
â
 
ş—r_f‹rs
(&
mut
 
£lf
) {

136 
	g£lf
.
	gf‹rs
.
wl
().
ş—r
();

139 
pub
 
â
 
add_f‹r
(&
mut
 
£lf
, 
f‹r
: 
Box
<
F‹r
<
M
>>) {

140 
£lf
.
f‹rs
.
wl
().
push
(
f‹r
);

144 
	gim¶
<
	gM
, 
	gC
: 
ChªÃl
<
M
>> ChªÃl<M> 
SimuÏ‹T¿n¥Üt
<M, C> {

145 
â
 
£nd
(&
£lf
, 
msg
: 
M
è-> 
ResuÉ
<()> {

146 
Ët
 
mut
 
k’
 = 0;

147 
Ët
 
mut
 
	gmsgs
 = 
vec
![
msg
];

148 
Ët
 
	gf‹rs
 = 
£lf
.
f‹rs
.
¾
();

149 
Ët
 
mut
 
	g»s
 = 
Ok
(());

150 
f‹r
 
š
 
	gf‹rs
.
™”
() {

151 
	gk’
 += 1;

152 
	g»s
 = 
f‹r
.
befÜe
(&
mut
 
msgs
);

153 
	g»s
.
is_”r
() {

157 
	g»s
.
is_ok
() {

158 
msg
 
š
 
	gmsgs
 {

159 
	g»s
 = 
£lf
.
ch
.
lock
().
unw¿p
().
£nd
(
msg
);

160 
	g»s
.
is_”r
() {

165 
f‹r
 
š
 
	gf‹rs
[..
k’
].
™”
().
»v
() {

166 
	g»s
 = 
f‹r
.
aá”
(
»s
);

168 
	g»s


172 
	gim¶
<
	gM
, 
	gC
: 
ChªÃl
<
M
>> 
ClÚe
 
SimuÏ‹T¿n¥Üt
<M, C> {

173 
â
 
şÚe
(&
£lf
è-> 
	gSimuÏ‹T¿n¥Üt
<
	gM
, 
	gC
> {

174 
	gSimuÏ‹T¿n¥Üt
 {

175 
	gf‹rs
: 
£lf
.
f‹rs
.
şÚe
(),

176 
	gch
: 
£lf
.
ch
.
şÚe
(),

181 
	gim¶
<
	gC
: 
ChªÃl
<
RaáMes§ge
>> 
T¿n¥Üt
 
SimuÏ‹T¿n¥Üt
<RaftMessage, C> {

182 
â
 
£nd
(&
£lf
, 
m
: 
RaáMes§ge
è-> 
ResuÉ
<()> {

183 
ChªÃl
::
£nd
(
£lf
, 
m
)

186 
â
 
æush
(&
mut
 
£lf
) {

187 
	g£lf
.
	gch
.
lock
().
unw¿p
().
æush
();

191 
	gim¶
<
	gC
: 
ChªÃl
<
StÜeMsg
>> 
RaáStÜeRou‹r
 
SimuÏ‹T¿n¥Üt
<StoreMsg, C> {

192 
â
 
£nd
(&
£lf
, 
m
: 
StÜeMsg
è-> 
ResuÉ
<()> {

193 
ChªÃl
::
£nd
(
£lf
, 
m
)

196 
â
 
Œy_£nd
(&
£lf
, 
m
: 
StÜeMsg
è-> 
ResuÉ
<()> {

197 
ChªÃl
::
£nd
(
£lf
, 
m
)

200 
â
 
signifiÿÁ_£nd
(&
£lf
, 
m
: 
SignifiÿÁMsg
è-> 
ResuÉ
<()> {

201 
£lf
.
ch
.
lock
().
unw¿p
().
signifiÿÁ_£nd
(
m
)

205 
pub
 
Œa™
 
F‹rFaùÜy
 {

206 
â
 
g’”©e
(&
£lf
, 
node_id
: 
u64
è-> 
Vec
<
S’dF‹r
>;

209 #[
d”ive
(
DeçuÉ
)]

210 
pub
 
	gDeçuÉF‹rFaùÜy
<
	gF
: 
F‹r
<
RaáMes§ge
> + 
DeçuÉ
>(
PhªtomD©a
<
F
>);

212 
	gim¶
<
	gF
: 
F‹r
<
RaáMes§ge
> + 
DeçuÉ
 + 'static> FilterFactory for DefaultFilterFactory<F> {

213 
â
 
g’”©e
(&
£lf
, 
_
: 
u64
è-> 
Vec
<
S’dF‹r
> {

214 
vec
![
Box
::
Ãw
(
F
::())]

218 
pub
 
ClÚeF‹rFaùÜy
<
F
: 
F‹r
<
RaáMes§ge
> + 
ClÚe
>(pub F);

220 
	gim¶
<
	gF
: 
F‹r
<
RaáMes§ge
> + 
ClÚe
 + 'static> FilterFactory for CloneFilterFactory<F> {

221 
â
 
g’”©e
(&
£lf
, 
_
: 
u64
è-> 
Vec
<
S’dF‹r
> {

222 
vec
![
Box
::
Ãw
(
£lf
.0.ş
Úe
())]

226 
	sP¬t™iÚF‹r
 {

227 
node_ids
: 
Vec
<
u64
>,

230 
im¶
 
	gF‹r
<
	gRaáMes§ge
> 
	gP¬t™iÚF‹r
 {

231 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
RaáMes§ge
>è-> 
ResuÉ
<()> {

232 
msgs
.
»š
(|
m
| !
£lf
.
node_ids
.
cÚšs
(&m.
g‘_to_³”
().
g‘_¡Üe_id
()));

233 
check_mes§ges
(
msgs
)

237 
pub
 
	sP¬t™iÚF‹rFaùÜy
 {

238 
	ms1
: 
Vec
<
u64
>,

239 
	ms2
: 
Vec
<
u64
>,

242 
im¶
 
	gP¬t™iÚF‹rFaùÜy
 {

243 
pub
 
â
 
Ãw
(
s1
: 
Vec
<
u64
>, 
s2
: Vec<u64>è-> 
P¬t™iÚF‹rFaùÜy
 {

244 
P¬t™iÚF‹rFaùÜy
 { 
s1
: s1, 
	gs2
: 
s2
 }

248 
im¶
 
F‹rFaùÜy
 
P¬t™iÚF‹rFaùÜy
 {

249 
â
 
g’”©e
(&
£lf
, 
node_id
: 
u64
è-> 
Vec
<
S’dF‹r
> {

250 
£lf
.
s1
.
cÚšs
(&
node_id
) {

251  
vec
![

252 
box
 
P¬t™iÚF‹r
 {

253 
node_ids
: 
£lf
.
s2
.
şÚe
(),

257  
	gvec
![

258 
box
 
P¬t™iÚF‹r
 {

259 
node_ids
: 
£lf
.
s1
.
şÚe
(),

265 
pub
 
	sIsŞ©iÚF‹rFaùÜy
 {

266 
	mnode_id
: 
u64
,

269 
im¶
 
	gIsŞ©iÚF‹rFaùÜy
 {

270 
pub
 
â
 
Ãw
(
node_id
: 
u64
è-> 
IsŞ©iÚF‹rFaùÜy
 {

271 
IsŞ©iÚF‹rFaùÜy
 { 
node_id
:‚ode_id }

275 
im¶
 
F‹rFaùÜy
 
IsŞ©iÚF‹rFaùÜy
 {

276 
â
 
g’”©e
(&
£lf
, 
node_id
: 
u64
è-> 
Vec
<
S’dF‹r
> {

277 
node_id
 =ğ
£lf
.node_id {

278  
vec
![
box
 
DrİPack‘F‹r
 { 
¿‹
: 100 }];

280 
	gvec
![

281 
box
 
P¬t™iÚF‹r
 {

282 
node_ids
: 
vec
![
£lf
.
node_id
],

288 #[
d”ive
(
ClÚe
, 
Cİy
)]

289 
pub
 
	eDœeùiÚ
 {

290 
	mRecv
,

291 
	mS’d
,

292 
	mBÙh
,

295 
im¶
 
	gDœeùiÚ
 {

296 
pub
 
â
 
is_»cv
(&
£lf
è-> 
	gboŞ
 {

297 
m©ch
 *
	g£lf
 {

298 
	gDœeùiÚ
::
Recv
 | 
DœeùiÚ
::
BÙh
 => 
Œue
,

299 
	gDœeùiÚ
::
S’d
 => 
çl£
,

303 
pub
 
â
 
is_£nd
(&
£lf
è-> 
	gboŞ
 {

304 
m©ch
 *
	g£lf
 {

305 
	gDœeùiÚ
::
S’d
 | 
DœeùiÚ
::
BÙh
 => 
Œue
,

306 
	gDœeùiÚ
::
Recv
 => 
çl£
,

314 #[
d”ive
(
ClÚe
)]

315 
pub
 
	sRegiÚPack‘F‹r
 {

316 
	m»giÚ_id
: 
u64
,

317 
	m¡Üe_id
: 
u64
,

318 
	mdœeùiÚ
: 
DœeùiÚ
,

319 
	mblock
: 
E™h”
<
Arc
<
AtomicUsize
>, 
	mArc
<
	mAtomicBoŞ
>>,

320 
	mmsg_ty³
: 
O±iÚ
<
Mes§geTy³
>,

323 
im¶
 
	gF‹r
<
	gRaáMes§ge
> 
	gRegiÚPack‘F‹r
 {

324 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
RaáMes§ge
>è-> 
ResuÉ
<()> {

325 
msgs
.
»š
(|
m
| {

326 
Ët
 
»giÚ_id
 = 
m
.
g‘_»giÚ_id
();

327 
Ët
 
äom_¡Üe_id
 = 
m
.
g‘_äom_³”
().
g‘_¡Üe_id
();

328 
Ët
 
to_¡Üe_id
 = 
m
.
g‘_to_³”
().
g‘_¡Üe_id
();

330 
£lf
.
»giÚ_id
 ==„egion_id &&

331 (
£lf
.
dœeùiÚ
.
is_£nd
(è&& s–f.
¡Üe_id
 =ğ
äom_¡Üe_id
 ||

332 
£lf
.
dœeùiÚ
.
is_»cv
(è&& s–f.
¡Üe_id
 =ğ
to_¡Üe_id
) &&

333 
£lf
.
msg_ty³


334 .
as_»f
()

335 .
m­_Ü
(
Œue
, |
t
| =ğ&
m
.
g‘_mes§ge
().
g‘_msg_ty³
())

337  
m©ch
 
£lf
.
block
 {

338 
E™h”
::
Leá
(
»f
 
couÁ
è=> 
loİ
 {

339 
Ët
 
Ëá
 = 
couÁ
.
lßd
(
Ord”šg
::
SeqC¡
);

340 
Ëá
 == 0 {

341  
çl£
;

343 
couÁ
.
com·»_ªd_sw­
(
Ëá
,†eá - 1, 
Ord”šg
::
SeqC¡
) ==†eft {

344  
Œue
;

347 
E™h”
::
Right
(
»f
 
block
è=> !block.
lßd
(
Ord”šg
::
SeqC¡
),

350 
Œue


352 
check_mes§ges
(
msgs
)

356 
im¶
 
	gRegiÚPack‘F‹r
 {

357 
pub
 
â
 
Ãw
(
»giÚ_id
: 
u64
, 
¡Üe_id
: u64è-> 
RegiÚPack‘F‹r
 {

358 
RegiÚPack‘F‹r
 {

359 
»giÚ_id
:„egion_id,

360 
	g¡Üe_id
: 
¡Üe_id
,

361 
	gdœeùiÚ
: 
DœeùiÚ
::
BÙh
,

362 
	gmsg_ty³
: 
NÚe
,

363 
	gblock
: 
E™h”
::
Right
(
Arc
::
Ãw
(
AtomicBoŞ
::Ãw(
Œue
))),

367 
pub
 
â
 
dœeùiÚ
(
mut
 
£lf
, dœeùiÚ: 
DœeùiÚ
è-> 
RegiÚPack‘F‹r
 {

368 
£lf
.
dœeùiÚ
 = direction;

369 
	g£lf


372 
pub
 
â
 
msg_ty³
(
mut
 
£lf
, 
m_ty³
: 
Mes§geTy³
è-> 
RegiÚPack‘F‹r
 {

373 
£lf
.
msg_ty³
 = 
Some
(
m_ty³
);

374 
	g£lf


377 
pub
 
â
 
®low
(
mut
 
£lf
, 
numb”
: 
usize
è-> 
RegiÚPack‘F‹r
 {

378 
£lf
.
block
 = 
E™h”
::
Leá
(
Arc
::
Ãw
(
AtomicUsize
::Ãw(
numb”
)));

379 
	g£lf


382 
pub
 
â
 
wh’
(
mut
 
£lf
, 
cÚd™iÚ
: 
Arc
<
AtomicBoŞ
>è-> 
RegiÚPack‘F‹r
 {

383 
£lf
.
block
 = 
E™h”
::
Right
(
cÚd™iÚ
);

384 
	g£lf


388 #[
d”ive
(
DeçuÉ
)]

389 
pub
 
	sSÇpshÙF‹r
 {

390 
	mdrİ
: 
AtomicBoŞ
,

393 
im¶
 
	gF‹r
<
	gRaáMes§ge
> 
	gSÇpshÙF‹r
 {

394 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
RaáMes§ge
>è-> 
ResuÉ
<()> {

395 
msgs
.
»š
(|
m
| {

396 
m
.
g‘_mes§ge
().
g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgSÇpshÙ


398 
	g£lf
.
	gdrİ
.
¡Üe
(
msgs
.
is_em±y
(), 
Ord”šg
::
R–axed
);

399 
check_mes§ges
(
msgs
)

402 
â
 
aá”
(&
£lf
, 
x
: 
ResuÉ
<()>) -> Result<()> {

403 
£lf
.
drİ
.
lßd
(
Ord”šg
::
R–axed
) {

404 
Ok
(())

406 
x


415 
pub
 
	sCŞËùSÇpshÙF‹r
 {

416 
drİ³d
: 
AtomicBoŞ
,

417 
	m¡®e
: 
AtomicBoŞ
,

418 
	m³ndšg_msg
: 
Mu‹x
<
HashM­
<
u64
, 
	mStÜeMsg
>>,

419 
	m³ndšg_couÁ_£nd”
: 
Mu‹x
<
S’d”
<
usize
>>,

422 
im¶
 
	gCŞËùSÇpshÙF‹r
 {

423 
pub
 
â
 
Ãw
(
£nd”
: 
S’d”
<
usize
>è-> 
CŞËùSÇpshÙF‹r
 {

424 
CŞËùSÇpshÙF‹r
 {

425 
drİ³d
: 
AtomicBoŞ
::
Ãw
(
çl£
),

426 
	g¡®e
: 
AtomicBoŞ
::
Ãw
(
çl£
),

427 
	g³ndšg_msg
: 
Mu‹x
::
Ãw
(
HashM­
::new()),

428 
	g³ndšg_couÁ_£nd”
: 
Mu‹x
::
Ãw
(
£nd”
),

433 
im¶
 
	gF‹r
<
	gStÜeMsg
> 
	gCŞËùSÇpshÙF‹r
 {

434 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
StÜeMsg
>è-> 
ResuÉ
<()> {

435 
£lf
.
¡®e
.
lßd
(
Ord”šg
::
R–axed
) {

436  
Ok
(());

438 
Ët
 
mut
 
	gto_£nd
 = 
vec
![];

439 
Ët
 
mut
 
	g³ndšg_msg
 = 
£lf
.
³ndšg_msg
.
lock
().
unw¿p
();

440 
m
 
š
 
	gmsgs
.
d¿š
(..) {

441 
Ët
 (
is_³ndšg
, 
äom_³”_id
èğ
m©ch
 
m
 {

442 
StÜeMsg
::
RaáMes§ge
(
»f
 
msg
) => {

443 
msg
.
g‘_mes§ge
().
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgSÇpshÙ
 {

444 
Ët
 
äom_³”_id
 = 
msg
.
g‘_äom_³”
().
g‘_id
();

445 
	g³ndšg_msg
.
cÚšs_key
(&
äom_³”_id
) {

450 (
	gŒue
, 
	gäom_³”_id
)

453 (
	gçl£
, 0)

456 
	g_
 => (
çl£
, 0),

458 
	gis_³ndšg
 {

459 
	g£lf
.
	gdrİ³d


460 .
com·»_ªd_sw­
(
çl£
, 
Œue
, 
Ord”šg
::
R–axed
);

461 
	g³ndšg_msg
.
š£¹
(
äom_³”_id
, 
m
);

462 
Ët
 
	g£nd”
 = 
£lf
.
³ndšg_couÁ_£nd”
.
lock
().
unw¿p
();

463 
	g£nd”
.
£nd
(
³ndšg_msg
.
Ën
()).
unw¿p
();

465 
	gto_£nd
.
push
(
m
);

469 
	g³ndšg_msg
.
Ën
() > 1 {

470 
	g£lf
.
	gdrİ³d


471 .
com·»_ªd_sw­
(
Œue
, 
çl£
, 
Ord”šg
::
R–axed
);

472 
	gmsgs
.
ex‹nd
(
³ndšg_msg
.
d¿š
().
m­
(|(
_
, 
v
)| v));

473 
	g£lf
.
	g¡®e
.
com·»_ªd_sw­
(
çl£
, 
Œue
, 
Ord”šg
::
R–axed
);

475 
	gmsgs
.
ex‹nd
(
to_£nd
);

476 
check_mes§ges
(
msgs
)

479 
â
 
aá”
(&
£lf
, 
»s
: 
ResuÉ
<()>) -> Result<()> {

480 
»s
.
is_”r
(è&& 
£lf
.
drİ³d
.
lßd
(
Ord”šg
::
R–axed
) {

481 
£lf
.
drİ³d


482 .
com·»_ªd_sw­
(
Œue
, 
çl£
, 
Ord”šg
::
R–axed
);

483 
Ok
(())

485 
	g»s


490 
pub
 
	sDrİSÇpshÙF‹r
 {

491 
	mnÙif›r
: 
Mu‹x
<
S’d”
<
u64
>>,

494 
im¶
 
	gDrİSÇpshÙF‹r
 {

495 
pub
 
â
 
Ãw
(
ch
: 
S’d”
<
u64
>è-> 
DrİSÇpshÙF‹r
 {

496 
DrİSÇpshÙF‹r
 {

497 
nÙif›r
: 
Mu‹x
::
Ãw
(
ch
),

502 
im¶
 
	gF‹r
<
	gStÜeMsg
> 
	gDrİSÇpshÙF‹r
 {

503 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
StÜeMsg
>è-> 
ResuÉ
<()> {

504 
Ët
 
nÙif›r
 = 
£lf
.nÙif›r.
lock
().
unw¿p
();

505 
	gmsgs
.
»š
(|
m
| 
m©ch
 *m {

506 
StÜeMsg
::
RaáMes§ge
(
»f
 
msg
) => {

507 
msg
.
g‘_mes§ge
().
g‘_msg_ty³
(è!ğ
Mes§geTy³
::
MsgSÇpshÙ
 {

508 
Œue


510 
Ët
 
idx
 = 
msg
.
g‘_mes§ge
().
g‘_¢­shÙ
().
g‘_m‘ad©a
().
g‘_šdex
();

511 
Ët
 
E¼
(
e
èğ
nÙif›r
.
£nd
(
idx
) {

512 
”rÜ
!("çedØnÙify sÇpshÙ {:?}: {:?}", 
msg
, 
e
);

514 
çl£


517 
_
 => 
Œue
,

519 
Ok
(())

527 
pub
 
	sL—dšgDu¶iÿ‹dSÇpshÙF‹r
 {

528 
	mdrİ³d
: 
AtomicBoŞ
,

529 
	m¡®e
: 
Arc
<
AtomicBoŞ
>,

530 
	mÏ¡_msg
: 
Mu‹x
<
O±iÚ
<
RaáMes§ge
>>,

533 
im¶
 
	gL—dšgDu¶iÿ‹dSÇpshÙF‹r
 {

534 
pub
 
â
 
Ãw
(
¡®e
: 
Arc
<
AtomicBoŞ
>è-> 
L—dšgDu¶iÿ‹dSÇpshÙF‹r
 {

535 
L—dšgDu¶iÿ‹dSÇpshÙF‹r
 {

536 
drİ³d
: 
AtomicBoŞ
::
Ãw
(
çl£
),

537 
	g¡®e
: 
¡®e
,

538 
	gÏ¡_msg
: 
Mu‹x
::
Ãw
(
NÚe
),

543 
im¶
 
	gF‹r
<
	gStÜeMsg
> 
	gL—dšgDu¶iÿ‹dSÇpshÙF‹r
 {

544 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
StÜeMsg
>è-> 
ResuÉ
<()> {

545 
Ët
 
mut
 
Ï¡_msg
 = 
£lf
.Ï¡_msg.
lock
().
unw¿p
();

546 
Ët
 
mut
 
	g¡®e
 = 
£lf
.
¡®e
.
lßd
(
Ord”šg
::
R–axed
);

547 
	g¡®e
 {

548 
	gÏ¡_msg
.
is_some
() {

549 
	gmsgs
.
push
(
StÜeMsg
::
RaáMes§ge
(
Ï¡_msg
.
ke
().
unw¿p
()));

551  
check_mes§ges
(
msgs
);

553 
Ët
 
mut
 
	gto_£nd
 = 
vec
![];

554 
m
 
š
 
	gmsgs
.
d¿š
(..) {

555 
m©ch
 
	gm
 {

556 
	gStÜeMsg
::
RaáMes§ge
(
msg
) => {

557 
msg
.
g‘_mes§ge
().
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgSÇpshÙ
 && !
¡®e
 {

558 
Ï¡_msg
.
as_»f
().
m­_Ü
(
çl£
, |
l
|† !ğ&
msg
) {

559 
to_£nd
.
push
(
StÜeMsg
::
RaáMes§ge
(
Ï¡_msg
.
ke
().
unw¿p
()));

560 *
	gÏ¡_msg
 = 
Some
(
msg
);

561 
	g¡®e
 = 
Œue
;

563 
	g£lf
.
	gdrİ³d
.
¡Üe
(
Œue
, 
Ord”šg
::
R–axed
);

564 *
	gÏ¡_msg
 = 
Some
(
msg
);

567 
	gto_£nd
.
push
(
StÜeMsg
::
RaáMes§ge
(
msg
));

570 
	g_
 => {

571 
to_£nd
.
push
(
m
);

575 
	g£lf
.
	g¡®e
.
¡Üe
(
¡®e
, 
Ord”šg
::
R–axed
);

576 
	gmsgs
.
ex‹nd
(
to_£nd
);

577 
check_mes§ges
(
msgs
)

580 
â
 
aá”
(&
£lf
, 
»s
: 
ResuÉ
<()>) -> Result<()> {

581 
Ët
 
drİ³d
 = 
£lf
.dropped

582 .
com·»_ªd_sw­
(
Œue
, 
çl£
, 
Ord”šg
::
R–axed
);

583 
	g»s
.
is_”r
(è&& 
	gdrİ³d
 {

584 
Ok
(())

586 
	g»s


595 
pub
 
	sRªdomL©’cyF‹r
 {

596 
	md–ay_¿‹
: 
u32
,

597 
	md–ayed_msgs
: 
Mu‹x
<
Vec
<
RaáMes§ge
>>,

600 
im¶
 
	gRªdomL©’cyF‹r
 {

601 
pub
 
â
 
Ãw
(
¿‹
: 
u32
è-> 
RªdomL©’cyF‹r
 {

602 
RªdomL©’cyF‹r
 {

603 
d–ay_¿‹
: 
¿‹
,

604 
	gd–ayed_msgs
: 
Mu‹x
::
Ãw
(
vec
![]),

608 
â
 
wl_d–ay
(&
£lf
, 
_
: &
RaáMes§ge
è-> 
boŞ
 {

609 
¿nd
::
¿ndom
::<
u32
>(è% 100u32 >ğ
£lf
.
d–ay_¿‹


613 
im¶
 
F‹r
<
RaáMes§ge
> 
RªdomL©’cyF‹r
 {

614 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
RaáMes§ge
>è-> 
ResuÉ
<()> {

615 
Ët
 
mut
 
to_£nd
 = 
vec
![];

616 
Ët
 
mut
 
	gto_d–ay
 = 
vec
![];

617 
Ët
 
mut
 
	gd–ayed_msgs
 = 
£lf
.
d–ayed_msgs
.
lock
().
unw¿p
();

620 
m
 
š
 
	gd–ayed_msgs
.
d¿š
(..).
chaš
(
msgs
.drain(..)) {

621 
	g£lf
.
wl_d–ay
(&
m
) {

622 
	gto_d–ay
.
push
(
m
);

624 
	gto_£nd
.
push
(
m
);

627 
	gd–ayed_msgs
.
ex‹nd
(
to_d–ay
);

628 
	gmsgs
.
ex‹nd
(
to_£nd
);

629 
Ok
(())

633 
im¶
 
ClÚe
 
	gRªdomL©’cyF‹r
 {

634 
â
 
şÚe
(&
£lf
è-> 
	gRªdomL©’cyF‹r
 {

635 
Ët
 
	gd–ayed_msgs
 = 
£lf
.
d–ayed_msgs
.
lock
().
unw¿p
();

636 
	gRªdomL©’cyF‹r
 {

637 
	gd–ay_¿‹
: 
£lf
.
d–ay_¿‹
,

638 
	gd–ayed_msgs
: 
Mu‹x
::
Ãw
(
d–ayed_msgs
.
şÚe
()),

	@tests/raftstore/util.rs

15 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

17 
u£
 
	g¡d
::
th»ad
;

19 
u£
 
	grocksdb
::
DB
;

20 
u£
 
	g´Ùobuf
;

22 
u£
 
	gkv´Ùo
::
m‘­b
::{
£lf
, 
	gRegiÚEpoch
};

23 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
AdmšReque¡
, 
	gRaáCmdReque¡
, 
	gRaáCmdRe¥Ú£
, 
	gReque¡
, 
	gStusReque¡
};

24 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::{
AdmšCmdTy³
, 
	gCmdTy³
, 
	gStusCmdTy³
};

25 
u£
 
	gkv´Ùo
::
pdpb
::{
ChªgeP“r
, 
	gRegiÚH—¹b—tRe¥Ú£
, 
	gT¿nsãrL—d”
};

26 
u£
 
	gkv´Ùo
::
”aápb
::
CÚfChªgeTy³
;

28 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::*;

29 
u£
 
	gtikv
::
£rv”
::
CÚfig
 
as
 
S”v”CÚfig
;

30 
u£
 
	gtikv
::
¡Üage
::
CÚfig
 
as
 
StÜageCÚfig
;

31 
u£
 
	gtikv
::
ut
::
esÿ³
;

32 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

33 
u£
 
	gtikv
::
cÚfig
::
TiKvCÚfig
;

35 
pub
 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
ut
::
fšd_³”
;

37 
pub
 cÚ¡ 
	gMAX_LEADER_LEASE
: 
u64
 = 250;

39 
pub
 
â
 
mu¡_g‘
(
’gše
: &
Arc
<
DB
>, 
cf
: &
¡r
, 
key
: &[
u8
], 
v®ue
: 
O±iÚ
<&[u8]>) {

40 
_
 
š
 1..300 {

41 
Ët
 
»s
 = 
’gše
.
g‘_v®ue_cf
(
cf
, &
keys
::
d©a_key
(
key
)).
unw¿p
();

42 
	gv®ue
.
is_some
(è&& 
	g»s
.is_some() {

43 
	gas£¹_eq
!(
	gv®ue
.
unw¿p
(), &*
	g»s
.unwrap());

46 
	gv®ue
.
is_nÚe
(è&& 
	g»s
.is_none() {

49 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(20));

51 
	gdebug
!("Ï¡ryØg‘ {}", 
esÿ³
(
key
));

52 
Ët
 
	g»s
 = 
’gše
.
g‘_v®ue_cf
(
cf
, &
keys
::
d©a_key
(
key
)).
unw¿p
();

53 
	gv®ue
.
is_nÚe
(è&& 
	g»s
.is_none() ||

54 
	gv®ue
.
is_some
(è&& 
	g»s
.is_some(è&& v®ue.
unw¿p
(è=ğ&*
»s
.unwrap()

58 
	g·nic
!(

60 
	gv®ue
.
m­
(
esÿ³
),

61 
esÿ³
(
key
)

65 
pub
 
â
 
mu¡_g‘_equ®
(
’gše
: &
Arc
<
DB
>, 
key
: &[
u8
], 
v®ue
: &[u8]) {

66 
mu¡_g‘
(
’gše
, "deçuÉ", 
key
, 
Some
(
v®ue
));

69 
pub
 
â
 
mu¡_g‘_nÚe
(
’gše
: &
Arc
<
DB
>, 
key
: &[
u8
]) {

70 
mu¡_g‘
(
’gše
, "deçuÉ", 
key
, 
NÚe
);

73 
pub
 
â
 
mu¡_g‘_cf_equ®
(
’gše
: &
Arc
<
DB
>, 
cf
: &
¡r
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

74 
mu¡_g‘
(
’gše
, 
cf
, 
key
, 
Some
(
v®ue
));

77 
pub
 
â
 
mu¡_g‘_cf_nÚe
(
’gše
: &
Arc
<
DB
>, 
cf
: &
¡r
, 
key
: &[
u8
]) {

78 
mu¡_g‘
(
’gše
, 
cf
, 
key
, 
NÚe
);

81 
pub
 
â
 
Ãw_¡Üe_cfg
(è-> 
	gCÚfig
 {

82 
	gCÚfig
 {

83 
	gsync_log
: 
çl£
,

84 
	g¿á_ba£_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
mlis
(10),

85 
	g¿á_h—¹b—t_ticks
: 2,

86 
	g¿á_–eùiÚ_timeout_ticks
: 25,

87 
	g¿á_log_gc_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
mlis
(100),

88 
	g¿á_log_gc_th»shŞd
: 1,

89 
	gpd_h—¹b—t_tick_š‹rv®
: 
R—dabËDu¿tiÚ
::
mlis
(20),

90 
	g»giÚ_¥l™_check_diff
: 
R—dabËSize
(10000),

94 
	gmax_Ëad”_missšg_du¿tiÚ
: 
R—dabËDu¿tiÚ
::
£cs
(3),

95 
	g»pÜt_»giÚ_æow_š‹rv®
: 
R—dabËDu¿tiÚ
::
mlis
(100),

96 
	g¿á_¡Üe_max_Ëad”_Ëa£
: 
R—dabËDu¿tiÚ
::
mlis
(
MAX_LEADER_LEASE
),

97 
	g®low_»move_Ëad”
: 
Œue
,

98 ..
	gCÚfig
::()

102 
pub
 
â
 
Ãw_£rv”_cÚfig
(
şu¡”_id
: 
u64
è-> 
S”v”CÚfig
 {

103 
S”v”CÚfig
 {

104 
şu¡”_id
: cluster_id,

105 
	gaddr
: "127.0.0.1:0".
to_owÃd
(),

106 
	gg½c_cÚcu¼’cy
: 1,

109 
	gg½c_¿á_cÚn_num
: 1,

110 
	g’d_pošt_cÚcu¼’cy
: 1,

111 ..
	gS”v”CÚfig
::()

115 
pub
 
â
 
Ãw_tikv_cÚfig
(
şu¡”_id
: 
u64
è-> 
TiKvCÚfig
 {

116 
TiKvCÚfig
 {

117 
¡Üage
: 
StÜageCÚfig
 {

118 
scheduËr_wÜk”_poŞ_size
: 1,

119 ..
	gStÜageCÚfig
::()

121 
	g£rv”
: 
Ãw_£rv”_cÚfig
(
şu¡”_id
),

122 
	g¿á_¡Üe
: 
Ãw_¡Üe_cfg
(),

123 ..
	gTiKvCÚfig
::()

128 
pub
 
â
 
Ãw_ba£_»que¡
(
»giÚ_id
: 
u64
, 
•och
: 
RegiÚEpoch
, 
»ad_quÜum
: 
boŞ
è-> 
RaáCmdReque¡
 {

129 
Ët
 
mut
 
»q
 = 
RaáCmdReque¡
::
Ãw
();

130 
	g»q
.
mut_h—d”
().
£t_»giÚ_id
(
»giÚ_id
);

131 
	g»q
.
mut_h—d”
().
£t_»giÚ_•och
(
•och
);

132 
	g»q
.
mut_h—d”
().
£t_»ad_quÜum
(
»ad_quÜum
);

133 
	g»q


136 
pub
 
â
 
Ãw_»que¡
(

137 
»giÚ_id
: 
u64
,

138 
•och
: 
RegiÚEpoch
,

139 
»que¡s
: 
Vec
<
Reque¡
>,

140 
»ad_quÜum
: 
boŞ
,

141 è-> 
	gRaáCmdReque¡
 {

142 
Ët
 
mut
 
	g»q
 = 
Ãw_ba£_»que¡
(
»giÚ_id
, 
•och
, 
»ad_quÜum
);

143 
	g»q
.
£t_»que¡s
(
´Ùobuf
::
R•—‹dF›ld
::
äom_vec
(
»que¡s
));

144 
	g»q


147 
pub
 
â
 
Ãw_put_cmd
(
key
: &[
u8
], 
v®ue
: &[u8]è-> 
Reque¡
 {

148 
Ët
 
mut
 
cmd
 = 
Reque¡
::
Ãw
();

149 
	gcmd
.
£t_cmd_ty³
(
CmdTy³
::
Put
);

150 
	gcmd
.
mut_put
().
£t_key
(
key
.
to_vec
());

151 
	gcmd
.
mut_put
().
£t_v®ue
(
v®ue
.
to_vec
());

152 
	gcmd


155 
pub
 
â
 
Ãw_put_cf_cmd
(
cf
: &
¡r
, 
key
: &[
u8
], 
v®ue
: &[u8]è-> 
Reque¡
 {

156 
Ët
 
mut
 
cmd
 = 
Reque¡
::
Ãw
();

157 
	gcmd
.
£t_cmd_ty³
(
CmdTy³
::
Put
);

158 
	gcmd
.
mut_put
().
£t_key
(
key
.
to_vec
());

159 
	gcmd
.
mut_put
().
£t_v®ue
(
v®ue
.
to_vec
());

160 
	gcmd
.
mut_put
().
£t_cf
(
cf
.
to_¡ršg
());

161 
	gcmd


164 
pub
 
â
 
Ãw_g‘_cmd
(
key
: &[
u8
]è-> 
Reque¡
 {

165 
Ët
 
mut
 
cmd
 = 
Reque¡
::
Ãw
();

166 
	gcmd
.
£t_cmd_ty³
(
CmdTy³
::
G‘
);

167 
	gcmd
.
mut_g‘
().
£t_key
(
key
.
to_vec
());

168 
	gcmd


171 
pub
 
â
 
Ãw_d–‘e_cmd
(
cf
: &
¡r
, 
key
: &[
u8
]è-> 
Reque¡
 {

172 
Ët
 
mut
 
cmd
 = 
Reque¡
::
Ãw
();

173 
	gcmd
.
£t_cmd_ty³
(
CmdTy³
::
D–‘e
);

174 
	gcmd
.
mut_d–‘e
().
£t_key
(
key
.
to_vec
());

175 
	gcmd
.
mut_d–‘e
().
£t_cf
(
cf
.
to_¡ršg
());

176 
	gcmd


179 
pub
 
â
 
Ãw_d–‘e_¿nge_cmd
(
cf
: &
¡r
, 
¡¬t
: &[
u8
], 
’d
: &[u8]è-> 
Reque¡
 {

180 
Ët
 
mut
 
cmd
 = 
Reque¡
::
Ãw
();

181 
	gcmd
.
£t_cmd_ty³
(
CmdTy³
::
D–‘eRªge
);

182 
	gcmd
.
mut_d–‘e_¿nge
().
£t_¡¬t_key
(
¡¬t
.
to_vec
());

183 
	gcmd
.
mut_d–‘e_¿nge
().
£t_’d_key
(
’d
.
to_vec
());

184 
	gcmd
.
mut_d–‘e_¿nge
().
£t_cf
(
cf
.
to_¡ršg
());

185 
	gcmd


188 
pub
 
â
 
Ãw_¡©us_»que¡
(

189 
»giÚ_id
: 
u64
,

190 
³”
: 
m‘­b
::
P“r
,

191 
»que¡
: 
StusReque¡
,

192 è-> 
	gRaáCmdReque¡
 {

193 
Ët
 
mut
 
	g»q
 = 
Ãw_ba£_»que¡
(
»giÚ_id
, 
RegiÚEpoch
::
Ãw
(), 
çl£
);

194 
	g»q
.
mut_h—d”
().
£t_³”
(
³”
);

195 
	g»q
.
£t_¡©us_»que¡
(
»que¡
);

196 
	g»q


199 
pub
 
â
 
Ãw_»giÚ_d‘a_cmd
(è-> 
	gStusReque¡
 {

200 
Ët
 
mut
 
	gcmd
 = 
StusReque¡
::
Ãw
();

201 
	gcmd
.
£t_cmd_ty³
(
StusCmdTy³
::
RegiÚD‘a
);

202 
	gcmd


205 
pub
 
â
 
Ãw_»giÚ_Ëad”_cmd
(è-> 
	gStusReque¡
 {

206 
Ët
 
mut
 
	gcmd
 = 
StusReque¡
::
Ãw
();

207 
	gcmd
.
£t_cmd_ty³
(
StusCmdTy³
::
RegiÚL—d”
);

208 
	gcmd


211 
pub
 
â
 
Ãw_admš_»que¡
(

212 
»giÚ_id
: 
u64
,

213 
•och
: &
RegiÚEpoch
,

214 
»que¡
: 
AdmšReque¡
,

215 è-> 
	gRaáCmdReque¡
 {

216 
Ët
 
mut
 
	g»q
 = 
Ãw_ba£_»que¡
(
»giÚ_id
, 
•och
.
şÚe
(), 
çl£
);

217 
	g»q
.
£t_admš_»que¡
(
»que¡
);

218 
	g»q


221 
pub
 
â
 
Ãw_chªge_³”_»que¡
(
chªge_ty³
: 
CÚfChªgeTy³
, 
³”
: 
m‘­b
::
P“r
è-> 
AdmšReque¡
 {

222 
Ët
 
mut
 
»q
 = 
AdmšReque¡
::
Ãw
();

223 
	g»q
.
£t_cmd_ty³
(
AdmšCmdTy³
::
ChªgeP“r
);

224 
	g»q
.
mut_chªge_³”
().
£t_chªge_ty³
(
chªge_ty³
);

225 
	g»q
.
mut_chªge_³”
().
£t_³”
(
³”
);

226 
	g»q


229 
pub
 
â
 
Ãw_Œªsãr_Ëad”_cmd
(
³”
: 
m‘­b
::
P“r
è-> 
AdmšReque¡
 {

230 
Ët
 
mut
 
cmd
 = 
AdmšReque¡
::
Ãw
();

231 
	gcmd
.
£t_cmd_ty³
(
AdmšCmdTy³
::
T¿nsãrL—d”
);

232 
	gcmd
.
mut_Œªsãr_Ëad”
().
£t_³”
(
³”
);

233 
	gcmd


236 
pub
 
â
 
Ãw_³”
(
¡Üe_id
: 
u64
, 
³”_id
: u64è-> 
m‘­b
::
P“r
 {

237 
Ët
 
mut
 
³”
 = 
m‘­b
::
P“r
::
Ãw
();

238 
	g³”
.
£t_¡Üe_id
(
¡Üe_id
);

239 
	g³”
.
£t_id
(
³”_id
);

240 
	g³”


244 
pub
 
â
 
Ãw_¡Üe
(
¡Üe_id
: 
u64
, 
addr
: 
SŒšg
è-> 
m‘­b
::
StÜe
 {

245 
Ët
 
mut
 
¡Üe
 = 
m‘­b
::
StÜe
::
Ãw
();

246 
	g¡Üe
.
£t_id
(
¡Üe_id
);

247 
	g¡Üe
.
£t_add»ss
(
addr
);

249 
	g¡Üe


252 
pub
 
â
 
	$¦“p_ms
(
ms
: 
u64
) {

253 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_mlis
(
ms
));

254 
	}
}

256 
pub
 
â
 
is_”rÜ_»¥Ú£
(
»¥
: &
RaáCmdRe¥Ú£
è-> 
boŞ
 {

257 
»¥
.
g‘_h—d”
().
has_”rÜ
()

260 
pub
 
â
 
Ãw_pd_chªge_³”
(

261 
chªge_ty³
: 
CÚfChªgeTy³
,

262 
³”
: 
m‘­b
::
P“r
,

263 è-> 
	gRegiÚH—¹b—tRe¥Ú£
 {

264 
Ët
 
mut
 
	gchªge_³”
 = 
ChªgeP“r
::
Ãw
();

265 
	gchªge_³”
.
£t_chªge_ty³
(
chªge_ty³
.
što
());

266 
	gchªge_³”
.
£t_³”
(
³”
);

268 
Ët
 
mut
 
	g»¥
 = 
RegiÚH—¹b—tRe¥Ú£
::
Ãw
();

269 
	g»¥
.
£t_chªge_³”
(
chªge_³”
);

270 
	g»¥


273 
pub
 
â
 
Ãw_pd_add_chªge_³”
(

274 
»giÚ
: &
m‘­b
::
RegiÚ
,

275 
³”
: 
m‘­b
::
P“r
,

276 è-> 
	gO±iÚ
<
	gRegiÚH—¹b—tRe¥Ú£
> {

277 
Ët
 
Some
(
p
èğ
fšd_³”
(
»giÚ
, 
³”
.
g‘_¡Üe_id
()) {

278 
	gas£¹_eq
!(
	gp
.
g‘_id
(), 
	g³”
.get_id());

279  
	gNÚe
;

282 
Some
(
Ãw_pd_chªge_³”
(
CÚfChªgeTy³
::
AddNode
, 
³”
))

285 
pub
 
â
 
Ãw_pd_»move_chªge_³”
(

286 
»giÚ
: &
m‘­b
::
RegiÚ
,

287 
³”
: 
m‘­b
::
P“r
,

288 è-> 
	gO±iÚ
<
	gRegiÚH—¹b—tRe¥Ú£
> {

289 
fšd_³”
(
»giÚ
, 
³”
.
g‘_¡Üe_id
()).
is_nÚe
() {

290  
	gNÚe
;

293 
Some
(
Ãw_pd_chªge_³”
(
CÚfChªgeTy³
::
RemoveNode
, 
³”
))

296 
pub
 
â
 
Ãw_pd_Œªsãr_Ëad”
(
³”
: 
m‘­b
::
P“r
è-> 
O±iÚ
<
RegiÚH—¹b—tRe¥Ú£
> {

297 
Ët
 
mut
 
Œªsãr_Ëad”
 = 
T¿nsãrL—d”
::
Ãw
();

298 
	gŒªsãr_Ëad”
.
£t_³”
(
³”
);

300 
Ët
 
mut
 
	g»¥
 = 
RegiÚH—¹b—tRe¥Ú£
::
Ãw
();

301 
	g»¥
.
£t_Œªsãr_Ëad”
(
Œªsãr_Ëad”
);

302 
Some
(
»¥
)

	@tests/raftstore_cases/mod.rs

15 
mod
 
	g‹¡_sšgË
;

16 
mod
 
	g‹¡_muÉi
;

17 
mod
 
	g‹¡_cÚf_chªge
;

18 
mod
 
	g‹¡_com·ù_log
;

19 
mod
 
	g‹¡_com·ù_lock_cf
;

20 
mod
 
	g‹¡_com·ù_aá”_d–‘e
;

21 
mod
 
	g‹¡_¥l™_»giÚ
;

22 
mod
 
	g‹¡_¡©us_commªd
;

23 
mod
 
	g‹¡_tomb¡Úe
;

24 
mod
 
	g‹¡_Œª¥Üt
;

25 
mod
 
	g‹¡_Œªsãr_Ëad”
;

26 
mod
 
	g‹¡_¡©s
;

27 
mod
 
	g‹¡_¢­
;

28 
mod
 
	g‹¡_»giÚ_h—¹b—t
;

29 
mod
 
	g‹¡_¡®e_³”
;

30 
mod
 
	g‹¡_Ëa£_»ad
;

31 
mod
 
	g‹¡_boÙ¡¿p
;

32 
mod
 
	g‹¡_£rviû
;

34 
u£
 
	g¿á¡Üe
::*;

	@tests/raftstore_cases/test_bootstrap.rs

14 
u£
 
	g¡d
::
sync
::{
mpsc
, 
	gArc
};

15 
u£
 
	g¡d
::
·th
::
P©h
;

16 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::{
boÙ¡¿p_¡Üe
, 
	gü—‹_ev’t_loİ
, 
	gkeys
, 
	gEngšes
, 
	gP“kabË
,

17 
	gSÇpMªag”
};

18 
u£
 
	gtikv
::
£rv”
::
Node
;

19 
u£
 
	gtikv
::
¡Üage
::{
ALL_CFS
, 
	gCF_RAFT
};

20 
u£
 
	gtikv
::
¿á¡Üe
::
cİroûssÜ
::
CİroûssÜHo¡
;

21 
u£
 
	gtikv
::
ut
::
rocksdb
;

22 
u£
 
	gtikv
::
ut
::
wÜk”
::
Futu»WÜk”
;

23 
u£
 
	g‹mpdœ
::
TempDœ
;

24 
u£
 
	gkv´Ùo
::
m‘­b
;

25 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RegiÚLoÿlS‹
;

27 
u£
 
	gsu³r
::
pd
::{
boÙ¡¿p_w™h_fœ¡_»giÚ
, 
	gTe¡PdCl›Á
};

28 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

29 
u£
 
	gsu³r
::
node
::{
Ãw_node_şu¡”
, 
	gChªÃlT¿n¥Üt
};

30 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::
SimuÏ‹T¿n¥Üt
;

31 
u£
 
	gsu³r
::
ut
::*;

33 
â
 
	g‹¡_boÙ¡¿p_idempÙ’t
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

35 
şu¡”
.
add_fœ¡_»giÚ
().
unw¿p
();

39 
	gşu¡”
.
¡¬t
();

40 
	gşu¡”
.
check_»giÚs_numb”
(1);

41 
	gşu¡”
.
shutdown
();

42 
¦“p_ms
(500);

43 
	gşu¡”
.
¡¬t
();

44 
	gşu¡”
.
check_»giÚs_numb”
(1);

47 #[
‹¡
]

48 
â
 
	$‹¡_node_boÙ¡¿p_w™h_´•¬ed_d©a
() {

50 
Ët
 
pd_ş›Á
 = 
Arc
::
	`Ãw
(
Te¡PdCl›Á
::new(0));

51 
Ët
 
cfg
 = 
	`Ãw_tikv_cÚfig
(0);

53 
Ët
 
mut
 
ev’t_loİ
 = 
	`ü—‹_ev’t_loİ
(&
cfg
.
¿á_¡Üe
).
	`unw¿p
();

54 
Ët
 
simuÏ‹_Œªs
 = 
SimuÏ‹T¿n¥Üt
::
	`Ãw
(
ChªÃlT¿n¥Üt
::new());

55 
Ët
 
tmp_·th
 = 
TempDœ
::
	`Ãw
("‹¡_şu¡”").
	`unw¿p
();

56 
Ët
 
’gše
 = 
Arc
::
	`Ãw
(

57 
rocksdb
::
	`Ãw_’gše
(
tmp_·th
.
	`·th
().
	`to_¡r
().
	`unw¿p
(), 
ALL_CFS
).unwrap(),

59 
Ët
 
tmp_·th_¿á
 = 
tmp_·th
.
	`·th
().
	`još
(
P©h
::
	`Ãw
("raft"));

60 
Ët
 
¿á_’gše
 = 
Arc
::
	`Ãw
(

61 
rocksdb
::
	`Ãw_’gše
(
tmp_·th_¿á
.
	`to_¡r
().
	`unw¿p
(), &[]).unwrap(),

63 
Ët
 
’gšes
 = 
Engšes
::
	`Ãw
(
’gše
.
	`şÚe
(), 
¿á_’gše
.clone());

64 
Ët
 
tmp_mgr
 = 
TempDœ
::
	`Ãw
("‹¡_şu¡”").
	`unw¿p
();

66 
Ët
 
mut
 
node
 = 
Node
::
	`Ãw
(

67 &
mut
 
ev’t_loİ
,

68 &
cfg
.
£rv”
,

69 &
cfg
.
¿á_¡Üe
,

70 
pd_ş›Á
.
	`şÚe
(),

72 
Ët
 
¢­_mgr
 = 
SÇpMªag”
::
	`Ãw
(

73 
tmp_mgr
.
	`·th
().
	`to_¡r
().
	`unw¿p
(),

74 
	`Some
(
node
.
	`g‘_£ndch
()),

75 
NÚe
,

77 
	`Ët
 (
_
, 
¢­shÙ_¡©us_»ûiv”
èğ
mpsc
::
	`chªÃl
();

78 
Ët
 
pd_wÜk”
 = 
Futu»WÜk”
::
	`Ãw
("test-pd-worker");

82 
	`boÙ¡¿p_w™h_fœ¡_»giÚ
(
pd_ş›Á
.
	`şÚe
()).
	`unw¿p
();

86 
	`boÙ¡¿p_¡Üe
(&
’gšes
, 0, 1).
	`unw¿p
();

87 
Ët
 
»giÚ
 = 
node
.
	`´•¬e_boÙ¡¿p_şu¡”
(&
’gšes
, 1).
	`unw¿p
();

88 
as£¹
!(

89 
’gše


90 .
g‘_msg
::<
m‘­b
::
RegiÚ
>(&
keys
::
	`´•¬e_boÙ¡¿p_key
())

91 .
	`unw¿p
()

92 .
	`is_some
()

94 
Ët
 
»giÚ_¡©e_key
 = 
keys
::
	`»giÚ_¡©e_key
(
»giÚ
.
	`g‘_id
());

95 
as£¹
!(

96 
’gše


97 .
g‘_msg_cf
::<
RegiÚLoÿlS‹
>(
CF_RAFT
, &
»giÚ_¡©e_key
)

98 .
	`unw¿p
()

99 .
	`is_some
()

103 
Ët
 
cİroûssÜ_ho¡
 = 
CİroûssÜHo¡
::
	`Ãw
(
cfg
.
cİroûssÜ
, 
node
.
	`g‘_£ndch
());

106 
node
.
	`¡¬t
(

107 
ev’t_loİ
,

108 
’gšes
,

109 
simuÏ‹_Œªs
,

110 
¢­_mgr
,

111 
¢­shÙ_¡©us_»ûiv”
,

112 
pd_wÜk”
,

113 
cİroûssÜ_ho¡
,

114 ).
	`unw¿p
();

115 
as£¹
!(

116 
’gše


117 .
	`şÚe
()

118 .
g‘_msg
::<
m‘­b
::
RegiÚ
>(&
keys
::
	`´•¬e_boÙ¡¿p_key
())

119 .
	`unw¿p
()

120 .
	`is_nÚe
()

122 
as£¹
!(

123 
’gše


124 .
g‘_msg_cf
::<
RegiÚLoÿlS‹
>(
CF_RAFT
, &
»giÚ_¡©e_key
)

125 .
	`unw¿p
()

126 .
	`is_nÚe
()

128 
as£¹_eq
!(
pd_ş›Á
.
	`g‘_»giÚs_numb”
(è
as
 
u32
, 1);

129 
node
.
	`¡İ
().
	`unw¿p
();

130 
	}
}

132 #[
‹¡
]

133 
â
 
	$‹¡_node_boÙ¡¿p_idempÙ’t
() {

134 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

135 
	`‹¡_boÙ¡¿p_idempÙ’t
(&
mut
 
şu¡”
);

136 
	}
}

	@tests/raftstore_cases/test_compact_after_delete.rs

15 
u£
 
	gtikv
::
¡Üage
::{
CF_DEFAULT
, 
	gCF_WRITE
};

16 
u£
 
	gtikv
::
ut
::
rocksdb
::
g‘_cf_hªdË
;

17 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

18 
u£
 
	grocksdb
::
Rªge
;

20 
u£
 
	gsu³r
::
ut
::*;

21 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

22 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

24 
â
 
	g‹¡_com·ù_aá”_d–‘e
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

25 
şu¡”
.
cfg
.
¿á_¡Üe
.
»giÚ_com·ù_check_š‹rv®
 = 
R—dabËDu¿tiÚ
::
£cs
(500);

26 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g»giÚ_com·ù_d–‘e_keys_couÁ
 = 5;

27 
	gşu¡”
.
run
();

29 
i
 
	gš
 1..9 {

30 
Ët
 (
k
, 
v
èğ(
fÜm©
!("k{}", 
	gi
), 
	gfÜm©
!("value{}", i));

31 
	gşu¡”
.
mu¡_put_cf
(
CF_DEFAULT
, 
k
.
as_by‹s
(), 
v
.as_bytes());

32 
	gşu¡”
.
mu¡_put_cf
(
CF_WRITE
, 
k
.
as_by‹s
(), 
v
.as_bytes());

33 
	gşu¡”
.
mu¡_d–‘e_cf
(
CF_DEFAULT
, 
k
.
as_by‹s
());

34 
	gşu¡”
.
mu¡_d–‘e_cf
(
CF_WRITE
, 
k
.
as_by‹s
());

38 
¦“p_ms
(1000);

40 
’gšes
 
š
 
	gşu¡”
.
	g’gšes
.
v®ues
() {

41 
Ët
 
	g­´oxim©e_size
 = 
’gšes


42 .
kv_’gše


43 .
g‘_­´oxim©e_sizes
(&[
Rªge
::
Ãw
(
b
"", b"k9")])[0];

44 
	gas£¹_eq
!(
	g­´oxim©e_size
, 0);

46 
Ët
 
	gcf_hªdË
 = 
g‘_cf_hªdË
(&
’gšes
.
kv_’gše
, 
CF_WRITE
).
unw¿p
();

47 
Ët
 
	g­´oxim©e_size
 = 
’gšes


48 .
kv_’gše


49 .
g‘_­´oxim©e_sizes_cf
(
cf_hªdË
, &[
Rªge
::
Ãw
(
b
"", b"k9")])[0];

50 
	gas£¹_eq
!(
	g­´oxim©e_size
, 0);

54 #[
‹¡
]

55 
â
 
	$‹¡_node_com·ù_aá”_d–‘e
() {

56 
Ët
 
couÁ
 = 1;

57 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

58 
	`‹¡_com·ù_aá”_d–‘e
(&
mut
 
şu¡”
);

59 
	}
}

	@tests/raftstore_cases/test_compact_lock_cf.rs

15 
u£
 
	gtikv
::
¡Üage
::
CF_LOCK
;

16 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

17 
u£
 
	grocksdb
::
DBSti¡icsTick”Ty³
;

19 
u£
 
	gsu³r
::
ut
::*;

20 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

21 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

23 
â
 
	gæush
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

24 
’gšes
 
š
 
şu¡”
.’gšes.
v®ues
() {

25 
Ët
 
lock_hªdË
 = 
’gšes
.
kv_’gše
.
cf_hªdË
(
CF_LOCK
).
unw¿p
();

26 
	g’gšes
.
	gkv_’gše
.
æush_cf
(
lock_hªdË
, 
Œue
).
unw¿p
();

30 
â
 
	gæush_th’_check
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>, 
	gš‹rv®
: 
u64
, 
	gwr™‹n
: 
boŞ
) {

31 
æush
(
şu¡”
);

33 
¦“p_ms
(
š‹rv®
 * 2);

34 
’gšes
 
š
 
	gşu¡”
.
	g’gšes
.
v®ues
() {

35 
Ët
 
	gcom·ù_wr™e_by‹s
 = 
’gšes


36 .
kv_’gše


37 .
g‘_¡©i¡ics_tick”_couÁ
(
DBSti¡icsTick”Ty³
::
Com·ùWr™eBy‹s
);

38 
	gwr™‹n
 {

39 
	gas£¹
!(
	gcom·ù_wr™e_by‹s
 > 0);

41 
	gas£¹_eq
!(
	gcom·ù_wr™e_by‹s
, 0);

46 
â
 
	g‹¡_com·ù_lock_cf
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

47 
Ët
 
š‹rv®
 = 500;

49 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	glock_cf_com·ù_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(
š‹rv®
);

51 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	glock_cf_com·ù_by‹s_th»shŞd
 = 
R—dabËSize
(100);

52 
	gşu¡”
.
run
();

55 
i
 
	gš
 0..5 {

56 
Ët
 (
k
, 
v
èğ(
fÜm©
!("k{}", 
	gi
), 
	gfÜm©
!("value{}", i));

57 
	gşu¡”
.
mu¡_put_cf
(
CF_LOCK
, 
k
.
as_by‹s
(), 
v
.as_bytes());

60 
æush
(
şu¡”
);

64 
i
 
	gš
 5..10 {

65 
Ët
 (
k
, 
v
èğ(
fÜm©
!("k{}", 
	gi
), 
	gfÜm©
!("value{}", i));

66 
	gşu¡”
.
mu¡_put_cf
(
CF_LOCK
, 
k
.
as_by‹s
(), 
v
.as_bytes());

69 
æush_th’_check
(
şu¡”
, 
š‹rv®
, 
çl£
);

72 
i
 
	gš
 10..15 {

73 
Ët
 (
k
, 
v
èğ(
fÜm©
!("k{}", 
	gi
), 
	gfÜm©
!("value{}", i));

74 
	gşu¡”
.
mu¡_put_cf
(
CF_LOCK
, 
k
.
as_by‹s
(), 
v
.as_bytes());

76 
æush_th’_check
(
şu¡”
, 
š‹rv®
, 
Œue
);

79 #[
‹¡
]

80 
â
 
	$‹¡_£rv”_com·ù_lock_cf
() {

81 
Ët
 
couÁ
 = 1;

82 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

83 
	`‹¡_com·ù_lock_cf
(&
mut
 
şu¡”
);

84 
	}
}

	@tests/raftstore_cases/test_compact_log.rs

14 
u£
 
	g¡d
::
cŞËùiÚs
::
HashM­
;

16 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::*;

17 
u£
 
	gtikv
::
¡Üage
::
CF_RAFT
;

18 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

19 
u£
 
	grocksdb
::
DB
;

20 
u£
 
	g´Ùobuf
;

21 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
RaáAµlyS‹
, 
	gRaáTrunÿ‹dS‹
};

23 
u£
 
	gsu³r
::
ut
::*;

24 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

25 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

27 
â
 
	gg‘_msg_cf_Ü_deçuÉ
<
	gM
>(
	g’gše
: &
DB
, 
	gcf
: &
¡r
, 
	gkey
: &[
u8
]è-> 
M


28 
wh”e


29 
M
: 
´Ùobuf
::
Mes§ge
 +…rÙobuf::
Mes§geStic
,

31 
	g’gše
.
g‘_msg_cf
(
cf
, 
key
).
unw¿p
().
unw¿p_Ü_deçuÉ
()

34 
â
 
	g‹¡_com·ù_log
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

35 
şu¡”
.
run
();

37 
Ët
 
mut
 
	gbefÜe_¡©es
 = 
HashM­
::
Ãw
();

39 &
	gid
, 
	g’gšes
è
	gš
 &
	gşu¡”
.engines {

40 
Ët
 
mut
 
	g¡©e
: 
RaáAµlyS‹
 =

41 
g‘_msg_cf_Ü_deçuÉ
(&
’gšes
.
kv_’gše
, 
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(1));

42 
	gbefÜe_¡©es
.
š£¹
(
id
, 
¡©e
.
ke_Œunÿ‹d_¡©e
());

45 
i
 
	gš
 1..1000 {

46 
Ët
 (
k
, 
v
èğ(
fÜm©
!("key{}", 
	gi
), 
	gfÜm©
!("value{}", i));

47 
Ët
 
	gkey
 = 
k
.
as_by‹s
();

48 
Ët
 
	gv®ue
 = 
v
.
as_by‹s
();

49 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

51 
	gi
 > 100 && 
check_com·ùed
(&
şu¡”
.
’gšes
, &
befÜe_¡©es
, 1) {

56 
	g·nic
!("after inserting 1000ƒntries, compaction is still‚ot finished.");

59 
â
 
check_com·ùed
(

60 
®l_’gšes
: &
HashM­
<
u64
, 
Engšes
>,

61 
befÜe_¡©es
: &
HashM­
<
u64
, 
RaáTrunÿ‹dS‹
>,

62 
com·ù_couÁ
: 
u64
,

63 è-> 
	gboŞ
 {

65 
Ët
 
mut
 
	gcom·ùed_idx
 = 
HashM­
::
Ãw
();

67 &
	gid
, 
	g’gšes
è
š
 
	g®l_’gšes
 {

68 
Ët
 
mut
 
	g¡©e
: 
RaáAµlyS‹
 =

69 
g‘_msg_cf_Ü_deçuÉ
(&
’gšes
.
kv_’gše
, 
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(1));

70 
Ët
 
	gaá”_¡©e
 = 
¡©e
.
ke_Œunÿ‹d_¡©e
();

72 
Ët
 
	gbefÜe_¡©e
 = &
befÜe_¡©es
[&
id
];

73 
Ët
 
	gidx
 = 
aá”_¡©e
.
g‘_šdex
();

74 
Ët
 
	g‹rm
 = 
aá”_¡©e
.
g‘_‹rm
();

75 
	gidx
 =ğ
befÜe_¡©e
.
g‘_šdex
(è|| 
‹rm
 =ğbefÜe_¡©e.
g‘_‹rm
() {

76  
çl£
;

78 
	gidx
 - 
	gbefÜe_¡©e
.
g‘_šdex
(è< 
	gcom·ù_couÁ
 {

79  
	gçl£
;

81 
	gas£¹
!(
	g‹rm
 > 
	gbefÜe_¡©e
.
g‘_‹rm
());

82 
	gcom·ùed_idx
.
š£¹
(
id
, 
idx
);

86 
¦“p_ms
(100);

88 
	gid
, 
	g’gšes
è
š
 
	g®l_’gšes
 {

89 
i
 
	gš
 0..c
	gom·ùed_idx
[
id
] {

90 
Ët
 
	gkey
 = 
keys
::
¿á_log_key
(1, 
i
);

91 
	g’gšes
.
	g¿á_’gše
.
g‘
(&
key
).
unw¿p
().
is_nÚe
() {

94 
	gas£¹
!(
	g’gšes
.
	g¿á_’gše
.
g‘
(&
key
).
unw¿p
().
is_nÚe
());

97 
	gŒue


100 
â
 
	g‹¡_com·ù_couÁ_lim™
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

101 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_couÁ_lim™
 = 100;

102 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_th»shŞd
 = 500;

103 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_size_lim™
 = 
R—dabËSize
::
mb
(20);

104 
	gşu¡”
.
run
();

106 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

108 
Ët
 
mut
 
	gbefÜe_¡©es
 = 
HashM­
::
Ãw
();

110 &
	gid
, 
	g’gšes
è
	gš
 &
	gşu¡”
.engines {

111 
mu¡_g‘_equ®
(&
’gšes
.
kv_’gše
, 
b
"k1", b"v1");

112 
Ët
 
mut
 
	g¡©e
: 
RaáAµlyS‹
 =

113 
g‘_msg_cf_Ü_deçuÉ
(&
’gšes
.
kv_’gše
, 
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(1));

114 
Ët
 
	g¡©e
 = 
¡©e
.
ke_Œunÿ‹d_¡©e
();

116 
	gas£¹_eq
!(
	gRAFT_INIT_LOG_INDEX
, 
	g¡©e
.
g‘_šdex
());

117 
	gas£¹_eq
!(
	gRAFT_INIT_LOG_TERM
, 
	g¡©e
.
g‘_‹rm
());

118 
	gbefÜe_¡©es
.
š£¹
(
id
, 
¡©e
);

121 
i
 
	gš
 1..60 {

122 
Ët
 
	gk
 = 
i
.
to_¡ršg
().
što_by‹s
();

123 
Ët
 
	gv
 = 
k
.
şÚe
();

124 
	gşu¡”
.
mu¡_put
(&
k
, &
v
);

128 
¦“p_ms
(500);

131 &
	gid
, 
	g’gšes
è
	gš
 &
	gşu¡”
.engines {

132 
Ët
 
mut
 
	g¡©e
: 
RaáAµlyS‹
 =

133 
g‘_msg_cf_Ü_deçuÉ
(&
’gšes
.
kv_’gše
, 
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(1));

134 
Ët
 
	gaá”_¡©e
 = 
¡©e
.
ke_Œunÿ‹d_¡©e
();

136 
Ët
 
	gbefÜe_¡©e
 = &
befÜe_¡©es
[&
id
];

137 
Ët
 
	gidx
 = 
aá”_¡©e
.
g‘_šdex
();

138 
	gas£¹_eq
!(
	gidx
, 
	gbefÜe_¡©e
.
g‘_šdex
());

141 
i
 
	gš
 60..200 {

142 
Ët
 
	gk
 = 
i
.
to_¡ršg
().
što_by‹s
();

143 
Ët
 
	gv
 = 
k
.
şÚe
();

144 
	gşu¡”
.
mu¡_put
(&
k
, &
v
);

145 
Ët
 
	gv2
 = 
şu¡”
.
g‘
(&
k
);

146 
	gas£¹_eq
!(
	gv2
, 
Some
(
v
));

148 
	gi
 > 100 && 
check_com·ùed
(&
şu¡”
.
’gšes
, &
befÜe_¡©es
, 1) {

152 
	g·nic
!("cluster is‚ot compacted‡fter inserting 200ƒntries.");

155 
â
 
	g‹¡_com·ù_mªy_times
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

156 
Ët
 
gc_lim™
: 
u64
 = 100;

157 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_couÁ_lim™
 = 
gc_lim™
;

158 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_th»shŞd
 = 500;

159 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(100);

160 
	gşu¡”
.
run
();

162 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

164 
Ët
 
mut
 
	gbefÜe_¡©es
 = 
HashM­
::
Ãw
();

166 &
	gid
, 
	g’gšes
è
	gš
 &
	gşu¡”
.engines {

167 
mu¡_g‘_equ®
(&
’gšes
.
kv_’gše
, 
b
"k1", b"v1");

168 
Ët
 
mut
 
	g¡©e
: 
RaáAµlyS‹
 =

169 
g‘_msg_cf_Ü_deçuÉ
(&
’gšes
.
kv_’gše
, 
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(1));

170 
Ët
 
	g¡©e
 = 
¡©e
.
ke_Œunÿ‹d_¡©e
();

172 
	gas£¹_eq
!(
	gRAFT_INIT_LOG_INDEX
, 
	g¡©e
.
g‘_šdex
());

173 
	gas£¹_eq
!(
	gRAFT_INIT_LOG_TERM
, 
	g¡©e
.
g‘_‹rm
());

174 
	gbefÜe_¡©es
.
š£¹
(
id
, 
¡©e
);

177 
i
 
	gš
 1..500 {

178 
Ët
 
	gk
 = 
i
.
to_¡ršg
().
što_by‹s
();

179 
Ët
 
	gv
 = 
k
.
şÚe
();

180 
	gşu¡”
.
mu¡_put
(&
k
, &
v
);

181 
Ët
 
	gv2
 = 
şu¡”
.
g‘
(&
k
);

182 
	gas£¹_eq
!(
	gv2
, 
Some
(
v
));

184 
	gi
 >ğ200 && 
check_com·ùed
(&
şu¡”
.
’gšes
, &
befÜe_¡©es
, 
gc_lim™
 * 2) {

189 
	g·nic
!("compact isƒxpectedo beƒxecuted multipleimes");

192 #[
‹¡
]

193 
â
 
	$‹¡_node_com·ù_log
() {

194 
Ët
 
couÁ
 = 5;

195 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

196 
	`‹¡_com·ù_log
(&
mut
 
şu¡”
);

197 
	}
}

199 #[
‹¡
]

200 
â
 
	$‹¡_node_com·ù_couÁ_lim™
() {

201 
Ët
 
couÁ
 = 5;

202 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

203 
	`‹¡_com·ù_couÁ_lim™
(&
mut
 
şu¡”
);

204 
	}
}

206 #[
‹¡
]

207 
â
 
	$‹¡_node_com·ù_mªy_times
() {

208 
Ët
 
couÁ
 = 5;

209 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

210 
	`‹¡_com·ù_mªy_times
(&
mut
 
şu¡”
);

211 
	}
}

213 
â
 
	g‹¡_com·ù_size_lim™
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

214 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_couÁ_lim™
 = 100000;

215 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_size_lim™
 = 
R—dabËSize
::
mb
(2);

216 
	gşu¡”
.
run
();

217 
	gşu¡”
.
¡İ_node
(1);

219 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

221 
Ët
 
mut
 
	gbefÜe_¡©es
 = 
HashM­
::
Ãw
();

223 &
	gid
, 
	g’gšes
è
	gš
 &
	gşu¡”
.engines {

224 
	gid
 == 1 {

227 
mu¡_g‘_equ®
(&
’gšes
.
kv_’gše
, 
b
"k1", b"v1");

228 
Ët
 
mut
 
	g¡©e
: 
RaáAµlyS‹
 =

229 
g‘_msg_cf_Ü_deçuÉ
(&
’gšes
.
kv_’gše
, 
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(1));

230 
Ët
 
	g¡©e
 = 
¡©e
.
ke_Œunÿ‹d_¡©e
();

232 
	gas£¹_eq
!(
	gRAFT_INIT_LOG_INDEX
, 
	g¡©e
.
g‘_šdex
());

233 
	gas£¹_eq
!(
	gRAFT_INIT_LOG_TERM
, 
	g¡©e
.
g‘_‹rm
());

234 
	gbefÜe_¡©es
.
š£¹
(
id
, 
¡©e
);

237 
i
 
	gš
 1..600 {

238 
Ët
 
	gk
 = 
i
.
to_¡ršg
().
što_by‹s
();

239 
Ët
 
	gv
 = 
k
.
şÚe
();

240 
	gşu¡”
.
mu¡_put
(&
k
, &
v
);

241 
Ët
 
	gv2
 = 
şu¡”
.
g‘
(&
k
);

242 
	gas£¹_eq
!(
	gv2
, 
Some
(
v
));

246 
¦“p_ms
(500);

249 &
	gid
, 
	g’gšes
è
	gš
 &
	gşu¡”
.engines {

250 
	gid
 == 1 {

253 
Ët
 
mut
 
	g¡©e
: 
RaáAµlyS‹
 =

254 
g‘_msg_cf_Ü_deçuÉ
(&
’gšes
.
kv_’gše
, 
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(1));

255 
Ët
 
	gaá”_¡©e
 = 
¡©e
.
ke_Œunÿ‹d_¡©e
();

257 
Ët
 
	gbefÜe_¡©e
 = &
befÜe_¡©es
[&
id
];

258 
Ët
 
	gidx
 = 
aá”_¡©e
.
g‘_šdex
();

259 
	gas£¹_eq
!(
	gidx
, 
	gbefÜe_¡©e
.
g‘_šdex
());

263 
_
 
	gš
 600..1200 {

264 
Ët
 
	gk
 = 
vec
![0; 1024 * 5];

265 
Ët
 
	gv
 = 
k
.
şÚe
();

266 
	gşu¡”
.
mu¡_put
(&
k
, &
v
);

267 
Ët
 
	gv2
 = 
şu¡”
.
g‘
(&
k
);

268 
	gas£¹_eq
!(
	gv2
, 
Some
(
v
));

271 
¦“p_ms
(500);

275 &
	gid
, 
	g’gšes
è
	gš
 &
	gşu¡”
.engines {

276 
	gid
 == 1 {

279 
Ët
 
mut
 
	g¡©e
: 
RaáAµlyS‹
 =

280 
g‘_msg_cf_Ü_deçuÉ
(&
’gšes
.
kv_’gše
, 
CF_RAFT
, &
keys
::
­¶y_¡©e_key
(1));

281 
Ët
 
	gaá”_¡©e
 = 
¡©e
.
ke_Œunÿ‹d_¡©e
();

283 
Ët
 
	gbefÜe_¡©e
 = &
befÜe_¡©es
[&
id
];

284 
Ët
 
	gidx
 = 
aá”_¡©e
.
g‘_šdex
();

285 
	gas£¹
!(
	gidx
 > 
	gbefÜe_¡©e
.
g‘_šdex
());

287 
i
 
	gš
 0..
	gidx
 {

288 
Ët
 
	gkey
 = 
keys
::
¿á_log_key
(1, 
i
);

289 
	gas£¹
!(
	g’gšes
.
	g¿á_’gše
.
g‘
(&
key
).
unw¿p
().
is_nÚe
());

294 #[
‹¡
]

295 
â
 
	$‹¡_node_com·ù_size_lim™
() {

296 
Ët
 
couÁ
 = 5;

297 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

298 
	`‹¡_com·ù_size_lim™
(&
mut
 
şu¡”
);

299 
	}
}

	@tests/raftstore_cases/test_conf_change.rs

14 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

15 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	g¡d
::
th»ad
;

18 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::*;

19 
u£
 
	gtikv
::
¡Üage
::
CF_RAFT
;

20 
u£
 
	gkv´Ùo
::
”aápb
::
CÚfChªgeTy³
;

21 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::
RaáRe¥Ú£H—d”
;

22 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::*;

23 
u£
 
	gkv´Ùo
::
m‘­b
;

24 
u£
 
	gtikv
::
pd
::
PdCl›Á
;

26 
u£
 
	gfutu»s
::
Futu»
;

28 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

29 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

30 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

31 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

32 
u£
 
	gsu³r
::
ut
::*;

33 
u£
 
	gsu³r
::
pd
::
Te¡PdCl›Á
;

35 
â
 
	g‹¡_sim¶e_cÚf_chªge
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

36 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

38 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

40 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

43 
Ët
 (
key
, 
v®ue
èğ(
b
"k1", 
	gb
"v1");

45 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

46 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

48 
Ët
 
	g’gše_2
 = 
şu¡”
.
g‘_’gše
(2);

49 
mu¡_g‘_nÚe
(&
’gše_2
, 
b
"k1");

51 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

53 
Ët
 (
key
, 
v®ue
èğ(
b
"k2", 
	gb
"v2");

54 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

55 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

58 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k1", b"v1");

59 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k2", b"v2");

61 
Ët
 
	g•och
 = 
şu¡”
.
pd_ş›Á
.
g‘_»giÚ_•och
(
r1
);

64 
	gas£¹
!(
	g•och
.
g‘_cÚf_v”
() > 1);

67 
Ët
 
	g’gše_5
 = 
şu¡”
.
g‘_’gše
(5);

68 
mu¡_g‘_nÚe
(&
’gše_5
, 
b
"k1");

71 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

73 
	gpd_ş›Á
.
mu¡_»move_³”
(
r1
, 
Ãw_³”
(2, 2));

75 
Ët
 (
key
, 
v®ue
èğ(
b
"k3", 
	gb
"v3");

76 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

77 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

79 
Ët
 
	g’gše_3
 = 
şu¡”
.
g‘_’gše
(3);

80 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k1", b"v1");

81 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k2", b"v2");

82 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k3", b"v3");

85 
mu¡_g‘_nÚe
(&
’gše_2
, 
b
"k1");

86 
mu¡_g‘_nÚe
(&
’gše_2
, 
b
"k2");

89 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k3", b"v3");

92 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

95 
Ët
 (
key
, 
v®ue
èğ(
b
"k2", 
	gb
"v2");

96 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

97 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

99 
Ët
 
	g’gše_2
 = 
şu¡”
.
g‘_’gše
(2);

101 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k1", b"v1");

102 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k2", b"v2");

103 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k3", b"v3");

106 
	gşu¡”
.
mu¡_put
(
b
"k4", b"v4");

107 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
b
"k4"), 
Some
(b"v4".
to_vec
()));

108 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k4", b"v4");

110 
Ët
 
	gcÚf_chªge
 = 
Ãw_chªge_³”_»que¡
(
CÚfChªgeTy³
::
AddNode
, 
Ãw_³”
(2, 2));

111 
Ët
 
	g•och
 = 
şu¡”
.
pd_ş›Á
.
g‘_»giÚ_•och
(
r1
);

112 
Ët
 
	gadmš_»q
 = 
Ãw_admš_»que¡
(
r1
, &
•och
, 
cÚf_chªge
);

113 
Ët
 
	g»¥
 = 
şu¡”


114 .
ÿÎ_commªd_Ú_Ëad”
(
admš_»q
, 
Du¿tiÚ
::
äom_£cs
(3))

115 .
unw¿p
();

116 
Ët
 
	gexec_»s
 = 
»¥
.
g‘_h—d”
()

117 .
g‘_”rÜ
()

118 .
g‘_mes§ge
()

119 .
cÚšs
("duplicated");

120 
	gas£¹
!(

121 
	gexec_»s
,

123 
	g»¥


127 
	gpd_ş›Á
.
mu¡_»move_³”
(
r1
, 
Ãw_³”
(2, 2));

130 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 4));

133 
	gpd_ş›Á
.
mu¡_»move_³”
(
r1
, 
Ãw_³”
(3, 3));

135 
Ët
 (
key
, 
v®ue
èğ(
b
"k4", 
	gb
"v4");

136 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

137 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

139 
Ët
 
	g’gše_2
 = 
şu¡”
.
g‘_’gše
(2);

141 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k1", b"v1");

142 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k4", b"v4");

145 
mu¡_g‘_nÚe
(&
’gše_3
, 
b
"k1");

146 
mu¡_g‘_nÚe
(&
’gše_3
, 
b
"k4");

151 
â
 
Ãw_cÚf_chªge_³”
(
¡Üe
: &
m‘­b
::
StÜe
, 
pd_ş›Á
: &
Arc
<
Te¡PdCl›Á
>è-> m‘­b::
P“r
 {

152 
Ët
 
³”_id
 = 
pd_ş›Á
.
®loc_id
().
unw¿p
();

153 
Ãw_³”
(
¡Üe
.
g‘_id
(), 
³”_id
)

156 
â
 
	g‹¡_pd_cÚf_chªge
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

157 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

159 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

161 
	gşu¡”
.
¡¬t
();

163 
Ët
 
	g»giÚ
 = &
pd_ş›Á
.
g‘_»giÚ
(
b
"").
unw¿p
();

164 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

166 
Ët
 
mut
 
	g¡Ües
 = 
pd_ş›Á
.
g‘_¡Ües
().
unw¿p
();

169 
	gas£¹_eq
!(
	g»giÚ
.
g‘_³”s
().
Ën
(), 1);

171 
Ët
 
	g³”
 = &
»giÚ
.
g‘_³”s
()[0];

173 
Ët
 
	gi
 = 
¡Ües


174 .
™”
()

175 .
pos™iÚ
(|
¡Üe
| stÜe.
g‘_id
(è=ğ
³”
.
g‘_¡Üe_id
())

176 .
unw¿p
();

177 
	g¡Ües
.
sw­
(0, 
i
);

181 
Ët
 (
key
, 
v®ue
èğ(
b
"k1", 
	gb
"v1");

182 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

183 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

185 
Ët
 
	g³”2
 = 
Ãw_cÚf_chªge_³”
(&
¡Ües
[1], &
pd_ş›Á
);

186 
Ët
 
	g’gše_2
 = 
şu¡”
.
g‘_’gše
(
³”2
.
g‘_¡Üe_id
());

187 
	gas£¹
!(

188 
	g’gše_2


189 .
g‘_v®ue
(&
keys
::
d©a_key
(
b
"k1"))

190 .
unw¿p
()

191 .
is_nÚe
()

194 
	gpd_ş›Á
.
mu¡_add_³”
(
»giÚ_id
, 
³”2
.
şÚe
());

196 
Ët
 (
key
, 
v®ue
èğ(
b
"k2", 
	gb
"v2");

197 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

198 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

201 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k1", b"v1");

202 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k2", b"v2");

205 
Ët
 
	g³”3
 = 
Ãw_cÚf_chªge_³”
(&
¡Ües
[2], &
pd_ş›Á
);

206 
	gpd_ş›Á
.
mu¡_add_³”
(
»giÚ_id
, 
³”3
.
şÚe
());

209 
	gpd_ş›Á
.
mu¡_»move_³”
(
»giÚ_id
, 
³”2
.
şÚe
());

211 
Ët
 (
key
, 
v®ue
èğ(
b
"k3", 
	gb
"v3");

212 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

213 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

215 
Ët
 
	g’gše_3
 = 
şu¡”
.
g‘_’gše
(
³”3
.
g‘_¡Üe_id
());

216 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k1", b"v1");

217 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k2", b"v2");

218 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k3", b"v3");

221 
mu¡_g‘_nÚe
(&
’gše_2
, 
b
"k1");

222 
mu¡_g‘_nÚe
(&
’gše_2
, 
b
"k2");

224 
Ët
 
	g³”4
 = 
Ãw_cÚf_chªge_³”
(&
¡Ües
[1], &
pd_ş›Á
);

225 
	gpd_ş›Á
.
mu¡_add_³”
(
»giÚ_id
, 
³”4
.
şÚe
());

227 
	gpd_ş›Á
.
mu¡_»move_³”
(
»giÚ_id
, 
³”3
.
şÚe
());

229 
Ët
 (
key
, 
v®ue
èğ(
b
"k4", 
	gb
"v4");

230 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

231 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

233 
Ët
 
	g’gše_2
 = 
şu¡”
.
g‘_’gše
(
³”4
.
g‘_¡Üe_id
());

235 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k1", b"v1");

236 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k4", b"v4");

239 
mu¡_g‘_nÚe
(&
’gše_3
, 
b
"k1");

240 
mu¡_g‘_nÚe
(&
’gše_3
, 
b
"k4");

246 #[
‹¡
]

247 
â
 
	$‹¡_node_sim¶e_cÚf_chªge
() {

248 
Ët
 
couÁ
 = 5;

249 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

250 
	`‹¡_sim¶e_cÚf_chªge
(&
mut
 
şu¡”
);

251 
	}
}

253 #[
‹¡
]

254 
â
 
	$‹¡_£rv”_sim¶e_cÚf_chªge
() {

255 
Ët
 
couÁ
 = 5;

256 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

257 
	`‹¡_sim¶e_cÚf_chªge
(&
mut
 
şu¡”
);

258 
	}
}

260 #[
‹¡
]

261 
â
 
	$‹¡_node_pd_cÚf_chªge
() {

262 
Ët
 
couÁ
 = 5;

263 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

264 
	`‹¡_pd_cÚf_chªge
(&
mut
 
şu¡”
);

265 
	}
}

267 #[
‹¡
]

268 
â
 
	$‹¡_£rv”_pd_cÚf_chªge
() {

269 
Ët
 
couÁ
 = 5;

270 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

271 
	`‹¡_pd_cÚf_chªge
(&
mut
 
şu¡”
);

272 
	}
}

274 
â
 
wa™_tl_»ach_couÁ
(
pd_ş›Á
: 
Arc
<
Te¡PdCl›Á
>, 
»giÚ_id
: 
u64
, 
c
: 
usize
) {

275 
Ët
 
mut
 
»¶iÿ_couÁ
 = 0;

276 
_
 
	gš
 0..1000 {

277 
Ët
 
	g»giÚ
 = 
m©ch
 
pd_ş›Á
.
g‘_»giÚ_by_id
(
»giÚ_id
).
wa™
().
unw¿p
() {

278 
Some
(
r
) =>„,

279 
	gNÚe
 => ,

281 
	g»¶iÿ_couÁ
 = 
»giÚ
.
g‘_³”s
().
Ën
();

282 
	g»¶iÿ_couÁ
 =ğ
c
 {

285 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(10));

287 
	g·nic
!(

289 
	g»¶iÿ_couÁ
,

290 
	gc


294 
â
 
	g‹¡_auto_adju¡_»¶iÿ
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

295 
şu¡”
.
¡¬t
();

297 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

298 
Ët
 
mut
 
	g»giÚ
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"").
unw¿p
();

299 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

301 
Ët
 
	g¡Ües
 = 
pd_ş›Á
.
g‘_¡Ües
().
unw¿p
();

304 
wa™_tl_»ach_couÁ
(
pd_ş›Á
.
şÚe
(), 
»giÚ_id
, 5);

306 
Ët
 (
key
, 
v®ue
èğ(
b
"k1", 
	gb
"v1");

307 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

308 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

310 
	g»giÚ
 = 
pd_ş›Á


311 .
g‘_»giÚ_by_id
(
»giÚ_id
)

312 .
wa™
()

313 .
unw¿p
()

314 .
unw¿p
();

315 
Ët
 
	gi
 = 
¡Ües


316 .
™”
()

317 .
pos™iÚ
(|
s
| {

318 
»giÚ


319 .
g‘_³”s
()

320 .
™”
()

321 .
®l
(|
p
| 
s
.
g‘_id
(è!ğp.
g‘_¡Üe_id
())

323 .
unw¿p
();

325 
Ët
 
	g³”
 = 
Ãw_cÚf_chªge_³”
(&
¡Ües
[
i
], &
pd_ş›Á
);

326 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_’gše
(
³”
.
g‘_¡Üe_id
());

327 
mu¡_g‘_nÚe
(&
’gše
, 
b
"k1");

329 
	gpd_ş›Á
.
mu¡_add_³”
(
»giÚ_id
, 
³”
.
şÚe
());

331 
wa™_tl_»ach_couÁ
(
pd_ş›Á
.
şÚe
(), 
»giÚ_id
, 6);

334 
	gpd_ş›Á
.
»£t_ruË
();

335 
wa™_tl_»ach_couÁ
(
pd_ş›Á
.
şÚe
(), 
»giÚ_id
, 5);

337 
	g»giÚ
 = 
pd_ş›Á


338 .
g‘_»giÚ_by_id
(
»giÚ_id
)

339 .
wa™
()

340 .
unw¿p
()

341 .
unw¿p
();

342 
Ët
 
	g³”
 = 
»giÚ
.
g‘_³”s
().
g‘
(1).
unw¿p
().
şÚe
();

343 
	gpd_ş›Á
.
mu¡_»move_³”
(
»giÚ_id
, 
³”
);

344 
wa™_tl_»ach_couÁ
(
pd_ş›Á
.
şÚe
(), 
»giÚ_id
, 4);

347 
	gpd_ş›Á
.
»£t_ruË
();

348 
wa™_tl_»ach_couÁ
(
pd_ş›Á
.
şÚe
(), 
»giÚ_id
, 5);

351 #[
‹¡
]

352 
â
 
	$‹¡_node_auto_adju¡_»¶iÿ
() {

353 
Ët
 
couÁ
 = 7;

354 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

355 
	`‹¡_auto_adju¡_»¶iÿ
(&
mut
 
şu¡”
);

356 
	}
}

358 #[
‹¡
]

359 
â
 
	$‹¡_£rv”_auto_adju¡_»¶iÿ
() {

360 
Ët
 
couÁ
 = 7;

361 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

362 
	`‹¡_auto_adju¡_»¶iÿ
(&
mut
 
şu¡”
);

363 
	}
}

365 
â
 
	g‹¡_aá”_»move_™£lf
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

366 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

368 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

371 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_th»shŞd
 = 10000;

373 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

375 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

376 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

385 
	gşu¡”
.
¡İ_node
(2);

387 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

389 
Ët
 
	g’gše1
 = 
şu¡”
.
g‘_’gše
(1);

390 
Ët
 
	g’gše3
 = 
şu¡”
.
g‘_’gše
(3);

391 
mu¡_g‘_equ®
(&
’gše1
, 
b
"k1", b"v1");

392 
mu¡_g‘_equ®
(&
’gše3
, 
b
"k1", b"v1");

394 
	gşu¡”
.
¡İ_node
(3);

396 
	gpd_ş›Á
.
£t_ruË
(
box
 
move
 |
»giÚ
, 
_
| {

397 
Ãw_pd_»move_chªge_³”
(
»giÚ
, 
Ãw_³”
(1, 1))

400 
Ët
 
	g•och
 = 
şu¡”


401 .
pd_ş›Á


402 .
g‘_»giÚ_by_id
(1)

403 .
wa™
()

404 .
unw¿p
()

405 .
unw¿p
()

406 .
ke_»giÚ_•och
();

408 
Ët
 
	gput
 = 
Ãw_put_cmd
(
b
"test_key", b"test_val");

409 
Ët
 
mut
 
	g»q
 = 
Ãw_»que¡
(1, 
•och
, 
vec
![
put
], 
Œue
);

410 
	g»q
.
mut_h—d”
().
£t_³”
(
Ãw_³”
(1, 1));

415 
Ët
 
	g_
 = 
şu¡”
.
ÿÎ_commªd
(
»q
, 
Du¿tiÚ
::
äom_mlis
(1));

417 
	gşu¡”
.
run_node
(2);

418 
	gşu¡”
.
run_node
(3);

420 
_
 
	gš
 0..250 {

421 
Ët
 
	g»giÚ
: 
RegiÚLoÿlS‹
 = 
’gše1


422 .
g‘_msg_cf
(
CF_RAFT
, &
keys
::
»giÚ_¡©e_key
(
r1
))

423 .
unw¿p
()

424 .
unw¿p
();

425 
	g»giÚ
.
g‘_¡©e
(è=ğ
P“rS‹
::
Tomb¡Úe
 {

428 
¦“p_ms
(20);

430 
Ët
 
	g»giÚ
: 
RegiÚLoÿlS‹
 = 
’gše1


431 .
g‘_msg_cf
(
CF_RAFT
, &
keys
::
»giÚ_¡©e_key
(
r1
))

432 .
unw¿p
()

433 .
unw¿p
();

434 
	gas£¹_eq
!(
	g»giÚ
.
g‘_¡©e
(), 
	gP“rS‹
::
Tomb¡Úe
);

439 #[
‹¡
]

440 
â
 
	$‹¡_node_aá”_»move_™£lf
() {

441 
Ët
 
couÁ
 = 3;

442 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

443 
	`‹¡_aá”_»move_™£lf
(&
mut
 
şu¡”
);

444 
	}
}

446 #[
‹¡
]

447 
â
 
	$‹¡_£rv”_aá”_»move_™£lf
() {

448 
Ët
 
couÁ
 = 3;

449 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

450 
	`‹¡_aá”_»move_™£lf
(&
mut
 
şu¡”
);

451 
	}
}

453 
â
 
	g‹¡_¥l™_b¿š
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

454 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

456 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

458 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

460 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

461 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

464 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
r1
, 
Ãw_³”
(2, 2));

465 
	gşu¡”
.
add_£nd_f‹r
(
IsŞ©iÚF‹rFaùÜy
::
Ãw
(1));

468 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

471 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(4, 4));

472 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(5, 5));

473 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(6, 6));

474 
	gpd_ş›Á
.
mu¡_»move_³”
(
r1
, 
Ãw_³”
(2, 2));

475 
	gpd_ş›Á
.
mu¡_»move_³”
(
r1
, 
Ãw_³”
(3, 3));

477 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

478 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(6), 
b
"k2", b"v2");

479 
Ët
 
	g»giÚ_d‘a
 = 
şu¡”
.
»giÚ_d‘a
(
r1
, 1);

480 
Ët
 
	g»giÚ_³”s
 = 
»giÚ_d‘a
.
g‘_»giÚ
().
g‘_³”s
();

481 
	gas£¹_eq
!(
	g»giÚ_³”s
.
Ën
(), 3);

482 
³”
 
š
 
	g»giÚ_³”s
 {

483 
	gas£¹
!(
	g³”
.
g‘_id
() < 4);

485 
	gas£¹
!(
	g»giÚ_d‘a
.
g‘_Ëad”
().
g‘_id
() < 4);

488 
	gşu¡”
.
ş—r_£nd_f‹rs
();

489 
	gşu¡”
.
·¹™iÚ
(
vec
![1, 2, 3], vec![4, 5, 6]);

492 
	gşu¡”
.
mu¡_put
(
b
"k3", b"v3");

497 
Ët
 
	gh—d”0
 = 
fšd_Ëad”_»¥Ú£_h—d”
(
şu¡”
, 
r1
, 
Ãw_³”
(2, 2));

498 
	gas£¹
!(
	gh—d”0
.
g‘_”rÜ
().
has_»giÚ_nÙ_found
());

501 
Ët
 
	g‹rm
 = 
fšd_Ëad”_»¥Ú£_h—d”
(
şu¡”
, 
r1
, 
Ãw_³”
(1, 1)).
g‘_cu¼’t_‹rm
();

502 
Ët
 
mut
 
	gcu¼’t_‹rm
 = 
‹rm
;

503 
	gcu¼’t_‹rm
 < 
	g‹rm
 + 2 {

504 
¦“p_ms
(10);

505 
Ët
 
	gh—d”2
 = 
fšd_Ëad”_»¥Ú£_h—d”
(
şu¡”
, 
r1
, 
Ãw_³”
(1, 1));

506 
	gcu¼’t_‹rm
 = 
h—d”2
.
g‘_cu¼’t_‹rm
();

509 
Ët
 
	gh—d”1
 = 
fšd_Ëad”_»¥Ú£_h—d”
(
şu¡”
, 
r1
, 
Ãw_³”
(2, 2));

510 
	gas£¹
!(
	gh—d”1
.
g‘_”rÜ
().
has_»giÚ_nÙ_found
());

513 
â
 
	gfšd_Ëad”_»¥Ú£_h—d”
<
	gT
: 
SimuÏtÜ
>(

514 
şu¡”
: &
mut
 
Clu¡”
<
T
>,

515 
	g»giÚ_id
: 
u64
,

516 
	g³”
: 
m‘­b
::
P“r
,

517 è-> 
	gRaáRe¥Ú£H—d”
 {

518 
Ët
 
	gfšd_Ëad”
 = 
Ãw_¡©us_»que¡
(
»giÚ_id
, 
³”
, 
Ãw_»giÚ_Ëad”_cmd
());

519 
Ët
 
	g»¥
 = 
şu¡”
.
ÿÎ_commªd
(
fšd_Ëad”
, 
Du¿tiÚ
::
äom_£cs
(5));

520 
	g»¥
.
unw¿p
().
ke_h—d”
()

523 #[
‹¡
]

524 
â
 
	$‹¡_£rv”_¥l™_b¿š
() {

525 
Ët
 
couÁ
 = 6;

526 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

527 
	`‹¡_¥l™_b¿š
(&
mut
 
şu¡”
);

528 
	}
}

530 #[
‹¡
]

531 
â
 
	$‹¡_node_¥l™_b¿š
() {

532 
Ët
 
couÁ
 = 6;

533 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

534 
	`‹¡_¥l™_b¿š
(&
mut
 
şu¡”
);

535 
	}
}

538 
â
 
	g‹¡_cÚf_chªge_§ã
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

539 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

541 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

543 
Ët
 
	g»giÚ_id
 = 
şu¡”
.
run_cÚf_chªge
();

548 
	gpd_ş›Á
.
mu¡_add_³”
(
»giÚ_id
, 
Ãw_³”
(2, 2));

549 
	gpd_ş›Á
.
mu¡_add_³”
(
»giÚ_id
, 
Ãw_³”
(3, 3));

552 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
»giÚ_id
, 
Ãw_³”
(1, 1));

553 
	gşu¡”
.
add_£nd_f‹r
(
IsŞ©iÚF‹rFaùÜy
::
Ãw
(1));

556 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

561 
	gpd_ş›Á
.
add_³”
(
»giÚ_id
, 
Ãw_³”
(4, 4));

563 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

564 
	gpd_ş›Á
.
mu¡_nÚe_³”
(
»giÚ_id
, 
Ãw_³”
(4, 4));

567 
	gşu¡”
.
ş—r_£nd_f‹rs
();

570 
	gpd_ş›Á
.
mu¡_add_³”
(
»giÚ_id
, 
Ãw_³”
(4, 4));

575 
	gpd_ş›Á
.
mu¡_»move_³”
(
»giÚ_id
, 
Ãw_³”
(4, 4));

578 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
»giÚ_id
, 
Ãw_³”
(1, 1));

579 
	gşu¡”
.
add_£nd_f‹r
(
IsŞ©iÚF‹rFaùÜy
::
Ãw
(1));

582 
	gşu¡”
.
mu¡_put
(
b
"k3", b"v3");

587 
	gpd_ş›Á
.
»move_³”
(
»giÚ_id
, 
Ãw_³”
(2, 2));

588 
	gşu¡”
.
mu¡_put
(
b
"k4", b"v4");

589 
	gpd_ş›Á
.
mu¡_have_³”
(
»giÚ_id
, 
Ãw_³”
(2, 2));

592 
	gpd_ş›Á
.
mu¡_»move_³”
(
»giÚ_id
, 
Ãw_³”
(1, 1));

595 
	gpd_ş›Á
.
mu¡_»move_³”
(
»giÚ_id
, 
Ãw_³”
(2, 2));

598 #[
‹¡
]

599 
â
 
	$‹¡_node_cÚf_chªge_§ã
() {

600 
Ët
 
couÁ
 = 5;

601 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

602 
	`‹¡_cÚf_chªge_§ã
(&
mut
 
şu¡”
);

603 
	}
}

605 #[
‹¡
]

606 
â
 
	$‹¡_£rv”_§ã_cÚf_chªge
() {

607 
Ët
 
couÁ
 = 5;

608 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

609 
	`‹¡_cÚf_chªge_§ã
(&
mut
 
şu¡”
);

610 
	}
}

612 #[
‹¡
]

613 
â
 
	$‹¡_cÚf_chªge_»move_Ëad”
() {

614 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

615 
şu¡”
.
cfg
.
¿á_¡Üe
.
®low_»move_Ëad”
 = 
çl£
;

616 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
	`şÚe
();

617 
pd_ş›Á
.
	`di§bË_deçuÉ_ruË
();

618 
Ët
 
r1
 = 
şu¡”
.
	`run_cÚf_chªge
();

619 
pd_ş›Á
.
	`mu¡_add_³”
(
r1
, 
	`Ãw_³”
(2, 2));

620 
pd_ş›Á
.
	`mu¡_add_³”
(
r1
, 
	`Ãw_³”
(3, 3));

623 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(
r1
, 
	`Ãw_³”
(1, 1));

626 
Ët
 
•och
 = 
şu¡”
.
	`g‘_»giÚ_•och
(
r1
);

627 
Ët
 
»q
 = 
	`Ãw_admš_»que¡
(

628 
r1
,

629 &
•och
,

630 
	`Ãw_chªge_³”_»que¡
(
CÚfChªgeTy³
::
RemoveNode
, 
	`Ãw_³”
(1, 1)),

632 
Ët
 
»s
 = 
şu¡”


633 .
	`ÿÎ_commªd_Ú_Ëad”
(
»q
, 
Du¿tiÚ
::
	`äom_£cs
(5))

634 .
	`unw¿p
();

635 
as£¹_eq
!(

636 
»s
.
	`g‘_h—d”
().
	`g‘_”rÜ
().
	`g‘_mes§ge
(),

639 
	}
}

	@tests/raftstore_cases/test_lease_read.rs

16 
u£
 
	g¡d
::
th»ad
;

17 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gRwLock
};

18 
u£
 
	g¡d
::
sync
::
©omic
::*;

19 
u£
 
	g¡d
::
time
::*;

20 
u£
 
	g¡d
::
cŞËùiÚs
::
HashS‘
;

22 
u£
 
	gkv´Ùo
::
”aápb
::{
CÚfChªgeTy³
, 
	gMes§geTy³
};

23 
u£
 
	gkv´Ùo
::
m‘­b
::{
P“r
, 
	gRegiÚ
};

24 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::
CmdTy³
;

25 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
RaáLoÿlS‹
, 
	gRaáMes§ge
};

26 
u£
 
	gtikv
::
¿á¡Üe
::{
E¼Ü
, 
	gResuÉ
};

27 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
keys
;

28 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
’gše
::
P“kabË
;

29 
u£
 
	gtikv
::
ut
::{
esÿ³
, 
	gHªdyRwLock
};

30 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

32 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

33 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

34 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

35 
u£
 
	gsu³r
::
ut
::*;

37 #[
d”ive
(
ClÚe
, 
DeçuÉ
)]

38 
	sL—£R—dF‹r
 {

39 
	mùx
: 
Arc
<
RwLock
<
HashS‘
<
Vec
<
u8
>>>>,

40 
	mke
: 
boŞ
,

43 
im¶
 
	gF‹r
<
	gRaáMes§ge
> 
	gL—£R—dF‹r
 {

44 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
RaáMes§ge
>è-> 
ResuÉ
<()> {

45 
Ët
 
mut
 
ùx
 = 
£lf
.ùx.
wl
();

46 
m
 
š
 
	gmsgs
 {

47 
Ët
 
	gmsg
 = 
m
.
mut_mes§ge
();

48 
	gmsg
.
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgH—¹b—t
 && !
msg
.
g‘_cÚ‹xt
().
is_em±y
() {

49 
ùx
.
š£¹
(
msg
.
g‘_cÚ‹xt
().
to_owÃd
());

51 
	g£lf
.
	gke
 {

52 
	gmsg
.
ke_cÚ‹xt
();

55 
Ok
(())

60 
â
 
	g»ad_Ú_³”
<
	gT
: 
SimuÏtÜ
>(

61 
şu¡”
: &
mut
 
Clu¡”
<
T
>,

62 
	g³”
: 
P“r
,

63 
	g»giÚ
: 
RegiÚ
,

64 
	gkey
: &[
u8
],

65 
	gtimeout
: 
Du¿tiÚ
,

66 è-> 
	gResuÉ
<
	gVec
<
	gu8
>> {

67 
Ët
 
mut
 
	g»que¡
 = 
Ãw_»que¡
(

68 
»giÚ
.
g‘_id
(),

69 
»giÚ
.
g‘_»giÚ_•och
().
şÚe
(),

70 
vec
![
Ãw_g‘_cmd
(
key
)],

71 
çl£
,

73 
	g»que¡
.
mut_h—d”
().
£t_³”
(
³”
);

74 
Ët
 
mut
 
	g»¥
 = 
şu¡”
.
ÿÎ_commªd
(
»que¡
, 
timeout
)?;

75 
	g»¥
.
g‘_h—d”
().
has_”rÜ
() {

76  
E¼
(
E¼Ü
::
Oth”
(

77 
box_”r
!(
»¥
.
mut_h—d”
().
ke_”rÜ
().
ke_mes§ge
()),

80 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
().
Ën
(), 1);

81 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
()[0].
g‘_cmd_ty³
(), 
	gCmdTy³
::
G‘
);

82 
	gas£¹
!(
	g»¥
.
g‘_»¥Ú£s
()[0].
has_g‘
());

83 
Ok
(
»¥
.
mut_»¥Ú£s
()[0].
mut_g‘
().
ke_v®ue
())

86 
â
 
	gmu¡_»ad_Ú_³”
<
	gT
: 
SimuÏtÜ
>(

87 
şu¡”
: &
mut
 
Clu¡”
<
T
>,

88 
	g³”
: 
P“r
,

89 
	g»giÚ
: 
RegiÚ
,

90 
	gkey
: &[
u8
],

91 
	gv®ue
: &[
u8
],

93 
Ët
 
	gtimeout
 = 
Du¿tiÚ
::
äom_£cs
(1);

94 
m©ch
 
»ad_Ú_³”
(
şu¡”
, 
³”
, 
»giÚ
, 
key
, 
timeout
) {

95 
Ok
(
v
è=> v !ğ
v®ue
 {

96 
·nic
!(

98 
esÿ³
(
key
),

99 
esÿ³
(
v®ue
),

100 
esÿ³
(&
v
)

103 
E¼
(
e
è=> 
·nic
!("çedØ»ad fÜ key {},ƒ¼ {:?}", 
esÿ³
(
key
), 
	ge
),

107 
â
 
	gmu¡_”rÜ_»ad_Ú_³”
<
	gT
: 
SimuÏtÜ
>(

108 
şu¡”
: &
mut
 
Clu¡”
<
T
>,

109 
	g³”
: 
P“r
,

110 
	g»giÚ
: 
RegiÚ
,

111 
	gkey
: &[
u8
],

112 
	gtimeout
: 
Du¿tiÚ
,

114 
Ët
 
Ok
(
v®ue
èğ
»ad_Ú_³”
(
şu¡”
, 
³”
, 
»giÚ
, 
key
, 
timeout
) {

115 
	g·nic
!(

117 
esÿ³
(
key
),

118 
esÿ³
(&
v®ue
)

136 
â
 
	g‹¡_»Ãw_Ëa£
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

138 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_th»shŞd
 = 100;

140 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_ba£_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(50);

142 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_–eùiÚ_timeout_ticks
 = 10000;

144 
Ët
 
	gmax_Ëa£
 = 
Du¿tiÚ
::
äom_£cs
(2);

145 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_¡Üe_max_Ëad”_Ëa£
 = 
R—dabËDu¿tiÚ
(
max_Ëa£
);

147 
Ët
 
	gnode_id
 = 1u64;

148 
Ët
 
	g¡Üe_id
 = 1u64;

149 
Ët
 
	g³”
 = 
Ãw_³”
(
¡Üe_id
, 
node_id
);

150 
	gşu¡”
.
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

151 
Ët
 
	g»giÚ_id
 = 
şu¡”
.
run_cÚf_chªge
();

152 
id
 
	gš
 2..şu
	g¡”
.
	g’gšes
.
Ën
(è
as
 
	gu64
 + 1 {

153 
	gşu¡”
.
	gpd_ş›Á
.
mu¡_add_³”
(
»giÚ_id
, 
Ãw_³”
(
id
, id));

157 
Ët
 
	gkey
 = 
b
"k";

158 
	gşu¡”
.
mu¡_put
(
key
, 
b
"v1");

160 
Ët
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
key
);

161 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

162 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
»giÚ_id
, 
³”
.
şÚe
());

163 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_¿á_’gše
(
¡Üe_id
);

164 
Ët
 
	g¡©e_key
 = 
keys
::
¿á_¡©e_key
(
»giÚ_id
);

165 
Ët
 
	g¡©e
: 
RaáLoÿlS‹
 = 
’gše
.
g‘_msg
(&
¡©e_key
).
unw¿p
().unwrap();

166 
Ët
 
	gÏ¡_šdex
 = 
¡©e
.
g‘_Ï¡_šdex
();

168 
Ët
 
	gd‘eùÜ
 = 
L—£R—dF‹r
::();

169 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(
d‘eùÜ
.
şÚe
()));

172 
mu¡_»ad_Ú_³”
(
şu¡”
, 
³”
.
şÚe
(), 
»giÚ
.şÚe(), 
key
, 
b
"v1");

173 
	gas£¹_eq
!(
	gd‘eùÜ
.
	gùx
.
¾
().
Ën
(), 0);

175 
Ët
 
mut
 
	gex³ù_Ëa£_»ad
 = 0;

177 
	gşu¡”
.
	g’gšes
.
Ën
() > 1 {

179 
	gth»ad
::
¦“p
(
max_Ëa£
);

182 
mu¡_»ad_Ú_³”
(
şu¡”
, 
³”
.
şÚe
(), 
»giÚ
.şÚe(), 
key
, 
b
"v1");

185 
	gas£¹_eq
!(
	gşu¡”
.
Ëad”_of_»giÚ
(
»giÚ_id
), 
Some
(
³”
.
şÚe
()));

186 
	gex³ù_Ëa£_»ad
 += 1;

187 
	gas£¹_eq
!(
	gd‘eùÜ
.
	gùx
.
¾
().
Ën
(), 
	gex³ù_Ëa£_»ad
);

191 
	gth»ad
::
¦“p
(
max_Ëa£
);

194 
	gşu¡”
.
mu¡_put
(
key
, 
b
"v2");

197 
	gas£¹_eq
!(
	gşu¡”
.
Ëad”_of_»giÚ
(
»giÚ_id
), 
Some
(
³”
.
şÚe
()));

198 
Ët
 
	g¡©e
: 
RaáLoÿlS‹
 = 
’gše
.
g‘_msg
(&
¡©e_key
).
unw¿p
().unwrap();

199 
	gas£¹_eq
!(
	g¡©e
.
g‘_Ï¡_šdex
(), 
	gÏ¡_šdex
 + 1);

202 
mu¡_»ad_Ú_³”
(
şu¡”
, 
³”
.
şÚe
(), 
»giÚ
.şÚe(), 
key
, 
b
"v2");

205 
	gas£¹_eq
!(
	gd‘eùÜ
.
	gùx
.
¾
().
Ën
(), 
	gex³ù_Ëa£_»ad
);

208 #[
‹¡
]

209 
â
 
	$‹¡_Úe_node_»Ãw_Ëa£
() {

210 
Ët
 
couÁ
 = 1;

211 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

212 
	`‹¡_»Ãw_Ëa£
(&
mut
 
şu¡”
);

213 
	}
}

215 #[
‹¡
]

216 
â
 
	$‹¡_node_»Ãw_Ëa£
() {

217 
Ët
 
couÁ
 = 3;

218 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

219 
	`‹¡_»Ãw_Ëa£
(&
mut
 
şu¡”
);

220 
	}
}

225 
â
 
	g‹¡_Ëa£_expœed
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

226 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

228 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

231 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_th»shŞd
 = 100;

233 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_ba£_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(50);

235 
Ët
 
	g–eùiÚ_timeout
 = 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_ba£_tick_š‹rv®
.0 *

236 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_–eùiÚ_timeout_ticks
 
as
 
u32
;

237 
Ët
 
	gnode_id
 = 3u64;

238 
Ët
 
	g¡Üe_id
 = 3u64;

239 
Ët
 
	g³”
 = 
Ãw_³”
(
¡Üe_id
, 
node_id
);

240 
	gşu¡”
.
run
();

243 
Ët
 
	gkey
 = 
b
"k";

244 
	gşu¡”
.
mu¡_put
(
key
, 
b
"v1");

246 
Ët
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
key
);

247 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

248 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
»giÚ_id
, 
³”
.
şÚe
());

251 
	gşu¡”
.
add_£nd_f‹r
(
IsŞ©iÚF‹rFaùÜy
::
Ãw
(
¡Üe_id
));

254 
	gth»ad
::
¦“p
(
–eùiÚ_timeout
 * 2);

257 
mu¡_”rÜ_»ad_Ú_³”
(

258 
şu¡”
,

259 
³”
.
şÚe
(),

260 
»giÚ
.
şÚe
(),

261 
key
,

262 
Du¿tiÚ
::
äom_£cs
(1),

266 #[
‹¡
]

267 
â
 
	$‹¡_node_Ëa£_expœed
() {

268 
Ët
 
couÁ
 = 3;

269 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

270 
	`‹¡_Ëa£_expœed
(&
mut
 
şu¡”
);

271 
	}
}

278 
â
 
	g‹¡_Ëa£_un§ã_duršg_Ëad”_Œªsãrs
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

280 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_th»shŞd
 = 100;

282 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_ba£_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(50);

284 
Ët
 
	gba£_tick
 = 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_ba£_tick_š‹rv®
.0;

285 
Ët
 
	g–eùiÚ_timeout
 = 
ba£_tick
 * 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_–eùiÚ_timeout_ticks
 
as
 
u32
;

286 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_¡Üe_max_Ëad”_Ëa£
 = 
R—dabËDu¿tiÚ
(
–eùiÚ_timeout
);

288 
Ët
 
	g¡Üe_id
 = 1u64;

289 
Ët
 
	g³”
 = 
Ãw_³”
(
¡Üe_id
, 1);

290 
Ët
 
	g³”3_¡Üe_id
 = 3u64;

291 
Ët
 
	g³”3
 = 
Ãw_³”
(
³”3_¡Üe_id
, 3);

292 
	gşu¡”
.
run
();

294 
Ët
 
	gd‘eùÜ
 = 
L—£R—dF‹r
::();

295 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(
d‘eùÜ
.
şÚe
()));

298 
Ët
 
	gkey
 = 
b
"k";

299 
	gşu¡”
.
mu¡_put
(
key
, 
b
"v1");

301 
Ët
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
key
);

302 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

303 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
»giÚ_id
, 
³”
.
şÚe
());

306 
mu¡_»ad_Ú_³”
(
şu¡”
, 
³”
.
şÚe
(), 
»giÚ
.şÚe(), 
key
, 
b
"v1");

308 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_¿á_’gše
(
¡Üe_id
);

309 
Ët
 
	g¡©e_key
 = 
keys
::
¿á_¡©e_key
(
»giÚ_id
);

310 
Ët
 
	g¡©e
: 
RaáLoÿlS‹
 = 
’gše
.
g‘_msg
(&
¡©e_key
).
unw¿p
().unwrap();

311 
Ët
 
	gÏ¡_šdex
 = 
¡©e
.
g‘_Ï¡_šdex
();

314 
mu¡_»ad_Ú_³”
(
şu¡”
, 
³”
.
şÚe
(), 
»giÚ
.şÚe(), 
key
, 
b
"v1");

315 
Ët
 
	g¡©e
: 
RaáLoÿlS‹
 = 
’gše
.
g‘_msg
(&
¡©e_key
).
unw¿p
().unwrap();

316 
	gas£¹_eq
!(
	g¡©e
.
g‘_Ï¡_šdex
(), 
	gÏ¡_šdex
);

317 
	gas£¹_eq
!(
	gd‘eùÜ
.
	gùx
.
¾
().
Ën
(), 0);

320 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

321 
RegiÚPack‘F‹r
::
Ãw
(
»giÚ_id
, 
³”3_¡Üe_id
)

322 .
msg_ty³
(
Mes§geTy³
::
MsgTimeoutNow
)

323 .
dœeùiÚ
(
DœeùiÚ
::
Recv
),

327 
	gşu¡”
.
Œªsãr_Ëad”
(
»giÚ_id
, 
³”3
);

330 
	gth»ad
::
¦“p
(
–eùiÚ_timeout
 / 2);

333 
mu¡_»ad_Ú_³”
(
şu¡”
, 
³”
.
şÚe
(), 
»giÚ
.şÚe(), 
key
, 
b
"v1");

334 
	gas£¹_eq
!(
	gd‘eùÜ
.
	gùx
.
¾
().
Ën
(), 1);

337 
mu¡_»ad_Ú_³”
(
şu¡”
, 
³”
.
şÚe
(), 
»giÚ
.şÚe(), 
key
, 
b
"v1");

338 
	gas£¹_eq
!(
	gd‘eùÜ
.
	gùx
.
¾
().
Ën
(), 2);

341 
	gth»ad
::
¦“p
(
–eùiÚ_timeout
 * 2);

347 
mu¡_»ad_Ú_³”
(
şu¡”
, 
³”
.
şÚe
(), 
»giÚ
.şÚe(), 
key
, 
b
"v1");

348 
	gas£¹_eq
!(
	gd‘eùÜ
.
	gùx
.
¾
().
Ën
(), 3);

351 
Ët
 
	g¡©e
: 
RaáLoÿlS‹
 = 
’gše
.
g‘_msg
(&
¡©e_key
).
unw¿p
().unwrap();

352 
	gas£¹_eq
!(
	g¡©e
.
g‘_Ï¡_šdex
(), 
	gÏ¡_šdex
 + 1);

355 
	gth»ad
::
¦“p
(
–eùiÚ_timeout
 / 2);

358 
mu¡_»ad_Ú_³”
(
şu¡”
, 
³”
.
şÚe
(), 
»giÚ
.şÚe(), 
key
, 
b
"v1");

359 
Ët
 
	g¡©e
: 
RaáLoÿlS‹
 = 
’gše
.
g‘_msg
(&
¡©e_key
).
unw¿p
().unwrap();

360 
	gas£¹_eq
!(
	g¡©e
.
g‘_Ï¡_šdex
(), 
	gÏ¡_šdex
 + 1);

361 
	gas£¹_eq
!(
	gd‘eùÜ
.
	gùx
.
¾
().
Ën
(), 3);

364 #[
‹¡
]

365 
â
 
	$‹¡_node_Ëa£_un§ã_duršg_Ëad”_Œªsãrs
() {

366 
Ët
 
couÁ
 = 3;

367 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

368 
	`‹¡_Ëa£_un§ã_duršg_Ëad”_Œªsãrs
(&
mut
 
şu¡”
);

369 
	}
}

373 #[
‹¡
]

374 
â
 
	$‹¡_node_ÿÎback_wh’_de¡royed
() {

375 
Ët
 
couÁ
 = 3;

376 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

377 
şu¡”
.
	`run
();

378 
şu¡”
.
	`mu¡_put
(
b
"k1", b"v1");

379 
Ët
 
Ëad”
 = 
şu¡”
.
	`Ëad”_of_»giÚ
(1).
	`unw¿p
();

380 
Ët
 
cc
 = 
	`Ãw_chªge_³”_»que¡
(
CÚfChªgeTy³
::
RemoveNode
, 
Ëad”
.
	`şÚe
());

381 
Ët
 
•och
 = 
şu¡”
.
	`g‘_»giÚ_•och
(1);

382 
Ët
 
»q
 = 
	`Ãw_admš_»que¡
(1, &
•och
, 
cc
);

384 
Ët
 
block
 = 
Arc
::
	`Ãw
(
AtomicBoŞ
::Ãw(
Œue
));

385 
şu¡”
.
	`add_£nd_f‹r
(
	`ClÚeF‹rFaùÜy
(

386 
RegiÚPack‘F‹r
::
	`Ãw
(1, 
Ëad”
.
	`g‘_¡Üe_id
())

387 .
	`msg_ty³
(
Mes§geTy³
::
MsgAµ’dRe¥Ú£
)

388 .
	`dœeùiÚ
(
DœeùiÚ
::
Recv
)

389 .
	`wh’
(
block
.
	`şÚe
()),

391 
Ët
 
mut
 
f‹r
 = 
L—£R—dF‹r
::();

392 
f‹r
.
ke
 = 
Œue
;

394 
şu¡”
.
	`add_£nd_f‹r
(
	`ClÚeF‹rFaùÜy
(
f‹r
.
	`şÚe
()));

396 
Ët
 
_
 = 
şu¡”
.
	`ÿÎ_commªd_Ú_Ëad”
(
»q
, 
Du¿tiÚ
::
	`äom_mlis
(500));

398 
Ët
 
g‘
 = 
	`Ãw_g‘_cmd
(
b
"k1");

399 
Ët
 
»q
 = 
	`Ãw_»que¡
(1, 
•och
, 
vec
![
g‘
], 
Œue
);

400 
block
.
	`¡Üe
(
çl£
, 
Ord”šg
::
SeqC¡
);

401 
Ët
 
»¥
 = 
şu¡”


402 .
	`ÿÎ_commªd_Ú_Ëad”
(
»q
, 
Du¿tiÚ
::
	`äom_£cs
(3))

403 .
	`unw¿p
();

404 
as£¹
!(

405 !
f‹r
.
ùx
.
	`¾
().
	`is_em±y
(),

408 
as£¹
!(

409 
»¥
.
	`g‘_h—d”
().
	`g‘_”rÜ
().
	`has_»giÚ_nÙ_found
(),

411 
»¥


413 
	}
}

	@tests/raftstore_cases/test_multi.rs

14 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::*;

15 
u£
 
	gtikv
::
ut
::
HªdyRwLock
;

16 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

17 
u£
 
	gtikv
::
£rv”
::
Œª¥Üt
::
RaáStÜeRou‹r
;

18 
u£
 
	gtikv
::
¿á¡Üe
::
ResuÉ
;

19 
u£
 
	gkv´Ùo
::
”aápb
::
Mes§geTy³
;

20 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::
RaáCmdRe¥Ú£
;

22 
u£
 
	gsu³r
::
ut
::*;

23 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

24 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

25 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

26 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

28 
u£
 
	g¿nd
;

29 
u£
 
	g¿nd
::
Rng
;

30 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

31 
u£
 
	g¡d
::
sync
::*;

32 
u£
 
	g¡d
::
th»ad
;

33 
u£
 
	g¡d
::
sync
::
©omic
::*;

35 
â
 
	g‹¡_muÉi_ba£
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

36 
şu¡”
.
run
();

38 
‹¡_muÉi_ba£_aá”_boÙ¡¿p
(
şu¡”
);

41 
â
 
	g‹¡_muÉi_ba£_aá”_boÙ¡¿p
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

42 
Ët
 (
key
, 
v®ue
èğ(
b
"k1", 
	gb
"v1");

44 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

45 
	gas£¹_eq
!(
	gşu¡”
.
mu¡_g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

48 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(200));

50 
	gşu¡”
.
as£¹_quÜum
(|
’gše
| {

51 
m©ch
 
’gše
.
g‘_v®ue
(&
keys
::
d©a_key
(
key
)).
unw¿p
() {

52 
NÚe
 => 
çl£
,

53 
Some
(
v
è=> &*v =ğ
v®ue
,

57 
	gşu¡”
.
mu¡_d–‘e
(
key
);

58 
	gas£¹_eq
!(
	gşu¡”
.
mu¡_g‘
(
key
), 
	gNÚe
);

61 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(200));

63 
	gşu¡”
.
as£¹_quÜum
(|
’gše
| {

64 
’gše
.
g‘_v®ue
(&
keys
::
d©a_key
(
key
)).
unw¿p
().
is_nÚe
()

70 
â
 
	g‹¡_muÉi_Ëad”_üash
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

71 
şu¡”
.
run
();

73 
Ët
 (
key1
, 
v®ue1
èğ(
b
"k1", 
	gb
"v1");

75 
	gşu¡”
.
mu¡_put
(
key1
, 
v®ue1
);

77 
Ët
 
	gÏ¡_Ëad”
 = 
şu¡”
.
Ëad”_of_»giÚ
(1).
unw¿p
();

78 
	gşu¡”
.
¡İ_node
(
Ï¡_Ëad”
.
g‘_¡Üe_id
());

80 
¦“p_ms
(800);

81 
	gşu¡”
.
»£t_Ëad”_of_»giÚ
(1);

82 
Ët
 
	gÃw_Ëad”
 = 
şu¡”


83 .
Ëad”_of_»giÚ
(1)

84 .
ex³ù
("leader should beƒlected.");

85 
	gas£¹_Ã
!(
	gÃw_Ëad”
, 
	gÏ¡_Ëad”
);

87 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key1
), 
Some
(
v®ue1
.
to_vec
()));

89 
Ët
 (
key2
, 
v®ue2
èğ(
b
"k2", 
	gb
"v2");

91 
	gşu¡”
.
mu¡_put
(
key2
, 
v®ue2
);

92 
	gşu¡”
.
mu¡_d–‘e
(
key1
);

93 
mu¡_g‘_nÚe
(

94 &
şu¡”
.
’gšes
[&
Ï¡_Ëad”
.
g‘_¡Üe_id
()].
kv_’gše
,

95 
key2
,

97 
mu¡_g‘_equ®
(

98 &
şu¡”
.
’gšes
[&
Ï¡_Ëad”
.
g‘_¡Üe_id
()].
kv_’gše
,

99 
key1
,

100 
v®ue1
,

104 
	gşu¡”
.
run_node
(
Ï¡_Ëad”
.
g‘_¡Üe_id
());

106 
mu¡_g‘_equ®
(

107 &
şu¡”
.
’gšes
[&
Ï¡_Ëad”
.
g‘_¡Üe_id
()].
kv_’gše
,

108 
key2
,

109 
v®ue2
,

111 
mu¡_g‘_nÚe
(

112 &
şu¡”
.
’gšes
[&
Ï¡_Ëad”
.
g‘_¡Üe_id
()].
kv_’gše
,

113 
key1
,

118 
â
 
	g‹¡_muÉi_şu¡”_»¡¬t
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

119 
şu¡”
.
run
();

121 
Ët
 (
key
, 
v®ue
èğ(
b
"k1", 
	gb
"v1");

123 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
	gNÚe
);

124 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

126 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

128 
	gşu¡”
.
shutdown
();

131 
¦“p_ms
(500);

133 
	gşu¡”
.
¡¬t
();

135 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

138 
â
 
	g‹¡_muÉi_lo¡_majÜ™y
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>, 
	gcouÁ
: 
usize
) {

139 
şu¡”
.
run
();

141 
Ët
 
	gh®f
 = (
couÁ
 
as
 
u64
 + 1) / 2;

142 
i
 
	gš
 1..
	gh®f
 + 1 {

143 
	gşu¡”
.
¡İ_node
(
i
);

145 
Ët
 
Some
(
Ëad”
èğ
şu¡”
.
Ëad”_of_»giÚ
(1) {

146 
Ëad”
.
g‘_¡Üe_id
(è>ğ
h®f
 + 1 {

147 
şu¡”
.
¡İ_node
(
Ëad”
.
g‘_¡Üe_id
());

150 
	gşu¡”
.
»£t_Ëad”_of_»giÚ
(1);

151 
¦“p_ms
(600);

153 
	gas£¹
!(
	gşu¡”
.
Ëad”_of_»giÚ
(1).
is_nÚe
());

157 
â
 
	g‹¡_muÉi_¿ndom_»¡¬t
<
	gT
: 
SimuÏtÜ
>(

158 
şu¡”
: &
mut
 
Clu¡”
<
T
>,

159 
	gnode_couÁ
: 
usize
,

160 
	g»¡¬t_couÁ
: 
u32
,

162 
	gşu¡”
.
run
();

164 
Ët
 
mut
 
	gºg
 = 
¿nd
::
th»ad_ºg
();

165 
Ët
 
mut
 
	gv®ue
 = [0u8; 5];

167 
i
 
	gš
 1..
	g»¡¬t_couÁ
 {

169 
Ët
 
	gid
 = 1 + 
ºg
.
g’_¿nge
(0, 
node_couÁ
 
as
 
u64
);

170 
	gşu¡”
.
¡İ_node
(
id
);

172 
Ët
 
	gkey
 = 
i
.
to_¡ršg
().
što_by‹s
();

174 
	gºg
.
fl_by‹s
(&
mut
 
v®ue
);

175 
	gşu¡”
.
mu¡_put
(&
key
, &
v®ue
);

176 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(&
key
), 
Some
(
v®ue
.
to_vec
()));

178 
	gşu¡”
.
run_node
(
id
);

181 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(
id
), &
key
, &
v®ue
);

183 
	gşu¡”
.
mu¡_d–‘e
(&
key
);

184 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(&
key
), 
	gNÚe
);

188 #[
‹¡
]

189 
â
 
	$‹¡_muÉi_node_ba£
() {

190 
Ët
 
couÁ
 = 5;

191 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

192 
	`‹¡_muÉi_ba£
(&
mut
 
şu¡”
)

193 
	}
}

195 
â
 
	g‹¡_muÉi_drİ_·ck‘
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

196 
şu¡”
.
run
();

197 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(
DrİPack‘F‹r
::
Ãw
(30)));

198 
‹¡_muÉi_ba£_aá”_boÙ¡¿p
(
şu¡”
);

201 #[
‹¡
]

202 
â
 
	$‹¡_muÉi_node_Ï‹ncy
() {

203 
Ët
 
couÁ
 = 5;

204 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

205 
	`‹¡_muÉi_Ï‹ncy
(&
mut
 
şu¡”
);

206 
	}
}

208 #[
‹¡
]

209 
â
 
	$‹¡_muÉi_node_drİ_·ck‘
() {

210 
Ët
 
couÁ
 = 5;

211 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

212 
	`‹¡_muÉi_drİ_·ck‘
(&
mut
 
şu¡”
);

213 
	}
}

215 #[
‹¡
]

216 
â
 
	$‹¡_muÉi_£rv”_ba£
() {

217 
Ët
 
couÁ
 = 5;

218 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

219 
	`‹¡_muÉi_ba£
(&
mut
 
şu¡”
)

220 
	}
}

223 
â
 
	g‹¡_muÉi_Ï‹ncy
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

224 
şu¡”
.
run
();

225 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

226 
D–ayF‹r
::
Ãw
(
Du¿tiÚ
::
äom_mlis
(30)),

228 
‹¡_muÉi_ba£_aá”_boÙ¡¿p
(
şu¡”
);

231 #[
‹¡
]

232 
â
 
	$‹¡_muÉi_£rv”_Ï‹ncy
() {

233 
Ët
 
couÁ
 = 5;

234 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

235 
	`‹¡_muÉi_Ï‹ncy
(&
mut
 
şu¡”
);

236 
	}
}

238 
â
 
	g‹¡_muÉi_¿ndom_Ï‹ncy
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

239 
şu¡”
.
run
();

240 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(
RªdomL©’cyF‹r
::
Ãw
(50)));

241 
‹¡_muÉi_ba£_aá”_boÙ¡¿p
(
şu¡”
);

244 #[
‹¡
]

245 
â
 
	$‹¡_muÉi_node_¿ndom_Ï‹ncy
() {

246 
Ët
 
couÁ
 = 5;

247 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

248 
	`‹¡_muÉi_¿ndom_Ï‹ncy
(&
mut
 
şu¡”
);

249 
	}
}

251 #[
‹¡
]

252 
â
 
	$‹¡_muÉi_£rv”_¿ndom_Ï‹ncy
() {

253 
Ët
 
couÁ
 = 5;

254 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

255 
	`‹¡_muÉi_¿ndom_Ï‹ncy
(&
mut
 
şu¡”
);

256 
	}
}

258 #[
‹¡
]

259 
â
 
	$‹¡_muÉi_£rv”_drİ_·ck‘
() {

260 
Ët
 
couÁ
 = 5;

261 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

262 
	`‹¡_muÉi_drİ_·ck‘
(&
mut
 
şu¡”
);

263 
	}
}

265 #[
‹¡
]

266 
â
 
	$‹¡_muÉi_node_Ëad”_üash
() {

267 
Ët
 
couÁ
 = 5;

268 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

269 
	`‹¡_muÉi_Ëad”_üash
(&
mut
 
şu¡”
)

270 
	}
}

272 #[
‹¡
]

273 
â
 
	$‹¡_muÉi_£rv”_Ëad”_üash
() {

274 
Ët
 
couÁ
 = 5;

275 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

276 
	`‹¡_muÉi_Ëad”_üash
(&
mut
 
şu¡”
)

277 
	}
}

279 #[
‹¡
]

280 
â
 
	$‹¡_muÉi_node_şu¡”_»¡¬t
() {

281 
Ët
 
couÁ
 = 5;

282 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

283 
	`‹¡_muÉi_şu¡”_»¡¬t
(&
mut
 
şu¡”
)

284 
	}
}

286 #[
‹¡
]

287 
â
 
	$‹¡_muÉi_£rv”_şu¡”_»¡¬t
() {

288 
Ët
 
couÁ
 = 5;

289 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

290 
	`‹¡_muÉi_şu¡”_»¡¬t
(&
mut
 
şu¡”
)

291 
	}
}

293 #[
‹¡
]

294 
â
 
	$‹¡_muÉi_node_lo¡_majÜ™y
() {

295 
Ët
 
mut
 
‹¡s
 = 
vec
![4, 5];

296 
couÁ
 
š
 
‹¡s
.
	`d¿š
(..) {

297 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

298 
	`‹¡_muÉi_lo¡_majÜ™y
(&
mut
 
şu¡”
, 
couÁ
)

300 
	}
}

302 #[
‹¡
]

303 
â
 
	$‹¡_muÉi_£rv”_lo¡_majÜ™y
() {

304 
Ët
 
mut
 
‹¡s
 = 
vec
![4, 5];

305 
couÁ
 
š
 
‹¡s
.
	`d¿š
(..) {

306 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

307 
	`‹¡_muÉi_lo¡_majÜ™y
(&
mut
 
şu¡”
, 
couÁ
)

309 
	}
}

311 #[
‹¡
]

312 
â
 
	$‹¡_muÉi_node_¿ndom_»¡¬t
() {

313 
Ët
 
couÁ
 = 5;

314 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

315 
	`‹¡_muÉi_¿ndom_»¡¬t
(&
mut
 
şu¡”
, 
couÁ
, 10);

316 
	}
}

318 #[
‹¡
]

319 
â
 
	$‹¡_muÉi_£rv”_¿ndom_»¡¬t
() {

320 
Ët
 
couÁ
 = 5;

321 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

322 
	`‹¡_muÉi_¿ndom_»¡¬t
(&
mut
 
şu¡”
, 
couÁ
, 10);

323 
	}
}

325 
â
 
	g‹¡_Ëad”_chªge_w™h_uncomm™‹d_log
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

326 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_–eùiÚ_timeout_ticks
 = 50;

328 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_th»shŞd
 = 1000;

330 
	gşu¡”
.
run
();

332 
¦“p_ms
(500);

335 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
Ãw_³”
(1, 1));

338 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

339 
RegiÚPack‘F‹r
::
Ãw
(1, 3).
msg_ty³
(
Mes§geTy³
::
MsgAµ’d
),

341 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

344 
i
 
	gš
 1..3 {

345 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_’gše
(
i
);

346 
mu¡_g‘_equ®
(&
’gše
, 
b
"k1", b"v1");

349 
Ët
 
	g’gše3
 = 
şu¡”
.
g‘_’gše
(3);

350 
mu¡_g‘_nÚe
(&
’gše3
, 
b
"k1");

356 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

357 
RegiÚPack‘F‹r
::
Ãw
(1, 2)

358 .
msg_ty³
(
Mes§geTy³
::
MsgAµ’d
)

359 .
dœeùiÚ
(
DœeùiÚ
::
Recv
)

360 .
®low
(1),

364 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

365 
RegiÚPack‘F‹r
::
Ãw
(1, 1)

366 .
msg_ty³
(
Mes§geTy³
::
MsgH—¹b—tRe¥Ú£
)

367 .
dœeùiÚ
(
DœeùiÚ
::
S’d
),

371 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

372 
RegiÚPack‘F‹r
::
Ãw
(1, 1)

373 .
msg_ty³
(
Mes§geTy³
::
MsgAµ’d
)

374 .
dœeùiÚ
(
DœeùiÚ
::
Recv
),

378 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

379 
RegiÚPack‘F‹r
::
Ãw
(1, 2)

380 .
msg_ty³
(
Mes§geTy³
::
MsgH—¹b—t
)

381 .
dœeùiÚ
(
DœeùiÚ
::
Recv
),

383 
	gdebug
!("putting k2");

384 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

387 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(1), 
b
"k2", b"v2");

389 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
ut
::
Ãw_³”
(2, 2));

391 
mu¡_g‘_nÚe
(&
şu¡”
.
g‘_’gše
(2), 
b
"k2");

393 
Ët
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
b
"");

394 
Ët
 
	g»qs
 = 
vec
![
Ãw_put_cmd
(
b
"k3", b"v3")];

395 
Ët
 
mut
 
	gput
 = 
Ãw_»que¡
(

396 
»giÚ
.
g‘_id
(),

397 
»giÚ
.
g‘_»giÚ_•och
().
şÚe
(),

398 
»qs
,

399 
çl£
,

401 
	gdebug
!("»que¡šg: {:?}", 
	gput
);

402 
	gput
.
mut_h—d”
().
£t_³”
(
Ãw_³”
(2, 2));

403 
	gşu¡”
.
ş—r_£nd_f‹rs
();

404 
Ët
 
	g»¥
 = 
şu¡”
.
ÿÎ_commªd
(
put
, 
Du¿tiÚ
::
äom_£cs
(5)).
unw¿p
();

405 
	gas£¹
!(!
	g»¥
.
g‘_h—d”
().
has_”rÜ
(), "{:?}",„esp);

407 
i
 
	gš
 1..4 {

408 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(
i
), 
b
"k2", b"v2");

409 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(
i
), 
b
"k3", b"v3");

413 #[
‹¡
]

414 
â
 
	$‹¡_node_Ëad”_chªge_w™h_uncomm™‹d_log
() {

415 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

416 
	`‹¡_Ëad”_chªge_w™h_uncomm™‹d_log
(&
mut
 
şu¡”
);

417 
	}
}

419 #[
‹¡
]

420 
â
 
	$‹¡_£rv”_Ëad”_chªge_w™h_uncomm™‹d_log
() {

421 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

422 
	`‹¡_Ëad”_chªge_w™h_uncomm™‹d_log
(&
mut
 
şu¡”
);

423 
	}
}

425 #[
‹¡
]

426 
â
 
	$‹¡_node_Ëad”_chªge_w™h_log_ov”Ïp
() {

427 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

428 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_–eùiÚ_timeout_ticks
 = 50;

430 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_th»shŞd
 = 1000;

432 
şu¡”
.
	`run
();

434 
	`¦“p_ms
(500);

437 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(1, 
	`Ãw_³”
(1, 1));

440 
şu¡”
.
	`add_£nd_f‹r
(
	`ClÚeF‹rFaùÜy
(

441 
RegiÚPack‘F‹r
::
	`Ãw
(1, 3).
	`msg_ty³
(
Mes§geTy³
::
MsgAµ’d
),

443 
şu¡”
.
	`mu¡_put
(
b
"k1", b"v1");

446 
i
 
š
 1..3 {

447 
Ët
 
’gše
 = 
şu¡”
.
	`g‘_’gše
(
i
);

448 
	`mu¡_g‘_equ®
(&
’gše
, 
b
"k1", b"v1");

451 
Ët
 
’gše3
 = 
şu¡”
.
	`g‘_’gše
(3);

452 
	`mu¡_g‘_nÚe
(&
’gše3
, 
b
"k1");

457 
şu¡”
.
	`add_£nd_f‹r
(
	`ClÚeF‹rFaùÜy
(

458 
RegiÚPack‘F‹r
::
	`Ãw
(1, 1)

459 .
	`msg_ty³
(
Mes§geTy³
::
MsgAµ’d
)

460 .
	`dœeùiÚ
(
DœeùiÚ
::
S’d
),

462 
Ët
 
put_msg
 = 
vec
![
	`Ãw_put_cmd
(
b
"k2", b"v2")];

463 
Ët
 
»giÚ
 = 
şu¡”
.
	`g‘_»giÚ
(
b
"");

464 
Ët
 
mut
 
put_»q
 = 
	`Ãw_»que¡
(

465 
»giÚ
.
	`g‘_id
(),

466 
»giÚ
.
	`g‘_»giÚ_•och
().
	`şÚe
(),

467 
put_msg
,

468 
çl£
,

470 
put_»q
.
	`mut_h—d”
().
	`£t_³”
(
	`Ãw_³”
(1, 1));

471 
Ët
 
ÿÎed
 = 
Arc
::
	`Ãw
(
AtomicBoŞ
::Ãw(
çl£
));

472 
Ët
 
ÿÎed_
 = 
ÿÎed
.
	`şÚe
();

473 
şu¡”


474 .
sim


475 .
	`¾
()

476 .
	`g‘_node_rou‹r
(1)

477 .
	`£nd_commªd
(
put_»q
, 
box
 
move
 |
»¥
: 
RaáCmdRe¥Ú£
| {

478 
ÿÎed_
.
	`¡Üe
(
Œue
, 
Ord”šg
::
SeqC¡
);

479 
as£¹
!(
»¥
.
	`g‘_h—d”
().
	`has_”rÜ
());

480 
as£¹
!(
»¥
.
	`g‘_h—d”
().
	`g‘_”rÜ
().
	`has_¡®e_commªd
());

482 .
	`unw¿p
();

486 
şu¡”
.
	`add_£nd_f‹r
(
	`ClÚeF‹rFaùÜy
(

487 
RegiÚPack‘F‹r
::
	`Ãw
(1, 1)

488 .
	`msg_ty³
(
Mes§geTy³
::
MsgH—¹b—t
)

489 .
	`dœeùiÚ
(
DœeùiÚ
::
S’d
),

492 
	`mu¡_g‘_nÚe
(&
şu¡”
.
	`g‘_’gše
(1), 
b
"k2");

495 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(1, 
	`Ãw_³”
(2, 2));

497 
	`mu¡_g‘_nÚe
(&
şu¡”
.
	`g‘_’gše
(2), 
b
"k2");

499 
şu¡”
.
	`ş—r_£nd_f‹rs
();

501 
_
 
š
 0..50 {

502 
	`¦“p_ms
(100);

503 
ÿÎed
.
	`lßd
(
Ord”šg
::
SeqC¡
) {

507 
·nic
!("callback has‚ot been called‡fter 5s.");

508 
	}
}

510 
â
 
	g‹¡_»ad_Ëad”_w™h_uÇµl›d_log
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

511 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_–eùiÚ_timeout_ticks
 = 50;

513 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_th»shŞd
 = 1000;

515 
	gşu¡”
.
run
();

517 
¦“p_ms
(500);

520 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
Ãw_³”
(1, 1));

526 
Ët
 (
k0
, 
v0
èğ(
b
"k0", 
	gb
"v0");

527 
	gşu¡”
.
mu¡_put
(
k0
, 
v0
);

529 
i
 
	gš
 1..4 {

530 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(
i
), 
k0
, 
v0
);

535 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

536 
RegiÚPack‘F‹r
::
Ãw
(1, 2)

537 .
msg_ty³
(
Mes§geTy³
::
MsgAµ’d
)

538 .
dœeùiÚ
(
DœeùiÚ
::
Recv
)

539 .
®low
(1),

544 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

545 
RegiÚPack‘F‹r
::
Ãw
(1, 2)

546 .
msg_ty³
(
Mes§geTy³
::
MsgAµ’d
)

547 .
dœeùiÚ
(
DœeùiÚ
::
S’d
),

552 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

553 
RegiÚPack‘F‹r
::
Ãw
(1, 2)

554 .
msg_ty³
(
Mes§geTy³
::
MsgH—¹b—t
)

555 .
dœeùiÚ
(
DœeùiÚ
::
Recv
),

558 
Ët
 (
k
, 
v
èğ(
b
"k", 
	gb
"v");

559 
	gşu¡”
.
mu¡_put
(
k
, 
v
);

562 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(1), 
k
, 
v
);

564 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
ut
::
Ãw_³”
(2, 2));

568 
mu¡_g‘_nÚe
(&
şu¡”
.
g‘_’gše
(2), 
k
);

572 
Ët
 
	g»q
 = 
g‘_w™h_timeout
(
şu¡”
, 
k
, 
çl£
, 
Du¿tiÚ
::
äom_£cs
(10)).
unw¿p
();

573 
	gas£¹
!(

574 
	g»q
.
g‘_h—d”
().
g‘_”rÜ
().
has_¡®e_commªd
(),

576 
	g»q


580 
	gşu¡”
.
ş—r_£nd_f‹rs
();

582 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
k
).
unw¿p
(), 
	gv
);

585 #[
‹¡
]

586 
â
 
	$‹¡_node_»ad_Ëad”_w™h_uÇµl›d_log
() {

587 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

588 
	`‹¡_»ad_Ëad”_w™h_uÇµl›d_log
(&
mut
 
şu¡”
);

589 
	}
}

591 #[
‹¡
]

592 
â
 
	$‹¡_£rv”_»ad_Ëad”_w™h_uÇµl›d_log
() {

593 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

594 
	`‹¡_»ad_Ëad”_w™h_uÇµl›d_log
(&
mut
 
şu¡”
);

595 
	}
}

597 
â
 
	gg‘_w™h_timeout
<
	gT
: 
SimuÏtÜ
>(

598 
şu¡”
: &
mut
 
Clu¡”
<
T
>,

599 
	gkey
: &[
u8
],

600 
	g»ad_quÜum
: 
boŞ
,

601 
	gtimeout
: 
Du¿tiÚ
,

602 è-> 
	gResuÉ
<
	gRaáCmdRe¥Ú£
> {

603 
Ët
 
mut
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
key
);

604 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

605 
Ët
 
	g»q
 = 
Ãw_»que¡
(

606 
»giÚ_id
,

607 
»giÚ
.
ke_»giÚ_•och
(),

608 
vec
![
Ãw_g‘_cmd
(
key
)],

609 
»ad_quÜum
,

611 
	gşu¡”
.
ÿÎ_commªd_Ú_Ëad”
(
»q
, 
timeout
)

614 
â
 
	g‹¡_»move_Ëad”_w™h_uncomm™‹d_log
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

615 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_–eùiÚ_timeout_ticks
 = 50;

617 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_th»shŞd
 = 1000;

619 
	gşu¡”
.
run
();

621 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

624 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
Ãw_³”
(1, 1));

627 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

628 
RegiÚPack‘F‹r
::
Ãw
(1, 2)

629 .
msg_ty³
(
Mes§geTy³
::
MsgAµ’d
)

630 .
dœeùiÚ
(
DœeùiÚ
::
Recv
),

633 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

634 
RegiÚPack‘F‹r
::
Ãw
(1, 2)

635 .
msg_ty³
(
Mes§geTy³
::
MsgReque¡VÙe
)

636 .
dœeùiÚ
(
DœeùiÚ
::
S’d
),

639 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

640 
	gpd_ş›Á
.
»move_³”
(1, 
Ãw_³”
(1, 1));

643 
¦“p_ms
(1000);

645 
Ët
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
b
"");

646 
Ët
 
	g»qs
 = 
vec
![
Ãw_put_cmd
(
b
"k3", b"v3")];

647 
Ët
 
mut
 
	gput
 = 
Ãw_»que¡
(

648 
»giÚ
.
g‘_id
(),

649 
»giÚ
.
g‘_»giÚ_•och
().
şÚe
(),

650 
»qs
,

651 
çl£
,

653 
	gdebug
!("»que¡šg: {:?}", 
	gput
);

654 
	gput
.
mut_h—d”
().
£t_³”
(
Ãw_³”
(1, 1));

655 
	gşu¡”
.
ş—r_£nd_f‹rs
();

656 
Ët
 
	g»¥
 = 
şu¡”
.
ÿÎ_commªd
(
put
, 
Du¿tiÚ
::
äom_£cs
(5)).
unw¿p
();

657 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
has_”rÜ
());

658 
	gas£¹
!(

659 
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_»giÚ_nÙ_found
(),

661 
	g»¥


665 #[
‹¡
]

666 
â
 
	$‹¡_node_»move_Ëad”_w™h_uncomm™‹d_log
() {

667 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 2);

668 
	`‹¡_»move_Ëad”_w™h_uncomm™‹d_log
(&
mut
 
şu¡”
);

669 
	}
}

671 #[
‹¡
]

672 
â
 
	$‹¡_£rv”_»move_Ëad”_w™h_uncomm™‹d_log
() {

673 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 2);

674 
	`‹¡_»move_Ëad”_w™h_uncomm™‹d_log
(&
mut
 
şu¡”
);

675 
	}
}

680 #[
‹¡
]

681 
â
 
	$‹¡_node_drİ³d_´İo§l
() {

682 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

683 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_–eùiÚ_timeout_ticks
 = 50;

685 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_th»shŞd
 = 1000;

687 
şu¡”
.
	`run
();

690 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(1, 
	`Ãw_³”
(1, 1));

693 
şu¡”
.
	`add_£nd_f‹r
(
	`ClÚeF‹rFaùÜy
(

694 
RegiÚPack‘F‹r
::
	`Ãw
(1, 3).
	`msg_ty³
(
Mes§geTy³
::
MsgAµ’d
),

696 
şu¡”
.
	`mu¡_put
(
b
"k1", b"v1");

699 
i
 
š
 1..3 {

700 
Ët
 
’gše
 = 
şu¡”
.
	`g‘_’gše
(
i
);

701 
	`mu¡_g‘_equ®
(&
’gše
, 
b
"k1", b"v1");

704 
Ët
 
’gše3
 = 
şu¡”
.
	`g‘_’gše
(3);

705 
	`mu¡_g‘_nÚe
(&
’gše3
, 
b
"k1");

707 
Ët
 
put_msg
 = 
vec
![
	`Ãw_put_cmd
(
b
"k2", b"v2")];

708 
Ët
 
»giÚ
 = 
şu¡”
.
	`g‘_»giÚ
(
b
"");

709 
Ët
 
mut
 
put_»q
 = 
	`Ãw_»que¡
(

710 
»giÚ
.
	`g‘_id
(),

711 
»giÚ
.
	`g‘_»giÚ_•och
().
	`şÚe
(),

712 
put_msg
,

713 
çl£
,

715 
put_»q
.
	`mut_h—d”
().
	`£t_³”
(
	`Ãw_³”
(1, 1));

719 
şu¡”
.
	`Œªsãr_Ëad”
(1, 
	`Ãw_³”
(3, 3));

721 
	`Ët
 (
tx
, 
rx
èğ
mpsc
::
	`chªÃl
();

722 
şu¡”


723 .
sim


724 .
	`¾
()

725 .
	`g‘_node_rou‹r
(1)

726 .
	`£nd_commªd
(
put_»q
, 
box
 
move
 |
»¥
: 
RaáCmdRe¥Ú£
| {

727 
Ët
 
_
 = 
tx
.
	`£nd
(
»¥
);

729 .
	`unw¿p
();

732 
rx
.
	`»cv_timeout
(
Du¿tiÚ
::
	`äom_£cs
(5))

733 .
	`ex³ù
("callback should have been called with in 5s.");

734 
	}
}

736 
â
 
	g‹¡_cÚsi¡’cy_check
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

737 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_–eùiÚ_timeout_ticks
 = 50;

739 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_th»shŞd
 = 1000;

740 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	gcÚsi¡’cy_check_š‹rv®
 = 
R—dabËDu¿tiÚ
::
£cs
(1);

742 
	gşu¡”
.
run
();

744 
i
 
	gš
 0..300 {

745 
	gşu¡”
.
mu¡_put
(

746 
fÜm©
!("k{:06}", 
i
).
as_by‹s
(),

747 
fÜm©
!("k{:06}", 
i
).
as_by‹s
(),

749 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(10));

753 #[
‹¡
]

754 
â
 
	$‹¡_node_cÚsi¡’cy_check
() {

755 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 2);

756 
	`‹¡_cÚsi¡’cy_check
(&
mut
 
şu¡”
);

757 
	}
}

759 
â
 
	g‹¡_b©ch_wr™e
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

760 
şu¡”
.
run
();

761 
Ët
 
	gr
 = 
şu¡”
.
g‘_»giÚ
(
b
"");

762 
	gşu¡”
.
mu¡_¥l™
(&
r
, 
b
"k3");

764 
Ët
 
	gr
 = 
şu¡”
.
g‘_»giÚ
(
b
"");

766 
Ët
 
	g»q
 = 
Ãw_»que¡
(

767 
r
.
g‘_id
(),

768 
r
.
g‘_»giÚ_•och
().
şÚe
(),

769 
vec
![
Ãw_put_cmd
(
b
"k1", b"v1"),‚ew_put_cmd(b"k2", b"v2")],

770 
çl£
,

772 
Ët
 
	g»¥
 = 
şu¡”


773 .
ÿÎ_commªd_Ú_Ëad”
(
»q
, 
Du¿tiÚ
::
äom_£cs
(3))

774 .
unw¿p
();

775 
	gas£¹
!(!
	g»¥
.
g‘_h—d”
().
has_”rÜ
());

776 
	gas£¹_eq
!(
	gşu¡”
.
mu¡_g‘
(
b
"k1"), 
Some
(b"v1".
to_vec
()));

777 
	gas£¹_eq
!(
	gşu¡”
.
mu¡_g‘
(
b
"k2"), 
Some
(b"v2".
to_vec
()));

779 
Ët
 
	g»q
 = 
Ãw_»que¡
(

780 
r
.
g‘_id
(),

781 
r
.
g‘_»giÚ_•och
().
şÚe
(),

782 
vec
![
Ãw_put_cmd
(
b
"k1", b"v3"),‚ew_put_cmd(b"k3", b"v3")],

783 
çl£
,

785 
Ët
 
	g»¥
 = 
şu¡”


786 .
ÿÎ_commªd_Ú_Ëad”
(
»q
, 
Du¿tiÚ
::
äom_£cs
(3))

787 .
unw¿p
();

788 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
has_”rÜ
());

789 
	gas£¹_eq
!(
	gşu¡”
.
mu¡_g‘
(
b
"k1"), 
Some
(b"v1".
to_vec
()));

790 
	gas£¹_eq
!(
	gşu¡”
.
mu¡_g‘
(
b
"k3"), 
	gNÚe
);

793 #[
‹¡
]

794 
â
 
	$‹¡_£rv”_b©ch_wr™e
() {

795 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

796 
	`‹¡_b©ch_wr™e
(&
mut
 
şu¡”
);

797 
	}
}

	@tests/raftstore_cases/test_region_heartbeat.rs

1 
u£
 
	g¡d
::
th»ad
::
¦“p
;

2 
u£
 
	g¡d
::
sync
::
mpsc
;

3 
u£
 
	g¡d
::
time
::{
Du¿tiÚ
, 
	gIn¡ªt
};

5 
u£
 
	gtikv
::
ut
::
HªdyRwLock
;

6 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

8 
u£
 
	gsu³r
::
ut
;

9 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

10 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

11 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

12 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

13 
u£
 
	gsu³r
::
ut
::*;

15 
â
 
	gwa™_down_³”s
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
Clu¡”
<
T
>, 
	gcouÁ
: 
u64
, 
	g³”
: 
O±iÚ
<u64>) {

16 
Ët
 
mut
 
³”s
 = 
şu¡”
.
g‘_down_³”s
();

17 
_
 
	gš
 1..1000 {

18 
	g³”s
.
Ën
(è=ğ
couÁ
 
as
 
usize
 && 
³”
.
as_»f
().
m­_Ü
(
Œue
, |
p
| 
³”s
.
cÚšs_key
(p)) {

21 
¦“p
(
Du¿tiÚ
::
äom_mlis
(10));

22 
	g³”s
 = 
şu¡”
.
g‘_down_³”s
();

24 
	g·nic
!(

26 
	g³”s
,

27 
	gcouÁ
,

28 
	g³”


32 
â
 
	g‹¡_down_³”s
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

33 
şu¡”
.
cfg
.
¿á_¡Üe
.
max_³”_down_du¿tiÚ
 = 
R—dabËDu¿tiÚ
::
£cs
(1);

34 
	gşu¡”
.
run
();

37 
Ën
 
	gš
 1..3 {

38 
Ët
 
	gid
 = 
Ën
;

39 
	gşu¡”
.
¡İ_node
(
id
);

40 
wa™_down_³”s
(
şu¡”
, 
Ën
, 
Some
(
id
));

44 
	gşu¡”
.
run_node
(1);

45 
	gşu¡”
.
run_node
(2);

46 
wa™_down_³”s
(
şu¡”
, 0, 
NÚe
);

48 
	gşu¡”
.
¡İ_node
(1);

50 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

54 
	gut
::
¦“p_ms
(1000);

56 
wa™_down_³”s
(
şu¡”
, 1, 
Some
(1));

57 
Ët
 
	gdown_£cs
 = 
şu¡”
.
g‘_down_³”s
()[&1].
g‘_down_£cÚds
();

58 
Ët
 
	gtim”
 = 
In¡ªt
::
now
();

59 
Ët
 
	gËad”
 = 
şu¡”
.
Ëad”_of_»giÚ
(1).
unw¿p
();

60 
Ët
 
	gÃw_Ëad”
 = 
Ëad”
.
g‘_id
() == 2 {

61 
ut
::
Ãw_³”
(3, 3)

63 
ut
::
Ãw_³”
(2, 2)

66 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
Ãw_Ëad”
);

68 
wa™_down_³”s
(
şu¡”
, 0, 
NÚe
);

69 
wa™_down_³”s
(
şu¡”
, 1, 
Some
(1));

70 
	gas£¹
!(

71 
	gşu¡”
.
g‘_down_³”s
()[&1].
g‘_down_£cÚds
(è< 
	gdown_£cs
 + 
	gtim”
.
–­£d
().
as_£cs
()

75 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
Ëad”
);

76 
wa™_down_³”s
(
şu¡”
, 0, 
NÚe
);

77 
wa™_down_³”s
(
şu¡”
, 1, 
Some
(1));

78 
	gas£¹
!(
	gşu¡”
.
g‘_down_³”s
()[&1].
g‘_down_£cÚds
(è< 
	gtim”
.
–­£d
().
as_£cs
() + 1);

81 #[
‹¡
]

82 
â
 
	$‹¡_node_down_³”s
() {

83 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 5);

84 
	`‹¡_down_³”s
(&
mut
 
şu¡”
);

85 
	}
}

87 #[
‹¡
]

88 
â
 
	$‹¡_£rv”_down_³”s
() {

89 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 5);

90 
	`‹¡_down_³”s
(&
mut
 
şu¡”
);

91 
	}
}

93 
â
 
	g‹¡_³ndšg_³”s
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

94 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

96 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

98 
Ët
 
	g»giÚ_id
 = 
şu¡”
.
run_cÚf_chªge
();

100 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

102 
Ët
 (
tx
, 
_
èğ
mpsc
::
chªÃl
();

103 
	gşu¡”


104 .
	gsim


105 .
wl
()

106 .
add_»cv_f‹r
(2, 
box
 
DrİSÇpshÙF‹r
::
Ãw
(
tx
));

108 
	gpd_ş›Á
.
mu¡_add_³”
(
»giÚ_id
, 
Ãw_³”
(2, 2));

110 
Ët
 
mut
 
	gŒ›d_times
 = 0;

111 
	gloİ
 {

112 
	gŒ›d_times
 += 1;

113 
	gŒ›d_times
 > 100 {

114 
	g·nic
!("ÿn'ˆg‘…’dšg…“¸aá” {}r›s.", 
	gŒ›d_times
);

116 
Ët
 
	g³ndšg_³”s
 = 
şu¡”
.
pd_ş›Á
.
g‘_³ndšg_³”s
();

117 
	g³ndšg_³”s
.
is_em±y
() {

118 
¦“p
(
Du¿tiÚ
::
äom_mlis
(100));

120 
	gas£¹_eq
!(
	g³ndšg_³”s
[&2], 
Ãw_³”
(2, 2));

125 
	gşu¡”
.
	gsim
.
wl
().
ş—r_»cv_f‹rs
(2);

126 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

128 
	gŒ›d_times
 = 0;

129 
	gloİ
 {

130 
	gŒ›d_times
 += 1;

131 
Ët
 
	g³ndšg_³”s
 = 
şu¡”
.
pd_ş›Á
.
g‘_³ndšg_³”s
();

132 !
	g³ndšg_³”s
.
is_em±y
() {

133 
¦“p
(
Du¿tiÚ
::
äom_mlis
(100));

137 
	gŒ›d_times
 > 100 {

138 
	g·nic
!(

140 
	g³ndšg_³”s
,

141 
	gŒ›d_times


147 #[
‹¡
]

148 
â
 
	$‹¡_node_³ndšg_³”s
() {

149 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

150 
	`‹¡_³ndšg_³”s
(&
mut
 
şu¡”
);

151 
	}
}

153 #[
‹¡
]

154 
â
 
	$‹¡_£rv”_³ndšg_³”s
() {

155 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

156 
	`‹¡_³ndšg_³”s
(&
mut
 
şu¡”
);

157 
	}
}

	@tests/raftstore_cases/test_service.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	gtikv
::
ut
::
HªdyRwLock
;

17 
u£
 
	gtikv
::
¡Üage
::{
Key
, 
	gCF_DEFAULT
, 
	gCF_LOCK
, 
	gCF_RAFT
, 
	gCF_WRITE
};

18 
u£
 
	gtikv
::
¡Üage
::
mvcc
::{
Lock
, 
	gLockTy³
};

19 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::{
keys
, 
	gMubË
, 
	gP“kabË
};

21 
u£
 
	gkv´Ùo
::
kv½ıb
::*;

22 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::*;

23 
u£
 
	gkv´Ùo
::
cİroûssÜ
::*;

24 
u£
 
	gkv´Ùo
::{
debugpb
, 
	g”aápb
, 
	gm‘­b
, 
	g¿á_£rv”pb
};

25 
u£
 
	gkv´Ùo
::
tikvpb_g½c
::
TikvCl›Á
;

26 
u£
 
	gkv´Ùo
::
debugpb_g½c
::
DebugCl›Á
;

27 
u£
 
	grocksdb
::
Wr™abË
;

28 
u£
 
	gfutu»s
::{
futu»
, 
	gFutu»
, 
	gSšk
, 
	gSŒ—m
};

29 
u£
 
	gg½c
::{
ChªÃlBud”
, 
	gEnvœÚm’t
, 
	gE¼Ü
, 
	gRpcStusCode
};

31 
u£
 
	gsu³r
::
£rv”
::*;

32 
u£
 
	gsu³r
::
şu¡”
::
Clu¡”
;

34 
â
 
mu¡_Ãw_şu¡”
(è-> (
	gClu¡”
<
	gS”v”Clu¡”
>, 
	gm‘­b
::
P“r
, 
	gCÚ‹xt
) {

35 
Ët
 
	gcouÁ
 = 1;

36 
Ët
 
mut
 
	gşu¡”
 = 
Ãw_£rv”_şu¡”
(0, 
couÁ
);

37 
	gşu¡”
.
run
();

39 
Ët
 
	g»giÚ_id
 = 1;

40 
Ët
 
	gËad”
 = 
şu¡”
.
Ëad”_of_»giÚ
(
»giÚ_id
).
unw¿p
();

41 
Ët
 
	g•och
 = 
şu¡”
.
g‘_»giÚ_•och
(
»giÚ_id
);

42 
Ët
 
mut
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

43 
	gùx
.
£t_»giÚ_id
(
»giÚ_id
);

44 
	gùx
.
£t_³”
(
Ëad”
.
şÚe
());

45 
	gùx
.
£t_»giÚ_•och
(
•och
);

47 (
	gşu¡”
, 
	gËad”
, 
	gùx
)

50 
â
 
mu¡_Ãw_şu¡”_ªd_kv_ş›Á
(è-> (
	gClu¡”
<
	gS”v”Clu¡”
>, 
	gTikvCl›Á
, 
	gCÚ‹xt
) {

51 
Ët
 (
şu¡”
, 
Ëad”
, 
ùx
èğ
mu¡_Ãw_şu¡”
();

53 
Ët
 
	g’v
 = 
Arc
::
Ãw
(
EnvœÚm’t
::new(1));

54 
Ët
 
	gchªÃl
 =

55 
ChªÃlBud”
::
Ãw
(
’v
).
cÚÃù
(
şu¡”
.
sim
.
¾
().
g‘_addr
(
Ëad”
.
g‘_¡Üe_id
()));

56 
Ët
 
	gş›Á
 = 
TikvCl›Á
::
Ãw
(
chªÃl
);

58 (
	gşu¡”
, 
	gş›Á
, 
	gùx
)

61 #[
‹¡
]

62 
â
 
	$‹¡_¿wkv
() {

63 
	`Ët
 (
_şu¡”
, 
ş›Á
, 
ùx
èğ
	`mu¡_Ãw_şu¡”_ªd_kv_ş›Á
();

64 
	`Ët
 (
k
, 
v
èğ(
b
"key".
	`to_vec
(), b"value".to_vec());

67 
Ët
 
mut
 
put_»q
 = 
RawPutReque¡
::
	`Ãw
();

68 
put_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

69 
put_»q
.
key
 = 
k
.
	`şÚe
();

70 
put_»q
.
v®ue
 = 
v
.
	`şÚe
();

71 
Ët
 
put_»¥
 = 
ş›Á
.
	`¿w_put
(
put_»q
).
	`unw¿p
();

72 
as£¹
!(!
put_»¥
.
	`has_»giÚ_”rÜ
());

73 
as£¹
!(
put_»¥
.
”rÜ
.
	`is_em±y
());

76 
Ët
 
mut
 
g‘_»q
 = 
RawG‘Reque¡
::
	`Ãw
();

77 
g‘_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

78 
g‘_»q
.
key
 = 
k
.
	`şÚe
();

79 
Ët
 
g‘_»¥
 = 
ş›Á
.
	`¿w_g‘
(
g‘_»q
).
	`unw¿p
();

80 
as£¹
!(!
g‘_»¥
.
	`has_»giÚ_”rÜ
());

81 
as£¹
!(
g‘_»¥
.
”rÜ
.
	`is_em±y
());

82 
as£¹_eq
!(
g‘_»¥
.
v®ue
, 
v
);

85 
Ët
 
mut
 
sÿn_»q
 = 
RawSÿnReque¡
::
	`Ãw
();

86 
sÿn_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

87 
sÿn_»q
.
¡¬t_key
 = 
k
.
	`şÚe
();

88 
sÿn_»q
.
lim™
 = 1;

89 
Ët
 
sÿn_»¥
 = 
ş›Á
.
	`¿w_sÿn
(
sÿn_»q
).
	`unw¿p
();

90 
as£¹
!(!
sÿn_»¥
.
	`has_»giÚ_”rÜ
());

91 
as£¹_eq
!(
sÿn_»¥
.
kvs
.
	`Ën
(), 1);

92 
kv
 
š
 
sÿn_»¥
.
kvs
.
	`što_™”
() {

93 
as£¹
!(!
kv
.
	`has_”rÜ
());

94 
as£¹_eq
!(
kv
.
key
, 
k
);

95 
as£¹_eq
!(
kv
.
v®ue
, 
v
);

99 
Ët
 
mut
 
d–‘e_»q
 = 
RawD–‘eReque¡
::
	`Ãw
();

100 
d–‘e_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

101 
d–‘e_»q
.
key
 = 
k
.
	`şÚe
();

102 
Ët
 
d–‘e_»¥
 = 
ş›Á
.
	`¿w_d–‘e
(
d–‘e_»q
).
	`unw¿p
();

103 
as£¹
!(!
d–‘e_»¥
.
	`has_»giÚ_”rÜ
());

104 
as£¹
!(
d–‘e_»¥
.
”rÜ
.
	`is_em±y
());

105 
	}
}

107 
â
 
mu¡_kv_´ewr™e
(
ş›Á
: &
TikvCl›Á
, 
ùx
: 
CÚ‹xt
, 
muts
: 
Vec
<
MutiÚ
>, 
pk
: Vec<
u8
>, 
ts
: 
u64
) {

108 
Ët
 
mut
 
´ewr™e_»q
 = 
P»wr™eReque¡
::
Ãw
();

109 
	g´ewr™e_»q
.
£t_cÚ‹xt
(
ùx
);

110 
	g´ewr™e_»q
.
£t_mutiÚs
(
muts
.
što_™”
().
cŞËù
());

111 
	g´ewr™e_»q
.
	g´im¬y_lock
 = 
pk
;

112 
	g´ewr™e_»q
.
	g¡¬t_v”siÚ
 = 
ts
;

113 
	g´ewr™e_»q
.
	glock_‰l
 = 
´ewr™e_»q
.
¡¬t_v”siÚ
 + 1;

114 
Ët
 
	g´ewr™e_»¥
 = 
ş›Á
.
kv_´ewr™e
(
´ewr™e_»q
).
unw¿p
();

115 
	gas£¹
!(

116 !
	g´ewr™e_»¥
.
has_»giÚ_”rÜ
(),

118 
	g´ewr™e_»¥
.
g‘_»giÚ_”rÜ
()

120 
	gas£¹
!(

121 
	g´ewr™e_»¥
.
	g”rÜs
.
is_em±y
(),

123 
	g´ewr™e_»¥
.
g‘_”rÜs
()

127 
â
 
mu¡_kv_comm™
(

128 
ş›Á
: &
TikvCl›Á
,

129 
ùx
: 
CÚ‹xt
,

130 
keys
: 
Vec
<Vec<
u8
>>,

131 
¡¬t_ts
: 
u64
,

132 
comm™_ts
: 
u64
,

134 
Ët
 
mut
 
	gcomm™_»q
 = 
Comm™Reque¡
::
Ãw
();

135 
	gcomm™_»q
.
£t_cÚ‹xt
(
ùx
);

136 
	gcomm™_»q
.
	g¡¬t_v”siÚ
 = 
¡¬t_ts
;

137 
	gcomm™_»q
.
£t_keys
(
keys
.
što_™”
().
cŞËù
());

138 
	gcomm™_»q
.
	gcomm™_v”siÚ
 = 
comm™_ts
;

139 
Ët
 
	gcomm™_»¥
 = 
ş›Á
.
kv_comm™
(
comm™_»q
).
unw¿p
();

140 
	gas£¹
!(

141 !
	gcomm™_»¥
.
has_»giÚ_”rÜ
(),

143 
	gcomm™_»¥
.
g‘_»giÚ_”rÜ
()

145 
	gas£¹
!(!
	gcomm™_»¥
.
has_”rÜ
(), "{:?}", comm™_»¥.
g‘_”rÜ
());

148 #[
‹¡
]

149 
â
 
	$‹¡_mvcc_basic
() {

150 
	`Ët
 (
_şu¡”
, 
ş›Á
, 
ùx
èğ
	`mu¡_Ãw_şu¡”_ªd_kv_ş›Á
();

151 
	`Ët
 (
k
, 
v
èğ(
b
"key".
	`to_vec
(), b"value".to_vec());

153 
Ët
 
mut
 
ts
 = 0;

156 
ts
 += 1;

157 
Ët
 
´ewr™e_¡¬t_v”siÚ
 = 
ts
;

158 
Ët
 
mut
 
mutiÚ
 = 
MutiÚ
::
	`Ãw
();

159 
mutiÚ
.
İ
 = 
Op
::
Put
;

160 
mutiÚ
.
key
 = 
k
.
	`şÚe
();

161 
mutiÚ
.
v®ue
 = 
v
.
	`şÚe
();

162 
	`mu¡_kv_´ewr™e
(

163 &
ş›Á
,

164 
ùx
.
	`şÚe
(),

165 
vec
![
mutiÚ
],

166 
k
.
	`şÚe
(),

167 
´ewr™e_¡¬t_v”siÚ
,

171 
ts
 += 1;

172 
Ët
 
comm™_v”siÚ
 = 
ts
;

173 
	`mu¡_kv_comm™
(

174 &
ş›Á
,

175 
ùx
.
	`şÚe
(),

176 
vec
![
k
.
	`şÚe
()],

177 
´ewr™e_¡¬t_v”siÚ
,

178 
comm™_v”siÚ
,

182 
ts
 += 1;

183 
Ët
 
g‘_v”siÚ
 = 
ts
;

184 
Ët
 
mut
 
g‘_»q
 = 
G‘Reque¡
::
	`Ãw
();

185 
g‘_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

186 
g‘_»q
.
key
 = 
k
.
	`şÚe
();

187 
g‘_»q
.
v”siÚ
 = 
g‘_v”siÚ
;

188 
Ët
 
g‘_»¥
 = 
ş›Á
.
	`kv_g‘
(
g‘_»q
).
	`unw¿p
();

189 
as£¹
!(!
g‘_»¥
.
	`has_»giÚ_”rÜ
());

190 
as£¹
!(!
g‘_»¥
.
	`has_”rÜ
());

191 
as£¹_eq
!(
g‘_»¥
.
v®ue
, 
v
);

194 
ts
 += 1;

195 
Ët
 
sÿn_v”siÚ
 = 
ts
;

196 
Ët
 
mut
 
sÿn_»q
 = 
SÿnReque¡
::
	`Ãw
();

197 
sÿn_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

198 
sÿn_»q
.
¡¬t_key
 = 
k
.
	`şÚe
();

199 
sÿn_»q
.
lim™
 = 1;

200 
sÿn_»q
.
v”siÚ
 = 
sÿn_v”siÚ
;

201 
Ët
 
sÿn_»¥
 = 
ş›Á
.
	`kv_sÿn
(
sÿn_»q
).
	`unw¿p
();

202 
as£¹
!(!
sÿn_»¥
.
	`has_»giÚ_”rÜ
());

203 
as£¹_eq
!(
sÿn_»¥
.
·œs
.
	`Ën
(), 1);

204 
kv
 
š
 
sÿn_»¥
.
·œs
.
	`što_™”
() {

205 
as£¹
!(!
kv
.
	`has_”rÜ
());

206 
as£¹_eq
!(
kv
.
key
, 
k
);

207 
as£¹_eq
!(
kv
.
v®ue
, 
v
);

211 
ts
 += 1;

212 
Ët
 
b©ch_g‘_v”siÚ
 = 
ts
;

213 
Ët
 
mut
 
b©ch_g‘_»q
 = 
B©chG‘Reque¡
::
	`Ãw
();

214 
b©ch_g‘_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

215 
b©ch_g‘_»q
.
	`£t_keys
(
vec
![
k
.
	`şÚe
()].
	`što_™”
().
	`cŞËù
());

216 
b©ch_g‘_»q
.
v”siÚ
 = 
b©ch_g‘_v”siÚ
;

217 
Ët
 
b©ch_g‘_»¥
 = 
ş›Á
.
	`kv_b©ch_g‘
(
b©ch_g‘_»q
).
	`unw¿p
();

218 
as£¹_eq
!(
b©ch_g‘_»¥
.
·œs
.
	`Ën
(), 1);

219 
kv
 
š
 
b©ch_g‘_»¥
.
·œs
.
	`što_™”
() {

220 
as£¹
!(!
kv
.
	`has_”rÜ
());

221 
as£¹_eq
!(
kv
.
key
, 
k
);

222 
as£¹_eq
!(
kv
.
v®ue
, 
v
);

224 
	}
}

226 #[
‹¡
]

227 
â
 
	$‹¡_mvcc_rŞlback_ªd_ş—nup
() {

228 
	`Ët
 (
_şu¡”
, 
ş›Á
, 
ùx
èğ
	`mu¡_Ãw_şu¡”_ªd_kv_ş›Á
();

229 
	`Ët
 (
k
, 
v
èğ(
b
"key".
	`to_vec
(), b"value".to_vec());

231 
Ët
 
mut
 
ts
 = 0;

234 
ts
 += 1;

235 
Ët
 
´ewr™e_¡¬t_v”siÚ
 = 
ts
;

236 
Ët
 
mut
 
mutiÚ
 = 
MutiÚ
::
	`Ãw
();

237 
mutiÚ
.
İ
 = 
Op
::
Put
;

238 
mutiÚ
.
key
 = 
k
.
	`şÚe
();

239 
mutiÚ
.
v®ue
 = 
v
.
	`şÚe
();

240 
	`mu¡_kv_´ewr™e
(

241 &
ş›Á
,

242 
ùx
.
	`şÚe
(),

243 
vec
![
mutiÚ
],

244 
k
.
	`şÚe
(),

245 
´ewr™e_¡¬t_v”siÚ
,

249 
ts
 += 1;

250 
Ët
 
comm™_v”siÚ
 = 
ts
;

251 
	`mu¡_kv_comm™
(

252 &
ş›Á
,

253 
ùx
.
	`şÚe
(),

254 
vec
![
k
.
	`şÚe
()],

255 
´ewr™e_¡¬t_v”siÚ
,

256 
comm™_v”siÚ
,

260 
ts
 += 1;

261 
Ët
 
´ewr™e_¡¬t_v”siÚ2
 = 
ts
;

262 
	`Ët
 (
k2
, 
v2
èğ(
b
"key2".
	`to_vec
(), b"value2".to_vec());

263 
Ët
 
mut
 
mut_´i
 = 
MutiÚ
::
	`Ãw
();

264 
mut_´i
.
İ
 = 
Op
::
Put
;

265 
mut_´i
.
key
 = 
k2
.
	`şÚe
();

266 
mut_´i
.
v®ue
 = 
v2
.
	`şÚe
();

267 
Ët
 
mut
 
mut_£c
 = 
MutiÚ
::
	`Ãw
();

268 
mut_£c
.
İ
 = 
Op
::
Put
;

269 
mut_£c
.
key
 = 
k
.
	`şÚe
();

270 
mut_£c
.
v®ue
 = 
b
"foo".
	`to_vec
();

271 
	`mu¡_kv_´ewr™e
(

272 &
ş›Á
,

273 
ùx
.
	`şÚe
(),

274 
vec
![
mut_´i
, 
mut_£c
],

275 
k2
.
	`şÚe
(),

276 
´ewr™e_¡¬t_v”siÚ2
,

280 
ts
 += 1;

281 
Ët
 
sÿn_lock_max_v”siÚ
 = 
ts
;

282 
Ët
 
mut
 
sÿn_lock_»q
 = 
SÿnLockReque¡
::
	`Ãw
();

283 
sÿn_lock_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

284 
sÿn_lock_»q
.
max_v”siÚ
 = 
sÿn_lock_max_v”siÚ
;

285 
Ët
 
sÿn_lock_»¥
 = 
ş›Á
.
	`kv_sÿn_lock
(
sÿn_lock_»q
).
	`unw¿p
();

286 
as£¹
!(!
sÿn_lock_»¥
.
	`has_»giÚ_”rÜ
());

287 
as£¹_eq
!(
sÿn_lock_»¥
.
locks
.
	`Ën
(), 2);

288 
lock
, 
key
è
š
 
sÿn_lock_»¥


289 .
locks


290 .
	`što_™”
()

291 .
	`z
(
vec
![
k
.
	`şÚe
(), 
k2
.clone()])

293 
as£¹_eq
!(
lock
.
´im¬y_lock
, 
k2
);

294 
as£¹_eq
!(
lock
.
key
, key);

295 
as£¹_eq
!(
lock
.
lock_v”siÚ
, 
´ewr™e_¡¬t_v”siÚ2
);

299 
Ët
 
rŞlback_¡¬t_v”siÚ
 = 
´ewr™e_¡¬t_v”siÚ2
;

300 
Ët
 
mut
 
rŞlback_»q
 = 
B©chRŞlbackReque¡
::
	`Ãw
();

301 
rŞlback_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

302 
rŞlback_»q
.
¡¬t_v”siÚ
 = 
rŞlback_¡¬t_v”siÚ
;

303 
rŞlback_»q
.
	`£t_keys
(
vec
![
k2
.
	`şÚe
()].
	`što_™”
().
	`cŞËù
());

304 
Ët
 
rŞlback_»¥
 = 
ş›Á
.
	`kv_b©ch_rŞlback
(
rŞlback_»q
.
	`şÚe
()).
	`unw¿p
();

305 
as£¹
!(!
rŞlback_»¥
.
	`has_»giÚ_”rÜ
());

306 
as£¹
!(!
rŞlback_»¥
.
	`has_”rÜ
());

307 
rŞlback_»q
.
	`£t_keys
(
vec
![
k
.
	`şÚe
()].
	`što_™”
().
	`cŞËù
());

308 
Ët
 
rŞlback_»¥2
 = 
ş›Á
.
	`kv_b©ch_rŞlback
(
rŞlback_»q
.
	`şÚe
()).
	`unw¿p
();

309 
as£¹
!(!
rŞlback_»¥2
.
	`has_»giÚ_”rÜ
());

310 
as£¹
!(!
rŞlback_»¥2
.
	`has_”rÜ
());

313 
Ët
 
ş—nup_¡¬t_v”siÚ
 = 
´ewr™e_¡¬t_v”siÚ2
;

314 
Ët
 
mut
 
ş—nup_»q
 = 
CËªupReque¡
::
	`Ãw
();

315 
ş—nup_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

316 
ş—nup_»q
.
¡¬t_v”siÚ
 = 
ş—nup_¡¬t_v”siÚ
;

317 
ş—nup_»q
.
	`£t_key
(
k2
.
	`şÚe
());

318 
Ët
 
ş—nup_»¥
 = 
ş›Á
.
	`kv_ş—nup
(
ş—nup_»q
).
	`unw¿p
();

319 
as£¹
!(!
ş—nup_»¥
.
	`has_»giÚ_”rÜ
());

320 
as£¹
!(!
ş—nup_»¥
.
	`has_”rÜ
());

323 
ts
 += 1;

324 
Ët
 
sÿn_lock_max_v”siÚ2
 = 
ts
;

325 
Ët
 
mut
 
sÿn_lock_»q
 = 
SÿnLockReque¡
::
	`Ãw
();

326 
sÿn_lock_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

327 
sÿn_lock_»q
.
max_v”siÚ
 = 
sÿn_lock_max_v”siÚ2
;

328 
Ët
 
sÿn_lock_»¥
 = 
ş›Á
.
	`kv_sÿn_lock
(
sÿn_lock_»q
).
	`unw¿p
();

329 
as£¹
!(!
sÿn_lock_»¥
.
	`has_»giÚ_”rÜ
());

330 
as£¹_eq
!(
sÿn_lock_»¥
.
locks
.
	`Ën
(), 0);

331 
	}
}

333 #[
‹¡
]

334 
â
 
	$‹¡_mvcc_»sŞve_lock_gc_ªd_d–‘e
() {

335 
u£
 
kv´Ùo
::
kv½ıb
::*;

336 
u£
 
´Ùobuf
;

337 
	`Ët
 (
_şu¡”
, 
ş›Á
, 
ùx
èğ
	`mu¡_Ãw_şu¡”_ªd_kv_ş›Á
();

338 
	`Ët
 (
k
, 
v
èğ(
b
"key".
	`to_vec
(), b"value".to_vec());

340 
Ët
 
mut
 
ts
 = 0;

343 
ts
 += 1;

344 
Ët
 
´ewr™e_¡¬t_v”siÚ
 = 
ts
;

345 
Ët
 
mut
 
mutiÚ
 = 
MutiÚ
::
	`Ãw
();

346 
mutiÚ
.
İ
 = 
Op
::
Put
;

347 
mutiÚ
.
key
 = 
k
.
	`şÚe
();

348 
mutiÚ
.
v®ue
 = 
v
.
	`şÚe
();

349 
	`mu¡_kv_´ewr™e
(

350 &
ş›Á
,

351 
ùx
.
	`şÚe
(),

352 
vec
![
mutiÚ
],

353 
k
.
	`şÚe
(),

354 
´ewr™e_¡¬t_v”siÚ
,

358 
ts
 += 1;

359 
Ët
 
comm™_v”siÚ
 = 
ts
;

360 
	`mu¡_kv_comm™
(

361 &
ş›Á
,

362 
ùx
.
	`şÚe
(),

363 
vec
![
k
.
	`şÚe
()],

364 
´ewr™e_¡¬t_v”siÚ
,

365 
comm™_v”siÚ
,

369 
ts
 += 1;

370 
Ët
 
´ewr™e_¡¬t_v”siÚ2
 = 
ts
;

371 
	`Ët
 (
k2
, 
v2
èğ(
b
"key2".
	`to_vec
(), b"value2".to_vec());

372 
Ët
 
Ãw_v
 = 
b
"Ãw v®ue".
	`to_vec
();

373 
Ët
 
mut
 
mut_´i
 = 
MutiÚ
::
	`Ãw
();

374 
mut_´i
.
İ
 = 
Op
::
Put
;

375 
mut_´i
.
key
 = 
k
.
	`şÚe
();

376 
mut_´i
.
v®ue
 = 
Ãw_v
.
	`şÚe
();

377 
Ët
 
mut
 
mut_£c
 = 
MutiÚ
::
	`Ãw
();

378 
mut_£c
.
İ
 = 
Op
::
Put
;

379 
mut_£c
.
key
 = 
k2
.
	`şÚe
();

380 
mut_£c
.
v®ue
 = 
v2
.
	`to_vec
();

381 
	`mu¡_kv_´ewr™e
(

382 &
ş›Á
,

383 
ùx
.
	`şÚe
(),

384 
vec
![
mut_´i
, 
mut_£c
],

385 
k
.
	`şÚe
(),

386 
´ewr™e_¡¬t_v”siÚ2
,

390 
ts
 += 1;

391 
Ët
 
»sŞve_lock_comm™_v”siÚ
 = 
ts
;

392 
Ët
 
mut
 
»sŞve_lock_»q
 = 
ResŞveLockReque¡
::
	`Ãw
();

393 
Ët
 
mut
 
‹mp_txnšfo
 = 
TxnInfo
::
	`Ãw
();

394 
‹mp_txnšfo
.
txn
 = 
´ewr™e_¡¬t_v”siÚ2
;

395 
‹mp_txnšfo
.
¡©us
 = 
»sŞve_lock_comm™_v”siÚ
;

396 
Ët
 
vec_txnšfo
 = 
vec
![
‹mp_txnšfo
];

397 
»sŞve_lock_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

398 
»sŞve_lock_»q
.
	`£t_txn_šfos
(
´Ùobuf
::
R•—‹dF›ld
::
	`äom_vec
(
vec_txnšfo
));

399 
Ët
 
»sŞve_lock_»¥
 = 
ş›Á
.
	`kv_»sŞve_lock
(
»sŞve_lock_»q
).
	`unw¿p
();

400 
as£¹
!(!
»sŞve_lock_»¥
.
	`has_»giÚ_”rÜ
());

401 
as£¹
!(!
»sŞve_lock_»¥
.
	`has_”rÜ
());

404 
ts
 += 1;

405 
Ët
 
g‘_v”siÚ1
 = 
ts
;

406 
Ët
 
mut
 
g‘_»q1
 = 
G‘Reque¡
::
	`Ãw
();

407 
g‘_»q1
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

408 
g‘_»q1
.
key
 = 
k
.
	`şÚe
();

409 
g‘_»q1
.
v”siÚ
 = 
g‘_v”siÚ1
;

410 
Ët
 
g‘_»¥1
 = 
ş›Á
.
	`kv_g‘
(
g‘_»q1
).
	`unw¿p
();

411 
as£¹
!(!
g‘_»¥1
.
	`has_»giÚ_”rÜ
());

412 
as£¹
!(!
g‘_»¥1
.
	`has_”rÜ
());

413 
as£¹_eq
!(
g‘_»¥1
.
v®ue
, 
Ãw_v
);

416 
ts
 += 1;

417 
Ët
 
gc_§ã_pÚ™
 = 
ts
;

418 
Ët
 
mut
 
gc_»q
 = 
GCReque¡
::
	`Ãw
();

419 
gc_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

420 
gc_»q
.
§ã_pošt
 = 
gc_§ã_pÚ™
;

421 
Ët
 
gc_»¥
 = 
ş›Á
.
	`kv_gc
(
gc_»q
).
	`unw¿p
();

422 
as£¹
!(!
gc_»¥
.
	`has_»giÚ_”rÜ
());

423 
as£¹
!(!
gc_»¥
.
	`has_”rÜ
());

426 
Ët
 
g‘_v”siÚ2
 = 
comm™_v”siÚ
 + 1;

427 
Ët
 
mut
 
g‘_»q2
 = 
G‘Reque¡
::
	`Ãw
();

428 
g‘_»q2
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

429 
g‘_»q2
.
key
 = 
k
.
	`şÚe
();

430 
g‘_»q2
.
v”siÚ
 = 
g‘_v”siÚ2
;

431 
Ët
 
g‘_»¥2
 = 
ş›Á
.
	`kv_g‘
(
g‘_»q2
).
	`unw¿p
();

432 
as£¹
!(!
g‘_»¥2
.
	`has_»giÚ_”rÜ
());

433 
as£¹
!(!
g‘_»¥2
.
	`has_”rÜ
());

434 
as£¹_eq
!(
g‘_»¥2
.
v®ue
, 
b
"".
	`to_vec
());

438 
Ët
 
mut
 
mvcc_g‘_by_key_»q
 = 
MvccG‘ByKeyReque¡
::
	`Ãw
();

439 
mvcc_g‘_by_key_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

440 
mvcc_g‘_by_key_»q
.
key
 = 
k
.
	`şÚe
();

441 
Ët
 
mvcc_g‘_by_key_»¥
 = 
ş›Á
.
	`mvcc_g‘_by_key
(
mvcc_g‘_by_key_»q
).
	`unw¿p
();

442 
as£¹
!(!
mvcc_g‘_by_key_»¥
.
	`has_»giÚ_”rÜ
());

443 
as£¹
!(
mvcc_g‘_by_key_»¥
.
”rÜ
.
	`is_em±y
());

444 
as£¹
!(
mvcc_g‘_by_key_»¥
.
	`has_šfo
());

446 
Ët
 
mut
 
mvcc_g‘_by_¡¬t_ts_»q
 = 
MvccG‘ByS¹TsReque¡
::
	`Ãw
();

447 
mvcc_g‘_by_¡¬t_ts_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

448 
mvcc_g‘_by_¡¬t_ts_»q
.
¡¬t_ts
 = 
´ewr™e_¡¬t_v”siÚ2
;

449 
Ët
 
mvcc_g‘_by_¡¬t_ts_»¥
 = 
ş›Á


450 .
	`mvcc_g‘_by_¡¬t_ts
(
mvcc_g‘_by_¡¬t_ts_»q
)

451 .
	`unw¿p
();

452 
as£¹
!(!
mvcc_g‘_by_¡¬t_ts_»¥
.
	`has_»giÚ_”rÜ
());

453 
as£¹
!(
mvcc_g‘_by_¡¬t_ts_»¥
.
”rÜ
.
	`is_em±y
());

454 
as£¹
!(
mvcc_g‘_by_¡¬t_ts_»¥
.
	`has_šfo
());

455 
as£¹_eq
!(
mvcc_g‘_by_¡¬t_ts_»¥
.
key
, 
k
);

458 
Ët
 
mut
 
d–_»q
 = 
D–‘eRªgeReque¡
::
	`Ãw
();

459 
d–_»q
.
	`£t_cÚ‹xt
(
ùx
.
	`şÚe
());

460 
d–_»q
.
¡¬t_key
 = 
b
"a".
	`to_vec
();

461 
d–_»q
.
’d_key
 = 
b
"z".
	`to_vec
();

462 
Ët
 
d–_»¥
 = 
ş›Á
.
	`kv_d–‘e_¿nge
(
d–_»q
).
	`unw¿p
();

463 
as£¹
!(!
d–_»¥
.
	`has_»giÚ_”rÜ
());

464 
as£¹
!(
d–_»¥
.
”rÜ
.
	`is_em±y
());

465 
	}
}

467 #[
‹¡
]

468 
â
 
	$‹¡_¿á
() {

469 
	`Ët
 (
_şu¡”
, 
ş›Á
, 
_
èğ
	`mu¡_Ãw_şu¡”_ªd_kv_ş›Á
();

472 
	`Ët
 (
sšk
, 
_
èğ
ş›Á
.
	`¿á
();

473 
sšk
.
	`£nd
((
RaáMes§ge
::
	`Ãw
(), 
DeçuÉ
::()))

474 .
	`wa™
()

475 .
	`unw¿p
();

477 
	`Ët
 (
sšk
, 
_
èğ
ş›Á
.
	`¢­shÙ
();

478 
Ët
 
mut
 
chunk
 = 
SÇpshÙChunk
::
	`Ãw
();

479 
chunk
.
	`£t_mes§ge
(
RaáMes§ge
::
	`Ãw
());

480 
sšk
.
	`£nd
((
chunk
, 
DeçuÉ
::())).
	`wa™
().
	`unw¿p
();

481 
	}
}

483 #[
‹¡
]

484 
â
 
	$‹¡_cİroûssÜ
() {

485 
	`Ët
 (
_şu¡”
, 
ş›Á
, 
_
èğ
	`mu¡_Ãw_şu¡”_ªd_kv_ş›Á
();

488 
ş›Á
.
	`cİroûssÜ
(
Reque¡
::
	`Ãw
()).
	`unw¿p
();

489 
	}
}

491 #[
‹¡
]

492 
â
 
	$‹¡_¥l™_»giÚ
() {

493 
	`Ët
 (
_şu¡”
, 
ş›Á
, 
ùx
èğ
	`mu¡_Ãw_şu¡”_ªd_kv_ş›Á
();

496 
Ët
 
key
 = 
b
"b";

497 
Ët
 
mut
 
»q
 = 
S¶™RegiÚReque¡
::
	`Ãw
();

498 
»q
.
	`£t_cÚ‹xt
(
ùx
);

499 
»q
.
	`£t_¥l™_key
(
key
.
	`to_vec
());

500 
Ët
 
»¥
 = 
ş›Á
.
	`¥l™_»giÚ
(
»q
).
	`unw¿p
();

501 
as£¹_eq
!(

502 
Key
::
	`äom_’coded
(
»¥
.
	`g‘_Ëá
().
	`g‘_’d_key
().
	`to_vec
())

503 .
	`Œunÿ‹_ts
()

504 .
	`unw¿p
()

505 .
	`’coded
()

506 .
	`as_¦iû
(),

507 
key


509 
as£¹_eq
!(

510 
»¥
.
	`g‘_Ëá
().
	`g‘_’d_key
(),

511 
»¥
.
	`g‘_right
().
	`g‘_¡¬t_key
()

513 
	}
}

515 
â
 
mu¡_Ãw_şu¡”_ªd_debug_ş›Á
(è-> (
	gClu¡”
<
	gS”v”Clu¡”
>, 
	gDebugCl›Á
, 
	gu64
) {

516 
Ët
 (
şu¡”
, 
Ëad”
, 
_
èğ
mu¡_Ãw_şu¡”
();

518 
Ët
 
	g’v
 = 
Arc
::
Ãw
(
EnvœÚm’t
::new(1));

519 
Ët
 
	gchªÃl
 =

520 
ChªÃlBud”
::
Ãw
(
’v
).
cÚÃù
(
şu¡”
.
sim
.
¾
().
g‘_addr
(
Ëad”
.
g‘_¡Üe_id
()));

521 
Ët
 
	gş›Á
 = 
DebugCl›Á
::
Ãw
(
chªÃl
);

523 (
	gşu¡”
, 
	gş›Á
, 
	gËad”
.
g‘_¡Üe_id
())

526 #[
‹¡
]

527 
â
 
	$‹¡_debug_g‘
() {

528 
	`Ët
 (
şu¡”
, 
debug_ş›Á
, 
¡Üe_id
èğ
	`mu¡_Ãw_şu¡”_ªd_debug_ş›Á
();

529 
	`Ët
 (
k
, 
v
èğ(
b
"key", b"value");

532 
Ët
 
’gše
 = 
şu¡”
.
	`g‘_’gše
(
¡Üe_id
);

533 
Ët
 
key
 = 
keys
::
	`d©a_key
(
k
);

534 
’gše
.
	`put
(&
key
, 
v
).
	`unw¿p
();

535 
as£¹_eq
!(
’gše
.
	`g‘
(&
key
).
	`unw¿p
().unw¿p(), 
v
);

538 
Ët
 
mut
 
»q
 = 
debugpb
::
G‘Reque¡
::
	`Ãw
();

539 
»q
.
	`£t_cf
(
CF_DEFAULT
.
	`to_owÃd
());

540 
»q
.
	`£t_db
(
debugpb
::
DB
::
KV
);

541 
»q
.
	`£t_key
(
key
);

542 
Ët
 
mut
 
»¥
 = 
debug_ş›Á
.
	`g‘
(
»q
.
	`şÚe
()).
	`unw¿p
();

543 
as£¹_eq
!(
»¥
.
	`ke_v®ue
(), 
v
);

545 
»q
.
	`£t_key
(
b
"foo".
	`to_vec
());

546 
m©ch
 
debug_ş›Á
.
	`g‘
(
»q
).
	`unw¿p_”r
() {

547 
E¼Ü
::
	`RpcFau»
(
¡©us
) => {

548 
as£¹_eq
!(
¡©us
.¡©us, 
RpcStusCode
::
NÙFound
);

550 
_
 => 
·nic
!("expect NotFound"),

552 
	}
}

554 #[
‹¡
]

555 
â
 
	$‹¡_debug_¿á_log
() {

556 
	`Ët
 (
şu¡”
, 
debug_ş›Á
, 
¡Üe_id
èğ
	`mu¡_Ãw_şu¡”_ªd_debug_ş›Á
();

559 
Ët
 
’gše
 = 
şu¡”
.
	`g‘_¿á_’gše
(
¡Üe_id
);

560 
	`Ët
 (
»giÚ_id
, 
log_šdex
) = (200, 200);

561 
Ët
 
key
 = 
keys
::
	`¿á_log_key
(
»giÚ_id
, 
log_šdex
);

562 
Ët
 
mut
 
’Œy
 = 
”aápb
::
EÁry
::
	`Ãw
();

563 
’Œy
.
	`£t_‹rm
(1);

564 
’Œy
.
	`£t_šdex
(1);

565 
’Œy
.
	`£t_’Œy_ty³
(
”aápb
::
EÁryTy³
::
EÁryNÜm®
);

566 
’Œy
.
	`£t_d©a
(
vec
![42]);

567 
’gše
.
	`put_msg
(
key
.
	`as_¦iû
(), &
’Œy
).
	`unw¿p
();

568 
as£¹_eq
!(

569 
’gše


570 .
g‘_msg
::<
”aápb
::
EÁry
>(
key
.
	`as_¦iû
())

571 .
	`unw¿p
()

572 .
	`unw¿p
(),

573 
’Œy


577 
Ët
 
mut
 
»q
 = 
debugpb
::
RaáLogReque¡
::
	`Ãw
();

578 
»q
.
	`£t_»giÚ_id
(
»giÚ_id
);

579 
»q
.
	`£t_log_šdex
(
log_šdex
);

580 
Ët
 
»¥
 = 
debug_ş›Á
.
	`¿á_log
(
»q
).
	`unw¿p
();

581 
as£¹_Ã
!(
»¥
.
	`g‘_’Œy
(), &
”aápb
::
EÁry
::
	`Ãw
());

583 
Ët
 
mut
 
»q
 = 
debugpb
::
RaáLogReque¡
::
	`Ãw
();

584 
»q
.
	`£t_»giÚ_id
(
»giÚ_id
 + 1);

585 
»q
.
	`£t_log_šdex
(
»giÚ_id
 + 1);

586 
m©ch
 
debug_ş›Á
.
	`¿á_log
(
»q
).
	`unw¿p_”r
() {

587 
E¼Ü
::
	`RpcFau»
(
¡©us
) => {

588 
as£¹_eq
!(
¡©us
.¡©us, 
RpcStusCode
::
NÙFound
);

590 
_
 => 
·nic
!("expect NotFound"),

592 
	}
}

594 #[
‹¡
]

595 
â
 
	$‹¡_debug_»giÚ_šfo
() {

596 
	`Ët
 (
şu¡”
, 
debug_ş›Á
, 
¡Üe_id
èğ
	`mu¡_Ãw_şu¡”_ªd_debug_ş›Á
();

598 
Ët
 
¿á_’gše
 = 
şu¡”
.
	`g‘_¿á_’gše
(
¡Üe_id
);

599 
Ët
 
kv_’gše
 = 
şu¡”
.
	`g‘_’gše
(
¡Üe_id
);

600 
Ët
 
¿á_cf
 = 
kv_’gše
.
	`cf_hªdË
(
CF_RAFT
).
	`unw¿p
();

602 
Ët
 
»giÚ_id
 = 100;

603 
Ët
 
¿á_¡©e_key
 = 
keys
::
	`¿á_¡©e_key
(
»giÚ_id
);

604 
Ët
 
mut
 
¿á_¡©e
 = 
¿á_£rv”pb
::
RaáLoÿlS‹
::
	`Ãw
();

605 
¿á_¡©e
.
	`£t_Ï¡_šdex
(42);

606 
¿á_’gše
.
	`put_msg
(&
¿á_¡©e_key
, &
¿á_¡©e
).
	`unw¿p
();

607 
as£¹_eq
!(

608 
¿á_’gše


609 .
g‘_msg
::<
¿á_£rv”pb
::
RaáLoÿlS‹
>(&
¿á_¡©e_key
)

610 .
	`unw¿p
()

611 .
	`unw¿p
(),

612 
¿á_¡©e


615 
Ët
 
­¶y_¡©e_key
 = 
keys
::
	`­¶y_¡©e_key
(
»giÚ_id
);

616 
Ët
 
mut
 
­¶y_¡©e
 = 
¿á_£rv”pb
::
RaáAµlyS‹
::
	`Ãw
();

617 
­¶y_¡©e
.
	`£t_­¶›d_šdex
(42);

618 
kv_’gše


619 .
	`put_msg_cf
(
¿á_cf
, &
­¶y_¡©e_key
, &
­¶y_¡©e
)

620 .
	`unw¿p
();

621 
as£¹_eq
!(

622 
kv_’gše


623 .
g‘_msg_cf
::<
¿á_£rv”pb
::
RaáAµlyS‹
>(
CF_RAFT
, &
­¶y_¡©e_key
)

624 .
	`unw¿p
()

625 .
	`unw¿p
(),

626 
­¶y_¡©e


629 
Ët
 
»giÚ_¡©e_key
 = 
keys
::
	`»giÚ_¡©e_key
(
»giÚ_id
);

630 
Ët
 
mut
 
»giÚ_¡©e
 = 
¿á_£rv”pb
::
RegiÚLoÿlS‹
::
	`Ãw
();

631 
»giÚ_¡©e
.
	`£t_¡©e
(
¿á_£rv”pb
::
P“rS‹
::
Tomb¡Úe
);

632 
kv_’gše


633 .
	`put_msg_cf
(
¿á_cf
, &
»giÚ_¡©e_key
, &
»giÚ_¡©e
)

634 .
	`unw¿p
();

635 
as£¹_eq
!(

636 
kv_’gše


637 .
g‘_msg_cf
::<
¿á_£rv”pb
::
RegiÚLoÿlS‹
>(
CF_RAFT
, &
»giÚ_¡©e_key
)

638 .
	`unw¿p
()

639 .
	`unw¿p
(),

640 
»giÚ_¡©e


644 
Ët
 
mut
 
»q
 = 
debugpb
::
RegiÚInfoReque¡
::
	`Ãw
();

645 
»q
.
	`£t_»giÚ_id
(
»giÚ_id
);

646 
Ët
 
mut
 
»¥
 = 
debug_ş›Á
.
	`»giÚ_šfo
(
»q
.
	`şÚe
()).
	`unw¿p
();

647 
as£¹_eq
!(
»¥
.
	`ke_¿á_loÿl_¡©e
(), 
¿á_¡©e
);

648 
as£¹_eq
!(
»¥
.
	`ke_¿á_­¶y_¡©e
(), 
­¶y_¡©e
);

649 
as£¹_eq
!(
»¥
.
	`ke_»giÚ_loÿl_¡©e
(), 
»giÚ_¡©e
);

651 
»q
.
	`£t_»giÚ_id
(
»giÚ_id
 + 1);

652 
m©ch
 
debug_ş›Á
.
	`»giÚ_šfo
(
»q
).
	`unw¿p_”r
() {

653 
E¼Ü
::
	`RpcFau»
(
¡©us
) => {

654 
as£¹_eq
!(
¡©us
.¡©us, 
RpcStusCode
::
NÙFound
);

656 
_
 => 
·nic
!("expect NotFound"),

658 
	}
}

660 #[
‹¡
]

661 
â
 
	$‹¡_debug_»giÚ_size
() {

662 
	`Ët
 (
şu¡”
, 
debug_ş›Á
, 
¡Üe_id
èğ
	`mu¡_Ãw_şu¡”_ªd_debug_ş›Á
();

663 
Ët
 
’gše
 = 
şu¡”
.
	`g‘_’gše
(
¡Üe_id
);

666 
Ët
 
»giÚ_id
 = 100;

667 
Ët
 
»giÚ_¡©e_key
 = 
keys
::
	`»giÚ_¡©e_key
(
»giÚ_id
);

668 
Ët
 
mut
 
»giÚ
 = 
m‘­b
::
RegiÚ
::
	`Ãw
();

669 
»giÚ
.
	`£t_id
(
»giÚ_id
);

670 
»giÚ
.
	`£t_¡¬t_key
(
b
"a".
	`to_vec
());

671 
»giÚ
.
	`£t_’d_key
(
b
"z".
	`to_vec
());

672 
Ët
 
mut
 
¡©e
 = 
RegiÚLoÿlS‹
::
	`Ãw
();

673 
¡©e
.
	`£t_»giÚ
(
»giÚ
);

674 
Ët
 
cf_¿á
 = 
’gše
.
	`cf_hªdË
(
CF_RAFT
).
	`unw¿p
();

675 
’gše


676 .
	`put_msg_cf
(
cf_¿á
, &
»giÚ_¡©e_key
, &
¡©e
)

677 .
	`unw¿p
();

679 
Ët
 
cfs
 = 
vec
![
CF_DEFAULT
, 
CF_LOCK
, 
CF_RAFT
, 
CF_WRITE
];

680 
	`Ët
 (
k
, 
v
èğ(
keys
::
	`d©a_key
(
b
"k"), b"v");

681 
cf
 
š
 &
cfs
 {

682 
Ët
 
cf_hªdË
 = 
’gše
.
	`cf_hªdË
(
cf
).
	`unw¿p
();

683 
’gše
.
	`put_cf
(
cf_hªdË
, 
k
.
	`as_¦iû
(), 
v
).
	`unw¿p
();

686 
Ët
 
mut
 
»q
 = 
debugpb
::
RegiÚSizeReque¡
::
	`Ãw
();

687 
»q
.
	`£t_»giÚ_id
(
»giÚ_id
);

688 
»q
.
	`£t_cfs
(
cfs
.
	`™”
().
	`m­
(|
s
| s.
	`to_¡ršg
()).
	`cŞËù
());

689 
Ët
 
’Œ›s
 = 
debug_ş›Á


690 .
	`»giÚ_size
(
»q
.
	`şÚe
())

691 .
	`unw¿p
()

692 .
	`ke_’Œ›s
();

693 
as£¹_eq
!(
’Œ›s
.
	`Ën
(), 4);

694 
e
 
š
 
’Œ›s
.
	`što_vec
() {

695 
cfs
.
	`™”
().
	`fšd
(|&&
c
| c =ğ
e
.
cf
).
	`unw¿p
();

696 
as£¹
!(
e
.
size
 > 0);

699 
»q
.
	`£t_»giÚ_id
(
»giÚ_id
 + 1);

700 
m©ch
 
debug_ş›Á
.
	`»giÚ_size
(
»q
).
	`unw¿p_”r
() {

701 
E¼Ü
::
	`RpcFau»
(
¡©us
) => {

702 
as£¹_eq
!(
¡©us
.¡©us, 
RpcStusCode
::
NÙFound
);

704 
_
 => 
·nic
!("expect NotFound"),

706 
	}
}

708 #[
‹¡
]

709 #[
cfg
(
nÙ
(
ã©u»
 = "no-fail"))]

710 
â
 
	$‹¡_debug_ç_pošt
() {

711 
	`Ët
 (
_şu¡”
, 
debug_ş›Á
, 
_
èğ
	`mu¡_Ãw_şu¡”_ªd_debug_ş›Á
();

713 
	`Ët
 (
å
, 
aù
) = ("tikv::raftstore::store::store::raft_between_save", "off");

715 
Ët
 
mut
 
šjeù_»q
 = 
debugpb
::
InjeùFaPoštReque¡
::
	`Ãw
();

716 
šjeù_»q
.
	`£t_Çme
(
å
.
	`to_owÃd
());

717 
šjeù_»q
.
	`£t_aùiÚs
(
aù
.
	`to_owÃd
());

718 
debug_ş›Á
.
	`šjeù_ç_pošt
(
šjeù_»q
).
	`unw¿p
();

720 
Ët
 
»¥
 = 
debug_ş›Á


721 .
	`li¡_ç_pošts
(
debugpb
::
Li¡FaPoštsReque¡
::
	`Ãw
())

722 .
	`unw¿p
();

723 
Ët
 
’Œ›s
 = 
»¥
.
	`g‘_’Œ›s
();

724 
as£¹_eq
!(
’Œ›s
.
	`Ën
(), 1);

725 
e
 
š
 
’Œ›s
 {

726 
as£¹_eq
!(
e
.
	`g‘_Çme
(), 
å
);

727 
as£¹_eq
!(
e
.
	`g‘_aùiÚs
(), 
aù
);

730 
Ët
 
mut
 
»cov”_»q
 = 
debugpb
::
Recov”FaPoštReque¡
::
	`Ãw
();

731 
»cov”_»q
.
	`£t_Çme
(
å
.
	`to_owÃd
());

732 
debug_ş›Á
.
	`»cov”_ç_pošt
(
»cov”_»q
).
	`unw¿p
();

734 
Ët
 
»¥
 = 
debug_ş›Á


735 .
	`li¡_ç_pošts
(
debugpb
::
Li¡FaPoštsReque¡
::
	`Ãw
())

736 .
	`unw¿p
();

737 
Ët
 
’Œ›s
 = 
»¥
.
	`g‘_’Œ›s
();

738 
as£¹_eq
!(
’Œ›s
.
	`Ën
(), 0);

739 
	}
}

741 #[
‹¡
]

742 
â
 
	$‹¡_debug_sÿn_mvcc
() {

743 
	`Ët
 (
şu¡”
, 
debug_ş›Á
, 
¡Üe_id
èğ
	`mu¡_Ãw_şu¡”_ªd_debug_ş›Á
();

744 
Ët
 
’gše
 = 
şu¡”
.
	`g‘_’gše
(
¡Üe_id
);

747 
Ët
 
keys
 = [

748 
keys
::
	`d©a_key
(
b
"meta_lock_1"),

749 
keys
::
	`d©a_key
(
b
"meta_lock_2"),

751 
k
 
š
 &
keys
 {

752 
Ët
 
v
 = 
Lock
::
	`Ãw
(
LockTy³
::
Put
, 
b
"pk".
	`to_vec
(), 1, 10, 
NÚe
).
	`to_by‹s
();

753 
Ët
 
cf_hªdË
 = 
’gše
.
	`cf_hªdË
(
CF_LOCK
).
	`unw¿p
();

754 
’gše
.
	`put_cf
(
cf_hªdË
, 
k
.
	`as_¦iû
(), &
v
).
	`unw¿p
();

757 
Ët
 
mut
 
»q
 = 
debugpb
::
SÿnMvccReque¡
::
	`Ãw
();

758 
»q
.
	`£t_äom_key
(
keys
::
	`d©a_key
(
b
"m"));

759 
»q
.
	`£t_to_key
(
keys
::
	`d©a_key
(
b
"n"));

760 
»q
.
	`£t_lim™
(1);

762 
Ët
 
»ûiv”
 = 
debug_ş›Á
.
	`sÿn_mvcc
(
»q
);

763 
Ët
 
futu»
 = 
»ûiv”
.
	`fŞd
(
Vec
::
	`Ãw
(), |
mut
 
keys
, muˆ
»¥
| {

764 
Ët
 
key
 = 
»¥
.
	`ke_key
();

765 
keys
.
	`push
(
key
);

766 
futu»
::
ok
::<
_
, 
E¼Ü
>(
keys
)

768 
Ët
 
keys
 = 
futu»
.
	`wa™
().
	`unw¿p
();

769 
as£¹_eq
!(
keys
.
	`Ën
(), 1);

770 
as£¹_eq
!(
keys
[0], keys::
	`d©a_key
(
b
"meta_lock_1"));

771 
	}
}

	@tests/raftstore_cases/test_single.rs

14 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

16 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

18 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

19 
u£
 
	gsu³r
::
ut
::*;

20 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

21 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

25 
â
 
	g‹¡_put
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

26 
şu¡”
.
run
();

28 
i
 
	gš
 1..1000 {

29 
Ët
 (
k
, 
v
èğ(
fÜm©
!("key{}", 
	gi
), 
	gfÜm©
!("value{}", i));

30 
Ët
 
	gkey
 = 
k
.
as_by‹s
();

31 
Ët
 
	gv®ue
 = 
v
.
as_by‹s
();

32 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

33 
Ët
 
	gv
 = 
şu¡”
.
g‘
(
key
);

34 
	gas£¹_eq
!(
	gv
, 
Some
(
v®ue
.
to_vec
()));

37 
i
 
	gš
 1..1000 {

38 
Ët
 (
k
, 
v
èğ(
fÜm©
!("key{}", 
	gi
), 
	gfÜm©
!("value{}", i + 1));

39 
Ët
 
	gkey
 = 
k
.
as_by‹s
();

40 
Ët
 
	gv®ue
 = 
v
.
as_by‹s
();

41 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

42 
Ët
 
	gv
 = 
şu¡”
.
g‘
(
key
);

43 
	gas£¹_eq
!(
	gv
, 
Some
(
v®ue
.
to_vec
()));

47 
â
 
	g‹¡_d–‘e
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

48 
şu¡”
.
run
();

50 
i
 
	gš
 1..1000 {

51 
Ët
 (
k
, 
v
èğ(
fÜm©
!("key{}", 
	gi
), 
	gfÜm©
!("value{}", i));

52 
Ët
 
	gkey
 = 
k
.
as_by‹s
();

53 
Ët
 
	gv®ue
 = 
v
.
as_by‹s
();

54 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

55 
Ët
 
	gv
 = 
şu¡”
.
g‘
(
key
);

56 
	gas£¹_eq
!(
	gv
, 
Some
(
v®ue
.
to_vec
()));

59 
i
 
	gš
 1..1000 {

60 
Ët
 
	gk
 = 
fÜm©
!("key{}", 
	gi
);

61 
Ët
 
	gkey
 = 
k
.
as_by‹s
();

62 
	gşu¡”
.
mu¡_d–‘e
(
key
);

63 
	gas£¹
!(
	gşu¡”
.
g‘
(
key
).
is_nÚe
());

67 
â
 
	g‹¡_d–‘e_¿nge
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

68 
şu¡”
.
run
();

70 
i
 
	gš
 1..1000 {

71 
Ët
 (
k
, 
v
èğ(
fÜm©
!("key{}", 
	gi
), 
	gfÜm©
!("value{}", i));

72 
Ët
 
	gkey
 = 
k
.
as_by‹s
();

73 
Ët
 
	gv®ue
 = 
v
.
as_by‹s
();

74 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

75 
Ët
 
	gv
 = 
şu¡”
.
g‘
(
key
);

76 
	gas£¹_eq
!(
	gv
, 
Some
(
v®ue
.
to_vec
()));

79 
	gşu¡”
.
mu¡_d–‘e_¿nge
(
b
"key1", b"key9999");

81 
i
 
	gš
 1..1000 {

82 
Ët
 
	gk
 = 
fÜm©
!("key{}", 
	gi
);

83 
Ët
 
	gkey
 = 
k
.
as_by‹s
();

84 
	gas£¹
!(
	gşu¡”
.
g‘
(
key
).
is_nÚe
());

88 
â
 
	g‹¡_wrÚg_¡Üe_id
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

89 
şu¡”
.
run
();

91 
Ët
 (
k
, 
v
èğ(
b
"k", 
	gb
"v");

92 
Ët
 
mut
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
k
);

93 
Ët
 
	g»giÚ_id
 = 
»giÚ
.
g‘_id
();

94 
Ët
 
	gcmd
 = 
Ãw_put_cmd
(
k
, 
v
);

95 
Ët
 
mut
 
	g»q
 = 
Ãw_»que¡
(
»giÚ_id
, 
»giÚ
.
ke_»giÚ_•och
(), 
vec
![
cmd
], 
Œue
);

96 
Ët
 
mut
 
	gËad”
 = 
şu¡”
.
Ëad”_of_»giÚ
(
»giÚ_id
).
unw¿p
();

98 
Ët
 
	g¡Üe_id
 = 
Ëad”
.
g‘_¡Üe_id
();

99 
	gËad”
.
£t_¡Üe_id
(
¡Üe_id
 + 1);

100 
	g»q
.
mut_h—d”
().
£t_³”
(
Ëad”
);

101 
Ët
 
	g»suÉ
 = 
şu¡”
.
ÿÎ_commªd_Ú_node
(
¡Üe_id
, 
»q
, 
Du¿tiÚ
::
äom_£cs
(5));

102 
	gas£¹
!(!
	g»suÉ


103 .
unw¿p
()

104 .
g‘_h—d”
()

105 .
g‘_”rÜ
()

106 .
g‘_mes§ge
()

107 .
is_em±y
());

110 
â
 
	g‹¡_put_Ïrge_’Œy
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

111 
Ët
 
max_size
: 
usize
 = 1024;

112 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_’Œy_max_size
 = 
R—dabËSize
(
max_size
 
as
 
u64
);

114 
	gşu¡”
.
run
();

116 
Ët
 
	gÏrge_v®ue
 = 
vec
![
b
'v'; 
max_size
 + 1];

117 
Ët
 
	g»s
 = 
şu¡”
.
put
(
b
"key", 
Ïrge_v®ue
.
as_¦iû
());

118 
	gas£¹
!(
	g»s
.
as_»f
().
”r
().
unw¿p
().
has_¿á_’Œy_too_Ïrge
());

121 #[
‹¡
]

122 
â
 
	$‹¡_node_put
() {

123 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 1);

124 
	`‹¡_put
(&
mut
 
şu¡”
);

125 
	}
}

127 #[
‹¡
]

128 
â
 
	$‹¡_node_d–‘e
() {

129 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 1);

130 
	`‹¡_d–‘e
(&
mut
 
şu¡”
);

131 
	}
}

133 #[
‹¡
]

134 
â
 
	$‹¡_node_d–‘e_¿nge
() {

135 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 1);

136 
	`‹¡_d–‘e_¿nge
(&
mut
 
şu¡”
);

137 
	}
}

139 #[
‹¡
]

140 
â
 
	$‹¡_node_wrÚg_¡Üe_id
() {

141 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 1);

142 
	`‹¡_wrÚg_¡Üe_id
(&
mut
 
şu¡”
);

143 
	}
}

145 #[
‹¡
]

146 
â
 
	$‹¡_£rv”_put
() {

147 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 1);

148 
	`‹¡_put
(&
mut
 
şu¡”
);

149 
	}
}

151 #[
‹¡
]

152 
â
 
	$‹¡_£rv”_d–‘e
() {

153 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 1);

154 
	`‹¡_d–‘e
(&
mut
 
şu¡”
);

155 
	}
}

157 #[
‹¡
]

158 
â
 
	$‹¡_£rv”_d–‘e_¿nge
() {

159 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 1);

160 
	`‹¡_d–‘e_¿nge
(&
mut
 
şu¡”
);

161 
	}
}

163 #[
‹¡
]

164 
â
 
	$‹¡_£rv”_wrÚg_¡Üe_id
() {

165 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 1);

166 
	`‹¡_wrÚg_¡Üe_id
(&
mut
 
şu¡”
);

167 
	}
}

169 #[
‹¡
]

170 
â
 
	$‹¡_node_put_Ïrge_’Œy
() {

171 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 1);

172 
	`‹¡_put_Ïrge_’Œy
(&
mut
 
şu¡”
);

173 
	}
}

175 #[
‹¡
]

176 
â
 
	$‹¡_£rv”_put_Ïrge_’Œy
() {

177 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 1);

178 
	`‹¡_put_Ïrge_’Œy
(&
mut
 
şu¡”
);

179 
	}
}

	@tests/raftstore_cases/test_snap.rs

15 
u£
 
	g¡d
::
fs
;

16 
u£
 
	g¡d
::
time
::{
Du¿tiÚ
, 
	gIn¡ªt
};

17 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gMu‹x
, 
	gRwLock
};

18 
u£
 
	g¡d
::
sync
::
mpsc
::{
£lf
, 
	gS’d”
};

19 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicBoŞ
, 
	gOrd”šg
};

21 
u£
 
	gtikv
::
¿á¡Üe
::
ResuÉ
;

22 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
Msg
;

23 
u£
 
	gtikv
::
ut
::
HªdyRwLock
;

24 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

25 
u£
 
	gkv´Ùo
::
”aápb
::{
Mes§ge
, 
	gMes§geTy³
};

26 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::
RaáMes§ge
;

28 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

29 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

30 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

31 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

32 
u£
 
	gsu³r
::
ut
::*;

34 
â
 
	g‹¡_huge_¢­shÙ
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

35 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_couÁ_lim™
 = 1000;

36 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(10);

37 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¢­_­¶y_b©ch_size
 = 
R—dabËSize
(500);

38 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

40 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

42 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

45 
i
 
	gš
 0..2 * 1024 {

46 
Ët
 
	gkey
 = 
fÜm©
!("{:01024}", 
	gi
);

47 
Ët
 
	gv®ue
 = 
fÜm©
!("{:01024}", 
	gi
);

48 
	gşu¡”
.
mu¡_put
(
key
.
as_by‹s
(), 
v®ue
.as_bytes());

51 
Ët
 
	g’gše_2
 = 
şu¡”
.
g‘_’gše
(2);

52 
mu¡_g‘_nÚe
(&
’gše_2
, &
fÜm©
!("{:01024}", 0).
što_by‹s
());

54 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

56 
Ët
 (
key
, 
v®ue
èğ(
b
"k2", 
	gb
"v2");

57 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

58 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

59 
mu¡_g‘_equ®
(&
’gše_2
, 
key
, 
v®ue
);

62 
Ët
 
	gkey
 = 
fÜm©
!("{:01024}", 0);

63 
Ët
 
	gv®ue
 = 
fÜm©
!("{:01024}", 0);

64 
mu¡_g‘_equ®
(&
’gše_2
, 
key
.
as_by‹s
(), 
v®ue
.as_bytes());

65 
Ët
 
	g¡®e
 = 
Arc
::
Ãw
(
AtomicBoŞ
::Ãw(
çl£
));

66 
	gşu¡”


67 .
	gsim


68 .
wl
()

69 .
add_»cv_f‹r
(3, 
box
 
L—dšgDu¶iÿ‹dSÇpshÙF‹r
::
Ãw
(
¡®e
.
şÚe
()));

70 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

71 
Ët
 
mut
 
	gi
 = 2 * 1024;

72 
	gloİ
 {

73 
	gi
 += 1;

74 
Ët
 
	gkey
 = 
fÜm©
!("{:01024}", 
	gi
);

75 
Ët
 
	gv®ue
 = 
fÜm©
!("{:01024}", 
	gi
);

76 
	gşu¡”
.
mu¡_put
(
key
.
as_by‹s
(), 
v®ue
.as_bytes());

77 
	g¡®e
.
lßd
(
Ord”šg
::
R–axed
) {

80 
	gi
 > 10 * 1024 {

81 
	g·nic
!("¢­shÙ should b£Áwiû‡á” {} kvs", 
	gi
);

84 
	gşu¡”
.
mu¡_put
(
b
"k3", b"v3");

85 
Ët
 
	g’gše_3
 = 
şu¡”
.
g‘_’gše
(3);

86 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k3", b"v3");

91 #[
‹¡
]

92 
â
 
	$‹¡_node_huge_¢­shÙ
() {

93 
Ët
 
couÁ
 = 5;

94 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

95 
	`‹¡_huge_¢­shÙ
(&
mut
 
şu¡”
);

96 
	}
}

98 #[
‹¡
]

99 
â
 
	$‹¡_£rv”_huge_¢­shÙ
() {

100 
Ët
 
couÁ
 = 5;

101 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

102 
	`‹¡_huge_¢­shÙ
(&
mut
 
şu¡”
);

103 
	}
}

105 
â
 
	g‹¡_¢­_gc
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

107 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(20);

108 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_couÁ_lim™
 = 2;

109 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¢­_mgr_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(50);

110 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¢­_gc_timeout
 = 
R—dabËDu¿tiÚ
::
mlis
(2);

112 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

114 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

115 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

116 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

117 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

118 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(2), 
b
"k1", b"v1");

120 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

122 
	gşu¡”


123 .
	gsim


124 .
wl
()

125 .
add_»cv_f‹r
(3, 
box
 
DrİSÇpshÙF‹r
::
Ãw
(
tx
));

126 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

128 
Ët
 
	gfœ¡_¢­_idx
 = 
rx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

130 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

133 
i
 
	gš
 1..3 {

134 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_’gše
(
i
);

135 
mu¡_g‘_equ®
(&
’gše
, 
b
"k2", b"v2");

138 
Ët
 
	g’gše3
 = 
şu¡”
.
g‘_’gše
(3);

139 
mu¡_g‘_nÚe
(&
’gše3
, 
b
"k2");

141 
_
 
	gš
 0..30 {

144 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

145 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

148 
Ët
 
mut
 
	gnow
 = 
In¡ªt
::
now
();

149 
	gloİ
 {

150 
Ët
 
	g¢­_šdex
 = 
rx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

151 
	g¢­_šdex
 !ğ
fœ¡_¢­_idx
 {

154 
	gnow
.
–­£d
(è>ğ
Du¿tiÚ
::
äom_£cs
(5) {

155 
·nic
!("ÿn'ˆg‘‡ny sÇ°aá” {}", 
fœ¡_¢­_idx
);

159 
Ët
 
	g¢­_dœ
 = 
şu¡”
.
g‘_¢­_dœ
(3);

161 
Ët
 
	g¢­fes
: 
Vec
<
_
> = 
fs
::
»ad_dœ
(
¢­_dœ
)

162 .
unw¿p
()

163 .
m­
(|
p
|….
unw¿p
().
·th
())

164 .
cŞËù
();

165 
	gas£¹
!(
	g¢­fes
.
Ën
() >= 2);

167 
	gşu¡”
.
	gsim
.
wl
().
ş—r_»cv_f‹rs
(3);

168 
	gdebug
!("filters cleared.");

171 
mu¡_g‘_equ®
(&
’gše3
, 
b
"k1", b"v1");

172 
mu¡_g‘_equ®
(&
’gše3
, 
b
"k2", b"v2");

174 
	gnow
 = 
In¡ªt
::
now
();

175 
	gloİ
 {

176 
Ët
 
mut
 
	g¢­_fes
 = 
vec
![];

177 
i
 
	gš
 1..4 {

178 
Ët
 
	g¢­_dœ
 = 
şu¡”
.
g‘_¢­_dœ
(
i
);

180 
	g¢­_fes
.
ex‹nd
(
fs
::
»ad_dœ
(
¢­_dœ
).
unw¿p
().
m­
(|
p
|….unw¿p().
·th
()));

182 
	g¢­_fes
.
is_em±y
() {

185 
	gnow
.
–­£d
(è> 
	gDu¿tiÚ
::
äom_£cs
(10) {

186 
·nic
!("¢­ fe i ¡ÈnÙƒm±y: {:?}", 
	g¢­_fes
);

189 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

190 
¦“p_ms
(20);

194 #[
‹¡
]

195 
â
 
	$‹¡_node_¢­_gc
() {

196 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

197 
	`‹¡_¢­_gc
(&
mut
 
şu¡”
);

198 
	}
}

200 #[
‹¡
]

201 
â
 
	$‹¡_£rv”_¢­_gc
() {

202 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

203 
	`‹¡_¢­_gc
(&
mut
 
şu¡”
);

204 
	}
}

209 
â
 
	g‹¡_cÚcu¼’t_¢­
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

211 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
£cs
(60);

213 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

215 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

217 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

218 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

219 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

221 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

222 
RegiÚPack‘F‹r
::
Ãw
(
r1
, 2)

223 .
msg_ty³
(
Mes§geTy³
::
MsgReque¡VÙe
)

224 .
dœeùiÚ
(
DœeùiÚ
::
S’d
),

226 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
r1
, 
Ãw_³”
(1, 1));

227 
	gşu¡”
.
mu¡_put
(
b
"k3", b"v3");

229 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

230 
	gşu¡”


231 .
	gsim


232 .
wl
()

233 .
add_»cv_f‹r
(3, 
box
 
CŞËùSÇpshÙF‹r
::
Ãw
(
tx
));

234 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

235 
Ët
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
b
"k1");

237 
Ët
 
E¼
(
e
èğ
rx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(1)) {

238 
·nic
!("th¢­shÙ i nÙ s’ˆbefÜ¥l™,ƒ: {:?}", 
e
);

241 
	gşu¡”
.
mu¡_¥l™
(&
»giÚ
, 
b
"k2");

242 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(3), 
b
"k3", b"v3");

244 
	gşu¡”
.
mu¡_put
(
b
"k11", b"v11");

245 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(3), 
b
"k11", b"v11");

246 
	gşu¡”
.
mu¡_put
(
b
"k4", b"v4");

247 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(3), 
b
"k4", b"v4");

250 #[
‹¡
]

251 
â
 
	$‹¡_node_cÚcu¼’t_¢­
() {

252 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

253 
	`‹¡_cÚcu¼’t_¢­
(&
mut
 
şu¡”
);

254 
	}
}

256 #[
‹¡
]

257 
â
 
	$‹¡_£rv”_cÚcu¼’t_¢­
() {

258 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

259 
	`‹¡_cÚcu¼’t_¢­
(&
mut
 
şu¡”
);

260 
	}
}

262 
â
 
	g‹¡_cf_¢­shÙ
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

264 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(20);

265 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_couÁ_lim™
 = 2;

266 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¢­_mgr_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(50);

268 
	gşu¡”
.
run
();

269 
Ët
 
	gcf
 = "lock";

270 
	gşu¡”
.
mu¡_put_cf
(
cf
, 
b
"k1", b"v1");

271 
	gşu¡”
.
mu¡_put_cf
(
cf
, 
b
"k2", b"v2");

272 
Ët
 
	g’gše1
 = 
şu¡”
.
g‘_’gše
(1);

273 
mu¡_g‘_cf_equ®
(&
’gše1
, 
cf
, 
b
"k1", b"v1");

274 
mu¡_g‘_cf_equ®
(&
’gše1
, 
cf
, 
b
"k2", b"v2");

277 
	gşu¡”
.
add_£nd_f‹r
(
IsŞ©iÚF‹rFaùÜy
::
Ãw
(1));

280 
i
 
	gš
 100..110 {

281 
Ët
 
	gkey
 = 
fÜm©
!("k{}", 
	gi
);

282 
Ët
 
	gv®ue
 = 
fÜm©
!("v{}", 
	gi
);

283 
	gşu¡”
.
mu¡_put_cf
(
cf
, 
key
.
as_by‹s
(), 
v®ue
.as_bytes());

286 
	gşu¡”
.
mu¡_d–‘e_cf
(
cf
, 
b
"k2");

289 
	gşu¡”
.
ş—r_£nd_f‹rs
();

292 
mu¡_g‘_cf_equ®
(&
’gše1
, 
cf
, 
b
"k1", b"v1");

293 
mu¡_g‘_cf_nÚe
(&
’gše1
, 
cf
, 
b
"k2");

296 
	gşu¡”
.
¡İ_node
(1);

297 
	gşu¡”
.
run_node
(1);

299 
	gşu¡”
.
mu¡_put_cf
(
cf
, 
b
"k3", b"v3");

300 
mu¡_g‘_cf_equ®
(&
’gše1
, 
cf
, 
b
"k3", b"v3");

303 #[
‹¡
]

304 
â
 
	$‹¡_node_cf_¢­shÙ
() {

305 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

306 
	`‹¡_cf_¢­shÙ
(&
mut
 
şu¡”
);

307 
	}
}

309 #[
‹¡
]

310 
â
 
	$‹¡_£rv”_¢­shÙ
() {

311 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

312 
	`‹¡_cf_¢­shÙ
(&
mut
 
şu¡”
);

313 
	}
}

316 
	sSËSÇp
 {

317 
	mfœ¡_¢­
: 
RwLock
<
O±iÚ
<
Mes§ge
>>,

318 
	m£Á
: 
Mu‹x
<
S’d”
<()>>,

321 
im¶
 
	gF‹r
<
	gRaáMes§ge
> 
	gArc
<
	gSËSÇp
> {

322 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
RaáMes§ge
>è-> 
ResuÉ
<()> {

323 
Ët
 
mut
 
»s
 = 
Vec
::
w™h_ÿ·c™y
(
msgs
.
Ën
());

324 
mut
 
m
 
š
 
	gmsgs
.
d¿š
(..) {

325 
	gm
.
g‘_mes§ge
().
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgSÇpshÙ
 &&

326 
m
.
g‘_to_³”
().
g‘_¡Üe_id
() == 3

328 
£lf
.
fœ¡_¢­
.
¾
().
is_nÚe
() {

329 *
£lf
.
fœ¡_¢­
.
wl
(èğ
Some
(
m
.
ke_mes§ge
());

332 
Ët
 
	gäom
 = 
m
.
g‘_mes§ge
().
g‘_äom
();

333 
Ët
 
	gto
 = 
m
.
g‘_mes§ge
().
g‘_to
();

334 
	gm
.
£t_mes§ge
(
£lf
.
fœ¡_¢­
.
¾
().
as_»f
().
unw¿p
().
şÚe
());

335 
	gm
.
mut_mes§ge
().
£t_äom
(
äom
);

336 
	gm
.
mut_mes§ge
().
£t_to
(
to
);

337 
Ët
 
	g_
 = 
£lf
.
£Á
.
lock
().
unw¿p
().
£nd
(());

340 
	g»s
.
push
(
m
);

342 *
	gmsgs
 = 
»s
;

343 
check_mes§ges
(
msgs
)

347 #[
‹¡
]

348 
â
 
	$‹¡_node_¡®e_¢­
() {

349 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

351 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_th»shŞd
 = 1000;

352 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_couÁ_lim™
 = 1000;

354 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
	`şÚe
();

356 
pd_ş›Á
.
	`di§bË_deçuÉ_ruË
();

358 
Ët
 
r1
 = 
şu¡”
.
	`run_cÚf_chªge
();

360 
pd_ş›Á
.
	`mu¡_add_³”
(
r1
, 
	`Ãw_³”
(2, 2));

361 
şu¡”
.
	`mu¡_put
(
b
"k1", b"v1");

362 
	`mu¡_g‘_equ®
(&
şu¡”
.
	`g‘_’gše
(2), 
b
"k1", b"v1");

364 
	`Ët
 (
tx
, 
rx
èğ
mpsc
::
	`chªÃl
();

365 
Ët
 
f‹r
 = 
SËSÇp
 {

366 
fœ¡_¢­
: 
RwLock
::(),

367 
£Á
: 
Mu‹x
::
	`Ãw
(
tx
),

369 
şu¡”
.
	`add_£nd_f‹r
(
	`ClÚeF‹rFaùÜy
(
Arc
::
	`Ãw
(
f‹r
)));

370 
pd_ş›Á
.
	`mu¡_add_³”
(
r1
, 
	`Ãw_³”
(3, 3));

371 
şu¡”
.
	`mu¡_put
(
b
"k2", b"v2");

372 
	`mu¡_g‘_equ®
(&
şu¡”
.
	`g‘_’gše
(3), 
b
"k2", b"v2");

373 
pd_ş›Á
.
	`mu¡_»move_³”
(
r1
, 
	`Ãw_³”
(3, 3));

374 
	`mu¡_g‘_nÚe
(&
şu¡”
.
	`g‘_’gše
(3), 
b
"k2");

375 
pd_ş›Á
.
	`mu¡_add_³”
(
r1
, 
	`Ãw_³”
(3, 4));

377 
şu¡”
.
	`mu¡_put
(
b
"k3", b"v3");

378 
	`mu¡_g‘_equ®
(&
şu¡”
.
	`g‘_’gše
(2), 
b
"k3", b"v3");

379 
rx
.
	`»cv
().
	`unw¿p
();

380 
	`¦“p_ms
(2000);

381 
	`mu¡_g‘_nÚe
(&
şu¡”
.
	`g‘_’gše
(3), 
b
"k3");

382 
şu¡”
.
	`ş—r_£nd_f‹rs
();

383 
	`mu¡_g‘_equ®
(&
şu¡”
.
	`g‘_’gše
(3), 
b
"k3", b"v3");

384 
	}
}

387 
pub
 
	sSÇpshÙAµ’dF‹r
 {

388 
	m¡®e
: 
AtomicBoŞ
,

389 
	m³ndšg_msg
: 
Mu‹x
<
Vec
<
Msg
>>,

390 
	mnÙif›r
: 
Mu‹x
<
S’d”
<()>>,

393 
im¶
 
	gSÇpshÙAµ’dF‹r
 {

394 
pub
 
â
 
Ãw
(
nÙif›r
: 
S’d”
<()>è-> 
SÇpshÙAµ’dF‹r
 {

395 
SÇpshÙAµ’dF‹r
 {

396 
¡®e
: 
AtomicBoŞ
::
Ãw
(
çl£
),

397 
	g³ndšg_msg
: 
Mu‹x
::
Ãw
(
vec
![]),

398 
	gnÙif›r
: 
Mu‹x
::
Ãw
(
nÙif›r
),

403 
im¶
 
	gF‹r
<
	gMsg
> 
	gSÇpshÙAµ’dF‹r
 {

404 
â
 
befÜe
(&
£lf
, 
msgs
: &
mut
 
Vec
<
Msg
>è-> 
ResuÉ
<()> {

405 
£lf
.
¡®e
.
lßd
(
Ord”šg
::
R–axed
) {

406  
Ok
(());

408 
Ët
 
mut
 
	gto_£nd
 = 
vec
![];

409 
Ët
 
mut
 
	g³ndšg_msg
 = 
£lf
.
³ndšg_msg
.
lock
().
unw¿p
();

410 
Ët
 
mut
 
	g¡®e
 = 
çl£
;

411 
m
 
š
 
	gmsgs
.
d¿š
(..) {

412 
Ët
 
mut
 
	gshould_cŞËù
 = 
çl£
;

413 
Ët
 
	gMsg
::
RaáMes§ge
(
»f
 
msg
èğ
m
 {

414 
should_cŞËù
 =

415 !
¡®e
 && 
msg
.
g‘_mes§ge
().
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgSÇpshÙ
;

416 
	g¡®e
 = !
³ndšg_msg
.
is_em±y
() &&

417 
msg
.
g‘_mes§ge
().
g‘_msg_ty³
(è=ğ
Mes§geTy³
::
MsgAµ’d
;

419 
	gshould_cŞËù
 {

420 
	g³ndšg_msg
.
push
(
m
);

421 
	g£lf
.
	gnÙif›r
.
lock
().
unw¿p
().
£nd
(()).unwrap();

423 
	g¡®e
 {

424 
	gto_£nd
.
ex‹nd
(
³ndšg_msg
.
d¿š
(..));

426 
	gto_£nd
.
push
(
m
);

429 
	g£lf
.
	g¡®e
.
¡Üe
(
¡®e
, 
Ord”šg
::
SeqC¡
);

430 
	gmsgs
.
ex‹nd
(
to_£nd
);

431 
Ok
(())

435 
â
 
	g‹¡_¢­shÙ_w™h_­³nd
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

437 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(20);

438 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_couÁ_lim™
 = 2;

439 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¢­_mgr_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(50);

441 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

443 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

444 
	gşu¡”
.
run
();

446 
	gpd_ş›Á
.
mu¡_»move_³”
(1, 
Ãw_³”
(4, 4));

448 
Ët
 (
tx
, 
rx
èğ
mpsc
::
chªÃl
();

449 
	gşu¡”


450 .
	gsim


451 .
wl
()

452 .
add_»cv_f‹r
(4, 
box
 
SÇpshÙAµ’dF‹r
::
Ãw
(
tx
));

453 
	gpd_ş›Á
.
add_³”
(1, 
Ãw_³”
(4, 5));

454 
	grx
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

455 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

456 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

457 
Ët
 
	g’gše4
 = 
şu¡”
.
g‘_’gše
(4);

458 
mu¡_g‘_equ®
(&
’gše4
, 
b
"k1", b"v1");

459 
mu¡_g‘_equ®
(&
’gše4
, 
b
"k2", b"v2");

462 #[
‹¡
]

463 
â
 
	$‹¡_node_¢­shÙ_w™h_­³nd
() {

464 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 4);

465 
	`‹¡_¢­shÙ_w™h_­³nd
(&
mut
 
şu¡”
);

466 
	}
}

468 #[
‹¡
]

469 
â
 
	$‹¡_£rv”_¢­shÙ_w™h_­³nd
() {

470 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 4);

471 
	`‹¡_¢­shÙ_w™h_­³nd
(&
mut
 
şu¡”
);

472 
	}
}

	@tests/raftstore_cases/test_split_region.rs

14 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

15 
u£
 
	g¡d
::{
fs
, 
	gth»ad
};

16 
u£
 
	g¡d
::
sync
::
mpsc
::
chªÃl
;

17 
u£
 
	g¿nd
::{
£lf
, 
	gRng
};

19 
u£
 
	gkv´Ùo
::
m‘­b
;

20 
u£
 
	gkv´Ùo
::
”aápb
::
Mes§geTy³
;

21 
u£
 
	gkv´Ùo
::
¿á_cmdpb
::
RaáCmdRe¥Ú£
;

23 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

24 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

25 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

26 
u£
 
	gsu³r
::
ut
;

27 
u£
 
	gtikv
::
pd
::
PdCl›Á
;

28 
u£
 
	gtikv
::
¡Üage
::{
CF_DEFAULT
, 
	gCF_WRITE
};

29 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
keys
::
d©a_key
;

30 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
’gše
::
I‹¿bË
;

31 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

32 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

34 
pub
 cÚ¡ 
	gREGION_MAX_SIZE
: 
u64
 = 50000;

35 
pub
 cÚ¡ 
	gREGION_SPLIT_SIZE
: 
u64
 = 30000;

37 
â
 
	g‹¡_ba£_¥l™_»giÚ
<
	gT
, 
	gF
>(
	gşu¡”
: &
mut
 
Clu¡”
<
T
>, 
	g¥l™
: 
F
, 
	gright_d”ive
: 
boŞ
)

38 
wh”e


39 
T
: 
SimuÏtÜ
,

40 
	gF
: 
Fn
(&
mut
 
Clu¡”
<
T
>, &
m‘­b
::
RegiÚ
, &[
u8
]),

42 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	gright_d”ive_wh’_¥l™
 = 
right_d”ive
;

43 
	gşu¡”
.
run
();

45 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

47 
Ët
 
	gtbls
 = 
vec
![

48 (
b
"k22", b"k11", b"k33"),

49 (
b
"k11", b"k00", b"k11"),

50 (
b
"k33", b"k22", b"k33"),

53 
	g¥l™_key
, 
	gËá_key
, 
	gright_key
è
š
 
	gtbls
 {

54 
	gşu¡”
.
mu¡_put
(
Ëá_key
, 
b
"v1");

55 
	gşu¡”
.
mu¡_put
(
right_key
, 
b
"v3");

58 
Ët
 
	g»giÚ
 = 
pd_ş›Á
.
g‘_»giÚ
(
Ëá_key
).
unw¿p
();

59 
Ët
 
	g»giÚ2
 = 
pd_ş›Á
.
g‘_»giÚ
(
right_key
).
unw¿p
();

60 
	gas£¹_eq
!(
	g»giÚ
.
g‘_id
(), 
	g»giÚ2
.get_id());

63 
¥l™
(
şu¡”
, &
»giÚ
, 
¥l™_key
);

65 
Ët
 
	gËá
 = 
pd_ş›Á
.
g‘_»giÚ
(
Ëá_key
).
unw¿p
();

66 
Ët
 
	gright
 = 
pd_ş›Á
.
g‘_»giÚ
(
right_key
).
unw¿p
();

68 
	gas£¹_eq
!(

69 
	g»giÚ
.
g‘_id
(),

70 
	gright_d”ive
 {

71 
	gright
.
g‘_id
()

73 
	gËá
.
g‘_id
()

76 
	gas£¹_eq
!(
	g»giÚ
.
g‘_¡¬t_key
(), 
	gËá
.get_start_key());

77 
	gas£¹_eq
!(
	gËá
.
g‘_’d_key
(), 
	gright
.
g‘_¡¬t_key
());

78 
	gas£¹_eq
!(
	g»giÚ
.
g‘_’d_key
(), 
	gright
.get_end_key());

80 
	gşu¡”
.
mu¡_put
(
Ëá_key
, 
b
"vv1");

81 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
Ëá_key
).
unw¿p
(), 
	gb
"vv1".
to_vec
());

83 
	gşu¡”
.
mu¡_put
(
right_key
, 
b
"vv3");

84 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
right_key
).
unw¿p
(), 
	gb
"vv3".
to_vec
());

86 
Ët
 
	g•och
 = 
Ëá
.
g‘_»giÚ_•och
().
şÚe
();

87 
Ët
 
	gg‘
 = 
ut
::
Ãw_»que¡
(

88 
Ëá
.
g‘_id
(),

89 
•och
,

90 
vec
![
ut
::
Ãw_g‘_cmd
(
right_key
)],

91 
çl£
,

93 
	gdebug
!("»que¡šg {:?}", 
	gg‘
);

94 
Ët
 
	g»¥
 = 
şu¡”


95 .
ÿÎ_commªd_Ú_Ëad”
(
g‘
, 
Du¿tiÚ
::
äom_£cs
(5))

96 .
unw¿p
();

97 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
has_”rÜ
(), "{:?}",„esp);

98 
	gas£¹
!(

99 
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_key_nÙ_š_»giÚ
(),

101 
	g»¥


107 #[
‹¡
]

108 
â
 
	$‹¡_node_ba£_¥l™_»giÚ_Ëá_d”ive
() {

109 
Ët
 
couÁ
 = 5;

110 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

111 
	`‹¡_ba£_¥l™_»giÚ
(&
mut
 
şu¡”
, 
Clu¡”
::
mu¡_¥l™
, 
çl£
);

112 
	}
}

114 #[
‹¡
]

115 
â
 
	$‹¡_node_ba£_¥l™_»giÚ_right_d”ive
() {

116 
Ët
 
couÁ
 = 5;

117 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

118 
	`‹¡_ba£_¥l™_»giÚ
(&
mut
 
şu¡”
, 
Clu¡”
::
mu¡_¥l™
, 
Œue
);

119 
	}
}

121 #[
‹¡
]

122 
â
 
	$‹¡_£rv”_ba£_¥l™_»giÚ_Ëá_d”ive
() {

123 
Ët
 
couÁ
 = 5;

124 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

125 
	`‹¡_ba£_¥l™_»giÚ
(&
mut
 
şu¡”
, 
Clu¡”
::
mu¡_¥l™
, 
çl£
);

126 
	}
}

128 #[
‹¡
]

129 
â
 
	$‹¡_£rv”_ba£_¥l™_»giÚ_right_d”ive
() {

130 
Ët
 
couÁ
 = 5;

131 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

132 
	`‹¡_ba£_¥l™_»giÚ
(&
mut
 
şu¡”
, 
Clu¡”
::
mu¡_¥l™
, 
Œue
);

133 
	}
}

135 #[
‹¡
]

136 
â
 
	$‹¡_£rv”_¥l™_»giÚ_twiû
() {

137 
Ët
 
couÁ
 = 5;

138 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

139 
şu¡”
.
	`run
();

140 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
	`şÚe
();

142 
	`Ët
 (
¥l™_key
, 
Ëá_key
, 
right_key
èğ(
b
"k22", b"k11", b"k33");

143 
şu¡”
.
	`mu¡_put
(
Ëá_key
, 
b
"v1");

144 
şu¡”
.
	`mu¡_put
(
right_key
, 
b
"v3");

147 
Ët
 
»giÚ
 = 
pd_ş›Á
.
	`g‘_»giÚ
(
Ëá_key
).
	`unw¿p
();

148 
Ët
 
»giÚ2
 = 
pd_ş›Á
.
	`g‘_»giÚ
(
right_key
).
	`unw¿p
();

149 
as£¹_eq
!(
»giÚ
.
	`g‘_id
(), 
»giÚ2
.get_id());

151 
	`Ët
 (
tx
, 
rx
èğ
	`chªÃl
();

152 
Ët
 
key
 = 
¥l™_key
.
	`to_vec
();

153 
Ët
 
c
 = 
Box
::
	`Ãw
(
move
 |
mut
 
»¥
: 
RaáCmdRe¥Ú£
| {

154 
Ët
 
admš_»¥
 = 
»¥
.
	`mut_admš_»¥Ú£
();

155 
Ët
 
¥l™_»¥
 = 
admš_»¥
.
	`mut_¥l™
();

156 
Ët
 
Ëá
 = 
¥l™_»¥
.
	`ke_Ëá
();

157 
Ët
 
right
 = 
¥l™_»¥
.
	`ke_right
();

158 
as£¹_eq
!(
Ëá
.
	`g‘_’d_key
(), 
key
.
	`as_¦iû
());

159 
as£¹_eq
!(
»giÚ2
.
	`g‘_¡¬t_key
(), 
Ëá
.get_start_key());

160 
as£¹_eq
!(
Ëá
.
	`g‘_’d_key
(), 
right
.
	`g‘_¡¬t_key
());

161 
as£¹_eq
!(
»giÚ2
.
	`g‘_’d_key
(), 
right
.get_end_key());

162 
tx
.
	`£nd
(
right
).
	`unw¿p
();

164 
şu¡”
.
	`¥l™_»giÚ
(&
»giÚ
, 
¥l™_key
, 
c
);

165 
Ët
 
»giÚ3
 = 
rx
.
	`»cv_timeout
(
Du¿tiÚ
::
	`äom_£cs
(5)).
	`unw¿p
();

167 
şu¡”
.
	`mu¡_put
(
¥l™_key
, 
b
"v2");

169 
	`Ët
 (
tx1
, 
rx1
èğ
	`chªÃl
();

170 
Ët
 
c
 = 
Box
::
	`Ãw
(
move
 |
»¥
: 
RaáCmdRe¥Ú£
| {

171 
as£¹
!(
»¥
.
	`has_h—d”
());

172 
as£¹
!(
»¥
.
	`g‘_h—d”
().
	`has_”rÜ
());

173 
as£¹
!(!
»¥
.
	`has_admš_»¥Ú£
());

174 
tx1
.
	`£nd
(()).
	`unw¿p
();

176 
şu¡”
.
	`¥l™_»giÚ
(&
»giÚ3
, 
¥l™_key
, 
c
);

177 
rx1
.
	`»cv_timeout
(
Du¿tiÚ
::
	`äom_£cs
(5)).
	`unw¿p
();

178 
	}
}

181 
â
 
	gput_tl_size
<
	gT
: 
SimuÏtÜ
>(

182 
şu¡”
: &
mut
 
Clu¡”
<
T
>,

183 
	glim™
: 
u64
,

184 
	g¿nge
: &
mut
 
I‹¿tÜ
<
I‹m
 = 
u64
>,

185 è-> 
	gVec
<
	gu8
> {

186 
put_cf_tl_size
(
şu¡”
, 
CF_DEFAULT
, 
lim™
, 
¿nge
)

189 
â
 
	gput_cf_tl_size
<
	gT
: 
SimuÏtÜ
>(

190 
şu¡”
: &
mut
 
Clu¡”
<
T
>,

191 
	gcf
: &'static str,

192 
lim™
: 
u64
,

193 
	g¿nge
: &
mut
 
I‹¿tÜ
<
I‹m
 = 
u64
>,

194 è-> 
	gVec
<
	gu8
> {

195 
	gas£¹
!(
	glim™
 > 0);

196 
Ët
 
mut
 
	gËn
 = 0;

197 
Ët
 
mut
 
	gºg
 = 
¿nd
::
th»ad_ºg
();

198 
Ët
 
mut
 
	gkey
 = 
vec
![];

199 
	gËn
 < 
	glim™
 {

200 
Ët
 
	gkey_id
 = 
¿nge
.
Ãxt
().
unw¿p
();

201 
Ët
 
	gkey_¡r
 = 
fÜm©
!("{:09}", 
	gkey_id
);

202 
	gkey
 = 
key_¡r
.
što_by‹s
();

203 
Ët
 
mut
 
	gv®ue
 = 
vec
![0; 64];

204 
	gºg
.
fl_by‹s
(&
mut
 
v®ue
);

205 
	gşu¡”
.
mu¡_put_cf
(
cf
, &
key
, &
v®ue
);

207 
	gËn
 +ğ
key
.
Ën
(è
as
 
u64
 + 1;

208 
	gËn
 +ğ
v®ue
.
Ën
(è
as
 
u64
;

212 
	gşu¡”
.
mu¡_æush
(
Œue
);

213 
	gkey


216 
â
 
	g‹¡_auto_¥l™_»giÚ
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

217 
şu¡”
.
cfg
.
¿á_¡Üe
.
¥l™_»giÚ_check_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(100);

218 
	gşu¡”
.
	gcfg
.
	gcİroûssÜ
.
	g»giÚ_max_size
 = 
R—dabËSize
(
REGION_MAX_SIZE
);

219 
	gşu¡”
.
	gcfg
.
	gcİroûssÜ
.
	g»giÚ_¥l™_size
 = 
R—dabËSize
(
REGION_SPLIT_SIZE
);

221 
Ët
 
	gcheck_size_diff
 = 
şu¡”
.
cfg
.
¿á_¡Üe
.
»giÚ_¥l™_check_diff
.0;

222 
Ët
 
mut
 
	g¿nge
 = 1..;

224 
	gşu¡”
.
run
();

226 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

228 
Ët
 
	g»giÚ
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"").
unw¿p
();

230 
Ët
 
	gÏ¡_key
 = 
put_tl_size
(
şu¡”
, 
REGION_SPLIT_SIZE
, &
mut
 
¿nge
);

233 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_£cs
(1));

235 
Ët
 
	grg‘
 = 
pd_ş›Á
.
g‘_»giÚ
(&
Ï¡_key
).
unw¿p
();

237 
	gas£¹_eq
!(
	g»giÚ
, 
	grg‘
);

239 
Ët
 
	gmax_key
 = 
put_cf_tl_size
(

240 
şu¡”
,

241 
CF_WRITE
,

242 
REGION_MAX_SIZE
 - 
REGION_SPLIT_SIZE
 + 
check_size_diff
,

243 &
mut
 
¿nge
,

246 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_£cs
(1));

248 
Ët
 
	gËá
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"").
unw¿p
();

249 
Ët
 
	gright
 = 
pd_ş›Á
.
g‘_»giÚ
(&
max_key
).
unw¿p
();

251 
	gas£¹_Ã
!(
	gËá
, 
	gright
);

252 
	gas£¹_eq
!(
	g»giÚ
.
g‘_¡¬t_key
(), 
	gËá
.get_start_key());

253 
	gas£¹_eq
!(
	gright
.
g‘_¡¬t_key
(), 
	gËá
.
g‘_’d_key
());

254 
	gas£¹_eq
!(
	g»giÚ
.
g‘_’d_key
(), 
	gright
.get_end_key());

255 
	gas£¹_eq
!(
	gpd_ş›Á
.
g‘_»giÚ
(&
max_key
).
unw¿p
(), 
	gright
);

256 
	gas£¹_eq
!(
	gpd_ş›Á
.
g‘_»giÚ
(
Ëá
.
g‘_’d_key
()).
unw¿p
(), 
	gright
);

258 
Ët
 
	gmiddË_key
 = 
Ëá
.
g‘_’d_key
();

259 
Ët
 
	gËad”
 = 
şu¡”
.
Ëad”_of_»giÚ
(
Ëá
.
g‘_id
()).
unw¿p
();

260 
Ët
 
	g¡Üe_id
 = 
Ëad”
.
g‘_¡Üe_id
();

261 
Ët
 
mut
 
	gsize
 = 0;

262 
	gşu¡”
.
	g’gšes
[&
¡Üe_id
]

263 .
	gkv_’gše


264 .
sÿn
(&
d©a_key
(
b
""), &d©a_key(
middË_key
), 
çl£
, &
mut
 |
k
, 
v
| {

265 
size
 +ğ
k
.
Ën
(è
as
 
u64
;

266 
size
 +ğ
v
.
Ën
(è
as
 
u64
;

267 
Ok
(
Œue
)

269 .
ex³ù
("");

270 
	gas£¹
!(
	gsize
 <ğ
REGION_SPLIT_SIZE
);

273 
	gas£¹
!(
	gsize
 > 
	gREGION_SPLIT_SIZE
 - 1000);

275 
Ët
 
	g•och
 = 
Ëá
.
g‘_»giÚ_•och
().
şÚe
();

276 
Ët
 
	gg‘
 = 
ut
::
Ãw_»que¡
(

277 
Ëá
.
g‘_id
(),

278 
•och
,

279 
vec
![
ut
::
Ãw_g‘_cmd
(&
max_key
)],

280 
çl£
,

282 
Ët
 
	g»¥
 = 
şu¡”


283 .
ÿÎ_commªd_Ú_Ëad”
(
g‘
, 
Du¿tiÚ
::
äom_£cs
(5))

284 .
unw¿p
();

285 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
has_”rÜ
());

286 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_key_nÙ_š_»giÚ
());

289 #[
‹¡
]

290 
â
 
	$‹¡_node_auto_¥l™_»giÚ
() {

291 
Ët
 
couÁ
 = 5;

292 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

293 
	`‹¡_auto_¥l™_»giÚ
(&
mut
 
şu¡”
);

294 
	}
}

296 #[
‹¡
]

297 
â
 
	$‹¡_£rv”_auto_¥l™_»giÚ
() {

298 
Ët
 
couÁ
 = 5;

299 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

300 
	`‹¡_auto_¥l™_»giÚ
(&
mut
 
şu¡”
);

301 
	}
}

303 
â
 
	g‹¡_d–ay_¥l™_»giÚ
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

305 
şu¡”
.
run
();

307 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

309 
Ët
 
	g»giÚ
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"").
unw¿p
();

311 
Ët
 
	gk1
 = 
b
"k1";

312 
	gşu¡”
.
mu¡_put
(
k1
, 
b
"v1");

314 
Ët
 
	gk3
 = 
b
"k3";

315 
	gşu¡”
.
mu¡_put
(
k3
, 
b
"v3");

318 
i
 
	gš
 0..3 {

319 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_’gše
(
i
 + 1);

320 
	gut
::
mu¡_g‘_equ®
(&
’gše
, 
k1
, 
b
"v1");

321 
	gut
::
mu¡_g‘_equ®
(&
’gše
, 
k3
, 
b
"v3");

324 
Ët
 
	gËad”
 = 
şu¡”
.
Ëad”_of_»giÚ
(
»giÚ
.
g‘_id
()).
unw¿p
();

327 
Ët
 
	gšdex
 = (1..4).
fšd
(|&
x
| x !ğ
Ëad”
.
g‘_¡Üe_id
()).
unw¿p
();

328 
	gşu¡”
.
¡İ_node
(
šdex
);

330 
Ët
 
	gk2
 = 
b
"k2";

331 
	gşu¡”
.
mu¡_¥l™
(&
»giÚ
, 
k2
);

336 
	gşu¡”
.
run_node
(
šdex
);

340 
	gut
::
¦“p_ms
(3000);

342 
Ët
 
	gk4
 = 
b
"k4";

343 
	gşu¡”
.
mu¡_put
(
k4
, 
b
"v4");

345 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
k4
).
unw¿p
(), 
	gb
"v4".
to_vec
());

347 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_’gše
(
šdex
);

348 
	gut
::
mu¡_g‘_equ®
(&
’gše
, 
k4
, 
b
"v4");

351 #[
‹¡
]

352 
â
 
	$‹¡_node_d–ay_¥l™_»giÚ
() {

353 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

354 
	`‹¡_d–ay_¥l™_»giÚ
(&
mut
 
şu¡”
);

355 
	}
}

357 #[
‹¡
]

358 
â
 
	$‹¡_£rv”_d–ay_¥l™_»giÚ
() {

359 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

360 
	`‹¡_d–ay_¥l™_»giÚ
(&
mut
 
şu¡”
);

361 
	}
}

363 
â
 
	g‹¡_¥l™_ov”Ïp_¢­shÙ
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

365 
şu¡”
.
run
();

368 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
ut
::
Ãw_³”
(1, 1));

369 
	gşu¡”
.
mu¡_put
(
b
"k0", b"v0");

370 
	gas£¹_eq
!(
	gşu¡”
.
Ëad”_of_»giÚ
(1), 
Some
(
ut
::
Ãw_³”
(1, 1)));

372 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

375 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(
RegiÚPack‘F‹r
::
Ãw
(1, 3)));

376 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

378 
Ët
 
	g»giÚ
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"").
unw¿p
();

381 
	gşu¡”
.
mu¡_¥l™
(&
»giÚ
, 
b
"k2");

383 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

386 
i
 
	gš
 1..3 {

387 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_’gše
(
i
);

388 
	gut
::
mu¡_g‘_equ®
(&
’gše
, 
b
"k2", b"v2");

391 
Ët
 
	g’gše3
 = 
şu¡”
.
g‘_’gše
(3);

392 
	gut
::
mu¡_g‘_nÚe
(&
’gše3
, 
b
"k2");

394 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_£cs
(1));

395 
Ët
 
	g¢­_dœ
 = 
şu¡”
.
g‘_¢­_dœ
(3);

397 
Ët
 
	g¢­fes
: 
Vec
<
_
> = 
fs
::
»ad_dœ
(
¢­_dœ
)

398 .
unw¿p
()

399 .
m­
(|
p
|….
unw¿p
().
·th
())

400 .
cŞËù
();

401 
	gas£¹
!(
	g¢­fes
.
is_em±y
());

403 
	gşu¡”
.
ş—r_£nd_f‹rs
();

404 
	gşu¡”
.
mu¡_put
(
b
"k3", b"v3");

406 
	gut
::
¦“p_ms
(3000);

408 
	gut
::
mu¡_g‘_equ®
(&
’gše3
, 
b
"k3", b"v3");

411 #[
‹¡
]

412 
â
 
	$‹¡_node_¥l™_ov”Ïp_¢­shÙ
() {

413 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

414 
	`‹¡_¥l™_ov”Ïp_¢­shÙ
(&
mut
 
şu¡”
);

415 
	}
}

417 #[
‹¡
]

418 
â
 
	$‹¡_£rv”_¥l™_ov”Ïp_¢­shÙ
() {

419 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

420 
	`‹¡_¥l™_ov”Ïp_¢­shÙ
(&
mut
 
şu¡”
);

421 
	}
}

423 
â
 
	g‹¡_­¶y_Ãw_v”siÚ_¢­shÙ
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

425 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(20);

426 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_couÁ_lim™
 = 5;

427 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_th»shŞd
 = 5;

430 
	gşu¡”
.
run
();

433 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
ut
::
Ãw_³”
(1, 1));

434 
	gşu¡”
.
mu¡_put
(
b
"k0", b"v0");

435 
	gas£¹_eq
!(
	gşu¡”
.
Ëad”_of_»giÚ
(1), 
Some
(
ut
::
Ãw_³”
(1, 1)));

437 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

440 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(
RegiÚPack‘F‹r
::
Ãw
(1, 3)));

441 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

443 
Ët
 
	g»giÚ
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"").
unw¿p
();

446 
	gşu¡”
.
mu¡_¥l™
(&
»giÚ
, 
b
"k2");

447 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

450 
i
 
	gš
 1..3 {

451 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_’gše
(
i
);

452 
	gut
::
mu¡_g‘_equ®
(&
’gše
, 
b
"k2", b"v2");

455 
Ët
 
	g’gše3
 = 
şu¡”
.
g‘_’gše
(3);

456 
	gut
::
mu¡_g‘_nÚe
(&
’gše3
, 
b
"k2");

459 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
ut
::
Ãw_³”
(2, 2));

461 
_
 
	gš
 0..100 {

463 
	gşu¡”
.
g‘
(
b
"k1").
unw¿p
();

464 
	gşu¡”
.
g‘
(
b
"k2").
unw¿p
();

467 
	gşu¡”
.
ş—r_£nd_f‹rs
();

469 
	gut
::
¦“p_ms
(3000);

471 
	gut
::
mu¡_g‘_equ®
(&
’gše3
, 
b
"k1", b"v1");

472 
	gut
::
mu¡_g‘_equ®
(&
’gše3
, 
b
"k2", b"v2");

475 #[
‹¡
]

476 
â
 
	$‹¡_node_­¶y_Ãw_v”siÚ_¢­shÙ
() {

477 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

478 
	`‹¡_­¶y_Ãw_v”siÚ_¢­shÙ
(&
mut
 
şu¡”
);

479 
	}
}

481 #[
‹¡
]

482 
â
 
	$‹¡_£rv”_­¶y_Ãw_v”siÚ_¢­shÙ
() {

483 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

484 
	`‹¡_­¶y_Ãw_v”siÚ_¢­shÙ
(&
mut
 
şu¡”
);

485 
	}
}

487 
â
 
	g‹¡_¥l™_w™h_¡®e_³”
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

489 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
£cs
(60);

491 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

493 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

495 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

498 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
ut
::
Ãw_³”
(2, 2));

501 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
ut
::
Ãw_³”
(3, 3));

503 
	gşu¡”
.
mu¡_put
(
b
"k0", b"v0");

505 
Ët
 
	g’gše3
 = 
şu¡”
.
g‘_’gše
(3);

506 
	gut
::
mu¡_g‘_equ®
(&
’gše3
, 
b
"k0", b"v0");

509 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
r1
, 
ut
::
Ãw_³”
(1, 1));

513 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

514 
RegiÚPack‘F‹r
::
Ãw
(1, 3).
msg_ty³
(
Mes§geTy³
::
MsgAµ’d
),

517 
Ët
 
	g»giÚ
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"").
unw¿p
();

520 
	gşu¡”
.
mu¡_¥l™
(&
»giÚ
, 
b
"k2");

521 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

523 
Ët
 
	g»giÚ2
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"k2").
unw¿p
();

526 
Ët
 
	g³”3
 = 
ut
::
fšd_³”
(&
»giÚ2
, 3).
unw¿p
();

527 
	gpd_ş›Á
.
mu¡_»move_³”
(
»giÚ2
.
g‘_id
(), 
³”3
.
şÚe
());

532 
	gşu¡”
.
ş—r_£nd_f‹rs
();

533 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

536 
	gut
::
mu¡_g‘_equ®
(&
’gše3
, 
b
"k1", b"v1");

539 
	gşu¡”
.
mu¡_¥l™
(&
»giÚ2
, 
b
"k3");

540 
Ët
 
	g»giÚ3
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"k3").
unw¿p
();

542 
	gas£¹_eq
!(
	g»giÚ3
.
g‘_³”s
().
Ën
(), 2);

543 
	gas£¹
!(
	gut
::
fšd_³”
(&
»giÚ3
, 3).
is_nÚe
());

545 
Ët
 
	gÃw_³”_id
 = 
pd_ş›Á
.
®loc_id
().
unw¿p
();

547 
	gpd_ş›Á
.
mu¡_add_³”
(
»giÚ3
.
g‘_id
(), 
ut
::
Ãw_³”
(3, 
Ãw_³”_id
));

549 
	gşu¡”
.
mu¡_put
(
b
"k3", b"v3");

551 
	gut
::
mu¡_g‘_equ®
(&
’gše3
, 
b
"k3", b"v3");

554 #[
‹¡
]

555 
â
 
	$‹¡_node_¥l™_w™h_¡®e_³”
() {

556 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

557 
	`‹¡_¥l™_w™h_¡®e_³”
(&
mut
 
şu¡”
);

558 
	}
}

560 #[
‹¡
]

561 
â
 
	$‹¡_£rv”_¥l™_w™h_¡®e_³”
() {

562 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

563 
	`‹¡_¥l™_w™h_¡®e_³”
(&
mut
 
şu¡”
);

564 
	}
}

566 
â
 
	g‹¡_¥l™_»giÚ_diff_check
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

567 
Ët
 
»giÚ_max_size
 = 2000;

568 
Ët
 
	g»giÚ_¥l™_size
 = 1000;

569 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¥l™_»giÚ_check_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(100);

570 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g»giÚ_¥l™_check_diff
 = 
R—dabËSize
(10);

571 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
£cs
(20);

572 
	gşu¡”
.
	gcfg
.
	gcİroûssÜ
.
	g»giÚ_max_size
 = 
R—dabËSize
(
»giÚ_max_size
);

573 
	gşu¡”
.
	gcfg
.
	gcİroûssÜ
.
	g»giÚ_¥l™_size
 = 
R—dabËSize
(
»giÚ_¥l™_size
);

575 
Ët
 
mut
 
	g¿nge
 = 1..;

577 
	gşu¡”
.
run
();

579 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

583 
_
 
	gš
 0..10 {

584 
put_tl_size
(
şu¡”
, 
»giÚ_max_size
, &
mut
 
¿nge
);

591 
Ët
 
	gmš_»giÚ_út
 = (
»giÚ_max_size
 * 10 -„egiÚ_max_sizeè/ 
»giÚ_¥l™_size
 + 2;

593 
Ët
 
mut
 
	gŒy_út
 = 0;

594 
	gloİ
 {

595 
	gut
::
¦“p_ms
(20);

596 
Ët
 
	g»giÚ_út
 = 
pd_ş›Á
.
g‘_¥l™_couÁ
() + 1;

597 
	g»giÚ_út
 >ğ
mš_»giÚ_út
 
as
 
usize
 {

600 
	gŒy_út
 += 1;

601 
	gŒy_út
 == 500 {

602 
·nic
!(

604 
mš_»giÚ_út
,

605 
»giÚ_út


611 #[
‹¡
]

612 
â
 
	$‹¡_£rv”_¥l™_»giÚ_diff_check
() {

613 
Ët
 
couÁ
 = 1;

614 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

615 
	`‹¡_¥l™_»giÚ_diff_check
(&
mut
 
şu¡”
);

616 
	}
}

618 #[
‹¡
]

619 
â
 
	$‹¡_node_¥l™_»giÚ_diff_check
() {

620 
Ët
 
couÁ
 = 1;

621 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

622 
	`‹¡_¥l™_»giÚ_diff_check
(&
mut
 
şu¡”
);

623 
	}
}

625 
â
 
	g‹¡_¥l™_¡®e_•och
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>, 
	gright_d”ive
: 
boŞ
) {

626 
şu¡”
.
cfg
.
¿á_¡Üe
.
right_d”ive_wh’_¥l™
 = 
right_d”ive
;

627 
	gşu¡”
.
run
();

628 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

629 
Ët
 
	gŞd
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"k1").
unw¿p
();

631 
Ët
 
	gg‘
 = 
ut
::
Ãw_»que¡
(

632 
Şd
.
g‘_id
(),

633 
Şd
.
g‘_»giÚ_•och
().
şÚe
(),

634 
vec
![
ut
::
Ãw_g‘_cmd
(
b
"k1")],

635 
çl£
,

637 
	gşu¡”
.
mu¡_¥l™
(&
Şd
, 
b
"k2");

638 
Ët
 
	gËá
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"k1").
unw¿p
();

639 
Ët
 
	gright
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"k3").
unw¿p
();

641 
Ët
 
	g»¥
 = 
şu¡”


642 .
ÿÎ_commªd_Ú_Ëad”
(
g‘
, 
Du¿tiÚ
::
äom_£cs
(5))

643 .
unw¿p
();

644 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
has_”rÜ
());

645 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_¡®e_•och
());

646 
	gright_d”ive
 {

647 
	gas£¹_eq
!(

648 
	g»¥
.
g‘_h—d”
()

649 .
g‘_”rÜ
()

650 .
g‘_¡®e_•och
()

651 .
g‘_Ãw_»giÚs
(),

652 &[
right
, 
Ëá
]

655 
	gas£¹_eq
!(

656 
	g»¥
.
g‘_h—d”
()

657 .
g‘_”rÜ
()

658 .
g‘_¡®e_•och
()

659 .
g‘_Ãw_»giÚs
(),

660 &[
Ëá
, 
right
]

665 #[
‹¡
]

666 
â
 
	$‹¡_£rv”_¥l™_¡®e_•och_Ëá_d”ive
() {

667 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

668 
	`‹¡_¥l™_¡®e_•och
(&
mut
 
şu¡”
, 
çl£
);

669 
	}
}

671 #[
‹¡
]

672 
â
 
	$‹¡_£rv”_¥l™_¡®e_•och_right_d”ive
() {

673 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

674 
	`‹¡_¥l™_¡®e_•och
(&
mut
 
şu¡”
, 
Œue
);

675 
	}
}

677 #[
‹¡
]

678 
â
 
	$‹¡_node_¥l™_¡®e_•och_Ëá_d”ive
() {

679 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

680 
	`‹¡_¥l™_¡®e_•och
(&
mut
 
şu¡”
, 
çl£
);

681 
	}
}

683 #[
‹¡
]

684 
â
 
	$‹¡_node_¥l™_¡®e_•och_right_d”ive
() {

685 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

686 
	`‹¡_¥l™_¡®e_•och
(&
mut
 
şu¡”
, 
Œue
);

687 
	}
}

693 
â
 
	g‹¡_quick_–eùiÚ_aá”_¥l™
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

695 
Ët
 
»£rved_time
 = 
Du¿tiÚ
::
äom_mlis
(

696 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_ba£_tick_š‹rv®
.
as_mlis
() * 2,

699 
	gşu¡”
.
run
();

700 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

701 
	gşu¡”
.
mu¡_put
(
b
"k3", b"v3");

702 
Ët
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
b
"k1");

703 
Ët
 
	gŞd_Ëad”
 = 
şu¡”
.
Ëad”_of_»giÚ
(
»giÚ
.
g‘_id
()).
unw¿p
();

705 
	gşu¡”
.
mu¡_¥l™
(&
»giÚ
, 
b
"k2");

708 
	gth»ad
::
¦“p
(
»£rved_time
);

711 
Ët
 
	gÃw_»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
b
"k3");

714 
Ët
 
	gÃw_Ëad”
 = 
şu¡”
.
qu”y_Ëad”
(
Şd_Ëad”
.
g‘_¡Üe_id
(), 
Ãw_»giÚ
.
g‘_id
());

715 
	gas£¹
!(
	gÃw_Ëad”
.
is_some
());

718 #[
‹¡
]

719 
â
 
	$‹¡_node_quick_–eùiÚ_aá”_¥l™
() {

720 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

721 
	`‹¡_quick_–eùiÚ_aá”_¥l™
(&
mut
 
şu¡”
);

722 
	}
}

724 #[
‹¡
]

725 
â
 
	$‹¡_£rv”_quick_–eùiÚ_aá”_¥l™
() {

726 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

727 
	`‹¡_quick_–eùiÚ_aá”_¥l™
(&
mut
 
şu¡”
);

728 
	}
}

	@tests/raftstore_cases/test_stale_peer.rs

16 
u£
 
	gkv´Ùo
::
”aápb
::
Mes§geTy³
;

17 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
P“rS‹
, 
	gRegiÚLoÿlS‹
};

18 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::{
keys
, 
	gP“kabË
};

19 
u£
 
	gtikv
::
¡Üage
::
CF_RAFT
;

21 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

22 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

23 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

24 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

25 
u£
 
	gsu³r
::
ut
::*;

43 
â
 
	g‹¡_¡®e_³”_out_of_»giÚ
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

44 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

46 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

48 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

49 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

50 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

51 
Ët
 (
key
, 
v®ue
èğ(
b
"k1", 
	gb
"v1");

52 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

53 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

55 
Ët
 
	g’gše_2
 = 
şu¡”
.
g‘_’gše
(2);

56 
mu¡_g‘_equ®
(&
’gše_2
, 
key
, 
v®ue
);

59 
	gşu¡”
.
add_£nd_f‹r
(
IsŞ©iÚF‹rFaùÜy
::
Ãw
(2));

63 
	gpd_ş›Á
.
mu¡_»move_³”
(
r1
, 
Ãw_³”
(2, 2));

66 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(4, 4));

67 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(5, 5));

68 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(6, 6));

71 
	gpd_ş›Á
.
mu¡_»move_³”
(
r1
, 
Ãw_³”
(1, 1));

72 
	gpd_ş›Á
.
mu¡_»move_³”
(
r1
, 
Ãw_³”
(3, 3));

80 
	gşu¡”
.
mu¡_»move_»giÚ
(2, 
r1
);

83 
Ët
 (
key2
, 
v®ue2
èğ(
b
"k2", 
	gb
"v2");

84 
	gşu¡”
.
mu¡_put
(
key2
, 
v®ue2
);

85 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key2
), 
Some
(
v®ue2
.
to_vec
()));

88 
mu¡_g‘_nÚe
(&
’gše_2
, 
key
);

89 
mu¡_g‘_nÚe
(&
’gše_2
, 
key2
);

90 
Ët
 
	g¡©e_key
 = 
keys
::
»giÚ_¡©e_key
(1);

91 
Ët
 
	g¡©e
: 
RegiÚLoÿlS‹
 = 
’gše_2
.
g‘_msg_cf
(
CF_RAFT
, &
¡©e_key
).
unw¿p
().unwrap();

92 
	gas£¹_eq
!(
	g¡©e
.
g‘_¡©e
(), 
	gP“rS‹
::
Tomb¡Úe
);

95 #[
‹¡
]

96 
â
 
	$‹¡_node_¡®e_³”_out_of_»giÚ
() {

97 
Ët
 
couÁ
 = 6;

98 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

99 
	`‹¡_¡®e_³”_out_of_»giÚ
(&
mut
 
şu¡”
);

100 
	}
}

102 #[
‹¡
]

103 
â
 
	$‹¡_£rv”_¡®e_³”_out_of_»giÚ
() {

104 
Ët
 
couÁ
 = 6;

105 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

106 
	`‹¡_¡®e_³”_out_of_»giÚ
(&
mut
 
şu¡”
);

107 
	}
}

121 
â
 
	g‹¡_¡®e_³”_w™hout_d©a
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>, 
	gright_d”ive
: 
boŞ
) {

122 
şu¡”
.
cfg
.
¿á_¡Üe
.
right_d”ive_wh’_¥l™
 = 
right_d”ive
;

124 
Ët
 
	gpd_ş›Á
 = 
şu¡”
.
pd_ş›Á
.
şÚe
();

126 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

128 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

129 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

130 
	gşu¡”
.
mu¡_put
(
b
"k3", b"v3");

131 
Ët
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
b
"");

132 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

133 
	gşu¡”
.
mu¡_¥l™
(&
»giÚ
, 
b
"k2");

134 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

136 
Ët
 
	g’gše3
 = 
şu¡”
.
g‘_’gše
(3);

137 
	gright_d”ive
 {

138 
mu¡_g‘_nÚe
(&
’gše3
, 
b
"k1");

139 
mu¡_g‘_equ®
(&
’gše3
, 
b
"k3", b"v3");

141 
mu¡_g‘_equ®
(&
’gše3
, 
b
"k1", b"v1");

142 
mu¡_g‘_nÚe
(&
’gše3
, 
b
"k3");

145 
Ët
 
	gÃw_»giÚ
 = 
right_d”ive
 {

146 
şu¡”
.
g‘_»giÚ
(
b
"k1")

148 
şu¡”
.
g‘_»giÚ
(
b
"k3")

150 
Ët
 
	gÃw_»giÚ_id
 = 
Ãw_»giÚ
.
g‘_id
();

152 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

153 
RegiÚPack‘F‹r
::
Ãw
(
Ãw_»giÚ_id
, 3).
msg_ty³
(
Mes§geTy³
::
MsgSÇpshÙ
),

156 
	gpd_ş›Á
.
mu¡_add_³”
(
Ãw_»giÚ_id
, 
Ãw_³”
(3, 4));

159 
	gşu¡”
.
mu¡_»giÚ_exi¡
(
Ãw_»giÚ_id
, 3);

162 
	gşu¡”
.
add_£nd_f‹r
(
IsŞ©iÚF‹rFaùÜy
::
Ãw
(3));

164 
	gpd_ş›Á
.
mu¡_»move_³”
(
Ãw_»giÚ_id
, 
Ãw_³”
(3, 4));

166 
	gşu¡”
.
mu¡_»move_»giÚ
(3, 
Ãw_»giÚ_id
);

169 
	gright_d”ive
 {

170 
mu¡_g‘_nÚe
(&
’gše3
, 
b
"k1");

172 
mu¡_g‘_nÚe
(&
’gše3
, 
b
"k3");

178 
Ët
 
	g¡©e_key
 = 
keys
::
»giÚ_¡©e_key
(
Ãw_»giÚ_id
);

179 
Ët
 
	g¡©e
: 
RegiÚLoÿlS‹
 = 
’gše3
.
g‘_msg_cf
(
CF_RAFT
, &
¡©e_key
).
unw¿p
().unwrap();

180 
	gas£¹_eq
!(
	g¡©e
.
g‘_¡©e
(), 
	gP“rS‹
::
Tomb¡Úe
);

183 
	gright_d”ive
 {

184 
mu¡_g‘_equ®
(&
’gše3
, 
b
"k3", b"v3");

186 
mu¡_g‘_equ®
(&
’gše3
, 
b
"k1", b"v1");

190 #[
‹¡
]

191 
â
 
	$‹¡_node_¡®e_³”_w™hout_d©a_Ëá_d”ive_wh’_¥l™
() {

192 
Ët
 
couÁ
 = 3;

193 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

194 
	`‹¡_¡®e_³”_w™hout_d©a
(&
mut
 
şu¡”
, 
çl£
);

195 
	}
}

197 #[
‹¡
]

198 
â
 
	$‹¡_node_¡®e_³”_w™hout_d©a_right_d”ive_wh’_¥l™
() {

199 
Ët
 
couÁ
 = 3;

200 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

201 
	`‹¡_¡®e_³”_w™hout_d©a
(&
mut
 
şu¡”
, 
Œue
);

202 
	}
}

204 #[
‹¡
]

205 
â
 
	$‹¡_£rv”_¡®e_³”_w™hout_d©a_Ëá_d”ive_wh’_¥l™
() {

206 
Ët
 
couÁ
 = 3;

207 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

208 
	`‹¡_¡®e_³”_w™hout_d©a
(&
mut
 
şu¡”
, 
çl£
);

209 
	}
}

211 #[
‹¡
]

212 
â
 
	$‹¡_£rv”_¡®e_³”_w™hout_d©a_right_d”ive_wh’_¥l™
() {

213 
Ët
 
couÁ
 = 3;

214 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

215 
	`‹¡_¡®e_³”_w™hout_d©a
(&
mut
 
şu¡”
, 
Œue
);

216 
	}
}

	@tests/raftstore_cases/test_stats.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

16 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

18 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

19 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

20 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

21 
u£
 
	gsu³r
::
ut
::*;

22 
u£
 
	gtikv
::
pd
::
PdCl›Á
;

23 
u£
 
	gsu³r
::
pd
::
Te¡PdCl›Á
;

25 
â
 
	gcheck_avaabË
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

26 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

27 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_’gše
(1);

28 
Ët
 
	g¿á_’gše
 = 
şu¡”
.
g‘_¿á_’gše
(1);

30 
Ët
 
	g¡©s
 = 
pd_ş›Á
.
g‘_¡Üe_¡©s
(1).
unw¿p
();

31 
	gas£¹_eq
!(
	g¡©s
.
g‘_»giÚ_couÁ
(), 2);

33 
Ët
 
	gv®ue
 = 
vec
![0; 1024];

34 
i
 
	gš
 0..1000 {

35 
Ët
 
	gÏ¡_avaabË
 = 
¡©s
.
g‘_avaabË
();

36 
	gşu¡”
.
mu¡_put
(
fÜm©
!("k{}", 
i
).
as_by‹s
(), &
v®ue
);

37 
	g¿á_’gše
.
æush
(
Œue
).
unw¿p
();

38 
	g’gše
.
æush
(
Œue
).
unw¿p
();

39 
¦“p_ms
(20);

41 
Ët
 
	g¡©s
 = 
pd_ş›Á
.
g‘_¡Üe_¡©s
(1).
unw¿p
();

45 
	g¡©s
.
g‘_avaabË
(è!ğ
Ï¡_avaabË
 {

50 
	g·nic
!("available‚ot changed")

53 
â
 
	g‹¡_sim¶e_¡Üe_¡©s
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

54 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

56 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	gpd_¡Üe_h—¹b—t_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(20);

57 
	gşu¡”
.
run
();

60 
_
 
	gš
 0..100 {

61 
¦“p_ms
(20);

63 
	gpd_ş›Á
.
g‘_¡Üe_¡©s
(1).
is_some
() {

68 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_’gše
(1);

69 
Ët
 
	g¿á_’gše
 = 
şu¡”
.
g‘_¿á_’gše
(1);

70 
	g¿á_’gše
.
æush
(
Œue
).
unw¿p
();

71 
	g’gše
.
æush
(
Œue
).
unw¿p
();

72 
Ët
 
	gÏ¡_¡©s
 = 
pd_ş›Á
.
g‘_¡Üe_¡©s
(1).
unw¿p
();

73 
	gas£¹_eq
!(
	gÏ¡_¡©s
.
g‘_»giÚ_couÁ
(), 1);

75 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

76 
	gşu¡”
.
mu¡_put
(
b
"k3", b"v3");

78 
Ët
 
	g»giÚ
 = 
pd_ş›Á
.
g‘_»giÚ
(
b
"").
unw¿p
();

79 
	gşu¡”
.
mu¡_¥l™
(&
»giÚ
, 
b
"k2");

80 
	g¿á_’gše
.
æush
(
Œue
).
unw¿p
();

81 
	g’gše
.
æush
(
Œue
).
unw¿p
();

84 
_
 
	gš
 0..100 {

85 
¦“p_ms
(20);

87 
Ët
 
	g¡©s
 = 
pd_ş›Á
.
g‘_¡Üe_¡©s
(1).
unw¿p
();

88 
	g¡©s
.
g‘_»giÚ_couÁ
() == 2 {

93 
Ët
 
	g¡©s
 = 
pd_ş›Á
.
g‘_¡Üe_¡©s
(1).
unw¿p
();

94 
	gas£¹_eq
!(
	g¡©s
.
g‘_»giÚ_couÁ
(), 2);

96 
check_avaabË
(
şu¡”
);

99 #[
‹¡
]

100 
â
 
	$‹¡_node_sim¶e_¡Üe_¡©s
() {

101 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 1);

102 
	`‹¡_sim¶e_¡Üe_¡©s
(&
mut
 
şu¡”
);

103 
	}
}

105 #[
‹¡
]

106 
â
 
	$‹¡_£rv”_¡Üe_¢­_¡©s
() {

107 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 2);

108 
şu¡”
.
cfg
.
¿á_¡Üe
.
pd_¡Üe_h—¹b—t_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
	`£cs
(600);

110 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
	`şÚe
();

112 
pd_ş›Á
.
	`di§bË_deçuÉ_ruË
();

114 
Ët
 
r1
 = 
şu¡”
.
	`run_cÚf_chªge
();

117 
i
 
š
 0..2 * 1024 {

118 
Ët
 
key
 = 
fÜm©
!("{:01024}", 
i
);

119 
Ët
 
v®ue
 = 
fÜm©
!("{:01024}", 
i
);

120 
şu¡”
.
	`mu¡_put
(
key
.
	`as_by‹s
(), 
v®ue
.as_bytes());

123 
pd_ş›Á
.
	`mu¡_add_³”
(
r1
, 
	`Ãw_³”
(2, 2));

125 
	`mu¡_d‘eù_¢­
(&
pd_ş›Á
, &[1, 2]);

128 
	`¦“p_ms
(100);

131 
pd_ş›Á
.
	`mu¡_»move_³”
(
r1
, 
	`Ãw_³”
(2, 2));

132 
şu¡”
.
	`mu¡_put
(
b
"k2", b"v2");

134 
	`mu¡_nÙ_d‘eù_¢­
(&
pd_ş›Á
);

135 
	}
}

137 
â
 
mu¡_d‘eù_¢­
(
pd_ş›Á
: &
Arc
<
Te¡PdCl›Á
>, 
nodes
: &[
u64
]) {

138 
_
 
š
 0..200 {

139 
¦“p_ms
(10);

141 
id
 
š
 
	gnodes
 {

142 
Ët
 
Some
(
¡©s
èğ
pd_ş›Á
.
g‘_¡Üe_¡©s
(*
id
) {

143 
¡©s
.
g‘_£ndšg_¢­_couÁ
(è> 0 || sts.
g‘_»ûivšg_¢­_couÁ
() > 0 {

150 
	g·nic
!("must detect snapshot sending/receiving");

153 
â
 
mu¡_nÙ_d‘eù_¢­
(
pd_ş›Á
: &
Arc
<
Te¡PdCl›Á
>) {

154 
_
 
š
 0..200 {

155 
¦“p_ms
(10);

157 
Ët
 
Some
(
¡©s
èğ
pd_ş›Á
.
g‘_¡Üe_¡©s
(1) {

158 
¡©s
.
g‘_£ndšg_¢­_couÁ
(è=ğ0 && sts.
g‘_»ûivšg_¢­_couÁ
() == 0 {

164 
	g·nic
!("must‚ot detect snapshot sending/receiving");

	@tests/raftstore_cases/test_status_command.rs

14 
u£
 
	gsu³r
::
£rv”
::*;

16 #[
‹¡
]

17 
â
 
	$‹¡_»giÚ_d‘a
() {

18 
Ët
 
couÁ
 = 5;

19 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

20 
şu¡”
.
	`run
();

22 
Ët
 
Ëad”
 = 
şu¡”
.
	`Ëad”_of_»giÚ
(1).
	`unw¿p
();

23 
Ët
 
»giÚ_d‘a
 = 
şu¡”
.
	`»giÚ_d‘a
(1, 1);

24 
as£¹
!(
»giÚ_d‘a
.
	`has_»giÚ
());

25 
Ët
 
»giÚ
 = 
»giÚ_d‘a
.
	`g‘_»giÚ
();

26 
as£¹_eq
!(
»giÚ
.
	`g‘_id
(), 1);

27 
as£¹
!(
»giÚ
.
	`g‘_¡¬t_key
().
	`is_em±y
());

28 
as£¹
!(
»giÚ
.
	`g‘_’d_key
().
	`is_em±y
());

29 
as£¹_eq
!(
»giÚ
.
	`g‘_³”s
().
	`Ën
(), 5);

30 
Ët
 
•och
 = 
»giÚ
.
	`g‘_»giÚ_•och
();

31 
as£¹_eq
!(
•och
.
	`g‘_cÚf_v”
(), 1);

32 
as£¹_eq
!(
•och
.
	`g‘_v”siÚ
(), 1);

35 
as£¹
!(
»giÚ_d‘a
.
	`has_Ëad”
());

36 
as£¹_eq
!(
»giÚ_d‘a
.
	`g‘_Ëad”
(), &
Ëad”
);

37 
	}
}

	@tests/raftstore_cases/test_tombstone.rs

14 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

15 
u£
 
	g¡d
::
th»ad
;

17 
u£
 
	grocksdb
::
Wr™abË
;

18 
u£
 
	g´Ùobuf
::
Mes§ge
;

20 
u£
 
	gkv´Ùo
::
¿á_£rv”pb
::{
P“rS‹
, 
	gRaáMes§ge
, 
	gRegiÚLoÿlS‹
, 
	gStÜeId’t
};

21 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

22 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

23 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

24 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

25 
u£
 
	gsu³r
::
ut
::*;

26 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::{
keys
, 
	gI‹¿bË
, 
	gMubË
, 
	gP“kabË
};

27 
u£
 
	gtikv
::
¡Üage
::
CF_RAFT
;

28 
u£
 
	gtikv
::
ut
::
rocksdb
::
g‘_cf_hªdË
;

30 
â
 
	g‹¡_tomb¡Úe
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

31 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

33 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

35 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

38 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

40 
Ët
 (
key
, 
v®ue
èğ(
b
"k1", 
	gb
"v1");

41 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

42 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

44 
Ët
 
	g’gše_2
 = 
şu¡”
.
g‘_’gše
(2);

45 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k1", b"v1");

48 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

50 
Ët
 
	g’gše_3
 = 
şu¡”
.
g‘_’gše
(3);

51 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k1", b"v1");

54 
	gpd_ş›Á
.
mu¡_»move_³”
(
r1
, 
Ãw_³”
(2, 2));

57 
	gşu¡”
.
Ëad”_of_»giÚ
(
r1
).
unw¿p
();

58 
Ët
 (
key
, 
v®ue
èğ(
b
"k3", 
	gb
"v3");

59 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

60 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

62 
Ët
 
	g’gše_2
 = 
şu¡”
.
g‘_’gše
(2);

63 
mu¡_g‘_nÚe
(&
’gše_2
, 
b
"k1");

64 
mu¡_g‘_nÚe
(&
’gše_2
, 
b
"k3");

65 
Ët
 
mut
 
	gexi¡šg_kvs
 = 
vec
![];

66 
cf
 
š
 
	g’gše_2
.
cf_Çmes
() {

67 
	g’gše_2


68 .
sÿn_cf
(
cf
, 
b
"", &[0xFF], 
çl£
, &
mut
 |
k
, 
v
| {

69 
exi¡šg_kvs
.
push
((
k
.
to_vec
(), 
v
.to_vec()));

70 
Ok
(
Œue
)

72 .
unw¿p
();

75 
	gas£¹_eq
!(
	gexi¡šg_kvs
.
Ën
(), 2);

76 
	gexi¡šg_kvs
.
sÜt
();

77 
	gas£¹_eq
!(
	gexi¡šg_kvs
[0].0, 
	gkeys
::
¡Üe_id’t_key
());

78 
	gas£¹_eq
!(
	gexi¡šg_kvs
[1].0, 
	gkeys
::
»giÚ_¡©e_key
(
r1
));

80 
Ët
 
mut
 
	gid’t
 = 
StÜeId’t
::
Ãw
();

81 
	gid’t
.
m”ge_äom_by‹s
(&
exi¡šg_kvs
[0].1).
unw¿p
();

82 
	gas£¹_eq
!(
	gid’t
.
g‘_¡Üe_id
(), 2);

83 
	gas£¹_eq
!(
	gid’t
.
g‘_şu¡”_id
(), 
	gşu¡”
.
id
());

85 
Ët
 
mut
 
	g¡©e
 = 
RegiÚLoÿlS‹
::
Ãw
();

86 
	g¡©e
.
m”ge_äom_by‹s
(&
exi¡šg_kvs
[1].1).
unw¿p
();

87 
	gas£¹_eq
!(
	g¡©e
.
g‘_¡©e
(), 
	gP“rS‹
::
Tomb¡Úe
);

92 
Ët
 
	gcÚf_v”
 = 
¡©e
.
g‘_»giÚ
().
g‘_»giÚ_•och
().
g‘_cÚf_v”
();

93 
	gas£¹
!(
	gcÚf_v”
 =ğ4 || 
cÚf_v”
 == 3);

96 
Ët
 
mut
 
	g¿á_msg
 = 
RaáMes§ge
::
Ãw
();

98 
	g¿á_msg
.
£t_»giÚ_id
(
r1
);

100 
	g¿á_msg
.
£t_äom_³”
(
Ãw_³”
(0, 0));

101 
	g¿á_msg
.
£t_to_³”
(
Ãw_³”
(2, 2));

102 
	g¿á_msg
.
mut_»giÚ_•och
().
£t_cÚf_v”
(0);

103 
	g¿á_msg
.
mut_»giÚ_•och
().
£t_v”siÚ
(0);

105 
	gşu¡”
.
£nd_¿á_msg
(
¿á_msg
).
unw¿p
();

108 
Ët
 
	g»giÚ_¡©us
 = 
Ãw_¡©us_»que¡
(
r1
, 
Ãw_³”
(2, 2), 
Ãw_»giÚ_Ëad”_cmd
());

109 
Ët
 
	g»¥
 = 
şu¡”


110 .
ÿÎ_commªd
(
»giÚ_¡©us
, 
Du¿tiÚ
::
äom_£cs
(5))

111 .
unw¿p
();

112 
	gas£¹
!(

113 
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_»giÚ_nÙ_found
(),

115 
	g»¥


119 #[
‹¡
]

120 
â
 
	$‹¡_node_tomb¡Úe
() {

121 
Ët
 
couÁ
 = 5;

122 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

123 
	`‹¡_tomb¡Úe
(&
mut
 
şu¡”
);

124 
	}
}

126 #[
‹¡
]

127 
â
 
	$‹¡_£rv”_tomb¡Úe
() {

128 
Ët
 
couÁ
 = 5;

129 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

130 
	`‹¡_tomb¡Úe
(&
mut
 
şu¡”
);

131 
	}
}

133 
â
 
	g‹¡_ç¡_de¡roy
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

134 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

137 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

139 
	gşu¡”
.
run
();

140 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

142 
Ët
 
	g’gše_3
 = 
şu¡”
.
g‘_’gše
(3);

143 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k1", b"v1");

145 
	gpd_ş›Á
.
mu¡_»move_³”
(1, 
Ãw_³”
(3, 3));

147 
mu¡_g‘_nÚe
(&
’gše_3
, 
b
"k1");

149 
	gşu¡”
.
¡İ_node
(3);

151 
Ët
 
	gkey
 = 
keys
::
»giÚ_¡©e_key
(1);

152 
Ët
 
	g¡©e
: 
RegiÚLoÿlS‹
 = 
’gše_3
.
g‘_msg_cf
(
CF_RAFT
, &
key
).
unw¿p
().unwrap();

153 
	gas£¹_eq
!(
	g¡©e
.
g‘_¡©e
(), 
	gP“rS‹
::
Tomb¡Úe
);

156 
	g’gše_3
.
put
(&
keys
::
d©a_key
(
b
"k0"), b"v0").
unw¿p
();

158 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

161 
	gşu¡”
.
run_node
(3);

164 
	gpd_ş›Á
.
mu¡_add_³”
(1, 
Ãw_³”
(3, 4));

166 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k2", b"v2");

168 
mu¡_g‘_nÚe
(&
’gše_3
, 
b
"k0");

171 #[
‹¡
]

172 
â
 
	$‹¡_node_ç¡_de¡roy
() {

173 
Ët
 
couÁ
 = 3;

174 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

175 
	`‹¡_ç¡_de¡roy
(&
mut
 
şu¡”
);

176 
	}
}

178 #[
‹¡
]

179 
â
 
	$‹¡_£rv”_ç¡_de¡roy
() {

180 
Ët
 
couÁ
 = 3;

181 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

182 
	`‹¡_ç¡_de¡roy
(&
mut
 
şu¡”
);

183 
	}
}

185 
â
 
	g‹¡_»add_³”
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

186 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

188 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

190 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

193 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

195 
Ët
 (
key
, 
v®ue
èğ(
b
"k1", 
	gb
"v1");

196 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

197 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

199 
Ët
 
	g’gše_2
 = 
şu¡”
.
g‘_’gše
(2);

200 
mu¡_g‘_equ®
(&
’gše_2
, 
b
"k1", b"v1");

203 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

205 
Ët
 
	g’gše_3
 = 
şu¡”
.
g‘_’gše
(3);

206 
mu¡_g‘_equ®
(&
’gše_3
, 
b
"k1", b"v1");

208 
	gşu¡”
.
add_£nd_f‹r
(
IsŞ©iÚF‹rFaùÜy
::
Ãw
(2));

211 
	gpd_ş›Á
.
mu¡_»move_³”
(
r1
, 
Ãw_³”
(2, 2));

214 
	gşu¡”
.
Ëad”_of_»giÚ
(
r1
).
unw¿p
();

215 
Ët
 (
key
, 
v®ue
èğ(
b
"k3", 
	gb
"v3");

216 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

217 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

218 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 4));

220 
	gşu¡”
.
ş—r_£nd_f‹rs
();

221 
	gşu¡”
.
mu¡_put
(
b
"k4", b"v4");

222 
Ët
 
	g’gše
 = 
şu¡”
.
g‘_’gše
(2);

223 
mu¡_g‘_equ®
(&
’gše
, 
b
"k4", b"v4");

226 
Ët
 
	g•och
 = 
pd_ş›Á
.
g‘_»giÚ_•och
(
r1
);

227 
Ët
 
mut
 
	ggc_msg
 = 
RaáMes§ge
::
Ãw
();

228 
	ggc_msg
.
£t_»giÚ_id
(
r1
);

229 
	ggc_msg
.
£t_äom_³”
(
Ãw_³”
(1, 1));

230 
	ggc_msg
.
£t_to_³”
(
Ãw_³”
(2, 2));

231 
	ggc_msg
.
£t_»giÚ_•och
(
•och
);

232 
	ggc_msg
.
£t_is_tomb¡Úe
(
Œue
);

233 
	gşu¡”
.
£nd_¿á_msg
(
gc_msg
).
unw¿p
();

235 
	gth»ad
::
¦“p
(
Du¿tiÚ
::
äom_£cs
(1));

236 
mu¡_g‘_equ®
(&
’gše
, 
b
"k4", b"v4");

239 #[
‹¡
]

240 
â
 
	$‹¡_node_»add_³”
() {

241 
Ët
 
couÁ
 = 5;

242 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 
couÁ
);

243 
	`‹¡_»add_³”
(&
mut
 
şu¡”
);

244 
	}
}

246 #[
‹¡
]

247 
â
 
	$‹¡_£rv”_»add_³”
() {

248 
Ët
 
couÁ
 = 5;

249 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

250 
	`‹¡_»add_³”
(&
mut
 
şu¡”
);

251 
	}
}

254 #[
‹¡
]

255 
â
 
	$‹¡_£rv”_¡®e_m‘a
() {

256 
Ët
 
couÁ
 = 3;

257 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 
couÁ
);

258 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
	`şÚe
();

260 
pd_ş›Á
.
	`di§bË_deçuÉ_ruË
();

262 
şu¡”
.
	`run
();

263 
şu¡”
.
	`add_£nd_f‹r
(
IsŞ©iÚF‹rFaùÜy
::
	`Ãw
(3));

264 
pd_ş›Á
.
	`mu¡_»move_³”
(1, 
	`Ãw_³”
(3, 3));

265 
pd_ş›Á
.
	`mu¡_add_³”
(1, 
	`Ãw_³”
(3, 4));

266 
şu¡”
.
	`shutdown
();

268 
Ët
 
’gše_3
 = 
şu¡”
.
	`g‘_’gše
(3);

269 
Ët
 
mut
 
¡©e
: 
RegiÚLoÿlS‹
 = 
’gše_3


270 .
	`g‘_msg_cf
(
CF_RAFT
, &
keys
::
	`»giÚ_¡©e_key
(1))

271 .
	`unw¿p
()

272 .
	`unw¿p
();

273 
¡©e
.
	`£t_¡©e
(
P“rS‹
::
Tomb¡Úe
);

275 
Ët
 
hªdË
 = 
	`g‘_cf_hªdË
(&
’gše_3
, 
CF_RAFT
).
	`unw¿p
();

276 
’gše_3


277 .
	`put_msg_cf
(
hªdË
, &
keys
::
	`»giÚ_¡©e_key
(1), &
¡©e
)

278 .
	`unw¿p
();

279 
şu¡”
.
	`ş—r_£nd_f‹rs
();

282 
	`¦“p_ms
(500);

283 
şu¡”
.
	`¡¬t
();

285 
şu¡”
.
	`mu¡_put
(
b
"k1", b"v1");

286 
	`mu¡_g‘_equ®
(&
’gše_3
, 
b
"k1", b"v1");

287 
	}
}

	@tests/raftstore_cases/test_transfer_leader.rs

14 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

15 
u£
 
	g¡d
::
th»ad
;

17 
u£
 
	gkv´Ùo
::
”aápb
::
Mes§geTy³
;

18 
u£
 
	gtikv
::
ut
::
cÚfig
::*;

20 
u£
 
	gsu³r
::
ut
::*;

21 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

22 
u£
 
	gsu³r
::
Œª¥Üt_simuÏ‹
::*;

23 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

24 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

26 
â
 
	g‹¡_basic_Œªsãr_Ëad”
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

27 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_h—¹b—t_ticks
 = 20;

28 
Ët
 
	g»£rved_time
 = 
Du¿tiÚ
::
äom_mlis
(

29 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_ba£_tick_š‹rv®
.
as_mlis
() *

30 
şu¡”
.
cfg
.
¿á_¡Üe
.
¿á_h—¹b—t_ticks
 
as
 
u64
,

32 
	gşu¡”
.
run
();

35 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
Ãw_³”
(2, 2));

36 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
Ãw_³”
(1, 1));

38 
Ët
 
mut
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
b
"k3");

41 
	gşu¡”
.
mu¡_put
(
b
"k1", b"v1");

42 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(2), 
b
"k1", b"v1");

45 
Ët
 
	gËad”
 = 
şu¡”
.
Ëad”_of_»giÚ
(1).
unw¿p
();

46 
Ët
 
	gadmš_»q
 = 
Ãw_Œªsãr_Ëad”_cmd
(
Ãw_³”
(2, 2));

47 
Ët
 
mut
 
	g»q
 = 
Ãw_admš_»que¡
(1, 
»giÚ
.
g‘_»giÚ_•och
(), 
admš_»q
);

48 
	g»q
.
mut_h—d”
().
£t_³”
(
Ëad”
);

49 
	gşu¡”
.
ÿÎ_commªd
(
»q
, 
Du¿tiÚ
::
äom_£cs
(3)).
unw¿p
();

50 
	gth»ad
::
¦“p
(
»£rved_time
);

51 
	gas£¹_eq
!(
	gşu¡”
.
qu”y_Ëad”
(2, 1), 
Some
(
Ãw_³”
(2, 2)));

53 
Ët
 
mut
 
	g»q
 = 
Ãw_»que¡
(

54 
»giÚ
.
g‘_id
(),

55 
»giÚ
.
ke_»giÚ_•och
(),

56 
vec
![
Ãw_put_cmd
(
b
"k3", b"v3")],

57 
çl£
,

59 
	g»q
.
mut_h—d”
().
£t_³”
(
Ãw_³”
(2, 2));

61 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(1, 
Ãw_³”
(1, 1));

63 
Ët
 
	g»¥
 = 
şu¡”
.
ÿÎ_commªd
(
»q
, 
Du¿tiÚ
::
äom_£cs
(5)).
unw¿p
();

64 
	gas£¹
!(
	g»¥
.
g‘_h—d”
().
g‘_”rÜ
().
has_nÙ_Ëad”
());

67 #[
‹¡
]

68 
â
 
	$‹¡_£rv”_basic_Œªsãr_Ëad”
() {

69 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

70 
	`‹¡_basic_Œªsãr_Ëad”
(&
mut
 
şu¡”
);

71 
	}
}

73 #[
‹¡
]

74 
â
 
	$‹¡_node_basic_Œªsãr_Ëad”
() {

75 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

76 
	`‹¡_basic_Œªsãr_Ëad”
(&
mut
 
şu¡”
);

77 
	}
}

79 
â
 
	g‹¡_pd_Œªsãr_Ëad”
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

80 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

81 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

83 
	gşu¡”
.
run
();

85 
	gşu¡”
.
mu¡_put
(
b
"k", b"v");

88 
Ët
 
mut
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
b
"");

89 
Ët
 
mut
 
	g»q
 = 
Ãw_»que¡
(

90 
»giÚ
.
g‘_id
(),

91 
»giÚ
.
ke_»giÚ_•och
(),

92 
vec
![
Ãw_g‘_cmd
(
b
"k")],

93 
çl£
,

96 
id
 
	gš
 1..4 {

98 
	gpd_ş›Á
.
£t_ruË
(
box
 
move
 |
_
, 
³”
| {

99 
³”
.
g‘_id
(è=ğ
id
 {

100  
NÚe
;

102 
Ãw_pd_Œªsãr_Ëad”
(
Ãw_³”
(
id
, id))

106 
_
 
	gš
 0..100 {

108 
	gşu¡”
.
»£t_Ëad”_of_»giÚ
(1);

110 
¦“p_ms
(20);

112 
Ët
 
Some
(
Ëad”
èğ
şu¡”
.
Ëad”_of_»giÚ
(1) {

113 
Ëad”
.
g‘_id
(è=ğ
id
 {

119 
	gas£¹_eq
!(
	gşu¡”
.
Ëad”_of_»giÚ
(1), 
Some
(
Ãw_³”
(
id
, id)));

120 
	g»q
.
mut_h—d”
().
£t_³”
(
Ãw_³”
(
id
, id));

121 
	gdebug
!("»que¡šg {:?}", 
	g»q
);

122 
Ët
 
	g»¥
 = 
şu¡”


123 .
ÿÎ_commªd
(
»q
.
şÚe
(), 
Du¿tiÚ
::
äom_£cs
(5))

124 .
unw¿p
();

125 
	gas£¹
!(!
	g»¥
.
g‘_h—d”
().
has_”rÜ
(), "{:?}",„esp);

126 
	gas£¹_eq
!(
	g»¥
.
g‘_»¥Ú£s
()[0].
g‘_g‘
().
g‘_v®ue
(), 
	gb
"v");

130 #[
‹¡
]

131 
â
 
	$‹¡_£rv”_pd_Œªsãr_Ëad”
() {

132 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

133 
	`‹¡_pd_Œªsãr_Ëad”
(&
mut
 
şu¡”
);

134 
	}
}

136 #[
‹¡
]

137 
â
 
	$‹¡_node_pd_Œªsãr_Ëad”
() {

138 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

139 
	`‹¡_pd_Œªsãr_Ëad”
(&
mut
 
şu¡”
);

140 
	}
}

142 
â
 
	g‹¡_Œªsãr_Ëad”_duršg_¢­shÙ
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

143 
Ët
 
pd_ş›Á
 = 
şu¡”
.pd_ş›Á.
şÚe
();

145 
	gpd_ş›Á
.
di§bË_deçuÉ_ruË
();

146 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_tick_š‹rv®
 = 
R—dabËDu¿tiÚ
::
mlis
(20);

147 
	gşu¡”
.
	gcfg
.
	g¿á_¡Üe
.
	g¿á_log_gc_couÁ_lim™
 = 2;

149 
Ët
 
	gr1
 = 
şu¡”
.
run_cÚf_chªge
();

150 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(2, 2));

152 
i
 
	gš
 0..1024 {

153 
Ët
 
	gkey
 = 
fÜm©
!("{:01024}", 
	gi
);

154 
Ët
 
	gv®ue
 = 
fÜm©
!("{:01024}", 
	gi
);

155 
	gşu¡”
.
mu¡_put
(
key
.
as_by‹s
(), 
v®ue
.as_bytes());

158 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
r1
, 
Ãw_³”
(1, 1));

162 
	gşu¡”
.
add_£nd_f‹r
(
DeçuÉF‹rFaùÜy
::<
SÇpshÙF‹r
>::());

164 
	gşu¡”
.
add_£nd_f‹r
(
ClÚeF‹rFaùÜy
(

165 
RegiÚPack‘F‹r
::
Ãw
(1, 2)

166 .
msg_ty³
(
Mes§geTy³
::
MsgTimeoutNow
)

167 .
dœeùiÚ
(
DœeùiÚ
::
Recv
),

170 
	gpd_ş›Á
.
mu¡_add_³”
(
r1
, 
Ãw_³”
(3, 3));

173 
¦“p_ms
(1000);

175 
Ët
 
	g•och
 = 
şu¡”
.
g‘_»giÚ_•och
(1);

176 
Ët
 
	gput
 = 
Ãw_»que¡
(1, 
•och
, 
vec
![
Ãw_put_cmd
(
b
"k1", b"v1")], 
çl£
);

177 
	gşu¡”
.
Œªsãr_Ëad”
(
r1
, 
Ãw_³”
(2, 2));

178 
Ët
 
	g»¥
 = 
şu¡”
.
ÿÎ_commªd_Ú_Ëad”
(
put
, 
Du¿tiÚ
::
äom_£cs
(5));

180 
	gas£¹
!(
	g»¥
.
is_ok
(), "{:?}",„esp);

183 #[
‹¡
]

184 
â
 
	$‹¡_£rv”_Œªsãr_Ëad”_duršg_¢­shÙ
() {

185 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

186 
	`‹¡_Œªsãr_Ëad”_duršg_¢­shÙ
(&
mut
 
şu¡”
);

187 
	}
}

189 #[
‹¡
]

190 
â
 
	$‹¡_node_Œªsãr_Ëad”_duršg_¢­shÙ
() {

191 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 3);

192 
	`‹¡_Œªsãr_Ëad”_duršg_¢­shÙ
(&
mut
 
şu¡”
);

193 
	}
}

	@tests/raftstore_cases/test_transport.rs

14 
u£
 
	gsu³r
::
şu¡”
::{
Clu¡”
, 
	gSimuÏtÜ
};

15 
u£
 
	gsu³r
::
node
::
Ãw_node_şu¡”
;

16 
u£
 
	gsu³r
::
£rv”
::
Ãw_£rv”_şu¡”
;

17 
u£
 
	gsu³r
::
ut
::{
mu¡_g‘_equ®
, 
	gÃw_³”
};

18 
u£
 
	gut
;

20 
â
 
	g‹¡_·¹™iÚ_wr™e
<
	gT
: 
SimuÏtÜ
>(
şu¡”
: &
mut
 
Clu¡”
<
T
>) {

21 
şu¡”
.
run
();

23 
Ët
 (
key
, 
v®ue
èğ(
b
"k1", 
	gb
"v1");

24 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

25 
mu¡_g‘_equ®
(&
şu¡”
.
’gšes
[&1].
kv_’gše
, 
key
, 
v®ue
);

27 
Ët
 
	g»giÚ_id
 = 
şu¡”
.
g‘_»giÚ_id
(
key
);

30 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
»giÚ_id
, 
Ãw_³”
(1, 1));

33 
	gşu¡”
.
·¹™iÚ
(
vec
![1, 2, 3], vec![4, 5]);

34 
	gşu¡”
.
mu¡_put
(
key
, 
v®ue
);

35 
	gas£¹_eq
!(
	gşu¡”
.
g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

36 
	gşu¡”
.
mu¡_Œªsãr_Ëad”
(
»giÚ_id
, 
Ãw_³”
(1, 1));

37 
	gşu¡”
.
ş—r_£nd_f‹rs
();

40 
	gşu¡”
.
·¹™iÚ
(
vec
![1, 2], vec![3, 4, 5]);

41 
	gas£¹_eq
!(
	gşu¡”
.
mu¡_g‘
(
key
), 
Some
(
v®ue
.
to_vec
()));

42 
	gas£¹_Ã
!(
	gşu¡”
.
Ëad”_of_»giÚ
(
»giÚ_id
).
unw¿p
().
g‘_id
(), 1);

43 
	gas£¹_Ã
!(
	gşu¡”
.
Ëad”_of_»giÚ
(
»giÚ_id
).
unw¿p
().
g‘_id
(), 2);

44 
	gşu¡”
.
mu¡_put
(
key
, 
b
"changed");

45 
	gşu¡”
.
ş—r_£nd_f‹rs
();

48 
	gşu¡”
.
»£t_Ëad”_of_»giÚ
(
»giÚ_id
);

49 
	gşu¡”
.
mu¡_put
(
b
"k2", b"v2");

50 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(1), 
b
"k2", b"v2");

51 
mu¡_g‘_equ®
(&
şu¡”
.
g‘_’gše
(1), 
key
, 
b
"changed");

54 #[
‹¡
]

55 
â
 
	$‹¡_node_·¹™iÚ_wr™e
() {

56 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_node_şu¡”
(0, 5);

57 
	`‹¡_·¹™iÚ_wr™e
(&
mut
 
şu¡”
);

58 
	}
}

60 #[
‹¡
]

61 
â
 
	$‹¡_£rv”_·¹™iÚ_wr™e
() {

62 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 5);

63 
	`‹¡_·¹™iÚ_wr™e
(&
mut
 
şu¡”
);

64 
	}
}

66 #[
‹¡
]

67 
â
 
	$‹¡_£cu»_cÚÃù
() {

68 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

69 
şu¡”
.
cfg
.
£cur™y
 = 
ut
::
	`Ãw_£cur™y_cfg
();

70 
şu¡”
.
	`run_cÚf_chªge
();

72 
	`Ët
 (
key
, 
v®ue
èğ(
b
"k1", b"v1");

73 
şu¡”
.
	`mu¡_put
(
key
, 
v®ue
);

75 
id
 
š
 1..4 {

76 
	`mu¡_g‘_equ®
(&
şu¡”
.
	`g‘_’gše
(
id
), 
key
, 
v®ue
);

78 
	}
}

	@tests/storage/assert_storage.rs

14 
u£
 
	gsu³r
::
sync_¡Üage
::
SyncStÜage
;

15 
u£
 
	gkv´Ùo
::
kv½ıb
::{
CÚ‹xt
, 
	gLockInfo
};

16 
u£
 
	gtikv
::
¡Üage
::{
£lf
, 
	gmake_key
, 
	gKey
, 
	gKvPaœ
, 
	gMutiÚ
, 
	gV®ue
};

17 
u£
 
	gtikv
::
¡Üage
::
mvcc
::{
£lf
, 
	gMAX_TXN_WRITE_SIZE
};

18 
u£
 
	gtikv
::
¡Üage
::
txn
;

19 
u£
 
	g¿á¡Üe
::
şu¡”
::
Clu¡”
;

20 
u£
 
	g¿á¡Üe
::
£rv”
::
S”v”Clu¡”
;

21 
u£
 
	gtikv
::
ut
::
HªdyRwLock
;

22 
u£
 
	gsu³r
::
ut
::
Ãw_¿á_¡Üage_w™h_¡Üe_couÁ
;

23 
u£
 
	gtikv
::
¡Üage
::
cÚfig
::
CÚfig
;

24 
u£
 
	gtikv
::
¡Üage
::
’gše
;

27 #[
d”ive
(
ClÚe
)]

28 
pub
 
	sAs£¹iÚStÜage
 {

29 
pub
 
	m¡Üe
: 
SyncStÜage
,

30 
pub
 
	mùx
: 
CÚ‹xt
,

33 
im¶
 
DeçuÉ
 
	gAs£¹iÚStÜage
 {

34 
â
 (è-> 
	gAs£¹iÚStÜage
 {

35 
	gAs£¹iÚStÜage
 {

36 
	gùx
: 
CÚ‹xt
::
Ãw
(),

37 
	g¡Üe
: 
SyncStÜage
::
Ãw
(&
CÚfig
::()),

42 
im¶
 
	gAs£¹iÚStÜage
 {

43 
pub
 
â
 
Ãw_¿á_¡Üage_w™h_¡Üe_couÁ
(

44 
couÁ
: 
usize
,

45 
key
: &
¡r
,

46 è-> (
	gClu¡”
<
	gS”v”Clu¡”
>, 
	gAs£¹iÚStÜage
) {

47 
Ët
 (
şu¡”
, 
¡Üe
, 
ùx
èğ
Ãw_¿á_¡Üage_w™h_¡Üe_couÁ
(
couÁ
, 
key
);

48 
Ët
 
	g¡Üage
 = 
As£¹iÚStÜage
 {

49 
ùx
: ctx,

50 
¡Üe
: store,

52 (
	gşu¡”
, 
	g¡Üage
)

55 
pub
 
â
 
upd©e_w™h_key_by‹
(&
mut
 
£lf
, 
şu¡”
: &muˆ
Clu¡”
<
S”v”Clu¡”
>, 
key
: &[
u8
]) {

57 
şu¡”
.
mu¡_g‘
(
key
);

58 
Ët
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
key
);

59 
Ët
 
	gËad”
 = 
şu¡”
.
Ëad”_of_»giÚ
(
»giÚ
.
g‘_id
()).
unw¿p
();

60 
	gËad”
.
g‘_¡Üe_id
(è=ğ
£lf
.
ùx
.
g‘_³”
().get_store_id() {

63 
Ët
 
	g’gše
 = 
şu¡”
.
sim
.
¾
().
¡Üages
[&
Ëad”
.
g‘_id
()].
şÚe
();

64 
	g£lf
.
	gùx
.
£t_»giÚ_id
(
»giÚ
.
g‘_id
());

65 
	g£lf
.
	gùx
.
£t_»giÚ_•och
(
»giÚ
.
g‘_»giÚ_•och
().
şÚe
());

66 
	g£lf
.
	gùx
.
£t_³”
(
Ëad”
.
şÚe
());

67 
	g£lf
.
	g¡Üe
 = 
SyncStÜage
::
äom_’gše
(
’gše
, &
CÚfig
::());

70 
pub
 
â
 
g‘_nÚe
(&
£lf
, 
key
: &[
u8
], 
ts
: 
u64
) {

71 
Ët
 
key
 = 
make_key
(key);

72 
	gas£¹_eq
!(
	g£lf
.
	g¡Üe
.
g‘
(
£lf
.
ùx
.
şÚe
(), &
key
, 
ts
).
unw¿p
(), 
	gNÚe
);

75 
pub
 
â
 
g‘_”r
(&
£lf
, 
key
: &[
u8
], 
ts
: 
u64
) {

76 
Ët
 
key
 = 
make_key
(key);

77 
	gas£¹
!(
	g£lf
.
	g¡Üe
.
g‘
(
£lf
.
ùx
.
şÚe
(), &
key
, 
ts
).
is_”r
());

80 
pub
 
â
 
g‘_ok
(&
£lf
, 
key
: &[
u8
], 
ts
: 
u64
, 
ex³ù
: &[u8]) {

81 
Ët
 
key
 = 
make_key
(key);

82 
	gas£¹_eq
!(

83 
	g£lf
.
	g¡Üe
.
g‘
(
£lf
.
ùx
.
şÚe
(), &
key
, 
ts
).
unw¿p
().unwrap(),

84 
	gex³ù


88 
pub
 
â
 
b©ch_g‘_ok
(&
£lf
, 
keys
: &[&[
u8
]], 
ts
: 
u64
, 
ex³ù
: 
Vec
<&[u8]>) {

89 
Ët
 
keys
: 
Vec
<
Key
> = keys.
što_™”
().
m­
(|
x
| 
make_key
(x)).
cŞËù
();

90 
Ët
 
	g»suÉ
: 
Vec
<Vec<
u8
>> = 
£lf
.
¡Üe


91 .
b©ch_g‘
(
£lf
.
ùx
.
şÚe
(), &
keys
, 
ts
)

92 .
unw¿p
()

93 .
što_™”
()

94 .
m­
(|
x
| x.
unw¿p
().1)

95 .
cŞËù
();

96 
Ët
 
	gex³ù
: 
Vec
<Vec<
u8
>> = 
ex³ù
.
što_™”
().
m­
(|
x
| x.
to_vec
()).
cŞËù
();

97 
	gas£¹_eq
!(
	g»suÉ
, 
	gex³ù
);

100 
â
 
ex³ù_nÙ_Ëad”_Ü_¡®e_commªd
(&
£lf
, 
”r
: 
¡Üage
::
E¼Ü
) {

101 
m©ch
 
”r
 {

102 
¡Üage
::
E¼Ü
::
Txn
(

103 
txn
::
E¼Ü
::
Mvcc
(
mvcc
::E¼Ü::
Engše
(
’gše
::E¼Ü::
Reque¡
(
»f
 
e
))),

105 
	g¡Üage
::
E¼Ü
::
Txn
(
txn
::E¼Ü::
Engše
(
’gše
::E¼Ü::
Reque¡
(
»f
 
e
))) |

106 
¡Üage
::
E¼Ü
::
Engše
(
’gše
::E¼Ü::
Reque¡
(
»f
 
e
)) => {

107 
as£¹
!(

108 
e
.
has_nÙ_Ëad”
(è|ƒ.
has_¡®e_commªd
(),

110 
e


113 
	g_
 => {

114 
·nic
!(

116 
”r


122 
â
 
ex³ù_šv®id_tso_”r
(&
£lf
, 
»¥
: 
ResuÉ
<(), 
¡Üage
::
E¼Ü
>, 
¡s
: 
u64
, 
cmt_ts
: u64) {

123 
as£¹
!(
»¥
.
is_”r
());

124 
Ët
 
	g”r
 = 
»¥
.
unw¿p_”r
();

125 
m©ch
 
	g”r
 {

126 
	g¡Üage
::
E¼Ü
::
Txn
(
txn
::E¼Ü::
Inv®idTxnTso
 {

127 
¡¬t_ts
,

128 
comm™_ts
,

130 
as£¹_eq
!(
¡s
, 
¡¬t_ts
);

131 
	gas£¹_eq
!(
	gcmt_ts
, 
	gcomm™_ts
);

133 
	g_
 => {

134 
·nic
!("ex³ù inv®idsØ”rÜ, buˆgÙ {:?}", 
”r
);

139 
pub
 
â
 
g‘_nÚe_äom_şu¡”
(

140 &
mut
 
£lf
,

141 
şu¡”
: &
mut
 
Clu¡”
<
S”v”Clu¡”
>,

142 
key
: &[
u8
],

143 
ts
: 
u64
,

145 
	gas£¹_eq
!(
	g£lf
.
g‘_äom_cu¡”
(
şu¡”
, 
key
, 
ts
), 
	gNÚe
);

148 
pub
 
â
 
put_ok_fÜ_şu¡”
(

149 &
mut
 
£lf
,

150 
şu¡”
: &
mut
 
Clu¡”
<
S”v”Clu¡”
>,

151 
key
: &[
u8
],

152 
v®ue
: &[
u8
],

153 
¡¬t_ts
: 
u64
,

154 
comm™_ts
: 
u64
,

156 
Ët
 
	gmutiÚs
 = 
vec
![
MutiÚ
::
Put
((
make_key
(
key
), 
v®ue
.
to_vec
()))];

157 
Ët
 
	gcomm™_keys
 = 
vec
![
make_key
(
key
)];

158 
	g£lf
.
two_pc_ok_fÜ_şu¡”
(
şu¡”
, 
mutiÚs
, 
key
, 
comm™_keys
, 
¡¬t_ts
, 
comm™_ts
);

161 
pub
 
â
 
put_ok
(&
£lf
, 
key
: &[
u8
], 
v®ue
: &[u8], 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

162 
£lf
.
¡Üe


163 .
´ewr™e
(

164 
£lf
.
ùx
.
şÚe
(),

165 
vec
![
MutiÚ
::
Put
((
make_key
(
key
), 
v®ue
.
to_vec
()))],

166 
key
.
to_vec
(),

167 
¡¬t_ts
,

169 .
unw¿p
();

170 
	g£lf
.
	g¡Üe


171 .
comm™
(
£lf
.
ùx
.
şÚe
(), 
vec
![
make_key
(
key
)], 
¡¬t_ts
, 
comm™_ts
)

172 .
unw¿p
();

175 
pub
 
â
 
d–‘e_ok
(&
£lf
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

176 
£lf
.
¡Üe


177 .
´ewr™e
(

178 
£lf
.
ùx
.
şÚe
(),

179 
vec
![
MutiÚ
::
D–‘e
(
make_key
(
key
))],

180 
key
.
to_vec
(),

181 
¡¬t_ts
,

183 .
unw¿p
();

184 
	g£lf
.
	g¡Üe


185 .
comm™
(
£lf
.
ùx
.
şÚe
(), 
vec
![
make_key
(
key
)], 
¡¬t_ts
, 
comm™_ts
)

186 .
unw¿p
();

189 
pub
 
â
 
d–‘e_ok_fÜ_şu¡”
(

190 &
mut
 
£lf
,

191 
şu¡”
: &
mut
 
Clu¡”
<
S”v”Clu¡”
>,

192 
key
: &[
u8
],

193 
¡¬t_ts
: 
u64
,

194 
comm™_ts
: 
u64
,

196 
Ët
 
	gmutiÚs
 = 
vec
![
MutiÚ
::
D–‘e
(
make_key
(
key
))];

197 
Ët
 
	gcomm™_keys
 = 
vec
![
make_key
(
key
)];

198 
	g£lf
.
two_pc_ok_fÜ_şu¡”
(
şu¡”
, 
mutiÚs
, 
key
, 
comm™_keys
, 
¡¬t_ts
, 
comm™_ts
);

201 
â
 
g‘_äom_cu¡”
(

202 &
mut
 
£lf
,

203 
şu¡”
: &
mut
 
Clu¡”
<
S”v”Clu¡”
>,

204 
key
: &[
u8
],

205 
ts
: 
u64
,

206 è-> 
	gO±iÚ
<
	gV®ue
> {

207 
_
 
	gš
 0..3 {

208 
Ët
 
	g»s
 = 
£lf
.
¡Üe
.
g‘
(£lf.
ùx
.
şÚe
(), &
make_key
(
key
), 
ts
);

209 
Ët
 
Ok
(
d©a
èğ
»s
 {

210  
d©a
;

212 
	g£lf
.
ex³ù_nÙ_Ëad”_Ü_¡®e_commªd
(
»s
.
unw¿p_”r
());

213 
	g£lf
.
upd©e_w™h_key_by‹
(
şu¡”
, 
key
);

215 
	g·nic
!("failed with 3ry");

218 
â
 
two_pc_ok_fÜ_şu¡”
(

219 &
mut
 
£lf
,

220 
şu¡”
: &
mut
 
Clu¡”
<
S”v”Clu¡”
>,

221 
´ewr™e_mutiÚs
: 
Vec
<
MutiÚ
>,

222 
key
: &[
u8
],

223 
comm™_keys
: 
Vec
<
Key
>,

224 
¡¬t_ts
: 
u64
,

225 
comm™_ts
: 
u64
,

227 
Ët
 
	g»Œy_time
 = 3;

228 
Ët
 
mut
 
	gsucûss
 = 
çl£
;

229 
_
 
	gš
 0..
	g»Œy_time
 {

230 
Ët
 
	g»s
 = 
£lf
.
¡Üe
.
´ewr™e
(

231 
£lf
.
ùx
.
şÚe
(),

232 
´ewr™e_mutiÚs
.
şÚe
(),

233 
key
.
to_vec
(),

234 
¡¬t_ts
,

236 
	g»s
.
is_ok
() {

237 
	gsucûss
 = 
Œue
;

240 
	g£lf
.
ex³ù_nÙ_Ëad”_Ü_¡®e_commªd
(
»s
.
unw¿p_”r
());

241 
	g£lf
.
upd©e_w™h_key_by‹
(
şu¡”
, 
key
)

243 
	gas£¹
!(
	gsucûss
);

245 
	gsucûss
 = 
çl£
;

246 
_
 
	gš
 0..
	g»Œy_time
 {

247 
Ët
 
	g»s
 = 
£lf
.
¡Üe


248 .
comm™
(
£lf
.
ùx
.
şÚe
(), 
comm™_keys
.şÚe(), 
¡¬t_ts
, 
comm™_ts
);

249 
	g»s
.
is_ok
() {

250 
	gsucûss
 = 
Œue
;

253 
	g£lf
.
ex³ù_nÙ_Ëad”_Ü_¡®e_commªd
(
»s
.
unw¿p_”r
());

254 
	g£lf
.
upd©e_w™h_key_by‹
(
şu¡”
, 
key
)

256 
	gas£¹
!(
	gsucûss
);

259 
pub
 
â
 
sÿn_ok
(

260 &
£lf
,

261 
¡¬t_key
: &[
u8
],

262 
lim™
: 
usize
,

263 
ts
: 
u64
,

264 
ex³ù
: 
Vec
<
O±iÚ
<(&[
u8
], &[u8])>>,

266 
Ët
 
	gkey_add»ss
 = 
make_key
(
¡¬t_key
);

267 
Ët
 
	g»suÉ
 = 
£lf
.
¡Üe


268 .
sÿn
(
£lf
.
ùx
.
şÚe
(), 
key_add»ss
, 
lim™
, 
çl£
, 
ts
)

269 .
unw¿p
();

270 
Ët
 
	g»suÉ
: 
Vec
<
O±iÚ
<
KvPaœ
>> = 
»suÉ
.
što_™”
().
m­
(
ResuÉ
::
ok
).
cŞËù
();

271 
Ët
 
	gex³ù
: 
Vec
<
O±iÚ
<
KvPaœ
>> = 
ex³ù


272 .
što_™”
()

273 .
m­
(|
x
| x.m­(|(
k
, 
v
)| (k.
to_vec
(), v.to_vec())))

274 .
cŞËù
();

275 
	gas£¹_eq
!(
	g»suÉ
, 
	gex³ù
);

278 
pub
 
â
 
sÿn_key_Úly_ok
(

279 &
£lf
,

280 
¡¬t_key
: &[
u8
],

281 
lim™
: 
usize
,

282 
ts
: 
u64
,

283 
ex³ù
: 
Vec
<
O±iÚ
<&[
u8
]>>,

285 
Ët
 
	gkey_add»ss
 = 
make_key
(
¡¬t_key
);

286 
Ët
 
	g»suÉ
 = 
£lf
.
¡Üe


287 .
sÿn
(
£lf
.
ùx
.
şÚe
(), 
key_add»ss
, 
lim™
, 
Œue
, 
ts
)

288 .
unw¿p
();

289 
Ët
 
	g»suÉ
: 
Vec
<
O±iÚ
<
KvPaœ
>> = 
»suÉ
.
što_™”
().
m­
(
ResuÉ
::
ok
).
cŞËù
();

290 
Ët
 
	gex³ù
: 
Vec
<
O±iÚ
<
KvPaœ
>> = 
ex³ù


291 .
što_™”
()

292 .
m­
(|
x
| x.m­(|
k
| (k.
to_vec
(), 
vec
![])))

293 .
cŞËù
();

294 
	gas£¹_eq
!(
	g»suÉ
, 
	gex³ù
);

297 
pub
 
â
 
´ewr™e_ok
(&
£lf
, 
mutiÚs
: 
Vec
<
MutiÚ
>, 
´im¬y
: &[
u8
], 
¡¬t_ts
: 
u64
) {

298 
£lf
.
¡Üe


299 .
´ewr™e
(
£lf
.
ùx
.
şÚe
(), 
mutiÚs
, 
´im¬y
.
to_vec
(), 
¡¬t_ts
)

300 .
unw¿p
();

303 
pub
 
â
 
´ewr™e_”r
(&
£lf
, 
mutiÚs
: 
Vec
<
MutiÚ
>, 
´im¬y
: &[
u8
], 
¡¬t_ts
: 
u64
) {

304 
£lf
.
¡Üe


305 .
´ewr™e
(
£lf
.
ùx
.
şÚe
(), 
mutiÚs
, 
´im¬y
.
to_vec
(), 
¡¬t_ts
)

306 .
unw¿p_”r
();

309 
pub
 
â
 
´ewr™e_locked
(

310 &
£lf
,

311 
mutiÚs
: 
Vec
<
MutiÚ
>,

312 
´im¬y
: &[
u8
],

313 
¡¬t_ts
: 
u64
,

314 
ex³ù_locks
: 
Vec
<(&[
u8
], &[u8], 
u64
)>,

316 
Ët
 
	g»s
 = 
£lf
.
¡Üe


317 .
´ewr™e
(
£lf
.
ùx
.
şÚe
(), 
mutiÚs
, 
´im¬y
.
to_vec
(), 
¡¬t_ts
)

318 .
unw¿p
();

319 
Ët
 
	glocks
: 
Vec
<(&[
u8
], &[u8], 
	gu64
)> = 
»s
.
™”
()

320 .
f‹r_m­
(|
x
| {

321 
Ët
 
E¼
(

322 
¡Üage
::
E¼Ü
::
Txn
(

323 
txn
::
E¼Ü
::
Mvcc
(
mvcc
::E¼Ü::
KeyIsLocked
 {

324 
»f
 
key
,

325 
»f
 
´im¬y
,

326 
ts
,

330 èğ*
x


332 
Some
((
key
.
as_»f
(), 
´im¬y
.as_»f(), 
ts
))

334 
NÚe


337 .
cŞËù
();

338 
	gas£¹_eq
!(
	gex³ù_locks
, 
	glocks
);

341 
pub
 
â
 
comm™_ok
(&
£lf
, 
keys
: 
Vec
<&[
u8
]>, 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

342 
Ët
 
keys
: 
Vec
<
Key
> = keys.
™”
().
m­
(|
x
| 
make_key
(x)).
cŞËù
();

343 
	g£lf
.
	g¡Üe


344 .
comm™
(
£lf
.
ùx
.
şÚe
(), 
keys
, 
¡¬t_ts
, 
comm™_ts
)

345 .
unw¿p
();

348 
pub
 
â
 
comm™_w™h_Ëg®_tso
(&
£lf
, 
keys
: 
Vec
<&[
u8
]>, 
¡¬t_ts
: 
u64
, 
comm™_ts
: u64) {

349 
Ët
 
keys
: 
Vec
<
Key
> = keys.
™”
().
m­
(|
x
| 
make_key
(x)).
cŞËù
();

350 
Ët
 
	g»¥
 = 
£lf
.
¡Üe


351 .
comm™
(
£lf
.
ùx
.
şÚe
(), 
keys
, 
¡¬t_ts
, 
comm™_ts
);

352 
	g£lf
.
ex³ù_šv®id_tso_”r
(
»¥
, 
¡¬t_ts
, 
comm™_ts
);

355 
pub
 
â
 
ş—nup_ok
(&
£lf
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
) {

356 
£lf
.
¡Üe


357 .
ş—nup
(
£lf
.
ùx
.
şÚe
(), 
make_key
(
key
), 
¡¬t_ts
)

358 .
unw¿p
();

361 
pub
 
â
 
ş—nup_”r
(&
£lf
, 
key
: &[
u8
], 
¡¬t_ts
: 
u64
) {

362 
as£¹
!(

363 
£lf
.
¡Üe


364 .
ş—nup
(
£lf
.
ùx
.
şÚe
(), 
make_key
(
key
), 
¡¬t_ts
)

365 .
is_”r
()

369 
pub
 
â
 
rŞlback_ok
(&
£lf
, 
keys
: 
Vec
<&[
u8
]>, 
¡¬t_ts
: 
u64
) {

370 
Ët
 
keys
: 
Vec
<
Key
> = keys.
™”
().
m­
(|
x
| 
make_key
(x)).
cŞËù
();

371 
	g£lf
.
	g¡Üe


372 .
rŞlback
(
£lf
.
ùx
.
şÚe
(), 
keys
, 
¡¬t_ts
)

373 .
unw¿p
();

376 
pub
 
â
 
rŞlback_”r
(&
£lf
, 
keys
: 
Vec
<&[
u8
]>, 
¡¬t_ts
: 
u64
) {

377 
Ët
 
keys
: 
Vec
<
Key
> = keys.
™”
().
m­
(|
x
| 
make_key
(x)).
cŞËù
();

378 
	gas£¹
!(

379 
	g£lf
.
	g¡Üe


380 .
rŞlback
(
£lf
.
ùx
.
şÚe
(), 
keys
, 
¡¬t_ts
)

381 .
is_”r
()

385 
pub
 
â
 
sÿn_lock_ok
(&
£lf
, 
max_ts
: 
u64
, 
ex³ù
: 
Vec
<
LockInfo
>) {

386 
as£¹_eq
!(

387 
£lf
.
¡Üe
.
sÿn_lock
(£lf.
ùx
.
şÚe
(), 
max_ts
).
unw¿p
(),

388 
	gex³ù


392 
pub
 
â
 
»sŞve_lock_ok
(&
£lf
, 
¡¬t_ts
: 
u64
, 
comm™_ts
: 
O±iÚ
<u64>) {

393 
£lf
.
¡Üe


394 .
»sŞve_lock
(
£lf
.
ùx
.
şÚe
(), 
¡¬t_ts
, 
comm™_ts
)

395 .
unw¿p
();

398 
pub
 
â
 
»sŞve_lock_b©ch_ok
(

399 &
£lf
,

400 
¡¬t_ts_1
: 
u64
,

401 
comm™_ts_1
: 
u64
,

402 
¡¬t_ts_2
: 
u64
,

403 
comm™_ts_2
: 
u64
,

405 
	g£lf
.
	g¡Üe


406 .
»sŞve_lock_b©ch
(

407 
£lf
.
ùx
.
şÚe
(),

408 
vec
![(
¡¬t_ts_1
, 
comm™_ts_1
), (
¡¬t_ts_2
, 
comm™_ts_2
)],

410 .
unw¿p
();

413 
pub
 
â
 
»sŞve_lock_w™h_Ëg®_tso
(&
£lf
, 
¡¬t_ts
: 
u64
, 
comm™_ts
: 
O±iÚ
<u64>) {

414 
Ët
 
»¥
 = 
£lf
.
¡Üe


415 .
»sŞve_lock
(
£lf
.
ùx
.
şÚe
(), 
¡¬t_ts
, 
comm™_ts
);

416 
	g£lf
.
ex³ù_šv®id_tso_”r
(
»¥
, 
¡¬t_ts
, 
comm™_ts
.
unw¿p
())

420 
pub
 
â
 
gc_ok
(&
£lf
, 
§ã_pošt
: 
u64
) {

421 
£lf
.
¡Üe
.
gc
(£lf.
ùx
.
şÚe
(), 
§ã_pošt
).
unw¿p
();

424 
pub
 
â
 
gc_ok_fÜ_şu¡”
(

425 &
mut
 
£lf
,

426 
şu¡”
: &
mut
 
Clu¡”
<
S”v”Clu¡”
>,

427 
»giÚ_key
: &[
u8
],

428 
§ã_pošt
: 
u64
,

430 
_
 
	gš
 0..3 {

431 
Ët
 
	g»t
 = 
£lf
.
¡Üe
.
gc
(£lf.
ùx
.
şÚe
(), 
§ã_pošt
);

432 
	g»t
.
is_ok
() {

435 
	g£lf
.
ex³ù_nÙ_Ëad”_Ü_¡®e_commªd
(
»t
.
unw¿p_”r
());

436 
	g£lf
.
upd©e_w™h_key_by‹
(
şu¡”
, 
»giÚ_key
);

438 
	g·nic
!("failed with 3„etry!");

441 
pub
 
â
 
¿w_g‘_ok
(&
£lf
, 
key
: 
Vec
<
u8
>, 
v®ue
: 
O±iÚ
<Vec<u8>>) {

442 
as£¹_eq
!(
£lf
.
¡Üe
.
¿w_g‘
(£lf.
ùx
.
şÚe
(), 
key
).
unw¿p
(), 
	gv®ue
);

445 
pub
 
â
 
¿w_put_ok
(&
£lf
, 
key
: 
Vec
<
u8
>, 
v®ue
: Vec<u8>) {

446 
£lf
.
¡Üe
.
¿w_put
(£lf.
ùx
.
şÚe
(), 
key
, 
v®ue
).
unw¿p
();

449 
pub
 
â
 
¿w_put_”r
(&
£lf
, 
key
: 
Vec
<
u8
>, 
v®ue
: Vec<u8>) {

450 
£lf
.
¡Üe


451 .
¿w_put
(
£lf
.
ùx
.
şÚe
(), 
key
, 
v®ue
)

452 .
unw¿p_”r
();

455 
pub
 
â
 
¿w_d–‘e_ok
(&
£lf
, 
key
: 
Vec
<
u8
>) {

456 
£lf
.
¡Üe
.
¿w_d–‘e
(£lf.
ùx
.
şÚe
(), 
key
).
unw¿p
()

459 
pub
 
â
 
¿w_d–‘e_”r
(&
£lf
, 
key
: 
Vec
<
u8
>) {

460 
£lf
.
¡Üe
.
¿w_d–‘e
(£lf.
ùx
.
şÚe
(), 
key
).
unw¿p_”r
();

463 
pub
 
â
 
¿w_sÿn_ok
(&
£lf
, 
¡¬t_key
: 
Vec
<
u8
>, 
lim™
: 
usize
, 
ex³ù
: Vec<(&[u8], &[u8])>) {

464 
Ët
 
	g»suÉ
: 
Vec
<
KvPaœ
> = 
£lf
.
¡Üe


465 .
¿w_sÿn
(
£lf
.
ùx
.
şÚe
(), 
¡¬t_key
, 
lim™
)

466 .
unw¿p
()

467 .
što_™”
()

468 .
m­
(|
x
| x.
unw¿p
())

469 .
cŞËù
();

470 
Ët
 
	gex³ù
: 
Vec
<
KvPaœ
> = 
ex³ù


471 .
što_™”
()

472 .
m­
(|(
k
, 
v
)| (k.
to_vec
(), v.to_vec()))

473 .
cŞËù
();

474 
	gas£¹_eq
!(
	g»suÉ
, 
	gex³ù
);

477 
pub
 
â
 
‹¡_txn_¡Üe_gc
(&
£lf
, 
key
: &
¡r
) {

478 
Ët
 
key_by‹s
 = 
key
.
as_by‹s
();

479 
	g£lf
.
put_ok
(
key_by‹s
, 
b
"v1", 5, 10);

480 
	g£lf
.
put_ok
(
key_by‹s
, 
b
"v2", 15, 20);

481 
	g£lf
.
gc_ok
(30);

482 
	g£lf
.
g‘_nÚe
(
key_by‹s
, 15);

483 
	g£lf
.
g‘_ok
(
key_by‹s
, 25, 
b
"v2");

486 
pub
 
â
 
‹¡_txn_¡Üe_gc3
(&
£lf
, 
key_´efix
: 
u8
) {

487 
Ët
 
key_Ën
 = 10
_000
;

488 
Ët
 
	gkey
 = 
vec
![
key_´efix
; 1024];

489 
k
 
	gš
 1u64..(
	gMAX_TXN_WRITE_SIZE
 / 
	gkey_Ën
 * 2è
as
 
	gu64
 {

490 
	g£lf
.
put_ok
(&
key
, 
b
"", 
k
 * 10, k * 10 + 5);

492 
	g£lf
.
d–‘e_ok
(&
key
, 1000, 1050);

493 
	g£lf
.
g‘_nÚe
(&
key
, 2000);

494 
	g£lf
.
gc_ok
(2000);

495 
	g£lf
.
g‘_nÚe
(&
key
, 3000);

498 
pub
 
â
 
‹¡_txn_¡Üe_gc3_fÜ_şu¡”
(

499 &
mut
 
£lf
,

500 
şu¡”
: &
mut
 
Clu¡”
<
S”v”Clu¡”
>,

501 
key_´efix
: 
u8
,

503 
Ët
 
	gkey_Ën
 = 10
_000
;

504 
Ët
 
	gkey
 = 
vec
![
key_´efix
; 1024];

505 
k
 
	gš
 1u64..(
	gMAX_TXN_WRITE_SIZE
 / 
	gkey_Ën
 * 2è
as
 
	gu64
 {

506 
	g£lf
.
put_ok_fÜ_şu¡”
(
şu¡”
, &
key
, 
b
"", 
k
 * 10, k * 10 + 5);

509 
	g£lf
.
d–‘e_ok_fÜ_şu¡”
(
şu¡”
, &
key
, 1000, 1050);

510 
	g£lf
.
g‘_nÚe_äom_şu¡”
(
şu¡”
, &
key
, 2000);

511 
	g£lf
.
gc_ok_fÜ_şu¡”
(
şu¡”
, &
key
, 2000);

512 
	g£lf
.
g‘_nÚe_äom_şu¡”
(
şu¡”
, &
key
, 3000);

	@tests/storage/mod.rs

14 
mod
 
	g‹¡_¿ákv
;

15 
pub
 
mod
 
	gsync_¡Üage
;

16 
pub
 
mod
 
	gas£¹_¡Üage
;

17 
mod
 
	g‹¡_¡Üage
;

18 
mod
 
	g‹¡_¿á_¡Üage
;

19 
pub
 
mod
 
	gut
;

	@tests/storage/sync_storage.rs

14 
u£
 
	g¡d
::
sync
::
Arc
;

15 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

17 
u£
 
	gtikv
::
ut
::
cŞËùiÚs
::
HashM­
;

18 
u£
 
	gtikv
::
¡Üage
::{
Engše
, 
	gKey
, 
	gKvPaœ
, 
	gMutiÚ
, 
	gO±iÚs
, 
	gResuÉ
, 
	gStÜage
, 
	gV®ue
};

19 
u£
 
	gtikv
::
¡Üage
::
cÚfig
::
CÚfig
;

20 
u£
 
	gkv´Ùo
::
kv½ıb
::{
CÚ‹xt
, 
	gLockInfo
};

23 
pub
 
	sSyncStÜage
 {

24 
	m¡Üe
: 
StÜage
,

25 
	mút
: 
Arc
<
AtomicUsize
>,

28 
im¶
 
	gSyncStÜage
 {

29 
pub
 
â
 
Ãw
(
cÚfig
: &
CÚfig
è-> 
SyncStÜage
 {

30 
Ët
 
¡Üage
 = 
StÜage
::
Ãw
(
cÚfig
).
unw¿p
();

31 
Ët
 
mut
 
	gs
 = 
SyncStÜage
 {

32 
¡Üe
: 
¡Üage
,

33 
út
: 
Arc
::
Ãw
(
AtomicUsize
::new(0)),

35 
	gs
.
¡¬t
(
cÚfig
);

36 
	gs


39 
pub
 
â
 
äom_’gše
(
’gše
: 
Box
<
Engše
>, 
cÚfig
: &
CÚfig
è-> 
SyncStÜage
 {

40 
Ët
 
mut
 
s
 = 
SyncStÜage
::
´•¬e
(
’gše
, 
cÚfig
);

41 
	gs
.
¡¬t
(
cÚfig
);

42 
	gs


45 
pub
 
â
 
´•¬e
(
’gše
: 
Box
<
Engše
>, 
cÚfig
: &
CÚfig
è-> 
SyncStÜage
 {

46 
Ët
 
¡Üage
 = 
StÜage
::
äom_’gše
(
’gše
, 
cÚfig
).
unw¿p
();

47 
	gSyncStÜage
 {

48 
	g¡Üe
: 
¡Üage
,

49 
	gút
: 
Arc
::
Ãw
(
AtomicUsize
::new(0)),

53 
pub
 
â
 
¡¬t
(&
mut
 
£lf
, 
cÚfig
: &
CÚfig
) {

54 
£lf
.
¡Üe
.
¡¬t
(
cÚfig
).
unw¿p
();

57 
pub
 
â
 
g‘_¡Üage
(&
£lf
è-> 
	gStÜage
 {

58 
	g£lf
.
	g¡Üe
.
şÚe
()

61 
pub
 
â
 
g‘_’gše
(&
£lf
è-> 
	gBox
<
	gEngše
> {

62 
	g£lf
.
	g¡Üe
.
g‘_’gše
()

65 
pub
 
â
 
g‘
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
key
: &
Key
, 
¡¬t_ts
: 
u64
è-> 
ResuÉ
<
O±iÚ
<
V®ue
>> {

66 
wa™_İ
!(|
cb
| {

67 
£lf
.
¡Üe


68 .
async_g‘
(
ùx
, 
key
.
to_owÃd
(), 
¡¬t_ts
, 
cb
)

69 .
unw¿p
()

70 }).
unw¿p
()

73 #[
®low
(
d—d_code
)]

74 
pub
 
â
 
b©ch_g‘
(

75 &
£lf
,

76 
ùx
: 
CÚ‹xt
,

77 
keys
: &[
Key
],

78 
¡¬t_ts
: 
u64
,

79 è-> 
	gResuÉ
<
	gVec
<ResuÉ<
	gKvPaœ
>>> {

80 
	gwa™_İ
!(|
	gcb
| {

81 
	g£lf
.
	g¡Üe


82 .
async_b©ch_g‘
(
ùx
, 
keys
.
to_owÃd
(), 
¡¬t_ts
, 
cb
)

83 .
unw¿p
()

84 }).
unw¿p
()

87 
pub
 
â
 
sÿn
(

88 &
£lf
,

89 
ùx
: 
CÚ‹xt
,

90 
key
: 
Key
,

91 
lim™
: 
usize
,

92 
key_Úly
: 
boŞ
,

93 
¡¬t_ts
: 
u64
,

94 è-> 
	gResuÉ
<
	gVec
<ResuÉ<
	gKvPaœ
>>> {

95 
	gwa™_İ
!(|
	gcb
| {

96 
	g£lf
.
	g¡Üe


97 .
async_sÿn
(

98 
ùx
,

99 
key
,

100 
lim™
,

101 
¡¬t_ts
,

102 
O±iÚs
::
Ãw
(0, 
çl£
, 
key_Úly
),

103 
cb
,

105 .
unw¿p
()

106 }).
unw¿p
()

109 
pub
 
â
 
´ewr™e
(

110 &
£lf
,

111 
ùx
: 
CÚ‹xt
,

112 
mutiÚs
: 
Vec
<
MutiÚ
>,

113 
´im¬y
: 
Vec
<
u8
>,

114 
¡¬t_ts
: 
u64
,

115 è-> 
	gResuÉ
<
	gVec
<Result<()>>> {

116 
	gwa™_İ
!(|
	gcb
| {

117 
	g£lf
.
	g¡Üe


118 .
async_´ewr™e
(
ùx
, 
mutiÚs
, 
´im¬y
, 
¡¬t_ts
, 
O±iÚs
::(), 
cb
)

119 .
unw¿p
()

120 }).
unw¿p
()

123 
pub
 
â
 
comm™
(

124 &
£lf
,

125 
ùx
: 
CÚ‹xt
,

126 
keys
: 
Vec
<
Key
>,

127 
¡¬t_ts
: 
u64
,

128 
comm™_ts
: 
u64
,

129 è-> 
	gResuÉ
<()> {

130 
	gwa™_İ
!(|
	gcb
| {

131 
	g£lf
.
	g¡Üe


132 .
async_comm™
(
ùx
, 
keys
, 
¡¬t_ts
, 
comm™_ts
, 
cb
)

133 .
unw¿p
()

134 }).
unw¿p
()

137 
pub
 
â
 
ş—nup
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
key
: 
Key
, 
¡¬t_ts
: 
u64
è-> 
ResuÉ
<()> {

138 
wa™_İ
!(|
cb
| {

139 
£lf
.
¡Üe
.
async_ş—nup
(
ùx
, 
key
, 
¡¬t_ts
, 
cb
).
unw¿p
()

140 }).
unw¿p
()

143 
pub
 
â
 
rŞlback
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
keys
: 
Vec
<
Key
>, 
¡¬t_ts
: 
u64
è-> 
ResuÉ
<()> {

144 
wa™_İ
!(|
cb
| {

145 
£lf
.
¡Üe
.
async_rŞlback
(
ùx
, 
keys
, 
¡¬t_ts
, 
cb
).
unw¿p
()

146 }).
unw¿p
()

149 
pub
 
â
 
sÿn_lock
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
max_ts
: 
u64
è-> 
ResuÉ
<
Vec
<
LockInfo
>> {

150 
wa™_İ
!(|
cb
| 
£lf
.
¡Üe
.
async_sÿn_lock
(
ùx
, 
max_ts
, cb).
unw¿p
()).unwrap()

153 
pub
 
â
 
»sŞve_lock
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
¡¬t_ts
: 
u64
, 
comm™_ts
: 
O±iÚ
<u64>è-> 
ResuÉ
<()> {

154 
Ët
 
mut
 
txn_¡©us
 = 
HashM­
::();

155 
	gtxn_¡©us
.
š£¹
(
¡¬t_ts
, 
comm™_ts
.
unw¿p_Ü
(0));

156 
	gwa™_İ
!(|
	gcb
| {

157 
	g£lf
.
	g¡Üe
.
async_»sŞve_lock
(
ùx
, 
txn_¡©us
, 
cb
).
unw¿p
()

158 }).
unw¿p
()

161 
pub
 
â
 
»sŞve_lock_b©ch
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
txns
: 
Vec
<(
u64
, u64)>è-> 
	gResuÉ
<()> {

162 
Ët
 
	gtxn_¡©us
: 
HashM­
<
u64
, 
	gu64
> = 
txns
.
što_™”
().
cŞËù
();

163 
	gwa™_İ
!(|
	gcb
| {

164 
	g£lf
.
	g¡Üe
.
async_»sŞve_lock
(
ùx
, 
txn_¡©us
, 
cb
).
unw¿p
()

165 }).
unw¿p
()

168 
pub
 
â
 
gc
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
§ã_pošt
: 
u64
è-> 
ResuÉ
<()> {

169 
wa™_İ
!(|
cb
| 
£lf
.
¡Üe
.
async_gc
(
ùx
, 
§ã_pošt
, cb).
unw¿p
()).unwrap()

172 
pub
 
â
 
¿w_g‘
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
key
: 
Vec
<
u8
>è-> 
ResuÉ
<
O±iÚ
<Vec<u8>>> {

173 
wa™_İ
!(|
cb
| 
£lf
.
¡Üe
.
async_¿w_g‘
(
ùx
, 
key
, cb).
unw¿p
()).unwrap()

176 
pub
 
â
 
¿w_put
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
key
: 
Vec
<
u8
>, 
v®ue
: Vec<u8>è-> 
ResuÉ
<()> {

177 
wa™_İ
!(|
cb
| 
£lf
.
¡Üe
.
async_¿w_put
(
ùx
, 
key
, 
v®ue
, cb).
unw¿p
()).unwrap()

180 
pub
 
â
 
¿w_d–‘e
(&
£lf
, 
ùx
: 
CÚ‹xt
, 
key
: 
Vec
<
u8
>è-> 
ResuÉ
<()> {

181 
wa™_İ
!(|
cb
| 
£lf
.
¡Üe
.
async_¿w_d–‘e
(
ùx
, 
key
, cb).
unw¿p
()).unwrap()

184 
pub
 
â
 
¿w_sÿn
(

185 &
£lf
,

186 
ùx
: 
CÚ‹xt
,

187 
¡¬t_key
: 
Vec
<
u8
>,

188 
lim™
: 
usize
,

189 è-> 
	gResuÉ
<
	gVec
<ResuÉ<
	gKvPaœ
>>> {

190 
	gwa™_İ
!(|
	gcb
| {

191 
	g£lf
.
	g¡Üe


192 .
async_¿w_sÿn
(
ùx
, 
¡¬t_key
, 
lim™
, 
cb
)

193 .
unw¿p
()

194 }).
unw¿p
()

198 
im¶
 
ClÚe
 
	gSyncStÜage
 {

199 
â
 
şÚe
(&
£lf
è-> 
	gSyncStÜage
 {

200 
	g£lf
.
	gút
.
ãtch_add
(1, 
Ord”šg
::
SeqC¡
);

201 
	gSyncStÜage
 {

202 
	g¡Üe
: 
£lf
.
¡Üe
.
şÚe
(),

203 
	gút
: 
£lf
.
út
.
şÚe
(),

208 
im¶
 
Drİ
 
	gSyncStÜage
 {

209 
â
 
drİ
(&
mut
 
£lf
) {

210 
	g£lf
.
	gút
.
ãtch_sub
(1, 
Ord”šg
::
SeqC¡
) == 0 {

211 
£lf
.
¡Üe
.
¡İ
().
unw¿p
()

	@tests/storage/test_raft_storage.rs

14 
u£
 
	g¡d
::
th»ad
;

15 
u£
 
	g¡d
::
sync
::
mpsc
::
chªÃl
;

16 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

18 
u£
 
	gtikv
::
ut
::
HªdyRwLock
;

19 
u£
 
	gtikv
::
¡Üage
::{
£lf
, 
	gmake_key
, 
	gEngše
, 
	gMutiÚ
, 
	gO±iÚs
, 
	gStÜage
};

20 
u£
 
	gtikv
::
¡Üage
::{
’gše
, 
	gmvcc
, 
	gtxn
};

21 
u£
 
	gtikv
::
¡Üage
::
cÚfig
::
CÚfig
;

22 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

23 
u£
 
	g¿á¡Üe
::
£rv”
::
Ãw_£rv”_şu¡”
;

24 
u£
 
	g¿á¡Üe
::
şu¡”
::
Clu¡”
;

25 
u£
 
	g¿á¡Üe
::
£rv”
::
S”v”Clu¡”
;

26 
u£
 
	g¿á¡Üe
::
ut
::*;

27 
u£
 
	g¡Üage
::
ut
;

28 
u£
 
	gsu³r
::
sync_¡Üage
::
SyncStÜage
;

29 
u£
 
	gsu³r
::
ut
::
Ãw_¿á_¡Üage_w™h_¡Üe_couÁ
;

31 
â
 
Ãw_¿á_¡Üage
(è-> (
	gClu¡”
<
	gS”v”Clu¡”
>, 
	gSyncStÜage
, 
	gCÚ‹xt
) {

32 
Ãw_¿á_¡Üage_w™h_¡Üe_couÁ
(1, "")

35 #[
‹¡
]

36 
â
 
	$‹¡_¿á_¡Üage
() {

37 
	`Ët
 (
_şu¡”
, 
¡Üage
, 
mut
 
ùx
èğ
	`Ãw_¿á_¡Üage
();

38 
Ët
 
key
 = 
	`make_key
(
b
"key");

39 
as£¹_eq
!(
¡Üage
.
	`g‘
(
ùx
.
	`şÚe
(), &
key
, 5).
	`unw¿p
(), 
NÚe
);

40 
¡Üage


41 .
	`´ewr™e
(

42 
ùx
.
	`şÚe
(),

43 
vec
![
MutiÚ
::
	`Put
((
key
.
	`şÚe
(), 
b
"v®ue".
	`to_vec
()))],

44 
b
"key".
	`to_vec
(),

47 .
	`unw¿p
();

48 
¡Üage


49 .
	`comm™
(
ùx
.
	`şÚe
(), 
vec
![
key
.clone()], 10, 15)

50 .
	`unw¿p
();

51 
as£¹_eq
!(

52 
¡Üage
.
	`g‘
(
ùx
.
	`şÚe
(), &
key
, 20).
	`unw¿p
().unwrap(),

53 
b
"v®ue".
	`to_vec
()

57 
Ët
 
»giÚ_id
 = 
ùx
.
	`g‘_»giÚ_id
();

58 
ùx
.
	`£t_»giÚ_id
(
»giÚ_id
 + 1);

59 
as£¹
!(
¡Üage
.
	`g‘
(
ùx
.
	`şÚe
(), &
key
, 20).
	`is_”r
());

60 
as£¹
!(
¡Üage
.
	`b©ch_g‘
(
ùx
.
	`şÚe
(), &[
key
.şÚe()], 20).
	`is_”r
());

61 
as£¹
!(

62 
¡Üage


63 .
	`sÿn
(
ùx
.
	`şÚe
(), 
key
.şÚe(), 1, 
çl£
, 20)

64 .
	`is_”r
()

66 
as£¹
!(
¡Üage
.
	`sÿn_lock
(
ùx
.
	`şÚe
(), 20).
	`is_”r
());

67 
	}
}

69 #[
‹¡
]

70 
â
 
	$‹¡_¿á_¡Üage_g‘_aá”_Ëa£
() {

71 
	`Ët
 (
_şu¡”
, 
¡Üage
, 
ùx
èğ
	`Ãw_¿á_¡Üage
();

72 
Ët
 
key
 = 
b
"key";

73 
Ët
 
v®ue
 = 
b
"value";

74 
as£¹_eq
!(
¡Üage
.
	`¿w_g‘
(
ùx
.
	`şÚe
(), 
key
.
	`to_vec
()).
	`unw¿p
(), 
NÚe
);

75 
¡Üage


76 .
	`¿w_put
(
ùx
.
	`şÚe
(), 
key
.
	`to_vec
(), 
v®ue
.to_vec())

77 .
	`unw¿p
();

78 
as£¹_eq
!(

79 
¡Üage
.
	`¿w_g‘
(
ùx
.
	`şÚe
(), 
key
.
	`to_vec
()).
	`unw¿p
().unwrap(),

80 
v®ue
.
	`to_vec
()

84 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_mlis
(
MAX_LEADER_LEASE
));

85 
as£¹_eq
!(

86 
¡Üage
.
	`¿w_g‘
(
ùx
.
	`şÚe
(), 
key
.
	`to_vec
()).
	`unw¿p
().unwrap(),

87 
v®ue
.
	`to_vec
()

89 
	}
}

91 #[
‹¡
]

92 
â
 
	$‹¡_¿á_¡Üage_rŞlback_befÜe_´ewr™e
() {

93 
	`Ët
 (
_şu¡”
, 
¡Üage
, 
ùx
èğ
	`Ãw_¿á_¡Üage
();

94 
Ët
 
»t
 = 
¡Üage
.
	`rŞlback
(
ùx
.
	`şÚe
(), 
vec
![
	`make_key
(
b
"key")], 10);

95 
as£¹
!(
»t
.
	`is_ok
());

96 
Ët
 
»t
 = 
¡Üage
.
	`´ewr™e
(

97 
ùx
.
	`şÚe
(),

98 
vec
![
MutiÚ
::
	`Put
((
	`make_key
(
b
"key"), b"v®ue".
	`to_vec
()))],

99 
b
"key".
	`to_vec
(),

102 
as£¹
!(
»t
.
	`is_”r
());

103 
Ët
 
”r
 = 
»t
.
	`unw¿p_”r
();

104 
m©ch
 
”r
 {

105 
¡Üage
::
E¼Ü
::
	`Txn
(
txn
::E¼Ü::
	`Mvcc
(
mvcc
::E¼Ü::
Wr™eCÚæiù
 { .. })) => {}

106 
_
 => {

107 
·nic
!("ex³ù Wr™eCÚæiùƒ¼Ü, buˆgÙ {:?}", 
”r
);

110 
	}
}

112 #[
‹¡
]

113 
â
 
	$‹¡_¿á_¡Üage_¡Üe_nÙ_m©ch
() {

114 
	`Ët
 (
_şu¡”
, 
¡Üage
, 
mut
 
ùx
èğ
	`Ãw_¿á_¡Üage
();

116 
Ët
 
key
 = 
	`make_key
(
b
"key");

117 
as£¹_eq
!(
¡Üage
.
	`g‘
(
ùx
.
	`şÚe
(), &
key
, 5).
	`unw¿p
(), 
NÚe
);

118 
¡Üage


119 .
	`´ewr™e
(

120 
ùx
.
	`şÚe
(),

121 
vec
![
MutiÚ
::
	`Put
((
key
.
	`şÚe
(), 
b
"v®ue".
	`to_vec
()))],

122 
b
"key".
	`to_vec
(),

125 .
	`unw¿p
();

126 
¡Üage


127 .
	`comm™
(
ùx
.
	`şÚe
(), 
vec
![
key
.clone()], 10, 15)

128 .
	`unw¿p
();

129 
as£¹_eq
!(

130 
¡Üage
.
	`g‘
(
ùx
.
	`şÚe
(), &
key
, 20).
	`unw¿p
().unwrap(),

131 
b
"v®ue".
	`to_vec
()

135 
Ët
 
mut
 
³”
 = 
ùx
.
	`g‘_³”
().
	`şÚe
();

136 
Ët
 
¡Üe_id
 = 
³”
.
	`g‘_¡Üe_id
();

138 
³”
.
	`£t_¡Üe_id
(
¡Üe_id
 + 1);

139 
ùx
.
	`£t_³”
(
³”
);

140 
as£¹
!(
¡Üage
.
	`g‘
(
ùx
.
	`şÚe
(), &
key
, 20).
	`is_”r
());

141 
Ët
 
»s
 = 
¡Üage
.
	`g‘
(
ùx
.
	`şÚe
(), &
key
, 20);

142 
Ët
 
¡Üage
::
E¼Ü
::
	`Txn
(
txn
::E¼Ü::
	`Engše
(
’gše
::E¼Ü::
	`Reque¡
(
»f
 
e
))) =

143 *
»s
.
	`as_»f
().
	`”r
().
	`unw¿p
()

145 
as£¹
!(
e
.
	`has_¡Üe_nÙ_m©ch
());

147 
·nic
!("ex³ù stÜe_nÙ_m©ch, buˆgÙ {:?}", 
»s
);

149 
as£¹
!(
¡Üage
.
	`b©ch_g‘
(
ùx
.
	`şÚe
(), &[
key
.şÚe()], 20).
	`is_”r
());

150 
as£¹
!(

151 
¡Üage


152 .
	`sÿn
(
ùx
.
	`şÚe
(), 
key
.şÚe(), 1, 
çl£
, 20)

153 .
	`is_”r
()

155 
as£¹
!(
¡Üage
.
	`sÿn_lock
(
ùx
.
	`şÚe
(), 20).
	`is_”r
());

156 
	}
}

158 #[
‹¡
]

159 
â
 
	$‹¡_’gše_Ëad”_chªge_twiû
() {

160 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 3);

161 
şu¡”
.
	`run
();

163 
Ët
 
»giÚ
 = 
şu¡”
.
	`g‘_»giÚ
(
b
"");

164 
Ët
 
³”s
 = 
»giÚ
.
	`g‘_³”s
();

166 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(
»giÚ
.
	`g‘_id
(), 
³”s
[0].
	`şÚe
());

167 
Ët
 
’gše
 = 
şu¡”
.
sim
.
	`¾
().
¡Üages
[&
³”s
[0].
	`g‘_id
()].
	`şÚe
();

169 
Ët
 
‹rm
 = 
şu¡”


170 .
	`»que¡
(
b
"", 
vec
![
	`Ãw_g‘_cmd
(b"")], 
Œue
, 
Du¿tiÚ
::
	`äom_£cs
(5))

171 .
	`g‘_h—d”
()

172 .
	`g‘_cu¼’t_‹rm
();

174 
Ët
 
mut
 
ùx
 = 
CÚ‹xt
::
	`Ãw
();

175 
ùx
.
	`£t_»giÚ_id
(
»giÚ
.
	`g‘_id
());

176 
ùx
.
	`£t_»giÚ_•och
(
»giÚ
.
	`g‘_»giÚ_•och
().
	`şÚe
());

177 
ùx
.
	`£t_³”
(
³”s
[0].
	`şÚe
());

178 
ùx
.
	`£t_‹rm
(
‹rm
);

181 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(
»giÚ
.
	`g‘_id
(), 
³”s
[1].
	`şÚe
());

182 
as£¹
!(
’gše
.
	`wr™e
(&
ùx
, 
vec
![]).
	`is_”r
());

184 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(
»giÚ
.
	`g‘_id
(), 
³”s
[0].
	`şÚe
());

185 
Ët
 
»s
 = 
’gše
.
	`wr™e
(&
ùx
, 
vec
![]);

186 
Ët
 
’gše
::
E¼Ü
::
	`Reque¡
(
»f
 
e
èğ*
»s
.
	`as_»f
().
	`”r
().
	`unw¿p
() {

187 
as£¹
!(
e
.
	`has_¡®e_commªd
());

189 
·nic
!("ex³ù sË commªd, buˆgÙ {:?}", 
»s
);

191 
	}
}

193 #[
‹¡
]

194 
â
 
	$‹¡_scheduËr_Ëad”_chªge_twiû
() {

195 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”
(0, 2);

196 
şu¡”
.
	`run
();

197 
Ët
 
»giÚ0
 = 
şu¡”
.
	`g‘_»giÚ
(
b
"");

198 
Ët
 
³”s
 = 
»giÚ0
.
	`g‘_³”s
();

199 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(
»giÚ0
.
	`g‘_id
(), 
³”s
[0].
	`şÚe
());

200 
Ët
 
cÚfig
 = 
CÚfig
::();

202 
Ët
 
’gše0
 = 
şu¡”
.
sim
.
	`¾
().
¡Üages
[&
³”s
[0].
	`g‘_id
()].
	`şÚe
();

203 
Ët
 
mut
 
’gše0
 = 
ut
::
BlockEngše
::
	`Ãw
(engine0);

204 
Ët
 
mut
 
¡Üage0
 = 
StÜage
::
	`äom_’gše
(
’gše0
.
	`şÚe
(), &
cÚfig
).
	`unw¿p
();

205 
¡Üage0
.
	`¡¬t
(&
cÚfig
).
	`unw¿p
();

207 
Ët
 
mut
 
ùx0
 = 
CÚ‹xt
::
	`Ãw
();

208 
ùx0
.
	`£t_»giÚ_id
(
»giÚ0
.
	`g‘_id
());

209 
ùx0
.
	`£t_»giÚ_•och
(
»giÚ0
.
	`g‘_»giÚ_•och
().
	`şÚe
());

210 
ùx0
.
	`£t_³”
(
³”s
[0].
	`şÚe
());

211 
	`Ët
 (
´ewr™e_tx
, 
´ewr™e_rx
èğ
	`chªÃl
();

212 
	`Ët
 (
¡x
, 
¤x
èğ
	`chªÃl
();

213 
’gše0
.
	`block_¢­shÙ
(
¡x
.
	`şÚe
());

214 
¡Üage0
.
	`async_´ewr™e
(
ùx0
,

215 
vec
![
MutiÚ
::
	`Put
((
	`make_key
(
b
"k"), b"v".
	`to_vec
()))],

216 
b
"k".
	`to_vec
(),

218 
O±iÚs
::(),

219 
box
 
move
 |
»s
: 
¡Üage
::
ResuÉ
<
_
>| {

220 
m©ch
 
»s
 {

221 
	`E¼
(
¡Üage
::
E¼Ü
::
	`Engše
(
’gše
::E¼Ü::
	`Reque¡
(
»f
 
e
))) => {

222 
as£¹
!(
e
.
	`has_¡®e_commªd
());

223 
´ewr™e_tx
.
	`£nd
(
çl£
).
	`unw¿p
();

225 
	`Ok
(
_
) => {

226 
´ewr™e_tx
.
	`£nd
(
Œue
).
	`unw¿p
();

228 
_
 => {

229 
·nic
!("ex³ù sË commªd, buˆgÙ {:?}", 
»s
);

233 .
	`unw¿p
();

235 
¤x
.
	`»cv_timeout
(
Du¿tiÚ
::
	`äom_£cs
(2)).
	`unw¿p
();

237 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(
»giÚ0
.
	`g‘_id
(), 
³”s
[1].
	`şÚe
());

238 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(
»giÚ0
.
	`g‘_id
(), 
³”s
[0].
	`şÚe
());

239 
’gše0
.
	`unblock_¢­shÙ
();

242 
Ët
 
ok
 = 
´ewr™e_rx
.
	`»cv_timeout
(
Du¿tiÚ
::
	`äom_£cs
(5)).
	`unw¿p
();

243 
ok
 {

244 
Ët
 
»giÚ1
 = 
şu¡”
.
	`g‘_»giÚ
(
b
"");

245 
şu¡”
.
	`mu¡_Œªsãr_Ëad”
(
»giÚ1
.
	`g‘_id
(), 
³”s
[1].
	`şÚe
());

247 
Ët
 
’gše1
 = 
şu¡”
.
sim
.
	`¾
().
¡Üages
[&
³”s
[1].
	`g‘_id
()].
	`şÚe
();

248 
Ët
 
mut
 
¡Üage1
 = 
StÜage
::
	`äom_’gše
(
’gše1
, &
cÚfig
).
	`unw¿p
();

249 
¡Üage1
.
	`¡¬t
(&
cÚfig
).
	`unw¿p
();

250 
Ët
 
mut
 
ùx1
 = 
CÚ‹xt
::
	`Ãw
();

251 
ùx1
.
	`£t_»giÚ_id
(
»giÚ1
.
	`g‘_id
());

252 
ùx1
.
	`£t_»giÚ_•och
(
»giÚ1
.
	`g‘_»giÚ_•och
().
	`şÚe
());

253 
ùx1
.
	`£t_³”
(
³”s
[1].
	`şÚe
());

255 
	`Ët
 (
comm™_tx
, 
comm™_rx
èğ
	`chªÃl
();

256 
¡Üage1


257 .
	`async_comm™
(

258 
ùx1
,

259 
vec
![
	`make_key
(
b
"k")],

262 
box
 
move
 |
»s
: 
¡Üage
::
ResuÉ
<
_
>| { 
comm™_tx
.
	`£nd
Ôes).
	`unw¿p
(); },

264 .
	`unw¿p
();

266 
Ët
 
»s
 = 
comm™_rx
.
	`»cv_timeout
(
Du¿tiÚ
::
	`äom_£cs
(5)).
	`unw¿p
();

267 
»s
.
	`as_»f
().
	`is_”r
() {

268 
·nic
!("ex³ù Ok(_), buˆgÙ {:?}", 
»s
);

271 
	}
}

	@tests/storage/test_raftkv.rs

1 
u£
 
	g¡d
::
th»ad
;

2 
u£
 
	g¡d
::
sync
::
mpsc
::
chªÃl
;

3 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

5 
u£
 
	gtikv
::
ut
::
HªdyRwLock
;

6 
u£
 
	gtikv
::
¡Üage
::
’gše
::*;

7 
u£
 
	gtikv
::
¡Üage
::{
CFSti¡ics
, 
	gCfName
, 
	gKey
, 
	gCF_DEFAULT
};

8 
u£
 
	gtikv
::
ut
::
codec
::
by‹s
;

9 
u£
 
	gtikv
::
ut
::
esÿ³
;

10 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

11 
u£
 
	g¿á¡Üe
::
Œª¥Üt_simuÏ‹
::
IsŞ©iÚF‹rFaùÜy
;

12 
u£
 
	g¿á¡Üe
::
£rv”
::
Ãw_£rv”_şu¡”_w™h_cfs
;

13 
u£
 
	gtikv
::
¿á¡Üe
::
¡Üe
::
’gše
::
I‹rO±iÚ
;

15 
u£
 
	g¿á¡Üe
::
ut
::
MAX_LEADER_LEASE
;

17 #[
‹¡
]

18 
â
 
	$‹¡_¿ákv
() {

19 
Ët
 
couÁ
 = 1;

20 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”_w™h_cfs
(0, 
couÁ
, &["cf"]);

21 
şu¡”
.
	`run
();

24 
as£¹_eq
!(
şu¡”
.
	`mu¡_g‘
(
b
"k1"), 
NÚe
);

26 
Ët
 
»giÚ
 = 
şu¡”
.
	`g‘_»giÚ
(
b
"");

27 
Ët
 
Ëad”_id
 = 
şu¡”
.
	`Ëad”_of_»giÚ
(
»giÚ
.
	`g‘_id
()).
	`unw¿p
();

28 
Ët
 
¡Üage
 = 
şu¡”
.
sim
.
	`¾
().
¡Üages
[&
Ëad”_id
.
	`g‘_id
()].
	`şÚe
();

30 
Ët
 
mut
 
ùx
 = 
CÚ‹xt
::
	`Ãw
();

31 
ùx
.
	`£t_»giÚ_id
(
»giÚ
.
	`g‘_id
());

32 
ùx
.
	`£t_»giÚ_•och
(
»giÚ
.
	`g‘_»giÚ_•och
().
	`şÚe
());

33 
ùx
.
	`£t_³”
(
»giÚ
.
	`g‘_³”s
()[0].
	`şÚe
());

35 
	`g‘_put
(&
ùx
, 
¡Üage
.
	`as_»f
());

36 
	`b©ch
(&
ùx
, 
¡Üage
.
	`as_»f
());

37 
	`£ek
(&
ùx
, 
¡Üage
.
	`as_»f
());

38 
	`Ã¬_£ek
(&
ùx
, 
¡Üage
.
	`as_»f
());

39 
	`cf
(&
ùx
, 
¡Üage
.
	`as_»f
());

40 
	`em±y_wr™e
(&
ùx
, 
¡Üage
.
	`as_»f
());

41 
	`wrÚg_cÚ‹xt
(&
ùx
, 
¡Üage
.
	`as_»f
());

43 
	}
}

45 #[
‹¡
]

46 
â
 
	$‹¡_»ad_Ëad”_š_Ëa£
() {

47 
Ët
 
couÁ
 = 3;

48 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”_w™h_cfs
(0, 
couÁ
, &["cf"]);

49 
şu¡”
.
	`run
();

51 
Ët
 
k1
 = 
b
"k1";

52 
	`Ët
 (
k2
, 
v2
èğ(
b
"k2", b"v2");

55 
as£¹_eq
!(
şu¡”
.
	`mu¡_g‘
(
k1
), 
NÚe
);

57 
Ët
 
»giÚ
 = 
şu¡”
.
	`g‘_»giÚ
(
b
"");

58 
Ët
 
Ëad”
 = 
şu¡”
.
	`Ëad”_of_»giÚ
(
»giÚ
.
	`g‘_id
()).
	`unw¿p
();

59 
Ët
 
¡Üage
 = 
şu¡”
.
sim
.
	`¾
().
¡Üages
[&
Ëad”
.
	`g‘_id
()].
	`şÚe
();

61 
Ët
 
mut
 
ùx
 = 
CÚ‹xt
::
	`Ãw
();

62 
ùx
.
	`£t_»giÚ_id
(
»giÚ
.
	`g‘_id
());

63 
ùx
.
	`£t_»giÚ_•och
(
»giÚ
.
	`g‘_»giÚ_•och
().
	`şÚe
());

64 
ùx
.
	`£t_³”
(
Ëad”
.
	`şÚe
());

67 
	`as£¹_nÚe
(&
ùx
, 
¡Üage
.
	`as_»f
(), 
k2
);

68 
	`mu¡_put
(&
ùx
, 
¡Üage
.
	`as_»f
(), 
k2
, 
v2
);

71 
şu¡”
.
	`add_£nd_f‹r
(
IsŞ©iÚF‹rFaùÜy
::
	`Ãw
(
Ëad”
.
	`g‘_¡Üe_id
()));

74 
as£¹_eq
!(
	`ÿn_»ad
(&
ùx
, 
¡Üage
.
	`as_»f
(), 
k2
, 
v2
), 
Œue
);

75 
	}
}

77 #[
‹¡
]

78 
â
 
	$‹¡_b©ch_¢­shÙ
() {

79 
Ët
 
couÁ
 = 3;

80 
Ët
 
mut
 
şu¡”
 = 
	`Ãw_£rv”_şu¡”_w™h_cfs
(0, 
couÁ
, &["cf"]);

81 
şu¡”
.
	`run
();

83 
Ët
 
key
 = 
b
"key";

85 
as£¹_eq
!(
şu¡”
.
	`mu¡_g‘
(
key
), 
NÚe
);

87 
Ët
 
»giÚ
 = 
şu¡”
.
	`g‘_»giÚ
(
b
"");

88 
Ët
 
Ëad”
 = 
şu¡”
.
	`Ëad”_of_»giÚ
(
»giÚ
.
	`g‘_id
()).
	`unw¿p
();

89 
Ët
 
¡Üage
 = 
şu¡”
.
sim
.
	`¾
().
¡Üages
[&
Ëad”
.
	`g‘_id
()].
	`şÚe
();

91 
Ët
 
mut
 
ùx
 = 
CÚ‹xt
::
	`Ãw
();

92 
ùx
.
	`£t_»giÚ_id
(
»giÚ
.
	`g‘_id
());

93 
ùx
.
	`£t_»giÚ_•och
(
»giÚ
.
	`g‘_»giÚ_•och
().
	`şÚe
());

94 
ùx
.
	`£t_³”
(
Ëad”
.
	`şÚe
());

96 
Ët
 
size
 = 3;

97 
Ët
 
b©ch
 = 
vec
![
ùx
.
	`şÚe
(); 
size
];

98 
Ët
 
¢­shÙs
 = 
	`mut_b©ch_¢­shÙ
(
b©ch
, 
¡Üage
.
	`as_»f
());

99 
as£¹_eq
!(
size
, 
¢­shÙs
.
	`Ën
());

100 
s
 
š
 
¢­shÙs
 {

101 
as£¹
!(
s
.
	`is_some
());

104 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_mlis
(
MAX_LEADER_LEASE
));

105 
Ët
 
b©ch
 = 
vec
![
ùx
; 
size
];

106 
Ët
 
¢­shÙs
 = 
	`mut_b©ch_¢­shÙ
(
b©ch
, 
¡Üage
.
	`as_»f
());

107 
as£¹_eq
!(
size
, 
¢­shÙs
.
	`Ën
());

108 
s
 
š
 
¢­shÙs
 {

109 
as£¹
!(
s
.
	`is_nÚe
());

111 
	}
}

113 
pub
 
â
 
make_key
(
k
: &[
u8
]è-> 
Key
 {

114 
Key
::
äom_¿w
(
k
)

117 
â
 
mut_b©ch_¢­shÙ
(
b©ch
: 
Vec
<
CÚ‹xt
>, 
’gše
: &
Engše
è-> 
B©chResuÉs
<
Box
<
SÇpshÙ
>> {

118 
Ët
 (
tx
, 
rx
èğ
chªÃl
();

119 
Ët
 
	gÚ_fšished
 = 
box
 
move
 |
¢­shÙs
| { 
tx
.
£nd
(¢­shÙs).
unw¿p
(); };

120 
	g’gše
.
async_b©ch_¢­shÙ
(
b©ch
, 
Ú_fšished
).
unw¿p
();

121 
	grx
.
»cv
().
unw¿p
()

124 
â
 
	$mu¡_put
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

125 
’gše
.
	`put
(
ùx
, 
	`make_key
(
key
), 
v®ue
.
	`to_vec
()).
	`unw¿p
();

126 
	}
}

128 
â
 
	$mu¡_put_cf
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
cf
: 
CfName
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

129 
’gše


130 .
	`put_cf
(
ùx
, 
cf
, 
	`make_key
(
key
), 
v®ue
.
	`to_vec
())

131 .
	`unw¿p
();

132 
	}
}

134 
â
 
	$mu¡_d–‘e
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
key
: &[
u8
]) {

135 
’gše
.
	`d–‘e
(
ùx
, 
	`make_key
(
key
)).
	`unw¿p
();

136 
	}
}

138 
â
 
	$mu¡_d–‘e_cf
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
cf
: 
CfName
, 
key
: &[
u8
]) {

139 
’gše
.
	`d–‘e_cf
(
ùx
, 
cf
, 
	`make_key
(
key
)).
	`unw¿p
();

140 
	}
}

142 
â
 
	$as£¹_has
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

143 
Ët
 
¢­shÙ
 = 
’gše
.
	`¢­shÙ
(
ùx
).
	`unw¿p
();

144 
as£¹_eq
!(
¢­shÙ
.
	`g‘
(&
	`make_key
(
key
)).
	`unw¿p
().unw¿p(), 
v®ue
);

145 
	}
}

147 
â
 
ÿn_»ad
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
key
: &[
u8
], 
v®ue
: &[u8]è-> 
boŞ
 {

148 
Ët
 
Ok
(
s
èğ
’gše
.
¢­shÙ
(
ùx
) {

149 
as£¹_eq
!(
s
.
g‘
(&
make_key
(
key
)).
unw¿p
().unw¿p(), 
v®ue
);

150  
	gŒue
;

152 
	gçl£


155 
â
 
	$as£¹_has_cf
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
cf
: 
CfName
, 
key
: &[
u8
], 
v®ue
: &[u8]) {

156 
Ët
 
¢­shÙ
 = 
’gše
.
	`¢­shÙ
(
ùx
).
	`unw¿p
();

157 
as£¹_eq
!(
¢­shÙ
.
	`g‘_cf
(
cf
, &
	`make_key
(
key
)).
	`unw¿p
().unw¿p(), 
v®ue
);

158 
	}
}

160 
â
 
	$as£¹_nÚe
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
key
: &[
u8
]) {

161 
Ët
 
¢­shÙ
 = 
’gše
.
	`¢­shÙ
(
ùx
).
	`unw¿p
();

162 
as£¹_eq
!(
¢­shÙ
.
	`g‘
(&
	`make_key
(
key
)).
	`unw¿p
(), 
NÚe
);

163 
	}
}

165 
â
 
	$as£¹_nÚe_cf
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
cf
: 
CfName
, 
key
: &[
u8
]) {

166 
Ët
 
¢­shÙ
 = 
’gše
.
	`¢­shÙ
(
ùx
).
	`unw¿p
();

167 
as£¹_eq
!(
¢­shÙ
.
	`g‘_cf
(
cf
, &
	`make_key
(
key
)).
	`unw¿p
(), 
NÚe
);

168 
	}
}

170 
â
 
as£¹_£ek
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
key
: &[
u8
], 
·œ
: (&[u8], &[u8])) {

171 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(
ùx
).
unw¿p
();

172 
Ët
 
mut
 
	g™”
 = 
¢­shÙ


173 .
™”
(
I‹rO±iÚ
::(), 
SÿnMode
::
Mixed
)

174 .
unw¿p
();

175 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

176 
	g™”
.
£ek
(&
make_key
(
key
), &
mut
 
¡©i¡ics
).
unw¿p
();

177 
	gas£¹_eq
!(

178 (
	g™”
.
key
(), i‹r.
v®ue
()),

179 (&*
	gby‹s
::
’code_by‹s
(
·œ
.0), 
	g·œ
.1)

183 
â
 
as£¹_£ek_cf
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
, 
cf
: 
CfName
, 
key
: &[
u8
], 
·œ
: (&[u8], &[u8])) {

184 
Ët
 
	g¢­shÙ
 = 
’gše
.
¢­shÙ
(
ùx
).
unw¿p
();

185 
Ët
 
mut
 
	g™”
 = 
¢­shÙ


186 .
™”_cf
(
cf
, 
I‹rO±iÚ
::(), 
SÿnMode
::
Mixed
)

187 .
unw¿p
();

188 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

189 
	g™”
.
£ek
(&
make_key
(
key
), &
mut
 
¡©i¡ics
).
unw¿p
();

190 
	gas£¹_eq
!(

191 (
	g™”
.
key
(), i‹r.
v®ue
()),

192 (&*
	gby‹s
::
’code_by‹s
(
·œ
.0), 
	g·œ
.1)

196 
â
 
as£¹_Ã¬_£ek
(
cursÜ
: &
mut
 
CursÜ
, 
key
: &[
u8
], 
·œ
: (&[u8], &[u8])) {

197 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

198 
	gas£¹
!(

199 
	gcursÜ
.
Ã¬_£ek
(&
make_key
(
key
), &
mut
 
¡©i¡ics
).
unw¿p
(),

200 
esÿ³
(
key
)

202 
	gas£¹_eq
!(

203 (
	gcursÜ
.
key
(), cursÜ.
v®ue
()),

204 (&*
	gby‹s
::
’code_by‹s
(
·œ
.0), 
	g·œ
.1)

208 
â
 
as£¹_Ã¬_»v”£_£ek
(
cursÜ
: &
mut
 
CursÜ
, 
key
: &[
u8
], 
·œ
: (&[u8], &[u8])) {

209 
Ët
 
mut
 
	g¡©i¡ics
 = 
CFSti¡ics
::();

210 
	gas£¹
!(

211 
	gcursÜ


212 .
Ã¬_»v”£_£ek
(&
make_key
(
key
), &
mut
 
¡©i¡ics
)

213 .
unw¿p
(),

214 
esÿ³
(
key
)

216 
	gas£¹_eq
!(

217 (
	gcursÜ
.
key
(), cursÜ.
v®ue
()),

218 (&*
	gby‹s
::
’code_by‹s
(
·œ
.0), 
	g·œ
.1)

222 
â
 
	$g‘_put
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
) {

223 
	`as£¹_nÚe
(
ùx
, 
’gše
, 
b
"x");

224 
	`mu¡_put
(
ùx
, 
’gše
, 
b
"x", b"1");

225 
	`as£¹_has
(
ùx
, 
’gše
, 
b
"x", b"1");

226 
	`mu¡_put
(
ùx
, 
’gše
, 
b
"x", b"2");

227 
	`as£¹_has
(
ùx
, 
’gše
, 
b
"x", b"2");

228 
	}
}

230 
â
 
	$b©ch
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
) {

231 
’gše


232 .
	`wr™e
(

233 
ùx
,

234 
vec
![

235 
Modify
::
	`Put
(
CF_DEFAULT
, 
	`make_key
(
b
"x"), b"1".
	`to_vec
()),

236 
Modify
::
	`Put
(
CF_DEFAULT
, 
	`make_key
(
b
"y"), b"2".
	`to_vec
()),

239 .
	`unw¿p
();

240 
	`as£¹_has
(
ùx
, 
’gše
, 
b
"x", b"1");

241 
	`as£¹_has
(
ùx
, 
’gše
, 
b
"y", b"2");

243 
’gše


244 .
	`wr™e
(

245 
ùx
,

246 
vec
![

247 
Modify
::
	`D–‘e
(
CF_DEFAULT
, 
	`make_key
(
b
"x")),

248 
Modify
::
	`D–‘e
(
CF_DEFAULT
, 
	`make_key
(
b
"y")),

251 .
	`unw¿p
();

252 
	`as£¹_nÚe
(
ùx
, 
’gše
, 
b
"y");

253 
	`as£¹_nÚe
(
ùx
, 
’gše
, 
b
"y");

254 
	}
}

256 
â
 
	$£ek
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
) {

257 
	`mu¡_put
(
ùx
, 
’gše
, 
b
"x", b"1");

258 
	`as£¹_£ek
(
ùx
, 
’gše
, 
b
"x", (b"x", b"1"));

259 
	`as£¹_£ek
(
ùx
, 
’gše
, 
b
"a", (b"x", b"1"));

260 
	`mu¡_put
(
ùx
, 
’gše
, 
b
"z", b"2");

261 
	`as£¹_£ek
(
ùx
, 
’gše
, 
b
"y", (b"z", b"2"));

262 
	`as£¹_£ek
(
ùx
, 
’gše
, 
b
"x\x00", (b"z", b"2"));

263 
Ët
 
¢­shÙ
 = 
’gše
.
	`¢­shÙ
(
ùx
).
	`unw¿p
();

264 
Ët
 
mut
 
™”
 = 
¢­shÙ


265 .
	`™”
(
I‹rO±iÚ
::(), 
SÿnMode
::
Mixed
)

266 .
	`unw¿p
();

267 
Ët
 
mut
 
¡©i¡ics
 = 
CFSti¡ics
::();

268 
as£¹
!(!
™”
.
	`£ek
(&
	`make_key
(
b
"z\x00"), &
mut
 
¡©i¡ics
).
	`unw¿p
());

269 
	`mu¡_d–‘e
(
ùx
, 
’gše
, 
b
"x");

270 
	`mu¡_d–‘e
(
ùx
, 
’gše
, 
b
"z");

271 
	}
}

273 
â
 
	$Ã¬_£ek
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
) {

274 
	`mu¡_put
(
ùx
, 
’gše
, 
b
"x", b"1");

275 
	`mu¡_put
(
ùx
, 
’gše
, 
b
"z", b"2");

276 
Ët
 
¢­shÙ
 = 
’gše
.
	`¢­shÙ
(
ùx
).
	`unw¿p
();

277 
Ët
 
mut
 
cursÜ
 = 
¢­shÙ


278 .
	`™”
(
I‹rO±iÚ
::(), 
SÿnMode
::
Mixed
)

279 .
	`unw¿p
();

280 
	`as£¹_Ã¬_£ek
(&
mut
 
cursÜ
, 
b
"x", (b"x", b"1"));

281 
	`as£¹_Ã¬_£ek
(&
mut
 
cursÜ
, 
b
"a", (b"x", b"1"));

282 
	`as£¹_Ã¬_»v”£_£ek
(&
mut
 
cursÜ
, 
b
"z1", (b"z", b"2"));

283 
	`as£¹_Ã¬_»v”£_£ek
(&
mut
 
cursÜ
, 
b
"x1", (b"x", b"1"));

284 
	`as£¹_Ã¬_£ek
(&
mut
 
cursÜ
, 
b
"y", (b"z", b"2"));

285 
	`as£¹_Ã¬_£ek
(&
mut
 
cursÜ
, 
b
"x\x00", (b"z", b"2"));

286 
Ët
 
mut
 
¡©i¡ics
 = 
CFSti¡ics
::();

287 
as£¹
!(!
cursÜ


288 .
	`Ã¬_£ek
(&
	`make_key
(
b
"z\x00"), &
mut
 
¡©i¡ics
)

289 .
	`unw¿p
());

290 
	`mu¡_d–‘e
(
ùx
, 
’gše
, 
b
"x");

291 
	`mu¡_d–‘e
(
ùx
, 
’gše
, 
b
"z");

292 
	}
}

294 
â
 
	$cf
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
) {

295 
	`as£¹_nÚe_cf
(
ùx
, 
’gše
, "cf", 
b
"key");

296 
	`mu¡_put_cf
(
ùx
, 
’gše
, "cf", 
b
"key", b"value");

297 
	`as£¹_has_cf
(
ùx
, 
’gše
, "cf", 
b
"key", b"value");

298 
	`as£¹_£ek_cf
(
ùx
, 
’gše
, "cf", 
b
"k", (b"key", b"value"));

299 
	`mu¡_d–‘e_cf
(
ùx
, 
’gše
, "cf", 
b
"key");

300 
	`as£¹_nÚe_cf
(
ùx
, 
’gše
, "cf", 
b
"key");

301 
	}
}

303 
â
 
	$em±y_wr™e
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
) {

304 
’gše
.
	`wr™e
(
ùx
, 
vec
![]).
	`unw¿p
();

305 
	}
}

307 
â
 
	$wrÚg_cÚ‹xt
(
ùx
: &
CÚ‹xt
, 
’gše
: &
Engše
) {

308 
Ët
 
»giÚ_id
 = 
ùx
.
	`g‘_»giÚ_id
();

309 
Ët
 
mut
 
ùx
 = ctx.
	`to_owÃd
();

310 
ùx
.
	`£t_»giÚ_id
(
»giÚ_id
 + 1);

311 
as£¹
!(
’gše
.
	`wr™e
(&
ùx
, 
vec
![]).
	`is_”r
());

312 
	}
}

	@tests/storage/test_storage.rs

14 
u£
 
	g¡d
::
sync
::{
Arc
, 
	gMu‹x
};

15 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicUsize
, 
	gOrd”šg
};

16 
u£
 
	g¡d
::
sync
::
mpsc
::
chªÃl
;

17 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

18 
u£
 
	g¡d
::
th»ad
;

19 
u£
 
	g¿nd
::
¿ndom
;

20 
u£
 
	gsu³r
::
sync_¡Üage
::
SyncStÜage
;

21 
u£
 
	gkv´Ùo
::
kv½ıb
::{
CÚ‹xt
, 
	gLockInfo
};

22 
u£
 
	gtikv
::
¡Üage
::{
£lf
, 
	gmake_key
, 
	gKey
, 
	gMutiÚ
, 
	gStÜage
, 
	gALL_CFS
};

23 
u£
 
	gtikv
::
¡Üage
::
’gše
::{
£lf
, 
	gEngše
, 
	gEngšeRocksdb
, 
	gTEMP_DIR
};

24 
u£
 
	gtikv
::
¡Üage
::
txn
::{
GC_BATCH_SIZE
, 
	gRESOLVE_LOCK_BATCH_SIZE
};

25 
u£
 
	gtikv
::
¡Üage
::
mvcc
::
MAX_TXN_WRITE_SIZE
;

26 
u£
 
	gtikv
::
¡Üage
::
cÚfig
::
CÚfig
;

28 
u£
 
	gsu³r
::
ut
::
Ãw_¿á_’gše
;

29 
u£
 
	gsu³r
::
as£¹_¡Üage
::
As£¹iÚStÜage
;

30 
u£
 
	g¡Üage
::
ut
;

31 
u£
 
	g¡d
::
u64
;

33 #[
‹¡
]

34 
â
 
	$‹¡_txn_¡Üe_g‘
() {

35 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

37 
¡Üe
.
	`g‘_nÚe
(
b
"x", 10);

39 
¡Üe
.
	`put_ok
(
b
"x", b"x", 5, 10);

40 
¡Üe
.
	`g‘_nÚe
(
b
"x", 9);

41 
¡Üe
.
	`g‘_ok
(
b
"x", 10, b"x");

42 
¡Üe
.
	`g‘_ok
(
b
"x", 11, b"x");

43 
	}
}

45 #[
‹¡
]

46 
â
 
	$‹¡_txn_¡Üe_d–‘e
() {

47 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

48 
¡Üe
.
	`put_ok
(
b
"x", b"x5-10", 5, 10);

49 
¡Üe
.
	`d–‘e_ok
(
b
"x", 15, 20);

50 
¡Üe
.
	`g‘_nÚe
(
b
"x", 5);

51 
¡Üe
.
	`g‘_nÚe
(
b
"x", 9);

52 
¡Üe
.
	`g‘_ok
(
b
"x", 10, b"x5-10");

53 
¡Üe
.
	`g‘_ok
(
b
"x", 19, b"x5-10");

54 
¡Üe
.
	`g‘_nÚe
(
b
"x", 20);

55 
¡Üe
.
	`g‘_nÚe
(
b
"x", 21);

56 
	}
}

58 #[
‹¡
]

59 
â
 
	$‹¡_txn_¡Üe_ş—nup_rŞlback
() {

60 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

61 
¡Üe
.
	`put_ok
(
b
"secondary", b"s-0", 1, 2);

62 
¡Üe
.
	`´ewr™e_ok
(

63 
vec
![

64 
MutiÚ
::
	`Put
((
	`make_key
(
b
"´im¬y"), b"p-5".
	`to_vec
())),

65 
MutiÚ
::
	`Put
((
	`make_key
(
b
"£cÚd¬y"), b"s-5".
	`to_vec
())),

67 
b
"primary",

70 
¡Üe
.
	`g‘_”r
(
b
"secondary", 10);

71 
¡Üe
.
	`rŞlback_ok
(
vec
![
b
"primary"], 5);

72 
¡Üe
.
	`ş—nup_ok
(
b
"primary", 5);

73 
	}
}

75 #[
‹¡
]

76 
â
 
	$‹¡_txn_¡Üe_ş—nup_comm™
() {

77 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

78 
¡Üe
.
	`put_ok
(
b
"secondary", b"s-0", 1, 2);

79 
¡Üe
.
	`´ewr™e_ok
(

80 
vec
![

81 
MutiÚ
::
	`Put
((
	`make_key
(
b
"´im¬y"), b"p-5".
	`to_vec
())),

82 
MutiÚ
::
	`Put
((
	`make_key
(
b
"£cÚd¬y"), b"s-5".
	`to_vec
())),

84 
b
"primary",

87 
¡Üe
.
	`g‘_”r
(
b
"secondary", 8);

88 
¡Üe
.
	`g‘_”r
(
b
"secondary", 12);

89 
¡Üe
.
	`comm™_ok
(
vec
![
b
"primary"], 5, 10);

90 
¡Üe
.
	`ş—nup_”r
(
b
"primary", 5);

91 
¡Üe
.
	`rŞlback_”r
(
vec
![
b
"primary"], 5);

92 
	}
}

94 #[
‹¡
]

95 
â
 
	$‹¡_txn_¡Üe_fÜ_pošt_g‘_w™h_pk
() {

96 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

98 
¡Üe
.
	`put_ok
(
b
"b", b"v2", 1, 2);

99 
¡Üe
.
	`put_ok
(
b
"primary", b"v1", 2, 3);

100 
¡Üe
.
	`put_ok
(
b
"secondary", b"v3", 3, 4);

101 
¡Üe
.
	`´ewr™e_ok
(

102 
vec
![

103 
MutiÚ
::
	`Put
((
	`make_key
(
b
"´im¬y"), b"v3".
	`to_vec
())),

104 
MutiÚ
::
	`Put
((
	`make_key
(
b
"£cÚd¬y"), b"s-5".
	`to_vec
())),

105 
MutiÚ
::
	`Put
((
	`make_key
(
b
"Ãw_key"), b"Ãw_key".
	`to_vec
())),

107 
b
"primary",

110 
¡Üe
.
	`g‘_ok
(
b
"primary", 4, b"v1");

111 
¡Üe
.
	`g‘_ok
(
b
"´im¬y", 
u64
::
MAX
, b"v1");

112 
¡Üe
.
	`g‘_”r
(
b
"primary", 6);

114 
¡Üe
.
	`g‘_ok
(
b
"secondary", 4, b"v3");

115 
¡Üe
.
	`g‘_”r
(
b
"secondary", 6);

116 
¡Üe
.
	`g‘_”r
(
b
"£cÚd¬y", 
u64
::
MAX
);

118 
¡Üe
.
	`g‘_”r
(
b
"new_key", 6);

119 
¡Üe
.
	`g‘_ok
(
b
"b", 6, b"v2");

121 
	}
}

123 #[
‹¡
]

124 
â
 
	$‹¡_txn_¡Üe_b©ch_g‘
() {

125 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

126 
¡Üe
.
	`put_ok
(
b
"x", b"x1", 5, 10);

127 
¡Üe
.
	`put_ok
(
b
"y", b"y1", 15, 20);

128 
¡Üe
.
	`put_ok
(
b
"z", b"z1", 25, 30);

129 
¡Üe
.
	`b©ch_g‘_ok
(&[
b
"x", b"y", b"z", b"w"], 15, 
vec
![b"x1"]);

130 
¡Üe
.
	`b©ch_g‘_ok
(&[
b
"x", b"y", b"z", b"w"], 16, 
vec
![b"x1"]);

131 
¡Üe
.
	`b©ch_g‘_ok
(&[
b
"x", b"y", b"z", b"w"], 19, 
vec
![b"x1"]);

132 
¡Üe
.
	`b©ch_g‘_ok
(&[
b
"x", b"y", b"z", b"w"], 20, 
vec
![b"x1", b"y1"]);

133 
¡Üe
.
	`b©ch_g‘_ok
(&[
b
"x", b"y", b"z", b"w"], 21, 
vec
![b"x1", b"y1"]);

134 
	}
}

136 #[
‹¡
]

137 
â
 
	$‹¡_txn_¡Üe_sÿn
() {

138 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

141 
¡Üe
.
	`put_ok
(
b
"A", b"A10", 5, 10);

142 
¡Üe
.
	`put_ok
(
b
"C", b"C10", 5, 10);

143 
¡Üe
.
	`put_ok
(
b
"E", b"E10", 5, 10);

145 
Ët
 
check_v10
 = || {

146 
¡Üe
.
	`sÿn_ok
(
b
"", 0, 10, 
vec
![]);

147 
¡Üe
.
	`sÿn_ok
(
b
"", 1, 10, 
vec
![
	`Some
((b"A", b"A10"))]);

148 
¡Üe
.
	`sÿn_ok
(
b
"", 2, 10, 
vec
![
	`Some
((b"A", b"A10")), Some((b"C", b"C10"))]);

149 
¡Üe
.
	`sÿn_ok
(

150 
b
"",

153 
vec
![

154 
	`Some
((
b
"A", b"A10")),

155 
	`Some
((
b
"C", b"C10")),

156 
	`Some
((
b
"E", b"E10")),

159 
¡Üe
.
	`sÿn_ok
(

160 
b
"",

163 
vec
![

164 
	`Some
((
b
"A", b"A10")),

165 
	`Some
((
b
"C", b"C10")),

166 
	`Some
((
b
"E", b"E10")),

169 
¡Üe
.
	`sÿn_ok
(

170 
b
"A",

173 
vec
![

174 
	`Some
((
b
"A", b"A10")),

175 
	`Some
((
b
"C", b"C10")),

176 
	`Some
((
b
"E", b"E10")),

179 
¡Üe
.
	`sÿn_ok
(

180 
b
"A\x00",

183 
vec
![
	`Some
((
b
"C", b"C10")), Some((b"E", b"E10"))],

185 
¡Üe
.
	`sÿn_ok
(

186 
b
"C",

189 
vec
![
	`Some
((
b
"C", b"C10")), Some((b"E", b"E10"))],

191 
¡Üe
.
	`sÿn_ok
(
b
"F", 1, 10, 
vec
![]);

193 
	`check_v10
();

196 
¡Üe
.
	`put_ok
(
b
"B", b"B20", 15, 20);

197 
¡Üe
.
	`put_ok
(
b
"D", b"D20", 15, 20);

199 
Ët
 
check_v20
 = || {

200 
¡Üe
.
	`sÿn_ok
(

201 
b
"",

204 
vec
![

205 
	`Some
((
b
"A", b"A10")),

206 
	`Some
((
b
"B", b"B20")),

207 
	`Some
((
b
"C", b"C10")),

208 
	`Some
((
b
"D", b"D20")),

209 
	`Some
((
b
"E", b"E10")),

212 
¡Üe
.
	`sÿn_ok
(

213 
b
"C",

216 
vec
![

217 
	`Some
((
b
"C", b"C10")),

218 
	`Some
((
b
"D", b"D20")),

219 
	`Some
((
b
"E", b"E10")),

222 
¡Üe
.
	`sÿn_ok
(
b
"D\x00", 1, 20, 
vec
![
	`Some
((b"E", b"E10"))]);

224 
	`check_v10
();

225 
	`check_v20
();

228 
¡Üe
.
	`d–‘e_ok
(
b
"A", 25, 30);

229 
¡Üe
.
	`d–‘e_ok
(
b
"D", 25, 30);

231 
Ët
 
check_v30
 = || {

232 
¡Üe
.
	`sÿn_ok
(

233 
b
"",

236 
vec
![

237 
	`Some
((
b
"B", b"B20")),

238 
	`Some
((
b
"C", b"C10")),

239 
	`Some
((
b
"E", b"E10")),

242 
¡Üe
.
	`sÿn_ok
(
b
"A", 1, 30, 
vec
![
	`Some
((b"B", b"B20"))]);

243 
¡Üe
.
	`sÿn_ok
(
b
"C\x00", 5, 30, 
vec
![
	`Some
((b"E", b"E10"))]);

245 
	`check_v10
();

246 
	`check_v20
();

247 
	`check_v30
();

250 
¡Üe
.
	`d–‘e_ok
(
b
"B", 35, 40);

251 
¡Üe
.
	`put_ok
(
b
"C", b"C40", 35, 40);

252 
¡Üe
.
	`put_ok
(
b
"D", b"D40", 35, 40);

254 
Ët
 
check_v40
 = || {

255 
¡Üe
.
	`sÿn_ok
(

256 
b
"",

259 
vec
![

260 
	`Some
((
b
"C", b"C40")),

261 
	`Some
((
b
"D", b"D40")),

262 
	`Some
((
b
"E", b"E10")),

265 
¡Üe
.
	`sÿn_ok
(

266 
b
"",

269 
vec
![

270 
	`Some
((
b
"C", b"C40")),

271 
	`Some
((
b
"D", b"D40")),

272 
	`Some
((
b
"E", b"E10")),

276 
	`check_v10
();

277 
	`check_v20
();

278 
	`check_v30
();

279 
	`check_v40
();

280 
	}
}

282 #[
‹¡
]

283 
â
 
	$‹¡_txn_¡Üe_sÿn_key_Úly
() {

284 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

285 
¡Üe
.
	`put_ok
(
b
"A", b"A", 5, 10);

286 
¡Üe
.
	`put_ok
(
b
"B", b"B", 5, 10);

287 
¡Üe
.
	`put_ok
(
b
"C", b"C", 5, 10);

288 
¡Üe
.
	`sÿn_key_Úly_ok
(
b
"AA", 2, 10, 
vec
![
	`Some
(b"B"), Some(b"C")]);

289 
	}
}

291 
â
 
lock
(
key
: &[
u8
], 
´im¬y
: &[u8], 
ts
: 
u64
è-> 
LockInfo
 {

292 
Ët
 
mut
 
lock
 = 
LockInfo
::
Ãw
();

293 
	glock
.
£t_key
(
key
.
to_vec
());

294 
	glock
.
£t_´im¬y_lock
(
´im¬y
.
to_vec
());

295 
	glock
.
£t_lock_v”siÚ
(
ts
);

296 
	glock


299 #[
‹¡
]

300 
â
 
	$‹¡_txn_¡Üe_sÿn_lock
() {

301 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

303 
¡Üe
.
	`put_ok
(
b
"k1", b"v1", 1, 2);

304 
¡Üe
.
	`´ewr™e_ok
(

305 
vec
![

306 
MutiÚ
::
	`Put
((
	`make_key
(
b
"p1"), b"v5".
	`to_vec
())),

307 
MutiÚ
::
	`Put
((
	`make_key
(
b
"s1"), b"v5".
	`to_vec
())),

309 
b
"p1",

312 
¡Üe
.
	`´ewr™e_ok
(

313 
vec
![

314 
MutiÚ
::
	`Put
((
	`make_key
(
b
"p2"), b"v10".
	`to_vec
())),

315 
MutiÚ
::
	`Put
((
	`make_key
(
b
"s2"), b"v10".
	`to_vec
())),

317 
b
"p2",

320 
¡Üe
.
	`´ewr™e_ok
(

321 
vec
![

322 
MutiÚ
::
	`Put
((
	`make_key
(
b
"p3"), b"v20".
	`to_vec
())),

323 
MutiÚ
::
	`Put
((
	`make_key
(
b
"s3"), b"v20".
	`to_vec
())),

325 
b
"p3",

329 
¡Üe
.
	`sÿn_ok
(

330 
b
"",

333 
vec
![
	`Some
((
b
"k1", b"v1")), 
NÚe
, None, None, None],

335 
¡Üe
.
	`sÿn_lock_ok
(

337 
vec
![

338 
	`lock
(
b
"p1", b"p1", 5),

339 
	`lock
(
b
"p2", b"p2", 10),

340 
	`lock
(
b
"s1", b"p1", 5),

341 
	`lock
(
b
"s2", b"p2", 10),

344 
	}
}

346 #[
‹¡
]

347 
â
 
	$‹¡_txn_¡Üe_»sŞve_lock
() {

348 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

350 
¡Üe
.
	`´ewr™e_ok
(

351 
vec
![

352 
MutiÚ
::
	`Put
((
	`make_key
(
b
"p1"), b"v5".
	`to_vec
())),

353 
MutiÚ
::
	`Put
((
	`make_key
(
b
"s1"), b"v5".
	`to_vec
())),

355 
b
"p1",

358 
¡Üe
.
	`´ewr™e_ok
(

359 
vec
![

360 
MutiÚ
::
	`Put
((
	`make_key
(
b
"p2"), b"v10".
	`to_vec
())),

361 
MutiÚ
::
	`Put
((
	`make_key
(
b
"s2"), b"v10".
	`to_vec
())),

363 
b
"p2",

366 
¡Üe
.
	`»sŞve_lock_ok
(5, 
NÚe
);

367 
¡Üe
.
	`»sŞve_lock_ok
(10, 
	`Some
(20));

368 
¡Üe
.
	`g‘_nÚe
(
b
"p1", 20);

369 
¡Üe
.
	`g‘_nÚe
(
b
"s1", 30);

370 
¡Üe
.
	`g‘_ok
(
b
"p2", 20, b"v10");

371 
¡Üe
.
	`g‘_ok
(
b
"s2", 30, b"v10");

372 
¡Üe
.
	`sÿn_lock_ok
(30, 
vec
![]);

373 
	}
}

375 
â
 
	$‹¡_txn_¡Üe_»sŞve_lock_b©ch
(
key_´efix_Ën
: 
usize
, 
n
: usize) {

376 
Ët
 
´efix
 = 
SŒšg
::
	`äom_utf8
(
vec
![
b
'k'; 
key_´efix_Ën
]).
	`unw¿p
();

377 
Ët
 
keys
: 
Vec
<
SŒšg
> = (0..
n
).
	`m­
(|
i
| 
fÜm©
!("{}{}", 
´efix
, i)).
	`cŞËù
();

379 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

380 
k
 
š
 &
keys
 {

381 
¡Üe
.
	`´ewr™e_ok
(

382 
vec
![
MutiÚ
::
	`Put
((
	`make_key
(
k
.
	`as_by‹s
()), 
b
"v".
	`to_vec
()))],

383 
b
"k1",

387 
¡Üe
.
	`»sŞve_lock_ok
(5, 
	`Some
(10));

388 
k
 
š
 &
keys
 {

389 
¡Üe
.
	`g‘_ok
(
k
.
	`as_by‹s
(), 30, 
b
"v");

390 
¡Üe
.
	`g‘_nÚe
(
k
.
	`as_by‹s
(), 8);

392 
	}
}

394 #[
‹¡
]

395 
â
 
	$‹¡_txn_¡Üe_»sŞve_lock_š_a_b©ch
() {

396 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

398 
¡Üe
.
	`´ewr™e_ok
(

399 
vec
![

400 
MutiÚ
::
	`Put
((
	`make_key
(
b
"p1"), b"v5".
	`to_vec
())),

401 
MutiÚ
::
	`Put
((
	`make_key
(
b
"s1"), b"v5".
	`to_vec
())),

403 
b
"p1",

406 
¡Üe
.
	`´ewr™e_ok
(

407 
vec
![

408 
MutiÚ
::
	`Put
((
	`make_key
(
b
"p2"), b"v10".
	`to_vec
())),

409 
MutiÚ
::
	`Put
((
	`make_key
(
b
"s2"), b"v10".
	`to_vec
())),

411 
b
"p2",

414 
¡Üe
.
	`»sŞve_lock_b©ch_ok
(5, 0, 10, 20);

415 
¡Üe
.
	`g‘_nÚe
(
b
"p1", 30);

416 
¡Üe
.
	`g‘_nÚe
(
b
"s1", 30);

417 
¡Üe
.
	`g‘_ok
(
b
"p2", 30, b"v10");

418 
¡Üe
.
	`g‘_ok
(
b
"s2", 30, b"v10");

419 
¡Üe
.
	`sÿn_lock_ok
(30, 
vec
![]);

420 
	}
}

422 #[
‹¡
]

423 
â
 
	$‹¡_txn_¡Üe_»sŞve_lock2
() {

424 &
i
 
š
 &[

427 
RESOLVE_LOCK_BATCH_SIZE
 - 1,

428 
RESOLVE_LOCK_BATCH_SIZE
,

429 
RESOLVE_LOCK_BATCH_SIZE
 + 1,

430 
RESOLVE_LOCK_BATCH_SIZE
 * 2,

432 
	`‹¡_txn_¡Üe_»sŞve_lock_b©ch
(1, 
i
);

435 &
i
 
š
 &[1, 512, 1024] {

436 
	`‹¡_txn_¡Üe_»sŞve_lock_b©ch
(
i
, 50);

438 
	}
}

440 #[
‹¡
]

441 
â
 
	$‹¡_txn_¡Üe_comm™_Ëg®_tso
() {

442 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

443 
Ët
 
comm™_ts
 = 4;

444 
Ët
 
¡¬t_ts
 = 5;

445 
¡Üe
.
	`´ewr™e_ok
(

446 
vec
![

447 
MutiÚ
::
	`Put
((
	`make_key
(
b
"´im¬y"), b"p-5".
	`to_vec
())),

448 
MutiÚ
::
	`Put
((
	`make_key
(
b
"£cÚd¬y"), b"s-5".
	`to_vec
())),

450 
b
"primary",

451 
¡¬t_ts
,

454 
¡Üe
.
	`comm™_w™h_Ëg®_tso
(
vec
![
b
"´im¬y"], 
¡¬t_ts
, 
comm™_ts
);

455 
	}
}

457 #[
‹¡
]

458 
â
 
	$‹¡_¡Üe_»sŞve_w™h_Ëg®_tso
() {

459 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

460 
Ët
 
comm™_ts
 = 
	`Some
(4);

461 
Ët
 
¡¬t_ts
 = 5;

462 
¡Üe
.
	`´ewr™e_ok
(

463 
vec
![

464 
MutiÚ
::
	`Put
((
	`make_key
(
b
"´im¬y"), b"p-5".
	`to_vec
())),

465 
MutiÚ
::
	`Put
((
	`make_key
(
b
"£cÚd¬y"), b"s-5".
	`to_vec
())),

467 
b
"primary",

468 
¡¬t_ts
,

470 
¡Üe
.
	`»sŞve_lock_w™h_Ëg®_tso
(
¡¬t_ts
, 
comm™_ts
);

471 
	}
}

473 #[
‹¡
]

474 
â
 
	$‹¡_txn_¡Üe_gc
() {

475 
Ët
 
key
 = "k";

476 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

477 
	`Ët
 (
_şu¡”
, 
¿á_¡Üe
èğ
As£¹iÚStÜage
::
	`Ãw_¿á_¡Üage_w™h_¡Üe_couÁ
(3, 
key
);

478 
¡Üe
.
	`‹¡_txn_¡Üe_gc
(
key
);

479 
¿á_¡Üe
.
	`‹¡_txn_¡Üe_gc
(
key
);

480 
	}
}

482 
â
 
	$‹¡_txn_¡Üe_gc_muÉË_keys
(
key_´efix_Ën
: 
usize
, 
n
: usize) {

483 
Ët
 
´efix
 = 
SŒšg
::
	`äom_utf8
(
vec
![
b
'k'; 
key_´efix_Ën
]).
	`unw¿p
();

484 
	`‹¡_txn_¡Üe_gc_muÉË_keys_şu¡”_¡Üage
(
n
, 
´efix
.
	`şÚe
());

485 
	`‹¡_txn_¡Üe_gc_muÉË_keys_sšgË_¡Üage
(
n
, 
´efix
.
	`şÚe
());

486 
	}
}

488 
pub
 
â
 
	$‹¡_txn_¡Üe_gc_muÉË_keys_sšgË_¡Üage
(
n
: 
usize
, 
´efix
: 
SŒšg
) {

489 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

490 
Ët
 
keys
: 
Vec
<
SŒšg
> = (0..
n
).
	`m­
(|
i
| 
fÜm©
!("{}{}", 
´efix
, i)).
	`cŞËù
();

491 
k
 
š
 &
keys
 {

492 
¡Üe
.
	`put_ok
(
k
.
	`as_by‹s
(), 
b
"v1", 5, 10);

493 
¡Üe
.
	`put_ok
(
k
.
	`as_by‹s
(), 
b
"v2", 15, 20);

495 
¡Üe
.
	`gc_ok
(30);

496 
k
 
š
 &
keys
 {

497 
¡Üe
.
	`g‘_nÚe
(
k
.
	`as_by‹s
(), 15);

499 
	}
}

501 
pub
 
â
 
	$‹¡_txn_¡Üe_gc_muÉË_keys_şu¡”_¡Üage
(
n
: 
usize
, 
´efix
: 
SŒšg
) {

502 
	`Ët
 (
mut
 
şu¡”
, muˆ
¡Üe
) =

503 
As£¹iÚStÜage
::
	`Ãw_¿á_¡Üage_w™h_¡Üe_couÁ
(3, 
´efix
.
	`şÚe
().
	`as_¡r
());

504 
Ët
 
keys
: 
Vec
<
SŒšg
> = (0..
n
).
	`m­
(|
i
| 
fÜm©
!("{}{}", 
´efix
, i)).
	`cŞËù
();

505 
k
 
š
 &
keys
 {

506 
¡Üe
.
	`put_ok_fÜ_şu¡”
(&
mut
 
şu¡”
, 
k
.
	`as_by‹s
(), 
b
"v1", 5, 10);

507 
¡Üe
.
	`put_ok_fÜ_şu¡”
(&
mut
 
şu¡”
, 
k
.
	`as_by‹s
(), 
b
"v2", 15, 20);

510 
k
 
š
 &
keys
 {

512 
¡Üe
.
	`gc_ok_fÜ_şu¡”
(&
mut
 
şu¡”
, 
k
.
	`as_by‹s
(), 30);

515 
k
 
š
 &
keys
 {

516 
¡Üe
.
	`g‘_nÚe_äom_şu¡”
(&
mut
 
şu¡”
, 
k
.
	`as_by‹s
(), 15);

518 
	}
}

520 #[
‹¡
]

521 
â
 
	$‹¡_txn_¡Üe_gc2_w™hout_key
() {

522 
	`‹¡_txn_¡Üe_gc_muÉË_keys
(1, 0);

523 
	}
}

525 #[
‹¡
]

526 
â
 
	$‹¡_txn_¡Üe_gc2_w™h_Ëss_keys
() {

527 
	`‹¡_txn_¡Üe_gc_muÉË_keys
(1, 3);

528 
	}
}

530 #[
‹¡
]

531 
â
 
	$‹¡_txn_¡Üe_gc2_w™h_mªy_keys
() {

532 
	`‹¡_txn_¡Üe_gc_muÉË_keys
(1, 
GC_BATCH_SIZE
 + 1);

533 
	}
}

535 #[
‹¡
]

536 
â
 
	$‹¡_txn_¡Üe_gc2_w™h_lÚg_key_´efix
() {

537 
	`‹¡_txn_¡Üe_gc_muÉË_keys
(1024, 
MAX_TXN_WRITE_SIZE
 / 1024 * 3);

538 
	}
}

540 #[
‹¡
]

541 
â
 
	$‹¡_txn_¡Üe_gc3
() {

542 
Ët
 
key
 = "k";

543 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

544 
¡Üe
.
	`‹¡_txn_¡Üe_gc3
(
key
.
	`as_by‹s
()[0]);

545 
	`Ët
 (
mut
 
şu¡”
, muˆ
¿á_¡Üe
èğ
As£¹iÚStÜage
::
	`Ãw_¿á_¡Üage_w™h_¡Üe_couÁ
(3, 
key
);

546 
¿á_¡Üe
.
	`‹¡_txn_¡Üe_gc3_fÜ_şu¡”
(&
mut
 
şu¡”
, 
key
.
	`as_by‹s
()[0]);

547 
	}
}

549 #[
‹¡
]

550 
â
 
	$‹¡_txn_¡Üe_¿wkv
() {

551 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

552 
¡Üe
.
	`¿w_g‘_ok
(
b
"key".
	`to_vec
(), 
NÚe
);

553 
¡Üe
.
	`¿w_put_ok
(
b
"key".
	`to_vec
(), b"value".to_vec());

554 
¡Üe
.
	`¿w_g‘_ok
(
b
"key".
	`to_vec
(), 
	`Some
(b"value".to_vec()));

555 
¡Üe
.
	`¿w_put_ok
(
b
"key".
	`to_vec
(), b"v2".to_vec());

556 
¡Üe
.
	`¿w_g‘_ok
(
b
"key".
	`to_vec
(), 
	`Some
(b"v2".to_vec()));

557 
¡Üe
.
	`¿w_d–‘e_ok
(
b
"key".
	`to_vec
());

558 
¡Üe
.
	`¿w_g‘_ok
(
b
"key".
	`to_vec
(), 
NÚe
);

560 
¡Üe
.
	`¿w_put_ok
(
b
"k1".
	`to_vec
(), b"v1".to_vec());

561 
¡Üe
.
	`¿w_put_ok
(
b
"k2".
	`to_vec
(), b"v2".to_vec());

562 
¡Üe
.
	`¿w_put_ok
(
b
"k3".
	`to_vec
(), b"v3".to_vec());

563 
¡Üe
.
	`¿w_sÿn_ok
(
b
"".
	`to_vec
(), 1, 
vec
![(b"k1", b"v1")]);

564 
¡Üe
.
	`¿w_sÿn_ok
(
b
"k1".
	`to_vec
(), 1, 
vec
![(b"k1", b"v1")]);

565 
¡Üe
.
	`¿w_sÿn_ok
(
b
"k10".
	`to_vec
(), 1, 
vec
![(b"k2", b"v2")]);

566 
¡Üe
.
	`¿w_sÿn_ok
(
b
"".
	`to_vec
(), 2, 
vec
![(b"k1", b"v1"), (b"k2", b"v2")]);

567 
¡Üe
.
	`¿w_sÿn_ok
(

568 
b
"k1".
	`to_vec
(),

570 
vec
![(
b
"k1", b"v1"), (b"k2", b"v2"), (b"k3", b"v3")],

572 
¡Üe
.
	`¿w_sÿn_ok
(
b
"".
	`to_vec
(), 0, 
vec
![]);

573 
¡Üe
.
	`¿w_sÿn_ok
(
b
"k5".
	`to_vec
(), 1, 
vec
![]);

574 
	}
}

576 #[
‹¡
]

577 
â
 
	$‹¡_txn_¡Üage_keysize
() {

578 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

579 
Ët
 
lÚg_key
 = 
vec
![
b
'x'; 10240];

580 
¡Üe
.
	`¿w_put_ok
(
b
"shÜt_key".
	`to_vec
(), b"v".to_vec());

581 
¡Üe
.
	`¿w_put_”r
(
lÚg_key
.
	`şÚe
(), 
b
"v".
	`to_vec
());

582 
¡Üe
.
	`¿w_d–‘e_ok
(
b
"shÜt_key".
	`to_vec
());

583 
¡Üe
.
	`¿w_d–‘e_”r
(
lÚg_key
.
	`şÚe
());

584 
¡Üe
.
	`´ewr™e_ok
(

585 
vec
![
MutiÚ
::
	`Put
((
	`make_key
(
b
"shÜt_key"), b"v".
	`to_vec
()))],

586 
b
"short_key",

589 
¡Üe
.
	`´ewr™e_”r
(

590 
vec
![
MutiÚ
::
	`Put
((
	`make_key
(&
lÚg_key
), 
b
"v".
	`to_vec
()))],

591 
b
"short_key",

594 
	}
}

596 #[
‹¡
]

597 
â
 
	$‹¡_txn_¡Üe_lock_´im¬y
() {

598 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

600 
¡Üe
.
	`´ewr™e_ok
(

601 
vec
![
MutiÚ
::
	`Put
((
	`make_key
(
b
"p"), b"p1".
	`to_vec
()))],

602 
b
"p",

607 
¡Üe
.
	`´ewr™e_locked
(

608 
vec
![

609 
MutiÚ
::
	`Put
((
	`make_key
(
b
"p"), b"p2".
	`to_vec
())),

610 
MutiÚ
::
	`Put
((
	`make_key
(
b
"s"), b"s2".
	`to_vec
())),

612 
b
"p",

614 
vec
![(
b
"p", b"p", 1)],

617 
¡Üe
.
	`rŞlback_ok
(
vec
![
b
"p"], 1);

618 
¡Üe
.
	`»sŞve_lock_ok
(1, 
NÚe
);

621 
¡Üe
.
	`´ewr™e_ok
(

622 
vec
![

623 
MutiÚ
::
	`Put
((
	`make_key
(
b
"p"), b"p3".
	`to_vec
())),

624 
MutiÚ
::
	`Put
((
	`make_key
(
b
"s"), b"s3".
	`to_vec
())),

626 
b
"p",

629 
	}
}

631 
	sO¿şe
 {

632 
	mts
: 
AtomicUsize
,

635 
im¶
 
	gO¿şe
 {

636 
â
 
Ãw
(è-> 
	gO¿şe
 {

637 
	gO¿şe
 {

638 
	gts
: 
AtomicUsize
::
Ãw
(1 
as
 
usize
),

642 
â
 
g‘_ts
(&
£lf
è-> 
	gu64
 {

643 
	g£lf
.
	gts
.
ãtch_add
(1, 
Ord”šg
::
R–axed
è
as
 
u64


647 cÚ¡ 
INC_MAX_RETRY
: 
usize
 = 100;

649 
â
 
šc
(
¡Üe
: &
SyncStÜage
, 
Üaşe
: &
O¿şe
, 
key
: &[
u8
]è-> 
ResuÉ
<
i32
, ()> {

650 
Ët
 
	gkey_add»ss
 = 
make_key
(
key
);

651 
i
 
	gš
 0..
	gINC_MAX_RETRY
 {

652 
Ët
 
	g¡¬t_ts
 = 
Üaşe
.
g‘_ts
();

653 
Ët
 
	gnumb”
: 
i32
 = 
m©ch
 
¡Üe
.
g‘
(
CÚ‹xt
::
Ãw
(), &
key_add»ss
, 
¡¬t_ts
) {

654 
Ok
(
Some
(
x
)è=> 
SŒšg
::
äom_utf8
(x).
unw¿p
().
·r£
().unwrap(),

655 
Ok
(
NÚe
) => 0,

656 
E¼
(
_
) => {

657 
backoff
(
i
);

661 
Ët
 
	gÃxt
 = 
numb”
 + 1;

662 
	g¡Üe


663 .
´ewr™e
(

664 
CÚ‹xt
::
Ãw
(),

665 
vec
![

666 
MutiÚ
::
Put
((
make_key
(
key
), 
Ãxt
.
to_¡ršg
().
što_by‹s
())),

668 
key
.
to_vec
(),

669 
¡¬t_ts
,

671 .
is_”r
()

673 
backoff
(
i
);

676 
Ët
 
	gcomm™_ts
 = 
Üaşe
.
g‘_ts
();

677 
	g¡Üe


678 .
comm™
(

679 
CÚ‹xt
::
Ãw
(),

680 
vec
![
key_add»ss
.
şÚe
()],

681 
¡¬t_ts
,

682 
comm™_ts
,

684 .
is_”r
()

686 
backoff
(
i
);

689  
Ok
(
numb”
);

691 
E¼
(())

694 #[
‹¡
]

695 
â
 
	$‹¡_isŞ©iÚ_šc
() {

696 cÚ¡ 
THREAD_NUM
: 
usize
 = 4;

697 cÚ¡ 
INC_PER_THREAD
: 
usize
 = 100;

699 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

700 
Ët
 
Üaşe
 = 
Arc
::
	`Ãw
(
O¿şe
::new());

701 
Ët
 
punch_ÿrd
 = 
Arc
::
	`Ãw
(
Mu‹x
::Ãw(
vec
![
çl£
; 
THREAD_NUM
 * 
INC_PER_THREAD
]));

703 
Ët
 
mut
 
th»ads
 = 
vec
![];

704 
_
 
š
 0..
THREAD_NUM
 {

705 
	`Ët
 (
punch_ÿrd
, 
¡Üe
, 
Üaşe
èğÕunch_ÿrd.
	`şÚe
(), store.clone(), oracle.clone());

706 
th»ads
.
	`push
(
th»ad
::
	`¥awn
(
move
 || 
_
 
š
 0..
INC_PER_THREAD
 {

707 
Ët
 
numb”
 = 
	`šc
(&
¡Üe
.¡Üe, &
Üaşe
, 
b
"key").
	`unw¿p
(è
as
 
usize
;

708 
Ët
 
mut
 
punch
 = 
punch_ÿrd
.
	`lock
().
	`unw¿p
();

709 
as£¹_eq
!(
punch
[
numb”
], 
çl£
);

710 
punch
[
numb”
] = 
Œue
;

713 
t
 
š
 
th»ads
 {

714 
t
.
	`još
().
	`unw¿p
();

716 
as£¹_eq
!(

717 
	`šc
(&
¡Üe
.¡Üe, &
Üaşe
, 
b
"key").
	`unw¿p
(è
as
 
usize
,

718 
THREAD_NUM
 * 
INC_PER_THREAD


720 
	}
}

722 
â
 
fÜm©_key
(
x
: 
usize
è-> 
Vec
<
u8
> {

723 
fÜm©
!("k{}", 
	gx
).
što_by‹s
()

726 
â
 
šc_muÉi
(
¡Üe
: &
SyncStÜage
, 
Üaşe
: &
O¿şe
, 
n
: 
usize
è-> 
boŞ
 {

728 
Ët
 
¡¬t_ts
 = 
Üaşe
.
g‘_ts
();

729 
Ët
 
	gkeys
: 
Vec
<
Key
> = (0..
n
).
m­
(
fÜm©_key
).m­(|
x
| 
make_key
(&x)).
cŞËù
();

730 
Ët
 
mut
 
	gmutiÚs
 = 
vec
![];

731 
key
 
š
 
	gkeys
.
™”
().
ke
(
n
) {

732 
Ët
 
	gnumb”
 = 
m©ch
 
¡Üe
.
g‘
(
CÚ‹xt
::
Ãw
(), 
key
, 
¡¬t_ts
) {

733 
Ok
(
Some
(
n
)è=> 
SŒšg
::
äom_utf8
Ò).
unw¿p
().
·r£
().unwrap(),

734 
Ok
(
NÚe
) => 0,

735 
E¼
(
_
) => {

736 
backoff
(
i
);

740 
Ët
 
	gÃxt
 = 
numb”
 + 1;

741 
	gmutiÚs
.
push
(
MutiÚ
::
Put
((
key
.
şÚe
(), 
Ãxt
.
to_¡ršg
().
što_by‹s
())));

743 
	g¡Üe


744 .
´ewr™e
(
CÚ‹xt
::
Ãw
(), 
mutiÚs
, 
b
"k0".
to_vec
(), 
¡¬t_ts
)

745 .
is_”r
()

747 
backoff
(
i
);

750 
Ët
 
	gcomm™_ts
 = 
Üaşe
.
g‘_ts
();

751 
	g¡Üe


752 .
comm™
(
CÚ‹xt
::
Ãw
(), 
keys
, 
¡¬t_ts
, 
comm™_ts
)

753 .
is_”r
()

755 
backoff
(
i
);

758  
	gŒue
;

760 
	gçl£


763 cÚ¡ 
	gBACK_OFF_CAP
: 
u64
 = 100;

767 
â
 
	$backoff
(
©‹m±s
: 
usize
) {

768 
Ët
 
uµ”_ms
 = 
m©ch
 
©‹m±s
 {

769 0...6 => 2u64.
	`pow
(
©‹m±s
 
as
 
u32
),

770 
_
 => 
BACK_OFF_CAP
,

772 
th»ad
::
	`¦“p
(
Du¿tiÚ
::
	`äom_mlis
(
¿ndom
::<
u64
>(è% 
uµ”_ms
))

773 
	}
}

775 #[
‹¡
]

776 
â
 
	$‹¡_isŞ©iÚ_muÉi_šc
() {

777 cÚ¡ 
THREAD_NUM
: 
usize
 = 4;

778 cÚ¡ 
KEY_NUM
: 
usize
 = 4;

779 cÚ¡ 
INC_PER_THREAD
: 
usize
 = 100;

781 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

782 
Ët
 
Üaşe
 = 
Arc
::
	`Ãw
(
O¿şe
::new());

783 
Ët
 
mut
 
th»ads
 = 
vec
![];

784 
_
 
š
 0..
THREAD_NUM
 {

785 
	`Ët
 (
¡Üe
, 
Üaşe
èğ(¡Üe.
	`şÚe
(), oracle.clone());

786 
th»ads
.
	`push
(
th»ad
::
	`¥awn
(
move
 || 
_
 
š
 0..
INC_PER_THREAD
 {

787 
as£¹
!(
	`šc_muÉi
(&
¡Üe
.¡Üe, &
Üaşe
, 
KEY_NUM
));

790 
t
 
š
 
th»ads
 {

791 
t
.
	`još
().
	`unw¿p
();

793 
n
 
š
 0..
KEY_NUM
 {

794 
as£¹_eq
!(

795 
	`šc
(&
¡Üe
.¡Üe, &
Üaşe
, &
	`fÜm©_key
(
n
)).
	`unw¿p
(è
as
 
usize
,

796 
THREAD_NUM
 * 
INC_PER_THREAD


799 
	}
}

801 
u£
 
	g‹¡
::
B’ch”
;

803 #[
b’ch
]

804 
â
 
	$b’ch_txn_¡Üe_rocksdb_šc
(
b
: &
mut
 
B’ch”
) {

805 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

806 
Ët
 
Üaşe
 = 
O¿şe
::
	`Ãw
();

808 
b
.
	`™”
(|| { 
	`šc
(&
¡Üe
.¡Üe, &
Üaşe
, b"key").
	`unw¿p
(); });

809 
	}
}

811 #[
b’ch
]

812 
â
 
	$b’ch_txn_¡Üe_rocksdb_šc_x100
(
b
: &
mut
 
B’ch”
) {

813 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

814 
Ët
 
Üaşe
 = 
O¿şe
::
	`Ãw
();

816 
b
.
	`™”
(|| { 
	`šc_muÉi
(&
¡Üe
.¡Üe, &
Üaşe
, 100); });

817 
	}
}

819 #[
b’ch
]

820 
â
 
	$b’ch_txn_¡Üe_rocksdb_put_x100
(
b
: &
mut
 
B’ch”
) {

821 
Ët
 
¡Üe
 = 
As£¹iÚStÜage
::();

822 
Ët
 
Üaşe
 = 
O¿şe
::
	`Ãw
();

824 
b
.
	`™”
(|| 
_
 
š
 0..100 {

825 
¡Üe
.
	`put_ok
(
b
"key", b"v®ue", 
Üaşe
.
	`g‘_ts
(), oracle.get_ts());

827 
	}
}

829 
â
 
‹¡_¡Üage_1gc_w™h_’gše
(
’gše
: 
Box
<
Engše
>, 
ùx
: 
CÚ‹xt
) {

830 
Ët
 
mut
 
’gše
 = 
ut
::
BlockEngše
::
Ãw
(engine);

831 
Ët
 
	gcÚfig
 = 
CÚfig
::();

832 
Ët
 
mut
 
	g¡Üage
 = 
StÜage
::
äom_’gše
(
’gše
.
şÚe
(), &
cÚfig
).
unw¿p
();

833 
	g¡Üage
.
¡¬t
(&
cÚfig
).
unw¿p
();

834 
Ët
 (
¡x
, 
¤x
èğ
chªÃl
();

835 
	g’gše
.
block_¢­shÙ
(
¡x
);

836 
Ët
 (
tx1
, 
rx1
èğ
chªÃl
();

837 
	g¡Üage


838 .
async_gc
(
ùx
.
şÚe
(), 1, 
box
 
move
 |
»s
: 
¡Üage
::
ResuÉ
<()>| {

839 
as£¹
!(
»s
.
is_ok
());

840 
tx1
.
£nd
(1).
unw¿p
();

842 .
unw¿p
();

845 
Ët
 (
tx2
, 
rx2
èğ
chªÃl
();

846 
	g¡Üage


847 .
async_gc
(
CÚ‹xt
::
Ãw
(), 1, 
box
 
move
 |
»s
: 
¡Üage
::
ResuÉ
<()>| {

848 
m©ch
 
»s
 {

849 
E¼
(
¡Üage
::
E¼Ü
::
SchedTooBusy
) => {}

850 
_
 => 
·nic
!("expectoo busy"),

852 
tx2
.
£nd
(1).
unw¿p
();

854 .
unw¿p
();

856 
	g¤x
.
»cv_timeout
(
Du¿tiÚ
::
äom_£cs
(2)).
unw¿p
();

857 
	grx2
.
»cv
().
unw¿p
();

858 
	g’gše
.
unblock_¢­shÙ
();

859 
	grx1
.
»cv
().
unw¿p
();

862 #[
‹¡
]

863 
â
 
	$‹¡_¡Üage_1gc
() {

864 
Ët
 
’gše
 =ƒngše::
	`Ãw_loÿl_’gše
(
TEMP_DIR
, 
ALL_CFS
).
	`unw¿p
();

865 
	`‹¡_¡Üage_1gc_w™h_’gše
(
’gše
, 
CÚ‹xt
::
	`Ãw
());

866 
	`Ët
 (
_şu¡”
, 
¿á_’gše
, 
ùx
èğ
	`Ãw_¿á_’gše
(3, "");

867 
	`‹¡_¡Üage_1gc_w™h_’gše
(
¿á_’gše
, 
ùx
);

868 
	}
}

870 #[
‹¡
]

871 
â
 
	$‹¡_cÚæiù_commªds_Ú_çuÉ_’gše
() {

872 
Ët
 
’gše
 = 
EngšeRocksdb
::
	`Ãw
(
TEMP_DIR
, 
ALL_CFS
).
	`unw¿p
();

873 
Ët
 
box_’gše
 = 
’gše
.
	`şÚe
();

874 
Ët
 
cÚfig
 = 
DeçuÉ
::();

875 
Ët
 
mut
 
¡Üe
 = 
SyncStÜage
::
	`´•¬e
(
box_’gše
, &
cÚfig
);

876 
Ët
 
async_¡Üage
 = 
¡Üe
.
	`g‘_¡Üage
();

877 
Ët
 
¡Üage
 = 
As£¹iÚStÜage
 {

878 
¡Üe
: stÜe.
	`şÚe
(),

879 
ùx
: 
CÚ‹xt
::
	`Ãw
(),

882 
	`Ët
 (
k
, 
v
èğ(
b
"k".
	`to_vec
(), b"v".to_vec());

883 
Ët
 
¡¬t_ts
 = 10;

884 
Ët
 
comm™_ts
 = 20;

886 
	`Ët
 (
tx
, 
rx
èğ
	`chªÃl
();

887 
async_¡Üage
.
	`async_´ewr™e
(

888 
¡Üage
.
ùx
.
	`şÚe
(),

889 
vec
![
MutiÚ
::
	`Put
((
	`make_key
(&
k
), 
v
.
	`şÚe
()))],

890 
k
.
	`şÚe
(),

891 
¡¬t_ts
,

892 
DeçuÉ
::(),

893 
box
 
move
 |
»s
| { 
tx
.
	`£nd
Ôes).
	`unw¿p
(); },

894 ).
	`unw¿p
();

895 
async_¡Üage


896 .
	`async_comm™
(

897 
¡Üage
.
ùx
.
	`şÚe
(),

898 
vec
![
	`make_key
(&
k
)],

899 
¡¬t_ts
,

900 
comm™_ts
,

901 
box
 |
_
| {},

903 .
	`unw¿p
();

904 
async_¡Üage


905 .
	`async_ş—nup
(
¡Üage
.
ùx
.
	`şÚe
(), 
	`make_key
(&
k
), 
¡¬t_ts
, 
box
 |
_
| {})

906 .
	`unw¿p
();

907 
async_¡Üage


908 .
	`async_rŞlback
(

909 
¡Üage
.
ùx
.
	`şÚe
(),

910 
vec
![
	`make_key
(&
k
)],

911 
¡¬t_ts
,

912 
box
 |
_
| {},

914 .
	`unw¿p
();

917 
’gše
.
	`¡İ
();

919 
¡Üe
.
	`¡¬t
(&
cÚfig
);

922 
rx
.
	`»cv
().
	`unw¿p
().
	`unw¿p_”r
();

923 
	}
}

	@tests/storage/util.rs

14 
u£
 
	g¡d
::
time
::
Du¿tiÚ
;

15 
u£
 
	g¡d
::
th»ad
;

16 
u£
 
	g¡d
::
sync
::
©omic
::{
AtomicBoŞ
, 
	gOrd”šg
};

17 
u£
 
	g¡d
::
sync
::
Arc
;

18 
u£
 
	g¡d
::
sync
::
mpsc
::
S’d”
;

19 
u£
 
	g¡d
::
sync
::
Mu‹x
;

20 
u£
 
	gtikv
::
¡Üage
::{
Engše
, 
	gModify
, 
	gSÇpshÙ
};

21 
u£
 
	gtikv
::
¡Üage
::
’gše
::{
B©chC®lback
, 
	gC®lback
, 
	gResuÉ
};

22 
u£
 
	gtikv
::
¡Üage
::
cÚfig
::
CÚfig
;

23 
u£
 
	gkv´Ùo
::
kv½ıb
::
CÚ‹xt
;

24 
u£
 
	g¿á¡Üe
::
şu¡”
::
Clu¡”
;

25 
u£
 
	g¿á¡Üe
::
£rv”
::
S”v”Clu¡”
;

26 
u£
 
	g¿á¡Üe
::
£rv”
::
Ãw_£rv”_şu¡”
;

27 
u£
 
	gtikv
::
ut
::
HªdyRwLock
;

28 
u£
 
	gsu³r
::
sync_¡Üage
::
SyncStÜage
;

30 #[
d”ive
(
Debug
)]

31 
pub
 
	sBlockEngše
 {

32 
	m’gše
: 
Box
<
Engše
>,

33 
	mblock_wr™e
: 
Arc
<
AtomicBoŞ
>,

34 
	mblock_¢­shÙ
: 
Arc
<
AtomicBoŞ
>,

35 
	m£nd”
: 
Arc
<
Mu‹x
<
O±iÚ
<
S’d”
<
boŞ
>>>>,

38 
im¶
 
	gBlockEngše
 {

39 
pub
 
â
 
Ãw
(
’gše
: 
Box
<
Engše
>è-> 
BlockEngše
 {

40 
BlockEngše
 {

41 
’gše
:ƒngine,

42 
	gblock_wr™e
: 
Arc
::
Ãw
(
AtomicBoŞ
::Ãw(
çl£
)),

43 
	gblock_¢­shÙ
: 
Arc
::
Ãw
(
AtomicBoŞ
::Ãw(
çl£
)),

44 
	g£nd”
: 
Arc
::
Ãw
(
Mu‹x
::Ãw(
NÚe
)),

48 #[
®low
(
d—d_code
)]

49 
â
 
£t_£nd”
(&
mut
 
£lf
, 
£nd”
: 
O±iÚ
<
S’d”
<
boŞ
>>) {

50 
Ët
 
mut
 
d©a
 = 
£lf
.
£nd”
.
lock
().
unw¿p
();

51 *
	gd©a
 = 
£nd”
;

54 #[
®low
(
d—d_code
)]

55 
pub
 
â
 
block_wr™e
(&
mut
 
£lf
, 
£nd”
: 
S’d”
<
boŞ
>) {

56 
£lf
.
block_wr™e
.
¡Üe
(
Œue
, 
Ord”šg
::
SeqC¡
);

57 
	g£lf
.
£t_£nd”
(
Some
(
£nd”
));

60 #[
®low
(
d—d_code
)]

61 
pub
 
â
 
unblock_wr™e
(&
mut
 
£lf
) {

62 
	g£lf
.
	gblock_wr™e
.
¡Üe
(
çl£
, 
Ord”šg
::
SeqC¡
);

63 
	g£lf
.
£t_£nd”
(
NÚe
);

66 
pub
 
â
 
block_¢­shÙ
(&
mut
 
£lf
, 
£nd”
: 
S’d”
<
boŞ
>) {

67 
£lf
.
block_¢­shÙ
.
¡Üe
(
Œue
, 
Ord”šg
::
SeqC¡
);

68 
	g£lf
.
£t_£nd”
(
Some
(
£nd”
));

71 
pub
 
â
 
unblock_¢­shÙ
(&
mut
 
£lf
) {

72 
	g£lf
.
	gblock_¢­shÙ
.
¡Üe
(
çl£
, 
Ord”šg
::
SeqC¡
);

73 
	g£lf
.
£t_£nd”
(
NÚe
);

78 
â
 
Œy_nÙify
(
block
: 
Arc
<
AtomicBoŞ
>, 
£nd”
: Arc<
Mu‹x
<
O±iÚ
<
S’d”
<
boŞ
>>>>) {

79 !
block
.
lßd
(
Ord”šg
::
SeqC¡
) {

82 
Ët
 
Some
(
s
èğ
£nd”
.
lock
().
unw¿p
().
as_»f
() {

83 
s
.
£nd
(
Œue
).
unw¿p
();

87 
im¶
 
Engše
 
	gBlockEngše
 {

88 
â
 
async_wr™e
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
b©ch
: 
Vec
<
Modify
>, 
ÿÎback
: 
C®lback
<()>è-> 
ResuÉ
<()> {

89 
Ët
 
block_wr™e
 = 
£lf
.block_wr™e.
şÚe
();

90 
Ët
 
	g£nd”
 = 
£lf
.
£nd”
.
şÚe
();

91 
	g£lf
.
	g’gše
.
async_wr™e
(
ùx
, 
b©ch
, 
box
 
move
 |
»s
| {

92 
th»ad
::
¥awn
(
move
 || {

93 
Œy_nÙify
(
block_wr™e
.
şÚe
(), 
£nd”
);

94 
block_wr™e
.
lßd
(
Ord”šg
::
SeqC¡
) {

95 
th»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(50));

97 
ÿÎback
(
»s
);

102 
â
 
async_¢­shÙ
(&
£lf
, 
ùx
: &
CÚ‹xt
, 
ÿÎback
: 
C®lback
<
Box
<
SÇpshÙ
>>è-> 
ResuÉ
<()> {

103 
Ët
 
block_¢­shÙ
 = 
£lf
.block_¢­shÙ.
şÚe
();

104 
Ët
 
	g£nd”
 = 
£lf
.
£nd”
.
şÚe
();

105 
	g£lf
.
	g’gše
.
async_¢­shÙ
(
ùx
, 
box
 
move
 |
»s
| {

106 
th»ad
::
¥awn
(
move
 || {

107 
Œy_nÙify
(
block_¢­shÙ
.
şÚe
(), 
£nd”
);

108 
block_¢­shÙ
.
lßd
(
Ord”šg
::
SeqC¡
) {

109 
th»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(50));

111 
ÿÎback
(
»s
);

116 
â
 
async_b©ch_¢­shÙ
(

117 &
£lf
,

118 
b©ch
: 
Vec
<
CÚ‹xt
>,

119 
Ú_fšished
: 
B©chC®lback
<
Box
<
SÇpshÙ
>>,

120 è-> 
	gResuÉ
<()> {

121 
Ët
 
	gblock_¢­shÙ
 = 
£lf
.
block_¢­shÙ
.
şÚe
();

122 
Ët
 
	g£nd”
 = 
£lf
.
£nd”
.
şÚe
();

123 
	g£lf
.
	g’gše
.
async_b©ch_¢­shÙ
(
b©ch
, 
box
 
move
 |
»s
| {

124 
th»ad
::
¥awn
(
move
 || {

125 
Œy_nÙify
(
block_¢­shÙ
.
şÚe
(), 
£nd”
);

126 
block_¢­shÙ
.
lßd
(
Ord”šg
::
SeqC¡
) {

127 
th»ad
::
¦“p
(
Du¿tiÚ
::
äom_mlis
(50));

129 
Ú_fšished
(
»s
);

134 
â
 
şÚe
(&
£lf
è-> 
	gBox
<
	gEngše
 + 'static> {

135 
box
 
	gBlockEngše
 {

136 
	g’gše
: 
£lf
.
’gše
.
şÚe
(),

137 
	gblock_wr™e
: 
£lf
.
block_wr™e
.
şÚe
(),

138 
	gblock_¢­shÙ
: 
£lf
.
block_¢­shÙ
.
şÚe
(),

139 
	g£nd”
: 
£lf
.
£nd”
.
şÚe
(),

144 
pub
 
â
 
Ãw_¿á_’gše
(
couÁ
: 
usize
, 
key
: &
¡r
è-> (
Clu¡”
<
S”v”Clu¡”
>, 
	gBox
<
	gEngše
>, 
	gCÚ‹xt
) {

145 
Ët
 
mut
 
	gşu¡”
 = 
Ãw_£rv”_şu¡”
(0, 
couÁ
);

146 
	gşu¡”
.
run
();

148 
	gas£¹_eq
!(
	gşu¡”
.
mu¡_g‘
(
b
""), 
	gNÚe
);

149 
Ët
 
	g»giÚ
 = 
şu¡”
.
g‘_»giÚ
(
key
.
as_by‹s
());

150 
Ët
 
	gËad”
 = 
şu¡”
.
Ëad”_of_»giÚ
(
»giÚ
.
g‘_id
()).
unw¿p
();

151 
Ët
 
	g’gše
 = 
şu¡”
.
sim
.
¾
().
¡Üages
[&
Ëad”
.
g‘_id
()].
şÚe
();

152 
Ët
 
mut
 
	gùx
 = 
CÚ‹xt
::
Ãw
();

153 
	gùx
.
£t_»giÚ_id
(
»giÚ
.
g‘_id
());

154 
	gùx
.
£t_»giÚ_•och
(
»giÚ
.
g‘_»giÚ_•och
().
şÚe
());

155 
	gùx
.
£t_³”
(
Ëad”
.
şÚe
());

156 (
	gşu¡”
, 
	g’gše
, 
	gùx
)

159 
pub
 
â
 
Ãw_¿á_¡Üage_w™h_¡Üe_couÁ
(

160 
couÁ
: 
usize
,

161 
key
: &
¡r
,

162 è-> (
	gClu¡”
<
	gS”v”Clu¡”
>, 
	gSyncStÜage
, 
	gCÚ‹xt
) {

163 
Ët
 (
şu¡”
, 
’gše
, 
ùx
èğ
Ãw_¿á_’gše
(
couÁ
, 
key
);

165 
	gşu¡”
,

166 
	gSyncStÜage
::
äom_’gše
(
’gše
, &
CÚfig
::()),

167 
	gùx
,

	@tests/util/mod.rs

14 
u£
 
	g¿nd
::{
£lf
, 
	gRng
, 
	gTh»adRng
};

15 
u£
 
	g¡d
::
io
::{
£lf
, 
	gWr™e
};

16 
u£
 
	g¡d
::
’v
;

17 
u£
 
	g¡d
::
fmt
::
Argum’ts
;

18 
u£
 
	g¡d
::
fs
::
Fe
;

19 
u£
 
	g¡d
::
·th
::
P©hBuf
;

20 
u£
 
	g¡d
::
sync
::
Mu‹x
;

22 
u£
 
	gtikv
::
ut
;

23 
u£
 
	gtikv
::
ut
::
logg”
::{
£lf
, 
	gLogWr™”
};

24 
u£
 
	gtikv
::
ut
::
£cur™y
::
Secur™yCÚfig
;

29 
pub
 
	sKvG’”©Ü
 {

30 
	mkey_Ën
: 
usize
,

31 
	mv®ue_Ën
: 
usize
,

32 
	mºg
: 
Th»adRng
,

35 
im¶
 
	gKvG’”©Ü
 {

36 
pub
 
â
 
Ãw
(
key_Ën
: 
usize
, 
v®ue_Ën
: usizeè-> 
KvG’”©Ü
 {

37 
KvG’”©Ü
 {

38 
key_Ën
: key_len,

39 
	gv®ue_Ën
: 
v®ue_Ën
,

40 
	gºg
: 
¿nd
::
th»ad_ºg
(),

45 
im¶
 
I‹¿tÜ
 
	gKvG’”©Ü
 {

46 
ty³
 
	gI‹m
 = (
Vec
<
u8
>, 
	gVec
<
	gu8
>);

48 
â
 
Ãxt
(&
mut
 
£lf
è-> 
	gO±iÚ
<(
	gVec
<
	gu8
>, Vec<u8>)> {

49 
Ët
 
mut
 
	gk
 = 
vec
![0; 
£lf
.
key_Ën
];

50 
	g£lf
.
	gºg
.
fl_by‹s
(&
mut
 
k
);

51 
Ët
 
mut
 
	gv
 = 
vec
![0; 
£lf
.
v®ue_Ën
];

52 
	g£lf
.
	gºg
.
fl_by‹s
(&
mut
 
v
);

54 
Some
((
k
, 
v
))

59 #[
®low
(
d—d_code
)]

60 
pub
 
â
 
g’”©e_¿ndom_kvs
(
n
: 
usize
, 
key_Ën
: usize, 
v®ue_Ën
: usizeè-> 
Vec
<(Vec<
u8
>, 
	gVec
<
	gu8
>)> {

61 
Ët
 
	gkv_g’”©Ü
 = 
KvG’”©Ü
::
Ãw
(
key_Ën
, 
v®ue_Ën
);

62 
	gkv_g’”©Ü
.
ke
(
n
).
cŞËù
()

66 
	sCa£T¿ûLogg”
 {

67 
	mf
: 
O±iÚ
<
Mu‹x
<
Fe
>>,

70 
im¶
 
LogWr™”
 
	gCa£T¿ûLogg”
 {

71 
â
 
wr™e
(&
£lf
, 
¬gs
: 
Argum’ts
) {

72 
Ët
 
g
 = 
ut
::
g‘_g_äom_th»ad_Çme
().
unw¿p_Ü_–£
(|| "".
što
());

73 
Ët
 
	g_
 = Ëˆ
Some
(
»f
 
out
èğ
£lf
.
f
 {

74 
Ët
 
mut
 
w
 = 
out
.
lock
().
unw¿p
();

75 
	gwr™e
!(
	gw
, "{} {}", 
	gg
, 
	g¬gs
)

77 
Ët
 
mut
 
	gw
 = 
io
::
¡d”r
();

78 
	gwr™e
!(
	gw
, "{} {}", 
	gg
, 
	g¬gs
)

83 
im¶
 
Drİ
 
	gCa£T¿ûLogg”
 {

84 
â
 
drİ
(&
mut
 
£lf
) {

85 
Ët
 
Some
(
»f
 
w
èğ
£lf
.
f
 {

86 
w
.
lock
().
unw¿p
().
æush
().unwrap();

92 
pub
 
â
 
	$š™_log
() {

93 
Ët
 
ouut
 = 
’v
::
	`v¬
("LOG_FILE").
	`ok
();

94 
Ët
 
Ëv–
 = 
logg”
::
	`g‘_Ëv–_by_¡ršg
(&
’v
::
	`v¬
("LOG_LEVEL")

95 .
	`unw¿p_Ü_–£
(|
_
| "debug".
	`to_owÃd
()));

96 
Ët
 
wr™”
 = 
ouut
.
	`m­
(|
f
| 
Mu‹x
::
	`Ãw
(
Fe
::
	`ü—‹
(f).
	`unw¿p
()));

98 
Ët
 
_
 = 
logg”
::
	`š™_log_fÜ_tikv_Úly
(
Ca£T¿ûLogg”
 { 
f
: 
wr™”
 }, 
Ëv–
);

99 
	}
}

101 
pub
 
â
 
Ãw_£cur™y_cfg
(è-> 
	gSecur™yCÚfig
 {

102 
Ët
 
	gp
 = 
P©hBuf
::
äom
(
’v
!("CARGO_MANIFEST_DIR"));

103 
	gSecur™yCÚfig
 {

104 
	gÿ_·th
: 
fÜm©
!("{}", 
	gp
.
još
("‹¡s/d©a/ÿ.üt").
di¥Ïy
()),

105 
	gû¹_·th
: 
fÜm©
!("{}", 
	gp
.
još
("‹¡s/d©a/£rv”.üt").
di¥Ïy
()),

106 
	gkey_·th
: 
fÜm©
!("{}", 
	gp
.
još
("‹¡s/d©a/£rv”.³m").
di¥Ïy
()),

107 
	gov”ride_s¦_rg‘
: "exam¶e.com".
to_owÃd
(),

	@
1
.
1
/usr/include
250
7608
benches/benches.rs
benches/bin/bench-tikv.rs
benches/bin/mvcc.rs
benches/bin/raftstore.rs
benches/channel/bench_channel.rs
benches/channel/mod.rs
benches/coprocessor/codec/mod.rs
benches/coprocessor/codec/mysql/json/mod.rs
benches/coprocessor/codec/mysql/mod.rs
benches/coprocessor/mod.rs
benches/serialization/bench_serialization.rs
benches/serialization/mod.rs
benches/writebatch/bench_writebatch.rs
benches/writebatch/mod.rs
build.rs
src/bin/profiling.rs
src/bin/signal_handler.rs
src/bin/tikv-ctl.rs
src/bin/tikv-fail.rs
src/bin/tikv-server.rs
src/config.rs
src/coprocessor/codec/convert.rs
src/coprocessor/codec/datum.rs
src/coprocessor/codec/mod.rs
src/coprocessor/codec/mysql/charset.rs
src/coprocessor/codec/mysql/decimal.rs
src/coprocessor/codec/mysql/duration.rs
src/coprocessor/codec/mysql/json/binary.rs
src/coprocessor/codec/mysql/json/comparison.rs
src/coprocessor/codec/mysql/json/json_cast.rs
src/coprocessor/codec/mysql/json/json_extract.rs
src/coprocessor/codec/mysql/json/json_merge.rs
src/coprocessor/codec/mysql/json/json_modify.rs
src/coprocessor/codec/mysql/json/json_remove.rs
src/coprocessor/codec/mysql/json/json_type.rs
src/coprocessor/codec/mysql/json/json_unquote.rs
src/coprocessor/codec/mysql/json/mod.rs
src/coprocessor/codec/mysql/json/path_expr.rs
src/coprocessor/codec/mysql/json/serde.rs
src/coprocessor/codec/mysql/mod.rs
src/coprocessor/codec/mysql/time.rs
src/coprocessor/codec/mysql/types.rs
src/coprocessor/codec/table.rs
src/coprocessor/dag/dag.rs
src/coprocessor/dag/executor/aggregation.rs
src/coprocessor/dag/executor/index_scan.rs
src/coprocessor/dag/executor/limit.rs
src/coprocessor/dag/executor/mod.rs
src/coprocessor/dag/executor/scanner.rs
src/coprocessor/dag/executor/selection.rs
src/coprocessor/dag/executor/table_scan.rs
src/coprocessor/dag/executor/topn.rs
src/coprocessor/dag/expr/arithmetic.rs
src/coprocessor/dag/expr/builtin_cast.rs
src/coprocessor/dag/expr/builtin_control.rs
src/coprocessor/dag/expr/builtin_op.rs
src/coprocessor/dag/expr/column.rs
src/coprocessor/dag/expr/compare.rs
src/coprocessor/dag/expr/constant.rs
src/coprocessor/dag/expr/fncall.rs
src/coprocessor/dag/expr/json.rs
src/coprocessor/dag/expr/math.rs
src/coprocessor/dag/expr/mod.rs
src/coprocessor/dag/mod.rs
src/coprocessor/endpoint.rs
src/coprocessor/metrics.rs
src/coprocessor/mod.rs
src/coprocessor/select/aggregate.rs
src/coprocessor/select/mod.rs
src/coprocessor/select/select.rs
src/coprocessor/select/topn_heap.rs
src/coprocessor/select/xeval/builtin_math.rs
src/coprocessor/select/xeval/evaluator.rs
src/coprocessor/select/xeval/mod.rs
src/coprocessor/statistics/analyze.rs
src/coprocessor/statistics/cmsketch.rs
src/coprocessor/statistics/fmsketch.rs
src/coprocessor/statistics/histogram.rs
src/coprocessor/statistics/mod.rs
src/lib.rs
src/pd/client.rs
src/pd/config.rs
src/pd/errors.rs
src/pd/metrics.rs
src/pd/mod.rs
src/pd/pd.rs
src/pd/util.rs
src/raft/errors.rs
src/raft/log_unstable.rs
src/raft/mod.rs
src/raft/progress.rs
src/raft/raft.rs
src/raft/raft_log.rs
src/raft/raw_node.rs
src/raft/read_only.rs
src/raft/status.rs
src/raft/storage.rs
src/raftstore/coprocessor/config.rs
src/raftstore/coprocessor/dispatcher.rs
src/raftstore/coprocessor/error.rs
src/raftstore/coprocessor/metrics.rs
src/raftstore/coprocessor/mod.rs
src/raftstore/coprocessor/region_snapshot.rs
src/raftstore/coprocessor/split_check/mod.rs
src/raftstore/coprocessor/split_check/size.rs
src/raftstore/coprocessor/split_check/table.rs
src/raftstore/coprocessor/split_observer.rs
src/raftstore/errors.rs
src/raftstore/mod.rs
src/raftstore/store/bootstrap.rs
src/raftstore/store/cmd_resp.rs
src/raftstore/store/config.rs
src/raftstore/store/engine.rs
src/raftstore/store/keys.rs
src/raftstore/store/local_metrics.rs
src/raftstore/store/metrics.rs
src/raftstore/store/mod.rs
src/raftstore/store/msg.rs
src/raftstore/store/peer.rs
src/raftstore/store/peer_storage.rs
src/raftstore/store/snap.rs
src/raftstore/store/store.rs
src/raftstore/store/transport.rs
src/raftstore/store/util.rs
src/raftstore/store/worker/apply.rs
src/raftstore/store/worker/compact.rs
src/raftstore/store/worker/consistency_check.rs
src/raftstore/store/worker/metrics.rs
src/raftstore/store/worker/mod.rs
src/raftstore/store/worker/raftlog_gc.rs
src/raftstore/store/worker/region.rs
src/raftstore/store/worker/split_check.rs
src/server/config.rs
src/server/debug.rs
src/server/errors.rs
src/server/metrics.rs
src/server/mod.rs
src/server/node.rs
src/server/raft_client.rs
src/server/resolve.rs
src/server/server.rs
src/server/service/debug.rs
src/server/service/kv.rs
src/server/service/mod.rs
src/server/snap.rs
src/server/transport.rs
src/storage/config.rs
src/storage/engine/metrics.rs
src/storage/engine/mod.rs
src/storage/engine/raftkv.rs
src/storage/engine/rocksdb.rs
src/storage/metrics.rs
src/storage/mod.rs
src/storage/mvcc/lock.rs
src/storage/mvcc/metrics.rs
src/storage/mvcc/mod.rs
src/storage/mvcc/reader.rs
src/storage/mvcc/txn.rs
src/storage/mvcc/write.rs
src/storage/txn/latch.rs
src/storage/txn/mod.rs
src/storage/txn/scheduler.rs
src/storage/txn/store.rs
src/storage/types.rs
src/util/buf.rs
src/util/codec/bytes.rs
src/util/codec/mod.rs
src/util/codec/number.rs
src/util/collections.rs
src/util/config.rs
src/util/file.rs
src/util/file_log.rs
src/util/io_limiter.rs
src/util/logger.rs
src/util/macros.rs
src/util/metrics.rs
src/util/mod.rs
src/util/panic_hook.rs
src/util/rocksdb/engine_metrics.rs
src/util/rocksdb/event_listener.rs
src/util/rocksdb/metrics_flusher.rs
src/util/rocksdb/mod.rs
src/util/rocksdb/properties.rs
src/util/security.rs
src/util/thread_metrics.rs
src/util/threadpool.rs
src/util/time.rs
src/util/transport.rs
src/util/worker/future.rs
src/util/worker/metrics.rs
src/util/worker/mod.rs
tests/config/mod.rs
tests/coprocessor/mod.rs
tests/coprocessor/test_analyze.rs
tests/coprocessor/test_select.rs
tests/failpoints.rs
tests/failpoints_cases/mod.rs
tests/failpoints_cases/test_pending_peers.rs
tests/failpoints_cases/test_snap.rs
tests/integrations.rs
tests/pd/mock/mocker/bootstrap.rs
tests/pd/mock/mocker/leader_change.rs
tests/pd/mock/mocker/mod.rs
tests/pd/mock/mocker/retry.rs
tests/pd/mock/mocker/service.rs
tests/pd/mock/mocker/split.rs
tests/pd/mock/mod.rs
tests/pd/mock/server.rs
tests/pd/mod.rs
tests/pd/test_rpc_client.rs
tests/raft/mod.rs
tests/raft/test_raft.rs
tests/raft/test_raft_flow_control.rs
tests/raft/test_raft_paper.rs
tests/raft/test_raft_snap.rs
tests/raft/test_raw_node.rs
tests/raftstore/cluster.rs
tests/raftstore/mod.rs
tests/raftstore/node.rs
tests/raftstore/pd.rs
tests/raftstore/server.rs
tests/raftstore/transport_simulate.rs
tests/raftstore/util.rs
tests/raftstore_cases/mod.rs
tests/raftstore_cases/test_bootstrap.rs
tests/raftstore_cases/test_compact_after_delete.rs
tests/raftstore_cases/test_compact_lock_cf.rs
tests/raftstore_cases/test_compact_log.rs
tests/raftstore_cases/test_conf_change.rs
tests/raftstore_cases/test_lease_read.rs
tests/raftstore_cases/test_multi.rs
tests/raftstore_cases/test_region_heartbeat.rs
tests/raftstore_cases/test_service.rs
tests/raftstore_cases/test_single.rs
tests/raftstore_cases/test_snap.rs
tests/raftstore_cases/test_split_region.rs
tests/raftstore_cases/test_stale_peer.rs
tests/raftstore_cases/test_stats.rs
tests/raftstore_cases/test_status_command.rs
tests/raftstore_cases/test_tombstone.rs
tests/raftstore_cases/test_transfer_leader.rs
tests/raftstore_cases/test_transport.rs
tests/storage/assert_storage.rs
tests/storage/mod.rs
tests/storage/sync_storage.rs
tests/storage/test_raft_storage.rs
tests/storage/test_raftkv.rs
tests/storage/test_storage.rs
tests/storage/util.rs
tests/util/mod.rs
